<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New test/jdk/java/io/Serializable/records/StreamRefTest.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @summary Tests for stream references
 27  * @compile --enable-preview -source ${jdk.version} StreamRefTest.java
 28  * @run testng/othervm --enable-preview StreamRefTest
 29  */
 30 
 31 import java.io.ByteArrayInputStream;
 32 import java.io.ByteArrayOutputStream;
 33 import java.io.IOException;
 34 import java.io.InvalidObjectException;
 35 import java.io.ObjectInputStream;
 36 import java.io.ObjectOutputStream;
 37 import java.io.Serializable;
 38 import java.lang.reflect.Field;
 39 import org.testng.annotations.Test;
 40 import static java.lang.System.out;
 41 import static org.testng.Assert.assertEquals;
 42 import static org.testng.Assert.assertTrue;
 43 import static org.testng.Assert.expectThrows;
 44 
 45 /**
 46  * Tests for stream references.
 47  */
 48 public class StreamRefTest {
 49 
 50     record A (int x) implements Serializable {
 51         public A(int x) {
 52             if (x &lt; 0)
 53                 throw new IllegalArgumentException(&quot;negative value for x:&quot; + x);
 54             this.x = x;
 55         }
 56     }
 57 
 58     static class B implements Serializable {
 59         final A a ;
 60         B(A a) { this.a = a; }
 61     }
 62 
 63     record C (B b) implements Serializable {
 64         public C(B b) { this.b = b; }
 65     }
 66 
 67     static class D implements Serializable {
 68         final C c ;
 69         D(C c) { this.c = c; }
 70     }
 71 
 72     @Test
 73     public void basicRef() throws Exception {
 74         out.println(&quot;\n---&quot;);
 75         var a = new A(6);
 76         var b = new B(a);
 77         var c = new C(b);
 78         var d = new D(c);
 79 
 80         var bytes = serialize(a, b, c, d);
 81 
 82         A a1 = (A)deserializeOne(bytes);
 83         B b1 = (B)deserializeOne(bytes);
 84         C c1 = (C)deserializeOne(bytes);
 85         D d1 = (D)deserializeOne(bytes);
 86 
 87         assertTrue(a1.x == a.x);
 88         assertTrue(a1 == b1.a);
 89         assertTrue(b1 == c1.b);
 90         assertTrue(c1 == d1.c);
 91     }
 92 
 93     @Test
 94     public void reverseBasicRef() throws Exception {
 95         out.println(&quot;\n---&quot;);
 96         var a = new A(7);
 97         var b = new B(a);
 98         var c = new C(b);
 99         var d = new D(c);
100 
101         var bytes = serialize(d, c, b, a);
102 
103         D d1 = (D)deserializeOne(bytes);
104         C c1 = (C)deserializeOne(bytes);
105         B b1 = (B)deserializeOne(bytes);
106         A a1 = (A)deserializeOne(bytes);
107 
108         assertTrue(a1 == b1.a);
109         assertTrue(b1 == c1.b);
110         assertTrue(c1 == d1.c);
111     }
112 
113     static final Class&lt;InvalidObjectException&gt; IOE = InvalidObjectException.class;
114 
115     @Test
116     public void basicRefWithInvalidA() throws Exception {
117         out.println(&quot;\n---&quot;);
118         var a = new A(3);
119         Field f = A.class.getDeclaredField(&quot;x&quot;);
120         f.setAccessible(true);
121         f.set(a, -3);  // a &quot;bad&quot; value
122         var b = new B(a);
123         assert a.x() == -3;
124 
125         var byteStream = serialize(a, b);
126 
127         InvalidObjectException ioe = expectThrows(IOE, () -&gt; deserializeOne(byteStream));
128         out.println(&quot;caught expected IOE: &quot; + ioe);
129         Throwable t = ioe.getCause();
130         assertTrue(t instanceof IllegalArgumentException, &quot;Expected IAE, got:&quot; + t);
131         out.println(&quot;expected cause IAE: &quot; + t);
132 
133         B b1 = (B)deserializeOne(byteStream);
134         assertEquals(b1.a, null);
135     }
136 
137     @Test
138     public void reverseBasicRefWithInvalidA() throws Exception {
139         out.println(&quot;\n---&quot;);
140         var a = new A(3);
141         Field f = A.class.getDeclaredField(&quot;x&quot;);
142         f.setAccessible(true);
143         f.set(a, -3);  // a &quot;bad&quot; value
144         var b = new B(a);
145         assert a.x() == -3;
146 
147         var byteStream = serialize(b, a);
148 
149         InvalidObjectException ioe = expectThrows(IOE, () -&gt; deserializeOne(byteStream));
150         out.println(&quot;caught expected IOE: &quot; + ioe);
151         Throwable t = ioe.getCause();
152         assertTrue(t instanceof IllegalArgumentException, &quot;Expected IAE, got:&quot; + t);
153         out.println(&quot;expected cause IAE: &quot; + t);
154 
155         A a1 = (A)deserializeOne(byteStream);
156         assertEquals(a1, null);
157     }
158 
159     // ---
160 
161 //    static class Y implements Serializable {
162 //        final int i = 10;
163 //        private void readObject(ObjectInputStream in)
164 //            throws IOException, ClassNotFoundException
165 //        {
166 //            in.defaultReadObject();
167 //            throw new IllegalArgumentException(&quot;dunno&quot;);
168 //        }
169 //    }
170 //
171 //    static class Z implements Serializable {
172 //        final Y y ;
173 //        Z(Y y) { this.y = y; }
174 //    }
175 //
176 //    static final Class&lt;IllegalArgumentException&gt; IAE = IllegalArgumentException.class;
177 //
178 //    @Test
179 //    public void whatDoesPlainDeserializationDo() throws Exception {
180 //        out.println(&quot;\n---&quot;);
181 //        var y = new Y();
182 //        var z = new Z(y);
183 //
184 //        var byteStream = serialize(z, y);
185 //
186 //        IllegalArgumentException iae = expectThrows(IAE, () -&gt; deserializeOne(byteStream));
187 //        out.println(&quot;caught expected IAE: &quot; + iae);
188 //        iae.printStackTrace();
189 //
190 //        Y y1 = (Y)deserializeOne(byteStream);
191 //        assertEquals(y1.i, 0);
192 //    }
193 //
194 //    @Test
195 //    public void reverseWhatDoesPlainDeserializationDo() throws Exception {
196 //        out.println(&quot;\n---&quot;);
197 //        var y = new Y();
198 //        var z = new Z(y);
199 //
200 //        var byteStream = serialize(y, z);
201 //
202 //        IllegalArgumentException iae = expectThrows(IAE, () -&gt; deserializeOne(byteStream));
203 //        out.println(&quot;caught expected IAE: &quot; + iae);
204 //        //iae.printStackTrace();
205 //
206 //        Z z1 = (Z)deserializeOne(byteStream);
207 //        assertEquals(z1.y, null);
208 //    }
209 
210     // ---
211 
212     static ObjectInputStream serialize(Object... objs) throws IOException {
213         ByteArrayOutputStream baos = new ByteArrayOutputStream();
214         ObjectOutputStream oos = new ObjectOutputStream(baos);
215         for (Object obj : objs)
216             oos.writeObject(obj);
217         oos.close();
218         ByteArrayInputStream bais = new ByteArrayInputStream(baos.toByteArray());
219         return new ObjectInputStream(bais);
220     }
221 
222     @SuppressWarnings(&quot;unchecked&quot;)
223     static Object deserializeOne(ObjectInputStream ois)
224         throws IOException, ClassNotFoundException
225     {
226         return ois.readObject();
227     }
228 }
    </pre>
  </body>
</html>