<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New test/jdk/java/io/Serializable/records/WriteReplaceTest.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @summary Basic tests for writeReplace
 27  * @compile --enable-preview -source ${jdk.version} WriteReplaceTest.java
 28  * @run testng/othervm --enable-preview WriteReplaceTest
 29  * @run testng/othervm/java.security.policy=empty_security.policy --enable-preview WriteReplaceTest
 30  */
 31 
 32 import java.io.ByteArrayInputStream;
 33 import java.io.ByteArrayOutputStream;
 34 import java.io.IOException;
 35 import java.io.ObjectInputStream;
 36 import java.io.ObjectOutputStream;
 37 import java.io.Serializable;
 38 import org.testng.annotations.DataProvider;
 39 import org.testng.annotations.Test;
 40 import static java.lang.System.out;
 41 import static org.testng.Assert.assertEquals;
 42 
 43 public class WriteReplaceTest {
 44 
 45     record R1 () implements Serializable {
 46         Object writeReplace() { return new Replacement(); }
 47 
 48         private static class Replacement implements Serializable {
 49             private Object readResolve() { return new R1(); }
 50         }
 51     }
 52 
 53     record R2 (int x, int y) implements Serializable {
 54         Object writeReplace() { return new Ser(x, y); }
 55 
 56         private static class Ser implements Serializable {
 57             private final int x;
 58             private final int y;
 59             Ser(int x, int y) { this.x = x; this.y = y; }
 60             private Object readResolve() { return new R2(x, y); }
 61         }
 62     }
 63 
 64     record R3 (R1 r1, R2 r2) implements Serializable { }
 65 
 66     record R4 (long l) implements Serializable {
 67         Object writeReplace() { return new Replacement(l); }
 68 
 69         static class Replacement implements Serializable {
 70             long l;
 71             Replacement(long l) { this.l = l; }
 72         }
 73     }
 74 
 75     @DataProvider(name = &quot;recordObjects&quot;)
 76     public Object[][] recordObjects() {
 77         return new Object[][] {
 78             new Object[] { new R1(),                       R1.class             },
 79             new Object[] { new R2(1, 2),                   R2.class             },
 80             new Object[] { new R3(new R1(), new R2(3,4)),  R3.class             },
 81             new Object[] { new R4(4L),                     R4.Replacement.class },
 82         };
 83     }
 84 
 85     @Test(dataProvider = &quot;recordObjects&quot;)
 86     public void testSerialize(Object objectToSerialize, Class&lt;?&gt; expectedType)
 87         throws Exception
 88     {
 89         out.println(&quot;\n---&quot;);
 90         out.println(&quot;serializing : &quot; + objectToSerialize);
 91         Object deserializedObj = serializeDeserialize(objectToSerialize);
 92         out.println(&quot;deserialized: &quot; + deserializedObj);
 93         if (objectToSerialize.getClass().equals(expectedType))
 94             assertEquals(deserializedObj, objectToSerialize);
 95         else
 96             assertEquals(deserializedObj.getClass(), expectedType);
 97     }
 98 
 99     // -- null replacement
100 
101     record R10 () implements Serializable {
102         Object writeReplace() { return null; }
103     }
104 
105     @Test
106     public void testNull() throws Exception {
107         out.println(&quot;\n---&quot;);
108         Object objectToSerialize = new R10();
109         out.println(&quot;serializing : &quot; + objectToSerialize);
110         Object deserializedObj = serializeDeserialize(objectToSerialize);
111         out.println(&quot;deserialized: &quot; + deserializedObj);
112         assertEquals(deserializedObj, null);
113     }
114 
115     // --- infra
116 
117     static &lt;T&gt; byte[] serialize(T obj) throws IOException {
118         ByteArrayOutputStream baos = new ByteArrayOutputStream();
119         ObjectOutputStream oos = new ObjectOutputStream(baos);
120         oos.writeObject(obj);
121         oos.close();
122         return baos.toByteArray();
123     }
124 
125     @SuppressWarnings(&quot;unchecked&quot;)
126     static &lt;T&gt; T deserialize(byte[] streamBytes)
127         throws IOException, ClassNotFoundException
128     {
129         ByteArrayInputStream bais = new ByteArrayInputStream(streamBytes);
130         ObjectInputStream ois  = new ObjectInputStream(bais);
131         return (T) ois.readObject();
132     }
133 
134     static &lt;T&gt; T serializeDeserialize(T obj)
135         throws IOException, ClassNotFoundException
136     {
137         return deserialize(serialize(obj));
138     }
139 }
    </pre>
  </body>
</html>