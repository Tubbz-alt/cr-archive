<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New test/jdk/java/io/Serializable/checkModifiers/CheckModifiers.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 1999, 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /* @test
 25  * @bug 4214888
 26  * @clean CheckModifiers TestClass1 TestClass2
 27  * @build CheckModifiers
 28  * @run main CheckModifiers
 29  * @summary Make sure that serialpersistentFields data member is used to
 30  *          represent tyhe serializable fields only if it has the modfiers
 31  *          static, final, private and the type is ObjectStreamField.
 32  *          No need to check for static, as ObjectStreamField class is not
 33  *          serializable.
 34  *
 35  */
 36 
 37 import java.io.*;
 38 class TestClass1 implements Serializable {
 39     private static final long serialVersionUID = 1L;
 40 
 41     // Missing the &quot;final&quot; modifier
 42     @SuppressWarnings(&quot;serial&quot;) /* Incorrect declarations are being tested */
 43     private static ObjectStreamField[] serialPersistentFields = {
 44         new ObjectStreamField(&quot;field1&quot;, Integer.class),
 45         new ObjectStreamField(&quot;field2&quot;, Double.TYPE),
 46     };
 47 
 48     Integer field1;
 49     double field2;
 50     int field3;
 51     String field4;
 52 
 53     public TestClass1(Integer f1, double f2, int f3, String f4) {
 54         field1 = f1;
 55         field2 = f2;
 56         field3 = f3;
 57         field4 = f4;
 58     }
 59 
 60     private void readObject(ObjectInputStream ois)
 61         throws IOException, ClassNotFoundException {
 62         ObjectInputStream.GetField pfields = ois.readFields();
 63 
 64         field1 = (Integer) pfields.get(&quot;field1&quot;, Integer.valueOf(100));
 65         field2 = pfields.get(&quot;field2&quot;, 99.99);
 66 
 67         /* These fields must be present in the stream */
 68         try {
 69             field3 = pfields.get(&quot;field3&quot;, 99);
 70             System.out.println(&quot;Passes test 1a&quot;);
 71         } catch(IllegalArgumentException e) {
 72             throw new Error(&quot;data field: field3 not in the persistent stream&quot;);
 73         }
 74         try {
 75             field4 = (String) pfields.get(&quot;field4&quot;, &quot;Default string&quot;);
 76             System.out.println(&quot;Passes test 1b&quot;);
 77         } catch(IllegalArgumentException e) {
 78             throw new Error(&quot;data field: field4 not in the persistent stream&quot;);
 79         }
 80     }
 81 };
 82 
 83 
 84 class TestClass2 implements Serializable {
 85     private static final long serialVersionUID = 1L;
 86 
 87     // public instead of private
 88     @SuppressWarnings(&quot;serial&quot;) /* Incorrect declarations are being tested */
 89     public static final ObjectStreamField[] serialPersistentFields = {
 90         new ObjectStreamField(&quot;field1&quot;, Integer.class),
 91         new ObjectStreamField(&quot;field2&quot;, Double.TYPE),
 92     };
 93 
 94     Integer field1;
 95     double field2;
 96     int field3;
 97     String field4;
 98 
 99     public TestClass2(Integer f1, double f2, int f3, String f4) {
100         field1 = f1;
101         field2 = f2;
102         field3 = f3;
103         field4 = f4;
104     }
105 
106     private void readObject(ObjectInputStream ois)
107         throws IOException, ClassNotFoundException {
108         ObjectInputStream.GetField pfields = ois.readFields();
109 
110         field1 = (Integer) pfields.get(&quot;field1&quot;, Integer.valueOf(100));
111         field2 = pfields.get(&quot;field2&quot;, 99.99);
112 
113         /* These fields must be present in the stream */
114         try {
115             field3 = pfields.get(&quot;field3&quot;, 99);
116             System.out.println(&quot;Passes test 2a&quot;);
117         } catch(IllegalArgumentException e) {
118             throw new Error(&quot;data field: field3 not in the persistent stream&quot;);
119         }
120         try {
121             field4 = (String) pfields.get(&quot;field4&quot;, &quot;Default string&quot;);
122             System.out.println(&quot;Passes test 2b&quot;);
123         } catch(IllegalArgumentException e) {
124             throw new Error(&quot;data field: field4 not in the persistent stream&quot;);
125         }
126     }
127 };
128 
129 class TestClass3 implements Serializable{
130     private static final long serialVersionUID = 1L;
131 
132     // Not of type ObjectStreamField
133     @SuppressWarnings(&quot;serial&quot;) /* Incorrect declarations are being tested */
134     private final String[] serialPersistentFields =  {&quot;Foo&quot;,&quot;Foobar&quot;};;
135     Integer field1;
136     double field2;
137     int field3;
138     String field4;
139 
140     public TestClass3(Integer f1, double f2, int f3, String f4) {
141         field1 = f1;
142         field2 = f2;
143         field3 = f3;
144         field4 = f4;
145     }
146 
147     private void readObject(ObjectInputStream ois)
148         throws IOException, ClassNotFoundException {
149         ObjectInputStream.GetField pfields = ois.readFields();
150 
151         field1 = (Integer) pfields.get(&quot;field1&quot;, Integer.valueOf(100));
152         field2 = pfields.get(&quot;field2&quot;, 99.99);
153         field3 = pfields.get(&quot;field3&quot;, 99);
154         field4 = (String) pfields.get(&quot;field4&quot;, &quot;Default string&quot;);
155 
156         try {
157             String[] tserialPersistentFields =
158                 (String[])pfields.get(&quot;serialPersistentFields&quot;, null);
159             System.out.println(&quot;Passes test 3&quot;);
160         } catch(IllegalArgumentException e) {
161             throw new Error(&quot;non-static field:  &quot; +
162                 &quot;serialPersistentFields must be in the persistent stream&quot;);
163         }
164     }
165 };
166 
167 class TestClass4 implements Serializable {
168     private static final long serialVersionUID = 1L;
169 
170     // Correct format
171     private static final ObjectStreamField[] serialPersistentFields = {
172         new ObjectStreamField(&quot;field1&quot;, Integer.class),
173         new ObjectStreamField(&quot;field2&quot;, Double.TYPE),
174     };
175 
176     Integer field1;
177     double field2;
178     int field3;
179     String field4;
180 
181     public TestClass4(Integer f1, double f2, int f3, String f4) {
182         field1 = f1;
183         field2 = f2;
184         field3 = f3;
185         field4 = f4;
186     }
187 
188     private void readObject(ObjectInputStream ois)
189         throws IOException, ClassNotFoundException {
190         ObjectInputStream.GetField pfields = ois.readFields();
191 
192         field1 = (Integer) pfields.get(&quot;field1&quot;, Integer.valueOf(100));
193         field2 = pfields.get(&quot;field2&quot;, 99.99);
194 
195         try {
196             field3 = pfields.get(&quot;field3&quot;, 99);
197             throw new Error(&quot;data field: field3 in the persistent stream&quot;);
198         } catch(IllegalArgumentException e) {
199             System.out.println(&quot;Passes test 4a&quot;);
200         }
201         try {
202             field4 = (String) pfields.get(&quot;field4&quot;, &quot;Default string&quot;);
203             throw new Error(&quot;data field: field4 in the persistent stream&quot;);
204         } catch(IllegalArgumentException e) {
205             System.out.println(&quot;Passes test 4b&quot;);
206         }
207     }
208 };
209 
210 public class CheckModifiers {
211     public static void main(String[] args)
212         throws ClassNotFoundException, IOException{
213         TestClass1 tc1 = new TestClass1(100, 25.56, 2000,
214             new String(&quot;Test modifiers of serialPersistentFields&quot;));
215 
216         TestClass2 tc2 = new TestClass2(100, 25.56, 2000,
217             new String(&quot;Test modifiers of serialPersistentFields&quot;));
218 
219         TestClass3 tc3 = new TestClass3(100, 25.56, 2000,
220             new String(&quot;Test Type of serialPersistentFields&quot;));
221 
222         TestClass4 tc4 = new TestClass4(100, 25.56, 2000,
223             new String(&quot;Test modifiers of serialPersistentFields&quot;));
224 
225 
226         FileOutputStream fos = new FileOutputStream(&quot;fields.ser&quot;);
227         try {
228             ObjectOutputStream oos = new ObjectOutputStream(fos);
229             System.out.println(&quot;Writing obj 1&quot;);
230             oos.writeObject(tc1);
231             System.out.println(&quot;Writing obj 2&quot;);
232             oos.writeObject(tc2);
233             System.out.println(&quot;Writing obj 3&quot;);
234             oos.writeObject(tc3);
235             System.out.println(&quot;Writing obj 4&quot;);
236             oos.writeObject(tc4);
237             oos.flush();
238         } finally {
239             fos.close();
240         }
241 
242         FileInputStream fis = new FileInputStream(&quot;fields.ser&quot;);
243         try {
244             ObjectInputStream ois = new ObjectInputStream(fis);
245             System.out.println(&quot;Test modifiers for serialPeristentFields &quot;);
246             System.out.println(&quot;---------------------------------------- &quot;);
247             System.out.println(&quot;Declaration missing final modifier&quot;);
248             ois.readObject();
249             System.out.println();
250             System.out.println(&quot;Declaration with public instead of private access&quot;);
251             ois.readObject();
252             System.out.println();
253             System.out.println(&quot;Declaration with different type&quot;);
254             ois.readObject();
255             System.out.println();
256             System.out.println(&quot;Declaration as in specification&quot;);
257             ois.readObject();
258         } finally {
259             fis.close();
260         }
261     }
262 };
    </pre>
  </body>
</html>