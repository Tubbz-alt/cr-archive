<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/jdk/java/nio/channels/Channels/Basic.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="../AsynchronousSocketChannel/Basic.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../DatagramChannel/BasicMulticastTests.java.udiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/nio/channels/Channels/Basic.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2001, 2017, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2001, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -20,20 +20,19 @@</span>
   * or visit www.oracle.com if you need additional information or have any
   * questions.
   */
  
  /* @test
<span class="udiff-line-modified-removed">-  * @bug 4417152 4481572 6248930 6725399 6884800</span>
<span class="udiff-line-modified-added">+  * @bug 4417152 4481572 6248930 6725399 6884800 8220477</span>
   * @summary Test Channels basic functionality
   */
  
  import java.io.*;
  import java.nio.*;
  import java.nio.charset.*;
  import java.nio.channels.*;
  
<span class="udiff-line-removed">- </span>
  public class Basic {
  
      static String message;
  
      static String encoding;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -202,10 +201,12 @@</span>
              blah.delete();
  
              writeOut(blah, ITERATIONS);
              testNewReader(blah);
  
<span class="udiff-line-added">+             testNewWriterClose();</span>
<span class="udiff-line-added">+             testNewReaderClose();</span>
          } finally {
              blah.delete();
          }
      }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -397,10 +398,102 @@</span>
                  throw new RuntimeException(&quot;Test failed&quot;);
          }
          r.close();
          fis.close();
      }
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private static void testNewWriterClose() throws Exception {</span>
<span class="udiff-line-added">+         Writer writer = null;</span>
<span class="udiff-line-added">+         try {</span>
<span class="udiff-line-added">+             WritableByteChannel channel = new WritableByteChannel() {</span>
<span class="udiff-line-added">+                 @Override</span>
<span class="udiff-line-added">+                 public int write(ByteBuffer src) throws IOException {</span>
<span class="udiff-line-added">+                     return 0;</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+                 @Override</span>
<span class="udiff-line-added">+                 public boolean isOpen() {</span>
<span class="udiff-line-added">+                     return true;</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+                 @Override</span>
<span class="udiff-line-added">+                 public void close() throws IOException {</span>
<span class="udiff-line-added">+                     throw new IOException();</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             };</span>
<span class="udiff-line-added">+             writer = Channels.newWriter(channel,</span>
<span class="udiff-line-added">+                 StandardCharsets.UTF_8.newEncoder(), -1);</span>
<span class="udiff-line-added">+             writer.close();</span>
<span class="udiff-line-added">+         } catch (IOException ioe) {</span>
<span class="udiff-line-added">+             Exception theException = null;</span>
<span class="udiff-line-added">+             try {</span>
<span class="udiff-line-added">+                 writer.write(1);</span>
<span class="udiff-line-added">+                 writer.flush();</span>
<span class="udiff-line-added">+             } catch (Exception e) {</span>
<span class="udiff-line-added">+                 theException = e;</span>
<span class="udiff-line-added">+             } finally {</span>
<span class="udiff-line-added">+                 if (theException == null) {</span>
<span class="udiff-line-added">+                     throw new RuntimeException(&quot;IOException not thrown&quot;);</span>
<span class="udiff-line-added">+                 } else if (!(theException instanceof IOException)) {</span>
<span class="udiff-line-added">+                     throw new RuntimeException(&quot;Exception not an IOException: &quot;</span>
<span class="udiff-line-added">+                         + theException);</span>
<span class="udiff-line-added">+                 } else {</span>
<span class="udiff-line-added">+                     String message = theException.getMessage();</span>
<span class="udiff-line-added">+                     if (!message.equals(&quot;Stream closed&quot;)) {</span>
<span class="udiff-line-added">+                         throw new RuntimeException(&quot;Unexpected message &quot;</span>
<span class="udiff-line-added">+                             + message);</span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private static void testNewReaderClose() throws Exception {</span>
<span class="udiff-line-added">+         Reader reader = null;</span>
<span class="udiff-line-added">+         try {</span>
<span class="udiff-line-added">+             ReadableByteChannel channel = new ReadableByteChannel() {</span>
<span class="udiff-line-added">+                 @Override</span>
<span class="udiff-line-added">+                 public int read(ByteBuffer dst) throws IOException {</span>
<span class="udiff-line-added">+                     dst.put((byte)7);</span>
<span class="udiff-line-added">+                     return 1;</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+                 @Override</span>
<span class="udiff-line-added">+                 public boolean isOpen() {</span>
<span class="udiff-line-added">+                     return true;</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+                 @Override</span>
<span class="udiff-line-added">+                 public void close() throws IOException {</span>
<span class="udiff-line-added">+                     throw new IOException();</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             };</span>
<span class="udiff-line-added">+             reader = Channels.newReader(channel,</span>
<span class="udiff-line-added">+                 StandardCharsets.UTF_8.newDecoder(), -1);</span>
<span class="udiff-line-added">+             reader.close();</span>
<span class="udiff-line-added">+         } catch (IOException ioe) {</span>
<span class="udiff-line-added">+             Exception theException = null;</span>
<span class="udiff-line-added">+             try {</span>
<span class="udiff-line-added">+                 reader.read();</span>
<span class="udiff-line-added">+             } catch (Exception e) {</span>
<span class="udiff-line-added">+                 theException = e;</span>
<span class="udiff-line-added">+             } finally {</span>
<span class="udiff-line-added">+                 if (theException == null) {</span>
<span class="udiff-line-added">+                     throw new RuntimeException(&quot;IOException not thrown&quot;);</span>
<span class="udiff-line-added">+                 } else if (!(theException instanceof IOException)) {</span>
<span class="udiff-line-added">+                     throw new RuntimeException(&quot;Exception not an IOException: &quot;</span>
<span class="udiff-line-added">+                         + theException);</span>
<span class="udiff-line-added">+                 } else {</span>
<span class="udiff-line-added">+                     String message = theException.getMessage();</span>
<span class="udiff-line-added">+                     if (!message.equals(&quot;Stream closed&quot;)) {</span>
<span class="udiff-line-added">+                         throw new RuntimeException(&quot;Unexpected message &quot;</span>
<span class="udiff-line-added">+                             + message);</span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
  }
  
  class ExtendedFileInputStream extends java.io.FileInputStream {
      ExtendedFileInputStream(File file) throws FileNotFoundException {
          super(file);
</pre>
<center><a href="../AsynchronousSocketChannel/Basic.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../DatagramChannel/BasicMulticastTests.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>