<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/java/nio/channels/Channels/Basic.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="../AsynchronousSocketChannel/Basic.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../DatagramChannel/BasicMulticastTests.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/nio/channels/Channels/Basic.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2001, 2017, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /* @test
<span class="line-modified"> 25  * @bug 4417152 4481572 6248930 6725399 6884800</span>
 26  * @summary Test Channels basic functionality
 27  */
 28 
 29 import java.io.*;
 30 import java.nio.*;
 31 import java.nio.charset.*;
 32 import java.nio.channels.*;
 33 
<span class="line-removed"> 34 </span>
 35 public class Basic {
 36 
 37     static String message;
 38 
 39     static String encoding;
 40 
 41     static File blah;
 42 
 43     static int ITERATIONS = 500;
 44 
 45     public static void main(String[] args) throws Exception {
 46         message = &quot;ascii data for a test&quot;;
 47         encoding = &quot;ISO-8859-1&quot;;
 48         test();
 49         message = &quot;\ucafe\ubabe\ucafe\ubabe\ucafe\ubabe&quot;;
 50         encoding = &quot;UTF-8&quot;;
 51         test();
 52     }
 53 
 54     static void failNpeExpected() {
</pre>
<hr />
<pre>
187             readAndCheck(blah);
188             blah.delete();
189 
190             testNewChannelWriteAfterClose(blah);
191 
192             testNewChannelReadAfterClose(blah);
193             blah.delete();
194 
195             writeOut(blah, ITERATIONS);
196             testNewChannelIn(blah);
197             test4481572(blah);
198             blah.delete();
199 
200             testNewWriter(blah);
201             readAndCheck(blah);
202             blah.delete();
203 
204             writeOut(blah, ITERATIONS);
205             testNewReader(blah);
206 


207         } finally {
208             blah.delete();
209         }
210     }
211 
212     private static void readAndCheck(File blah) throws Exception {
213         FileInputStream fis = new FileInputStream(blah);
214         int messageSize = message.length() * ITERATIONS * 3 + 1;
215         byte bb[] = new byte[messageSize];
216         int bytesRead = 0;
217         int totalRead = 0;
218         while (bytesRead != -1) {
219             totalRead += bytesRead;
220             bytesRead = fis.read(bb, totalRead, messageSize - totalRead);
221         }
222         String result = new String(bb, 0, totalRead, encoding);
223         int len = message.length();
224         for (int i=0; i&lt;ITERATIONS; i++) {
225             String segment = result.substring(i++ * len, i * len);
226             if (!segment.equals(message))
</pre>
<hr />
<pre>
382 
383         int messageSize = message.length() * ITERATIONS;
384         char data[] = new char[messageSize];
385 
386         int totalRead = 0;
387         int charsRead = 0;
388         while (totalRead &lt; messageSize) {
389             totalRead += charsRead;
390             charsRead = r.read(data, totalRead, messageSize - totalRead);
391         }
392         String result = new String(data, 0, totalRead);
393         int len = message.length();
394         for (int i=0; i&lt;ITERATIONS; i++) {
395             String segment = result.substring(i++ * len, i * len);
396             if (!segment.equals(message))
397                 throw new RuntimeException(&quot;Test failed&quot;);
398         }
399         r.close();
400         fis.close();
401     }




























































































402 }
403 
404 class ExtendedFileInputStream extends java.io.FileInputStream {
405     ExtendedFileInputStream(File file) throws FileNotFoundException {
406         super(file);
407     }
408 }
409 
410 class ExtendedFileOutputStream extends java.io.FileOutputStream {
411     ExtendedFileOutputStream(File file) throws FileNotFoundException {
412         super(file);
413     }
414 }
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2001, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /* @test
<span class="line-modified"> 25  * @bug 4417152 4481572 6248930 6725399 6884800 8220477</span>
 26  * @summary Test Channels basic functionality
 27  */
 28 
 29 import java.io.*;
 30 import java.nio.*;
 31 import java.nio.charset.*;
 32 import java.nio.channels.*;
 33 

 34 public class Basic {
 35 
 36     static String message;
 37 
 38     static String encoding;
 39 
 40     static File blah;
 41 
 42     static int ITERATIONS = 500;
 43 
 44     public static void main(String[] args) throws Exception {
 45         message = &quot;ascii data for a test&quot;;
 46         encoding = &quot;ISO-8859-1&quot;;
 47         test();
 48         message = &quot;\ucafe\ubabe\ucafe\ubabe\ucafe\ubabe&quot;;
 49         encoding = &quot;UTF-8&quot;;
 50         test();
 51     }
 52 
 53     static void failNpeExpected() {
</pre>
<hr />
<pre>
186             readAndCheck(blah);
187             blah.delete();
188 
189             testNewChannelWriteAfterClose(blah);
190 
191             testNewChannelReadAfterClose(blah);
192             blah.delete();
193 
194             writeOut(blah, ITERATIONS);
195             testNewChannelIn(blah);
196             test4481572(blah);
197             blah.delete();
198 
199             testNewWriter(blah);
200             readAndCheck(blah);
201             blah.delete();
202 
203             writeOut(blah, ITERATIONS);
204             testNewReader(blah);
205 
<span class="line-added">206             testNewWriterClose();</span>
<span class="line-added">207             testNewReaderClose();</span>
208         } finally {
209             blah.delete();
210         }
211     }
212 
213     private static void readAndCheck(File blah) throws Exception {
214         FileInputStream fis = new FileInputStream(blah);
215         int messageSize = message.length() * ITERATIONS * 3 + 1;
216         byte bb[] = new byte[messageSize];
217         int bytesRead = 0;
218         int totalRead = 0;
219         while (bytesRead != -1) {
220             totalRead += bytesRead;
221             bytesRead = fis.read(bb, totalRead, messageSize - totalRead);
222         }
223         String result = new String(bb, 0, totalRead, encoding);
224         int len = message.length();
225         for (int i=0; i&lt;ITERATIONS; i++) {
226             String segment = result.substring(i++ * len, i * len);
227             if (!segment.equals(message))
</pre>
<hr />
<pre>
383 
384         int messageSize = message.length() * ITERATIONS;
385         char data[] = new char[messageSize];
386 
387         int totalRead = 0;
388         int charsRead = 0;
389         while (totalRead &lt; messageSize) {
390             totalRead += charsRead;
391             charsRead = r.read(data, totalRead, messageSize - totalRead);
392         }
393         String result = new String(data, 0, totalRead);
394         int len = message.length();
395         for (int i=0; i&lt;ITERATIONS; i++) {
396             String segment = result.substring(i++ * len, i * len);
397             if (!segment.equals(message))
398                 throw new RuntimeException(&quot;Test failed&quot;);
399         }
400         r.close();
401         fis.close();
402     }
<span class="line-added">403 </span>
<span class="line-added">404     private static void testNewWriterClose() throws Exception {</span>
<span class="line-added">405         Writer writer = null;</span>
<span class="line-added">406         try {</span>
<span class="line-added">407             WritableByteChannel channel = new WritableByteChannel() {</span>
<span class="line-added">408                 @Override</span>
<span class="line-added">409                 public int write(ByteBuffer src) throws IOException {</span>
<span class="line-added">410                     return 0;</span>
<span class="line-added">411                 }</span>
<span class="line-added">412 </span>
<span class="line-added">413                 @Override</span>
<span class="line-added">414                 public boolean isOpen() {</span>
<span class="line-added">415                     return true;</span>
<span class="line-added">416                 }</span>
<span class="line-added">417 </span>
<span class="line-added">418                 @Override</span>
<span class="line-added">419                 public void close() throws IOException {</span>
<span class="line-added">420                     throw new IOException();</span>
<span class="line-added">421                 }</span>
<span class="line-added">422             };</span>
<span class="line-added">423             writer = Channels.newWriter(channel,</span>
<span class="line-added">424                 StandardCharsets.UTF_8.newEncoder(), -1);</span>
<span class="line-added">425             writer.close();</span>
<span class="line-added">426         } catch (IOException ioe) {</span>
<span class="line-added">427             Exception theException = null;</span>
<span class="line-added">428             try {</span>
<span class="line-added">429                 writer.write(1);</span>
<span class="line-added">430                 writer.flush();</span>
<span class="line-added">431             } catch (Exception e) {</span>
<span class="line-added">432                 theException = e;</span>
<span class="line-added">433             } finally {</span>
<span class="line-added">434                 if (theException == null) {</span>
<span class="line-added">435                     throw new RuntimeException(&quot;IOException not thrown&quot;);</span>
<span class="line-added">436                 } else if (!(theException instanceof IOException)) {</span>
<span class="line-added">437                     throw new RuntimeException(&quot;Exception not an IOException: &quot;</span>
<span class="line-added">438                         + theException);</span>
<span class="line-added">439                 } else {</span>
<span class="line-added">440                     String message = theException.getMessage();</span>
<span class="line-added">441                     if (!message.equals(&quot;Stream closed&quot;)) {</span>
<span class="line-added">442                         throw new RuntimeException(&quot;Unexpected message &quot;</span>
<span class="line-added">443                             + message);</span>
<span class="line-added">444                     }</span>
<span class="line-added">445                 }</span>
<span class="line-added">446             }</span>
<span class="line-added">447         }</span>
<span class="line-added">448     }</span>
<span class="line-added">449 </span>
<span class="line-added">450     private static void testNewReaderClose() throws Exception {</span>
<span class="line-added">451         Reader reader = null;</span>
<span class="line-added">452         try {</span>
<span class="line-added">453             ReadableByteChannel channel = new ReadableByteChannel() {</span>
<span class="line-added">454                 @Override</span>
<span class="line-added">455                 public int read(ByteBuffer dst) throws IOException {</span>
<span class="line-added">456                     dst.put((byte)7);</span>
<span class="line-added">457                     return 1;</span>
<span class="line-added">458                 }</span>
<span class="line-added">459 </span>
<span class="line-added">460                 @Override</span>
<span class="line-added">461                 public boolean isOpen() {</span>
<span class="line-added">462                     return true;</span>
<span class="line-added">463                 }</span>
<span class="line-added">464 </span>
<span class="line-added">465                 @Override</span>
<span class="line-added">466                 public void close() throws IOException {</span>
<span class="line-added">467                     throw new IOException();</span>
<span class="line-added">468                 }</span>
<span class="line-added">469             };</span>
<span class="line-added">470             reader = Channels.newReader(channel,</span>
<span class="line-added">471                 StandardCharsets.UTF_8.newDecoder(), -1);</span>
<span class="line-added">472             reader.close();</span>
<span class="line-added">473         } catch (IOException ioe) {</span>
<span class="line-added">474             Exception theException = null;</span>
<span class="line-added">475             try {</span>
<span class="line-added">476                 reader.read();</span>
<span class="line-added">477             } catch (Exception e) {</span>
<span class="line-added">478                 theException = e;</span>
<span class="line-added">479             } finally {</span>
<span class="line-added">480                 if (theException == null) {</span>
<span class="line-added">481                     throw new RuntimeException(&quot;IOException not thrown&quot;);</span>
<span class="line-added">482                 } else if (!(theException instanceof IOException)) {</span>
<span class="line-added">483                     throw new RuntimeException(&quot;Exception not an IOException: &quot;</span>
<span class="line-added">484                         + theException);</span>
<span class="line-added">485                 } else {</span>
<span class="line-added">486                     String message = theException.getMessage();</span>
<span class="line-added">487                     if (!message.equals(&quot;Stream closed&quot;)) {</span>
<span class="line-added">488                         throw new RuntimeException(&quot;Unexpected message &quot;</span>
<span class="line-added">489                             + message);</span>
<span class="line-added">490                     }</span>
<span class="line-added">491                 }</span>
<span class="line-added">492             }</span>
<span class="line-added">493         }</span>
<span class="line-added">494     }</span>
495 }
496 
497 class ExtendedFileInputStream extends java.io.FileInputStream {
498     ExtendedFileInputStream(File file) throws FileNotFoundException {
499         super(file);
500     }
501 }
502 
503 class ExtendedFileOutputStream extends java.io.FileOutputStream {
504     ExtendedFileOutputStream(File file) throws FileNotFoundException {
505         super(file);
506     }
507 }
</pre>
</td>
</tr>
</table>
<center><a href="../AsynchronousSocketChannel/Basic.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../DatagramChannel/BasicMulticastTests.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>