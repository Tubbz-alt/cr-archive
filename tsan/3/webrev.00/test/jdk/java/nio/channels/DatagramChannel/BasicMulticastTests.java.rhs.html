<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/jdk/java/nio/channels/DatagramChannel/BasicMulticastTests.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 2007, 2011, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /* @test
 25  * @bug 4527345
 26  * @summary Unit test for DatagramChannel&#39;s multicast support
 27  * @library /test/lib
 28  * @build jdk.test.lib.NetworkConfiguration
 29  *        jdk.test.lib.Platform
 30  *        BasicMulticastTests
 31  * @run main BasicMulticastTests
 32  */
 33 
 34 import java.nio.ByteBuffer;
 35 import java.nio.channels.*;
 36 import java.net.*;
 37 import java.util.*;
 38 import java.io.IOException;
 39 
 40 import jdk.test.lib.NetworkConfiguration;
 41 
 42 public class BasicMulticastTests {
 43 
 44     /**
 45      * Tests that existing membership key is returned by join methods and that
 46      * membership key methods return the expected results
 47      */
<a name="1" id="anc1"></a><span class="line-modified"> 48     static void membershipKeyTests(StandardProtocolFamily family,</span>
 49                                    InetAddress group,
<a name="2" id="anc2"></a><span class="line-added"> 50                                    NetworkInterface nif,</span>
 51                                    InetAddress source)
 52         throws IOException
 53     {
 54         System.out.format(&quot;MembershipKey test using %s @ %s\n&quot;,
 55             group.getHostAddress(), nif.getName());
 56 
<a name="3" id="anc3"></a>


 57         DatagramChannel dc = DatagramChannel.open(family)
 58             .setOption(StandardSocketOptions.SO_REUSEADDR, true)
 59             .bind(new InetSocketAddress(source, 0));
 60 
 61         // check existing key is returned
 62         MembershipKey key = dc.join(group, nif);
 63         MembershipKey other = dc.join(group, nif);
 64         if (other != key) {
 65             throw new RuntimeException(&quot;existing key not returned&quot;);
 66         }
 67 
 68         // check key
 69         if (!key.isValid())
 70             throw new RuntimeException(&quot;key is not valid&quot;);
 71         if (!key.group().equals(group))
 72             throw new RuntimeException(&quot;group is incorrect&quot;);
 73         if (!key.networkInterface().equals(nif))
 74             throw new RuntimeException(&quot;network interface is incorrect&quot;);
 75         if (key.sourceAddress() != null)
 76             throw new RuntimeException(&quot;key is source specific&quot;);
 77 
 78         // drop membership
 79         key.drop();
 80         if (key.isValid()) {
 81             throw new RuntimeException(&quot;key is still valid&quot;);
 82         }
 83 
 84         // source-specific
 85         try {
 86             key = dc.join(group, nif, source);
 87             other = dc.join(group, nif, source);
 88             if (other != key) {
 89                 throw new RuntimeException(&quot;existing key not returned&quot;);
 90             }
 91             if (!key.isValid())
 92                 throw new RuntimeException(&quot;key is not valid&quot;);
 93             if (!key.group().equals(group))
 94                 throw new RuntimeException(&quot;group is incorrect&quot;);
 95             if (!key.networkInterface().equals(nif))
 96                 throw new RuntimeException(&quot;network interface is incorrect&quot;);
 97             if (!key.sourceAddress().equals(source))
 98                 throw new RuntimeException(&quot;key&#39;s source address incorrect&quot;);
 99 
100             // drop membership
101             key.drop();
102             if (key.isValid()) {
103                 throw new RuntimeException(&quot;key is still valid&quot;);
104             }
105         } catch (UnsupportedOperationException x) {
106         }
107 
108         // done
109         dc.close();
110     }
111 
112     /**
113      * Tests exceptions for invalid arguments or scenarios
114      */
<a name="4" id="anc4"></a><span class="line-modified">115     static void exceptionTests(StandardProtocolFamily family,</span>
<span class="line-added">116                                InetAddress group,</span>
<span class="line-added">117                                InetAddress notGroup,</span>
<span class="line-added">118                                NetworkInterface nif,</span>
<span class="line-added">119                                InetAddress loopback)</span>
120         throws IOException
121     {
<a name="5" id="anc5"></a><span class="line-modified">122         System.out.format(&quot;Exception Tests using %s, %s @ %s\n&quot;,</span>
<span class="line-added">123             group.getHostAddress(),</span>
<span class="line-added">124             notGroup.getHostAddress(),</span>
<span class="line-added">125             nif.getName());</span>
126 
<a name="6" id="anc6"></a><span class="line-modified">127         DatagramChannel dc = DatagramChannel.open(family)</span>
128             .setOption(StandardSocketOptions.SO_REUSEADDR, true)
129             .bind(new InetSocketAddress(0));
130 
<a name="7" id="anc7"></a>



131         // IllegalStateException
132         MembershipKey key;
133         key = dc.join(group, nif);
134         try {
<a name="8" id="anc8"></a><span class="line-modified">135             dc.join(group, nif, loopback);</span>
136             throw new RuntimeException(&quot;IllegalStateException not thrown&quot;);
137         } catch (IllegalStateException x) {
138         } catch (UnsupportedOperationException x) {
139         }
140         key.drop();
141         try {
<a name="9" id="anc9"></a><span class="line-modified">142             key = dc.join(group, nif, loopback);</span>
143             try {
144                 dc.join(group, nif);
145                 throw new RuntimeException(&quot;IllegalStateException not thrown&quot;);
146             } catch (IllegalStateException x) {
147             }
148             key.drop();
149         } catch (UnsupportedOperationException x) {
150         }
151 
152         // IllegalArgumentException
153         try {
154             dc.join(notGroup, nif);
155             throw new RuntimeException(&quot;IllegalArgumentException not thrown&quot;);
156         } catch (IllegalArgumentException x) {
157         }
158         try {
<a name="10" id="anc10"></a><span class="line-modified">159             dc.join(notGroup, nif, loopback);</span>
160             throw new RuntimeException(&quot;IllegalArgumentException not thrown&quot;);
161         } catch (IllegalArgumentException x) {
162         } catch (UnsupportedOperationException x) {
163         }
164 
165         // NullPointerException
166         try {
167             dc.join(null, nif);
168             throw new RuntimeException(&quot;NullPointerException not thrown&quot;);
169         } catch (NullPointerException x) {
170         }
171         try {
172             dc.join(group, null);
173             throw new RuntimeException(&quot;NullPointerException not thrown&quot;);
174         } catch (NullPointerException x) {
175         }
176         try {
177             dc.join(group, nif, null);
178             throw new RuntimeException(&quot;NullPointerException not thrown&quot;);
179         } catch (NullPointerException x) {
180         } catch (UnsupportedOperationException x) {
181         }
182 
183         dc.close();
184 
185         // ClosedChannelException
186         try {
187             dc.join(group, nif);
188             throw new RuntimeException(&quot;ClosedChannelException not thrown&quot;);
189         } catch (ClosedChannelException x) {
190         }
191         try {
<a name="11" id="anc11"></a><span class="line-modified">192             dc.join(group, nif, loopback);</span>
193             throw new RuntimeException(&quot;ClosedChannelException not thrown&quot;);
194         } catch (ClosedChannelException x) {
195         } catch (UnsupportedOperationException x) {
196         }
197     }
198 
199 
200     /**
201      * Probe interfaces to get interfaces that support IPv4 or IPv6 multicasting
202      * and invoke tests.
203      */
204     public static void main(String[] args) throws IOException {
<a name="12" id="anc12"></a><span class="line-modified">205         NetworkConfiguration.printSystemConfiguration(System.out);</span>




206 
207         NetworkConfiguration config = NetworkConfiguration.probe();
208 
<a name="13" id="anc13"></a><span class="line-modified">209         // test IPv4 if available</span>
<span class="line-modified">210         {</span>
<span class="line-modified">211             var multicastInterfaces = config.ip4MulticastInterfaces().iterator();</span>
<span class="line-modified">212             InetAddress group = InetAddress.getByName(&quot;225.4.5.6&quot;);</span>
<span class="line-modified">213             InetAddress notGroup = InetAddress.getByName(&quot;1.2.3.4&quot;);</span>
<span class="line-modified">214             InetAddress loopback = InetAddress.getByName(&quot;127.0.0.1&quot;);</span>
<span class="line-added">215             while (multicastInterfaces.hasNext()) {</span>
<span class="line-added">216                 NetworkInterface nif = multicastInterfaces.next();</span>
<span class="line-added">217                 InetAddress anySource = config.ip4Addresses(nif).iterator().next();</span>
<span class="line-added">218                 membershipKeyTests(StandardProtocolFamily.INET, group, nif, anySource);</span>
<span class="line-added">219                 exceptionTests(StandardProtocolFamily.INET, group, notGroup, nif, loopback);</span>
<span class="line-added">220             }</span>
<span class="line-added">221         }</span>
222 
<a name="14" id="anc14"></a><span class="line-modified">223         // test IPv6 if available</span>
<span class="line-modified">224         {</span>
<span class="line-modified">225             var multicastInterfaces = config.ip6MulticastInterfaces().iterator();</span>
<span class="line-modified">226             InetAddress group = InetAddress.getByName(&quot;ff02::a&quot;);</span>
<span class="line-modified">227             InetAddress notGroup = InetAddress.getByName(&quot;fe80::1234&quot;);</span>
<span class="line-added">228             InetAddress loopback = InetAddress.getByName(&quot;::1&quot;);</span>
<span class="line-added">229             while (multicastInterfaces.hasNext()) {</span>
<span class="line-added">230                 NetworkInterface nif = multicastInterfaces.next();</span>
<span class="line-added">231                 InetAddress anySource = config.ip6Addresses(nif).iterator().next();</span>
<span class="line-added">232                 membershipKeyTests(StandardProtocolFamily.INET6, group, nif, anySource);</span>
<span class="line-added">233                 exceptionTests(StandardProtocolFamily.INET6, group, notGroup, nif, loopback);</span>
<span class="line-added">234             }</span>
235         }
236     }
237 }
<a name="15" id="anc15"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="15" type="hidden" />
</body>
</html>