<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/jdk/java/nio/channels/spi/SelectorProvider/inheritedChannel/StateTest.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="Launcher.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="UnixDomainSocket.java.udiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/nio/channels/spi/SelectorProvider/inheritedChannel/StateTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -33,10 +33,11 @@</span>
   * socket state and replies back to this class via an out-of-band
   * channel.
   */
  import java.io.IOException;
  import java.net.InetSocketAddress;
<span class="udiff-line-added">+ import java.net.InetAddress;</span>
  import java.nio.ByteBuffer;
  import java.nio.channels.DatagramChannel;
  import java.nio.channels.SelectionKey;
  import java.nio.channels.Selector;
  import java.nio.channels.ServerSocketChannel;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -64,10 +65,11 @@</span>
          SocketChannel sc;
  
          /*
           * Wait for service to connect
           */
<span class="udiff-line-added">+         System.err.println(&quot;Waiting for the service to connect&quot;);</span>
          ssc.configureBlocking(false);
          sk = ssc.register(sel, SelectionKey.OP_ACCEPT);
          long to = Utils.adjustTimeout(15*1000);
          sc = null;
          for (;;) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -87,10 +89,11 @@</span>
          ssc.configureBlocking(false);
  
          /*
           * Wait for service to report test result
           */
<span class="udiff-line-added">+         System.err.println(&quot;Waiting for the service to report test result&quot;);</span>
          sc.configureBlocking(false);
          sk = sc.register(sel, SelectionKey.OP_READ);
          to = Utils.adjustTimeout(5000);
          ByteBuffer bb = ByteBuffer.allocateDirect(20);
          for (;;) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -109,17 +112,19 @@</span>
              to -= System.currentTimeMillis() - st;
              if (to &lt;= 0) {
                  throw new IOException(&quot;Timed out waiting for service to report test result&quot;);
              }
          }
<span class="udiff-line-added">+         System.err.println(&quot;Cleaning up&quot;);</span>
          sk.cancel();
          sc.close();
          sel.close();
  
          /*
           * Examine the test result
           */
<span class="udiff-line-added">+         System.err.println(&quot;Examine test result&quot;);</span>
          bb.flip();
          byte b = bb.get();
  
          if (expectFail &amp;&amp; b == &#39;P&#39;) {
              System.err.println(&quot;Test passed - test is expected to fail!!!&quot;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -150,11 +155,12 @@</span>
          /*
           * Create the listener which will be used to read the test result
           * from the service.
           */
          ServerSocketChannel ssc = ServerSocketChannel.open();
<span class="udiff-line-modified-removed">-         ssc.socket().bind(new InetSocketAddress(0));</span>
<span class="udiff-line-modified-added">+         ssc.socket().bind(new InetSocketAddress(InetAddress.getLocalHost(), 0));</span>
<span class="udiff-line-added">+         System.err.println(&quot;Listener bound to: &quot; + ssc.socket().getLocalSocketAddress());</span>
  
          /*
           * The port is passed to the service as an argument.
           */
          int port = ssc.socket().getLocalPort();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -162,30 +168,35 @@</span>
          arg[0] = String.valueOf(port);
  
          /*
           * Launch service with a SocketChannel (tcp nowait)
           */
<span class="udiff-line-added">+         System.err.println(&quot;launchWithSocketChannel&quot;);</span>
          SocketChannel sc = Launcher.launchWithSocketChannel(TEST_SERVICE, options, arg);
<span class="udiff-line-added">+         System.err.println(&quot;Waiting for test results&quot;);</span>
          waitForTestResult(ssc, expectFail);
          sc.close();
  
          /*
           * Launch service with a ServerSocketChannel (tcp wait)
           * launchWithServerSocketChannel establishes a connection to the service
           * and the returned SocketChannel is connected to the service.
           */
<span class="udiff-line-added">+         System.err.println(&quot;launchWithServerSocketChannel&quot;);</span>
          sc = Launcher.launchWithServerSocketChannel(TEST_SERVICE, options, arg);
          waitForTestResult(ssc, expectFail);
          sc.close();
  
          /*
           * Launch service with a DatagramChannel (udp wait)
           */
<span class="udiff-line-added">+         System.err.println(&quot;launchWithDatagramChannel&quot;);</span>
          DatagramChannel dc = Launcher.launchWithDatagramChannel(TEST_SERVICE, options, arg);
          waitForTestResult(ssc, expectFail);
          dc.close();
  
<span class="udiff-line-added">+         System.err.println(&quot;done&quot;);</span>
          if (failures &gt; 0) {
              throw new RuntimeException(&quot;Test failed - see log for details&quot;);
          } else {
              System.out.println(&quot;All tests passed.&quot;);
          }
</pre>
<center><a href="Launcher.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="UnixDomainSocket.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>