<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/jdk/java/nio/channels/spi/SelectorProvider/inheritedChannel/Launcher.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre><a name="1" id="anc1"></a><span class="line-added">  1 </span>
  2 /*
<a name="2" id="anc2"></a><span class="line-modified">  3  * Copyright (c) 2003, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  4  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  5  *
  6  * This code is free software; you can redistribute it and/or modify it
  7  * under the terms of the GNU General Public License version 2 only, as
  8  * published by the Free Software Foundation.
  9  *
 10  * This code is distributed in the hope that it will be useful, but WITHOUT
 11  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 12  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 13  * version 2 for more details (a copy is included in the LICENSE file that
 14  * accompanied this code).
 15  *
 16  * You should have received a copy of the GNU General Public License version
 17  * 2 along with this work; if not, write to the Free Software Foundation,
 18  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 19  *
 20  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 21  * or visit www.oracle.com if you need additional information or have any
 22  * questions.
 23  */
 24 
 25 /*
 26  * A Launcher to launch a java process with its standard input, output,
 27  * and error streams connected to a socket.
 28  */
 29 import java.io.IOException;
 30 import java.net.InetAddress;
 31 import java.net.InetSocketAddress;
 32 import java.nio.channels.DatagramChannel;
 33 import java.nio.channels.ServerSocketChannel;
 34 import java.nio.channels.SocketChannel;
 35 
 36 public class Launcher {
 37 
 38     static {
 39         System.loadLibrary(&quot;InheritedChannel&quot;);
 40     }
 41 
 42     private static native void launch0(String cmdarray[], int fd) throws IOException;
 43 
 44     private static void launch(String className, String options[], String args[], int fd) throws IOException {
 45         // java [-options] class [args...]
 46         int optsLen = (options == null) ? 0 : options.length;
 47         int argsLen = (args == null) ? 0 : args.length;
 48         int len = 1 + optsLen + 1 + argsLen;
 49         String cmdarray[] = new String[len];
 50         int pos = 0;
 51         cmdarray[pos++] = Util.javaCommand();
 52         if (options != null) {
 53             for (String opt: options) {
 54                 cmdarray[pos++] = opt;
 55             }
 56         }
 57         cmdarray[pos++] = className;
 58         if (args != null) {
 59             for (String arg: args) {
 60                 cmdarray[pos++] = arg;
 61             }
 62         }
 63         launch0(cmdarray, fd);
 64     }
 65 
 66 
 67     /**
 68      * Launch &#39;java&#39; with specified class using a UnixDomainSocket pair linking calling
 69      * process to the child VM. UnixDomainSocket is a simplified interface to PF_UNIX sockets
 70      * which supports byte a time reads and writes.
 71      */
 72     public static UnixDomainSocket launchWithUnixDomainSocket(String className) throws IOException {
 73         UnixDomainSocket[] socks = UnixDomainSocket.socketpair();
 74         launch(className, null, null, socks[0].fd());
 75         socks[0].close();
 76         return socks[1];
 77     }
 78 
<a name="3" id="anc3"></a><span class="line-added"> 79     /**</span>
<span class="line-added"> 80      * Launch specified class with an AF_UNIX socket created externally, and one String arg to child VM</span>
<span class="line-added"> 81      */</span>
<span class="line-added"> 82     public static void launchWithUnixDomainSocket(String className, UnixDomainSocket socket, String arg) throws IOException {</span>
<span class="line-added"> 83         String[] args = new String[1];</span>
<span class="line-added"> 84         args[0] = arg;</span>
<span class="line-added"> 85         launch(className, null, args, socket.fd());</span>
<span class="line-added"> 86     }</span>
<span class="line-added"> 87 </span>
 88     /*
 89      * Launch &#39;java&#39; with specified class with the specified arguments (may be null).
 90      * The launched process will inherit a connected TCP socket. The remote endpoint
 91      * will be the SocketChannel returned by this method.
 92      */
 93     public static SocketChannel launchWithSocketChannel(String className, String options[], String args[]) throws IOException {
 94         ServerSocketChannel ssc = ServerSocketChannel.open();
<a name="4" id="anc4"></a><span class="line-modified"> 95         ssc.socket().bind(new InetSocketAddress(InetAddress.getLocalHost(), 0));</span>
 96         InetSocketAddress isa = new InetSocketAddress(InetAddress.getLocalHost(),
 97                                                       ssc.socket().getLocalPort());
 98         SocketChannel sc1 = SocketChannel.open(isa);
 99         SocketChannel sc2 = ssc.accept();
100         launch(className, options, args, Util.getFD(sc2));
101         sc2.close();
102         ssc.close();
103         return sc1;
104     }
105 
106     public static SocketChannel launchWithSocketChannel(String className, String args[]) throws IOException {
107         return launchWithSocketChannel(className, null, args);
108     }
109 
110     public static SocketChannel launchWithSocketChannel(String className) throws IOException {
111         return launchWithSocketChannel(className, null);
112     }
113 
114     /*
115      * Launch &#39;java&#39; with specified class with the specified arguments (may be null).
116      * The launched process will inherited a TCP listener socket.
117      * Once launched this method tries to connect to service. If a connection
118      * can be established a SocketChannel, connected to the service, is returned.
119      */
120     public static SocketChannel launchWithServerSocketChannel(String className, String options[], String args[])
121         throws IOException
122     {
123         ServerSocketChannel ssc = ServerSocketChannel.open();
<a name="5" id="anc5"></a><span class="line-modified">124         ssc.socket().bind(new InetSocketAddress(InetAddress.getLocalHost(), 0));</span>
125         int port = ssc.socket().getLocalPort();
126         launch(className, options, args, Util.getFD(ssc));
127         ssc.close();
128         InetSocketAddress isa = new InetSocketAddress(InetAddress.getLocalHost(), port);
129         return SocketChannel.open(isa);
130     }
131 
132     public static SocketChannel launchWithServerSocketChannel(String className, String args[]) throws IOException {
133         return launchWithServerSocketChannel(className, null, args);
134     }
135 
136     public static SocketChannel launchWithServerSocketChannel(String className) throws IOException {
137         return launchWithServerSocketChannel(className, null);
138     }
139 
140     /*
141      * Launch &#39;java&#39; with specified class with the specified arguments (may be null).
142      * The launch process will inherited a bound UDP socket.
143      * Once launched this method creates a DatagramChannel and &quot;connects
144      * it to the service. The created DatagramChannel is then returned.
145      * As it is connected any packets sent from the socket will be
146      * sent to the service.
147      */
148     public static DatagramChannel launchWithDatagramChannel(String className, String options[], String args[])
149         throws IOException
150     {
<a name="6" id="anc6"></a><span class="line-added">151         InetAddress address = InetAddress.getLocalHost();</span>
<span class="line-added">152         if (address.isLoopbackAddress()) {</span>
<span class="line-added">153             address = InetAddress.getLoopbackAddress();</span>
<span class="line-added">154         }</span>
155         DatagramChannel dc = DatagramChannel.open();
<a name="7" id="anc7"></a><span class="line-modified">156         dc.socket().bind(new InetSocketAddress(address, 0));</span>
157 
158         int port = dc.socket().getLocalPort();
159         launch(className, options, args, Util.getFD(dc));
160         dc.close();
161 
162         dc = DatagramChannel.open();
<a name="8" id="anc8"></a>



163         InetSocketAddress isa = new InetSocketAddress(address, port);
164 
165         dc.connect(isa);
166         return dc;
167     }
168 
169     public static DatagramChannel launchWithDatagramChannel(String className, String args[]) throws IOException {
170         return launchWithDatagramChannel(className, null, args);
171     }
172 
173     public static DatagramChannel launchWithDatagramChannel(String className) throws IOException {
174         return launchWithDatagramChannel(className, null);
175     }
176 }
<a name="9" id="anc9"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="9" type="hidden" />
</body>
</html>