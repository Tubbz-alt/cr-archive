<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/java/nio/channels/DatagramChannel/BasicMulticastTests.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="../Channels/Basic.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="BindNull.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/nio/channels/DatagramChannel/BasicMulticastTests.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 28  * @build jdk.test.lib.NetworkConfiguration
 29  *        jdk.test.lib.Platform
 30  *        BasicMulticastTests
 31  * @run main BasicMulticastTests
 32  */
 33 
 34 import java.nio.ByteBuffer;
 35 import java.nio.channels.*;
 36 import java.net.*;
 37 import java.util.*;
 38 import java.io.IOException;
 39 
 40 import jdk.test.lib.NetworkConfiguration;
 41 
 42 public class BasicMulticastTests {
 43 
 44     /**
 45      * Tests that existing membership key is returned by join methods and that
 46      * membership key methods return the expected results
 47      */
<span class="line-modified"> 48     static void membershipKeyTests(NetworkInterface nif,</span>
 49                                    InetAddress group,

 50                                    InetAddress source)
 51         throws IOException
 52     {
 53         System.out.format(&quot;MembershipKey test using %s @ %s\n&quot;,
 54             group.getHostAddress(), nif.getName());
 55 
<span class="line-removed"> 56         ProtocolFamily family = (group instanceof Inet4Address) ?</span>
<span class="line-removed"> 57             StandardProtocolFamily.INET : StandardProtocolFamily.INET6;</span>
<span class="line-removed"> 58 </span>
 59         DatagramChannel dc = DatagramChannel.open(family)
 60             .setOption(StandardSocketOptions.SO_REUSEADDR, true)
 61             .bind(new InetSocketAddress(source, 0));
 62 
 63         // check existing key is returned
 64         MembershipKey key = dc.join(group, nif);
 65         MembershipKey other = dc.join(group, nif);
 66         if (other != key) {
 67             throw new RuntimeException(&quot;existing key not returned&quot;);
 68         }
 69 
 70         // check key
 71         if (!key.isValid())
 72             throw new RuntimeException(&quot;key is not valid&quot;);
 73         if (!key.group().equals(group))
 74             throw new RuntimeException(&quot;group is incorrect&quot;);
 75         if (!key.networkInterface().equals(nif))
 76             throw new RuntimeException(&quot;network interface is incorrect&quot;);
 77         if (key.sourceAddress() != null)
 78             throw new RuntimeException(&quot;key is source specific&quot;);
</pre>
<hr />
<pre>
 97             if (!key.networkInterface().equals(nif))
 98                 throw new RuntimeException(&quot;network interface is incorrect&quot;);
 99             if (!key.sourceAddress().equals(source))
100                 throw new RuntimeException(&quot;key&#39;s source address incorrect&quot;);
101 
102             // drop membership
103             key.drop();
104             if (key.isValid()) {
105                 throw new RuntimeException(&quot;key is still valid&quot;);
106             }
107         } catch (UnsupportedOperationException x) {
108         }
109 
110         // done
111         dc.close();
112     }
113 
114     /**
115      * Tests exceptions for invalid arguments or scenarios
116      */
<span class="line-modified">117     static void exceptionTests(NetworkInterface nif)</span>




118         throws IOException
119     {
<span class="line-modified">120         System.out.println(&quot;Exception Tests&quot;);</span>



121 
<span class="line-modified">122         DatagramChannel dc = DatagramChannel.open(StandardProtocolFamily.INET)</span>
123             .setOption(StandardSocketOptions.SO_REUSEADDR, true)
124             .bind(new InetSocketAddress(0));
125 
<span class="line-removed">126         InetAddress group = InetAddress.getByName(&quot;225.4.5.6&quot;);</span>
<span class="line-removed">127         InetAddress notGroup = InetAddress.getByName(&quot;1.2.3.4&quot;);</span>
<span class="line-removed">128         InetAddress thisHost = InetAddress.getLocalHost();</span>
<span class="line-removed">129 </span>
130         // IllegalStateException
131         MembershipKey key;
132         key = dc.join(group, nif);
133         try {
<span class="line-modified">134             dc.join(group, nif, thisHost);</span>
135             throw new RuntimeException(&quot;IllegalStateException not thrown&quot;);
136         } catch (IllegalStateException x) {
137         } catch (UnsupportedOperationException x) {
138         }
139         key.drop();
140         try {
<span class="line-modified">141             key = dc.join(group, nif, thisHost);</span>
142             try {
143                 dc.join(group, nif);
144                 throw new RuntimeException(&quot;IllegalStateException not thrown&quot;);
145             } catch (IllegalStateException x) {
146             }
147             key.drop();
148         } catch (UnsupportedOperationException x) {
149         }
150 
151         // IllegalArgumentException
152         try {
153             dc.join(notGroup, nif);
154             throw new RuntimeException(&quot;IllegalArgumentException not thrown&quot;);
155         } catch (IllegalArgumentException x) {
156         }
157         try {
<span class="line-modified">158             dc.join(notGroup, nif, thisHost);</span>
159             throw new RuntimeException(&quot;IllegalArgumentException not thrown&quot;);
160         } catch (IllegalArgumentException x) {
161         } catch (UnsupportedOperationException x) {
162         }
163 
164         // NullPointerException
165         try {
166             dc.join(null, nif);
167             throw new RuntimeException(&quot;NullPointerException not thrown&quot;);
168         } catch (NullPointerException x) {
169         }
170         try {
171             dc.join(group, null);
172             throw new RuntimeException(&quot;NullPointerException not thrown&quot;);
173         } catch (NullPointerException x) {
174         }
175         try {
176             dc.join(group, nif, null);
177             throw new RuntimeException(&quot;NullPointerException not thrown&quot;);
178         } catch (NullPointerException x) {
179         } catch (UnsupportedOperationException x) {
180         }
181 
182         dc.close();
183 
184         // ClosedChannelException
185         try {
186             dc.join(group, nif);
187             throw new RuntimeException(&quot;ClosedChannelException not thrown&quot;);
188         } catch (ClosedChannelException x) {
189         }
190         try {
<span class="line-modified">191             dc.join(group, nif, thisHost);</span>
192             throw new RuntimeException(&quot;ClosedChannelException not thrown&quot;);
193         } catch (ClosedChannelException x) {
194         } catch (UnsupportedOperationException x) {
195         }
196     }
197 
198 
199     /**
200      * Probe interfaces to get interfaces that support IPv4 or IPv6 multicasting
201      * and invoke tests.
202      */
203     public static void main(String[] args) throws IOException {
<span class="line-modified">204 </span>
<span class="line-removed">205         // multicast groups used for the test</span>
<span class="line-removed">206         InetAddress ip4Group = InetAddress.getByName(&quot;225.4.5.6&quot;);</span>
<span class="line-removed">207         InetAddress ip6Group = InetAddress.getByName(&quot;ff02::a&quot;);</span>
<span class="line-removed">208 </span>
209 
210         NetworkConfiguration config = NetworkConfiguration.probe();
211 
<span class="line-modified">212         NetworkInterface nif = config.ip4MulticastInterfaces().iterator().next();</span>
<span class="line-modified">213         InetAddress anySource = config.ip4Addresses(nif).iterator().next();</span>
<span class="line-modified">214         membershipKeyTests(nif, ip4Group, anySource);</span>
<span class="line-modified">215         exceptionTests(nif);</span>
<span class="line-modified">216 </span>
<span class="line-modified">217         // re-run the membership key tests with IPv6 if available</span>







218 
<span class="line-modified">219         Iterator&lt;NetworkInterface&gt; iter = config.ip6MulticastInterfaces().iterator();</span>
<span class="line-modified">220         if (iter.hasNext()) {</span>
<span class="line-modified">221             nif = iter.next();</span>
<span class="line-modified">222             anySource = config.ip6Addresses(nif).iterator().next();</span>
<span class="line-modified">223             membershipKeyTests(nif, ip6Group, anySource);</span>







224         }
225     }
226 }
</pre>
</td>
<td>
<hr />
<pre>
 28  * @build jdk.test.lib.NetworkConfiguration
 29  *        jdk.test.lib.Platform
 30  *        BasicMulticastTests
 31  * @run main BasicMulticastTests
 32  */
 33 
 34 import java.nio.ByteBuffer;
 35 import java.nio.channels.*;
 36 import java.net.*;
 37 import java.util.*;
 38 import java.io.IOException;
 39 
 40 import jdk.test.lib.NetworkConfiguration;
 41 
 42 public class BasicMulticastTests {
 43 
 44     /**
 45      * Tests that existing membership key is returned by join methods and that
 46      * membership key methods return the expected results
 47      */
<span class="line-modified"> 48     static void membershipKeyTests(StandardProtocolFamily family,</span>
 49                                    InetAddress group,
<span class="line-added"> 50                                    NetworkInterface nif,</span>
 51                                    InetAddress source)
 52         throws IOException
 53     {
 54         System.out.format(&quot;MembershipKey test using %s @ %s\n&quot;,
 55             group.getHostAddress(), nif.getName());
 56 



 57         DatagramChannel dc = DatagramChannel.open(family)
 58             .setOption(StandardSocketOptions.SO_REUSEADDR, true)
 59             .bind(new InetSocketAddress(source, 0));
 60 
 61         // check existing key is returned
 62         MembershipKey key = dc.join(group, nif);
 63         MembershipKey other = dc.join(group, nif);
 64         if (other != key) {
 65             throw new RuntimeException(&quot;existing key not returned&quot;);
 66         }
 67 
 68         // check key
 69         if (!key.isValid())
 70             throw new RuntimeException(&quot;key is not valid&quot;);
 71         if (!key.group().equals(group))
 72             throw new RuntimeException(&quot;group is incorrect&quot;);
 73         if (!key.networkInterface().equals(nif))
 74             throw new RuntimeException(&quot;network interface is incorrect&quot;);
 75         if (key.sourceAddress() != null)
 76             throw new RuntimeException(&quot;key is source specific&quot;);
</pre>
<hr />
<pre>
 95             if (!key.networkInterface().equals(nif))
 96                 throw new RuntimeException(&quot;network interface is incorrect&quot;);
 97             if (!key.sourceAddress().equals(source))
 98                 throw new RuntimeException(&quot;key&#39;s source address incorrect&quot;);
 99 
100             // drop membership
101             key.drop();
102             if (key.isValid()) {
103                 throw new RuntimeException(&quot;key is still valid&quot;);
104             }
105         } catch (UnsupportedOperationException x) {
106         }
107 
108         // done
109         dc.close();
110     }
111 
112     /**
113      * Tests exceptions for invalid arguments or scenarios
114      */
<span class="line-modified">115     static void exceptionTests(StandardProtocolFamily family,</span>
<span class="line-added">116                                InetAddress group,</span>
<span class="line-added">117                                InetAddress notGroup,</span>
<span class="line-added">118                                NetworkInterface nif,</span>
<span class="line-added">119                                InetAddress loopback)</span>
120         throws IOException
121     {
<span class="line-modified">122         System.out.format(&quot;Exception Tests using %s, %s @ %s\n&quot;,</span>
<span class="line-added">123             group.getHostAddress(),</span>
<span class="line-added">124             notGroup.getHostAddress(),</span>
<span class="line-added">125             nif.getName());</span>
126 
<span class="line-modified">127         DatagramChannel dc = DatagramChannel.open(family)</span>
128             .setOption(StandardSocketOptions.SO_REUSEADDR, true)
129             .bind(new InetSocketAddress(0));
130 




131         // IllegalStateException
132         MembershipKey key;
133         key = dc.join(group, nif);
134         try {
<span class="line-modified">135             dc.join(group, nif, loopback);</span>
136             throw new RuntimeException(&quot;IllegalStateException not thrown&quot;);
137         } catch (IllegalStateException x) {
138         } catch (UnsupportedOperationException x) {
139         }
140         key.drop();
141         try {
<span class="line-modified">142             key = dc.join(group, nif, loopback);</span>
143             try {
144                 dc.join(group, nif);
145                 throw new RuntimeException(&quot;IllegalStateException not thrown&quot;);
146             } catch (IllegalStateException x) {
147             }
148             key.drop();
149         } catch (UnsupportedOperationException x) {
150         }
151 
152         // IllegalArgumentException
153         try {
154             dc.join(notGroup, nif);
155             throw new RuntimeException(&quot;IllegalArgumentException not thrown&quot;);
156         } catch (IllegalArgumentException x) {
157         }
158         try {
<span class="line-modified">159             dc.join(notGroup, nif, loopback);</span>
160             throw new RuntimeException(&quot;IllegalArgumentException not thrown&quot;);
161         } catch (IllegalArgumentException x) {
162         } catch (UnsupportedOperationException x) {
163         }
164 
165         // NullPointerException
166         try {
167             dc.join(null, nif);
168             throw new RuntimeException(&quot;NullPointerException not thrown&quot;);
169         } catch (NullPointerException x) {
170         }
171         try {
172             dc.join(group, null);
173             throw new RuntimeException(&quot;NullPointerException not thrown&quot;);
174         } catch (NullPointerException x) {
175         }
176         try {
177             dc.join(group, nif, null);
178             throw new RuntimeException(&quot;NullPointerException not thrown&quot;);
179         } catch (NullPointerException x) {
180         } catch (UnsupportedOperationException x) {
181         }
182 
183         dc.close();
184 
185         // ClosedChannelException
186         try {
187             dc.join(group, nif);
188             throw new RuntimeException(&quot;ClosedChannelException not thrown&quot;);
189         } catch (ClosedChannelException x) {
190         }
191         try {
<span class="line-modified">192             dc.join(group, nif, loopback);</span>
193             throw new RuntimeException(&quot;ClosedChannelException not thrown&quot;);
194         } catch (ClosedChannelException x) {
195         } catch (UnsupportedOperationException x) {
196         }
197     }
198 
199 
200     /**
201      * Probe interfaces to get interfaces that support IPv4 or IPv6 multicasting
202      * and invoke tests.
203      */
204     public static void main(String[] args) throws IOException {
<span class="line-modified">205         NetworkConfiguration.printSystemConfiguration(System.out);</span>




206 
207         NetworkConfiguration config = NetworkConfiguration.probe();
208 
<span class="line-modified">209         // test IPv4 if available</span>
<span class="line-modified">210         {</span>
<span class="line-modified">211             var multicastInterfaces = config.ip4MulticastInterfaces().iterator();</span>
<span class="line-modified">212             InetAddress group = InetAddress.getByName(&quot;225.4.5.6&quot;);</span>
<span class="line-modified">213             InetAddress notGroup = InetAddress.getByName(&quot;1.2.3.4&quot;);</span>
<span class="line-modified">214             InetAddress loopback = InetAddress.getByName(&quot;127.0.0.1&quot;);</span>
<span class="line-added">215             while (multicastInterfaces.hasNext()) {</span>
<span class="line-added">216                 NetworkInterface nif = multicastInterfaces.next();</span>
<span class="line-added">217                 InetAddress anySource = config.ip4Addresses(nif).iterator().next();</span>
<span class="line-added">218                 membershipKeyTests(StandardProtocolFamily.INET, group, nif, anySource);</span>
<span class="line-added">219                 exceptionTests(StandardProtocolFamily.INET, group, notGroup, nif, loopback);</span>
<span class="line-added">220             }</span>
<span class="line-added">221         }</span>
222 
<span class="line-modified">223         // test IPv6 if available</span>
<span class="line-modified">224         {</span>
<span class="line-modified">225             var multicastInterfaces = config.ip6MulticastInterfaces().iterator();</span>
<span class="line-modified">226             InetAddress group = InetAddress.getByName(&quot;ff02::a&quot;);</span>
<span class="line-modified">227             InetAddress notGroup = InetAddress.getByName(&quot;fe80::1234&quot;);</span>
<span class="line-added">228             InetAddress loopback = InetAddress.getByName(&quot;::1&quot;);</span>
<span class="line-added">229             while (multicastInterfaces.hasNext()) {</span>
<span class="line-added">230                 NetworkInterface nif = multicastInterfaces.next();</span>
<span class="line-added">231                 InetAddress anySource = config.ip6Addresses(nif).iterator().next();</span>
<span class="line-added">232                 membershipKeyTests(StandardProtocolFamily.INET6, group, nif, anySource);</span>
<span class="line-added">233                 exceptionTests(StandardProtocolFamily.INET6, group, notGroup, nif, loopback);</span>
<span class="line-added">234             }</span>
235         }
236     }
237 }
</pre>
</td>
</tr>
</table>
<center><a href="../Channels/Basic.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="BindNull.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>