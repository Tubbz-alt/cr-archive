<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff test/jdk/java/nio/channels/spi/SelectorProvider/inheritedChannel/libInheritedChannel.c</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="UnixDomainSocket.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../../../../charset/coders/Check.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/nio/channels/spi/SelectorProvider/inheritedChannel/libInheritedChannel.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2003, 2018, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2003, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 24,12 ***</span>
<span class="line-new-header">--- 24,14 ---</span>
  /*
   * A simple launcher to launch a program as if it was launched by inetd.
   */
  #include &lt;stdio.h&gt;
  #include &lt;stdlib.h&gt;
<span class="line-added">+ #include &lt;string.h&gt;</span>
  #include &lt;sys/types.h&gt;
  #include &lt;sys/socket.h&gt;
<span class="line-added">+ #include &lt;sys/un.h&gt;</span>
  #include &lt;unistd.h&gt;
  #include &lt;dirent.h&gt;
  #include &lt;sys/stat.h&gt;
  #include &lt;fcntl.h&gt;
  #include &lt;ctype.h&gt;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 145,23 ***</span>
          return;
      }
  
      /*
       * We need to close all file descriptors except for serviceFd. To
<span class="line-modified">!      * get the list of open file descriptos we read through /proc/self/fd</span>
       * but to open this requires a file descriptor. We could use a specific
       * file descriptor and fdopendir but Linux doesn&#39;t seem to support
       * fdopendir. Instead we use opendir and make an assumption on the
       * file descriptor that is used (by opening &amp; closing a file).
       */
<span class="line-modified">!     thisFd = open(&quot;/dev/null&quot;, O_RDONLY);</span>
      if (thisFd &lt; 0) {
          _exit(-1);
      }
<span class="line-removed">-     close(thisFd);</span>
  
<span class="line-modified">!     if ((dp = opendir(&quot;/proc/self/fd&quot;)) == NULL) {</span>
          _exit(-1);
      }
  
      while ((dirp = readdir(dp)) != NULL) {
          if (isdigit(dirp-&gt;d_name[0])) {
<span class="line-new-header">--- 147,22 ---</span>
          return;
      }
  
      /*
       * We need to close all file descriptors except for serviceFd. To
<span class="line-modified">!      * get the list of open file descriptos we read through /proc/self/fd (/dev/fd)</span>
       * but to open this requires a file descriptor. We could use a specific
       * file descriptor and fdopendir but Linux doesn&#39;t seem to support
       * fdopendir. Instead we use opendir and make an assumption on the
       * file descriptor that is used (by opening &amp; closing a file).
       */
<span class="line-modified">!     thisFd = open(&quot;/dev/fd&quot;, O_RDONLY);</span>
      if (thisFd &lt; 0) {
          _exit(-1);
      }
  
<span class="line-modified">!     if ((dp = fdopendir(thisFd)) == NULL) {</span>
          _exit(-1);
      }
  
      while ((dirp = readdir(dp)) != NULL) {
          if (isdigit(dirp-&gt;d_name[0])) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 214,10 ***</span>
<span class="line-new-header">--- 215,73 ---</span>
      socket = (*env)-&gt;NewObject(env, unixSocketClass, unixSocketCtor, fds[1]);
      (*env)-&gt;SetObjectArrayElement(env, result, 1, socket);
      return result;
  }
  
<span class="line-added">+ JNIEXPORT jint JNICALL Java_UnixDomainSocket_create</span>
<span class="line-added">+   (JNIEnv *env, jclass cls)</span>
<span class="line-added">+ {</span>
<span class="line-added">+     int sock = socket(AF_UNIX, SOCK_STREAM, 0);</span>
<span class="line-added">+     if (sock == -1) {</span>
<span class="line-added">+         ThrowException(env, &quot;java/io/IOException&quot;, &quot;socket create error&quot;);</span>
<span class="line-added">+     }</span>
<span class="line-added">+     return sock;</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ JNIEXPORT void JNICALL Java_UnixDomainSocket_bind0</span>
<span class="line-added">+   (JNIEnv *env, jclass cls, jint sock, jstring name)</span>
<span class="line-added">+ {</span>
<span class="line-added">+     struct sockaddr_un addr;</span>
<span class="line-added">+     const char *nameUtf = (*env)-&gt;GetStringUTFChars(env, name, NULL);</span>
<span class="line-added">+     int ret = -1;</span>
<span class="line-added">+     int length = sizeof(addr.sun_path);</span>
<span class="line-added">+     unlink(nameUtf);</span>
<span class="line-added">+     memset(&amp;addr, 0, sizeof(addr));</span>
<span class="line-added">+     addr.sun_family = AF_UNIX;</span>
<span class="line-added">+     strncpy(addr.sun_path, nameUtf, length);</span>
<span class="line-added">+     addr.sun_path[length - 1] = &#39;\0&#39;;</span>
<span class="line-added">+     ret = bind(sock, (const struct sockaddr*)&amp;addr, sizeof(addr));</span>
<span class="line-added">+     if (ret == -1) {</span>
<span class="line-added">+         ThrowException(env, &quot;java/io/IOException&quot;, &quot;socket bind error&quot;);</span>
<span class="line-added">+     }</span>
<span class="line-added">+     ret = listen(sock, 5);</span>
<span class="line-added">+     if (ret == -1) {</span>
<span class="line-added">+         ThrowException(env, &quot;java/io/IOException&quot;, &quot;socket bind error&quot;);</span>
<span class="line-added">+     }</span>
<span class="line-added">+     (*env)-&gt;ReleaseStringUTFChars(env, name, nameUtf);</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ JNIEXPORT jint JNICALL Java_UnixDomainSocket_accept0</span>
<span class="line-added">+   (JNIEnv *env, jclass cls, jint sock)</span>
<span class="line-added">+ {</span>
<span class="line-added">+     struct sockaddr_storage addr;</span>
<span class="line-added">+     socklen_t len = sizeof(addr);</span>
<span class="line-added">+     int ret = accept(sock, (struct sockaddr *)&amp;addr, &amp;len);</span>
<span class="line-added">+     if (ret == -1)</span>
<span class="line-added">+         ThrowException(env, &quot;java/io/IOException&quot;, &quot;socket accept error&quot;);</span>
<span class="line-added">+     return ret;</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ JNIEXPORT void JNICALL Java_UnixDomainSocket_connect0</span>
<span class="line-added">+   (JNIEnv *env, jclass cls, jint fd, jstring name)</span>
<span class="line-added">+ {</span>
<span class="line-added">+     struct sockaddr_un addr;</span>
<span class="line-added">+     const char *nameUtf = (*env)-&gt;GetStringUTFChars(env, name, NULL);</span>
<span class="line-added">+     int ret = -1;</span>
<span class="line-added">+     int length = sizeof(addr.sun_path);</span>
<span class="line-added">+     memset(&amp;addr, 0, sizeof(addr));</span>
<span class="line-added">+     addr.sun_family = AF_UNIX;</span>
<span class="line-added">+     strncpy(addr.sun_path, nameUtf, length);</span>
<span class="line-added">+     addr.sun_path[length - 1] = &#39;\0&#39;;</span>
<span class="line-added">+     ret = connect(fd, (const struct sockaddr*)&amp;addr, sizeof(addr));</span>
<span class="line-added">+     if (ret == -1) {</span>
<span class="line-added">+         ThrowException(env, &quot;java/io/IOException&quot;, &quot;socket connect error&quot;);</span>
<span class="line-added">+     }</span>
<span class="line-added">+     (*env)-&gt;ReleaseStringUTFChars(env, name, nameUtf);</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ </span>
  JNIEXPORT jint JNICALL Java_UnixDomainSocket_read0
    (JNIEnv *env, jclass cls, jint fd)
  {
      int ret;
      unsigned char res;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 241,9 ***</span>
          ThrowException(env, &quot;java/io/IOException&quot;, &quot;write error&quot;);
      }
  }
  
  JNIEXPORT void JNICALL Java_UnixDomainSocket_close0
<span class="line-modified">!   (JNIEnv *env, jclass cls, jint fd)</span>
  {
      close(fd);
  }
<span class="line-new-header">--- 305,14 ---</span>
          ThrowException(env, &quot;java/io/IOException&quot;, &quot;write error&quot;);
      }
  }
  
  JNIEXPORT void JNICALL Java_UnixDomainSocket_close0
<span class="line-modified">!   (JNIEnv *env, jclass cls, jint fd, jstring name)</span>
  {
      close(fd);
<span class="line-added">+     if (name != NULL) {</span>
<span class="line-added">+         const char *nameUtf = (*env)-&gt;GetStringUTFChars(env, name, NULL);</span>
<span class="line-added">+         unlink(nameUtf);</span>
<span class="line-added">+         (*env)-&gt;ReleaseStringUTFChars(env, name, nameUtf);</span>
<span class="line-added">+     }</span>
  }
</pre>
<center><a href="UnixDomainSocket.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../../../../charset/coders/Check.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>