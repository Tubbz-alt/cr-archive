<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/java/nio/channels/Selector/SelectWithConsumer.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="RacyDeregister.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="WakeupSpeed.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/nio/channels/Selector/SelectWithConsumer.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
</pre>
<hr />
<pre>
180             if (peer != null) peer.close();
181         }
182     }
183 
184     /**
185      * Test that the action is called for two selected channels
186      */
187     public void testTwoChannels() throws Exception {
188         Pipe p = Pipe.open();
189         try (Selector sel = Selector.open()) {
190             Pipe.SourceChannel source = p.source();
191             Pipe.SinkChannel sink = p.sink();
192             source.configureBlocking(false);
193             sink.configureBlocking(false);
194             SelectionKey key1 = source.register(sel, SelectionKey.OP_READ);
195             SelectionKey key2 = sink.register(sel, SelectionKey.OP_WRITE);
196 
197             // write to sink to ensure that the source is readable
198             sink.write(messageBuffer());
199 








200             var counter = new AtomicInteger();
201 
202             // select(Consumer)
203             counter.set(0);
204             int n = sel.select(k -&gt; {

205                 counter.incrementAndGet();
<span class="line-removed">206                 if (k == key1) {</span>
<span class="line-removed">207                     assertTrue(k.isReadable());</span>
<span class="line-removed">208                 } else if (k == key2) {</span>
<span class="line-removed">209                     assertTrue(k.isWritable());</span>
<span class="line-removed">210                 } else {</span>
<span class="line-removed">211                     assertTrue(false);</span>
<span class="line-removed">212                 }</span>
213             });
214             assertTrue(n == 2);
215             assertTrue(counter.get() == 2);
216 
217             // select(Consumer, timeout)
218             counter.set(0);
219             n = sel.select(k -&gt; {

220                 counter.incrementAndGet();
<span class="line-removed">221                 if (k == key1) {</span>
<span class="line-removed">222                     assertTrue(k.isReadable());</span>
<span class="line-removed">223                 } else if (k == key2) {</span>
<span class="line-removed">224                     assertTrue(k.isWritable());</span>
<span class="line-removed">225                 } else {</span>
<span class="line-removed">226                     assertTrue(false);</span>
<span class="line-removed">227                 }</span>
228             }, 1000);
229             assertTrue(n == 2);
230             assertTrue(counter.get() == 2);
231 
232             // selectNow(Consumer)
233             counter.set(0);
234             n = sel.selectNow(k -&gt; {

235                 counter.incrementAndGet();
<span class="line-removed">236                 if (k == key1) {</span>
<span class="line-removed">237                     assertTrue(k.isReadable());</span>
<span class="line-removed">238                 } else if (k == key2) {</span>
<span class="line-removed">239                     assertTrue(k.isWritable());</span>
<span class="line-removed">240                 } else {</span>
<span class="line-removed">241                     assertTrue(false);</span>
<span class="line-removed">242                 }</span>
243             });
244             assertTrue(n == 2);
245             assertTrue(counter.get() == 2);
246         } finally {
247             closePipe(p);
248         }
249     }
250 
251     /**
252      * Test calling select twice, the action should be invoked each time
253      */
254     public void testRepeatedSelect1() throws Exception {
255         Pipe p = Pipe.open();
256         try (Selector sel = Selector.open()) {
257             Pipe.SourceChannel source = p.source();
258             Pipe.SinkChannel sink = p.sink();
259             source.configureBlocking(false);
260             SelectionKey key = source.register(sel, SelectionKey.OP_READ);
261 
262             // write to sink to ensure that the source is readable
</pre>
<hr />
<pre>
447     public void testClosedSelector3() throws Exception {
448         Selector sel = Selector.open();
449         sel.close();
450         sel.selectNow(k -&gt; assertTrue(false));
451     }
452 
453     /**
454      * Test closing selector while in a selection operation
455      */
456     public void testCloseDuringSelect() throws Exception {
457         // select(Consumer)
458         try (Selector sel = Selector.open()) {
459             scheduleClose(sel, 3, SECONDS);
460             int n = sel.select(k -&gt; assertTrue(false));
461             assertTrue(n == 0);
462             assertFalse(sel.isOpen());
463         }
464 
465         // select(Consumer, timeout)
466         try (Selector sel = Selector.open()) {

467             scheduleClose(sel, 3, SECONDS);
<span class="line-modified">468             long start = System.currentTimeMillis();</span>
469             int n = sel.select(k -&gt; assertTrue(false), 60*1000);
<span class="line-modified">470             long duration = System.currentTimeMillis() - start;</span>


471             assertTrue(n == 0);
<span class="line-modified">472             assertTrue(duration &gt; 2000 &amp;&amp; duration &lt; 10*1000,</span>
<span class="line-modified">473                     &quot;select took &quot; + duration + &quot; ms&quot;);</span>

474             assertFalse(sel.isOpen());
475         }
476     }
477 
478     /**
479      * Test action closing selector
480      */
481     @Test(expectedExceptions = ClosedSelectorException.class)
482     public void testActionClosingSelector() throws Exception {
483         Pipe p = Pipe.open();
484         try (Selector sel = Selector.open()) {
485             Pipe.SourceChannel source = p.source();
486             Pipe.SinkChannel sink = p.sink();
487             source.configureBlocking(false);
488             SelectionKey key = source.register(sel, SelectionKey.OP_READ);
489 
490             // write to sink to ensure that the source is readable
491             sink.write(messageBuffer());
492 
493             // should relay ClosedSelectorException
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2018, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
</pre>
<hr />
<pre>
180             if (peer != null) peer.close();
181         }
182     }
183 
184     /**
185      * Test that the action is called for two selected channels
186      */
187     public void testTwoChannels() throws Exception {
188         Pipe p = Pipe.open();
189         try (Selector sel = Selector.open()) {
190             Pipe.SourceChannel source = p.source();
191             Pipe.SinkChannel sink = p.sink();
192             source.configureBlocking(false);
193             sink.configureBlocking(false);
194             SelectionKey key1 = source.register(sel, SelectionKey.OP_READ);
195             SelectionKey key2 = sink.register(sel, SelectionKey.OP_WRITE);
196 
197             // write to sink to ensure that the source is readable
198             sink.write(messageBuffer());
199 
<span class="line-added">200             // wait for key1 to be readable</span>
<span class="line-added">201             sel.select();</span>
<span class="line-added">202             assertTrue(key2.isWritable());</span>
<span class="line-added">203             while (!key1.isReadable()) {</span>
<span class="line-added">204                 Thread.sleep(20);</span>
<span class="line-added">205                 sel.select();</span>
<span class="line-added">206             }</span>
<span class="line-added">207 </span>
208             var counter = new AtomicInteger();
209 
210             // select(Consumer)
211             counter.set(0);
212             int n = sel.select(k -&gt; {
<span class="line-added">213                 assertTrue(k == key1 || k == key2);</span>
214                 counter.incrementAndGet();







215             });
216             assertTrue(n == 2);
217             assertTrue(counter.get() == 2);
218 
219             // select(Consumer, timeout)
220             counter.set(0);
221             n = sel.select(k -&gt; {
<span class="line-added">222                 assertTrue(k == key1 || k == key2);</span>
223                 counter.incrementAndGet();







224             }, 1000);
225             assertTrue(n == 2);
226             assertTrue(counter.get() == 2);
227 
228             // selectNow(Consumer)
229             counter.set(0);
230             n = sel.selectNow(k -&gt; {
<span class="line-added">231                 assertTrue(k == key1 || k == key2);</span>
232                 counter.incrementAndGet();







233             });
234             assertTrue(n == 2);
235             assertTrue(counter.get() == 2);
236         } finally {
237             closePipe(p);
238         }
239     }
240 
241     /**
242      * Test calling select twice, the action should be invoked each time
243      */
244     public void testRepeatedSelect1() throws Exception {
245         Pipe p = Pipe.open();
246         try (Selector sel = Selector.open()) {
247             Pipe.SourceChannel source = p.source();
248             Pipe.SinkChannel sink = p.sink();
249             source.configureBlocking(false);
250             SelectionKey key = source.register(sel, SelectionKey.OP_READ);
251 
252             // write to sink to ensure that the source is readable
</pre>
<hr />
<pre>
437     public void testClosedSelector3() throws Exception {
438         Selector sel = Selector.open();
439         sel.close();
440         sel.selectNow(k -&gt; assertTrue(false));
441     }
442 
443     /**
444      * Test closing selector while in a selection operation
445      */
446     public void testCloseDuringSelect() throws Exception {
447         // select(Consumer)
448         try (Selector sel = Selector.open()) {
449             scheduleClose(sel, 3, SECONDS);
450             int n = sel.select(k -&gt; assertTrue(false));
451             assertTrue(n == 0);
452             assertFalse(sel.isOpen());
453         }
454 
455         // select(Consumer, timeout)
456         try (Selector sel = Selector.open()) {
<span class="line-added">457             long before = System.nanoTime();</span>
458             scheduleClose(sel, 3, SECONDS);
<span class="line-modified">459             long start = System.nanoTime();</span>
460             int n = sel.select(k -&gt; assertTrue(false), 60*1000);
<span class="line-modified">461             long after = System.nanoTime();</span>
<span class="line-added">462             long selectDuration = (after - start) / 1000000;</span>
<span class="line-added">463             long scheduleDuration = (start - before) / 1000000;</span>
464             assertTrue(n == 0);
<span class="line-modified">465             assertTrue(selectDuration &gt; 2000 &amp;&amp; selectDuration &lt; 10*1000,</span>
<span class="line-modified">466                     &quot;select took &quot; + selectDuration + &quot; ms schedule took &quot; +</span>
<span class="line-added">467                     scheduleDuration + &quot; ms&quot;);</span>
468             assertFalse(sel.isOpen());
469         }
470     }
471 
472     /**
473      * Test action closing selector
474      */
475     @Test(expectedExceptions = ClosedSelectorException.class)
476     public void testActionClosingSelector() throws Exception {
477         Pipe p = Pipe.open();
478         try (Selector sel = Selector.open()) {
479             Pipe.SourceChannel source = p.source();
480             Pipe.SinkChannel sink = p.sink();
481             source.configureBlocking(false);
482             SelectionKey key = source.register(sel, SelectionKey.OP_READ);
483 
484             // write to sink to ensure that the source is readable
485             sink.write(messageBuffer());
486 
487             // should relay ClosedSelectorException
</pre>
</td>
</tr>
</table>
<center><a href="RacyDeregister.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="WakeupSpeed.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>