<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/jdk/java/nio/Buffer/Basic-X.java.template</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="../../net/ipv6tests/UdpTest.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="Basic.java.udiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/nio/Buffer/Basic-X.java.template</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2000, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -28,11 +28,21 @@</span>
   * independently of the rest of the source tree.
   */
  
  #warn This file is preprocessed before being compiled
  
<span class="udiff-line-added">+ #if[byte]</span>
<span class="udiff-line-added">+ import java.io.IOException;</span>
<span class="udiff-line-added">+ import java.io.UncheckedIOException;</span>
<span class="udiff-line-added">+ #end[byte]</span>
  import java.nio.*;
<span class="udiff-line-added">+ #if[byte]</span>
<span class="udiff-line-added">+ import java.nio.channels.FileChannel;</span>
<span class="udiff-line-added">+ import java.nio.file.Files;</span>
<span class="udiff-line-added">+ import java.nio.file.Path;</span>
<span class="udiff-line-added">+ import java.util.Random;</span>
<span class="udiff-line-added">+ #end[byte]</span>
  
  
  public class Basic$Type$
      extends Basic
  {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -467,10 +477,77 @@</span>
                  if (as.limit() != ec) {
                      fail(&quot;Buffer capacity incorrect, expected: &quot; + ec, as);
                  }
              }
          }
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         // mapped buffers</span>
<span class="udiff-line-added">+         try {</span>
<span class="udiff-line-added">+             for (MappedByteBuffer bb : mappedBuffers()) {</span>
<span class="udiff-line-added">+                 try {</span>
<span class="udiff-line-added">+                     int offset = bb.alignmentOffset(1, 4);</span>
<span class="udiff-line-added">+                     ck(bb, offset &gt;= 0);</span>
<span class="udiff-line-added">+                 } catch (UnsupportedOperationException e) {</span>
<span class="udiff-line-added">+                     System.out.println(&quot;Not applicable, UOE thrown: &quot;);</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         } catch (IOException e) {</span>
<span class="udiff-line-added">+             throw new UncheckedIOException(e);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         // alignment identities</span>
<span class="udiff-line-added">+         final int maxPow2 = 12;</span>
<span class="udiff-line-added">+         ByteBuffer bb = ByteBuffer.allocateDirect(1 &lt;&lt; maxPow2); // cap 4096</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         Random rnd = new Random();</span>
<span class="udiff-line-added">+         long seed = rnd.nextLong();</span>
<span class="udiff-line-added">+         rnd = new Random(seed);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         for (int i = 0; i &lt; 100; i++) {</span>
<span class="udiff-line-added">+             // 1 == 2^0 &lt;= unitSize == 2^k &lt;= bb.capacity()/2</span>
<span class="udiff-line-added">+             int unitSize = 1 &lt;&lt; rnd.nextInt(maxPow2);</span>
<span class="udiff-line-added">+             // 0 &lt;= index &lt; 2*unitSize</span>
<span class="udiff-line-added">+             int index = rnd.nextInt(unitSize &lt;&lt; 1);</span>
<span class="udiff-line-added">+             int value = bb.alignmentOffset(index, unitSize);</span>
<span class="udiff-line-added">+             try {</span>
<span class="udiff-line-added">+                 if (value &lt; 0 || value &gt;= unitSize) {</span>
<span class="udiff-line-added">+                     throw new RuntimeException(value + &quot; &lt; 0 || &quot; +</span>
<span class="udiff-line-added">+                         value + &quot; &gt;= &quot; + unitSize);</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+                 if (value &lt;= index &amp;&amp;</span>
<span class="udiff-line-added">+                     bb.alignmentOffset(index - value, unitSize) != 0)</span>
<span class="udiff-line-added">+                     throw new RuntimeException(&quot;Identity 1&quot;);</span>
<span class="udiff-line-added">+                 if (bb.alignmentOffset(index + (unitSize - value),</span>
<span class="udiff-line-added">+                     unitSize) != 0)</span>
<span class="udiff-line-added">+                     throw new RuntimeException(&quot;Identity 2&quot;);</span>
<span class="udiff-line-added">+             } catch (RuntimeException re) {</span>
<span class="udiff-line-added">+                 System.err.format(&quot;seed %d, index %d, unitSize %d, value %d%n&quot;,</span>
<span class="udiff-line-added">+                     seed, index, unitSize, value);</span>
<span class="udiff-line-added">+                 throw re;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private static MappedByteBuffer[] mappedBuffers() throws IOException {</span>
<span class="udiff-line-added">+         return new MappedByteBuffer[]{</span>
<span class="udiff-line-added">+                 createMappedBuffer(new byte[]{0, 1, 2, 3}),</span>
<span class="udiff-line-added">+                 createMappedBuffer(new byte[]{0, 1, 2, -3,</span>
<span class="udiff-line-added">+                     45, 6, 7, 78, 3, -7, 6, 7, -128, 127}),</span>
<span class="udiff-line-added">+         };</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private static MappedByteBuffer createMappedBuffer(byte[] contents)</span>
<span class="udiff-line-added">+         throws IOException {</span>
<span class="udiff-line-added">+         Path tempFile = Files.createTempFile(&quot;mbb&quot;, null);</span>
<span class="udiff-line-added">+         tempFile.toFile().deleteOnExit();</span>
<span class="udiff-line-added">+         Files.write(tempFile, contents);</span>
<span class="udiff-line-added">+         try (FileChannel fc = FileChannel.open(tempFile)) {</span>
<span class="udiff-line-added">+             MappedByteBuffer map =</span>
<span class="udiff-line-added">+                 fc.map(FileChannel.MapMode.READ_ONLY, 0, contents.length);</span>
<span class="udiff-line-added">+             map.load();</span>
<span class="udiff-line-added">+             return map;</span>
<span class="udiff-line-added">+         }</span>
      }
  #end[byte]
  
      private static void fail(String problem,
                               $Type$Buffer xb, $Type$Buffer yb,
</pre>
<center><a href="../../net/ipv6tests/UdpTest.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="Basic.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>