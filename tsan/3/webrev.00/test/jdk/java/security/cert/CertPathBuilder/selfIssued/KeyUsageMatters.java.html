<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New test/jdk/java/security/cert/CertPathBuilder/selfIssued/KeyUsageMatters.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2009, 2014, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 //
 25 // Security properties, once set, cannot revert to unset.  To avoid
 26 // conflicts with tests running in the same VM isolate this test by
 27 // running it in otherVM mode.
 28 //
 29 
 30 /**
 31  * @test
 32  * @bug 6852744 8133489
 33  * @summary PIT b61: PKI test suite fails because self signed certificates
 34  *          are being rejected
 35  * @modules java.base/sun.security.util
 36  * @run main/othervm -Djava.security.debug=certpath KeyUsageMatters subca
 37  * @run main/othervm -Djava.security.debug=certpath KeyUsageMatters subci
 38  * @run main/othervm -Djava.security.debug=certpath KeyUsageMatters alice
 39  * @author Xuelei Fan
 40  */
 41 
 42 import java.io.*;
 43 import java.net.SocketException;
 44 import java.util.*;
 45 import java.security.Security;
 46 import java.security.cert.*;
 47 import java.security.cert.CertPathValidatorException.BasicReason;
 48 import sun.security.util.DerInputStream;
 49 
 50 /**
 51  * KeyUsage extension plays a important rule during looking for the issuer
 52  * of a certificate or CRL. A certificate issuer should have the keyCertSign
 53  * bit set, and a CRL issuer should have the cRLSign bit set.
 54  *
 55  * Sometime, a delegated CRL issuer would also have the keyCertSign bit set,
 56  * as would be troublesome to find the proper CRL issuer during certificate
 57  * path build if the delegated CRL issuer is a self-issued certificate, for
 58  * it is hard to identify it from its issuer by the &quot;issuer&quot; field only.
 59  *
 60  * The fix of 6852744 should addresses above issue, and allow a delegated CRL
 61  * issuer to have keyCertSign bit set.
 62  *
 63  * In the test case, the delegated CRL issuers have cRLSign bit set only, and
 64  * the CAs have the keyCertSign bit set only, it is expected to work before
 65  * and after the bug fix of 6852744.
 66  */
 67 public final class KeyUsageMatters {
 68 
 69     // the trust anchor
 70     static String selfSignedCertStr =
 71         &quot;-----BEGIN CERTIFICATE-----\n&quot; +
 72         &quot;MIICPjCCAaegAwIBAgIBADANBgkqhkiG9w0BAQQFADAfMQswCQYDVQQGEwJVUzEQ\n&quot; +
 73         &quot;MA4GA1UEChMHRXhhbXBsZTAeFw0wOTA0MjcwMjI0MzJaFw0zMDA0MDcwMjI0MzJa\n&quot; +
 74         &quot;MB8xCzAJBgNVBAYTAlVTMRAwDgYDVQQKEwdFeGFtcGxlMIGfMA0GCSqGSIb3DQEB\n&quot; +
 75         &quot;AQUAA4GNADCBiQKBgQC4OTag24sTxL2tXTNuvpmUEtdxrYAZoFsslFQ60T+WD9wQ\n&quot; +
 76         &quot;Jeiw87FSPsR2vxRuv0j8DNm2a4h7LNNIFcLurfNldbz5pvgZ7VqdbbUMPE9qP85n\n&quot; +
 77         &quot;jgDl4woyRTSUeRI4A7O0CO6NpES21dtbdhroWQrEkHxpnrDPxsxrz5gf2m3gqwID\n&quot; +
 78         &quot;AQABo4GJMIGGMB0GA1UdDgQWBBSCJd0hpl5PdAD9IZS+Hzng4lXLGzBHBgNVHSME\n&quot; +
 79         &quot;QDA+gBSCJd0hpl5PdAD9IZS+Hzng4lXLG6EjpCEwHzELMAkGA1UEBhMCVVMxEDAO\n&quot; +
 80         &quot;BgNVBAoTB0V4YW1wbGWCAQAwDwYDVR0TAQH/BAUwAwEB/zALBgNVHQ8EBAMCAgQw\n&quot; +
 81         &quot;DQYJKoZIhvcNAQEEBQADgYEAluy6HIjWcq009lTLmhp+Np6dxU78pInBK8RZkza0\n&quot; +
 82         &quot;484qGaxFGD3UGyZkI5uWmsH2XuMbuox5khfIq6781gmkPBHXBIEtJN8eLusOHEye\n&quot; +
 83         &quot;iE8h7WI+N3qa6Pj56WionMrioqC/3X+b06o147bbhx8U0vkYv/HyPaITOFfMXTdz\n&quot; +
 84         &quot;Vjw=\n&quot; +
 85         &quot;-----END CERTIFICATE-----&quot;;
 86 
 87     // the sub-ca
 88     static String subCaCertStr =
 89         &quot;-----BEGIN CERTIFICATE-----\n&quot; +
 90         &quot;MIICUDCCAbmgAwIBAgIBAzANBgkqhkiG9w0BAQQFADAfMQswCQYDVQQGEwJVUzEQ\n&quot; +
 91         &quot;MA4GA1UEChMHRXhhbXBsZTAeFw0wOTA0MjcwMjI0MzRaFw0yOTAxMTIwMjI0MzRa\n&quot; +
 92         &quot;MDExCzAJBgNVBAYTAlVTMRAwDgYDVQQKEwdFeGFtcGxlMRAwDgYDVQQLEwdDbGFz\n&quot; +
 93         &quot;cy0xMIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQCiAJnAQW2ad3ZMKUhSJVZj\n&quot; +
 94         &quot;8pBqxTcHSTwAVguQkDglsN/OIwUpvR5Jgp3lpRWUEt6idEp0FZzORpvtjt3pr5MG\n&quot; +
 95         &quot;Eg2CDptekC5BSPS+fIAIKlncB3HwOiFFhH6b3wTydDCdEd2fvsi4QMOSVrIYMeA8\n&quot; +
 96         &quot;P/mCz6kRhfUQPE0CMmOUewIDAQABo4GJMIGGMB0GA1UdDgQWBBT0/nNP8WpyxmYr\n&quot; +
 97         &quot;IBp4tN8y08jw2jBHBgNVHSMEQDA+gBSCJd0hpl5PdAD9IZS+Hzng4lXLG6EjpCEw\n&quot; +
 98         &quot;HzELMAkGA1UEBhMCVVMxEDAOBgNVBAoTB0V4YW1wbGWCAQAwDwYDVR0TAQH/BAUw\n&quot; +
 99         &quot;AwEB/zALBgNVHQ8EBAMCAgQwDQYJKoZIhvcNAQEEBQADgYEAS9PzI6B39R/U9fRj\n&quot; +
100         &quot;UExzN1FXNP5awnAPtiv34kSCL6n6MryqkfG+8aaAOdZsSjmTylNFaF7cW/Xp1VBF\n&quot; +
101         &quot;hq0bg/SbEAbK7+UwL8GSC3crhULHLbh+1iFdVTEwxCw5YmB8ji3BaZ/WKW/PkjCZ\n&quot; +
102         &quot;7cXP6VDeZMG6oRQ4hbOcixoFPXo=\n&quot; +
103         &quot;-----END CERTIFICATE-----&quot;;
104 
105     // a delegated CRL issuer, it&#39;s a self-issued certificate of trust anchor
106     static String topCrlIssuerCertStr =
107         &quot;-----BEGIN CERTIFICATE-----\n&quot; +
108         &quot;MIICKzCCAZSgAwIBAgIBAjANBgkqhkiG9w0BAQQFADAfMQswCQYDVQQGEwJVUzEQ\n&quot; +
109         &quot;MA4GA1UEChMHRXhhbXBsZTAeFw0wOTA0MjcwMjI0MzNaFw0yOTAxMTIwMjI0MzNa\n&quot; +
110         &quot;MB8xCzAJBgNVBAYTAlVTMRAwDgYDVQQKEwdFeGFtcGxlMIGfMA0GCSqGSIb3DQEB\n&quot; +
111         &quot;AQUAA4GNADCBiQKBgQDMJeBMBybHykI/YpwUJ4O9euqDSLb1kpWpceBS8TVqvgBC\n&quot; +
112         &quot;SgUJWtFZL0i6bdvF6mMdlbuBkGzhXqHiVAi96/zRLbUC9F8SMEJ6MuD+YhQ0ZFTQ\n&quot; +
113         &quot;atKy8zf8O9XzztelLJ26Gqb7QPV133WY3haAqHtCXOhEKkCN16NOYNC37DTaJwID\n&quot; +
114         &quot;AQABo3cwdTAdBgNVHQ4EFgQULXSWzXzUOIpOJpzbSCpW42IJUugwRwYDVR0jBEAw\n&quot; +
115         &quot;PoAUgiXdIaZeT3QA/SGUvh854OJVyxuhI6QhMB8xCzAJBgNVBAYTAlVTMRAwDgYD\n&quot; +
116         &quot;VQQKEwdFeGFtcGxlggEAMAsGA1UdDwQEAwIBAjANBgkqhkiG9w0BAQQFAAOBgQAY\n&quot; +
117         &quot;eMnf5AHSNlyUlzXk8o2S0h4gCuvKX6C3kFfKuZcWvFAbx4yQOWLS2s15/nzR4+AP\n&quot; +
118         &quot;FGX3lgJjROyAh7fGedTQK+NFWwkM2ag1g3hXktnlnT1qHohi0w31nVBJxXEDO/Ck\n&quot; +
119         &quot;uJTpJGt8XxxbFaw5v7cHy7XuTAeU/sekvjEiNHW00Q==\n&quot; +
120         &quot;-----END CERTIFICATE-----&quot;;
121 
122     // a delegated CRL issuer, it&#39;s a self-issued certificate of sub-ca
123     static String subCrlIssuerCertStr =
124         &quot;-----BEGIN CERTIFICATE-----\n&quot; +
125         &quot;MIICPTCCAaagAwIBAgIBBDANBgkqhkiG9w0BAQQFADAfMQswCQYDVQQGEwJVUzEQ\n&quot; +
126         &quot;MA4GA1UEChMHRXhhbXBsZTAeFw0wOTA0MjcwMjI0MzRaFw0yOTAxMTIwMjI0MzRa\n&quot; +
127         &quot;MDExCzAJBgNVBAYTAlVTMRAwDgYDVQQKEwdFeGFtcGxlMRAwDgYDVQQLEwdDbGFz\n&quot; +
128         &quot;cy0xMIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDWUtDQx2MB/7arDiquMJyd\n&quot; +
129         &quot;LWwSg6p8sg5z6wKrC1v47MT4DBhFX+0RUgTMUdQgYpgxGpczn+6y4zfV76064S0N\n&quot; +
130         &quot;4L/IQ+SunTW1w4yRGjB+xkyyJmWAqijG1nr+Dgkv5nxPI+9Er5lHcoVWVMEcvvRm\n&quot; +
131         &quot;6jIBQdldVlSgv+VgUnFm5wIDAQABo3cwdTAdBgNVHQ4EFgQUkV3Qqtk7gIot9n60\n&quot; +
132         &quot;jX6dloxrfMEwRwYDVR0jBEAwPoAUgiXdIaZeT3QA/SGUvh854OJVyxuhI6QhMB8x\n&quot; +
133         &quot;CzAJBgNVBAYTAlVTMRAwDgYDVQQKEwdFeGFtcGxlggEAMAsGA1UdDwQEAwIBAjAN\n&quot; +
134         &quot;BgkqhkiG9w0BAQQFAAOBgQADu4GM8EdmIKhC7FRvk5jF90zfvZ38wbXBzCjKI4jX\n&quot; +
135         &quot;QJrhne1bfyeNNm5c1w+VKidT+XzBzBGH7ZqYzoZmzRIfcbLKX2brEBKiukeeAyL3\n&quot; +
136         &quot;bctQtbp19tX+uu2dQberD188AAysKTkHcJUV+rRsTwVJ9vcYKxoRxKk8DhH7ZS3M\n&quot; +
137         &quot;rg==\n&quot; +
138         &quot;-----END CERTIFICATE-----&quot;;
139 
140     // the target EE certificate
141     static String targetCertStr =
142         &quot;-----BEGIN CERTIFICATE-----\n&quot; +
143         &quot;MIICNzCCAaCgAwIBAgIBAjANBgkqhkiG9w0BAQQFADAxMQswCQYDVQQGEwJVUzEQ\n&quot; +
144         &quot;MA4GA1UEChMHRXhhbXBsZTEQMA4GA1UECxMHQ2xhc3MtMTAeFw0wOTA0MjcwMjI0\n&quot; +
145         &quot;MzZaFw0yOTAxMTIwMjI0MzZaMEExCzAJBgNVBAYTAlVTMRAwDgYDVQQKEwdFeGFt\n&quot; +
146         &quot;cGxlMRAwDgYDVQQLEwdDbGFzcy0xMQ4wDAYDVQQDEwVBbGljZTCBnzANBgkqhkiG\n&quot; +
147         &quot;9w0BAQEFAAOBjQAwgYkCgYEAvYSaU3oiE4Pxp/aUIXwMqOwSiWkZ+O3aTu13hRtK\n&quot; +
148         &quot;ZyR+Wtj63IuvaigAC4uC+zBypF93ThjwCzVR2qKDQaQzV8CLleO96gStt7Y+i3G2\n&quot; +
149         &quot;V3IUGgrVCqeK7N6nNYu0wW84sibcPqG/TIy0UoaQMqgB21xtRF+1DUVlFh4Z89X/\n&quot; +
150         &quot;pskCAwEAAaNPME0wCwYDVR0PBAQDAgPoMB0GA1UdDgQWBBSynMEdcal/e9TmvlNE\n&quot; +
151         &quot;4suXGA4+hjAfBgNVHSMEGDAWgBT0/nNP8WpyxmYrIBp4tN8y08jw2jANBgkqhkiG\n&quot; +
152         &quot;9w0BAQQFAAOBgQB/jru7E/+piSmUwByw5qbZsoQZVcgR97pd2TErNJpJMAX2oIHR\n&quot; +
153         &quot;wJH6w4NuYs27+fEAX7wK4whc6EUH/w1SI6o28F2rG6HqYQPPZ2E2WqwbBQL9nYE3\n&quot; +
154         &quot;Vfzu/G9axTUQXFbf90h80UErA+mZVxqc2xtymLuH0YEaMZImtRZ2MXHfXg==\n&quot; +
155         &quot;-----END CERTIFICATE-----&quot;;
156 
157     // CRL issued by the delegated CRL issuer, topCrlIssuerCertStr
158     static String topCrlStr =
159         &quot;-----BEGIN X509 CRL-----\n&quot; +
160         &quot;MIIBGzCBhQIBATANBgkqhkiG9w0BAQQFADAfMQswCQYDVQQGEwJVUzEQMA4GA1UE\n&quot; +
161         &quot;ChMHRXhhbXBsZRcNMDkwNDI3MDIzODA0WhcNMjgwNjI2MDIzODA0WjAiMCACAQUX\n&quot; +
162         &quot;DTA5MDQyNzAyMzgwMFowDDAKBgNVHRUEAwoBBKAOMAwwCgYDVR0UBAMCAQIwDQYJ\n&quot; +
163         &quot;KoZIhvcNAQEEBQADgYEAoarfzXEtw3ZDi4f9U8eSvRIipHSyxOrJC7HR/hM5VhmY\n&quot; +
164         &quot;CErChny6x9lBVg9s57tfD/P9PSzBLusCcHwHMAbMOEcTltVVKUWZnnbumpywlYyg\n&quot; +
165         &quot;oKLrE9+yCOkYUOpiRlz43/3vkEL5hjIKMcDSZnPKBZi1h16Yj2hPe9GMibNip54=\n&quot; +
166         &quot;-----END X509 CRL-----&quot;;
167 
168     // CRL issued by the delegated CRL issuer, subCrlIssuerCertStr
169     static String subCrlStr =
170         &quot;-----BEGIN X509 CRL-----\n&quot; +
171         &quot;MIIBLTCBlwIBATANBgkqhkiG9w0BAQQFADAxMQswCQYDVQQGEwJVUzEQMA4GA1UE\n&quot; +
172         &quot;ChMHRXhhbXBsZTEQMA4GA1UECxMHQ2xhc3MtMRcNMDkwNDI3MDIzODA0WhcNMjgw\n&quot; +
173         &quot;NjI2MDIzODA0WjAiMCACAQQXDTA5MDQyNzAyMzgwMVowDDAKBgNVHRUEAwoBBKAO\n&quot; +
174         &quot;MAwwCgYDVR0UBAMCAQIwDQYJKoZIhvcNAQEEBQADgYEAeS+POqYEIHIIJcsLxuUr\n&quot; +
175         &quot;aJFzQ/ujH0QmnyMNEL3Uavyq4VQuAahF+w6aTPb5UBzms0uX8NAvD2vNoUJvmJOX\n&quot; +
176         &quot;nGKuq4Q1DFj82E7/9d25nXdWGOmFvFCRVO+St2Xe5n8CJuZNBiz388FDSIOiFSCa\n&quot; +
177         &quot;ARGr6Qu68MYGtLMC6ZqP3u0=\n&quot; +
178         &quot;-----END X509 CRL-----&quot;;
179 
180     private static Set&lt;TrustAnchor&gt; generateTrustAnchors()
181             throws CertificateException {
182         // generate certificate from cert string
183         CertificateFactory cf = CertificateFactory.getInstance(&quot;X.509&quot;);
184 
185         ByteArrayInputStream is =
186                     new ByteArrayInputStream(selfSignedCertStr.getBytes());
187         Certificate selfSignedCert = cf.generateCertificate(is);
188 
189         // generate a trust anchor
190         TrustAnchor anchor =
191             new TrustAnchor((X509Certificate)selfSignedCert, null);
192 
193         return Collections.singleton(anchor);
194     }
195 
196     private static CertStore generateCertificateStore() throws Exception {
197         Collection entries = new HashSet();
198 
199         // generate certificate from certificate string
200         CertificateFactory cf = CertificateFactory.getInstance(&quot;X.509&quot;);
201 
202         ByteArrayInputStream is;
203 
204         is = new ByteArrayInputStream(targetCertStr.getBytes());
205         Certificate cert = cf.generateCertificate(is);
206         entries.add(cert);
207 
208         is = new ByteArrayInputStream(subCaCertStr.getBytes());
209         cert = cf.generateCertificate(is);
210         entries.add(cert);
211 
212         is = new ByteArrayInputStream(selfSignedCertStr.getBytes());
213         cert = cf.generateCertificate(is);
214         entries.add(cert);
215 
216         is = new ByteArrayInputStream(topCrlIssuerCertStr.getBytes());
217         cert = cf.generateCertificate(is);
218         entries.add(cert);
219 
220         is = new ByteArrayInputStream(subCrlIssuerCertStr.getBytes());
221         cert = cf.generateCertificate(is);
222         entries.add(cert);
223 
224         // generate CRL from CRL string
225         is = new ByteArrayInputStream(topCrlStr.getBytes());
226         Collection mixes = cf.generateCRLs(is);
227         entries.addAll(mixes);
228 
229         is = new ByteArrayInputStream(subCrlStr.getBytes());
230         mixes = cf.generateCRLs(is);
231         entries.addAll(mixes);
232 
233         return CertStore.getInstance(&quot;Collection&quot;,
234                             new CollectionCertStoreParameters(entries));
235     }
236 
237     private static X509CertSelector generateSelector(String name)
238                 throws Exception {
239         X509CertSelector selector = new X509CertSelector();
240 
241         // generate certificate from certificate string
242         CertificateFactory cf = CertificateFactory.getInstance(&quot;X.509&quot;);
243         ByteArrayInputStream is = null;
244         if (name.equals(&quot;subca&quot;)) {
245             is = new ByteArrayInputStream(subCaCertStr.getBytes());
246         } else if (name.equals(&quot;subci&quot;)) {
247             is = new ByteArrayInputStream(subCrlIssuerCertStr.getBytes());
248         } else {
249             is = new ByteArrayInputStream(targetCertStr.getBytes());
250         }
251 
252         X509Certificate target = (X509Certificate)cf.generateCertificate(is);
253         byte[] extVal = target.getExtensionValue(&quot;2.5.29.14&quot;);
254         if (extVal != null) {
255             DerInputStream in = new DerInputStream(extVal);
256             byte[] subjectKID = in.getOctetString();
257             selector.setSubjectKeyIdentifier(subjectKID);
258         } else {
259             // unlikely to happen.
260             throw new Exception(&quot;unexpected certificate: no SKID extension&quot;);
261         }
262 
263         return selector;
264     }
265 
266     private static boolean match(String name, Certificate cert)
267                 throws Exception {
268         X509CertSelector selector = new X509CertSelector();
269 
270         // generate certificate from certificate string
271         CertificateFactory cf = CertificateFactory.getInstance(&quot;X.509&quot;);
272         ByteArrayInputStream is = null;
273         if (name.equals(&quot;subca&quot;)) {
274             is = new ByteArrayInputStream(subCaCertStr.getBytes());
275         } else if (name.equals(&quot;subci&quot;)) {
276             is = new ByteArrayInputStream(subCrlIssuerCertStr.getBytes());
277         } else {
278             is = new ByteArrayInputStream(targetCertStr.getBytes());
279         }
280         X509Certificate target = (X509Certificate)cf.generateCertificate(is);
281 
282         return target.equals(cert);
283     }
284 
285 
286     public static void main(String[] args) throws Exception {
287         // MD5 is used in this test case, don&#39;t disable MD5 algorithm.
288         Security.setProperty(
289                 &quot;jdk.certpath.disabledAlgorithms&quot;, &quot;MD2, RSA keySize &lt; 1024&quot;);
290 
291         CertPathBuilder builder = CertPathBuilder.getInstance(&quot;PKIX&quot;);
292 
293         X509CertSelector selector = generateSelector(args[0]);
294 
295         Set&lt;TrustAnchor&gt; anchors = generateTrustAnchors();
296         CertStore certs = generateCertificateStore();
297 
298 
299         PKIXBuilderParameters params =
300                 new PKIXBuilderParameters(anchors, selector);
301         params.addCertStore(certs);
302         params.setRevocationEnabled(true);
303         params.setDate(new Date(109, 5, 1));   // 2009-05-01
304         Security.setProperty(&quot;ocsp.enable&quot;, &quot;false&quot;);
305         System.setProperty(&quot;com.sun.security.enableCRLDP&quot;, &quot;true&quot;);
306 
307         PKIXCertPathBuilderResult result =
308                 (PKIXCertPathBuilderResult)builder.build(params);
309 
310         if (!match(args[0], result.getCertPath().getCertificates().get(0))) {
311             throw new Exception(&quot;unexpected certificate&quot;);
312         }
313     }
314 }
    </pre>
  </body>
</html>