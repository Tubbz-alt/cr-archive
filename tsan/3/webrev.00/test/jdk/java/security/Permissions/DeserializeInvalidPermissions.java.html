<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New test/jdk/java/security/Permissions/DeserializeInvalidPermissions.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @bug 8020637
 27  * @summary Deserialize a serialized Permissions object with incorrect Class to
 28  *          Permission mappings
 29  */
 30 
 31 import java.io.ByteArrayInputStream;
 32 import java.io.InvalidObjectException;
 33 import java.io.ObjectInputStream;
 34 import java.security.Permissions;
 35 import java.util.Base64;
 36 
 37 public class DeserializeInvalidPermissions {
 38 
 39     private static final String BASE = System.getProperty(&quot;test.src&quot;, &quot;.&quot;);
 40 
 41     /**
 42      * A base64 encoded serialized Permissions object. This contains two
 43      * Permissions, SecurityPermission(&quot;foo&quot;) and FilePermission(&quot;bar&quot;, &quot;read&quot;).
 44      * However, the Hashtable mappings have been switched, such that
 45      * FilePermission.class maps to BasicPermissionCollection (which contains
 46      * the SecurityPermission) and SecurityPermission.class maps to
 47      * FilePermissionCollection.
 48      */
 49     private static String INVALID_PERMISSIONS =
 50         &quot;rO0ABXNyABlqYXZhLnNlY3VyaXR5LlBlcm1pc3Npb25zQ21LTdLID1ADAAJMAA1hbGxQ&quot; +
 51         &quot;ZXJtaXNzaW9udAAkTGphdmEvc2VjdXJpdHkvUGVybWlzc2lvbkNvbGxlY3Rpb247TAAF&quot; +
 52         &quot;cGVybXN0ABVMamF2YS91dGlsL0hhc2h0YWJsZTt4cgAiamF2YS5zZWN1cml0eS5QZXJt&quot; +
 53         &quot;aXNzaW9uQ29sbGVjdGlvbqKk2tZqGAkpAgABWgAIcmVhZE9ubHl4cABwc3IAE2phdmEu&quot; +
 54         &quot;dXRpbC5IYXNodGFibGUTuw8lIUrkuAMAAkYACmxvYWRGYWN0b3JJAAl0aHJlc2hvbGR4&quot; +
 55         &quot;cD9AAAAAAAADdwgAAAAEAAAAAnZyABZqYXZhLmlvLkZpbGVQZXJtaXNzaW9ubg+fk/TA&quot; +
 56         &quot;qbsDAAFMAAdhY3Rpb25zdAASTGphdmEvbGFuZy9TdHJpbmc7eHIAGGphdmEuc2VjdXJp&quot; +
 57         &quot;dHkuUGVybWlzc2lvbrHG4T8oV1F+AgABTAAEbmFtZXEAfgAIeHBzcgAnamF2YS5zZWN1&quot; +
 58         &quot;cml0eS5CYXNpY1Blcm1pc3Npb25Db2xsZWN0aW9uCkKHBI3t48cDAANaAAthbGxfYWxs&quot; +
 59         &quot;b3dlZEwACXBlcm1DbGFzc3QAEUxqYXZhL2xhbmcvQ2xhc3M7TAALcGVybWlzc2lvbnNx&quot; +
 60         &quot;AH4AAnhxAH4AAwAAdnIAIGphdmEuc2VjdXJpdHkuU2VjdXJpdHlQZXJtaXNzaW9uSKpm&quot; +
 61         &quot;PrGHHSYCAAB4cgAdamF2YS5zZWN1cml0eS5CYXNpY1Blcm1pc3Npb25XJQvcz06megIA&quot; +
 62         &quot;AHhxAH4ACXNxAH4ABT9AAAAAAAABdwgAAAACAAAAAXQAA2Zvb3NxAH4ADnEAfgASeHhx&quot; +
 63         &quot;AH4AEHNyACBqYXZhLmlvLkZpbGVQZXJtaXNzaW9uQ29sbGVjdGlvbh6SeX3UjlWpAwAB&quot; +
 64         &quot;TAALcGVybWlzc2lvbnN0ABJMamF2YS91dGlsL1ZlY3Rvcjt4cQB+AAMAc3IAEGphdmEu&quot; +
 65         &quot;dXRpbC5WZWN0b3LZl31bgDuvAQMAA0kAEWNhcGFjaXR5SW5jcmVtZW50SQAMZWxlbWVu&quot; +
 66         &quot;dENvdW50WwALZWxlbWVudERhdGF0ABNbTGphdmEvbGFuZy9PYmplY3Q7eHAAAAAAAAAA&quot; +
 67         &quot;AXVyABNbTGphdmEubGFuZy5PYmplY3Q7kM5YnxBzKWwCAAB4cAAAAAFzcQB+AAd0AANi&quot; +
 68         &quot;YXJ0AARyZWFkeHh4eHg=&quot;;
 69 
 70     /**
 71      * A base64 encoded serialized PermissionsHash object, which is an internal
 72      * class used to store Permissions that do not implement their own
 73      * PermissionCollection. This contains one Permission,
 74      * PrivateCredentialPermission(&quot;a.b.PrivateCredential a.b.Principal
 75      *                              \&quot;duke\&quot;&quot;, &quot;read&quot;)
 76      * However, the Hashtable entry has been modified to map the
 77      * PrivateCredentialPermission to SecurityPermission(&quot;foo&quot;) instead of
 78      * itself.
 79      */
 80     private static String INVALID_PERMISSIONS_HASH =
 81         &quot;rO0ABXNyABlqYXZhLnNlY3VyaXR5LlBlcm1pc3Npb25zQ21LTdLID1ADAAJMAA1hbGxQ&quot; +
 82         &quot;ZXJtaXNzaW9udAAkTGphdmEvc2VjdXJpdHkvUGVybWlzc2lvbkNvbGxlY3Rpb247TAAF&quot; +
 83         &quot;cGVybXN0ABVMamF2YS91dGlsL0hhc2h0YWJsZTt4cgAiamF2YS5zZWN1cml0eS5QZXJt&quot; +
 84         &quot;aXNzaW9uQ29sbGVjdGlvbqKk2tZqGAkpAgABWgAIcmVhZE9ubHl4cAFwc3IAE2phdmEu&quot; +
 85         &quot;dXRpbC5IYXNodGFibGUTuw8lIUrkuAMAAkYACmxvYWRGYWN0b3JJAAl0aHJlc2hvbGR4&quot; +
 86         &quot;cD9AAAAAAAAEdwgAAAAGAAAAA3ZyABZqYXZhLmlvLkZpbGVQZXJtaXNzaW9ubg+fk/TA&quot; +
 87         &quot;qbsDAAFMAAdhY3Rpb25zdAASTGphdmEvbGFuZy9TdHJpbmc7eHIAGGphdmEuc2VjdXJp&quot; +
 88         &quot;dHkuUGVybWlzc2lvbrHG4T8oV1F+AgABTAAEbmFtZXEAfgAIeHBzcgAgamF2YS5pby5G&quot; +
 89         &quot;aWxlUGVybWlzc2lvbkNvbGxlY3Rpb24eknl91I5VqQMAAUwAC3Blcm1pc3Npb25zdAAS&quot; +
 90         &quot;TGphdmEvdXRpbC9WZWN0b3I7eHEAfgADAHNyABBqYXZhLnV0aWwuVmVjdG9y2Zd9W4A7&quot; +
 91         &quot;rwEDAANJABFjYXBhY2l0eUluY3JlbWVudEkADGVsZW1lbnRDb3VudFsAC2VsZW1lbnRE&quot; +
 92         &quot;YXRhdAATW0xqYXZhL2xhbmcvT2JqZWN0O3hwAAAAAAAAAAF1cgATW0xqYXZhLmxhbmcu&quot; +
 93         &quot;T2JqZWN0O5DOWJ8QcylsAgAAeHAAAAABc3EAfgAHdAADYmFydAAEcmVhZHh4eHZyAC9q&quot; +
 94         &quot;YXZheC5zZWN1cml0eS5hdXRoLlByaXZhdGVDcmVkZW50aWFsUGVybWlzc2lvbklV3Hd7&quot; +
 95         &quot;UH9MAgADWgAHdGVzdGluZ0wAD2NyZWRlbnRpYWxDbGFzc3EAfgAITAAKcHJpbmNpcGFs&quot; +
 96         &quot;c3QAD0xqYXZhL3V0aWwvU2V0O3hxAH4ACXNyAB1qYXZhLnNlY3VyaXR5LlBlcm1pc3Np&quot; +
 97         &quot;b25zSGFzaIomZbSmPV1AAwABTAAFcGVybXNxAH4AAnhxAH4AAwBzcQB+AAU/QAAAAAAA&quot; +
 98         &quot;AXcIAAAAAgAAAAFzcQB+ABZ0ACphLmIuUHJpdmF0ZUNyZWRlbnRpYWwgYS5iLlByaW5j&quot; +
 99         &quot;aXBhbCAiZHVrZSIAdAAVYS5iLlByaXZhdGVDcmVkZW50aWFscHNyACBqYXZhLnNlY3Vy&quot; +
100         &quot;aXR5LlNlY3VyaXR5UGVybWlzc2lvbkiqZj6xhx0mAgAAeHIAHWphdmEuc2VjdXJpdHku&quot; +
101         &quot;QmFzaWNQZXJtaXNzaW9uVyUL3M9OpnoCAAB4cQB+AAl0AANmb294eHZxAH4AH3NyACdq&quot; +
102         &quot;YXZhLnNlY3VyaXR5LkJhc2ljUGVybWlzc2lvbkNvbGxlY3Rpb24KQocEje3jxwMAA1oA&quot; +
103         &quot;C2FsbF9hbGxvd2VkTAAJcGVybUNsYXNzdAARTGphdmEvbGFuZy9DbGFzcztMAAtwZXJt&quot; +
104         &quot;aXNzaW9uc3EAfgACeHEAfgADAABxAH4AI3NxAH4ABT9AAAAAAAABdwgAAAACAAAAAXEA&quot; +
105         &quot;fgAic3EAfgAfcQB+ACJ4eHh4&quot;;
106 
107     public static void main(String[] args) throws Exception {
108 
109         Base64.Decoder decoder = Base64.getDecoder();
110         deserialize(decoder.decode(INVALID_PERMISSIONS));
111         deserialize(decoder.decode(INVALID_PERMISSIONS_HASH));
112     }
113 
114     private static void deserialize(byte[] serialBytes) throws Exception {
115         try (ObjectInputStream ois =
116                 new ObjectInputStream(new ByteArrayInputStream(serialBytes))) {
117             try {
118                 Permissions p = (Permissions) ois.readObject();
119                 throw new Exception(&quot;expected InvalidObjectException&quot;);
120             } catch (InvalidObjectException ioe) {
121                 // test passed
122             }
123         }
124     }
125 }
    </pre>
  </body>
</html>