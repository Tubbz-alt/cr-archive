<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/jdk/java/lang/invoke/CallSiteTest.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="AccessControlTest.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="CallerSensitiveAccess.java.udiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/lang/invoke/CallSiteTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -22,14 +22,15 @@</span>
   */
  
  /**
   * @test
   * @summary smoke tests for CallSite
<span class="udiff-line-added">+  * @library /test/lib</span>
   *
   * @build indify.Indify
   * @compile CallSiteTest.java
<span class="udiff-line-modified-removed">-  * @run main/othervm/timeout=3600 -XX:+IgnoreUnrecognizedVMOptions -XX:-VerifyDependencies</span>
<span class="udiff-line-modified-added">+  * @run main/othervm/timeout=3600 -XX:+IgnoreUnrecognizedVMOptions -XX:-VerifyDependencies -Xbatch</span>
   *      indify.Indify
   *      --expand-properties --classpath ${test.classes}
   *      --java test.java.lang.invoke.CallSiteTest
   */
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -38,10 +39,11 @@</span>
  import java.io.*;
  
  import java.lang.invoke.*;
  import static java.lang.invoke.MethodHandles.*;
  import static java.lang.invoke.MethodType.*;
<span class="udiff-line-added">+ import static jdk.test.lib.Asserts.*;</span>
  
  public class CallSiteTest {
      private static final Class&lt;?&gt; CLASS = CallSiteTest.class;
  
      private static CallSite mcs;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -49,31 +51,88 @@</span>
      private static MethodHandle mh_foo;
      private static MethodHandle mh_bar;
  
      static {
          try {
<span class="udiff-line-added">+ </span>
              mh_foo = lookup().findStatic(CLASS, &quot;foo&quot;, methodType(int.class, int.class, int.class));
              mh_bar = lookup().findStatic(CLASS, &quot;bar&quot;, methodType(int.class, int.class, int.class));
              mcs = new MutableCallSite(mh_foo);
              vcs = new VolatileCallSite(mh_foo);
          } catch (Exception e) {
              e.printStackTrace();
<span class="udiff-line-added">+             throw new Error(e);</span>
          }
      }
  
      public static void main(String... av) throws Throwable {
<span class="udiff-line-added">+         testConstantCallSite();</span>
          testMutableCallSite();
          testVolatileCallSite();
      }
  
      private static final int N = Integer.MAX_VALUE / 100;
      private static final int RESULT1 = 762786192;
      private static final int RESULT2 = -21474836;
  
<span class="udiff-line-modified-removed">-     private static void assertEquals(int expected, int actual) {</span>
<span class="udiff-line-modified-removed">-         if (expected != actual)</span>
<span class="udiff-line-modified-removed">-             throw new AssertionError(&quot;expected: &quot; + expected + &quot;, actual: &quot; + actual);</span>
<span class="udiff-line-modified-added">+     static final CallSite     MCS         = new MutableCallSite(methodType(void.class));</span>
<span class="udiff-line-modified-added">+     static final MethodHandle MCS_INVOKER = MCS.dynamicInvoker();</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-added">+     static void test(boolean shouldThrow) {</span>
<span class="udiff-line-added">+         try {</span>
<span class="udiff-line-added">+             MCS_INVOKER.invokeExact();</span>
<span class="udiff-line-added">+             if (shouldThrow) {</span>
<span class="udiff-line-added">+                 throw new AssertionError(&quot;should throw&quot;);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         } catch (IllegalStateException ise) {</span>
<span class="udiff-line-added">+             if (!shouldThrow) {</span>
<span class="udiff-line-added">+                 throw new AssertionError(&quot;should not throw&quot;, ise);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         } catch (Throwable e) {</span>
<span class="udiff-line-added">+             throw new Error(e);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     static class MyCCS extends ConstantCallSite {</span>
<span class="udiff-line-added">+         public MyCCS(MethodType targetType, MethodHandle createTargetHook) throws Throwable {</span>
<span class="udiff-line-added">+             super(targetType, createTargetHook);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private static MethodHandle testConstantCallSiteHandler(CallSite cs, CallSite[] holder) throws Throwable {</span>
<span class="udiff-line-added">+         holder[0] = cs; // capture call site instance for subsequent checks</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         MethodType csType = cs.type(); // should not throw on partially constructed instance</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         // Truly dynamic invoker for constant call site</span>
<span class="udiff-line-added">+         MethodHandle getTarget = lookup().findVirtual(CallSite.class, &quot;getTarget&quot;, MethodType.methodType(MethodHandle.class))</span>
<span class="udiff-line-added">+                                          .bindTo(cs);</span>
<span class="udiff-line-added">+         MethodHandle invoker = MethodHandles.exactInvoker(csType);</span>
<span class="udiff-line-added">+         MethodHandle target = MethodHandles.foldArguments(invoker, getTarget);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         MCS.setTarget(target);</span>
<span class="udiff-line-added">+         // warmup</span>
<span class="udiff-line-added">+         for (int i = 0; i &lt; 20_000; i++) {</span>
<span class="udiff-line-added">+             test(true); // should throw IllegalStateException</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         return MethodHandles.empty(csType); // initialize cs with an empty method handle</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private static void testConstantCallSite() throws Throwable {</span>
<span class="udiff-line-added">+         CallSite[] holder = new CallSite[1];</span>
<span class="udiff-line-added">+         MethodHandle handler = lookup().findStatic(CLASS, &quot;testConstantCallSiteHandler&quot;, MethodType.methodType(MethodHandle.class, CallSite.class, CallSite[].class));</span>
<span class="udiff-line-added">+         handler = MethodHandles.insertArguments(handler, 1, new Object[] { holder } );</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         CallSite ccs = new MyCCS(MCS.type(), handler); // trigger call to handler</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         if (ccs != holder[0]) {</span>
<span class="udiff-line-added">+             throw new AssertionError(&quot;different call site instances&quot;);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         for (int i = 0; i &lt; 20_000; i++) {</span>
<span class="udiff-line-added">+             test(false); // should not throw</span>
<span class="udiff-line-added">+         }</span>
      }
  
      private static void testMutableCallSite() throws Throwable {
          // warm-up
          for (int i = 0; i &lt; 20000; i++) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -81,15 +140,15 @@</span>
          }
          // run
          for (int n = 0; n &lt; 2; n++) {
              mcs.setTarget(mh_foo);
              for (int i = 0; i &lt; 5; i++) {
<span class="udiff-line-modified-removed">-                 assertEquals(RESULT1, runMutableCallSite());</span>
<span class="udiff-line-modified-added">+                 assertEQ(RESULT1, runMutableCallSite());</span>
              }
              mcs.setTarget(mh_bar);
              for (int i = 0; i &lt; 5; i++) {
<span class="udiff-line-modified-removed">-                 assertEquals(RESULT2, runMutableCallSite());</span>
<span class="udiff-line-modified-added">+                 assertEQ(RESULT2, runMutableCallSite());</span>
              }
          }
      }
      private static void testVolatileCallSite() throws Throwable {
          // warm-up
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -98,15 +157,15 @@</span>
          }
          // run
          for (int n = 0; n &lt; 2; n++) {
              vcs.setTarget(mh_foo);
              for (int i = 0; i &lt; 5; i++) {
<span class="udiff-line-modified-removed">-                 assertEquals(RESULT1, runVolatileCallSite());</span>
<span class="udiff-line-modified-added">+                 assertEQ(RESULT1, runVolatileCallSite());</span>
              }
              vcs.setTarget(mh_bar);
              for (int i = 0; i &lt; 5; i++) {
<span class="udiff-line-modified-removed">-                 assertEquals(RESULT2, runVolatileCallSite());</span>
<span class="udiff-line-modified-added">+                 assertEQ(RESULT2, runVolatileCallSite());</span>
              }
          }
      }
  
      private static int runMutableCallSite() throws Throwable {
</pre>
<center><a href="AccessControlTest.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="CallerSensitiveAccess.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>