<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff test/jdk/java/lang/invoke/VarHandles/accessibility/TestFieldLookupAccessibility.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../TryFinallyTest.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../../modules/Unnamed.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/lang/invoke/VarHandles/accessibility/TestFieldLookupAccessibility.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 20,11 ***</span>
   * or visit www.oracle.com if you need additional information or have any
   * questions.
   */
  
  /* @test
<span class="line-modified">!  * @bug 8152645</span>
   * @summary test field lookup accessibility of MethodHandles and VarHandles
   * @compile TestFieldLookupAccessibility.java
   *          pkg/A.java pkg/B_extends_A.java pkg/C.java
   *          pkg/subpkg/B_extends_A.java pkg/subpkg/C.java
   * @run testng/othervm TestFieldLookupAccessibility
<span class="line-new-header">--- 20,11 ---</span>
   * or visit www.oracle.com if you need additional information or have any
   * questions.
   */
  
  /* @test
<span class="line-modified">!  * @bug 8152645 8216558</span>
   * @summary test field lookup accessibility of MethodHandles and VarHandles
   * @compile TestFieldLookupAccessibility.java
   *          pkg/A.java pkg/B_extends_A.java pkg/C.java
   *          pkg/subpkg/B_extends_A.java pkg/subpkg/C.java
   * @run testng/othervm TestFieldLookupAccessibility
</pre>
<hr />
<pre>
<span class="line-old-header">*** 94,24 ***</span>
          },
          MH_UNREFLECT_GETTER_ACCESSIBLE() {
              Object lookup(MethodHandles.Lookup l, Field f) throws Exception {
                  return l.unreflectGetter(cloneAndSetAccessible(f));
              }
          },
          MH_UNREFLECT_SETTER() {
              Object lookup(MethodHandles.Lookup l, Field f) throws Exception {
                  return l.unreflectSetter(f);
              }
  
              boolean isAccessible(Field f) {
<span class="line-modified">!                 return f.isAccessible() || !Modifier.isFinal(f.getModifiers());</span>
              }
          },
          MH_UNREFLECT_SETTER_ACCESSIBLE() {
              Object lookup(MethodHandles.Lookup l, Field f) throws Exception {
                  return l.unreflectSetter(cloneAndSetAccessible(f));
              }
          },
          VH() {
              Object lookup(MethodHandles.Lookup l, Field f) throws Exception {
                  return l.findVarHandle(f.getDeclaringClass(), f.getName(), f.getType());
              }
<span class="line-new-header">--- 94,44 ---</span>
          },
          MH_UNREFLECT_GETTER_ACCESSIBLE() {
              Object lookup(MethodHandles.Lookup l, Field f) throws Exception {
                  return l.unreflectGetter(cloneAndSetAccessible(f));
              }
<span class="line-added">+ </span>
<span class="line-added">+             // Setting the accessibility bit of a Field grants access under</span>
<span class="line-added">+             // all conditions for MethodHandle getters.</span>
<span class="line-added">+             Set&lt;String&gt; inaccessibleFields(Set&lt;String&gt; inaccessibleFields) {</span>
<span class="line-added">+                 return new HashSet&lt;&gt;();</span>
<span class="line-added">+             }</span>
          },
          MH_UNREFLECT_SETTER() {
              Object lookup(MethodHandles.Lookup l, Field f) throws Exception {
                  return l.unreflectSetter(f);
              }
  
              boolean isAccessible(Field f) {
<span class="line-modified">!                 return f.isAccessible() &amp;&amp; !Modifier.isStatic(f.getModifiers()) || !Modifier.isFinal(f.getModifiers());</span>
              }
          },
          MH_UNREFLECT_SETTER_ACCESSIBLE() {
              Object lookup(MethodHandles.Lookup l, Field f) throws Exception {
                  return l.unreflectSetter(cloneAndSetAccessible(f));
              }
<span class="line-added">+ </span>
<span class="line-added">+             boolean isAccessible(Field f) {</span>
<span class="line-added">+                 return !(Modifier.isStatic(f.getModifiers()) &amp;&amp; Modifier.isFinal(f.getModifiers()));</span>
<span class="line-added">+             }</span>
<span class="line-added">+ </span>
<span class="line-added">+             // Setting the accessibility bit of a Field grants access to non-static</span>
<span class="line-added">+             // final fields for MethodHandle setters.</span>
<span class="line-added">+             Set&lt;String&gt; inaccessibleFields(Set&lt;String&gt;inaccessibleFields) {</span>
<span class="line-added">+                 Set&lt;String&gt; result = new HashSet&lt;&gt;();</span>
<span class="line-added">+                 inaccessibleFields.stream()</span>
<span class="line-added">+                                   .filter(f -&gt; (f.contains(&quot;static&quot;) &amp;&amp; f.contains(&quot;final&quot;)))</span>
<span class="line-added">+                                   .forEach(result::add);</span>
<span class="line-added">+                 return result;</span>
<span class="line-added">+             }</span>
          },
          VH() {
              Object lookup(MethodHandles.Lookup l, Field f) throws Exception {
                  return l.findVarHandle(f.getDeclaringClass(), f.getName(), f.getType());
              }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 140,10 ***</span>
<span class="line-new-header">--- 160,14 ---</span>
  
          boolean isAccessible(Field f) {
              return true;
          }
  
<span class="line-added">+         Set&lt;String&gt; inaccessibleFields(Set&lt;String&gt; inaccessibleFields) {</span>
<span class="line-added">+             return new HashSet&lt;&gt;(inaccessibleFields);</span>
<span class="line-added">+         }</span>
<span class="line-added">+ </span>
          static Field cloneAndSetAccessible(Field f) throws Exception {
              // Clone to avoid mutating source field
              f = f.getDeclaringClass().getDeclaredField(f.getName());
              f.setAccessible(true);
              return f;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 178,11 ***</span>
      }
  
      @Test(dataProvider = &quot;lookupProvider&quot;)
      public void test(FieldLookup fl, Class&lt;?&gt; src, MethodHandles.Lookup l, Set&lt;String&gt; inaccessibleFields) {
          // Add to the expected failures all inaccessible fields due to accessibility modifiers
<span class="line-modified">!         Set&lt;String&gt; expected = new HashSet&lt;&gt;(inaccessibleFields);</span>
          Map&lt;Field, Throwable&gt; actual = new HashMap&lt;&gt;();
  
          for (Field f : fields(src)) {
              // Add to the expected failures all inaccessible fields due to static/final modifiers
              if (!fl.isAccessible(f)) {
<span class="line-new-header">--- 202,11 ---</span>
      }
  
      @Test(dataProvider = &quot;lookupProvider&quot;)
      public void test(FieldLookup fl, Class&lt;?&gt; src, MethodHandles.Lookup l, Set&lt;String&gt; inaccessibleFields) {
          // Add to the expected failures all inaccessible fields due to accessibility modifiers
<span class="line-modified">!         Set&lt;String&gt; expected = fl.inaccessibleFields(inaccessibleFields);</span>
          Map&lt;Field, Throwable&gt; actual = new HashMap&lt;&gt;();
  
          for (Field f : fields(src)) {
              // Add to the expected failures all inaccessible fields due to static/final modifiers
              if (!fl.isAccessible(f)) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 200,16 ***</span>
  
          Set&lt;String&gt; actualFieldNames = actual.keySet().stream().map(Field::getName).
                  collect(Collectors.toSet());
          if (!actualFieldNames.equals(expected)) {
              if (actualFieldNames.isEmpty()) {
<span class="line-modified">!                 // Setting the accessibility bit of a Field grants access under</span>
<span class="line-removed">-                 // all conditions for MethodHander getters and setters</span>
<span class="line-removed">-                 if (fl != FieldLookup.MH_UNREFLECT_GETTER_ACCESSIBLE &amp;&amp;</span>
<span class="line-removed">-                     fl != FieldLookup.MH_UNREFLECT_SETTER_ACCESSIBLE) {</span>
<span class="line-removed">-                     Assert.assertEquals(actualFieldNames, expected, &quot;No accessibility failures:&quot;);</span>
<span class="line-removed">-                 }</span>
              }
              else {
                  Assert.assertEquals(actualFieldNames, expected, &quot;Accessibility failures differ:&quot;);
              }
          }
<span class="line-new-header">--- 224,11 ---</span>
  
          Set&lt;String&gt; actualFieldNames = actual.keySet().stream().map(Field::getName).
                  collect(Collectors.toSet());
          if (!actualFieldNames.equals(expected)) {
              if (actualFieldNames.isEmpty()) {
<span class="line-modified">!                 Assert.assertEquals(actualFieldNames, expected, &quot;No accessibility failures:&quot;);</span>
              }
              else {
                  Assert.assertEquals(actualFieldNames, expected, &quot;Accessibility failures differ:&quot;);
              }
          }
</pre>
<center><a href="../../TryFinallyTest.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../../modules/Unnamed.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>