<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/jdk/java/lang/invoke/MethodHandlesGeneralTest.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="MethodHandles/privateLookupIn/test/p/PrivateLookupInTests.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="MethodHandlesTest.java.udiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/lang/invoke/MethodHandlesGeneralTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2018, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -20,10 +20,11 @@</span>
   * or visit www.oracle.com if you need additional information or have any
   * questions.
   */
  
  /* @test
<span class="udiff-line-added">+  * @bug 8216558</span>
   * @summary unit tests for java.lang.invoke.MethodHandles
   * @library /test/lib /java/lang/invoke/common
   * @compile MethodHandlesTest.java MethodHandlesGeneralTest.java remote/RemoteExample.java
   * @run junit/othervm/timeout=2500 -XX:+IgnoreUnrecognizedVMOptions
   *                                 -XX:-VerifyDependencies
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -632,11 +633,11 @@</span>
          testGetter(TEST_FIND_STATIC);
      }
  
      public void testGetter(int testMode) throws Throwable {
          Lookup lookup = PRIVATE;  // FIXME: test more lookups than this one
<span class="udiff-line-modified-removed">-         for (Object[] c : HasFields.CASES) {</span>
<span class="udiff-line-modified-added">+         for (Object[] c : HasFields.testCasesFor(testMode)) {</span>
              boolean positive = (c[1] != Error.class);
              testGetter(positive, lookup, c[0], c[1], testMode);
              if (positive)
                  testGetter(positive, lookup, c[0], c[1], testMode | TEST_NPE);
          }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -721,19 +722,24 @@</span>
                  :   IllegalAccessException.class,
                  noAccess);
              if (verbosity &gt;= 5)  ex.printStackTrace(System.out);
          }
          if (verbosity &gt;= 3)
<span class="udiff-line-modified-removed">-             System.out.println(&quot;find&quot;+(isStatic?&quot;Static&quot;:&quot;&quot;)+(isGetter?&quot;Getter&quot;:&quot;Setter&quot;)+&quot; &quot;+fclass.getName()+&quot;.&quot;+fname+&quot;/&quot;+ftype</span>
<span class="udiff-line-modified-removed">-                                +&quot; =&gt; &quot;+mh</span>
<span class="udiff-line-modified-removed">-                                +(noAccess == null ? &quot;&quot; : &quot; !! &quot;+noAccess));</span>
<span class="udiff-line-modified-added">+             System.out.format(&quot;%s%s %s.%s/%s =&gt; %s %s%n&quot;,</span>
<span class="udiff-line-modified-added">+                               (testMode0 &amp; TEST_UNREFLECT) != 0</span>
<span class="udiff-line-modified-added">+                                   ? &quot;unreflect&quot;</span>
<span class="udiff-line-added">+                                   : &quot;find&quot; + ((testMode0 &amp; TEST_FIND_STATIC) != 0 ? &quot;Static&quot; : &quot;&quot;),</span>
<span class="udiff-line-added">+                               (isGetter ? &quot;Getter&quot; : &quot;Setter&quot;),</span>
<span class="udiff-line-added">+                               fclass.getName(), fname, ftype, mh,</span>
<span class="udiff-line-added">+                               (noAccess == null ? &quot;&quot; : &quot; !! &quot;+noAccess));</span>
<span class="udiff-line-added">+         // negative test case and expected noAccess, then done.</span>
<span class="udiff-line-added">+         if (!positive &amp;&amp; noAccess != null) return;</span>
<span class="udiff-line-added">+         // positive test case but found noAccess, then error</span>
          if (positive &amp;&amp; !testNPE &amp;&amp; noAccess != null)  throw new RuntimeException(noAccess);
          assertEquals(positive0 ? &quot;positive test&quot; : &quot;negative test erroneously passed&quot;, positive0, mh != null);
          if (!positive &amp;&amp; !testNPE)  return; // negative access test failed as expected
          assertEquals((isStatic ? 0 : 1)+(isGetter ? 0 : 1), mh.type().parameterCount());
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- </span>
          assertSame(mh.type(), expType);
          //assertNameStringContains(mh, fname);  // This does not hold anymore with LFs
          HasFields fields = new HasFields();
          HasFields fieldsForMH = fields;
          if (testNPE)  fieldsForMH = null;  // perturb MH argument to elicit expected error
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -753,10 +759,13 @@</span>
          }
          if (f != null &amp;&amp; f.getDeclaringClass() == HasFields.class) {
              assertEquals(f.get(fields), value);  // clean to start with
          }
          Throwable caughtEx = null;
<span class="udiff-line-added">+         // non-final field and setAccessible(true) on instance field will have write access</span>
<span class="udiff-line-added">+         boolean writeAccess = !Modifier.isFinal(f.getModifiers()) ||</span>
<span class="udiff-line-added">+                               (!Modifier.isStatic(f.getModifiers()) &amp;&amp; f.isAccessible());</span>
          if (isGetter) {
              Object expValue = value;
              for (int i = 0; i &lt;= 1; i++) {
                  sawValue = null;  // make DA rules happy under try/catch
                  try {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -776,12 +785,11 @@</span>
                          caughtEx = ex;
                          break;
                      }
                  }
                  assertEquals(sawValue, expValue);
<span class="udiff-line-modified-removed">-                 if (f != null &amp;&amp; f.getDeclaringClass() == HasFields.class</span>
<span class="udiff-line-removed">-                     &amp;&amp; !Modifier.isFinal(f.getModifiers())) {</span>
<span class="udiff-line-modified-added">+                 if (f != null &amp;&amp; f.getDeclaringClass() == HasFields.class &amp;&amp; writeAccess) {</span>
                      Object random = randomArg(ftype);
                      f.set(fields, random);
                      expValue = random;
                  } else {
                      break;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -811,12 +819,12 @@</span>
                  if (f != null &amp;&amp; f.getDeclaringClass() == HasFields.class) {
                      assertEquals(f.get(fields), putValue);
                  }
              }
          }
<span class="udiff-line-modified-removed">-         if (f != null &amp;&amp; f.getDeclaringClass() == HasFields.class) {</span>
<span class="udiff-line-modified-removed">-             f.set(fields, value);  // put it back</span>
<span class="udiff-line-modified-added">+         if (f != null &amp;&amp; f.getDeclaringClass() == HasFields.class &amp;&amp; writeAccess) {</span>
<span class="udiff-line-modified-added">+             f.set(fields, value);  // put it back if it has write access</span>
          }
          if (testNPE) {
              if (caughtEx == null || !(caughtEx instanceof NullPointerException))
                  throw new RuntimeException(&quot;failed to catch NPE exception&quot;+(caughtEx == null ? &quot; (caughtEx=null)&quot; : &quot;&quot;), caughtEx);
              caughtEx = null;  // nullify expected exception
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -860,12 +868,12 @@</span>
          testSetter(TEST_FIND_STATIC);
      }
  
      public void testSetter(int testMode) throws Throwable {
          Lookup lookup = PRIVATE;  // FIXME: test more lookups than this one
<span class="udiff-line-modified-removed">-         startTest(&quot;unreflectSetter&quot;);</span>
<span class="udiff-line-modified-removed">-         for (Object[] c : HasFields.CASES) {</span>
<span class="udiff-line-modified-added">+         startTest(&quot;testSetter&quot;);</span>
<span class="udiff-line-modified-added">+         for (Object[] c : HasFields.testCasesFor(testMode|TEST_SETTER)) {</span>
              boolean positive = (c[1] != Error.class);
              testSetter(positive, lookup, c[0], c[1], testMode);
              if (positive)
                  testSetter(positive, lookup, c[0], c[1], testMode | TEST_NPE);
          }
</pre>
<center><a href="MethodHandles/privateLookupIn/test/p/PrivateLookupInTests.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="MethodHandlesTest.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>