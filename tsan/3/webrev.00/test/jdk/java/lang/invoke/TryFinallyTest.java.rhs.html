<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/jdk/java/lang/invoke/TryFinallyTest.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
    <script type="text/javascript" src="../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 2015, 2016, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 /* @test
<a name="1" id="anc1"></a><span class="line-modified"> 27  * @bug 8139885 8150824 8150825 8194238 8233920</span>
<span class="line-modified"> 28  * @run testng/othervm -ea -esa -Xverify:all test.java.lang.invoke.TryFinallyTest</span>
 29  */
 30 
 31 package test.java.lang.invoke;
 32 
 33 import java.lang.invoke.MethodHandle;
 34 import java.lang.invoke.MethodHandles;
 35 import java.lang.invoke.MethodHandles.Lookup;
 36 import java.lang.invoke.MethodType;
 37 
 38 import static java.lang.invoke.MethodType.methodType;
 39 
 40 import static org.testng.AssertJUnit.*;
 41 
 42 import org.testng.annotations.*;
 43 
 44 /**
 45  * Tests for the tryFinally method handle combinator introduced in JEP 274.
 46  */
 47 public class TryFinallyTest {
 48 
 49     static final Lookup LOOKUP = MethodHandles.lookup();
 50 
 51     @Test
 52     public static void testTryFinally() throws Throwable {
 53         MethodHandle hello = MethodHandles.tryFinally(TryFinally.MH_greet, TryFinally.MH_exclaim);
 54         assertEquals(TryFinally.MT_hello, hello.type());
 55         assertEquals(&quot;Hello, world!&quot;, hello.invoke(&quot;world&quot;));
 56     }
 57 
<a name="2" id="anc2"></a><span class="line-added"> 58     @DataProvider</span>
<span class="line-added"> 59     static Object[][] tryFinallyArgs() {</span>
<span class="line-added"> 60         return new Object[][] {</span>
<span class="line-added"> 61                 { boolean.class, true },</span>
<span class="line-added"> 62                 { byte.class, (byte) 2 },</span>
<span class="line-added"> 63                 { short.class, (short) 2 },</span>
<span class="line-added"> 64                 { char.class, (char) 2 },</span>
<span class="line-added"> 65                 { int.class, 2 },</span>
<span class="line-added"> 66                 { long.class, 2L },</span>
<span class="line-added"> 67                 { float.class, 2f },</span>
<span class="line-added"> 68                 { double.class, 2D },</span>
<span class="line-added"> 69                 { Object.class, new Object() }</span>
<span class="line-added"> 70         };</span>
<span class="line-added"> 71     }</span>
<span class="line-added"> 72 </span>
<span class="line-added"> 73     @Test(dataProvider = &quot;tryFinallyArgs&quot;)</span>
<span class="line-added"> 74     public static void testTryFinally(Class&lt;?&gt; argType, Object arg) throws Throwable {</span>
<span class="line-added"> 75         MethodHandle identity = MethodHandles.identity(argType);</span>
<span class="line-added"> 76         MethodHandle tryFinally = MethodHandles.tryFinally(</span>
<span class="line-added"> 77                 identity,</span>
<span class="line-added"> 78                 MethodHandles.dropArguments(identity, 0, Throwable.class));</span>
<span class="line-added"> 79         assertEquals(methodType(argType, argType), tryFinally.type());</span>
<span class="line-added"> 80         assertEquals(arg, tryFinally.invoke(arg));</span>
<span class="line-added"> 81     }</span>
<span class="line-added"> 82 </span>
<span class="line-added"> 83     @Test(dataProvider = &quot;tryFinallyArgs&quot;, expectedExceptions = TryFinally.T1.class)</span>
<span class="line-added"> 84     public static void testTryFinallyException(Class&lt;?&gt; argType, Object arg) throws Throwable {</span>
<span class="line-added"> 85         MethodHandle identity = TryFinally.MH_throwingTargetIdentity.asType(methodType(argType, argType));</span>
<span class="line-added"> 86         MethodHandle tryFinally = MethodHandles.tryFinally(</span>
<span class="line-added"> 87                 identity,</span>
<span class="line-added"> 88                 MethodHandles.dropArguments(identity, 0, TryFinally.T1.class));</span>
<span class="line-added"> 89         assertEquals(methodType(argType, argType), tryFinally.type());</span>
<span class="line-added"> 90         tryFinally.invoke(arg); // should throw</span>
<span class="line-added"> 91     }</span>
<span class="line-added"> 92 </span>
 93     @Test
 94     public static void testTryFinallyVoid() throws Throwable {
 95         MethodHandle tfVoid = MethodHandles.tryFinally(TryFinally.MH_print, TryFinally.MH_printMore);
 96         assertEquals(TryFinally.MT_printHello, tfVoid.type());
 97         tfVoid.invoke(&quot;world&quot;);
 98     }
 99 
100     @Test
101     public static void testTryFinallySublist() throws Throwable {
102         MethodHandle helloMore = MethodHandles.tryFinally(TryFinally.MH_greetMore, TryFinally.MH_exclaimMore);
103         assertEquals(TryFinally.MT_moreHello, helloMore.type());
104         assertEquals(&quot;Hello, world and universe (but world first)!&quot;, helloMore.invoke(&quot;world&quot;, &quot;universe&quot;));
105     }
106 
107     @DataProvider
108     static Object[][] omitTrailingArguments() {
109         MethodHandle c = TryFinally.MH_voidCleanup;
110         return new Object[][]{
111                 {c},
112                 {MethodHandles.dropArguments(c, 1, int.class)},
113                 {MethodHandles.dropArguments(c, 1, int.class, long.class)},
114                 {MethodHandles.dropArguments(c, 1, int.class, long.class, Object.class, int.class)},
115                 {MethodHandles.dropArguments(c, 1, int.class, long.class, Object.class, int.class, long.class)}
116         };
117     }
118 
119     @Test(dataProvider = &quot;omitTrailingArguments&quot;)
120     public static void testTryFinallyOmitTrailingArguments(MethodHandle cleanup) throws Throwable {
121         MethodHandle tf = MethodHandles.tryFinally(TryFinally.MH_dummyTarget, cleanup);
122         tf.invoke(1, 2L, &quot;a&quot;, 23, 42L, &quot;b&quot;);
123     }
124 
125     @DataProvider
126     static Object[][] negativeTestData() {
127         MethodHandle intid = MethodHandles.identity(int.class);
128         MethodHandle intco = MethodHandles.constant(int.class, 0);
129         MethodHandle errTarget = MethodHandles.dropArguments(intco, 0, int.class, double.class, String.class, int.class);
130         MethodHandle errCleanup = MethodHandles.dropArguments(MethodHandles.constant(int.class, 0), 0, Throwable.class,
131                 int.class, double.class, Object.class);
132         MethodHandle voidTarget = TryFinally.MH_voidTarget;
133         MethodHandle voidICleanup = MethodHandles.dropArguments(TryFinally.MH_voidCleanup, 1, int.class);
134         return new Object[][]{
135                 {intid, MethodHandles.identity(double.class),
136                         &quot;target and return types must match: double != int&quot;},
137                 {intid, MethodHandles.dropArguments(intid, 0, String.class),
138                         &quot;cleanup first argument and Throwable must match: (String,int)int != class java.lang.Throwable&quot;},
139                 {intid, MethodHandles.dropArguments(intid, 0, Throwable.class, double.class),
140                         &quot;cleanup second argument and target return type must match: (Throwable,double,int)int != int&quot;},
141                 {errTarget, errCleanup,
142                         &quot;cleanup parameters after (Throwable,result) and target parameter list prefix must match: &quot; +
143                                 errCleanup.type() + &quot; != &quot; + errTarget.type()},
144                 {voidTarget, voidICleanup,
145                         &quot;cleanup parameters after (Throwable,result) and target parameter list prefix must match: &quot; +
146                                 voidICleanup.type() + &quot; != &quot; + voidTarget.type()}
147         };
148     }
149 
150     @Test(dataProvider = &quot;negativeTestData&quot;)
151     public static void testTryFinallyNegative(MethodHandle target, MethodHandle cleanup, String expectedMessage) {
152         boolean caught = false;
153         try {
154             MethodHandles.tryFinally(target, cleanup);
155         } catch (IllegalArgumentException iae) {
156             assertEquals(expectedMessage, iae.getMessage());
157             caught = true;
158         }
159         assertTrue(caught);
160     }
161 
162     @Test
163     public static void testTryFinallyThrowableCheck() {
164         MethodHandle mh = MethodHandles.tryFinally(TryFinally.MH_throwingTarget,
165                                                    TryFinally.MH_catchingCleanup);
166         try {
167             mh.invoke();
168             fail(&quot;ClassCastException expected&quot;);
169         } catch (Throwable t) {
170             assertTrue(&quot;Throwable not assignable to ClassCastException: &quot; + t,
171                        ClassCastException.class.isAssignableFrom(t.getClass()));
172         }
173     }
174 
175     static class TryFinally {
176 
177         static String greet(String whom) {
178             return &quot;Hello, &quot; + whom;
179         }
180 
181         static String exclaim(Throwable t, String r, String whom) {
182             return r + &quot;!&quot;;
183         }
184 
185         static void print(String what) {
186             System.out.print(&quot;Hello, &quot; + what);
187         }
188 
189         static void printMore(Throwable t, String what) {
190             System.out.println(&quot;!&quot;);
191         }
192 
193         static String greetMore(String first, String second) {
194             return &quot;Hello, &quot; + first + &quot; and &quot; + second;
195         }
196 
197         static String exclaimMore(Throwable t, String r, String first) {
198             return r + &quot; (but &quot; + first + &quot; first)!&quot;;
199         }
200 
201         static void voidTarget() {}
202 
203         static void voidCleanup(Throwable t) {}
204 
205         static class T1 extends Throwable {}
206 
207         static class T2 extends Throwable {}
208 
209         static void throwingTarget() throws Throwable {
210             throw new T1();
211         }
212 
<a name="3" id="anc3"></a><span class="line-added">213         static Object throwingTargetIdentity(Object o) throws Throwable {</span>
<span class="line-added">214             throw new T1();</span>
<span class="line-added">215         }</span>
<span class="line-added">216 </span>
217         static void catchingCleanup(T2 t) throws Throwable {
218         }
219 
220         static final Class&lt;TryFinally&gt; TRY_FINALLY = TryFinally.class;
221 
222         static final MethodType MT_greet = methodType(String.class, String.class);
223         static final MethodType MT_exclaim = methodType(String.class, Throwable.class, String.class, String.class);
224         static final MethodType MT_print = methodType(void.class, String.class);
225         static final MethodType MT_printMore = methodType(void.class, Throwable.class, String.class);
226         static final MethodType MT_greetMore = methodType(String.class, String.class, String.class);
227         static final MethodType MT_exclaimMore = methodType(String.class, Throwable.class, String.class, String.class);
228         static final MethodType MT_voidTarget = methodType(void.class);
229         static final MethodType MT_voidCleanup = methodType(void.class, Throwable.class);
230         static final MethodType MT_throwingTarget = methodType(void.class);
<a name="4" id="anc4"></a><span class="line-added">231         static final MethodType MT_throwingTargetIdentity = methodType(Object.class, Object.class);</span>
232         static final MethodType MT_catchingCleanup = methodType(void.class, T2.class);
233 
234         static final MethodHandle MH_greet;
235         static final MethodHandle MH_exclaim;
236         static final MethodHandle MH_print;
237         static final MethodHandle MH_printMore;
238         static final MethodHandle MH_greetMore;
239         static final MethodHandle MH_exclaimMore;
240         static final MethodHandle MH_voidTarget;
241         static final MethodHandle MH_voidCleanup;
242         static final MethodHandle MH_throwingTarget;
<a name="5" id="anc5"></a><span class="line-added">243         static final MethodHandle MH_throwingTargetIdentity;</span>
244         static final MethodHandle MH_catchingCleanup;
245 
246         static final MethodHandle MH_dummyTarget;
247 
248         static final MethodType MT_hello = methodType(String.class, String.class);
249         static final MethodType MT_printHello = methodType(void.class, String.class);
250         static final MethodType MT_moreHello = methodType(String.class, String.class, String.class);
251 
252         static {
253             try {
254                 MH_greet = LOOKUP.findStatic(TRY_FINALLY, &quot;greet&quot;, MT_greet);
255                 MH_exclaim = LOOKUP.findStatic(TRY_FINALLY, &quot;exclaim&quot;, MT_exclaim);
256                 MH_print = LOOKUP.findStatic(TRY_FINALLY, &quot;print&quot;, MT_print);
257                 MH_printMore = LOOKUP.findStatic(TRY_FINALLY, &quot;printMore&quot;, MT_printMore);
258                 MH_greetMore = LOOKUP.findStatic(TRY_FINALLY, &quot;greetMore&quot;, MT_greetMore);
259                 MH_exclaimMore = LOOKUP.findStatic(TRY_FINALLY, &quot;exclaimMore&quot;, MT_exclaimMore);
260                 MH_voidTarget = LOOKUP.findStatic(TRY_FINALLY, &quot;voidTarget&quot;, MT_voidTarget);
261                 MH_voidCleanup = LOOKUP.findStatic(TRY_FINALLY, &quot;voidCleanup&quot;, MT_voidCleanup);
262                 MH_throwingTarget = LOOKUP.findStatic(TRY_FINALLY, &quot;throwingTarget&quot;, MT_throwingTarget);
<a name="6" id="anc6"></a><span class="line-added">263                 MH_throwingTargetIdentity = LOOKUP.findStatic(TRY_FINALLY, &quot;throwingTargetIdentity&quot;, MT_throwingTargetIdentity);</span>
264                 MH_catchingCleanup = LOOKUP.findStatic(TRY_FINALLY, &quot;catchingCleanup&quot;, MT_catchingCleanup);
265                 MH_dummyTarget = MethodHandles.dropArguments(MH_voidTarget, 0, int.class, long.class, Object.class,
266                         int.class, long.class, Object.class);
267             } catch (Exception e) {
268                 throw new ExceptionInInitializerError(e);
269             }
270         }
271 
272     }
273 
274 }
<a name="7" id="anc7"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="7" type="hidden" />
</body>
</html>