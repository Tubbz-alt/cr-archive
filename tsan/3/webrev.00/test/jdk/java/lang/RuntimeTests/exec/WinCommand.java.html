<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New test/jdk/java/lang/RuntimeTests/exec/WinCommand.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2004, 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /* @test
 25  * @bug 5006520
 26  * @summary Check many different ways to run Windows programs
 27  * @author Martin Buchholz
 28  * @key randomness
 29  */
 30 
 31 import java.io.*;
 32 import java.util.*;
 33 import static java.lang.System.*;
 34 
 35 class StreamDrainer extends Thread {
 36     private final InputStream is;
 37     private final ByteArrayOutputStream os = new ByteArrayOutputStream();
 38     public StreamDrainer(InputStream is) { this.is = is; }
 39     public void run() {
 40         try {
 41             int i;
 42             while ((i = is.read()) &gt;= 0)
 43                 os.write(i);
 44         } catch (Exception e) {}
 45     }
 46     public String toString() { return os.toString(); }
 47 }
 48 
 49 class CommandRunner {
 50     private static Random generator = new Random();
 51     public final int exitValue;
 52     public final String out;
 53     public final String err;
 54     CommandRunner(String... args) throws Exception {
 55         Process p = (generator.nextInt(2) == 0)
 56             ? new ProcessBuilder(args).start()
 57             : Runtime.getRuntime().exec(args);
 58         StreamDrainer d1 = new StreamDrainer(p.getInputStream());
 59         StreamDrainer d2 = new StreamDrainer(p.getErrorStream());
 60         d1.start();
 61         d2.start();
 62         p.waitFor();
 63         d1.join();
 64         d2.join();
 65         this.exitValue = p.exitValue();
 66         this.out = d1.toString();
 67         this.err = d2.toString();
 68     }
 69 }
 70 
 71 public class WinCommand {
 72     private static int failed = 0;
 73 
 74     private static void fail(String msg) {
 75         err.printf(&quot;FAIL: %s%n&quot;, msg);
 76         failed++;
 77     }
 78 
 79     private static String outputOf(String... args) {
 80         try {
 81             CommandRunner cr = new CommandRunner(args);
 82             if (cr.exitValue != 0)
 83                 fail(&quot;exitValue != 0&quot;);
 84             if (! cr.err.equals(&quot;&quot;))
 85                 fail(&quot;stderr: &quot; + cr.err);
 86             return cr.out.replaceFirst(&quot;[\r\n]+$&quot;, &quot;&quot;);
 87         } catch (Exception e) {
 88             fail(e.toString());
 89             return &quot;&quot;;
 90         }
 91     }
 92 
 93     private static void checkCD(String... filespecs) {
 94         String firstCD = null;
 95         for (String filespec : filespecs) {
 96             String CD = outputOf(filespec, &quot;/C&quot;, &quot;CD&quot;);
 97             out.printf(&quot;%s CD ==&gt; %s%n&quot;, filespec, CD);
 98             if (firstCD == null) {
 99                 firstCD = CD;
100                 checkDir(CD);
101             }
102             if (! CD.equals(firstCD)) {
103                 fail(&quot;Inconsistent result from CD subcommand&quot;);
104                 checkDir(CD);
105             }
106         }
107     }
108 
109     private static void checkDir(String dirname) {
110         if (! new File(dirname).isDirectory())
111             fail(String.format(&quot;Not a directory: %s%n&quot;, dirname));
112     }
113 
114     private static void writeFile(String filename, String contents) {
115         try {
116             FileOutputStream fos = new FileOutputStream(filename);
117             fos.write(contents.getBytes());
118             fos.close();
119         } catch (Exception e) {
120             fail(&quot;Unexpected exception&quot; + e.toString());
121         }
122     }
123 
124     public static void main(String[] args) throws Exception {
125         File systemRoot =
126             getenv(&quot;SystemRoot&quot;) != null ? new File(getenv(&quot;SystemRoot&quot;)) :
127             getenv(&quot;WINDIR&quot;)     != null ? new File(getenv (&quot;WINDIR&quot;)) :
128             null;
129         if (systemRoot == null || ! systemRoot.isDirectory())
130             return; // Not Windows as we know it
131 
132         String systemDirW = new File(systemRoot, &quot;System32&quot;).getPath();
133         String systemDirM = systemDirW.replace(&#39;\\&#39;, &#39;/&#39;);
134         out.printf(&quot;systemDirW=%s%n&quot;, systemDirW);
135         out.printf(&quot;systemDirM=%s%n&quot;, systemDirM);
136 
137         // Win9x systems don&#39;t have a cmd.exe
138         if (new File(systemDirW, &quot;cmd.exe&quot;).exists()) {
139             try {
140                 out.println(&quot;Running cmd.exe tests...&quot;);
141                 writeFile(&quot;cdcmd.cmd&quot;, &quot;@echo off\r\nCD\r\n&quot;);
142                 writeFile(&quot;cdbat.bat&quot;, &quot;@echo off\r\nCD\r\n&quot;);
143                 checkCD(&quot;cmd&quot;,
144                         &quot;cmd.exe&quot;,
145                         systemDirW + &quot;\\cmd.exe&quot;,
146                         // Only the &quot;.exe&quot; extension can be omitted
147                         systemDirW + &quot;\\cmd&quot;,
148                         systemDirM + &quot;/cmd.exe&quot;,
149                         systemDirM + &quot;/cmd&quot;,
150                         &quot;/&quot; + systemDirM + &quot;/cmd&quot;,
151                         &quot;cdcmd.cmd&quot;, &quot;./cdcmd.cmd&quot;, &quot;.\\cdcmd.cmd&quot;,
152                         &quot;cdbat.bat&quot;, &quot;./cdbat.bat&quot;, &quot;.\\cdbat.bat&quot;);
153             } finally {
154                 new File(&quot;cdcmd.cmd&quot;).delete();
155                 new File(&quot;cdbat.bat&quot;).delete();
156             }
157         }
158 
159         // 16-bit apps like command.com must have a console;
160         // fix this someday...
161 
162 //      // Win64 systems don&#39;t have a command.com
163 //      if (new File(systemDirW, &quot;command.com&quot;).exists()
164 //          // no output if running without a console;
165 //          // fix this in Mustang
166 //          &amp;&amp; ! outputOf(&quot;command.com&quot;, &quot;/C&quot;, &quot;CD&quot;).equals(&quot;&quot;)) {
167 //          out.println(&quot;Running command.com tests...&quot;);
168 //          checkCD(&quot;command.com&quot;,
169 //                  systemDirM + &quot;/command.com&quot;,
170 //                  systemDirW + &quot;\\command.com&quot;);
171 //      }
172 
173         // Win9x systems have a %SYSTEMDRIVE%\command.com
174 //      if (new File(&quot;C:\\COMMAND.COM&quot;).exists()
175 //          &amp;&amp; ! outputOf(&quot;COMMAND.COM&quot;, &quot;/C&quot;, &quot;CD&quot;).equals(&quot;&quot;)) {
176 //          out.println(&quot;Running COMMAND.COM tests...&quot;);
177 //          checkCD(&quot;C:/command.com&quot;,
178 //                  &quot;C:\\command.com&quot;);
179 //      }
180 
181         if (failed &gt; 0)
182             throw new Exception(failed + &quot; tests failed&quot;);
183     }
184 }
    </pre>
  </body>
</html>