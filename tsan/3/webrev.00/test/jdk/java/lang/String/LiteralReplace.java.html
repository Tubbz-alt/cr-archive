<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New test/jdk/java/lang/String/LiteralReplace.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2015, 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /* @test
 25  * @bug 8058779 8054307 8222955
 26  * @library /test/lib
 27  * @build jdk.test.lib.RandomFactory
 28  * @run testng LiteralReplace
 29  * @summary Basic tests of String.replace(CharSequence, CharSequence)
 30  * @key randomness
 31  */
 32 
 33 import java.util.ArrayList;
 34 import java.util.Arrays;
 35 import java.util.Iterator;
 36 import java.util.regex.Matcher;
 37 import java.util.regex.Pattern;
 38 import java.util.Random;
 39 
 40 import jdk.test.lib.RandomFactory;
 41 
 42 import org.testng.annotations.Test;
 43 import org.testng.annotations.DataProvider;
 44 import static org.testng.Assert.fail;
 45 
 46 public class LiteralReplace {
 47 
 48     @Test(dataProvider=&quot;sourceTargetReplacementExpected&quot;)
 49     public void testExpected(String source, String target,
 50              String replacement, String expected)
 51     {
 52         String canonical = canonicalReplace(source, target, replacement);
 53         if (!canonical.equals(expected)) {
 54             fail(&quot;Canonical: &quot; + canonical + &quot; != &quot; + expected);
 55         }
 56         test0(source, target, replacement, expected);
 57     }
 58 
 59     @Test(dataProvider=&quot;sourceTargetReplacement&quot;)
 60     public void testCanonical(String source, String target,
 61             String replacement)
 62     {
 63         String canonical = canonicalReplace(source, target, replacement);
 64         test0(source, target, replacement, canonical);
 65     }
 66 
 67     private void test0(String source, String target, String replacement,
 68             String expected)
 69     {
 70         String result = source.replace(target, replacement);
 71         if (!result.equals(expected)) {
 72             fail(result + &quot; != &quot; + expected);
 73         }
 74     }
 75 
 76     @Test(dataProvider=&quot;sourceTargetReplacementWithNull&quot;,
 77             expectedExceptions = {NullPointerException.class})
 78     public void testNPE(String source, String target, String replacement) {
 79         source.replace(target, replacement);
 80     }
 81 
 82     @Test(expectedExceptions = {OutOfMemoryError.class})
 83     public void testOOM() {
 84         &quot;1&quot;.repeat(65537).replace(&quot;1&quot;, &quot;2&quot;.repeat(65537));
 85     }
 86 
 87     @DataProvider
 88     public static Object[][] sourceTargetReplacementExpected() {
 89         return new Object[][] {
 90             {&quot;aaa&quot;, &quot;aa&quot;, &quot;b&quot;, &quot;ba&quot;},
 91             {&quot;abcdefgh&quot;, &quot;def&quot;, &quot;DEF&quot;, &quot;abcDEFgh&quot;},
 92             {&quot;abcdefgh&quot;, &quot;123&quot;, &quot;DEF&quot;, &quot;abcdefgh&quot;},
 93             {&quot;abcdefgh&quot;, &quot;abcdefghi&quot;, &quot;DEF&quot;, &quot;abcdefgh&quot;},
 94             {&quot;abcdefghabc&quot;, &quot;abc&quot;, &quot;DEF&quot;, &quot;DEFdefghDEF&quot;},
 95             {&quot;abcdefghdef&quot;, &quot;def&quot;, &quot;&quot;, &quot;abcgh&quot;},
 96             {&quot;abcdefgh&quot;, &quot;&quot;, &quot;_&quot;, &quot;_a_b_c_d_e_f_g_h_&quot;},
 97             {&quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;},
 98             {&quot;&quot;, &quot;a&quot;, &quot;b&quot;, &quot;&quot;},
 99             {&quot;&quot;, &quot;&quot;, &quot;abc&quot;, &quot;abc&quot;},
100             {&quot;abcdefgh&quot;, &quot;abcdefgh&quot;, &quot;abcdefgh&quot;, &quot;abcdefgh&quot;},
101             {&quot;abcdefgh&quot;, &quot;abcdefgh&quot;, &quot;abcdefghi&quot;, &quot;abcdefghi&quot;},
102             {&quot;abcdefgh&quot;, &quot;abcdefgh&quot;, &quot;&quot;, &quot;&quot;},
103             {&quot;abcdabcd&quot;, &quot;abcd&quot;, &quot;&quot;, &quot;&quot;},
104             {&quot;aaaaaaaaa&quot;, &quot;aa&quot;, &quot;_X_&quot;, &quot;_X__X__X__X_a&quot;},
105             {&quot;aaaaaaaaa&quot;, &quot;aa&quot;, &quot;aaa&quot;, &quot;aaaaaaaaaaaaa&quot;},
106             {&quot;aaaaaaaaa&quot;, &quot;aa&quot;, &quot;aa&quot;, &quot;aaaaaaaaa&quot;},
107             {&quot;a.c.e.g.&quot;, &quot;.&quot;, &quot;-&quot;, &quot;a-c-e-g-&quot;},
108             {&quot;abcdefgh&quot;, &quot;[a-h]&quot;, &quot;X&quot;, &quot;abcdefgh&quot;},
109             {&quot;aa+&quot;, &quot;a+&quot;, &quot;&quot;, &quot;a&quot;},
110             {&quot;^abc$&quot;, &quot;abc&quot;, &quot;x&quot;, &quot;^x$&quot;},
111             {&quot;abc&quot;, &quot;b&quot;, &quot;_&quot;, &quot;a_c&quot;},
112             {&quot;abc&quot;, &quot;bc&quot;, &quot;_&quot;, &quot;a_&quot;},
113             {&quot;abc&quot;.repeat(65537) + &quot;end&quot;, &quot;b&quot;, &quot;_XYZ_&quot;, &quot;a_XYZ_c&quot;.repeat(65537) + &quot;end&quot;},
114             {&quot;abc&quot;.repeat(65537) + &quot;end&quot;, &quot;a&quot;, &quot;_&quot;, &quot;_bc&quot;.repeat(65537) + &quot;end&quot;},
115             {&quot;a&quot;.repeat(65537), &quot;a&quot;, &quot;&quot;, &quot;&quot;},
116             {&quot;ab&quot;.repeat(65537), &quot;a&quot;, &quot;&quot;, &quot;b&quot;.repeat(65537)},
117             {&quot;ab&quot;.repeat(65537), &quot;ab&quot;, &quot;&quot;, &quot;&quot;},
118             {&quot;b&quot; + &quot;ab&quot;.repeat(65537), &quot;ab&quot;, &quot;&quot;, &quot;b&quot;},
119 
120             // more with non-latin1 characters
121             {&quot;\u4e00\u4e00\u4e00&quot;,
122              &quot;\u4e00\u4e00&quot;,
123              &quot;\u4e01&quot;,
124              &quot;\u4e01\u4e00&quot;},
125 
126             {&quot;\u4e00\u4e01\u4e02\u4e03\u4e04\u4e05\u4e06\u4e07\u4e08&quot;,
127              &quot;\u4e03\u4e04\u4e05&quot;,
128              &quot;\u4e10\u4e11\u4e12&quot;,
129              &quot;\u4e00\u4e01\u4e02\u4e10\u4e11\u4e12\u4e06\u4e07\u4e08&quot;},
130 
131             {&quot;\u4e00\u4e01\u4e02\u4e03\u4e04\u4e05\u4e06\u4e07\u4e08&quot;,
132              &quot;ABC&quot;,
133              &quot;\u4e10\u4e11\u4e12&quot;,
134              &quot;\u4e00\u4e01\u4e02\u4e03\u4e04\u4e05\u4e06\u4e07\u4e08&quot;},
135 
136             {&quot;\u4e00\u4e01\u4e02\u4e03\u4e04\u4e02\u4e03\u4e07\u4e08&quot;,
137              &quot;\u4e02\u4e03&quot;,
138              &quot;\u4e12\u4e13&quot;,
139              &quot;\u4e00\u4e01\u4e12\u4e13\u4e04\u4e12\u4e13\u4e07\u4e08&quot;},
140 
141             {&quot;\u4e00\u4e01\u4e02\u4e03\u4e04\u4e02\u4e03\u4e07\u4e08&quot;,
142              &quot;\u4e02\u4e03&quot;,
143              &quot;ab&quot;,
144              &quot;\u4e00\u4e01ab\u4e04ab\u4e07\u4e08&quot;},
145 
146             {&quot;\u4e00\u4e01\u4e02\u4e03\u4e04\u4e05\u4e06\u4e07&quot;,
147              &quot;&quot;,
148              &quot;_&quot;,
149              &quot;_\u4e00_\u4e01_\u4e02_\u4e03_\u4e04_\u4e05_\u4e06_\u4e07_&quot;},
150             {&quot;^\u4e00\u4e01\u4e02$&quot;,
151              &quot;\u4e00\u4e01\u4e02&quot;,
152              &quot;\u4e03&quot;,
153              &quot;^\u4e03$&quot;},
154 
155             {&quot;&quot;, &quot;\u4e00&quot;, &quot;\u4e01&quot;, &quot;&quot;},
156             {&quot;&quot;, &quot;&quot;, &quot;\u4e00\u4e01\u4e02&quot;, &quot;\u4e00\u4e01\u4e02&quot;},
157 
158             {&quot;^\u4e00\u4e01\u4e02$&quot;,
159              &quot;\u4e00\u4e01\u4e02&quot;,
160              &quot;X&quot;,
161              &quot;^X$&quot;},
162 
163             {&quot;abcdefgh&quot;,
164              &quot;def&quot;,
165              &quot;\u4e01&quot;,
166              &quot;abc\u4e01gh&quot;},
167 
168             {&quot;abcdefgh&quot;,
169              &quot;def&quot;,
170              &quot;\u4e01\u4e02&quot;,
171              &quot;abc\u4e01\u4e02gh&quot;},
172 
173             {&quot;abcdefabcgh&quot;,
174              &quot;abc&quot;,
175              &quot;\u4e01\u4e02&quot;,
176              &quot;\u4e01\u4e02def\u4e01\u4e02gh&quot;},
177 
178             {&quot;abcdefabcghabc&quot;,
179              &quot;abc&quot;,
180              &quot;\u4e01\u4e02&quot;,
181              &quot;\u4e01\u4e02def\u4e01\u4e02gh\u4e01\u4e02&quot;},
182 
183             {&quot;\u4e00\u4e01\u4e02\u4e03\u4e04\u4e05&quot;,
184              &quot;\u4e00\u4e01\u4e02\u4e03\u4e04\u4e05&quot;,
185              &quot;abcd&quot;,
186              &quot;abcd&quot;},
187 
188             {&quot;\u4e00\u4e01&quot;,
189              &quot;\u4e00\u4e01&quot;,
190              &quot;abcdefg&quot;,
191              &quot;abcdefg&quot;},
192 
193             {&quot;\u4e00\u4e01xyz&quot;,
194              &quot;\u4e00\u4e01&quot;,
195              &quot;abcdefg&quot;,
196              &quot;abcdefgxyz&quot;},
197 
198             {&quot;\u4e00\u4e00\u4e00\u4e00\u4e00\u4e00&quot;,
199              &quot;\u4e00\u4e00&quot;,
200              &quot;\u4e00\u4e00\u4e00&quot;,
201              &quot;\u4e00\u4e00\u4e00\u4e00\u4e00\u4e00\u4e00\u4e00\u4e00&quot;},
202 
203             {&quot;\u4e00\u4e00\u4e00\u4e00\u4e00\u4e00&quot;,
204              &quot;\u4e00\u4e00\u4e00&quot;,
205              &quot;\u4e00\u4e00&quot;,
206              &quot;\u4e00\u4e00\u4e00\u4e00&quot;},
207 
208             {&quot;\u4e00.\u4e01.\u4e02.\u4e03.\u4e04.&quot;,
209              &quot;.&quot;,
210              &quot;-&quot;,
211              &quot;\u4e00-\u4e01-\u4e02-\u4e03-\u4e04-&quot;},
212 
213             {&quot;\u4e00\u4e00\u4e00\u4e00\u4e00\u4e00&quot;,
214              &quot;\u4e00&quot;,
215              &quot;&quot;,
216              &quot;&quot;},
217 
218             {&quot;\u4e00\u4e01\u4e02\u4e03\u4e04\u4e05&quot;,
219              &quot;\u4e00\u4e01\u4e02\u4e03\u4e04\u4e05&quot;,
220              &quot;&quot;,
221              &quot;&quot;},
222 
223             {&quot;\u4e01\u4e02\u4e03&quot;, &quot;\u4e02&quot;, &quot;\u4e02&quot;, &quot;\u4e01\u4e02\u4e03&quot;},
224             {&quot;\u4e01\u4e02\u4e03&quot;, &quot;\u4e02&quot;, &quot;\u4e04&quot;, &quot;\u4e01\u4e04\u4e03&quot;},
225             {&quot;\u4e01\u4e02\u4e03&quot;, &quot;\u4e02&quot;, &quot;_&quot;, &quot;\u4e01_\u4e03&quot;},
226             {&quot;a\u4e02c&quot;, &quot;\u4e02&quot;, &quot;_&quot;, &quot;a_c&quot;},
227             {&quot;\u4e01@\u4e03&quot;, &quot;@&quot;, &quot;_&quot;, &quot;\u4e01_\u4e03&quot;},
228             {&quot;\u4e01@\u4e03&quot;, &quot;@&quot;, &quot;\u4e02&quot;, &quot;\u4e01\u4e02\u4e03&quot;},
229             {&quot;\u4e01\u4e02\u4e03&quot;, &quot;\u4e02\u4e03&quot;, &quot;\u4e02\u4e03&quot;, &quot;\u4e01\u4e02\u4e03&quot;},
230             {&quot;\u4e01\u4e02\u4e03&quot;, &quot;\u4e02\u4e03&quot;, &quot;\u4e04\u4e05&quot;, &quot;\u4e01\u4e04\u4e05&quot;},
231             {&quot;\u4e01\u4e02\u4e03&quot;, &quot;\u4e02\u4e03&quot;, &quot;\u4e06&quot;, &quot;\u4e01\u4e06&quot;},
232             {&quot;\u4e01\u4e02\u4e03&quot;, &quot;\u4e02\u4e03&quot;, &quot;&lt;&gt;&quot;, &quot;\u4e01&lt;&gt;&quot;},
233             {&quot;@\u4e02\u4e03&quot;, &quot;\u4e02\u4e03&quot;, &quot;&lt;&gt;&quot;, &quot;@&lt;&gt;&quot;},
234             {&quot;\u4e01@@&quot;, &quot;\u4e01@&quot;, &quot;&quot;, &quot;@&quot;},
235             {&quot;\u4e01@@&quot;, &quot;\u4e01@&quot;, &quot;#&quot;, &quot;#@&quot;},
236             {&quot;\u4e01@@&quot;, &quot;\u4e01@&quot;, &quot;\u4e09&quot;, &quot;\u4e09@&quot;},
237             {&quot;\u4e01@@&quot;, &quot;\u4e01@&quot;, &quot;#\u4e09&quot;, &quot;#\u4e09@&quot;},
238             {&quot;\u4e01\u4e02\u4e03&quot;.repeat(32771) + &quot;end&quot;, &quot;\u4e02&quot;, &quot;\u4e02&quot;, &quot;\u4e01\u4e02\u4e03&quot;.repeat(32771) + &quot;end&quot;},
239             {&quot;\u4e01\u4e02\u4e03&quot;.repeat(32771) + &quot;end&quot;, &quot;\u4e02&quot;, &quot;\u4e04&quot;, &quot;\u4e01\u4e04\u4e03&quot;.repeat(32771) + &quot;end&quot;},
240             {&quot;\u4e01\u4e02\u4e03&quot;.repeat(32771) + &quot;end&quot;, &quot;\u4e02&quot;, &quot;\u4e04\u4e05&quot;, &quot;\u4e01\u4e04\u4e05\u4e03&quot;.repeat(32771) + &quot;end&quot;},
241             {&quot;\u4e01\u4e02\u4e03&quot;.repeat(32771) + &quot;end&quot;, &quot;\u4e02&quot;, &quot;_&quot;, &quot;\u4e01_\u4e03&quot;.repeat(32771) + &quot;end&quot;},
242             {&quot;\u4e01_\u4e03&quot;.repeat(32771) + &quot;end&quot;, &quot;_&quot;, &quot;_&quot;, &quot;\u4e01_\u4e03&quot;.repeat(32771) + &quot;end&quot;},
243             {&quot;\u4e01_\u4e03&quot;.repeat(32771) + &quot;end&quot;, &quot;_&quot;, &quot;\u4e06&quot;, &quot;\u4e01\u4e06\u4e03&quot;.repeat(32771) + &quot;end&quot;},
244             {&quot;\u4e01_\u4e03&quot;.repeat(32771) + &quot;end&quot;, &quot;_&quot;, &quot;\u4e06\u4e06&quot;, &quot;\u4e01\u4e06\u4e06\u4e03&quot;.repeat(32771) + &quot;end&quot;},
245             {&quot;X_Y&quot;.repeat(32771) + &quot;end&quot;, &quot;_&quot;, &quot;\u4e07&quot;, &quot;X\u4e07Y&quot;.repeat(32771) + &quot;end&quot;},
246             {&quot;X_Y&quot;.repeat(32771) + &quot;end&quot;, &quot;_&quot;, &quot;\u4e07\u4e08&quot;, &quot;X\u4e07\u4e08Y&quot;.repeat(32771) + &quot;end&quot;},
247             {&quot;X_Y&quot;.repeat(32771) + &quot;end&quot;, &quot;_&quot;, &quot;.\u4e08.&quot;, &quot;X.\u4e08.Y&quot;.repeat(32771) + &quot;end&quot;},
248             {&quot;\u4e0a&quot;.repeat(32771), &quot;\u4e0a&quot;, &quot;&quot;, &quot;&quot;},
249             {&quot;\u4e0a\u4e0b&quot;.repeat(32771), &quot;\u4e0a&quot;, &quot;&quot;, &quot;\u4e0b&quot;.repeat(32771)},
250             {&quot;\u4e0a\u4e0b&quot;.repeat(32771), &quot;\u4e0b&quot;, &quot;&quot;, &quot;\u4e0a&quot;.repeat(32771)},
251             {&quot;\u4e0a\u4e0b&quot;.repeat(32771), &quot;\u4e0a\u4e0b&quot;, &quot;&quot;, &quot;&quot;},
252             {&quot;\u4e0b&quot; + &quot;\u4e0a\u4e0b&quot;.repeat(32771), &quot;\u4e0a\u4e0b&quot;, &quot;&quot;, &quot;\u4e0b&quot;},
253             {&quot;\u4e0a\u4e0b&quot;.repeat(32771) + &quot;\u4e0a&quot;, &quot;\u4e0a\u4e0b&quot;, &quot;&quot;, &quot;\u4e0a&quot;},
254             {&quot;\u4e0b&quot; + &quot;\u4e0a\u4e0b&quot;.repeat(32771) + &quot;\u4e0a&quot;, &quot;\u4e0a\u4e0b&quot;, &quot;&quot;, &quot;\u4e0b\u4e0a&quot;},
255             {&quot;b&quot; + &quot;\u4e0a\u4e0b&quot;.repeat(32771), &quot;\u4e0a\u4e0b&quot;, &quot;&quot;, &quot;b&quot;},
256             {&quot;\u4e0a\u4e0b&quot;.repeat(32771) + &quot;a&quot;, &quot;\u4e0a\u4e0b&quot;, &quot;&quot;, &quot;a&quot;},
257             {&quot;b&quot; + &quot;\u4e0a\u4e0b&quot;.repeat(32771) + &quot;a&quot;, &quot;\u4e0a\u4e0b&quot;, &quot;&quot;, &quot;ba&quot;},
258         };
259     }
260 
261     @DataProvider
262     public static Iterator&lt;Object[]&gt; sourceTargetReplacement() {
263         ArrayList&lt;Object[]&gt; list = new ArrayList&lt;&gt;();
264         for (int maxSrcLen = 1; maxSrcLen &lt;= (1 &lt;&lt; 10); maxSrcLen &lt;&lt;= 1) {
265             for (int maxTrgLen = 1; maxTrgLen &lt;= (1 &lt;&lt; 10); maxTrgLen &lt;&lt;= 1) {
266                 for (int maxPrlLen = 1; maxPrlLen &lt;= (1 &lt;&lt; 10); maxPrlLen &lt;&lt;= 1) {
267                     list.add(makeArray(makeRandomString(maxSrcLen),
268                                        makeRandomString(maxTrgLen),
269                                        makeRandomString(maxPrlLen)));
270 
271                     String source = makeRandomString(maxSrcLen);
272                     list.add(makeArray(source,
273                                        mekeRandomSubstring(source, maxTrgLen),
274                                        makeRandomString(maxPrlLen)));
275                 }
276             }
277         }
278         return list.iterator();
279     }
280 
281     @DataProvider
282     public static Iterator&lt;Object[]&gt; sourceTargetReplacementWithNull() {
283         ArrayList&lt;Object[]&gt; list = new ArrayList&lt;&gt;();
284         Object[] arr = {null, &quot;&quot;, &quot;a&quot;, &quot;b&quot;, &quot;string&quot;, &quot;str&quot;, &quot;ababstrstr&quot;};
285         for (int i = 0; i &lt; arr.length; ++i) {
286             for (int j = 0; j &lt; arr.length; ++j) {
287                 for (int k = 0; k &lt; arr.length; ++k) {
288                     if (arr[i] != null &amp;&amp; (arr[j] == null || arr[k] == null)) {
289                         list.add(makeArray(arr[i], arr[j], arr[k]));
290                     }
291                 }
292             }
293         }
294         return list.iterator();
295     }
296 
297     // utilities
298 
299     /**
300      * How the String.replace(CharSequence, CharSequence) used to be implemented
301      */
302     private static String canonicalReplace(String source, String target, String replacement) {
303         return Pattern.compile(target.toString(), Pattern.LITERAL).matcher(
304                 source).replaceAll(Matcher.quoteReplacement(replacement.toString()));
305     }
306 
307     private static final Random random = RandomFactory.getRandom();
308 
309     private static final char[] CHARS = (&quot;qwertyuiop[]12345678&quot; +
310         &quot;90-=\\`asdfghjkl;&#39;zxcvbnm,./~!@#$%^&amp;*()_+|QWERTYUIOP{&quot; +
311         &quot;}ASDFGHJKL:\&quot;ZXCVBNM&lt;&gt;?\n\r\t\u0444\u044B\u0432\u0430&quot;).toCharArray();
312 
313     private static String makeRandomString(int maxLen) {
314         int len = random.nextInt(maxLen);
315         char[] buf = new char[len];
316         for (int i = 0; i &lt; len; ++i) {
317             buf[i] = CHARS[random.nextInt(CHARS.length)];
318         }
319         return new String(buf);
320     }
321 
322     private static String mekeRandomSubstring(String source, int maxLen) {
323         if (source.isEmpty()) {
324             return source;
325         }
326         int pos = random.nextInt(source.length());
327         int len = Integer.min(source.length() - pos,
328                               random.nextInt(maxLen));
329         return source.substring(pos, pos + len);
330     }
331 
332     private static Object[] makeArray(Object... array) {
333          return array;
334     }
335 }
    </pre>
  </body>
</html>