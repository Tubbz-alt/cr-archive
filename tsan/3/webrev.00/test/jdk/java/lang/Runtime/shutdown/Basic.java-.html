<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old test/jdk/java/lang/Runtime/shutdown/Basic.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2018, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @bug 4227137
 27  * @summary Basic functional test for virtual-machine shutdown hooks
 28  * @modules java.desktop
 29  * @library /test/lib
 30  * @build jdk.test.lib.process.*
 31  * @run testng Basic
 32  */
 33 
 34 import java.lang.reflect.Method;
 35 import java.lang.reflect.InvocationTargetException;
 36 import java.io.PrintStream;
 37 import java.io.FileOutputStream;
 38 import java.awt.Frame;
 39 import java.awt.TextArea;
 40 import java.awt.event.WindowEvent;
 41 import java.awt.event.WindowAdapter;
 42 
 43 import org.testng.annotations.DataProvider;
 44 import org.testng.annotations.Test;
 45 import jdk.test.lib.process.ProcessTools;
 46 
 47 public class Basic {
 48 
 49     static Runtime rt = Runtime.getRuntime();
 50     static PrintStream out = System.out;
 51 
 52     // Expect that no finalizer is invoked at exit
 53     @DataProvider(name = &quot;testcase&quot;)
 54     public Object[][] getTestCase() {
 55         return new Object[][] {
 56             { &quot;fallThrough&quot;, 0, &quot;h1&quot;, &quot;&quot; },
 57             { &quot;exit0&quot;,       0, &quot;h1&quot;, &quot;&quot; },
 58             { &quot;exit0NoHook&quot;, 0, &quot;&quot;,   &quot;&quot; },
 59             { &quot;exit1&quot;,       1, &quot;h1&quot;, &quot;&quot; },
 60             { &quot;exit1NoHook&quot;, 1, &quot;&quot;,   &quot;&quot; },
 61             { &quot;halt&quot;,        0, &quot;&quot;,   &quot;&quot; },
 62             { &quot;haltNoHook&quot;,  0, &quot;&quot;,   &quot;&quot; },
 63             { &quot;haltInHook&quot;,  0, &quot;h1&quot;, &quot;&quot; },
 64             { &quot;addLate&quot;,     0, &quot;h1&quot;,
 65                 &quot;Caught as expected: java.lang.IllegalStateException: Shutdown in progress&quot; },
 66             { &quot;removeLate&quot;,  0, &quot;h2&quot;,
 67                 &quot;Caught as expected: java.lang.IllegalStateException: Shutdown in progress&quot; }
 68         };
 69     }
 70 
 71     @Test(dataProvider = &quot;testcase&quot;)
 72     public void test(String testcase, int exitValue, String hook, String finalizer)
 73             throws Exception {
 74         System.out.println(&quot;Test &quot; + testcase);
 75         ProcessTools.executeTestJava(&quot;Basic&quot;, testcase)
 76                 .shouldHaveExitValue(exitValue)
 77                 .stdoutShouldMatch(
 78                     hook + (hook.isEmpty() ? &quot;&quot; : System.lineSeparator()) + finalizer);
 79         System.out.println(&quot;Passed&quot;);
 80     }
 81 
 82     public static class Fin {
 83         String name;
 84 
 85         public Fin(String name) {
 86             this.name = name;
 87         }
 88 
 89         public void go() { }
 90 
 91         protected void finalize() {
 92             out.println(name);
 93             go();
 94         }
 95     }
 96 
 97 
 98     public static class Hook extends Thread {
 99         String name;
100 
101         public Hook(String name) {
102             this.name = name;
103         }
104 
105         public void go() { }
106 
107         public void run() {
108             out.println(name);
109             go();
110         }
111     }
112 
113     public static void fallThrough() throws Exception {
114         rt.addShutdownHook(new Hook(&quot;h1&quot;));
115         Fin f = new Fin(&quot;f1&quot;);
116     }
117 
118     public static void exit0() throws Exception {
119         rt.addShutdownHook(new Hook(&quot;h1&quot;));
120         Fin f = new Fin(&quot;f1&quot;);
121         rt.exit(0);
122     }
123 
124     public static void exit0NoHook() throws Exception {
125         Fin f = new Fin(&quot;f1&quot;);
126         rt.exit(0);
127     }
128 
129     /* Finalizer should not run */
130     public static void exit1() throws Exception {
131         rt.addShutdownHook(new Hook(&quot;h1&quot;));
132         Fin f = new Fin(&quot;f1&quot;);
133         rt.exit(1);
134     }
135 
136     public static void exit1NoHook() throws Exception {
137         Fin f = new Fin(&quot;f1&quot;);
138         rt.exit(1);
139     }
140 
141     public static void halt() throws Exception {
142         rt.addShutdownHook(new Hook(&quot;h1&quot;) {
143             public void go() { rt.halt(1); }});
144         Fin f = new Fin(&quot;f1&quot;) { public void go() { rt.halt(1); }};
145         rt.halt(0);
146     }
147 
148     public static void haltNoHook() throws Exception {
149         Fin f = new Fin(&quot;f1&quot;) { public void go() { rt.halt(1); }};
150         rt.halt(0);
151     }
152 
153     public static void haltInHook() throws Exception {
154         rt.addShutdownHook(new Hook(&quot;h1&quot;) {
155             public void go() { rt.halt(0); }});
156         Fin f = new Fin(&quot;f1&quot;);
157         rt.exit(1);
158     }
159 
160     public static void addLate() throws Exception {
161         rt.addShutdownHook(new Hook(&quot;h1&quot;) {
162             public void go() {
163                 try {
164                     rt.addShutdownHook(new Hook(&quot;h2&quot;));
165                 } catch (IllegalStateException x) {
166                     out.println(&quot;Caught as expected: &quot; + x);
167                     rt.halt(0);
168                 }
169             }});
170         rt.exit(1);
171     }
172 
173     public static void removeLate() throws Exception {
174         final Hook h1 = new Hook(&quot;h1&quot;);
175         rt.addShutdownHook(new Hook(&quot;h2&quot;) {
176             public void go() {
177                 try {
178                     rt.removeShutdownHook(h1);
179                 } catch (IllegalStateException x) {
180                     out.println(&quot;Caught as expected: &quot; + x);
181                     rt.halt(0);
182                 }
183             }});
184         rt.exit(1);
185     }
186 
187     /* For INT, HUP, TERM */
188     public static void stall() throws Exception {
189         Fin f = new Fin(&quot;f1&quot;);
190         rt.addShutdownHook(new Hook(&quot;h1&quot;));
191         out.print(&quot;Type ^C now: &quot;);
192         out.flush();
193         Thread.sleep(100000);
194     }
195 
196 
197     public static void main(String[] args) throws Throwable {
198         Method m = Basic.class.getMethod(args[0], new Class[] { });
199         String log = null;
200         try {
201             log = System.getProperty(&quot;log&quot;);
202         } catch (SecurityException x) { }
203         if (log != null) {
204             out = new PrintStream(new FileOutputStream(log), true);
205         }
206         try {
207             m.invoke(null, new Object[] { });
208         } catch (InvocationTargetException x) {
209             throw x.getTargetException();
210         }
211     }
212 
213 }
    </pre>
  </body>
</html>