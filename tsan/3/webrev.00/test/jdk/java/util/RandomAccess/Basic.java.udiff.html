<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/jdk/java/util/RandomAccess/Basic.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="../Properties/PropertiesTest.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../ResourceBundle/Control/MissingResourceCauseTestRun.java.udiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/util/RandomAccess/Basic.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2000, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -19,113 +19,150 @@</span>
   * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
   * or visit www.oracle.com if you need additional information or have any
   * questions.
   */
  
<span class="udiff-line-modified-removed">- /*</span>
<span class="udiff-line-modified-added">+ /**</span>
   * @test
<span class="udiff-line-modified-removed">-  * @bug 4327164</span>
<span class="udiff-line-modified-added">+  * @bug 4327164 8229338</span>
   * @summary Basic test for new RandomAccess interface
<span class="udiff-line-added">+  * @run testng Basic</span>
   */
  
<span class="udiff-line-modified-removed">- import java.util.ArrayList;</span>
<span class="udiff-line-modified-removed">- import java.util.Arrays;</span>
<span class="udiff-line-modified-removed">- import java.util.Collections;</span>
<span class="udiff-line-modified-removed">- import java.util.LinkedList;</span>
<span class="udiff-line-modified-removed">- import java.util.List;</span>
<span class="udiff-line-modified-removed">- import java.util.Random;</span>
<span class="udiff-line-modified-removed">- import java.util.RandomAccess;</span>
<span class="udiff-line-modified-removed">- import java.util.Vector;</span>
<span class="udiff-line-modified-added">+ import org.testng.annotations.DataProvider;</span>
<span class="udiff-line-modified-added">+ import org.testng.annotations.Test;</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+ import static org.testng.Assert.assertEquals;</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+ import java.util.*;</span>
<span class="udiff-line-modified-added">+ import java.util.concurrent.CopyOnWriteArrayList;</span>
<span class="udiff-line-modified-added">+ import java.util.function.Function;</span>
<span class="udiff-line-added">+ import java.util.function.Supplier;</span>
  
  public class Basic {
<span class="udiff-line-removed">-     public static void main(String[] args) throws Exception {</span>
<span class="udiff-line-removed">-         List a0 = Arrays.asList(new String[] { &quot;a&quot;, &quot;b&quot;, &quot;c&quot; });</span>
<span class="udiff-line-removed">-         List a[] = { a0, new ArrayList(a0), new LinkedList(a0),</span>
<span class="udiff-line-removed">-                 new Vector(a0) };</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         if (!(a[0] instanceof RandomAccess))</span>
<span class="udiff-line-removed">-             throw new Exception(&quot;Arrays.asList doesn&#39;t implement RandomAccess&quot;);</span>
<span class="udiff-line-removed">-         if (!(a[1] instanceof RandomAccess))</span>
<span class="udiff-line-removed">-             throw new Exception(&quot;ArrayList doesn&#39;t implement RandomAccess&quot;);</span>
<span class="udiff-line-removed">-         if (a[2] instanceof RandomAccess)</span>
<span class="udiff-line-removed">-             throw new Exception(&quot;LinkedList implements RandomAccess&quot;);</span>
<span class="udiff-line-removed">-         if (!(a[3] instanceof RandomAccess))</span>
<span class="udiff-line-removed">-             throw new Exception(&quot;Vector doesn&#39;t implement RandomAccess&quot;);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         for (int i = 0; i &lt; a.length; i++) {</span>
<span class="udiff-line-removed">-             List t = a[i];</span>
<span class="udiff-line-removed">-             List ut = Collections.unmodifiableList(t);</span>
<span class="udiff-line-removed">-             List st = Collections.synchronizedList(t);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             boolean random = t instanceof RandomAccess;</span>
<span class="udiff-line-removed">-             if ((ut instanceof RandomAccess) != random)</span>
<span class="udiff-line-removed">-                 throw new Exception(</span>
<span class="udiff-line-removed">-                         &quot;Unmodifiable fails to preserve RandomAccess: &quot; + i);</span>
<span class="udiff-line-removed">-             if ((st instanceof RandomAccess) != random)</span>
<span class="udiff-line-removed">-                 throw new Exception(</span>
<span class="udiff-line-removed">-                         &quot;Synchronized fails to preserve RandomAccess: &quot; + i);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             while (t.size() &gt; 0) {</span>
<span class="udiff-line-removed">-                 t = t.subList(0, t.size() - 1);</span>
<span class="udiff-line-removed">-                 if ((t instanceof RandomAccess) != random)</span>
<span class="udiff-line-removed">-                     throw new Exception(</span>
<span class="udiff-line-removed">-                             &quot;SubList fails to preserve RandomAccess: &quot; + i</span>
<span class="udiff-line-removed">-                                     + &quot;, &quot; + t.size());</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-                 ut = ut.subList(0, ut.size() - 1);</span>
<span class="udiff-line-removed">-                 if ((ut instanceof RandomAccess) != random)</span>
<span class="udiff-line-removed">-                     throw new Exception(</span>
<span class="udiff-line-removed">-                             &quot;SubList(unmodifiable) fails to preserve RandomAccess: &quot;</span>
<span class="udiff-line-removed">-                                     + i + &quot;, &quot; + ut.size());</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-                 st = st.subList(0, st.size() - 1);</span>
<span class="udiff-line-removed">-                 if ((st instanceof RandomAccess) != random)</span>
<span class="udiff-line-removed">-                     throw new Exception(</span>
<span class="udiff-line-removed">-                             &quot;SubList(synchronized) fails to preserve RandomAccess: &quot;</span>
<span class="udiff-line-removed">-                                     + i + &quot;, &quot; + st.size());</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-         }</span>
  
<span class="udiff-line-modified-removed">-         // Test that shuffle works the same on random and sequential access</span>
<span class="udiff-line-modified-removed">-         List al = new ArrayList();</span>
<span class="udiff-line-modified-removed">-         for (int j = 0; j &lt; 100; j++)</span>
<span class="udiff-line-modified-removed">-             al.add(Integer.valueOf(2 * j));</span>
<span class="udiff-line-modified-removed">-         List ll = new LinkedList(al);</span>
<span class="udiff-line-modified-removed">-         Random r1 = new Random(666), r2 = new Random(666);</span>
<span class="udiff-line-modified-added">+     /*</span>
<span class="udiff-line-modified-added">+      * Lists which implement Random Access interface</span>
<span class="udiff-line-modified-added">+      */</span>
<span class="udiff-line-modified-added">+     @DataProvider(name = &quot;testLists&quot;)</span>
<span class="udiff-line-modified-added">+     public Object[][] testData() {</span>
<span class="udiff-line-modified-added">+         var intArray = new Integer[100];</span>
<span class="udiff-line-added">+         var stack = new Stack&lt;&gt;();</span>
<span class="udiff-line-added">+         var random = new Random();</span>
          for (int i = 0; i &lt; 100; i++) {
<span class="udiff-line-modified-removed">-             Collections.shuffle(al, r1);</span>
<span class="udiff-line-modified-removed">-             Collections.shuffle(ll, r2);</span>
<span class="udiff-line-modified-removed">-             if (!al.equals(ll))</span>
<span class="udiff-line-modified-removed">-                 throw new Exception(&quot;Shuffle failed: &quot; + i);</span>
<span class="udiff-line-modified-added">+             var r = random.nextInt(100);</span>
<span class="udiff-line-modified-added">+             stack.push(r);</span>
<span class="udiff-line-modified-added">+             intArray[i] = r;</span>
<span class="udiff-line-modified-added">+         }</span>
<span class="udiff-line-added">+         List&lt;Integer&gt; list = Arrays.asList(intArray);</span>
<span class="udiff-line-added">+         return new Object[][]{</span>
<span class="udiff-line-added">+                 {list, true, &quot;Arrays.asList&quot;},</span>
<span class="udiff-line-added">+                 {stack, true, &quot;Stack&quot;},</span>
<span class="udiff-line-added">+                 {new ArrayList&lt;&gt;(list), true, &quot;ArrayList&quot;},</span>
<span class="udiff-line-added">+                 {new LinkedList&lt;&gt;(list), false, &quot;LinkedList&quot;},</span>
<span class="udiff-line-added">+                 {new Vector&lt;&gt;(list), true, &quot;Vector&quot;},</span>
<span class="udiff-line-added">+                 {new CopyOnWriteArrayList&lt;&gt;(list), true, &quot;CopyOnWriteArrayList&quot;}</span>
<span class="udiff-line-added">+         };</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     @Test(dataProvider = &quot;testLists&quot;)</span>
<span class="udiff-line-added">+     public void testRandomAccess(List&lt;Integer&gt; list, boolean expectedRA, String failMsg) {</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         var actualRA = list instanceof RandomAccess;</span>
<span class="udiff-line-added">+         assertEquals(actualRA, expectedRA, failMsg);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         List&lt;Integer&gt; unmodList = Collections.unmodifiableList(list);</span>
<span class="udiff-line-added">+         List&lt;Integer&gt; syncList = Collections.synchronizedList(list);</span>
<span class="udiff-line-added">+         assertEquals((unmodList instanceof RandomAccess), actualRA,</span>
<span class="udiff-line-added">+                 &quot;Unmodifiable fails to preserve RandomAccess&quot;);</span>
<span class="udiff-line-added">+         assertEquals((syncList instanceof RandomAccess), actualRA,</span>
<span class="udiff-line-added">+                 &quot;Synchronized fails to preserve RandomAccess&quot;);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         while (list.size() &gt; 0) {</span>
<span class="udiff-line-added">+             list = list.subList(0, list.size() - 1);</span>
<span class="udiff-line-added">+             assertEquals((list instanceof RandomAccess), actualRA,</span>
<span class="udiff-line-added">+                     &quot;SubList fails to preserve RandomAccess: &quot; + list.size());</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             unmodList = unmodList.subList(0, unmodList.size() - 1);</span>
<span class="udiff-line-added">+             assertEquals((unmodList instanceof RandomAccess), actualRA,</span>
<span class="udiff-line-added">+                     &quot;SubList(unmodifiable) fails to preserve RandomAccess: &quot;</span>
<span class="udiff-line-added">+                             + unmodList.size());</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             syncList = syncList.subList(0, syncList.size() - 1);</span>
<span class="udiff-line-added">+             assertEquals((syncList instanceof RandomAccess), actualRA,</span>
<span class="udiff-line-added">+                     &quot;SubList(synchronized) fails to preserve RandomAccess: &quot;</span>
<span class="udiff-line-added">+                             + syncList.size());</span>
          }
<span class="udiff-line-added">+     }</span>
  
<span class="udiff-line-modified-removed">-         // Test that fill works on random &amp; sequential access</span>
<span class="udiff-line-modified-removed">-         List gumbyParade = Collections.nCopies(100, &quot;gumby&quot;);</span>
<span class="udiff-line-modified-removed">-         Collections.fill(al, &quot;gumby&quot;);</span>
<span class="udiff-line-modified-removed">-         if (!al.equals(gumbyParade))</span>
<span class="udiff-line-modified-removed">-             throw new Exception(&quot;ArrayList fill failed&quot;);</span>
<span class="udiff-line-modified-removed">-         Collections.fill(ll, &quot;gumby&quot;);</span>
<span class="udiff-line-modified-removed">-         if (!ll.equals(gumbyParade))</span>
<span class="udiff-line-removed">-             throw new Exception(&quot;LinkedList fill failed&quot;);</span>
<span class="udiff-line-modified-added">+     @Test(dataProvider = &quot;testLists&quot;)</span>
<span class="udiff-line-modified-added">+     public void testListCopy(List&lt;Integer&gt; list, boolean expectedRA, String failMsg) {</span>
<span class="udiff-line-modified-added">+         ArrayList testCollection = new ArrayList&lt;&gt;(Collections.nCopies(100, 0));</span>
<span class="udiff-line-modified-added">+         // Test that copy works on random &amp; sequential access</span>
<span class="udiff-line-modified-added">+         Collections.copy(list, testCollection);</span>
<span class="udiff-line-modified-added">+         assertEquals(list, testCollection, &quot;Copy failed: &quot; + failMsg);</span>
<span class="udiff-line-modified-added">+     }</span>
  
<span class="udiff-line-added">+     @Test(dataProvider = &quot;testLists&quot;)</span>
<span class="udiff-line-added">+     public void testListFill(List&lt;Integer&gt; list, boolean expectedRA, String failMsg) {</span>
<span class="udiff-line-added">+         ArrayList testCollection = new ArrayList&lt;&gt;(Collections.nCopies(100, 0));</span>
          // Test that copy works on random &amp; sequential access
<span class="udiff-line-modified-removed">-         List pokeyParade = Collections.nCopies(100, &quot;pokey&quot;);</span>
<span class="udiff-line-modified-removed">-         Collections.copy(al, pokeyParade);</span>
<span class="udiff-line-modified-removed">-         if (!al.equals(pokeyParade))</span>
<span class="udiff-line-modified-removed">-             throw new Exception(&quot;ArrayList copy failed&quot;);</span>
<span class="udiff-line-modified-removed">-         Collections.copy(ll, pokeyParade);</span>
<span class="udiff-line-modified-removed">-         if (!ll.equals(pokeyParade))</span>
<span class="udiff-line-modified-removed">-             throw new Exception(&quot;LinkedList copy failed&quot;);</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-         // Test that binarySearch works the same on random &amp; sequential access</span>
<span class="udiff-line-modified-removed">-         al = new ArrayList();</span>
<span class="udiff-line-modified-removed">-         for (int i = 0; i &lt; 10000; i++)</span>
<span class="udiff-line-modified-removed">-             al.add(Integer.valueOf(2 * i));</span>
<span class="udiff-line-modified-removed">-         ll = new LinkedList(al);</span>
<span class="udiff-line-modified-added">+         Collections.fill(list, 0);</span>
<span class="udiff-line-modified-added">+         assertEquals(list, testCollection, &quot;Fill failed: &quot; + failMsg);</span>
<span class="udiff-line-modified-added">+     }</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+     /*</span>
<span class="udiff-line-modified-added">+      * Test that shuffle and binarySearch work the same on random and sequential access lists.</span>
<span class="udiff-line-modified-added">+      */</span>
<span class="udiff-line-modified-added">+     @DataProvider(name = &quot;testFactoryLists&quot;)</span>
<span class="udiff-line-modified-added">+     public Object[][] testDataFactory() {</span>
<span class="udiff-line-modified-added">+         return new Object[][]{</span>
<span class="udiff-line-modified-added">+                 {&quot;ArrayList -&gt; LinkedList&quot;, supplier(ArrayList::new), copyCtor(LinkedList::new)},</span>
<span class="udiff-line-modified-added">+                 {&quot;CopyOnWriteArrayList -&gt; Stack&quot;, supplier(CopyOnWriteArrayList::new),</span>
<span class="udiff-line-modified-added">+                         copyCtor((list) -&gt; { var s = new Stack();s.addAll(list);return s; })}</span>
<span class="udiff-line-added">+         };</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private Supplier&lt;List&lt;Integer&gt;&gt; supplier(Supplier&lt;List&lt;Integer&gt;&gt; supplier) {</span>
<span class="udiff-line-added">+         return supplier;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private Function&lt;List&lt;Integer&gt;, List&lt;Integer&gt;&gt; copyCtor(Function&lt;List&lt;Integer&gt;, List&lt;Integer&gt;&gt; ctor) {</span>
<span class="udiff-line-added">+         return ctor;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     @Test(dataProvider = &quot;testFactoryLists&quot;)</span>
<span class="udiff-line-added">+     public void testListShuffle(String description, Supplier&lt;List&lt;Integer&gt;&gt; randomAccessListSupplier,</span>
<span class="udiff-line-added">+                                 Function&lt;List&lt;Integer&gt;, List&lt;Integer&gt;&gt; otherListFactory) {</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         //e.g: ArrayList&lt;Integer&gt; al = new ArrayList&lt;&gt;();</span>
<span class="udiff-line-added">+         List&lt;Integer&gt; l1 = randomAccessListSupplier.get();</span>
<span class="udiff-line-added">+         for (int j = 0; j &lt; 100; j++) {</span>
<span class="udiff-line-added">+             l1.add(Integer.valueOf(2 * j));</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         // e.g: List&lt;Integer&gt; ll = new LinkedList&lt;&gt;(al);</span>
<span class="udiff-line-added">+         List&lt;Integer&gt; l2 = otherListFactory.apply(l1);</span>
<span class="udiff-line-added">+         for (int i = 0; i &lt; 100; i++) {</span>
<span class="udiff-line-added">+             Collections.shuffle(l1, new Random(666));</span>
<span class="udiff-line-added">+             Collections.shuffle(l2, new Random(666));</span>
<span class="udiff-line-added">+             assertEquals(l1, l2, &quot;Shuffle failed: &quot; + description);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     @Test(dataProvider = &quot;testFactoryLists&quot;)</span>
<span class="udiff-line-added">+     public void testListBinarySearch(String description, Supplier&lt;List&lt;Integer&gt;&gt; randomAccessListSupplier,</span>
<span class="udiff-line-added">+                                      Function&lt;List&lt;Integer&gt;, List&lt;Integer&gt;&gt; otherListFactory) {</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         //e.g: ArrayList&lt;Integer&gt; al = new ArrayList&lt;&gt;();</span>
<span class="udiff-line-added">+         List&lt;Integer&gt; l1 = randomAccessListSupplier.get();</span>
<span class="udiff-line-added">+         for (int i = 0; i &lt; 10000; i++) {</span>
<span class="udiff-line-added">+             l1.add(Integer.valueOf(2 * i));</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         // e.g: List&lt;Integer&gt; ll = new LinkedList&lt;&gt;(al);</span>
<span class="udiff-line-added">+         List&lt;Integer&gt; l2 = otherListFactory.apply(l1);</span>
          for (int i = 0; i &lt; 500; i++) {
<span class="udiff-line-modified-removed">-             Integer key = Integer.valueOf(r1.nextInt(20000));</span>
<span class="udiff-line-modified-removed">-             if (Collections.binarySearch(al, key) != Collections</span>
<span class="udiff-line-modified-removed">-                     .binarySearch(ll, key))</span>
<span class="udiff-line-removed">-                 throw new Exception(&quot;Binary search failed: &quot; + i);</span>
<span class="udiff-line-modified-added">+             Integer key = Integer.valueOf(new Random(666).nextInt(20000));</span>
<span class="udiff-line-modified-added">+             assertEquals(Collections.binarySearch(l1, key), Collections</span>
<span class="udiff-line-modified-added">+                     .binarySearch(l2, key), &quot;Binary search failed: &quot; + description);</span>
          }
      }
  }
</pre>
<center><a href="../Properties/PropertiesTest.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../ResourceBundle/Control/MissingResourceCauseTestRun.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>