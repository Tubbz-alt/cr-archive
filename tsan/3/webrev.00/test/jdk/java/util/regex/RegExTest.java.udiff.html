<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/jdk/java/util/regex/RegExTest.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="GraphemeTest.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="TestCases.txt.udiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/util/regex/RegExTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 1999, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 1999, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -33,27 +33,43 @@</span>
   * 6350801 6676425 6878475 6919132 6931676 6948903 6990617 7014645 7039066
   * 7067045 7014640 7189363 8007395 8013252 8013254 8012646 8023647 6559590
   * 8027645 8035076 8039124 8035975 8074678 6854417 8143854 8147531 7071819
   * 8151481 4867170 7080302 6728861 6995635 6736245 4916384 6328855 6192895
   * 6345469 6988218 6693451 7006761 8140212 8143282 8158482 8176029 8184706
<span class="udiff-line-modified-removed">-  * 8194667 8197462 8184692</span>
<span class="udiff-line-modified-added">+  * 8194667 8197462 8184692 8221431 8224789 8228352 8230829 8236034 8235812</span>
   *
   * @library /test/lib
<span class="udiff-line-added">+  * @library /lib/testlibrary/java/lang</span>
   * @build jdk.test.lib.RandomFactory
   * @run main RegExTest
   * @key randomness
   */
  
<span class="udiff-line-modified-removed">- import java.util.function.Function;</span>
<span class="udiff-line-modified-removed">- import java.util.regex.*;</span>
<span class="udiff-line-modified-added">+ import java.io.BufferedReader;</span>
<span class="udiff-line-modified-added">+ import java.io.ByteArrayInputStream;</span>
<span class="udiff-line-added">+ import java.io.ByteArrayOutputStream;</span>
<span class="udiff-line-added">+ import java.io.File;</span>
<span class="udiff-line-added">+ import java.io.FileInputStream;</span>
<span class="udiff-line-added">+ import java.io.InputStreamReader;</span>
<span class="udiff-line-added">+ import java.io.ObjectInputStream;</span>
<span class="udiff-line-added">+ import java.io.ObjectOutputStream;</span>
<span class="udiff-line-added">+ import java.math.BigInteger;</span>
<span class="udiff-line-added">+ import java.nio.CharBuffer;</span>
<span class="udiff-line-added">+ import java.nio.file.Files;</span>
<span class="udiff-line-added">+ import java.util.ArrayList;</span>
<span class="udiff-line-added">+ import java.util.Arrays;</span>
<span class="udiff-line-added">+ import java.util.HashMap;</span>
<span class="udiff-line-added">+ import java.util.List;</span>
<span class="udiff-line-added">+ import java.util.Map;</span>
  import java.util.Random;
  import java.util.Scanner;
<span class="udiff-line-modified-removed">- import java.io.*;</span>
<span class="udiff-line-removed">- import java.nio.file.*;</span>
<span class="udiff-line-removed">- import java.util.*;</span>
<span class="udiff-line-removed">- import java.nio.CharBuffer;</span>
<span class="udiff-line-modified-added">+ import java.util.function.Function;</span>
  import java.util.function.Predicate;
<span class="udiff-line-added">+ import java.util.regex.Matcher;</span>
<span class="udiff-line-added">+ import java.util.regex.MatchResult;</span>
<span class="udiff-line-added">+ import java.util.regex.Pattern;</span>
<span class="udiff-line-added">+ import java.util.regex.PatternSyntaxException;</span>
  import jdk.test.lib.RandomFactory;
  
  /**
   * This is a test class created to check the operation of
   * the Pattern and Matcher classes.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -168,10 +184,13 @@</span>
          invalidFlags();
          embeddedFlags();
          grapheme();
          expoBacktracking();
          invalidGroupName();
<span class="udiff-line-added">+         illegalRepetitionRange();</span>
<span class="udiff-line-added">+         surrogatePairWithCanonEq();</span>
<span class="udiff-line-added">+         lineBreakWithQuantifier();</span>
  
          if (failure) {
              throw new
                  RuntimeException(&quot;RegExTest failed, 1st failure: &quot; +
                                   firstFailure);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1052,10 +1071,26 @@</span>
             failCount++;
          matcher.region(3*2,6*2);
          matcher.useAnchoringBounds(false);
          if (matcher.find())
             failCount++;
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         // JDK-8230829</span>
<span class="udiff-line-added">+         pattern = Pattern.compile(&quot;\\ud800\\udc61&quot;);</span>
<span class="udiff-line-added">+         matcher = pattern.matcher(&quot;\ud800\udc61&quot;);</span>
<span class="udiff-line-added">+         matcher.region(0, 1);</span>
<span class="udiff-line-added">+         if (matcher.find()) {</span>
<span class="udiff-line-added">+             failCount++;</span>
<span class="udiff-line-added">+             System.out.println(&quot;Matched a surrogate pair&quot; +</span>
<span class="udiff-line-added">+                     &quot; that crosses border of region&quot;);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         if (!matcher.hitEnd()) {</span>
<span class="udiff-line-added">+             failCount++;</span>
<span class="udiff-line-added">+             System.out.println(&quot;Expected to hit the end when&quot; +</span>
<span class="udiff-line-added">+                     &quot; matching a surrogate pair crossing region&quot;);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
          report(&quot;Regions&quot;);
      }
  
      private static void expectRegionFail(Matcher matcher, int index1,
                                           int index2)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -4753,12 +4788,11 @@</span>
          }
          report(&quot;Embedded flags&quot;);
      }
  
      private static void grapheme() throws Exception {
<span class="udiff-line-modified-removed">-         Files.lines(Paths.get(System.getProperty(&quot;test.src&quot;, &quot;.&quot;),</span>
<span class="udiff-line-removed">-                               &quot;GraphemeBreakTest.txt&quot;))</span>
<span class="udiff-line-modified-added">+         Files.lines(UCDFiles.GRAPHEME_BREAK_TEST)</span>
              .filter( ln -&gt; ln.length() != 0 &amp;&amp; !ln.startsWith(&quot;#&quot;) )
              .forEach( ln -&gt; {
                      ln = ln.replaceAll(&quot;\\s+|\\([a-zA-Z]+\\)|\\[[a-zA-Z]]+\\]|#.*&quot;, &quot;&quot;);
                      // System.out.println(str);
                      String[] strs = ln.split(&quot;\u00f7|\u00d7&quot;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -4930,6 +4964,120 @@</span>
                  }
              }
          }
          report(&quot;Invalid capturing group names&quot;);
      }
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private static void illegalRepetitionRange() {</span>
<span class="udiff-line-added">+         // huge integers &gt; (2^31 - 1)</span>
<span class="udiff-line-added">+         String n = BigInteger.valueOf(1L &lt;&lt; 32)</span>
<span class="udiff-line-added">+             .toString();</span>
<span class="udiff-line-added">+         String m = BigInteger.valueOf(1L &lt;&lt; 31)</span>
<span class="udiff-line-added">+             .add(new BigInteger(80, generator))</span>
<span class="udiff-line-added">+             .toString();</span>
<span class="udiff-line-added">+         for (String rep : List.of(&quot;&quot;, &quot;x&quot;, &quot;.&quot;, &quot;,&quot;, &quot;-1&quot;, &quot;2,1&quot;,</span>
<span class="udiff-line-added">+                 n, n + &quot;,&quot;, &quot;0,&quot; + n, n + &quot;,&quot; + m, m, m + &quot;,&quot;, &quot;0,&quot; + m)) {</span>
<span class="udiff-line-added">+             String pat = &quot;.{&quot; + rep + &quot;}&quot;;</span>
<span class="udiff-line-added">+             try {</span>
<span class="udiff-line-added">+                 Pattern.compile(pat);</span>
<span class="udiff-line-added">+                 failCount++;</span>
<span class="udiff-line-added">+                 System.out.println(&quot;Expected to fail. Pattern: &quot; + pat);</span>
<span class="udiff-line-added">+             } catch (PatternSyntaxException e) {</span>
<span class="udiff-line-added">+                 if (!e.getMessage().startsWith(&quot;Illegal repetition&quot;)) {</span>
<span class="udiff-line-added">+                     failCount++;</span>
<span class="udiff-line-added">+                     System.out.println(&quot;Unexpected error message: &quot; + e.getMessage());</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             } catch (Throwable t) {</span>
<span class="udiff-line-added">+                 failCount++;</span>
<span class="udiff-line-added">+                 System.out.println(&quot;Unexpected exception: &quot; + t);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         report(&quot;illegalRepetitionRange&quot;);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private static void surrogatePairWithCanonEq() {</span>
<span class="udiff-line-added">+         try {</span>
<span class="udiff-line-added">+             Pattern.compile(&quot;\ud834\udd21&quot;, Pattern.CANON_EQ);</span>
<span class="udiff-line-added">+         } catch (Throwable t) {</span>
<span class="udiff-line-added">+             failCount++;</span>
<span class="udiff-line-added">+             System.out.println(&quot;Unexpected exception: &quot; + t);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         report(&quot;surrogatePairWithCanonEq&quot;);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     // This test is for 8235812</span>
<span class="udiff-line-added">+     private static void lineBreakWithQuantifier() {</span>
<span class="udiff-line-added">+         // key:    pattern</span>
<span class="udiff-line-added">+         // value:  lengths of input that must match the pattern</span>
<span class="udiff-line-added">+         Map&lt;String, List&lt;Integer&gt;&gt; cases = Map.ofEntries(</span>
<span class="udiff-line-added">+             Map.entry(&quot;\\R?&quot;,      List.of(0, 1)),</span>
<span class="udiff-line-added">+             Map.entry(&quot;\\R*&quot;,      List.of(0, 1, 2, 3)),</span>
<span class="udiff-line-added">+             Map.entry(&quot;\\R+&quot;,      List.of(1, 2, 3)),</span>
<span class="udiff-line-added">+             Map.entry(&quot;\\R{0}&quot;,    List.of(0)),</span>
<span class="udiff-line-added">+             Map.entry(&quot;\\R{1}&quot;,    List.of(1)),</span>
<span class="udiff-line-added">+             Map.entry(&quot;\\R{2}&quot;,    List.of(2)),</span>
<span class="udiff-line-added">+             Map.entry(&quot;\\R{3}&quot;,    List.of(3)),</span>
<span class="udiff-line-added">+             Map.entry(&quot;\\R{0,}&quot;,   List.of(0, 1, 2, 3)),</span>
<span class="udiff-line-added">+             Map.entry(&quot;\\R{1,}&quot;,   List.of(1, 2, 3)),</span>
<span class="udiff-line-added">+             Map.entry(&quot;\\R{2,}&quot;,   List.of(2, 3)),</span>
<span class="udiff-line-added">+             Map.entry(&quot;\\R{3,}&quot;,   List.of(3)),</span>
<span class="udiff-line-added">+             Map.entry(&quot;\\R{0,0}&quot;,  List.of(0)),</span>
<span class="udiff-line-added">+             Map.entry(&quot;\\R{0,1}&quot;,  List.of(0, 1)),</span>
<span class="udiff-line-added">+             Map.entry(&quot;\\R{0,2}&quot;,  List.of(0, 1, 2)),</span>
<span class="udiff-line-added">+             Map.entry(&quot;\\R{0,3}&quot;,  List.of(0, 1, 2, 3)),</span>
<span class="udiff-line-added">+             Map.entry(&quot;\\R{1,1}&quot;,  List.of(1)),</span>
<span class="udiff-line-added">+             Map.entry(&quot;\\R{1,2}&quot;,  List.of(1, 2)),</span>
<span class="udiff-line-added">+             Map.entry(&quot;\\R{1,3}&quot;,  List.of(1, 2, 3)),</span>
<span class="udiff-line-added">+             Map.entry(&quot;\\R{2,2}&quot;,  List.of(2)),</span>
<span class="udiff-line-added">+             Map.entry(&quot;\\R{2,3}&quot;,  List.of(2, 3)),</span>
<span class="udiff-line-added">+             Map.entry(&quot;\\R{3,3}&quot;,  List.of(3)),</span>
<span class="udiff-line-added">+             Map.entry(&quot;\\R&quot;,       List.of(1)),</span>
<span class="udiff-line-added">+             Map.entry(&quot;\\R\\R&quot;,    List.of(2)),</span>
<span class="udiff-line-added">+             Map.entry(&quot;\\R\\R\\R&quot;, List.of(3))</span>
<span class="udiff-line-added">+         );</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         // key:    length of input</span>
<span class="udiff-line-added">+         // value:  all possible inputs of given length</span>
<span class="udiff-line-added">+         Map&lt;Integer, List&lt;String&gt;&gt; inputs = new HashMap&lt;&gt;();</span>
<span class="udiff-line-added">+         String[] Rs = { &quot;\r\n&quot;, &quot;\r&quot;, &quot;\n&quot;,</span>
<span class="udiff-line-added">+                         &quot;\u000B&quot;, &quot;\u000C&quot;, &quot;\u0085&quot;, &quot;\u2028&quot;, &quot;\u2029&quot; };</span>
<span class="udiff-line-added">+         StringBuilder sb = new StringBuilder();</span>
<span class="udiff-line-added">+         for (int len = 0; len &lt;= 3; ++len) {</span>
<span class="udiff-line-added">+             int[] idx = new int[len + 1];</span>
<span class="udiff-line-added">+             do {</span>
<span class="udiff-line-added">+                 sb.setLength(0);</span>
<span class="udiff-line-added">+                 for (int j = 0; j &lt; len; ++j)</span>
<span class="udiff-line-added">+                     sb.append(Rs[idx[j]]);</span>
<span class="udiff-line-added">+                 inputs.computeIfAbsent(len, ArrayList::new).add(sb.toString());</span>
<span class="udiff-line-added">+                 idx[0]++;</span>
<span class="udiff-line-added">+                 for (int j = 0; j &lt; len; ++j) {</span>
<span class="udiff-line-added">+                     if (idx[j] &lt; Rs.length)</span>
<span class="udiff-line-added">+                         break;</span>
<span class="udiff-line-added">+                     idx[j] = 0;</span>
<span class="udiff-line-added">+                     idx[j+1]++;</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             } while (idx[len] == 0);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         // exhaustive testing</span>
<span class="udiff-line-added">+         for (String patStr : cases.keySet()) {</span>
<span class="udiff-line-added">+             Pattern[] pats = patStr.endsWith(&quot;R&quot;)</span>
<span class="udiff-line-added">+                 ? new Pattern[] { Pattern.compile(patStr) }  // no quantifiers</span>
<span class="udiff-line-added">+                 : new Pattern[] { Pattern.compile(patStr),          // greedy</span>
<span class="udiff-line-added">+                                   Pattern.compile(patStr + &quot;?&quot;) };  // reluctant</span>
<span class="udiff-line-added">+             Matcher m = pats[0].matcher(&quot;&quot;);</span>
<span class="udiff-line-added">+             for (Pattern p : pats) {</span>
<span class="udiff-line-added">+                 m.usePattern(p);</span>
<span class="udiff-line-added">+                 for (int len : cases.get(patStr)) {</span>
<span class="udiff-line-added">+                     for (String in : inputs.get(len)) {</span>
<span class="udiff-line-added">+                         if (!m.reset(in).matches()) {</span>
<span class="udiff-line-added">+                             failCount++;</span>
<span class="udiff-line-added">+                             System.err.println(&quot;Expected to match &#39;&quot; +</span>
<span class="udiff-line-added">+                                     in + &quot;&#39; =~ /&quot; + p + &quot;/&quot;);</span>
<span class="udiff-line-added">+                         }</span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         report(&quot;lineBreakWithQuantifier&quot;);</span>
<span class="udiff-line-added">+     }</span>
  }
</pre>
<center><a href="GraphemeTest.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="TestCases.txt.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>