<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/jdk/java/util/regex/GraphemeTest.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
    <script type="text/javascript" src="../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2016, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
<a name="2" id="anc2"></a><span class="line-modified"> 26  * @bug 7071819 8221431</span>
 27  * @summary tests Unicode Extended Grapheme support
<a name="3" id="anc3"></a><span class="line-added"> 28  * @library /lib/testlibrary/java/lang</span>
 29  * @run main GraphemeTest
 30  */
 31 
 32 import java.io.IOException;
 33 import java.nio.file.Files;
 34 import java.nio.file.Path;
 35 import java.nio.file.Paths;
 36 import java.util.Arrays;
 37 import java.util.ArrayList;
 38 import java.util.Scanner;
 39 import java.util.regex.Pattern;
 40 import java.util.regex.Matcher;
 41 
 42 public class GraphemeTest {
 43 
 44     public static void main(String[] args) throws Throwable {
<a name="4" id="anc4"></a><span class="line-modified"> 45         testProps(UCDFiles.GRAPHEME_BREAK_PROPERTY);</span>
<span class="line-modified"> 46         testProps(UCDFiles.EMOJI_DATA);</span>


 47     }
 48 
 49     private static void testProps(Path path) throws IOException {
 50         Files.lines(path)
<a name="5" id="anc5"></a><span class="line-modified"> 51             .map( ln -&gt; ln.replaceFirst(&quot;#.*&quot;, &quot;&quot;) )</span>
<span class="line-added"> 52             .filter( ln -&gt; ln.length() != 0 )</span>
 53             .forEach(ln -&gt; {
 54                     String[] strs = ln.split(&quot;\\s+&quot;);
 55                     int off = strs[0].indexOf(&quot;..&quot;);
 56                     int cp0, cp1;
 57                     String expected = strs[2];
 58                     if (off != -1) {
 59                         cp0 = Integer.parseInt(strs[0], 0, off, 16);
 60                         cp1 = Integer.parseInt(strs[0], off + 2, strs[0].length(), 16);
 61                     } else {
 62                         cp0 = cp1 = Integer.parseInt(strs[0], 16);
 63                     }
 64                     for (int cp = cp0; cp &lt;=  cp1; cp++) {
<a name="6" id="anc6"></a><span class="line-added"> 65                         // Ignore Emoji* for now (only interested in Extended_Pictographic)</span>
<span class="line-added"> 66                         if (expected.startsWith(&quot;Emoji&quot;)) {</span>
<span class="line-added"> 67                             continue;</span>
<span class="line-added"> 68                         }</span>
<span class="line-added"> 69 </span>
 70                         // NOTE:
 71                         // #tr29 &quot;plus a few General_Category = Spacing_Mark needed for
 72                         // canonical equivalence.&quot;
 73                         // For &quot;extended grapheme clusters&quot; support, there is no
 74                         // need actually to diff &quot;extend&quot; and &quot;spackmark&quot; given GB9, GB9a.
 75                         if (!expected.equals(types[getType(cp)])) {
 76                             if (&quot;Extend&quot;.equals(expected) &amp;&amp;
 77                                 &quot;SpacingMark&quot;.equals(types[getType(cp)]))
 78                                 System.out.printf(&quot;[%x]  [%s][%d] -&gt; [%s]%n&quot;,
 79                                     cp, expected, Character.getType(cp), types[getType(cp)]);
 80                             else
 81                                 throw new RuntimeException(String.format(
 82                                     &quot;cp=[%x], expeced:[%s] result:[%s]%n&quot;,
 83                                     cp, expected, types[getType(cp)]));
 84                         }
 85                     }
 86                 });
 87     }
 88 
<a name="7" id="anc7"></a>
































 89     private static final String[] types = {
<a name="8" id="anc8"></a><span class="line-modified"> 90         &quot;Other&quot;, &quot;CR&quot;, &quot;LF&quot;, &quot;Control&quot;, &quot;Extend&quot;, &quot;ZWJ&quot;, &quot;Regional_Indicator&quot;,</span>
 91         &quot;Prepend&quot;, &quot;SpacingMark&quot;,
<a name="9" id="anc9"></a><span class="line-modified"> 92         &quot;L&quot;, &quot;V&quot;, &quot;T&quot;, &quot;LV&quot;, &quot;LVT&quot;,</span>
<span class="line-added"> 93         &quot;Extended_Pictographic&quot; };</span>
 94 
 95     ///////////////////////////////////////////////////////////////////////////////////////////////////////////////
 96 
<a name="10" id="anc10"></a><span class="line-added"> 97     // from java.util.regex.Grapheme.java</span>
 98     // types
 99     private static final int OTHER = 0;
100     private static final int CR = 1;
101     private static final int LF = 2;
102     private static final int CONTROL = 3;
103     private static final int EXTEND = 4;
<a name="11" id="anc11"></a><span class="line-modified">104     private static final int ZWJ = 5;</span>
<span class="line-modified">105     private static final int RI = 6;</span>
<span class="line-modified">106     private static final int PREPEND = 7;</span>
<span class="line-modified">107     private static final int SPACINGMARK = 8;</span>
<span class="line-modified">108     private static final int L = 9;</span>
<span class="line-modified">109     private static final int V = 10;</span>
<span class="line-modified">110     private static final int T = 11;</span>
<span class="line-modified">111     private static final int LV = 12;</span>
<span class="line-added">112     private static final int LVT = 13;</span>
<span class="line-added">113     private static final int EXTENDED_PICTOGRAPHIC = 14;</span>
114 
115     private static final int FIRST_TYPE = 0;
<a name="12" id="anc12"></a><span class="line-modified">116     private static final int LAST_TYPE = 14;</span>
117 
118     private static boolean[][] rules;
119     static {
120         rules = new boolean[LAST_TYPE + 1][LAST_TYPE + 1];
<a name="13" id="anc13"></a><span class="line-modified">121         // GB 999 Any + Any  -&gt; default</span>
122         for (int i = FIRST_TYPE; i &lt;= LAST_TYPE; i++)
123             for (int j = FIRST_TYPE; j &lt;= LAST_TYPE; j++)
124                 rules[i][j] = true;
125         // GB 6 L x (L | V | LV | VT)
126         rules[L][L] = false;
127         rules[L][V] = false;
128         rules[L][LV] = false;
129         rules[L][LVT] = false;
130         // GB 7 (LV | V) x (V | T)
131         rules[LV][V] = false;
132         rules[LV][T] = false;
133         rules[V][V] = false;
134         rules[V][T] = false;
135         // GB 8 (LVT | T) x T
136         rules[LVT][T] = false;
137         rules[T][T] = false;
<a name="14" id="anc14"></a><span class="line-modified">138         // GB 9 x (Extend|ZWJ)</span>


139         // GB 9a x Spacing Mark
140         // GB 9b Prepend x
141         for (int i = FIRST_TYPE; i &lt;= LAST_TYPE; i++) {
142             rules[i][EXTEND] = false;
<a name="15" id="anc15"></a><span class="line-added">143             rules[i][ZWJ] = false;</span>
144             rules[i][SPACINGMARK] = false;
145             rules[PREPEND][i] = false;
146         }
147         // GB 4  (Control | CR | LF) +
148         // GB 5  + (Control | CR | LF)
149         for (int i = FIRST_TYPE; i &lt;= LAST_TYPE; i++)
150             for (int j = CR; j &lt;= CONTROL; j++) {
151                 rules[i][j] = true;
152                 rules[j][i] = true;
153             }
154         // GB 3 CR x LF
155         rules[CR][LF] = false;
<a name="16" id="anc16"></a><span class="line-modified">156         // GB 11 Exended_Pictographic x (Extend|ZWJ)</span>
<span class="line-added">157         rules[EXTENDED_PICTOGRAPHIC][EXTEND] = false;</span>
<span class="line-added">158         rules[EXTENDED_PICTOGRAPHIC][ZWJ] = false;</span>
159     }
160 
161     // Hangul syllables
162     private static final int SYLLABLE_BASE = 0xAC00;
163     private static final int LCOUNT = 19;
164     private static final int VCOUNT = 21;
165     private static final int TCOUNT = 28;
166     private static final int NCOUNT = VCOUNT * TCOUNT; // 588
167     private static final int SCOUNT = LCOUNT * NCOUNT; // 11172
168 
169     // #tr29: SpacingMark exceptions: The following (which have
170     // General_Category = Spacing_Mark and would otherwise be included)
171     // are specifically excluded
172     private static boolean isExcludedSpacingMark(int cp) {
173        return  cp == 0x102B || cp == 0x102C || cp == 0x1038 ||
174                cp &gt;= 0x1062 &amp;&amp; cp &lt;= 0x1064 ||
175                cp &gt;= 0x1062 &amp;&amp; cp &lt;= 0x106D ||
176                cp == 0x1083 ||
177                cp &gt;= 0x1087 &amp;&amp; cp &lt;= 0x108C ||
178                cp == 0x108F ||
179                cp &gt;= 0x109A &amp;&amp; cp &lt;= 0x109C ||
180                cp == 0x1A61 || cp == 0x1A63 || cp == 0x1A64 ||
181                cp == 0xAA7B || cp == 0xAA7D;
182     }
183 
<a name="17" id="anc17"></a><span class="line-added">184     @SuppressWarnings(&quot;fallthrough&quot;)</span>
185     private static int getType(int cp) {
<a name="18" id="anc18"></a><span class="line-added">186         if (isExtendedPictographic(cp)) {</span>
<span class="line-added">187             return EXTENDED_PICTOGRAPHIC;</span>
<span class="line-added">188         }</span>
<span class="line-added">189 </span>
190         int type = Character.getType(cp);
191         switch(type) {
192         case Character.CONTROL:
193             if (cp == 0x000D)
194                 return CR;
195             if (cp == 0x000A)
196                 return LF;
197             return CONTROL;
<a name="19" id="anc19"></a><span class="line-modified">198         case Character.UNASSIGNED:</span>
199             // NOTE: #tr29 lists &quot;Unassigned and Default_Ignorable_Code_Point&quot; as Control
200             // but GraphemeBreakTest.txt lists u+0378/reserved-0378 as &quot;Other&quot;
201             // so type it as &quot;Other&quot; to make the test happy
<a name="20" id="anc20"></a><span class="line-modified">202             if (cp == 0x0378)</span>
<span class="line-modified">203                 return OTHER;</span>
<span class="line-added">204 </span>
205         case Character.LINE_SEPARATOR:
206         case Character.PARAGRAPH_SEPARATOR:
207         case Character.SURROGATE:
208             return CONTROL;
209         case Character.FORMAT:
<a name="21" id="anc21"></a><span class="line-modified">210             if (cp == 0x200C ||</span>
<span class="line-added">211                 cp &gt;= 0xE0020 &amp;&amp; cp &lt;= 0xE007F)</span>
212                 return EXTEND;
<a name="22" id="anc22"></a><span class="line-added">213             if (cp == 0x200D)</span>
<span class="line-added">214                 return ZWJ;</span>
<span class="line-added">215             if (cp &gt;= 0x0600 &amp;&amp; cp &lt;= 0x0605 ||</span>
<span class="line-added">216                 cp == 0x06DD || cp == 0x070F || cp == 0x08E2 ||</span>
<span class="line-added">217                 cp == 0x110BD || cp == 0x110CD)</span>
<span class="line-added">218                 return PREPEND;</span>
219             return CONTROL;
220         case Character.NON_SPACING_MARK:
221         case Character.ENCLOSING_MARK:
<a name="23" id="anc23"></a><span class="line-modified">222             // NOTE:</span>
<span class="line-modified">223             // #tr29 &quot;plus a few General_Category = Spacing_Mark needed for</span>
<span class="line-modified">224             // canonical equivalence.&quot;</span>
<span class="line-modified">225             // but for &quot;extended grapheme clusters&quot; support, there is no</span>
<span class="line-modified">226             // need actually to diff &quot;extend&quot; and &quot;spackmark&quot; given GB9, GB9a</span>
<span class="line-modified">227             return EXTEND;</span>
228         case  Character.COMBINING_SPACING_MARK:
229             if (isExcludedSpacingMark(cp))
230                 return OTHER;
231             // NOTE:
232             // 0x11720 and 0x11721 are mentioned in #tr29 as
233             // OTHER_LETTER but it appears their category has been updated to
234             // COMBING_SPACING_MARK already (verified in ver.8)
235             return SPACINGMARK;
236         case Character.OTHER_SYMBOL:
237             if (cp &gt;= 0x1F1E6 &amp;&amp; cp &lt;= 0x1F1FF)
238                 return RI;
239             return OTHER;
240         case Character.MODIFIER_LETTER:
<a name="24" id="anc24"></a><span class="line-added">241         case Character.MODIFIER_SYMBOL:</span>
242             // WARNING:
243             // not mentioned in #tr29 but listed in GraphemeBreakProperty.txt
<a name="25" id="anc25"></a><span class="line-modified">244             if (cp == 0xFF9E || cp == 0xFF9F ||</span>
<span class="line-added">245                 cp &gt;= 0x1F3FB &amp;&amp; cp &lt;= 0x1F3FF)</span>
246                 return EXTEND;
247             return OTHER;
248         case Character.OTHER_LETTER:
249             if (cp == 0x0E33 || cp == 0x0EB3)
250                 return SPACINGMARK;
251             // hangul jamo
252             if (cp &gt;= 0x1100 &amp;&amp; cp &lt;= 0x11FF) {
253                 if (cp &lt;= 0x115F)
254                     return L;
255                 if (cp &lt;= 0x11A7)
256                     return V;
257                 return T;
258             }
259             // hangul syllables
260             int sindex = cp - SYLLABLE_BASE;
261             if (sindex &gt;= 0 &amp;&amp; sindex &lt; SCOUNT) {
262 
263                 if (sindex % TCOUNT == 0)
264                     return LV;
265                 return LVT;
266             }
267             //  hangul jamo_extended A
268             if (cp &gt;= 0xA960 &amp;&amp; cp &lt;= 0xA97C)
269                 return L;
270             //  hangul jamo_extended B
271             if (cp &gt;= 0xD7B0 &amp;&amp; cp &lt;= 0xD7C6)
272                 return V;
273             if (cp &gt;= 0xD7CB &amp;&amp; cp &lt;= 0xD7FB)
274                 return T;
<a name="26" id="anc26"></a><span class="line-added">275 </span>
<span class="line-added">276             // Prepend</span>
<span class="line-added">277             switch (cp) {</span>
<span class="line-added">278                 case 0x0D4E:</span>
<span class="line-added">279                 case 0x111C2:</span>
<span class="line-added">280                 case 0x111C3:</span>
<span class="line-added">281                 case 0x11A3A:</span>
<span class="line-added">282                 case 0x11A84:</span>
<span class="line-added">283                 case 0x11A85:</span>
<span class="line-added">284                 case 0x11A86:</span>
<span class="line-added">285                 case 0x11A87:</span>
<span class="line-added">286                 case 0x11A88:</span>
<span class="line-added">287                 case 0x11A89:</span>
<span class="line-added">288                 case 0x11D46:</span>
<span class="line-added">289                     return PREPEND;</span>
<span class="line-added">290             }</span>
291         }
292         return OTHER;
293     }
<a name="27" id="anc27"></a><span class="line-added">294 </span>
<span class="line-added">295     // from generated java.util.regex.EmojiData.java</span>
<span class="line-added">296     static boolean isExtendedPictographic(int cp) {</span>
<span class="line-added">297         return</span>
<span class="line-added">298             cp == 0x00A9 ||</span>
<span class="line-added">299             cp == 0x00AE ||</span>
<span class="line-added">300             cp == 0x203C ||</span>
<span class="line-added">301             cp == 0x2049 ||</span>
<span class="line-added">302             cp == 0x2122 ||</span>
<span class="line-added">303             cp == 0x2139 ||</span>
<span class="line-added">304            (cp &gt;= 0x2194 &amp;&amp; cp &lt;= 0x2199) ||</span>
<span class="line-added">305             cp == 0x21A9 ||</span>
<span class="line-added">306             cp == 0x21AA ||</span>
<span class="line-added">307             cp == 0x231A ||</span>
<span class="line-added">308             cp == 0x231B ||</span>
<span class="line-added">309             cp == 0x2328 ||</span>
<span class="line-added">310             cp == 0x2388 ||</span>
<span class="line-added">311             cp == 0x23CF ||</span>
<span class="line-added">312            (cp &gt;= 0x23E9 &amp;&amp; cp &lt;= 0x23F3) ||</span>
<span class="line-added">313            (cp &gt;= 0x23F8 &amp;&amp; cp &lt;= 0x23FA) ||</span>
<span class="line-added">314             cp == 0x24C2 ||</span>
<span class="line-added">315             cp == 0x25AA ||</span>
<span class="line-added">316             cp == 0x25AB ||</span>
<span class="line-added">317             cp == 0x25B6 ||</span>
<span class="line-added">318             cp == 0x25C0 ||</span>
<span class="line-added">319            (cp &gt;= 0x25FB &amp;&amp; cp &lt;= 0x25FE) ||</span>
<span class="line-added">320            (cp &gt;= 0x2600 &amp;&amp; cp &lt;= 0x2605) ||</span>
<span class="line-added">321            (cp &gt;= 0x2607 &amp;&amp; cp &lt;= 0x2612) ||</span>
<span class="line-added">322            (cp &gt;= 0x2614 &amp;&amp; cp &lt;= 0x2685) ||</span>
<span class="line-added">323            (cp &gt;= 0x2690 &amp;&amp; cp &lt;= 0x2705) ||</span>
<span class="line-added">324            (cp &gt;= 0x2708 &amp;&amp; cp &lt;= 0x2712) ||</span>
<span class="line-added">325             cp == 0x2714 ||</span>
<span class="line-added">326             cp == 0x2716 ||</span>
<span class="line-added">327             cp == 0x271D ||</span>
<span class="line-added">328             cp == 0x2721 ||</span>
<span class="line-added">329             cp == 0x2728 ||</span>
<span class="line-added">330             cp == 0x2733 ||</span>
<span class="line-added">331             cp == 0x2734 ||</span>
<span class="line-added">332             cp == 0x2744 ||</span>
<span class="line-added">333             cp == 0x2747 ||</span>
<span class="line-added">334             cp == 0x274C ||</span>
<span class="line-added">335             cp == 0x274E ||</span>
<span class="line-added">336            (cp &gt;= 0x2753 &amp;&amp; cp &lt;= 0x2755) ||</span>
<span class="line-added">337             cp == 0x2757 ||</span>
<span class="line-added">338            (cp &gt;= 0x2763 &amp;&amp; cp &lt;= 0x2767) ||</span>
<span class="line-added">339            (cp &gt;= 0x2795 &amp;&amp; cp &lt;= 0x2797) ||</span>
<span class="line-added">340             cp == 0x27A1 ||</span>
<span class="line-added">341             cp == 0x27B0 ||</span>
<span class="line-added">342             cp == 0x27BF ||</span>
<span class="line-added">343             cp == 0x2934 ||</span>
<span class="line-added">344             cp == 0x2935 ||</span>
<span class="line-added">345            (cp &gt;= 0x2B05 &amp;&amp; cp &lt;= 0x2B07) ||</span>
<span class="line-added">346             cp == 0x2B1B ||</span>
<span class="line-added">347             cp == 0x2B1C ||</span>
<span class="line-added">348             cp == 0x2B50 ||</span>
<span class="line-added">349             cp == 0x2B55 ||</span>
<span class="line-added">350             cp == 0x3030 ||</span>
<span class="line-added">351             cp == 0x303D ||</span>
<span class="line-added">352             cp == 0x3297 ||</span>
<span class="line-added">353             cp == 0x3299 ||</span>
<span class="line-added">354            (cp &gt;= 0x1F000 &amp;&amp; cp &lt;= 0x1F0FF) ||</span>
<span class="line-added">355            (cp &gt;= 0x1F10D &amp;&amp; cp &lt;= 0x1F10F) ||</span>
<span class="line-added">356             cp == 0x1F12F ||</span>
<span class="line-added">357            (cp &gt;= 0x1F16C &amp;&amp; cp &lt;= 0x1F171) ||</span>
<span class="line-added">358             cp == 0x1F17E ||</span>
<span class="line-added">359             cp == 0x1F17F ||</span>
<span class="line-added">360             cp == 0x1F18E ||</span>
<span class="line-added">361            (cp &gt;= 0x1F191 &amp;&amp; cp &lt;= 0x1F19A) ||</span>
<span class="line-added">362            (cp &gt;= 0x1F1AD &amp;&amp; cp &lt;= 0x1F1E5) ||</span>
<span class="line-added">363            (cp &gt;= 0x1F201 &amp;&amp; cp &lt;= 0x1F20F) ||</span>
<span class="line-added">364             cp == 0x1F21A ||</span>
<span class="line-added">365             cp == 0x1F22F ||</span>
<span class="line-added">366            (cp &gt;= 0x1F232 &amp;&amp; cp &lt;= 0x1F23A) ||</span>
<span class="line-added">367            (cp &gt;= 0x1F23C &amp;&amp; cp &lt;= 0x1F23F) ||</span>
<span class="line-added">368            (cp &gt;= 0x1F249 &amp;&amp; cp &lt;= 0x1F3FA) ||</span>
<span class="line-added">369            (cp &gt;= 0x1F400 &amp;&amp; cp &lt;= 0x1F53D) ||</span>
<span class="line-added">370            (cp &gt;= 0x1F546 &amp;&amp; cp &lt;= 0x1F64F) ||</span>
<span class="line-added">371            (cp &gt;= 0x1F680 &amp;&amp; cp &lt;= 0x1F6FF) ||</span>
<span class="line-added">372            (cp &gt;= 0x1F774 &amp;&amp; cp &lt;= 0x1F77F) ||</span>
<span class="line-added">373            (cp &gt;= 0x1F7D5 &amp;&amp; cp &lt;= 0x1F7FF) ||</span>
<span class="line-added">374            (cp &gt;= 0x1F80C &amp;&amp; cp &lt;= 0x1F80F) ||</span>
<span class="line-added">375            (cp &gt;= 0x1F848 &amp;&amp; cp &lt;= 0x1F84F) ||</span>
<span class="line-added">376            (cp &gt;= 0x1F85A &amp;&amp; cp &lt;= 0x1F85F) ||</span>
<span class="line-added">377            (cp &gt;= 0x1F888 &amp;&amp; cp &lt;= 0x1F88F) ||</span>
<span class="line-added">378            (cp &gt;= 0x1F8AE &amp;&amp; cp &lt;= 0x1F8FF) ||</span>
<span class="line-added">379            (cp &gt;= 0x1F90C &amp;&amp; cp &lt;= 0x1F93A) ||</span>
<span class="line-added">380            (cp &gt;= 0x1F93C &amp;&amp; cp &lt;= 0x1F945) ||</span>
<span class="line-added">381            (cp &gt;= 0x1F947 &amp;&amp; cp &lt;= 0x1FFFD);</span>
<span class="line-added">382 </span>
<span class="line-added">383     }</span>
384 }
<a name="28" id="anc28"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="28" type="hidden" />
</body>
</html>