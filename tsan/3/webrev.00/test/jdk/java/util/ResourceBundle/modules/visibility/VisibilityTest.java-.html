<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old test/jdk/java/util/ResourceBundle/modules/visibility/VisibilityTest.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2015, 2018, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @bug 8137317 8139238 8210408
 27  * @summary Visibility tests for ResourceBundle.getBundle with and without
 28  *          an unnamed module argument.
 29  * @library /test/lib
 30  *          ..
 31  * @build jdk.test.lib.JDKToolLauncher
 32  *        jdk.test.lib.Utils
 33  *        jdk.test.lib.compiler.CompilerUtils
 34  *        jdk.test.lib.process.ProcessTools
 35  *        ModuleTestUtil
 36  * @run testng VisibilityTest
 37  */
 38 
 39 import java.nio.file.Path;
 40 import java.nio.file.Paths;
 41 import java.util.List;
 42 
 43 import jdk.test.lib.JDKToolLauncher;
 44 import jdk.test.lib.Utils;
 45 import jdk.test.lib.process.ProcessTools;
 46 import org.testng.annotations.BeforeTest;
 47 import org.testng.annotations.DataProvider;
 48 import org.testng.annotations.Test;
 49 
 50 import static org.testng.Assert.assertEquals;
 51 
 52 @Test
 53 public class VisibilityTest {
 54     private static final Path SRC_DIR = Paths.get(Utils.TEST_SRC, &quot;src&quot;);
 55     private static final Path MODS_DIR = Paths.get(Utils.TEST_CLASSES, &quot;mods&quot;);
 56     private static final Path CLASSES_DIR = Paths.get(Utils.TEST_CLASSES, &quot;classes&quot;);
 57     private static final Path NAMED_BUNDLES_DIR = MODS_DIR.resolve(&quot;named.bundles&quot;);
 58     private static final Path EXPORTED_NAMED_BUNDLES_DIR = MODS_DIR.resolve(&quot;exported.named.bundles&quot;);
 59 
 60     private static final List&lt;String&gt; MODULE_LIST = List.of(&quot;embargo&quot;,
 61             &quot;exported.named.bundles&quot;, &quot;named.bundles&quot;, &quot;test&quot;);
 62 
 63     @BeforeTest
 64     public void prepareTestEnv() throws Throwable {
 65         MODULE_LIST.forEach(mn -&gt; ModuleTestUtil.prepareModule(SRC_DIR,
 66                 MODS_DIR, mn, &quot;.properties&quot;));
 67 
 68         // Prepare resource bundles in an unnamed module
 69         ModuleTestUtil.compilePkg(SRC_DIR, CLASSES_DIR, &quot;pkg&quot;);
 70         ModuleTestUtil.copyResFiles(SRC_DIR, CLASSES_DIR, &quot;pkg&quot;, &quot;.properties&quot;);
 71 
 72     }
 73 
 74     /**
 75      * Package jdk.test is in named module &quot;test&quot;.
 76      * Package jdk.embargo is in named module &quot;embargo&quot;.
 77      *
 78      * jdk.{test,embargo}.TestWithUnnamedModuleArg call:
 79      *     ResourceBundle.getBundle(basename, classloader.getUnnamedModule())
 80      *     where classloader is the TCCL or system class loader.
 81      * jdk.{test,embargo}.TestWithNoModuleArg call:
 82      *     ResourceBundle.getBundle(basename)
 83      *
 84      * jdk.test.resources[.exported].classes.* are class-based resource bundles.
 85      * jdk.test.resources[.exported].props.* are properties file-based resource bundles.
 86      *
 87      * Packages jdk.test.resources.{classes,props} in named module &quot;named.bundles&quot;
 88      * are exported only to named module &quot;test&quot;.
 89      * Packages jdk.test.resources.exported.{classes,props} in named module
 90      * &quot;exported.named.bundle&quot; are exported to unnamed modules.
 91      */
 92 
 93     @DataProvider(name = &quot;RunWithTestResData&quot;)
 94     Object[][] RunWithTestResData() {
 95         return new Object[][] {
 96                 // Tests using jdk.test.TestWithNoModuleArg and jdk.embargo.TestWithNoModuleArg.
 97                 // Neither of which specifies an unnamed module with ResourceBundle.getBundle().
 98 
 99                 // jdk.test.resources.{classes,props}.* are available only to
100                 // named module &quot;test&quot; by ResourceBundleProvider.
101                 {List.of(&quot;-p&quot;, MODS_DIR.toString(),
102                         &quot;-m&quot;, &quot;test/jdk.test.TestWithNoModuleArg&quot;,
103                         &quot;jdk.test.resources.classes.MyResources&quot;, &quot;true&quot;)},
104                 {List.of(&quot;-p&quot;, MODS_DIR.toString(),
105                         &quot;-m&quot;, &quot;test/jdk.test.TestWithNoModuleArg&quot;,
106                         &quot;jdk.test.resources.props.MyResources&quot;, &quot;true&quot;)},
107                 {List.of(&quot;-p&quot;, MODS_DIR.toString(),
108                         &quot;-m&quot;, &quot;embargo/jdk.embargo.TestWithNoModuleArg&quot;,
109                         &quot;jdk.test.resources.classes.MyResources&quot;, &quot;false&quot;)},
110                 {List.of(&quot;-p&quot;, MODS_DIR.toString(),
111                         &quot;-m&quot;, &quot;embargo/jdk.embargo.TestWithNoModuleArg&quot;,
112                         &quot;jdk.test.resources.props.MyResources&quot;, &quot;false&quot;)},
113 
114                 // Add mods/named.bundles to the class path.
115                 {List.of(&quot;-cp&quot;, NAMED_BUNDLES_DIR.toString(),
116                         &quot;-p&quot;, MODS_DIR.toString(),
117                         &quot;-m&quot;, &quot;test/jdk.test.TestWithNoModuleArg&quot;,
118                         &quot;jdk.test.resources.classes.MyResources&quot;, &quot;true&quot;)},
119                 {List.of(&quot;-cp&quot;, NAMED_BUNDLES_DIR.toString(),
120                         &quot;-p&quot;, MODS_DIR.toString(),
121                         &quot;-m&quot;, &quot;test/jdk.test.TestWithNoModuleArg&quot;,
122                         &quot;jdk.test.resources.props.MyResources&quot;, &quot;true&quot;)},
123                 {List.of(&quot;-cp&quot;, NAMED_BUNDLES_DIR.toString(),
124                         &quot;-p&quot;, MODS_DIR.toString(),
125                         &quot;-m&quot;, &quot;embargo/jdk.embargo.TestWithNoModuleArg&quot;,
126                         &quot;jdk.test.resources.classes.MyResources&quot;, &quot;true&quot;)},
127                 {List.of(&quot;-cp&quot;, NAMED_BUNDLES_DIR.toString(),
128                         &quot;-p&quot;, MODS_DIR.toString(),
129                         &quot;-m&quot;, &quot;embargo/jdk.embargo.TestWithNoModuleArg&quot;,
130                         &quot;jdk.test.resources.props.MyResources&quot;, &quot;true&quot;)},
131 
132                 // Tests using jdk.test.TestWithUnnamedModuleArg and
133                 // jdk.embargo.TestWithUnnamedModuleArg.
134                 // Both of which specify an unnamed module with ResourceBundle.getBundle.
135 
136                 // jdk.test.resources.classes is exported to named module &quot;test&quot;.
137                 // IllegalAccessException is thrown in ResourceBundle.Control.newBundle().
138                 {List.of(&quot;-p&quot;, MODS_DIR.toString(),
139                         &quot;-m&quot;, &quot;test/jdk.test.TestWithUnnamedModuleArg&quot;,
140                         &quot;jdk.test.resources.classes.MyResources&quot;, &quot;false&quot;)},
141 
142                 // jdk.test.resources.props is exported to named module &quot;test&quot;.
143                 // loader.getResource() doesn&#39;t find jdk.test.resources.props.MyResources.
144                 {List.of(&quot;-p&quot;, MODS_DIR.toString(),
145                         &quot;-m&quot;, &quot;test/jdk.test.TestWithUnnamedModuleArg&quot;,
146                         &quot;jdk.test.resources.props.MyResources&quot;, &quot;false&quot;)},
147 
148                 // IllegalAccessException is thrown in ResourceBundle.Control.newBundle().
149                 {List.of(&quot;-p&quot;, MODS_DIR.toString(),
150                         &quot;-m&quot;, &quot;embargo/jdk.embargo.TestWithUnnamedModuleArg&quot;,
151                         &quot;jdk.test.resources.classes.MyResources&quot;, &quot;false&quot;)},
152 
153                 // jdk.test.resources.props is exported to named module &quot;test&quot;.
154                 // loader.getResource() doesn&#39;t find jdk.test.resources.props.MyResources.
155                 {List.of(&quot;-p&quot;, MODS_DIR.toString(),
156                         &quot;-m&quot;, &quot;embargo/jdk.embargo.TestWithUnnamedModuleArg&quot;,
157                         &quot;jdk.test.resources.props.MyResources&quot;, &quot;false&quot;)},
158 
159                 // Add mods/named.bundles to the class path.
160 
161                 // IllegalAccessException is thrown in ResourceBundle.Control.newBundle().
162                 {List.of(&quot;-cp&quot;, NAMED_BUNDLES_DIR.toString(),
163                         &quot;-p&quot;, MODS_DIR.toString(),
164                         &quot;-m&quot;, &quot;test/jdk.test.TestWithUnnamedModuleArg&quot;,
165                         &quot;jdk.test.resources.classes.MyResources&quot;, &quot;false&quot;)},
166 
167                 // loader.getResource() finds jdk.test.resources.exported.props.MyResources.
168                 {List.of(&quot;-cp&quot;, NAMED_BUNDLES_DIR.toString(),
169                         &quot;-p&quot;, MODS_DIR.toString(),
170                         &quot;-m&quot;, &quot;test/jdk.test.TestWithUnnamedModuleArg&quot;,
171                         &quot;jdk.test.resources.props.MyResources&quot;, &quot;true&quot;)},
172 
173                 // jdk.test.resources.exported.classes.MyResources is treated
174                 // as if the class is in an unnamed module.
175                 {List.of(&quot;-cp&quot;, NAMED_BUNDLES_DIR.toString(),
176                         &quot;-p&quot;, MODS_DIR.toString(),
177                         &quot;-m&quot;, &quot;embargo/jdk.embargo.TestWithUnnamedModuleArg&quot;,
178                         &quot;jdk.test.resources.classes.MyResources&quot;, &quot;true&quot;)},
179 
180                 // loader.getResource() finds jdk.test.resources.exported.props.MyResources.
181                 {List.of(&quot;-cp&quot;, NAMED_BUNDLES_DIR.toString(),
182                         &quot;-p&quot;, MODS_DIR.toString(),
183                         &quot;-m&quot;, &quot;embargo/jdk.embargo.TestWithUnnamedModuleArg&quot;,
184                         &quot;jdk.test.resources.props.MyResources&quot;, &quot;true&quot;)},
185         };
186     }
187 
188     @DataProvider(name = &quot;RunWithExportedResData&quot;)
189     Object[][] RunWithExportedResData() {
190         return new Object[][] {
191                 // Tests using jdk.test.TestWithNoModuleArg and jdk.embargo.TestWithNoModuleArg
192                 // neither of which specifies an unnamed module with ResourceBundle.getBundle.
193 
194                 // None of jdk.test.resources.exported.** is available to the named modules.
195                 {List.of(&quot;-p&quot;, MODS_DIR.toString(),
196                         &quot;-m&quot;, &quot;test/jdk.test.TestWithNoModuleArg&quot;,
197                         &quot;jdk.test.resources.exported.classes.MyResources&quot;, &quot;false&quot;)},
198                 {List.of(&quot;-p&quot;, MODS_DIR.toString(),
199                         &quot;-m&quot;, &quot;test/jdk.test.TestWithNoModuleArg&quot;,
200                         &quot;jdk.test.resources.exported.props.MyResources&quot;, &quot;false&quot;)},
201                 {List.of(&quot;-p&quot;, MODS_DIR.toString(),
202                         &quot;-m&quot;, &quot;embargo/jdk.embargo.TestWithNoModuleArg&quot;,
203                         &quot;jdk.test.resources.exported.classes.MyResources&quot;, &quot;false&quot;)},
204                 {List.of(&quot;-p&quot;, MODS_DIR.toString(),
205                         &quot;-m&quot;, &quot;embargo/jdk.embargo.TestWithNoModuleArg&quot;,
206                         &quot;jdk.test.resources.exported.props.MyResources&quot;, &quot;false&quot;)},
207 
208                 // Add mods/exported.named.bundles to the class path.
209                 {List.of(&quot;-cp&quot;, EXPORTED_NAMED_BUNDLES_DIR.toString(),
210                         &quot;-p&quot;, MODS_DIR.toString(),
211                         &quot;-m&quot;, &quot;test/jdk.test.TestWithNoModuleArg&quot;,
212                         &quot;jdk.test.resources.exported.classes.MyResources&quot;, &quot;true&quot;)},
213                 {List.of(&quot;-cp&quot;, EXPORTED_NAMED_BUNDLES_DIR.toString(),
214                         &quot;-p&quot;, MODS_DIR.toString(),
215                         &quot;-m&quot;, &quot;test/jdk.test.TestWithNoModuleArg&quot;,
216                         &quot;jdk.test.resources.exported.props.MyResources&quot;, &quot;true&quot;)},
217                 {List.of(&quot;-cp&quot;, EXPORTED_NAMED_BUNDLES_DIR.toString(),
218                         &quot;-p&quot;, MODS_DIR.toString(),
219                         &quot;-m&quot;, &quot;embargo/jdk.embargo.TestWithNoModuleArg&quot;,
220                         &quot;jdk.test.resources.exported.classes.MyResources&quot;, &quot;true&quot;)},
221                 {List.of(&quot;-cp&quot;, EXPORTED_NAMED_BUNDLES_DIR.toString(),
222                         &quot;-p&quot;, MODS_DIR.toString(),
223                         &quot;-m&quot;, &quot;embargo/jdk.embargo.TestWithNoModuleArg&quot;,
224                         &quot;jdk.test.resources.exported.props.MyResources&quot;, &quot;true&quot;)},
225 
226                 // Tests using jdk.test.TestWithUnnamedModuleArg and
227                 // jdk.embargo.TestWithUnnamedModuleArg which specify
228                 // an unnamed module with ResourceBundle.getBundle.
229 
230                 // loader.loadClass() doesn&#39;t find jdk.test.resources.exported.classes.MyResources
231                 // and throws a ClassNotFoundException.
232                 {List.of(&quot;-p&quot;, MODS_DIR.toString(),
233                         &quot;-m&quot;, &quot;test/jdk.test.TestWithUnnamedModuleArg&quot;,
234                         &quot;jdk.test.resources.exported.classes.MyResources&quot;, &quot;false&quot;)},
235 
236                 // The properties files in jdk.test.resources.exported.props
237                 // are not found with loader.getResource().
238                 {List.of(&quot;-p&quot;, MODS_DIR.toString(),
239                         &quot;-m&quot;, &quot;test/jdk.test.TestWithUnnamedModuleArg&quot;,
240                         &quot;jdk.test.resources.exported.props.MyResources&quot;, &quot;false&quot;)},
241 
242                 // loader.loadClass() doesn&#39;t find jdk.test.resources.exported.classes.MyResources
243                 // and throws a ClassNotFoundException.
244                 {List.of(&quot;-p&quot;, MODS_DIR.toString(),
245                         &quot;-m&quot;, &quot;embargo/jdk.embargo.TestWithUnnamedModuleArg&quot;,
246                         &quot;jdk.test.resources.exported.classes.MyResources&quot;, &quot;false&quot;)},
247 
248                 // The properties files in jdk.test.resources.exported.props are not found
249                 // with loader.getResource().
250                 {List.of(&quot;-p&quot;, MODS_DIR.toString(),
251                         &quot;-m&quot;, &quot;embargo/jdk.embargo.TestWithUnnamedModuleArg&quot;,
252                         &quot;jdk.test.resources.exported.props.MyResources&quot;, &quot;false&quot;)},
253 
254                 // Add mods/exported.named.bundles to the class path.
255 
256                 // jdk.test.resources.exported.classes.MyResources.getModule().isNamed()
257                 // returns false.
258                 {List.of(&quot;-cp&quot;, EXPORTED_NAMED_BUNDLES_DIR.toString(),
259                         &quot;-p&quot;, MODS_DIR.toString(),
260                         &quot;-m&quot;, &quot;test/jdk.test.TestWithUnnamedModuleArg&quot;,
261                         &quot;jdk.test.resources.exported.classes.MyResources&quot;, &quot;true&quot;)},
262 
263                 // loader.getResource() finds jdk.test.resources.exported.props.MyResources.
264                 {List.of(&quot;-cp&quot;, EXPORTED_NAMED_BUNDLES_DIR.toString(),
265                         &quot;-p&quot;, MODS_DIR.toString(),
266                         &quot;-m&quot;, &quot;test/jdk.test.TestWithUnnamedModuleArg&quot;,
267                         &quot;jdk.test.resources.exported.props.MyResources&quot;, &quot;true&quot;)},
268 
269                 // jdk.test.resources.exported.classes.MyResources.getModule().isNamed()
270                 // returns false.
271                 {List.of(&quot;-cp&quot;, EXPORTED_NAMED_BUNDLES_DIR.toString(),
272                         &quot;-p&quot;, MODS_DIR.toString(),
273                         &quot;-m&quot;, &quot;embargo/jdk.embargo.TestWithUnnamedModuleArg&quot;,
274                         &quot;jdk.test.resources.exported.classes.MyResources&quot;, &quot;true&quot;)},
275 
276                 // loader.getResource() finds jdk.test.resources.exported.props.MyResources.
277                 {List.of(&quot;-cp&quot;, EXPORTED_NAMED_BUNDLES_DIR.toString(),
278                         &quot;-p&quot;, MODS_DIR.toString(),
279                         &quot;-m&quot;, &quot;embargo/jdk.embargo.TestWithUnnamedModuleArg&quot;,
280                         &quot;jdk.test.resources.exported.props.MyResources&quot;, &quot;true&quot;)},
281 
282         };
283     }
284 
285     @DataProvider(name = &quot;RunWithPkgResData&quot;)
286     Object[][] RunWithPkgResData() {
287         return new Object[][] {
288                 // jdk.pkg.resources.* are in an unnamed module.
289                 // jdk.pkg.test.Main calls ResourceBundle.getBundle with an unnamed module.
290                 { List.of(&quot;-cp&quot;, CLASSES_DIR.resolve(&quot;pkg&quot;).toString(), &quot;jdk.pkg.test.Main&quot;,
291                         &quot;jdk.pkg.resources.classes.MyResources&quot;, &quot;true&quot;)},
292                 { List.of(&quot;-cp&quot;, CLASSES_DIR.resolve(&quot;pkg&quot;).toString(), &quot;jdk.pkg.test.Main&quot;,
293                         &quot;jdk.pkg.resources.props.MyResources&quot;, &quot;true&quot;)},
294         };
295     }
296 
297     /**
298      * Test cases with jdk.test.resources.*
299      */
300     @Test(dataProvider = &quot;RunWithTestResData&quot;)
301     public void RunWithTestRes(List&lt;String&gt; argsList) throws Throwable {
302         int exitCode = runCmd(argsList);
303         assertEquals(exitCode, 0, &quot;Execution of the tests with &quot;
304                 + &quot;jdk.test.resources.* failed. &quot;
305                 + &quot;Unexpected exit code: &quot; + exitCode);
306     }
307 
308     /**
309      * Test cases with jdk.test.resources.exported.*
310      */
311     @Test(dataProvider = &quot;RunWithExportedResData&quot;)
312     public void RunWithExportedRes(List&lt;String&gt; argsList) throws Throwable {
313         int exitCode = runCmd(argsList);
314         assertEquals(exitCode, 0, &quot;Execution of the tests with &quot;
315                 + &quot;jdk.test.resources.exported.* failed. &quot;
316                 + &quot;Unexpected exit code: &quot; + exitCode);
317     }
318 
319     /**
320      * Test cases with jdk.pkg.resources.*
321      */
322     @Test(dataProvider = &quot;RunWithPkgResData&quot;)
323     public void RunWithPkgRes(List&lt;String&gt; argsList) throws Throwable {
324         int exitCode = runCmd(argsList);
325         assertEquals(exitCode, 0, &quot;Execution of the tests with &quot;
326                 + &quot;jdk.pkg.resources.* failed. &quot;
327                 + &quot;Unexpected exit code: &quot; + exitCode);
328     }
329 
330     private int runCmd(List&lt;String&gt; argsList) throws Throwable {
331         JDKToolLauncher launcher = JDKToolLauncher.createUsingTestJDK(&quot;java&quot;);
332         argsList.forEach(launcher::addToolArg);
333 
334         return ProcessTools.executeCommand(launcher.getCommand()).getExitValue();
335     }
336 }
    </pre>
  </body>
</html>