<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/java/util/concurrent/tck/TimeUnitTest.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="ThreadPoolExecutorTest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="TreeMapTest.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/util/concurrent/tck/TimeUnitTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 39 import static java.util.concurrent.TimeUnit.MILLISECONDS;
 40 import static java.util.concurrent.TimeUnit.MINUTES;
 41 import static java.util.concurrent.TimeUnit.NANOSECONDS;
 42 import static java.util.concurrent.TimeUnit.SECONDS;
 43 
 44 import java.util.concurrent.CountDownLatch;
 45 import java.util.concurrent.TimeUnit;
 46 
 47 import junit.framework.Test;
 48 import junit.framework.TestSuite;
 49 
 50 public class TimeUnitTest extends JSR166TestCase {
 51     public static void main(String[] args) {
 52         main(suite(), args);
 53     }
 54 
 55     public static Test suite() {
 56         return new TestSuite(TimeUnitTest.class);
 57     }
 58 
<span class="line-modified"> 59     // (loops to 88888 check increments at all time divisions.)</span>
<span class="line-modified"> 60 </span>
<span class="line-modified"> 61     /**</span>
<span class="line-modified"> 62      * convert correctly converts sample values across the units</span>
<span class="line-modified"> 63      */</span>
<span class="line-modified"> 64     public void testConvert() {</span>
<span class="line-modified"> 65         for (long t = 0; t &lt; 88888; ++t) {</span>
<span class="line-modified"> 66             assertEquals(t*60*60*24,</span>
<span class="line-modified"> 67                          SECONDS.convert(t, DAYS));</span>
<span class="line-modified"> 68             assertEquals(t*60*60,</span>
<span class="line-modified"> 69                          SECONDS.convert(t, HOURS));</span>
<span class="line-removed"> 70             assertEquals(t*60,</span>
<span class="line-removed"> 71                          SECONDS.convert(t, MINUTES));</span>
<span class="line-removed"> 72             assertEquals(t,</span>
<span class="line-removed"> 73                          SECONDS.convert(t, SECONDS));</span>
<span class="line-removed"> 74             assertEquals(t,</span>
<span class="line-removed"> 75                          SECONDS.convert(1000L*t, MILLISECONDS));</span>
<span class="line-removed"> 76             assertEquals(t,</span>
<span class="line-removed"> 77                          SECONDS.convert(1000000L*t, MICROSECONDS));</span>
<span class="line-removed"> 78             assertEquals(t,</span>
<span class="line-removed"> 79                          SECONDS.convert(1000000000L*t, NANOSECONDS));</span>
<span class="line-removed"> 80 </span>
<span class="line-removed"> 81             assertEquals(1000L*t*60*60*24,</span>
<span class="line-removed"> 82                          MILLISECONDS.convert(t, DAYS));</span>
<span class="line-removed"> 83             assertEquals(1000L*t*60*60,</span>
<span class="line-removed"> 84                          MILLISECONDS.convert(t, HOURS));</span>
<span class="line-removed"> 85             assertEquals(1000L*t*60,</span>
<span class="line-removed"> 86                          MILLISECONDS.convert(t, MINUTES));</span>
<span class="line-removed"> 87             assertEquals(1000L*t,</span>
<span class="line-removed"> 88                          MILLISECONDS.convert(t, SECONDS));</span>
<span class="line-removed"> 89             assertEquals(t,</span>
<span class="line-removed"> 90                          MILLISECONDS.convert(t, MILLISECONDS));</span>
<span class="line-removed"> 91             assertEquals(t,</span>
<span class="line-removed"> 92                          MILLISECONDS.convert(1000L*t, MICROSECONDS));</span>
<span class="line-removed"> 93             assertEquals(t,</span>
<span class="line-removed"> 94                          MILLISECONDS.convert(1000000L*t, NANOSECONDS));</span>
<span class="line-removed"> 95 </span>
<span class="line-removed"> 96             assertEquals(1000000L*t*60*60*24,</span>
<span class="line-removed"> 97                          MICROSECONDS.convert(t, DAYS));</span>
<span class="line-removed"> 98             assertEquals(1000000L*t*60*60,</span>
<span class="line-removed"> 99                          MICROSECONDS.convert(t, HOURS));</span>
<span class="line-removed">100             assertEquals(1000000L*t*60,</span>
<span class="line-removed">101                          MICROSECONDS.convert(t, MINUTES));</span>
<span class="line-removed">102             assertEquals(1000000L*t,</span>
<span class="line-removed">103                          MICROSECONDS.convert(t, SECONDS));</span>
<span class="line-removed">104             assertEquals(1000L*t,</span>
<span class="line-removed">105                          MICROSECONDS.convert(t, MILLISECONDS));</span>
<span class="line-removed">106             assertEquals(t,</span>
<span class="line-removed">107                          MICROSECONDS.convert(t, MICROSECONDS));</span>
<span class="line-removed">108             assertEquals(t,</span>
<span class="line-removed">109                          MICROSECONDS.convert(1000L*t, NANOSECONDS));</span>
<span class="line-removed">110 </span>
<span class="line-removed">111             assertEquals(1000000000L*t*60*60*24,</span>
<span class="line-removed">112                          NANOSECONDS.convert(t, DAYS));</span>
<span class="line-removed">113             assertEquals(1000000000L*t*60*60,</span>
<span class="line-removed">114                          NANOSECONDS.convert(t, HOURS));</span>
<span class="line-removed">115             assertEquals(1000000000L*t*60,</span>
<span class="line-removed">116                          NANOSECONDS.convert(t, MINUTES));</span>
<span class="line-removed">117             assertEquals(1000000000L*t,</span>
<span class="line-removed">118                          NANOSECONDS.convert(t, SECONDS));</span>
<span class="line-removed">119             assertEquals(1000000L*t,</span>
<span class="line-removed">120                          NANOSECONDS.convert(t, MILLISECONDS));</span>
<span class="line-removed">121             assertEquals(1000L*t,</span>
<span class="line-removed">122                          NANOSECONDS.convert(t, MICROSECONDS));</span>
<span class="line-removed">123             assertEquals(t,</span>
<span class="line-removed">124                          NANOSECONDS.convert(t, NANOSECONDS));</span>
<span class="line-removed">125         }</span>
<span class="line-removed">126 </span>
<span class="line-removed">127         for (TimeUnit x : TimeUnit.values()) {</span>
<span class="line-removed">128             long[] zs = {</span>
<span class="line-removed">129                 0, 1, -1,</span>
<span class="line-removed">130                 Integer.MAX_VALUE, Integer.MIN_VALUE,</span>
<span class="line-removed">131                 Long.MAX_VALUE, Long.MIN_VALUE,</span>
<span class="line-removed">132             };</span>
<span class="line-removed">133             for (long z : zs) assertEquals(z, x.convert(z, x));</span>
<span class="line-removed">134         }</span>
<span class="line-removed">135     }</span>
<span class="line-removed">136 </span>
<span class="line-removed">137     /**</span>
<span class="line-removed">138      * toNanos correctly converts sample values in different units to</span>
<span class="line-removed">139      * nanoseconds</span>
<span class="line-removed">140      */</span>
<span class="line-removed">141     public void testToNanos() {</span>
<span class="line-removed">142         for (long t = 0; t &lt; 88888; ++t) {</span>
<span class="line-removed">143             assertEquals(t*1000000000L*60*60*24,</span>
<span class="line-removed">144                          DAYS.toNanos(t));</span>
<span class="line-removed">145             assertEquals(t*1000000000L*60*60,</span>
<span class="line-removed">146                          HOURS.toNanos(t));</span>
<span class="line-removed">147             assertEquals(t*1000000000L*60,</span>
<span class="line-removed">148                          MINUTES.toNanos(t));</span>
<span class="line-removed">149             assertEquals(1000000000L*t,</span>
<span class="line-removed">150                          SECONDS.toNanos(t));</span>
<span class="line-removed">151             assertEquals(1000000L*t,</span>
<span class="line-removed">152                          MILLISECONDS.toNanos(t));</span>
<span class="line-removed">153             assertEquals(1000L*t,</span>
<span class="line-removed">154                          MICROSECONDS.toNanos(t));</span>
<span class="line-removed">155             assertEquals(t,</span>
<span class="line-removed">156                          NANOSECONDS.toNanos(t));</span>
<span class="line-removed">157         }</span>
<span class="line-removed">158     }</span>
<span class="line-removed">159 </span>
<span class="line-removed">160     /**</span>
<span class="line-removed">161      * toMicros correctly converts sample values in different units to</span>
<span class="line-removed">162      * microseconds</span>
<span class="line-removed">163      */</span>
<span class="line-removed">164     public void testToMicros() {</span>
<span class="line-removed">165         for (long t = 0; t &lt; 88888; ++t) {</span>
<span class="line-removed">166             assertEquals(t*1000000L*60*60*24,</span>
<span class="line-removed">167                          DAYS.toMicros(t));</span>
<span class="line-removed">168             assertEquals(t*1000000L*60*60,</span>
<span class="line-removed">169                          HOURS.toMicros(t));</span>
<span class="line-removed">170             assertEquals(t*1000000L*60,</span>
<span class="line-removed">171                          MINUTES.toMicros(t));</span>
<span class="line-removed">172             assertEquals(1000000L*t,</span>
<span class="line-removed">173                          SECONDS.toMicros(t));</span>
<span class="line-removed">174             assertEquals(1000L*t,</span>
<span class="line-removed">175                          MILLISECONDS.toMicros(t));</span>
<span class="line-removed">176             assertEquals(t,</span>
<span class="line-removed">177                          MICROSECONDS.toMicros(t));</span>
<span class="line-removed">178             assertEquals(t,</span>
<span class="line-removed">179                          NANOSECONDS.toMicros(t*1000L));</span>
180         }
<span class="line-removed">181     }</span>
182 
<span class="line-modified">183     /**</span>
<span class="line-removed">184      * toMillis correctly converts sample values in different units to</span>
<span class="line-removed">185      * milliseconds</span>
<span class="line-removed">186      */</span>
<span class="line-removed">187     public void testToMillis() {</span>
<span class="line-removed">188         for (long t = 0; t &lt; 88888; ++t) {</span>
<span class="line-removed">189             assertEquals(t*1000L*60*60*24,</span>
<span class="line-removed">190                          DAYS.toMillis(t));</span>
<span class="line-removed">191             assertEquals(t*1000L*60*60,</span>
<span class="line-removed">192                          HOURS.toMillis(t));</span>
<span class="line-removed">193             assertEquals(t*1000L*60,</span>
<span class="line-removed">194                          MINUTES.toMillis(t));</span>
<span class="line-removed">195             assertEquals(1000L*t,</span>
<span class="line-removed">196                          SECONDS.toMillis(t));</span>
<span class="line-removed">197             assertEquals(t,</span>
<span class="line-removed">198                          MILLISECONDS.toMillis(t));</span>
<span class="line-removed">199             assertEquals(t,</span>
<span class="line-removed">200                          MICROSECONDS.toMillis(t*1000L));</span>
<span class="line-removed">201             assertEquals(t,</span>
<span class="line-removed">202                          NANOSECONDS.toMillis(t*1000000L));</span>
<span class="line-removed">203         }</span>
204     }
205 
<span class="line-modified">206     /**</span>
<span class="line-modified">207      * toSeconds correctly converts sample values in different units to</span>
<span class="line-modified">208      * seconds</span>
<span class="line-modified">209      */</span>
<span class="line-modified">210     public void testToSeconds() {</span>
<span class="line-modified">211         for (long t = 0; t &lt; 88888; ++t) {</span>
<span class="line-modified">212             assertEquals(t*60*60*24,</span>
<span class="line-modified">213                          DAYS.toSeconds(t));</span>
<span class="line-modified">214             assertEquals(t*60*60,</span>
<span class="line-modified">215                          HOURS.toSeconds(t));</span>
<span class="line-removed">216             assertEquals(t*60,</span>
<span class="line-removed">217                          MINUTES.toSeconds(t));</span>
<span class="line-removed">218             assertEquals(t,</span>
<span class="line-removed">219                          SECONDS.toSeconds(t));</span>
<span class="line-removed">220             assertEquals(t,</span>
<span class="line-removed">221                          MILLISECONDS.toSeconds(t*1000L));</span>
<span class="line-removed">222             assertEquals(t,</span>
<span class="line-removed">223                          MICROSECONDS.toSeconds(t*1000000L));</span>
<span class="line-removed">224             assertEquals(t,</span>
<span class="line-removed">225                          NANOSECONDS.toSeconds(t*1000000000L));</span>
226         }
227     }
228 
229     /**
<span class="line-modified">230      * toMinutes correctly converts sample values in different units to</span>
<span class="line-removed">231      * minutes</span>
232      */
<span class="line-modified">233     public void testToMinutes() {</span>
<span class="line-modified">234         for (long t = 0; t &lt; 88888; ++t) {</span>
<span class="line-modified">235             assertEquals(t*60*24,</span>
<span class="line-modified">236                          DAYS.toMinutes(t));</span>
<span class="line-modified">237             assertEquals(t*60,</span>
<span class="line-modified">238                          HOURS.toMinutes(t));</span>
<span class="line-modified">239             assertEquals(t,</span>
<span class="line-modified">240                          MINUTES.toMinutes(t));</span>
<span class="line-modified">241             assertEquals(t,</span>
<span class="line-removed">242                          SECONDS.toMinutes(t*60));</span>
<span class="line-removed">243             assertEquals(t,</span>
<span class="line-removed">244                          MILLISECONDS.toMinutes(t*1000L*60));</span>
<span class="line-removed">245             assertEquals(t,</span>
<span class="line-removed">246                          MICROSECONDS.toMinutes(t*1000000L*60));</span>
<span class="line-removed">247             assertEquals(t,</span>
<span class="line-removed">248                          NANOSECONDS.toMinutes(t*1000000000L*60));</span>
<span class="line-removed">249         }</span>
<span class="line-removed">250     }</span>
251 
<span class="line-modified">252     /**</span>
<span class="line-modified">253      * toHours correctly converts sample values in different units to</span>
<span class="line-removed">254      * hours</span>
<span class="line-removed">255      */</span>
<span class="line-removed">256     public void testToHours() {</span>
<span class="line-removed">257         for (long t = 0; t &lt; 88888; ++t) {</span>
<span class="line-removed">258             assertEquals(t*24,</span>
<span class="line-removed">259                          DAYS.toHours(t));</span>
<span class="line-removed">260             assertEquals(t,</span>
<span class="line-removed">261                          HOURS.toHours(t));</span>
<span class="line-removed">262             assertEquals(t,</span>
<span class="line-removed">263                          MINUTES.toHours(t*60));</span>
<span class="line-removed">264             assertEquals(t,</span>
<span class="line-removed">265                          SECONDS.toHours(t*60*60));</span>
<span class="line-removed">266             assertEquals(t,</span>
<span class="line-removed">267                          MILLISECONDS.toHours(t*1000L*60*60));</span>
<span class="line-removed">268             assertEquals(t,</span>
<span class="line-removed">269                          MICROSECONDS.toHours(t*1000000L*60*60));</span>
<span class="line-removed">270             assertEquals(t,</span>
<span class="line-removed">271                          NANOSECONDS.toHours(t*1000000000L*60*60));</span>
272         }
<span class="line-removed">273     }</span>
274 
<span class="line-modified">275     /**</span>
<span class="line-modified">276      * toDays correctly converts sample values in different units to</span>
<span class="line-modified">277      * days</span>
<span class="line-modified">278      */</span>
<span class="line-removed">279     public void testToDays() {</span>
<span class="line-removed">280         for (long t = 0; t &lt; 88888; ++t) {</span>
<span class="line-removed">281             assertEquals(t,</span>
<span class="line-removed">282                          DAYS.toDays(t));</span>
<span class="line-removed">283             assertEquals(t,</span>
<span class="line-removed">284                          HOURS.toDays(t*24));</span>
<span class="line-removed">285             assertEquals(t,</span>
<span class="line-removed">286                          MINUTES.toDays(t*60*24));</span>
<span class="line-removed">287             assertEquals(t,</span>
<span class="line-removed">288                          SECONDS.toDays(t*60*60*24));</span>
<span class="line-removed">289             assertEquals(t,</span>
<span class="line-removed">290                          MILLISECONDS.toDays(t*1000L*60*60*24));</span>
<span class="line-removed">291             assertEquals(t,</span>
<span class="line-removed">292                          MICROSECONDS.toDays(t*1000000L*60*60*24));</span>
<span class="line-removed">293             assertEquals(t,</span>
<span class="line-removed">294                          NANOSECONDS.toDays(t*1000000000L*60*60*24));</span>
<span class="line-removed">295         }</span>
296     }
297 
298     /**
299      * convert saturates positive too-large values to Long.MAX_VALUE
300      * and negative to LONG.MIN_VALUE
301      */
302     public void testConvertSaturate() {
303         assertEquals(Long.MAX_VALUE,
304                      NANOSECONDS.convert(Long.MAX_VALUE / 2, SECONDS));
305         assertEquals(Long.MIN_VALUE,
306                      NANOSECONDS.convert(-Long.MAX_VALUE / 4, SECONDS));
307         assertEquals(Long.MAX_VALUE,
308                      NANOSECONDS.convert(Long.MAX_VALUE / 2, MINUTES));
309         assertEquals(Long.MIN_VALUE,
310                      NANOSECONDS.convert(-Long.MAX_VALUE / 4, MINUTES));
311         assertEquals(Long.MAX_VALUE,
312                      NANOSECONDS.convert(Long.MAX_VALUE / 2, HOURS));
313         assertEquals(Long.MIN_VALUE,
314                      NANOSECONDS.convert(-Long.MAX_VALUE / 4, HOURS));
315         assertEquals(Long.MAX_VALUE,
</pre>
<hr />
<pre>
477             long ratio = x.toNanos(1) / HOURS.toNanos(1);
478             if (ratio &gt;= 1) {
479                 long max = Long.MAX_VALUE/ratio;
480                 for (long z : new long[] {0, 1, -1, max, -max})
481                     assertEquals(z * ratio, x.toHours(z));
482                 if (max &lt; Long.MAX_VALUE) {
483                     assertEquals(Long.MAX_VALUE, x.toHours(max + 1));
484                     assertEquals(Long.MIN_VALUE, x.toHours(-max - 1));
485                     assertEquals(Long.MIN_VALUE, x.toHours(Long.MIN_VALUE + 1));
486                 }
487                 assertEquals(Long.MAX_VALUE, x.toHours(Long.MAX_VALUE));
488                 assertEquals(Long.MIN_VALUE, x.toHours(Long.MIN_VALUE));
489             }
490         }
491     }
492 
493     /**
494      * toString returns name of unit
495      */
496     public void testToString() {



497         assertEquals(&quot;SECONDS&quot;, SECONDS.toString());



498     }
499 
500     /**
501      * name returns name of unit
502      */
503     public void testName() {
<span class="line-modified">504         assertEquals(&quot;SECONDS&quot;, SECONDS.name());</span>

505     }
506 
507     /**
508      * Timed wait without holding lock throws
509      * IllegalMonitorStateException
510      */
511     public void testTimedWait_IllegalMonitorException() {
512         Thread t = newStartedThread(new CheckedRunnable() {
513             public void realRun() throws InterruptedException {
514                 Object o = new Object();
<span class="line-removed">515                 TimeUnit tu = MILLISECONDS;</span>
<span class="line-removed">516 </span>
517                 try {
<span class="line-modified">518                     tu.timedWait(o, LONG_DELAY_MS);</span>
519                     threadShouldThrow();
520                 } catch (IllegalMonitorStateException success) {}
521             }});
522 
523         awaitTermination(t);
524     }
525 
526     /**
527      * timedWait throws InterruptedException when interrupted
528      */
529     public void testTimedWait_Interruptible() {
530         final CountDownLatch pleaseInterrupt = new CountDownLatch(1);
531         Thread t = newStartedThread(new CheckedRunnable() {
532             public void realRun() throws InterruptedException {
533                 Object o = new Object();
<span class="line-removed">534                 TimeUnit tu = MILLISECONDS;</span>
535 
536                 Thread.currentThread().interrupt();
537                 try {
538                     synchronized (o) {
<span class="line-modified">539                         tu.timedWait(o, LONG_DELAY_MS);</span>
540                     }
541                     shouldThrow();
542                 } catch (InterruptedException success) {}
543                 assertFalse(Thread.interrupted());
544 
545                 pleaseInterrupt.countDown();
546                 try {
547                     synchronized (o) {
<span class="line-modified">548                         tu.timedWait(o, LONG_DELAY_MS);</span>
549                     }
550                     shouldThrow();
551                 } catch (InterruptedException success) {}
552                 assertFalse(Thread.interrupted());
553             }});
554 
555         await(pleaseInterrupt);
<span class="line-modified">556         assertThreadBlocks(t, Thread.State.TIMED_WAITING);</span>
557         t.interrupt();
558         awaitTermination(t);
559     }
560 
561     /**
562      * timedJoin throws InterruptedException when interrupted
563      */
564     public void testTimedJoin_Interruptible() {
565         final CountDownLatch pleaseInterrupt = new CountDownLatch(1);
566         final Thread s = newStartedThread(new CheckedInterruptedRunnable() {
567             public void realRun() throws InterruptedException {
<span class="line-modified">568                 Thread.sleep(LONG_DELAY_MS);</span>
569             }});
570         final Thread t = newStartedThread(new CheckedRunnable() {
571             public void realRun() throws InterruptedException {
<span class="line-removed">572                 TimeUnit tu = MILLISECONDS;</span>
573                 Thread.currentThread().interrupt();
574                 try {
<span class="line-modified">575                     tu.timedJoin(s, LONG_DELAY_MS);</span>
576                     shouldThrow();
577                 } catch (InterruptedException success) {}
578                 assertFalse(Thread.interrupted());
579 
580                 pleaseInterrupt.countDown();
581                 try {
<span class="line-modified">582                     tu.timedJoin(s, LONG_DELAY_MS);</span>
583                     shouldThrow();
584                 } catch (InterruptedException success) {}
585                 assertFalse(Thread.interrupted());
586             }});
587 
588         await(pleaseInterrupt);
<span class="line-modified">589         assertThreadBlocks(t, Thread.State.TIMED_WAITING);</span>
590         t.interrupt();
591         awaitTermination(t);
592         s.interrupt();
593         awaitTermination(s);
594     }
595 
596     /**
<span class="line-modified">597      * timedSleep throws InterruptedException when interrupted</span>
598      */
599     public void testTimedSleep_Interruptible() {
600         final CountDownLatch pleaseInterrupt = new CountDownLatch(1);
601         Thread t = newStartedThread(new CheckedRunnable() {
602             public void realRun() throws InterruptedException {
<span class="line-removed">603                 TimeUnit tu = MILLISECONDS;</span>
604                 Thread.currentThread().interrupt();
605                 try {
<span class="line-modified">606                     tu.sleep(LONG_DELAY_MS);</span>
607                     shouldThrow();
608                 } catch (InterruptedException success) {}
609                 assertFalse(Thread.interrupted());
610 
611                 pleaseInterrupt.countDown();
612                 try {
<span class="line-modified">613                     tu.sleep(LONG_DELAY_MS);</span>
614                     shouldThrow();
615                 } catch (InterruptedException success) {}
616                 assertFalse(Thread.interrupted());
617             }});
618 
619         await(pleaseInterrupt);
<span class="line-modified">620         assertThreadBlocks(t, Thread.State.TIMED_WAITING);</span>
621         t.interrupt();
622         awaitTermination(t);
623     }
624 












625     /**
626      * a deserialized/reserialized unit is the same instance
627      */
628     public void testSerialization() throws Exception {
629         for (TimeUnit x : TimeUnit.values())
630             assertSame(x, serialClone(x));
631     }
632 
633 }
</pre>
</td>
<td>
<hr />
<pre>
 39 import static java.util.concurrent.TimeUnit.MILLISECONDS;
 40 import static java.util.concurrent.TimeUnit.MINUTES;
 41 import static java.util.concurrent.TimeUnit.NANOSECONDS;
 42 import static java.util.concurrent.TimeUnit.SECONDS;
 43 
 44 import java.util.concurrent.CountDownLatch;
 45 import java.util.concurrent.TimeUnit;
 46 
 47 import junit.framework.Test;
 48 import junit.framework.TestSuite;
 49 
 50 public class TimeUnitTest extends JSR166TestCase {
 51     public static void main(String[] args) {
 52         main(suite(), args);
 53     }
 54 
 55     public static Test suite() {
 56         return new TestSuite(TimeUnitTest.class);
 57     }
 58 
<span class="line-modified"> 59     void testConversion(TimeUnit x, TimeUnit y, long n, long expected) {</span>
<span class="line-modified"> 60         assertEquals(expected, x.convert(n, y));</span>
<span class="line-modified"> 61         switch (x) {</span>
<span class="line-modified"> 62         case NANOSECONDS:  assertEquals(expected, y.toNanos(n));   break;</span>
<span class="line-modified"> 63         case MICROSECONDS: assertEquals(expected, y.toMicros(n));  break;</span>
<span class="line-modified"> 64         case MILLISECONDS: assertEquals(expected, y.toMillis(n));  break;</span>
<span class="line-modified"> 65         case SECONDS:      assertEquals(expected, y.toSeconds(n)); break;</span>
<span class="line-modified"> 66         case MINUTES:      assertEquals(expected, y.toMinutes(n)); break;</span>
<span class="line-modified"> 67         case HOURS:        assertEquals(expected, y.toHours(n));   break;</span>
<span class="line-modified"> 68         case DAYS:         assertEquals(expected, y.toDays(n));    break;</span>
<span class="line-modified"> 69         default: throw new AssertionError();</span>














































































































 70         }

 71 
<span class="line-modified"> 72         if (n &gt; 0) testConversion(x, y, -n, -expected);</span>




















 73     }
 74 
<span class="line-modified"> 75     void testConversion(TimeUnit x, TimeUnit y) {</span>
<span class="line-modified"> 76         long ratio = x.toNanos(1)/y.toNanos(1);</span>
<span class="line-modified"> 77         assertTrue(ratio &gt; 0);</span>
<span class="line-modified"> 78         long[] ns = { 0, 1, 2, Long.MAX_VALUE/ratio, Long.MIN_VALUE/ratio };</span>
<span class="line-modified"> 79         for (long n : ns) {</span>
<span class="line-modified"> 80             testConversion(y, x, n, n * ratio);</span>
<span class="line-modified"> 81             long[] ks = { n * ratio, n * ratio + 1, n * ratio - 1 };</span>
<span class="line-modified"> 82             for (long k : ks) {</span>
<span class="line-modified"> 83                 testConversion(x, y, k, k / ratio);</span>
<span class="line-modified"> 84             }</span>










 85         }
 86     }
 87 
 88     /**
<span class="line-modified"> 89      * Conversion methods correctly convert sample values</span>

 90      */
<span class="line-modified"> 91     public void testConversions() {</span>
<span class="line-modified"> 92         // Sanity check</span>
<span class="line-modified"> 93         assertEquals(1, NANOSECONDS.toNanos(1));</span>
<span class="line-modified"> 94         assertEquals(1000L * NANOSECONDS.toNanos(1), MICROSECONDS.toNanos(1));</span>
<span class="line-modified"> 95         assertEquals(1000L * MICROSECONDS.toNanos(1), MILLISECONDS.toNanos(1));</span>
<span class="line-modified"> 96         assertEquals(1000L * MILLISECONDS.toNanos(1), SECONDS.toNanos(1));</span>
<span class="line-modified"> 97         assertEquals(60L * SECONDS.toNanos(1), MINUTES.toNanos(1));</span>
<span class="line-modified"> 98         assertEquals(60L * MINUTES.toNanos(1), HOURS.toNanos(1));</span>
<span class="line-modified"> 99         assertEquals(24L * HOURS.toNanos(1), DAYS.toNanos(1));</span>









100 
<span class="line-modified">101         for (TimeUnit x : TimeUnit.values()) {</span>
<span class="line-modified">102             assertEquals(x.toNanos(1), NANOSECONDS.convert(1, x));</span>


















103         }

104 
<span class="line-modified">105         for (TimeUnit x : TimeUnit.values())</span>
<span class="line-modified">106             for (TimeUnit y : TimeUnit.values())</span>
<span class="line-modified">107                 if (x.toNanos(1) &gt;= y.toNanos(1))</span>
<span class="line-modified">108                     testConversion(x, y);</span>

















109     }
110 
111     /**
112      * convert saturates positive too-large values to Long.MAX_VALUE
113      * and negative to LONG.MIN_VALUE
114      */
115     public void testConvertSaturate() {
116         assertEquals(Long.MAX_VALUE,
117                      NANOSECONDS.convert(Long.MAX_VALUE / 2, SECONDS));
118         assertEquals(Long.MIN_VALUE,
119                      NANOSECONDS.convert(-Long.MAX_VALUE / 4, SECONDS));
120         assertEquals(Long.MAX_VALUE,
121                      NANOSECONDS.convert(Long.MAX_VALUE / 2, MINUTES));
122         assertEquals(Long.MIN_VALUE,
123                      NANOSECONDS.convert(-Long.MAX_VALUE / 4, MINUTES));
124         assertEquals(Long.MAX_VALUE,
125                      NANOSECONDS.convert(Long.MAX_VALUE / 2, HOURS));
126         assertEquals(Long.MIN_VALUE,
127                      NANOSECONDS.convert(-Long.MAX_VALUE / 4, HOURS));
128         assertEquals(Long.MAX_VALUE,
</pre>
<hr />
<pre>
290             long ratio = x.toNanos(1) / HOURS.toNanos(1);
291             if (ratio &gt;= 1) {
292                 long max = Long.MAX_VALUE/ratio;
293                 for (long z : new long[] {0, 1, -1, max, -max})
294                     assertEquals(z * ratio, x.toHours(z));
295                 if (max &lt; Long.MAX_VALUE) {
296                     assertEquals(Long.MAX_VALUE, x.toHours(max + 1));
297                     assertEquals(Long.MIN_VALUE, x.toHours(-max - 1));
298                     assertEquals(Long.MIN_VALUE, x.toHours(Long.MIN_VALUE + 1));
299                 }
300                 assertEquals(Long.MAX_VALUE, x.toHours(Long.MAX_VALUE));
301                 assertEquals(Long.MIN_VALUE, x.toHours(Long.MIN_VALUE));
302             }
303         }
304     }
305 
306     /**
307      * toString returns name of unit
308      */
309     public void testToString() {
<span class="line-added">310         assertEquals(&quot;NANOSECONDS&quot;, NANOSECONDS.toString());</span>
<span class="line-added">311         assertEquals(&quot;MICROSECONDS&quot;, MICROSECONDS.toString());</span>
<span class="line-added">312         assertEquals(&quot;MILLISECONDS&quot;, MILLISECONDS.toString());</span>
313         assertEquals(&quot;SECONDS&quot;, SECONDS.toString());
<span class="line-added">314         assertEquals(&quot;MINUTES&quot;, MINUTES.toString());</span>
<span class="line-added">315         assertEquals(&quot;HOURS&quot;, HOURS.toString());</span>
<span class="line-added">316         assertEquals(&quot;DAYS&quot;, DAYS.toString());</span>
317     }
318 
319     /**
320      * name returns name of unit
321      */
322     public void testName() {
<span class="line-modified">323         for (TimeUnit x : TimeUnit.values())</span>
<span class="line-added">324             assertEquals(x.toString(), x.name());</span>
325     }
326 
327     /**
328      * Timed wait without holding lock throws
329      * IllegalMonitorStateException
330      */
331     public void testTimedWait_IllegalMonitorException() {
332         Thread t = newStartedThread(new CheckedRunnable() {
333             public void realRun() throws InterruptedException {
334                 Object o = new Object();


335                 try {
<span class="line-modified">336                     MILLISECONDS.timedWait(o, LONGER_DELAY_MS);</span>
337                     threadShouldThrow();
338                 } catch (IllegalMonitorStateException success) {}
339             }});
340 
341         awaitTermination(t);
342     }
343 
344     /**
345      * timedWait throws InterruptedException when interrupted
346      */
347     public void testTimedWait_Interruptible() {
348         final CountDownLatch pleaseInterrupt = new CountDownLatch(1);
349         Thread t = newStartedThread(new CheckedRunnable() {
350             public void realRun() throws InterruptedException {
351                 Object o = new Object();

352 
353                 Thread.currentThread().interrupt();
354                 try {
355                     synchronized (o) {
<span class="line-modified">356                         MILLISECONDS.timedWait(o, LONGER_DELAY_MS);</span>
357                     }
358                     shouldThrow();
359                 } catch (InterruptedException success) {}
360                 assertFalse(Thread.interrupted());
361 
362                 pleaseInterrupt.countDown();
363                 try {
364                     synchronized (o) {
<span class="line-modified">365                         MILLISECONDS.timedWait(o, LONGER_DELAY_MS);</span>
366                     }
367                     shouldThrow();
368                 } catch (InterruptedException success) {}
369                 assertFalse(Thread.interrupted());
370             }});
371 
372         await(pleaseInterrupt);
<span class="line-modified">373         if (randomBoolean()) assertThreadBlocks(t, Thread.State.TIMED_WAITING);</span>
374         t.interrupt();
375         awaitTermination(t);
376     }
377 
378     /**
379      * timedJoin throws InterruptedException when interrupted
380      */
381     public void testTimedJoin_Interruptible() {
382         final CountDownLatch pleaseInterrupt = new CountDownLatch(1);
383         final Thread s = newStartedThread(new CheckedInterruptedRunnable() {
384             public void realRun() throws InterruptedException {
<span class="line-modified">385                 Thread.sleep(LONGER_DELAY_MS);</span>
386             }});
387         final Thread t = newStartedThread(new CheckedRunnable() {
388             public void realRun() throws InterruptedException {

389                 Thread.currentThread().interrupt();
390                 try {
<span class="line-modified">391                     MILLISECONDS.timedJoin(s, LONGER_DELAY_MS);</span>
392                     shouldThrow();
393                 } catch (InterruptedException success) {}
394                 assertFalse(Thread.interrupted());
395 
396                 pleaseInterrupt.countDown();
397                 try {
<span class="line-modified">398                     MILLISECONDS.timedJoin(s, LONGER_DELAY_MS);</span>
399                     shouldThrow();
400                 } catch (InterruptedException success) {}
401                 assertFalse(Thread.interrupted());
402             }});
403 
404         await(pleaseInterrupt);
<span class="line-modified">405         if (randomBoolean()) assertThreadBlocks(t, Thread.State.TIMED_WAITING);</span>
406         t.interrupt();
407         awaitTermination(t);
408         s.interrupt();
409         awaitTermination(s);
410     }
411 
412     /**
<span class="line-modified">413      * timeUnit.sleep throws InterruptedException when interrupted</span>
414      */
415     public void testTimedSleep_Interruptible() {
416         final CountDownLatch pleaseInterrupt = new CountDownLatch(1);
417         Thread t = newStartedThread(new CheckedRunnable() {
418             public void realRun() throws InterruptedException {

419                 Thread.currentThread().interrupt();
420                 try {
<span class="line-modified">421                     MILLISECONDS.sleep(LONGER_DELAY_MS);</span>
422                     shouldThrow();
423                 } catch (InterruptedException success) {}
424                 assertFalse(Thread.interrupted());
425 
426                 pleaseInterrupt.countDown();
427                 try {
<span class="line-modified">428                     MILLISECONDS.sleep(LONGER_DELAY_MS);</span>
429                     shouldThrow();
430                 } catch (InterruptedException success) {}
431                 assertFalse(Thread.interrupted());
432             }});
433 
434         await(pleaseInterrupt);
<span class="line-modified">435         if (randomBoolean()) assertThreadBlocks(t, Thread.State.TIMED_WAITING);</span>
436         t.interrupt();
437         awaitTermination(t);
438     }
439 
<span class="line-added">440     /**</span>
<span class="line-added">441      * timeUnit.sleep(x) for x &lt;= 0 does not sleep at all.</span>
<span class="line-added">442      */</span>
<span class="line-added">443     public void testTimedSleep_nonPositive() throws InterruptedException {</span>
<span class="line-added">444         boolean interrupt = randomBoolean();</span>
<span class="line-added">445         if (interrupt) Thread.currentThread().interrupt();</span>
<span class="line-added">446         randomTimeUnit().sleep(0L);</span>
<span class="line-added">447         randomTimeUnit().sleep(-1L);</span>
<span class="line-added">448         randomTimeUnit().sleep(Long.MIN_VALUE);</span>
<span class="line-added">449         if (interrupt) assertTrue(Thread.interrupted());</span>
<span class="line-added">450     }</span>
<span class="line-added">451 </span>
452     /**
453      * a deserialized/reserialized unit is the same instance
454      */
455     public void testSerialization() throws Exception {
456         for (TimeUnit x : TimeUnit.values())
457             assertSame(x, serialClone(x));
458     }
459 
460 }
</pre>
</td>
</tr>
</table>
<center><a href="ThreadPoolExecutorTest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="TreeMapTest.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>