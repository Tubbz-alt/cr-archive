<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/java/util/concurrent/tck/DelayQueueTest.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="CyclicBarrierTest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="DoubleAccumulatorTest.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/util/concurrent/tck/DelayQueueTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
315     }
316 
317     /**
318      * put doesn&#39;t block waiting for take
319      */
320     public void testPutWithTake() throws InterruptedException {
321         final DelayQueue q = new DelayQueue();
322         Thread t = newStartedThread(new CheckedRunnable() {
323             public void realRun() {
324                 q.put(new PDelay(0));
325                 q.put(new PDelay(0));
326                 q.put(new PDelay(0));
327                 q.put(new PDelay(0));
328             }});
329 
330         awaitTermination(t);
331         assertEquals(4, q.size());
332     }
333 
334     /**
<span class="line-modified">335      * timed offer does not time out</span>
336      */
337     public void testTimedOffer() throws InterruptedException {
338         final DelayQueue q = new DelayQueue();
339         Thread t = newStartedThread(new CheckedRunnable() {
340             public void realRun() throws InterruptedException {
341                 q.put(new PDelay(0));
342                 q.put(new PDelay(0));
343                 assertTrue(q.offer(new PDelay(0), SHORT_DELAY_MS, MILLISECONDS));
344                 assertTrue(q.offer(new PDelay(0), LONG_DELAY_MS, MILLISECONDS));
345             }});
346 
347         awaitTermination(t);
348     }
349 
350     /**
351      * take retrieves elements in priority order
352      */
353     public void testTake() throws InterruptedException {
354         DelayQueue q = populatedQueue(SIZE);
355         for (int i = 0; i &lt; SIZE; ++i) {
</pre>
<hr />
<pre>
367             public void realRun() throws InterruptedException {
368                 for (int i = 0; i &lt; SIZE; i++)
369                     assertEquals(new PDelay(i), ((PDelay)q.take()));
370 
371                 Thread.currentThread().interrupt();
372                 try {
373                     q.take();
374                     shouldThrow();
375                 } catch (InterruptedException success) {}
376                 assertFalse(Thread.interrupted());
377 
378                 pleaseInterrupt.countDown();
379                 try {
380                     q.take();
381                     shouldThrow();
382                 } catch (InterruptedException success) {}
383                 assertFalse(Thread.interrupted());
384             }});
385 
386         await(pleaseInterrupt);
<span class="line-modified">387         assertThreadBlocks(t, Thread.State.WAITING);</span>
388         t.interrupt();
389         awaitTermination(t);
390     }
391 
392     /**
393      * poll succeeds unless empty
394      */
395     public void testPoll() {
396         DelayQueue q = populatedQueue(SIZE);
397         for (int i = 0; i &lt; SIZE; ++i) {
398             assertEquals(new PDelay(i), q.poll());
399         }
400         assertNull(q.poll());
401     }
402 
403     /**
404      * timed poll with zero timeout succeeds when non-empty, else times out
405      */
406     public void testTimedPoll0() throws InterruptedException {
407         DelayQueue q = populatedQueue(SIZE);
</pre>
<hr />
<pre>
419         for (int i = 0; i &lt; SIZE; ++i) {
420             long startTime = System.nanoTime();
421             assertEquals(new PDelay(i), q.poll(LONG_DELAY_MS, MILLISECONDS));
422             assertTrue(millisElapsedSince(startTime) &lt; LONG_DELAY_MS);
423         }
424         long startTime = System.nanoTime();
425         assertNull(q.poll(timeoutMillis(), MILLISECONDS));
426         assertTrue(millisElapsedSince(startTime) &gt;= timeoutMillis());
427         checkEmpty(q);
428     }
429 
430     /**
431      * Interrupted timed poll throws InterruptedException instead of
432      * returning timeout status
433      */
434     public void testInterruptedTimedPoll() throws InterruptedException {
435         final CountDownLatch pleaseInterrupt = new CountDownLatch(1);
436         final DelayQueue q = populatedQueue(SIZE);
437         Thread t = newStartedThread(new CheckedRunnable() {
438             public void realRun() throws InterruptedException {
<span class="line-removed">439                 long startTime = System.nanoTime();</span>
440                 for (int i = 0; i &lt; SIZE; i++)
441                     assertEquals(new PDelay(i),
442                                  ((PDelay)q.poll(LONG_DELAY_MS, MILLISECONDS)));
443 
444                 Thread.currentThread().interrupt();
445                 try {
<span class="line-modified">446                     q.poll(LONG_DELAY_MS, MILLISECONDS);</span>
447                     shouldThrow();
448                 } catch (InterruptedException success) {}
449                 assertFalse(Thread.interrupted());
450 
451                 pleaseInterrupt.countDown();
452                 try {
<span class="line-modified">453                     q.poll(LONG_DELAY_MS, MILLISECONDS);</span>
454                     shouldThrow();
455                 } catch (InterruptedException success) {}
456                 assertFalse(Thread.interrupted());
<span class="line-removed">457 </span>
<span class="line-removed">458                 assertTrue(millisElapsedSince(startTime) &lt; LONG_DELAY_MS);</span>
459             }});
460 
461         await(pleaseInterrupt);
<span class="line-modified">462         assertThreadBlocks(t, Thread.State.TIMED_WAITING);</span>
463         t.interrupt();
464         awaitTermination(t);
465         checkEmpty(q);
466     }
467 
468     /**
469      * peek returns next element, or null if empty
470      */
471     public void testPeek() {
472         DelayQueue q = populatedQueue(SIZE);
473         for (int i = 0; i &lt; SIZE; ++i) {
474             assertEquals(new PDelay(i), q.peek());
475             assertEquals(new PDelay(i), q.poll());
476             if (q.isEmpty())
477                 assertNull(q.peek());
478             else
479                 assertFalse(new PDelay(i).equals(q.peek()));
480         }
481         assertNull(q.peek());
482     }
</pre>
</td>
<td>
<hr />
<pre>
315     }
316 
317     /**
318      * put doesn&#39;t block waiting for take
319      */
320     public void testPutWithTake() throws InterruptedException {
321         final DelayQueue q = new DelayQueue();
322         Thread t = newStartedThread(new CheckedRunnable() {
323             public void realRun() {
324                 q.put(new PDelay(0));
325                 q.put(new PDelay(0));
326                 q.put(new PDelay(0));
327                 q.put(new PDelay(0));
328             }});
329 
330         awaitTermination(t);
331         assertEquals(4, q.size());
332     }
333 
334     /**
<span class="line-modified">335      * Queue is unbounded, so timed offer never times out</span>
336      */
337     public void testTimedOffer() throws InterruptedException {
338         final DelayQueue q = new DelayQueue();
339         Thread t = newStartedThread(new CheckedRunnable() {
340             public void realRun() throws InterruptedException {
341                 q.put(new PDelay(0));
342                 q.put(new PDelay(0));
343                 assertTrue(q.offer(new PDelay(0), SHORT_DELAY_MS, MILLISECONDS));
344                 assertTrue(q.offer(new PDelay(0), LONG_DELAY_MS, MILLISECONDS));
345             }});
346 
347         awaitTermination(t);
348     }
349 
350     /**
351      * take retrieves elements in priority order
352      */
353     public void testTake() throws InterruptedException {
354         DelayQueue q = populatedQueue(SIZE);
355         for (int i = 0; i &lt; SIZE; ++i) {
</pre>
<hr />
<pre>
367             public void realRun() throws InterruptedException {
368                 for (int i = 0; i &lt; SIZE; i++)
369                     assertEquals(new PDelay(i), ((PDelay)q.take()));
370 
371                 Thread.currentThread().interrupt();
372                 try {
373                     q.take();
374                     shouldThrow();
375                 } catch (InterruptedException success) {}
376                 assertFalse(Thread.interrupted());
377 
378                 pleaseInterrupt.countDown();
379                 try {
380                     q.take();
381                     shouldThrow();
382                 } catch (InterruptedException success) {}
383                 assertFalse(Thread.interrupted());
384             }});
385 
386         await(pleaseInterrupt);
<span class="line-modified">387         if (randomBoolean()) assertThreadBlocks(t, Thread.State.WAITING);</span>
388         t.interrupt();
389         awaitTermination(t);
390     }
391 
392     /**
393      * poll succeeds unless empty
394      */
395     public void testPoll() {
396         DelayQueue q = populatedQueue(SIZE);
397         for (int i = 0; i &lt; SIZE; ++i) {
398             assertEquals(new PDelay(i), q.poll());
399         }
400         assertNull(q.poll());
401     }
402 
403     /**
404      * timed poll with zero timeout succeeds when non-empty, else times out
405      */
406     public void testTimedPoll0() throws InterruptedException {
407         DelayQueue q = populatedQueue(SIZE);
</pre>
<hr />
<pre>
419         for (int i = 0; i &lt; SIZE; ++i) {
420             long startTime = System.nanoTime();
421             assertEquals(new PDelay(i), q.poll(LONG_DELAY_MS, MILLISECONDS));
422             assertTrue(millisElapsedSince(startTime) &lt; LONG_DELAY_MS);
423         }
424         long startTime = System.nanoTime();
425         assertNull(q.poll(timeoutMillis(), MILLISECONDS));
426         assertTrue(millisElapsedSince(startTime) &gt;= timeoutMillis());
427         checkEmpty(q);
428     }
429 
430     /**
431      * Interrupted timed poll throws InterruptedException instead of
432      * returning timeout status
433      */
434     public void testInterruptedTimedPoll() throws InterruptedException {
435         final CountDownLatch pleaseInterrupt = new CountDownLatch(1);
436         final DelayQueue q = populatedQueue(SIZE);
437         Thread t = newStartedThread(new CheckedRunnable() {
438             public void realRun() throws InterruptedException {

439                 for (int i = 0; i &lt; SIZE; i++)
440                     assertEquals(new PDelay(i),
441                                  ((PDelay)q.poll(LONG_DELAY_MS, MILLISECONDS)));
442 
443                 Thread.currentThread().interrupt();
444                 try {
<span class="line-modified">445                     q.poll(randomTimeout(), randomTimeUnit());</span>
446                     shouldThrow();
447                 } catch (InterruptedException success) {}
448                 assertFalse(Thread.interrupted());
449 
450                 pleaseInterrupt.countDown();
451                 try {
<span class="line-modified">452                     q.poll(LONGER_DELAY_MS, MILLISECONDS);</span>
453                     shouldThrow();
454                 } catch (InterruptedException success) {}
455                 assertFalse(Thread.interrupted());


456             }});
457 
458         await(pleaseInterrupt);
<span class="line-modified">459         if (randomBoolean()) assertThreadBlocks(t, Thread.State.TIMED_WAITING);</span>
460         t.interrupt();
461         awaitTermination(t);
462         checkEmpty(q);
463     }
464 
465     /**
466      * peek returns next element, or null if empty
467      */
468     public void testPeek() {
469         DelayQueue q = populatedQueue(SIZE);
470         for (int i = 0; i &lt; SIZE; ++i) {
471             assertEquals(new PDelay(i), q.peek());
472             assertEquals(new PDelay(i), q.poll());
473             if (q.isEmpty())
474                 assertNull(q.peek());
475             else
476                 assertFalse(new PDelay(i).equals(q.peek()));
477         }
478         assertNull(q.peek());
479     }
</pre>
</td>
</tr>
</table>
<center><a href="CyclicBarrierTest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="DoubleAccumulatorTest.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>