<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff test/jdk/java/util/concurrent/tck/SynchronousQueueTest.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="StampedLockTest.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="ThreadLocalRandom8Test.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/util/concurrent/tck/SynchronousQueueTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 43,11 ***</span>
  import java.util.concurrent.BlockingQueue;
  import java.util.concurrent.CountDownLatch;
  import java.util.concurrent.Executors;
  import java.util.concurrent.ExecutorService;
  import java.util.concurrent.SynchronousQueue;
<span class="line-removed">- import java.util.concurrent.ThreadLocalRandom;</span>
  
  import junit.framework.Test;
  
  public class SynchronousQueueTest extends JSR166TestCase {
  
<span class="line-new-header">--- 43,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 164,11 ***</span>
                  } catch (InterruptedException success) {}
                  assertFalse(Thread.interrupted());
              }});
  
          await(pleaseInterrupt);
<span class="line-modified">!         assertThreadBlocks(t, Thread.State.WAITING);</span>
          t.interrupt();
          awaitTermination(t);
          assertEquals(0, q.remainingCapacity());
      }
  
<span class="line-new-header">--- 163,11 ---</span>
                  } catch (InterruptedException success) {}
                  assertFalse(Thread.interrupted());
              }});
  
          await(pleaseInterrupt);
<span class="line-modified">!         if (randomBoolean()) assertThreadBlocks(t, Thread.State.WAITING);</span>
          t.interrupt();
          awaitTermination(t);
          assertEquals(0, q.remainingCapacity());
      }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 205,46 ***</span>
          assertEquals(0, q.remainingCapacity());
          try { assertSame(one, q.take()); }
          catch (InterruptedException e) { threadUnexpectedException(e); }
  
          await(pleaseInterrupt);
<span class="line-modified">!         assertThreadBlocks(t, Thread.State.WAITING);</span>
          t.interrupt();
          awaitTermination(t);
          assertEquals(0, q.remainingCapacity());
      }
  
      /**
       * timed offer times out if elements not taken
       */
      public void testTimedOffer() {
<span class="line-modified">!         final boolean fair = ThreadLocalRandom.current().nextBoolean();</span>
          final SynchronousQueue q = new SynchronousQueue(fair);
          final CountDownLatch pleaseInterrupt = new CountDownLatch(1);
          Thread t = newStartedThread(new CheckedRunnable() {
              public void realRun() throws InterruptedException {
                  long startTime = System.nanoTime();
                  assertFalse(q.offer(new Object(), timeoutMillis(), MILLISECONDS));
                  assertTrue(millisElapsedSince(startTime) &gt;= timeoutMillis());
  
                  Thread.currentThread().interrupt();
                  try {
<span class="line-modified">!                     q.offer(new Object(), 2 * LONG_DELAY_MS, MILLISECONDS);</span>
                      shouldThrow();
                  } catch (InterruptedException success) {}
                  assertFalse(Thread.interrupted());
  
                  pleaseInterrupt.countDown();
                  try {
<span class="line-modified">!                     q.offer(new Object(), 2 * LONG_DELAY_MS, MILLISECONDS);</span>
                      shouldThrow();
                  } catch (InterruptedException success) {}
                  assertFalse(Thread.interrupted());
              }});
  
          await(pleaseInterrupt);
<span class="line-modified">!         assertThreadBlocks(t, Thread.State.TIMED_WAITING);</span>
          t.interrupt();
          awaitTermination(t);
      }
  
      /**
<span class="line-new-header">--- 204,47 ---</span>
          assertEquals(0, q.remainingCapacity());
          try { assertSame(one, q.take()); }
          catch (InterruptedException e) { threadUnexpectedException(e); }
  
          await(pleaseInterrupt);
<span class="line-modified">!         if (randomBoolean()) assertThreadBlocks(t, Thread.State.WAITING);</span>
          t.interrupt();
          awaitTermination(t);
          assertEquals(0, q.remainingCapacity());
      }
  
      /**
       * timed offer times out if elements not taken
       */
      public void testTimedOffer() {
<span class="line-modified">!         final boolean fair = randomBoolean();</span>
          final SynchronousQueue q = new SynchronousQueue(fair);
          final CountDownLatch pleaseInterrupt = new CountDownLatch(1);
          Thread t = newStartedThread(new CheckedRunnable() {
              public void realRun() throws InterruptedException {
                  long startTime = System.nanoTime();
<span class="line-added">+ </span>
                  assertFalse(q.offer(new Object(), timeoutMillis(), MILLISECONDS));
                  assertTrue(millisElapsedSince(startTime) &gt;= timeoutMillis());
  
                  Thread.currentThread().interrupt();
                  try {
<span class="line-modified">!                     q.offer(new Object(), randomTimeout(), randomTimeUnit());</span>
                      shouldThrow();
                  } catch (InterruptedException success) {}
                  assertFalse(Thread.interrupted());
  
                  pleaseInterrupt.countDown();
                  try {
<span class="line-modified">!                     q.offer(new Object(), LONGER_DELAY_MS, MILLISECONDS);</span>
                      shouldThrow();
                  } catch (InterruptedException success) {}
                  assertFalse(Thread.interrupted());
              }});
  
          await(pleaseInterrupt);
<span class="line-modified">!         if (randomBoolean()) assertThreadBlocks(t, Thread.State.TIMED_WAITING);</span>
          t.interrupt();
          awaitTermination(t);
      }
  
      /**
</pre>
<hr />
<pre>
<span class="line-old-header">*** 270,11 ***</span>
  
      /**
       * timed poll with nonzero timeout times out if no active putter
       */
      public void testTimedPoll() {
<span class="line-modified">!         final boolean fair = ThreadLocalRandom.current().nextBoolean();</span>
          final SynchronousQueue q = new SynchronousQueue(fair);
          final long startTime = System.nanoTime();
          try { assertNull(q.poll(timeoutMillis(), MILLISECONDS)); }
          catch (InterruptedException e) { threadUnexpectedException(e); }
          assertTrue(millisElapsedSince(startTime) &gt;= timeoutMillis());
<span class="line-new-header">--- 270,11 ---</span>
  
      /**
       * timed poll with nonzero timeout times out if no active putter
       */
      public void testTimedPoll() {
<span class="line-modified">!         final boolean fair = randomBoolean();</span>
          final SynchronousQueue q = new SynchronousQueue(fair);
          final long startTime = System.nanoTime();
          try { assertNull(q.poll(timeoutMillis(), MILLISECONDS)); }
          catch (InterruptedException e) { threadUnexpectedException(e); }
          assertTrue(millisElapsedSince(startTime) &gt;= timeoutMillis());
</pre>
<hr />
<pre>
<span class="line-old-header">*** 283,11 ***</span>
      /**
       * timed poll before a delayed offer times out, returning null;
       * after offer succeeds; on interruption throws
       */
      public void testTimedPollWithOffer() {
<span class="line-modified">!         final boolean fair = ThreadLocalRandom.current().nextBoolean();</span>
          final SynchronousQueue q = new SynchronousQueue(fair);
          final CountDownLatch pleaseOffer = new CountDownLatch(1);
          final CountDownLatch pleaseInterrupt = new CountDownLatch(1);
          Thread t = newStartedThread(new CheckedRunnable() {
              public void realRun() throws InterruptedException {
<span class="line-new-header">--- 283,11 ---</span>
      /**
       * timed poll before a delayed offer times out, returning null;
       * after offer succeeds; on interruption throws
       */
      public void testTimedPollWithOffer() {
<span class="line-modified">!         final boolean fair = randomBoolean();</span>
          final SynchronousQueue q = new SynchronousQueue(fair);
          final CountDownLatch pleaseOffer = new CountDownLatch(1);
          final CountDownLatch pleaseInterrupt = new CountDownLatch(1);
          Thread t = newStartedThread(new CheckedRunnable() {
              public void realRun() throws InterruptedException {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 299,11 ***</span>
                  startTime = System.nanoTime();
                  assertSame(zero, q.poll(LONG_DELAY_MS, MILLISECONDS));
  
                  Thread.currentThread().interrupt();
                  try {
<span class="line-modified">!                     q.poll(LONG_DELAY_MS, MILLISECONDS);</span>
                      shouldThrow();
                  } catch (InterruptedException success) {}
                  assertFalse(Thread.interrupted());
  
                  pleaseInterrupt.countDown();
<span class="line-new-header">--- 299,11 ---</span>
                  startTime = System.nanoTime();
                  assertSame(zero, q.poll(LONG_DELAY_MS, MILLISECONDS));
  
                  Thread.currentThread().interrupt();
                  try {
<span class="line-modified">!                     q.poll(randomTimeout(), randomTimeUnit());</span>
                      shouldThrow();
                  } catch (InterruptedException success) {}
                  assertFalse(Thread.interrupted());
  
                  pleaseInterrupt.countDown();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 321,11 ***</span>
          try { assertTrue(q.offer(zero, LONG_DELAY_MS, MILLISECONDS)); }
          catch (InterruptedException e) { threadUnexpectedException(e); }
          assertTrue(millisElapsedSince(startTime) &lt; LONG_DELAY_MS);
  
          await(pleaseInterrupt);
<span class="line-modified">!         assertThreadBlocks(t, Thread.State.TIMED_WAITING);</span>
          t.interrupt();
          awaitTermination(t);
      }
  
      /**
<span class="line-new-header">--- 321,11 ---</span>
          try { assertTrue(q.offer(zero, LONG_DELAY_MS, MILLISECONDS)); }
          catch (InterruptedException e) { threadUnexpectedException(e); }
          assertTrue(millisElapsedSince(startTime) &lt; LONG_DELAY_MS);
  
          await(pleaseInterrupt);
<span class="line-modified">!         if (randomBoolean()) assertThreadBlocks(t, Thread.State.TIMED_WAITING);</span>
          t.interrupt();
          awaitTermination(t);
      }
  
      /**
</pre>
<center><a href="StampedLockTest.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="ThreadLocalRandom8Test.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>