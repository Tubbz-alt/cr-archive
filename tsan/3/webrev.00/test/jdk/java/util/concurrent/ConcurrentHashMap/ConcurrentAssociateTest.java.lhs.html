<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/jdk/java/util/concurrent/ConcurrentHashMap/ConcurrentAssociateTest.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 2013, 2016, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 import org.testng.annotations.Test;
 25 
 26 import java.lang.management.ManagementFactory;
 27 import java.lang.management.ThreadInfo;
 28 import java.lang.management.ThreadMXBean;
 29 import java.util.HashMap;
 30 import java.util.Map;
 31 import java.util.concurrent.CompletableFuture;
 32 import java.util.concurrent.ConcurrentHashMap;
 33 import java.util.concurrent.ConcurrentMap;
 34 import java.util.concurrent.CountDownLatch;
 35 import java.util.concurrent.ThreadLocalRandom;
 36 import java.util.concurrent.TimeUnit;
 37 import java.util.concurrent.TimeoutException;
 38 import java.util.function.BiConsumer;
 39 import java.util.function.Supplier;
 40 import java.util.stream.IntStream;
 41 import java.util.stream.Stream;
 42 
 43 /**
 44  * @test
 45  * @bug 8028564
 46  * @run testng/timeout=1200 ConcurrentAssociateTest
 47  * @summary Test that association operations, such as put and compute,
 48  * place entries in the map
 49  * @modules java.management
 50  */
 51 @Test
 52 public class ConcurrentAssociateTest {
 53 
 54     /** Maximum time (in seconds) to wait for a test method to complete. */
 55     private static final int TIMEOUT = Integer.getInteger(&quot;timeout&quot;, 200);
 56 
 57     /** The number of entries for each thread to place in a map. */
 58     private static final int N = Integer.getInteger(&quot;n&quot;, 128);
 59 
 60     /** The number of iterations of the test. */
 61     private static final int I = Integer.getInteger(&quot;i&quot;, 64);
 62 
 63     /** Objects to be placed in the concurrent map. */
 64     static class X {
 65         // Limit the hash code to trigger collisions
 66         final int hc = ThreadLocalRandom.current().nextInt(1, 9);
 67 
 68         public int hashCode() { return hc; }
 69     }
 70 
 71     @Test
 72     public void testPut() throws Throwable {
 73         test(&quot;CHM.put&quot;, (m, o) -&gt; m.put(o, o));
 74     }
 75 
 76     @Test
 77     public void testCompute() throws Throwable {
 78         test(&quot;CHM.compute&quot;, (m, o) -&gt; m.compute(o, (k, v) -&gt; o));
 79     }
 80 
 81     @Test
 82     public void testComputeIfAbsent() throws Throwable {
 83         test(&quot;CHM.computeIfAbsent&quot;, (m, o) -&gt; m.computeIfAbsent(o, (k) -&gt; o));
 84     }
 85 
 86     @Test
 87     public void testMerge() throws Throwable {
 88         test(&quot;CHM.merge&quot;, (m, o) -&gt; m.merge(o, o, (v1, v2) -&gt; v1));
 89     }
 90 
 91     @Test
 92     public void testPutAll() throws Throwable {
 93         test(&quot;CHM.putAll&quot;, (m, o) -&gt; {
 94             Map&lt;Object, Object&gt; hm = new HashMap&lt;&gt;();
 95             hm.put(o, o);
 96             m.putAll(hm);
 97         });
 98     }
 99 
100     private static void test(String desc, BiConsumer&lt;ConcurrentMap&lt;Object, Object&gt;, Object&gt; associator) throws Throwable {
101         for (int i = 0; i &lt; I; i++) {
102             testOnce(desc, associator);
103         }
104     }
105 
106     static class AssociationFailure extends RuntimeException {
107         AssociationFailure(String message) {
108             super(message);
109         }
110     }
111 
112     private static void testOnce(String desc, BiConsumer&lt;ConcurrentMap&lt;Object, Object&gt;, Object&gt; associator) throws Throwable {
113         ConcurrentHashMap&lt;Object, Object&gt; m = new ConcurrentHashMap&lt;&gt;();
114         CountDownLatch s = new CountDownLatch(1);
115 
116         Supplier&lt;Runnable&gt; sr = () -&gt; () -&gt; {
117             try {
118                 if (!s.await(TIMEOUT, TimeUnit.SECONDS)) {
119                     dumpTestThreads();
120                     throw new AssertionError(&quot;timed out&quot;);
121                 }
122             }
123             catch (InterruptedException e) {
124             }
125 
126             for (int i = 0; i &lt; N; i++) {
127                 Object o = new X();
128                 associator.accept(m, o);
129                 if (!m.containsKey(o)) {
130                     throw new AssociationFailure(desc + &quot; failed: entry does not exist&quot;);
131                 }
132             }
133         };
134 
135         // Bound concurrency to avoid degenerate performance
136         int ps = Math.min(Runtime.getRuntime().availableProcessors(), 8);
137         Stream&lt;CompletableFuture&gt; runners = IntStream.range(0, ps)
138                 .mapToObj(i -&gt; sr.get())
139                 .map(CompletableFuture::runAsync);
140 
141         CompletableFuture all = CompletableFuture.allOf(
142                 runners.toArray(CompletableFuture[]::new));
143 
144         // Trigger the runners to start associating
145         s.countDown();
146 
147         try {
148             all.get(TIMEOUT, TimeUnit.SECONDS);
149         } catch (TimeoutException e) {
150             dumpTestThreads();
151             throw e;
152         } catch (Throwable e) {
153             dumpTestThreads();
154             Throwable cause = e.getCause();
155             if (cause instanceof AssociationFailure) {
156                 throw cause;
157             }
158             throw e;
159         }
160     }
161 
162     /**
163      * A debugging tool to print stack traces of most threads, as jstack does.
164      * Uninteresting threads are filtered out.
165      */
166     static void dumpTestThreads() {
167         ThreadMXBean threadMXBean = ManagementFactory.getThreadMXBean();
168         System.err.println(&quot;------ stacktrace dump start ------&quot;);
169         for (ThreadInfo info : threadMXBean.dumpAllThreads(true, true)) {
<a name="1" id="anc1"></a><span class="line-modified">170             String name = info.getThreadName();</span>

171             if (&quot;Signal Dispatcher&quot;.equals(name))
172                 continue;
173             if (&quot;Reference Handler&quot;.equals(name)
<a name="2" id="anc2"></a><span class="line-modified">174                 &amp;&amp; info.getLockName().startsWith(&quot;java.lang.ref.Reference$Lock&quot;))</span>

175                 continue;
176             if (&quot;Finalizer&quot;.equals(name)
<a name="3" id="anc3"></a><span class="line-modified">177                 &amp;&amp; info.getLockName().startsWith(&quot;java.lang.ref.ReferenceQueue$Lock&quot;))</span>

178                 continue;
179             System.err.print(info);
180         }
181         System.err.println(&quot;------ stacktrace dump end ------&quot;);
182     }
183 }
<a name="4" id="anc4"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="4" type="hidden" />
</body>
</html>