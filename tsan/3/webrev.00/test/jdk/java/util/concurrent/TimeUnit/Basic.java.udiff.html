<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/jdk/java/util/concurrent/TimeUnit/Basic.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="../ScheduledThreadPoolExecutor/GCRetention.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../atomic/DoubleAdderDemo.java.udiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/util/concurrent/TimeUnit/Basic.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -22,10 +22,11 @@</span>
   */
  
  /* @test
   * @bug 5057341 6363898
   * @summary Basic tests for TimeUnit
<span class="udiff-line-added">+  * @library /test/lib</span>
   * @author Martin Buchholz
   */
  
  import static java.util.concurrent.TimeUnit.DAYS;
  import static java.util.concurrent.TimeUnit.HOURS;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -37,16 +38,24 @@</span>
  
  import java.io.ByteArrayInputStream;
  import java.io.ByteArrayOutputStream;
  import java.io.IOException;
  import java.io.InputStream;
<span class="udiff-line-added">+ import java.util.List;</span>
  import java.io.ObjectOutputStream;
  import java.io.ObjectInputStream;
  import java.util.Arrays;
<span class="udiff-line-added">+ import java.util.concurrent.CompletableFuture;</span>
<span class="udiff-line-added">+ import java.util.concurrent.ThreadLocalRandom;</span>
  import java.util.concurrent.TimeUnit;
<span class="udiff-line-added">+ import java.util.stream.Collectors;</span>
<span class="udiff-line-added">+ import java.util.stream.IntStream;</span>
<span class="udiff-line-added">+ import jdk.test.lib.Utils;</span>
  
  public class Basic {
<span class="udiff-line-added">+     static final long LONG_DELAY_MS = Utils.adjustTimeout(10_000);</span>
<span class="udiff-line-added">+ </span>
      private static void realMain(String[] args) throws Throwable {
  
          for (TimeUnit u : TimeUnit.values()) {
              System.out.println(u);
              check(u instanceof TimeUnit);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -69,22 +78,37 @@</span>
          equal(  60L, MINUTES.toSeconds(1));
          equal(1000L, SECONDS.toMillis(1));
          equal(1000L, MILLISECONDS.toMicros(1));
          equal(1000L, MICROSECONDS.toNanos(1));
  
<span class="udiff-line-modified-removed">-         long t0 = System.nanoTime();</span>
<span class="udiff-line-modified-removed">-         MILLISECONDS.sleep(3); /* See windows bug 6313903, might not sleep */</span>
<span class="udiff-line-modified-removed">-         long elapsedMillis = (System.nanoTime() - t0)/(1000L * 1000L);</span>
<span class="udiff-line-modified-removed">-         System.out.printf(&quot;elapsed=%d%n&quot;, elapsedMillis);</span>
<span class="udiff-line-modified-removed">-         check(elapsedMillis &gt;= 0);</span>
<span class="udiff-line-modified-removed">-         /* Might not sleep on windows: check(elapsedMillis &gt;= 3); */</span>
<span class="udiff-line-modified-removed">-         check(elapsedMillis &lt; 1000);</span>
<span class="udiff-line-modified-added">+         //----------------------------------------------------------------</span>
<span class="udiff-line-modified-added">+         // TimeUnit.sleep sleeps for at least the specified time.</span>
<span class="udiff-line-modified-added">+         // TimeUnit.sleep(x, unit) for x &lt;= 0 does not sleep at all.</span>
<span class="udiff-line-modified-added">+         //----------------------------------------------------------------</span>
<span class="udiff-line-modified-added">+         ThreadLocalRandom rnd = ThreadLocalRandom.current();</span>
<span class="udiff-line-modified-added">+         int maxTimeoutMillis = rnd.nextInt(1, 12);</span>
<span class="udiff-line-modified-added">+         List&lt;CompletableFuture&lt;?&gt;&gt; workers =</span>
<span class="udiff-line-added">+             IntStream.range(-1, maxTimeoutMillis + 1)</span>
<span class="udiff-line-added">+             .mapToObj(timeoutMillis -&gt; (Runnable) () -&gt; {</span>
<span class="udiff-line-added">+                 try {</span>
<span class="udiff-line-added">+                     long startTime = System.nanoTime();</span>
<span class="udiff-line-added">+                     MILLISECONDS.sleep(timeoutMillis);</span>
<span class="udiff-line-added">+                     long elapsedNanos = System.nanoTime() - startTime;</span>
<span class="udiff-line-added">+                     long timeoutNanos = MILLISECONDS.toNanos(timeoutMillis);</span>
<span class="udiff-line-added">+                     check(elapsedNanos &gt;= timeoutNanos);</span>
<span class="udiff-line-added">+                 } catch (InterruptedException fail) {</span>
<span class="udiff-line-added">+                     throw new AssertionError(fail);</span>
<span class="udiff-line-added">+                 }})</span>
<span class="udiff-line-added">+             .map(CompletableFuture::runAsync)</span>
<span class="udiff-line-added">+             .collect(Collectors.toList());</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         workers.forEach(CompletableFuture&lt;?&gt;::join);</span>
  
          //----------------------------------------------------------------
          // Tests for serialized form compatibility with previous release
          //----------------------------------------------------------------
<span class="udiff-line-modified-removed">-         byte[] serializedForm = /* Generated using tiger */</span>
<span class="udiff-line-modified-added">+         byte[] serializedForm = /* Generated using JDK 5 */</span>
              {-84, -19, 0, 5, &#39;~&#39;, &#39;r&#39;, 0, 29, &#39;j&#39;, &#39;a&#39;, &#39;v&#39;, &#39;a&#39;, &#39;.&#39;,
               &#39;u&#39;, &#39;t&#39;, &#39;i&#39;, &#39;l&#39;, &#39;.&#39;, &#39;c&#39;, &#39;o&#39;, &#39;n&#39;, &#39;c&#39;, &#39;u&#39;, &#39;r&#39;, &#39;r&#39;, &#39;e&#39;,
               &#39;n&#39;, &#39;t&#39;, &#39;.&#39;, &#39;T&#39;, &#39;i&#39;, &#39;m&#39;, &#39;e&#39;, &#39;U&#39;, &#39;n&#39;, &#39;i&#39;, &#39;t&#39;, 0, 0,
               0, 0, 0, 0, 0, 0, 18, 0, 0, &#39;x&#39;, &#39;r&#39;, 0, 14,
               &#39;j&#39;, &#39;a&#39;, &#39;v&#39;, &#39;a&#39;, &#39;.&#39;, &#39;l&#39;, &#39;a&#39;, &#39;n&#39;, &#39;g&#39;, &#39;.&#39;, &#39;E&#39;, &#39;n&#39;, &#39;u&#39;,
</pre>
<center><a href="../ScheduledThreadPoolExecutor/GCRetention.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../atomic/DoubleAdderDemo.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>