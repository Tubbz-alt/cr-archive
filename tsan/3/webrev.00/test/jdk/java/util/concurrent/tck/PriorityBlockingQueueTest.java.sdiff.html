<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/java/util/concurrent/tck/PriorityBlockingQueueTest.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="PhaserTest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="ReentrantLockTest.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/util/concurrent/tck/PriorityBlockingQueueTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
329     }
330 
331     /**
332      * put doesn&#39;t block waiting for take
333      */
334     public void testPutWithTake() throws InterruptedException {
335         final PriorityBlockingQueue q = new PriorityBlockingQueue(2);
336         final int size = 4;
337         Thread t = newStartedThread(new CheckedRunnable() {
338             public void realRun() {
339                 for (int i = 0; i &lt; size; i++)
340                     q.put(new Integer(0));
341             }});
342 
343         awaitTermination(t);
344         assertEquals(size, q.size());
345         q.take();
346     }
347 
348     /**
<span class="line-modified">349      * timed offer does not time out</span>
350      */
351     public void testTimedOffer() {
352         final PriorityBlockingQueue q = new PriorityBlockingQueue(2);
353         Thread t = newStartedThread(new CheckedRunnable() {
354             public void realRun() {
355                 q.put(new Integer(0));
356                 q.put(new Integer(0));
357                 assertTrue(q.offer(new Integer(0), SHORT_DELAY_MS, MILLISECONDS));
358                 assertTrue(q.offer(new Integer(0), LONG_DELAY_MS, MILLISECONDS));
359             }});
360 
361         awaitTermination(t);
362     }
363 
364     /**
365      * take retrieves elements in priority order
366      */
367     public void testTake() throws InterruptedException {
368         PriorityBlockingQueue q = populatedQueue(SIZE);
369         for (int i = 0; i &lt; SIZE; ++i) {
</pre>
<hr />
<pre>
380         Thread t = newStartedThread(new CheckedRunnable() {
381             public void realRun() throws InterruptedException {
382                 for (int i = 0; i &lt; SIZE; i++) assertEquals(i, q.take());
383 
384                 Thread.currentThread().interrupt();
385                 try {
386                     q.take();
387                     shouldThrow();
388                 } catch (InterruptedException success) {}
389                 assertFalse(Thread.interrupted());
390 
391                 pleaseInterrupt.countDown();
392                 try {
393                     q.take();
394                     shouldThrow();
395                 } catch (InterruptedException success) {}
396                 assertFalse(Thread.interrupted());
397             }});
398 
399         await(pleaseInterrupt);
<span class="line-modified">400         assertThreadBlocks(t, Thread.State.WAITING);</span>
401         t.interrupt();
402         awaitTermination(t);
403     }
404 
405     /**
406      * poll succeeds unless empty
407      */
408     public void testPoll() {
409         PriorityBlockingQueue q = populatedQueue(SIZE);
410         for (int i = 0; i &lt; SIZE; ++i) {
411             assertEquals(i, q.poll());
412         }
413         assertNull(q.poll());
414     }
415 
416     /**
417      * timed poll with zero timeout succeeds when non-empty, else times out
418      */
419     public void testTimedPoll0() throws InterruptedException {
420         PriorityBlockingQueue q = populatedQueue(SIZE);
</pre>
<hr />
<pre>
432         for (int i = 0; i &lt; SIZE; ++i) {
433             long startTime = System.nanoTime();
434             assertEquals(i, (int) q.poll(LONG_DELAY_MS, MILLISECONDS));
435             assertTrue(millisElapsedSince(startTime) &lt; LONG_DELAY_MS);
436         }
437         long startTime = System.nanoTime();
438         assertNull(q.poll(timeoutMillis(), MILLISECONDS));
439         assertTrue(millisElapsedSince(startTime) &gt;= timeoutMillis());
440         checkEmpty(q);
441     }
442 
443     /**
444      * Interrupted timed poll throws InterruptedException instead of
445      * returning timeout status
446      */
447     public void testInterruptedTimedPoll() throws InterruptedException {
448         final BlockingQueue&lt;Integer&gt; q = populatedQueue(SIZE);
449         final CountDownLatch pleaseInterrupt = new CountDownLatch(1);
450         Thread t = newStartedThread(new CheckedRunnable() {
451             public void realRun() throws InterruptedException {
<span class="line-removed">452                 long startTime = System.nanoTime();</span>
453                 for (int i = 0; i &lt; SIZE; i++)
454                     assertEquals(i, (int) q.poll(LONG_DELAY_MS, MILLISECONDS));
455 
456                 Thread.currentThread().interrupt();
457                 try {
<span class="line-modified">458                     q.poll(LONG_DELAY_MS, MILLISECONDS);</span>
459                     shouldThrow();
460                 } catch (InterruptedException success) {}
461                 assertFalse(Thread.interrupted());
462 
463                 pleaseInterrupt.countDown();
464                 try {
<span class="line-modified">465                     q.poll(LONG_DELAY_MS, MILLISECONDS);</span>
466                     shouldThrow();
467                 } catch (InterruptedException success) {}
468                 assertFalse(Thread.interrupted());
<span class="line-removed">469 </span>
<span class="line-removed">470                 assertTrue(millisElapsedSince(startTime) &lt; LONG_DELAY_MS);</span>
471             }});
472 
473         await(pleaseInterrupt);
<span class="line-modified">474         assertThreadBlocks(t, Thread.State.TIMED_WAITING);</span>
475         t.interrupt();
476         awaitTermination(t);
477     }
478 
479     /**
480      * peek returns next element, or null if empty
481      */
482     public void testPeek() {
483         PriorityBlockingQueue q = populatedQueue(SIZE);
484         for (int i = 0; i &lt; SIZE; ++i) {
485             assertEquals(i, q.peek());
486             assertEquals(i, q.poll());
487             assertTrue(q.peek() == null ||
488                        !q.peek().equals(i));
489         }
490         assertNull(q.peek());
491     }
492 
493     /**
494      * element returns next element, or throws NSEE if empty
</pre>
</td>
<td>
<hr />
<pre>
329     }
330 
331     /**
332      * put doesn&#39;t block waiting for take
333      */
334     public void testPutWithTake() throws InterruptedException {
335         final PriorityBlockingQueue q = new PriorityBlockingQueue(2);
336         final int size = 4;
337         Thread t = newStartedThread(new CheckedRunnable() {
338             public void realRun() {
339                 for (int i = 0; i &lt; size; i++)
340                     q.put(new Integer(0));
341             }});
342 
343         awaitTermination(t);
344         assertEquals(size, q.size());
345         q.take();
346     }
347 
348     /**
<span class="line-modified">349      * Queue is unbounded, so timed offer never times out</span>
350      */
351     public void testTimedOffer() {
352         final PriorityBlockingQueue q = new PriorityBlockingQueue(2);
353         Thread t = newStartedThread(new CheckedRunnable() {
354             public void realRun() {
355                 q.put(new Integer(0));
356                 q.put(new Integer(0));
357                 assertTrue(q.offer(new Integer(0), SHORT_DELAY_MS, MILLISECONDS));
358                 assertTrue(q.offer(new Integer(0), LONG_DELAY_MS, MILLISECONDS));
359             }});
360 
361         awaitTermination(t);
362     }
363 
364     /**
365      * take retrieves elements in priority order
366      */
367     public void testTake() throws InterruptedException {
368         PriorityBlockingQueue q = populatedQueue(SIZE);
369         for (int i = 0; i &lt; SIZE; ++i) {
</pre>
<hr />
<pre>
380         Thread t = newStartedThread(new CheckedRunnable() {
381             public void realRun() throws InterruptedException {
382                 for (int i = 0; i &lt; SIZE; i++) assertEquals(i, q.take());
383 
384                 Thread.currentThread().interrupt();
385                 try {
386                     q.take();
387                     shouldThrow();
388                 } catch (InterruptedException success) {}
389                 assertFalse(Thread.interrupted());
390 
391                 pleaseInterrupt.countDown();
392                 try {
393                     q.take();
394                     shouldThrow();
395                 } catch (InterruptedException success) {}
396                 assertFalse(Thread.interrupted());
397             }});
398 
399         await(pleaseInterrupt);
<span class="line-modified">400         if (randomBoolean()) assertThreadBlocks(t, Thread.State.WAITING);</span>
401         t.interrupt();
402         awaitTermination(t);
403     }
404 
405     /**
406      * poll succeeds unless empty
407      */
408     public void testPoll() {
409         PriorityBlockingQueue q = populatedQueue(SIZE);
410         for (int i = 0; i &lt; SIZE; ++i) {
411             assertEquals(i, q.poll());
412         }
413         assertNull(q.poll());
414     }
415 
416     /**
417      * timed poll with zero timeout succeeds when non-empty, else times out
418      */
419     public void testTimedPoll0() throws InterruptedException {
420         PriorityBlockingQueue q = populatedQueue(SIZE);
</pre>
<hr />
<pre>
432         for (int i = 0; i &lt; SIZE; ++i) {
433             long startTime = System.nanoTime();
434             assertEquals(i, (int) q.poll(LONG_DELAY_MS, MILLISECONDS));
435             assertTrue(millisElapsedSince(startTime) &lt; LONG_DELAY_MS);
436         }
437         long startTime = System.nanoTime();
438         assertNull(q.poll(timeoutMillis(), MILLISECONDS));
439         assertTrue(millisElapsedSince(startTime) &gt;= timeoutMillis());
440         checkEmpty(q);
441     }
442 
443     /**
444      * Interrupted timed poll throws InterruptedException instead of
445      * returning timeout status
446      */
447     public void testInterruptedTimedPoll() throws InterruptedException {
448         final BlockingQueue&lt;Integer&gt; q = populatedQueue(SIZE);
449         final CountDownLatch pleaseInterrupt = new CountDownLatch(1);
450         Thread t = newStartedThread(new CheckedRunnable() {
451             public void realRun() throws InterruptedException {

452                 for (int i = 0; i &lt; SIZE; i++)
453                     assertEquals(i, (int) q.poll(LONG_DELAY_MS, MILLISECONDS));
454 
455                 Thread.currentThread().interrupt();
456                 try {
<span class="line-modified">457                     q.poll(randomTimeout(), randomTimeUnit());</span>
458                     shouldThrow();
459                 } catch (InterruptedException success) {}
460                 assertFalse(Thread.interrupted());
461 
462                 pleaseInterrupt.countDown();
463                 try {
<span class="line-modified">464                     q.poll(LONGER_DELAY_MS, MILLISECONDS);</span>
465                     shouldThrow();
466                 } catch (InterruptedException success) {}
467                 assertFalse(Thread.interrupted());


468             }});
469 
470         await(pleaseInterrupt);
<span class="line-modified">471         if (randomBoolean()) assertThreadBlocks(t, Thread.State.TIMED_WAITING);</span>
472         t.interrupt();
473         awaitTermination(t);
474     }
475 
476     /**
477      * peek returns next element, or null if empty
478      */
479     public void testPeek() {
480         PriorityBlockingQueue q = populatedQueue(SIZE);
481         for (int i = 0; i &lt; SIZE; ++i) {
482             assertEquals(i, q.peek());
483             assertEquals(i, q.poll());
484             assertTrue(q.peek() == null ||
485                        !q.peek().equals(i));
486         }
487         assertNull(q.peek());
488     }
489 
490     /**
491      * element returns next element, or throws NSEE if empty
</pre>
</td>
</tr>
</table>
<center><a href="PhaserTest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="ReentrantLockTest.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>