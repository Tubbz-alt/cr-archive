<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff test/jdk/java/util/concurrent/tck/CountDownLatchTest.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="ConcurrentSkipListMapTest.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="CyclicBarrierTest.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/util/concurrent/tck/CountDownLatchTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 34,10 ***</span>
<span class="line-new-header">--- 34,11 ---</span>
   */
  
  import static java.util.concurrent.TimeUnit.MILLISECONDS;
  
  import java.util.concurrent.CountDownLatch;
<span class="line-added">+ import java.util.concurrent.ThreadLocalRandom;</span>
  
  import junit.framework.Test;
  import junit.framework.TestSuite;
  
  public class CountDownLatchTest extends JSR166TestCase {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 97,11 ***</span>
  
          await(pleaseCountDown);
          assertEquals(2, l.getCount());
          l.countDown();
          assertEquals(1, l.getCount());
<span class="line-modified">!         assertThreadBlocks(t, Thread.State.WAITING);</span>
          l.countDown();
          assertEquals(0, l.getCount());
          awaitTermination(t);
      }
  
<span class="line-new-header">--- 98,11 ---</span>
  
          await(pleaseCountDown);
          assertEquals(2, l.getCount());
          l.countDown();
          assertEquals(1, l.getCount());
<span class="line-modified">!         if (randomBoolean()) assertThreadBlocks(t, Thread.State.WAITING);</span>
          l.countDown();
          assertEquals(0, l.getCount());
          awaitTermination(t);
      }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 122,11 ***</span>
  
          await(pleaseCountDown);
          assertEquals(2, l.getCount());
          l.countDown();
          assertEquals(1, l.getCount());
<span class="line-modified">!         assertThreadBlocks(t, Thread.State.TIMED_WAITING);</span>
          l.countDown();
          assertEquals(0, l.getCount());
          awaitTermination(t);
      }
  
<span class="line-new-header">--- 123,11 ---</span>
  
          await(pleaseCountDown);
          assertEquals(2, l.getCount());
          l.countDown();
          assertEquals(1, l.getCount());
<span class="line-modified">!         if (randomBoolean()) assertThreadBlocks(t, Thread.State.TIMED_WAITING);</span>
          l.countDown();
          assertEquals(0, l.getCount());
          awaitTermination(t);
      }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 154,42 ***</span>
  
                  assertEquals(1, l.getCount());
              }});
  
          await(pleaseInterrupt);
<span class="line-modified">!         assertThreadBlocks(t, Thread.State.WAITING);</span>
          t.interrupt();
          awaitTermination(t);
      }
  
      /**
       * timed await throws InterruptedException if interrupted before counted down
       */
      public void testTimedAwait_Interruptible() {
<span class="line-modified">!         final CountDownLatch l = new CountDownLatch(1);</span>
          final CountDownLatch pleaseInterrupt = new CountDownLatch(1);
          Thread t = newStartedThread(new CheckedRunnable() {
              public void realRun() throws InterruptedException {
                  Thread.currentThread().interrupt();
                  try {
<span class="line-modified">!                     l.await(LONG_DELAY_MS, MILLISECONDS);</span>
                      shouldThrow();
                  } catch (InterruptedException success) {}
                  assertFalse(Thread.interrupted());
  
                  pleaseInterrupt.countDown();
                  try {
<span class="line-modified">!                     l.await(LONG_DELAY_MS, MILLISECONDS);</span>
                      shouldThrow();
                  } catch (InterruptedException success) {}
                  assertFalse(Thread.interrupted());
  
<span class="line-modified">!                 assertEquals(1, l.getCount());</span>
              }});
  
          await(pleaseInterrupt);
<span class="line-modified">!         assertThreadBlocks(t, Thread.State.TIMED_WAITING);</span>
          t.interrupt();
          awaitTermination(t);
      }
  
      /**
<span class="line-new-header">--- 155,43 ---</span>
  
                  assertEquals(1, l.getCount());
              }});
  
          await(pleaseInterrupt);
<span class="line-modified">!         if (randomBoolean()) assertThreadBlocks(t, Thread.State.WAITING);</span>
          t.interrupt();
          awaitTermination(t);
      }
  
      /**
       * timed await throws InterruptedException if interrupted before counted down
       */
      public void testTimedAwait_Interruptible() {
<span class="line-modified">!         final int initialCount = ThreadLocalRandom.current().nextInt(1, 3);</span>
<span class="line-added">+         final CountDownLatch l = new CountDownLatch(initialCount);</span>
          final CountDownLatch pleaseInterrupt = new CountDownLatch(1);
          Thread t = newStartedThread(new CheckedRunnable() {
              public void realRun() throws InterruptedException {
                  Thread.currentThread().interrupt();
                  try {
<span class="line-modified">!                     l.await(randomTimeout(), randomTimeUnit());</span>
                      shouldThrow();
                  } catch (InterruptedException success) {}
                  assertFalse(Thread.interrupted());
  
                  pleaseInterrupt.countDown();
                  try {
<span class="line-modified">!                     l.await(LONGER_DELAY_MS, MILLISECONDS);</span>
                      shouldThrow();
                  } catch (InterruptedException success) {}
                  assertFalse(Thread.interrupted());
  
<span class="line-modified">!                 assertEquals(initialCount, l.getCount());</span>
              }});
  
          await(pleaseInterrupt);
<span class="line-modified">!         if (randomBoolean()) assertThreadBlocks(t, Thread.State.TIMED_WAITING);</span>
          t.interrupt();
          awaitTermination(t);
      }
  
      /**
</pre>
<hr />
<pre>
<span class="line-old-header">*** 198,11 ***</span>
<span class="line-new-header">--- 200,15 ---</span>
      public void testAwaitTimeout() throws InterruptedException {
          final CountDownLatch l = new CountDownLatch(1);
          Thread t = newStartedThread(new CheckedRunnable() {
              public void realRun() throws InterruptedException {
                  assertEquals(1, l.getCount());
<span class="line-added">+ </span>
<span class="line-added">+                 long startTime = System.nanoTime();</span>
                  assertFalse(l.await(timeoutMillis(), MILLISECONDS));
<span class="line-added">+                 assertTrue(millisElapsedSince(startTime) &gt;= timeoutMillis());</span>
<span class="line-added">+ </span>
                  assertEquals(1, l.getCount());
              }});
  
          awaitTermination(t);
          assertEquals(1, l.getCount());
</pre>
<center><a href="ConcurrentSkipListMapTest.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="CyclicBarrierTest.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>