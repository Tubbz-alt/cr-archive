<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/jdk/java/util/concurrent/locks/Lock/FlakyMutex.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="CheckedLockLoops.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="TimedAcquireLeak.java.udiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/util/concurrent/locks/Lock/FlakyMutex.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -47,35 +47,55 @@</span>
      static class MyError extends Error {}
      static class MyException extends Exception {}
      static class MyRuntimeException extends RuntimeException {}
  
      static void checkThrowable(Throwable t) {
<span class="udiff-line-modified-removed">-         check((t instanceof MyError) ||</span>
<span class="udiff-line-modified-added">+         if (!((t instanceof MyError) ||</span>
                (t instanceof MyException) ||
<span class="udiff-line-modified-removed">-               (t instanceof MyRuntimeException));</span>
<span class="udiff-line-modified-added">+               (t instanceof MyRuntimeException)))</span>
<span class="udiff-line-added">+             unexpected(t);</span>
      }
  
      static void realMain(String[] args) throws Throwable {
<span class="udiff-line-modified-removed">-         final int nThreads = 3;</span>
<span class="udiff-line-modified-added">+         final ThreadLocalRandom rndMain = ThreadLocalRandom.current();</span>
<span class="udiff-line-added">+         final int nCpus = Runtime.getRuntime().availableProcessors();</span>
<span class="udiff-line-added">+         final int maxThreads = Math.min(4, nCpus);</span>
<span class="udiff-line-added">+         final int nThreads = rndMain.nextInt(1, maxThreads + 1);</span>
          final int iterations = 10_000;
          final CyclicBarrier startingGate = new CyclicBarrier(nThreads);
<span class="udiff-line-removed">-         final FlakyMutex mutex = new FlakyMutex();</span>
          final ExecutorService es = Executors.newFixedThreadPool(nThreads);
<span class="udiff-line-added">+         final FlakyMutex mutex = new FlakyMutex();</span>
          final Runnable task = () -&gt; {
              try {
<span class="udiff-line-added">+                 ThreadLocalRandom rnd = ThreadLocalRandom.current();</span>
                  startingGate.await();
                  for (int i = 0; i &lt; iterations; i++) {
                      for (;;) {
<span class="udiff-line-modified-removed">-                         try { mutex.lock(); break; }</span>
<span class="udiff-line-modified-removed">-                         catch (Throwable t) { checkThrowable(t); }</span>
<span class="udiff-line-modified-added">+                         try {</span>
<span class="udiff-line-modified-added">+                             if (rnd.nextBoolean())</span>
<span class="udiff-line-added">+                                 mutex.lock();</span>
<span class="udiff-line-added">+                             else</span>
<span class="udiff-line-added">+                                 mutex.lockInterruptibly();</span>
<span class="udiff-line-added">+                             break;</span>
<span class="udiff-line-added">+                         } catch (Throwable t) { checkThrowable(t); }</span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+                     if (rnd.nextBoolean()) {</span>
<span class="udiff-line-added">+                         try {</span>
<span class="udiff-line-added">+                             check(! mutex.tryLock());</span>
<span class="udiff-line-added">+                         } catch (Throwable t) { checkThrowable(t); }</span>
                      }
  
<span class="udiff-line-modified-removed">-                     try { check(! mutex.tryLock()); }</span>
<span class="udiff-line-modified-removed">-                     catch (Throwable t) { checkThrowable(t); }</span>
<span class="udiff-line-modified-added">+                     if (rnd.nextInt(10) == 0) {</span>
<span class="udiff-line-modified-added">+                         try {</span>
<span class="udiff-line-added">+                             check(! mutex.tryLock(1, TimeUnit.MICROSECONDS));</span>
<span class="udiff-line-added">+                         } catch (Throwable t) { checkThrowable(t); }</span>
<span class="udiff-line-added">+                     }</span>
  
<span class="udiff-line-modified-removed">-                     try { check(! mutex.tryLock(1, TimeUnit.MICROSECONDS)); }</span>
<span class="udiff-line-modified-removed">-                     catch (Throwable t) { checkThrowable(t); }</span>
<span class="udiff-line-modified-added">+                     if (rnd.nextBoolean()) {</span>
<span class="udiff-line-modified-added">+                         check(mutex.isLocked());</span>
<span class="udiff-line-added">+                     }</span>
  
                      mutex.unlock();
                  }
              } catch (Throwable t) { unexpected(t); }
          };
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -144,11 +164,15 @@</span>
      static void check(boolean cond) {if (cond) pass(); else fail();}
      static void equal(Object x, Object y) {
          if (x == null ? y == null : x.equals(y)) pass();
          else fail(x + &quot; not equal to &quot; + y);}
      public static void main(String[] args) throws Throwable {
<span class="udiff-line-modified-removed">-         try {realMain(args);} catch (Throwable t) {unexpected(t);}</span>
<span class="udiff-line-modified-added">+         int runsPerTest = Integer.getInteger(&quot;jsr166.runsPerTest&quot;, 1);</span>
<span class="udiff-line-added">+         try {</span>
<span class="udiff-line-added">+             for (int i = runsPerTest; i--&gt; 0; )</span>
<span class="udiff-line-added">+                 realMain(args);</span>
<span class="udiff-line-added">+         } catch (Throwable t) { unexpected(t); }</span>
          System.out.printf(&quot;%nPassed = %d, failed = %d%n%n&quot;, passed, failed);
          if (failed &gt; 0) throw new AssertionError(&quot;Some tests failed&quot;);}
      @SuppressWarnings(&quot;unchecked&quot;)
      static &lt;T extends Throwable&gt; void uncheckedThrow(Throwable t) throws T {
          throw (T)t; // rely on vacuous cast
</pre>
<center><a href="CheckedLockLoops.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="TimedAcquireLeak.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>