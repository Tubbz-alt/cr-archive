<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/java/util/concurrent/tck/LinkedTransferQueueTest.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="LinkedHashMapTest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="LongAccumulatorTest.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/util/concurrent/tck/LinkedTransferQueueTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 237         Thread t = newStartedThread(new CheckedRunnable() {
 238             public void realRun() throws InterruptedException {
 239                 for (int i = 0; i &lt; SIZE; i++) assertEquals(i, q.take());
 240 
 241                 Thread.currentThread().interrupt();
 242                 try {
 243                     q.take();
 244                     shouldThrow();
 245                 } catch (InterruptedException success) {}
 246                 assertFalse(Thread.interrupted());
 247 
 248                 pleaseInterrupt.countDown();
 249                 try {
 250                     q.take();
 251                     shouldThrow();
 252                 } catch (InterruptedException success) {}
 253                 assertFalse(Thread.interrupted());
 254             }});
 255 
 256         await(pleaseInterrupt);
<span class="line-modified"> 257         assertThreadBlocks(t, Thread.State.WAITING);</span>
 258         t.interrupt();
 259         awaitTermination(t);
 260     }
 261 
 262     /**
 263      * poll succeeds unless empty
 264      */
 265     public void testPoll() throws InterruptedException {
 266         LinkedTransferQueue&lt;Integer&gt; q = populatedQueue(SIZE);
 267         for (int i = 0; i &lt; SIZE; ++i) {
 268             assertEquals(i, (int) q.poll());
 269         }
 270         assertNull(q.poll());
 271         checkEmpty(q);
 272     }
 273 
 274     /**
 275      * timed poll with zero timeout succeeds when non-empty, else times out
 276      */
 277     public void testTimedPoll0() throws InterruptedException {
</pre>
<hr />
<pre>
 291         long startTime = System.nanoTime();
 292         for (int i = 0; i &lt; SIZE; ++i)
 293             assertEquals(i, (int) q.poll(LONG_DELAY_MS, MILLISECONDS));
 294         assertTrue(millisElapsedSince(startTime) &lt; LONG_DELAY_MS);
 295 
 296         startTime = System.nanoTime();
 297         assertNull(q.poll(timeoutMillis(), MILLISECONDS));
 298         assertTrue(millisElapsedSince(startTime) &gt;= timeoutMillis());
 299         checkEmpty(q);
 300     }
 301 
 302     /**
 303      * Interrupted timed poll throws InterruptedException instead of
 304      * returning timeout status
 305      */
 306     public void testInterruptedTimedPoll() throws InterruptedException {
 307         final BlockingQueue&lt;Integer&gt; q = populatedQueue(SIZE);
 308         final CountDownLatch pleaseInterrupt = new CountDownLatch(1);
 309         Thread t = newStartedThread(new CheckedRunnable() {
 310             public void realRun() throws InterruptedException {
<span class="line-removed"> 311                 long startTime = System.nanoTime();</span>
 312                 for (int i = 0; i &lt; SIZE; i++)
 313                     assertEquals(i, (int) q.poll(LONG_DELAY_MS, MILLISECONDS));
 314 
 315                 Thread.currentThread().interrupt();
 316                 try {
<span class="line-modified"> 317                     q.poll(LONG_DELAY_MS, MILLISECONDS);</span>
 318                     shouldThrow();
 319                 } catch (InterruptedException success) {}
 320                 assertFalse(Thread.interrupted());
 321 
 322                 pleaseInterrupt.countDown();
 323                 try {
<span class="line-modified"> 324                     q.poll(LONG_DELAY_MS, MILLISECONDS);</span>
 325                     shouldThrow();
 326                 } catch (InterruptedException success) {}
 327                 assertFalse(Thread.interrupted());
<span class="line-removed"> 328 </span>
<span class="line-removed"> 329                 assertTrue(millisElapsedSince(startTime) &lt; LONG_DELAY_MS);</span>
 330             }});
 331 
 332         await(pleaseInterrupt);
<span class="line-modified"> 333         assertThreadBlocks(t, Thread.State.TIMED_WAITING);</span>
 334         t.interrupt();
 335         awaitTermination(t);
 336         checkEmpty(q);
 337     }
 338 
 339     /**
 340      * timed poll after thread interrupted throws InterruptedException
 341      * instead of returning timeout status
 342      */
 343     public void testTimedPollAfterInterrupt() throws InterruptedException {
 344         final BlockingQueue&lt;Integer&gt; q = populatedQueue(SIZE);
 345         Thread t = newStartedThread(new CheckedRunnable() {
 346             public void realRun() throws InterruptedException {
<span class="line-removed"> 347                 long startTime = System.nanoTime();</span>
 348                 Thread.currentThread().interrupt();
 349                 for (int i = 0; i &lt; SIZE; ++i)
<span class="line-modified"> 350                     assertEquals(i, (int) q.poll(LONG_DELAY_MS, MILLISECONDS));</span>
 351                 try {
<span class="line-modified"> 352                     q.poll(LONG_DELAY_MS, MILLISECONDS);</span>
 353                     shouldThrow();
 354                 } catch (InterruptedException success) {}
 355                 assertFalse(Thread.interrupted());
<span class="line-removed"> 356                 assertTrue(millisElapsedSince(startTime) &lt; LONG_DELAY_MS);</span>
 357             }});
 358 
 359         awaitTermination(t);
 360         checkEmpty(q);
 361     }
 362 
 363     /**
 364      * peek returns next element, or null if empty
 365      */
 366     public void testPeek() throws InterruptedException {
 367         LinkedTransferQueue&lt;Integer&gt; q = populatedQueue(SIZE);
 368         for (int i = 0; i &lt; SIZE; ++i) {
 369             assertEquals(i, (int) q.peek());
 370             assertEquals(i, (int) q.poll());
 371             assertTrue(q.peek() == null ||
 372                        i != (int) q.peek());
 373         }
 374         assertNull(q.peek());
 375         checkEmpty(q);
 376     }
</pre>
<hr />
<pre>
 965                 assertTrue(q.hasWaitingConsumer());
 966                 checkEmpty(q);
 967                 assertTrue(q.tryTransfer(hotPotato));
 968             }});
 969 
 970         assertSame(q.take(), hotPotato);
 971         checkEmpty(q);
 972         awaitTermination(t);
 973     }
 974 
 975     /**
 976      * tryTransfer blocks interruptibly if no takers
 977      */
 978     public void testTryTransfer5() throws InterruptedException {
 979         final LinkedTransferQueue q = new LinkedTransferQueue();
 980         final CountDownLatch pleaseInterrupt = new CountDownLatch(1);
 981         assertTrue(q.isEmpty());
 982 
 983         Thread t = newStartedThread(new CheckedRunnable() {
 984             public void realRun() throws InterruptedException {
<span class="line-removed"> 985                 long startTime = System.nanoTime();</span>
 986                 Thread.currentThread().interrupt();
 987                 try {
<span class="line-modified"> 988                     q.tryTransfer(new Object(), LONG_DELAY_MS, MILLISECONDS);</span>
 989                     shouldThrow();
 990                 } catch (InterruptedException success) {}
 991                 assertFalse(Thread.interrupted());
 992 
 993                 pleaseInterrupt.countDown();
 994                 try {
<span class="line-modified"> 995                     q.tryTransfer(new Object(), LONG_DELAY_MS, MILLISECONDS);</span>
 996                     shouldThrow();
 997                 } catch (InterruptedException success) {}
 998                 assertFalse(Thread.interrupted());
<span class="line-removed"> 999                 assertTrue(millisElapsedSince(startTime) &lt; LONG_DELAY_MS);</span>
1000             }});
1001 
1002         await(pleaseInterrupt);
<span class="line-modified">1003         assertThreadBlocks(t, Thread.State.TIMED_WAITING);</span>
1004         t.interrupt();
1005         awaitTermination(t);
1006         checkEmpty(q);
1007     }
1008 
1009     /**
1010      * tryTransfer gives up after the timeout and returns false
1011      */
1012     public void testTryTransfer6() throws InterruptedException {
1013         final LinkedTransferQueue q = new LinkedTransferQueue();
1014 
1015         Thread t = newStartedThread(new CheckedRunnable() {
1016             public void realRun() throws InterruptedException {
1017                 long startTime = System.nanoTime();
1018                 assertFalse(q.tryTransfer(new Object(),
1019                                           timeoutMillis(), MILLISECONDS));
1020                 assertTrue(millisElapsedSince(startTime) &gt;= timeoutMillis());
1021                 checkEmpty(q);
1022             }});
1023 
</pre>
</td>
<td>
<hr />
<pre>
 237         Thread t = newStartedThread(new CheckedRunnable() {
 238             public void realRun() throws InterruptedException {
 239                 for (int i = 0; i &lt; SIZE; i++) assertEquals(i, q.take());
 240 
 241                 Thread.currentThread().interrupt();
 242                 try {
 243                     q.take();
 244                     shouldThrow();
 245                 } catch (InterruptedException success) {}
 246                 assertFalse(Thread.interrupted());
 247 
 248                 pleaseInterrupt.countDown();
 249                 try {
 250                     q.take();
 251                     shouldThrow();
 252                 } catch (InterruptedException success) {}
 253                 assertFalse(Thread.interrupted());
 254             }});
 255 
 256         await(pleaseInterrupt);
<span class="line-modified"> 257         if (randomBoolean()) assertThreadBlocks(t, Thread.State.WAITING);</span>
 258         t.interrupt();
 259         awaitTermination(t);
 260     }
 261 
 262     /**
 263      * poll succeeds unless empty
 264      */
 265     public void testPoll() throws InterruptedException {
 266         LinkedTransferQueue&lt;Integer&gt; q = populatedQueue(SIZE);
 267         for (int i = 0; i &lt; SIZE; ++i) {
 268             assertEquals(i, (int) q.poll());
 269         }
 270         assertNull(q.poll());
 271         checkEmpty(q);
 272     }
 273 
 274     /**
 275      * timed poll with zero timeout succeeds when non-empty, else times out
 276      */
 277     public void testTimedPoll0() throws InterruptedException {
</pre>
<hr />
<pre>
 291         long startTime = System.nanoTime();
 292         for (int i = 0; i &lt; SIZE; ++i)
 293             assertEquals(i, (int) q.poll(LONG_DELAY_MS, MILLISECONDS));
 294         assertTrue(millisElapsedSince(startTime) &lt; LONG_DELAY_MS);
 295 
 296         startTime = System.nanoTime();
 297         assertNull(q.poll(timeoutMillis(), MILLISECONDS));
 298         assertTrue(millisElapsedSince(startTime) &gt;= timeoutMillis());
 299         checkEmpty(q);
 300     }
 301 
 302     /**
 303      * Interrupted timed poll throws InterruptedException instead of
 304      * returning timeout status
 305      */
 306     public void testInterruptedTimedPoll() throws InterruptedException {
 307         final BlockingQueue&lt;Integer&gt; q = populatedQueue(SIZE);
 308         final CountDownLatch pleaseInterrupt = new CountDownLatch(1);
 309         Thread t = newStartedThread(new CheckedRunnable() {
 310             public void realRun() throws InterruptedException {

 311                 for (int i = 0; i &lt; SIZE; i++)
 312                     assertEquals(i, (int) q.poll(LONG_DELAY_MS, MILLISECONDS));
 313 
 314                 Thread.currentThread().interrupt();
 315                 try {
<span class="line-modified"> 316                     q.poll(randomTimeout(), randomTimeUnit());</span>
 317                     shouldThrow();
 318                 } catch (InterruptedException success) {}
 319                 assertFalse(Thread.interrupted());
 320 
 321                 pleaseInterrupt.countDown();
 322                 try {
<span class="line-modified"> 323                     q.poll(LONGER_DELAY_MS, MILLISECONDS);</span>
 324                     shouldThrow();
 325                 } catch (InterruptedException success) {}
 326                 assertFalse(Thread.interrupted());


 327             }});
 328 
 329         await(pleaseInterrupt);
<span class="line-modified"> 330         if (randomBoolean()) assertThreadBlocks(t, Thread.State.TIMED_WAITING);</span>
 331         t.interrupt();
 332         awaitTermination(t);
 333         checkEmpty(q);
 334     }
 335 
 336     /**
 337      * timed poll after thread interrupted throws InterruptedException
 338      * instead of returning timeout status
 339      */
 340     public void testTimedPollAfterInterrupt() throws InterruptedException {
 341         final BlockingQueue&lt;Integer&gt; q = populatedQueue(SIZE);
 342         Thread t = newStartedThread(new CheckedRunnable() {
 343             public void realRun() throws InterruptedException {

 344                 Thread.currentThread().interrupt();
 345                 for (int i = 0; i &lt; SIZE; ++i)
<span class="line-modified"> 346                     assertEquals(i, (int) q.poll(randomTimeout(), randomTimeUnit()));</span>
 347                 try {
<span class="line-modified"> 348                     q.poll(randomTimeout(), randomTimeUnit());</span>
 349                     shouldThrow();
 350                 } catch (InterruptedException success) {}
 351                 assertFalse(Thread.interrupted());

 352             }});
 353 
 354         awaitTermination(t);
 355         checkEmpty(q);
 356     }
 357 
 358     /**
 359      * peek returns next element, or null if empty
 360      */
 361     public void testPeek() throws InterruptedException {
 362         LinkedTransferQueue&lt;Integer&gt; q = populatedQueue(SIZE);
 363         for (int i = 0; i &lt; SIZE; ++i) {
 364             assertEquals(i, (int) q.peek());
 365             assertEquals(i, (int) q.poll());
 366             assertTrue(q.peek() == null ||
 367                        i != (int) q.peek());
 368         }
 369         assertNull(q.peek());
 370         checkEmpty(q);
 371     }
</pre>
<hr />
<pre>
 960                 assertTrue(q.hasWaitingConsumer());
 961                 checkEmpty(q);
 962                 assertTrue(q.tryTransfer(hotPotato));
 963             }});
 964 
 965         assertSame(q.take(), hotPotato);
 966         checkEmpty(q);
 967         awaitTermination(t);
 968     }
 969 
 970     /**
 971      * tryTransfer blocks interruptibly if no takers
 972      */
 973     public void testTryTransfer5() throws InterruptedException {
 974         final LinkedTransferQueue q = new LinkedTransferQueue();
 975         final CountDownLatch pleaseInterrupt = new CountDownLatch(1);
 976         assertTrue(q.isEmpty());
 977 
 978         Thread t = newStartedThread(new CheckedRunnable() {
 979             public void realRun() throws InterruptedException {

 980                 Thread.currentThread().interrupt();
 981                 try {
<span class="line-modified"> 982                     q.tryTransfer(new Object(), randomTimeout(), randomTimeUnit());</span>
 983                     shouldThrow();
 984                 } catch (InterruptedException success) {}
 985                 assertFalse(Thread.interrupted());
 986 
 987                 pleaseInterrupt.countDown();
 988                 try {
<span class="line-modified"> 989                     q.tryTransfer(new Object(), LONGER_DELAY_MS, MILLISECONDS);</span>
 990                     shouldThrow();
 991                 } catch (InterruptedException success) {}
 992                 assertFalse(Thread.interrupted());

 993             }});
 994 
 995         await(pleaseInterrupt);
<span class="line-modified"> 996         if (randomBoolean()) assertThreadBlocks(t, Thread.State.TIMED_WAITING);</span>
 997         t.interrupt();
 998         awaitTermination(t);
 999         checkEmpty(q);
1000     }
1001 
1002     /**
1003      * tryTransfer gives up after the timeout and returns false
1004      */
1005     public void testTryTransfer6() throws InterruptedException {
1006         final LinkedTransferQueue q = new LinkedTransferQueue();
1007 
1008         Thread t = newStartedThread(new CheckedRunnable() {
1009             public void realRun() throws InterruptedException {
1010                 long startTime = System.nanoTime();
1011                 assertFalse(q.tryTransfer(new Object(),
1012                                           timeoutMillis(), MILLISECONDS));
1013                 assertTrue(millisElapsedSince(startTime) &gt;= timeoutMillis());
1014                 checkEmpty(q);
1015             }});
1016 
</pre>
</td>
</tr>
</table>
<center><a href="LinkedHashMapTest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="LongAccumulatorTest.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>