<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/java/util/concurrent/tck/ThreadPoolExecutorSubclassTest.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="ThreadLocalRandom8Test.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="ThreadPoolExecutorTest.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/util/concurrent/tck/ThreadPoolExecutorSubclassTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 779             assertEquals(tasks.length - 2, p.getTaskCount());
 780         }
 781     }
 782 
 783     /**
 784      * shutdownNow returns a list containing tasks that were not run,
 785      * and those tasks are drained from the queue
 786      */
 787     public void testShutdownNow() throws InterruptedException {
 788         final int poolSize = 2;
 789         final int count = 5;
 790         final AtomicInteger ran = new AtomicInteger(0);
 791         final ThreadPoolExecutor p =
 792             new CustomTPE(poolSize, poolSize,
 793                           LONG_DELAY_MS, MILLISECONDS,
 794                           new ArrayBlockingQueue&lt;Runnable&gt;(10));
 795         final CountDownLatch threadsStarted = new CountDownLatch(poolSize);
 796         Runnable waiter = new CheckedRunnable() { public void realRun() {
 797             threadsStarted.countDown();
 798             try {
<span class="line-modified"> 799                 MILLISECONDS.sleep(2 * LONG_DELAY_MS);</span>
 800             } catch (InterruptedException success) {}
 801             ran.getAndIncrement();
 802         }};
 803         for (int i = 0; i &lt; count; i++)
 804             p.execute(waiter);
 805         await(threadsStarted);
 806         assertEquals(poolSize, p.getActiveCount());
 807         assertEquals(0, p.getCompletedTaskCount());
 808         final List&lt;Runnable&gt; queuedTasks;
 809         try {
 810             queuedTasks = p.shutdownNow();
 811         } catch (SecurityException ok) {
 812             return; // Allowed in case test doesn&#39;t have privs
 813         }
 814         assertTrue(p.isShutdown());
 815         assertTrue(p.getQueue().isEmpty());
 816         assertEquals(count - poolSize, queuedTasks.size());
 817         assertTrue(p.awaitTermination(LONG_DELAY_MS, MILLISECONDS));
 818         assertTrue(p.isTerminated());
 819         assertEquals(poolSize, ran.get());
</pre>
<hr />
<pre>
1652                 e.invokeAny(emptyCollection, randomTimeout(), randomTimeUnit());
1653                 shouldThrow();
1654             } catch (IllegalArgumentException success) {}
1655         }
1656     }
1657 
1658     /**
1659      * timed invokeAny(c) throws NPE if c has null elements
1660      */
1661     public void testTimedInvokeAny3() throws Exception {
1662         CountDownLatch latch = new CountDownLatch(1);
1663         final ExecutorService e =
1664             new CustomTPE(2, 2,
1665                           LONG_DELAY_MS, MILLISECONDS,
1666                           new ArrayBlockingQueue&lt;Runnable&gt;(10));
1667         try (PoolCleaner cleaner = cleaner(e)) {
1668             List&lt;Callable&lt;String&gt;&gt; l = new ArrayList&lt;&gt;();
1669             l.add(latchAwaitingStringTask(latch));
1670             l.add(null);
1671             try {
<span class="line-modified">1672                 e.invokeAny(l, randomTimeout(), MILLISECONDS);</span>
1673                 shouldThrow();
1674             } catch (NullPointerException success) {}
1675             latch.countDown();
1676         }
1677     }
1678 
1679     /**
1680      * timed invokeAny(c) throws ExecutionException if no task completes
1681      */
1682     public void testTimedInvokeAny4() throws Exception {
1683         final ExecutorService e =
1684             new CustomTPE(2, 2,
1685                           LONG_DELAY_MS, MILLISECONDS,
1686                           new ArrayBlockingQueue&lt;Runnable&gt;(10));
1687         try (PoolCleaner cleaner = cleaner(e)) {
1688             long startTime = System.nanoTime();
1689             List&lt;Callable&lt;String&gt;&gt; l = new ArrayList&lt;&gt;();
1690             l.add(new NPETask());
1691             try {
1692                 e.invokeAny(l, LONG_DELAY_MS, MILLISECONDS);
</pre>
</td>
<td>
<hr />
<pre>
 779             assertEquals(tasks.length - 2, p.getTaskCount());
 780         }
 781     }
 782 
 783     /**
 784      * shutdownNow returns a list containing tasks that were not run,
 785      * and those tasks are drained from the queue
 786      */
 787     public void testShutdownNow() throws InterruptedException {
 788         final int poolSize = 2;
 789         final int count = 5;
 790         final AtomicInteger ran = new AtomicInteger(0);
 791         final ThreadPoolExecutor p =
 792             new CustomTPE(poolSize, poolSize,
 793                           LONG_DELAY_MS, MILLISECONDS,
 794                           new ArrayBlockingQueue&lt;Runnable&gt;(10));
 795         final CountDownLatch threadsStarted = new CountDownLatch(poolSize);
 796         Runnable waiter = new CheckedRunnable() { public void realRun() {
 797             threadsStarted.countDown();
 798             try {
<span class="line-modified"> 799                 MILLISECONDS.sleep(LONGER_DELAY_MS);</span>
 800             } catch (InterruptedException success) {}
 801             ran.getAndIncrement();
 802         }};
 803         for (int i = 0; i &lt; count; i++)
 804             p.execute(waiter);
 805         await(threadsStarted);
 806         assertEquals(poolSize, p.getActiveCount());
 807         assertEquals(0, p.getCompletedTaskCount());
 808         final List&lt;Runnable&gt; queuedTasks;
 809         try {
 810             queuedTasks = p.shutdownNow();
 811         } catch (SecurityException ok) {
 812             return; // Allowed in case test doesn&#39;t have privs
 813         }
 814         assertTrue(p.isShutdown());
 815         assertTrue(p.getQueue().isEmpty());
 816         assertEquals(count - poolSize, queuedTasks.size());
 817         assertTrue(p.awaitTermination(LONG_DELAY_MS, MILLISECONDS));
 818         assertTrue(p.isTerminated());
 819         assertEquals(poolSize, ran.get());
</pre>
<hr />
<pre>
1652                 e.invokeAny(emptyCollection, randomTimeout(), randomTimeUnit());
1653                 shouldThrow();
1654             } catch (IllegalArgumentException success) {}
1655         }
1656     }
1657 
1658     /**
1659      * timed invokeAny(c) throws NPE if c has null elements
1660      */
1661     public void testTimedInvokeAny3() throws Exception {
1662         CountDownLatch latch = new CountDownLatch(1);
1663         final ExecutorService e =
1664             new CustomTPE(2, 2,
1665                           LONG_DELAY_MS, MILLISECONDS,
1666                           new ArrayBlockingQueue&lt;Runnable&gt;(10));
1667         try (PoolCleaner cleaner = cleaner(e)) {
1668             List&lt;Callable&lt;String&gt;&gt; l = new ArrayList&lt;&gt;();
1669             l.add(latchAwaitingStringTask(latch));
1670             l.add(null);
1671             try {
<span class="line-modified">1672                 e.invokeAny(l, randomTimeout(), randomTimeUnit());</span>
1673                 shouldThrow();
1674             } catch (NullPointerException success) {}
1675             latch.countDown();
1676         }
1677     }
1678 
1679     /**
1680      * timed invokeAny(c) throws ExecutionException if no task completes
1681      */
1682     public void testTimedInvokeAny4() throws Exception {
1683         final ExecutorService e =
1684             new CustomTPE(2, 2,
1685                           LONG_DELAY_MS, MILLISECONDS,
1686                           new ArrayBlockingQueue&lt;Runnable&gt;(10));
1687         try (PoolCleaner cleaner = cleaner(e)) {
1688             long startTime = System.nanoTime();
1689             List&lt;Callable&lt;String&gt;&gt; l = new ArrayList&lt;&gt;();
1690             l.add(new NPETask());
1691             try {
1692                 e.invokeAny(l, LONG_DELAY_MS, MILLISECONDS);
</pre>
</td>
</tr>
</table>
<center><a href="ThreadLocalRandom8Test.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="ThreadPoolExecutorTest.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>