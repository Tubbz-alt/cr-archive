<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff test/jdk/java/util/concurrent/CountDownLatch/Basic.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="../ConcurrentQueues/OfferRemoveLoops.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../CyclicBarrier/Basic.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/util/concurrent/CountDownLatch/Basic.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 21,195 ***</span>
   * questions.
   */
  
  /*
   * @test
<span class="line-modified">!  * @bug 6332435</span>
   * @summary Basic tests for CountDownLatch
   * @library /test/lib
   * @author Seetharam Avadhanam, Martin Buchholz
   */
  
  import java.util.concurrent.CountDownLatch;
  import java.util.concurrent.TimeUnit;
  import java.util.concurrent.atomic.AtomicInteger;
  import jdk.test.lib.Utils;
  
  public class Basic {
      static final long LONG_DELAY_MS = Utils.adjustTimeout(10_000);
  
<span class="line-removed">-     interface AwaiterFactory {</span>
<span class="line-removed">-         Awaiter getAwaiter();</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
      abstract static class Awaiter extends Thread {
<span class="line-modified">!         private volatile Throwable result = null;</span>
<span class="line-modified">!         protected void result(Throwable result) { this.result = result; }</span>
<span class="line-modified">!         public Throwable result() { return this.result; }</span>
<span class="line-modified">!     }</span>
<span class="line-modified">! </span>
<span class="line-modified">!     private void toTheStartingGate(CountDownLatch gate) {</span>
<span class="line-modified">!         try {</span>
<span class="line-modified">!             gate.await();</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-         catch (Throwable t) { fail(t); }</span>
      }
  
<span class="line-modified">!     private Awaiter awaiter(final CountDownLatch latch,</span>
<span class="line-modified">!                             final CountDownLatch gate) {</span>
<span class="line-modified">!         return new Awaiter() { public void run() {</span>
<span class="line-modified">!             System.out.println(&quot;without millis: &quot; + latch.toString());</span>
<span class="line-modified">!             gate.countDown();</span>
<span class="line-removed">- </span>
<span class="line-removed">-             try {</span>
                  latch.await();
<span class="line-modified">!                 System.out.println(&quot;without millis - ComingOut&quot;);</span>
<span class="line-removed">-             }</span>
<span class="line-removed">-             catch (Throwable result) { result(result); }}};</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     private Awaiter awaiter(final CountDownLatch latch,</span>
<span class="line-removed">-                             final CountDownLatch gate,</span>
<span class="line-removed">-                             final long millis) {</span>
<span class="line-removed">-         return new Awaiter() { public void run() {</span>
<span class="line-removed">-             System.out.println(&quot;with millis: &quot;+latch.toString());</span>
<span class="line-removed">-             gate.countDown();</span>
<span class="line-removed">- </span>
<span class="line-removed">-             try {</span>
<span class="line-removed">-                 latch.await(millis, TimeUnit.MILLISECONDS);</span>
<span class="line-removed">-                 System.out.println(&quot;with millis - ComingOut&quot;);</span>
<span class="line-removed">-             }</span>
<span class="line-removed">-             catch (Throwable result) { result(result); }}};</span>
      }
  
<span class="line-modified">!     AwaiterFactory awaiterFactory(CountDownLatch latch, CountDownLatch gate) {</span>
<span class="line-modified">!         return () -&gt; awaiter(latch, gate);</span>
      }
  
<span class="line-modified">!     AwaiterFactory timedAwaiterFactory(CountDownLatch latch, CountDownLatch gate) {</span>
<span class="line-modified">!         return () -&gt; awaiter(latch, gate, LONG_DELAY_MS);</span>
      }
  
      //----------------------------------------------------------------
      // Normal use
      //----------------------------------------------------------------
      public static void normalUse() throws Throwable {
          int count = 0;
<span class="line-removed">-         Basic test = new Basic();</span>
          CountDownLatch latch = new CountDownLatch(3);
          Awaiter[] a = new Awaiter[12];
  
          for (int i = 0; i &lt; 3; i++) {
              CountDownLatch gate = new CountDownLatch(4);
<span class="line-modified">!             AwaiterFactory factory1 = test.awaiterFactory(latch, gate);</span>
<span class="line-modified">!             AwaiterFactory factory2 = test.timedAwaiterFactory(latch, gate);</span>
<span class="line-modified">!             a[count] = factory1.getAwaiter(); a[count++].start();</span>
<span class="line-modified">!             a[count] = factory1.getAwaiter(); a[count++].start();</span>
<span class="line-modified">!             a[count] = factory2.getAwaiter(); a[count++].start();</span>
<span class="line-modified">!             a[count] = factory2.getAwaiter(); a[count++].start();</span>
<span class="line-removed">-             test.toTheStartingGate(gate);</span>
<span class="line-removed">-             System.out.println(&quot;Main Thread: &quot; + latch.toString());</span>
              latch.countDown();
              checkCount(latch, 2-i);
          }
<span class="line-modified">!         for (int i = 0; i &lt; 12; i++)</span>
<span class="line-modified">!             a[i].join();</span>
<span class="line-modified">! </span>
<span class="line-modified">!         for (int i = 0; i &lt; 12; i++)</span>
<span class="line-removed">-             checkResult(a[i], null);</span>
      }
  
      //----------------------------------------------------------------
      // One thread interrupted
      //----------------------------------------------------------------
      public static void threadInterrupted() throws Throwable {
          int count = 0;
<span class="line-removed">-         Basic test = new Basic();</span>
          CountDownLatch latch = new CountDownLatch(3);
          Awaiter[] a = new Awaiter[12];
  
          for (int i = 0; i &lt; 3; i++) {
              CountDownLatch gate = new CountDownLatch(4);
<span class="line-modified">!             AwaiterFactory factory1 = test.awaiterFactory(latch, gate);</span>
<span class="line-modified">!             AwaiterFactory factory2 = test.timedAwaiterFactory(latch, gate);</span>
<span class="line-modified">!             a[count] = factory1.getAwaiter(); a[count++].start();</span>
<span class="line-modified">!             a[count] = factory1.getAwaiter(); a[count++].start();</span>
<span class="line-modified">!             a[count] = factory2.getAwaiter(); a[count++].start();</span>
<span class="line-modified">!             a[count] = factory2.getAwaiter(); a[count++].start();</span>
              a[count-1].interrupt();
<span class="line-removed">-             test.toTheStartingGate(gate);</span>
<span class="line-removed">-             System.out.println(&quot;Main Thread: &quot; + latch.toString());</span>
              latch.countDown();
              checkCount(latch, 2-i);
          }
<span class="line-modified">!         for (int i = 0; i &lt; 12; i++)</span>
<span class="line-modified">!             a[i].join();</span>
<span class="line-modified">! </span>
<span class="line-modified">!         for (int i = 0; i &lt; 12; i++)</span>
<span class="line-modified">!             checkResult(a[i],</span>
<span class="line-modified">!                         (i % 4) == 3 ? InterruptedException.class : null);</span>
      }
  
      //----------------------------------------------------------------
      // One thread timed out
      //----------------------------------------------------------------
      public static void timeOut() throws Throwable {
<span class="line-modified">!         int count =0;</span>
<span class="line-removed">-         Basic test = new Basic();</span>
          CountDownLatch latch = new CountDownLatch(3);
          Awaiter[] a = new Awaiter[12];
  
          long[] timeout = { 0L, 5L, 10L };
  
          for (int i = 0; i &lt; 3; i++) {
              CountDownLatch gate = new CountDownLatch(4);
<span class="line-modified">!             AwaiterFactory factory1 = test.awaiterFactory(latch, gate);</span>
<span class="line-modified">!             AwaiterFactory factory2 = test.timedAwaiterFactory(latch, gate);</span>
<span class="line-modified">!             a[count] = test.awaiter(latch, gate, timeout[i]); a[count++].start();</span>
<span class="line-modified">!             a[count] = factory1.getAwaiter(); a[count++].start();</span>
<span class="line-modified">!             a[count] = factory2.getAwaiter(); a[count++].start();</span>
<span class="line-modified">!             a[count] = factory2.getAwaiter(); a[count++].start();</span>
<span class="line-removed">-             test.toTheStartingGate(gate);</span>
<span class="line-removed">-             System.out.println(&quot;Main Thread: &quot; + latch.toString());</span>
              latch.countDown();
              checkCount(latch, 2-i);
          }
<span class="line-modified">!         for (int i = 0; i &lt; 12; i++)</span>
<span class="line-modified">!             a[i].join();</span>
<span class="line-modified">! </span>
<span class="line-modified">!         for (int i = 0; i &lt; 12; i++)</span>
<span class="line-removed">-             checkResult(a[i], null);</span>
      }
  
      public static void main(String[] args) throws Throwable {
<span class="line-modified">!         normalUse();</span>
<span class="line-modified">!         threadInterrupted();</span>
<span class="line-modified">!         timeOut();</span>
          if (failures.get() &gt; 0L)
              throw new AssertionError(failures.get() + &quot; failures&quot;);
      }
  
<span class="line-modified">!     private static final AtomicInteger failures = new AtomicInteger(0);</span>
  
<span class="line-modified">!     private static void fail(String msg) {</span>
          fail(new AssertionError(msg));
      }
  
<span class="line-modified">!     private static void fail(Throwable t) {</span>
          t.printStackTrace();
          failures.getAndIncrement();
      }
  
<span class="line-modified">!     private static void checkCount(CountDownLatch b, int expected) {</span>
          if (b.getCount() != expected)
              fail(&quot;Count = &quot; + b.getCount() +
                   &quot;, expected = &quot; + expected);
      }
  
<span class="line-modified">!     private static void checkResult(Awaiter a, Class c) {</span>
<span class="line-modified">!         Throwable t = a.result();</span>
<span class="line-modified">!         if (! ((t == null &amp;&amp; c == null) || c.isInstance(t))) {</span>
<span class="line-modified">!             System.out.println(&quot;Mismatch: &quot; + t + &quot;, &quot; + c.getName());</span>
<span class="line-removed">-             failures.getAndIncrement();</span>
<span class="line-removed">-         }</span>
      }
  }
<span class="line-new-header">--- 21,180 ---</span>
   * questions.
   */
  
  /*
   * @test
<span class="line-modified">!  * @bug 6332435 8221168</span>
   * @summary Basic tests for CountDownLatch
   * @library /test/lib
   * @author Seetharam Avadhanam, Martin Buchholz
   */
  
  import java.util.concurrent.CountDownLatch;
<span class="line-added">+ import java.util.concurrent.ThreadLocalRandom;</span>
  import java.util.concurrent.TimeUnit;
  import java.util.concurrent.atomic.AtomicInteger;
<span class="line-added">+ import java.util.function.Supplier;</span>
  import jdk.test.lib.Utils;
  
  public class Basic {
      static final long LONG_DELAY_MS = Utils.adjustTimeout(10_000);
  
      abstract static class Awaiter extends Thread {
<span class="line-modified">!         volatile Throwable exception;</span>
<span class="line-modified">!         volatile boolean interrupted;</span>
<span class="line-modified">!         abstract void realRun() throws Exception;</span>
<span class="line-modified">!         public final void run() {</span>
<span class="line-modified">!             try { realRun(); }</span>
<span class="line-modified">!             catch (Throwable ex) { exception = ex; }</span>
<span class="line-modified">!             interrupted = Thread.interrupted();</span>
<span class="line-modified">!         };</span>
      }
  
<span class="line-modified">!     static Awaiter awaiter(CountDownLatch latch,</span>
<span class="line-modified">!                            CountDownLatch gate) {</span>
<span class="line-modified">!         return new Awaiter() {</span>
<span class="line-modified">!             public void realRun() throws InterruptedException {</span>
<span class="line-modified">!                 gate.countDown();</span>
                  latch.await();
<span class="line-modified">!             }};</span>
      }
  
<span class="line-modified">!     static Awaiter awaiter(CountDownLatch latch,</span>
<span class="line-modified">!                            CountDownLatch gate,</span>
<span class="line-added">+                            long timeoutMillis) {</span>
<span class="line-added">+         return new Awaiter() {</span>
<span class="line-added">+             public void realRun() throws InterruptedException {</span>
<span class="line-added">+                 gate.countDown();</span>
<span class="line-added">+                 latch.await(timeoutMillis, TimeUnit.MILLISECONDS);</span>
<span class="line-added">+             }};</span>
      }
  
<span class="line-modified">!     static Supplier&lt;Awaiter&gt; randomAwaiterSupplier(</span>
<span class="line-modified">!             CountDownLatch latch, CountDownLatch gate) {</span>
<span class="line-added">+         return () -&gt; (ThreadLocalRandom.current().nextBoolean())</span>
<span class="line-added">+             ? awaiter(latch, gate)</span>
<span class="line-added">+             : awaiter(latch, gate, LONG_DELAY_MS);</span>
      }
  
      //----------------------------------------------------------------
      // Normal use
      //----------------------------------------------------------------
      public static void normalUse() throws Throwable {
          int count = 0;
          CountDownLatch latch = new CountDownLatch(3);
          Awaiter[] a = new Awaiter[12];
  
          for (int i = 0; i &lt; 3; i++) {
              CountDownLatch gate = new CountDownLatch(4);
<span class="line-modified">!             Supplier&lt;Awaiter&gt; s = randomAwaiterSupplier(latch, gate);</span>
<span class="line-modified">!             a[count] = s.get(); a[count++].start();</span>
<span class="line-modified">!             a[count] = s.get(); a[count++].start();</span>
<span class="line-modified">!             a[count] = s.get(); a[count++].start();</span>
<span class="line-modified">!             a[count] = s.get(); a[count++].start();</span>
<span class="line-modified">!             gate.await();</span>
              latch.countDown();
              checkCount(latch, 2-i);
          }
<span class="line-modified">!         for (Awaiter awaiter : a)</span>
<span class="line-modified">!             awaiter.join();</span>
<span class="line-modified">!         for (Awaiter awaiter : a)</span>
<span class="line-modified">!             checkException(awaiter, null);</span>
      }
  
      //----------------------------------------------------------------
      // One thread interrupted
      //----------------------------------------------------------------
      public static void threadInterrupted() throws Throwable {
          int count = 0;
          CountDownLatch latch = new CountDownLatch(3);
          Awaiter[] a = new Awaiter[12];
  
          for (int i = 0; i &lt; 3; i++) {
              CountDownLatch gate = new CountDownLatch(4);
<span class="line-modified">!             Supplier&lt;Awaiter&gt; s = randomAwaiterSupplier(latch, gate);</span>
<span class="line-modified">!             a[count] = s.get(); a[count++].start();</span>
<span class="line-modified">!             a[count] = s.get(); a[count++].start();</span>
<span class="line-modified">!             a[count] = s.get(); a[count++].start();</span>
<span class="line-modified">!             a[count] = s.get(); a[count++].start();</span>
<span class="line-modified">!             gate.await();</span>
              a[count-1].interrupt();
              latch.countDown();
              checkCount(latch, 2-i);
          }
<span class="line-modified">!         for (Awaiter awaiter : a)</span>
<span class="line-modified">!             awaiter.join();</span>
<span class="line-modified">!         for (int i = 0; i &lt; a.length; i++) {</span>
<span class="line-modified">!             Awaiter awaiter = a[i];</span>
<span class="line-modified">!             Throwable ex = awaiter.exception;</span>
<span class="line-modified">!             if ((i % 4) == 3 &amp;&amp; !awaiter.interrupted)</span>
<span class="line-added">+                 checkException(awaiter, InterruptedException.class);</span>
<span class="line-added">+             else</span>
<span class="line-added">+                 checkException(awaiter, null);</span>
<span class="line-added">+         }</span>
      }
  
      //----------------------------------------------------------------
      // One thread timed out
      //----------------------------------------------------------------
      public static void timeOut() throws Throwable {
<span class="line-modified">!         int count = 0;</span>
          CountDownLatch latch = new CountDownLatch(3);
          Awaiter[] a = new Awaiter[12];
  
          long[] timeout = { 0L, 5L, 10L };
  
          for (int i = 0; i &lt; 3; i++) {
              CountDownLatch gate = new CountDownLatch(4);
<span class="line-modified">!             Supplier&lt;Awaiter&gt; s = randomAwaiterSupplier(latch, gate);</span>
<span class="line-modified">!             a[count] = awaiter(latch, gate, timeout[i]); a[count++].start();</span>
<span class="line-modified">!             a[count] = s.get(); a[count++].start();</span>
<span class="line-modified">!             a[count] = s.get(); a[count++].start();</span>
<span class="line-modified">!             a[count] = s.get(); a[count++].start();</span>
<span class="line-modified">!             gate.await();</span>
              latch.countDown();
              checkCount(latch, 2-i);
          }
<span class="line-modified">!         for (Awaiter awaiter : a)</span>
<span class="line-modified">!             awaiter.join();</span>
<span class="line-modified">!         for (Awaiter awaiter : a)</span>
<span class="line-modified">!             checkException(awaiter, null);</span>
      }
  
      public static void main(String[] args) throws Throwable {
<span class="line-modified">!         try {</span>
<span class="line-modified">!             normalUse();</span>
<span class="line-modified">!         } catch (Throwable ex) { fail(ex); }</span>
<span class="line-added">+         try {</span>
<span class="line-added">+             threadInterrupted();</span>
<span class="line-added">+         } catch (Throwable ex) { fail(ex); }</span>
<span class="line-added">+         try {</span>
<span class="line-added">+             timeOut();</span>
<span class="line-added">+         } catch (Throwable ex) { fail(ex); }</span>
<span class="line-added">+ </span>
          if (failures.get() &gt; 0L)
              throw new AssertionError(failures.get() + &quot; failures&quot;);
      }
  
<span class="line-modified">!     static final AtomicInteger failures = new AtomicInteger(0);</span>
  
<span class="line-modified">!     static void fail(String msg) {</span>
          fail(new AssertionError(msg));
      }
  
<span class="line-modified">!     static void fail(Throwable t) {</span>
          t.printStackTrace();
          failures.getAndIncrement();
      }
  
<span class="line-modified">!     static void checkCount(CountDownLatch b, int expected) {</span>
          if (b.getCount() != expected)
              fail(&quot;Count = &quot; + b.getCount() +
                   &quot;, expected = &quot; + expected);
      }
  
<span class="line-modified">!     static void checkException(Awaiter awaiter, Class&lt;? extends Throwable&gt; c) {</span>
<span class="line-modified">!         Throwable ex = awaiter.exception;</span>
<span class="line-modified">!         if (! ((ex == null &amp;&amp; c == null) || c.isInstance(ex)))</span>
<span class="line-modified">!             fail(&quot;Expected: &quot; + c + &quot;, got: &quot; + ex);</span>
      }
  }
</pre>
<center><a href="../ConcurrentQueues/OfferRemoveLoops.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../CyclicBarrier/Basic.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>