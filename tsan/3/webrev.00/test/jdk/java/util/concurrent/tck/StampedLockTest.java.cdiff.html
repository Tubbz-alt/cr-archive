<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff test/jdk/java/util/concurrent/tck/StampedLockTest.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="SplittableRandomTest.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="SynchronousQueueTest.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/util/concurrent/tck/StampedLockTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 40,16 ***</span>
<span class="line-new-header">--- 40,21 ---</span>
  import static java.util.concurrent.locks.StampedLock.isReadLockStamp;
  import static java.util.concurrent.locks.StampedLock.isWriteLockStamp;
  
  import java.util.ArrayList;
  import java.util.List;
<span class="line-added">+ import java.util.concurrent.Callable;</span>
<span class="line-added">+ import java.util.concurrent.CompletableFuture;</span>
  import java.util.concurrent.CountDownLatch;
  import java.util.concurrent.Future;
<span class="line-added">+ import java.util.concurrent.ThreadLocalRandom;</span>
  import java.util.concurrent.TimeUnit;
<span class="line-added">+ import java.util.concurrent.atomic.AtomicBoolean;</span>
  import java.util.concurrent.locks.Lock;
  import java.util.concurrent.locks.StampedLock;
  import java.util.function.BiConsumer;
<span class="line-added">+ import java.util.function.Consumer;</span>
  import java.util.function.Function;
  
  import junit.framework.Test;
  import junit.framework.TestSuite;
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 100,60 ***</span>
          assertEquals(0, lock.getReadLockCount());
          assertValid(lock, lock.tryOptimisticRead());
      }
  
      List&lt;Action&gt; lockLockers(Lock lock) {
<span class="line-modified">!         List&lt;Action&gt; lockers = new ArrayList&lt;&gt;();</span>
<span class="line-modified">!         lockers.add(() -&gt; lock.lock());</span>
<span class="line-modified">!         lockers.add(() -&gt; lock.lockInterruptibly());</span>
<span class="line-modified">!         lockers.add(() -&gt; lock.tryLock());</span>
<span class="line-modified">!         lockers.add(() -&gt; lock.tryLock(Long.MIN_VALUE, DAYS));</span>
<span class="line-modified">!         lockers.add(() -&gt; lock.tryLock(0L, DAYS));</span>
<span class="line-modified">!         lockers.add(() -&gt; lock.tryLock(Long.MAX_VALUE, DAYS));</span>
<span class="line-removed">-         return lockers;</span>
      }
  
      List&lt;Function&lt;StampedLock, Long&gt;&gt; readLockers() {
<span class="line-modified">!         List&lt;Function&lt;StampedLock, Long&gt;&gt; readLockers = new ArrayList&lt;&gt;();</span>
<span class="line-modified">!         readLockers.add(sl -&gt; sl.readLock());</span>
<span class="line-modified">!         readLockers.add(sl -&gt; sl.tryReadLock());</span>
<span class="line-modified">!         readLockers.add(sl -&gt; readLockInterruptiblyUninterrupted(sl));</span>
<span class="line-modified">!         readLockers.add(sl -&gt; tryReadLockUninterrupted(sl, Long.MIN_VALUE, DAYS));</span>
<span class="line-modified">!         readLockers.add(sl -&gt; tryReadLockUninterrupted(sl, 0L, DAYS));</span>
<span class="line-modified">!         readLockers.add(sl -&gt; sl.tryConvertToReadLock(sl.tryOptimisticRead()));</span>
<span class="line-removed">-         return readLockers;</span>
      }
  
      List&lt;BiConsumer&lt;StampedLock, Long&gt;&gt; readUnlockers() {
<span class="line-modified">!         List&lt;BiConsumer&lt;StampedLock, Long&gt;&gt; readUnlockers = new ArrayList&lt;&gt;();</span>
<span class="line-modified">!         readUnlockers.add((sl, stamp) -&gt; sl.unlockRead(stamp));</span>
<span class="line-modified">!         readUnlockers.add((sl, stamp) -&gt; assertTrue(sl.tryUnlockRead()));</span>
<span class="line-modified">!         readUnlockers.add((sl, stamp) -&gt; sl.asReadLock().unlock());</span>
<span class="line-modified">!         readUnlockers.add((sl, stamp) -&gt; sl.unlock(stamp));</span>
<span class="line-modified">!         readUnlockers.add((sl, stamp) -&gt; assertValid(sl, sl.tryConvertToOptimisticRead(stamp)));</span>
<span class="line-removed">-         return readUnlockers;</span>
      }
  
      List&lt;Function&lt;StampedLock, Long&gt;&gt; writeLockers() {
<span class="line-modified">!         List&lt;Function&lt;StampedLock, Long&gt;&gt; writeLockers = new ArrayList&lt;&gt;();</span>
<span class="line-modified">!         writeLockers.add(sl -&gt; sl.writeLock());</span>
<span class="line-modified">!         writeLockers.add(sl -&gt; sl.tryWriteLock());</span>
<span class="line-modified">!         writeLockers.add(sl -&gt; writeLockInterruptiblyUninterrupted(sl));</span>
<span class="line-modified">!         writeLockers.add(sl -&gt; tryWriteLockUninterrupted(sl, Long.MIN_VALUE, DAYS));</span>
<span class="line-modified">!         writeLockers.add(sl -&gt; tryWriteLockUninterrupted(sl, 0L, DAYS));</span>
<span class="line-modified">!         writeLockers.add(sl -&gt; sl.tryConvertToWriteLock(sl.tryOptimisticRead()));</span>
<span class="line-removed">-         return writeLockers;</span>
      }
  
      List&lt;BiConsumer&lt;StampedLock, Long&gt;&gt; writeUnlockers() {
<span class="line-modified">!         List&lt;BiConsumer&lt;StampedLock, Long&gt;&gt; writeUnlockers = new ArrayList&lt;&gt;();</span>
<span class="line-modified">!         writeUnlockers.add((sl, stamp) -&gt; sl.unlockWrite(stamp));</span>
<span class="line-modified">!         writeUnlockers.add((sl, stamp) -&gt; assertTrue(sl.tryUnlockWrite()));</span>
<span class="line-modified">!         writeUnlockers.add((sl, stamp) -&gt; sl.asWriteLock().unlock());</span>
<span class="line-modified">!         writeUnlockers.add((sl, stamp) -&gt; sl.unlock(stamp));</span>
<span class="line-modified">!         writeUnlockers.add((sl, stamp) -&gt; assertValid(sl, sl.tryConvertToOptimisticRead(stamp)));</span>
<span class="line-removed">-         return writeUnlockers;</span>
      }
  
      /**
       * Constructed StampedLock is in unlocked state
       */
<span class="line-new-header">--- 105,55 ---</span>
          assertEquals(0, lock.getReadLockCount());
          assertValid(lock, lock.tryOptimisticRead());
      }
  
      List&lt;Action&gt; lockLockers(Lock lock) {
<span class="line-modified">!         return List.of(</span>
<span class="line-modified">!             () -&gt; lock.lock(),</span>
<span class="line-modified">!             () -&gt; lock.lockInterruptibly(),</span>
<span class="line-modified">!             () -&gt; lock.tryLock(),</span>
<span class="line-modified">!             () -&gt; lock.tryLock(Long.MIN_VALUE, DAYS),</span>
<span class="line-modified">!             () -&gt; lock.tryLock(0L, DAYS),</span>
<span class="line-modified">!             () -&gt; lock.tryLock(Long.MAX_VALUE, DAYS));</span>
      }
  
      List&lt;Function&lt;StampedLock, Long&gt;&gt; readLockers() {
<span class="line-modified">!         return List.of(</span>
<span class="line-modified">!             sl -&gt; sl.readLock(),</span>
<span class="line-modified">!             sl -&gt; sl.tryReadLock(),</span>
<span class="line-modified">!             sl -&gt; readLockInterruptiblyUninterrupted(sl),</span>
<span class="line-modified">!             sl -&gt; tryReadLockUninterrupted(sl, Long.MIN_VALUE, DAYS),</span>
<span class="line-modified">!             sl -&gt; tryReadLockUninterrupted(sl, 0L, DAYS),</span>
<span class="line-modified">!             sl -&gt; sl.tryConvertToReadLock(sl.tryOptimisticRead()));</span>
      }
  
      List&lt;BiConsumer&lt;StampedLock, Long&gt;&gt; readUnlockers() {
<span class="line-modified">!         return List.of(</span>
<span class="line-modified">!             (sl, stamp) -&gt; sl.unlockRead(stamp),</span>
<span class="line-modified">!             (sl, stamp) -&gt; assertTrue(sl.tryUnlockRead()),</span>
<span class="line-modified">!             (sl, stamp) -&gt; sl.asReadLock().unlock(),</span>
<span class="line-modified">!             (sl, stamp) -&gt; sl.unlock(stamp),</span>
<span class="line-modified">!             (sl, stamp) -&gt; assertValid(sl, sl.tryConvertToOptimisticRead(stamp)));</span>
      }
  
      List&lt;Function&lt;StampedLock, Long&gt;&gt; writeLockers() {
<span class="line-modified">!         return List.of(</span>
<span class="line-modified">!             sl -&gt; sl.writeLock(),</span>
<span class="line-modified">!             sl -&gt; sl.tryWriteLock(),</span>
<span class="line-modified">!             sl -&gt; writeLockInterruptiblyUninterrupted(sl),</span>
<span class="line-modified">!             sl -&gt; tryWriteLockUninterrupted(sl, Long.MIN_VALUE, DAYS),</span>
<span class="line-modified">!             sl -&gt; tryWriteLockUninterrupted(sl, 0L, DAYS),</span>
<span class="line-modified">!             sl -&gt; sl.tryConvertToWriteLock(sl.tryOptimisticRead()));</span>
      }
  
      List&lt;BiConsumer&lt;StampedLock, Long&gt;&gt; writeUnlockers() {
<span class="line-modified">!         return List.of(</span>
<span class="line-modified">!             (sl, stamp) -&gt; sl.unlockWrite(stamp),</span>
<span class="line-modified">!             (sl, stamp) -&gt; assertTrue(sl.tryUnlockWrite()),</span>
<span class="line-modified">!             (sl, stamp) -&gt; sl.asWriteLock().unlock(),</span>
<span class="line-modified">!             (sl, stamp) -&gt; sl.unlock(stamp),</span>
<span class="line-modified">!             (sl, stamp) -&gt; assertValid(sl, sl.tryConvertToOptimisticRead(stamp)));</span>
      }
  
      /**
       * Constructed StampedLock is in unlocked state
       */
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1007,110 ***</span>
      /**
       * Passing optimistic read stamps to unlock operations result in
       * IllegalMonitorStateException
       */
      public void testCannotUnlockOptimisticReadStamps() {
<span class="line-modified">!         Runnable[] actions = {</span>
<span class="line-modified">!             () -&gt; {</span>
<span class="line-modified">!                 StampedLock sl = new StampedLock();</span>
<span class="line-modified">!                 long stamp = assertValid(sl, sl.tryOptimisticRead());</span>
<span class="line-modified">!                 sl.unlockRead(stamp);</span>
<span class="line-modified">!             },</span>
<span class="line-modified">!             () -&gt; {</span>
<span class="line-modified">!                 StampedLock sl = new StampedLock();</span>
<span class="line-modified">!                 long stamp = sl.tryOptimisticRead();</span>
<span class="line-modified">!                 sl.unlock(stamp);</span>
<span class="line-modified">!             },</span>
<span class="line-modified">! </span>
<span class="line-removed">-             () -&gt; {</span>
<span class="line-removed">-                 StampedLock sl = new StampedLock();</span>
<span class="line-removed">-                 long stamp = sl.tryOptimisticRead();</span>
<span class="line-removed">-                 sl.writeLock();</span>
<span class="line-removed">-                 sl.unlock(stamp);</span>
<span class="line-removed">-             },</span>
<span class="line-removed">-             () -&gt; {</span>
<span class="line-removed">-                 StampedLock sl = new StampedLock();</span>
<span class="line-removed">-                 sl.readLock();</span>
<span class="line-removed">-                 long stamp = assertValid(sl, sl.tryOptimisticRead());</span>
<span class="line-removed">-                 sl.unlockRead(stamp);</span>
<span class="line-removed">-             },</span>
<span class="line-removed">-             () -&gt; {</span>
<span class="line-removed">-                 StampedLock sl = new StampedLock();</span>
<span class="line-removed">-                 sl.readLock();</span>
<span class="line-removed">-                 long stamp = assertValid(sl, sl.tryOptimisticRead());</span>
<span class="line-removed">-                 sl.unlock(stamp);</span>
<span class="line-removed">-             },</span>
  
<span class="line-modified">!             () -&gt; {</span>
<span class="line-modified">!                 StampedLock sl = new StampedLock();</span>
<span class="line-modified">!                 long stamp = sl.tryConvertToOptimisticRead(sl.writeLock());</span>
<span class="line-modified">!                 assertValid(sl, stamp);</span>
<span class="line-modified">!                 sl.writeLock();</span>
<span class="line-modified">!                 sl.unlockWrite(stamp);</span>
<span class="line-modified">!             },</span>
<span class="line-modified">!             () -&gt; {</span>
<span class="line-modified">!                 StampedLock sl = new StampedLock();</span>
<span class="line-modified">!                 long stamp = sl.tryConvertToOptimisticRead(sl.writeLock());</span>
<span class="line-modified">!                 sl.writeLock();</span>
<span class="line-modified">!                 sl.unlock(stamp);</span>
<span class="line-modified">!             },</span>
<span class="line-modified">!             () -&gt; {</span>
<span class="line-modified">!                 StampedLock sl = new StampedLock();</span>
<span class="line-modified">!                 long stamp = sl.tryConvertToOptimisticRead(sl.writeLock());</span>
<span class="line-modified">!                 sl.readLock();</span>
<span class="line-modified">!                 sl.unlockRead(stamp);</span>
<span class="line-modified">!             },</span>
<span class="line-modified">!             () -&gt; {</span>
<span class="line-modified">!                 StampedLock sl = new StampedLock();</span>
<span class="line-removed">-                 long stamp = sl.tryConvertToOptimisticRead(sl.writeLock());</span>
<span class="line-removed">-                 sl.readLock();</span>
<span class="line-removed">-                 sl.unlock(stamp);</span>
<span class="line-removed">-             },</span>
  
<span class="line-modified">!             () -&gt; {</span>
<span class="line-modified">!                 StampedLock sl = new StampedLock();</span>
<span class="line-modified">!                 long stamp = sl.tryConvertToOptimisticRead(sl.readLock());</span>
<span class="line-modified">!                 assertValid(sl, stamp);</span>
<span class="line-modified">!                 sl.writeLock();</span>
<span class="line-modified">!                 sl.unlockWrite(stamp);</span>
<span class="line-modified">!             },</span>
<span class="line-modified">!             () -&gt; {</span>
<span class="line-modified">!                 StampedLock sl = new StampedLock();</span>
<span class="line-modified">!                 long stamp = sl.tryConvertToOptimisticRead(sl.readLock());</span>
<span class="line-modified">!                 sl.writeLock();</span>
<span class="line-modified">!                 sl.unlock(stamp);</span>
<span class="line-modified">!             },</span>
<span class="line-modified">!             () -&gt; {</span>
<span class="line-modified">!                 StampedLock sl = new StampedLock();</span>
<span class="line-modified">!                 long stamp = sl.tryConvertToOptimisticRead(sl.readLock());</span>
<span class="line-modified">!                 sl.readLock();</span>
<span class="line-modified">!                 sl.unlockRead(stamp);</span>
<span class="line-modified">!             },</span>
<span class="line-modified">!             () -&gt; {</span>
<span class="line-modified">!                 StampedLock sl = new StampedLock();</span>
<span class="line-modified">!                 sl.readLock();</span>
<span class="line-modified">!                 long stamp = sl.tryConvertToOptimisticRead(sl.readLock());</span>
<span class="line-modified">!                 assertValid(sl, stamp);</span>
<span class="line-modified">!                 sl.readLock();</span>
<span class="line-modified">!                 sl.unlockRead(stamp);</span>
<span class="line-modified">!             },</span>
<span class="line-modified">!             () -&gt; {</span>
<span class="line-modified">!                 StampedLock sl = new StampedLock();</span>
<span class="line-removed">-                 long stamp = sl.tryConvertToOptimisticRead(sl.readLock());</span>
<span class="line-removed">-                 sl.readLock();</span>
<span class="line-removed">-                 sl.unlock(stamp);</span>
<span class="line-removed">-             },</span>
<span class="line-removed">-             () -&gt; {</span>
<span class="line-removed">-                 StampedLock sl = new StampedLock();</span>
<span class="line-removed">-                 sl.readLock();</span>
<span class="line-removed">-                 long stamp = sl.tryConvertToOptimisticRead(sl.readLock());</span>
<span class="line-removed">-                 sl.readLock();</span>
<span class="line-removed">-                 sl.unlock(stamp);</span>
<span class="line-removed">-             },</span>
<span class="line-removed">-         };</span>
  
<span class="line-modified">!         assertThrows(IllegalMonitorStateException.class, actions);</span>
      }
  
      static long writeLockInterruptiblyUninterrupted(StampedLock sl) {
          try { return sl.writeLockInterruptibly(); }
          catch (InterruptedException ex) { throw new AssertionError(ex); }
<span class="line-new-header">--- 1007,121 ---</span>
      /**
       * Passing optimistic read stamps to unlock operations result in
       * IllegalMonitorStateException
       */
      public void testCannotUnlockOptimisticReadStamps() {
<span class="line-modified">!         {</span>
<span class="line-modified">!             StampedLock sl = new StampedLock();</span>
<span class="line-modified">!             long stamp = assertValid(sl, sl.tryOptimisticRead());</span>
<span class="line-modified">!             assertThrows(IllegalMonitorStateException.class,</span>
<span class="line-modified">!                 () -&gt; sl.unlockRead(stamp));</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         {</span>
<span class="line-modified">!             StampedLock sl = new StampedLock();</span>
<span class="line-modified">!             long stamp = sl.tryOptimisticRead();</span>
<span class="line-modified">!             assertThrows(IllegalMonitorStateException.class,</span>
<span class="line-modified">!                 () -&gt; sl.unlock(stamp));</span>
<span class="line-modified">!         }</span>
  
<span class="line-modified">!         {</span>
<span class="line-modified">!             StampedLock sl = new StampedLock();</span>
<span class="line-modified">!             long stamp = sl.tryOptimisticRead();</span>
<span class="line-modified">!             sl.writeLock();</span>
<span class="line-modified">!             assertThrows(IllegalMonitorStateException.class,</span>
<span class="line-modified">!                 () -&gt; sl.unlock(stamp));</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         {</span>
<span class="line-modified">!             StampedLock sl = new StampedLock();</span>
<span class="line-modified">!             sl.readLock();</span>
<span class="line-modified">!             long stamp = assertValid(sl, sl.tryOptimisticRead());</span>
<span class="line-modified">!             assertThrows(IllegalMonitorStateException.class,</span>
<span class="line-modified">!                 () -&gt; sl.unlockRead(stamp));</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         {</span>
<span class="line-modified">!             StampedLock sl = new StampedLock();</span>
<span class="line-modified">!             sl.readLock();</span>
<span class="line-modified">!             long stamp = assertValid(sl, sl.tryOptimisticRead());</span>
<span class="line-modified">!             assertThrows(IllegalMonitorStateException.class,</span>
<span class="line-modified">!                 () -&gt; sl.unlock(stamp));</span>
<span class="line-modified">!         }</span>
  
<span class="line-modified">!         {</span>
<span class="line-modified">!             StampedLock sl = new StampedLock();</span>
<span class="line-modified">!             long stamp = sl.tryConvertToOptimisticRead(sl.writeLock());</span>
<span class="line-modified">!             assertValid(sl, stamp);</span>
<span class="line-modified">!             sl.writeLock();</span>
<span class="line-modified">!             assertThrows(IllegalMonitorStateException.class,</span>
<span class="line-modified">!                 () -&gt; sl.unlockWrite(stamp));</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         {</span>
<span class="line-modified">!             StampedLock sl = new StampedLock();</span>
<span class="line-modified">!             long stamp = sl.tryConvertToOptimisticRead(sl.writeLock());</span>
<span class="line-modified">!             sl.writeLock();</span>
<span class="line-modified">!             assertThrows(IllegalMonitorStateException.class,</span>
<span class="line-modified">!                 () -&gt; sl.unlock(stamp));</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         {</span>
<span class="line-modified">!             StampedLock sl = new StampedLock();</span>
<span class="line-modified">!             long stamp = sl.tryConvertToOptimisticRead(sl.writeLock());</span>
<span class="line-modified">!             sl.readLock();</span>
<span class="line-modified">!             assertThrows(IllegalMonitorStateException.class,</span>
<span class="line-modified">!                 () -&gt; sl.unlockRead(stamp));</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         {</span>
<span class="line-modified">!             StampedLock sl = new StampedLock();</span>
<span class="line-modified">!             long stamp = sl.tryConvertToOptimisticRead(sl.writeLock());</span>
<span class="line-modified">!             sl.readLock();</span>
<span class="line-modified">!             assertThrows(IllegalMonitorStateException.class,</span>
<span class="line-modified">!                 () -&gt; sl.unlock(stamp));</span>
<span class="line-modified">!         }</span>
  
<span class="line-modified">!         {</span>
<span class="line-added">+             StampedLock sl = new StampedLock();</span>
<span class="line-added">+             long stamp = sl.tryConvertToOptimisticRead(sl.readLock());</span>
<span class="line-added">+             assertValid(sl, stamp);</span>
<span class="line-added">+             sl.writeLock();</span>
<span class="line-added">+             assertThrows(IllegalMonitorStateException.class,</span>
<span class="line-added">+                 () -&gt; sl.unlockWrite(stamp));</span>
<span class="line-added">+             }</span>
<span class="line-added">+         {</span>
<span class="line-added">+             StampedLock sl = new StampedLock();</span>
<span class="line-added">+             long stamp = sl.tryConvertToOptimisticRead(sl.readLock());</span>
<span class="line-added">+             sl.writeLock();</span>
<span class="line-added">+             assertThrows(IllegalMonitorStateException.class,</span>
<span class="line-added">+                 () -&gt; sl.unlock(stamp));</span>
<span class="line-added">+         }</span>
<span class="line-added">+         {</span>
<span class="line-added">+             StampedLock sl = new StampedLock();</span>
<span class="line-added">+             long stamp = sl.tryConvertToOptimisticRead(sl.readLock());</span>
<span class="line-added">+             sl.readLock();</span>
<span class="line-added">+             assertThrows(IllegalMonitorStateException.class,</span>
<span class="line-added">+                 () -&gt; sl.unlockRead(stamp));</span>
<span class="line-added">+         }</span>
<span class="line-added">+         {</span>
<span class="line-added">+             StampedLock sl = new StampedLock();</span>
<span class="line-added">+             sl.readLock();</span>
<span class="line-added">+             long stamp = sl.tryConvertToOptimisticRead(sl.readLock());</span>
<span class="line-added">+             assertValid(sl, stamp);</span>
<span class="line-added">+             sl.readLock();</span>
<span class="line-added">+             assertThrows(IllegalMonitorStateException.class,</span>
<span class="line-added">+                 () -&gt; sl.unlockRead(stamp));</span>
<span class="line-added">+         }</span>
<span class="line-added">+         {</span>
<span class="line-added">+             StampedLock sl = new StampedLock();</span>
<span class="line-added">+             long stamp = sl.tryConvertToOptimisticRead(sl.readLock());</span>
<span class="line-added">+             sl.readLock();</span>
<span class="line-added">+             assertThrows(IllegalMonitorStateException.class,</span>
<span class="line-added">+                 () -&gt; sl.unlock(stamp));</span>
<span class="line-added">+         }</span>
<span class="line-added">+         {</span>
<span class="line-added">+             StampedLock sl = new StampedLock();</span>
<span class="line-added">+             sl.readLock();</span>
<span class="line-added">+             long stamp = sl.tryConvertToOptimisticRead(sl.readLock());</span>
<span class="line-added">+             sl.readLock();</span>
<span class="line-added">+             assertThrows(IllegalMonitorStateException.class,</span>
<span class="line-added">+                 () -&gt; sl.unlock(stamp));</span>
<span class="line-added">+         }</span>
      }
  
      static long writeLockInterruptiblyUninterrupted(StampedLock sl) {
          try { return sl.writeLockInterruptibly(); }
          catch (InterruptedException ex) { throw new AssertionError(ex); }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1400,6 ***</span>
<span class="line-new-header">--- 1411,115 ---</span>
                      lock.unlockWrite(writeStamp);
              }
          }
      }
  
<span class="line-added">+     /**</span>
<span class="line-added">+      * Multiple threads repeatedly contend for the same lock.</span>
<span class="line-added">+      */</span>
<span class="line-added">+     public void testConcurrentAccess() throws Exception {</span>
<span class="line-added">+         final StampedLock sl = new StampedLock();</span>
<span class="line-added">+         final Lock wl = sl.asWriteLock();</span>
<span class="line-added">+         final Lock rl = sl.asReadLock();</span>
<span class="line-added">+         final long testDurationMillis = expensiveTests ? 1000 : 2;</span>
<span class="line-added">+         final int nTasks = ThreadLocalRandom.current().nextInt(1, 10);</span>
<span class="line-added">+         final AtomicBoolean done = new AtomicBoolean(false);</span>
<span class="line-added">+         final List&lt;CompletableFuture&gt; futures = new ArrayList&lt;&gt;();</span>
<span class="line-added">+         final List&lt;Callable&lt;Long&gt;&gt; stampedWriteLockers = List.of(</span>
<span class="line-added">+             () -&gt; sl.writeLock(),</span>
<span class="line-added">+             () -&gt; writeLockInterruptiblyUninterrupted(sl),</span>
<span class="line-added">+             () -&gt; tryWriteLockUninterrupted(sl, LONG_DELAY_MS, MILLISECONDS),</span>
<span class="line-added">+             () -&gt; {</span>
<span class="line-added">+                 long stamp;</span>
<span class="line-added">+                 do { stamp = sl.tryConvertToWriteLock(sl.tryOptimisticRead()); }</span>
<span class="line-added">+                 while (stamp == 0L);</span>
<span class="line-added">+                 return stamp;</span>
<span class="line-added">+             },</span>
<span class="line-added">+             () -&gt; {</span>
<span class="line-added">+               long stamp;</span>
<span class="line-added">+               do { stamp = sl.tryWriteLock(); } while (stamp == 0L);</span>
<span class="line-added">+               return stamp;</span>
<span class="line-added">+             },</span>
<span class="line-added">+             () -&gt; {</span>
<span class="line-added">+               long stamp;</span>
<span class="line-added">+               do { stamp = sl.tryWriteLock(0L, DAYS); } while (stamp == 0L);</span>
<span class="line-added">+               return stamp;</span>
<span class="line-added">+             });</span>
<span class="line-added">+         final List&lt;Callable&lt;Long&gt;&gt; stampedReadLockers = List.of(</span>
<span class="line-added">+             () -&gt; sl.readLock(),</span>
<span class="line-added">+             () -&gt; readLockInterruptiblyUninterrupted(sl),</span>
<span class="line-added">+             () -&gt; tryReadLockUninterrupted(sl, LONG_DELAY_MS, MILLISECONDS),</span>
<span class="line-added">+             () -&gt; {</span>
<span class="line-added">+                 long stamp;</span>
<span class="line-added">+                 do { stamp = sl.tryConvertToReadLock(sl.tryOptimisticRead()); }</span>
<span class="line-added">+                 while (stamp == 0L);</span>
<span class="line-added">+                 return stamp;</span>
<span class="line-added">+             },</span>
<span class="line-added">+             () -&gt; {</span>
<span class="line-added">+               long stamp;</span>
<span class="line-added">+               do { stamp = sl.tryReadLock(); } while (stamp == 0L);</span>
<span class="line-added">+               return stamp;</span>
<span class="line-added">+             },</span>
<span class="line-added">+             () -&gt; {</span>
<span class="line-added">+               long stamp;</span>
<span class="line-added">+               do { stamp = sl.tryReadLock(0L, DAYS); } while (stamp == 0L);</span>
<span class="line-added">+               return stamp;</span>
<span class="line-added">+             });</span>
<span class="line-added">+         final List&lt;Consumer&lt;Long&gt;&gt; stampedWriteUnlockers = List.of(</span>
<span class="line-added">+             stamp -&gt; sl.unlockWrite(stamp),</span>
<span class="line-added">+             stamp -&gt; sl.unlock(stamp),</span>
<span class="line-added">+             stamp -&gt; assertTrue(sl.tryUnlockWrite()),</span>
<span class="line-added">+             stamp -&gt; wl.unlock(),</span>
<span class="line-added">+             stamp -&gt; sl.tryConvertToOptimisticRead(stamp));</span>
<span class="line-added">+         final List&lt;Consumer&lt;Long&gt;&gt; stampedReadUnlockers = List.of(</span>
<span class="line-added">+             stamp -&gt; sl.unlockRead(stamp),</span>
<span class="line-added">+             stamp -&gt; sl.unlock(stamp),</span>
<span class="line-added">+             stamp -&gt; assertTrue(sl.tryUnlockRead()),</span>
<span class="line-added">+             stamp -&gt; rl.unlock(),</span>
<span class="line-added">+             stamp -&gt; sl.tryConvertToOptimisticRead(stamp));</span>
<span class="line-added">+         final Action writer = () -&gt; {</span>
<span class="line-added">+             // repeatedly acquires write lock</span>
<span class="line-added">+             var locker = chooseRandomly(stampedWriteLockers);</span>
<span class="line-added">+             var unlocker = chooseRandomly(stampedWriteUnlockers);</span>
<span class="line-added">+             while (!done.getAcquire()) {</span>
<span class="line-added">+                 long stamp = locker.call();</span>
<span class="line-added">+                 try {</span>
<span class="line-added">+                     assertTrue(isWriteLockStamp(stamp));</span>
<span class="line-added">+                     assertTrue(sl.isWriteLocked());</span>
<span class="line-added">+                     assertFalse(isReadLockStamp(stamp));</span>
<span class="line-added">+                     assertFalse(sl.isReadLocked());</span>
<span class="line-added">+                     assertEquals(0, sl.getReadLockCount());</span>
<span class="line-added">+                     assertTrue(sl.validate(stamp));</span>
<span class="line-added">+                 } finally {</span>
<span class="line-added">+                     unlocker.accept(stamp);</span>
<span class="line-added">+                 }</span>
<span class="line-added">+             }</span>
<span class="line-added">+         };</span>
<span class="line-added">+         final Action reader = () -&gt; {</span>
<span class="line-added">+             // repeatedly acquires read lock</span>
<span class="line-added">+             var locker = chooseRandomly(stampedReadLockers);</span>
<span class="line-added">+             var unlocker = chooseRandomly(stampedReadUnlockers);</span>
<span class="line-added">+             while (!done.getAcquire()) {</span>
<span class="line-added">+                 long stamp = locker.call();</span>
<span class="line-added">+                 try {</span>
<span class="line-added">+                     assertFalse(isWriteLockStamp(stamp));</span>
<span class="line-added">+                     assertFalse(sl.isWriteLocked());</span>
<span class="line-added">+                     assertTrue(isReadLockStamp(stamp));</span>
<span class="line-added">+                     assertTrue(sl.isReadLocked());</span>
<span class="line-added">+                     assertTrue(sl.getReadLockCount() &gt; 0);</span>
<span class="line-added">+                     assertTrue(sl.validate(stamp));</span>
<span class="line-added">+                 } finally {</span>
<span class="line-added">+                     unlocker.accept(stamp);</span>
<span class="line-added">+                 }</span>
<span class="line-added">+             }</span>
<span class="line-added">+         };</span>
<span class="line-added">+         for (int i = nTasks; i--&gt; 0; ) {</span>
<span class="line-added">+             Action task = chooseRandomly(writer, reader);</span>
<span class="line-added">+             futures.add(CompletableFuture.runAsync(checkedRunnable(task)));</span>
<span class="line-added">+         }</span>
<span class="line-added">+         Thread.sleep(testDurationMillis);</span>
<span class="line-added">+         done.setRelease(true);</span>
<span class="line-added">+         for (var future : futures)</span>
<span class="line-added">+             checkTimedGet(future, null);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
  }
</pre>
<center><a href="SplittableRandomTest.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="SynchronousQueueTest.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>