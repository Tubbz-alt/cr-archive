<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/java/util/concurrent/TimeUnit/Basic.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="../ScheduledThreadPoolExecutor/GCRetention.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../atomic/DoubleAdderDemo.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/util/concurrent/TimeUnit/Basic.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /* @test
 25  * @bug 5057341 6363898
 26  * @summary Basic tests for TimeUnit

 27  * @author Martin Buchholz
 28  */
 29 
 30 import static java.util.concurrent.TimeUnit.DAYS;
 31 import static java.util.concurrent.TimeUnit.HOURS;
 32 import static java.util.concurrent.TimeUnit.MICROSECONDS;
 33 import static java.util.concurrent.TimeUnit.MILLISECONDS;
 34 import static java.util.concurrent.TimeUnit.MINUTES;
 35 import static java.util.concurrent.TimeUnit.NANOSECONDS;
 36 import static java.util.concurrent.TimeUnit.SECONDS;
 37 
 38 import java.io.ByteArrayInputStream;
 39 import java.io.ByteArrayOutputStream;
 40 import java.io.IOException;
 41 import java.io.InputStream;

 42 import java.io.ObjectOutputStream;
 43 import java.io.ObjectInputStream;
 44 import java.util.Arrays;


 45 import java.util.concurrent.TimeUnit;



 46 
 47 public class Basic {


 48     private static void realMain(String[] args) throws Throwable {
 49 
 50         for (TimeUnit u : TimeUnit.values()) {
 51             System.out.println(u);
 52             check(u instanceof TimeUnit);
 53             equal(42L, u.convert(42, u));
 54             for (TimeUnit v : TimeUnit.values())
 55                 if (u.convert(42, v) &gt;= 42)
 56                     equal(42L, v.convert(u.convert(42, v), u));
 57             check(readObject(serializedForm(u)) == u);
 58         }
 59 
 60         equal(  24L, HOURS.convert       (1, DAYS));
 61         equal(  60L, MINUTES.convert     (1, HOURS));
 62         equal(  60L, SECONDS.convert     (1, MINUTES));
 63         equal(1000L, MILLISECONDS.convert(1, SECONDS));
 64         equal(1000L, MICROSECONDS.convert(1, MILLISECONDS));
 65         equal(1000L, NANOSECONDS.convert (1, MICROSECONDS));
 66 
 67         equal(  24L, DAYS.toHours(1));
 68         equal(  60L, HOURS.toMinutes(1));
 69         equal(  60L, MINUTES.toSeconds(1));
 70         equal(1000L, SECONDS.toMillis(1));
 71         equal(1000L, MILLISECONDS.toMicros(1));
 72         equal(1000L, MICROSECONDS.toNanos(1));
 73 
<span class="line-modified"> 74         long t0 = System.nanoTime();</span>
<span class="line-modified"> 75         MILLISECONDS.sleep(3); /* See windows bug 6313903, might not sleep */</span>
<span class="line-modified"> 76         long elapsedMillis = (System.nanoTime() - t0)/(1000L * 1000L);</span>
<span class="line-modified"> 77         System.out.printf(&quot;elapsed=%d%n&quot;, elapsedMillis);</span>
<span class="line-modified"> 78         check(elapsedMillis &gt;= 0);</span>
<span class="line-modified"> 79         /* Might not sleep on windows: check(elapsedMillis &gt;= 3); */</span>
<span class="line-modified"> 80         check(elapsedMillis &lt; 1000);</span>















 81 
 82         //----------------------------------------------------------------
 83         // Tests for serialized form compatibility with previous release
 84         //----------------------------------------------------------------
<span class="line-modified"> 85         byte[] serializedForm = /* Generated using tiger */</span>
 86             {-84, -19, 0, 5, &#39;~&#39;, &#39;r&#39;, 0, 29, &#39;j&#39;, &#39;a&#39;, &#39;v&#39;, &#39;a&#39;, &#39;.&#39;,
 87              &#39;u&#39;, &#39;t&#39;, &#39;i&#39;, &#39;l&#39;, &#39;.&#39;, &#39;c&#39;, &#39;o&#39;, &#39;n&#39;, &#39;c&#39;, &#39;u&#39;, &#39;r&#39;, &#39;r&#39;, &#39;e&#39;,
 88              &#39;n&#39;, &#39;t&#39;, &#39;.&#39;, &#39;T&#39;, &#39;i&#39;, &#39;m&#39;, &#39;e&#39;, &#39;U&#39;, &#39;n&#39;, &#39;i&#39;, &#39;t&#39;, 0, 0,
 89              0, 0, 0, 0, 0, 0, 18, 0, 0, &#39;x&#39;, &#39;r&#39;, 0, 14,
 90              &#39;j&#39;, &#39;a&#39;, &#39;v&#39;, &#39;a&#39;, &#39;.&#39;, &#39;l&#39;, &#39;a&#39;, &#39;n&#39;, &#39;g&#39;, &#39;.&#39;, &#39;E&#39;, &#39;n&#39;, &#39;u&#39;,
 91              &#39;m&#39;, 0, 0, 0, 0, 0, 0, 0, 0, 18, 0, 0, &#39;x&#39;,
 92              &#39;p&#39;, &#39;t&#39;, 0, 7, &#39;S&#39;, &#39;E&#39;, &#39;C&#39;, &#39;O&#39;, &#39;N&#39;, &#39;D&#39;, &#39;S&#39;, };
 93         check(Arrays.equals(serializedForm(SECONDS), serializedForm));
 94     }
 95 
 96     //--------------------- Infrastructure ---------------------------
 97     static volatile int passed = 0, failed = 0;
 98     static void pass() {passed++;}
 99     static void fail() {failed++; Thread.dumpStack();}
100     static void fail(String msg) {System.out.println(msg); fail();}
101     static void unexpected(Throwable t) {failed++; t.printStackTrace();}
102     static void check(boolean cond) {if (cond) pass(); else fail();}
103     static void equal(Object x, Object y) {
104         if (x == null ? y == null : x.equals(y)) pass();
105         else fail(x + &quot; not equal to &quot; + y);}
</pre>
</td>
<td>
<hr />
<pre>
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /* @test
 25  * @bug 5057341 6363898
 26  * @summary Basic tests for TimeUnit
<span class="line-added"> 27  * @library /test/lib</span>
 28  * @author Martin Buchholz
 29  */
 30 
 31 import static java.util.concurrent.TimeUnit.DAYS;
 32 import static java.util.concurrent.TimeUnit.HOURS;
 33 import static java.util.concurrent.TimeUnit.MICROSECONDS;
 34 import static java.util.concurrent.TimeUnit.MILLISECONDS;
 35 import static java.util.concurrent.TimeUnit.MINUTES;
 36 import static java.util.concurrent.TimeUnit.NANOSECONDS;
 37 import static java.util.concurrent.TimeUnit.SECONDS;
 38 
 39 import java.io.ByteArrayInputStream;
 40 import java.io.ByteArrayOutputStream;
 41 import java.io.IOException;
 42 import java.io.InputStream;
<span class="line-added"> 43 import java.util.List;</span>
 44 import java.io.ObjectOutputStream;
 45 import java.io.ObjectInputStream;
 46 import java.util.Arrays;
<span class="line-added"> 47 import java.util.concurrent.CompletableFuture;</span>
<span class="line-added"> 48 import java.util.concurrent.ThreadLocalRandom;</span>
 49 import java.util.concurrent.TimeUnit;
<span class="line-added"> 50 import java.util.stream.Collectors;</span>
<span class="line-added"> 51 import java.util.stream.IntStream;</span>
<span class="line-added"> 52 import jdk.test.lib.Utils;</span>
 53 
 54 public class Basic {
<span class="line-added"> 55     static final long LONG_DELAY_MS = Utils.adjustTimeout(10_000);</span>
<span class="line-added"> 56 </span>
 57     private static void realMain(String[] args) throws Throwable {
 58 
 59         for (TimeUnit u : TimeUnit.values()) {
 60             System.out.println(u);
 61             check(u instanceof TimeUnit);
 62             equal(42L, u.convert(42, u));
 63             for (TimeUnit v : TimeUnit.values())
 64                 if (u.convert(42, v) &gt;= 42)
 65                     equal(42L, v.convert(u.convert(42, v), u));
 66             check(readObject(serializedForm(u)) == u);
 67         }
 68 
 69         equal(  24L, HOURS.convert       (1, DAYS));
 70         equal(  60L, MINUTES.convert     (1, HOURS));
 71         equal(  60L, SECONDS.convert     (1, MINUTES));
 72         equal(1000L, MILLISECONDS.convert(1, SECONDS));
 73         equal(1000L, MICROSECONDS.convert(1, MILLISECONDS));
 74         equal(1000L, NANOSECONDS.convert (1, MICROSECONDS));
 75 
 76         equal(  24L, DAYS.toHours(1));
 77         equal(  60L, HOURS.toMinutes(1));
 78         equal(  60L, MINUTES.toSeconds(1));
 79         equal(1000L, SECONDS.toMillis(1));
 80         equal(1000L, MILLISECONDS.toMicros(1));
 81         equal(1000L, MICROSECONDS.toNanos(1));
 82 
<span class="line-modified"> 83         //----------------------------------------------------------------</span>
<span class="line-modified"> 84         // TimeUnit.sleep sleeps for at least the specified time.</span>
<span class="line-modified"> 85         // TimeUnit.sleep(x, unit) for x &lt;= 0 does not sleep at all.</span>
<span class="line-modified"> 86         //----------------------------------------------------------------</span>
<span class="line-modified"> 87         ThreadLocalRandom rnd = ThreadLocalRandom.current();</span>
<span class="line-modified"> 88         int maxTimeoutMillis = rnd.nextInt(1, 12);</span>
<span class="line-modified"> 89         List&lt;CompletableFuture&lt;?&gt;&gt; workers =</span>
<span class="line-added"> 90             IntStream.range(-1, maxTimeoutMillis + 1)</span>
<span class="line-added"> 91             .mapToObj(timeoutMillis -&gt; (Runnable) () -&gt; {</span>
<span class="line-added"> 92                 try {</span>
<span class="line-added"> 93                     long startTime = System.nanoTime();</span>
<span class="line-added"> 94                     MILLISECONDS.sleep(timeoutMillis);</span>
<span class="line-added"> 95                     long elapsedNanos = System.nanoTime() - startTime;</span>
<span class="line-added"> 96                     long timeoutNanos = MILLISECONDS.toNanos(timeoutMillis);</span>
<span class="line-added"> 97                     check(elapsedNanos &gt;= timeoutNanos);</span>
<span class="line-added"> 98                 } catch (InterruptedException fail) {</span>
<span class="line-added"> 99                     throw new AssertionError(fail);</span>
<span class="line-added">100                 }})</span>
<span class="line-added">101             .map(CompletableFuture::runAsync)</span>
<span class="line-added">102             .collect(Collectors.toList());</span>
<span class="line-added">103 </span>
<span class="line-added">104         workers.forEach(CompletableFuture&lt;?&gt;::join);</span>
105 
106         //----------------------------------------------------------------
107         // Tests for serialized form compatibility with previous release
108         //----------------------------------------------------------------
<span class="line-modified">109         byte[] serializedForm = /* Generated using JDK 5 */</span>
110             {-84, -19, 0, 5, &#39;~&#39;, &#39;r&#39;, 0, 29, &#39;j&#39;, &#39;a&#39;, &#39;v&#39;, &#39;a&#39;, &#39;.&#39;,
111              &#39;u&#39;, &#39;t&#39;, &#39;i&#39;, &#39;l&#39;, &#39;.&#39;, &#39;c&#39;, &#39;o&#39;, &#39;n&#39;, &#39;c&#39;, &#39;u&#39;, &#39;r&#39;, &#39;r&#39;, &#39;e&#39;,
112              &#39;n&#39;, &#39;t&#39;, &#39;.&#39;, &#39;T&#39;, &#39;i&#39;, &#39;m&#39;, &#39;e&#39;, &#39;U&#39;, &#39;n&#39;, &#39;i&#39;, &#39;t&#39;, 0, 0,
113              0, 0, 0, 0, 0, 0, 18, 0, 0, &#39;x&#39;, &#39;r&#39;, 0, 14,
114              &#39;j&#39;, &#39;a&#39;, &#39;v&#39;, &#39;a&#39;, &#39;.&#39;, &#39;l&#39;, &#39;a&#39;, &#39;n&#39;, &#39;g&#39;, &#39;.&#39;, &#39;E&#39;, &#39;n&#39;, &#39;u&#39;,
115              &#39;m&#39;, 0, 0, 0, 0, 0, 0, 0, 0, 18, 0, 0, &#39;x&#39;,
116              &#39;p&#39;, &#39;t&#39;, 0, 7, &#39;S&#39;, &#39;E&#39;, &#39;C&#39;, &#39;O&#39;, &#39;N&#39;, &#39;D&#39;, &#39;S&#39;, };
117         check(Arrays.equals(serializedForm(SECONDS), serializedForm));
118     }
119 
120     //--------------------- Infrastructure ---------------------------
121     static volatile int passed = 0, failed = 0;
122     static void pass() {passed++;}
123     static void fail() {failed++; Thread.dumpStack();}
124     static void fail(String msg) {System.out.println(msg); fail();}
125     static void unexpected(Throwable t) {failed++; t.printStackTrace();}
126     static void check(boolean cond) {if (cond) pass(); else fail();}
127     static void equal(Object x, Object y) {
128         if (x == null ? y == null : x.equals(y)) pass();
129         else fail(x + &quot; not equal to &quot; + y);}
</pre>
</td>
</tr>
</table>
<center><a href="../ScheduledThreadPoolExecutor/GCRetention.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../atomic/DoubleAdderDemo.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>