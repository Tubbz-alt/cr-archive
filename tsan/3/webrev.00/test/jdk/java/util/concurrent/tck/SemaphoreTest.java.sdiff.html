<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/java/util/concurrent/tck/SemaphoreTest.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="ScheduledExecutorTest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="SplittableRandomTest.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/util/concurrent/tck/SemaphoreTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 21  */
 22 
 23 /*
 24  * This file is available under and governed by the GNU General Public
 25  * License version 2 only, as published by the Free Software Foundation.
 26  * However, the following notice accompanied the original version of this
 27  * file:
 28  *
 29  * Written by Doug Lea with assistance from members of JCP JSR-166
 30  * Expert Group and released to the public domain, as explained at
 31  * http://creativecommons.org/publicdomain/zero/1.0/
 32  * Other contributors include Andrew Wright, Jeffrey Hayes,
 33  * Pat Fisher, Mike Judd.
 34  */
 35 
 36 import static java.util.concurrent.TimeUnit.MILLISECONDS;
 37 
 38 import java.util.Collection;
 39 import java.util.concurrent.CountDownLatch;
 40 import java.util.concurrent.Semaphore;
<span class="line-removed"> 41 import java.util.concurrent.ThreadLocalRandom;</span>
 42 
 43 import junit.framework.Test;
 44 import junit.framework.TestSuite;
 45 
 46 public class SemaphoreTest extends JSR166TestCase {
 47     public static void main(String[] args) {
 48         main(suite(), args);
 49     }
 50     public static Test suite() {
 51         return new TestSuite(SemaphoreTest.class);
 52     }
 53 
 54     /**
 55      * Subclass to expose protected methods
 56      */
 57     static class PublicSemaphore extends Semaphore {
 58         PublicSemaphore(int permits) { super(permits); }
 59         PublicSemaphore(int permits, boolean fair) { super(permits, fair); }
 60         public Collection&lt;Thread&gt; getQueuedThreads() {
 61             return super.getQueuedThreads();
</pre>
<hr />
<pre>
203 
204     /**
205      * tryAcquire succeeds when sufficient permits, else fails
206      */
207     public void testTryAcquireInSameThread()      { testTryAcquireInSameThread(false); }
208     public void testTryAcquireInSameThread_fair() { testTryAcquireInSameThread(true); }
209     public void testTryAcquireInSameThread(boolean fair) {
210         Semaphore s = new Semaphore(2, fair);
211         assertEquals(2, s.availablePermits());
212         assertTrue(s.tryAcquire());
213         assertTrue(s.tryAcquire());
214         assertEquals(0, s.availablePermits());
215         assertFalse(s.tryAcquire());
216         assertFalse(s.tryAcquire());
217         assertEquals(0, s.availablePermits());
218     }
219 
220     /**
221      * timed tryAcquire times out
222      */
<span class="line-modified">223     public void testTryAcquire_timeout() {</span>
<span class="line-modified">224         final boolean fair = ThreadLocalRandom.current().nextBoolean();</span>
225         final Semaphore s = new Semaphore(0, fair);
226         final long startTime = System.nanoTime();
<span class="line-modified">227         try { assertFalse(s.tryAcquire(timeoutMillis(), MILLISECONDS)); }</span>
<span class="line-removed">228         catch (InterruptedException e) { threadUnexpectedException(e); }</span>
229         assertTrue(millisElapsedSince(startTime) &gt;= timeoutMillis());
230     }
231 
232     /**
233      * timed tryAcquire(N) times out
234      */
<span class="line-modified">235     public void testTryAcquireN_timeout() {</span>
<span class="line-modified">236         final boolean fair = ThreadLocalRandom.current().nextBoolean();</span>
237         final Semaphore s = new Semaphore(2, fair);
238         final long startTime = System.nanoTime();
<span class="line-modified">239         try { assertFalse(s.tryAcquire(3, timeoutMillis(), MILLISECONDS)); }</span>
<span class="line-removed">240         catch (InterruptedException e) { threadUnexpectedException(e); }</span>
241         assertTrue(millisElapsedSince(startTime) &gt;= timeoutMillis());
242     }
243 
244     /**
245      * acquire(), acquire(N), timed tryAcquired, timed tryAcquire(N)
246      * are interruptible
247      */
248     public void testInterruptible_acquire()               { testInterruptible(false, AcquireMethod.acquire); }
249     public void testInterruptible_acquire_fair()          { testInterruptible(true,  AcquireMethod.acquire); }
250     public void testInterruptible_acquireN()              { testInterruptible(false, AcquireMethod.acquireN); }
251     public void testInterruptible_acquireN_fair()         { testInterruptible(true,  AcquireMethod.acquireN); }
252     public void testInterruptible_tryAcquireTimed()       { testInterruptible(false, AcquireMethod.tryAcquireTimed); }
253     public void testInterruptible_tryAcquireTimed_fair()  { testInterruptible(true,  AcquireMethod.tryAcquireTimed); }
254     public void testInterruptible_tryAcquireTimedN()      { testInterruptible(false, AcquireMethod.tryAcquireTimedN); }
255     public void testInterruptible_tryAcquireTimedN_fair() { testInterruptible(true,  AcquireMethod.tryAcquireTimedN); }
256     public void testInterruptible(boolean fair, final AcquireMethod acquirer) {
257         final PublicSemaphore s = new PublicSemaphore(0, fair);
258         final java.util.concurrent.CyclicBarrier pleaseInterrupt
259             = new java.util.concurrent.CyclicBarrier(2);
260         Thread t = newStartedThread(new CheckedRunnable() {
</pre>
</td>
<td>
<hr />
<pre>
 21  */
 22 
 23 /*
 24  * This file is available under and governed by the GNU General Public
 25  * License version 2 only, as published by the Free Software Foundation.
 26  * However, the following notice accompanied the original version of this
 27  * file:
 28  *
 29  * Written by Doug Lea with assistance from members of JCP JSR-166
 30  * Expert Group and released to the public domain, as explained at
 31  * http://creativecommons.org/publicdomain/zero/1.0/
 32  * Other contributors include Andrew Wright, Jeffrey Hayes,
 33  * Pat Fisher, Mike Judd.
 34  */
 35 
 36 import static java.util.concurrent.TimeUnit.MILLISECONDS;
 37 
 38 import java.util.Collection;
 39 import java.util.concurrent.CountDownLatch;
 40 import java.util.concurrent.Semaphore;

 41 
 42 import junit.framework.Test;
 43 import junit.framework.TestSuite;
 44 
 45 public class SemaphoreTest extends JSR166TestCase {
 46     public static void main(String[] args) {
 47         main(suite(), args);
 48     }
 49     public static Test suite() {
 50         return new TestSuite(SemaphoreTest.class);
 51     }
 52 
 53     /**
 54      * Subclass to expose protected methods
 55      */
 56     static class PublicSemaphore extends Semaphore {
 57         PublicSemaphore(int permits) { super(permits); }
 58         PublicSemaphore(int permits, boolean fair) { super(permits, fair); }
 59         public Collection&lt;Thread&gt; getQueuedThreads() {
 60             return super.getQueuedThreads();
</pre>
<hr />
<pre>
202 
203     /**
204      * tryAcquire succeeds when sufficient permits, else fails
205      */
206     public void testTryAcquireInSameThread()      { testTryAcquireInSameThread(false); }
207     public void testTryAcquireInSameThread_fair() { testTryAcquireInSameThread(true); }
208     public void testTryAcquireInSameThread(boolean fair) {
209         Semaphore s = new Semaphore(2, fair);
210         assertEquals(2, s.availablePermits());
211         assertTrue(s.tryAcquire());
212         assertTrue(s.tryAcquire());
213         assertEquals(0, s.availablePermits());
214         assertFalse(s.tryAcquire());
215         assertFalse(s.tryAcquire());
216         assertEquals(0, s.availablePermits());
217     }
218 
219     /**
220      * timed tryAcquire times out
221      */
<span class="line-modified">222     public void testTryAcquire_timeout() throws InterruptedException {</span>
<span class="line-modified">223         final boolean fair = randomBoolean();</span>
224         final Semaphore s = new Semaphore(0, fair);
225         final long startTime = System.nanoTime();
<span class="line-modified">226         assertFalse(s.tryAcquire(timeoutMillis(), MILLISECONDS));</span>

227         assertTrue(millisElapsedSince(startTime) &gt;= timeoutMillis());
228     }
229 
230     /**
231      * timed tryAcquire(N) times out
232      */
<span class="line-modified">233     public void testTryAcquireN_timeout() throws InterruptedException {</span>
<span class="line-modified">234         final boolean fair = randomBoolean();</span>
235         final Semaphore s = new Semaphore(2, fair);
236         final long startTime = System.nanoTime();
<span class="line-modified">237         assertFalse(s.tryAcquire(3, timeoutMillis(), MILLISECONDS));</span>

238         assertTrue(millisElapsedSince(startTime) &gt;= timeoutMillis());
239     }
240 
241     /**
242      * acquire(), acquire(N), timed tryAcquired, timed tryAcquire(N)
243      * are interruptible
244      */
245     public void testInterruptible_acquire()               { testInterruptible(false, AcquireMethod.acquire); }
246     public void testInterruptible_acquire_fair()          { testInterruptible(true,  AcquireMethod.acquire); }
247     public void testInterruptible_acquireN()              { testInterruptible(false, AcquireMethod.acquireN); }
248     public void testInterruptible_acquireN_fair()         { testInterruptible(true,  AcquireMethod.acquireN); }
249     public void testInterruptible_tryAcquireTimed()       { testInterruptible(false, AcquireMethod.tryAcquireTimed); }
250     public void testInterruptible_tryAcquireTimed_fair()  { testInterruptible(true,  AcquireMethod.tryAcquireTimed); }
251     public void testInterruptible_tryAcquireTimedN()      { testInterruptible(false, AcquireMethod.tryAcquireTimedN); }
252     public void testInterruptible_tryAcquireTimedN_fair() { testInterruptible(true,  AcquireMethod.tryAcquireTimedN); }
253     public void testInterruptible(boolean fair, final AcquireMethod acquirer) {
254         final PublicSemaphore s = new PublicSemaphore(0, fair);
255         final java.util.concurrent.CyclicBarrier pleaseInterrupt
256             = new java.util.concurrent.CyclicBarrier(2);
257         Thread t = newStartedThread(new CheckedRunnable() {
</pre>
</td>
</tr>
</table>
<center><a href="ScheduledExecutorTest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="SplittableRandomTest.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>