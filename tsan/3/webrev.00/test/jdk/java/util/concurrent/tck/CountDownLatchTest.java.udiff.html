<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/jdk/java/util/concurrent/tck/CountDownLatchTest.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="ConcurrentSkipListMapTest.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="CyclicBarrierTest.java.udiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/util/concurrent/tck/CountDownLatchTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -34,10 +34,11 @@</span>
   */
  
  import static java.util.concurrent.TimeUnit.MILLISECONDS;
  
  import java.util.concurrent.CountDownLatch;
<span class="udiff-line-added">+ import java.util.concurrent.ThreadLocalRandom;</span>
  
  import junit.framework.Test;
  import junit.framework.TestSuite;
  
  public class CountDownLatchTest extends JSR166TestCase {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -97,11 +98,11 @@</span>
  
          await(pleaseCountDown);
          assertEquals(2, l.getCount());
          l.countDown();
          assertEquals(1, l.getCount());
<span class="udiff-line-modified-removed">-         assertThreadBlocks(t, Thread.State.WAITING);</span>
<span class="udiff-line-modified-added">+         if (randomBoolean()) assertThreadBlocks(t, Thread.State.WAITING);</span>
          l.countDown();
          assertEquals(0, l.getCount());
          awaitTermination(t);
      }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -122,11 +123,11 @@</span>
  
          await(pleaseCountDown);
          assertEquals(2, l.getCount());
          l.countDown();
          assertEquals(1, l.getCount());
<span class="udiff-line-modified-removed">-         assertThreadBlocks(t, Thread.State.TIMED_WAITING);</span>
<span class="udiff-line-modified-added">+         if (randomBoolean()) assertThreadBlocks(t, Thread.State.TIMED_WAITING);</span>
          l.countDown();
          assertEquals(0, l.getCount());
          awaitTermination(t);
      }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -154,42 +155,43 @@</span>
  
                  assertEquals(1, l.getCount());
              }});
  
          await(pleaseInterrupt);
<span class="udiff-line-modified-removed">-         assertThreadBlocks(t, Thread.State.WAITING);</span>
<span class="udiff-line-modified-added">+         if (randomBoolean()) assertThreadBlocks(t, Thread.State.WAITING);</span>
          t.interrupt();
          awaitTermination(t);
      }
  
      /**
       * timed await throws InterruptedException if interrupted before counted down
       */
      public void testTimedAwait_Interruptible() {
<span class="udiff-line-modified-removed">-         final CountDownLatch l = new CountDownLatch(1);</span>
<span class="udiff-line-modified-added">+         final int initialCount = ThreadLocalRandom.current().nextInt(1, 3);</span>
<span class="udiff-line-added">+         final CountDownLatch l = new CountDownLatch(initialCount);</span>
          final CountDownLatch pleaseInterrupt = new CountDownLatch(1);
          Thread t = newStartedThread(new CheckedRunnable() {
              public void realRun() throws InterruptedException {
                  Thread.currentThread().interrupt();
                  try {
<span class="udiff-line-modified-removed">-                     l.await(LONG_DELAY_MS, MILLISECONDS);</span>
<span class="udiff-line-modified-added">+                     l.await(randomTimeout(), randomTimeUnit());</span>
                      shouldThrow();
                  } catch (InterruptedException success) {}
                  assertFalse(Thread.interrupted());
  
                  pleaseInterrupt.countDown();
                  try {
<span class="udiff-line-modified-removed">-                     l.await(LONG_DELAY_MS, MILLISECONDS);</span>
<span class="udiff-line-modified-added">+                     l.await(LONGER_DELAY_MS, MILLISECONDS);</span>
                      shouldThrow();
                  } catch (InterruptedException success) {}
                  assertFalse(Thread.interrupted());
  
<span class="udiff-line-modified-removed">-                 assertEquals(1, l.getCount());</span>
<span class="udiff-line-modified-added">+                 assertEquals(initialCount, l.getCount());</span>
              }});
  
          await(pleaseInterrupt);
<span class="udiff-line-modified-removed">-         assertThreadBlocks(t, Thread.State.TIMED_WAITING);</span>
<span class="udiff-line-modified-added">+         if (randomBoolean()) assertThreadBlocks(t, Thread.State.TIMED_WAITING);</span>
          t.interrupt();
          awaitTermination(t);
      }
  
      /**
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -198,11 +200,15 @@</span>
      public void testAwaitTimeout() throws InterruptedException {
          final CountDownLatch l = new CountDownLatch(1);
          Thread t = newStartedThread(new CheckedRunnable() {
              public void realRun() throws InterruptedException {
                  assertEquals(1, l.getCount());
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+                 long startTime = System.nanoTime();</span>
                  assertFalse(l.await(timeoutMillis(), MILLISECONDS));
<span class="udiff-line-added">+                 assertTrue(millisElapsedSince(startTime) &gt;= timeoutMillis());</span>
<span class="udiff-line-added">+ </span>
                  assertEquals(1, l.getCount());
              }});
  
          awaitTermination(t);
          assertEquals(1, l.getCount());
</pre>
<center><a href="ConcurrentSkipListMapTest.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="CyclicBarrierTest.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>