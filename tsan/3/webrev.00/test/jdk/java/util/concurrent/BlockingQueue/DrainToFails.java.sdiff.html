<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/java/util/concurrent/BlockingQueue/DrainToFails.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="../../TimeZone/TimeZoneTest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="OfferDrainToLoops.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/util/concurrent/BlockingQueue/DrainToFails.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 18  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 19  * or visit www.oracle.com if you need additional information or have any
 20  * questions.
 21  */
 22 
 23 /*
 24  * This file is available under and governed by the GNU General Public
 25  * License version 2 only, as published by the Free Software Foundation.
 26  * However, the following notice accompanied the original version of this
 27  * file:
 28  *
 29  * Written by Doug Lea and Martin Buchholz with assistance from
 30  * members of JCP JSR-166 Expert Group and released to the public
 31  * domain, as explained at
 32  * http://creativecommons.org/publicdomain/zero/1.0/
 33  */
 34 
 35 /*
 36  * @test
 37  * @summary Test drainTo failing due to c.add throwing

 38  */
 39 
 40 import java.util.ArrayList;
 41 import java.util.List;
 42 import java.util.concurrent.DelayQueue;
 43 import java.util.concurrent.Delayed;
 44 import java.util.concurrent.ArrayBlockingQueue;
 45 import java.util.concurrent.BlockingQueue;
 46 import java.util.concurrent.LinkedBlockingDeque;
 47 import java.util.concurrent.LinkedBlockingQueue;
 48 import java.util.concurrent.FutureTask;
 49 import java.util.concurrent.PriorityBlockingQueue;
 50 import java.util.concurrent.RunnableScheduledFuture;
 51 import java.util.concurrent.ScheduledThreadPoolExecutor;
 52 import java.util.concurrent.TimeUnit;

 53 
 54 @SuppressWarnings({&quot;unchecked&quot;, &quot;rawtypes&quot;})
 55 public class DrainToFails {

 56     final int CAPACITY = 10;
 57     final int SMALL = 2;
 58 
 59     void test(String[] args) throws Throwable {
 60         testDelayQueue(new DelayQueue());
 61         testDelayQueue(new ScheduledThreadPoolExecutor(1).getQueue());
 62 
 63         testUnbounded(new LinkedBlockingQueue());
 64         testUnbounded(new LinkedBlockingDeque());
 65         testUnbounded(new PriorityBlockingQueue());
 66 
 67         testBounded(new LinkedBlockingQueue(CAPACITY));
 68         testBounded(new LinkedBlockingDeque(CAPACITY));
 69         testBounded(new ArrayBlockingQueue(CAPACITY));
 70     }
 71 
 72     static class PDelay
 73         extends FutureTask&lt;Void&gt;
 74         implements Delayed, RunnableScheduledFuture&lt;Void&gt; {
 75         int pseudodelay;
</pre>
<hr />
<pre>
152             putters.add(putter);
153             putter.setDaemon(true);
154             putter.start();
155         }
156         ArrayBlockingQueue q2 = new ArrayBlockingQueue(SMALL);
157         try {
158             q.drainTo(q2, 7);
159             fail(&quot;should throw&quot;);
160         } catch (IllegalStateException success) {
161             while (q.size() &lt; CAPACITY)
162                 Thread.yield();
163             assertContentsInOrder(q2, 0, 1);
164             q2.clear();
165         }
166 
167         try {
168             q.drainTo(q2);
169             fail(&quot;should throw&quot;);
170         } catch (IllegalStateException success) {
171             for (Thread putter : putters) {
<span class="line-modified">172                 putter.join(2000L);</span>
173                 check(! putter.isAlive());
174             }
175             assertContentsInOrder(q2, 2, 3);
176             for (int i = 2 * SMALL; i &lt; CAPACITY; i++)
177                 equal(i, q.poll());
178             equal(4, q.size());
179             check(q.contains(42));
180             check(q.contains(43));
181             check(q.contains(44));
182             check(q.contains(45));
183         }
184     }
185 
<span class="line-modified">186     Runnable putter(final BlockingQueue q, final int elt) {</span>
<span class="line-modified">187         return new Runnable() {</span>
<span class="line-modified">188             public void run() {</span>
<span class="line-modified">189                 try { q.put(elt); }</span>
<span class="line-removed">190                 catch (Throwable t) { unexpected(t); }}};</span>
191     }
192 
193     void assertContentsInOrder(Iterable it, Object... contents) {
194         int i = 0;
195         for (Object e : it)
196             equal(contents[i++], e);
197         equal(contents.length, i);
198     }
199 
200     //--------------------- Infrastructure ---------------------------
201     volatile int passed = 0, failed = 0;
202     void pass() {passed++;}
203     void fail() {failed++; Thread.dumpStack();}
204     void fail(String msg) {System.err.println(msg); fail();}
205     void unexpected(Throwable t) {failed++; t.printStackTrace();}
206     void check(boolean cond) {if (cond) pass(); else fail();}
207     void equal(Object x, Object y) {
208         if (x == null ? y == null : x.equals(y)) pass();
209         else fail(x + &quot; not equal to &quot; + y);}
210     public static void main(String[] args) throws Throwable {
</pre>
</td>
<td>
<hr />
<pre>
 18  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 19  * or visit www.oracle.com if you need additional information or have any
 20  * questions.
 21  */
 22 
 23 /*
 24  * This file is available under and governed by the GNU General Public
 25  * License version 2 only, as published by the Free Software Foundation.
 26  * However, the following notice accompanied the original version of this
 27  * file:
 28  *
 29  * Written by Doug Lea and Martin Buchholz with assistance from
 30  * members of JCP JSR-166 Expert Group and released to the public
 31  * domain, as explained at
 32  * http://creativecommons.org/publicdomain/zero/1.0/
 33  */
 34 
 35 /*
 36  * @test
 37  * @summary Test drainTo failing due to c.add throwing
<span class="line-added"> 38  * @library /test/lib</span>
 39  */
 40 
 41 import java.util.ArrayList;
 42 import java.util.List;
 43 import java.util.concurrent.DelayQueue;
 44 import java.util.concurrent.Delayed;
 45 import java.util.concurrent.ArrayBlockingQueue;
 46 import java.util.concurrent.BlockingQueue;
 47 import java.util.concurrent.LinkedBlockingDeque;
 48 import java.util.concurrent.LinkedBlockingQueue;
 49 import java.util.concurrent.FutureTask;
 50 import java.util.concurrent.PriorityBlockingQueue;
 51 import java.util.concurrent.RunnableScheduledFuture;
 52 import java.util.concurrent.ScheduledThreadPoolExecutor;
 53 import java.util.concurrent.TimeUnit;
<span class="line-added"> 54 import jdk.test.lib.Utils;</span>
 55 
 56 @SuppressWarnings({&quot;unchecked&quot;, &quot;rawtypes&quot;})
 57 public class DrainToFails {
<span class="line-added"> 58     static final long LONG_DELAY_MS = Utils.adjustTimeout(10_000);</span>
 59     final int CAPACITY = 10;
 60     final int SMALL = 2;
 61 
 62     void test(String[] args) throws Throwable {
 63         testDelayQueue(new DelayQueue());
 64         testDelayQueue(new ScheduledThreadPoolExecutor(1).getQueue());
 65 
 66         testUnbounded(new LinkedBlockingQueue());
 67         testUnbounded(new LinkedBlockingDeque());
 68         testUnbounded(new PriorityBlockingQueue());
 69 
 70         testBounded(new LinkedBlockingQueue(CAPACITY));
 71         testBounded(new LinkedBlockingDeque(CAPACITY));
 72         testBounded(new ArrayBlockingQueue(CAPACITY));
 73     }
 74 
 75     static class PDelay
 76         extends FutureTask&lt;Void&gt;
 77         implements Delayed, RunnableScheduledFuture&lt;Void&gt; {
 78         int pseudodelay;
</pre>
<hr />
<pre>
155             putters.add(putter);
156             putter.setDaemon(true);
157             putter.start();
158         }
159         ArrayBlockingQueue q2 = new ArrayBlockingQueue(SMALL);
160         try {
161             q.drainTo(q2, 7);
162             fail(&quot;should throw&quot;);
163         } catch (IllegalStateException success) {
164             while (q.size() &lt; CAPACITY)
165                 Thread.yield();
166             assertContentsInOrder(q2, 0, 1);
167             q2.clear();
168         }
169 
170         try {
171             q.drainTo(q2);
172             fail(&quot;should throw&quot;);
173         } catch (IllegalStateException success) {
174             for (Thread putter : putters) {
<span class="line-modified">175                 putter.join(LONG_DELAY_MS);</span>
176                 check(! putter.isAlive());
177             }
178             assertContentsInOrder(q2, 2, 3);
179             for (int i = 2 * SMALL; i &lt; CAPACITY; i++)
180                 equal(i, q.poll());
181             equal(4, q.size());
182             check(q.contains(42));
183             check(q.contains(43));
184             check(q.contains(44));
185             check(q.contains(45));
186         }
187     }
188 
<span class="line-modified">189     Runnable putter(BlockingQueue q, int elt) {</span>
<span class="line-modified">190         return () -&gt; {</span>
<span class="line-modified">191             try { q.put(elt); }</span>
<span class="line-modified">192             catch (Throwable t) { unexpected(t); }};</span>

193     }
194 
195     void assertContentsInOrder(Iterable it, Object... contents) {
196         int i = 0;
197         for (Object e : it)
198             equal(contents[i++], e);
199         equal(contents.length, i);
200     }
201 
202     //--------------------- Infrastructure ---------------------------
203     volatile int passed = 0, failed = 0;
204     void pass() {passed++;}
205     void fail() {failed++; Thread.dumpStack();}
206     void fail(String msg) {System.err.println(msg); fail();}
207     void unexpected(Throwable t) {failed++; t.printStackTrace();}
208     void check(boolean cond) {if (cond) pass(); else fail();}
209     void equal(Object x, Object y) {
210         if (x == null ? y == null : x.equals(y)) pass();
211         else fail(x + &quot; not equal to &quot; + y);}
212     public static void main(String[] args) throws Throwable {
</pre>
</td>
</tr>
</table>
<center><a href="../../TimeZone/TimeZoneTest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="OfferDrainToLoops.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>