<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/jdk/java/util/Locale/Bug8040211.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
    <script type="text/javascript" src="../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2016, 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
<a name="2" id="anc2"></a><span class="line-modified"> 26  * @bug 8040211 8191404 8203872</span>
 27  * @summary Checks the IANA language subtag registry data update
<a name="3" id="anc3"></a><span class="line-modified"> 28  *          (LSR Revision: 2018-04-23) with Locale and Locale.LanguageRange</span>
 29  *          class methods.
 30  * @run main Bug8040211
 31  */
 32 
 33 import java.util.ArrayList;
 34 import java.util.Iterator;
 35 import java.util.Locale;
 36 import java.util.List;
 37 import java.util.Locale.LanguageRange;
 38 import java.util.Locale.FilteringMode;
 39 import static java.util.Locale.FilteringMode.EXTENDED_FILTERING;
 40 
 41 public class Bug8040211 {
 42 
 43     static boolean err = false;
 44 
<a name="4" id="anc4"></a>













































































 45     public static void main(String[] args) {
 46         testLanguageRange();
 47         testLocale();
 48 
 49         if (err) {
 50             throw new RuntimeException(&quot;Failed.&quot;);
 51         }
 52     }
 53 
 54     private static void testLanguageRange() {
 55         System.out.println(&quot;Test LanguageRange class parse method...&quot;);
 56         test_parse();
 57     }
 58 
 59     private static void testLocale() {
 60         System.out.println(&quot;Test Locale class methods...&quot;);
 61         test_filter();
 62         test_filterTags();
 63         test_lookup();
 64         test_lookupTag();
 65     }
 66 
 67     private static void test_parse() {
 68         boolean error = false;
<a name="5" id="anc5"></a><span class="line-modified"> 69         String str = &quot;Accept-Language: aam, adp, aue, bcg, cqu, ema,&quot;</span>
<span class="line-modified"> 70                 + &quot; en-gb-oed, gti, kdz, koj, kwq, kxe, lii, lmm, mtm, ngv,&quot;</span>
<span class="line-removed"> 71                 + &quot; oyb, phr, pub, suj, taj;q=0.9, ar-hyw;q=0.8, yug;q=0.5, gfx;q=0.4&quot;;</span>
<span class="line-removed"> 72         ArrayList&lt;LanguageRange&gt; expected = new ArrayList&lt;&gt;();</span>
<span class="line-removed"> 73         expected.add(new LanguageRange(&quot;aam&quot;, 1.0));</span>
<span class="line-removed"> 74         expected.add(new LanguageRange(&quot;aas&quot;, 1.0));</span>
<span class="line-removed"> 75         expected.add(new LanguageRange(&quot;adp&quot;, 1.0));</span>
<span class="line-removed"> 76         expected.add(new LanguageRange(&quot;dz&quot;, 1.0));</span>
<span class="line-removed"> 77         expected.add(new LanguageRange(&quot;aue&quot;, 1.0));</span>
<span class="line-removed"> 78         expected.add(new LanguageRange(&quot;ktz&quot;, 1.0));</span>
<span class="line-removed"> 79         expected.add(new LanguageRange(&quot;bcg&quot;, 1.0));</span>
<span class="line-removed"> 80         expected.add(new LanguageRange(&quot;bgm&quot;, 1.0));</span>
<span class="line-removed"> 81         expected.add(new LanguageRange(&quot;cqu&quot;, 1.0));</span>
<span class="line-removed"> 82         expected.add(new LanguageRange(&quot;quh&quot;, 1.0));</span>
<span class="line-removed"> 83         expected.add(new LanguageRange(&quot;ema&quot;, 1.0));</span>
<span class="line-removed"> 84         expected.add(new LanguageRange(&quot;uok&quot;, 1.0));</span>
<span class="line-removed"> 85         expected.add(new LanguageRange(&quot;en-gb-oed&quot;, 1.0));</span>
<span class="line-removed"> 86         expected.add(new LanguageRange(&quot;en-gb-oxendict&quot;, 1.0));</span>
<span class="line-removed"> 87         expected.add(new LanguageRange(&quot;gti&quot;, 1.0));</span>
<span class="line-removed"> 88         expected.add(new LanguageRange(&quot;nyc&quot;, 1.0));</span>
<span class="line-removed"> 89         expected.add(new LanguageRange(&quot;kdz&quot;, 1.0));</span>
<span class="line-removed"> 90         expected.add(new LanguageRange(&quot;ncp&quot;, 1.0));</span>
<span class="line-removed"> 91         expected.add(new LanguageRange(&quot;koj&quot;, 1.0));</span>
<span class="line-removed"> 92         expected.add(new LanguageRange(&quot;kwv&quot;, 1.0));</span>
<span class="line-removed"> 93         expected.add(new LanguageRange(&quot;kwq&quot;, 1.0));</span>
<span class="line-removed"> 94         expected.add(new LanguageRange(&quot;yam&quot;, 1.0));</span>
<span class="line-removed"> 95         expected.add(new LanguageRange(&quot;kxe&quot;, 1.0));</span>
<span class="line-removed"> 96         expected.add(new LanguageRange(&quot;tvd&quot;, 1.0));</span>
<span class="line-removed"> 97         expected.add(new LanguageRange(&quot;lii&quot;, 1.0));</span>
<span class="line-removed"> 98         expected.add(new LanguageRange(&quot;raq&quot;, 1.0));</span>
<span class="line-removed"> 99         expected.add(new LanguageRange(&quot;lmm&quot;, 1.0));</span>
<span class="line-removed">100         expected.add(new LanguageRange(&quot;rmx&quot;, 1.0));</span>
<span class="line-removed">101         expected.add(new LanguageRange(&quot;mtm&quot;, 1.0));</span>
<span class="line-removed">102         expected.add(new LanguageRange(&quot;ymt&quot;, 1.0));</span>
<span class="line-removed">103         expected.add(new LanguageRange(&quot;ngv&quot;, 1.0));</span>
<span class="line-removed">104         expected.add(new LanguageRange(&quot;nnx&quot;, 1.0));</span>
<span class="line-removed">105         expected.add(new LanguageRange(&quot;oyb&quot;, 1.0));</span>
<span class="line-removed">106         expected.add(new LanguageRange(&quot;thx&quot;, 1.0));</span>
<span class="line-removed">107         expected.add(new LanguageRange(&quot;skk&quot;, 1.0));</span>
<span class="line-removed">108         expected.add(new LanguageRange(&quot;jeg&quot;, 1.0));</span>
<span class="line-removed">109         expected.add(new LanguageRange(&quot;phr&quot;, 1.0));</span>
<span class="line-removed">110         expected.add(new LanguageRange(&quot;pmu&quot;, 1.0));</span>
<span class="line-removed">111         expected.add(new LanguageRange(&quot;pub&quot;, 1.0));</span>
<span class="line-removed">112         expected.add(new LanguageRange(&quot;puz&quot;, 1.0));</span>
<span class="line-removed">113         expected.add(new LanguageRange(&quot;suj&quot;, 1.0));</span>
<span class="line-removed">114         expected.add(new LanguageRange(&quot;xsj&quot;, 1.0));</span>
<span class="line-removed">115         expected.add(new LanguageRange(&quot;taj&quot;, 0.9));</span>
<span class="line-removed">116         expected.add(new LanguageRange(&quot;tsf&quot;, 0.9));</span>
<span class="line-removed">117         expected.add(new LanguageRange(&quot;ar-hyw&quot;, 0.8));</span>
<span class="line-removed">118         expected.add(new LanguageRange(&quot;ar-arevmda&quot;, 0.8));</span>
<span class="line-removed">119         expected.add(new LanguageRange(&quot;yug&quot;, 0.5));</span>
<span class="line-removed">120         expected.add(new LanguageRange(&quot;yuu&quot;, 0.5));</span>
<span class="line-removed">121         expected.add(new LanguageRange(&quot;gfx&quot;, 0.4));</span>
<span class="line-removed">122         expected.add(new LanguageRange(&quot;oun&quot;, 0.4));</span>
<span class="line-removed">123         expected.add(new LanguageRange(&quot;mwj&quot;, 0.4));</span>
<span class="line-removed">124         expected.add(new LanguageRange(&quot;vaj&quot;, 0.4));</span>
<span class="line-removed">125         List&lt;LanguageRange&gt; got = LanguageRange.parse(str);</span>
<span class="line-removed">126         if (!areEqual(expected, got)) {</span>
127             error = true;
128             System.err.println(&quot;    language parse() test failed.&quot;);
129         }
130 
131         if (error) {
132             err = true;
<a name="6" id="anc6"></a><span class="line-modified">133             System.err.println(&quot;  test_parse() failed.&quot;);</span>
134         } else {
135             System.out.println(&quot;  test_parse() passed.&quot;);
136         }
137 
138     }
139 
140     private static boolean areEqual(List&lt;LanguageRange&gt; expected,
141             List&lt;LanguageRange&gt; got) {
142         boolean error = false;
143 
144         int expectedSize = expected.size();
145         int actualSize = got.size();
146 
147         if (expectedSize != actualSize) {
148             error = true;
149 
150             System.err.println(&quot;  Expected size=&quot; + expectedSize);
151             for (LanguageRange lr : expected) {
152                 System.err.println(&quot;    range=&quot; + lr.getRange()
153                         + &quot;, weight=&quot; + lr.getWeight());
154             }
155 
<a name="7" id="anc7"></a><span class="line-modified">156             System.out.println(&quot;  Actual size=&quot; + actualSize);</span>
157             for (LanguageRange lr : got) {
158                 System.err.println(&quot;    range=&quot; + lr.getRange()
159                         + &quot;, weight=&quot; + lr.getWeight());
160             }
161         } else {
162             for (int i = 0; i &lt; expectedSize; i++) {
163                 LanguageRange lr1 = expected.get(i);
164                 LanguageRange lr2 = got.get(i);
165 
166                 if (!lr1.getRange().equals(lr2.getRange())
167                         || lr1.getWeight() != lr2.getWeight()) {
168                     error = true;
169                     System.err.println(&quot;  &quot; + i + &quot;: Expected: range=&quot; + lr1.getRange()
170                             + &quot;, weight=&quot; + lr1.getWeight());
171                     System.err.println(&quot;  &quot; + i + &quot;: Actual:   range=&quot; + lr2.getRange()
172                             + &quot;, weight=&quot; + lr2.getWeight());
173                 }
174             }
175         }
176 
177         return !error;
178     }
179 
180     private static void test_filter() {
181         boolean error = false;
182 
183         String ranges = &quot;mtm-RU, en-gb-oed, coy, ar-HY&quot;;
184         String tags = &quot;de-DE, en, mtm-RU, ymt-RU, en-gb-oxendict, ja-JP, pij, nts, ar-arevela&quot;;
185         FilteringMode mode = EXTENDED_FILTERING;
186 
187         List&lt;LanguageRange&gt; priorityList = LanguageRange.parse(ranges);
188         List&lt;Locale&gt; tagList = generateLocales(tags);
189         String actualLocales
190                 = showLocales(Locale.filter(priorityList, tagList, mode));
<a name="8" id="anc8"></a><span class="line-modified">191         String expectedLocales = &quot;mtm-RU, ymt-RU, en-GB-oxendict, nts, pij, ar-arevela&quot;;</span>
192 
193         if (!expectedLocales.equals(actualLocales)) {
194             error = true;
195             showErrorMessage(&quot;#1 filter(&quot; + mode + &quot;)&quot;,
196                     ranges, tags, expectedLocales, actualLocales);
197         }
198 
199         ranges = &quot;phr-*-IN, ja-JP&quot;;
200         tags = &quot;en, pmu-Guru-IN, ja-Latn-JP, iw&quot;;
201         mode = EXTENDED_FILTERING;
202 
203         priorityList = LanguageRange.parse(ranges);
204         tagList = generateLocales(tags);
205         actualLocales = showLocales(Locale.filter(priorityList, tagList, mode));
206         expectedLocales = &quot;pmu-Guru-IN, ja-Latn-JP&quot;;
207 
208         if (!expectedLocales.equals(actualLocales)) {
209             error = true;
210             showErrorMessage(&quot;#2 filter(&quot; + mode + &quot;)&quot;,
211                     ranges, tags, expectedLocales, actualLocales);
212         }
213 
214         if (error) {
215             err = true;
216             System.out.println(&quot;  test_filter() failed.&quot;);
217         } else {
218             System.out.println(&quot;  test_filter() passed.&quot;);
219         }
220     }
221 
222     private static void test_filterTags() {
223         boolean error = false;
224 
225         String ranges = &quot;gti;q=0.2, gfx, kzj&quot;;
226         String tags = &quot;de-DE, gti, he, nyc, mwj, vaj, ktr, dtp&quot;;
227 
228         List&lt;LanguageRange&gt; priorityList = LanguageRange.parse(ranges);
229         List&lt;String&gt; tagList = generateLanguageTags(tags);
230         String actualTags
231                 = showLanguageTags(Locale.filterTags(priorityList, tagList));
232         String expectedTags = &quot;mwj, vaj, ktr, dtp, gti, nyc&quot;;
233 
234         if (!expectedTags.equals(actualTags)) {
235             error = true;
236             showErrorMessage(&quot;filterTags()&quot;,
237                     ranges, tags, expectedTags, actualTags);
238         }
239 
240         if (error) {
241             err = true;
242             System.out.println(&quot;  test_filterTags() failed.&quot;);
243         } else {
244             System.out.println(&quot;  test_filterTags() passed.&quot;);
245         }
246     }
247 
248     private static void test_lookup() {
249         boolean error = false;
250 
251         String ranges = &quot;en;q=0.2, yam, rmx;q=0.9&quot;;
252         String tags = &quot;de-DE, en, kwq, lmm&quot;;
253         List&lt;LanguageRange&gt; priorityList = LanguageRange.parse(ranges);
254         List&lt;Locale&gt; localeList = generateLocales(tags);
255         String actualLocale
256                 = Locale.lookup(priorityList, localeList).toLanguageTag();
257         String expectedLocale = &quot;kwq&quot;;
258 
259         if (!expectedLocale.equals(actualLocale)) {
260             error = true;
261             showErrorMessage(&quot;lookup()&quot;, ranges, tags, expectedLocale, actualLocale);
262         }
263 
264         if (error) {
265             err = true;
266             System.out.println(&quot;  test_lookup() failed.&quot;);
267         } else {
268             System.out.println(&quot;  test_lookup() passed.&quot;);
269         }
270     }
271 
272     private static void test_lookupTag() {
273         boolean error = false;
274 
275         String ranges = &quot;en, tsf;q=0.2&quot;;
276         String tags = &quot;es, ja-JP, taj&quot;;
277         List&lt;LanguageRange&gt; priorityList = LanguageRange.parse(ranges);
278         List&lt;String&gt; tagList = generateLanguageTags(tags);
279         String actualTag = Locale.lookupTag(priorityList, tagList);
280         String expectedTag = &quot;taj&quot;;
281 
282         if (!expectedTag.equals(actualTag)) {
283             error = true;
284             showErrorMessage(&quot;lookupTag()&quot;, ranges, tags, expectedTag, actualTag);
285         }
286 
287         if (error) {
288             err = true;
289             System.out.println(&quot;  test_lookupTag() failed.&quot;);
290         } else {
291             System.out.println(&quot;  test_lookupTag() passed.&quot;);
292         }
293     }
294 
295     private static List&lt;Locale&gt; generateLocales(String tags) {
296         if (tags == null) {
297             return null;
298         }
299 
300         List&lt;Locale&gt; localeList = new ArrayList&lt;&gt;();
301         if (tags.equals(&quot;&quot;)) {
302             return localeList;
303         }
304         String[] t = tags.split(&quot;, &quot;);
305         for (String tag : t) {
306             localeList.add(Locale.forLanguageTag(tag));
307         }
308         return localeList;
309     }
310 
311     private static List&lt;String&gt; generateLanguageTags(String tags) {
312         List&lt;String&gt; tagList = new ArrayList&lt;&gt;();
313         String[] t = tags.split(&quot;, &quot;);
314         for (String tag : t) {
315             tagList.add(tag);
316         }
317         return tagList;
318     }
319 
320     private static String showLanguageTags(List&lt;String&gt; tags) {
321         StringBuilder sb = new StringBuilder();
322 
323         Iterator&lt;String&gt; itr = tags.iterator();
324         if (itr.hasNext()) {
325             sb.append(itr.next());
326         }
327         while (itr.hasNext()) {
328             sb.append(&quot;, &quot;);
329             sb.append(itr.next());
330         }
331 
332         return sb.toString().trim();
333     }
334 
335     private static String showLocales(List&lt;Locale&gt; locales) {
336         StringBuilder sb = new StringBuilder();
337 
338         java.util.Iterator&lt;Locale&gt; itr = locales.iterator();
339         if (itr.hasNext()) {
340             sb.append(itr.next().toLanguageTag());
341         }
342         while (itr.hasNext()) {
343             sb.append(&quot;, &quot;);
344             sb.append(itr.next().toLanguageTag());
345         }
346 
347         return sb.toString().trim();
348     }
349 
350     private static void showErrorMessage(String methodName,
351             String priorityList,
352             String tags,
353             String expectedTags,
354             String actualTags) {
<a name="9" id="anc9"></a><span class="line-modified">355         System.out.println(&quot;\nIncorrect &quot; + methodName + &quot; result.&quot;);</span>
<span class="line-modified">356         System.out.println(&quot;  Priority list  :  &quot; + priorityList);</span>
<span class="line-modified">357         System.out.println(&quot;  Language tags  :  &quot; + tags);</span>
<span class="line-modified">358         System.out.println(&quot;  Expected value : &quot; + expectedTags);</span>
<span class="line-modified">359         System.out.println(&quot;  Actual value   : &quot; + actualTags);</span>
360     }
361 
362 }
363 
<a name="10" id="anc10"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="10" type="hidden" />
</body>
</html>