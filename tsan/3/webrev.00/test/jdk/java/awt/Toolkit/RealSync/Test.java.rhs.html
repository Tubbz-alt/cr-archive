<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/jdk/java/awt/Toolkit/RealSync/Test.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2005, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25   @test
 26   @bug 6252005
 27   @key headful
 28   @summary Tests that realSync feature works
 29   @author denis.mikhalkin: area=awt.toolkit
 30   @modules java.desktop/sun.awt
 31   @run main/timeout=6000 Test
 32 */
 33 
 34 import java.awt.*;
 35 import java.awt.event.*;
 36 import java.util.LinkedList;
 37 import java.util.Collections;
 38 import java.lang.reflect.Method;
 39 import java.lang.reflect.Modifier;
 40 import javax.swing.*;
 41 import java.awt.image.*;
 42 import javax.imageio.*;
 43 import java.io.*;
 44 
 45 /**
 46  * Tests various problematic areas and how they are fixed using real-sync API:
 47  * - requesting focus
 48  * - showing and robot mouse pressing
 49  * - showing and getting location on screen
 50  * - showing and typing
 51  */
 52 
 53 public class Test {
 54     private static boolean doRealSync = true;
 55     private static boolean someFailed = false;
 56     private static Robot robot;
 57     public static void main(String[] args) {
 58         installListeners();
 59 
 60         try {
 61             robot = new Robot();
 62         } catch (Exception e) {
 63             e.printStackTrace();
 64             return;
 65         }
 66 
 67 
 68         int count = 100;
 69         String method = null;
 70         if (args.length != 0) {
 71             try {
 72                 count = Integer.parseInt(args[0]);
 73             } catch (NumberFormatException nfe) {
 74                 method = args[0];
 75                 count = 1;
 76             }
 77         }
 78         while (count &gt; 0 &amp;&amp; !someFailed) {
 79             run(method);
 80             gc();
 81             count--;
 82         }
 83 
 84         System.err.println(&quot;Total results: &quot; + (someFailed? (&quot;some tests failed (&quot; + count + &quot;)&quot;): &quot;ALL TESTS PASSED!!!&quot;));
 85     }
 86 
 87     private static void gc() {
 88         System.gc();
 89         sleep(50);
 90         System.gc();
 91         Thread.yield();
 92         System.gc();
 93     }
 94 
 95     private static void sleep(int time) {
 96         try {
 97             Thread.sleep(time);
 98         } catch (InterruptedException ie) {
 99         }
100     }
101 
102     private static java.util.List&lt;Object&gt; events = Collections.synchronizedList(new LinkedList&lt;Object&gt;());
103 
104     private static class TestFailureException extends RuntimeException {
105     }
106 
107     public static void run(String method) {
108         Class cl = Test.class;
109         for (Method m : cl.getMethods()) {
110             if (Modifier.isStatic(m.getModifiers()) &amp;&amp; m.getName().startsWith(&quot;test&quot;) &amp;&amp; method == null ||
111                 (method != null &amp;&amp; method.equals(m.getName()))) {
112                 realSync(null);
113                 events.clear();
114                 try {
115                     m.invoke(null);
116                 } catch (TestFailureException e) {
117                     // Do nothing
118                 } catch (Exception e) {
119                     fail(e);
120                 }
121                 reportErrors(m);
122             }
123         }
124     }
125 
126     private static java.util.List&lt;Object&gt; errors = Collections.synchronizedList(new LinkedList&lt;Object&gt;());
127     public static void reportErrors(Method m) {
128         realSync(null);
129         if (errors.size() == 0) {
130 //             System.err.println(&quot;Test passed: &quot; + m.getName());
131 //             System.err.println(&quot;------------------------------------------------------\nEvents for &quot; + m.getName());
132 //             for (Object e : events) {
133 //                 System.err.println(e);
134 //             }
135             return;
136         }
137 
138         someFailed = true;
139         System.err.println(&quot;Test failed: &quot; + m.getName());
140         for (Object error : errors) {
141             if (error instanceof Throwable) {
142                 ((Throwable)error).printStackTrace();
143             } else {
144                 System.err.println(&quot;Cause: &quot; + error);
145             }
146         }
147         System.err.println(&quot;Events:&quot;);
148         synchronized(events) {
149             for (Object e : events) {
150                 System.err.println(e);
151             }
152         }
153         errors.clear();
154         throw new Error();
155     }
156 
157     public static void asser(boolean value) {
158         if (!value) {
159             fail(&quot;Test failed&quot;);
160         }
161     }
162     public static void asser(boolean value, String msg) {
163         if (!value) {
164             fail(msg);
165         }
166     }
167     static int screenNum = 0;
168     public static void fail(Object cause) {
169         synchronized (events) {
170             events.add(&quot;FAILURE MOMENT&quot;);
171         }
172         errors.add(cause);
173         errors.add(&quot;- Focus owner: &quot; + KeyboardFocusManager.getCurrentKeyboardFocusManager().getFocusOwner());
174         errors.add(&quot;- Focused window: &quot; + KeyboardFocusManager.getCurrentKeyboardFocusManager().getFocusedWindow());
175 //         try {
176 //             Robot r = new Robot();
177 //             BufferedImage image = r.createScreenCapture(new Rectangle(0, 0, 1024, 768));
178 //             ImageIO.write(image, &quot;GIF&quot;, new File(&quot;/tmp/screen&quot; + screenNum + &quot;.gif&quot;));
179 //             screenNum++;
180 //             image.flush();
181 //         } catch (Exception e) {
182 //         }
183     }
184 
185     public static void _test1() {
186         Frame f = new Frame();
187         f.setLocation(100, 100);
188 
189         f.setVisible(true);
190 
191         Point loc = new Point(100, 100);
192         robot.mouseMove(loc.x+30, loc.y+40);
193 
194         robot.mousePress(InputEvent.BUTTON1_MASK);
195         robot.mouseRelease(InputEvent.BUTTON1_MASK);
196 
197         try {
198             Thread.sleep(3000);
199         } catch (InterruptedException ie) {
200         }
201     }
202 
203     public static void testType() {
204         Frame f = new Frame(&quot;testType&quot;);
205         f.setLayout(new BorderLayout());
206         TextField b = new TextField();
207         f.add(b, BorderLayout.CENTER);
208         f.setBounds(100, 100, 200, 200);
209 
210         f.setVisible(true);
211         realSync(f);
212 
213         f.toFront();
214         realSync(f);
215         b.requestFocus();
216         realSync(f);
217         asser(b.isFocusOwner(), &quot;Couldn&#39;t focus text field&quot;);
218 
219         robot.keyPress(KeyEvent.VK_A);
220         robot.keyRelease(KeyEvent.VK_A);
221         realSync(f);
<a name="2" id="anc2"></a><span class="line-modified">222         asser(&quot;a&quot;.equals(b.getText()), &quot;Expected &#39;a&#39; got &quot; + &quot;&#39;&quot; +</span>
<span class="line-added">223             b.getText() + &quot;&#39;.&quot;);</span>
224         f.dispose();
225     }
226 
227     public static void testTypeSwing() {
228         JFrame f = new JFrame(&quot;testTypeSwing&quot;);
229         f.setLayout(new BorderLayout());
230         JTextField b = new JTextField();
231         f.add(b, BorderLayout.CENTER);
232         f.setBounds(100, 100, 200, 200);
233 
234         f.setVisible(true);
235         realSync(f);
236 
237         f.toFront();
238         realSync(f);
239         b.requestFocus();
240         realSync(f);
241         asser(b.isFocusOwner(), &quot;Couldn&#39;t focus text field&quot;);
242 
243         robot.keyPress(KeyEvent.VK_A);
244         robot.keyRelease(KeyEvent.VK_A);
245         realSync(f);
<a name="3" id="anc3"></a><span class="line-modified">246         asser(&quot;a&quot;.equals(b.getText()), &quot;Expected &#39;a&#39; got &quot; + &quot;&#39;&quot; +</span>
<span class="line-added">247             b.getText() + &quot;&#39;.&quot;);</span>
248         f.dispose();
249     }
250 
251     private static boolean pressed;
252     public static void testPress() {
253         Frame f = new Frame(&quot;testPress&quot;);
254         f.setLayout(new FlowLayout());
255         Button b = new Button(&quot;b&quot;);
256         b.addActionListener(new ActionListener() {
257                 public void actionPerformed(ActionEvent e) {
258                     pressed = true;
259                 }
260             });
261         f.add(b);
262         f.setBounds(100, 100, 200, 200);
263 
264         f.setVisible(true);
265         realSync(f);
266 
267         Point loc = b.getLocationOnScreen();
268         events.add(&quot;Pressing at &quot; + loc);
269         robot.mouseMove(loc.x+3, loc.y+3);
270         pressed = false;
271         robot.mousePress(InputEvent.BUTTON1_MASK);
272         robot.mouseRelease(InputEvent.BUTTON1_MASK);
273         realSync(f);
274         asser(pressed, &quot;Not pressed&quot;);
275         f.dispose();
276     }
277 
278     public static void testPressSwing() {
279         JFrame f = new JFrame(&quot;testPressSwing&quot;);
280         f.setLayout(new FlowLayout());
281         JButton b = new JButton(&quot;b&quot;);
282         b.addActionListener(new ActionListener() {
283                 public void actionPerformed(ActionEvent e) {
284                     pressed = true;
285                 }
286             });
287         f.add(b);
288         f.setBounds(100, 100, 200, 200);
289 
290         f.setVisible(true);
291         realSync(f);
292 
293         Point loc = b.getLocationOnScreen();
294         events.add(&quot;Pressing at &quot; + loc);
295         robot.mouseMove(loc.x+3, loc.y+3);
296         pressed = false;
297         robot.mousePress(InputEvent.BUTTON1_MASK);
298         robot.mouseRelease(InputEvent.BUTTON1_MASK);
299         realSync(f);
300         asser(pressed, &quot;Not pressed&quot;);
301         f.dispose();
302     }
303 
304     public static void testFocus0() {
305         Frame f = new Frame(&quot;testFocus0&quot;);
306         f.setLayout(new FlowLayout());
307         Button b1 = new Button(&quot;b1&quot;);
308         Button b2 = new Button(&quot;b2&quot;);
309         f.add(b1);
310         f.add(b2);
311         f.setBounds(100, 100, 200, 200);
312         f.setVisible(true);
313         realSync(f);
314         f.toFront();
315         realSync(f);
316         asser(b1.isFocusOwner(), &quot;B1 didn&#39;t get focus&quot;);
317         b2.requestFocus();
318         realSync(f);
319         asser(b2.isFocusOwner(), &quot;Couldn&#39;t focus b2&quot;);
320         f.dispose();
321     }
322 
323     public static void testFocus1() {
324         Frame f = new Frame(&quot;testFocus1&quot;);
325         f.setLayout(new FlowLayout());
326         Button b1 = new Button(&quot;b1&quot;);
327         f.add(b1);
328         f.setBounds(100, 100, 200, 200);
329         f.setVisible(true);
330         realSync(f);
331         f.toFront();
332         realSync(f);
333         asser(b1.isFocusOwner(), &quot;B1 didn&#39;t get focus&quot;);
334         f.dispose();
335     }
336 
337     public static void testFocus2() {
338         Frame f = new Frame(&quot;testFocus2&quot;);
339         f.setLayout(new FlowLayout());
340         Button b1 = new Button(&quot;b1&quot;);
341         Button b2 = new Button(&quot;b2&quot;);
342         f.add(b1);
343         f.add(b2);
344         f.setBounds(100, 100, 200, 200);
345         f.setVisible(true);
346         realSync(f);
347         f.toFront();
348         realSync(f);
349         b2.requestFocus();
350         realSync(f);
351         if (!b2.isFocusOwner()) {
352             fail(&quot;1: &quot; + KeyboardFocusManager.getCurrentKeyboardFocusManager().getFocusOwner());
353         } else {
354             // Half passed
355             b1.requestFocus();
356             realSync(f);
357             asser(b1.isFocusOwner(), &quot;B1 couldn&#39;t get focus&quot;);
358         }
359         f.dispose();
360     }
361 
362     public static void testFocus2Swing() {
363         JFrame f = new JFrame(&quot;testFocus2Swing&quot;);
364         f.setLayout(new FlowLayout());
365         JButton b1 = new JButton(&quot;b1&quot;);
366         JButton b2 = new JButton(&quot;b2&quot;);
367         f.add(b1);
368         f.add(b2);
369         f.setBounds(100, 100, 200, 200);
370         f.setVisible(true);
371         realSync(f);
372         f.toFront();
373         realSync(f);
374         b2.requestFocus();
375         realSync(f);
376         if (!b2.isFocusOwner()) {
377             fail(&quot;1: &quot; + KeyboardFocusManager.getCurrentKeyboardFocusManager().getFocusOwner());
378         } else {
379             // Half passed
380             b1.requestFocus();
381             realSync(f);
382             asser(b1.isFocusOwner(), &quot;B1 couldn&#39;t get focus&quot;);
383         }
384         f.dispose();
385     }
386 
387     public static void realSync(Window w) {
388         if (doRealSync) {
389             ((sun.awt.SunToolkit)Toolkit.getDefaultToolkit()).realSync();
390         }
391     }
392 
393     public static void installListeners() {
394         Toolkit.getDefaultToolkit().addAWTEventListener(new AWTEventListener() {
395                 public void eventDispatched(AWTEvent e) {
396                     synchronized(events) {
397                         events.add(e);
398                     }
399                 }
400             }, 0xffff &amp; ~AWTEvent.HIERARCHY_EVENT_MASK);
401 //         ((XToolkit)Toolkit.getDefaultToolkit()).addXEventListener(new XToolkit.XEventListener() {
402 //                 public void eventProcessed(IXAnyEvent e) {
403 //                     synchronized(events) {
404 //                         events.add(e);
405 //                     }
406 //                 }
407 //             });
408     }
409 }
<a name="4" id="anc4"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="4" type="hidden" />
</body>
</html>