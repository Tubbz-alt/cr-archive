<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/jdk/java/awt/print/RemotePrinterStatusRefresh/RemotePrinterStatusRefresh.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2018, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
<a name="2" id="anc2"></a><span class="line-modified"> 24 /*</span>
 25  * @test
<a name="3" id="anc3"></a><span class="line-modified"> 26  * @bug 8153732 8212202 8221263 8221412 8222108</span>
 27  * @requires (os.family == &quot;Windows&quot;)
 28  * @summary Windows remote printer changes do not reflect in lookupPrintServices()
<a name="4" id="anc4"></a><span class="line-modified"> 29  * @run main/manual/othervm -Dsun.java2d.print.minRefreshTime=120 RemotePrinterStatusRefresh</span>

 30  */
 31 
<a name="5" id="anc5"></a><span class="line-modified"> 32 import java.awt.BorderLayout;</span>
<span class="line-modified"> 33 import java.awt.Color;</span>
<span class="line-added"> 34 import java.awt.Component;</span>
<span class="line-added"> 35 import java.awt.GridLayout;</span>
 36 import java.awt.event.ActionEvent;
<a name="6" id="anc6"></a><span class="line-modified"> 37 import java.awt.event.WindowAdapter;</span>
<span class="line-modified"> 38 import java.awt.event.WindowEvent;</span>
<span class="line-modified"> 39 import java.util.ArrayList;</span>
<span class="line-added"> 40 import java.util.Collections;</span>
<span class="line-added"> 41 import java.util.List;</span>
 42 import java.util.concurrent.CountDownLatch;
<a name="7" id="anc7"></a><span class="line-modified"> 43 import javax.print.PrintService;</span>
<span class="line-added"> 44 import javax.print.PrintServiceLookup;</span>
<span class="line-added"> 45 import javax.swing.AbstractListModel;</span>
 46 import javax.swing.BorderFactory;
 47 import javax.swing.Box;
<a name="8" id="anc8"></a><span class="line-added"> 48 import javax.swing.BoxLayout;</span>
<span class="line-added"> 49 import javax.swing.DefaultListCellRenderer;</span>
<span class="line-added"> 50 import javax.swing.GroupLayout;</span>
 51 import javax.swing.JButton;
 52 import javax.swing.JFrame;
 53 import javax.swing.JLabel;
<a name="9" id="anc9"></a><span class="line-added"> 54 import javax.swing.JList;</span>
 55 import javax.swing.JPanel;
<a name="10" id="anc10"></a><span class="line-added"> 56 import javax.swing.JScrollPane;</span>
 57 import javax.swing.JTextArea;
<a name="11" id="anc11"></a><span class="line-added"> 58 import javax.swing.JTextField;</span>
 59 import javax.swing.SwingUtilities;
<a name="12" id="anc12"></a><span class="line-modified"> 60 import javax.swing.Timer;</span>

 61 
<a name="13" id="anc13"></a><span class="line-modified"> 62 import static javax.swing.BorderFactory.createTitledBorder;</span>
<span class="line-modified"> 63 </span>
<span class="line-modified"> 64 public class RemotePrinterStatusRefresh extends WindowAdapter {</span>
<span class="line-modified"> 65 </span>
<span class="line-modified"> 66     private static final long DEFAULT_REFRESH_TIME = 240L;</span>
<span class="line-modified"> 67     private static final long MINIMAL_REFRESH_TIME = 120L;</span>
<span class="line-modified"> 68 </span>
<span class="line-modified"> 69     private static final long refreshTime = getRefreshTime();</span>
<span class="line-modified"> 70 </span>
<span class="line-modified"> 71     private static final long TIMEOUT = refreshTime * 4 + 60;</span>
<span class="line-modified"> 72 </span>
<span class="line-modified"> 73 </span>
<span class="line-modified"> 74     private static final CountDownLatch latch = new CountDownLatch(1);</span>
<span class="line-modified"> 75     private static volatile RemotePrinterStatusRefresh test;</span>
<span class="line-modified"> 76 </span>
<span class="line-modified"> 77     private volatile boolean testResult;</span>
<span class="line-modified"> 78     private volatile boolean testTimedOut;</span>
<span class="line-modified"> 79 </span>
<span class="line-modified"> 80     private final JFrame frame;</span>
<span class="line-modified"> 81 </span>
<span class="line-modified"> 82     private JButton refreshButton;</span>
<span class="line-modified"> 83     private JButton passButton;</span>
<span class="line-modified"> 84     private JButton failButton;</span>
<span class="line-modified"> 85 </span>
<span class="line-modified"> 86     private final ServiceItemListModel beforeList;</span>
<span class="line-modified"> 87     private final ServiceItemListModel afterList;</span>
<span class="line-modified"> 88 </span>
<span class="line-modified"> 89     private JTextField nextRefresh;</span>
<span class="line-modified"> 90     private JTextField timeLeft;</span>
<span class="line-modified"> 91 </span>
<span class="line-modified"> 92     private final Timer timer;</span>
<span class="line-modified"> 93     private final long startTime;</span>
<span class="line-modified"> 94 </span>
<span class="line-modified"> 95 </span>
<span class="line-added"> 96     private static class ServiceItem {</span>
<span class="line-added"> 97         private enum State {</span>
<span class="line-added"> 98             REMOVED, UNCHANGED, ADDED</span>
 99         }
100 
<a name="14" id="anc14"></a><span class="line-modified">101         final String name;</span>
<span class="line-modified">102         State state;</span>
<span class="line-modified">103 </span>
<span class="line-modified">104         private ServiceItem(final String name) {</span>
<span class="line-added">105             this.name = name;</span>
<span class="line-added">106             state = State.UNCHANGED;</span>
107         }
108 
<a name="15" id="anc15"></a><span class="line-modified">109         @Override</span>
<span class="line-modified">110         public String toString() {</span>
<span class="line-modified">111             return name;</span>
112         }
113 
<a name="16" id="anc16"></a><span class="line-modified">114         @Override</span>
<span class="line-modified">115         public boolean equals(Object obj) {</span>
<span class="line-added">116             return (obj instanceof ServiceItem)</span>
<span class="line-added">117                     &amp;&amp; ((ServiceItem) obj).name.equals(name);</span>
<span class="line-added">118         }</span>
119 
<a name="17" id="anc17"></a><span class="line-modified">120         @Override</span>
<span class="line-modified">121         public int hashCode() {</span>
<span class="line-modified">122             return name.hashCode();</span>
<span class="line-modified">123         }</span>
124     }
125 
<a name="18" id="anc18"></a><span class="line-modified">126     private static class ServiceItemListModel extends AbstractListModel&lt;ServiceItem&gt; {</span>
<span class="line-modified">127         private final List&lt;ServiceItem&gt; list;</span>
<span class="line-modified">128 </span>
<span class="line-modified">129         private ServiceItemListModel(List&lt;ServiceItem&gt; list) {</span>
<span class="line-added">130             this.list = list;</span>
<span class="line-added">131         }</span>
<span class="line-added">132 </span>
<span class="line-added">133         @Override</span>
<span class="line-added">134         public int getSize() {</span>
<span class="line-added">135             return list.size();</span>
136         }
137 
<a name="19" id="anc19"></a><span class="line-modified">138         @Override</span>
<span class="line-modified">139         public ServiceItem getElementAt(int index) {</span>
<span class="line-modified">140             return list.get(index);</span>
<span class="line-modified">141         }</span>
<span class="line-added">142 </span>
<span class="line-added">143         private void refreshList(List&lt;ServiceItem&gt; newList) {</span>
<span class="line-added">144             list.clear();</span>
<span class="line-added">145             list.addAll(newList);</span>
<span class="line-added">146             fireChanged();</span>
<span class="line-added">147         }</span>
<span class="line-added">148 </span>
<span class="line-added">149         private void fireChanged() {</span>
<span class="line-added">150             fireContentsChanged(this, 0, list.size() - 1);</span>
151         }
152     }
153 
<a name="20" id="anc20"></a><span class="line-modified">154     private static class ServiceItemListRenderer extends DefaultListCellRenderer {</span>
<span class="line-modified">155         @Override</span>
<span class="line-modified">156         public Component getListCellRendererComponent(JList&lt;?&gt; list,</span>
<span class="line-modified">157                                                       Object value,</span>
<span class="line-modified">158                                                       int index,</span>
<span class="line-modified">159                                                       boolean isSelected,</span>
<span class="line-modified">160                                                       boolean cellHasFocus) {</span>
<span class="line-modified">161             Component component =</span>
<span class="line-modified">162                     super.getListCellRendererComponent(list, value, index,</span>
<span class="line-modified">163                                                        isSelected, cellHasFocus);</span>
<span class="line-modified">164             switch (((ServiceItem) value).state) {</span>
<span class="line-modified">165                 case REMOVED:</span>
<span class="line-modified">166                     component.setBackground(Color.RED);</span>
<span class="line-modified">167                     component.setForeground(Color.WHITE);</span>
<span class="line-modified">168                     break;</span>
<span class="line-modified">169                 case ADDED:</span>
<span class="line-modified">170                     component.setBackground(Color.GREEN);</span>
<span class="line-added">171                     component.setForeground(Color.BLACK);</span>
<span class="line-added">172                     break;</span>
<span class="line-added">173                 case UNCHANGED:</span>
<span class="line-added">174                 default:</span>
<span class="line-added">175                     break;</span>
176             }
<a name="21" id="anc21"></a><span class="line-added">177             return component;</span>
178         }
179     }
<a name="22" id="anc22"></a>
180 
<a name="23" id="anc23"></a><span class="line-modified">181     private static final String INSTRUCTIONS_TEXT =</span>
<span class="line-modified">182             &quot;Please follow the steps for this manual test:\n&quot;</span>
<span class="line-modified">183                     + &quot;Step 0: \&quot;Before\&quot; list is populated with currently &quot;</span>
<span class="line-added">184                     +          &quot;configured printers.\n&quot;</span>
<span class="line-added">185                     + &quot;Step 1: Add or Remove a network printer using &quot;</span>
<span class="line-added">186                     +          &quot;Windows Control Panel.\n&quot;</span>
<span class="line-added">187                     + &quot;Step 2: Wait for 2\u20134 minutes after adding or removing.\n&quot;</span>
<span class="line-added">188                     + &quot;             \&quot;Next printer refresh in\&quot; gives you a &quot;</span>
<span class="line-added">189                     +          &quot;rough estimation on when update will happen.\n&quot;</span>
<span class="line-added">190                     + &quot;Step 3: Click Refresh.&quot;</span>
<span class="line-added">191                     +          &quot;\&quot;After\&quot; list is populated with updated list &quot;</span>
<span class="line-added">192                     +          &quot;of printers.\n&quot;</span>
<span class="line-added">193                     + &quot;Step 4: Compare the list of printers in \&quot;Before\&quot; and &quot;</span>
<span class="line-added">194                     +          &quot;\&quot;After\&quot; lists.\n&quot;</span>
<span class="line-added">195                     + &quot;              Added printers are highlighted with &quot;</span>
<span class="line-added">196                     +               &quot;green color, removed ones \u2014 with &quot;</span>
<span class="line-added">197                     +               &quot;red color.\n&quot;</span>
<span class="line-added">198                     + &quot;Step 5: Click Pass if the list of printers is correctly &quot;</span>
<span class="line-added">199                     +          &quot;updated.\n&quot;</span>
<span class="line-added">200                     + &quot;Step 6: If the list is not updated, wait for another &quot;</span>
<span class="line-added">201                     +          &quot;2\u20134 minutes, and then click Refresh again.\n&quot;</span>
<span class="line-added">202                     + &quot;Step 7: If the list does not update, click Fail.\n&quot;</span>
<span class="line-added">203                     + &quot;\n&quot;</span>
<span class="line-added">204                     + &quot;You have to click Refresh to enable Pass and Fail buttons. &quot;</span>
<span class="line-added">205                     + &quot;If no button is pressed,\n&quot;</span>
<span class="line-added">206                     + &quot;the test will time out. &quot;</span>
<span class="line-added">207                     + &quot;Closing the window also fails the test.&quot;;</span>
<span class="line-added">208 </span>
<span class="line-added">209     public static void main(String[] args) throws Exception {</span>
<span class="line-added">210         SwingUtilities.invokeAndWait(RemotePrinterStatusRefresh::createUI);</span>
<span class="line-added">211 </span>
<span class="line-added">212         latch.await();</span>
<span class="line-added">213         if (!test.testResult) {</span>
<span class="line-added">214             throw new RuntimeException(&quot;Test failed&quot;</span>
<span class="line-added">215                 + (test.testTimedOut ? &quot; because of time out&quot; : &quot;&quot;));</span>
<span class="line-added">216         }</span>
<span class="line-added">217     }</span>
<span class="line-added">218 </span>
<span class="line-added">219     private static long getRefreshTime() {</span>
<span class="line-added">220         String refreshTime =</span>
<span class="line-added">221                 System.getProperty(&quot;sun.java2d.print.minRefreshTime&quot;,</span>
<span class="line-added">222                                    Long.toString(DEFAULT_REFRESH_TIME));</span>
<span class="line-added">223         try {</span>
<span class="line-added">224             long value = Long.parseLong(refreshTime);</span>
<span class="line-added">225             return value &lt; MINIMAL_REFRESH_TIME ? MINIMAL_REFRESH_TIME : value;</span>
<span class="line-added">226         } catch (NumberFormatException e) {</span>
<span class="line-added">227             return DEFAULT_REFRESH_TIME;</span>
<span class="line-added">228         }</span>
<span class="line-added">229     }</span>
<span class="line-added">230 </span>
<span class="line-added">231     private static void createUI() {</span>
<span class="line-added">232         test = new RemotePrinterStatusRefresh();</span>
<span class="line-added">233     }</span>
<span class="line-added">234 </span>
<span class="line-added">235     private RemotePrinterStatusRefresh() {</span>
<span class="line-added">236         frame = new JFrame(&quot;RemotePrinterStatusRefresh&quot;);</span>
<span class="line-added">237         frame.addWindowListener(this);</span>
238 
<a name="24" id="anc24"></a>
239 
<a name="25" id="anc25"></a><span class="line-modified">240         JPanel northPanel = new JPanel(new BorderLayout());</span>
<span class="line-modified">241         northPanel.add(createInfoPanel(), BorderLayout.NORTH);</span>
<span class="line-modified">242         northPanel.add(createInstructionsPanel(), BorderLayout.SOUTH);</span>

243 
<a name="26" id="anc26"></a>


244 
<a name="27" id="anc27"></a><span class="line-modified">245         beforeList = new ServiceItemListModel(</span>
<span class="line-modified">246                 Collections.unmodifiableList(collectPrinterList()));</span>
<span class="line-modified">247         afterList = new ServiceItemListModel(new ArrayList&lt;&gt;());</span>
<span class="line-modified">248         logList(&quot;Before:&quot;, beforeList.list);</span>

249 
<a name="28" id="anc28"></a><span class="line-modified">250         JPanel listPanel = new JPanel(new GridLayout(1, 2));</span>
<span class="line-modified">251         listPanel.setBorder(createTitledBorder(&quot;Print Services&quot;));</span>
<span class="line-added">252         listPanel.add(createListPanel(beforeList, &quot;Before:&quot;, &#39;b&#39;));</span>
<span class="line-added">253         listPanel.add(createListPanel(afterList, &quot;After:&quot;, &#39;a&#39;));</span>
<span class="line-added">254 </span>
<span class="line-added">255 </span>
<span class="line-added">256         JPanel mainPanel = new JPanel(new BorderLayout());</span>
<span class="line-added">257         mainPanel.add(northPanel, BorderLayout.NORTH);</span>
<span class="line-added">258         mainPanel.add(listPanel, BorderLayout.CENTER);</span>
<span class="line-added">259         mainPanel.add(createButtonPanel(), BorderLayout.SOUTH);</span>
<span class="line-added">260 </span>
<span class="line-added">261 </span>
<span class="line-added">262         frame.add(mainPanel);</span>
<span class="line-added">263         frame.pack();</span>
<span class="line-added">264         refreshButton.requestFocusInWindow();</span>
<span class="line-added">265         frame.setVisible(true);</span>
<span class="line-added">266 </span>
<span class="line-added">267 </span>
<span class="line-added">268         timer = new Timer(1000, this::updateTimeLeft);</span>
<span class="line-added">269         timer.start();</span>
<span class="line-added">270         startTime = System.currentTimeMillis();</span>
<span class="line-added">271         updateTimeLeft(null);</span>
<span class="line-added">272     }</span>
<span class="line-added">273 </span>
<span class="line-added">274     private JPanel createInfoPanel() {</span>
<span class="line-added">275         JLabel javaLabel = new JLabel(&quot;Java version:&quot;);</span>
<span class="line-added">276         JTextField javaVersion =</span>
<span class="line-added">277                 new JTextField(System.getProperty(&quot;java.runtime.version&quot;));</span>
<span class="line-added">278         javaVersion.setEditable(false);</span>
<span class="line-added">279         javaLabel.setLabelFor(javaVersion);</span>
<span class="line-added">280 </span>
<span class="line-added">281         JLabel refreshTimeLabel = new JLabel(&quot;Refresh interval:&quot;);</span>
<span class="line-added">282         long minutes = refreshTime / 60;</span>
<span class="line-added">283         long seconds = refreshTime % 60;</span>
<span class="line-added">284         String interval = String.format(&quot;%1$d seconds%2$s&quot;,</span>
<span class="line-added">285                 refreshTime,</span>
<span class="line-added">286                 minutes &gt; 0</span>
<span class="line-added">287                     ? String.format(&quot; (%1$d %2$s%3$s)&quot;,</span>
<span class="line-added">288                         minutes,</span>
<span class="line-added">289                         minutes &gt; 1 ? &quot;minutes&quot; : &quot;minute&quot;,</span>
<span class="line-added">290                         seconds &gt; 0</span>
<span class="line-added">291                             ? String.format(&quot; %1$d %2$s&quot;,</span>
<span class="line-added">292                                 seconds,</span>
<span class="line-added">293                                 seconds &gt; 1 ? &quot;seconds&quot; : &quot;second&quot;)</span>
<span class="line-added">294                             : &quot;&quot;)</span>
<span class="line-added">295                     : &quot;&quot;</span>
<span class="line-added">296         );</span>
<span class="line-added">297         JTextField refreshInterval = new JTextField(interval);</span>
<span class="line-added">298         refreshInterval.setEditable(false);</span>
<span class="line-added">299         refreshTimeLabel.setLabelFor(refreshInterval);</span>
<span class="line-added">300 </span>
<span class="line-added">301         JLabel nextRefreshLabel = new JLabel(&quot;Next printer refresh in:&quot;);</span>
<span class="line-added">302         nextRefresh = new JTextField();</span>
<span class="line-added">303         nextRefresh.setEditable(false);</span>
<span class="line-added">304         nextRefreshLabel.setLabelFor(nextRefresh);</span>
<span class="line-added">305 </span>
<span class="line-added">306         JLabel timeoutLabel = new JLabel(&quot;Time left:&quot;);</span>
<span class="line-added">307         timeLeft = new JTextField();</span>
<span class="line-added">308         timeLeft.setEditable(false);</span>
<span class="line-added">309         timeoutLabel.setLabelFor(timeLeft);</span>
<span class="line-added">310 </span>
<span class="line-added">311         JPanel infoPanel = new JPanel();</span>
<span class="line-added">312         GroupLayout layout = new GroupLayout(infoPanel);</span>
<span class="line-added">313         infoPanel.setLayout(layout);</span>
<span class="line-added">314         infoPanel.setBorder(BorderFactory.createTitledBorder(&quot;Info&quot;));</span>
<span class="line-added">315         layout.setAutoCreateGaps(true);</span>
<span class="line-added">316         layout.setHorizontalGroup(</span>
<span class="line-added">317             layout.createSequentialGroup()</span>
<span class="line-added">318                 .addGroup(layout.createParallelGroup(GroupLayout.Alignment.LEADING)</span>
<span class="line-added">319                     .addComponent(javaLabel)</span>
<span class="line-added">320                     .addComponent(refreshTimeLabel)</span>
<span class="line-added">321                     .addComponent(nextRefreshLabel)</span>
<span class="line-added">322                     .addComponent(timeoutLabel)</span>
<span class="line-added">323                 )</span>
<span class="line-added">324                 .addGroup(layout.createParallelGroup(GroupLayout.Alignment.LEADING, true)</span>
<span class="line-added">325                     .addComponent(javaVersion)</span>
<span class="line-added">326                     .addComponent(refreshInterval)</span>
<span class="line-added">327                     .addComponent(nextRefresh)</span>
<span class="line-added">328                     .addComponent(timeLeft)</span>
<span class="line-added">329                 )</span>
<span class="line-added">330         );</span>
<span class="line-added">331         layout.setVerticalGroup(</span>
<span class="line-added">332             layout.createSequentialGroup()</span>
<span class="line-added">333                 .addGroup(layout.createParallelGroup(GroupLayout.Alignment.BASELINE)</span>
<span class="line-added">334                     .addComponent(javaLabel)</span>
<span class="line-added">335                     .addComponent(javaVersion)</span>
<span class="line-added">336                 )</span>
<span class="line-added">337                 .addGroup(layout.createParallelGroup(GroupLayout.Alignment.BASELINE)</span>
<span class="line-added">338                     .addComponent(refreshTimeLabel)</span>
<span class="line-added">339                     .addComponent(refreshInterval))</span>
<span class="line-added">340                 .addGroup(layout.createParallelGroup(GroupLayout.Alignment.BASELINE)</span>
<span class="line-added">341                     .addComponent(nextRefreshLabel)</span>
<span class="line-added">342                     .addComponent(nextRefresh))</span>
<span class="line-added">343                 .addGroup(layout.createParallelGroup(GroupLayout.Alignment.BASELINE)</span>
<span class="line-added">344                     .addComponent(timeoutLabel)</span>
<span class="line-added">345                     .addComponent(timeLeft))</span>
<span class="line-added">346         );</span>
<span class="line-added">347         return infoPanel;</span>
<span class="line-added">348     }</span>
<span class="line-added">349 </span>
<span class="line-added">350     private JPanel createInstructionsPanel() {</span>
<span class="line-added">351         JPanel instructionsPanel = new JPanel(new BorderLayout());</span>
<span class="line-added">352         JTextArea instructionText = new JTextArea(INSTRUCTIONS_TEXT);</span>
<span class="line-added">353         instructionText.setEditable(false);</span>
<span class="line-added">354         instructionsPanel.setBorder(createTitledBorder(&quot;Test Instructions&quot;));</span>
<span class="line-added">355         instructionsPanel.add(new JScrollPane(instructionText));</span>
<span class="line-added">356         return  instructionsPanel;</span>
357     }
358 
<a name="29" id="anc29"></a><span class="line-modified">359     private JPanel createListPanel(final ServiceItemListModel model,</span>
<span class="line-modified">360                                    final String title,</span>
<span class="line-modified">361                                    final char mnemonic) {</span>
<span class="line-modified">362         JPanel panel = new JPanel();</span>
<span class="line-modified">363         panel.setLayout(new BoxLayout(panel, BoxLayout.Y_AXIS));</span>
<span class="line-modified">364         JList&lt;ServiceItem&gt; list = new JList&lt;&gt;(model);</span>
<span class="line-modified">365         list.setCellRenderer(new ServiceItemListRenderer());</span>
<span class="line-modified">366 </span>
<span class="line-modified">367         JLabel label = new JLabel(title);</span>
<span class="line-modified">368         label.setLabelFor(list);</span>
<span class="line-modified">369         label.setDisplayedMnemonic(mnemonic);</span>
<span class="line-modified">370         JPanel labelPanel = new JPanel();</span>
<span class="line-modified">371         labelPanel.setLayout(new BoxLayout(labelPanel, BoxLayout.X_AXIS));</span>
<span class="line-modified">372         labelPanel.add(label, BorderLayout.EAST);</span>
<span class="line-modified">373         labelPanel.add(Box.createHorizontalGlue());</span>
<span class="line-modified">374 </span>
<span class="line-modified">375         panel.add(labelPanel);</span>
<span class="line-modified">376         panel.add(new JScrollPane(list));</span>
<span class="line-modified">377         return panel;</span>
<span class="line-modified">378     }</span>
<span class="line-modified">379 </span>
<span class="line-modified">380     private JPanel createButtonPanel() {</span>
<span class="line-modified">381         refreshButton = new JButton(&quot;Refresh&quot;);</span>
<span class="line-modified">382         refreshButton.addActionListener(this::refresh);</span>
<span class="line-modified">383 </span>



















384         passButton = new JButton(&quot;Pass&quot;);
<a name="30" id="anc30"></a><span class="line-modified">385         passButton.addActionListener(this::pass);</span>
<span class="line-modified">386         passButton.setEnabled(false);</span>





387 
388         failButton = new JButton(&quot;Fail&quot;);
<a name="31" id="anc31"></a><span class="line-modified">389         failButton.addActionListener(this::fail);</span>
<span class="line-modified">390         failButton.setEnabled(false);</span>
<span class="line-modified">391 </span>
<span class="line-modified">392         JPanel buttonPanel = new JPanel();</span>
<span class="line-modified">393         buttonPanel.setLayout(new BoxLayout(buttonPanel, BoxLayout.X_AXIS));</span>
<span class="line-modified">394         buttonPanel.add(Box.createHorizontalGlue());</span>
<span class="line-modified">395         buttonPanel.add(refreshButton);</span>
<span class="line-added">396         buttonPanel.add(passButton);</span>
<span class="line-added">397         buttonPanel.add(failButton);</span>
<span class="line-added">398         buttonPanel.add(Box.createHorizontalGlue());</span>
<span class="line-added">399         return buttonPanel;</span>
<span class="line-added">400     }</span>
401 
<a name="32" id="anc32"></a><span class="line-modified">402     private static List&lt;ServiceItem&gt; collectPrinterList() {</span>
<span class="line-modified">403         PrintService[] printServices = PrintServiceLookup.lookupPrintServices(null, null);</span>
<span class="line-modified">404         List&lt;ServiceItem&gt; list = new ArrayList&lt;&gt;(printServices.length);</span>
<span class="line-added">405         for (PrintService service : printServices) {</span>
<span class="line-added">406             list.add(new ServiceItem(service.getName()));</span>
<span class="line-added">407         }</span>
<span class="line-added">408         return list;</span>
<span class="line-added">409     }</span>
410 
<a name="33" id="anc33"></a><span class="line-modified">411     private static void logList(final String title, final List&lt;ServiceItem&gt; list) {</span>
<span class="line-modified">412         System.out.println(title);</span>
<span class="line-modified">413         for (ServiceItem item : list) {</span>
<span class="line-added">414             System.out.println(item.name);</span>
<span class="line-added">415         }</span>
<span class="line-added">416         System.out.println();</span>
<span class="line-added">417     }</span>
418 
<a name="34" id="anc34"></a><span class="line-modified">419     private static void compareLists(final ServiceItemListModel before, final ServiceItemListModel after) {</span>
<span class="line-modified">420         boolean beforeUpdated = false;</span>
<span class="line-modified">421         boolean afterUpdated = false;</span>
<span class="line-added">422 </span>
<span class="line-added">423         for (ServiceItem item : before.list) {</span>
<span class="line-added">424             if (!after.list.contains(item)) {</span>
<span class="line-added">425                 item.state = ServiceItem.State.REMOVED;</span>
<span class="line-added">426                 beforeUpdated = true;</span>
<span class="line-added">427             } else if (item.state != ServiceItem.State.UNCHANGED) {</span>
<span class="line-added">428                 item.state = ServiceItem.State.UNCHANGED;</span>
<span class="line-added">429                 beforeUpdated = true;</span>
<span class="line-added">430             }</span>
<span class="line-added">431         }</span>
<span class="line-added">432 </span>
<span class="line-added">433         for (ServiceItem item : after.list) {</span>
<span class="line-added">434             if (!before.list.contains(item)) {</span>
<span class="line-added">435                 item.state = ServiceItem.State.ADDED;</span>
<span class="line-added">436                 afterUpdated = true;</span>
<span class="line-added">437             } else if (item.state != ServiceItem.State.UNCHANGED) {</span>
<span class="line-added">438                 item.state = ServiceItem.State.UNCHANGED;</span>
<span class="line-added">439                 afterUpdated = true;</span>
<span class="line-added">440             }</span>
<span class="line-added">441         }</span>
442 
<a name="35" id="anc35"></a><span class="line-modified">443         if (beforeUpdated) {</span>
<span class="line-modified">444             before.fireChanged();</span>
<span class="line-modified">445         }</span>
<span class="line-modified">446         if (afterUpdated) {</span>
<span class="line-added">447             after.fireChanged();</span>
<span class="line-added">448         }</span>
<span class="line-added">449     }</span>
450 
<a name="36" id="anc36"></a><span class="line-modified">451     @Override</span>
<span class="line-modified">452     public void windowClosing(WindowEvent e) {</span>
<span class="line-modified">453         System.out.println(&quot;The window closed&quot;);</span>
<span class="line-modified">454         disposeUI();</span>
<span class="line-added">455     }</span>
456 
<a name="37" id="anc37"></a><span class="line-modified">457     private void disposeUI() {</span>
<span class="line-modified">458         timer.stop();</span>
<span class="line-modified">459         latch.countDown();</span>
<span class="line-added">460         frame.dispose();</span>
<span class="line-added">461     }</span>
462 
<a name="38" id="anc38"></a><span class="line-modified">463     @SuppressWarnings(&quot;unused&quot;)</span>
<span class="line-modified">464     private void refresh(ActionEvent e) {</span>
<span class="line-modified">465         System.out.println(&quot;Refresh button pressed&quot;);</span>
<span class="line-added">466         afterList.refreshList(collectPrinterList());</span>
<span class="line-added">467         compareLists(beforeList, afterList);</span>
<span class="line-added">468         passButton.setEnabled(true);</span>
<span class="line-added">469         failButton.setEnabled(true);</span>
<span class="line-added">470         logList(&quot;After:&quot;, afterList.list);</span>
471     }
472 
<a name="39" id="anc39"></a><span class="line-modified">473     @SuppressWarnings(&quot;unused&quot;)</span>
<span class="line-modified">474     private void pass(ActionEvent e) {</span>
<span class="line-added">475         System.out.println(&quot;Pass button pressed&quot;);</span>
<span class="line-added">476         testResult = true;</span>
<span class="line-added">477         disposeUI();</span>
478     }
<a name="40" id="anc40"></a><span class="line-added">479 </span>
<span class="line-added">480     @SuppressWarnings(&quot;unused&quot;)</span>
<span class="line-added">481     private void fail(ActionEvent e) {</span>
<span class="line-added">482         System.out.println(&quot;Fail button pressed&quot;);</span>
<span class="line-added">483         testResult = false;</span>
<span class="line-added">484         disposeUI();</span>
<span class="line-added">485     }</span>
<span class="line-added">486 </span>
<span class="line-added">487     @SuppressWarnings(&quot;unused&quot;)</span>
<span class="line-added">488     private void updateTimeLeft(ActionEvent e) {</span>
<span class="line-added">489         long elapsed = (System.currentTimeMillis() - startTime) / 1000;</span>
<span class="line-added">490         long left = TIMEOUT - elapsed;</span>
<span class="line-added">491         if (left &lt; 0) {</span>
<span class="line-added">492             testTimedOut = true;</span>
<span class="line-added">493             disposeUI();</span>
<span class="line-added">494         }</span>
<span class="line-added">495         timeLeft.setText(formatTime(left));</span>
<span class="line-added">496         nextRefresh.setText(formatTime(refreshTime - (elapsed % refreshTime)));</span>
<span class="line-added">497     }</span>
<span class="line-added">498 </span>
<span class="line-added">499     private static String formatTime(final long seconds) {</span>
<span class="line-added">500         long minutes = seconds / 60;</span>
<span class="line-added">501         return String.format(&quot;%d:%02d&quot;, minutes, seconds - minutes * 60);</span>
<span class="line-added">502     }</span>
<span class="line-added">503 </span>
504 }
<a name="41" id="anc41"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="41" type="hidden" />
</body>
</html>