<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/java/awt/print/RemotePrinterStatusRefresh/RemotePrinterStatusRefresh.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="../PrinterJob/PrintToDir.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../../../io/DataOutputStream/WriteUTF.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/awt/print/RemotePrinterStatusRefresh/RemotePrinterStatusRefresh.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
<span class="line-modified"> 24 /**</span>
 25  * @test
<span class="line-modified"> 26  * @bug 8153732 8212202</span>
 27  * @requires (os.family == &quot;Windows&quot;)
 28  * @summary Windows remote printer changes do not reflect in lookupPrintServices()
<span class="line-modified"> 29  * @ignore Requires a new network printer installation\removal</span>
<span class="line-removed"> 30  * @run main/manual RemotePrinterStatusRefresh</span>
 31  */
 32 
<span class="line-modified"> 33 import java.awt.GridBagConstraints;</span>
<span class="line-modified"> 34 import java.awt.GridBagLayout;</span>


 35 import java.awt.event.ActionEvent;
<span class="line-modified"> 36 import java.awt.print.PageFormat;</span>
<span class="line-modified"> 37 import java.awt.print.Paper;</span>
<span class="line-modified"> 38 import java.awt.print.PrinterException;</span>


 39 import java.util.concurrent.CountDownLatch;
<span class="line-modified"> 40 import java.util.concurrent.TimeUnit;</span>


 41 import javax.swing.BorderFactory;
 42 import javax.swing.Box;



 43 import javax.swing.JButton;
 44 import javax.swing.JFrame;
 45 import javax.swing.JLabel;

 46 import javax.swing.JPanel;

 47 import javax.swing.JTextArea;

 48 import javax.swing.SwingUtilities;
<span class="line-modified"> 49 import java.awt.print.PrinterJob;</span>
<span class="line-removed"> 50 import javax.print.PrintService;</span>
 51 
<span class="line-modified"> 52 public class RemotePrinterStatusRefresh</span>
<span class="line-modified"> 53 {</span>
<span class="line-modified"> 54     private static TestUI test = null;</span>
<span class="line-modified"> 55     public static void main(String args[]) throws Exception {</span>
<span class="line-modified"> 56         final CountDownLatch latch = new CountDownLatch(1);</span>
<span class="line-modified"> 57 </span>
<span class="line-modified"> 58         // Test UI creation</span>
<span class="line-modified"> 59         test = new TestUI(latch);</span>
<span class="line-modified"> 60 </span>
<span class="line-modified"> 61         SwingUtilities.invokeAndWait(new Runnable() {</span>
<span class="line-modified"> 62             @Override</span>
<span class="line-modified"> 63             public void run() {</span>
<span class="line-modified"> 64                 try {</span>
<span class="line-modified"> 65                     test.createUI();</span>
<span class="line-modified"> 66                 } catch (Exception e) {</span>
<span class="line-modified"> 67                     throw new RuntimeException(e);</span>
<span class="line-modified"> 68                 }</span>
<span class="line-modified"> 69             }</span>
<span class="line-modified"> 70         });</span>
<span class="line-modified"> 71 </span>
<span class="line-modified"> 72         // RemotePrinterStatusRefresh creation</span>
<span class="line-modified"> 73         RemotePrinterStatusRefresh RemotePrinterStatusRefresh = new RemotePrinterStatusRefresh();</span>
<span class="line-modified"> 74         SwingUtilities.invokeAndWait(() -&gt; {</span>
<span class="line-modified"> 75             collectPrintersList(test.resultsTextArea, true);</span>
<span class="line-modified"> 76         });</span>
<span class="line-modified"> 77 </span>
<span class="line-modified"> 78         // 8 min = 480000 msec</span>
<span class="line-modified"> 79         if(waitForFlag(480000)) {</span>
<span class="line-modified"> 80             SwingUtilities.invokeAndWait(() -&gt; {</span>
<span class="line-modified"> 81                 collectPrintersList(test.resultsTextArea, false);</span>
<span class="line-modified"> 82             });</span>
<span class="line-modified"> 83         } else {</span>
<span class="line-modified"> 84             dispose();</span>
<span class="line-modified"> 85             throw new RuntimeException(&quot;No new network printer got added/removed!! Test timed out!!&quot;);</span>



 86         }
 87 
<span class="line-modified"> 88         boolean status = latch.await(1, TimeUnit.MINUTES);</span>
<span class="line-modified"> 89         if (!status) {</span>
<span class="line-modified"> 90             dispose();</span>
<span class="line-modified"> 91             throw new RuntimeException(&quot;Test timed out.&quot;);</span>


 92         }
 93 
<span class="line-modified"> 94         if (test.testResult == false) {</span>
<span class="line-modified"> 95             dispose();</span>
<span class="line-modified"> 96             throw new RuntimeException(&quot;Test Failed.&quot;);</span>
 97         }
 98 
<span class="line-modified"> 99         dispose();</span>
<span class="line-modified">100     }</span>



101 
<span class="line-modified">102     public static void dispose() throws Exception {</span>
<span class="line-modified">103         SwingUtilities.invokeAndWait(() -&gt; {</span>
<span class="line-modified">104             test.disposeUI();</span>
<span class="line-modified">105         });</span>
106     }
107 
<span class="line-modified">108     public static boolean waitForFlag (long maxTimeoutInMsec) throws Exception {</span>
<span class="line-modified">109         while(!test.isAdded &amp;&amp; maxTimeoutInMsec &gt; 0) {</span>
<span class="line-modified">110             maxTimeoutInMsec -= 100;</span>
<span class="line-modified">111             Thread.sleep(100);</span>






112         }
113 
<span class="line-modified">114         if(maxTimeoutInMsec &lt;= 0) {</span>
<span class="line-modified">115             return false;</span>
<span class="line-modified">116         } else {</span>
<span class="line-modified">117             return true;</span>









118         }
119     }
120 
<span class="line-modified">121     private static void collectPrintersList(JTextArea textArea, boolean before) {</span>
<span class="line-modified">122         if(before) {</span>
<span class="line-modified">123             System.out.println(&quot;List of printers(before): &quot;);</span>
<span class="line-modified">124             textArea.setText(&quot;List of printers(before): \n&quot;);</span>
<span class="line-modified">125             for (PrintService printServiceBefore : PrinterJob.lookupPrintServices()) {</span>
<span class="line-modified">126                 System.out.println(printServiceBefore);</span>
<span class="line-modified">127                 textArea.append(printServiceBefore.toString());</span>
<span class="line-modified">128                 textArea.append(&quot;\n&quot;);</span>
<span class="line-modified">129             }</span>
<span class="line-modified">130         } else {</span>
<span class="line-modified">131             textArea.append(&quot;\n&quot;);</span>
<span class="line-modified">132             System.out.println(&quot;List of printers(after): &quot;);</span>
<span class="line-modified">133             textArea.append(&quot;List of printers(after): \n&quot;);</span>
<span class="line-modified">134             for (PrintService printServiceAfter : PrinterJob.lookupPrintServices()) {</span>
<span class="line-modified">135                 System.out.println(printServiceAfter);</span>
<span class="line-modified">136                 textArea.append(printServiceAfter.toString());</span>
<span class="line-modified">137                 textArea.append(&quot;\n&quot;);</span>





138             }

139         }
140     }
<span class="line-removed">141 }</span>
142 
<span class="line-modified">143 class TestUI {</span>
<span class="line-modified">144     private static JFrame mainFrame;</span>
<span class="line-modified">145     private static JPanel mainControlPanel;</span>






















































146 
<span class="line-removed">147     private static JTextArea instructionTextArea;</span>
148 
<span class="line-modified">149     private static JPanel resultButtonPanel;</span>
<span class="line-modified">150     private static JButton passButton;</span>
<span class="line-modified">151     private static JButton failButton;</span>
<span class="line-removed">152     private static JButton addedButton;</span>
153 
<span class="line-removed">154     private static JPanel testPanel;</span>
<span class="line-removed">155     private static JButton testButton;</span>
<span class="line-removed">156     private static JLabel buttonPressCountLabel;</span>
157 
<span class="line-modified">158     private static GridBagLayout layout;</span>
<span class="line-modified">159     private final CountDownLatch latch;</span>
<span class="line-modified">160     public boolean testResult = false;</span>
<span class="line-modified">161     public volatile Boolean isAdded = false;</span>
<span class="line-removed">162     public static JTextArea resultsTextArea;</span>
163 
<span class="line-modified">164     public TestUI(CountDownLatch latch) throws Exception {</span>
<span class="line-modified">165         this.latch = latch;</span>









































































































166     }
167 
<span class="line-modified">168     public final void createUI() {</span>
<span class="line-modified">169         mainFrame = new JFrame(&quot;RemotePrinterStatusRefresh&quot;);</span>
<span class="line-modified">170         layout = new GridBagLayout();</span>
<span class="line-modified">171         mainControlPanel = new JPanel(layout);</span>
<span class="line-modified">172         resultButtonPanel = new JPanel(layout);</span>
<span class="line-modified">173         testPanel = new JPanel(layout);</span>
<span class="line-modified">174         GridBagConstraints gbc = new GridBagConstraints();</span>
<span class="line-modified">175 </span>
<span class="line-modified">176         // Create Test instructions</span>
<span class="line-modified">177         String instructions</span>
<span class="line-modified">178                 = &quot;This test displays the current list of printers(before) attached to \n&quot;</span>
<span class="line-modified">179                 + &quot;this computer in the results panel.\n\n&quot;</span>
<span class="line-modified">180                 + &quot;Please follow the below steps for this manual test\n&quot;</span>
<span class="line-modified">181                 + &quot;--------------------------------------------------------------------\n&quot;</span>
<span class="line-modified">182                 + &quot;Step 1: Add/Remove a new network printer and Wait for 4 minutes after adding/removing\n&quot;</span>
<span class="line-modified">183                 + &quot;Step 2: Then click on &#39;Printer Added/Removed&#39; button\n&quot;</span>
<span class="line-modified">184                 + &quot;Step 2: Once the new network printer is added/removed, see if it is \n&quot;</span>
<span class="line-modified">185                 + &quot;        the same as displayed/not displayed in the results panel.\n&quot;</span>
<span class="line-modified">186                 + &quot;Step 3: If displayed/not displayed, then click &#39;Pass&#39; else click on &#39;Fail&#39; button&quot;;</span>
<span class="line-modified">187 </span>
<span class="line-modified">188         instructionTextArea = new JTextArea();</span>
<span class="line-modified">189         instructionTextArea.setText(instructions);</span>
<span class="line-modified">190         instructionTextArea.setEditable(false);</span>
<span class="line-modified">191         instructionTextArea.setBorder(BorderFactory.</span>
<span class="line-modified">192                 createTitledBorder(&quot;Test Instructions&quot;));</span>
<span class="line-removed">193 </span>
<span class="line-removed">194         gbc.gridx = 0;</span>
<span class="line-removed">195         gbc.gridy = 0;</span>
<span class="line-removed">196         gbc.fill = GridBagConstraints.HORIZONTAL;</span>
<span class="line-removed">197         mainControlPanel.add(instructionTextArea, gbc);</span>
<span class="line-removed">198 </span>
<span class="line-removed">199         gbc.gridx = 0;</span>
<span class="line-removed">200         gbc.gridy = 1;</span>
<span class="line-removed">201         testPanel.add(Box.createVerticalStrut(50));</span>
<span class="line-removed">202         mainControlPanel.add(testPanel);</span>
<span class="line-removed">203 </span>
<span class="line-removed">204         addedButton = new JButton(&quot;Printer Added/Removed&quot;);</span>
<span class="line-removed">205         addedButton.setActionCommand(&quot;Added&quot;);</span>
<span class="line-removed">206         addedButton.addActionListener((ActionEvent e) -&gt; {</span>
<span class="line-removed">207             System.out.println(&quot;Added Button pressed!&quot;);</span>
<span class="line-removed">208             isAdded = true;</span>
<span class="line-removed">209         });</span>
<span class="line-removed">210 </span>
<span class="line-removed">211         // Create resultButtonPanel with Pass, Fail buttons</span>
212         passButton = new JButton(&quot;Pass&quot;);
<span class="line-modified">213         passButton.setActionCommand(&quot;Pass&quot;);</span>
<span class="line-modified">214         passButton.addActionListener((ActionEvent e) -&gt; {</span>
<span class="line-removed">215             System.out.println(&quot;Pass Button pressed!&quot;);</span>
<span class="line-removed">216             testResult = true;</span>
<span class="line-removed">217             latch.countDown();</span>
<span class="line-removed">218             disposeUI();</span>
<span class="line-removed">219         });</span>
220 
221         failButton = new JButton(&quot;Fail&quot;);
<span class="line-modified">222         failButton.setActionCommand(&quot;Fail&quot;);</span>
<span class="line-modified">223         failButton.addActionListener((ActionEvent e) -&gt; {</span>
<span class="line-modified">224             System.out.println(&quot;Fail Button pressed!&quot;);</span>
<span class="line-modified">225             testResult = false;</span>
<span class="line-modified">226             latch.countDown();</span>
<span class="line-modified">227             disposeUI();</span>
<span class="line-modified">228         });</span>





229 
<span class="line-modified">230         gbc.gridx = 0;</span>
<span class="line-modified">231         gbc.gridy = 0;</span>
<span class="line-modified">232         resultButtonPanel.add(addedButton, gbc);</span>





233 
<span class="line-modified">234         gbc.gridx = 1;</span>
<span class="line-modified">235         gbc.gridy = 0;</span>
<span class="line-modified">236         resultButtonPanel.add(passButton, gbc);</span>




237 
<span class="line-modified">238         gbc.gridx = 2;</span>
<span class="line-modified">239         gbc.gridy = 0;</span>
<span class="line-modified">240         resultButtonPanel.add(failButton, gbc);</span>




















241 
<span class="line-modified">242         resultsTextArea = new JTextArea();</span>
<span class="line-modified">243         resultsTextArea.setEditable(false);</span>
<span class="line-modified">244         resultsTextArea.setBorder(BorderFactory.</span>
<span class="line-modified">245                 createTitledBorder(&quot;Results&quot;));</span>



246 
<span class="line-modified">247         gbc.gridx = 0;</span>
<span class="line-modified">248         gbc.gridy = 1;</span>
<span class="line-modified">249         gbc.fill = GridBagConstraints.HORIZONTAL;</span>
<span class="line-modified">250         mainControlPanel.add(resultsTextArea, gbc);</span>

251 
<span class="line-modified">252         gbc.gridx = 0;</span>
<span class="line-modified">253         gbc.gridy = 2;</span>
<span class="line-modified">254         mainControlPanel.add(resultButtonPanel, gbc);</span>


255 
<span class="line-modified">256         mainFrame.add(mainControlPanel);</span>
<span class="line-modified">257         mainFrame.pack();</span>
<span class="line-modified">258         mainFrame.setVisible(true);</span>





259     }
260 
<span class="line-modified">261     public void disposeUI() {</span>
<span class="line-modified">262         mainFrame.dispose();</span>



263     }

























264 }
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2018, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
<span class="line-modified"> 24 /*</span>
 25  * @test
<span class="line-modified"> 26  * @bug 8153732 8212202 8221263 8221412 8222108</span>
 27  * @requires (os.family == &quot;Windows&quot;)
 28  * @summary Windows remote printer changes do not reflect in lookupPrintServices()
<span class="line-modified"> 29  * @run main/manual/othervm -Dsun.java2d.print.minRefreshTime=120 RemotePrinterStatusRefresh</span>

 30  */
 31 
<span class="line-modified"> 32 import java.awt.BorderLayout;</span>
<span class="line-modified"> 33 import java.awt.Color;</span>
<span class="line-added"> 34 import java.awt.Component;</span>
<span class="line-added"> 35 import java.awt.GridLayout;</span>
 36 import java.awt.event.ActionEvent;
<span class="line-modified"> 37 import java.awt.event.WindowAdapter;</span>
<span class="line-modified"> 38 import java.awt.event.WindowEvent;</span>
<span class="line-modified"> 39 import java.util.ArrayList;</span>
<span class="line-added"> 40 import java.util.Collections;</span>
<span class="line-added"> 41 import java.util.List;</span>
 42 import java.util.concurrent.CountDownLatch;
<span class="line-modified"> 43 import javax.print.PrintService;</span>
<span class="line-added"> 44 import javax.print.PrintServiceLookup;</span>
<span class="line-added"> 45 import javax.swing.AbstractListModel;</span>
 46 import javax.swing.BorderFactory;
 47 import javax.swing.Box;
<span class="line-added"> 48 import javax.swing.BoxLayout;</span>
<span class="line-added"> 49 import javax.swing.DefaultListCellRenderer;</span>
<span class="line-added"> 50 import javax.swing.GroupLayout;</span>
 51 import javax.swing.JButton;
 52 import javax.swing.JFrame;
 53 import javax.swing.JLabel;
<span class="line-added"> 54 import javax.swing.JList;</span>
 55 import javax.swing.JPanel;
<span class="line-added"> 56 import javax.swing.JScrollPane;</span>
 57 import javax.swing.JTextArea;
<span class="line-added"> 58 import javax.swing.JTextField;</span>
 59 import javax.swing.SwingUtilities;
<span class="line-modified"> 60 import javax.swing.Timer;</span>

 61 
<span class="line-modified"> 62 import static javax.swing.BorderFactory.createTitledBorder;</span>
<span class="line-modified"> 63 </span>
<span class="line-modified"> 64 public class RemotePrinterStatusRefresh extends WindowAdapter {</span>
<span class="line-modified"> 65 </span>
<span class="line-modified"> 66     private static final long DEFAULT_REFRESH_TIME = 240L;</span>
<span class="line-modified"> 67     private static final long MINIMAL_REFRESH_TIME = 120L;</span>
<span class="line-modified"> 68 </span>
<span class="line-modified"> 69     private static final long refreshTime = getRefreshTime();</span>
<span class="line-modified"> 70 </span>
<span class="line-modified"> 71     private static final long TIMEOUT = refreshTime * 4 + 60;</span>
<span class="line-modified"> 72 </span>
<span class="line-modified"> 73 </span>
<span class="line-modified"> 74     private static final CountDownLatch latch = new CountDownLatch(1);</span>
<span class="line-modified"> 75     private static volatile RemotePrinterStatusRefresh test;</span>
<span class="line-modified"> 76 </span>
<span class="line-modified"> 77     private volatile boolean testResult;</span>
<span class="line-modified"> 78     private volatile boolean testTimedOut;</span>
<span class="line-modified"> 79 </span>
<span class="line-modified"> 80     private final JFrame frame;</span>
<span class="line-modified"> 81 </span>
<span class="line-modified"> 82     private JButton refreshButton;</span>
<span class="line-modified"> 83     private JButton passButton;</span>
<span class="line-modified"> 84     private JButton failButton;</span>
<span class="line-modified"> 85 </span>
<span class="line-modified"> 86     private final ServiceItemListModel beforeList;</span>
<span class="line-modified"> 87     private final ServiceItemListModel afterList;</span>
<span class="line-modified"> 88 </span>
<span class="line-modified"> 89     private JTextField nextRefresh;</span>
<span class="line-modified"> 90     private JTextField timeLeft;</span>
<span class="line-modified"> 91 </span>
<span class="line-modified"> 92     private final Timer timer;</span>
<span class="line-modified"> 93     private final long startTime;</span>
<span class="line-modified"> 94 </span>
<span class="line-modified"> 95 </span>
<span class="line-added"> 96     private static class ServiceItem {</span>
<span class="line-added"> 97         private enum State {</span>
<span class="line-added"> 98             REMOVED, UNCHANGED, ADDED</span>
 99         }
100 
<span class="line-modified">101         final String name;</span>
<span class="line-modified">102         State state;</span>
<span class="line-modified">103 </span>
<span class="line-modified">104         private ServiceItem(final String name) {</span>
<span class="line-added">105             this.name = name;</span>
<span class="line-added">106             state = State.UNCHANGED;</span>
107         }
108 
<span class="line-modified">109         @Override</span>
<span class="line-modified">110         public String toString() {</span>
<span class="line-modified">111             return name;</span>
112         }
113 
<span class="line-modified">114         @Override</span>
<span class="line-modified">115         public boolean equals(Object obj) {</span>
<span class="line-added">116             return (obj instanceof ServiceItem)</span>
<span class="line-added">117                     &amp;&amp; ((ServiceItem) obj).name.equals(name);</span>
<span class="line-added">118         }</span>
119 
<span class="line-modified">120         @Override</span>
<span class="line-modified">121         public int hashCode() {</span>
<span class="line-modified">122             return name.hashCode();</span>
<span class="line-modified">123         }</span>
124     }
125 
<span class="line-modified">126     private static class ServiceItemListModel extends AbstractListModel&lt;ServiceItem&gt; {</span>
<span class="line-modified">127         private final List&lt;ServiceItem&gt; list;</span>
<span class="line-modified">128 </span>
<span class="line-modified">129         private ServiceItemListModel(List&lt;ServiceItem&gt; list) {</span>
<span class="line-added">130             this.list = list;</span>
<span class="line-added">131         }</span>
<span class="line-added">132 </span>
<span class="line-added">133         @Override</span>
<span class="line-added">134         public int getSize() {</span>
<span class="line-added">135             return list.size();</span>
136         }
137 
<span class="line-modified">138         @Override</span>
<span class="line-modified">139         public ServiceItem getElementAt(int index) {</span>
<span class="line-modified">140             return list.get(index);</span>
<span class="line-modified">141         }</span>
<span class="line-added">142 </span>
<span class="line-added">143         private void refreshList(List&lt;ServiceItem&gt; newList) {</span>
<span class="line-added">144             list.clear();</span>
<span class="line-added">145             list.addAll(newList);</span>
<span class="line-added">146             fireChanged();</span>
<span class="line-added">147         }</span>
<span class="line-added">148 </span>
<span class="line-added">149         private void fireChanged() {</span>
<span class="line-added">150             fireContentsChanged(this, 0, list.size() - 1);</span>
151         }
152     }
153 
<span class="line-modified">154     private static class ServiceItemListRenderer extends DefaultListCellRenderer {</span>
<span class="line-modified">155         @Override</span>
<span class="line-modified">156         public Component getListCellRendererComponent(JList&lt;?&gt; list,</span>
<span class="line-modified">157                                                       Object value,</span>
<span class="line-modified">158                                                       int index,</span>
<span class="line-modified">159                                                       boolean isSelected,</span>
<span class="line-modified">160                                                       boolean cellHasFocus) {</span>
<span class="line-modified">161             Component component =</span>
<span class="line-modified">162                     super.getListCellRendererComponent(list, value, index,</span>
<span class="line-modified">163                                                        isSelected, cellHasFocus);</span>
<span class="line-modified">164             switch (((ServiceItem) value).state) {</span>
<span class="line-modified">165                 case REMOVED:</span>
<span class="line-modified">166                     component.setBackground(Color.RED);</span>
<span class="line-modified">167                     component.setForeground(Color.WHITE);</span>
<span class="line-modified">168                     break;</span>
<span class="line-modified">169                 case ADDED:</span>
<span class="line-modified">170                     component.setBackground(Color.GREEN);</span>
<span class="line-added">171                     component.setForeground(Color.BLACK);</span>
<span class="line-added">172                     break;</span>
<span class="line-added">173                 case UNCHANGED:</span>
<span class="line-added">174                 default:</span>
<span class="line-added">175                     break;</span>
176             }
<span class="line-added">177             return component;</span>
178         }
179     }

180 
<span class="line-modified">181     private static final String INSTRUCTIONS_TEXT =</span>
<span class="line-modified">182             &quot;Please follow the steps for this manual test:\n&quot;</span>
<span class="line-modified">183                     + &quot;Step 0: \&quot;Before\&quot; list is populated with currently &quot;</span>
<span class="line-added">184                     +          &quot;configured printers.\n&quot;</span>
<span class="line-added">185                     + &quot;Step 1: Add or Remove a network printer using &quot;</span>
<span class="line-added">186                     +          &quot;Windows Control Panel.\n&quot;</span>
<span class="line-added">187                     + &quot;Step 2: Wait for 2\u20134 minutes after adding or removing.\n&quot;</span>
<span class="line-added">188                     + &quot;             \&quot;Next printer refresh in\&quot; gives you a &quot;</span>
<span class="line-added">189                     +          &quot;rough estimation on when update will happen.\n&quot;</span>
<span class="line-added">190                     + &quot;Step 3: Click Refresh.&quot;</span>
<span class="line-added">191                     +          &quot;\&quot;After\&quot; list is populated with updated list &quot;</span>
<span class="line-added">192                     +          &quot;of printers.\n&quot;</span>
<span class="line-added">193                     + &quot;Step 4: Compare the list of printers in \&quot;Before\&quot; and &quot;</span>
<span class="line-added">194                     +          &quot;\&quot;After\&quot; lists.\n&quot;</span>
<span class="line-added">195                     + &quot;              Added printers are highlighted with &quot;</span>
<span class="line-added">196                     +               &quot;green color, removed ones \u2014 with &quot;</span>
<span class="line-added">197                     +               &quot;red color.\n&quot;</span>
<span class="line-added">198                     + &quot;Step 5: Click Pass if the list of printers is correctly &quot;</span>
<span class="line-added">199                     +          &quot;updated.\n&quot;</span>
<span class="line-added">200                     + &quot;Step 6: If the list is not updated, wait for another &quot;</span>
<span class="line-added">201                     +          &quot;2\u20134 minutes, and then click Refresh again.\n&quot;</span>
<span class="line-added">202                     + &quot;Step 7: If the list does not update, click Fail.\n&quot;</span>
<span class="line-added">203                     + &quot;\n&quot;</span>
<span class="line-added">204                     + &quot;You have to click Refresh to enable Pass and Fail buttons. &quot;</span>
<span class="line-added">205                     + &quot;If no button is pressed,\n&quot;</span>
<span class="line-added">206                     + &quot;the test will time out. &quot;</span>
<span class="line-added">207                     + &quot;Closing the window also fails the test.&quot;;</span>
<span class="line-added">208 </span>
<span class="line-added">209     public static void main(String[] args) throws Exception {</span>
<span class="line-added">210         SwingUtilities.invokeAndWait(RemotePrinterStatusRefresh::createUI);</span>
<span class="line-added">211 </span>
<span class="line-added">212         latch.await();</span>
<span class="line-added">213         if (!test.testResult) {</span>
<span class="line-added">214             throw new RuntimeException(&quot;Test failed&quot;</span>
<span class="line-added">215                 + (test.testTimedOut ? &quot; because of time out&quot; : &quot;&quot;));</span>
<span class="line-added">216         }</span>
<span class="line-added">217     }</span>
<span class="line-added">218 </span>
<span class="line-added">219     private static long getRefreshTime() {</span>
<span class="line-added">220         String refreshTime =</span>
<span class="line-added">221                 System.getProperty(&quot;sun.java2d.print.minRefreshTime&quot;,</span>
<span class="line-added">222                                    Long.toString(DEFAULT_REFRESH_TIME));</span>
<span class="line-added">223         try {</span>
<span class="line-added">224             long value = Long.parseLong(refreshTime);</span>
<span class="line-added">225             return value &lt; MINIMAL_REFRESH_TIME ? MINIMAL_REFRESH_TIME : value;</span>
<span class="line-added">226         } catch (NumberFormatException e) {</span>
<span class="line-added">227             return DEFAULT_REFRESH_TIME;</span>
<span class="line-added">228         }</span>
<span class="line-added">229     }</span>
<span class="line-added">230 </span>
<span class="line-added">231     private static void createUI() {</span>
<span class="line-added">232         test = new RemotePrinterStatusRefresh();</span>
<span class="line-added">233     }</span>
<span class="line-added">234 </span>
<span class="line-added">235     private RemotePrinterStatusRefresh() {</span>
<span class="line-added">236         frame = new JFrame(&quot;RemotePrinterStatusRefresh&quot;);</span>
<span class="line-added">237         frame.addWindowListener(this);</span>
238 

239 
<span class="line-modified">240         JPanel northPanel = new JPanel(new BorderLayout());</span>
<span class="line-modified">241         northPanel.add(createInfoPanel(), BorderLayout.NORTH);</span>
<span class="line-modified">242         northPanel.add(createInstructionsPanel(), BorderLayout.SOUTH);</span>

243 



244 
<span class="line-modified">245         beforeList = new ServiceItemListModel(</span>
<span class="line-modified">246                 Collections.unmodifiableList(collectPrinterList()));</span>
<span class="line-modified">247         afterList = new ServiceItemListModel(new ArrayList&lt;&gt;());</span>
<span class="line-modified">248         logList(&quot;Before:&quot;, beforeList.list);</span>

249 
<span class="line-modified">250         JPanel listPanel = new JPanel(new GridLayout(1, 2));</span>
<span class="line-modified">251         listPanel.setBorder(createTitledBorder(&quot;Print Services&quot;));</span>
<span class="line-added">252         listPanel.add(createListPanel(beforeList, &quot;Before:&quot;, &#39;b&#39;));</span>
<span class="line-added">253         listPanel.add(createListPanel(afterList, &quot;After:&quot;, &#39;a&#39;));</span>
<span class="line-added">254 </span>
<span class="line-added">255 </span>
<span class="line-added">256         JPanel mainPanel = new JPanel(new BorderLayout());</span>
<span class="line-added">257         mainPanel.add(northPanel, BorderLayout.NORTH);</span>
<span class="line-added">258         mainPanel.add(listPanel, BorderLayout.CENTER);</span>
<span class="line-added">259         mainPanel.add(createButtonPanel(), BorderLayout.SOUTH);</span>
<span class="line-added">260 </span>
<span class="line-added">261 </span>
<span class="line-added">262         frame.add(mainPanel);</span>
<span class="line-added">263         frame.pack();</span>
<span class="line-added">264         refreshButton.requestFocusInWindow();</span>
<span class="line-added">265         frame.setVisible(true);</span>
<span class="line-added">266 </span>
<span class="line-added">267 </span>
<span class="line-added">268         timer = new Timer(1000, this::updateTimeLeft);</span>
<span class="line-added">269         timer.start();</span>
<span class="line-added">270         startTime = System.currentTimeMillis();</span>
<span class="line-added">271         updateTimeLeft(null);</span>
<span class="line-added">272     }</span>
<span class="line-added">273 </span>
<span class="line-added">274     private JPanel createInfoPanel() {</span>
<span class="line-added">275         JLabel javaLabel = new JLabel(&quot;Java version:&quot;);</span>
<span class="line-added">276         JTextField javaVersion =</span>
<span class="line-added">277                 new JTextField(System.getProperty(&quot;java.runtime.version&quot;));</span>
<span class="line-added">278         javaVersion.setEditable(false);</span>
<span class="line-added">279         javaLabel.setLabelFor(javaVersion);</span>
<span class="line-added">280 </span>
<span class="line-added">281         JLabel refreshTimeLabel = new JLabel(&quot;Refresh interval:&quot;);</span>
<span class="line-added">282         long minutes = refreshTime / 60;</span>
<span class="line-added">283         long seconds = refreshTime % 60;</span>
<span class="line-added">284         String interval = String.format(&quot;%1$d seconds%2$s&quot;,</span>
<span class="line-added">285                 refreshTime,</span>
<span class="line-added">286                 minutes &gt; 0</span>
<span class="line-added">287                     ? String.format(&quot; (%1$d %2$s%3$s)&quot;,</span>
<span class="line-added">288                         minutes,</span>
<span class="line-added">289                         minutes &gt; 1 ? &quot;minutes&quot; : &quot;minute&quot;,</span>
<span class="line-added">290                         seconds &gt; 0</span>
<span class="line-added">291                             ? String.format(&quot; %1$d %2$s&quot;,</span>
<span class="line-added">292                                 seconds,</span>
<span class="line-added">293                                 seconds &gt; 1 ? &quot;seconds&quot; : &quot;second&quot;)</span>
<span class="line-added">294                             : &quot;&quot;)</span>
<span class="line-added">295                     : &quot;&quot;</span>
<span class="line-added">296         );</span>
<span class="line-added">297         JTextField refreshInterval = new JTextField(interval);</span>
<span class="line-added">298         refreshInterval.setEditable(false);</span>
<span class="line-added">299         refreshTimeLabel.setLabelFor(refreshInterval);</span>
<span class="line-added">300 </span>
<span class="line-added">301         JLabel nextRefreshLabel = new JLabel(&quot;Next printer refresh in:&quot;);</span>
<span class="line-added">302         nextRefresh = new JTextField();</span>
<span class="line-added">303         nextRefresh.setEditable(false);</span>
<span class="line-added">304         nextRefreshLabel.setLabelFor(nextRefresh);</span>
<span class="line-added">305 </span>
<span class="line-added">306         JLabel timeoutLabel = new JLabel(&quot;Time left:&quot;);</span>
<span class="line-added">307         timeLeft = new JTextField();</span>
<span class="line-added">308         timeLeft.setEditable(false);</span>
<span class="line-added">309         timeoutLabel.setLabelFor(timeLeft);</span>
<span class="line-added">310 </span>
<span class="line-added">311         JPanel infoPanel = new JPanel();</span>
<span class="line-added">312         GroupLayout layout = new GroupLayout(infoPanel);</span>
<span class="line-added">313         infoPanel.setLayout(layout);</span>
<span class="line-added">314         infoPanel.setBorder(BorderFactory.createTitledBorder(&quot;Info&quot;));</span>
<span class="line-added">315         layout.setAutoCreateGaps(true);</span>
<span class="line-added">316         layout.setHorizontalGroup(</span>
<span class="line-added">317             layout.createSequentialGroup()</span>
<span class="line-added">318                 .addGroup(layout.createParallelGroup(GroupLayout.Alignment.LEADING)</span>
<span class="line-added">319                     .addComponent(javaLabel)</span>
<span class="line-added">320                     .addComponent(refreshTimeLabel)</span>
<span class="line-added">321                     .addComponent(nextRefreshLabel)</span>
<span class="line-added">322                     .addComponent(timeoutLabel)</span>
<span class="line-added">323                 )</span>
<span class="line-added">324                 .addGroup(layout.createParallelGroup(GroupLayout.Alignment.LEADING, true)</span>
<span class="line-added">325                     .addComponent(javaVersion)</span>
<span class="line-added">326                     .addComponent(refreshInterval)</span>
<span class="line-added">327                     .addComponent(nextRefresh)</span>
<span class="line-added">328                     .addComponent(timeLeft)</span>
<span class="line-added">329                 )</span>
<span class="line-added">330         );</span>
<span class="line-added">331         layout.setVerticalGroup(</span>
<span class="line-added">332             layout.createSequentialGroup()</span>
<span class="line-added">333                 .addGroup(layout.createParallelGroup(GroupLayout.Alignment.BASELINE)</span>
<span class="line-added">334                     .addComponent(javaLabel)</span>
<span class="line-added">335                     .addComponent(javaVersion)</span>
<span class="line-added">336                 )</span>
<span class="line-added">337                 .addGroup(layout.createParallelGroup(GroupLayout.Alignment.BASELINE)</span>
<span class="line-added">338                     .addComponent(refreshTimeLabel)</span>
<span class="line-added">339                     .addComponent(refreshInterval))</span>
<span class="line-added">340                 .addGroup(layout.createParallelGroup(GroupLayout.Alignment.BASELINE)</span>
<span class="line-added">341                     .addComponent(nextRefreshLabel)</span>
<span class="line-added">342                     .addComponent(nextRefresh))</span>
<span class="line-added">343                 .addGroup(layout.createParallelGroup(GroupLayout.Alignment.BASELINE)</span>
<span class="line-added">344                     .addComponent(timeoutLabel)</span>
<span class="line-added">345                     .addComponent(timeLeft))</span>
<span class="line-added">346         );</span>
<span class="line-added">347         return infoPanel;</span>
<span class="line-added">348     }</span>
<span class="line-added">349 </span>
<span class="line-added">350     private JPanel createInstructionsPanel() {</span>
<span class="line-added">351         JPanel instructionsPanel = new JPanel(new BorderLayout());</span>
<span class="line-added">352         JTextArea instructionText = new JTextArea(INSTRUCTIONS_TEXT);</span>
<span class="line-added">353         instructionText.setEditable(false);</span>
<span class="line-added">354         instructionsPanel.setBorder(createTitledBorder(&quot;Test Instructions&quot;));</span>
<span class="line-added">355         instructionsPanel.add(new JScrollPane(instructionText));</span>
<span class="line-added">356         return  instructionsPanel;</span>
357     }
358 
<span class="line-modified">359     private JPanel createListPanel(final ServiceItemListModel model,</span>
<span class="line-modified">360                                    final String title,</span>
<span class="line-modified">361                                    final char mnemonic) {</span>
<span class="line-modified">362         JPanel panel = new JPanel();</span>
<span class="line-modified">363         panel.setLayout(new BoxLayout(panel, BoxLayout.Y_AXIS));</span>
<span class="line-modified">364         JList&lt;ServiceItem&gt; list = new JList&lt;&gt;(model);</span>
<span class="line-modified">365         list.setCellRenderer(new ServiceItemListRenderer());</span>
<span class="line-modified">366 </span>
<span class="line-modified">367         JLabel label = new JLabel(title);</span>
<span class="line-modified">368         label.setLabelFor(list);</span>
<span class="line-modified">369         label.setDisplayedMnemonic(mnemonic);</span>
<span class="line-modified">370         JPanel labelPanel = new JPanel();</span>
<span class="line-modified">371         labelPanel.setLayout(new BoxLayout(labelPanel, BoxLayout.X_AXIS));</span>
<span class="line-modified">372         labelPanel.add(label, BorderLayout.EAST);</span>
<span class="line-modified">373         labelPanel.add(Box.createHorizontalGlue());</span>
<span class="line-modified">374 </span>
<span class="line-modified">375         panel.add(labelPanel);</span>
<span class="line-modified">376         panel.add(new JScrollPane(list));</span>
<span class="line-modified">377         return panel;</span>
<span class="line-modified">378     }</span>
<span class="line-modified">379 </span>
<span class="line-modified">380     private JPanel createButtonPanel() {</span>
<span class="line-modified">381         refreshButton = new JButton(&quot;Refresh&quot;);</span>
<span class="line-modified">382         refreshButton.addActionListener(this::refresh);</span>
<span class="line-modified">383 </span>



















384         passButton = new JButton(&quot;Pass&quot;);
<span class="line-modified">385         passButton.addActionListener(this::pass);</span>
<span class="line-modified">386         passButton.setEnabled(false);</span>





387 
388         failButton = new JButton(&quot;Fail&quot;);
<span class="line-modified">389         failButton.addActionListener(this::fail);</span>
<span class="line-modified">390         failButton.setEnabled(false);</span>
<span class="line-modified">391 </span>
<span class="line-modified">392         JPanel buttonPanel = new JPanel();</span>
<span class="line-modified">393         buttonPanel.setLayout(new BoxLayout(buttonPanel, BoxLayout.X_AXIS));</span>
<span class="line-modified">394         buttonPanel.add(Box.createHorizontalGlue());</span>
<span class="line-modified">395         buttonPanel.add(refreshButton);</span>
<span class="line-added">396         buttonPanel.add(passButton);</span>
<span class="line-added">397         buttonPanel.add(failButton);</span>
<span class="line-added">398         buttonPanel.add(Box.createHorizontalGlue());</span>
<span class="line-added">399         return buttonPanel;</span>
<span class="line-added">400     }</span>
401 
<span class="line-modified">402     private static List&lt;ServiceItem&gt; collectPrinterList() {</span>
<span class="line-modified">403         PrintService[] printServices = PrintServiceLookup.lookupPrintServices(null, null);</span>
<span class="line-modified">404         List&lt;ServiceItem&gt; list = new ArrayList&lt;&gt;(printServices.length);</span>
<span class="line-added">405         for (PrintService service : printServices) {</span>
<span class="line-added">406             list.add(new ServiceItem(service.getName()));</span>
<span class="line-added">407         }</span>
<span class="line-added">408         return list;</span>
<span class="line-added">409     }</span>
410 
<span class="line-modified">411     private static void logList(final String title, final List&lt;ServiceItem&gt; list) {</span>
<span class="line-modified">412         System.out.println(title);</span>
<span class="line-modified">413         for (ServiceItem item : list) {</span>
<span class="line-added">414             System.out.println(item.name);</span>
<span class="line-added">415         }</span>
<span class="line-added">416         System.out.println();</span>
<span class="line-added">417     }</span>
418 
<span class="line-modified">419     private static void compareLists(final ServiceItemListModel before, final ServiceItemListModel after) {</span>
<span class="line-modified">420         boolean beforeUpdated = false;</span>
<span class="line-modified">421         boolean afterUpdated = false;</span>
<span class="line-added">422 </span>
<span class="line-added">423         for (ServiceItem item : before.list) {</span>
<span class="line-added">424             if (!after.list.contains(item)) {</span>
<span class="line-added">425                 item.state = ServiceItem.State.REMOVED;</span>
<span class="line-added">426                 beforeUpdated = true;</span>
<span class="line-added">427             } else if (item.state != ServiceItem.State.UNCHANGED) {</span>
<span class="line-added">428                 item.state = ServiceItem.State.UNCHANGED;</span>
<span class="line-added">429                 beforeUpdated = true;</span>
<span class="line-added">430             }</span>
<span class="line-added">431         }</span>
<span class="line-added">432 </span>
<span class="line-added">433         for (ServiceItem item : after.list) {</span>
<span class="line-added">434             if (!before.list.contains(item)) {</span>
<span class="line-added">435                 item.state = ServiceItem.State.ADDED;</span>
<span class="line-added">436                 afterUpdated = true;</span>
<span class="line-added">437             } else if (item.state != ServiceItem.State.UNCHANGED) {</span>
<span class="line-added">438                 item.state = ServiceItem.State.UNCHANGED;</span>
<span class="line-added">439                 afterUpdated = true;</span>
<span class="line-added">440             }</span>
<span class="line-added">441         }</span>
442 
<span class="line-modified">443         if (beforeUpdated) {</span>
<span class="line-modified">444             before.fireChanged();</span>
<span class="line-modified">445         }</span>
<span class="line-modified">446         if (afterUpdated) {</span>
<span class="line-added">447             after.fireChanged();</span>
<span class="line-added">448         }</span>
<span class="line-added">449     }</span>
450 
<span class="line-modified">451     @Override</span>
<span class="line-modified">452     public void windowClosing(WindowEvent e) {</span>
<span class="line-modified">453         System.out.println(&quot;The window closed&quot;);</span>
<span class="line-modified">454         disposeUI();</span>
<span class="line-added">455     }</span>
456 
<span class="line-modified">457     private void disposeUI() {</span>
<span class="line-modified">458         timer.stop();</span>
<span class="line-modified">459         latch.countDown();</span>
<span class="line-added">460         frame.dispose();</span>
<span class="line-added">461     }</span>
462 
<span class="line-modified">463     @SuppressWarnings(&quot;unused&quot;)</span>
<span class="line-modified">464     private void refresh(ActionEvent e) {</span>
<span class="line-modified">465         System.out.println(&quot;Refresh button pressed&quot;);</span>
<span class="line-added">466         afterList.refreshList(collectPrinterList());</span>
<span class="line-added">467         compareLists(beforeList, afterList);</span>
<span class="line-added">468         passButton.setEnabled(true);</span>
<span class="line-added">469         failButton.setEnabled(true);</span>
<span class="line-added">470         logList(&quot;After:&quot;, afterList.list);</span>
471     }
472 
<span class="line-modified">473     @SuppressWarnings(&quot;unused&quot;)</span>
<span class="line-modified">474     private void pass(ActionEvent e) {</span>
<span class="line-added">475         System.out.println(&quot;Pass button pressed&quot;);</span>
<span class="line-added">476         testResult = true;</span>
<span class="line-added">477         disposeUI();</span>
478     }
<span class="line-added">479 </span>
<span class="line-added">480     @SuppressWarnings(&quot;unused&quot;)</span>
<span class="line-added">481     private void fail(ActionEvent e) {</span>
<span class="line-added">482         System.out.println(&quot;Fail button pressed&quot;);</span>
<span class="line-added">483         testResult = false;</span>
<span class="line-added">484         disposeUI();</span>
<span class="line-added">485     }</span>
<span class="line-added">486 </span>
<span class="line-added">487     @SuppressWarnings(&quot;unused&quot;)</span>
<span class="line-added">488     private void updateTimeLeft(ActionEvent e) {</span>
<span class="line-added">489         long elapsed = (System.currentTimeMillis() - startTime) / 1000;</span>
<span class="line-added">490         long left = TIMEOUT - elapsed;</span>
<span class="line-added">491         if (left &lt; 0) {</span>
<span class="line-added">492             testTimedOut = true;</span>
<span class="line-added">493             disposeUI();</span>
<span class="line-added">494         }</span>
<span class="line-added">495         timeLeft.setText(formatTime(left));</span>
<span class="line-added">496         nextRefresh.setText(formatTime(refreshTime - (elapsed % refreshTime)));</span>
<span class="line-added">497     }</span>
<span class="line-added">498 </span>
<span class="line-added">499     private static String formatTime(final long seconds) {</span>
<span class="line-added">500         long minutes = seconds / 60;</span>
<span class="line-added">501         return String.format(&quot;%d:%02d&quot;, minutes, seconds - minutes * 60);</span>
<span class="line-added">502     }</span>
<span class="line-added">503 </span>
504 }
</pre>
</td>
</tr>
</table>
<center><a href="../PrinterJob/PrintToDir.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../../../io/DataOutputStream/WriteUTF.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>