<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff test/jdk/java/awt/print/RemotePrinterStatusRefresh/RemotePrinterStatusRefresh.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="../PrinterJob/PrintToDir.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../../../io/DataOutputStream/WriteUTF.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/awt/print/RemotePrinterStatusRefresh/RemotePrinterStatusRefresh.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2018, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2018, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 19,246 ***</span>
   * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
   * or visit www.oracle.com if you need additional information or have any
   * questions.
   */
  
<span class="line-modified">! /**</span>
   * @test
<span class="line-modified">!  * @bug 8153732 8212202</span>
   * @requires (os.family == &quot;Windows&quot;)
   * @summary Windows remote printer changes do not reflect in lookupPrintServices()
<span class="line-modified">!  * @ignore Requires a new network printer installation\removal</span>
<span class="line-removed">-  * @run main/manual RemotePrinterStatusRefresh</span>
   */
  
<span class="line-modified">! import java.awt.GridBagConstraints;</span>
<span class="line-modified">! import java.awt.GridBagLayout;</span>
  import java.awt.event.ActionEvent;
<span class="line-modified">! import java.awt.print.PageFormat;</span>
<span class="line-modified">! import java.awt.print.Paper;</span>
<span class="line-modified">! import java.awt.print.PrinterException;</span>
  import java.util.concurrent.CountDownLatch;
<span class="line-modified">! import java.util.concurrent.TimeUnit;</span>
  import javax.swing.BorderFactory;
  import javax.swing.Box;
  import javax.swing.JButton;
  import javax.swing.JFrame;
  import javax.swing.JLabel;
  import javax.swing.JPanel;
  import javax.swing.JTextArea;
  import javax.swing.SwingUtilities;
<span class="line-modified">! import java.awt.print.PrinterJob;</span>
<span class="line-removed">- import javax.print.PrintService;</span>
  
<span class="line-modified">! public class RemotePrinterStatusRefresh</span>
<span class="line-modified">! {</span>
<span class="line-modified">!     private static TestUI test = null;</span>
<span class="line-modified">!     public static void main(String args[]) throws Exception {</span>
<span class="line-modified">!         final CountDownLatch latch = new CountDownLatch(1);</span>
<span class="line-modified">! </span>
<span class="line-modified">!         // Test UI creation</span>
<span class="line-modified">!         test = new TestUI(latch);</span>
<span class="line-modified">! </span>
<span class="line-modified">!         SwingUtilities.invokeAndWait(new Runnable() {</span>
<span class="line-modified">!             @Override</span>
<span class="line-modified">!             public void run() {</span>
<span class="line-modified">!                 try {</span>
<span class="line-modified">!                     test.createUI();</span>
<span class="line-modified">!                 } catch (Exception e) {</span>
<span class="line-modified">!                     throw new RuntimeException(e);</span>
<span class="line-modified">!                 }</span>
<span class="line-modified">!             }</span>
<span class="line-modified">!         });</span>
<span class="line-modified">! </span>
<span class="line-modified">!         // RemotePrinterStatusRefresh creation</span>
<span class="line-modified">!         RemotePrinterStatusRefresh RemotePrinterStatusRefresh = new RemotePrinterStatusRefresh();</span>
<span class="line-modified">!         SwingUtilities.invokeAndWait(() -&gt; {</span>
<span class="line-modified">!             collectPrintersList(test.resultsTextArea, true);</span>
<span class="line-modified">!         });</span>
<span class="line-modified">! </span>
<span class="line-modified">!         // 8 min = 480000 msec</span>
<span class="line-modified">!         if(waitForFlag(480000)) {</span>
<span class="line-modified">!             SwingUtilities.invokeAndWait(() -&gt; {</span>
<span class="line-modified">!                 collectPrintersList(test.resultsTextArea, false);</span>
<span class="line-modified">!             });</span>
<span class="line-modified">!         } else {</span>
<span class="line-modified">!             dispose();</span>
<span class="line-modified">!             throw new RuntimeException(&quot;No new network printer got added/removed!! Test timed out!!&quot;);</span>
          }
  
<span class="line-modified">!         boolean status = latch.await(1, TimeUnit.MINUTES);</span>
<span class="line-modified">!         if (!status) {</span>
<span class="line-modified">!             dispose();</span>
<span class="line-modified">!             throw new RuntimeException(&quot;Test timed out.&quot;);</span>
          }
  
<span class="line-modified">!         if (test.testResult == false) {</span>
<span class="line-modified">!             dispose();</span>
<span class="line-modified">!             throw new RuntimeException(&quot;Test Failed.&quot;);</span>
          }
  
<span class="line-modified">!         dispose();</span>
<span class="line-modified">!     }</span>
  
<span class="line-modified">!     public static void dispose() throws Exception {</span>
<span class="line-modified">!         SwingUtilities.invokeAndWait(() -&gt; {</span>
<span class="line-modified">!             test.disposeUI();</span>
<span class="line-modified">!         });</span>
      }
  
<span class="line-modified">!     public static boolean waitForFlag (long maxTimeoutInMsec) throws Exception {</span>
<span class="line-modified">!         while(!test.isAdded &amp;&amp; maxTimeoutInMsec &gt; 0) {</span>
<span class="line-modified">!             maxTimeoutInMsec -= 100;</span>
<span class="line-modified">!             Thread.sleep(100);</span>
          }
  
<span class="line-modified">!         if(maxTimeoutInMsec &lt;= 0) {</span>
<span class="line-modified">!             return false;</span>
<span class="line-modified">!         } else {</span>
<span class="line-modified">!             return true;</span>
          }
      }
  
<span class="line-modified">!     private static void collectPrintersList(JTextArea textArea, boolean before) {</span>
<span class="line-modified">!         if(before) {</span>
<span class="line-modified">!             System.out.println(&quot;List of printers(before): &quot;);</span>
<span class="line-modified">!             textArea.setText(&quot;List of printers(before): \n&quot;);</span>
<span class="line-modified">!             for (PrintService printServiceBefore : PrinterJob.lookupPrintServices()) {</span>
<span class="line-modified">!                 System.out.println(printServiceBefore);</span>
<span class="line-modified">!                 textArea.append(printServiceBefore.toString());</span>
<span class="line-modified">!                 textArea.append(&quot;\n&quot;);</span>
<span class="line-modified">!             }</span>
<span class="line-modified">!         } else {</span>
<span class="line-modified">!             textArea.append(&quot;\n&quot;);</span>
<span class="line-modified">!             System.out.println(&quot;List of printers(after): &quot;);</span>
<span class="line-modified">!             textArea.append(&quot;List of printers(after): \n&quot;);</span>
<span class="line-modified">!             for (PrintService printServiceAfter : PrinterJob.lookupPrintServices()) {</span>
<span class="line-modified">!                 System.out.println(printServiceAfter);</span>
<span class="line-modified">!                 textArea.append(printServiceAfter.toString());</span>
<span class="line-modified">!                 textArea.append(&quot;\n&quot;);</span>
              }
          }
      }
<span class="line-removed">- }</span>
  
<span class="line-modified">! class TestUI {</span>
<span class="line-modified">!     private static JFrame mainFrame;</span>
<span class="line-modified">!     private static JPanel mainControlPanel;</span>
  
<span class="line-removed">-     private static JTextArea instructionTextArea;</span>
  
<span class="line-modified">!     private static JPanel resultButtonPanel;</span>
<span class="line-modified">!     private static JButton passButton;</span>
<span class="line-modified">!     private static JButton failButton;</span>
<span class="line-removed">-     private static JButton addedButton;</span>
  
<span class="line-removed">-     private static JPanel testPanel;</span>
<span class="line-removed">-     private static JButton testButton;</span>
<span class="line-removed">-     private static JLabel buttonPressCountLabel;</span>
  
<span class="line-modified">!     private static GridBagLayout layout;</span>
<span class="line-modified">!     private final CountDownLatch latch;</span>
<span class="line-modified">!     public boolean testResult = false;</span>
<span class="line-modified">!     public volatile Boolean isAdded = false;</span>
<span class="line-removed">-     public static JTextArea resultsTextArea;</span>
  
<span class="line-modified">!     public TestUI(CountDownLatch latch) throws Exception {</span>
<span class="line-modified">!         this.latch = latch;</span>
      }
  
<span class="line-modified">!     public final void createUI() {</span>
<span class="line-modified">!         mainFrame = new JFrame(&quot;RemotePrinterStatusRefresh&quot;);</span>
<span class="line-modified">!         layout = new GridBagLayout();</span>
<span class="line-modified">!         mainControlPanel = new JPanel(layout);</span>
<span class="line-modified">!         resultButtonPanel = new JPanel(layout);</span>
<span class="line-modified">!         testPanel = new JPanel(layout);</span>
<span class="line-modified">!         GridBagConstraints gbc = new GridBagConstraints();</span>
<span class="line-modified">! </span>
<span class="line-modified">!         // Create Test instructions</span>
<span class="line-modified">!         String instructions</span>
<span class="line-modified">!                 = &quot;This test displays the current list of printers(before) attached to \n&quot;</span>
<span class="line-modified">!                 + &quot;this computer in the results panel.\n\n&quot;</span>
<span class="line-modified">!                 + &quot;Please follow the below steps for this manual test\n&quot;</span>
<span class="line-modified">!                 + &quot;--------------------------------------------------------------------\n&quot;</span>
<span class="line-modified">!                 + &quot;Step 1: Add/Remove a new network printer and Wait for 4 minutes after adding/removing\n&quot;</span>
<span class="line-modified">!                 + &quot;Step 2: Then click on &#39;Printer Added/Removed&#39; button\n&quot;</span>
<span class="line-modified">!                 + &quot;Step 2: Once the new network printer is added/removed, see if it is \n&quot;</span>
<span class="line-modified">!                 + &quot;        the same as displayed/not displayed in the results panel.\n&quot;</span>
<span class="line-modified">!                 + &quot;Step 3: If displayed/not displayed, then click &#39;Pass&#39; else click on &#39;Fail&#39; button&quot;;</span>
<span class="line-modified">! </span>
<span class="line-modified">!         instructionTextArea = new JTextArea();</span>
<span class="line-modified">!         instructionTextArea.setText(instructions);</span>
<span class="line-modified">!         instructionTextArea.setEditable(false);</span>
<span class="line-modified">!         instructionTextArea.setBorder(BorderFactory.</span>
<span class="line-modified">!                 createTitledBorder(&quot;Test Instructions&quot;));</span>
<span class="line-removed">- </span>
<span class="line-removed">-         gbc.gridx = 0;</span>
<span class="line-removed">-         gbc.gridy = 0;</span>
<span class="line-removed">-         gbc.fill = GridBagConstraints.HORIZONTAL;</span>
<span class="line-removed">-         mainControlPanel.add(instructionTextArea, gbc);</span>
<span class="line-removed">- </span>
<span class="line-removed">-         gbc.gridx = 0;</span>
<span class="line-removed">-         gbc.gridy = 1;</span>
<span class="line-removed">-         testPanel.add(Box.createVerticalStrut(50));</span>
<span class="line-removed">-         mainControlPanel.add(testPanel);</span>
<span class="line-removed">- </span>
<span class="line-removed">-         addedButton = new JButton(&quot;Printer Added/Removed&quot;);</span>
<span class="line-removed">-         addedButton.setActionCommand(&quot;Added&quot;);</span>
<span class="line-removed">-         addedButton.addActionListener((ActionEvent e) -&gt; {</span>
<span class="line-removed">-             System.out.println(&quot;Added Button pressed!&quot;);</span>
<span class="line-removed">-             isAdded = true;</span>
<span class="line-removed">-         });</span>
<span class="line-removed">- </span>
<span class="line-removed">-         // Create resultButtonPanel with Pass, Fail buttons</span>
          passButton = new JButton(&quot;Pass&quot;);
<span class="line-modified">!         passButton.setActionCommand(&quot;Pass&quot;);</span>
<span class="line-modified">!         passButton.addActionListener((ActionEvent e) -&gt; {</span>
<span class="line-removed">-             System.out.println(&quot;Pass Button pressed!&quot;);</span>
<span class="line-removed">-             testResult = true;</span>
<span class="line-removed">-             latch.countDown();</span>
<span class="line-removed">-             disposeUI();</span>
<span class="line-removed">-         });</span>
  
          failButton = new JButton(&quot;Fail&quot;);
<span class="line-modified">!         failButton.setActionCommand(&quot;Fail&quot;);</span>
<span class="line-modified">!         failButton.addActionListener((ActionEvent e) -&gt; {</span>
<span class="line-modified">!             System.out.println(&quot;Fail Button pressed!&quot;);</span>
<span class="line-modified">!             testResult = false;</span>
<span class="line-modified">!             latch.countDown();</span>
<span class="line-modified">!             disposeUI();</span>
<span class="line-modified">!         });</span>
  
<span class="line-modified">!         gbc.gridx = 0;</span>
<span class="line-modified">!         gbc.gridy = 0;</span>
<span class="line-modified">!         resultButtonPanel.add(addedButton, gbc);</span>
  
<span class="line-modified">!         gbc.gridx = 1;</span>
<span class="line-modified">!         gbc.gridy = 0;</span>
<span class="line-modified">!         resultButtonPanel.add(passButton, gbc);</span>
  
<span class="line-modified">!         gbc.gridx = 2;</span>
<span class="line-modified">!         gbc.gridy = 0;</span>
<span class="line-modified">!         resultButtonPanel.add(failButton, gbc);</span>
  
<span class="line-modified">!         resultsTextArea = new JTextArea();</span>
<span class="line-modified">!         resultsTextArea.setEditable(false);</span>
<span class="line-modified">!         resultsTextArea.setBorder(BorderFactory.</span>
<span class="line-modified">!                 createTitledBorder(&quot;Results&quot;));</span>
  
<span class="line-modified">!         gbc.gridx = 0;</span>
<span class="line-modified">!         gbc.gridy = 1;</span>
<span class="line-modified">!         gbc.fill = GridBagConstraints.HORIZONTAL;</span>
<span class="line-modified">!         mainControlPanel.add(resultsTextArea, gbc);</span>
  
<span class="line-modified">!         gbc.gridx = 0;</span>
<span class="line-modified">!         gbc.gridy = 2;</span>
<span class="line-modified">!         mainControlPanel.add(resultButtonPanel, gbc);</span>
  
<span class="line-modified">!         mainFrame.add(mainControlPanel);</span>
<span class="line-modified">!         mainFrame.pack();</span>
<span class="line-modified">!         mainFrame.setVisible(true);</span>
      }
  
<span class="line-modified">!     public void disposeUI() {</span>
<span class="line-modified">!         mainFrame.dispose();</span>
      }
  }
<span class="line-new-header">--- 19,486 ---</span>
   * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
   * or visit www.oracle.com if you need additional information or have any
   * questions.
   */
  
<span class="line-modified">! /*</span>
   * @test
<span class="line-modified">!  * @bug 8153732 8212202 8221263 8221412 8222108</span>
   * @requires (os.family == &quot;Windows&quot;)
   * @summary Windows remote printer changes do not reflect in lookupPrintServices()
<span class="line-modified">!  * @run main/manual/othervm -Dsun.java2d.print.minRefreshTime=120 RemotePrinterStatusRefresh</span>
   */
  
<span class="line-modified">! import java.awt.BorderLayout;</span>
<span class="line-modified">! import java.awt.Color;</span>
<span class="line-added">+ import java.awt.Component;</span>
<span class="line-added">+ import java.awt.GridLayout;</span>
  import java.awt.event.ActionEvent;
<span class="line-modified">! import java.awt.event.WindowAdapter;</span>
<span class="line-modified">! import java.awt.event.WindowEvent;</span>
<span class="line-modified">! import java.util.ArrayList;</span>
<span class="line-added">+ import java.util.Collections;</span>
<span class="line-added">+ import java.util.List;</span>
  import java.util.concurrent.CountDownLatch;
<span class="line-modified">! import javax.print.PrintService;</span>
<span class="line-added">+ import javax.print.PrintServiceLookup;</span>
<span class="line-added">+ import javax.swing.AbstractListModel;</span>
  import javax.swing.BorderFactory;
  import javax.swing.Box;
<span class="line-added">+ import javax.swing.BoxLayout;</span>
<span class="line-added">+ import javax.swing.DefaultListCellRenderer;</span>
<span class="line-added">+ import javax.swing.GroupLayout;</span>
  import javax.swing.JButton;
  import javax.swing.JFrame;
  import javax.swing.JLabel;
<span class="line-added">+ import javax.swing.JList;</span>
  import javax.swing.JPanel;
<span class="line-added">+ import javax.swing.JScrollPane;</span>
  import javax.swing.JTextArea;
<span class="line-added">+ import javax.swing.JTextField;</span>
  import javax.swing.SwingUtilities;
<span class="line-modified">! import javax.swing.Timer;</span>
  
<span class="line-modified">! import static javax.swing.BorderFactory.createTitledBorder;</span>
<span class="line-modified">! </span>
<span class="line-modified">! public class RemotePrinterStatusRefresh extends WindowAdapter {</span>
<span class="line-modified">! </span>
<span class="line-modified">!     private static final long DEFAULT_REFRESH_TIME = 240L;</span>
<span class="line-modified">!     private static final long MINIMAL_REFRESH_TIME = 120L;</span>
<span class="line-modified">! </span>
<span class="line-modified">!     private static final long refreshTime = getRefreshTime();</span>
<span class="line-modified">! </span>
<span class="line-modified">!     private static final long TIMEOUT = refreshTime * 4 + 60;</span>
<span class="line-modified">! </span>
<span class="line-modified">! </span>
<span class="line-modified">!     private static final CountDownLatch latch = new CountDownLatch(1);</span>
<span class="line-modified">!     private static volatile RemotePrinterStatusRefresh test;</span>
<span class="line-modified">! </span>
<span class="line-modified">!     private volatile boolean testResult;</span>
<span class="line-modified">!     private volatile boolean testTimedOut;</span>
<span class="line-modified">! </span>
<span class="line-modified">!     private final JFrame frame;</span>
<span class="line-modified">! </span>
<span class="line-modified">!     private JButton refreshButton;</span>
<span class="line-modified">!     private JButton passButton;</span>
<span class="line-modified">!     private JButton failButton;</span>
<span class="line-modified">! </span>
<span class="line-modified">!     private final ServiceItemListModel beforeList;</span>
<span class="line-modified">!     private final ServiceItemListModel afterList;</span>
<span class="line-modified">! </span>
<span class="line-modified">!     private JTextField nextRefresh;</span>
<span class="line-modified">!     private JTextField timeLeft;</span>
<span class="line-modified">! </span>
<span class="line-modified">!     private final Timer timer;</span>
<span class="line-modified">!     private final long startTime;</span>
<span class="line-modified">! </span>
<span class="line-modified">! </span>
<span class="line-added">+     private static class ServiceItem {</span>
<span class="line-added">+         private enum State {</span>
<span class="line-added">+             REMOVED, UNCHANGED, ADDED</span>
          }
  
<span class="line-modified">!         final String name;</span>
<span class="line-modified">!         State state;</span>
<span class="line-modified">! </span>
<span class="line-modified">!         private ServiceItem(final String name) {</span>
<span class="line-added">+             this.name = name;</span>
<span class="line-added">+             state = State.UNCHANGED;</span>
          }
  
<span class="line-modified">!         @Override</span>
<span class="line-modified">!         public String toString() {</span>
<span class="line-modified">!             return name;</span>
          }
  
<span class="line-modified">!         @Override</span>
<span class="line-modified">!         public boolean equals(Object obj) {</span>
<span class="line-added">+             return (obj instanceof ServiceItem)</span>
<span class="line-added">+                     &amp;&amp; ((ServiceItem) obj).name.equals(name);</span>
<span class="line-added">+         }</span>
  
<span class="line-modified">!         @Override</span>
<span class="line-modified">!         public int hashCode() {</span>
<span class="line-modified">!             return name.hashCode();</span>
<span class="line-modified">!         }</span>
      }
  
<span class="line-modified">!     private static class ServiceItemListModel extends AbstractListModel&lt;ServiceItem&gt; {</span>
<span class="line-modified">!         private final List&lt;ServiceItem&gt; list;</span>
<span class="line-modified">! </span>
<span class="line-modified">!         private ServiceItemListModel(List&lt;ServiceItem&gt; list) {</span>
<span class="line-added">+             this.list = list;</span>
<span class="line-added">+         }</span>
<span class="line-added">+ </span>
<span class="line-added">+         @Override</span>
<span class="line-added">+         public int getSize() {</span>
<span class="line-added">+             return list.size();</span>
          }
  
<span class="line-modified">!         @Override</span>
<span class="line-modified">!         public ServiceItem getElementAt(int index) {</span>
<span class="line-modified">!             return list.get(index);</span>
<span class="line-modified">!         }</span>
<span class="line-added">+ </span>
<span class="line-added">+         private void refreshList(List&lt;ServiceItem&gt; newList) {</span>
<span class="line-added">+             list.clear();</span>
<span class="line-added">+             list.addAll(newList);</span>
<span class="line-added">+             fireChanged();</span>
<span class="line-added">+         }</span>
<span class="line-added">+ </span>
<span class="line-added">+         private void fireChanged() {</span>
<span class="line-added">+             fireContentsChanged(this, 0, list.size() - 1);</span>
          }
      }
  
<span class="line-modified">!     private static class ServiceItemListRenderer extends DefaultListCellRenderer {</span>
<span class="line-modified">!         @Override</span>
<span class="line-modified">!         public Component getListCellRendererComponent(JList&lt;?&gt; list,</span>
<span class="line-modified">!                                                       Object value,</span>
<span class="line-modified">!                                                       int index,</span>
<span class="line-modified">!                                                       boolean isSelected,</span>
<span class="line-modified">!                                                       boolean cellHasFocus) {</span>
<span class="line-modified">!             Component component =</span>
<span class="line-modified">!                     super.getListCellRendererComponent(list, value, index,</span>
<span class="line-modified">!                                                        isSelected, cellHasFocus);</span>
<span class="line-modified">!             switch (((ServiceItem) value).state) {</span>
<span class="line-modified">!                 case REMOVED:</span>
<span class="line-modified">!                     component.setBackground(Color.RED);</span>
<span class="line-modified">!                     component.setForeground(Color.WHITE);</span>
<span class="line-modified">!                     break;</span>
<span class="line-modified">!                 case ADDED:</span>
<span class="line-modified">!                     component.setBackground(Color.GREEN);</span>
<span class="line-added">+                     component.setForeground(Color.BLACK);</span>
<span class="line-added">+                     break;</span>
<span class="line-added">+                 case UNCHANGED:</span>
<span class="line-added">+                 default:</span>
<span class="line-added">+                     break;</span>
              }
<span class="line-added">+             return component;</span>
          }
      }
  
<span class="line-modified">!     private static final String INSTRUCTIONS_TEXT =</span>
<span class="line-modified">!             &quot;Please follow the steps for this manual test:\n&quot;</span>
<span class="line-modified">!                     + &quot;Step 0: \&quot;Before\&quot; list is populated with currently &quot;</span>
<span class="line-added">+                     +          &quot;configured printers.\n&quot;</span>
<span class="line-added">+                     + &quot;Step 1: Add or Remove a network printer using &quot;</span>
<span class="line-added">+                     +          &quot;Windows Control Panel.\n&quot;</span>
<span class="line-added">+                     + &quot;Step 2: Wait for 2\u20134 minutes after adding or removing.\n&quot;</span>
<span class="line-added">+                     + &quot;             \&quot;Next printer refresh in\&quot; gives you a &quot;</span>
<span class="line-added">+                     +          &quot;rough estimation on when update will happen.\n&quot;</span>
<span class="line-added">+                     + &quot;Step 3: Click Refresh.&quot;</span>
<span class="line-added">+                     +          &quot;\&quot;After\&quot; list is populated with updated list &quot;</span>
<span class="line-added">+                     +          &quot;of printers.\n&quot;</span>
<span class="line-added">+                     + &quot;Step 4: Compare the list of printers in \&quot;Before\&quot; and &quot;</span>
<span class="line-added">+                     +          &quot;\&quot;After\&quot; lists.\n&quot;</span>
<span class="line-added">+                     + &quot;              Added printers are highlighted with &quot;</span>
<span class="line-added">+                     +               &quot;green color, removed ones \u2014 with &quot;</span>
<span class="line-added">+                     +               &quot;red color.\n&quot;</span>
<span class="line-added">+                     + &quot;Step 5: Click Pass if the list of printers is correctly &quot;</span>
<span class="line-added">+                     +          &quot;updated.\n&quot;</span>
<span class="line-added">+                     + &quot;Step 6: If the list is not updated, wait for another &quot;</span>
<span class="line-added">+                     +          &quot;2\u20134 minutes, and then click Refresh again.\n&quot;</span>
<span class="line-added">+                     + &quot;Step 7: If the list does not update, click Fail.\n&quot;</span>
<span class="line-added">+                     + &quot;\n&quot;</span>
<span class="line-added">+                     + &quot;You have to click Refresh to enable Pass and Fail buttons. &quot;</span>
<span class="line-added">+                     + &quot;If no button is pressed,\n&quot;</span>
<span class="line-added">+                     + &quot;the test will time out. &quot;</span>
<span class="line-added">+                     + &quot;Closing the window also fails the test.&quot;;</span>
<span class="line-added">+ </span>
<span class="line-added">+     public static void main(String[] args) throws Exception {</span>
<span class="line-added">+         SwingUtilities.invokeAndWait(RemotePrinterStatusRefresh::createUI);</span>
<span class="line-added">+ </span>
<span class="line-added">+         latch.await();</span>
<span class="line-added">+         if (!test.testResult) {</span>
<span class="line-added">+             throw new RuntimeException(&quot;Test failed&quot;</span>
<span class="line-added">+                 + (test.testTimedOut ? &quot; because of time out&quot; : &quot;&quot;));</span>
<span class="line-added">+         }</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     private static long getRefreshTime() {</span>
<span class="line-added">+         String refreshTime =</span>
<span class="line-added">+                 System.getProperty(&quot;sun.java2d.print.minRefreshTime&quot;,</span>
<span class="line-added">+                                    Long.toString(DEFAULT_REFRESH_TIME));</span>
<span class="line-added">+         try {</span>
<span class="line-added">+             long value = Long.parseLong(refreshTime);</span>
<span class="line-added">+             return value &lt; MINIMAL_REFRESH_TIME ? MINIMAL_REFRESH_TIME : value;</span>
<span class="line-added">+         } catch (NumberFormatException e) {</span>
<span class="line-added">+             return DEFAULT_REFRESH_TIME;</span>
<span class="line-added">+         }</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     private static void createUI() {</span>
<span class="line-added">+         test = new RemotePrinterStatusRefresh();</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     private RemotePrinterStatusRefresh() {</span>
<span class="line-added">+         frame = new JFrame(&quot;RemotePrinterStatusRefresh&quot;);</span>
<span class="line-added">+         frame.addWindowListener(this);</span>
  
  
<span class="line-modified">!         JPanel northPanel = new JPanel(new BorderLayout());</span>
<span class="line-modified">!         northPanel.add(createInfoPanel(), BorderLayout.NORTH);</span>
<span class="line-modified">!         northPanel.add(createInstructionsPanel(), BorderLayout.SOUTH);</span>
  
  
<span class="line-modified">!         beforeList = new ServiceItemListModel(</span>
<span class="line-modified">!                 Collections.unmodifiableList(collectPrinterList()));</span>
<span class="line-modified">!         afterList = new ServiceItemListModel(new ArrayList&lt;&gt;());</span>
<span class="line-modified">!         logList(&quot;Before:&quot;, beforeList.list);</span>
  
<span class="line-modified">!         JPanel listPanel = new JPanel(new GridLayout(1, 2));</span>
<span class="line-modified">!         listPanel.setBorder(createTitledBorder(&quot;Print Services&quot;));</span>
<span class="line-added">+         listPanel.add(createListPanel(beforeList, &quot;Before:&quot;, &#39;b&#39;));</span>
<span class="line-added">+         listPanel.add(createListPanel(afterList, &quot;After:&quot;, &#39;a&#39;));</span>
<span class="line-added">+ </span>
<span class="line-added">+ </span>
<span class="line-added">+         JPanel mainPanel = new JPanel(new BorderLayout());</span>
<span class="line-added">+         mainPanel.add(northPanel, BorderLayout.NORTH);</span>
<span class="line-added">+         mainPanel.add(listPanel, BorderLayout.CENTER);</span>
<span class="line-added">+         mainPanel.add(createButtonPanel(), BorderLayout.SOUTH);</span>
<span class="line-added">+ </span>
<span class="line-added">+ </span>
<span class="line-added">+         frame.add(mainPanel);</span>
<span class="line-added">+         frame.pack();</span>
<span class="line-added">+         refreshButton.requestFocusInWindow();</span>
<span class="line-added">+         frame.setVisible(true);</span>
<span class="line-added">+ </span>
<span class="line-added">+ </span>
<span class="line-added">+         timer = new Timer(1000, this::updateTimeLeft);</span>
<span class="line-added">+         timer.start();</span>
<span class="line-added">+         startTime = System.currentTimeMillis();</span>
<span class="line-added">+         updateTimeLeft(null);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     private JPanel createInfoPanel() {</span>
<span class="line-added">+         JLabel javaLabel = new JLabel(&quot;Java version:&quot;);</span>
<span class="line-added">+         JTextField javaVersion =</span>
<span class="line-added">+                 new JTextField(System.getProperty(&quot;java.runtime.version&quot;));</span>
<span class="line-added">+         javaVersion.setEditable(false);</span>
<span class="line-added">+         javaLabel.setLabelFor(javaVersion);</span>
<span class="line-added">+ </span>
<span class="line-added">+         JLabel refreshTimeLabel = new JLabel(&quot;Refresh interval:&quot;);</span>
<span class="line-added">+         long minutes = refreshTime / 60;</span>
<span class="line-added">+         long seconds = refreshTime % 60;</span>
<span class="line-added">+         String interval = String.format(&quot;%1$d seconds%2$s&quot;,</span>
<span class="line-added">+                 refreshTime,</span>
<span class="line-added">+                 minutes &gt; 0</span>
<span class="line-added">+                     ? String.format(&quot; (%1$d %2$s%3$s)&quot;,</span>
<span class="line-added">+                         minutes,</span>
<span class="line-added">+                         minutes &gt; 1 ? &quot;minutes&quot; : &quot;minute&quot;,</span>
<span class="line-added">+                         seconds &gt; 0</span>
<span class="line-added">+                             ? String.format(&quot; %1$d %2$s&quot;,</span>
<span class="line-added">+                                 seconds,</span>
<span class="line-added">+                                 seconds &gt; 1 ? &quot;seconds&quot; : &quot;second&quot;)</span>
<span class="line-added">+                             : &quot;&quot;)</span>
<span class="line-added">+                     : &quot;&quot;</span>
<span class="line-added">+         );</span>
<span class="line-added">+         JTextField refreshInterval = new JTextField(interval);</span>
<span class="line-added">+         refreshInterval.setEditable(false);</span>
<span class="line-added">+         refreshTimeLabel.setLabelFor(refreshInterval);</span>
<span class="line-added">+ </span>
<span class="line-added">+         JLabel nextRefreshLabel = new JLabel(&quot;Next printer refresh in:&quot;);</span>
<span class="line-added">+         nextRefresh = new JTextField();</span>
<span class="line-added">+         nextRefresh.setEditable(false);</span>
<span class="line-added">+         nextRefreshLabel.setLabelFor(nextRefresh);</span>
<span class="line-added">+ </span>
<span class="line-added">+         JLabel timeoutLabel = new JLabel(&quot;Time left:&quot;);</span>
<span class="line-added">+         timeLeft = new JTextField();</span>
<span class="line-added">+         timeLeft.setEditable(false);</span>
<span class="line-added">+         timeoutLabel.setLabelFor(timeLeft);</span>
<span class="line-added">+ </span>
<span class="line-added">+         JPanel infoPanel = new JPanel();</span>
<span class="line-added">+         GroupLayout layout = new GroupLayout(infoPanel);</span>
<span class="line-added">+         infoPanel.setLayout(layout);</span>
<span class="line-added">+         infoPanel.setBorder(BorderFactory.createTitledBorder(&quot;Info&quot;));</span>
<span class="line-added">+         layout.setAutoCreateGaps(true);</span>
<span class="line-added">+         layout.setHorizontalGroup(</span>
<span class="line-added">+             layout.createSequentialGroup()</span>
<span class="line-added">+                 .addGroup(layout.createParallelGroup(GroupLayout.Alignment.LEADING)</span>
<span class="line-added">+                     .addComponent(javaLabel)</span>
<span class="line-added">+                     .addComponent(refreshTimeLabel)</span>
<span class="line-added">+                     .addComponent(nextRefreshLabel)</span>
<span class="line-added">+                     .addComponent(timeoutLabel)</span>
<span class="line-added">+                 )</span>
<span class="line-added">+                 .addGroup(layout.createParallelGroup(GroupLayout.Alignment.LEADING, true)</span>
<span class="line-added">+                     .addComponent(javaVersion)</span>
<span class="line-added">+                     .addComponent(refreshInterval)</span>
<span class="line-added">+                     .addComponent(nextRefresh)</span>
<span class="line-added">+                     .addComponent(timeLeft)</span>
<span class="line-added">+                 )</span>
<span class="line-added">+         );</span>
<span class="line-added">+         layout.setVerticalGroup(</span>
<span class="line-added">+             layout.createSequentialGroup()</span>
<span class="line-added">+                 .addGroup(layout.createParallelGroup(GroupLayout.Alignment.BASELINE)</span>
<span class="line-added">+                     .addComponent(javaLabel)</span>
<span class="line-added">+                     .addComponent(javaVersion)</span>
<span class="line-added">+                 )</span>
<span class="line-added">+                 .addGroup(layout.createParallelGroup(GroupLayout.Alignment.BASELINE)</span>
<span class="line-added">+                     .addComponent(refreshTimeLabel)</span>
<span class="line-added">+                     .addComponent(refreshInterval))</span>
<span class="line-added">+                 .addGroup(layout.createParallelGroup(GroupLayout.Alignment.BASELINE)</span>
<span class="line-added">+                     .addComponent(nextRefreshLabel)</span>
<span class="line-added">+                     .addComponent(nextRefresh))</span>
<span class="line-added">+                 .addGroup(layout.createParallelGroup(GroupLayout.Alignment.BASELINE)</span>
<span class="line-added">+                     .addComponent(timeoutLabel)</span>
<span class="line-added">+                     .addComponent(timeLeft))</span>
<span class="line-added">+         );</span>
<span class="line-added">+         return infoPanel;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     private JPanel createInstructionsPanel() {</span>
<span class="line-added">+         JPanel instructionsPanel = new JPanel(new BorderLayout());</span>
<span class="line-added">+         JTextArea instructionText = new JTextArea(INSTRUCTIONS_TEXT);</span>
<span class="line-added">+         instructionText.setEditable(false);</span>
<span class="line-added">+         instructionsPanel.setBorder(createTitledBorder(&quot;Test Instructions&quot;));</span>
<span class="line-added">+         instructionsPanel.add(new JScrollPane(instructionText));</span>
<span class="line-added">+         return  instructionsPanel;</span>
      }
  
<span class="line-modified">!     private JPanel createListPanel(final ServiceItemListModel model,</span>
<span class="line-modified">!                                    final String title,</span>
<span class="line-modified">!                                    final char mnemonic) {</span>
<span class="line-modified">!         JPanel panel = new JPanel();</span>
<span class="line-modified">!         panel.setLayout(new BoxLayout(panel, BoxLayout.Y_AXIS));</span>
<span class="line-modified">!         JList&lt;ServiceItem&gt; list = new JList&lt;&gt;(model);</span>
<span class="line-modified">!         list.setCellRenderer(new ServiceItemListRenderer());</span>
<span class="line-modified">! </span>
<span class="line-modified">!         JLabel label = new JLabel(title);</span>
<span class="line-modified">!         label.setLabelFor(list);</span>
<span class="line-modified">!         label.setDisplayedMnemonic(mnemonic);</span>
<span class="line-modified">!         JPanel labelPanel = new JPanel();</span>
<span class="line-modified">!         labelPanel.setLayout(new BoxLayout(labelPanel, BoxLayout.X_AXIS));</span>
<span class="line-modified">!         labelPanel.add(label, BorderLayout.EAST);</span>
<span class="line-modified">!         labelPanel.add(Box.createHorizontalGlue());</span>
<span class="line-modified">! </span>
<span class="line-modified">!         panel.add(labelPanel);</span>
<span class="line-modified">!         panel.add(new JScrollPane(list));</span>
<span class="line-modified">!         return panel;</span>
<span class="line-modified">!     }</span>
<span class="line-modified">! </span>
<span class="line-modified">!     private JPanel createButtonPanel() {</span>
<span class="line-modified">!         refreshButton = new JButton(&quot;Refresh&quot;);</span>
<span class="line-modified">!         refreshButton.addActionListener(this::refresh);</span>
<span class="line-modified">! </span>
          passButton = new JButton(&quot;Pass&quot;);
<span class="line-modified">!         passButton.addActionListener(this::pass);</span>
<span class="line-modified">!         passButton.setEnabled(false);</span>
  
          failButton = new JButton(&quot;Fail&quot;);
<span class="line-modified">!         failButton.addActionListener(this::fail);</span>
<span class="line-modified">!         failButton.setEnabled(false);</span>
<span class="line-modified">! </span>
<span class="line-modified">!         JPanel buttonPanel = new JPanel();</span>
<span class="line-modified">!         buttonPanel.setLayout(new BoxLayout(buttonPanel, BoxLayout.X_AXIS));</span>
<span class="line-modified">!         buttonPanel.add(Box.createHorizontalGlue());</span>
<span class="line-modified">!         buttonPanel.add(refreshButton);</span>
<span class="line-added">+         buttonPanel.add(passButton);</span>
<span class="line-added">+         buttonPanel.add(failButton);</span>
<span class="line-added">+         buttonPanel.add(Box.createHorizontalGlue());</span>
<span class="line-added">+         return buttonPanel;</span>
<span class="line-added">+     }</span>
  
<span class="line-modified">!     private static List&lt;ServiceItem&gt; collectPrinterList() {</span>
<span class="line-modified">!         PrintService[] printServices = PrintServiceLookup.lookupPrintServices(null, null);</span>
<span class="line-modified">!         List&lt;ServiceItem&gt; list = new ArrayList&lt;&gt;(printServices.length);</span>
<span class="line-added">+         for (PrintService service : printServices) {</span>
<span class="line-added">+             list.add(new ServiceItem(service.getName()));</span>
<span class="line-added">+         }</span>
<span class="line-added">+         return list;</span>
<span class="line-added">+     }</span>
  
<span class="line-modified">!     private static void logList(final String title, final List&lt;ServiceItem&gt; list) {</span>
<span class="line-modified">!         System.out.println(title);</span>
<span class="line-modified">!         for (ServiceItem item : list) {</span>
<span class="line-added">+             System.out.println(item.name);</span>
<span class="line-added">+         }</span>
<span class="line-added">+         System.out.println();</span>
<span class="line-added">+     }</span>
  
<span class="line-modified">!     private static void compareLists(final ServiceItemListModel before, final ServiceItemListModel after) {</span>
<span class="line-modified">!         boolean beforeUpdated = false;</span>
<span class="line-modified">!         boolean afterUpdated = false;</span>
<span class="line-added">+ </span>
<span class="line-added">+         for (ServiceItem item : before.list) {</span>
<span class="line-added">+             if (!after.list.contains(item)) {</span>
<span class="line-added">+                 item.state = ServiceItem.State.REMOVED;</span>
<span class="line-added">+                 beforeUpdated = true;</span>
<span class="line-added">+             } else if (item.state != ServiceItem.State.UNCHANGED) {</span>
<span class="line-added">+                 item.state = ServiceItem.State.UNCHANGED;</span>
<span class="line-added">+                 beforeUpdated = true;</span>
<span class="line-added">+             }</span>
<span class="line-added">+         }</span>
<span class="line-added">+ </span>
<span class="line-added">+         for (ServiceItem item : after.list) {</span>
<span class="line-added">+             if (!before.list.contains(item)) {</span>
<span class="line-added">+                 item.state = ServiceItem.State.ADDED;</span>
<span class="line-added">+                 afterUpdated = true;</span>
<span class="line-added">+             } else if (item.state != ServiceItem.State.UNCHANGED) {</span>
<span class="line-added">+                 item.state = ServiceItem.State.UNCHANGED;</span>
<span class="line-added">+                 afterUpdated = true;</span>
<span class="line-added">+             }</span>
<span class="line-added">+         }</span>
  
<span class="line-modified">!         if (beforeUpdated) {</span>
<span class="line-modified">!             before.fireChanged();</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         if (afterUpdated) {</span>
<span class="line-added">+             after.fireChanged();</span>
<span class="line-added">+         }</span>
<span class="line-added">+     }</span>
  
<span class="line-modified">!     @Override</span>
<span class="line-modified">!     public void windowClosing(WindowEvent e) {</span>
<span class="line-modified">!         System.out.println(&quot;The window closed&quot;);</span>
<span class="line-modified">!         disposeUI();</span>
<span class="line-added">+     }</span>
  
<span class="line-modified">!     private void disposeUI() {</span>
<span class="line-modified">!         timer.stop();</span>
<span class="line-modified">!         latch.countDown();</span>
<span class="line-added">+         frame.dispose();</span>
<span class="line-added">+     }</span>
  
<span class="line-modified">!     @SuppressWarnings(&quot;unused&quot;)</span>
<span class="line-modified">!     private void refresh(ActionEvent e) {</span>
<span class="line-modified">!         System.out.println(&quot;Refresh button pressed&quot;);</span>
<span class="line-added">+         afterList.refreshList(collectPrinterList());</span>
<span class="line-added">+         compareLists(beforeList, afterList);</span>
<span class="line-added">+         passButton.setEnabled(true);</span>
<span class="line-added">+         failButton.setEnabled(true);</span>
<span class="line-added">+         logList(&quot;After:&quot;, afterList.list);</span>
      }
  
<span class="line-modified">!     @SuppressWarnings(&quot;unused&quot;)</span>
<span class="line-modified">!     private void pass(ActionEvent e) {</span>
<span class="line-added">+         System.out.println(&quot;Pass button pressed&quot;);</span>
<span class="line-added">+         testResult = true;</span>
<span class="line-added">+         disposeUI();</span>
      }
<span class="line-added">+ </span>
<span class="line-added">+     @SuppressWarnings(&quot;unused&quot;)</span>
<span class="line-added">+     private void fail(ActionEvent e) {</span>
<span class="line-added">+         System.out.println(&quot;Fail button pressed&quot;);</span>
<span class="line-added">+         testResult = false;</span>
<span class="line-added">+         disposeUI();</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     @SuppressWarnings(&quot;unused&quot;)</span>
<span class="line-added">+     private void updateTimeLeft(ActionEvent e) {</span>
<span class="line-added">+         long elapsed = (System.currentTimeMillis() - startTime) / 1000;</span>
<span class="line-added">+         long left = TIMEOUT - elapsed;</span>
<span class="line-added">+         if (left &lt; 0) {</span>
<span class="line-added">+             testTimedOut = true;</span>
<span class="line-added">+             disposeUI();</span>
<span class="line-added">+         }</span>
<span class="line-added">+         timeLeft.setText(formatTime(left));</span>
<span class="line-added">+         nextRefresh.setText(formatTime(refreshTime - (elapsed % refreshTime)));</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     private static String formatTime(final long seconds) {</span>
<span class="line-added">+         long minutes = seconds / 60;</span>
<span class="line-added">+         return String.format(&quot;%d:%02d&quot;, minutes, seconds - minutes * 60);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
  }
</pre>
<center><a href="../PrinterJob/PrintToDir.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../../../io/DataOutputStream/WriteUTF.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>