<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/jdk/java/awt/Window/AlwaysOnTop/AutoTestOnTop.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="../../Toolkit/RealSync/Test.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../FullWindowContentTest/FullWindowContentTest.java.udiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/awt/Window/AlwaysOnTop/AutoTestOnTop.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2003, 2015, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2003, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -25,37 +25,59 @@</span>
    @test
    @key headful
    @bug 4632143
    @summary Unit test for the RFE window/frame/dialog always on top
    @author dom@sparc.spb.su: area=awt.toplevel
<span class="udiff-line-modified-removed">-   @modules java.desktop/sun.awt</span>
<span class="udiff-line-removed">-   @run main AutoTestOnTop</span>
<span class="udiff-line-modified-added">+   @run main/othervm/timeout=600 AutoTestOnTop</span>
  */
  
<span class="udiff-line-modified-removed">- import java.awt.*;</span>
<span class="udiff-line-modified-removed">- import java.awt.event.*;</span>
<span class="udiff-line-modified-removed">- import java.lang.reflect.*;</span>
<span class="udiff-line-modified-removed">- import javax.swing.*;</span>
<span class="udiff-line-modified-added">+ import java.awt.AWTEvent;</span>
<span class="udiff-line-modified-added">+ import java.awt.AWTException;</span>
<span class="udiff-line-modified-added">+ import java.awt.Component;</span>
<span class="udiff-line-modified-added">+ import java.awt.Dialog;</span>
<span class="udiff-line-added">+ import java.awt.EventQueue;</span>
<span class="udiff-line-added">+ import java.awt.Frame;</span>
<span class="udiff-line-added">+ import java.awt.IllegalComponentStateException;</span>
<span class="udiff-line-added">+ import java.awt.Point;</span>
<span class="udiff-line-added">+ import java.awt.Robot;</span>
<span class="udiff-line-added">+ import java.awt.Toolkit;</span>
<span class="udiff-line-added">+ import java.awt.Window;</span>
<span class="udiff-line-added">+ import java.awt.event.AWTEventListener;</span>
<span class="udiff-line-added">+ import java.awt.event.FocusEvent;</span>
<span class="udiff-line-added">+ import java.awt.event.InputEvent;</span>
<span class="udiff-line-added">+ import java.awt.event.MouseEvent;</span>
<span class="udiff-line-added">+ import java.awt.event.PaintEvent;</span>
<span class="udiff-line-added">+ import java.awt.event.WindowAdapter;</span>
<span class="udiff-line-added">+ import java.awt.event.WindowEvent;</span>
<span class="udiff-line-added">+ import java.lang.reflect.InvocationTargetException;</span>
<span class="udiff-line-added">+ import java.lang.reflect.Method;</span>
  import java.util.Vector;
  
<span class="udiff-line-added">+ import javax.swing.JDialog;</span>
<span class="udiff-line-added">+ import javax.swing.JFrame;</span>
<span class="udiff-line-added">+ import javax.swing.JWindow;</span>
<span class="udiff-line-added">+ </span>
  /**
   * @author tav@sparc.spb.su
   * @author dom@sparc.spb.su
   * Tests that always-on-top windows combine correctly with different kinds of window in different styles and conditions.
   *
   * !!! WARNING !!!
   * The test fails sometimes because the toFront() method doesn&#39;t guarantee
   * that after its invocation the frame will be placed above all other windows.
   */
  public class AutoTestOnTop {
<span class="udiff-line-added">+     private static final int X = 300;</span>
<span class="udiff-line-added">+     private static final int Y = 300;</span>
<span class="udiff-line-added">+ </span>
      static Window topw;
      static Frame  parentw = new Frame();
      static Window f;
      static Frame  parentf = new Frame();
  
<span class="udiff-line-modified-removed">-     static Object  uncheckedSrc = new Object(); // used when no need to check event source</span>
<span class="udiff-line-modified-removed">-     static Object  eventSrc = uncheckedSrc;</span>
<span class="udiff-line-modified-added">+     static final Object  uncheckedSrc = new Object(); // used when no need to check event source</span>
<span class="udiff-line-modified-added">+     static volatile Object  eventSrc = uncheckedSrc;</span>
      static boolean dispatchedCond;
  
      static Semaphore STATE_SEMA = new Semaphore();
      static Semaphore VIS_SEMA = new Semaphore();
      static Vector errors = new Vector();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -112,13 +134,15 @@</span>
                      if (e.getID() == MouseEvent.MOUSE_CLICKED) {
                          if (eventSrc != null &amp; eventSrc != uncheckedSrc &amp;&amp; e.getSource() != eventSrc) {
                              error(&quot;Test failed: stage #&quot; + stageNum + &quot;, action # &quot; + actNum + &quot;: &quot; + msgCase + &quot;: &quot; + msgAction + &quot;: &quot; + msgError);
                              testResult = -1;
                          }
<span class="udiff-line-modified-removed">-                         synchronized (eventSrc) {</span>
<span class="udiff-line-modified-removed">-                             dispatchedCond = true;</span>
<span class="udiff-line-modified-removed">-                             eventSrc.notify();</span>
<span class="udiff-line-modified-added">+                         if (eventSrc != null){</span>
<span class="udiff-line-modified-added">+                             synchronized (eventSrc) {</span>
<span class="udiff-line-modified-added">+                                 dispatchedCond = true;</span>
<span class="udiff-line-added">+                                 eventSrc.notify();</span>
<span class="udiff-line-added">+                             }</span>
                          }
                      }
  
                      if (doCheckEvents &amp;&amp; (e.getSource() == topw || e.getSource() == f)) {
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -156,16 +180,17 @@</span>
                  checksActionEvents[name.charAt(name.length() - 1) - &#39;0&#39;] = allMethods[i];
              }
          }
  
          f = new Frame(&quot;Auxiliary Frame&quot;);
<span class="udiff-line-modified-removed">-         f.setBounds(50, 0, 400, 50);</span>
<span class="udiff-line-modified-added">+         f.setBounds(X, Y, 650, 100);</span>
          f.setVisible(true);
          waitTillShown(f);
  
          try {
              robot = new Robot();
<span class="udiff-line-added">+             robot.setAutoDelay(100);</span>
          } catch (AWTException e) {
              throw new RuntimeException(&quot;Error: unable to create robot&quot;, e);
          }
  
          mainTest();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -263,21 +288,21 @@</span>
  
          ensureInitialWinPosition(topw);
  
          // Check that always-on-top window is topmost.
          // - Click on always-on-top window on the windows cross area.
<span class="udiff-line-modified-removed">-         clickOn(topw, f, 10, 30, &quot;setting &quot; + msgVisibility +</span>
<span class="udiff-line-modified-added">+         clickOn(topw, f, 10, 50, &quot;setting &quot; + msgVisibility +</span>
                  &quot; window (1) always-on-top didn&#39;t make it topmost&quot;);
  
          // Check that we can&#39;t change z-order of always-on-top window.
          // - a) Try to put the other window on the top.
          f.toFront();
<span class="udiff-line-modified-removed">-         clickOn(uncheckedSrc, f, 190, 30, &quot;&quot;); // coz toFront() works not always</span>
<span class="udiff-line-modified-added">+         clickOn(uncheckedSrc, f, 450, 50, &quot;&quot;); // coz toFront() works not always</span>
          pause(300);
  
          // - b) Click on always-on-top window on the windows cross area.
<span class="udiff-line-modified-removed">-         clickOn(topw, f, 10, 30, &quot;setting &quot; + msgVisibility +</span>
<span class="udiff-line-modified-added">+         clickOn(topw, f, 10, 50, &quot;setting &quot; + msgVisibility +</span>
                  &quot; window (1) always-on-top didn&#39;t make it such&quot;);
  
          // Ask for always-on-top property
          if (isAlwaysOnTop(topw) != true)
                  error(&quot;Test failed: stage #&quot; + stageNum + &quot;, action #&quot; + actNum + &quot;: &quot; + msgCase + &quot;: &quot; + msgAction +
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -290,22 +315,22 @@</span>
          ensureInitialWinPosition(topw);
  
          if (msgVisibility.equals(&quot;visible&quot;) &amp;&amp; actNum != 2) {
              // Check that the window remains topmost.
              // - click on the window on the windows cross area.
<span class="udiff-line-modified-removed">-             clickOn(topw, f, 10, 30, &quot;setting &quot; + msgVisibility +</span>
<span class="udiff-line-modified-added">+             clickOn(topw, f, 10, 50, &quot;setting &quot; + msgVisibility +</span>
                      &quot; window (1) not always-on-top didn&#39;t keep it topmost&quot;);
          }
  
          // Check that we can change z-order of not always-on-top window.
          // - a) try to put the other window on the top.
          f.toFront();
<span class="udiff-line-modified-removed">-         clickOn(uncheckedSrc, f, 190, 30, &quot;&quot;); // coz toFront() works not always</span>
<span class="udiff-line-modified-added">+         clickOn(uncheckedSrc, f, 450, 50, &quot;&quot;); // coz toFront() works not always</span>
          pause(300);
  
          // - b) click on not always-on-top window on the windows cross area.
<span class="udiff-line-modified-removed">-         clickOn(f, f, 10, 30, &quot;setting &quot; + msgVisibility +</span>
<span class="udiff-line-modified-added">+         clickOn(f, f, 10, 50, &quot;setting &quot; + msgVisibility +</span>
                  &quot; window (1) not always-on-top didn&#39;t make it such&quot;);
  
          // Ask for always-on-top property
          if (isAlwaysOnTop(topw) != false)
              error(&quot;Test failed: stage #&quot; + stageNum + &quot;, action #&quot; + actNum + &quot;: &quot; + msgCase + &quot;: &quot; + msgAction +
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -314,11 +339,11 @@</span>
      }
  
  
      private static void createWindow(int stageNum) {
          // Free native resourses
<span class="udiff-line-modified-removed">-         if (topw != null &amp;&amp; topw.isVisible()) {</span>
<span class="udiff-line-modified-added">+         if (topw != null) {</span>
              topw.dispose();
          }
  
          switch (stageNum) {
          case 0:
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -339,11 +364,11 @@</span>
              break;
          case 4:
              topw = new Frame(&quot;Top Frame&quot;);
              f.dispose();
              f = new Dialog(parentf, &quot;Auxiliary Dialog&quot;);
<span class="udiff-line-modified-removed">-             f.setBounds(50, 0, 250, 50);</span>
<span class="udiff-line-modified-added">+             f.setBounds(X, Y, 650, 100);</span>
              f.setVisible(true);
              waitTillShown(f);
              msgCase.replace(0, msgCase.length(), &quot;Frame (1) over Dialog (2)&quot;);
              break;
          case 5:
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -359,11 +384,11 @@</span>
                  public void windowStateChanged(WindowEvent e) {
                      System.err.println(&quot;* &quot; + e);
                      STATE_SEMA.raise();
                  }
              });
<span class="udiff-line-modified-removed">-         topw.setSize(200, 50);</span>
<span class="udiff-line-modified-added">+         topw.setSize(300, 100);</span>
      }
  
      /**
       * 0: setting always-on-top to invisible window
       * 1: setting always-on-top to visible window
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -434,11 +459,11 @@</span>
      public static void preAction_3() {
          setWindowVisible(&quot;after dragging&quot;,  &quot;visible&quot;);
      }
      public static void postAction_3() {
          Point p = topw.getLocationOnScreen();
<span class="udiff-line-modified-removed">-         int x = p.x + 40, y = p.y + 5;</span>
<span class="udiff-line-modified-added">+         int x = p.x + 150, y = p.y + 5;</span>
  
          try {                      // Take a pause to avoid double click
              Thread.sleep(500);     // when called one after another.
          } catch (InterruptedException ie) {
              ie.printStackTrace();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -447,11 +472,11 @@</span>
          }
  
          // Drag the window.
          robot.mouseMove(x, y);
          robot.mousePress(InputEvent.BUTTON1_MASK);
<span class="udiff-line-modified-removed">-         robot.mouseMove(200, 50);</span>
<span class="udiff-line-modified-added">+         robot.mouseMove(X + 150, Y + 100);</span>
          robot.mouseMove(x, y);
          robot.mouseRelease(InputEvent.BUTTON1_MASK);
      }
      public static boolean isActionAllowed_3() {
          return (stageNum &lt; 5);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -463,11 +488,11 @@</span>
      public static void preAction_4() {
          setWindowVisible(&quot;after dragging window (2)&quot;,  &quot;visible&quot;);
      }
      public static void postAction_4() {
          Point p = f.getLocationOnScreen();
<span class="udiff-line-modified-removed">-         int x = p.x + 150, y = p.y + 5;</span>
<span class="udiff-line-modified-added">+         int x = p.x + 400, y = p.y + 5;</span>
  
          try {                      // Take a pause to avoid double click
              Thread.sleep(500);     // when called one after another.
          } catch (InterruptedException ie) {
              ie.printStackTrace();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -476,11 +501,11 @@</span>
          }
  
          // Drag the window.
          robot.mouseMove(x, y);
          robot.mousePress(InputEvent.BUTTON1_MASK);
<span class="udiff-line-modified-removed">-         robot.mouseMove(200, 50);</span>
<span class="udiff-line-modified-added">+         robot.mouseMove(X + 400, Y + 100);</span>
          robot.mouseMove(x, y);
          robot.mouseRelease(InputEvent.BUTTON1_MASK);
  
          ensureInitialWinPosition(f);
      }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -597,11 +622,11 @@</span>
          msgAction.replace(0, msgAction.length(), mAction);
          msgVisibility.replace(0, msgVisibility.length(), mVisibility);
  
          topw.setVisible(true);
          pause(100); // Needs for Sawfish
<span class="udiff-line-modified-removed">-         topw.setLocation(0, 0);</span>
<span class="udiff-line-modified-added">+         topw.setLocation(X, Y);</span>
          waitTillShown(topw);
          f.toFront();
          pause(300);
      }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -638,11 +663,11 @@</span>
          }
      }
  
      private static void setAlwaysOnTop(Window w, boolean value) {
          System.err.println(&quot;Setting always on top on &quot; + w + &quot; to &quot; + value);
<span class="udiff-line-modified-removed">-         robot.mouseMove(0, 100); // Move out of the window</span>
<span class="udiff-line-modified-added">+         robot.mouseMove(X - 50, Y - 50); // Move out of the window</span>
          msgFunc.replace(0, msgCase.length(), &quot;setAlwaysOnTop()&quot;);
          try {
              w.setAlwaysOnTop(value);
          } catch (Exception e) {
              error(&quot;Test failed: stage#&quot; + stageNum + &quot;action #&quot; + actNum + &quot;: &quot; + msgCase + &quot;: &quot; + msgAction +
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -650,11 +675,11 @@</span>
                                 &quot; threw exeption &quot; + e);
          }
      }
  
      private static boolean isAlwaysOnTop(Window w) {
<span class="udiff-line-modified-removed">-         robot.mouseMove(0, 100); // Move out of the window</span>
<span class="udiff-line-modified-added">+         robot.mouseMove(X - 50, Y - 50); // Move out of the window</span>
          msgFunc.replace(0, msgCase.length(), &quot;isAlwaysOnTop()&quot;);
          boolean result = false;
          try {
              result = w.isAlwaysOnTop();
          } catch (Exception e) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -720,25 +745,26 @@</span>
          } catch (InterruptedException ie) {
              System.err.println(&quot;Wait interrupted: &quot; + ie);
          }
          boolean state = STATE_SEMA.getState();
          STATE_SEMA.reset();
<span class="udiff-line-added">+         robot.delay(1000); // animation normal &lt;--&gt; maximized states</span>
          return state;
      }
  
      private static void ensureInitialWinPosition(Window w) {
          int counter = 30;
<span class="udiff-line-modified-removed">-         while (w.getLocationOnScreen().y != 0 &amp;&amp; --counter &gt; 0) {</span>
<span class="udiff-line-modified-added">+         while (w.getLocationOnScreen().y != Y &amp;&amp; --counter &gt; 0) {</span>
              try {
                  Thread.sleep(100);
              } catch (InterruptedException e) {
                  e.printStackTrace();
                  break;
              }
          }
          if (counter &lt;= 0) {
<span class="udiff-line-modified-removed">-             w.setLocation(0, 0);</span>
<span class="udiff-line-modified-added">+             w.setLocation(X, Y);</span>
              pause(100);
              System.err.println(&quot;Test: window set to initial position forcedly&quot;);
          }
      }
  
</pre>
<center><a href="../../Toolkit/RealSync/Test.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../FullWindowContentTest/FullWindowContentTest.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>