<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New test/jdk/java/awt/dnd/RightMouseButtonDragTest/RightMouseButtonDragTest.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2001, 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @key headful
 27  * @bug 4494085 8079258 8234802
 28  * @summary Verifies that the right mouse button drag gesture is recognized
 29  *          on Win32 and Mac OS X
 30  * @run main RightMouseButtonDragTest
 31  */
 32 
 33 import java.awt.*;
 34 import java.awt.datatransfer.*;
 35 import java.awt.dnd.*;
 36 import java.awt.event.*;
 37 import java.io.*;
 38 import javax.swing.*;
 39 
 40 public class RightMouseButtonDragTest implements AWTEventListener {
 41 
 42     private static Frame frame;
 43     boolean dragRecognized = false;
 44 
 45     final DragSource dragSource = DragSource.getDefaultDragSource();
 46     final Transferable transferable = new StringSelection(&quot;TEXT&quot;);
 47     final DragGestureListener dragGestureListener = new DragGestureListener() {
 48             public void dragGestureRecognized(DragGestureEvent dge) {
 49                 dragRecognized = true;
 50             }
 51         };
 52 
 53     static final Object SYNC_LOCK = new Object();
 54     static final int FRAME_ACTIVATION_TIMEOUT = 2000;
 55     static final int DROP_COMPLETION_TIMEOUT = 5000;
 56     static final int MOUSE_RELEASE_TIMEOUT = 1000;
 57 
 58     final String os = System.getProperty(&quot;os.name&quot;);
 59     final boolean isWin = os.startsWith(&quot;Win&quot;);
 60     final boolean isMac = os.startsWith(&quot;Mac&quot;);
 61 
 62     Component clickedComponent = null;
 63 
 64     public static void main(String[] args) throws Exception {
 65         try {
 66             RightMouseButtonDragTest app = new RightMouseButtonDragTest();
 67             SwingUtilities.invokeAndWait(() -&gt; app.init());
 68             app.start();
 69         } finally {
 70             if(frame != null) SwingUtilities.invokeAndWait(() -&gt; frame.dispose());
 71         }
 72     }
 73 
 74     public void init() {
 75         //Create instructions for the user here, as well as set up
 76         // the environment -- set the layout manager, add buttons,
 77         // etc.
 78         frame = new JFrame();
 79         frame.setTitle(&quot;Test frame&quot;);
 80         frame.setBounds(100, 100, 200, 200);
 81         dragSource.createDefaultDragGestureRecognizer(frame, DnDConstants.ACTION_COPY_OR_MOVE,
 82                                                       dragGestureListener);
 83 
 84 
 85         frame.getToolkit().addAWTEventListener(this, AWTEvent.MOUSE_EVENT_MASK);
 86         frame.setVisible(true);
 87 
 88     }
 89 
 90     public static int sign(int n) {
 91         return n &lt; 0 ? -1 : n == 0 ? 0 : 1;
 92     }
 93 
 94     public void start() {
 95         try {
 96             final Robot robot = new Robot();
 97             robot.waitForIdle();
 98 
 99             Thread.sleep(FRAME_ACTIVATION_TIMEOUT);
100 
101             final Point srcPoint = frame.getLocationOnScreen();
102             Dimension d = frame.getSize();
103             srcPoint.translate(d.width / 2, d.height / 2);
104 
105             if (!pointInComponent(robot, srcPoint, frame)) {
106                 System.err.println(&quot;WARNING: Couldn&#39;t locate source frame.&quot;);
107                 return;
108             }
109 
110             final Point dstPoint = new Point(srcPoint);
111             dstPoint.translate(d.width / 4, d.height / 4);
112 
113             if (!pointInComponent(robot, dstPoint, frame)) {
114                 System.err.println(&quot;WARNING: Couldn&#39;t locate target frame.&quot;);
115                 return;
116             }
117 
118             robot.mouseMove(srcPoint.x, srcPoint.y);
119             robot.keyPress(KeyEvent.VK_CONTROL);
120             robot.mousePress(InputEvent.BUTTON3_MASK);
121             for (;!srcPoint.equals(dstPoint);
122                  srcPoint.translate(sign(dstPoint.x - srcPoint.x),
123                                     sign(dstPoint.y - srcPoint.y))) {
124                 robot.mouseMove(srcPoint.x, srcPoint.y);
125                 Thread.sleep(50);
126             }
127 
128             robot.mouseRelease(InputEvent.BUTTON3_MASK);
129             robot.keyRelease(KeyEvent.VK_CONTROL);
130 
131         } catch (Exception e) {
132             e.printStackTrace();
133             throw new RuntimeException(&quot;The test failed.&quot;);
134         }
135 
136         if ( (isWin || isMac) &amp;&amp; !dragRecognized) {
137             throw new RuntimeException(&quot;Drag is not recognized on: &quot; + os);
138         } else if (!isWin &amp;&amp; !isMac &amp;&amp; dragRecognized) {
139             throw new RuntimeException(&quot;Drag is recognized on: &quot; + os);
140         }
141     }
142 
143     public void reset() {
144         clickedComponent = null;
145     }
146 
147     public void eventDispatched(AWTEvent e) {
148         if (e.getID() == MouseEvent.MOUSE_RELEASED) {
149             clickedComponent = (Component)e.getSource();
150             synchronized (SYNC_LOCK) {
151                 SYNC_LOCK.notifyAll();
152             }
153         }
154     }
155 
156     boolean pointInComponent(Robot robot, Point p, Component comp)
157       throws InterruptedException {
158         robot.waitForIdle();
159         reset();
160         robot.mouseMove(p.x, p.y);
161         robot.mousePress(InputEvent.BUTTON1_MASK);
162         synchronized (SYNC_LOCK) {
163             robot.mouseRelease(InputEvent.BUTTON1_MASK);
164             SYNC_LOCK.wait(MOUSE_RELEASE_TIMEOUT);
165         }
166 
167         Component c = clickedComponent;
168 
169         while (c != null &amp;&amp; c != comp) {
170             c = c.getParent();
171         }
172 
173         return c == comp;
174     }
175 }
    </pre>
  </body>
</html>