<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old test/jdk/java/awt/SplashScreen/MultiResolutionSplash/MultiResolutionSplashTest.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2014, 2018, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 import java.awt.Color;
 25 import java.awt.Dialog;
 26 import java.awt.Frame;
 27 import java.awt.Graphics;
 28 import java.awt.Graphics2D;
 29 import java.awt.GraphicsEnvironment;
 30 import java.awt.Panel;
 31 import java.awt.Rectangle;
 32 import java.awt.Robot;
 33 import java.awt.SplashScreen;
 34 import java.awt.TextField;
 35 import java.awt.Window;
 36 import java.awt.event.KeyEvent;
 37 import java.awt.image.BufferedImage;
 38 import java.io.File;
 39 import javax.imageio.ImageIO;
 40 import sun.java2d.SunGraphics2D;
 41 
 42 
 43 /**
 44  * @test
 45  * @key headful
 46  * @bug 8043869 8075244 8078082 8145173 8151787 8212213
 47  * @summary Tests the HiDPI splash screen support for windows and MAC
 48  * @modules java.desktop/sun.java2d
 49  * @run main MultiResolutionSplashTest GENERATE_IMAGES
 50  * @run main/othervm -splash:splash1.png MultiResolutionSplashTest TEST_SPLASH 0
 51  * @run main/othervm -splash:splash2 MultiResolutionSplashTest TEST_SPLASH 1
 52  * @run main/othervm -splash:splash3. MultiResolutionSplashTest TEST_SPLASH 2
 53  * @run main/othervm -splash:splash1.png MultiResolutionSplashTest TEST_FOCUS
 54  */
 55 public class MultiResolutionSplashTest {
 56 
 57     private static final int IMAGE_WIDTH = 300;
 58     private static final int IMAGE_HEIGHT = 200;
 59     private static boolean isMac;
 60 
 61     static {
 62         isMac = System.getProperty(&quot;os.name&quot;).contains(&quot;OS X&quot;);
 63     }
 64     private static final ImageInfo[] tests = {
 65         new ImageInfo(&quot;splash1.png&quot;, &quot;splash1@2x.png&quot;, Color.BLUE, Color.GREEN),
 66         new ImageInfo(&quot;splash2&quot;, &quot;splash2@2x&quot;, Color.WHITE, Color.BLACK),
 67         new ImageInfo(&quot;splash3.&quot;, &quot;splash3@2x.&quot;, Color.YELLOW, Color.RED)
 68     };
 69 
 70     public static void main(String[] args) throws Exception {
 71 
 72         String test = args[0];
 73         switch (test) {
 74             case &quot;GENERATE_IMAGES&quot;:
 75                 generateImages();
 76                 break;
 77             case &quot;TEST_SPLASH&quot;:
 78                 int index = Integer.parseInt(args[1]);
 79                 testSplash(tests[index]);
 80                 break;
 81             case &quot;TEST_FOCUS&quot;:
 82                 testFocus();
 83                 break;
 84             default:
 85                 throw new RuntimeException(&quot;Unknown test: &quot; + test);
 86         }
 87     }
 88 
 89     static void testSplash(ImageInfo test) throws Exception {
 90         SplashScreen splashScreen = SplashScreen.getSplashScreen();
 91 
 92         if (splashScreen == null) {
 93             throw new RuntimeException(&quot;Splash screen is not shown!&quot;);
 94         }
 95 
 96         Graphics2D g = splashScreen.createGraphics();
 97         Rectangle splashBounds = splashScreen.getBounds();
 98         int screenX = (int) splashBounds.getCenterX();
 99         int screenY = (int) splashBounds.getCenterY();
100         if (splashBounds.width != IMAGE_WIDTH) {
101             throw new RuntimeException(
102                     &quot;SplashScreen#getBounds has wrong width&quot;);
103         }
104         if (splashBounds.height != IMAGE_HEIGHT) {
105             throw new RuntimeException(
106                     &quot;SplashScreen#getBounds has wrong height&quot;);
107         }
108 
109         Robot robot = new Robot();
110         Color splashScreenColor = robot.getPixelColor(screenX, screenY);
111         float scaleFactor = getScaleFactor();
112         Color testColor = (1 &lt; scaleFactor) ? test.color2x : test.color1x;
113 
114         if (!compare(testColor, splashScreenColor)) {
115             throw new RuntimeException(
116                     &quot;Image with wrong resolution is used for splash screen!&quot;);
117         }
118     }
119 
120     static void testFocus() throws Exception {
121 
122         Robot robot = new Robot();
123         robot.setAutoDelay(50);
124 
125         Frame frame = new Frame();
126         frame.setSize(100, 100);
127         String test = &quot;123&quot;;
128         TextField textField = new TextField(test);
129         textField.selectAll();
130         frame.add(textField);
131         frame.setVisible(true);
132         robot.waitForIdle();
133 
134         robot.keyPress(KeyEvent.VK_A);
135         robot.keyRelease(KeyEvent.VK_A);
136         robot.keyPress(KeyEvent.VK_B);
137         robot.keyRelease(KeyEvent.VK_B);
138         robot.waitForIdle();
139 
140         frame.dispose();
141 
142         if (!textField.getText().equals(&quot;ab&quot;)) {
143             throw new RuntimeException(&quot;Focus is lost!&quot;);
144         }
145     }
146 
147     static boolean compare(Color c1, Color c2) {
148         return compare(c1.getRed(), c2.getRed())
149                 &amp;&amp; compare(c1.getGreen(), c2.getGreen())
150                 &amp;&amp; compare(c1.getBlue(), c2.getBlue());
151     }
152 
153     static boolean compare(int n, int m) {
154         return Math.abs(n - m) &lt;= 50;
155     }
156 
157     static float getScaleFactor() {
158 
159         final Dialog dialog = new Dialog((Window) null);
160         dialog.setSize(100, 100);
161         dialog.setModal(true);
162         final float[] scaleFactors = new float[1];
163         Panel panel = new Panel() {
164 
165             @Override
166             public void paint(Graphics g) {
167                 float scaleFactor = 1;
168                 if (g instanceof SunGraphics2D) {
169                     scaleFactor = getScreenScaleFactor();
170                 }
171                 scaleFactors[0] = scaleFactor;
172                 dialog.setVisible(false);
173             }
174         };
175 
176         dialog.add(panel);
177         dialog.setVisible(true);
178         dialog.dispose();
179 
180         return scaleFactors[0];
181     }
182 
183     static void generateImages() throws Exception {
184         for (ImageInfo test : tests) {
185             generateImage(test.name1x, test.color1x, 1);
186             generateImage(test.name2x, test.color2x, getScreenScaleFactor());
187         }
188     }
189 
190     static void generateImage(String name, Color color, float scale) throws Exception {
191         File file = new File(name);
192         if (file.exists()) {
193             return;
194         }
195         BufferedImage image = new BufferedImage((int) (scale * IMAGE_WIDTH),
196                 (int) (scale * IMAGE_HEIGHT), BufferedImage.TYPE_INT_RGB);
197         Graphics g = image.getGraphics();
198         g.setColor(color);
199         g.fillRect(0, 0, (int) (scale * IMAGE_WIDTH), (int) (scale * IMAGE_HEIGHT));
200         ImageIO.write(image, &quot;png&quot;, file);
201     }
202 
203     static float getScreenScaleFactor() {
204         return (float) GraphicsEnvironment.
205                 getLocalGraphicsEnvironment().
206                 getDefaultScreenDevice().getDefaultConfiguration().
207                 getDefaultTransform().getScaleX();
208     }
209 
210     static class ImageInfo {
211 
212         final String name1x;
213         final String name2x;
214         final Color color1x;
215         final Color color2x;
216 
217         public ImageInfo(String name1x, String name2x, Color color1x, Color color2x) {
218             this.name1x = name1x;
219             if (!isMac) {
220                 float scale = getScreenScaleFactor();
221                 StringBuffer buff = new StringBuffer();
222                 if (scale - (int) scale &gt; 0) {
223                     buff.append(&quot;@&quot;).append((int) (scale * 100)).append(&quot;pct&quot;);
224                 } else {
225                     buff.append(&quot;@&quot;).append((int) scale).append(&quot;x&quot;);
226                 }
227                 StringBuffer buffer = new StringBuffer();
228                 String[] splitStr = name1x.split(&quot;\\.&quot;);
229                 if (splitStr.length == 2) {
230                     this.name2x = buffer.append(splitStr[0]).append(buff)
231                             .append(&quot;.&quot;).append(splitStr[1]).toString();
232                 } else {
233                     if (name1x.indexOf(&quot;.&quot;) &gt; 0) {
234                         this.name2x = buffer.append(splitStr[0]).append(buff).append(&quot;.&quot;).toString();
235                     } else {
236                         this.name2x = buffer.append(splitStr[0]).append(buff).toString();
237                     }
238                 }
239             } else {
240                 this.name2x = name2x;
241             }
242             this.color1x = color1x;
243             this.color2x = color2x;
244         }
245     }
246 }
247 
    </pre>
  </body>
</html>