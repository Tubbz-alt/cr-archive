<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/com/sun/nio/sctp/SctpMultiChannel/SendFailed.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="Send.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="SocketOptionTests.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/com/sun/nio/sctp/SctpMultiChannel/SendFailed.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /* @test
 25  * @bug 8067846
 26  * @summary Test for send failed notification
 27  */
 28 
 29 import com.sun.nio.sctp.*;
 30 import java.io.IOException;

 31 import java.net.InetSocketAddress;
 32 import java.net.SocketAddress;
 33 import java.nio.ByteBuffer;
 34 import static java.lang.System.out;
 35 import static java.nio.ByteBuffer.*;
 36 
 37 public class SendFailed {
 38 
 39     static final SocketAddress remoteAddress = new InetSocketAddress(InetAddress.getLoopbackAddress(), 3000);
 40 
 41     static final int[] bufferSizes =
 42             { 20, 49, 50, 51, 100, 101, 1024, 1025, 4095, 4096, 4097, 8191, 8192, 8193};
 43 
 44     void test(String[] args) throws IOException {
 45         SocketAddress address = null;
 46         String os = System.getProperty(&quot;os.name&quot;).toLowerCase();
 47 
 48         if (!Util.isSCTPSupported()) {
 49             out.println(&quot;SCTP protocol is not supported&quot;);
 50             out.println(&quot;Test cannot be run&quot;);
</pre>
<hr />
<pre>
 80     }
 81 
 82     void doTest(int sendBufferSize, int recvBufferSize, boolean direct, int offset)
 83         throws IOException
 84     {
 85         debug(&quot;%n--- Testing with send size:[%d], recv size:[%d], offset:[%d] &quot;
 86                 + &quot;, direct [%s]. &quot;, sendBufferSize, recvBufferSize, offset, direct);
 87 
 88         try (SctpMultiChannel channel = SctpMultiChannel.open()) {
 89             MessageInfo messageInfo = MessageInfo.createOutgoing(remoteAddress, 0);
 90             ByteBuffer sendBuffer = filledBuffer(sendBufferSize, direct);
 91 
 92             debug(&quot;%nAttempting to send to %s. &quot;, remoteAddress);
 93             int sent = channel.send(sendBuffer, messageInfo);
 94             sendBuffer.flip();
 95 
 96             SendFailedNotificationHandler handler =
 97                     new SendFailedNotificationHandler();
 98             ByteBuffer recvBuffer = direct ? allocateDirect(recvBufferSize)
 99                                            : allocate((recvBufferSize));
<span class="line-modified">100             channel.receive(recvBuffer, null, handler);</span>
<span class="line-modified">101 </span>
<span class="line-modified">102             // verify sent buffer received by send failed notification</span>
<span class="line-modified">103             ByteBuffer buffer = handler.getSendFailedByteBuffer();</span>
<span class="line-modified">104             check(buffer.remaining() == sent);</span>
<span class="line-modified">105             check(buffer.position() == 0);</span>
<span class="line-modified">106             check(buffer.limit() == sent);</span>
<span class="line-modified">107             assertSameContent(sendBuffer, handler.getSendFailedByteBuffer());</span>





108         }
109     }
110 
111     class SendFailedNotificationHandler extends AbstractNotificationHandler&lt;Object&gt;
112     {
113         /** Reference to the buffer captured in send failed notification */
114         private ByteBuffer sentBuffer;

115 
116         @Override
117         public HandlerResult handleNotification(
118                 Notification notification, Object attachment) {
119             fail(&quot;Unknown notification type&quot;);
120             return HandlerResult.CONTINUE;
121         }
122 
123         @Override
124         public HandlerResult handleNotification(
125                 AssociationChangeNotification notification, Object attachment) {
126             AssociationChangeNotification.AssocChangeEvent event = notification.event();
127             debug(&quot;%nAssociationChangeNotification&quot;);
128             debug(&quot;%n  Association: %s. &quot;, notification.association());
129             debug(&quot;%n  Event: %s. &quot;, event);
130             return HandlerResult.CONTINUE;
131         }
132 
133         @Override
134         public HandlerResult handleNotification(
135                 SendFailedNotification notification, Object attachment) {
136             debug(&quot;%nSendFailedNotification: %s. &quot;, notification);

137             sentBuffer = notification.buffer();
138             return HandlerResult.RETURN;
139         }
140 
141         public ByteBuffer getSendFailedByteBuffer() {
142             return sentBuffer;
143         }
144 
145         @Override
146         public HandlerResult handleNotification(
147                 PeerAddressChangeNotification pacn, Object attachment)
148         {
149             debug(&quot;%nPeerAddressChangeNotification: %s&quot;, pacn);
150             return HandlerResult.CONTINUE;
151         }
152 
153         @Override
154         public HandlerResult handleNotification(
155                 ShutdownNotification notification, Object attachment) {
156             debug(&quot;%nShutdownNotification&quot;);
</pre>
</td>
<td>
<hr />
<pre>
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /* @test
 25  * @bug 8067846
 26  * @summary Test for send failed notification
 27  */
 28 
 29 import com.sun.nio.sctp.*;
 30 import java.io.IOException;
<span class="line-added"> 31 import java.net.InetAddress;</span>
 32 import java.net.InetSocketAddress;
 33 import java.net.SocketAddress;
 34 import java.nio.ByteBuffer;
 35 import static java.lang.System.out;
 36 import static java.nio.ByteBuffer.*;
 37 
 38 public class SendFailed {
 39 
 40     static final SocketAddress remoteAddress = new InetSocketAddress(InetAddress.getLoopbackAddress(), 3000);
 41 
 42     static final int[] bufferSizes =
 43             { 20, 49, 50, 51, 100, 101, 1024, 1025, 4095, 4096, 4097, 8191, 8192, 8193};
 44 
 45     void test(String[] args) throws IOException {
 46         SocketAddress address = null;
 47         String os = System.getProperty(&quot;os.name&quot;).toLowerCase();
 48 
 49         if (!Util.isSCTPSupported()) {
 50             out.println(&quot;SCTP protocol is not supported&quot;);
 51             out.println(&quot;Test cannot be run&quot;);
</pre>
<hr />
<pre>
 81     }
 82 
 83     void doTest(int sendBufferSize, int recvBufferSize, boolean direct, int offset)
 84         throws IOException
 85     {
 86         debug(&quot;%n--- Testing with send size:[%d], recv size:[%d], offset:[%d] &quot;
 87                 + &quot;, direct [%s]. &quot;, sendBufferSize, recvBufferSize, offset, direct);
 88 
 89         try (SctpMultiChannel channel = SctpMultiChannel.open()) {
 90             MessageInfo messageInfo = MessageInfo.createOutgoing(remoteAddress, 0);
 91             ByteBuffer sendBuffer = filledBuffer(sendBufferSize, direct);
 92 
 93             debug(&quot;%nAttempting to send to %s. &quot;, remoteAddress);
 94             int sent = channel.send(sendBuffer, messageInfo);
 95             sendBuffer.flip();
 96 
 97             SendFailedNotificationHandler handler =
 98                     new SendFailedNotificationHandler();
 99             ByteBuffer recvBuffer = direct ? allocateDirect(recvBufferSize)
100                                            : allocate((recvBufferSize));
<span class="line-modified">101             MessageInfo info = channel.receive(recvBuffer, null, handler);</span>
<span class="line-modified">102             debug(&quot;receive returned info:&quot; + info);</span>
<span class="line-modified">103 </span>
<span class="line-modified">104             if (handler.receivedSendFailed) {</span>
<span class="line-modified">105                 // verify sent buffer received by send failed notification</span>
<span class="line-modified">106                 ByteBuffer buffer = handler.getSendFailedByteBuffer();</span>
<span class="line-modified">107                 check(buffer.remaining() == sent);</span>
<span class="line-modified">108                 check(buffer.position() == 0);</span>
<span class="line-added">109                 check(buffer.limit() == sent);</span>
<span class="line-added">110                 assertSameContent(sendBuffer, handler.getSendFailedByteBuffer());</span>
<span class="line-added">111             } else {</span>
<span class="line-added">112                 debug(&quot;Unexpected event or received data. Check output.&quot;);</span>
<span class="line-added">113             }</span>
114         }
115     }
116 
117     class SendFailedNotificationHandler extends AbstractNotificationHandler&lt;Object&gt;
118     {
119         /** Reference to the buffer captured in send failed notification */
120         private ByteBuffer sentBuffer;
<span class="line-added">121         boolean receivedSendFailed;</span>
122 
123         @Override
124         public HandlerResult handleNotification(
125                 Notification notification, Object attachment) {
126             fail(&quot;Unknown notification type&quot;);
127             return HandlerResult.CONTINUE;
128         }
129 
130         @Override
131         public HandlerResult handleNotification(
132                 AssociationChangeNotification notification, Object attachment) {
133             AssociationChangeNotification.AssocChangeEvent event = notification.event();
134             debug(&quot;%nAssociationChangeNotification&quot;);
135             debug(&quot;%n  Association: %s. &quot;, notification.association());
136             debug(&quot;%n  Event: %s. &quot;, event);
137             return HandlerResult.CONTINUE;
138         }
139 
140         @Override
141         public HandlerResult handleNotification(
142                 SendFailedNotification notification, Object attachment) {
143             debug(&quot;%nSendFailedNotification: %s. &quot;, notification);
<span class="line-added">144             receivedSendFailed = true;</span>
145             sentBuffer = notification.buffer();
146             return HandlerResult.RETURN;
147         }
148 
149         public ByteBuffer getSendFailedByteBuffer() {
150             return sentBuffer;
151         }
152 
153         @Override
154         public HandlerResult handleNotification(
155                 PeerAddressChangeNotification pacn, Object attachment)
156         {
157             debug(&quot;%nPeerAddressChangeNotification: %s&quot;, pacn);
158             return HandlerResult.CONTINUE;
159         }
160 
161         @Override
162         public HandlerResult handleNotification(
163                 ShutdownNotification notification, Object attachment) {
164             debug(&quot;%nShutdownNotification&quot;);
</pre>
</td>
</tr>
</table>
<center><a href="Send.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="SocketOptionTests.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>