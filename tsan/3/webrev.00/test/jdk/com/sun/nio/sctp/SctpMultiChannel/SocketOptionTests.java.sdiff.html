<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/com/sun/nio/sctp/SctpMultiChannel/SocketOptionTests.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="SendFailed.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../../../../../demo/jfc/J2Ddemo/J2DdemoTest.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/com/sun/nio/sctp/SctpMultiChannel/SocketOptionTests.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
137                fail(&quot;NullPointerException not thrown for getOption&quot;);
138             } catch (NullPointerException unused) {
139                pass();
140             }
141 
142             /* ClosedChannelException */
143             smc.close();
144             try {
145                smc.setOption(SCTP_INIT_MAXSTREAMS, streams, null);
146                fail(&quot;ClosedChannelException not thrown&quot;);
147             } catch (ClosedChannelException unused) {
148                 pass();
149             }
150         } catch (IOException ioe) {
151             unexpected(ioe);
152         }
153     }
154 
155     /* SCTP_PRIMARY_ADDR */
156     void sctpPrimaryAddr() throws IOException {
<span class="line-removed">157         SocketAddress addrToSet = null;</span>
158         ByteBuffer buffer = ByteBuffer.allocate(Util.SMALL_BUFFER);
159 
160         System.out.println(&quot;TESTING SCTP_PRIMARY_ADDR&quot;);
161 
162         /* create listening channel */
163         SctpServerChannel ssc = SctpServerChannel.open().bind(null);
164         Set&lt;SocketAddress&gt; addrs = ssc.getAllLocalAddresses();
165         if (addrs.isEmpty())
166             debug(&quot;addrs should not be empty&quot;);
167 
168         InetSocketAddress serverAddr = (InetSocketAddress) addrs.iterator().next();
169 
170         /* setup an association implicitly by sending a small message */
171         int streamNumber = 0;
172         debug(&quot;sending to &quot; + serverAddr + &quot; on stream number: &quot; + streamNumber);
173         MessageInfo info = MessageInfo.createOutgoing(serverAddr, streamNumber);
174         buffer.put(Util.SMALL_MESSAGE.getBytes(&quot;ISO-8859-1&quot;));
175         buffer.flip();
176 
177         debug(&quot;sending small message: &quot; + buffer);
178         SctpMultiChannel smc = SctpMultiChannel.open();
179         int sent = smc.send(buffer, info);
180 
181         /* Receive the COMM_UP */
182         buffer.clear();
183         SOTNotificationHandler handler = new SOTNotificationHandler();
184         info = smc.receive(buffer, null, handler);
185         check(handler.receivedCommUp(), &quot;COMM_UP no received&quot;);
186         Set&lt;Association&gt; associations = smc.associations();
187         check(!associations.isEmpty(),&quot;There should be some associations&quot;);
188         Association assoc = associations.iterator().next();
189 
190         SctpChannel peerChannel = ssc.accept();
191         ssc.close();
<span class="line-modified">192         Set&lt;SocketAddress&gt; peerAddrs = peerChannel.getAllLocalAddresses();</span>
<span class="line-modified">193         debug(&quot;Peer local Addresses: &quot;);</span>
<span class="line-modified">194         for (Iterator&lt;SocketAddress&gt; it = peerAddrs.iterator(); it.hasNext(); ) {</span>
195             InetSocketAddress addr = (InetSocketAddress)it.next();
196             debug(&quot;\t&quot; + addr);
<span class="line-removed">197             addrToSet = addr;   // any of the peer addresses will do!</span>
198         }
199 
200         /* retrieval of SCTP_PRIMARY_ADDR is not supported on Solaris */
201         if (&quot;SunOS&quot;.equals(osName)) {
202             /* For now do not set this option. There is a bug on Solaris 10 pre Update 5
203              * where setting this option returns Invalid argument */
204             //debug(&quot;Set SCTP_PRIMARY_ADDR with &quot; + addrToSet);
205             //smc.setOption(SCTP_PRIMARY_ADDR, addrToSet, assoc);
206             return;
207         } else { /* Linux */
208             SocketAddress primaryAddr = smc.getOption(SCTP_PRIMARY_ADDR, assoc);
209             System.out.println(&quot;SCTP_PRIMARY_ADDR returned: &quot; + primaryAddr);
<span class="line-modified">210             /* Verify that this is one of the peer addresses */</span>
<span class="line-modified">211             boolean found = false;</span>
<span class="line-modified">212             addrToSet = primaryAddr; // may not have more than one addr</span>
<span class="line-modified">213             for (Iterator&lt;SocketAddress&gt; it = peerAddrs.iterator(); it.hasNext(); ) {</span>
<span class="line-modified">214                 InetSocketAddress addr = (InetSocketAddress)it.next();</span>
<span class="line-modified">215                 if (addr.equals(primaryAddr)) {</span>
<span class="line-modified">216                     found = true;</span>
<span class="line-modified">217                 }</span>
<span class="line-modified">218                 addrToSet = addr;</span>


219             }
<span class="line-removed">220             check(found, &quot;SCTP_PRIMARY_ADDR returned bogus address!&quot;);</span>
<span class="line-removed">221 </span>
<span class="line-removed">222             System.out.println(&quot;Try SCTP_PRIMARY_ADDR set to: &quot; + addrToSet);</span>
<span class="line-removed">223             smc.setOption(SCTP_PRIMARY_ADDR, addrToSet, assoc);</span>
<span class="line-removed">224             System.out.println(&quot;SCTP_PRIMARY_ADDR set to: &quot; + addrToSet);</span>
<span class="line-removed">225             primaryAddr = smc.getOption(SCTP_PRIMARY_ADDR, assoc);</span>
<span class="line-removed">226             System.out.println(&quot;SCTP_PRIMARY_ADDR returned: &quot; + primaryAddr);</span>
<span class="line-removed">227             check(addrToSet.equals(primaryAddr),&quot;SCTP_PRIMARY_ADDR not set correctly&quot;);</span>
228         }


229     }
230 
231     class SOTNotificationHandler extends AbstractNotificationHandler&lt;Object&gt;
232     {
233         boolean receivedCommUp;  // false
234 
235         boolean receivedCommUp() {
236             return receivedCommUp;
237         }
238 
239         @Override
240         public HandlerResult handleNotification(
241                 AssociationChangeNotification notification, Object attachment) {
242             AssocChangeEvent event = notification.event();
243             debug(&quot;AssociationChangeNotification&quot;);
244             debug(&quot;  Association: &quot; + notification.association());
245             debug(&quot;  Event: &quot; + event);
246 
247             if (event.equals(AssocChangeEvent.COMM_UP))
248                 receivedCommUp = true;
</pre>
</td>
<td>
<hr />
<pre>
137                fail(&quot;NullPointerException not thrown for getOption&quot;);
138             } catch (NullPointerException unused) {
139                pass();
140             }
141 
142             /* ClosedChannelException */
143             smc.close();
144             try {
145                smc.setOption(SCTP_INIT_MAXSTREAMS, streams, null);
146                fail(&quot;ClosedChannelException not thrown&quot;);
147             } catch (ClosedChannelException unused) {
148                 pass();
149             }
150         } catch (IOException ioe) {
151             unexpected(ioe);
152         }
153     }
154 
155     /* SCTP_PRIMARY_ADDR */
156     void sctpPrimaryAddr() throws IOException {

157         ByteBuffer buffer = ByteBuffer.allocate(Util.SMALL_BUFFER);
158 
159         System.out.println(&quot;TESTING SCTP_PRIMARY_ADDR&quot;);
160 
161         /* create listening channel */
162         SctpServerChannel ssc = SctpServerChannel.open().bind(null);
163         Set&lt;SocketAddress&gt; addrs = ssc.getAllLocalAddresses();
164         if (addrs.isEmpty())
165             debug(&quot;addrs should not be empty&quot;);
166 
167         InetSocketAddress serverAddr = (InetSocketAddress) addrs.iterator().next();
168 
169         /* setup an association implicitly by sending a small message */
170         int streamNumber = 0;
171         debug(&quot;sending to &quot; + serverAddr + &quot; on stream number: &quot; + streamNumber);
172         MessageInfo info = MessageInfo.createOutgoing(serverAddr, streamNumber);
173         buffer.put(Util.SMALL_MESSAGE.getBytes(&quot;ISO-8859-1&quot;));
174         buffer.flip();
175 
176         debug(&quot;sending small message: &quot; + buffer);
177         SctpMultiChannel smc = SctpMultiChannel.open();
178         int sent = smc.send(buffer, info);
179 
180         /* Receive the COMM_UP */
181         buffer.clear();
182         SOTNotificationHandler handler = new SOTNotificationHandler();
183         info = smc.receive(buffer, null, handler);
184         check(handler.receivedCommUp(), &quot;COMM_UP no received&quot;);
185         Set&lt;Association&gt; associations = smc.associations();
186         check(!associations.isEmpty(),&quot;There should be some associations&quot;);
187         Association assoc = associations.iterator().next();
188 
189         SctpChannel peerChannel = ssc.accept();
190         ssc.close();
<span class="line-modified">191         Set&lt;SocketAddress&gt; remoteAddresses = smc.getRemoteAddresses(assoc);</span>
<span class="line-modified">192         debug(&quot;Remote Addresses: &quot;);</span>
<span class="line-modified">193         for (Iterator&lt;SocketAddress&gt; it = remoteAddresses.iterator(); it.hasNext(); ) {</span>
194             InetSocketAddress addr = (InetSocketAddress)it.next();
195             debug(&quot;\t&quot; + addr);

196         }
197 
198         /* retrieval of SCTP_PRIMARY_ADDR is not supported on Solaris */
199         if (&quot;SunOS&quot;.equals(osName)) {
200             /* For now do not set this option. There is a bug on Solaris 10 pre Update 5
201              * where setting this option returns Invalid argument */
202             //debug(&quot;Set SCTP_PRIMARY_ADDR with &quot; + addrToSet);
203             //smc.setOption(SCTP_PRIMARY_ADDR, addrToSet, assoc);
204             return;
205         } else { /* Linux */
206             SocketAddress primaryAddr = smc.getOption(SCTP_PRIMARY_ADDR, assoc);
207             System.out.println(&quot;SCTP_PRIMARY_ADDR returned: &quot; + primaryAddr);
<span class="line-modified">208             /* Verify that this is one of the remote addresses */</span>
<span class="line-modified">209             check(remoteAddresses.contains(primaryAddr), &quot;SCTP_PRIMARY_ADDR returned bogus address!&quot;);</span>
<span class="line-modified">210 </span>
<span class="line-modified">211             for (Iterator&lt;SocketAddress&gt; it = remoteAddresses.iterator(); it.hasNext(); ) {</span>
<span class="line-modified">212                 InetSocketAddress addrToSet = (InetSocketAddress) it.next();</span>
<span class="line-modified">213                 System.out.println(&quot;SCTP_PRIMARY_ADDR try set to: &quot; + addrToSet);</span>
<span class="line-modified">214                 smc.setOption(SCTP_PRIMARY_ADDR, addrToSet, assoc);</span>
<span class="line-modified">215                 System.out.println(&quot;SCTP_PRIMARY_ADDR set to    : &quot; + addrToSet);</span>
<span class="line-modified">216                 primaryAddr = smc.getOption(SCTP_PRIMARY_ADDR, assoc);</span>
<span class="line-added">217                 System.out.println(&quot;SCTP_PRIMARY_ADDR returned  : &quot; + primaryAddr);</span>
<span class="line-added">218                 check(addrToSet.equals(primaryAddr), &quot;SCTP_PRIMARY_ADDR not set correctly&quot;);</span>
219             }








220         }
<span class="line-added">221         smc.close();</span>
<span class="line-added">222         peerChannel.close();</span>
223     }
224 
225     class SOTNotificationHandler extends AbstractNotificationHandler&lt;Object&gt;
226     {
227         boolean receivedCommUp;  // false
228 
229         boolean receivedCommUp() {
230             return receivedCommUp;
231         }
232 
233         @Override
234         public HandlerResult handleNotification(
235                 AssociationChangeNotification notification, Object attachment) {
236             AssocChangeEvent event = notification.event();
237             debug(&quot;AssociationChangeNotification&quot;);
238             debug(&quot;  Association: &quot; + notification.association());
239             debug(&quot;  Event: &quot; + event);
240 
241             if (event.equals(AssocChangeEvent.COMM_UP))
242                 receivedCommUp = true;
</pre>
</td>
</tr>
</table>
<center><a href="SendFailed.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../../../../../demo/jfc/J2Ddemo/J2DdemoTest.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>