<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/jdk/com/sun/management/ThreadMXBean/ThreadAllocatedMemory.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2011, 2015, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
<a name="2" id="anc2"></a><span class="line-modified"> 26  * @bug     6173675</span>
 27  * @summary Basic test of ThreadMXBean.getThreadAllocatedBytes
 28  * @author  Paul Hohensee
 29  */
 30 
 31 import java.lang.management.*;
 32 
 33 public class ThreadAllocatedMemory {
 34     private static com.sun.management.ThreadMXBean mbean =
 35         (com.sun.management.ThreadMXBean)ManagementFactory.getThreadMXBean();
<a name="3" id="anc3"></a><span class="line-modified"> 36     private static boolean testFailed = false;</span>
<span class="line-modified"> 37     private static boolean done = false;</span>
<span class="line-removed"> 38     private static boolean done1 = false;</span>
 39     private static Object obj = new Object();
 40     private static final int NUM_THREADS = 10;
 41     private static Thread[] threads = new Thread[NUM_THREADS];
 42     private static long[] sizes = new long[NUM_THREADS];
 43 
 44     public static void main(String[] argv)
 45         throws Exception {
 46 
<a name="4" id="anc4"></a>















 47         if (!mbean.isThreadAllocatedMemorySupported()) {
 48             return;
 49         }
 50 
 51         // disable allocated memory measurement
 52         if (mbean.isThreadAllocatedMemoryEnabled()) {
 53             mbean.setThreadAllocatedMemoryEnabled(false);
 54         }
 55 
 56         if (mbean.isThreadAllocatedMemoryEnabled()) {
 57             throw new RuntimeException(
 58                 &quot;ThreadAllocatedMemory is expected to be disabled&quot;);
 59         }
 60 
<a name="5" id="anc5"></a><span class="line-modified"> 61         Thread curThread = Thread.currentThread();</span>
<span class="line-removed"> 62         long id = curThread.getId();</span>
<span class="line-removed"> 63 </span>
<span class="line-removed"> 64         long s = mbean.getThreadAllocatedBytes(id);</span>
 65         if (s != -1) {
 66             throw new RuntimeException(
 67                 &quot;Invalid ThreadAllocatedBytes returned = &quot; +
 68                 s + &quot; expected = -1&quot;);
 69         }
 70 
 71         // enable allocated memory measurement
 72         if (!mbean.isThreadAllocatedMemoryEnabled()) {
 73             mbean.setThreadAllocatedMemoryEnabled(true);
 74         }
 75 
 76         if (!mbean.isThreadAllocatedMemoryEnabled()) {
 77             throw new RuntimeException(
 78                 &quot;ThreadAllocatedMemory is expected to be enabled&quot;);
 79         }
<a name="6" id="anc6"></a>















 80 
 81         long size = mbean.getThreadAllocatedBytes(id);
<a name="7" id="anc7"></a><span class="line-modified"> 82         // implementation could have started measurement when</span>
<span class="line-removed"> 83         // measurement was enabled, in which case size can be 0</span>
<span class="line-removed"> 84         if (size &lt; 0) {</span>
<span class="line-removed"> 85             throw new RuntimeException(</span>
<span class="line-removed"> 86                 &quot;Invalid allocated bytes returned = &quot; + size);</span>
<span class="line-removed"> 87         }</span>
 88 
<a name="8" id="anc8"></a>
 89         doit();
 90 
<a name="9" id="anc9"></a><span class="line-modified"> 91         // Expected to be size1 &gt;= size</span>
<span class="line-modified"> 92         long size1 = mbean.getThreadAllocatedBytes(id);</span>
<span class="line-modified"> 93         if (size1 &lt; size) {</span>
<span class="line-modified"> 94             throw new RuntimeException(&quot;Allocated bytes &quot; + size1 +</span>
<span class="line-modified"> 95                 &quot; expected &gt;= &quot; + size);</span>






























 96         }
<a name="10" id="anc10"></a><span class="line-removed"> 97         System.out.println(curThread.getName() +</span>
<span class="line-removed"> 98             &quot; Current thread allocated bytes = &quot; + size +</span>
<span class="line-removed"> 99             &quot; allocated bytes = &quot; + size1);</span>
100 
<a name="11" id="anc11"></a>






101 
<a name="12" id="anc12"></a><span class="line-modified">102         // start threads, wait for them to block</span>




103         for (int i = 0; i &lt; NUM_THREADS; i++) {
104             threads[i] = new MyThread(&quot;MyThread-&quot; + i);
105             threads[i].start();
106         }
107 
<a name="13" id="anc13"></a><span class="line-modified">108         // threads block after doing some allocation</span>
<span class="line-modified">109         waitUntilThreadBlocked();</span>
110 
111         for (int i = 0; i &lt; NUM_THREADS; i++) {
112             sizes[i] = mbean.getThreadAllocatedBytes(threads[i].getId());
<a name="14" id="anc14"></a>
113         }
114 
<a name="15" id="anc15"></a><span class="line-modified">115         // let threads go and do some more allocation</span>
116         synchronized (obj) {
117             done = true;
118             obj.notifyAll();
119         }
120 
<a name="16" id="anc16"></a><span class="line-modified">121         // wait for threads to get going again.  we don&#39;t care if we</span>
122         // catch them in mid-execution or if some of them haven&#39;t
123         // restarted after we&#39;re done sleeping.
124         goSleep(400);
125 
126         for (int i = 0; i &lt; NUM_THREADS; i++) {
<a name="17" id="anc17"></a><span class="line-modified">127             long newSize = mbean.getThreadAllocatedBytes(threads[i].getId());</span>
<span class="line-modified">128             if (sizes[i] &gt; newSize) {</span>
<span class="line-removed">129                 throw new RuntimeException(&quot;TEST FAILED: &quot; +</span>
<span class="line-removed">130                     threads[i].getName() +</span>
<span class="line-removed">131                     &quot; previous allocated bytes = &quot; + sizes[i] +</span>
<span class="line-removed">132                     &quot; &gt; current allocated bytes = &quot; + newSize);</span>
<span class="line-removed">133             }</span>
<span class="line-removed">134             System.out.println(threads[i].getName() +</span>
<span class="line-removed">135                 &quot; Previous allocated bytes = &quot; + sizes[i] +</span>
<span class="line-removed">136                 &quot; Current allocated bytes = &quot; + newSize);</span>
137         }
138 
139         // let threads exit
140         synchronized (obj) {
141             done1 = true;
142             obj.notifyAll();
143         }
144 
145         for (int i = 0; i &lt; NUM_THREADS; i++) {
146             try {
147                 threads[i].join();
148             } catch (InterruptedException e) {
149                 System.out.println(&quot;Unexpected exception is thrown.&quot;);
150                 e.printStackTrace(System.out);
<a name="18" id="anc18"></a><span class="line-removed">151                 testFailed = true;</span>
152                 break;
153             }
154         }
<a name="19" id="anc19"></a><span class="line-modified">155         if (testFailed) {</span>
<span class="line-removed">156             throw new RuntimeException(&quot;TEST FAILED&quot;);</span>
<span class="line-removed">157         }</span>
158 
<a name="20" id="anc20"></a><span class="line-modified">159         System.out.println(&quot;Test passed&quot;);</span>






160     }
161 
<a name="21" id="anc21"></a>









162 
163     private static void goSleep(long ms) throws Exception {
164         try {
165             Thread.sleep(ms);
166         } catch (InterruptedException e) {
167             System.out.println(&quot;Unexpected exception is thrown.&quot;);
168             throw e;
169         }
170     }
171 
<a name="22" id="anc22"></a><span class="line-modified">172     private static void waitUntilThreadBlocked()</span>











173         throws Exception {
174         int count = 0;
175         while (count != NUM_THREADS) {
176             goSleep(100);
177             count = 0;
178             for (int i = 0; i &lt; NUM_THREADS; i++) {
179                 ThreadInfo info = mbean.getThreadInfo(threads[i].getId());
180                 if (info.getThreadState() == Thread.State.WAITING) {
181                     count++;
182                 }
183             }
184         }
185     }
186 
187     public static void doit() {
188         String tmp = &quot;&quot;;
189         long hashCode = 0;
190         for (int counter = 0; counter &lt; 1000; counter++) {
191             tmp += counter;
192             hashCode = tmp.hashCode();
193         }
194         System.out.println(Thread.currentThread().getName() +
195                            &quot; hashcode: &quot; + hashCode);
196     }
197 
198     static class MyThread extends Thread {
199         public MyThread(String name) {
200             super(name);
201         }
202 
203         public void run() {
204             ThreadAllocatedMemory.doit();
205 
206             synchronized (obj) {
207                 while (!done) {
208                     try {
209                         obj.wait();
210                     } catch (InterruptedException e) {
211                         System.out.println(&quot;Unexpected exception is thrown.&quot;);
212                         e.printStackTrace(System.out);
<a name="23" id="anc23"></a><span class="line-removed">213                         testFailed = true;</span>
214                         break;
215                     }
216                 }
217             }
218 
219             long size1 = mbean.getThreadAllocatedBytes(getId());
220             ThreadAllocatedMemory.doit();
221             long size2 = mbean.getThreadAllocatedBytes(getId());
222 
223             System.out.println(getName() + &quot;: &quot; +
224                 &quot;ThreadAllocatedBytes  = &quot; + size1 +
225                 &quot; ThreadAllocatedBytes  = &quot; + size2);
226 
227             if (size1 &gt; size2) {
<a name="24" id="anc24"></a><span class="line-modified">228                 throw new RuntimeException(&quot;TEST FAILED: &quot; + getName() +</span>
229                     &quot; ThreadAllocatedBytes = &quot; + size1 +
230                     &quot; &gt; ThreadAllocatedBytes = &quot; + size2);
231             }
232 
233             synchronized (obj) {
234                 while (!done1) {
235                     try {
236                         obj.wait();
237                     } catch (InterruptedException e) {
238                         System.out.println(&quot;Unexpected exception is thrown.&quot;);
239                         e.printStackTrace(System.out);
<a name="25" id="anc25"></a><span class="line-removed">240                         testFailed = true;</span>
241                         break;
242                     }
243                 }
244             }
245         }
246     }
247 }
<a name="26" id="anc26"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="26" type="hidden" />
</body>
</html>