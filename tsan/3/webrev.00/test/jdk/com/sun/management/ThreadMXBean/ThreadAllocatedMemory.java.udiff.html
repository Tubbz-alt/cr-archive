<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/jdk/com/sun/management/ThreadMXBean/ThreadAllocatedMemory.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="../OperatingSystemMXBean/GetCommittedVirtualMemorySize.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../../net/httpserver/EchoHandler.java.udiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/com/sun/management/ThreadMXBean/ThreadAllocatedMemory.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2011, 2015, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2011, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -21,31 +21,46 @@</span>
   * questions.
   */
  
  /*
   * @test
<span class="udiff-line-modified-removed">-  * @bug     6173675</span>
<span class="udiff-line-modified-added">+  * @bug     6173675 8231209</span>
   * @summary Basic test of ThreadMXBean.getThreadAllocatedBytes
   * @author  Paul Hohensee
   */
  
  import java.lang.management.*;
  
  public class ThreadAllocatedMemory {
      private static com.sun.management.ThreadMXBean mbean =
          (com.sun.management.ThreadMXBean)ManagementFactory.getThreadMXBean();
<span class="udiff-line-modified-removed">-     private static boolean testFailed = false;</span>
<span class="udiff-line-modified-removed">-     private static boolean done = false;</span>
<span class="udiff-line-removed">-     private static boolean done1 = false;</span>
<span class="udiff-line-modified-added">+     private static volatile boolean done = false;</span>
<span class="udiff-line-modified-added">+     private static volatile boolean done1 = false;</span>
      private static Object obj = new Object();
      private static final int NUM_THREADS = 10;
      private static Thread[] threads = new Thread[NUM_THREADS];
      private static long[] sizes = new long[NUM_THREADS];
  
      public static void main(String[] argv)
          throws Exception {
  
<span class="udiff-line-added">+         testSupportEnableDisable();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         // Test current thread two ways</span>
<span class="udiff-line-added">+         testGetCurrentThreadAllocatedBytes();</span>
<span class="udiff-line-added">+         testCurrentThreadGetThreadAllocatedBytes();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         // Test a single thread that is not this one</span>
<span class="udiff-line-added">+         testGetThreadAllocatedBytes();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         // Test many threads that are not this one</span>
<span class="udiff-line-added">+         testGetThreadsAllocatedBytes();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         System.out.println(&quot;Test passed&quot;);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private static void testSupportEnableDisable() {</span>
          if (!mbean.isThreadAllocatedMemorySupported()) {
              return;
          }
  
          // disable allocated memory measurement
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -56,14 +71,11 @@</span>
          if (mbean.isThreadAllocatedMemoryEnabled()) {
              throw new RuntimeException(
                  &quot;ThreadAllocatedMemory is expected to be disabled&quot;);
          }
  
<span class="udiff-line-modified-removed">-         Thread curThread = Thread.currentThread();</span>
<span class="udiff-line-removed">-         long id = curThread.getId();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         long s = mbean.getThreadAllocatedBytes(id);</span>
<span class="udiff-line-modified-added">+         long s = mbean.getCurrentThreadAllocatedBytes();</span>
          if (s != -1) {
              throw new RuntimeException(
                  &quot;Invalid ThreadAllocatedBytes returned = &quot; +
                  s + &quot; expected = -1&quot;);
          }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -75,67 +87,110 @@</span>
  
          if (!mbean.isThreadAllocatedMemoryEnabled()) {
              throw new RuntimeException(
                  &quot;ThreadAllocatedMemory is expected to be enabled&quot;);
          }
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private static void testGetCurrentThreadAllocatedBytes() {</span>
<span class="udiff-line-added">+         long size = mbean.getCurrentThreadAllocatedBytes();</span>
<span class="udiff-line-added">+         ensureValidSize(size);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         // do some more allocation</span>
<span class="udiff-line-added">+         doit();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         checkResult(Thread.currentThread(), size,</span>
<span class="udiff-line-added">+                     mbean.getCurrentThreadAllocatedBytes());</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private static void testCurrentThreadGetThreadAllocatedBytes() {</span>
<span class="udiff-line-added">+         Thread curThread = Thread.currentThread();</span>
<span class="udiff-line-added">+         long id = curThread.getId();</span>
  
          long size = mbean.getThreadAllocatedBytes(id);
<span class="udiff-line-modified-removed">-         // implementation could have started measurement when</span>
<span class="udiff-line-removed">-         // measurement was enabled, in which case size can be 0</span>
<span class="udiff-line-removed">-         if (size &lt; 0) {</span>
<span class="udiff-line-removed">-             throw new RuntimeException(</span>
<span class="udiff-line-removed">-                 &quot;Invalid allocated bytes returned = &quot; + size);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-modified-added">+         ensureValidSize(size);</span>
  
<span class="udiff-line-added">+         // do some more allocation</span>
          doit();
  
<span class="udiff-line-modified-removed">-         // Expected to be size1 &gt;= size</span>
<span class="udiff-line-modified-removed">-         long size1 = mbean.getThreadAllocatedBytes(id);</span>
<span class="udiff-line-modified-removed">-         if (size1 &lt; size) {</span>
<span class="udiff-line-modified-removed">-             throw new RuntimeException(&quot;Allocated bytes &quot; + size1 +</span>
<span class="udiff-line-modified-removed">-                 &quot; expected &gt;= &quot; + size);</span>
<span class="udiff-line-modified-added">+         checkResult(curThread, size, mbean.getThreadAllocatedBytes(id));</span>
<span class="udiff-line-modified-added">+     }</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+     private static void testGetThreadAllocatedBytes()</span>
<span class="udiff-line-modified-added">+         throws Exception {</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         // start a thread</span>
<span class="udiff-line-added">+         done = false; done1 = false;</span>
<span class="udiff-line-added">+         Thread curThread = new MyThread(&quot;MyThread&quot;);</span>
<span class="udiff-line-added">+         curThread.start();</span>
<span class="udiff-line-added">+         long id = curThread.getId();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         // wait for thread to block after doing some allocation</span>
<span class="udiff-line-added">+         waitUntilThreadBlocked(curThread);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         long size = mbean.getThreadAllocatedBytes(id);</span>
<span class="udiff-line-added">+         ensureValidSize(size);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         // let thread go to do some more allocation</span>
<span class="udiff-line-added">+         synchronized (obj) {</span>
<span class="udiff-line-added">+             done = true;</span>
<span class="udiff-line-added">+             obj.notifyAll();</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         // wait for thread to get going again. we don&#39;t care if we</span>
<span class="udiff-line-added">+         // catch it in mid-execution or if it hasn&#39;t</span>
<span class="udiff-line-added">+         // restarted after we&#39;re done sleeping.</span>
<span class="udiff-line-added">+         goSleep(400);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         checkResult(curThread, size, mbean.getThreadAllocatedBytes(id));</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         // let thread exit</span>
<span class="udiff-line-added">+         synchronized (obj) {</span>
<span class="udiff-line-added">+             done1 = true;</span>
<span class="udiff-line-added">+             obj.notifyAll();</span>
          }
<span class="udiff-line-removed">-         System.out.println(curThread.getName() +</span>
<span class="udiff-line-removed">-             &quot; Current thread allocated bytes = &quot; + size +</span>
<span class="udiff-line-removed">-             &quot; allocated bytes = &quot; + size1);</span>
  
<span class="udiff-line-added">+         try {</span>
<span class="udiff-line-added">+             curThread.join();</span>
<span class="udiff-line-added">+         } catch (InterruptedException e) {</span>
<span class="udiff-line-added">+             System.out.println(&quot;Unexpected exception is thrown.&quot;);</span>
<span class="udiff-line-added">+             e.printStackTrace(System.out);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
  
<span class="udiff-line-modified-removed">-         // start threads, wait for them to block</span>
<span class="udiff-line-modified-added">+     private static void testGetThreadsAllocatedBytes()</span>
<span class="udiff-line-added">+         throws Exception {</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         // start threads</span>
<span class="udiff-line-added">+         done = false; done1 = false;</span>
          for (int i = 0; i &lt; NUM_THREADS; i++) {
              threads[i] = new MyThread(&quot;MyThread-&quot; + i);
              threads[i].start();
          }
  
<span class="udiff-line-modified-removed">-         // threads block after doing some allocation</span>
<span class="udiff-line-modified-removed">-         waitUntilThreadBlocked();</span>
<span class="udiff-line-modified-added">+         // wait for threads to block after doing some allocation</span>
<span class="udiff-line-modified-added">+         waitUntilThreadsBlocked();</span>
  
          for (int i = 0; i &lt; NUM_THREADS; i++) {
              sizes[i] = mbean.getThreadAllocatedBytes(threads[i].getId());
<span class="udiff-line-added">+             ensureValidSize(sizes[i]);</span>
          }
  
<span class="udiff-line-modified-removed">-         // let threads go and do some more allocation</span>
<span class="udiff-line-modified-added">+         // let threads go to do some more allocation</span>
          synchronized (obj) {
              done = true;
              obj.notifyAll();
          }
  
<span class="udiff-line-modified-removed">-         // wait for threads to get going again.  we don&#39;t care if we</span>
<span class="udiff-line-modified-added">+         // wait for threads to get going again. we don&#39;t care if we</span>
          // catch them in mid-execution or if some of them haven&#39;t
          // restarted after we&#39;re done sleeping.
          goSleep(400);
  
          for (int i = 0; i &lt; NUM_THREADS; i++) {
<span class="udiff-line-modified-removed">-             long newSize = mbean.getThreadAllocatedBytes(threads[i].getId());</span>
<span class="udiff-line-modified-removed">-             if (sizes[i] &gt; newSize) {</span>
<span class="udiff-line-removed">-                 throw new RuntimeException(&quot;TEST FAILED: &quot; +</span>
<span class="udiff-line-removed">-                     threads[i].getName() +</span>
<span class="udiff-line-removed">-                     &quot; previous allocated bytes = &quot; + sizes[i] +</span>
<span class="udiff-line-removed">-                     &quot; &gt; current allocated bytes = &quot; + newSize);</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             System.out.println(threads[i].getName() +</span>
<span class="udiff-line-removed">-                 &quot; Previous allocated bytes = &quot; + sizes[i] +</span>
<span class="udiff-line-removed">-                 &quot; Current allocated bytes = &quot; + newSize);</span>
<span class="udiff-line-modified-added">+             checkResult(threads[i], sizes[i],</span>
<span class="udiff-line-modified-added">+                         mbean.getThreadAllocatedBytes(threads[i].getId()));</span>
          }
  
          // let threads exit
          synchronized (obj) {
              done1 = true;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -146,32 +201,56 @@</span>
              try {
                  threads[i].join();
              } catch (InterruptedException e) {
                  System.out.println(&quot;Unexpected exception is thrown.&quot;);
                  e.printStackTrace(System.out);
<span class="udiff-line-removed">-                 testFailed = true;</span>
                  break;
              }
          }
<span class="udiff-line-modified-removed">-         if (testFailed) {</span>
<span class="udiff-line-removed">-             throw new RuntimeException(&quot;TEST FAILED&quot;);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-modified-added">+     }</span>
  
<span class="udiff-line-modified-removed">-         System.out.println(&quot;Test passed&quot;);</span>
<span class="udiff-line-modified-added">+     private static void ensureValidSize(long size) {</span>
<span class="udiff-line-added">+         // implementation could have started measurement when</span>
<span class="udiff-line-added">+         // measurement was enabled, in which case size can be 0</span>
<span class="udiff-line-added">+         if (size &lt; 0) {</span>
<span class="udiff-line-added">+             throw new RuntimeException(</span>
<span class="udiff-line-added">+                 &quot;Invalid allocated bytes returned = &quot; + size);</span>
<span class="udiff-line-added">+         }</span>
      }
  
<span class="udiff-line-added">+     private static void checkResult(Thread curThread,</span>
<span class="udiff-line-added">+                                     long prev_size, long curr_size) {</span>
<span class="udiff-line-added">+         if (curr_size &lt; prev_size) {</span>
<span class="udiff-line-added">+             throw new RuntimeException(&quot;Allocated bytes &quot; + curr_size +</span>
<span class="udiff-line-added">+                                        &quot; expected &gt;= &quot; + prev_size);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         System.out.println(curThread.getName() +</span>
<span class="udiff-line-added">+                            &quot; Previous allocated bytes = &quot; + prev_size +</span>
<span class="udiff-line-added">+                            &quot; Current allocated bytes = &quot; + curr_size);</span>
<span class="udiff-line-added">+     }</span>
  
      private static void goSleep(long ms) throws Exception {
          try {
              Thread.sleep(ms);
          } catch (InterruptedException e) {
              System.out.println(&quot;Unexpected exception is thrown.&quot;);
              throw e;
          }
      }
  
<span class="udiff-line-modified-removed">-     private static void waitUntilThreadBlocked()</span>
<span class="udiff-line-modified-added">+     private static void waitUntilThreadBlocked(Thread thread)</span>
<span class="udiff-line-added">+         throws Exception {</span>
<span class="udiff-line-added">+         while (true) {</span>
<span class="udiff-line-added">+             goSleep(100);</span>
<span class="udiff-line-added">+             ThreadInfo info = mbean.getThreadInfo(thread.getId());</span>
<span class="udiff-line-added">+             if (info.getThreadState() == Thread.State.WAITING) {</span>
<span class="udiff-line-added">+                 break;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private static void waitUntilThreadsBlocked()</span>
          throws Exception {
          int count = 0;
          while (count != NUM_THREADS) {
              goSleep(100);
              count = 0;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -208,11 +287,10 @@</span>
                      try {
                          obj.wait();
                      } catch (InterruptedException e) {
                          System.out.println(&quot;Unexpected exception is thrown.&quot;);
                          e.printStackTrace(System.out);
<span class="udiff-line-removed">-                         testFailed = true;</span>
                          break;
                      }
                  }
              }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -223,11 +301,11 @@</span>
              System.out.println(getName() + &quot;: &quot; +
                  &quot;ThreadAllocatedBytes  = &quot; + size1 +
                  &quot; ThreadAllocatedBytes  = &quot; + size2);
  
              if (size1 &gt; size2) {
<span class="udiff-line-modified-removed">-                 throw new RuntimeException(&quot;TEST FAILED: &quot; + getName() +</span>
<span class="udiff-line-modified-added">+                 throw new RuntimeException(getName() +</span>
                      &quot; ThreadAllocatedBytes = &quot; + size1 +
                      &quot; &gt; ThreadAllocatedBytes = &quot; + size2);
              }
  
              synchronized (obj) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -235,11 +313,10 @@</span>
                      try {
                          obj.wait();
                      } catch (InterruptedException e) {
                          System.out.println(&quot;Unexpected exception is thrown.&quot;);
                          e.printStackTrace(System.out);
<span class="udiff-line-removed">-                         testFailed = true;</span>
                          break;
                      }
                  }
              }
          }
</pre>
<center><a href="../OperatingSystemMXBean/GetCommittedVirtualMemorySize.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../../net/httpserver/EchoHandler.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>