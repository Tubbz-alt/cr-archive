<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/jdk/com/sun/management/ThreadMXBean/ThreadAllocatedMemory.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2011, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
<a name="2" id="anc2"></a><span class="line-modified"> 26  * @bug     6173675 8231209</span>
 27  * @summary Basic test of ThreadMXBean.getThreadAllocatedBytes
 28  * @author  Paul Hohensee
 29  */
 30 
 31 import java.lang.management.*;
 32 
 33 public class ThreadAllocatedMemory {
 34     private static com.sun.management.ThreadMXBean mbean =
 35         (com.sun.management.ThreadMXBean)ManagementFactory.getThreadMXBean();
<a name="3" id="anc3"></a><span class="line-modified"> 36     private static volatile boolean done = false;</span>
<span class="line-modified"> 37     private static volatile boolean done1 = false;</span>

 38     private static Object obj = new Object();
 39     private static final int NUM_THREADS = 10;
 40     private static Thread[] threads = new Thread[NUM_THREADS];
 41     private static long[] sizes = new long[NUM_THREADS];
 42 
 43     public static void main(String[] argv)
 44         throws Exception {
 45 
<a name="4" id="anc4"></a><span class="line-added"> 46         testSupportEnableDisable();</span>
<span class="line-added"> 47 </span>
<span class="line-added"> 48         // Test current thread two ways</span>
<span class="line-added"> 49         testGetCurrentThreadAllocatedBytes();</span>
<span class="line-added"> 50         testCurrentThreadGetThreadAllocatedBytes();</span>
<span class="line-added"> 51 </span>
<span class="line-added"> 52         // Test a single thread that is not this one</span>
<span class="line-added"> 53         testGetThreadAllocatedBytes();</span>
<span class="line-added"> 54 </span>
<span class="line-added"> 55         // Test many threads that are not this one</span>
<span class="line-added"> 56         testGetThreadsAllocatedBytes();</span>
<span class="line-added"> 57 </span>
<span class="line-added"> 58         System.out.println(&quot;Test passed&quot;);</span>
<span class="line-added"> 59     }</span>
<span class="line-added"> 60 </span>
<span class="line-added"> 61     private static void testSupportEnableDisable() {</span>
 62         if (!mbean.isThreadAllocatedMemorySupported()) {
 63             return;
 64         }
 65 
 66         // disable allocated memory measurement
 67         if (mbean.isThreadAllocatedMemoryEnabled()) {
 68             mbean.setThreadAllocatedMemoryEnabled(false);
 69         }
 70 
 71         if (mbean.isThreadAllocatedMemoryEnabled()) {
 72             throw new RuntimeException(
 73                 &quot;ThreadAllocatedMemory is expected to be disabled&quot;);
 74         }
 75 
<a name="5" id="anc5"></a><span class="line-modified"> 76         long s = mbean.getCurrentThreadAllocatedBytes();</span>



 77         if (s != -1) {
 78             throw new RuntimeException(
 79                 &quot;Invalid ThreadAllocatedBytes returned = &quot; +
 80                 s + &quot; expected = -1&quot;);
 81         }
 82 
 83         // enable allocated memory measurement
 84         if (!mbean.isThreadAllocatedMemoryEnabled()) {
 85             mbean.setThreadAllocatedMemoryEnabled(true);
 86         }
 87 
 88         if (!mbean.isThreadAllocatedMemoryEnabled()) {
 89             throw new RuntimeException(
 90                 &quot;ThreadAllocatedMemory is expected to be enabled&quot;);
 91         }
<a name="6" id="anc6"></a><span class="line-added"> 92     }</span>
<span class="line-added"> 93 </span>
<span class="line-added"> 94     private static void testGetCurrentThreadAllocatedBytes() {</span>
<span class="line-added"> 95         long size = mbean.getCurrentThreadAllocatedBytes();</span>
<span class="line-added"> 96         ensureValidSize(size);</span>
<span class="line-added"> 97 </span>
<span class="line-added"> 98         // do some more allocation</span>
<span class="line-added"> 99         doit();</span>
<span class="line-added">100 </span>
<span class="line-added">101         checkResult(Thread.currentThread(), size,</span>
<span class="line-added">102                     mbean.getCurrentThreadAllocatedBytes());</span>
<span class="line-added">103     }</span>
<span class="line-added">104 </span>
<span class="line-added">105     private static void testCurrentThreadGetThreadAllocatedBytes() {</span>
<span class="line-added">106         Thread curThread = Thread.currentThread();</span>
<span class="line-added">107         long id = curThread.getId();</span>
108 
109         long size = mbean.getThreadAllocatedBytes(id);
<a name="7" id="anc7"></a><span class="line-modified">110         ensureValidSize(size);</span>





111 
<a name="8" id="anc8"></a><span class="line-added">112         // do some more allocation</span>
113         doit();
114 
<a name="9" id="anc9"></a><span class="line-modified">115         checkResult(curThread, size, mbean.getThreadAllocatedBytes(id));</span>
<span class="line-modified">116     }</span>
<span class="line-modified">117 </span>
<span class="line-modified">118     private static void testGetThreadAllocatedBytes()</span>
<span class="line-modified">119         throws Exception {</span>
<span class="line-added">120 </span>
<span class="line-added">121         // start a thread</span>
<span class="line-added">122         done = false; done1 = false;</span>
<span class="line-added">123         Thread curThread = new MyThread(&quot;MyThread&quot;);</span>
<span class="line-added">124         curThread.start();</span>
<span class="line-added">125         long id = curThread.getId();</span>
<span class="line-added">126 </span>
<span class="line-added">127         // wait for thread to block after doing some allocation</span>
<span class="line-added">128         waitUntilThreadBlocked(curThread);</span>
<span class="line-added">129 </span>
<span class="line-added">130         long size = mbean.getThreadAllocatedBytes(id);</span>
<span class="line-added">131         ensureValidSize(size);</span>
<span class="line-added">132 </span>
<span class="line-added">133         // let thread go to do some more allocation</span>
<span class="line-added">134         synchronized (obj) {</span>
<span class="line-added">135             done = true;</span>
<span class="line-added">136             obj.notifyAll();</span>
<span class="line-added">137         }</span>
<span class="line-added">138 </span>
<span class="line-added">139         // wait for thread to get going again. we don&#39;t care if we</span>
<span class="line-added">140         // catch it in mid-execution or if it hasn&#39;t</span>
<span class="line-added">141         // restarted after we&#39;re done sleeping.</span>
<span class="line-added">142         goSleep(400);</span>
<span class="line-added">143 </span>
<span class="line-added">144         checkResult(curThread, size, mbean.getThreadAllocatedBytes(id));</span>
<span class="line-added">145 </span>
<span class="line-added">146         // let thread exit</span>
<span class="line-added">147         synchronized (obj) {</span>
<span class="line-added">148             done1 = true;</span>
<span class="line-added">149             obj.notifyAll();</span>
150         }
<a name="10" id="anc10"></a>


151 
<a name="11" id="anc11"></a><span class="line-added">152         try {</span>
<span class="line-added">153             curThread.join();</span>
<span class="line-added">154         } catch (InterruptedException e) {</span>
<span class="line-added">155             System.out.println(&quot;Unexpected exception is thrown.&quot;);</span>
<span class="line-added">156             e.printStackTrace(System.out);</span>
<span class="line-added">157         }</span>
<span class="line-added">158     }</span>
159 
<a name="12" id="anc12"></a><span class="line-modified">160     private static void testGetThreadsAllocatedBytes()</span>
<span class="line-added">161         throws Exception {</span>
<span class="line-added">162 </span>
<span class="line-added">163         // start threads</span>
<span class="line-added">164         done = false; done1 = false;</span>
165         for (int i = 0; i &lt; NUM_THREADS; i++) {
166             threads[i] = new MyThread(&quot;MyThread-&quot; + i);
167             threads[i].start();
168         }
169 
<a name="13" id="anc13"></a><span class="line-modified">170         // wait for threads to block after doing some allocation</span>
<span class="line-modified">171         waitUntilThreadsBlocked();</span>
172 
173         for (int i = 0; i &lt; NUM_THREADS; i++) {
174             sizes[i] = mbean.getThreadAllocatedBytes(threads[i].getId());
<a name="14" id="anc14"></a><span class="line-added">175             ensureValidSize(sizes[i]);</span>
176         }
177 
<a name="15" id="anc15"></a><span class="line-modified">178         // let threads go to do some more allocation</span>
179         synchronized (obj) {
180             done = true;
181             obj.notifyAll();
182         }
183 
<a name="16" id="anc16"></a><span class="line-modified">184         // wait for threads to get going again. we don&#39;t care if we</span>
185         // catch them in mid-execution or if some of them haven&#39;t
186         // restarted after we&#39;re done sleeping.
187         goSleep(400);
188 
189         for (int i = 0; i &lt; NUM_THREADS; i++) {
<a name="17" id="anc17"></a><span class="line-modified">190             checkResult(threads[i], sizes[i],</span>
<span class="line-modified">191                         mbean.getThreadAllocatedBytes(threads[i].getId()));</span>








192         }
193 
194         // let threads exit
195         synchronized (obj) {
196             done1 = true;
197             obj.notifyAll();
198         }
199 
200         for (int i = 0; i &lt; NUM_THREADS; i++) {
201             try {
202                 threads[i].join();
203             } catch (InterruptedException e) {
204                 System.out.println(&quot;Unexpected exception is thrown.&quot;);
205                 e.printStackTrace(System.out);
<a name="18" id="anc18"></a>
206                 break;
207             }
208         }
<a name="19" id="anc19"></a><span class="line-modified">209     }</span>


210 
<a name="20" id="anc20"></a><span class="line-modified">211     private static void ensureValidSize(long size) {</span>
<span class="line-added">212         // implementation could have started measurement when</span>
<span class="line-added">213         // measurement was enabled, in which case size can be 0</span>
<span class="line-added">214         if (size &lt; 0) {</span>
<span class="line-added">215             throw new RuntimeException(</span>
<span class="line-added">216                 &quot;Invalid allocated bytes returned = &quot; + size);</span>
<span class="line-added">217         }</span>
218     }
219 
<a name="21" id="anc21"></a><span class="line-added">220     private static void checkResult(Thread curThread,</span>
<span class="line-added">221                                     long prev_size, long curr_size) {</span>
<span class="line-added">222         if (curr_size &lt; prev_size) {</span>
<span class="line-added">223             throw new RuntimeException(&quot;Allocated bytes &quot; + curr_size +</span>
<span class="line-added">224                                        &quot; expected &gt;= &quot; + prev_size);</span>
<span class="line-added">225         }</span>
<span class="line-added">226         System.out.println(curThread.getName() +</span>
<span class="line-added">227                            &quot; Previous allocated bytes = &quot; + prev_size +</span>
<span class="line-added">228                            &quot; Current allocated bytes = &quot; + curr_size);</span>
<span class="line-added">229     }</span>
230 
231     private static void goSleep(long ms) throws Exception {
232         try {
233             Thread.sleep(ms);
234         } catch (InterruptedException e) {
235             System.out.println(&quot;Unexpected exception is thrown.&quot;);
236             throw e;
237         }
238     }
239 
<a name="22" id="anc22"></a><span class="line-modified">240     private static void waitUntilThreadBlocked(Thread thread)</span>
<span class="line-added">241         throws Exception {</span>
<span class="line-added">242         while (true) {</span>
<span class="line-added">243             goSleep(100);</span>
<span class="line-added">244             ThreadInfo info = mbean.getThreadInfo(thread.getId());</span>
<span class="line-added">245             if (info.getThreadState() == Thread.State.WAITING) {</span>
<span class="line-added">246                 break;</span>
<span class="line-added">247             }</span>
<span class="line-added">248         }</span>
<span class="line-added">249     }</span>
<span class="line-added">250 </span>
<span class="line-added">251     private static void waitUntilThreadsBlocked()</span>
252         throws Exception {
253         int count = 0;
254         while (count != NUM_THREADS) {
255             goSleep(100);
256             count = 0;
257             for (int i = 0; i &lt; NUM_THREADS; i++) {
258                 ThreadInfo info = mbean.getThreadInfo(threads[i].getId());
259                 if (info.getThreadState() == Thread.State.WAITING) {
260                     count++;
261                 }
262             }
263         }
264     }
265 
266     public static void doit() {
267         String tmp = &quot;&quot;;
268         long hashCode = 0;
269         for (int counter = 0; counter &lt; 1000; counter++) {
270             tmp += counter;
271             hashCode = tmp.hashCode();
272         }
273         System.out.println(Thread.currentThread().getName() +
274                            &quot; hashcode: &quot; + hashCode);
275     }
276 
277     static class MyThread extends Thread {
278         public MyThread(String name) {
279             super(name);
280         }
281 
282         public void run() {
283             ThreadAllocatedMemory.doit();
284 
285             synchronized (obj) {
286                 while (!done) {
287                     try {
288                         obj.wait();
289                     } catch (InterruptedException e) {
290                         System.out.println(&quot;Unexpected exception is thrown.&quot;);
291                         e.printStackTrace(System.out);
<a name="23" id="anc23"></a>
292                         break;
293                     }
294                 }
295             }
296 
297             long size1 = mbean.getThreadAllocatedBytes(getId());
298             ThreadAllocatedMemory.doit();
299             long size2 = mbean.getThreadAllocatedBytes(getId());
300 
301             System.out.println(getName() + &quot;: &quot; +
302                 &quot;ThreadAllocatedBytes  = &quot; + size1 +
303                 &quot; ThreadAllocatedBytes  = &quot; + size2);
304 
305             if (size1 &gt; size2) {
<a name="24" id="anc24"></a><span class="line-modified">306                 throw new RuntimeException(getName() +</span>
307                     &quot; ThreadAllocatedBytes = &quot; + size1 +
308                     &quot; &gt; ThreadAllocatedBytes = &quot; + size2);
309             }
310 
311             synchronized (obj) {
312                 while (!done1) {
313                     try {
314                         obj.wait();
315                     } catch (InterruptedException e) {
316                         System.out.println(&quot;Unexpected exception is thrown.&quot;);
317                         e.printStackTrace(System.out);
<a name="25" id="anc25"></a>
318                         break;
319                     }
320                 }
321             }
322         }
323     }
324 }
<a name="26" id="anc26"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="26" type="hidden" />
</body>
</html>