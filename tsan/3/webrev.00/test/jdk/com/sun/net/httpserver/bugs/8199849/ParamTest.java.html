<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New test/jdk/com/sun/net/httpserver/bugs/8199849/ParamTest.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 import java.io.*;
 25 import java.net.*;
 26 import java.net.http.HttpClient;
 27 import java.net.http.HttpRequest;
 28 import java.net.http.HttpResponse;
 29 import java.util.*;
 30 import java.nio.charset.StandardCharsets;
 31 import jdk.test.lib.net.URIBuilder;
 32 
 33 /**
 34  * @test
 35  * @bug 8199849 8235976
 36  * @summary
 37  * @library /test/lib
 38  * @run main/othervm ParamTest
 39  * @run main/othervm -Djava.net.preferIPv6Addresses=true ParamTest
 40  */
 41 
 42 public class ParamTest {
 43 
 44     static final String[] variants = {
 45         &quot; ,charset=utf-8&quot;,
 46         &quot; ,charset=UtF-8&quot;,
 47         &quot; ,charset=\&quot;utF-8\&quot;&quot;,
 48         &quot; ,charset=\&quot;UtF-8\&quot;&quot;
 49     };
 50 
 51     static final int LOOPS = variants.length;
 52 
 53     volatile static boolean error = false;
 54 
 55     static class BasicServer extends Thread {
 56 
 57         final ServerSocket server;
 58 
 59         Socket s;
 60         InputStream is;
 61         OutputStream os;
 62 
 63         static final String realm = &quot;wallyworld&quot;;
 64 
 65         String reply1 = &quot;HTTP/1.1 401 Unauthorized\r\n&quot;+
 66             &quot;WWW-Authenticate: Basic realm=\&quot;&quot;+realm+&quot;\&quot;\r\n&quot;;
 67 
 68         String reply2 = &quot;HTTP/1.1 200 OK\r\n&quot;+
 69             &quot;Date: Mon, 15 Jan 2001 12:18:21 GMT\r\n&quot; +
 70             &quot;Server: Apache/1.3.14 (Unix)\r\n&quot; +
 71             &quot;Connection: close\r\n&quot; +
 72             &quot;Content-Type: text/html; charset=iso-8859-1\r\n&quot; +
 73             &quot;Content-Length: 10\r\n\r\n&quot;;
 74 
 75         BasicServer(ServerSocket s) {
 76             server = s;
 77         }
 78 
 79         String readHeaders(Socket sock) throws IOException {
 80             InputStream is = sock.getInputStream();
 81             String s = &quot;&quot;;
 82             byte[] buf = new byte[1024];
 83             while (!s.endsWith(&quot;\r\n\r\n&quot;)) {
 84                 int c = is.read(buf);
 85                 if (c == -1)
 86                     return s;
 87                 String f = new String(buf, 0, c, StandardCharsets.ISO_8859_1);
 88                 s = s + f;
 89             }
 90             return s;
 91         }
 92 
 93         void check(String s, int iteration) {
 94             if (s.indexOf(encodedAuthString) == -1) {
 95                 System.err.printf(&quot;On iteration %d, wrong auth string received %s\n&quot;, iteration, s);
 96                 error = true;
 97             } else {
 98                 System.err.println(&quot;check: correct auth string received&quot;);
 99             }
100         }
101 
102         public void run() {
103             try {
104                 for (int j = 0; j &lt; 2; j++)
105                     for (int i = 0; i &lt; LOOPS; i++) {
106                         System.out.println(&quot;Server 1: accept&quot;);
107                         s = server.accept();
108                         readHeaders(s);
109                         System.out.println(&quot;accepted&quot;);
110                         os = s.getOutputStream();
111                         String str = reply1 + variants[i] + &quot;\r\n\r\n&quot;;
112                         os.write(str.getBytes());
113 
114                         System.out.println(&quot;Server 2: accept&quot;);
115                         Socket s1 = server.accept();
116                         String request = readHeaders(s1);
117                         check(request, i);
118                         System.out.println(&quot;accepted&quot;);
119                         os = s1.getOutputStream();
120                         os.write((reply2 + &quot;HelloWorld&quot;).getBytes());
121                         os.flush();
122                         s.close();
123                         s1.close();
124                         finished();
125                     }
126             } catch (Exception e) {
127                 System.out.println(e);
128                 error = true;
129             }
130         }
131 
132         public synchronized void finished() {
133             notifyAll();
134         }
135 
136     }
137 
138     static final String password = &quot;Selam D\u00fcnya.&quot;;
139 
140     // &quot;user : &lt;password above&gt;&quot; encoded in UTF-8 and converted to Base 64
141 
142     static final String encodedAuthString = &quot;dXNlcjpTZWxhbSBEw7xueWEu&quot;;
143 
144     static class MyAuthenticator extends Authenticator {
145         MyAuthenticator() {
146             super();
147         }
148 
149         public PasswordAuthentication getPasswordAuthentication()
150             {
151             System.out.println(&quot;Auth called&quot;);
152             return (new PasswordAuthentication (&quot;user&quot;, password.toCharArray()));
153         }
154     }
155 
156 
157     static void read(InputStream is) throws IOException {
158         int c;
159         System.out.println(&quot;reading&quot;);
160         while ((c=is.read()) != -1) {
161             System.out.write(c);
162         }
163         System.out.println(&quot;&quot;);
164         System.out.println(&quot;finished reading&quot;);
165     }
166 
167     public static void main(String args[]) throws Exception {
168         MyAuthenticator auth = new MyAuthenticator();
169         Authenticator.setDefault(auth);
170         InetAddress loopback = InetAddress.getLoopbackAddress();
171         ServerSocket ss = new ServerSocket();
172         ss.bind(new InetSocketAddress(loopback, 0));
173         int port = ss.getLocalPort();
174         BasicServer server = new BasicServer(ss);
175         synchronized (server) {
176             server.start();
177             System.out.println(&quot;client 1&quot;);
178             String base = URIBuilder.newBuilder()
179                 .scheme(&quot;http&quot;)
180                 .loopback()
181                 .port(port)
182                 .path(&quot;/&quot;)
183                 .build()
184                 .toString();
185             URL url = new URL(base + &quot;d1/d2/d3/foo.html&quot;);
186 
187             for (int i = 0; i &lt; LOOPS; i++) {
188                 URLConnection urlc = url.openConnection(Proxy.NO_PROXY);
189                 InputStream is = urlc.getInputStream();
190                 read(is);
191                 System.out.println(&quot;Client: waiting for notify&quot;);
192                 server.wait();
193                 System.out.println(&quot;Client: continue&quot;);
194                 // check if authenticator was called once (ok) or twice (not)
195                 if (error) {
196                     System.err.println(&quot;Error old client iteration &quot; + i);
197                 }
198             }
199 
200             URI uri = url.toURI();
201             HttpClient client = HttpClient.newBuilder()
202                 .authenticator(auth)
203                 .build();
204 
205             HttpRequest request = HttpRequest
206                 .newBuilder(uri)
207                 .GET()
208                 .build();
209 
210             for (int i = 0; i &lt; LOOPS; i++) {
211                 HttpResponse&lt;Void&gt; response = client.send(request, HttpResponse.BodyHandlers.discarding());
212                 int status = response.statusCode();
213                 if (status != 200) {
214                     System.err.printf(&quot;Error new client (%d) iteration &quot;,
215                                 status, i);
216                     error = true;
217                 } else
218                     System.err.println(&quot;New client ok iteration &quot; + i);
219                 System.out.println(&quot;New Client: waiting for notify&quot;);
220                 server.wait();
221                 System.out.println(&quot;New Client: continue&quot;);
222             }
223 
224             if (error) {
225                 throw new RuntimeException(&quot;Test failed&quot;);
226             }
227         }
228     }
229 }
    </pre>
  </body>
</html>