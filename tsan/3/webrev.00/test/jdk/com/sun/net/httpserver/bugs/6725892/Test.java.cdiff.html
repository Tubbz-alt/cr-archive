<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff test/jdk/com/sun/net/httpserver/bugs/6725892/Test.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../TestLogging.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../B6339483.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/com/sun/net/httpserver/bugs/6725892/Test.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 22,11 ***</span>
<span class="line-new-header">--- 22,13 ---</span>
   */
  
  /**
   * @test
   * @bug 6725892
<span class="line-added">+  * @library /test/lib</span>
   * @run main/othervm -Dsun.net.httpserver.maxReqTime=2 Test
<span class="line-added">+  * @run main/othervm -Djava.net.preferIPv6Addresses=true -Dsun.net.httpserver.maxReqTime=2 Test</span>
   * @summary
   */
  
  import com.sun.net.httpserver.*;
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 34,111 ***</span>
  import java.util.logging.*;
  import java.io.*;
  import java.net.*;
  import javax.net.ssl.*;
  
  public class Test {
  
      static HttpServer s1;
      static int port;
      static URL url;
      static final String RESPONSE_BODY = &quot;response&quot;;
      static boolean failed = false;
  
      static class Handler implements HttpHandler {
  
<span class="line-modified">!         public void handle (HttpExchange t)</span>
              throws IOException
          {
              InputStream is = t.getRequestBody();
              InetSocketAddress rem = t.getRemoteAddress();
<span class="line-modified">!             System.out.println (&quot;Request from: &quot; + rem);</span>
              while (is.read () != -1) ;
              is.close();
              String requrl = t.getRequestURI().toString();
              OutputStream os = t.getResponseBody();
<span class="line-modified">!             t.sendResponseHeaders (200, RESPONSE_BODY.length());</span>
<span class="line-modified">!             os.write (RESPONSE_BODY.getBytes());</span>
              t.close();
          }
      }
  
<span class="line-modified">!     public static void main (String[] args) throws Exception {</span>
  
          ExecutorService exec = Executors.newCachedThreadPool();
  
          try {
<span class="line-modified">!             InetSocketAddress addr = new InetSocketAddress (0);</span>
<span class="line-modified">!             s1 = HttpServer.create (addr, 100);</span>
<span class="line-modified">!             HttpHandler h = new Handler ();</span>
<span class="line-modified">!             HttpContext c1 = s1.createContext (&quot;/&quot;, h);</span>
              s1.setExecutor(exec);
              s1.start();
  
              port = s1.getAddress().getPort();
<span class="line-modified">!             System.out.println (&quot;Server on port &quot; + port);</span>
<span class="line-modified">!             url = new URL (&quot;http://127.0.0.1:&quot;+port+&quot;/foo&quot;);</span>
              test1();
              test2();
              test3();
<span class="line-modified">!             Thread.sleep (2000);</span>
          } catch (Exception e) {
              e.printStackTrace();
<span class="line-modified">!             System.out.println (&quot;FAIL&quot;);</span>
<span class="line-modified">!             throw new RuntimeException ();</span>
          } finally {
              s1.stop(0);
<span class="line-modified">!             System.out.println (&quot;After Shutdown&quot;);</span>
              exec.shutdown();
          }
      }
  
      // open TCP connection without sending anything. Check server closes it.
  
      static void test1() throws IOException {
          failed = false;
<span class="line-modified">!         Socket s = new Socket (InetAddress.getLoopbackAddress(), port);</span>
          InputStream is = s.getInputStream();
          // server should close connection after 2 seconds. We wait up to 10
<span class="line-modified">!         s.setSoTimeout (10000);</span>
          try {
              is.read();
          } catch (SocketTimeoutException e) {
              failed = true;
          }
          s.close();
          if (failed) {
<span class="line-modified">!             System.out.println (&quot;test1: FAIL&quot;);</span>
<span class="line-modified">!             throw new RuntimeException ();</span>
          } else {
<span class="line-modified">!             System.out.println (&quot;test1: OK&quot;);</span>
          }
      }
  
      // send request and don&#39;t read response. Check server closes connection
  
      static void test2() throws IOException {
<span class="line-modified">!         HttpURLConnection urlc = (HttpURLConnection) url.openConnection();</span>
<span class="line-modified">!         urlc.setReadTimeout (20 * 1000);</span>
          InputStream is = urlc.getInputStream();
          // we won&#39;t read response and check if it times out
          // on server. If it timesout at client then there is a problem
          try {
<span class="line-modified">!             Thread.sleep (10 * 1000);</span>
              while (is.read() != -1) ;
          } catch (InterruptedException e) {
<span class="line-modified">!             System.out.println (e);</span>
<span class="line-modified">!             System.out.println (&quot;test2: FAIL&quot;);</span>
<span class="line-modified">!             throw new RuntimeException (&quot;unexpected error&quot;);</span>
          } catch (SocketTimeoutException e1) {
<span class="line-modified">!             System.out.println (e1);</span>
<span class="line-modified">!             System.out.println (&quot;test2: FAIL&quot;);</span>
<span class="line-modified">!             throw new RuntimeException (&quot;client timedout&quot;);</span>
          } finally {
              is.close();
          }
<span class="line-modified">!         System.out.println (&quot;test2: OK&quot;);</span>
      }
  
      // same as test2, but repeated with multiple connections
      // including a number of valid request/responses
  
<span class="line-new-header">--- 36,120 ---</span>
  import java.util.logging.*;
  import java.io.*;
  import java.net.*;
  import javax.net.ssl.*;
  
<span class="line-added">+ import jdk.test.lib.net.URIBuilder;</span>
<span class="line-added">+ </span>
  public class Test {
  
      static HttpServer s1;
      static int port;
      static URL url;
      static final String RESPONSE_BODY = &quot;response&quot;;
      static boolean failed = false;
  
      static class Handler implements HttpHandler {
  
<span class="line-modified">!         public void handle(HttpExchange t)</span>
              throws IOException
          {
              InputStream is = t.getRequestBody();
              InetSocketAddress rem = t.getRemoteAddress();
<span class="line-modified">!             System.out.println(&quot;Request from: &quot; + rem);</span>
              while (is.read () != -1) ;
              is.close();
              String requrl = t.getRequestURI().toString();
              OutputStream os = t.getResponseBody();
<span class="line-modified">!             t.sendResponseHeaders(200, RESPONSE_BODY.length());</span>
<span class="line-modified">!             os.write(RESPONSE_BODY.getBytes());</span>
              t.close();
          }
      }
  
<span class="line-modified">!     public static void main(String[] args) throws Exception {</span>
  
          ExecutorService exec = Executors.newCachedThreadPool();
  
<span class="line-added">+         InetAddress loopback = InetAddress.getLoopbackAddress();</span>
          try {
<span class="line-modified">!             InetSocketAddress addr = new InetSocketAddress(loopback, 0);</span>
<span class="line-modified">!             s1 = HttpServer.create(addr, 100);</span>
<span class="line-modified">!             HttpHandler h = new Handler();</span>
<span class="line-modified">!             HttpContext c1 = s1.createContext(&quot;/&quot;, h);</span>
              s1.setExecutor(exec);
              s1.start();
  
              port = s1.getAddress().getPort();
<span class="line-modified">!             System.out.println(&quot;Server on port &quot; + port);</span>
<span class="line-modified">!             url = URIBuilder.newBuilder()</span>
<span class="line-added">+                 .scheme(&quot;http&quot;)</span>
<span class="line-added">+                 .loopback()</span>
<span class="line-added">+                 .port(port)</span>
<span class="line-added">+                 .path(&quot;/foo&quot;)</span>
<span class="line-added">+                 .toURLUnchecked();</span>
<span class="line-added">+             System.out.println(&quot;URL: &quot; + url);</span>
              test1();
              test2();
              test3();
<span class="line-modified">!             Thread.sleep(2000);</span>
          } catch (Exception e) {
              e.printStackTrace();
<span class="line-modified">!             System.out.println(&quot;FAIL&quot;);</span>
<span class="line-modified">!             throw new RuntimeException();</span>
          } finally {
              s1.stop(0);
<span class="line-modified">!             System.out.println(&quot;After Shutdown&quot;);</span>
              exec.shutdown();
          }
      }
  
      // open TCP connection without sending anything. Check server closes it.
  
      static void test1() throws IOException {
          failed = false;
<span class="line-modified">!         Socket s = new Socket(InetAddress.getLoopbackAddress(), port);</span>
          InputStream is = s.getInputStream();
          // server should close connection after 2 seconds. We wait up to 10
<span class="line-modified">!         s.setSoTimeout(10000);</span>
          try {
              is.read();
          } catch (SocketTimeoutException e) {
              failed = true;
          }
          s.close();
          if (failed) {
<span class="line-modified">!             System.out.println(&quot;test1: FAIL&quot;);</span>
<span class="line-modified">!             throw new RuntimeException();</span>
          } else {
<span class="line-modified">!             System.out.println(&quot;test1: OK&quot;);</span>
          }
      }
  
      // send request and don&#39;t read response. Check server closes connection
  
      static void test2() throws IOException {
<span class="line-modified">!         HttpURLConnection urlc = (HttpURLConnection) url.openConnection(Proxy.NO_PROXY);</span>
<span class="line-modified">!         urlc.setReadTimeout(20 * 1000);</span>
          InputStream is = urlc.getInputStream();
          // we won&#39;t read response and check if it times out
          // on server. If it timesout at client then there is a problem
          try {
<span class="line-modified">!             Thread.sleep(10 * 1000);</span>
              while (is.read() != -1) ;
          } catch (InterruptedException e) {
<span class="line-modified">!             System.out.println(e);</span>
<span class="line-modified">!             System.out.println(&quot;test2: FAIL&quot;);</span>
<span class="line-modified">!             throw new RuntimeException(&quot;unexpected error&quot;);</span>
          } catch (SocketTimeoutException e1) {
<span class="line-modified">!             System.out.println(e1);</span>
<span class="line-modified">!             System.out.println(&quot;test2: FAIL&quot;);</span>
<span class="line-modified">!             throw new RuntimeException(&quot;client timedout&quot;);</span>
          } finally {
              is.close();
          }
<span class="line-modified">!         System.out.println(&quot;test2: OK&quot;);</span>
      }
  
      // same as test2, but repeated with multiple connections
      // including a number of valid request/responses
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 163,55 ***</span>
              this.latch = latch;
              this.mode = mode;
          }
  
          void fail(String msg) {
<span class="line-modified">!             System.out.println (msg);</span>
              failed = true;
          }
  
<span class="line-modified">!         public void run () {</span>
              HttpURLConnection urlc;
              InputStream is = null;
  
              try {
<span class="line-modified">!                 urlc = (HttpURLConnection) url.openConnection();</span>
<span class="line-modified">!                 urlc.setReadTimeout (20 * 1000);</span>
                  urlc.setDoOutput(true);
              } catch (IOException e) {
                  fail(&quot;Worker: failed to connect to server&quot;);
                  latch.countDown();
                  return;
              }
              try {
                  OutputStream os = urlc.getOutputStream();
<span class="line-modified">!                 os.write (&quot;foo&quot;.getBytes());</span>
                  if (mode == Mode.REQUEST) {
<span class="line-modified">!                     Thread.sleep (3000);</span>
                  }
                  os.close();
                  is = urlc.getInputStream();
                  if (mode == Mode.RESPONSE) {
<span class="line-modified">!                     Thread.sleep (3000);</span>
                  }
<span class="line-modified">!                 if (!checkResponse (is, RESPONSE_BODY)) {</span>
<span class="line-modified">!                     fail (&quot;Worker: response&quot;);</span>
                  }
                  is.close();
                  return;
              } catch (InterruptedException e0) {
                  fail(&quot;Worker: timedout&quot;);
              } catch (SocketTimeoutException e1) {
                  fail(&quot;Worker: timedout&quot;);
              } catch (IOException e2) {
                  switch (mode) {
                    case NORMAL:
<span class="line-modified">!                     fail (&quot;Worker: &quot; + e2.getMessage());</span>
                      break;
                    case RESPONSE:
                      if (is == null) {
<span class="line-modified">!                         fail (&quot;Worker: &quot; + e2.getMessage());</span>
                          break;
                      }
                    // default: is ok
                  }
              } finally {
<span class="line-new-header">--- 174,55 ---</span>
              this.latch = latch;
              this.mode = mode;
          }
  
          void fail(String msg) {
<span class="line-modified">!             System.out.println(msg);</span>
              failed = true;
          }
  
<span class="line-modified">!         public void run() {</span>
              HttpURLConnection urlc;
              InputStream is = null;
  
              try {
<span class="line-modified">!                 urlc = (HttpURLConnection) url.openConnection(Proxy.NO_PROXY);</span>
<span class="line-modified">!                 urlc.setReadTimeout(20 * 1000);</span>
                  urlc.setDoOutput(true);
              } catch (IOException e) {
                  fail(&quot;Worker: failed to connect to server&quot;);
                  latch.countDown();
                  return;
              }
              try {
                  OutputStream os = urlc.getOutputStream();
<span class="line-modified">!                 os.write(&quot;foo&quot;.getBytes());</span>
                  if (mode == Mode.REQUEST) {
<span class="line-modified">!                     Thread.sleep(3000);</span>
                  }
                  os.close();
                  is = urlc.getInputStream();
                  if (mode == Mode.RESPONSE) {
<span class="line-modified">!                     Thread.sleep(3000);</span>
                  }
<span class="line-modified">!                 if (!checkResponse(is, RESPONSE_BODY)) {</span>
<span class="line-modified">!                     fail(&quot;Worker: response&quot;);</span>
                  }
                  is.close();
                  return;
              } catch (InterruptedException e0) {
                  fail(&quot;Worker: timedout&quot;);
              } catch (SocketTimeoutException e1) {
                  fail(&quot;Worker: timedout&quot;);
              } catch (IOException e2) {
                  switch (mode) {
                    case NORMAL:
<span class="line-modified">!                     fail(&quot;Worker: &quot; + e2.getMessage());</span>
                      break;
                    case RESPONSE:
                      if (is == null) {
<span class="line-modified">!                         fail(&quot;Worker: &quot; + e2.getMessage());</span>
                          break;
                      }
                    // default: is ok
                  }
              } finally {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 222,45 ***</span>
  
      static final int NUM = 20;
  
      static void test3() throws Exception {
          failed = false;
<span class="line-modified">!         CountDownLatch l = new CountDownLatch (NUM*3);</span>
          Worker[] workers = new Worker[NUM*3];
          for (int i=0; i&lt;NUM; i++) {
<span class="line-modified">!             workers[i*3] = new Worker (l, Worker.Mode.NORMAL);</span>
<span class="line-modified">!             workers[i*3+1] = new Worker (l, Worker.Mode.REQUEST);</span>
<span class="line-modified">!             workers[i*3+2] = new Worker (l, Worker.Mode.RESPONSE);</span>
              workers[i*3].start();
              workers[i*3+1].start();
              workers[i*3+2].start();
          }
          l.await();
          for (int i=0; i&lt;NUM*3; i++) {
              workers[i].join();
          }
          if (failed) {
<span class="line-modified">!             throw new RuntimeException (&quot;test3: failed&quot;);</span>
          }
<span class="line-modified">!         System.out.println (&quot;test3: OK&quot;);</span>
      }
  
<span class="line-modified">!     static boolean checkResponse (InputStream is, String resp) {</span>
          try {
              ByteArrayOutputStream bos = new ByteArrayOutputStream();
<span class="line-modified">!             byte[] buf = new byte [64];</span>
              int c;
              while ((c=is.read(buf)) != -1) {
<span class="line-modified">!                 bos.write (buf, 0, c);</span>
              }
              bos.close();
              if (!bos.toString().equals(resp)) {
<span class="line-modified">!                 System.out.println (&quot;Wrong response: &quot; + bos.toString());</span>
                  return false;
              }
          } catch (IOException e) {
<span class="line-modified">!             System.out.println (e);</span>
              return false;
          }
          return true;
      }
  }
<span class="line-new-header">--- 233,45 ---</span>
  
      static final int NUM = 20;
  
      static void test3() throws Exception {
          failed = false;
<span class="line-modified">!         CountDownLatch l = new CountDownLatch(NUM*3);</span>
          Worker[] workers = new Worker[NUM*3];
          for (int i=0; i&lt;NUM; i++) {
<span class="line-modified">!             workers[i*3] = new Worker(l, Worker.Mode.NORMAL);</span>
<span class="line-modified">!             workers[i*3+1] = new Worker(l, Worker.Mode.REQUEST);</span>
<span class="line-modified">!             workers[i*3+2] = new Worker(l, Worker.Mode.RESPONSE);</span>
              workers[i*3].start();
              workers[i*3+1].start();
              workers[i*3+2].start();
          }
          l.await();
          for (int i=0; i&lt;NUM*3; i++) {
              workers[i].join();
          }
          if (failed) {
<span class="line-modified">!             throw new RuntimeException(&quot;test3: failed&quot;);</span>
          }
<span class="line-modified">!         System.out.println(&quot;test3: OK&quot;);</span>
      }
  
<span class="line-modified">!     static boolean checkResponse(InputStream is, String resp) {</span>
          try {
              ByteArrayOutputStream bos = new ByteArrayOutputStream();
<span class="line-modified">!             byte[] buf = new byte[64];</span>
              int c;
              while ((c=is.read(buf)) != -1) {
<span class="line-modified">!                 bos.write(buf, 0, c);</span>
              }
              bos.close();
              if (!bos.toString().equals(resp)) {
<span class="line-modified">!                 System.out.println(&quot;Wrong response: &quot; + bos.toString());</span>
                  return false;
              }
          } catch (IOException e) {
<span class="line-modified">!             System.out.println(e);</span>
              return false;
          }
          return true;
      }
  }
</pre>
<center><a href="../../TestLogging.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../B6339483.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>