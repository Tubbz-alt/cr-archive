<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/com/sun/net/httpserver/bugs/B6373555.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="B6361557.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="B6393710.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/com/sun/net/httpserver/bugs/B6373555.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2006, 2011, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /**
 25  * @test
 26  * @bug 6373555

 27  * @summary HTTP Server failing to answer client requests


 28  */
 29 
 30 import java.net.*;
 31 import java.io.*;
 32 import java.util.*;
 33 import com.sun.net.httpserver.*;
 34 import java.util.concurrent.*;

 35 
 36 public class B6373555 {
 37 
 38     private static int s_received = 0;
 39     private static int sent = 0;
 40 
 41     private static int received = 0;
 42     private static int port;
 43 
 44     private static volatile boolean error = false;
 45     static HttpServer httpServer;
 46     static ExecutorService pool, execs;
 47     static int NUM = 1000;
 48 
 49     public static void main(String[] args) throws Exception {
 50         try {
 51             if (args.length &gt; 0) {
 52                 NUM = Integer.parseInt (args[0]);
 53             }
 54             execs = Executors.newFixedThreadPool(5);
</pre>
<hr />
<pre>
 79             httpServer.stop(0);
 80             pool.shutdownNow();
 81             execs.shutdownNow();
 82         }
 83     }
 84 
 85     public static class Client implements Runnable {
 86 
 87         byte[] getBuf () {
 88             byte[] buf = new byte [5200];
 89             for (int i=0; i&lt; 5200; i++) {
 90                 buf [i] = (byte)i;
 91             }
 92             return buf;
 93         }
 94 
 95         public void run() {
 96             try {
 97                 Thread.sleep(10);
 98                 byte[] buf = getBuf();
<span class="line-modified"> 99                 URL url = new URL(&quot;http://127.0.0.1:&quot;+port+&quot;/test&quot;);</span>
<span class="line-modified">100                 HttpURLConnection con = (HttpURLConnection)url.openConnection();</span>






101                 con.setDoOutput(true);
102                 con.setDoInput(true);
103                 con.setRequestMethod(&quot;POST&quot;);
104                 con.setRequestProperty(
105                     &quot;Content-Type&quot;,
106                     &quot;Multipart/Related; type=\&quot;application/xop+xml\&quot;; boundary=\&quot;----=_Part_0_6251267.1128549570165\&quot;; start-info=\&quot;text/xml\&quot;&quot;);
107                 OutputStream out = con.getOutputStream();
108                 out.write(buf);
109                 out.close();
110                 InputStream in = con.getInputStream();
111                 byte[] newBuf = readFully(in);
112                 in.close();
113                 if (buf.length != newBuf.length) {
114                     System.out.println(&quot;Doesn&#39;t match&quot;);
115                     error = true;
116                 }
117             }
118             catch(Exception e) {
119                 e.printStackTrace();
120                 System.out.print (&quot;.&quot;);
</pre>
<hr />
<pre>
123         }
124     }
125 
126     private static byte[] readFully(InputStream istream) throws IOException {
127         ByteArrayOutputStream bout = new ByteArrayOutputStream();
128         byte[] buf = new byte[1024];
129         int num = 0;
130 
131         if (istream != null) {
132             while ((num = istream.read(buf)) != -1) {
133                 bout.write(buf, 0, num);
134             }
135         }
136         byte[] ret = bout.toByteArray();
137         return ret;
138     }
139 
140 
141     private static HttpServer createHttpServer(ExecutorService execs)
142         throws Exception {
<span class="line-modified">143         InetSocketAddress inetAddress = new InetSocketAddress(0);</span>

144         HttpServer testServer = HttpServer.create(inetAddress, 15);
145         testServer.setExecutor(execs);
146         HttpContext context = testServer.createContext(&quot;/test&quot;);
147         context.setHandler(new HttpHandler() {
148             public void handle(HttpExchange msg) {
149                 try {
150                     String method = msg.getRequestMethod();
151                         if (method.equals(&quot;POST&quot;)) {
152                         InputStream is = msg.getRequestBody();
153                             byte[] buf = readFully(is);
154                             is.close();
155                             writePostReply(msg, buf);
156                     } else {
157                         System.out.println(&quot;****** METHOD not handled ***** &quot;+method);
158                             System.out.println(&quot;Received=&quot;+s_received);
159                     }
160                 }
161                 catch(Exception e) {
162                     e.printStackTrace();
163                 }
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2006, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /**
 25  * @test
 26  * @bug 6373555
<span class="line-added"> 27  * @library /test/lib</span>
 28  * @summary HTTP Server failing to answer client requests
<span class="line-added"> 29  * @run main B6373555</span>
<span class="line-added"> 30  * @run main/othervm -Djava.net.preferIPv6Addresses=true B6373555</span>
 31  */
 32 
 33 import java.net.*;
 34 import java.io.*;
 35 import java.util.*;
 36 import com.sun.net.httpserver.*;
 37 import java.util.concurrent.*;
<span class="line-added"> 38 import jdk.test.lib.net.URIBuilder;</span>
 39 
 40 public class B6373555 {
 41 
 42     private static int s_received = 0;
 43     private static int sent = 0;
 44 
 45     private static int received = 0;
 46     private static int port;
 47 
 48     private static volatile boolean error = false;
 49     static HttpServer httpServer;
 50     static ExecutorService pool, execs;
 51     static int NUM = 1000;
 52 
 53     public static void main(String[] args) throws Exception {
 54         try {
 55             if (args.length &gt; 0) {
 56                 NUM = Integer.parseInt (args[0]);
 57             }
 58             execs = Executors.newFixedThreadPool(5);
</pre>
<hr />
<pre>
 83             httpServer.stop(0);
 84             pool.shutdownNow();
 85             execs.shutdownNow();
 86         }
 87     }
 88 
 89     public static class Client implements Runnable {
 90 
 91         byte[] getBuf () {
 92             byte[] buf = new byte [5200];
 93             for (int i=0; i&lt; 5200; i++) {
 94                 buf [i] = (byte)i;
 95             }
 96             return buf;
 97         }
 98 
 99         public void run() {
100             try {
101                 Thread.sleep(10);
102                 byte[] buf = getBuf();
<span class="line-modified">103                 URL url = URIBuilder.newBuilder()</span>
<span class="line-modified">104                     .scheme(&quot;http&quot;)</span>
<span class="line-added">105                     .loopback()</span>
<span class="line-added">106                     .port(port)</span>
<span class="line-added">107                     .path(&quot;/test&quot;)</span>
<span class="line-added">108                     .toURLUnchecked();</span>
<span class="line-added">109                 System.out.println(&quot;URL: &quot; + url);</span>
<span class="line-added">110                 HttpURLConnection con = (HttpURLConnection)url.openConnection(Proxy.NO_PROXY);</span>
111                 con.setDoOutput(true);
112                 con.setDoInput(true);
113                 con.setRequestMethod(&quot;POST&quot;);
114                 con.setRequestProperty(
115                     &quot;Content-Type&quot;,
116                     &quot;Multipart/Related; type=\&quot;application/xop+xml\&quot;; boundary=\&quot;----=_Part_0_6251267.1128549570165\&quot;; start-info=\&quot;text/xml\&quot;&quot;);
117                 OutputStream out = con.getOutputStream();
118                 out.write(buf);
119                 out.close();
120                 InputStream in = con.getInputStream();
121                 byte[] newBuf = readFully(in);
122                 in.close();
123                 if (buf.length != newBuf.length) {
124                     System.out.println(&quot;Doesn&#39;t match&quot;);
125                     error = true;
126                 }
127             }
128             catch(Exception e) {
129                 e.printStackTrace();
130                 System.out.print (&quot;.&quot;);
</pre>
<hr />
<pre>
133         }
134     }
135 
136     private static byte[] readFully(InputStream istream) throws IOException {
137         ByteArrayOutputStream bout = new ByteArrayOutputStream();
138         byte[] buf = new byte[1024];
139         int num = 0;
140 
141         if (istream != null) {
142             while ((num = istream.read(buf)) != -1) {
143                 bout.write(buf, 0, num);
144             }
145         }
146         byte[] ret = bout.toByteArray();
147         return ret;
148     }
149 
150 
151     private static HttpServer createHttpServer(ExecutorService execs)
152         throws Exception {
<span class="line-modified">153         InetAddress loopback = InetAddress.getLoopbackAddress();</span>
<span class="line-added">154         InetSocketAddress inetAddress = new InetSocketAddress(loopback, 0);</span>
155         HttpServer testServer = HttpServer.create(inetAddress, 15);
156         testServer.setExecutor(execs);
157         HttpContext context = testServer.createContext(&quot;/test&quot;);
158         context.setHandler(new HttpHandler() {
159             public void handle(HttpExchange msg) {
160                 try {
161                     String method = msg.getRequestMethod();
162                         if (method.equals(&quot;POST&quot;)) {
163                         InputStream is = msg.getRequestBody();
164                             byte[] buf = readFully(is);
165                             is.close();
166                             writePostReply(msg, buf);
167                     } else {
168                         System.out.println(&quot;****** METHOD not handled ***** &quot;+method);
169                             System.out.println(&quot;Received=&quot;+s_received);
170                     }
171                 }
172                 catch(Exception e) {
173                     e.printStackTrace();
174                 }
</pre>
</td>
</tr>
</table>
<center><a href="B6361557.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="B6393710.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>