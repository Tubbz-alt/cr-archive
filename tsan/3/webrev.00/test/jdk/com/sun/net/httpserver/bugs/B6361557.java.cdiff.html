<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff test/jdk/com/sun/net/httpserver/bugs/B6361557.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="B6341616.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="B6373555.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/com/sun/net/httpserver/bugs/B6361557.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 67,44 ***</span>
      final static String request = &quot;GET /test/foo.html HTTP/1.1\r\nContent-length: 0\r\n\r\n&quot;;
      final static ByteBuffer requestBuf = ByteBuffer.allocate(64).put(request.getBytes());
  
      public static void main (String[] args) throws Exception {
          Handler handler = new Handler();
<span class="line-modified">!         InetSocketAddress addr = new InetSocketAddress (0);</span>
          HttpServer server = HttpServer.create (addr, 0);
          HttpContext ctx = server.createContext (&quot;/test&quot;, handler);
  
          ExecutorService executor = Executors.newCachedThreadPool();
          server.setExecutor (executor);
          server.start ();
  
          InetSocketAddress destaddr = new InetSocketAddress (
<span class="line-modified">!                 InetAddress.getLoopbackAddress(), server.getAddress().getPort()</span>
          );
          System.out.println (&quot;destaddr &quot; + destaddr);
  
          Selector selector = Selector.open ();
          int requests = 0;
          int responses = 0;
          while (true) {
<span class="line-modified">!             int selres = selector.select (1);</span>
              Set&lt;SelectionKey&gt; selkeys = selector.selectedKeys();
              for (SelectionKey key : selkeys) {
                  if (key.isReadable()) {
                      SocketChannel chan = (SocketChannel)key.channel();
                      ByteBuffer buf = (ByteBuffer)key.attachment();
                      try {
                          int x = chan.read(buf);
                          if (x == -1 || responseComplete(buf)) {
                              key.attach(null);
                              chan.close();
                              responses++;
                          }
<span class="line-modified">!                     } catch (IOException e) {}</span>
                  }
              }
              if (requests &lt; NUM) {
                  SocketChannel schan = SocketChannel.open(destaddr);
                  requestBuf.rewind();
                  int c = 0;
                  while (requestBuf.remaining() &gt; 0) {
                      c += schan.write(requestBuf);
<span class="line-new-header">--- 67,52 ---</span>
      final static String request = &quot;GET /test/foo.html HTTP/1.1\r\nContent-length: 0\r\n\r\n&quot;;
      final static ByteBuffer requestBuf = ByteBuffer.allocate(64).put(request.getBytes());
  
      public static void main (String[] args) throws Exception {
          Handler handler = new Handler();
<span class="line-modified">!         InetAddress loopback = InetAddress.getLoopbackAddress();</span>
<span class="line-added">+         InetSocketAddress addr = new InetSocketAddress (loopback, 0);</span>
          HttpServer server = HttpServer.create (addr, 0);
          HttpContext ctx = server.createContext (&quot;/test&quot;, handler);
  
          ExecutorService executor = Executors.newCachedThreadPool();
          server.setExecutor (executor);
          server.start ();
  
          InetSocketAddress destaddr = new InetSocketAddress (
<span class="line-modified">!                 loopback, server.getAddress().getPort()</span>
          );
          System.out.println (&quot;destaddr &quot; + destaddr);
  
          Selector selector = Selector.open ();
          int requests = 0;
          int responses = 0;
          while (true) {
<span class="line-modified">!             // we need to read responses from time to time: slightly</span>
<span class="line-added">+             // increase the timeout with the amount of pending responses</span>
<span class="line-added">+             // to give a chance to the server to reply.</span>
<span class="line-added">+             int selres = selector.select (requests - responses + 1);</span>
              Set&lt;SelectionKey&gt; selkeys = selector.selectedKeys();
              for (SelectionKey key : selkeys) {
                  if (key.isReadable()) {
                      SocketChannel chan = (SocketChannel)key.channel();
                      ByteBuffer buf = (ByteBuffer)key.attachment();
                      try {
                          int x = chan.read(buf);
                          if (x == -1 || responseComplete(buf)) {
<span class="line-added">+                             System.out.print(&quot;_&quot;);</span>
                              key.attach(null);
                              chan.close();
                              responses++;
                          }
<span class="line-modified">!                     } catch (IOException e) {</span>
<span class="line-added">+                         System.out.println(e);</span>
<span class="line-added">+                     }</span>
                  }
              }
              if (requests &lt; NUM) {
<span class="line-added">+                 System.out.print(&quot;.&quot;);</span>
                  SocketChannel schan = SocketChannel.open(destaddr);
                  requestBuf.rewind();
                  int c = 0;
                  while (requestBuf.remaining() &gt; 0) {
                      c += schan.write(requestBuf);
</pre>
<center><a href="B6341616.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="B6373555.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>