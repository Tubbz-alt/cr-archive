<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/jdk/com/sun/jdi/BadHandshakeTest.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="../java/swing/plaf/gtk/Test6963870.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="ExceptionEvents.java.udiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/com/sun/jdi/BadHandshakeTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2005, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2005, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -19,10 +19,11 @@</span>
   * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
   * or visit www.oracle.com if you need additional information or have any
   * questions.
   */
  
<span class="udiff-line-added">+ import java.net.ConnectException;</span>
  import java.net.Socket;
  
  import com.sun.jdi.Bootstrap;
  import com.sun.jdi.VirtualMachine;
  import com.sun.jdi.event.*;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -32,23 +33,21 @@</span>
  
  import java.util.Map;
  import java.util.List;
  import java.util.Iterator;
  import java.util.concurrent.TimeUnit;
<span class="udiff-line-removed">- import java.util.concurrent.atomic.AtomicBoolean;</span>
  
<span class="udiff-line-modified-removed">- import jdk.test.lib.Utils;</span>
<span class="udiff-line-removed">- import jdk.test.lib.process.ProcessTools;</span>
<span class="udiff-line-modified-added">+ import lib.jdb.Debuggee;</span>
  
  /* @test
   * @bug 6306165 6432567
   * @summary Check that a bad handshake doesn&#39;t cause a debuggee to abort
   * @library /test/lib
   *
   * @modules java.management
   *          jdk.jdi
<span class="udiff-line-modified-removed">-  * @build VMConnection BadHandshakeTest Exit0</span>
<span class="udiff-line-modified-added">+  * @build BadHandshakeTest Exit0</span>
   * @run driver BadHandshakeTest
   */
  public class BadHandshakeTest {
  
      /*
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -56,131 +55,86 @@</span>
       */
      private static Connector findConnector(String name) {
          List&lt;Connector&gt; connectors = Bootstrap.virtualMachineManager().allConnectors();
          Iterator&lt;Connector&gt; iter = connectors.iterator();
          while (iter.hasNext()) {
<span class="udiff-line-modified-removed">-             Connector connector = (Connector)iter.next();</span>
<span class="udiff-line-modified-added">+             Connector connector = iter.next();</span>
              if (connector.name().equals(name)) {
                  return connector;
              }
          }
          return null;
      }
  
<span class="udiff-line-modified-removed">-     /*</span>
<span class="udiff-line-modified-removed">-      * Launch a server debuggee with the given address</span>
<span class="udiff-line-removed">-      */</span>
<span class="udiff-line-removed">-     private static LaunchResult launch(String address, String class_name) throws Exception {</span>
<span class="udiff-line-removed">-         String[] args = VMConnection.insertDebuggeeVMOptions(new String[] {</span>
<span class="udiff-line-removed">-             &quot;-agentlib:jdwp=transport=dt_socket&quot; +</span>
<span class="udiff-line-removed">-             &quot;,server=y&quot; + &quot;,suspend=y&quot; + &quot;,address=&quot; + address,</span>
<span class="udiff-line-removed">-             class_name</span>
<span class="udiff-line-removed">-         });</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         ProcessBuilder pb = ProcessTools.createJavaProcessBuilder(args);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         final AtomicBoolean success = new AtomicBoolean();</span>
<span class="udiff-line-removed">-         final AtomicBoolean bindFailed = new AtomicBoolean();</span>
<span class="udiff-line-removed">-         Process p = ProcessTools.startProcess(</span>
<span class="udiff-line-removed">-             class_name,</span>
<span class="udiff-line-removed">-             pb,</span>
<span class="udiff-line-removed">-             (line) -&gt; {</span>
<span class="udiff-line-removed">-                 // &#39;Listening for transport dt_socket at address: xxxxx&#39;</span>
<span class="udiff-line-removed">-                 // indicates the debuggee is ready to accept connections</span>
<span class="udiff-line-removed">-                 if (line.contains(&quot;Listening for transport dt_socket at address:&quot;)) {</span>
<span class="udiff-line-removed">-                     success.set(true);</span>
<span class="udiff-line-removed">-                     return true;</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-                 // &#39;Address already in use&#39; indicates</span>
<span class="udiff-line-removed">-                 // the debuggee has failed to start due to busy port.</span>
<span class="udiff-line-removed">-                 if (line.contains(&quot;Address already in use&quot;)) {</span>
<span class="udiff-line-removed">-                     bindFailed.set(true);</span>
<span class="udiff-line-removed">-                     return true;</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-                 return false;</span>
<span class="udiff-line-removed">-             },</span>
<span class="udiff-line-removed">-             Integer.MAX_VALUE,</span>
<span class="udiff-line-removed">-             TimeUnit.MILLISECONDS</span>
<span class="udiff-line-removed">-         );</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         return new LaunchResult(success.get() ? p : null,</span>
<span class="udiff-line-removed">-                 bindFailed.get());</span>
<span class="udiff-line-modified-added">+     private static void log(Object s) {</span>
<span class="udiff-line-modified-added">+         System.out.println(String.valueOf(s));</span>
      }
  
<span class="udiff-line-removed">-     /*</span>
<span class="udiff-line-removed">-      * - pick a TCP port</span>
<span class="udiff-line-removed">-      * - Launch a server debuggee: server=y,suspend=y,address=${port}</span>
<span class="udiff-line-removed">-      * - run it to VM death</span>
<span class="udiff-line-removed">-      * - verify we saw no error</span>
<span class="udiff-line-removed">-      */</span>
      public static void main(String args[]) throws Exception {
<span class="udiff-line-modified-removed">-         // Launch the server debuggee</span>
<span class="udiff-line-modified-removed">-         int port = 0;</span>
<span class="udiff-line-modified-removed">-         Process process = null;</span>
<span class="udiff-line-modified-removed">-         while (process == null) {</span>
<span class="udiff-line-modified-removed">-             port = Utils.getFreePort();</span>
<span class="udiff-line-modified-removed">-             String address = String.valueOf(port);</span>
<span class="udiff-line-modified-removed">-             LaunchResult launchResult = launch(address, &quot;Exit0&quot;);</span>
<span class="udiff-line-modified-removed">-             process = launchResult.getProcess();</span>
<span class="udiff-line-modified-removed">-             if (launchResult.isBindFailed()) {</span>
<span class="udiff-line-modified-removed">-                 System.out.println(&quot;Port &quot; + port + &quot; already in use. Trying to restart debuggee with a new one...&quot;);</span>
<span class="udiff-line-modified-removed">-                 Thread.sleep(100);</span>
<span class="udiff-line-modified-removed">-             } else if (process == null ) {</span>
<span class="udiff-line-modified-removed">-                 throw new RuntimeException(&quot;Unable to start debugee&quot;);</span>
<span class="udiff-line-modified-added">+         // Launch the server debugee</span>
<span class="udiff-line-modified-added">+         log(&quot;Starting debuggee...&quot;);</span>
<span class="udiff-line-modified-added">+         try (Debuggee debuggee = Debuggee.launcher(&quot;Exit0&quot;).launch()) {</span>
<span class="udiff-line-modified-added">+             log(&quot;Debuggee started.&quot;);</span>
<span class="udiff-line-modified-added">+             int port = Integer.parseInt(debuggee.getAddress());</span>
<span class="udiff-line-modified-added">+             log(&quot;Debuggee port: &quot; + port);</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+             log(&quot;testcase 1...&quot;);</span>
<span class="udiff-line-modified-added">+             // Connect to the debuggee and handshake with garbage</span>
<span class="udiff-line-modified-added">+             Socket s = new Socket(&quot;localhost&quot;, port);</span>
<span class="udiff-line-modified-added">+             s.getOutputStream().write(&quot;Here&#39;s a poke in the eye&quot;.getBytes(&quot;UTF-8&quot;));</span>
<span class="udiff-line-modified-added">+             s.close();</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-added">+             log(&quot;testcase 2...&quot;);</span>
<span class="udiff-line-added">+             // Re-connect and do a partial handshake - don&#39;t disconnect</span>
<span class="udiff-line-added">+             // Re-connect just after disconnect may cause &quot;connection refused&quot; error (see JDK-8192057)</span>
<span class="udiff-line-added">+             Exception error = null;</span>
<span class="udiff-line-added">+             long retryDelay = 20;</span>
<span class="udiff-line-added">+             for (int retry = 0; retry &lt; 5; retry++) {</span>
<span class="udiff-line-added">+                 if (error != null) {</span>
<span class="udiff-line-added">+                     try {</span>
<span class="udiff-line-added">+                         Thread.sleep(retryDelay);</span>
<span class="udiff-line-added">+                     } catch (InterruptedException ex) {</span>
<span class="udiff-line-added">+                         // ignore</span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+                     retryDelay *= 2;</span>
<span class="udiff-line-added">+                     error = null;</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+                 try {</span>
<span class="udiff-line-added">+                     log(&quot;retry: &quot; + retry);</span>
<span class="udiff-line-added">+                     s = new Socket(&quot;localhost&quot;, port);</span>
<span class="udiff-line-added">+                     s.getOutputStream().write(&quot;JDWP-&quot;.getBytes(&quot;UTF-8&quot;));</span>
<span class="udiff-line-added">+                     break;</span>
<span class="udiff-line-added">+                 } catch (ConnectException ex) {</span>
<span class="udiff-line-added">+                     log(&quot;got exception: &quot; + ex.toString());</span>
<span class="udiff-line-added">+                     error = ex;</span>
<span class="udiff-line-added">+                 }</span>
              }
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-removed">-         // Connect to the debuggee and handshake with garbage</span>
<span class="udiff-line-removed">-         Socket s = new Socket(&quot;localhost&quot;, port);</span>
<span class="udiff-line-removed">-         s.getOutputStream().write(&quot;Here&#39;s a poke in the eye&quot;.getBytes(&quot;UTF-8&quot;));</span>
<span class="udiff-line-removed">-         s.close();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         // Re-connect and to a partial handshake - don&#39;t disconnect</span>
<span class="udiff-line-removed">-         s = new Socket(&quot;localhost&quot;, port);</span>
<span class="udiff-line-removed">-         s.getOutputStream().write(&quot;JDWP-&quot;.getBytes(&quot;UTF-8&quot;));</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         // Attach to server debuggee and resume it so it can exit</span>
<span class="udiff-line-removed">-         AttachingConnector conn = (AttachingConnector)findConnector(&quot;com.sun.jdi.SocketAttach&quot;);</span>
<span class="udiff-line-removed">-         Map&lt;String, Argument&gt; conn_args = conn.defaultArguments();</span>
<span class="udiff-line-removed">-         Connector.IntegerArgument port_arg =</span>
<span class="udiff-line-removed">-             (Connector.IntegerArgument)conn_args.get(&quot;port&quot;);</span>
<span class="udiff-line-removed">-         port_arg.setValue(port);</span>
<span class="udiff-line-removed">-         VirtualMachine vm = conn.attach(conn_args);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         // The first event is always a VMStartEvent, and it is always in</span>
<span class="udiff-line-removed">-         // an EventSet by itself.  Wait for it.</span>
<span class="udiff-line-removed">-         EventSet evtSet = vm.eventQueue().remove();</span>
<span class="udiff-line-removed">-         for (Event event: evtSet) {</span>
<span class="udiff-line-removed">-             if (event instanceof VMStartEvent) {</span>
<span class="udiff-line-removed">-                 break;</span>
<span class="udiff-line-modified-added">+             if (error != null) {</span>
<span class="udiff-line-modified-added">+                 throw error;</span>
              }
<span class="udiff-line-removed">-             throw new RuntimeException(&quot;Test failed - debuggee did not start properly&quot;);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         vm.eventRequestManager().deleteAllBreakpoints();</span>
<span class="udiff-line-removed">-         vm.resume();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         process.waitFor();</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private static class LaunchResult {</span>
  
<span class="udiff-line-modified-removed">-         private final Process p;</span>
<span class="udiff-line-modified-removed">-         private final boolean bindFailed;</span>
<span class="udiff-line-modified-added">+             log(&quot;cleaning...&quot;);</span>
<span class="udiff-line-modified-added">+             // Attach to server debuggee and resume it so it can exit</span>
<span class="udiff-line-added">+             AttachingConnector conn = (AttachingConnector)findConnector(&quot;com.sun.jdi.SocketAttach&quot;);</span>
<span class="udiff-line-added">+             Map&lt;String, Argument&gt; conn_args = conn.defaultArguments();</span>
<span class="udiff-line-added">+             Connector.IntegerArgument port_arg =</span>
<span class="udiff-line-added">+                     (Connector.IntegerArgument)conn_args.get(&quot;port&quot;);</span>
<span class="udiff-line-added">+             port_arg.setValue(port);</span>
<span class="udiff-line-added">+             VirtualMachine vm = conn.attach(conn_args);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // The first event is always a VMStartEvent, and it is always in</span>
<span class="udiff-line-added">+             // an EventSet by itself.  Wait for it.</span>
<span class="udiff-line-added">+             EventSet evtSet = vm.eventQueue().remove();</span>
<span class="udiff-line-added">+             for (Event event : evtSet) {</span>
<span class="udiff-line-added">+                 if (event instanceof VMStartEvent) {</span>
<span class="udiff-line-added">+                     break;</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+                 throw new RuntimeException(&quot;Test failed - debuggee did not start properly&quot;);</span>
<span class="udiff-line-added">+             }</span>
  
<span class="udiff-line-modified-removed">-         public LaunchResult(Process p, boolean bindFailed) {</span>
<span class="udiff-line-modified-removed">-             this.p = p;</span>
<span class="udiff-line-removed">-             this.bindFailed = bindFailed;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-modified-added">+             vm.eventRequestManager().deleteAllBreakpoints();</span>
<span class="udiff-line-modified-added">+             vm.resume();</span>
  
<span class="udiff-line-modified-removed">-         public Process getProcess() {</span>
<span class="udiff-line-removed">-             return p;</span>
<span class="udiff-line-modified-added">+             debuggee.waitFor(10, TimeUnit.SECONDS);</span>
          }
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         public boolean isBindFailed() {</span>
<span class="udiff-line-removed">-             return bindFailed;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
      }
<span class="udiff-line-removed">- </span>
  }
</pre>
<center><a href="../java/swing/plaf/gtk/Test6963870.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="ExceptionEvents.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>