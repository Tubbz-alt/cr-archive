<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/com/sun/jdi/BadHandshakeTest.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="../java/swing/plaf/gtk/Test6963870.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="ExceptionEvents.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/com/sun/jdi/BadHandshakeTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2005, 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 

 24 import java.net.Socket;
 25 
 26 import com.sun.jdi.Bootstrap;
 27 import com.sun.jdi.VirtualMachine;
 28 import com.sun.jdi.event.*;
 29 import com.sun.jdi.connect.Connector;
 30 import com.sun.jdi.connect.AttachingConnector;
 31 import com.sun.jdi.connect.Connector.Argument;
 32 
 33 import java.util.Map;
 34 import java.util.List;
 35 import java.util.Iterator;
 36 import java.util.concurrent.TimeUnit;
<span class="line-removed"> 37 import java.util.concurrent.atomic.AtomicBoolean;</span>
 38 
<span class="line-modified"> 39 import jdk.test.lib.Utils;</span>
<span class="line-removed"> 40 import jdk.test.lib.process.ProcessTools;</span>
 41 
 42 /* @test
 43  * @bug 6306165 6432567
 44  * @summary Check that a bad handshake doesn&#39;t cause a debuggee to abort
 45  * @library /test/lib
 46  *
 47  * @modules java.management
 48  *          jdk.jdi
<span class="line-modified"> 49  * @build VMConnection BadHandshakeTest Exit0</span>
 50  * @run driver BadHandshakeTest
 51  */
 52 public class BadHandshakeTest {
 53 
 54     /*
 55      * Find a connector by name
 56      */
 57     private static Connector findConnector(String name) {
 58         List&lt;Connector&gt; connectors = Bootstrap.virtualMachineManager().allConnectors();
 59         Iterator&lt;Connector&gt; iter = connectors.iterator();
 60         while (iter.hasNext()) {
<span class="line-modified"> 61             Connector connector = (Connector)iter.next();</span>
 62             if (connector.name().equals(name)) {
 63                 return connector;
 64             }
 65         }
 66         return null;
 67     }
 68 
<span class="line-modified"> 69     /*</span>
<span class="line-modified"> 70      * Launch a server debuggee with the given address</span>
<span class="line-removed"> 71      */</span>
<span class="line-removed"> 72     private static LaunchResult launch(String address, String class_name) throws Exception {</span>
<span class="line-removed"> 73         String[] args = VMConnection.insertDebuggeeVMOptions(new String[] {</span>
<span class="line-removed"> 74             &quot;-agentlib:jdwp=transport=dt_socket&quot; +</span>
<span class="line-removed"> 75             &quot;,server=y&quot; + &quot;,suspend=y&quot; + &quot;,address=&quot; + address,</span>
<span class="line-removed"> 76             class_name</span>
<span class="line-removed"> 77         });</span>
<span class="line-removed"> 78 </span>
<span class="line-removed"> 79         ProcessBuilder pb = ProcessTools.createJavaProcessBuilder(args);</span>
<span class="line-removed"> 80 </span>
<span class="line-removed"> 81         final AtomicBoolean success = new AtomicBoolean();</span>
<span class="line-removed"> 82         final AtomicBoolean bindFailed = new AtomicBoolean();</span>
<span class="line-removed"> 83         Process p = ProcessTools.startProcess(</span>
<span class="line-removed"> 84             class_name,</span>
<span class="line-removed"> 85             pb,</span>
<span class="line-removed"> 86             (line) -&gt; {</span>
<span class="line-removed"> 87                 // &#39;Listening for transport dt_socket at address: xxxxx&#39;</span>
<span class="line-removed"> 88                 // indicates the debuggee is ready to accept connections</span>
<span class="line-removed"> 89                 if (line.contains(&quot;Listening for transport dt_socket at address:&quot;)) {</span>
<span class="line-removed"> 90                     success.set(true);</span>
<span class="line-removed"> 91                     return true;</span>
<span class="line-removed"> 92                 }</span>
<span class="line-removed"> 93                 // &#39;Address already in use&#39; indicates</span>
<span class="line-removed"> 94                 // the debuggee has failed to start due to busy port.</span>
<span class="line-removed"> 95                 if (line.contains(&quot;Address already in use&quot;)) {</span>
<span class="line-removed"> 96                     bindFailed.set(true);</span>
<span class="line-removed"> 97                     return true;</span>
<span class="line-removed"> 98                 }</span>
<span class="line-removed"> 99                 return false;</span>
<span class="line-removed">100             },</span>
<span class="line-removed">101             Integer.MAX_VALUE,</span>
<span class="line-removed">102             TimeUnit.MILLISECONDS</span>
<span class="line-removed">103         );</span>
<span class="line-removed">104 </span>
<span class="line-removed">105         return new LaunchResult(success.get() ? p : null,</span>
<span class="line-removed">106                 bindFailed.get());</span>
107     }
108 
<span class="line-removed">109     /*</span>
<span class="line-removed">110      * - pick a TCP port</span>
<span class="line-removed">111      * - Launch a server debuggee: server=y,suspend=y,address=${port}</span>
<span class="line-removed">112      * - run it to VM death</span>
<span class="line-removed">113      * - verify we saw no error</span>
<span class="line-removed">114      */</span>
115     public static void main(String args[]) throws Exception {
<span class="line-modified">116         // Launch the server debuggee</span>
<span class="line-modified">117         int port = 0;</span>
<span class="line-modified">118         Process process = null;</span>
<span class="line-modified">119         while (process == null) {</span>
<span class="line-modified">120             port = Utils.getFreePort();</span>
<span class="line-modified">121             String address = String.valueOf(port);</span>
<span class="line-modified">122             LaunchResult launchResult = launch(address, &quot;Exit0&quot;);</span>
<span class="line-modified">123             process = launchResult.getProcess();</span>
<span class="line-modified">124             if (launchResult.isBindFailed()) {</span>
<span class="line-modified">125                 System.out.println(&quot;Port &quot; + port + &quot; already in use. Trying to restart debuggee with a new one...&quot;);</span>
<span class="line-modified">126                 Thread.sleep(100);</span>
<span class="line-modified">127             } else if (process == null ) {</span>
<span class="line-modified">128                 throw new RuntimeException(&quot;Unable to start debugee&quot;);</span>
























129             }
<span class="line-modified">130         }</span>
<span class="line-modified">131 </span>
<span class="line-removed">132         // Connect to the debuggee and handshake with garbage</span>
<span class="line-removed">133         Socket s = new Socket(&quot;localhost&quot;, port);</span>
<span class="line-removed">134         s.getOutputStream().write(&quot;Here&#39;s a poke in the eye&quot;.getBytes(&quot;UTF-8&quot;));</span>
<span class="line-removed">135         s.close();</span>
<span class="line-removed">136 </span>
<span class="line-removed">137         // Re-connect and to a partial handshake - don&#39;t disconnect</span>
<span class="line-removed">138         s = new Socket(&quot;localhost&quot;, port);</span>
<span class="line-removed">139         s.getOutputStream().write(&quot;JDWP-&quot;.getBytes(&quot;UTF-8&quot;));</span>
<span class="line-removed">140 </span>
<span class="line-removed">141 </span>
<span class="line-removed">142         // Attach to server debuggee and resume it so it can exit</span>
<span class="line-removed">143         AttachingConnector conn = (AttachingConnector)findConnector(&quot;com.sun.jdi.SocketAttach&quot;);</span>
<span class="line-removed">144         Map&lt;String, Argument&gt; conn_args = conn.defaultArguments();</span>
<span class="line-removed">145         Connector.IntegerArgument port_arg =</span>
<span class="line-removed">146             (Connector.IntegerArgument)conn_args.get(&quot;port&quot;);</span>
<span class="line-removed">147         port_arg.setValue(port);</span>
<span class="line-removed">148         VirtualMachine vm = conn.attach(conn_args);</span>
<span class="line-removed">149 </span>
<span class="line-removed">150         // The first event is always a VMStartEvent, and it is always in</span>
<span class="line-removed">151         // an EventSet by itself.  Wait for it.</span>
<span class="line-removed">152         EventSet evtSet = vm.eventQueue().remove();</span>
<span class="line-removed">153         for (Event event: evtSet) {</span>
<span class="line-removed">154             if (event instanceof VMStartEvent) {</span>
<span class="line-removed">155                 break;</span>
156             }
<span class="line-removed">157             throw new RuntimeException(&quot;Test failed - debuggee did not start properly&quot;);</span>
<span class="line-removed">158         }</span>
<span class="line-removed">159 </span>
<span class="line-removed">160         vm.eventRequestManager().deleteAllBreakpoints();</span>
<span class="line-removed">161         vm.resume();</span>
<span class="line-removed">162 </span>
<span class="line-removed">163         process.waitFor();</span>
<span class="line-removed">164     }</span>
<span class="line-removed">165 </span>
<span class="line-removed">166     private static class LaunchResult {</span>
167 
<span class="line-modified">168         private final Process p;</span>
<span class="line-modified">169         private final boolean bindFailed;</span>
















170 
<span class="line-modified">171         public LaunchResult(Process p, boolean bindFailed) {</span>
<span class="line-modified">172             this.p = p;</span>
<span class="line-removed">173             this.bindFailed = bindFailed;</span>
<span class="line-removed">174         }</span>
175 
<span class="line-modified">176         public Process getProcess() {</span>
<span class="line-removed">177             return p;</span>
178         }
<span class="line-removed">179 </span>
<span class="line-removed">180         public boolean isBindFailed() {</span>
<span class="line-removed">181             return bindFailed;</span>
<span class="line-removed">182         }</span>
<span class="line-removed">183 </span>
184     }
<span class="line-removed">185 </span>
186 }
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2005, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
<span class="line-added"> 24 import java.net.ConnectException;</span>
 25 import java.net.Socket;
 26 
 27 import com.sun.jdi.Bootstrap;
 28 import com.sun.jdi.VirtualMachine;
 29 import com.sun.jdi.event.*;
 30 import com.sun.jdi.connect.Connector;
 31 import com.sun.jdi.connect.AttachingConnector;
 32 import com.sun.jdi.connect.Connector.Argument;
 33 
 34 import java.util.Map;
 35 import java.util.List;
 36 import java.util.Iterator;
 37 import java.util.concurrent.TimeUnit;

 38 
<span class="line-modified"> 39 import lib.jdb.Debuggee;</span>

 40 
 41 /* @test
 42  * @bug 6306165 6432567
 43  * @summary Check that a bad handshake doesn&#39;t cause a debuggee to abort
 44  * @library /test/lib
 45  *
 46  * @modules java.management
 47  *          jdk.jdi
<span class="line-modified"> 48  * @build BadHandshakeTest Exit0</span>
 49  * @run driver BadHandshakeTest
 50  */
 51 public class BadHandshakeTest {
 52 
 53     /*
 54      * Find a connector by name
 55      */
 56     private static Connector findConnector(String name) {
 57         List&lt;Connector&gt; connectors = Bootstrap.virtualMachineManager().allConnectors();
 58         Iterator&lt;Connector&gt; iter = connectors.iterator();
 59         while (iter.hasNext()) {
<span class="line-modified"> 60             Connector connector = iter.next();</span>
 61             if (connector.name().equals(name)) {
 62                 return connector;
 63             }
 64         }
 65         return null;
 66     }
 67 
<span class="line-modified"> 68     private static void log(Object s) {</span>
<span class="line-modified"> 69         System.out.println(String.valueOf(s));</span>




































 70     }
 71 






 72     public static void main(String args[]) throws Exception {
<span class="line-modified"> 73         // Launch the server debugee</span>
<span class="line-modified"> 74         log(&quot;Starting debuggee...&quot;);</span>
<span class="line-modified"> 75         try (Debuggee debuggee = Debuggee.launcher(&quot;Exit0&quot;).launch()) {</span>
<span class="line-modified"> 76             log(&quot;Debuggee started.&quot;);</span>
<span class="line-modified"> 77             int port = Integer.parseInt(debuggee.getAddress());</span>
<span class="line-modified"> 78             log(&quot;Debuggee port: &quot; + port);</span>
<span class="line-modified"> 79 </span>
<span class="line-modified"> 80             log(&quot;testcase 1...&quot;);</span>
<span class="line-modified"> 81             // Connect to the debuggee and handshake with garbage</span>
<span class="line-modified"> 82             Socket s = new Socket(&quot;localhost&quot;, port);</span>
<span class="line-modified"> 83             s.getOutputStream().write(&quot;Here&#39;s a poke in the eye&quot;.getBytes(&quot;UTF-8&quot;));</span>
<span class="line-modified"> 84             s.close();</span>
<span class="line-modified"> 85 </span>
<span class="line-added"> 86             log(&quot;testcase 2...&quot;);</span>
<span class="line-added"> 87             // Re-connect and do a partial handshake - don&#39;t disconnect</span>
<span class="line-added"> 88             // Re-connect just after disconnect may cause &quot;connection refused&quot; error (see JDK-8192057)</span>
<span class="line-added"> 89             Exception error = null;</span>
<span class="line-added"> 90             long retryDelay = 20;</span>
<span class="line-added"> 91             for (int retry = 0; retry &lt; 5; retry++) {</span>
<span class="line-added"> 92                 if (error != null) {</span>
<span class="line-added"> 93                     try {</span>
<span class="line-added"> 94                         Thread.sleep(retryDelay);</span>
<span class="line-added"> 95                     } catch (InterruptedException ex) {</span>
<span class="line-added"> 96                         // ignore</span>
<span class="line-added"> 97                     }</span>
<span class="line-added"> 98                     retryDelay *= 2;</span>
<span class="line-added"> 99                     error = null;</span>
<span class="line-added">100                 }</span>
<span class="line-added">101                 try {</span>
<span class="line-added">102                     log(&quot;retry: &quot; + retry);</span>
<span class="line-added">103                     s = new Socket(&quot;localhost&quot;, port);</span>
<span class="line-added">104                     s.getOutputStream().write(&quot;JDWP-&quot;.getBytes(&quot;UTF-8&quot;));</span>
<span class="line-added">105                     break;</span>
<span class="line-added">106                 } catch (ConnectException ex) {</span>
<span class="line-added">107                     log(&quot;got exception: &quot; + ex.toString());</span>
<span class="line-added">108                     error = ex;</span>
<span class="line-added">109                 }</span>
110             }
<span class="line-modified">111             if (error != null) {</span>
<span class="line-modified">112                 throw error;</span>
























113             }










114 
<span class="line-modified">115             log(&quot;cleaning...&quot;);</span>
<span class="line-modified">116             // Attach to server debuggee and resume it so it can exit</span>
<span class="line-added">117             AttachingConnector conn = (AttachingConnector)findConnector(&quot;com.sun.jdi.SocketAttach&quot;);</span>
<span class="line-added">118             Map&lt;String, Argument&gt; conn_args = conn.defaultArguments();</span>
<span class="line-added">119             Connector.IntegerArgument port_arg =</span>
<span class="line-added">120                     (Connector.IntegerArgument)conn_args.get(&quot;port&quot;);</span>
<span class="line-added">121             port_arg.setValue(port);</span>
<span class="line-added">122             VirtualMachine vm = conn.attach(conn_args);</span>
<span class="line-added">123 </span>
<span class="line-added">124             // The first event is always a VMStartEvent, and it is always in</span>
<span class="line-added">125             // an EventSet by itself.  Wait for it.</span>
<span class="line-added">126             EventSet evtSet = vm.eventQueue().remove();</span>
<span class="line-added">127             for (Event event : evtSet) {</span>
<span class="line-added">128                 if (event instanceof VMStartEvent) {</span>
<span class="line-added">129                     break;</span>
<span class="line-added">130                 }</span>
<span class="line-added">131                 throw new RuntimeException(&quot;Test failed - debuggee did not start properly&quot;);</span>
<span class="line-added">132             }</span>
133 
<span class="line-modified">134             vm.eventRequestManager().deleteAllBreakpoints();</span>
<span class="line-modified">135             vm.resume();</span>


136 
<span class="line-modified">137             debuggee.waitFor(10, TimeUnit.SECONDS);</span>

138         }





139     }

140 }
</pre>
</td>
</tr>
</table>
<center><a href="../java/swing/plaf/gtk/Test6963870.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="ExceptionEvents.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>