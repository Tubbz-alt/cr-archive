<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New test/jdk/com/sun/jdi/BadHandshakeTest.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2005, 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 import java.net.ConnectException;
 25 import java.net.Socket;
 26 
 27 import com.sun.jdi.Bootstrap;
 28 import com.sun.jdi.VirtualMachine;
 29 import com.sun.jdi.event.*;
 30 import com.sun.jdi.connect.Connector;
 31 import com.sun.jdi.connect.AttachingConnector;
 32 import com.sun.jdi.connect.Connector.Argument;
 33 
 34 import java.util.Map;
 35 import java.util.List;
 36 import java.util.Iterator;
 37 import java.util.concurrent.TimeUnit;
 38 
 39 import lib.jdb.Debuggee;
 40 
 41 /* @test
 42  * @bug 6306165 6432567
 43  * @summary Check that a bad handshake doesn&#39;t cause a debuggee to abort
 44  * @library /test/lib
 45  *
 46  * @modules java.management
 47  *          jdk.jdi
 48  * @build BadHandshakeTest Exit0
 49  * @run driver BadHandshakeTest
 50  */
 51 public class BadHandshakeTest {
 52 
 53     /*
 54      * Find a connector by name
 55      */
 56     private static Connector findConnector(String name) {
 57         List&lt;Connector&gt; connectors = Bootstrap.virtualMachineManager().allConnectors();
 58         Iterator&lt;Connector&gt; iter = connectors.iterator();
 59         while (iter.hasNext()) {
 60             Connector connector = iter.next();
 61             if (connector.name().equals(name)) {
 62                 return connector;
 63             }
 64         }
 65         return null;
 66     }
 67 
 68     private static void log(Object s) {
 69         System.out.println(String.valueOf(s));
 70     }
 71 
 72     public static void main(String args[]) throws Exception {
 73         // Launch the server debugee
 74         log(&quot;Starting debuggee...&quot;);
 75         try (Debuggee debuggee = Debuggee.launcher(&quot;Exit0&quot;).launch()) {
 76             log(&quot;Debuggee started.&quot;);
 77             int port = Integer.parseInt(debuggee.getAddress());
 78             log(&quot;Debuggee port: &quot; + port);
 79 
 80             log(&quot;testcase 1...&quot;);
 81             // Connect to the debuggee and handshake with garbage
 82             Socket s = new Socket(&quot;localhost&quot;, port);
 83             s.getOutputStream().write(&quot;Here&#39;s a poke in the eye&quot;.getBytes(&quot;UTF-8&quot;));
 84             s.close();
 85 
 86             log(&quot;testcase 2...&quot;);
 87             // Re-connect and do a partial handshake - don&#39;t disconnect
 88             // Re-connect just after disconnect may cause &quot;connection refused&quot; error (see JDK-8192057)
 89             Exception error = null;
 90             long retryDelay = 20;
 91             for (int retry = 0; retry &lt; 5; retry++) {
 92                 if (error != null) {
 93                     try {
 94                         Thread.sleep(retryDelay);
 95                     } catch (InterruptedException ex) {
 96                         // ignore
 97                     }
 98                     retryDelay *= 2;
 99                     error = null;
100                 }
101                 try {
102                     log(&quot;retry: &quot; + retry);
103                     s = new Socket(&quot;localhost&quot;, port);
104                     s.getOutputStream().write(&quot;JDWP-&quot;.getBytes(&quot;UTF-8&quot;));
105                     break;
106                 } catch (ConnectException ex) {
107                     log(&quot;got exception: &quot; + ex.toString());
108                     error = ex;
109                 }
110             }
111             if (error != null) {
112                 throw error;
113             }
114 
115             log(&quot;cleaning...&quot;);
116             // Attach to server debuggee and resume it so it can exit
117             AttachingConnector conn = (AttachingConnector)findConnector(&quot;com.sun.jdi.SocketAttach&quot;);
118             Map&lt;String, Argument&gt; conn_args = conn.defaultArguments();
119             Connector.IntegerArgument port_arg =
120                     (Connector.IntegerArgument)conn_args.get(&quot;port&quot;);
121             port_arg.setValue(port);
122             VirtualMachine vm = conn.attach(conn_args);
123 
124             // The first event is always a VMStartEvent, and it is always in
125             // an EventSet by itself.  Wait for it.
126             EventSet evtSet = vm.eventQueue().remove();
127             for (Event event : evtSet) {
128                 if (event instanceof VMStartEvent) {
129                     break;
130                 }
131                 throw new RuntimeException(&quot;Test failed - debuggee did not start properly&quot;);
132             }
133 
134             vm.eventRequestManager().deleteAllBreakpoints();
135             vm.resume();
136 
137             debuggee.waitFor(10, TimeUnit.SECONDS);
138         }
139     }
140 }
    </pre>
  </body>
</html>