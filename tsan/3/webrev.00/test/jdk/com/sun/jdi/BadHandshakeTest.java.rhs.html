<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/jdk/com/sun/jdi/BadHandshakeTest.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
    <script type="text/javascript" src="../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2005, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
<a name="2" id="anc2"></a><span class="line-added"> 24 import java.net.ConnectException;</span>
 25 import java.net.Socket;
 26 
 27 import com.sun.jdi.Bootstrap;
 28 import com.sun.jdi.VirtualMachine;
 29 import com.sun.jdi.event.*;
 30 import com.sun.jdi.connect.Connector;
 31 import com.sun.jdi.connect.AttachingConnector;
 32 import com.sun.jdi.connect.Connector.Argument;
 33 
 34 import java.util.Map;
 35 import java.util.List;
 36 import java.util.Iterator;
 37 import java.util.concurrent.TimeUnit;
<a name="3" id="anc3"></a>
 38 
<a name="4" id="anc4"></a><span class="line-modified"> 39 import lib.jdb.Debuggee;</span>

 40 
 41 /* @test
 42  * @bug 6306165 6432567
 43  * @summary Check that a bad handshake doesn&#39;t cause a debuggee to abort
 44  * @library /test/lib
 45  *
 46  * @modules java.management
 47  *          jdk.jdi
<a name="5" id="anc5"></a><span class="line-modified"> 48  * @build BadHandshakeTest Exit0</span>
 49  * @run driver BadHandshakeTest
 50  */
 51 public class BadHandshakeTest {
 52 
 53     /*
 54      * Find a connector by name
 55      */
 56     private static Connector findConnector(String name) {
 57         List&lt;Connector&gt; connectors = Bootstrap.virtualMachineManager().allConnectors();
 58         Iterator&lt;Connector&gt; iter = connectors.iterator();
 59         while (iter.hasNext()) {
<a name="6" id="anc6"></a><span class="line-modified"> 60             Connector connector = iter.next();</span>
 61             if (connector.name().equals(name)) {
 62                 return connector;
 63             }
 64         }
 65         return null;
 66     }
 67 
<a name="7" id="anc7"></a><span class="line-modified"> 68     private static void log(Object s) {</span>
<span class="line-modified"> 69         System.out.println(String.valueOf(s));</span>




































 70     }
 71 
<a name="8" id="anc8"></a>





 72     public static void main(String args[]) throws Exception {
<a name="9" id="anc9"></a><span class="line-modified"> 73         // Launch the server debugee</span>
<span class="line-modified"> 74         log(&quot;Starting debuggee...&quot;);</span>
<span class="line-modified"> 75         try (Debuggee debuggee = Debuggee.launcher(&quot;Exit0&quot;).launch()) {</span>
<span class="line-modified"> 76             log(&quot;Debuggee started.&quot;);</span>
<span class="line-modified"> 77             int port = Integer.parseInt(debuggee.getAddress());</span>
<span class="line-modified"> 78             log(&quot;Debuggee port: &quot; + port);</span>
<span class="line-modified"> 79 </span>
<span class="line-modified"> 80             log(&quot;testcase 1...&quot;);</span>
<span class="line-modified"> 81             // Connect to the debuggee and handshake with garbage</span>
<span class="line-modified"> 82             Socket s = new Socket(&quot;localhost&quot;, port);</span>
<span class="line-modified"> 83             s.getOutputStream().write(&quot;Here&#39;s a poke in the eye&quot;.getBytes(&quot;UTF-8&quot;));</span>
<span class="line-modified"> 84             s.close();</span>
<span class="line-modified"> 85 </span>
<span class="line-added"> 86             log(&quot;testcase 2...&quot;);</span>
<span class="line-added"> 87             // Re-connect and do a partial handshake - don&#39;t disconnect</span>
<span class="line-added"> 88             // Re-connect just after disconnect may cause &quot;connection refused&quot; error (see JDK-8192057)</span>
<span class="line-added"> 89             Exception error = null;</span>
<span class="line-added"> 90             long retryDelay = 20;</span>
<span class="line-added"> 91             for (int retry = 0; retry &lt; 5; retry++) {</span>
<span class="line-added"> 92                 if (error != null) {</span>
<span class="line-added"> 93                     try {</span>
<span class="line-added"> 94                         Thread.sleep(retryDelay);</span>
<span class="line-added"> 95                     } catch (InterruptedException ex) {</span>
<span class="line-added"> 96                         // ignore</span>
<span class="line-added"> 97                     }</span>
<span class="line-added"> 98                     retryDelay *= 2;</span>
<span class="line-added"> 99                     error = null;</span>
<span class="line-added">100                 }</span>
<span class="line-added">101                 try {</span>
<span class="line-added">102                     log(&quot;retry: &quot; + retry);</span>
<span class="line-added">103                     s = new Socket(&quot;localhost&quot;, port);</span>
<span class="line-added">104                     s.getOutputStream().write(&quot;JDWP-&quot;.getBytes(&quot;UTF-8&quot;));</span>
<span class="line-added">105                     break;</span>
<span class="line-added">106                 } catch (ConnectException ex) {</span>
<span class="line-added">107                     log(&quot;got exception: &quot; + ex.toString());</span>
<span class="line-added">108                     error = ex;</span>
<span class="line-added">109                 }</span>
110             }
<a name="10" id="anc10"></a><span class="line-modified">111             if (error != null) {</span>
<span class="line-modified">112                 throw error;</span>
























113             }
<a name="11" id="anc11"></a>









114 
<a name="12" id="anc12"></a><span class="line-modified">115             log(&quot;cleaning...&quot;);</span>
<span class="line-modified">116             // Attach to server debuggee and resume it so it can exit</span>
<span class="line-added">117             AttachingConnector conn = (AttachingConnector)findConnector(&quot;com.sun.jdi.SocketAttach&quot;);</span>
<span class="line-added">118             Map&lt;String, Argument&gt; conn_args = conn.defaultArguments();</span>
<span class="line-added">119             Connector.IntegerArgument port_arg =</span>
<span class="line-added">120                     (Connector.IntegerArgument)conn_args.get(&quot;port&quot;);</span>
<span class="line-added">121             port_arg.setValue(port);</span>
<span class="line-added">122             VirtualMachine vm = conn.attach(conn_args);</span>
<span class="line-added">123 </span>
<span class="line-added">124             // The first event is always a VMStartEvent, and it is always in</span>
<span class="line-added">125             // an EventSet by itself.  Wait for it.</span>
<span class="line-added">126             EventSet evtSet = vm.eventQueue().remove();</span>
<span class="line-added">127             for (Event event : evtSet) {</span>
<span class="line-added">128                 if (event instanceof VMStartEvent) {</span>
<span class="line-added">129                     break;</span>
<span class="line-added">130                 }</span>
<span class="line-added">131                 throw new RuntimeException(&quot;Test failed - debuggee did not start properly&quot;);</span>
<span class="line-added">132             }</span>
133 
<a name="13" id="anc13"></a><span class="line-modified">134             vm.eventRequestManager().deleteAllBreakpoints();</span>
<span class="line-modified">135             vm.resume();</span>


136 
<a name="14" id="anc14"></a><span class="line-modified">137             debuggee.waitFor(10, TimeUnit.SECONDS);</span>

138         }
<a name="15" id="anc15"></a>




139     }
<a name="16" id="anc16"></a>
140 }
<a name="17" id="anc17"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="17" type="hidden" />
</body>
</html>