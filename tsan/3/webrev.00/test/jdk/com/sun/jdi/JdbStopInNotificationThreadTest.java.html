<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New test/jdk/com/sun/jdi/JdbStopInNotificationThreadTest.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @summary Tests that the breakpoint in the notification listener is hit when the
 27  * notification thread is enabled and is not hit when the notification thread is disabled
 28  * (the service thread delivers the notifications in this case).
 29  *
 30  * @library /test/lib
 31  * @run compile -g JdbStopInNotificationThreadTest.java
 32  * @run main/othervm JdbStopInNotificationThreadTest
 33  */
 34 
 35 import jdk.test.lib.process.OutputAnalyzer;
 36 import lib.jdb.JdbCommand;
 37 import lib.jdb.JdbTest;
 38 
 39 import javax.management.Notification;
 40 import javax.management.NotificationEmitter;
 41 import javax.management.NotificationListener;
 42 import java.lang.management.*;
 43 import java.util.Collection;
 44 import java.util.LinkedList;
 45 
 46 class JdbStopInNotificationThreadTestTarg {
 47 
 48     private static volatile boolean done = false;
 49 
 50     private static final MemoryPoolMXBean tenuredGenPool =
 51             findTenuredGenPool();
 52 
 53     public static void main(String[] args) throws Exception {
 54         test(); // @1 breakpoint
 55     }
 56 
 57     private static void test() throws Exception {
 58         setPercentageUsageThreshold(0.1);
 59         MemoryMXBean mbean = ManagementFactory.getMemoryMXBean();
 60         NotificationEmitter emitter = (NotificationEmitter) mbean;
 61         emitter.addNotificationListener(new NotificationListener() {
 62             public void handleNotification(Notification n, Object hb) {
 63                 System.out.println(&quot;Notification received:&quot; + n.getType());
 64                 if (n.getType().equals(
 65                         MemoryNotificationInfo.MEMORY_THRESHOLD_EXCEEDED)) {
 66                     done = true;
 67                     System.out.println(&quot;Notification MEMORY_THRESHOLD_EXCEEDED received:&quot;);
 68                     long maxMemory = tenuredGenPool.getUsage().getMax();
 69                     long usedMemory = tenuredGenPool.getUsage().getUsed();
 70                     System.out.println(&quot;Memory usage low!!!&quot;); // @2 breakpoint
 71                     double percentageUsed = ((double) usedMemory) / maxMemory;
 72                     System.out.println(&quot;percentageUsed = &quot; + percentageUsed);
 73                 }
 74             }
 75         }, null, null);
 76 
 77         Collection&lt;Object[]&gt; numbers = new LinkedList();
 78         long counter = 0;
 79         while (!done) {
 80             numbers.add(new Object[1000]);
 81             counter++;
 82             if (counter % 1000 == 0) {
 83                 Thread.sleep(100);
 84             }
 85         }
 86         System.out.println(&quot;Done&quot;);
 87     }
 88 
 89     private static MemoryPoolMXBean findTenuredGenPool() {
 90         for (MemoryPoolMXBean pool :
 91                 ManagementFactory.getMemoryPoolMXBeans()) {
 92             if (pool.getType() == MemoryType.HEAP &amp;&amp;
 93                     pool.isUsageThresholdSupported()) {
 94                 return pool;
 95             }
 96         }
 97         throw new RuntimeException(&quot;Could not find tenured space&quot;);
 98     }
 99 
100     public static void setPercentageUsageThreshold(double percentage) {
101         if (percentage &lt;= 0.0 || percentage &gt; 1.0) {
102             throw new IllegalArgumentException(&quot;Percentage not in range&quot;);
103         }
104         System.out.println(&quot;Setting threashold for pool &quot; + tenuredGenPool.getName() + &quot; percentage:&quot; + percentage);
105         long maxMemory = tenuredGenPool.getUsage().getMax();
106         long warningThreshold = (long) (maxMemory * percentage);
107         tenuredGenPool.setUsageThreshold(warningThreshold);
108     }
109 }
110 
111 public class JdbStopInNotificationThreadTest extends JdbTest {
112 
113     private static final String DEBUGGEE_CLASS = JdbStopInNotificationThreadTestTarg.class.getName();
114     private static final String PATTERN1_TEMPLATE = &quot;^Breakpoint hit: \&quot;thread=Notification Thread\&quot;, &quot; +
115             &quot;JdbStopInNotificationThreadTestTarg\\$1\\.handleNotification\\(\\), line=%LINE_NUMBER.*\\R%LINE_NUMBER\\s+System\\.out\\.println\\(\&quot;Memory usage low!!!\&quot;\\);.*&quot;;
116 
117     private JdbStopInNotificationThreadTest() {
118         super(DEBUGGEE_CLASS);
119     }
120 
121     public static void main(String argv[]) {
122         new JdbStopInNotificationThreadTest().run();
123     }
124 
125     @Override
126     protected void runCases() {
127         if (isNotificationThreadDisabled()) {
128             System.out.println(&quot;Notification Thread is disabled. Skipping the test&quot;);
129             return;
130         }
131         int bpLine2 = parseBreakpoints(getTestSourcePath(&quot;JdbStopInNotificationThreadTest.java&quot;), 2).get(0);
132         jdb.command(JdbCommand.stopAt(DEBUGGEE_CLASS + &quot;$1&quot;, bpLine2));
133         String pattern = PATTERN1_TEMPLATE.replaceAll(&quot;%LINE_NUMBER&quot;, String.valueOf(bpLine2));
134         jdb.command(JdbCommand.cont());
135         new OutputAnalyzer(jdb.getJdbOutput()).shouldMatch(pattern);
136     }
137 
138     private boolean isNotificationThreadDisabled() {
139         int bpLine1 = parseBreakpoints(getTestSourcePath(&quot;JdbStopInNotificationThreadTest.java&quot;), 1).get(0);
140         jdb.command(JdbCommand.stopAt(DEBUGGEE_CLASS, bpLine1));
141         jdb.command(JdbCommand.run());
142         jdb.command(JdbCommand.threads());
143         if (new OutputAnalyzer(jdb.getJdbOutput()).getOutput().contains(&quot;Notification Thread&quot;)) {
144             return false;
145         }
146         return true;
147     }
148 }
    </pre>
  </body>
</html>