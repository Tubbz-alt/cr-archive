<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/jdk/com/sun/jndi/ldap/LdapTimeoutTest.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2011, 2016, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
<a name="2" id="anc2"></a><span class="line-modified"> 24 /**</span>
 25  * @test
<a name="3" id="anc3"></a><span class="line-modified"> 26  * @run main/othervm LdapTimeoutTest</span>
<span class="line-modified"> 27  * @bug 7094377 8000487 6176036 7056489</span>


 28  * @summary Timeout tests for ldap
 29  */
 30 
<a name="4" id="anc4"></a>









 31 import java.net.Socket;
<a name="5" id="anc5"></a><span class="line-removed"> 32 import java.net.ServerSocket;</span>
<span class="line-removed"> 33 import java.net.SocketTimeoutException;</span>
<span class="line-removed"> 34 import java.io.*;</span>
<span class="line-removed"> 35 import javax.naming.*;</span>
<span class="line-removed"> 36 import javax.naming.directory.*;</span>
<span class="line-removed"> 37 import java.util.List;</span>
<span class="line-removed"> 38 import java.util.Hashtable;</span>
 39 import java.util.ArrayList;
<a name="6" id="anc6"></a>


 40 import java.util.concurrent.Callable;
<a name="7" id="anc7"></a>
 41 import java.util.concurrent.ExecutionException;
<a name="8" id="anc8"></a><span class="line-removed"> 42 import java.util.concurrent.Executors;</span>
 43 import java.util.concurrent.ExecutorService;
<a name="9" id="anc9"></a>
 44 import java.util.concurrent.Future;
<a name="10" id="anc10"></a><span class="line-modified"> 45 import java.util.concurrent.ScheduledExecutorService;</span>
<span class="line-modified"> 46 import java.util.concurrent.ScheduledFuture;</span>
<span class="line-removed"> 47 import java.util.concurrent.TimeoutException;</span>
 48 import java.util.concurrent.TimeUnit;
<a name="11" id="anc11"></a><span class="line-modified"> 49 import javax.net.ssl.SSLHandshakeException;</span>
 50 
<a name="12" id="anc12"></a>
 51 import static java.util.concurrent.TimeUnit.MILLISECONDS;
 52 import static java.util.concurrent.TimeUnit.NANOSECONDS;
<a name="13" id="anc13"></a>


 53 
<a name="14" id="anc14"></a>
 54 
<a name="15" id="anc15"></a><span class="line-modified"> 55 abstract class LdapTest implements Callable {</span>
<span class="line-modified"> 56 </span>
<span class="line-modified"> 57     Hashtable env;</span>
<span class="line-modified"> 58     TestServer server;</span>
<span class="line-modified"> 59     ScheduledExecutorService killSwitchPool;</span>
<span class="line-modified"> 60     boolean passed = false;</span>
<span class="line-modified"> 61     private int HANGING_TEST_TIMEOUT = 20_000;</span>
<span class="line-modified"> 62 </span>
<span class="line-modified"> 63     public LdapTest (TestServer server, Hashtable env) {</span>
<span class="line-modified"> 64         this.server = server;</span>
<span class="line-modified"> 65         this.env = env;</span>
<span class="line-modified"> 66     }</span>
<span class="line-modified"> 67 </span>
<span class="line-modified"> 68     public LdapTest(TestServer server, Hashtable env,</span>
<span class="line-modified"> 69             ScheduledExecutorService killSwitchPool)</span>
<span class="line-modified"> 70     {</span>
<span class="line-modified"> 71         this(server, env);</span>
<span class="line-modified"> 72         this.killSwitchPool = killSwitchPool;</span>
<span class="line-modified"> 73     }</span>
<span class="line-modified"> 74 </span>
<span class="line-modified"> 75     public abstract void performOp(InitialContext ctx) throws NamingException;</span>
<span class="line-modified"> 76     public abstract void handleNamingException(</span>
<span class="line-modified"> 77         NamingException e, long start, long end);</span>
<span class="line-removed"> 78 </span>
<span class="line-removed"> 79     public void pass() {</span>
<span class="line-removed"> 80         this.passed = true;</span>
<span class="line-removed"> 81     }</span>
<span class="line-removed"> 82 </span>
<span class="line-removed"> 83     public void fail() {</span>
<span class="line-removed"> 84         throw new RuntimeException(&quot;Test failed&quot;);</span>
 85     }
 86 
<a name="16" id="anc16"></a><span class="line-modified"> 87     public void fail(Exception e) {</span>
<span class="line-modified"> 88         throw new RuntimeException(&quot;Test failed&quot;, e);</span>

 89     }
 90 
<a name="17" id="anc17"></a><span class="line-modified"> 91     boolean shutItDown(InitialContext ctx) {</span>












 92         try {
<a name="18" id="anc18"></a><span class="line-modified"> 93             if (ctx != null) ctx.close();</span>
<span class="line-modified"> 94             return true;</span>
<span class="line-modified"> 95         } catch (NamingException ex) {</span>
<span class="line-modified"> 96             return false;</span>





 97         }
<a name="19" id="anc19"></a><span class="line-modified"> 98     }</span>
<span class="line-modified"> 99 </span>
<span class="line-removed">100     public Boolean call() {</span>
<span class="line-removed">101         InitialContext ctx = null;</span>
<span class="line-removed">102         ScheduledFuture killer = null;</span>
<span class="line-removed">103         long start = System.nanoTime();</span>
<span class="line-removed">104 </span>
<span class="line-removed">105         try {</span>
<span class="line-removed">106             while(!server.accepting())</span>
<span class="line-removed">107                 Thread.sleep(200); // allow the server to start up</span>
<span class="line-removed">108             Thread.sleep(200); // to be sure</span>
<span class="line-removed">109 </span>
<span class="line-removed">110             // if this is a hanging test, scheduled a thread to</span>
<span class="line-removed">111             // interrupt after a certain time</span>
<span class="line-removed">112             if (killSwitchPool != null) {</span>
<span class="line-removed">113                 final Thread current = Thread.currentThread();</span>
<span class="line-removed">114                 killer = killSwitchPool.schedule(</span>
<span class="line-removed">115                     new Callable&lt;Void&gt;() {</span>
<span class="line-removed">116                         public Void call() throws Exception {</span>
<span class="line-removed">117                             current.interrupt();</span>
<span class="line-removed">118                             return null;</span>
<span class="line-removed">119                         }</span>
<span class="line-removed">120                     }, HANGING_TEST_TIMEOUT, MILLISECONDS);</span>
<span class="line-removed">121             }</span>
<span class="line-removed">122 </span>
<span class="line-removed">123             env.put(Context.PROVIDER_URL, &quot;ldap://localhost:&quot; +</span>
<span class="line-removed">124                     server.getLocalPort());</span>
<span class="line-removed">125 </span>
126             try {
<a name="20" id="anc20"></a><span class="line-modified">127                 ctx = new InitialDirContext(env);</span>
<span class="line-modified">128                 performOp(ctx);</span>
<span class="line-modified">129                 fail();</span>
<span class="line-modified">130             } catch (NamingException e) {</span>
<span class="line-removed">131                 long end = System.nanoTime();</span>
<span class="line-removed">132                 System.out.println(this.getClass().toString() + &quot; - elapsed: &quot;</span>
<span class="line-removed">133                         + NANOSECONDS.toMillis(end - start));</span>
<span class="line-removed">134                 handleNamingException(e, start, end);</span>
<span class="line-removed">135             } finally {</span>
<span class="line-removed">136                 if (killer != null &amp;&amp; !killer.isDone())</span>
<span class="line-removed">137                     killer.cancel(true);</span>
<span class="line-removed">138                 shutItDown(ctx);</span>
<span class="line-removed">139                 server.close();</span>
140             }
<a name="21" id="anc21"></a><span class="line-removed">141             return passed;</span>
<span class="line-removed">142         } catch (IOException|InterruptedException e) {</span>
<span class="line-removed">143             throw new RuntimeException(e);</span>
144         }
<a name="22" id="anc22"></a>

145     }
<a name="23" id="anc23"></a><span class="line-removed">146 }</span>
<span class="line-removed">147 </span>
<span class="line-removed">148 abstract class ReadServerTest extends LdapTest {</span>
149 
<a name="24" id="anc24"></a><span class="line-modified">150     public ReadServerTest(Hashtable env) throws IOException {</span>
<span class="line-modified">151         super(new BindableServer(), env);</span>














152     }
153 
<a name="25" id="anc25"></a><span class="line-modified">154     public ReadServerTest(Hashtable env,</span>
<span class="line-modified">155                           ScheduledExecutorService killSwitchPool)</span>
<span class="line-modified">156             throws IOException</span>
<span class="line-modified">157     {</span>
<span class="line-modified">158         super(new BindableServer(), env, killSwitchPool);</span>









159     }
160 
<a name="26" id="anc26"></a><span class="line-modified">161     public void performOp(InitialContext ctx) throws NamingException {</span>
<span class="line-modified">162         SearchControls scl = new SearchControls();</span>
<span class="line-modified">163         scl.setSearchScope(SearchControls.SUBTREE_SCOPE);</span>
<span class="line-modified">164         NamingEnumeration&lt;SearchResult&gt; answer = ((InitialDirContext)ctx)</span>
<span class="line-modified">165             .search(&quot;ou=People,o=JNDITutorial&quot;, &quot;(objectClass=*)&quot;, scl);</span>








166     }
<a name="27" id="anc27"></a><span class="line-removed">167 }</span>
<span class="line-removed">168 </span>
<span class="line-removed">169 abstract class DeadServerTest extends LdapTest {</span>
170 
<a name="28" id="anc28"></a><span class="line-modified">171     public DeadServerTest(Hashtable env) throws IOException {</span>
<span class="line-modified">172         super(new DeadServer(), env);</span>

















173     }
174 
<a name="29" id="anc29"></a><span class="line-modified">175     public DeadServerTest(Hashtable env,</span>
<span class="line-modified">176                           ScheduledExecutorService killSwitchPool)</span>
<span class="line-modified">177             throws IOException</span>
<span class="line-modified">178     {</span>
<span class="line-modified">179         super(new DeadServer(), env, killSwitchPool);</span>

















180     }
181 
<a name="30" id="anc30"></a><span class="line-modified">182     public void performOp(InitialContext ctx) throws NamingException {}</span>
<span class="line-modified">183 }</span>
<span class="line-modified">184 </span>
<span class="line-modified">185 class DeadServerNoTimeoutTest extends DeadServerTest {</span>
<span class="line-modified">186 </span>
<span class="line-modified">187     public DeadServerNoTimeoutTest(Hashtable env,</span>
<span class="line-modified">188                                    ScheduledExecutorService killSwitchPool)</span>
<span class="line-modified">189             throws IOException</span>
<span class="line-modified">190     {</span>
<span class="line-modified">191         super(env, killSwitchPool);</span>









192     }
193 
<a name="31" id="anc31"></a><span class="line-modified">194     public void handleNamingException(NamingException e, long start, long end) {</span>
<span class="line-modified">195         if (e instanceof InterruptedNamingException) Thread.interrupted();</span>
<span class="line-modified">196 </span>
<span class="line-modified">197         if (NANOSECONDS.toMillis(end - start) &lt; LdapTimeoutTest.MIN_TIMEOUT) {</span>
<span class="line-modified">198             System.err.printf(&quot;DeadServerNoTimeoutTest fail: timeout should be &quot; +</span>
<span class="line-modified">199                               &quot;at least %s ms, actual time is %s ms%n&quot;,</span>
<span class="line-modified">200                               LdapTimeoutTest.MIN_TIMEOUT,</span>
<span class="line-modified">201                               NANOSECONDS.toMillis(end - start));</span>
<span class="line-modified">202             fail();</span>
<span class="line-modified">203         } else {</span>
<span class="line-modified">204             pass();</span>












205         }
206     }
<a name="32" id="anc32"></a><span class="line-removed">207 }</span>
208 
<a name="33" id="anc33"></a><span class="line-modified">209 class DeadServerTimeoutTest extends DeadServerTest {</span>
210 
<a name="34" id="anc34"></a><span class="line-modified">211     public DeadServerTimeoutTest(Hashtable env) throws IOException {</span>
<span class="line-removed">212         super(env);</span>
<span class="line-removed">213     }</span>
214 
<a name="35" id="anc35"></a><span class="line-modified">215     public void handleNamingException(NamingException e, long start, long end)</span>
<span class="line-removed">216     {</span>
<span class="line-removed">217         // non SSL connect will timeout via readReply using connectTimeout</span>
<span class="line-removed">218         if (NANOSECONDS.toMillis(end - start) &lt; 2_900) {</span>
<span class="line-removed">219             pass();</span>
<span class="line-removed">220         } else {</span>
<span class="line-removed">221             System.err.println(&quot;Fail: Waited too long&quot;);</span>
<span class="line-removed">222             fail();</span>
<span class="line-removed">223         }</span>
<span class="line-removed">224     }</span>
<span class="line-removed">225 }</span>
226 
<a name="36" id="anc36"></a>
227 
<a name="37" id="anc37"></a><span class="line-modified">228 class ReadServerNoTimeoutTest extends ReadServerTest {</span>



229 
<a name="38" id="anc38"></a><span class="line-modified">230     public ReadServerNoTimeoutTest(Hashtable env,</span>
<span class="line-modified">231                                    ScheduledExecutorService killSwitchPool)</span>
<span class="line-modified">232             throws IOException</span>
<span class="line-removed">233     {</span>
<span class="line-removed">234         super(env, killSwitchPool);</span>
235     }
236 
<a name="39" id="anc39"></a><span class="line-modified">237     public void handleNamingException(NamingException e, long start, long end) {</span>
<span class="line-modified">238         if (e instanceof InterruptedNamingException) Thread.interrupted();</span>
<span class="line-modified">239 </span>
<span class="line-modified">240         if (NANOSECONDS.toMillis(end - start) &lt; LdapTimeoutTest.MIN_TIMEOUT) {</span>
<span class="line-modified">241             System.err.printf(&quot;ReadServerNoTimeoutTest fail: timeout should be &quot; +</span>
<span class="line-modified">242                               &quot;at least %s ms, actual time is %s ms%n&quot;,</span>
<span class="line-modified">243                               LdapTimeoutTest.MIN_TIMEOUT,</span>
<span class="line-modified">244                               NANOSECONDS.toMillis(end - start));</span>
<span class="line-modified">245             fail();</span>
<span class="line-modified">246         } else {</span>
<span class="line-modified">247             pass();</span>










248         }
249     }
<a name="40" id="anc40"></a><span class="line-removed">250 }</span>
251 
<a name="41" id="anc41"></a><span class="line-modified">252 class ReadServerTimeoutTest extends ReadServerTest {</span>
253 
<a name="42" id="anc42"></a><span class="line-modified">254     public ReadServerTimeoutTest(Hashtable env) throws IOException {</span>
<span class="line-removed">255         super(env);</span>
<span class="line-removed">256     }</span>
257 
<a name="43" id="anc43"></a><span class="line-modified">258     public void handleNamingException(NamingException e, long start, long end) {</span>
<span class="line-modified">259         System.out.println(&quot;ReadServerTimeoutTest: end-start=&quot; + NANOSECONDS.toMillis(end - start));</span>
<span class="line-modified">260         if (NANOSECONDS.toMillis(end - start) &lt; 2_500) {</span>
<span class="line-modified">261             fail();</span>
<span class="line-modified">262         } else {</span>
<span class="line-modified">263             pass();</span>

264         }
265     }
<a name="44" id="anc44"></a><span class="line-removed">266 }</span>
<span class="line-removed">267 </span>
<span class="line-removed">268 class TestServer extends Thread {</span>
<span class="line-removed">269     ServerSocket serverSock;</span>
<span class="line-removed">270     boolean accepting = false;</span>
<span class="line-removed">271 </span>
<span class="line-removed">272     public TestServer() throws IOException {</span>
<span class="line-removed">273         this.serverSock = new ServerSocket(0);</span>
<span class="line-removed">274         start();</span>
<span class="line-removed">275     }</span>
276 
<a name="45" id="anc45"></a><span class="line-modified">277     public int getLocalPort() {</span>
<span class="line-modified">278         return serverSock.getLocalPort();</span>
<span class="line-modified">279     }</span>


















280 
<a name="46" id="anc46"></a><span class="line-modified">281     public boolean accepting() {</span>
<span class="line-modified">282         return accepting;</span>
<span class="line-removed">283     }</span>
284 
<a name="47" id="anc47"></a><span class="line-modified">285     public void close() throws IOException {</span>
<span class="line-modified">286         serverSock.close();</span>
<span class="line-modified">287     }</span>
<span class="line-modified">288 }</span>


289 
<a name="48" id="anc48"></a><span class="line-modified">290 class BindableServer extends TestServer {</span>


291 
<a name="49" id="anc49"></a><span class="line-modified">292     public BindableServer() throws IOException {</span>
<span class="line-modified">293         super();</span>
<span class="line-modified">294     }</span>




295 
<a name="50" id="anc50"></a><span class="line-modified">296     private byte[] bindResponse = {</span>
<span class="line-modified">297         0x30, 0x0C, 0x02, 0x01, 0x01, 0x61, 0x07, 0x0A,</span>
<span class="line-removed">298         0x01, 0x00, 0x04, 0x00, 0x04, 0x00</span>
<span class="line-removed">299     };</span>
300 
<a name="51" id="anc51"></a><span class="line-removed">301     public void run() {</span>
302         try {
<a name="52" id="anc52"></a><span class="line-modified">303             accepting = true;</span>
<span class="line-modified">304             Socket socket = serverSock.accept();</span>
<span class="line-modified">305             InputStream in = socket.getInputStream();</span>
<span class="line-modified">306             OutputStream out = socket.getOutputStream();</span>
<span class="line-modified">307 </span>
<span class="line-removed">308             // Read the LDAP BindRequest</span>
<span class="line-removed">309             while (in.read() != -1) {</span>
<span class="line-removed">310                 in.skip(in.available());</span>
<span class="line-removed">311                 break;</span>
312             }
<a name="53" id="anc53"></a><span class="line-modified">313 </span>
<span class="line-modified">314             // Write an LDAP BindResponse</span>
<span class="line-modified">315             out.write(bindResponse);</span>
<span class="line-modified">316             out.flush();</span>
<span class="line-modified">317         } catch (IOException e) {</span>
<span class="line-modified">318             // ignore</span>










319         }
320     }
<a name="54" id="anc54"></a><span class="line-removed">321 }</span>
<span class="line-removed">322 </span>
<span class="line-removed">323 class DeadServer extends TestServer {</span>
<span class="line-removed">324 </span>
<span class="line-removed">325     public DeadServer() throws IOException {</span>
<span class="line-removed">326         super();</span>
<span class="line-removed">327     }</span>
328 
<a name="55" id="anc55"></a><span class="line-modified">329     public void run() {</span>
<span class="line-modified">330         while(true) {</span>
<span class="line-modified">331             try {</span>
<span class="line-modified">332                 accepting = true;</span>
<span class="line-modified">333                 Socket socket = serverSock.accept();</span>
<span class="line-modified">334             } catch (Exception e) {</span>
<span class="line-modified">335                 break;</span>
<span class="line-modified">336             }</span>


337         }
<a name="56" id="anc56"></a><span class="line-modified">338     }</span>
<span class="line-removed">339 }</span>
340 
<a name="57" id="anc57"></a><span class="line-modified">341 public class LdapTimeoutTest {</span>

342 
<a name="58" id="anc58"></a><span class="line-modified">343     private static final ExecutorService testPool =</span>
<span class="line-modified">344         Executors.newFixedThreadPool(3);</span>
<span class="line-modified">345     private static final ScheduledExecutorService killSwitchPool =</span>
<span class="line-modified">346         Executors.newScheduledThreadPool(3);</span>
<span class="line-modified">347     public static int MIN_TIMEOUT = 18_000;</span>
<span class="line-modified">348 </span>
<span class="line-removed">349     static Hashtable createEnv() {</span>
<span class="line-removed">350         Hashtable env = new Hashtable(11);</span>
<span class="line-removed">351         env.put(Context.INITIAL_CONTEXT_FACTORY,</span>
<span class="line-removed">352             &quot;com.sun.jndi.ldap.LdapCtxFactory&quot;);</span>
<span class="line-removed">353         return env;</span>
<span class="line-removed">354     }</span>
355 
<a name="59" id="anc59"></a><span class="line-modified">356     public static void main(String[] args) throws Exception {</span>










357 
<a name="60" id="anc60"></a><span class="line-modified">358         InitialContext ctx = null;</span>
<span class="line-modified">359         List&lt;Future&gt; results = new ArrayList&lt;&gt;();</span>
360 
361         try {
<a name="61" id="anc61"></a><span class="line-modified">362             // run the DeadServerTest with no timeouts set</span>
<span class="line-modified">363             // this should get stuck indefinitely, so we need to kill</span>
<span class="line-modified">364             // it after a timeout</span>
<span class="line-modified">365             System.out.println(&quot;Running connect timeout test with 20s kill switch&quot;);</span>
<span class="line-modified">366             Hashtable env = createEnv();</span>
<span class="line-removed">367             results.add(</span>
<span class="line-removed">368                     testPool.submit(new DeadServerNoTimeoutTest(env, killSwitchPool)));</span>
<span class="line-removed">369 </span>
<span class="line-removed">370             // run the ReadServerTest with connect timeout set</span>
<span class="line-removed">371             // this should get stuck indefinitely so we need to kill</span>
<span class="line-removed">372             // it after a timeout</span>
<span class="line-removed">373             System.out.println(&quot;Running read timeout test with 10ms connect timeout &amp; 20s kill switch&quot;);</span>
<span class="line-removed">374             Hashtable env1 = createEnv();</span>
<span class="line-removed">375             env1.put(&quot;com.sun.jndi.ldap.connect.timeout&quot;, &quot;10&quot;);</span>
<span class="line-removed">376             results.add(testPool.submit(</span>
<span class="line-removed">377                     new ReadServerNoTimeoutTest(env1, killSwitchPool)));</span>
<span class="line-removed">378 </span>
<span class="line-removed">379             // run the ReadServerTest with no timeouts set</span>
<span class="line-removed">380             // this should get stuck indefinitely, so we need to kill</span>
<span class="line-removed">381             // it after a timeout</span>
<span class="line-removed">382             System.out.println(&quot;Running read timeout test with 20s kill switch&quot;);</span>
<span class="line-removed">383             Hashtable env2 = createEnv();</span>
<span class="line-removed">384             results.add(testPool.submit(</span>
<span class="line-removed">385                     new ReadServerNoTimeoutTest(env2, killSwitchPool)));</span>
<span class="line-removed">386 </span>
<span class="line-removed">387             // run the DeadServerTest with connect / read timeouts set</span>
<span class="line-removed">388             // this should exit after the connect timeout expires</span>
<span class="line-removed">389             System.out.println(&quot;Running connect timeout test with 10ms connect timeout, 3000ms read timeout&quot;);</span>
<span class="line-removed">390             Hashtable env3 = createEnv();</span>
<span class="line-removed">391             env3.put(&quot;com.sun.jndi.ldap.connect.timeout&quot;, &quot;10&quot;);</span>
<span class="line-removed">392             env3.put(&quot;com.sun.jndi.ldap.read.timeout&quot;, &quot;3000&quot;);</span>
<span class="line-removed">393             results.add(testPool.submit(new DeadServerTimeoutTest(env3)));</span>
<span class="line-removed">394 </span>
<span class="line-removed">395 </span>
<span class="line-removed">396             // run the ReadServerTest with connect / read timeouts set</span>
<span class="line-removed">397             // this should exit after the connect timeout expires</span>
<span class="line-removed">398             //</span>
<span class="line-removed">399             // NOTE: commenting this test out as it is failing intermittently.</span>
<span class="line-removed">400             //</span>
<span class="line-removed">401             // System.out.println(&quot;Running read timeout test with 10ms connect timeout, 3000ms read timeout&quot;);</span>
<span class="line-removed">402             // Hashtable env4 = createEnv();</span>
<span class="line-removed">403             // env4.put(&quot;com.sun.jndi.ldap.connect.timeout&quot;, &quot;10&quot;);</span>
<span class="line-removed">404             // env4.put(&quot;com.sun.jndi.ldap.read.timeout&quot;, &quot;3000&quot;);</span>
<span class="line-removed">405             // results.add(testPool.submit(new ReadServerTimeoutTest(env4)));</span>
<span class="line-removed">406 </span>
<span class="line-removed">407             // run the DeadServerTest with connect timeout set</span>
<span class="line-removed">408             // this should exit after the connect timeout expires</span>
<span class="line-removed">409             System.out.println(&quot;Running connect timeout test with 10ms connect timeout&quot;);</span>
<span class="line-removed">410             Hashtable env5 = createEnv();</span>
<span class="line-removed">411             env5.put(&quot;com.sun.jndi.ldap.connect.timeout&quot;, &quot;10&quot;);</span>
<span class="line-removed">412             results.add(testPool.submit(new DeadServerTimeoutTest(env5)));</span>
<span class="line-removed">413 </span>
<span class="line-removed">414             // 8000487: Java JNDI connection library on ldap conn is</span>
<span class="line-removed">415             // not honoring configured timeout</span>
<span class="line-removed">416             System.out.println(&quot;Running simple auth connection test&quot;);</span>
<span class="line-removed">417             Hashtable env6 = createEnv();</span>
<span class="line-removed">418             env6.put(&quot;com.sun.jndi.ldap.connect.timeout&quot;, &quot;10&quot;);</span>
<span class="line-removed">419             env6.put(&quot;com.sun.jndi.ldap.read.timeout&quot;, &quot;3000&quot;);</span>
<span class="line-removed">420             env6.put(Context.SECURITY_AUTHENTICATION, &quot;simple&quot;);</span>
<span class="line-removed">421             env6.put(Context.SECURITY_PRINCIPAL, &quot;user&quot;);</span>
<span class="line-removed">422             env6.put(Context.SECURITY_CREDENTIALS, &quot;password&quot;);</span>
<span class="line-removed">423             results.add(testPool.submit(new DeadServerTimeoutTest(env6)));</span>
<span class="line-removed">424 </span>
<span class="line-removed">425             boolean testFailed = false;</span>
<span class="line-removed">426             for (Future test : results) {</span>
<span class="line-removed">427                 while (!test.isDone()) {</span>
<span class="line-removed">428                     if ((Boolean) test.get() == false)</span>
<span class="line-removed">429                         testFailed = true;</span>
<span class="line-removed">430                 }</span>
431             }
<a name="62" id="anc62"></a><span class="line-modified">432 </span>
<span class="line-modified">433             if (testFailed) {</span>
<span class="line-modified">434                 throw new AssertionError(&quot;some tests failed&quot;);</span>


435             }
<a name="63" id="anc63"></a><span class="line-modified">436 </span>
437         } finally {
<a name="64" id="anc64"></a><span class="line-modified">438             LdapTimeoutTest.killSwitchPool.shutdown();</span>
<span class="line-removed">439             LdapTimeoutTest.testPool.shutdown();</span>
440         }
441     }
442 
<a name="65" id="anc65"></a><span class="line-modified">443 }</span>






































444 
<a name="66" id="anc66"></a>





<a name="67" id="anc67"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="67" type="hidden" />
</body>
</html>