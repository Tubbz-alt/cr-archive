<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/jdk/com/sun/jndi/ldap/InvalidLdapFilters.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2010, 2012, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /**
 25  * @test
 26  * @bug 6916202 7041125
<a name="2" id="anc2"></a>
 27  * @summary More cases of invalid ldap filters accepted and processed
 28  *      LDAP API does not catch malformed filters that contain two operands
 29  *      for the ! operator
 30  * @run main/othervm InvalidLdapFilters valid (cn=Babs)
 31  * @run main/othervm InvalidLdapFilters valid (&amp;(cn=Bob))
 32  * @run main/othervm InvalidLdapFilters valid (&amp;(objectClass=*)(uid=*))
 33  * @run main/othervm InvalidLdapFilters valid (|(cn=Bob))
 34  * @run main/othervm InvalidLdapFilters valid (|(objectClass=*)(uid=*))
 35  * @run main/othervm InvalidLdapFilters valid (!(cn=Tim))
 36  * @run main/othervm InvalidLdapFilters valid (!(!(cn=Tim)))
 37  * @run main/othervm InvalidLdapFilters valid (!(&amp;(objectClass=*)(uid=*)))
 38  * @run main/othervm InvalidLdapFilters valid (!(|(objectClass=*)(uid=*)))
 39  * @run main/othervm InvalidLdapFilters valid (&amp;(objectClass=*)(!(uid=*)))
 40  * @run main/othervm InvalidLdapFilters valid (o=univ*of*mich*)
 41  * @run main/othervm InvalidLdapFilters valid (seeAlso=)
 42  * @run main/othervm InvalidLdapFilters valid (cn:caseExactMatch:=Flintstone)
 43  * @run main/othervm InvalidLdapFilters valid (cn:=Betty)
 44  * @run main/othervm InvalidLdapFilters valid (sn:dn:2.4.6.8.10:=Barney)
 45  * @run main/othervm InvalidLdapFilters valid (o:dn:=Ace)
 46  * @run main/othervm InvalidLdapFilters valid (:1.2.3:=Wilma)
 47  * @run main/othervm InvalidLdapFilters valid (:DN:2.4.6.8.10:=Dino)
 48  * @run main/othervm InvalidLdapFilters valid (1.2.3=abc)
 49  * @run main/othervm InvalidLdapFilters valid (cn;lang-de;lang-en=abc)
 50  * @run main/othervm InvalidLdapFilters valid (owner=abc)
 51  * @run main/othervm InvalidLdapFilters valid (sn;lang-en:dn:2.4.6.8.10:=Barney)
 52  * @run main/othervm InvalidLdapFilters valid
 53          (&amp;(objectClass=Person)(|(sn=Jensen)(cn=Bab*)))
 54  * @run main/othervm InvalidLdapFilters valid
 55          (orcluserapplnprovstatus;EMAIL_email=PROVISIONING_FAILURE)
 56  * @run main/othervm InvalidLdapFilters invalid &quot;(&amp;(cn=Robert Dean)))&quot;
 57  * @run main/othervm InvalidLdapFilters invalid (&amp;|(cn=Bob))
 58  * @run main/othervm InvalidLdapFilters invalid (&amp;&amp;(cn=Bob))
 59  * @run main/othervm InvalidLdapFilters invalid (|&amp;(cn=Bob))
 60  * @run main/othervm InvalidLdapFilters invalid (||(cn=Bob))
 61  * @run main/othervm InvalidLdapFilters invalid (:1.2.:=Wilma)
 62  * @run main/othervm InvalidLdapFilters invalid (::DN:2.4.6.8.10:=Dino)
 63  * @run main/othervm InvalidLdapFilters invalid (:DN::2.4.6.8.10:=Dino)
 64  * @run main/othervm InvalidLdapFilters invalid (:DN:2.4.6.8.10::=Dino)
 65  * @run main/othervm InvalidLdapFilters invalid (:DN:2.4.6..8.10:=Dino)
 66  * @run main/othervm InvalidLdapFilters invalid (:DN:2.4.6.8.:=Dino)
 67  * @run main/othervm InvalidLdapFilters invalid (1.2.;::=abc)
 68  * @run main/othervm InvalidLdapFilters invalid (1.2.3;::=abc)
 69  * @run main/othervm InvalidLdapFilters invalid (1.2.3;x;=abc)
 70  * @run main/othervm InvalidLdapFilters invalid (1.2.3:x::=abc)
 71  * @run main/othervm InvalidLdapFilters invalid (1.2.3:x=abc)
 72  * @run main/othervm InvalidLdapFilters invalid (sn;:dn:2.4.6.8.10:=Barney)
 73  * @run main/othervm InvalidLdapFilters invalid &quot;\&quot;((objectClass=*)&amp;(uid=*))\&quot;&quot;
 74  * @run main/othervm InvalidLdapFilters invalid &quot;&amp;(objectClass=*)(uid=*)&quot;
 75  * @run main/othervm InvalidLdapFilters invalid &quot;(:DN:2.4.6.8.10:cn:=Dino)&quot;
 76  * @run main/othervm InvalidLdapFilters invalid &quot;(:DN:2.4.6.8.10:cn=Dino)&quot;
 77  * @run main/othervm InvalidLdapFilters invalid
 78          &quot;((objectCategory=person)(cn=u)(!(cn=u2*)))&quot;
 79  * @run main/othervm InvalidLdapFilters invalid
 80          &quot;((&amp;(objectClass=user)(cn=andy*)(cn=steve*)(cn=bob*)))&quot;
 81  * @run main/othervm InvalidLdapFilters invalid
 82          (&amp;(objectClass=Person)(!(sn=Jensen)(cn=Bab)))
 83  *
 84  * @author Xuelei Fan
 85  */
 86 
 87 import java.io.*;
 88 import javax.naming.*;
 89 import javax.naming.directory.*;
<a name="3" id="anc3"></a><span class="line-modified"> 90 import java.util.Properties;</span>


 91 import java.util.Hashtable;
 92 
 93 import java.net.Socket;
 94 import java.net.ServerSocket;
 95 
<a name="4" id="anc4"></a>

 96 public class InvalidLdapFilters {
 97     // Should we run the client or server in a separate thread?
 98     //
 99     // Both sides can throw exceptions, but do you have a preference
100     // as to which side should be the main thread.
101     static boolean separateServerThread = true;
102 
103     // use any free port by default
104     volatile int serverPort = 0;
105 
106     // Is the server ready to serve?
107     volatile static boolean serverReady = false;
108 
109     // Define the server side of the test.
110     //
111     // If the server prematurely exits, serverReady will be set to true
112     // to avoid infinite hangs.
113     void doServerSide() throws Exception {
<a name="5" id="anc5"></a><span class="line-modified">114         ServerSocket serverSock = new ServerSocket(serverPort);</span>




115 
<a name="6" id="anc6"></a><span class="line-modified">116         // signal client, it&#39;s ready to accecpt connection</span>
117         serverPort = serverSock.getLocalPort();
118         serverReady = true;
119 
120         // accept a connection
121         Socket socket = serverSock.accept();
122         System.out.println(&quot;Server: Connection accepted&quot;);
123 
124         InputStream is = socket.getInputStream();
125         OutputStream os = socket.getOutputStream();
126 
127         // read the bindRequest
128         while (is.read() != -1) {
129             // ignore
130             is.skip(is.available());
131             break;
132         }
133 
134         byte[] bindResponse = {0x30, 0x0C, 0x02, 0x01, 0x01, 0x61, 0x07, 0x0A,
135                                0x01, 0x00, 0x04, 0x00, 0x04, 0x00};
136         // write bindResponse
137         os.write(bindResponse);
138         os.flush();
139 
140         // ignore any more request.
141         while (is.read() != -1) {
142             // ignore
143             is.skip(is.available());
144         }
145 
146         is.close();
147         os.close();
148         socket.close();
149         serverSock.close();
150     }
151 
152     //  Define the client side of the test.
153     //
154     // If the server prematurely exits, serverReady will be set to true
155     // to avoid infinite hangs.
156     void doClientSide() throws Exception {
157         // Wait for server to get started.
158         while (!serverReady) {
159             Thread.sleep(50);
160         }
161 
162         // set up the environment for creating the initial context
<a name="7" id="anc7"></a><span class="line-modified">163         Hashtable&lt;Object, Object&gt; env = new Hashtable&lt;Object, Object&gt;();</span>
164         env.put(Context.INITIAL_CONTEXT_FACTORY,
165                                 &quot;com.sun.jndi.ldap.LdapCtxFactory&quot;);
<a name="8" id="anc8"></a><span class="line-modified">166         env.put(Context.PROVIDER_URL, &quot;ldap://localhost:&quot; + serverPort);</span>






167         env.put(&quot;com.sun.jndi.ldap.read.timeout&quot;, &quot;1000&quot;);
168 
169         // env.put(Context.SECURITY_AUTHENTICATION, &quot;simple&quot;);
170         // env.put(Context.SECURITY_PRINCIPAL,&quot;cn=root&quot;);
171         // env.put(Context.SECURITY_CREDENTIALS,&quot;root&quot;);
172 
173         // create initial context
174         DirContext context = null;
175         int i = 0;
176         while (true) {
177             try {
178                 context = new InitialDirContext(env);
179                 break;
180             } catch (NamingException ne) {
181                 // may be a connection or read timeout, try again
182                 // no more than 5 times
183                 if (i++ &gt; 5) {
184                     throw new Exception(
185                         &quot;Maybe timeout during context initialization&quot;, ne);
186                 }
187             }
188         }
189 
190         // searching
191         SearchControls scs = new SearchControls();
192         scs.setSearchScope(SearchControls.SUBTREE_SCOPE);
193 
194         try {
195             NamingEnumeration answer =
196                     context.search(&quot;o=sun,c=us&quot;, searchFilter, scs);
197         } catch (InvalidSearchFilterException isfe) {
198             if (filterIsValid) {
199                 // unexpected filter exception.
200                 throw new Exception(&quot;Unexpected ISFE&quot;, isfe);
201             } else {
202                 // ignore, it is the expected filter exception.
203                 System.out.println(&quot;Expected exception: &quot; + isfe.getMessage());
204             }
205         } catch (NamingException ne) {
206             // maybe a read timeout exception, as the server does not response.
207             if (filterIsValid) {
208                 System.out.println(&quot;Expected exception: &quot; + ne.getMessage());
209             } else {
210                 throw new Exception(&quot;Not an InvalidSearchFilterException&quot;, ne);
211             }
212         }
213 
214         context.close();
215     }
216 
217     private static boolean filterIsValid;
218     private static String searchFilter;
219 
220     private static void parseArguments(String[] args) {
221         System.out.println(&quot;arguments length: &quot; + args.length);
222         if (args[0].equals(&quot;valid&quot;)) {
223           filterIsValid = true;
224         }
225 
226         searchFilter = args[1];
227     }
228 
229     /*
230      * ============================================================
231      * The remainder is just support stuff
232      */
233 
234     // client and server thread
235     Thread clientThread = null;
236     Thread serverThread = null;
237 
238     // client and server exceptions
239     volatile Exception serverException = null;
240     volatile Exception clientException = null;
241 
242     void startServer(boolean newThread) throws Exception {
243         if (newThread) {
244             serverThread = new Thread() {
245                 public void run() {
246                     try {
247                         doServerSide();
248                     } catch (Exception e) {
249                         /*
250                          * Our server thread just died.
251                          *
252                          * Release the client, if not active already...
253                          */
254                         System.err.println(&quot;Server died...&quot;);
255                         System.err.println(e);
256                         serverReady = true;
257                         serverException = e;
258                     }
259                 }
260             };
261             serverThread.start();
262         } else {
263             doServerSide();
264         }
265     }
266 
267     void startClient(boolean newThread) throws Exception {
268         if (newThread) {
269             clientThread = new Thread() {
270                 public void run() {
271                     try {
272                         doClientSide();
273                     } catch (Exception e) {
274                         /*
275                          * Our client thread just died.
276                          */
277                         System.err.println(&quot;Client died...&quot;);
278                         clientException = e;
279                     }
280                 }
281             };
282             clientThread.start();
283         } else {
284             doClientSide();
285         }
286     }
287 
288     // Primary constructor, used to drive remainder of the test.
289     InvalidLdapFilters() throws Exception {
290         if (separateServerThread) {
291             startServer(true);
292             startClient(false);
293         } else {
294             startClient(true);
295             startServer(false);
296         }
297 
298         /*
299          * Wait for other side to close down.
300          */
301         if (separateServerThread) {
302             serverThread.join();
303         } else {
304             clientThread.join();
305         }
306 
307         /*
308          * When we get here, the test is pretty much over.
309          *
310          * If the main thread excepted, that propagates back
311          * immediately.  If the other thread threw an exception, we
312          * should report back.
313          */
314         if (serverException != null) {
315             System.out.print(&quot;Server Exception:&quot;);
316             throw serverException;
317         }
318         if (clientException != null) {
319             System.out.print(&quot;Client Exception:&quot;);
320             throw clientException;
321         }
322     }
323 
324     public static void main(String[] args) throws Exception {
325         // parse the customized arguments
326         parseArguments(args);
327 
328         // start the test
329         new InvalidLdapFilters();
330     }
331 
332 }
<a name="9" id="anc9"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="9" type="hidden" />
</body>
</html>