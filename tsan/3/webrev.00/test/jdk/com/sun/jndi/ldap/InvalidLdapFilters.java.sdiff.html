<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/com/sun/jndi/ldap/InvalidLdapFilters.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="../../jdi/lib/jdb/JdbTest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="LdapDnsProviderTest.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/com/sun/jndi/ldap/InvalidLdapFilters.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2010, 2012, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /**
 25  * @test
 26  * @bug 6916202 7041125

 27  * @summary More cases of invalid ldap filters accepted and processed
 28  *      LDAP API does not catch malformed filters that contain two operands
 29  *      for the ! operator
 30  * @run main/othervm InvalidLdapFilters valid (cn=Babs)
 31  * @run main/othervm InvalidLdapFilters valid (&amp;(cn=Bob))
 32  * @run main/othervm InvalidLdapFilters valid (&amp;(objectClass=*)(uid=*))
 33  * @run main/othervm InvalidLdapFilters valid (|(cn=Bob))
 34  * @run main/othervm InvalidLdapFilters valid (|(objectClass=*)(uid=*))
 35  * @run main/othervm InvalidLdapFilters valid (!(cn=Tim))
 36  * @run main/othervm InvalidLdapFilters valid (!(!(cn=Tim)))
 37  * @run main/othervm InvalidLdapFilters valid (!(&amp;(objectClass=*)(uid=*)))
 38  * @run main/othervm InvalidLdapFilters valid (!(|(objectClass=*)(uid=*)))
 39  * @run main/othervm InvalidLdapFilters valid (&amp;(objectClass=*)(!(uid=*)))
 40  * @run main/othervm InvalidLdapFilters valid (o=univ*of*mich*)
 41  * @run main/othervm InvalidLdapFilters valid (seeAlso=)
 42  * @run main/othervm InvalidLdapFilters valid (cn:caseExactMatch:=Flintstone)
 43  * @run main/othervm InvalidLdapFilters valid (cn:=Betty)
 44  * @run main/othervm InvalidLdapFilters valid (sn:dn:2.4.6.8.10:=Barney)
 45  * @run main/othervm InvalidLdapFilters valid (o:dn:=Ace)
 46  * @run main/othervm InvalidLdapFilters valid (:1.2.3:=Wilma)
</pre>
<hr />
<pre>
 70  * @run main/othervm InvalidLdapFilters invalid (1.2.3:x::=abc)
 71  * @run main/othervm InvalidLdapFilters invalid (1.2.3:x=abc)
 72  * @run main/othervm InvalidLdapFilters invalid (sn;:dn:2.4.6.8.10:=Barney)
 73  * @run main/othervm InvalidLdapFilters invalid &quot;\&quot;((objectClass=*)&amp;(uid=*))\&quot;&quot;
 74  * @run main/othervm InvalidLdapFilters invalid &quot;&amp;(objectClass=*)(uid=*)&quot;
 75  * @run main/othervm InvalidLdapFilters invalid &quot;(:DN:2.4.6.8.10:cn:=Dino)&quot;
 76  * @run main/othervm InvalidLdapFilters invalid &quot;(:DN:2.4.6.8.10:cn=Dino)&quot;
 77  * @run main/othervm InvalidLdapFilters invalid
 78          &quot;((objectCategory=person)(cn=u)(!(cn=u2*)))&quot;
 79  * @run main/othervm InvalidLdapFilters invalid
 80          &quot;((&amp;(objectClass=user)(cn=andy*)(cn=steve*)(cn=bob*)))&quot;
 81  * @run main/othervm InvalidLdapFilters invalid
 82          (&amp;(objectClass=Person)(!(sn=Jensen)(cn=Bab)))
 83  *
 84  * @author Xuelei Fan
 85  */
 86 
 87 import java.io.*;
 88 import javax.naming.*;
 89 import javax.naming.directory.*;
<span class="line-modified"> 90 import java.util.Properties;</span>


 91 import java.util.Hashtable;
 92 
 93 import java.net.Socket;
 94 import java.net.ServerSocket;
 95 


 96 public class InvalidLdapFilters {
 97     // Should we run the client or server in a separate thread?
 98     //
 99     // Both sides can throw exceptions, but do you have a preference
100     // as to which side should be the main thread.
101     static boolean separateServerThread = true;
102 
103     // use any free port by default
104     volatile int serverPort = 0;
105 
106     // Is the server ready to serve?
107     volatile static boolean serverReady = false;
108 
109     // Define the server side of the test.
110     //
111     // If the server prematurely exits, serverReady will be set to true
112     // to avoid infinite hangs.
113     void doServerSide() throws Exception {
<span class="line-modified">114         ServerSocket serverSock = new ServerSocket(serverPort);</span>




115 
<span class="line-modified">116         // signal client, it&#39;s ready to accecpt connection</span>
117         serverPort = serverSock.getLocalPort();
118         serverReady = true;
119 
120         // accept a connection
121         Socket socket = serverSock.accept();
122         System.out.println(&quot;Server: Connection accepted&quot;);
123 
124         InputStream is = socket.getInputStream();
125         OutputStream os = socket.getOutputStream();
126 
127         // read the bindRequest
128         while (is.read() != -1) {
129             // ignore
130             is.skip(is.available());
131             break;
132         }
133 
134         byte[] bindResponse = {0x30, 0x0C, 0x02, 0x01, 0x01, 0x61, 0x07, 0x0A,
135                                0x01, 0x00, 0x04, 0x00, 0x04, 0x00};
136         // write bindResponse
</pre>
<hr />
<pre>
143             is.skip(is.available());
144         }
145 
146         is.close();
147         os.close();
148         socket.close();
149         serverSock.close();
150     }
151 
152     //  Define the client side of the test.
153     //
154     // If the server prematurely exits, serverReady will be set to true
155     // to avoid infinite hangs.
156     void doClientSide() throws Exception {
157         // Wait for server to get started.
158         while (!serverReady) {
159             Thread.sleep(50);
160         }
161 
162         // set up the environment for creating the initial context
<span class="line-modified">163         Hashtable&lt;Object, Object&gt; env = new Hashtable&lt;Object, Object&gt;();</span>
164         env.put(Context.INITIAL_CONTEXT_FACTORY,
165                                 &quot;com.sun.jndi.ldap.LdapCtxFactory&quot;);
<span class="line-modified">166         env.put(Context.PROVIDER_URL, &quot;ldap://localhost:&quot; + serverPort);</span>






167         env.put(&quot;com.sun.jndi.ldap.read.timeout&quot;, &quot;1000&quot;);
168 
169         // env.put(Context.SECURITY_AUTHENTICATION, &quot;simple&quot;);
170         // env.put(Context.SECURITY_PRINCIPAL,&quot;cn=root&quot;);
171         // env.put(Context.SECURITY_CREDENTIALS,&quot;root&quot;);
172 
173         // create initial context
174         DirContext context = null;
175         int i = 0;
176         while (true) {
177             try {
178                 context = new InitialDirContext(env);
179                 break;
180             } catch (NamingException ne) {
181                 // may be a connection or read timeout, try again
182                 // no more than 5 times
183                 if (i++ &gt; 5) {
184                     throw new Exception(
185                         &quot;Maybe timeout during context initialization&quot;, ne);
186                 }
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2010, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /**
 25  * @test
 26  * @bug 6916202 7041125
<span class="line-added"> 27  * @library /test/lib</span>
 28  * @summary More cases of invalid ldap filters accepted and processed
 29  *      LDAP API does not catch malformed filters that contain two operands
 30  *      for the ! operator
 31  * @run main/othervm InvalidLdapFilters valid (cn=Babs)
 32  * @run main/othervm InvalidLdapFilters valid (&amp;(cn=Bob))
 33  * @run main/othervm InvalidLdapFilters valid (&amp;(objectClass=*)(uid=*))
 34  * @run main/othervm InvalidLdapFilters valid (|(cn=Bob))
 35  * @run main/othervm InvalidLdapFilters valid (|(objectClass=*)(uid=*))
 36  * @run main/othervm InvalidLdapFilters valid (!(cn=Tim))
 37  * @run main/othervm InvalidLdapFilters valid (!(!(cn=Tim)))
 38  * @run main/othervm InvalidLdapFilters valid (!(&amp;(objectClass=*)(uid=*)))
 39  * @run main/othervm InvalidLdapFilters valid (!(|(objectClass=*)(uid=*)))
 40  * @run main/othervm InvalidLdapFilters valid (&amp;(objectClass=*)(!(uid=*)))
 41  * @run main/othervm InvalidLdapFilters valid (o=univ*of*mich*)
 42  * @run main/othervm InvalidLdapFilters valid (seeAlso=)
 43  * @run main/othervm InvalidLdapFilters valid (cn:caseExactMatch:=Flintstone)
 44  * @run main/othervm InvalidLdapFilters valid (cn:=Betty)
 45  * @run main/othervm InvalidLdapFilters valid (sn:dn:2.4.6.8.10:=Barney)
 46  * @run main/othervm InvalidLdapFilters valid (o:dn:=Ace)
 47  * @run main/othervm InvalidLdapFilters valid (:1.2.3:=Wilma)
</pre>
<hr />
<pre>
 71  * @run main/othervm InvalidLdapFilters invalid (1.2.3:x::=abc)
 72  * @run main/othervm InvalidLdapFilters invalid (1.2.3:x=abc)
 73  * @run main/othervm InvalidLdapFilters invalid (sn;:dn:2.4.6.8.10:=Barney)
 74  * @run main/othervm InvalidLdapFilters invalid &quot;\&quot;((objectClass=*)&amp;(uid=*))\&quot;&quot;
 75  * @run main/othervm InvalidLdapFilters invalid &quot;&amp;(objectClass=*)(uid=*)&quot;
 76  * @run main/othervm InvalidLdapFilters invalid &quot;(:DN:2.4.6.8.10:cn:=Dino)&quot;
 77  * @run main/othervm InvalidLdapFilters invalid &quot;(:DN:2.4.6.8.10:cn=Dino)&quot;
 78  * @run main/othervm InvalidLdapFilters invalid
 79          &quot;((objectCategory=person)(cn=u)(!(cn=u2*)))&quot;
 80  * @run main/othervm InvalidLdapFilters invalid
 81          &quot;((&amp;(objectClass=user)(cn=andy*)(cn=steve*)(cn=bob*)))&quot;
 82  * @run main/othervm InvalidLdapFilters invalid
 83          (&amp;(objectClass=Person)(!(sn=Jensen)(cn=Bab)))
 84  *
 85  * @author Xuelei Fan
 86  */
 87 
 88 import java.io.*;
 89 import javax.naming.*;
 90 import javax.naming.directory.*;
<span class="line-modified"> 91 import java.net.InetAddress;</span>
<span class="line-added"> 92 import java.net.InetSocketAddress;</span>
<span class="line-added"> 93 import java.net.SocketAddress;</span>
 94 import java.util.Hashtable;
 95 
 96 import java.net.Socket;
 97 import java.net.ServerSocket;
 98 
<span class="line-added"> 99 import jdk.test.lib.net.URIBuilder;</span>
<span class="line-added">100 </span>
101 public class InvalidLdapFilters {
102     // Should we run the client or server in a separate thread?
103     //
104     // Both sides can throw exceptions, but do you have a preference
105     // as to which side should be the main thread.
106     static boolean separateServerThread = true;
107 
108     // use any free port by default
109     volatile int serverPort = 0;
110 
111     // Is the server ready to serve?
112     volatile static boolean serverReady = false;
113 
114     // Define the server side of the test.
115     //
116     // If the server prematurely exits, serverReady will be set to true
117     // to avoid infinite hangs.
118     void doServerSide() throws Exception {
<span class="line-modified">119         ServerSocket serverSock = new ServerSocket();</span>
<span class="line-added">120         SocketAddress sockAddr = new InetSocketAddress(</span>
<span class="line-added">121                 InetAddress.getLoopbackAddress(), serverPort);</span>
<span class="line-added">122         // Bind server socket</span>
<span class="line-added">123         serverSock.bind(sockAddr);</span>
124 
<span class="line-modified">125         // signal client, it&#39;s ready to accept connection</span>
126         serverPort = serverSock.getLocalPort();
127         serverReady = true;
128 
129         // accept a connection
130         Socket socket = serverSock.accept();
131         System.out.println(&quot;Server: Connection accepted&quot;);
132 
133         InputStream is = socket.getInputStream();
134         OutputStream os = socket.getOutputStream();
135 
136         // read the bindRequest
137         while (is.read() != -1) {
138             // ignore
139             is.skip(is.available());
140             break;
141         }
142 
143         byte[] bindResponse = {0x30, 0x0C, 0x02, 0x01, 0x01, 0x61, 0x07, 0x0A,
144                                0x01, 0x00, 0x04, 0x00, 0x04, 0x00};
145         // write bindResponse
</pre>
<hr />
<pre>
152             is.skip(is.available());
153         }
154 
155         is.close();
156         os.close();
157         socket.close();
158         serverSock.close();
159     }
160 
161     //  Define the client side of the test.
162     //
163     // If the server prematurely exits, serverReady will be set to true
164     // to avoid infinite hangs.
165     void doClientSide() throws Exception {
166         // Wait for server to get started.
167         while (!serverReady) {
168             Thread.sleep(50);
169         }
170 
171         // set up the environment for creating the initial context
<span class="line-modified">172         Hashtable&lt;Object, Object&gt; env = new Hashtable&lt;&gt;();</span>
173         env.put(Context.INITIAL_CONTEXT_FACTORY,
174                                 &quot;com.sun.jndi.ldap.LdapCtxFactory&quot;);
<span class="line-modified">175         String providerUrl = URIBuilder.newBuilder()</span>
<span class="line-added">176                 .scheme(&quot;ldap&quot;)</span>
<span class="line-added">177                 .loopback()</span>
<span class="line-added">178                 .port(serverPort)</span>
<span class="line-added">179                 .build()</span>
<span class="line-added">180                 .toString();</span>
<span class="line-added">181         env.put(Context.PROVIDER_URL, providerUrl);</span>
182         env.put(&quot;com.sun.jndi.ldap.read.timeout&quot;, &quot;1000&quot;);
183 
184         // env.put(Context.SECURITY_AUTHENTICATION, &quot;simple&quot;);
185         // env.put(Context.SECURITY_PRINCIPAL,&quot;cn=root&quot;);
186         // env.put(Context.SECURITY_CREDENTIALS,&quot;root&quot;);
187 
188         // create initial context
189         DirContext context = null;
190         int i = 0;
191         while (true) {
192             try {
193                 context = new InitialDirContext(env);
194                 break;
195             } catch (NamingException ne) {
196                 // may be a connection or read timeout, try again
197                 // no more than 5 times
198                 if (i++ &gt; 5) {
199                     throw new Exception(
200                         &quot;Maybe timeout during context initialization&quot;, ne);
201                 }
</pre>
</td>
</tr>
</table>
<center><a href="../../jdi/lib/jdb/JdbTest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="LdapDnsProviderTest.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>