<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/jdk/com/sun/jndi/ldap/LdapTimeoutTest.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2011, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
<a name="2" id="anc2"></a><span class="line-modified"> 24 /*</span>
 25  * @test
<a name="3" id="anc3"></a><span class="line-modified"> 26  * @library /test/lib</span>
<span class="line-modified"> 27  *          lib/</span>
<span class="line-added"> 28  * @run testng/othervm LdapTimeoutTest</span>
<span class="line-added"> 29  * @bug 7094377 8000487 6176036 7056489 8151678</span>
 30  * @summary Timeout tests for ldap
 31  */
 32 
<a name="4" id="anc4"></a><span class="line-added"> 33 import org.testng.Assert;</span>
<span class="line-added"> 34 import org.testng.annotations.BeforeTest;</span>
<span class="line-added"> 35 import org.testng.annotations.Test;</span>
<span class="line-added"> 36 </span>
<span class="line-added"> 37 import javax.naming.Context;</span>
<span class="line-added"> 38 import javax.naming.NamingException;</span>
<span class="line-added"> 39 import javax.naming.directory.InitialDirContext;</span>
<span class="line-added"> 40 import javax.naming.directory.SearchControls;</span>
<span class="line-added"> 41 import java.io.IOException;</span>
<span class="line-added"> 42 import java.io.OutputStream;</span>
 43 import java.net.Socket;
<a name="5" id="anc5"></a>






 44 import java.util.ArrayList;
<a name="6" id="anc6"></a><span class="line-added"> 45 import java.util.Hashtable;</span>
<span class="line-added"> 46 import java.util.List;</span>
<span class="line-added"> 47 import java.util.Objects;</span>
 48 import java.util.concurrent.Callable;
<a name="7" id="anc7"></a><span class="line-added"> 49 import java.util.concurrent.CompletableFuture;</span>
 50 import java.util.concurrent.ExecutionException;
<a name="8" id="anc8"></a>
 51 import java.util.concurrent.ExecutorService;
<a name="9" id="anc9"></a><span class="line-added"> 52 import java.util.concurrent.Executors;</span>
 53 import java.util.concurrent.Future;
<a name="10" id="anc10"></a><span class="line-modified"> 54 import java.util.concurrent.FutureTask;</span>
<span class="line-modified"> 55 import java.util.concurrent.SynchronousQueue;</span>

 56 import java.util.concurrent.TimeUnit;
<a name="11" id="anc11"></a><span class="line-modified"> 57 import java.util.concurrent.TimeoutException;</span>
 58 
<a name="12" id="anc12"></a><span class="line-added"> 59 import static java.lang.String.format;</span>
 60 import static java.util.concurrent.TimeUnit.MILLISECONDS;
 61 import static java.util.concurrent.TimeUnit.NANOSECONDS;
<a name="13" id="anc13"></a><span class="line-added"> 62 import static jdk.test.lib.Utils.adjustTimeout;</span>
<span class="line-added"> 63 import static org.testng.Assert.assertTrue;</span>
<span class="line-added"> 64 import static org.testng.Assert.expectThrows;</span>
 65 
<a name="14" id="anc14"></a><span class="line-added"> 66 public class LdapTimeoutTest {</span>
 67 
<a name="15" id="anc15"></a><span class="line-modified"> 68     // ------ configure test timeouts here ------</span>
<span class="line-modified"> 69 </span>
<span class="line-modified"> 70     /*</span>
<span class="line-modified"> 71      * Practical representation of an infinite timeout.</span>
<span class="line-modified"> 72      */</span>
<span class="line-modified"> 73     private static final long INFINITY_MILLIS = adjustTimeout(20_000);</span>
<span class="line-modified"> 74     /*</span>
<span class="line-modified"> 75      * The acceptable variation in timeout measurements.</span>
<span class="line-modified"> 76      */</span>
<span class="line-modified"> 77     private static final long TOLERANCE       = adjustTimeout( 3_500);</span>
<span class="line-modified"> 78 </span>
<span class="line-modified"> 79     private static final long CONNECT_MILLIS  = adjustTimeout( 3_000);</span>
<span class="line-modified"> 80     private static final long READ_MILLIS     = adjustTimeout(10_000);</span>
<span class="line-modified"> 81 </span>
<span class="line-modified"> 82     static {</span>
<span class="line-modified"> 83         // a series of checks to make sure this timeouts configuration is</span>
<span class="line-modified"> 84         // consistent and the timeouts do not overlap</span>
<span class="line-modified"> 85 </span>
<span class="line-modified"> 86         assert (TOLERANCE &gt;= 0);</span>
<span class="line-modified"> 87         // context creation</span>
<span class="line-modified"> 88         assert (2 * CONNECT_MILLIS + TOLERANCE &lt; READ_MILLIS);</span>
<span class="line-modified"> 89         // context creation immediately followed by search</span>
<span class="line-modified"> 90         assert (2 * CONNECT_MILLIS + READ_MILLIS + TOLERANCE &lt; INFINITY_MILLIS);</span>







 91     }
 92 
<a name="16" id="anc16"></a><span class="line-modified"> 93     @BeforeTest</span>
<span class="line-modified"> 94     public void beforeTest() {</span>
<span class="line-added"> 95         startAuxiliaryDiagnosticOutput();</span>
 96     }
 97 
<a name="17" id="anc17"></a><span class="line-modified"> 98     /*</span>
<span class="line-added"> 99      * These are timeout tests and they are run in parallel to reduce the total</span>
<span class="line-added">100      * amount of run time.</span>
<span class="line-added">101      *</span>
<span class="line-added">102      * Currently it doesn&#39;t seem possible to instruct JTREG to run TestNG test</span>
<span class="line-added">103      * methods in parallel. That said, this JTREG test is still</span>
<span class="line-added">104      * a &quot;TestNG-flavored&quot; test for the sake of having org.testng.Assert</span>
<span class="line-added">105      * capability.</span>
<span class="line-added">106      */</span>
<span class="line-added">107     @Test</span>
<span class="line-added">108     public void test() throws Exception {</span>
<span class="line-added">109         List&lt;Future&lt;?&gt;&gt; futures = new ArrayList&lt;&gt;();</span>
<span class="line-added">110         ExecutorService executorService = Executors.newCachedThreadPool();</span>
111         try {
<a name="18" id="anc18"></a><span class="line-modified">112             futures.add(executorService.submit(() -&gt; { test1(); return null; }));</span>
<span class="line-modified">113             futures.add(executorService.submit(() -&gt; { test2(); return null; }));</span>
<span class="line-modified">114             futures.add(executorService.submit(() -&gt; { test3(); return null; }));</span>
<span class="line-modified">115             futures.add(executorService.submit(() -&gt; { test4(); return null; }));</span>
<span class="line-added">116             futures.add(executorService.submit(() -&gt; { test5(); return null; }));</span>
<span class="line-added">117             futures.add(executorService.submit(() -&gt; { test6(); return null; }));</span>
<span class="line-added">118             futures.add(executorService.submit(() -&gt; { test7(); return null; }));</span>
<span class="line-added">119         } finally {</span>
<span class="line-added">120             executorService.shutdown();</span>
121         }
<a name="19" id="anc19"></a><span class="line-modified">122         int failedCount = 0;</span>
<span class="line-modified">123         for (var f : futures) {</span>


























124             try {
<a name="20" id="anc20"></a><span class="line-modified">125                 f.get();</span>
<span class="line-modified">126             } catch (ExecutionException e) {</span>
<span class="line-modified">127                 failedCount++;</span>
<span class="line-modified">128                 e.getCause().printStackTrace(System.out);</span>









129             }
<a name="21" id="anc21"></a>


130         }
<a name="22" id="anc22"></a><span class="line-added">131         if (failedCount &gt; 0)</span>
<span class="line-added">132             throw new RuntimeException(failedCount + &quot; (sub)tests failed&quot;);</span>
133     }
<a name="23" id="anc23"></a>


134 
<a name="24" id="anc24"></a><span class="line-modified">135     static void test1() throws Exception {</span>
<span class="line-modified">136         Hashtable&lt;Object, Object&gt; env = new Hashtable&lt;&gt;();</span>
<span class="line-added">137         env.put(Context.INITIAL_CONTEXT_FACTORY, &quot;com.sun.jndi.ldap.LdapCtxFactory&quot;);</span>
<span class="line-added">138         // Here and in the other tests it&#39;s important to close the server as</span>
<span class="line-added">139         // calling `thread.interrupt` from assertion may not be enough</span>
<span class="line-added">140         // (depending on where the blocking call has stuck)</span>
<span class="line-added">141         try (TestServer server = new NotBindableServer()) {</span>
<span class="line-added">142             env.put(Context.PROVIDER_URL, urlTo(server));</span>
<span class="line-added">143             server.start();</span>
<span class="line-added">144             // Here and in the other tests joining done purely to reduce timing</span>
<span class="line-added">145             // jitter. Commenting out or removing that should not make the test</span>
<span class="line-added">146             // incorrect. (ServerSocket can accept connection as soon as it is</span>
<span class="line-added">147             // bound, not need to call `accept` before that.)</span>
<span class="line-added">148             server.starting().join();</span>
<span class="line-added">149             assertIncompletion(INFINITY_MILLIS, () -&gt; new InitialDirContext(env));</span>
<span class="line-added">150         }</span>
151     }
152 
<a name="25" id="anc25"></a><span class="line-modified">153     static void test2() throws Exception {</span>
<span class="line-modified">154         Hashtable&lt;Object, Object&gt; env = new Hashtable&lt;&gt;();</span>
<span class="line-modified">155         env.put(Context.INITIAL_CONTEXT_FACTORY, &quot;com.sun.jndi.ldap.LdapCtxFactory&quot;);</span>
<span class="line-modified">156         env.put(&quot;com.sun.jndi.ldap.connect.timeout&quot;, String.valueOf(CONNECT_MILLIS));</span>
<span class="line-modified">157         try (TestServer server = new BindableButNotReadableServer()) {</span>
<span class="line-added">158             env.put(Context.PROVIDER_URL, urlTo(server));</span>
<span class="line-added">159             server.start();</span>
<span class="line-added">160             server.starting().join();</span>
<span class="line-added">161             InitialDirContext ctx = new InitialDirContext(env);</span>
<span class="line-added">162             SearchControls scl = new SearchControls();</span>
<span class="line-added">163             scl.setSearchScope(SearchControls.SUBTREE_SCOPE);</span>
<span class="line-added">164             assertIncompletion(INFINITY_MILLIS,</span>
<span class="line-added">165                                () -&gt; ctx.search(&quot;ou=People,o=JNDITutorial&quot;, &quot;(objectClass=*)&quot;, scl));</span>
<span class="line-added">166         }</span>
167     }
168 
<a name="26" id="anc26"></a><span class="line-modified">169     static void test3() throws Exception {</span>
<span class="line-modified">170         Hashtable&lt;Object, Object&gt; env = new Hashtable&lt;&gt;();</span>
<span class="line-modified">171         env.put(Context.INITIAL_CONTEXT_FACTORY, &quot;com.sun.jndi.ldap.LdapCtxFactory&quot;);</span>
<span class="line-modified">172         try (TestServer server = new BindableButNotReadableServer()) {</span>
<span class="line-modified">173             env.put(Context.PROVIDER_URL, urlTo(server));</span>
<span class="line-added">174             server.start();</span>
<span class="line-added">175             server.starting().join();</span>
<span class="line-added">176             InitialDirContext ctx = new InitialDirContext(env);</span>
<span class="line-added">177             SearchControls scl = new SearchControls();</span>
<span class="line-added">178             scl.setSearchScope(SearchControls.SUBTREE_SCOPE);</span>
<span class="line-added">179             assertIncompletion(INFINITY_MILLIS,</span>
<span class="line-added">180                                () -&gt; ctx.search(&quot;ou=People,o=JNDITutorial&quot;, &quot;(objectClass=*)&quot;, scl));</span>
<span class="line-added">181         }</span>
182     }
<a name="27" id="anc27"></a>


183 
<a name="28" id="anc28"></a><span class="line-modified">184     static void test4() throws Exception {</span>
<span class="line-modified">185         Hashtable&lt;Object, Object&gt; env = new Hashtable&lt;&gt;();</span>
<span class="line-added">186         env.put(Context.INITIAL_CONTEXT_FACTORY, &quot;com.sun.jndi.ldap.LdapCtxFactory&quot;);</span>
<span class="line-added">187         env.put(&quot;com.sun.jndi.ldap.connect.timeout&quot;, String.valueOf(CONNECT_MILLIS));</span>
<span class="line-added">188         env.put(&quot;com.sun.jndi.ldap.read.timeout&quot;, String.valueOf(READ_MILLIS));</span>
<span class="line-added">189         try (TestServer server = new NotBindableServer()) {</span>
<span class="line-added">190             env.put(Context.PROVIDER_URL, urlTo(server));</span>
<span class="line-added">191             server.start();</span>
<span class="line-added">192             server.starting().join();</span>
<span class="line-added">193             Assert.ThrowingRunnable completion =</span>
<span class="line-added">194                     () -&gt; assertCompletion(CONNECT_MILLIS,</span>
<span class="line-added">195                                            2 * CONNECT_MILLIS + TOLERANCE,</span>
<span class="line-added">196                                            () -&gt; new InitialDirContext(env));</span>
<span class="line-added">197             NamingException e = expectThrows(NamingException.class, completion);</span>
<span class="line-added">198             String msg = e.getMessage();</span>
<span class="line-added">199             assertTrue(msg != null &amp;&amp; msg.contains(&quot;timeout&quot;)</span>
<span class="line-added">200                                &amp;&amp; msg.contains(String.valueOf(CONNECT_MILLIS)),</span>
<span class="line-added">201                        msg);</span>
<span class="line-added">202         }</span>
203     }
204 
<a name="29" id="anc29"></a><span class="line-modified">205     static void test5() throws Exception {</span>
<span class="line-modified">206         Hashtable&lt;Object, Object&gt; env = new Hashtable&lt;&gt;();</span>
<span class="line-modified">207         env.put(Context.INITIAL_CONTEXT_FACTORY, &quot;com.sun.jndi.ldap.LdapCtxFactory&quot;);</span>
<span class="line-modified">208         env.put(&quot;com.sun.jndi.ldap.connect.timeout&quot;, String.valueOf(CONNECT_MILLIS));</span>
<span class="line-modified">209         env.put(&quot;com.sun.jndi.ldap.read.timeout&quot;, String.valueOf(READ_MILLIS));</span>
<span class="line-added">210         try (TestServer server = new BindableButNotReadableServer()) {</span>
<span class="line-added">211             env.put(Context.PROVIDER_URL, urlTo(server));</span>
<span class="line-added">212             server.start();</span>
<span class="line-added">213             server.starting().join();</span>
<span class="line-added">214             InitialDirContext ctx = new InitialDirContext(env);</span>
<span class="line-added">215             SearchControls scl = new SearchControls();</span>
<span class="line-added">216             scl.setSearchScope(SearchControls.SUBTREE_SCOPE);</span>
<span class="line-added">217             Assert.ThrowingRunnable completion =</span>
<span class="line-added">218                     () -&gt; assertCompletion(READ_MILLIS,</span>
<span class="line-added">219                                            READ_MILLIS + TOLERANCE,</span>
<span class="line-added">220                                            () -&gt; ctx.search(&quot;ou=People,o=JNDITutorial&quot;, &quot;(objectClass=*)&quot;, scl));</span>
<span class="line-added">221             NamingException e = expectThrows(NamingException.class, completion);</span>
<span class="line-added">222             String msg = e.getMessage();</span>
<span class="line-added">223             assertTrue(msg != null &amp;&amp; msg.contains(&quot;timeout&quot;)</span>
<span class="line-added">224                                &amp;&amp; msg.contains(String.valueOf(READ_MILLIS)),</span>
<span class="line-added">225                        msg);</span>
<span class="line-added">226         }</span>
227     }
228 
<a name="30" id="anc30"></a><span class="line-modified">229     static void test6() throws Exception {</span>
<span class="line-modified">230         Hashtable&lt;Object, Object&gt; env = new Hashtable&lt;&gt;();</span>
<span class="line-modified">231         env.put(Context.INITIAL_CONTEXT_FACTORY, &quot;com.sun.jndi.ldap.LdapCtxFactory&quot;);</span>
<span class="line-modified">232         env.put(&quot;com.sun.jndi.ldap.connect.timeout&quot;, String.valueOf(CONNECT_MILLIS));</span>
<span class="line-modified">233         env.put(&quot;com.sun.jndi.ldap.read.timeout&quot;, String.valueOf(READ_MILLIS));</span>
<span class="line-modified">234         try (TestServer server = new NotBindableServer()) {</span>
<span class="line-modified">235             env.put(Context.PROVIDER_URL, urlTo(server));</span>
<span class="line-modified">236             server.start();</span>
<span class="line-modified">237             server.starting().join();</span>
<span class="line-modified">238             Assert.ThrowingRunnable completion =</span>
<span class="line-added">239                     () -&gt; assertCompletion(CONNECT_MILLIS,</span>
<span class="line-added">240                                            2 * CONNECT_MILLIS + TOLERANCE,</span>
<span class="line-added">241                                            () -&gt; new InitialDirContext(env));</span>
<span class="line-added">242             NamingException e = expectThrows(NamingException.class, completion);</span>
<span class="line-added">243             String msg = e.getMessage();</span>
<span class="line-added">244             assertTrue(msg != null &amp;&amp; msg.contains(&quot;timeout&quot;)</span>
<span class="line-added">245                                &amp;&amp; msg.contains(String.valueOf(CONNECT_MILLIS)),</span>
<span class="line-added">246                        msg);</span>
<span class="line-added">247         }</span>
248     }
249 
<a name="31" id="anc31"></a><span class="line-modified">250     static void test7() throws Exception {</span>
<span class="line-modified">251         // 8000487: Java JNDI connection library on ldap conn is</span>
<span class="line-modified">252         // not honoring configured timeout</span>
<span class="line-modified">253         Hashtable&lt;Object, Object&gt; env = new Hashtable&lt;&gt;();</span>
<span class="line-modified">254         env.put(Context.INITIAL_CONTEXT_FACTORY, &quot;com.sun.jndi.ldap.LdapCtxFactory&quot;);</span>
<span class="line-modified">255         env.put(&quot;com.sun.jndi.ldap.connect.timeout&quot;, String.valueOf(CONNECT_MILLIS));</span>
<span class="line-modified">256         env.put(&quot;com.sun.jndi.ldap.read.timeout&quot;, String.valueOf(READ_MILLIS));</span>
<span class="line-modified">257         env.put(Context.SECURITY_AUTHENTICATION, &quot;simple&quot;);</span>
<span class="line-modified">258         env.put(Context.SECURITY_PRINCIPAL, &quot;user&quot;);</span>
<span class="line-modified">259         env.put(Context.SECURITY_CREDENTIALS, &quot;password&quot;);</span>
<span class="line-modified">260         try (TestServer server = new NotBindableServer()) {</span>
<span class="line-added">261             env.put(Context.PROVIDER_URL, urlTo(server));</span>
<span class="line-added">262             server.start();</span>
<span class="line-added">263             server.starting().join();</span>
<span class="line-added">264             Assert.ThrowingRunnable completion =</span>
<span class="line-added">265                     () -&gt; assertCompletion(CONNECT_MILLIS,</span>
<span class="line-added">266                                            2 * CONNECT_MILLIS + TOLERANCE,</span>
<span class="line-added">267                                            () -&gt; new InitialDirContext(env));</span>
<span class="line-added">268             NamingException e = expectThrows(NamingException.class, completion);</span>
<span class="line-added">269             String msg = e.getMessage();</span>
<span class="line-added">270             assertTrue(msg != null &amp;&amp; msg.contains(&quot;timeout&quot;)</span>
<span class="line-added">271                                &amp;&amp; msg.contains(String.valueOf(CONNECT_MILLIS)),</span>
<span class="line-added">272                        msg);</span>
273         }
274     }
<a name="32" id="anc32"></a>
275 
<a name="33" id="anc33"></a><span class="line-modified">276     // ------ test stub servers ------</span>
277 
<a name="34" id="anc34"></a><span class="line-modified">278     static class TestServer extends BaseLdapServer {</span>


279 
<a name="35" id="anc35"></a><span class="line-modified">280         private final CompletableFuture&lt;Void&gt; starting = new CompletableFuture&lt;&gt;();</span>










281 
<a name="36" id="anc36"></a><span class="line-added">282         TestServer() throws IOException { }</span>
283 
<a name="37" id="anc37"></a><span class="line-modified">284         @Override</span>
<span class="line-added">285         protected void beforeAcceptingConnections() {</span>
<span class="line-added">286             starting.completeAsync(() -&gt; null);</span>
<span class="line-added">287         }</span>
288 
<a name="38" id="anc38"></a><span class="line-modified">289         public CompletableFuture&lt;Void&gt; starting() {</span>
<span class="line-modified">290             return starting.copy();</span>
<span class="line-modified">291         }</span>


292     }
293 
<a name="39" id="anc39"></a><span class="line-modified">294     static class BindableButNotReadableServer extends TestServer {</span>
<span class="line-modified">295 </span>
<span class="line-modified">296         BindableButNotReadableServer() throws IOException { }</span>
<span class="line-modified">297 </span>
<span class="line-modified">298         private static final byte[] bindResponse = {</span>
<span class="line-modified">299                 0x30, 0x0C, 0x02, 0x01, 0x01, 0x61, 0x07, 0x0A,</span>
<span class="line-modified">300                 0x01, 0x00, 0x04, 0x00, 0x04, 0x00</span>
<span class="line-modified">301         };</span>
<span class="line-modified">302 </span>
<span class="line-modified">303         @Override</span>
<span class="line-modified">304         protected void handleRequest(Socket socket,</span>
<span class="line-added">305                                      LdapMessage msg,</span>
<span class="line-added">306                                      OutputStream out)</span>
<span class="line-added">307                 throws IOException {</span>
<span class="line-added">308             switch (msg.getOperation()) {</span>
<span class="line-added">309                 case BIND_REQUEST:</span>
<span class="line-added">310                     out.write(bindResponse);</span>
<span class="line-added">311                     out.flush();</span>
<span class="line-added">312                 default:</span>
<span class="line-added">313                     break;</span>
<span class="line-added">314             }</span>
315         }
316     }
<a name="40" id="anc40"></a>
317 
<a name="41" id="anc41"></a><span class="line-modified">318     static class NotBindableServer extends TestServer {</span>
319 
<a name="42" id="anc42"></a><span class="line-modified">320         NotBindableServer() throws IOException { }</span>


321 
<a name="43" id="anc43"></a><span class="line-modified">322         @Override</span>
<span class="line-modified">323         protected void beforeConnectionHandled(Socket socket) {</span>
<span class="line-modified">324             try {</span>
<span class="line-modified">325                 TimeUnit.DAYS.sleep(Integer.MAX_VALUE);</span>
<span class="line-modified">326             } catch (InterruptedException e) {</span>
<span class="line-modified">327                 Thread.currentThread().interrupt();</span>
<span class="line-added">328             }</span>
329         }
330     }
<a name="44" id="anc44"></a>









331 
<a name="45" id="anc45"></a><span class="line-modified">332     // ------ timeouts check utilities ------</span>
<span class="line-modified">333 </span>
<span class="line-modified">334     /*</span>
<span class="line-added">335      * Asserts that the specified executable yields a result or an exception</span>
<span class="line-added">336      * within the specified time frame. Interrupts the executable</span>
<span class="line-added">337      * unconditionally.</span>
<span class="line-added">338      *</span>
<span class="line-added">339      * If the executable yields a result or an exception within the specified</span>
<span class="line-added">340      * time frame, the result will be returned and the exception will be</span>
<span class="line-added">341      * rethrown respectively in a transparent fashion as if the executable was</span>
<span class="line-added">342      * executed directly.</span>
<span class="line-added">343      */</span>
<span class="line-added">344     public static &lt;T&gt; T assertCompletion(long loMillis,</span>
<span class="line-added">345                                          long hiMillis,</span>
<span class="line-added">346                                          Callable&lt;T&gt; code)</span>
<span class="line-added">347             throws Throwable {</span>
<span class="line-added">348         if (loMillis &lt; 0 || hiMillis &lt; 0 || loMillis &gt; hiMillis) {</span>
<span class="line-added">349             throw new IllegalArgumentException(&quot;loMillis=&quot; + loMillis +</span>
<span class="line-added">350                                                        &quot;, hiMillis=&quot; + hiMillis);</span>
<span class="line-added">351         }</span>
<span class="line-added">352         Objects.requireNonNull(code);</span>
353 
<a name="46" id="anc46"></a><span class="line-modified">354         // this queue acts both as an exchange point and a barrier</span>
<span class="line-modified">355         SynchronousQueue&lt;Long&gt; startTime = new SynchronousQueue&lt;&gt;();</span>

356 
<a name="47" id="anc47"></a><span class="line-modified">357         Callable&lt;T&gt; wrappedTask = () -&gt; {</span>
<span class="line-modified">358             // by the time this value reaches the &quot;stopwatch&quot; thread it might be</span>
<span class="line-modified">359             // well outdated and that&#39;s okay, we will adjust the wait time</span>
<span class="line-modified">360             startTime.put(System.nanoTime());</span>
<span class="line-added">361             return code.call();</span>
<span class="line-added">362         };</span>
363 
<a name="48" id="anc48"></a><span class="line-modified">364         FutureTask&lt;T&gt; task = new FutureTask&lt;&gt;(wrappedTask);</span>
<span class="line-added">365         Thread t = new Thread(task);</span>
<span class="line-added">366         t.start();</span>
367 
<a name="49" id="anc49"></a><span class="line-modified">368         final long startNanos;</span>
<span class="line-modified">369         try {</span>
<span class="line-modified">370             startNanos = startTime.take(); // (1) wait for the initial time mark</span>
<span class="line-added">371         } catch (Throwable e) {</span>
<span class="line-added">372             t.interrupt();</span>
<span class="line-added">373             throw e;</span>
<span class="line-added">374         }</span>
375 
<a name="50" id="anc50"></a><span class="line-modified">376         final long waitTime = hiMillis -</span>
<span class="line-modified">377                 NANOSECONDS.toMillis(System.nanoTime() - startNanos); // (2) adjust wait time</span>


378 
<a name="51" id="anc51"></a>
379         try {
<a name="52" id="anc52"></a><span class="line-modified">380             T r = task.get(waitTime, MILLISECONDS); // (3) wait for the task to complete</span>
<span class="line-modified">381             long elapsed = NANOSECONDS.toMillis(System.nanoTime() - startNanos);</span>
<span class="line-modified">382             if (elapsed &lt; loMillis || elapsed &gt; hiMillis) {</span>
<span class="line-modified">383                 throw new RuntimeException(format(</span>
<span class="line-modified">384                         &quot;After %s ms. (waitTime %s ms.) returned result &#39;%s&#39;&quot;, elapsed, waitTime, r));</span>




385             }
<a name="53" id="anc53"></a><span class="line-modified">386             return r;</span>
<span class="line-modified">387         } catch (ExecutionException e) {</span>
<span class="line-modified">388             long elapsed = NANOSECONDS.toMillis(System.nanoTime() - startNanos);</span>
<span class="line-modified">389             if (elapsed &lt; loMillis || elapsed &gt; hiMillis) {</span>
<span class="line-modified">390                 throw new RuntimeException(format(</span>
<span class="line-modified">391                         &quot;After %s ms. (waitTime %s ms.) thrown exception&quot;, elapsed, waitTime), e);</span>
<span class="line-added">392             }</span>
<span class="line-added">393             throw e.getCause();</span>
<span class="line-added">394         } catch (TimeoutException e) {</span>
<span class="line-added">395             // We trust timed get not to throw TimeoutException prematurely</span>
<span class="line-added">396             // (i.e. before the wait time elapses)</span>
<span class="line-added">397             long elapsed = NANOSECONDS.toMillis(System.nanoTime() - startNanos);</span>
<span class="line-added">398             throw new RuntimeException(format(</span>
<span class="line-added">399                     &quot;After %s ms. (waitTime %s ms.) is incomplete&quot;, elapsed, waitTime));</span>
<span class="line-added">400         } finally {</span>
<span class="line-added">401             t.interrupt();</span>
402         }
403     }
<a name="54" id="anc54"></a>






404 
<a name="55" id="anc55"></a><span class="line-modified">405     /*</span>
<span class="line-modified">406      * Asserts that the specified executable yields no result and no exception</span>
<span class="line-modified">407      * for at least the specified amount of time. Interrupts the executable</span>
<span class="line-modified">408      * unconditionally.</span>
<span class="line-modified">409      */</span>
<span class="line-modified">410     public static void assertIncompletion(long millis, Callable&lt;?&gt; code)</span>
<span class="line-modified">411             throws Exception</span>
<span class="line-modified">412     {</span>
<span class="line-added">413         if (millis &lt; 0) {</span>
<span class="line-added">414             throw new IllegalArgumentException(&quot;millis=&quot; + millis);</span>
415         }
<a name="56" id="anc56"></a><span class="line-modified">416         Objects.requireNonNull(code);</span>

417 
<a name="57" id="anc57"></a><span class="line-modified">418         // this queue acts both as an exchange point and a barrier</span>
<span class="line-added">419         SynchronousQueue&lt;Long&gt; startTime = new SynchronousQueue&lt;&gt;();</span>
420 
<a name="58" id="anc58"></a><span class="line-modified">421         Callable&lt;?&gt; wrappedTask = () -&gt; {</span>
<span class="line-modified">422             // by the time this value reaches the &quot;stopwatch&quot; thread it might be</span>
<span class="line-modified">423             // well outdated and that&#39;s okay, we will adjust the wait time</span>
<span class="line-modified">424             startTime.put(System.nanoTime());</span>
<span class="line-modified">425             return code.call();</span>
<span class="line-modified">426         };</span>






427 
<a name="59" id="anc59"></a><span class="line-modified">428         FutureTask&lt;?&gt; task = new FutureTask&lt;&gt;(wrappedTask);</span>
<span class="line-added">429         Thread t = new Thread(task);</span>
<span class="line-added">430         t.start();</span>
<span class="line-added">431 </span>
<span class="line-added">432         final long startNanos;</span>
<span class="line-added">433         try {</span>
<span class="line-added">434             startNanos = startTime.take(); // (1) wait for the initial time mark</span>
<span class="line-added">435         } catch (Throwable e) {</span>
<span class="line-added">436             t.interrupt();</span>
<span class="line-added">437             throw e;</span>
<span class="line-added">438         }</span>
439 
<a name="60" id="anc60"></a><span class="line-modified">440         final long waitTime = millis -</span>
<span class="line-modified">441                 NANOSECONDS.toMillis(System.nanoTime() - startNanos); // (2) adjust wait time</span>
442 
443         try {
<a name="61" id="anc61"></a><span class="line-modified">444             Object r = task.get(waitTime, MILLISECONDS); // (3) wait for the task to complete</span>
<span class="line-modified">445             long elapsed = NANOSECONDS.toMillis(System.nanoTime() - startNanos);</span>
<span class="line-modified">446             if (elapsed &lt; waitTime) {</span>
<span class="line-modified">447                 throw new RuntimeException(format(</span>
<span class="line-modified">448                         &quot;After %s ms. (waitTime %s ms.) returned result &#39;%s&#39;&quot;, elapsed, waitTime, r));</span>
































































449             }
<a name="62" id="anc62"></a><span class="line-modified">450         } catch (ExecutionException e) {</span>
<span class="line-modified">451             long elapsed = NANOSECONDS.toMillis(System.nanoTime() - startNanos);</span>
<span class="line-modified">452             if (elapsed &lt; waitTime) {</span>
<span class="line-added">453                 throw new RuntimeException(format(</span>
<span class="line-added">454                         &quot;After %s ms. (waitTime %s ms.) thrown exception&quot;, elapsed, waitTime), e);</span>
455             }
<a name="63" id="anc63"></a><span class="line-modified">456         } catch (TimeoutException expected) {</span>
457         } finally {
<a name="64" id="anc64"></a><span class="line-modified">458             t.interrupt();</span>

459         }
460     }
461 
<a name="65" id="anc65"></a><span class="line-modified">462     // ------ miscellaneous utilities ------</span>
<span class="line-added">463 </span>
<span class="line-added">464     private static String urlTo(TestServer server) {</span>
<span class="line-added">465         String hostAddress = server.getInetAddress().getHostAddress();</span>
<span class="line-added">466         String addr;</span>
<span class="line-added">467         if (hostAddress.contains(&quot;:&quot;)) { // IPv6</span>
<span class="line-added">468             addr = &#39;[&#39; + hostAddress + &#39;]&#39;;</span>
<span class="line-added">469         } else {                         // IPv4</span>
<span class="line-added">470             addr = hostAddress;</span>
<span class="line-added">471         }</span>
<span class="line-added">472         return &quot;ldap://&quot; + addr + &quot;:&quot; + server.getPort();</span>
<span class="line-added">473     }</span>
<span class="line-added">474 </span>
<span class="line-added">475     /*</span>
<span class="line-added">476      * A diagnostic aid that might help with debugging timeout issues. The idea</span>
<span class="line-added">477      * is to continuously measure accuracy and responsiveness of the system that</span>
<span class="line-added">478      * runs this test. If the system is overwhelmed (with something else), it</span>
<span class="line-added">479      * might affect the test run. At the very least we will have traces of that</span>
<span class="line-added">480      * in the logs.</span>
<span class="line-added">481      *</span>
<span class="line-added">482      * This utility does not automatically scale up test timeouts, it simply</span>
<span class="line-added">483      * gathers information.</span>
<span class="line-added">484      */</span>
<span class="line-added">485     private static void startAuxiliaryDiagnosticOutput() {</span>
<span class="line-added">486         System.out.printf(&quot;Starting diagnostic output (probe)%n&quot;);</span>
<span class="line-added">487         Thread t = new Thread(() -&gt; {</span>
<span class="line-added">488             for (int i = 0; ; i = ((i % 20) + 1)) {</span>
<span class="line-added">489                 // 500, 1_000, 1_500, ..., 9_500, 10_000, 500, 1_000, ...</span>
<span class="line-added">490                 long expected = i * 500;</span>
<span class="line-added">491                 long start = System.nanoTime();</span>
<span class="line-added">492                 try {</span>
<span class="line-added">493                     MILLISECONDS.sleep(expected);</span>
<span class="line-added">494                 } catch (InterruptedException e) {</span>
<span class="line-added">495                     return;</span>
<span class="line-added">496                 }</span>
<span class="line-added">497                 long stop = System.nanoTime();</span>
<span class="line-added">498                 long actual = NANOSECONDS.toMillis(stop - start);</span>
<span class="line-added">499                 System.out.printf(&quot;(probe) expected [ms.]: %s, actual [ms.]: %s%n&quot;,</span>
<span class="line-added">500                                   expected, actual);</span>
501 
<a name="66" id="anc66"></a><span class="line-added">502             }</span>
<span class="line-added">503         }, &quot;probe&quot;);</span>
<span class="line-added">504         t.setDaemon(true);</span>
<span class="line-added">505         t.start();</span>
<span class="line-added">506     }</span>
<span class="line-added">507 }</span>
<a name="67" id="anc67"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="67" type="hidden" />
</body>
</html>