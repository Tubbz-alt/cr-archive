<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff test/jdk/tools/jar/modularJar/Basic.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="../../../sun/util/resources/cldr/TimeZoneNamesTest.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../multiRelease/Basic.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/tools/jar/modularJar/Basic.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2015, 2018, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2015, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 22,18 ***</span>
   */
  
  import java.io.*;
  import java.lang.module.ModuleDescriptor;
  import java.lang.reflect.Method;
<span class="line-modified">! import java.nio.file.*;</span>
  import java.util.*;
  import java.util.function.Consumer;
  import java.util.jar.JarEntry;
  import java.util.jar.JarFile;
  import java.util.jar.JarInputStream;
  import java.util.jar.Manifest;
  import java.util.regex.Pattern;
  import java.util.stream.Collectors;
  import java.util.stream.Stream;
  
  import jdk.test.lib.util.FileUtils;
  import jdk.test.lib.JDKToolFinder;
<span class="line-new-header">--- 22,21 ---</span>
   */
  
  import java.io.*;
  import java.lang.module.ModuleDescriptor;
  import java.lang.reflect.Method;
<span class="line-modified">! import java.nio.file.Files;</span>
<span class="line-added">+ import java.nio.file.Path;</span>
<span class="line-added">+ import java.nio.file.Paths;</span>
  import java.util.*;
  import java.util.function.Consumer;
  import java.util.jar.JarEntry;
  import java.util.jar.JarFile;
  import java.util.jar.JarInputStream;
  import java.util.jar.Manifest;
  import java.util.regex.Pattern;
<span class="line-added">+ import java.util.spi.ToolProvider;</span>
  import java.util.stream.Collectors;
  import java.util.stream.Stream;
  
  import jdk.test.lib.util.FileUtils;
  import jdk.test.lib.JDKToolFinder;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 57,10 ***</span>
<span class="line-new-header">--- 60,20 ---</span>
   * @run testng Basic
   * @summary Tests for plain Modular jars &amp; Multi-Release Modular jars
   */
  
  public class Basic {
<span class="line-added">+ </span>
<span class="line-added">+     private static final ToolProvider JAR_TOOL = ToolProvider.findFirst(&quot;jar&quot;)</span>
<span class="line-added">+             .orElseThrow(()</span>
<span class="line-added">+                     -&gt; new RuntimeException(&quot;jar tool not found&quot;)</span>
<span class="line-added">+             );</span>
<span class="line-added">+     private static final ToolProvider JAVAC_TOOL = ToolProvider.findFirst(&quot;javac&quot;)</span>
<span class="line-added">+             .orElseThrow(()</span>
<span class="line-added">+                     -&gt; new RuntimeException(&quot;javac tool not found&quot;)</span>
<span class="line-added">+             );</span>
<span class="line-added">+ </span>
      static final Path TEST_SRC = Paths.get(System.getProperty(&quot;test.src&quot;, &quot;.&quot;));
      static final Path TEST_CLASSES = Paths.get(System.getProperty(&quot;test.classes&quot;, &quot;.&quot;));
      static final Path MODULE_CLASSES = TEST_CLASSES.resolve(&quot;build&quot;);
      static final Path MRJAR_DIR = MODULE_CLASSES.resolve(&quot;mrjar&quot;);
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 975,17 ***</span>
          if (!TOOL_VM_OPTIONS.isEmpty()) {
              commands.addAll(Arrays.asList(TOOL_VM_OPTIONS.split(&quot;\\s+&quot;, -1)));
          }
          Stream.of(args).forEach(commands::add);
          ProcessBuilder p = new ProcessBuilder(commands);
<span class="line-modified">!         if (stdinSource != null)</span>
              p.redirectInput(stdinSource);
          return run(p);
      }
  
      static Result jar(String... args) {
<span class="line-modified">!         return jarWithStdin(null, args);</span>
      }
  
      static Path compileModule(String mn) throws IOException {
          return compileModule(mn, null);
      }
<span class="line-new-header">--- 988,18 ---</span>
          if (!TOOL_VM_OPTIONS.isEmpty()) {
              commands.addAll(Arrays.asList(TOOL_VM_OPTIONS.split(&quot;\\s+&quot;, -1)));
          }
          Stream.of(args).forEach(commands::add);
          ProcessBuilder p = new ProcessBuilder(commands);
<span class="line-modified">!         if (stdinSource != null) {</span>
              p.redirectInput(stdinSource);
<span class="line-added">+         }</span>
          return run(p);
      }
  
      static Result jar(String... args) {
<span class="line-modified">!         return run(JAR_TOOL, args);</span>
      }
  
      static Path compileModule(String mn) throws IOException {
          return compileModule(mn, null);
      }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1069,14 ***</span>
      }
  
      static void javac(Path dest, Path modulePath, Path... sourceFiles)
          throws IOException
      {
<span class="line-removed">-         String javac = getJDKTool(&quot;javac&quot;);</span>
  
          List&lt;String&gt; commands = new ArrayList&lt;&gt;();
<span class="line-removed">-         commands.add(javac);</span>
          if (!TOOL_VM_OPTIONS.isEmpty()) {
              commands.addAll(Arrays.asList(TOOL_VM_OPTIONS.split(&quot;\\s+&quot;, -1)));
          }
          commands.add(&quot;-d&quot;);
          commands.add(dest.toString());
<span class="line-new-header">--- 1083,12 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1090,11 ***</span>
              commands.add(&quot;--module-path&quot;);
              commands.add(modulePath.toString());
          }
          Stream.of(sourceFiles).map(Object::toString).forEach(x -&gt; commands.add(x));
  
<span class="line-modified">!         quickFail(run(new ProcessBuilder(commands)));</span>
      }
  
      static Result java(Path modulePath, String entryPoint, String... args) {
          String java = getJDKTool(&quot;java&quot;);
  
<span class="line-new-header">--- 1102,17 ---</span>
              commands.add(&quot;--module-path&quot;);
              commands.add(modulePath.toString());
          }
          Stream.of(sourceFiles).map(Object::toString).forEach(x -&gt; commands.add(x));
  
<span class="line-modified">!         StringWriter sw = new StringWriter();</span>
<span class="line-added">+         try (PrintWriter pw = new PrintWriter(sw)) {</span>
<span class="line-added">+             int rc = JAVAC_TOOL.run(pw, pw, commands.toArray(new String[0]));</span>
<span class="line-added">+             if(rc != 0) {</span>
<span class="line-added">+                 throw new RuntimeException(sw.toString());</span>
<span class="line-added">+             }</span>
<span class="line-added">+         }</span>
      }
  
      static Result java(Path modulePath, String entryPoint, String... args) {
          String java = getJDKTool(&quot;java&quot;);
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1136,13 ***</span>
                  return true;
          }
          return false;
      }
  
<span class="line-modified">!     static void quickFail(Result r) {</span>
<span class="line-modified">!         if (r.ec != 0)</span>
<span class="line-modified">!             throw new RuntimeException(r.output);</span>
      }
  
      static Result run(ProcessBuilder pb) {
          Process p;
          out.printf(&quot;Running: %s%n&quot;, pb.command());
<span class="line-new-header">--- 1154,17 ---</span>
                  return true;
          }
          return false;
      }
  
<span class="line-modified">!     static Result run(ToolProvider tp, String[] commands) {</span>
<span class="line-modified">!         int rc = 0;</span>
<span class="line-modified">!         StringWriter sw = new StringWriter();</span>
<span class="line-added">+         try (PrintWriter pw = new PrintWriter(sw)) {</span>
<span class="line-added">+             rc = tp.run(pw, pw, commands);</span>
<span class="line-added">+         }</span>
<span class="line-added">+         return new Result(rc, sw.toString());</span>
      }
  
      static Result run(ProcessBuilder pb) {
          Process p;
          out.printf(&quot;Running: %s%n&quot;, pb.command());
</pre>
<center><a href="../../../sun/util/resources/cldr/TimeZoneNamesTest.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../multiRelease/Basic.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>