<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/tools/jlink/basic/BasicTest.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="../JLinkReproducibleTest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../plugins/ExcludeVMPluginTest.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/tools/jlink/basic/BasicTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 83         if (!CompilerUtils.compile(src, classes)) {
 84             throw new AssertionError(&quot;Compilation failure. See log.&quot;);
 85         }
 86 
 87         Files.createDirectories(jmods);
 88         Files.createDirectories(jars);
 89         Path jarfile = jars.resolve(&quot;test.jar&quot;);
 90         JarUtils.createJarFile(jarfile, classes);
 91 
 92         Path image = Paths.get(&quot;mysmallimage&quot;);
 93         runJmod(jarfile.toString(), TEST_MODULE, true);
 94         runJlink(image, TEST_MODULE, &quot;--compress&quot;, &quot;2&quot;, &quot;--launcher&quot;, &quot;foo=&quot; + TEST_MODULE);
 95         execute(image, &quot;foo&quot;);
 96 
 97         Files.delete(jmods.resolve(TEST_MODULE + &quot;.jmod&quot;));
 98 
 99         image = Paths.get(&quot;myimage&quot;);
100         runJmod(classes.toString(), TEST_MODULE, true);
101         runJlink(image, TEST_MODULE, &quot;--launcher&quot;, &quot;bar=&quot; + TEST_MODULE);
102         execute(image, &quot;bar&quot;);
<span class="line-removed">103 </span>
104         Files.delete(jmods.resolve(TEST_MODULE + &quot;.jmod&quot;));
105 
106         image = Paths.get(&quot;myimage2&quot;);
107         runJmod(classes.toString(), TEST_MODULE, false /* no ModuleMainClass! */);
108         // specify main class in --launcher command line
109         runJlink(image, TEST_MODULE, &quot;--launcher&quot;, &quot;bar2=&quot; + TEST_MODULE + &quot;/jdk.test.Test&quot;);
110         execute(image, &quot;bar2&quot;);








111 













112     }
113 
114     private void execute(Path image, String scriptName) throws Throwable {
115         String cmd = image.resolve(&quot;bin&quot;).resolve(scriptName).toString();
116         OutputAnalyzer analyzer;
117         if (System.getProperty(&quot;os.name&quot;).startsWith(&quot;Windows&quot;)) {
118             analyzer = ProcessTools.executeProcess(&quot;sh.exe&quot;, cmd, &quot;1&quot;, &quot;2&quot;, &quot;3&quot;);
119         } else {
120             analyzer = ProcessTools.executeProcess(cmd, &quot;1&quot;, &quot;2&quot;, &quot;3&quot;);
121         }
122         if (analyzer.getExitValue() != 0) {
123             throw new AssertionError(&quot;Image invocation failed: rc=&quot; + analyzer.getExitValue());
124         }
125     }
126 
127     private void runJlink(Path image, String modName, String... options) {
128         List&lt;String&gt; args = new ArrayList&lt;&gt;();
129         Collections.addAll(args,
130                 &quot;--module-path&quot;, jdkMods + File.pathSeparator + jmods,
131                 &quot;--add-modules&quot;, modName,
</pre>
</td>
<td>
<hr />
<pre>
 83         if (!CompilerUtils.compile(src, classes)) {
 84             throw new AssertionError(&quot;Compilation failure. See log.&quot;);
 85         }
 86 
 87         Files.createDirectories(jmods);
 88         Files.createDirectories(jars);
 89         Path jarfile = jars.resolve(&quot;test.jar&quot;);
 90         JarUtils.createJarFile(jarfile, classes);
 91 
 92         Path image = Paths.get(&quot;mysmallimage&quot;);
 93         runJmod(jarfile.toString(), TEST_MODULE, true);
 94         runJlink(image, TEST_MODULE, &quot;--compress&quot;, &quot;2&quot;, &quot;--launcher&quot;, &quot;foo=&quot; + TEST_MODULE);
 95         execute(image, &quot;foo&quot;);
 96 
 97         Files.delete(jmods.resolve(TEST_MODULE + &quot;.jmod&quot;));
 98 
 99         image = Paths.get(&quot;myimage&quot;);
100         runJmod(classes.toString(), TEST_MODULE, true);
101         runJlink(image, TEST_MODULE, &quot;--launcher&quot;, &quot;bar=&quot; + TEST_MODULE);
102         execute(image, &quot;bar&quot;);

103         Files.delete(jmods.resolve(TEST_MODULE + &quot;.jmod&quot;));
104 
105         image = Paths.get(&quot;myimage2&quot;);
106         runJmod(classes.toString(), TEST_MODULE, false /* no ModuleMainClass! */);
107         // specify main class in --launcher command line
108         runJlink(image, TEST_MODULE, &quot;--launcher&quot;, &quot;bar2=&quot; + TEST_MODULE + &quot;/jdk.test.Test&quot;);
109         execute(image, &quot;bar2&quot;);
<span class="line-added">110         Files.delete(jmods.resolve(TEST_MODULE + &quot;.jmod&quot;));</span>
<span class="line-added">111 </span>
<span class="line-added">112         image = Paths.get(&quot;myadder&quot;);</span>
<span class="line-added">113         runJmod(classes.toString(), TEST_MODULE, false /* no ModuleMainClass! */);</span>
<span class="line-added">114         // specify main class in --launcher command line</span>
<span class="line-added">115         runJlink(image, TEST_MODULE, &quot;--launcher&quot;, &quot;adder=&quot; + TEST_MODULE + &quot;/jdk.test.Adder&quot;);</span>
<span class="line-added">116         addAndCheck(image, &quot;adder&quot;);</span>
<span class="line-added">117     }</span>
118 
<span class="line-added">119     private void addAndCheck(Path image, String scriptName) throws Throwable {</span>
<span class="line-added">120         String cmd = image.resolve(&quot;bin&quot;).resolve(scriptName).toString();</span>
<span class="line-added">121         OutputAnalyzer analyzer;</span>
<span class="line-added">122         if (System.getProperty(&quot;os.name&quot;).startsWith(&quot;Windows&quot;)) {</span>
<span class="line-added">123             analyzer = ProcessTools.executeProcess(&quot;sh.exe&quot;, cmd, &quot;12&quot;, &quot;8&quot;, &quot;7&quot;, &quot;--&quot;, &quot;foo bar&quot;);</span>
<span class="line-added">124         } else {</span>
<span class="line-added">125             analyzer = ProcessTools.executeProcess(cmd, &quot;12&quot;, &quot;8&quot;, &quot;7&quot;, &quot;--&quot;, &quot;foo bar&quot;);</span>
<span class="line-added">126         }</span>
<span class="line-added">127         if (analyzer.getExitValue() != 27) {</span>
<span class="line-added">128             throw new AssertionError(&quot;Image invocation failed: expected 27, rc=&quot; + analyzer.getExitValue());</span>
<span class="line-added">129         }</span>
<span class="line-added">130         // last argument contains space and should be properly quoted.</span>
<span class="line-added">131         analyzer.stdoutShouldContain(&quot;Num args: 5&quot;);</span>
132     }
133 
134     private void execute(Path image, String scriptName) throws Throwable {
135         String cmd = image.resolve(&quot;bin&quot;).resolve(scriptName).toString();
136         OutputAnalyzer analyzer;
137         if (System.getProperty(&quot;os.name&quot;).startsWith(&quot;Windows&quot;)) {
138             analyzer = ProcessTools.executeProcess(&quot;sh.exe&quot;, cmd, &quot;1&quot;, &quot;2&quot;, &quot;3&quot;);
139         } else {
140             analyzer = ProcessTools.executeProcess(cmd, &quot;1&quot;, &quot;2&quot;, &quot;3&quot;);
141         }
142         if (analyzer.getExitValue() != 0) {
143             throw new AssertionError(&quot;Image invocation failed: rc=&quot; + analyzer.getExitValue());
144         }
145     }
146 
147     private void runJlink(Path image, String modName, String... options) {
148         List&lt;String&gt; args = new ArrayList&lt;&gt;();
149         Collections.addAll(args,
150                 &quot;--module-path&quot;, jdkMods + File.pathSeparator + jmods,
151                 &quot;--add-modules&quot;, modName,
</pre>
</td>
</tr>
</table>
<center><a href="../JLinkReproducibleTest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../plugins/ExcludeVMPluginTest.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>