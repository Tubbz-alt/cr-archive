<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/jdk/tools/jlink/IntegrationTest.java</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 2015, 2017, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 import java.io.File;
 25 import java.io.FileReader;
 26 import java.io.IOException;
 27 import java.io.UncheckedIOException;
 28 import java.nio.ByteOrder;
 29 import java.nio.file.Files;
 30 import java.nio.file.Path;
 31 import java.nio.file.Paths;
 32 import java.util.ArrayList;
 33 import java.util.Collections;
 34 import java.util.HashMap;
 35 import java.util.HashSet;
 36 import java.util.List;
 37 import java.util.Map;
 38 import java.util.Properties;
 39 import java.util.Set;
 40 import java.util.function.Function;
 41 import jdk.tools.jlink.internal.Jlink;
 42 import jdk.tools.jlink.internal.JlinkTask;
 43 import jdk.tools.jlink.builder.DefaultImageBuilder;
 44 import jdk.tools.jlink.plugin.ResourcePool;
 45 import jdk.tools.jlink.plugin.ResourcePoolBuilder;
 46 import jdk.tools.jlink.plugin.Plugin;
 47 import jdk.tools.jlink.internal.ExecutableImage;
 48 import jdk.tools.jlink.internal.Jlink.JlinkConfiguration;
 49 import jdk.tools.jlink.internal.Jlink.PluginsConfiguration;
 50 import jdk.tools.jlink.internal.PostProcessor;
 51 import jdk.tools.jlink.internal.plugins.DefaultCompressPlugin;
 52 import jdk.tools.jlink.internal.plugins.DefaultStripDebugPlugin;
 53 
 54 import tests.Helper;
 55 import tests.JImageGenerator;
 56 
 57 /*
 58  * @test
 59  * @summary Test integration API
 60  * @author Jean-Francois Denise
 61  * @library ../lib
 62  * @modules java.base/jdk.internal.jimage
 63  *          jdk.jdeps/com.sun.tools.classfile
 64  *          jdk.jlink/jdk.tools.jlink.builder
 65  *          jdk.jlink/jdk.tools.jlink.internal
 66  *          jdk.jlink/jdk.tools.jlink.internal.plugins
 67  *          jdk.jlink/jdk.tools.jlink.plugin
 68  *          jdk.jlink/jdk.tools.jmod
 69  *          jdk.jlink/jdk.tools.jimage
 70  *          jdk.compiler
 71  * @build tests.*
<a name="1" id="anc1"></a><span class="line-modified"> 72  * @run main IntegrationTest</span>
 73  */
 74 public class IntegrationTest {
 75 
 76     private static final List&lt;Integer&gt; ordered = new ArrayList&lt;&gt;();
 77 
 78     public static class MyPostProcessor implements PostProcessor, Plugin {
 79 
 80         public static final String NAME = &quot;mypostprocessor&quot;;
 81 
 82         @Override
 83         public List&lt;String&gt; process(ExecutableImage image) {
 84             try {
 85                 Files.createFile(image.getHome().resolve(&quot;toto.txt&quot;));
 86                 return null;
 87             } catch (IOException ex) {
 88                 throw new UncheckedIOException(ex);
 89             }
 90         }
 91 
 92         @Override
 93         public String getName() {
 94             return NAME;
 95         }
 96 
 97         @Override
 98         public Category getType() {
 99             return Category.PROCESSOR;
100         }
101 
102         @Override
103         public void configure(Map&lt;String, String&gt; config) {
104             throw new UnsupportedOperationException(&quot;Shouldn&#39;t be called&quot;);
105         }
106 
107         @Override
108         public ResourcePool transform(ResourcePool in, ResourcePoolBuilder out) {
109             in.transformAndCopy(Function.identity(), out);
110             return out.build();
111         }
112     }
113 
114     public static void main(String[] args) throws Exception {
115 
116         Helper helper = Helper.newHelper();
117         if (helper == null) {
118             System.err.println(&quot;Test not run&quot;);
119             return;
120         }
121         apitest();
122         test();
123     }
124 
125     private static void apitest() throws Exception {
126         boolean failed = false;
127         Jlink jl = new Jlink();
128 
129         try {
130             jl.build(null);
131             failed = true;
132         } catch (Exception ex) {
133             // XXX OK
134         }
135         if (failed) {
136             throw new Exception(&quot;Should have failed&quot;);
137         }
138         System.out.println(jl);
139 
140         Plugin p = Jlink.newPlugin(&quot;toto&quot;, Collections.emptyMap(), null);
141         if (p != null) {
142             throw new Exception(&quot;Plugin should be null&quot;);
143         }
144 
145         Plugin p2 = Jlink.newPlugin(&quot;compress&quot;, Map.of(&quot;compress&quot;, &quot;1&quot;), null);
146         if (p2 == null) {
147             throw new Exception(&quot;Plugin should not be null&quot;);
148         }
149     }
150 
151     private static void test() throws Exception {
152         Jlink jlink = new Jlink();
153         Path output = Paths.get(&quot;integrationout&quot;);
154         List&lt;Path&gt; modulePaths = new ArrayList&lt;&gt;();
155         File jmods
156                 = JImageGenerator.getJModsDir(new File(System.getProperty(&quot;test.jdk&quot;)));
157         modulePaths.add(jmods.toPath());
158         Set&lt;String&gt; mods = new HashSet&lt;&gt;();
159         mods.add(&quot;java.management&quot;);
160         Set&lt;String&gt; limits = new HashSet&lt;&gt;();
161         limits.add(&quot;java.management&quot;);
162         JlinkConfiguration config = new Jlink.JlinkConfiguration(output,
163                 mods, ByteOrder.nativeOrder(),
164                 JlinkTask.newModuleFinder(modulePaths, limits, mods));
165 
166         List&lt;Plugin&gt; lst = new ArrayList&lt;&gt;();
167 
168         //Strip debug
169         {
170             Map&lt;String, String&gt; config1 = new HashMap&lt;&gt;();
171             config1.put(DefaultStripDebugPlugin.NAME, &quot;&quot;);
172             Plugin strip = Jlink.newPlugin(&quot;strip-debug&quot;, config1, null);
173             lst.add(strip);
174         }
175         // compress
176         {
177             Map&lt;String, String&gt; config1 = new HashMap&lt;&gt;();
178             config1.put(DefaultCompressPlugin.NAME, &quot;2&quot;);
179             Plugin compress
180                     = Jlink.newPlugin(&quot;compress&quot;, config1, null);
181             lst.add(compress);
182         }
183         // Post processor
184         {
185             lst.add(new MyPostProcessor());
186         }
187         // Image builder
188         DefaultImageBuilder builder = new DefaultImageBuilder(output, Collections.emptyMap());
189         PluginsConfiguration plugins
190                 = new Jlink.PluginsConfiguration(lst, builder, null);
191 
192         jlink.build(config, plugins);
193 
194         if (!Files.exists(output)) {
195             throw new AssertionError(&quot;Directory not created&quot;);
196         }
197         File jimage = new File(output.toString(), &quot;lib&quot; + File.separator + &quot;modules&quot;);
198         if (!jimage.exists()) {
199             throw new AssertionError(&quot;jimage not generated&quot;);
200         }
201         File release = new File(output.toString(), &quot;release&quot;);
202         if (!release.exists()) {
203             throw new AssertionError(&quot;release not generated&quot;);
204         }
205 
206         Properties props = new Properties();
207         try (FileReader reader = new FileReader(release)) {
208             props.load(reader);
209         }
210 
211         checkReleaseProperty(props, &quot;JAVA_VERSION&quot;);
212 
213         if (!Files.exists(output.resolve(&quot;toto.txt&quot;))) {
214             throw new AssertionError(&quot;Post processing not called&quot;);
215         }
216 
217     }
218 
219     static void checkReleaseProperty(Properties props, String name) {
220         if (! props.containsKey(name)) {
221             throw new AssertionError(&quot;release file does not contain property : &quot; + name);
222         }
223 
224         // property value is of min. length 3 and double quoted at the ends.
225         String value = props.getProperty(name);
226         if (value.length() &lt; 3 ||
227             value.charAt(0) != &#39;&quot;&#39; ||
228             value.charAt(value.length() - 1) != &#39;&quot;&#39;) {
229             throw new AssertionError(&quot;release property &quot; + name + &quot; is not quoted property&quot;);
230         }
231     }
232 }
<a name="2" id="anc2"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="2" type="hidden" />
</body>
</html>