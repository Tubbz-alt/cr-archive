<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New test/jdk/tools/jlink/plugins/IncludeLocalesPluginTest.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2016, 2020, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 import java.nio.file.Path;
 25 import java.util.Arrays;
 26 import java.util.ArrayList;
 27 import java.util.List;
 28 import java.util.Locale;
 29 import java.util.stream.Collectors;
 30 
 31 import jdk.tools.jlink.plugin.Plugin;
 32 import jdk.tools.jlink.plugin.PluginException;
 33 import jdk.tools.jlink.internal.PluginRepository;
 34 import jdk.tools.jlink.internal.TaskHelper;
 35 import jdk.tools.jlink.internal.plugins.PluginsResourceBundle;
 36 import tests.Helper;
 37 import tests.JImageGenerator;
 38 import tests.JImageValidator;
 39 import tests.Result;
 40 
 41 /*
 42  * @test
 43  * @bug 8152143 8152704 8155649 8165804 8185841 8176841 8190918
 44  *      8179071 8202537 8221432 8222098
 45  * @summary IncludeLocalesPlugin tests
 46  * @author Naoto Sato
 47  * @requires (vm.compMode != &quot;Xcomp&quot; &amp; os.maxMemory &gt;= 2g)
 48  * @library ../../lib
 49  * @modules java.base/jdk.internal.jimage
 50  *          jdk.jdeps/com.sun.tools.classfile
 51  *          jdk.jlink/jdk.tools.jlink.internal
 52  *          jdk.jlink/jdk.tools.jlink.internal.plugins
 53  *          jdk.jlink/jdk.tools.jlink.plugin
 54  *          jdk.jlink/jdk.tools.jmod
 55  *          jdk.jlink/jdk.tools.jimage
 56  *          jdk.compiler
 57  * @build tests.*
 58  * @build tools.jlink.plugins.GetAvailableLocales
 59  * @run main/othervm/timeout=180 -Xmx1g IncludeLocalesPluginTest
 60  */
 61 public class IncludeLocalesPluginTest {
 62 
 63     private final static String moduleName = &quot;IncludeLocalesTest&quot;;
 64     private static Helper helper;
 65     private final static int INCLUDE_LOCALES_OPTION = 0;
 66     private final static int ADDMODS_OPTION         = 1;
 67     private final static int EXPECTED_LOCATIONS     = 2;
 68     private final static int UNEXPECTED_PATHS       = 3;
 69     private final static int AVAILABLE_LOCALES      = 4;
 70     private final static int ERROR_MESSAGE          = 5;
 71 
 72     private static int errors;
 73 
 74     private final static Object[][] testData = {
 75         // Test data should include:
 76         //  - --include-locales command line option
 77         //  - --add-modules command line option values
 78         //  - List of required resources in the result image
 79         //  - List of resources that should not exist in the result image
 80         //  - List of available locales in the result image
 81         //  - Error message
 82 
 83         // without --include-locales option: should include all locales
 84         {
 85             &quot;&quot;,
 86             &quot;jdk.localedata&quot;,
 87             List.of(
 88                 &quot;/jdk.localedata/sun/text/resources/ext/FormatData_en_GB.class&quot;,
 89                 &quot;/jdk.localedata/sun/text/resources/ext/FormatData_ja.class&quot;,
 90                 &quot;/jdk.localedata/sun/text/resources/ext/FormatData_th.class&quot;,
 91                 &quot;/jdk.localedata/sun/text/resources/ext/FormatData_zh.class&quot;,
 92                 &quot;/jdk.localedata/sun/text/resources/cldr/ext/FormatData_en_001.class&quot;,
 93                 &quot;/jdk.localedata/sun/text/resources/cldr/ext/FormatData_ja.class&quot;,
 94                 &quot;/jdk.localedata/sun/text/resources/cldr/ext/FormatData_th.class&quot;,
 95                 &quot;/jdk.localedata/sun/text/resources/cldr/ext/FormatData_zh.class&quot;),
 96             List.of(),
 97             Arrays.stream(Locale.getAvailableLocales())
 98                   // &quot;(root)&quot; for Locale.ROOT rather than &quot;&quot;
 99                   .map(loc -&gt; loc.equals(Locale.ROOT) ? &quot;(root)&quot; : loc.toString())
100                   .collect(Collectors.toList()),
101             &quot;&quot;,
102         },
103 
104         // Asterisk works exactly the same as above
105         {
106             &quot;--include-locales=*&quot;,
107             &quot;jdk.localedata&quot;,
108             List.of(
109                 &quot;/jdk.localedata/sun/text/resources/ext/FormatData_en_GB.class&quot;,
110                 &quot;/jdk.localedata/sun/text/resources/ext/FormatData_ja.class&quot;,
111                 &quot;/jdk.localedata/sun/text/resources/ext/FormatData_th.class&quot;,
112                 &quot;/jdk.localedata/sun/text/resources/ext/FormatData_zh.class&quot;,
113                 &quot;/jdk.localedata/sun/text/resources/cldr/ext/FormatData_en_001.class&quot;,
114                 &quot;/jdk.localedata/sun/text/resources/cldr/ext/FormatData_ja.class&quot;,
115                 &quot;/jdk.localedata/sun/text/resources/cldr/ext/FormatData_th.class&quot;,
116                 &quot;/jdk.localedata/sun/text/resources/cldr/ext/FormatData_zh.class&quot;),
117             List.of(),
118             Arrays.stream(Locale.getAvailableLocales())
119                   // &quot;(root)&quot; for Locale.ROOT rather than &quot;&quot;
120                   .map(loc -&gt; loc.equals(Locale.ROOT) ? &quot;(root)&quot; : loc.toString())
121                   .collect(Collectors.toList()),
122             &quot;&quot;,
123         },
124 
125         // World English/Spanish in Latin America
126         {
127             &quot;--include-locales=en-001,es-419&quot;,
128             &quot;jdk.localedata&quot;,
129             List.of(
130                 &quot;/jdk.localedata/sun/text/resources/ext/FormatData_en_AU.class&quot;,
131                 &quot;/jdk.localedata/sun/text/resources/ext/FormatData_es.class&quot;,
132                 &quot;/jdk.localedata/sun/text/resources/ext/FormatData_es_AR.class&quot;,
133                 &quot;/jdk.localedata/sun/text/resources/cldr/ext/FormatData_en_001.class&quot;,
134                 &quot;/jdk.localedata/sun/text/resources/cldr/ext/FormatData_en_150.class&quot;,
135                 &quot;/jdk.localedata/sun/text/resources/cldr/ext/FormatData_en_AT.class&quot;,
136                 &quot;/jdk.localedata/sun/text/resources/cldr/ext/FormatData_es.class&quot;,
137                 &quot;/jdk.localedata/sun/text/resources/cldr/ext/FormatData_es_419.class&quot;,
138                 &quot;/jdk.localedata/sun/text/resources/cldr/ext/FormatData_es_AR.class&quot;),
139             List.of(
140                 &quot;/jdk.localedata/sun/text/resources/ext/LineBreakIteratorData_th&quot;,
141                 &quot;/jdk.localedata/sun/text/resources/ext/thai_dict&quot;,
142                 &quot;/jdk.localedata/sun/text/resources/ext/WordBreakIteratorData_th&quot;,
143                 &quot;/jdk.localedata/sun/text/resources/ext/BreakIteratorInfo_th.class&quot;,
144                 &quot;/jdk.localedata/sun/text/resources/ext/FormatData_ja.class&quot;,
145                 &quot;/jdk.localedata/sun/text/resources/ext/FormatData_th.class&quot;,
146                 &quot;/jdk.localedata/sun/text/resources/cldr/ext/FormatData_ja.class&quot;,
147                 &quot;/jdk.localedata/sun/text/resources/cldr/ext/FormatData_th.class&quot;),
148             List.of(
149                 &quot;(root)&quot;, &quot;en&quot;, &quot;en_US&quot;, &quot;en_US_POSIX&quot;, &quot;en_001&quot;, &quot;en_150&quot;, &quot;en_AG&quot;, &quot;en_AI&quot;,
150                 &quot;en_AT&quot;, &quot;en_AU&quot;, &quot;en_BB&quot;, &quot;en_BE&quot;, &quot;en_BM&quot;, &quot;en_BS&quot;, &quot;en_BW&quot;, &quot;en_BZ&quot;,
151                 &quot;en_CA&quot;, &quot;en_CC&quot;, &quot;en_CH&quot;, &quot;en_CK&quot;, &quot;en_CM&quot;, &quot;en_CX&quot;, &quot;en_CY&quot;, &quot;en_DE&quot;,
152                 &quot;en_DG&quot;, &quot;en_DK&quot;, &quot;en_DM&quot;, &quot;en_ER&quot;, &quot;en_FI&quot;, &quot;en_FJ&quot;, &quot;en_FK&quot;, &quot;en_FM&quot;,
153                 &quot;en_GB&quot;, &quot;en_GD&quot;, &quot;en_GG&quot;, &quot;en_GH&quot;, &quot;en_GI&quot;, &quot;en_GM&quot;, &quot;en_GY&quot;, &quot;en_HK&quot;,
154                 &quot;en_IE&quot;, &quot;en_IL&quot;, &quot;en_IM&quot;, &quot;en_IN&quot;, &quot;en_IO&quot;, &quot;en_JE&quot;, &quot;en_JM&quot;, &quot;en_KE&quot;,
155                 &quot;en_KI&quot;, &quot;en_KN&quot;, &quot;en_KY&quot;, &quot;en_LC&quot;, &quot;en_LR&quot;, &quot;en_LS&quot;, &quot;en_MG&quot;, &quot;en_MO&quot;,
156                 &quot;en_MS&quot;, &quot;en_MT&quot;, &quot;en_MU&quot;, &quot;en_MW&quot;, &quot;en_MY&quot;, &quot;en_NA&quot;, &quot;en_NF&quot;, &quot;en_NG&quot;,
157                 &quot;en_NL&quot;, &quot;en_NR&quot;, &quot;en_NU&quot;, &quot;en_NZ&quot;, &quot;en_PG&quot;, &quot;en_PH&quot;, &quot;en_PK&quot;, &quot;en_PN&quot;,
158                 &quot;en_PW&quot;, &quot;en_RW&quot;, &quot;en_SB&quot;, &quot;en_SC&quot;, &quot;en_SD&quot;, &quot;en_SE&quot;, &quot;en_SG&quot;, &quot;en_SH&quot;,
159                 &quot;en_SI&quot;, &quot;en_SL&quot;, &quot;en_SS&quot;, &quot;en_SX&quot;, &quot;en_SZ&quot;, &quot;en_TC&quot;, &quot;en_TK&quot;, &quot;en_TO&quot;,
160                 &quot;en_TT&quot;, &quot;en_TV&quot;, &quot;en_TZ&quot;, &quot;en_UG&quot;, &quot;en_VC&quot;, &quot;en_VG&quot;, &quot;en_VU&quot;, &quot;en_WS&quot;,
161                 &quot;en_ZA&quot;, &quot;en_ZM&quot;, &quot;en_ZW&quot;, &quot;es&quot;, &quot;es_419&quot;, &quot;es_AR&quot;, &quot;es_BO&quot;, &quot;es_BR&quot;, &quot;es_BZ&quot;,
162                 &quot;es_CL&quot;, &quot;es_CO&quot;, &quot;es_CR&quot;, &quot;es_CU&quot;, &quot;es_DO&quot;, &quot;es_EC&quot;, &quot;es_GT&quot;, &quot;es_HN&quot;,
163                 &quot;es_MX&quot;, &quot;es_NI&quot;, &quot;es_PA&quot;, &quot;es_PE&quot;, &quot;es_PR&quot;, &quot;es_PY&quot;, &quot;es_SV&quot;, &quot;es_US&quot;,
164                 &quot;es_UY&quot;, &quot;es_VE&quot;),
165             &quot;&quot;,
166         },
167 
168         // All English and Japanese locales
169         {
170             &quot;--include-locales=en,ja&quot;,
171             &quot;jdk.localedata&quot;,
172             List.of(
173                 &quot;/jdk.localedata/sun/text/resources/ext/FormatData_en_GB.class&quot;,
174                 &quot;/jdk.localedata/sun/text/resources/ext/FormatData_ja.class&quot;,
175                 &quot;/jdk.localedata/sun/text/resources/cldr/ext/FormatData_en_001.class&quot;,
176                 &quot;/jdk.localedata/sun/text/resources/cldr/ext/FormatData_ja.class&quot;),
177             List.of(
178                 &quot;/jdk.localedata/sun/text/resources/ext/LineBreakIteratorData_th&quot;,
179                 &quot;/jdk.localedata/sun/text/resources/ext/thai_dict&quot;,
180                 &quot;/jdk.localedata/sun/text/resources/ext/WordBreakIteratorData_th&quot;,
181                 &quot;/jdk.localedata/sun/text/resources/ext/BreakIteratorInfo_th.class&quot;,
182                 &quot;/jdk.localedata/sun/text/resources/ext/FormatData_th.class&quot;,
183                 &quot;/jdk.localedata/sun/text/resources/ext/FormatData_zh.class&quot;,
184                 &quot;/jdk.localedata/sun/text/resources/cldr/ext/FormatData_th.class&quot;,
185                 &quot;/jdk.localedata/sun/text/resources/cldr/ext/FormatData_zh.class&quot;),
186             List.of(
187                 &quot;(root)&quot;, &quot;en&quot;, &quot;en_001&quot;, &quot;en_150&quot;, &quot;en_AE&quot;, &quot;en_AG&quot;, &quot;en_AI&quot;, &quot;en_AS&quot;, &quot;en_AT&quot;,
188                 &quot;en_AU&quot;, &quot;en_BB&quot;, &quot;en_BE&quot;, &quot;en_BI&quot;, &quot;en_BM&quot;, &quot;en_BS&quot;, &quot;en_BW&quot;, &quot;en_BZ&quot;,
189                 &quot;en_CA&quot;, &quot;en_CC&quot;, &quot;en_CH&quot;, &quot;en_CK&quot;, &quot;en_CM&quot;, &quot;en_CX&quot;, &quot;en_CY&quot;, &quot;en_DE&quot;,
190                 &quot;en_DG&quot;, &quot;en_DK&quot;, &quot;en_DM&quot;, &quot;en_ER&quot;, &quot;en_FI&quot;, &quot;en_FJ&quot;, &quot;en_FK&quot;, &quot;en_FM&quot;,
191                 &quot;en_GB&quot;, &quot;en_GD&quot;, &quot;en_GG&quot;, &quot;en_GH&quot;, &quot;en_GI&quot;, &quot;en_GM&quot;, &quot;en_GU&quot;, &quot;en_GY&quot;,
192                 &quot;en_HK&quot;, &quot;en_IE&quot;, &quot;en_IL&quot;, &quot;en_IM&quot;, &quot;en_IN&quot;, &quot;en_IO&quot;, &quot;en_JE&quot;, &quot;en_JM&quot;,
193                 &quot;en_KE&quot;, &quot;en_KI&quot;, &quot;en_KN&quot;, &quot;en_KY&quot;, &quot;en_LC&quot;, &quot;en_LR&quot;, &quot;en_LS&quot;, &quot;en_MG&quot;,
194                 &quot;en_MH&quot;, &quot;en_MO&quot;, &quot;en_MP&quot;, &quot;en_MS&quot;, &quot;en_MT&quot;, &quot;en_MU&quot;, &quot;en_MW&quot;, &quot;en_MY&quot;,
195                 &quot;en_NA&quot;, &quot;en_NF&quot;, &quot;en_NG&quot;, &quot;en_NL&quot;, &quot;en_NR&quot;, &quot;en_NU&quot;, &quot;en_NZ&quot;, &quot;en_PG&quot;,
196                 &quot;en_PH&quot;, &quot;en_PK&quot;, &quot;en_PN&quot;, &quot;en_PR&quot;, &quot;en_PW&quot;, &quot;en_RW&quot;, &quot;en_SB&quot;, &quot;en_SC&quot;,
197                 &quot;en_SD&quot;, &quot;en_SE&quot;, &quot;en_SG&quot;, &quot;en_SH&quot;, &quot;en_SI&quot;, &quot;en_SL&quot;, &quot;en_SS&quot;, &quot;en_SX&quot;,
198                 &quot;en_SZ&quot;, &quot;en_TC&quot;, &quot;en_TK&quot;, &quot;en_TO&quot;, &quot;en_TT&quot;, &quot;en_TV&quot;, &quot;en_TZ&quot;, &quot;en_UG&quot;,
199                 &quot;en_UM&quot;, &quot;en_US&quot;, &quot;en_US_POSIX&quot;, &quot;en_VC&quot;, &quot;en_VG&quot;, &quot;en_VI&quot;, &quot;en_VU&quot;,
200                 &quot;en_WS&quot;, &quot;en_ZA&quot;, &quot;en_ZM&quot;, &quot;en_ZW&quot;, &quot;ja&quot;, &quot;ja_JP&quot;,
201                 &quot;ja_JP_JP_#u-ca-japanese&quot;),
202             &quot;&quot;,
203         },
204 
205         // All locales in Austria
206         {
207             &quot;--include-locales=*-AT&quot;,
208             &quot;jdk.localedata&quot;,
209             List.of(
210                 &quot;/jdk.localedata/sun/text/resources/ext/FormatData_de.class&quot;,
211                 &quot;/jdk.localedata/sun/text/resources/ext/FormatData_de_AT.class&quot;,
212                 &quot;/jdk.localedata/sun/text/resources/cldr/ext/FormatData_de.class&quot;,
213                 &quot;/jdk.localedata/sun/text/resources/cldr/ext/FormatData_de_AT.class&quot;,
214                 &quot;/jdk.localedata/sun/text/resources/cldr/ext/FormatData_en_001.class&quot;,
215                 &quot;/jdk.localedata/sun/text/resources/cldr/ext/FormatData_en_150.class&quot;,
216                 &quot;/jdk.localedata/sun/text/resources/cldr/ext/FormatData_en_AT.class&quot;),
217             List.of(
218                 &quot;/jdk.localedata/sun/text/resources/ext/LineBreakIteratorData_th&quot;,
219                 &quot;/jdk.localedata/sun/text/resources/ext/thai_dict&quot;,
220                 &quot;/jdk.localedata/sun/text/resources/ext/WordBreakIteratorData_th&quot;,
221                 &quot;/jdk.localedata/sun/text/resources/ext/BreakIteratorInfo_th.class&quot;,
222                 &quot;/jdk.localedata/sun/text/resources/ext/FormatData_en_GB.class&quot;,
223                 &quot;/jdk.localedata/sun/text/resources/ext/FormatData_ja.class&quot;,
224                 &quot;/jdk.localedata/sun/text/resources/ext/FormatData_th.class&quot;,
225                 &quot;/jdk.localedata/sun/text/resources/cldr/ext/FormatData_ja.class&quot;,
226                 &quot;/jdk.localedata/sun/text/resources/cldr/ext/FormatData_th.class&quot;),
227             List.of(
228                 &quot;(root)&quot;, &quot;en&quot;, &quot;en_US&quot;, &quot;en_US_POSIX&quot;, &quot;en_001&quot;, &quot;en_150&quot;, &quot;en_AT&quot;,
229                 &quot;de&quot;, &quot;de_AT&quot;),
230             &quot;&quot;,
231         },
232 
233         // All locales in India
234         {
235             &quot;--include-locales=*-IN&quot;,
236             &quot;jdk.localedata&quot;,
237             List.of(
238                 &quot;/jdk.localedata/sun/text/resources/ext/FormatData_en_IN.class&quot;,
239                 &quot;/jdk.localedata/sun/text/resources/ext/FormatData_hi_IN.class&quot;,
240                 &quot;/jdk.localedata/sun/text/resources/cldr/ext/FormatData_en_001.class&quot;,
241                 &quot;/jdk.localedata/sun/text/resources/cldr/ext/FormatData_en_IN.class&quot;),
242             List.of(
243                 &quot;/jdk.localedata/sun/text/resources/ext/LineBreakIteratorData_th&quot;,
244                 &quot;/jdk.localedata/sun/text/resources/ext/thai_dict&quot;,
245                 &quot;/jdk.localedata/sun/text/resources/ext/WordBreakIteratorData_th&quot;,
246                 &quot;/jdk.localedata/sun/text/resources/ext/BreakIteratorInfo_th.class&quot;,
247                 &quot;/jdk.localedata/sun/text/resources/ext/BreakIteratorResources_th.class&quot;,
248                 &quot;/jdk.localedata/sun/text/resources/ext/FormatData_en_GB.class&quot;,
249                 &quot;/jdk.localedata/sun/text/resources/ext/FormatData_ja.class&quot;,
250                 &quot;/jdk.localedata/sun/text/resources/ext/FormatData_th.class&quot;,
251                 &quot;/jdk.localedata/sun/text/resources/ext/FormatData_zh.class&quot;,
252                 &quot;/jdk.localedata/sun/util/resources/cldr/ext/CalendarData_as_IN.class&quot;,
253                 &quot;/jdk.localedata/sun/text/resources/cldr/ext/FormatData_ja.class&quot;,
254                 &quot;/jdk.localedata/sun/text/resources/cldr/ext/FormatData_th.class&quot;,
255                 &quot;/jdk.localedata/sun/text/resources/cldr/ext/FormatData_zh.class&quot;),
256             List.of(
257                 &quot;(root)&quot;, &quot;as_IN&quot;, &quot;as&quot;, &quot;bn_IN&quot;, &quot;bn&quot;, &quot;bo_IN&quot;, &quot;bo&quot;, &quot;brx_IN&quot;, &quot;brx&quot;,
258                 &quot;ccp&quot;, &quot;ccp_IN&quot;,&quot;en&quot;, &quot;en_001&quot;, &quot;en_IN&quot;, &quot;en_US&quot;, &quot;en_US_POSIX&quot;, &quot;gu_IN&quot;,
259                 &quot;gu&quot;, &quot;hi_IN&quot;, &quot;hi&quot;, &quot;kn_IN&quot;, &quot;kn&quot;, &quot;kok_IN&quot;, &quot;kok&quot;, &quot;ks_IN&quot;, &quot;ks&quot;, &quot;ml_IN&quot;,
260                 &quot;ml&quot;, &quot;mr_IN&quot;, &quot;mr&quot;, &quot;ne_IN&quot;, &quot;ne&quot;, &quot;or_IN&quot;, &quot;or&quot;, &quot;pa&quot;, &quot;pa_IN_#Guru&quot;,
261                 &quot;pa__#Guru&quot;, &quot;ta_IN&quot;, &quot;ta&quot;, &quot;te_IN&quot;, &quot;te&quot;, &quot;ur_IN&quot;, &quot;ur&quot;),
262             &quot;&quot;,
263         },
264 
265         // Thai
266         {
267             &quot;--include-locales=th&quot;,
268             &quot;jdk.localedata&quot;,
269             List.of(
270                 &quot;/jdk.localedata/sun/text/resources/ext/LineBreakIteratorData_th&quot;,
271                 &quot;/jdk.localedata/sun/text/resources/ext/thai_dict&quot;,
272                 &quot;/jdk.localedata/sun/text/resources/ext/WordBreakIteratorData_th&quot;,
273                 &quot;/jdk.localedata/sun/text/resources/ext/BreakIteratorInfo_th.class&quot;,
274                 &quot;/jdk.localedata/sun/text/resources/ext/BreakIteratorResources_th.class&quot;,
275                 &quot;/jdk.localedata/sun/text/resources/ext/FormatData_th.class&quot;),
276             List.of(
277                 &quot;/jdk.localedata/sun/text/resources/ext/FormatData_en_GB.class&quot;,
278                 &quot;/jdk.localedata/sun/text/resources/ext/FormatData_ja.class&quot;,
279                 &quot;/jdk.localedata/sun/text/resources/ext/FormatData_zh.class&quot;,
280                 &quot;/jdk.localedata/sun/text/resources/cldr/ext/FormatData_en_001.class&quot;,
281                 &quot;/jdk.localedata/sun/text/resources/cldr/ext/FormatData_ja.class&quot;,
282                 &quot;/jdk.localedata/sun/text/resources/cldr/ext/FormatData_zh.class&quot;),
283             List.of(
284                 &quot;(root)&quot;, &quot;en&quot;, &quot;en_US&quot;, &quot;en_US_POSIX&quot;, &quot;th&quot;, &quot;th_TH&quot;,
285                 &quot;th_TH_TH_#u-nu-thai&quot;),
286             &quot;&quot;,
287         },
288 
289         // Hong Kong
290         {
291             &quot;--include-locales=zh-HK&quot;,
292             &quot;jdk.localedata&quot;,
293             List.of(
294                 &quot;/jdk.localedata/sun/text/resources/ext/FormatData_zh.class&quot;,
295                 &quot;/jdk.localedata/sun/text/resources/ext/FormatData_zh_HK.class&quot;,
296                 &quot;/jdk.localedata/sun/text/resources/ext/FormatData_zh_TW.class&quot;,
297                 &quot;/jdk.localedata/sun/text/resources/cldr/ext/FormatData_zh.class&quot;),
298             List.of(
299                 &quot;/jdk.localedata/sun/text/resources/ext/LineBreakIteratorData_th&quot;,
300                 &quot;/jdk.localedata/sun/text/resources/ext/thai_dict&quot;,
301                 &quot;/jdk.localedata/sun/text/resources/ext/WordBreakIteratorData_th&quot;,
302                 &quot;/jdk.localedata/sun/text/resources/ext/BreakIteratorInfo_th.class&quot;,
303                 &quot;/jdk.localedata/sun/text/resources/ext/FormatData_en_GB.class&quot;,
304                 &quot;/jdk.localedata/sun/text/resources/ext/FormatData_ja.class&quot;,
305                 &quot;/jdk.localedata/sun/text/resources/ext/FormatData_th.class&quot;,
306                 &quot;/jdk.localedata/sun/text/resources/ext/FormatData_zh_CN.class&quot;,
307                 &quot;/jdk.localedata/sun/text/resources/cldr/ext/FormatData_en_001.class&quot;,
308                 &quot;/jdk.localedata/sun/text/resources/cldr/ext/FormatData_ja.class&quot;,
309                 &quot;/jdk.localedata/sun/text/resources/cldr/ext/FormatData_th.class&quot;),
310             List.of(
311                 &quot;(root)&quot;, &quot;en&quot;, &quot;en_US&quot;, &quot;en_US_POSIX&quot;, &quot;zh&quot;, &quot;zh__#Hans&quot;, &quot;zh__#Hant&quot;,
312                 &quot;zh_HK&quot;, &quot;zh_HK_#Hans&quot;, &quot;zh_HK_#Hant&quot;),
313             &quot;&quot;,
314         },
315 
316         // Simplified Chinese
317         {
318             &quot;--include-locales=zh-Hans&quot;,
319             &quot;jdk.localedata&quot;,
320             List.of(
321                 &quot;/jdk.localedata/sun/text/resources/ext/FormatData_zh.class&quot;,
322                 &quot;/jdk.localedata/sun/text/resources/ext/FormatData_zh_CN.class&quot;,
323                 &quot;/jdk.localedata/sun/text/resources/ext/FormatData_zh_SG.class&quot;,
324                 &quot;/jdk.localedata/sun/text/resources/cldr/ext/FormatData_zh.class&quot;),
325             List.of(
326                 &quot;/jdk.localedata/sun/text/resources/ext/LineBreakIteratorData_th&quot;,
327                 &quot;/jdk.localedata/sun/text/resources/ext/thai_dict&quot;,
328                 &quot;/jdk.localedata/sun/text/resources/ext/WordBreakIteratorData_th&quot;,
329                 &quot;/jdk.localedata/sun/text/resources/ext/BreakIteratorInfo_th.class&quot;,
330                 &quot;/jdk.localedata/sun/text/resources/ext/FormatData_en_GB.class&quot;,
331                 &quot;/jdk.localedata/sun/text/resources/ext/FormatData_ja.class&quot;,
332                 &quot;/jdk.localedata/sun/text/resources/ext/FormatData_th.class&quot;,
333                 &quot;/jdk.localedata/sun/text/resources/cldr/ext/FormatData_en_001.class&quot;,
334                 &quot;/jdk.localedata/sun/text/resources/cldr/ext/FormatData_ja.class&quot;,
335                 &quot;/jdk.localedata/sun/text/resources/cldr/ext/FormatData_th.class&quot;),
336             List.of(
337                 &quot;(root)&quot;, &quot;en&quot;, &quot;en_US&quot;, &quot;en_US_POSIX&quot;, &quot;zh&quot;, &quot;zh__#Hans&quot;, &quot;zh_CN&quot;,
338                 &quot;zh_CN_#Hans&quot;, &quot;zh_HK_#Hans&quot;, &quot;zh_MO_#Hans&quot;, &quot;zh_SG&quot;, &quot;zh_SG_#Hans&quot;),
339             &quot;&quot;,
340         },
341 
342         // Norwegian
343         {
344             &quot;--include-locales=nb,nn,no&quot;,
345             &quot;jdk.localedata&quot;,
346             List.of(
347                 &quot;/jdk.localedata/sun/text/resources/ext/FormatData_no.class&quot;,
348                 &quot;/jdk.localedata/sun/text/resources/ext/FormatData_no_NO.class&quot;,
349                 &quot;/jdk.localedata/sun/text/resources/ext/FormatData_no_NO_NY.class&quot;,
350                 &quot;/jdk.localedata/sun/text/resources/cldr/ext/FormatData_nb.class&quot;,
351                 &quot;/jdk.localedata/sun/text/resources/cldr/ext/FormatData_nn.class&quot;),
352             List.of(
353                 &quot;/jdk.localedata/sun/text/resources/ext/LineBreakIteratorData_th&quot;,
354                 &quot;/jdk.localedata/sun/text/resources/ext/thai_dict&quot;,
355                 &quot;/jdk.localedata/sun/text/resources/ext/WordBreakIteratorData_th&quot;,
356                 &quot;/jdk.localedata/sun/text/resources/ext/BreakIteratorInfo_th.class&quot;,
357                 &quot;/jdk.localedata/sun/text/resources/ext/FormatData_en_GB.class&quot;,
358                 &quot;/jdk.localedata/sun/text/resources/ext/FormatData_ja.class&quot;,
359                 &quot;/jdk.localedata/sun/text/resources/ext/FormatData_th.class&quot;,
360                 &quot;/jdk.localedata/sun/text/resources/cldr/ext/FormatData_en_001.class&quot;,
361                 &quot;/jdk.localedata/sun/text/resources/cldr/ext/FormatData_ja.class&quot;,
362                 &quot;/jdk.localedata/sun/text/resources/cldr/ext/FormatData_th.class&quot;),
363             List.of(
364                 &quot;(root)&quot;, &quot;en&quot;, &quot;en_US&quot;, &quot;en_US_POSIX&quot;, &quot;nb&quot;, &quot;nb_NO&quot;, &quot;nb_SJ&quot;, &quot;nn&quot;,
365                 &quot;nn_NO&quot;, &quot;no&quot;, &quot;no_NO&quot;, &quot;no_NO_NY&quot;),
366             &quot;&quot;,
367         },
368 
369         // Hebrew/Indonesian/Yiddish
370         {
371             &quot;--include-locales=he,id,yi&quot;,
372             &quot;jdk.localedata&quot;,
373             List.of(
374                 &quot;/jdk.localedata/sun/text/resources/ext/FormatData_in.class&quot;,
375                 &quot;/jdk.localedata/sun/text/resources/ext/FormatData_in_ID.class&quot;,
376                 &quot;/jdk.localedata/sun/text/resources/ext/FormatData_iw.class&quot;,
377                 &quot;/jdk.localedata/sun/text/resources/ext/FormatData_iw_IL.class&quot;,
378                 &quot;/jdk.localedata/sun/text/resources/cldr/ext/FormatData_in.class&quot;,
379                 &quot;/jdk.localedata/sun/text/resources/cldr/ext/FormatData_iw.class&quot;,
380                 &quot;/jdk.localedata/sun/text/resources/cldr/ext/FormatData_ji.class&quot;),
381             List.of(
382                 &quot;/jdk.localedata/sun/text/resources/ext/LineBreakIteratorData_th&quot;,
383                 &quot;/jdk.localedata/sun/text/resources/ext/thai_dict&quot;,
384                 &quot;/jdk.localedata/sun/text/resources/ext/WordBreakIteratorData_th&quot;,
385                 &quot;/jdk.localedata/sun/text/resources/ext/BreakIteratorInfo_th.class&quot;,
386                 &quot;/jdk.localedata/sun/text/resources/ext/FormatData_en_GB.class&quot;,
387                 &quot;/jdk.localedata/sun/text/resources/ext/FormatData_ja.class&quot;,
388                 &quot;/jdk.localedata/sun/text/resources/ext/FormatData_th.class&quot;,
389                 &quot;/jdk.localedata/sun/text/resources/cldr/ext/FormatData_en_001.class&quot;,
390                 &quot;/jdk.localedata/sun/text/resources/cldr/ext/FormatData_ja.class&quot;,
391                 &quot;/jdk.localedata/sun/text/resources/cldr/ext/FormatData_th.class&quot;),
392             List.of(
393                 &quot;(root)&quot;, &quot;en&quot;, &quot;en_US&quot;, &quot;en_US_POSIX&quot;, &quot;in&quot;, &quot;in_ID&quot;, &quot;iw&quot;, &quot;iw_IL&quot;,
394                 &quot;ji&quot;, &quot;ji_001&quot;),
395             &quot;&quot;,
396         },
397 
398         // Langtag including extensions. Should be ignored.
399         {
400             &quot;--include-locales=en,ja-u-nu-thai&quot;,
401             &quot;jdk.localedata&quot;,
402             List.of(
403                 &quot;/jdk.localedata/sun/text/resources/ext/FormatData_en_GB.class&quot;,
404                 &quot;/jdk.localedata/sun/text/resources/cldr/ext/FormatData_en_001.class&quot;),
405             List.of(
406                 &quot;/jdk.localedata/sun/text/resources/cldr/ext/FormatData_ja.class&quot;,
407                 &quot;/jdk.localedata/sun/text/resources/ext/FormatData_th.class&quot;),
408             List.of(
409                 &quot;(root)&quot;, &quot;en&quot;, &quot;en_001&quot;, &quot;en_150&quot;, &quot;en_AE&quot;, &quot;en_AG&quot;, &quot;en_AI&quot;, &quot;en_AS&quot;, &quot;en_AT&quot;,
410                 &quot;en_AU&quot;, &quot;en_BB&quot;, &quot;en_BE&quot;, &quot;en_BI&quot;, &quot;en_BM&quot;, &quot;en_BS&quot;, &quot;en_BW&quot;, &quot;en_BZ&quot;,
411                 &quot;en_CA&quot;, &quot;en_CC&quot;, &quot;en_CH&quot;, &quot;en_CK&quot;, &quot;en_CM&quot;, &quot;en_CX&quot;, &quot;en_CY&quot;, &quot;en_DE&quot;,
412                 &quot;en_DG&quot;, &quot;en_DK&quot;, &quot;en_DM&quot;, &quot;en_ER&quot;, &quot;en_FI&quot;, &quot;en_FJ&quot;, &quot;en_FK&quot;, &quot;en_FM&quot;,
413                 &quot;en_GB&quot;, &quot;en_GD&quot;, &quot;en_GG&quot;, &quot;en_GH&quot;, &quot;en_GI&quot;, &quot;en_GM&quot;, &quot;en_GU&quot;, &quot;en_GY&quot;,
414                 &quot;en_HK&quot;, &quot;en_IE&quot;, &quot;en_IL&quot;, &quot;en_IM&quot;, &quot;en_IN&quot;, &quot;en_IO&quot;, &quot;en_JE&quot;, &quot;en_JM&quot;,
415                 &quot;en_KE&quot;, &quot;en_KI&quot;, &quot;en_KN&quot;, &quot;en_KY&quot;, &quot;en_LC&quot;, &quot;en_LR&quot;, &quot;en_LS&quot;, &quot;en_MG&quot;,
416                 &quot;en_MH&quot;, &quot;en_MO&quot;, &quot;en_MP&quot;, &quot;en_MS&quot;, &quot;en_MT&quot;, &quot;en_MU&quot;, &quot;en_MW&quot;, &quot;en_MY&quot;,
417                 &quot;en_NA&quot;, &quot;en_NF&quot;, &quot;en_NG&quot;, &quot;en_NL&quot;, &quot;en_NR&quot;, &quot;en_NU&quot;, &quot;en_NZ&quot;, &quot;en_PG&quot;,
418                 &quot;en_PH&quot;, &quot;en_PK&quot;, &quot;en_PN&quot;, &quot;en_PR&quot;, &quot;en_PW&quot;, &quot;en_RW&quot;, &quot;en_SB&quot;, &quot;en_SC&quot;,
419                 &quot;en_SD&quot;, &quot;en_SE&quot;, &quot;en_SG&quot;, &quot;en_SH&quot;, &quot;en_SI&quot;, &quot;en_SL&quot;, &quot;en_SS&quot;, &quot;en_SX&quot;,
420                 &quot;en_SZ&quot;, &quot;en_TC&quot;, &quot;en_TK&quot;, &quot;en_TO&quot;, &quot;en_TT&quot;, &quot;en_TV&quot;, &quot;en_TZ&quot;, &quot;en_UG&quot;,
421                 &quot;en_UM&quot;, &quot;en_US&quot;, &quot;en_US_POSIX&quot;, &quot;en_VC&quot;, &quot;en_VG&quot;, &quot;en_VI&quot;, &quot;en_VU&quot;,
422                 &quot;en_WS&quot;, &quot;en_ZA&quot;, &quot;en_ZM&quot;, &quot;en_ZW&quot;),
423             &quot;&quot;,
424         },
425 
426         // Error case: No matching locales
427         {
428             &quot;--include-locales=xyz&quot;,
429             &quot;jdk.localedata&quot;,
430             null,
431             null,
432             null,
433             new PluginException(String.format(
434                 PluginsResourceBundle.getMessage(&quot;include-locales.nomatchinglocales&quot;), &quot;xyz&quot;))
435                 .getMessage(),
436         },
437 
438         // Error case: Invalid argument
439         {
440             &quot;--include-locales=en,zh_HK&quot;,
441             &quot;jdk.localedata&quot;,
442             null,
443             null,
444             null,
445             new PluginException(String.format(
446                 PluginsResourceBundle.getMessage(&quot;include-locales.invalidtag&quot;), &quot;zh_hk&quot;))
447                 .getMessage(),
448         },
449 
450         // Error case: jdk.localedata is not added
451         {
452             &quot;--include-locales=en-US&quot;,
453             &quot;java.base&quot;,
454             null,
455             null,
456             null,
457             new PluginException(
458                 PluginsResourceBundle.getMessage(&quot;include-locales.localedatanotfound&quot;))
459                 .getMessage(),
460         },
461     };
462 
463     public static void main(String[] args) throws Exception {
464         helper = Helper.newHelper();
465         if (helper == null) {
466             System.err.println(&quot;Test not run&quot;);
467             return;
468         }
469         helper.generateDefaultModules();
470 
471         for (Object[] data : testData) {
472             // create image for each test data
473             Result result;
474             if (data[INCLUDE_LOCALES_OPTION].toString().isEmpty()) {
475                 System.out.println(&quot;Invoking jlink with no --include-locales option&quot;);
476                 result = JImageGenerator.getJLinkTask()
477                     .modulePath(helper.defaultModulePath())
478                     .output(helper.createNewImageDir(moduleName))
479                     .addMods((String) data[ADDMODS_OPTION])
480                     .call();
481             } else {
482                 System.out.println(&quot;Invoking jlink with \&quot;&quot; + data[INCLUDE_LOCALES_OPTION] + &quot;\&quot;&quot;);
483                 result = JImageGenerator.getJLinkTask()
484                     .modulePath(helper.defaultModulePath())
485                     .output(helper.createNewImageDir(moduleName))
486                     .addMods((String) data[ADDMODS_OPTION])
487                     .option((String) data[INCLUDE_LOCALES_OPTION])
488                     .call();
489             }
490 
491             String errorMsg = (String) data[ERROR_MESSAGE];
492             if (errorMsg.isEmpty()) {
493                 Path image = result.assertSuccess();
494 
495                 // test locale data entries
496                 testLocaleDataEntries(image,
497                     (List&lt;String&gt;) data[EXPECTED_LOCATIONS],
498                     (List&lt;String&gt;) data[UNEXPECTED_PATHS]);
499 
500                 // test available locales
501                 testAvailableLocales(image, (List&lt;String&gt;) data[AVAILABLE_LOCALES]);
502             } else {
503                 result.assertFailure(new TaskHelper(TaskHelper.JLINK_BUNDLE)
504                     .getMessage(&quot;error.prefix&quot;) + &quot; &quot; +errorMsg);
505                 System.out.println(&quot;\tExpected failure: &quot; + result.getMessage());
506             }
507         }
508 
509         if (errors &gt; 0) {
510             throw new RuntimeException(&quot;Test failed&quot;);
511         }
512     }
513 
514     private static void testLocaleDataEntries(Path image, List&lt;String&gt; expectedLocations,
515                         List&lt;String&gt; unexpectedPaths) throws Exception {
516         System.out.println(&quot;testLocaleDataEntries:&quot;);
517         try {
518             JImageValidator.validate(
519                 image.resolve(&quot;lib&quot;).resolve(&quot;modules&quot;),
520                 expectedLocations, unexpectedPaths);
521         } catch (Exception e) {
522             System.out.println(&quot;\tFailed with: &quot; + e);
523             e.printStackTrace();
524             errors++;
525         }
526     }
527 
528     private static void testAvailableLocales(Path image, List&lt;String&gt; availableLocales) throws Exception {
529         System.out.println(&quot;testAvailableLocales:&quot;);
530         Path launcher = image.resolve(&quot;bin/java&quot; +
531             (System.getProperty(&quot;os.name&quot;).startsWith(&quot;Windows&quot;) ? &quot;.exe&quot; : &quot;&quot;));
532         List&lt;String&gt; args = new ArrayList&lt;&gt;(availableLocales.size() + 2);
533         args.add(launcher.toString());
534         args.add(&quot;GetAvailableLocales&quot;);
535         args.addAll(availableLocales);
536         Process proc = new ProcessBuilder(args).inheritIO().start();
537 
538         int len = Math.min(10, args.size());
539         String command = args.subList(0, len).stream().collect(Collectors.joining(&quot; &quot;))
540                          + (len &lt; availableLocales.size() ? &quot; ...&quot; : &quot;&quot;);
541 
542         int status = proc.waitFor();
543         if (status == 0) {
544             System.out.println(&quot;\tDone\t&quot; + command);
545         } else {
546             System.out.println(&quot;\tExit &quot; + status + &quot;\t&quot; + command);
547             errors++;
548         }
549         System.out.println();
550     }
551 }
    </pre>
  </body>
</html>