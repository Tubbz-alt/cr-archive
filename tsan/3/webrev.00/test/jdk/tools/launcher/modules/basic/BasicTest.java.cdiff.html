<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff test/jdk/tools/launcher/modules/basic/BasicTest.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="../../VersionCheck.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../../../../../jtreg-ext/requires/VMProps.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/tools/launcher/modules/basic/BasicTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 27,10 ***</span>
<span class="line-new-header">--- 27,11 ---</span>
   * @modules jdk.compiler
   *          jdk.jartool
   *          jdk.jlink
   * @build BasicTest jdk.test.lib.compiler.CompilerUtils
   * @run testng BasicTest
<span class="line-added">+  * @bug 8234076</span>
   * @summary Basic test of starting an application as a module
   */
  
  import java.io.File;
  import java.nio.file.Files;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 38,10 ***</span>
<span class="line-new-header">--- 39,12 ---</span>
  import java.nio.file.Paths;
  import java.util.spi.ToolProvider;
  
  import jdk.test.lib.compiler.CompilerUtils;
  import jdk.test.lib.process.ProcessTools;
<span class="line-added">+ import jdk.test.lib.process.OutputAnalyzer;</span>
<span class="line-added">+ import jdk.test.lib.Utils;</span>
  
  import org.testng.annotations.BeforeTest;
  import org.testng.annotations.Test;
  import static org.testng.Assert.*;
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 68,10 ***</span>
<span class="line-new-header">--- 71,12 ---</span>
      private static final String TEST_MODULE = &quot;test&quot;;
  
      // the module main class
      private static final String MAIN_CLASS = &quot;jdk.test.Main&quot;;
  
<span class="line-added">+     // for Windows specific launcher tests</span>
<span class="line-added">+     static final boolean IS_WINDOWS = System.getProperty(&quot;os.name&quot;, &quot;unknown&quot;).startsWith(&quot;Windows&quot;);</span>
  
      @BeforeTest
      public void compileTestModule() throws Exception {
  
          // javac -d mods/$TESTMODULE src/$TESTMODULE/**
</pre>
<hr />
<pre>
<span class="line-old-header">*** 257,6 ***</span>
<span class="line-new-header">--- 262,89 ---</span>
          // java --module-path mods --module $TESTMODULE/$MAINCLASS
          int exitValue = exec(&quot;--module-path&quot;, modulepath, &quot;--module&quot;, mid);
          assertTrue(exitValue != 0);
      }
  
<span class="line-added">+ </span>
<span class="line-added">+     /**</span>
<span class="line-added">+      * Helper method that creates a ProcessBuilder with command line arguments</span>
<span class="line-added">+      * while setting the _JAVA_LAUNCHER_DEBUG environment variable.</span>
<span class="line-added">+      */</span>
<span class="line-added">+     private ProcessBuilder createProcessWithLauncherDebugging(String... cmds) {</span>
<span class="line-added">+         ProcessBuilder pb = ProcessTools.createJavaProcessBuilder(Utils.addTestJavaOpts(cmds));</span>
<span class="line-added">+         pb.environment().put(&quot;_JAVA_LAUNCHER_DEBUG&quot;, &quot;true&quot;);</span>
<span class="line-added">+ </span>
<span class="line-added">+         return pb;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+      /**</span>
<span class="line-added">+      * Test the ability for the Windows launcher to do proper application argument</span>
<span class="line-added">+      * detection and expansion, when using the long form module option and all passed in</span>
<span class="line-added">+      * command line arguments are prefixed with a dash.</span>
<span class="line-added">+      *</span>
<span class="line-added">+      * These tests are not expected to work on *nixes, and are ignored.</span>
<span class="line-added">+      */</span>
<span class="line-added">+     public void testWindowsWithLongFormModuleOption() throws Exception {</span>
<span class="line-added">+         if (!IS_WINDOWS) {</span>
<span class="line-added">+             return;</span>
<span class="line-added">+         }</span>
<span class="line-added">+ </span>
<span class="line-added">+         String dir = MODS_DIR.toString();</span>
<span class="line-added">+         String mid = TEST_MODULE + &quot;/&quot; + MAIN_CLASS;</span>
<span class="line-added">+ </span>
<span class="line-added">+         // java --module-path=mods --module=$TESTMODULE/$MAINCLASS --help</span>
<span class="line-added">+         // We should be able to find the argument --help as an application argument</span>
<span class="line-added">+         ProcessTools.executeProcess(</span>
<span class="line-added">+             createProcessWithLauncherDebugging(</span>
<span class="line-added">+                 &quot;--module-path=&quot; + dir,</span>
<span class="line-added">+                 &quot;--module=&quot; + mid,</span>
<span class="line-added">+                 &quot;--help&quot;))</span>
<span class="line-added">+             .outputTo(System.out)</span>
<span class="line-added">+             .errorTo(System.out)</span>
<span class="line-added">+             .shouldContain(&quot;F--help&quot;);</span>
<span class="line-added">+ </span>
<span class="line-added">+         // java --module-path=mods --module=$TESTMODULE/$MAINCLASS &lt;...src/test&gt;/*.java --help</span>
<span class="line-added">+         // We should be able to see argument expansion happen</span>
<span class="line-added">+         ProcessTools.executeProcess(</span>
<span class="line-added">+             createProcessWithLauncherDebugging(</span>
<span class="line-added">+                 &quot;--module-path=&quot; + dir,</span>
<span class="line-added">+                 &quot;--module=&quot; + mid,</span>
<span class="line-added">+                 SRC_DIR.resolve(TEST_MODULE).toString() + &quot;\\*.java&quot;,</span>
<span class="line-added">+                 &quot;--help&quot;))</span>
<span class="line-added">+             .outputTo(System.out)</span>
<span class="line-added">+             .errorTo(System.out)</span>
<span class="line-added">+             .shouldContain(&quot;F--help&quot;)</span>
<span class="line-added">+             .shouldContain(&quot;module-info.java&quot;);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+ </span>
<span class="line-added">+     /**</span>
<span class="line-added">+      * Test that --module= is terminating for VM argument processing just like --module</span>
<span class="line-added">+      */</span>
<span class="line-added">+     public void testLongFormModuleOptionTermination() throws Exception {</span>
<span class="line-added">+         String dir = MODS_DIR.toString();</span>
<span class="line-added">+         String mid = TEST_MODULE + &quot;/&quot; + MAIN_CLASS;</span>
<span class="line-added">+ </span>
<span class="line-added">+         // java --module-path=mods --module=$TESTMODULE/$MAINCLASS --module-path=mods --module=$TESTMODULE/$MAINCLASS</span>
<span class="line-added">+         // The first --module= will terminate the VM arguments processing. The second pair of module-path and module will be</span>
<span class="line-added">+         // deemed as application arguments</span>
<span class="line-added">+         OutputAnalyzer output = ProcessTools.executeProcess(</span>
<span class="line-added">+             createProcessWithLauncherDebugging(</span>
<span class="line-added">+                 &quot;--module-path=&quot; + dir,</span>
<span class="line-added">+                 &quot;--module=&quot; + mid,</span>
<span class="line-added">+                 &quot;--module-path=&quot; + dir,</span>
<span class="line-added">+                 &quot;--module=&quot; + mid))</span>
<span class="line-added">+             .outputTo(System.out)</span>
<span class="line-added">+             .errorTo(System.out)</span>
<span class="line-added">+             .shouldContain(&quot;argv[ 0] = &#39;--module-path=&quot; + dir)</span>
<span class="line-added">+             .shouldContain(&quot;argv[ 1] = &#39;--module=&quot; + mid);</span>
<span class="line-added">+ </span>
<span class="line-added">+         if (IS_WINDOWS) {</span>
<span class="line-added">+             output.shouldContain(&quot;F--module-path=&quot; + dir).shouldContain(&quot;F--module=&quot; + mid);</span>
<span class="line-added">+         }</span>
<span class="line-added">+ </span>
<span class="line-added">+         // java --module=$TESTMODULE/$MAINCLASS --module-path=mods</span>
<span class="line-added">+         // This command line will not work as --module= is terminating and the module will be not found</span>
<span class="line-added">+         int exitValue = exec(&quot;--module=&quot; + mid, &quot;--module-path&quot; + dir);</span>
<span class="line-added">+         assertTrue(exitValue != 0);</span>
<span class="line-added">+     }</span>
  }
</pre>
<center><a href="../../VersionCheck.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../../../../../jtreg-ext/requires/VMProps.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>