<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/tools/launcher/Arrrghs.java</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="ArgsFileTest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="HelpFlagsTest.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/tools/launcher/Arrrghs.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2007, 2015, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /**
 25  * @test
 26  * @bug 5030233 6214916 6356475 6571029 6684582 6742159 4459600 6758881 6753938
<span class="line-modified"> 27  *      6894719 6968053 7151434 7146424 8007333 8077822 8143640 8132379</span>
 28  * @summary Argument parsing validation.
 29  * @modules jdk.compiler
 30  *          jdk.zipfs
 31  * @compile -XDignore.symbol.file Arrrghs.java
 32  * @run main/othervm Arrrghs
 33  */
 34 
 35 
 36 import java.io.File;
 37 import java.io.FileNotFoundException;
 38 import java.io.IOException;



 39 import java.util.ArrayList;
 40 import java.util.Arrays;
 41 import java.util.HashMap;
 42 import java.util.List;
 43 import java.util.Map;
 44 import java.util.regex.Matcher;
 45 import java.util.regex.Pattern;
 46 
 47 public class Arrrghs extends TestHelper {
 48     private Arrrghs(){}
 49     /**
 50      * This class provides various tests for arguments processing.
 51      *
 52      * History: these set of tests  were part of Arrrghs.sh. The MKS shell
 53      * implementations were notoriously buggy. Implementing these tests purely
 54      * in Java is not only portable but also robust.
 55      *
 56      */
 57 
<span class="line-removed"> 58     /*</span>
<span class="line-removed"> 59      * SIGH, On Windows all strings are quoted, we need to unwrap it</span>
<span class="line-removed"> 60      */</span>
<span class="line-removed"> 61     private static String removeExtraQuotes(String in) {</span>
<span class="line-removed"> 62         if (isWindows) {</span>
<span class="line-removed"> 63             // Trim the string and remove the enclosed quotes if any.</span>
<span class="line-removed"> 64             in = in.trim();</span>
<span class="line-removed"> 65             if (in.startsWith(&quot;\&quot;&quot;) &amp;&amp; in.endsWith(&quot;\&quot;&quot;)) {</span>
<span class="line-removed"> 66                 return in.substring(1, in.length()-1);</span>
<span class="line-removed"> 67             }</span>
<span class="line-removed"> 68         }</span>
<span class="line-removed"> 69         return in;</span>
<span class="line-removed"> 70     }</span>
<span class="line-removed"> 71 </span>
 72     // the pattern we hope to see in the output
 73     static final Pattern ArgPattern = Pattern.compile(&quot;\\s*argv\\[[0-9]*\\].*=.*&quot;);
 74 
 75     void checkArgumentParsing(String inArgs, String... expArgs) throws IOException {
 76         List&lt;String&gt; scratchpad = new ArrayList&lt;&gt;();
 77         scratchpad.add(&quot;set &quot; + JLDEBUG_KEY + &quot;=true&quot;);
 78         // GAK, -version needs to be added so that windows can flush its stderr
 79         // exiting the process prematurely can terminate the stderr.
 80         scratchpad.add(javaCmd + &quot; -version &quot; + inArgs);
 81         File batFile = new File(&quot;atest.bat&quot;);
 82         createAFile(batFile, scratchpad);
 83 
 84         TestResult tr = doExec(batFile.getName());
 85 
 86         ArrayList&lt;String&gt; expList = new ArrayList&lt;&gt;();
 87         expList.add(javaCmd);
 88         expList.add(&quot;-version&quot;);
 89         expList.addAll(Arrays.asList(expArgs));
 90 
 91         List&lt;String&gt; gotList = new ArrayList&lt;&gt;();
</pre>
<hr />
<pre>
472         if (!tr.testStatus)
473             System.out.println(tr);
474 
475         // 6753938, test for non-negative exit value for an incorrectly formed
476         // command line,  &#39;% java -Xcomp&#39;
477         tr = doExec(javaCmd, &quot;-Xcomp&quot;);
478         tr.checkNegative();
479         tr.isNotZeroOutput();
480         if (!tr.testStatus)
481             System.out.println(tr);
482 
483         // 7151434, test for non-negative exit value for an incorrectly formed
484         // command line, &#39;% java -jar -W&#39;, note the bogus -W
485         tr = doExec(javaCmd, &quot;-jar&quot;, &quot;-W&quot;);
486         tr.checkNegative();
487         tr.contains(&quot;Unrecognized option: -W&quot;);
488         if (!tr.testStatus)
489             System.out.println(tr);
490     }
491 





















492     /*
493      * Tests various dispositions of the main method, these tests are limited
494      * to English locales as they check for error messages that are localized.
495      */
496     @Test
497     void testMainMethod() throws FileNotFoundException {
498         if (!isEnglishLocale()) {
499             return;
500         }
501 
502         TestResult tr;
503 
504         // a missing class
505         createJar(&quot;MIA&quot;, new File(&quot;some.jar&quot;), new File(&quot;Foo&quot;),
506                 (String[])null);
507         tr = doExec(javaCmd, &quot;-jar&quot;, &quot;some.jar&quot;);
508         tr.contains(&quot;Error: Could not find or load main class MIA&quot;);
509         if (!tr.testStatus)
510             System.out.println(tr);
511         // use classpath to check
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2007, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /**
 25  * @test
 26  * @bug 5030233 6214916 6356475 6571029 6684582 6742159 4459600 6758881 6753938
<span class="line-modified"> 27  *      6894719 6968053 7151434 7146424 8007333 8077822 8143640 8132379 8218547</span>
 28  * @summary Argument parsing validation.
 29  * @modules jdk.compiler
 30  *          jdk.zipfs
 31  * @compile -XDignore.symbol.file Arrrghs.java
 32  * @run main/othervm Arrrghs
 33  */
 34 
 35 
 36 import java.io.File;
 37 import java.io.FileNotFoundException;
 38 import java.io.IOException;
<span class="line-added"> 39 import java.nio.file.Files;</span>
<span class="line-added"> 40 import java.nio.file.Paths;</span>
<span class="line-added"> 41 import java.nio.file.Path;</span>
 42 import java.util.ArrayList;
 43 import java.util.Arrays;
 44 import java.util.HashMap;
 45 import java.util.List;
 46 import java.util.Map;
 47 import java.util.regex.Matcher;
 48 import java.util.regex.Pattern;
 49 
 50 public class Arrrghs extends TestHelper {
 51     private Arrrghs(){}
 52     /**
 53      * This class provides various tests for arguments processing.
 54      *
 55      * History: these set of tests  were part of Arrrghs.sh. The MKS shell
 56      * implementations were notoriously buggy. Implementing these tests purely
 57      * in Java is not only portable but also robust.
 58      *
 59      */
 60 














 61     // the pattern we hope to see in the output
 62     static final Pattern ArgPattern = Pattern.compile(&quot;\\s*argv\\[[0-9]*\\].*=.*&quot;);
 63 
 64     void checkArgumentParsing(String inArgs, String... expArgs) throws IOException {
 65         List&lt;String&gt; scratchpad = new ArrayList&lt;&gt;();
 66         scratchpad.add(&quot;set &quot; + JLDEBUG_KEY + &quot;=true&quot;);
 67         // GAK, -version needs to be added so that windows can flush its stderr
 68         // exiting the process prematurely can terminate the stderr.
 69         scratchpad.add(javaCmd + &quot; -version &quot; + inArgs);
 70         File batFile = new File(&quot;atest.bat&quot;);
 71         createAFile(batFile, scratchpad);
 72 
 73         TestResult tr = doExec(batFile.getName());
 74 
 75         ArrayList&lt;String&gt; expList = new ArrayList&lt;&gt;();
 76         expList.add(javaCmd);
 77         expList.add(&quot;-version&quot;);
 78         expList.addAll(Arrays.asList(expArgs));
 79 
 80         List&lt;String&gt; gotList = new ArrayList&lt;&gt;();
</pre>
<hr />
<pre>
461         if (!tr.testStatus)
462             System.out.println(tr);
463 
464         // 6753938, test for non-negative exit value for an incorrectly formed
465         // command line,  &#39;% java -Xcomp&#39;
466         tr = doExec(javaCmd, &quot;-Xcomp&quot;);
467         tr.checkNegative();
468         tr.isNotZeroOutput();
469         if (!tr.testStatus)
470             System.out.println(tr);
471 
472         // 7151434, test for non-negative exit value for an incorrectly formed
473         // command line, &#39;% java -jar -W&#39;, note the bogus -W
474         tr = doExec(javaCmd, &quot;-jar&quot;, &quot;-W&quot;);
475         tr.checkNegative();
476         tr.contains(&quot;Unrecognized option: -W&quot;);
477         if (!tr.testStatus)
478             System.out.println(tr);
479     }
480 
<span class="line-added">481     /*</span>
<span class="line-added">482      * Tests -jar command on a jar file with &quot;long&quot; (&gt; 260 chars) full path on Windows</span>
<span class="line-added">483      */</span>
<span class="line-added">484     @Test</span>
<span class="line-added">485     void testLongPathJarFile() throws IOException {</span>
<span class="line-added">486         if (!isWindows) {</span>
<span class="line-added">487             return;</span>
<span class="line-added">488         }</span>
<span class="line-added">489         // put the jar file to a location with long path</span>
<span class="line-added">490         String longPathPart = &quot;longpathtest_longpathtest/&quot;;</span>
<span class="line-added">491         String longPathStr = longPathPart.repeat(15);</span>
<span class="line-added">492         Path longPath = Paths.get(longPathStr);</span>
<span class="line-added">493         Path jarPath = Files.createDirectories(longPath).resolve(&quot;elp.jar&quot;);</span>
<span class="line-added">494         File elp = jarPath.toFile();</span>
<span class="line-added">495         createJar(elp, new File(&quot;Foo&quot;), &quot;public static void main(String[] args){ System.out.println(\&quot;Hello from ELP\&quot;); }&quot;);</span>
<span class="line-added">496         System.out.println(&quot;execute &quot; + elp.getAbsolutePath());</span>
<span class="line-added">497         TestResult tr = doExec(javaCmd, &quot;-jar&quot;, elp.getAbsolutePath());</span>
<span class="line-added">498         tr.checkPositive();</span>
<span class="line-added">499         tr.contains(&quot;Hello from ELP&quot;);</span>
<span class="line-added">500     }</span>
<span class="line-added">501 </span>
502     /*
503      * Tests various dispositions of the main method, these tests are limited
504      * to English locales as they check for error messages that are localized.
505      */
506     @Test
507     void testMainMethod() throws FileNotFoundException {
508         if (!isEnglishLocale()) {
509             return;
510         }
511 
512         TestResult tr;
513 
514         // a missing class
515         createJar(&quot;MIA&quot;, new File(&quot;some.jar&quot;), new File(&quot;Foo&quot;),
516                 (String[])null);
517         tr = doExec(javaCmd, &quot;-jar&quot;, &quot;some.jar&quot;);
518         tr.contains(&quot;Error: Could not find or load main class MIA&quot;);
519         if (!tr.testStatus)
520             System.out.println(tr);
521         // use classpath to check
</pre>
</td>
</tr>
</table>
<center><a href="ArgsFileTest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="HelpFlagsTest.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>