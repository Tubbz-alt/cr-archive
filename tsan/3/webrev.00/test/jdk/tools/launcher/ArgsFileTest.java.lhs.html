<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/jdk/tools/launcher/ArgsFileTest.java</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 2015, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /**
 25  * @test
<a name="1" id="anc1"></a><span class="line-modified"> 26  * @bug 8027634</span>
 27  * @summary Argument parsing from file
 28  * @modules jdk.compiler
 29  *          jdk.zipfs
 30  * @build TestHelper
 31  * @run main ArgsFileTest
 32  */
 33 import java.io.File;
 34 import java.io.IOException;
 35 import java.util.ArrayList;
 36 import java.util.Arrays;
 37 import java.util.Collections;
 38 import java.util.HashMap;
 39 import java.util.List;
 40 import java.util.Map;
 41 import java.util.regex.Matcher;
 42 import java.util.regex.Pattern;
 43 
 44 public class ArgsFileTest extends TestHelper {
 45     private static File testJar = null;
 46     private static Map&lt;String, String&gt; env = new HashMap&lt;&gt;();
 47 
 48     static void init() throws IOException {
 49         if  (testJar != null) {
 50             return;
 51         }
 52         testJar = new File(&quot;test.jar&quot;);
 53         StringBuilder tsrc = new StringBuilder();
 54         tsrc.append(&quot;public static void main(String... args) {\n&quot;);
 55         tsrc.append(&quot;   for (String x : args) {\n&quot;);
 56         tsrc.append(&quot;        System.out.println(x);\n&quot;);
 57         tsrc.append(&quot;   }\n&quot;);
 58         tsrc.append(&quot;}\n&quot;);
 59         createJar(testJar, new File(&quot;Foo&quot;), tsrc.toString());
 60 
 61         env.put(JLDEBUG_KEY, &quot;true&quot;);
 62     }
 63 
<a name="2" id="anc2"></a><span class="line-modified"> 64     private File createArgFile(String fname, List&lt;String&gt; lines) throws IOException {</span>
 65         File argFile = new File(fname);
 66         argFile.delete();
<a name="3" id="anc3"></a><span class="line-modified"> 67         createAFile(argFile, lines);</span>
 68         return argFile;
 69     }
 70 
<a name="4" id="anc4"></a>



 71     private void verifyOptions(List&lt;String&gt; args, TestResult tr) {
 72         if (args.isEmpty()) {
 73             return;
 74         }
 75 
 76         int i = 1;
 77         for (String x : args) {
 78             tr.matches(&quot;.*argv\\[&quot; + i + &quot;\\] = &quot; + Pattern.quote(x) + &quot;.*&quot;);
 79             i++;
 80         }
 81         if (! tr.testStatus) {
 82             System.out.println(tr);
 83             throw new RuntimeException(&quot;test fails&quot;);
 84         }
 85     }
 86 
 87     private void verifyUserArgs(List&lt;String&gt; args, TestResult tr, int index) {
 88         if (javaCmd != TestHelper.javaCmd) {
 89             tr.contains(&quot;\tFirst application arg index: 1&quot;);
 90         } else {
 91             tr.contains(&quot;\tFirst application arg index: &quot; + index);
 92 
 93             for (String arg: args) {
 94                 tr.matches(&quot;^&quot; + Pattern.quote(arg) + &quot;$&quot;);
 95             }
 96         }
 97 
 98         if (! tr.testStatus) {
 99             System.out.println(tr);
100             throw new RuntimeException(&quot;test fails&quot;);
101         }
102     }
103 
104     @Test
105     public void expandAll() throws IOException {
106         List&lt;String&gt; lines = new ArrayList&lt;&gt;();
107         lines.add(&quot;-Xmx32m&quot;);
108         lines.add(&quot;-Xint&quot;);
109         File argFile1 = createArgFile(&quot;argFile1&quot;, lines);
110         lines = new ArrayList&lt;&gt;();
111         lines.add(&quot;-jar&quot;);
112         lines.add(&quot;test.jar&quot;);
113         lines.add(&quot;uarg1 @uarg2 @@uarg3 -uarg4 uarg5&quot;);
114         File argFile2 = createArgFile(&quot;argFile2&quot;, lines);
115 
116         TestResult tr = doExec(env, javaCmd, &quot;@argFile1&quot;, &quot;@argFile2&quot;);
117 
118         List&lt;String&gt; appArgs = new ArrayList&lt;&gt;();
119         appArgs.add(&quot;uarg1&quot;);
120         appArgs.add(&quot;@uarg2&quot;);
121         appArgs.add(&quot;@@uarg3&quot;);
122         appArgs.add(&quot;-uarg4&quot;);
123         appArgs.add(&quot;uarg5&quot;);
124 
125         List&lt;String&gt; options = new ArrayList&lt;&gt;();
126         options.add(&quot;-Xmx32m&quot;);
127         options.add(&quot;-Xint&quot;);
128         options.add(&quot;-jar&quot;);
129         options.add(&quot;test.jar&quot;);
130         options.addAll(appArgs);
131 
132         verifyOptions(options, tr);
133         verifyUserArgs(appArgs, tr, 5);
134         argFile1.delete();
135         argFile2.delete();
136 
137         File cpFile = createArgFile(&quot;cpFile&quot;, Arrays.asList(&quot;-cp&quot;, &quot;test.jar&quot;));
138         List&lt;String&gt; appCmd = new ArrayList&lt;&gt;();
139         appCmd.add(&quot;Foo&quot;);
140         appCmd.addAll(appArgs);
141         File appFile = createArgFile(&quot;appFile&quot;, appCmd);
142 
143         tr = doExec(env, javaCmd, &quot;@cpFile&quot;, &quot;@appFile&quot;);
144         verifyOptions(Arrays.asList(&quot;-cp&quot;, &quot;test.jar&quot;, &quot;Foo&quot;,
145                 &quot;uarg1&quot;, &quot;@uarg2&quot;, &quot;@@uarg3&quot;, &quot;-uarg4&quot;, &quot;uarg5&quot;), tr);
146         verifyUserArgs(appArgs, tr, 4);
147         cpFile.delete();
148         appFile.delete();
149     }
150 
151     @Test
152     public void escapeArg() throws IOException {
153         List&lt;String&gt; lines = new ArrayList&lt;&gt;();
154         lines.add(&quot;-Xmx32m&quot;);
155         lines.add(&quot;-Xint&quot;);
156         File argFile1 = createArgFile(&quot;argFile1&quot;, lines);
157 
158         TestResult tr = doExec(env, javaCmd, &quot;-cp&quot;, &quot;@@arg&quot;, &quot;-cp&quot;, &quot;@&quot;,
159                 &quot;-cp&quot;, &quot;@@@cp&quot;, &quot;@argFile1&quot;, &quot;@@@@Main@@@@&quot;, &quot;-version&quot;);
160         List&lt;String&gt; options = new ArrayList&lt;&gt;();
161         options.add(&quot;-cp&quot;);
162         options.add(&quot;@arg&quot;);
163         options.add(&quot;-cp&quot;);
164         options.add(&quot;@&quot;);
165         options.add(&quot;-cp&quot;);
166         options.add(&quot;@@cp&quot;);
167         options.add(&quot;-Xmx32m&quot;);
168         options.add(&quot;-Xint&quot;);
169         options.add(&quot;@@@Main@@@@&quot;);
170         options.add(&quot;-version&quot;);
171         verifyOptions(options, tr);
172         verifyUserArgs(Collections.emptyList(), tr, options.size());
173         argFile1.delete();
174     }
175 
176     @Test
177     public void killSwitch() throws IOException {
178         List&lt;String&gt; lines = new ArrayList&lt;&gt;();
179         lines.add(&quot;-Xmx32m&quot;);
180         lines.add(&quot;-Xint&quot;);
181         File argFile1 = createArgFile(&quot;argFile1&quot;, lines);
182         lines = new ArrayList&lt;&gt;();
183         lines.add(&quot;-jar&quot;);
184         lines.add(&quot;test.jar&quot;);
185         lines.add(&quot;uarg1 @uarg2 @@uarg3 -uarg4 uarg5&quot;);
186         File argFile2 = createArgFile(&quot;argFile2&quot;, lines);
187         File argKill = createArgFile(&quot;argKill&quot;,
188             Collections.singletonList(&quot;--disable-@files&quot;));
189 
190         TestResult tr = doExec(env, javaCmd, &quot;@argFile1&quot;, &quot;--disable-@files&quot;, &quot;@argFile2&quot;);
191         List&lt;String&gt; options = new ArrayList&lt;&gt;();
192         options.add(&quot;-Xmx32m&quot;);
193         options.add(&quot;-Xint&quot;);
194         options.add(&quot;--disable-@files&quot;);
195         options.add(&quot;@argFile2&quot;);
196         verifyOptions(options, tr);
197         // Main class is @argFile2
198         verifyUserArgs(Collections.emptyList(), tr, 5);
199 
200         // Specify in file is same as specify inline
201         tr = doExec(env, javaCmd, &quot;@argFile1&quot;, &quot;@argKill&quot;, &quot;@argFile2&quot;);
202         verifyOptions(options, tr);
203         // Main class is @argFile2
204         verifyUserArgs(Collections.emptyList(), tr, 5);
205 
206         // multiple is fine, once on is on.
207         tr = doExec(env, javaCmd, &quot;@argKill&quot;, &quot;@argFile1&quot;, &quot;--disable-@files&quot;, &quot;@argFile2&quot;);
208         options = Arrays.asList(&quot;--disable-@files&quot;, &quot;@argFile1&quot;,
209                 &quot;--disable-@files&quot;, &quot;@argFile2&quot;);
210         verifyOptions(options, tr);
211         verifyUserArgs(Collections.emptyList(), tr, 3);
212 
213         // after main class, becoming an user application argument
214         tr = doExec(env, javaCmd, &quot;@argFile2&quot;, &quot;@argKill&quot;);
215         options = Arrays.asList(&quot;-jar&quot;, &quot;test.jar&quot;, &quot;uarg1&quot;, &quot;@uarg2&quot;, &quot;@@uarg3&quot;,
216                 &quot;-uarg4&quot;, &quot;uarg5&quot;, &quot;@argKill&quot;);
217         verifyOptions(options, tr);
218         verifyUserArgs(Arrays.asList(&quot;uarg1&quot;, &quot;@uarg2&quot;, &quot;@@uarg3&quot;,
219                 &quot;-uarg4&quot;, &quot;uarg5&quot;, &quot;@argKill&quot;), tr, 3);
220 
221         argFile1.delete();
222         argFile2.delete();
223         argKill.delete();
224     }
225 
226     @Test
227     public void userApplication() throws IOException {
228         List&lt;String&gt; lines = new ArrayList&lt;&gt;();
229         lines.add(&quot;-Xmx32m&quot;);
230         lines.add(&quot;-Xint&quot;);
231         File vmArgs = createArgFile(&quot;vmArgs&quot;, lines);
232         File jarOpt = createArgFile(&quot;jarOpt&quot;, Arrays.asList(&quot;-jar&quot;));
233         File cpOpt = createArgFile(&quot;cpOpt&quot;, Arrays.asList(&quot;-cp&quot;));
234         File jarArg = createArgFile(&quot;jarArg&quot;, Arrays.asList(&quot;test.jar&quot;));
235         File userArgs = createArgFile(&quot;userArgs&quot;, Arrays.asList(&quot;-opt&quot;, &quot;arg&quot;, &quot;--longopt&quot;));
236 
237         TestResult tr = doExec(env, javaCmd,
238                 &quot;@vmArgs&quot;, &quot;@jarOpt&quot;, &quot;test.jar&quot;, &quot;-opt&quot;, &quot;arg&quot;, &quot;--longopt&quot;);
239         verifyOptions(Arrays.asList(
240                 &quot;-Xmx32m&quot;, &quot;-Xint&quot;, &quot;-jar&quot;, &quot;test.jar&quot;, &quot;-opt&quot;, &quot;arg&quot;, &quot;--longopt&quot;), tr);
241         verifyUserArgs(Arrays.asList(&quot;-opt&quot;, &quot;arg&quot;, &quot;--longopt&quot;), tr, 5);
242 
243         tr = doExec(env, javaCmd, &quot;@jarOpt&quot;, &quot;@jarArg&quot;, &quot;@vmArgs&quot;);
244         verifyOptions(Arrays.asList(&quot;-jar&quot;, &quot;test.jar&quot;, &quot;@vmArgs&quot;), tr);
245         verifyUserArgs(Arrays.asList(&quot;@vmArgs&quot;), tr, 3);
246 
247         tr = doExec(env, javaCmd, &quot;-cp&quot;, &quot;@jarArg&quot;, &quot;@vmArgs&quot;, &quot;Foo&quot;, &quot;@userArgs&quot;);
248         verifyOptions(Arrays.asList(&quot;-cp&quot;, &quot;test.jar&quot;, &quot;-Xmx32m&quot;, &quot;-Xint&quot;,
249                 &quot;Foo&quot;, &quot;@userArgs&quot;), tr);
250         verifyUserArgs(Arrays.asList(&quot;@userArgs&quot;), tr, 6);
251 
252         tr = doExec(env, javaCmd, &quot;@cpOpt&quot;, &quot;@jarArg&quot;, &quot;@vmArgs&quot;, &quot;Foo&quot;, &quot;@userArgs&quot;);
253         verifyOptions(Arrays.asList(&quot;-cp&quot;, &quot;test.jar&quot;, &quot;-Xmx32m&quot;, &quot;-Xint&quot;,
254                 &quot;Foo&quot;, &quot;@userArgs&quot;), tr);
255         verifyUserArgs(Arrays.asList(&quot;@userArgs&quot;), tr, 6);
256 
257         tr = doExec(env, javaCmd, &quot;@cpOpt&quot;, &quot;test.jar&quot;, &quot;@vmArgs&quot;, &quot;Foo&quot;, &quot;@userArgs&quot;);
258         verifyOptions(Arrays.asList(&quot;-cp&quot;, &quot;test.jar&quot;, &quot;-Xmx32m&quot;, &quot;-Xint&quot;,
259                 &quot;Foo&quot;, &quot;@userArgs&quot;), tr);
260         verifyUserArgs(Arrays.asList(&quot;@userArgs&quot;), tr, 6);
261 
262         vmArgs.delete();
263         jarOpt.delete();
264         cpOpt.delete();
265         jarArg.delete();
266         userArgs.delete();
267     }
268 
<a name="5" id="anc5"></a>
















269     // test with missing file
270     @Test
271     public void missingFileNegativeTest() throws IOException {
272         TestResult tr = doExec(javaCmd, &quot;@&quot; + &quot;missing.cmd&quot;);
273         tr.checkNegative();
274         tr.contains(&quot;Error: could not open `missing.cmd&#39;&quot;);
275         if (!tr.testStatus) {
276             System.out.println(tr);
277             throw new RuntimeException(&quot;test fails&quot;);
278         }
279     }
280 
281     public static void main(String... args) throws Exception {
282         init();
283         ArgsFileTest a = new ArgsFileTest();
284         a.run(args);
285         if (testExitValue &gt; 0) {
286             System.out.println(&quot;Total of &quot; + testExitValue + &quot; failed&quot;);
287             System.exit(1);
288         } else {
289             System.out.println(&quot;All tests pass&quot;);
290         }
291     }
292 }
<a name="6" id="anc6"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="6" type="hidden" />
</body>
</html>