<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/tools/launcher/ArgsFileTest.java</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="ArgsEnvVar.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="Arrrghs.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/tools/launcher/ArgsFileTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /**
 25  * @test
<span class="line-modified"> 26  * @bug 8027634</span>
 27  * @summary Argument parsing from file
 28  * @modules jdk.compiler
 29  *          jdk.zipfs
 30  * @build TestHelper
 31  * @run main ArgsFileTest
 32  */
 33 import java.io.File;
 34 import java.io.IOException;
 35 import java.util.ArrayList;
 36 import java.util.Arrays;
 37 import java.util.Collections;
 38 import java.util.HashMap;
 39 import java.util.List;
 40 import java.util.Map;
 41 import java.util.regex.Matcher;
 42 import java.util.regex.Pattern;
 43 
 44 public class ArgsFileTest extends TestHelper {
 45     private static File testJar = null;
 46     private static Map&lt;String, String&gt; env = new HashMap&lt;&gt;();
 47 
 48     static void init() throws IOException {
 49         if  (testJar != null) {
 50             return;
 51         }
 52         testJar = new File(&quot;test.jar&quot;);
 53         StringBuilder tsrc = new StringBuilder();
 54         tsrc.append(&quot;public static void main(String... args) {\n&quot;);
 55         tsrc.append(&quot;   for (String x : args) {\n&quot;);
 56         tsrc.append(&quot;        System.out.println(x);\n&quot;);
 57         tsrc.append(&quot;   }\n&quot;);
 58         tsrc.append(&quot;}\n&quot;);
 59         createJar(testJar, new File(&quot;Foo&quot;), tsrc.toString());
 60 
 61         env.put(JLDEBUG_KEY, &quot;true&quot;);
 62     }
 63 
<span class="line-modified"> 64     private File createArgFile(String fname, List&lt;String&gt; lines) throws IOException {</span>
 65         File argFile = new File(fname);
 66         argFile.delete();
<span class="line-modified"> 67         createAFile(argFile, lines);</span>
 68         return argFile;
 69     }
 70 




 71     private void verifyOptions(List&lt;String&gt; args, TestResult tr) {
 72         if (args.isEmpty()) {
 73             return;
 74         }
 75 
 76         int i = 1;
 77         for (String x : args) {
 78             tr.matches(&quot;.*argv\\[&quot; + i + &quot;\\] = &quot; + Pattern.quote(x) + &quot;.*&quot;);
 79             i++;
 80         }
 81         if (! tr.testStatus) {
 82             System.out.println(tr);
 83             throw new RuntimeException(&quot;test fails&quot;);
 84         }
 85     }
 86 
 87     private void verifyUserArgs(List&lt;String&gt; args, TestResult tr, int index) {
 88         if (javaCmd != TestHelper.javaCmd) {
 89             tr.contains(&quot;\tFirst application arg index: 1&quot;);
 90         } else {
</pre>
<hr />
<pre>
249                 &quot;Foo&quot;, &quot;@userArgs&quot;), tr);
250         verifyUserArgs(Arrays.asList(&quot;@userArgs&quot;), tr, 6);
251 
252         tr = doExec(env, javaCmd, &quot;@cpOpt&quot;, &quot;@jarArg&quot;, &quot;@vmArgs&quot;, &quot;Foo&quot;, &quot;@userArgs&quot;);
253         verifyOptions(Arrays.asList(&quot;-cp&quot;, &quot;test.jar&quot;, &quot;-Xmx32m&quot;, &quot;-Xint&quot;,
254                 &quot;Foo&quot;, &quot;@userArgs&quot;), tr);
255         verifyUserArgs(Arrays.asList(&quot;@userArgs&quot;), tr, 6);
256 
257         tr = doExec(env, javaCmd, &quot;@cpOpt&quot;, &quot;test.jar&quot;, &quot;@vmArgs&quot;, &quot;Foo&quot;, &quot;@userArgs&quot;);
258         verifyOptions(Arrays.asList(&quot;-cp&quot;, &quot;test.jar&quot;, &quot;-Xmx32m&quot;, &quot;-Xint&quot;,
259                 &quot;Foo&quot;, &quot;@userArgs&quot;), tr);
260         verifyUserArgs(Arrays.asList(&quot;@userArgs&quot;), tr, 6);
261 
262         vmArgs.delete();
263         jarOpt.delete();
264         cpOpt.delete();
265         jarArg.delete();
266         userArgs.delete();
267     }
268 

















269     // test with missing file
270     @Test
271     public void missingFileNegativeTest() throws IOException {
272         TestResult tr = doExec(javaCmd, &quot;@&quot; + &quot;missing.cmd&quot;);
273         tr.checkNegative();
274         tr.contains(&quot;Error: could not open `missing.cmd&#39;&quot;);
275         if (!tr.testStatus) {
276             System.out.println(tr);
277             throw new RuntimeException(&quot;test fails&quot;);
278         }
279     }
280 
281     public static void main(String... args) throws Exception {
282         init();
283         ArgsFileTest a = new ArgsFileTest();
284         a.run(args);
285         if (testExitValue &gt; 0) {
286             System.out.println(&quot;Total of &quot; + testExitValue + &quot; failed&quot;);
287             System.exit(1);
288         } else {
</pre>
</td>
<td>
<hr />
<pre>
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /**
 25  * @test
<span class="line-modified"> 26  * @bug 8027634 8231863</span>
 27  * @summary Argument parsing from file
 28  * @modules jdk.compiler
 29  *          jdk.zipfs
 30  * @build TestHelper
 31  * @run main ArgsFileTest
 32  */
 33 import java.io.File;
 34 import java.io.IOException;
 35 import java.util.ArrayList;
 36 import java.util.Arrays;
 37 import java.util.Collections;
 38 import java.util.HashMap;
 39 import java.util.List;
 40 import java.util.Map;
 41 import java.util.regex.Matcher;
 42 import java.util.regex.Pattern;
 43 
 44 public class ArgsFileTest extends TestHelper {
 45     private static File testJar = null;
 46     private static Map&lt;String, String&gt; env = new HashMap&lt;&gt;();
 47 
 48     static void init() throws IOException {
 49         if  (testJar != null) {
 50             return;
 51         }
 52         testJar = new File(&quot;test.jar&quot;);
 53         StringBuilder tsrc = new StringBuilder();
 54         tsrc.append(&quot;public static void main(String... args) {\n&quot;);
 55         tsrc.append(&quot;   for (String x : args) {\n&quot;);
 56         tsrc.append(&quot;        System.out.println(x);\n&quot;);
 57         tsrc.append(&quot;   }\n&quot;);
 58         tsrc.append(&quot;}\n&quot;);
 59         createJar(testJar, new File(&quot;Foo&quot;), tsrc.toString());
 60 
 61         env.put(JLDEBUG_KEY, &quot;true&quot;);
 62     }
 63 
<span class="line-modified"> 64     private File createArgFile(String fname, List&lt;String&gt; lines, boolean endWithNewline) throws IOException {</span>
 65         File argFile = new File(fname);
 66         argFile.delete();
<span class="line-modified"> 67         createAFile(argFile, lines, endWithNewline);</span>
 68         return argFile;
 69     }
 70 
<span class="line-added"> 71     private File createArgFile(String fname, List&lt;String&gt; lines) throws IOException {</span>
<span class="line-added"> 72         return createArgFile(fname, lines, true);</span>
<span class="line-added"> 73     }</span>
<span class="line-added"> 74 </span>
 75     private void verifyOptions(List&lt;String&gt; args, TestResult tr) {
 76         if (args.isEmpty()) {
 77             return;
 78         }
 79 
 80         int i = 1;
 81         for (String x : args) {
 82             tr.matches(&quot;.*argv\\[&quot; + i + &quot;\\] = &quot; + Pattern.quote(x) + &quot;.*&quot;);
 83             i++;
 84         }
 85         if (! tr.testStatus) {
 86             System.out.println(tr);
 87             throw new RuntimeException(&quot;test fails&quot;);
 88         }
 89     }
 90 
 91     private void verifyUserArgs(List&lt;String&gt; args, TestResult tr, int index) {
 92         if (javaCmd != TestHelper.javaCmd) {
 93             tr.contains(&quot;\tFirst application arg index: 1&quot;);
 94         } else {
</pre>
<hr />
<pre>
253                 &quot;Foo&quot;, &quot;@userArgs&quot;), tr);
254         verifyUserArgs(Arrays.asList(&quot;@userArgs&quot;), tr, 6);
255 
256         tr = doExec(env, javaCmd, &quot;@cpOpt&quot;, &quot;@jarArg&quot;, &quot;@vmArgs&quot;, &quot;Foo&quot;, &quot;@userArgs&quot;);
257         verifyOptions(Arrays.asList(&quot;-cp&quot;, &quot;test.jar&quot;, &quot;-Xmx32m&quot;, &quot;-Xint&quot;,
258                 &quot;Foo&quot;, &quot;@userArgs&quot;), tr);
259         verifyUserArgs(Arrays.asList(&quot;@userArgs&quot;), tr, 6);
260 
261         tr = doExec(env, javaCmd, &quot;@cpOpt&quot;, &quot;test.jar&quot;, &quot;@vmArgs&quot;, &quot;Foo&quot;, &quot;@userArgs&quot;);
262         verifyOptions(Arrays.asList(&quot;-cp&quot;, &quot;test.jar&quot;, &quot;-Xmx32m&quot;, &quot;-Xint&quot;,
263                 &quot;Foo&quot;, &quot;@userArgs&quot;), tr);
264         verifyUserArgs(Arrays.asList(&quot;@userArgs&quot;), tr, 6);
265 
266         vmArgs.delete();
267         jarOpt.delete();
268         cpOpt.delete();
269         jarArg.delete();
270         userArgs.delete();
271     }
272 
<span class="line-added">273     @Test</span>
<span class="line-added">274     public void userApplicationWithoutEmptyLastLine() throws IOException {</span>
<span class="line-added">275         File cpOpt = createArgFile(&quot;cpOpt&quot;, Arrays.asList(&quot;-classpath .&quot;), false);</span>
<span class="line-added">276         File vmArgs = createArgFile(&quot;vmArgs&quot;, Arrays.asList(&quot;-Xint&quot;), false);</span>
<span class="line-added">277 </span>
<span class="line-added">278         TestResult tr = doExec(env, javaCmd, &quot;-cp&quot;, &quot;test.jar&quot;, &quot;@cpOpt&quot;, &quot;Foo&quot;, &quot;-test&quot;);</span>
<span class="line-added">279         verifyOptions(Arrays.asList(&quot;-cp&quot;, &quot;test.jar&quot;, &quot;-classpath&quot;, &quot;.&quot;, &quot;Foo&quot;, &quot;-test&quot;), tr);</span>
<span class="line-added">280         verifyUserArgs(Arrays.asList(&quot;-test&quot;), tr, 6);</span>
<span class="line-added">281 </span>
<span class="line-added">282         tr = doExec(env, javaCmd,  &quot;-cp&quot;, &quot;test.jar&quot;, &quot;@vmArgs&quot;, &quot;Foo&quot;, &quot;-test&quot;);</span>
<span class="line-added">283         verifyOptions(Arrays.asList(&quot;-cp&quot;, &quot;test.jar&quot;, &quot;-Xint&quot;, &quot;Foo&quot;, &quot;-test&quot;), tr);</span>
<span class="line-added">284         verifyUserArgs(Arrays.asList(&quot;-test&quot;), tr, 5);</span>
<span class="line-added">285 </span>
<span class="line-added">286         cpOpt.delete();</span>
<span class="line-added">287         vmArgs.delete();</span>
<span class="line-added">288     }</span>
<span class="line-added">289 </span>
290     // test with missing file
291     @Test
292     public void missingFileNegativeTest() throws IOException {
293         TestResult tr = doExec(javaCmd, &quot;@&quot; + &quot;missing.cmd&quot;);
294         tr.checkNegative();
295         tr.contains(&quot;Error: could not open `missing.cmd&#39;&quot;);
296         if (!tr.testStatus) {
297             System.out.println(tr);
298             throw new RuntimeException(&quot;test fails&quot;);
299         }
300     }
301 
302     public static void main(String... args) throws Exception {
303         init();
304         ArgsFileTest a = new ArgsFileTest();
305         a.run(args);
306         if (testExitValue &gt; 0) {
307             System.out.println(&quot;Total of &quot; + testExitValue + &quot; failed&quot;);
308             System.exit(1);
309         } else {
</pre>
</td>
</tr>
</table>
<center><a href="ArgsEnvVar.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="Arrrghs.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>