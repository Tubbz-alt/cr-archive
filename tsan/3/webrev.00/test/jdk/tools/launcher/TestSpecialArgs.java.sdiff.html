<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/tools/launcher/TestSpecialArgs.java</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="TestHelper.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="TooSmallStackSize.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/tools/launcher/TestSpecialArgs.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2012, 2015, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
</pre>
<hr />
<pre>
115     void testNativeMemoryTracking() {
116         final Map&lt;String, String&gt; envMap = new HashMap&lt;&gt;();
117         envMap.put(&quot;_JAVA_LAUNCHER_DEBUG&quot;, &quot;true&quot;);
118         TestResult tr;
119         /*
120          * test argument : -XX:NativeMemoryTracking=value
121          * A JVM flag, comsumed by the JVM, but requiring launcher
122          * to set an environmental variable if and only if value is supplied.
123          * Test and order:
124          * 1) execute with valid parameter: -XX:NativeMemoryTracking=MyValue
125          *    a) check for correct env variable name: &quot;NMT_LEVEL_&quot; + pid
126          *    b) check that &quot;MyValue&quot; was found in local env.
127          * 2) execute with invalid parameter: -XX:NativeMemoryTracking=
128          *    !) Won&#39;t find &quot;NativeMemoryTracking:&quot;
129          *       Code to create env variable not executed.
130          * 3) execute with invalid parameter: -XX:NativeMemoryTracking
131          *    !) Won&#39;t find &quot;NativeMemoryTracking:&quot;
132          *       Code to create env variable not executed.
133          * 4) give and invalid value and check to make sure JVM commented
134          */
<span class="line-removed">135         String launcherPidString = &quot;launcher.pid=&quot;;</span>
136         String envVarPidString = &quot;TRACER_MARKER: NativeMemoryTracking: env var is NMT_LEVEL_&quot;;
137         String NMT_Option_Value = &quot;off&quot;;
138         String myClassName = &quot;helloworld&quot;;
<span class="line-removed">139         boolean haveLauncherPid = false;</span>
140 
141         // === Run the tests ===
142         // ---Test 1a
143         tr = doExec(envMap, javaCmd, &quot;-XX:NativeMemoryTracking=&quot; + NMT_Option_Value,
144                 &quot;-version&quot;);
145 
146         // get the PID from the env var we set for the JVM
147         String envVarPid = null;
148         for (String line : tr.testOutput) {
149             if (line.contains(envVarPidString)) {
150                 int sindex = envVarPidString.length();
151                 envVarPid = line.substring(sindex);
152                 break;
153             }
154         }
155         // did we find envVarPid?
156         if (envVarPid == null) {
157             System.out.println(tr);
158             throw new RuntimeException(&quot;Error: failed to find env Var Pid in tracking info&quot;);
159         }
160         // we think we found the pid string.  min test, not &quot;&quot;.
161         if (envVarPid.length() &lt; 1) {
162             System.out.println(tr);
163             throw new RuntimeException(&quot;Error: env Var Pid in tracking info is empty string&quot;);
164         }
165 
<span class="line-removed">166         /*</span>
<span class="line-removed">167          * On Linux, Launcher Tracking will print the PID.  Use this info</span>
<span class="line-removed">168          * to validate what we got as the PID in the Launcher itself.</span>
<span class="line-removed">169          * Linux is the only one that prints this, and trying to get it</span>
<span class="line-removed">170          * here for win is awful.  So let the linux test make sure we get</span>
<span class="line-removed">171          * the valid pid, and for non-linux, just make sure pid string is</span>
<span class="line-removed">172          * non-zero.</span>
<span class="line-removed">173          */</span>
<span class="line-removed">174         if (isLinux) {</span>
<span class="line-removed">175             // get what the test says is the launcher pid</span>
<span class="line-removed">176             String launcherPid = null;</span>
<span class="line-removed">177             for (String line : tr.testOutput) {</span>
<span class="line-removed">178                 int index = line.indexOf(launcherPidString);</span>
<span class="line-removed">179                 if (index &gt;= 0) {</span>
<span class="line-removed">180                     int sindex = index + launcherPidString.length();</span>
<span class="line-removed">181                     int tindex = sindex + line.substring(sindex).indexOf(&quot;&#39;&quot;);</span>
<span class="line-removed">182                     System.out.println(&quot;DEBUG INFO: sindex = &quot; + sindex);</span>
<span class="line-removed">183                     System.out.println(&quot;DEBUG INFO: searching substring: &quot; + line.substring(sindex));</span>
<span class="line-removed">184                     System.out.println(&quot;DEBUG INFO: tindex = &quot; + tindex);</span>
<span class="line-removed">185                     // DEBUG INFO</span>
<span class="line-removed">186                     System.out.println(tr);</span>
<span class="line-removed">187                     launcherPid = line.substring(sindex, tindex);</span>
<span class="line-removed">188                     break;</span>
<span class="line-removed">189                 }</span>
<span class="line-removed">190             }</span>
<span class="line-removed">191             if (launcherPid == null) {</span>
<span class="line-removed">192                 System.out.println(tr);</span>
<span class="line-removed">193                 throw new RuntimeException(&quot;Error: failed to find launcher Pid in launcher tracking info&quot;);</span>
<span class="line-removed">194             }</span>
<span class="line-removed">195 </span>
<span class="line-removed">196             // did we create the env var with the correct pid?</span>
<span class="line-removed">197             if (!launcherPid.equals(envVarPid)) {</span>
<span class="line-removed">198                 System.out.println(tr);</span>
<span class="line-removed">199                 System.out.println(&quot;Error: wrong pid in creating env var&quot;);</span>
<span class="line-removed">200                 System.out.println(&quot;Error Info: launcherPid = &quot; + launcherPid);</span>
<span class="line-removed">201                 System.out.println(&quot;Error Info: envVarPid   = &quot; + envVarPid);</span>
<span class="line-removed">202                 throw new RuntimeException(&quot;Error: wrong pid in creating env var&quot;);</span>
<span class="line-removed">203             }</span>
<span class="line-removed">204         }</span>
<span class="line-removed">205 </span>
206         // --- Test 1b
207         if (!tr.contains(&quot;NativeMemoryTracking: got value &quot; + NMT_Option_Value)) {
208             System.out.println(tr);
209             throw new RuntimeException(&quot;Error: Valid param failed to set env variable&quot;);
210         }
211 
212         // --- Test 2
213         tr = doExec(envMap, javaCmd, &quot;-XX:NativeMemoryTracking=&quot;,
214                 &quot;-version&quot;);
215         if (tr.contains(&quot;NativeMemoryTracking:&quot;)) {
216             System.out.println(tr);
217             throw new RuntimeException(&quot;Error: invalid param caused env variable to be erroneously created&quot;);
218         }
219         if (!tr.contains(&quot;Syntax error, expecting -XX:NativeMemoryTracking=&quot;)) {
220             System.out.println(tr);
221             throw new RuntimeException(&quot;Error: invalid param not checked by JVM&quot;);
222         }
223 
224         // --- Test 3
225         tr = doExec(envMap, javaCmd, &quot;-XX:NativeMemoryTracking&quot;,
</pre>
<hr />
<pre>
271         envMap.put(&quot;CLASSPATH&quot;, &quot;.&quot;);
272         tr = doExec(envMap, javaCmd, &quot;Foo&quot;, &quot;-XX:NativeMemoryTracking=summary&quot;);
273         checkTestResult(tr);
274 
275         // should accept with no warnings
276         tr = doExec(javaCmd, &quot;-cp&quot;, jarFile.getName(),
277                     &quot;-XX:NativeMemoryTracking=summary&quot;, &quot;Foo&quot;);
278         ensureNoWarnings(tr);
279 
280         // should accept with no warnings
281         tr = doExec(javaCmd, &quot;-classpath&quot;, jarFile.getName(),
282                     &quot;-XX:NativeMemoryTracking=summary&quot;, &quot;Foo&quot;);
283         ensureNoWarnings(tr);
284 
285         // make sure a missing class is handled correctly, because the class
286         // resolution is performed by the JVM.
287         tr = doExec(javaCmd, &quot;AbsentClass&quot;, &quot;-XX:NativeMemoryTracking=summary&quot;);
288         if (!tr.contains(&quot;Error: Could not find or load main class AbsentClass&quot;)) {
289             throw new RuntimeException(&quot;Test Fails&quot;);
290         }




291     }
292 
293     void ensureNoWarnings(TestResult tr) {
294         checkTestResult(tr);
295         if (tr.contains(&quot;warning: Native Memory Tracking&quot;)) {
296             System.err.println(tr.toString());
297             throw new RuntimeException(&quot;Test Fails&quot;);
298         }
299     }
300 
301     void checkTestResult(TestResult tr) {
302         if (!tr.isOK()) {
303             System.err.println(tr.toString());
304             throw new RuntimeException(&quot;Test Fails&quot;);
305         }
306     }
307 }
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2012, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
</pre>
<hr />
<pre>
115     void testNativeMemoryTracking() {
116         final Map&lt;String, String&gt; envMap = new HashMap&lt;&gt;();
117         envMap.put(&quot;_JAVA_LAUNCHER_DEBUG&quot;, &quot;true&quot;);
118         TestResult tr;
119         /*
120          * test argument : -XX:NativeMemoryTracking=value
121          * A JVM flag, comsumed by the JVM, but requiring launcher
122          * to set an environmental variable if and only if value is supplied.
123          * Test and order:
124          * 1) execute with valid parameter: -XX:NativeMemoryTracking=MyValue
125          *    a) check for correct env variable name: &quot;NMT_LEVEL_&quot; + pid
126          *    b) check that &quot;MyValue&quot; was found in local env.
127          * 2) execute with invalid parameter: -XX:NativeMemoryTracking=
128          *    !) Won&#39;t find &quot;NativeMemoryTracking:&quot;
129          *       Code to create env variable not executed.
130          * 3) execute with invalid parameter: -XX:NativeMemoryTracking
131          *    !) Won&#39;t find &quot;NativeMemoryTracking:&quot;
132          *       Code to create env variable not executed.
133          * 4) give and invalid value and check to make sure JVM commented
134          */

135         String envVarPidString = &quot;TRACER_MARKER: NativeMemoryTracking: env var is NMT_LEVEL_&quot;;
136         String NMT_Option_Value = &quot;off&quot;;
137         String myClassName = &quot;helloworld&quot;;

138 
139         // === Run the tests ===
140         // ---Test 1a
141         tr = doExec(envMap, javaCmd, &quot;-XX:NativeMemoryTracking=&quot; + NMT_Option_Value,
142                 &quot;-version&quot;);
143 
144         // get the PID from the env var we set for the JVM
145         String envVarPid = null;
146         for (String line : tr.testOutput) {
147             if (line.contains(envVarPidString)) {
148                 int sindex = envVarPidString.length();
149                 envVarPid = line.substring(sindex);
150                 break;
151             }
152         }
153         // did we find envVarPid?
154         if (envVarPid == null) {
155             System.out.println(tr);
156             throw new RuntimeException(&quot;Error: failed to find env Var Pid in tracking info&quot;);
157         }
158         // we think we found the pid string.  min test, not &quot;&quot;.
159         if (envVarPid.length() &lt; 1) {
160             System.out.println(tr);
161             throw new RuntimeException(&quot;Error: env Var Pid in tracking info is empty string&quot;);
162         }
163 








































164         // --- Test 1b
165         if (!tr.contains(&quot;NativeMemoryTracking: got value &quot; + NMT_Option_Value)) {
166             System.out.println(tr);
167             throw new RuntimeException(&quot;Error: Valid param failed to set env variable&quot;);
168         }
169 
170         // --- Test 2
171         tr = doExec(envMap, javaCmd, &quot;-XX:NativeMemoryTracking=&quot;,
172                 &quot;-version&quot;);
173         if (tr.contains(&quot;NativeMemoryTracking:&quot;)) {
174             System.out.println(tr);
175             throw new RuntimeException(&quot;Error: invalid param caused env variable to be erroneously created&quot;);
176         }
177         if (!tr.contains(&quot;Syntax error, expecting -XX:NativeMemoryTracking=&quot;)) {
178             System.out.println(tr);
179             throw new RuntimeException(&quot;Error: invalid param not checked by JVM&quot;);
180         }
181 
182         // --- Test 3
183         tr = doExec(envMap, javaCmd, &quot;-XX:NativeMemoryTracking&quot;,
</pre>
<hr />
<pre>
229         envMap.put(&quot;CLASSPATH&quot;, &quot;.&quot;);
230         tr = doExec(envMap, javaCmd, &quot;Foo&quot;, &quot;-XX:NativeMemoryTracking=summary&quot;);
231         checkTestResult(tr);
232 
233         // should accept with no warnings
234         tr = doExec(javaCmd, &quot;-cp&quot;, jarFile.getName(),
235                     &quot;-XX:NativeMemoryTracking=summary&quot;, &quot;Foo&quot;);
236         ensureNoWarnings(tr);
237 
238         // should accept with no warnings
239         tr = doExec(javaCmd, &quot;-classpath&quot;, jarFile.getName(),
240                     &quot;-XX:NativeMemoryTracking=summary&quot;, &quot;Foo&quot;);
241         ensureNoWarnings(tr);
242 
243         // make sure a missing class is handled correctly, because the class
244         // resolution is performed by the JVM.
245         tr = doExec(javaCmd, &quot;AbsentClass&quot;, &quot;-XX:NativeMemoryTracking=summary&quot;);
246         if (!tr.contains(&quot;Error: Could not find or load main class AbsentClass&quot;)) {
247             throw new RuntimeException(&quot;Test Fails&quot;);
248         }
<span class="line-added">249 </span>
<span class="line-added">250         // Make sure we handle correctly the module long form (--module=)</span>
<span class="line-added">251         tr = doExec(javaCmd, &quot;-XX:NativeMemoryTracking=summary&quot;, &quot;--module=jdk.compiler/com.sun.tools.javac.Main&quot;, &quot;--help&quot;);</span>
<span class="line-added">252         ensureNoWarnings(tr);</span>
253     }
254 
255     void ensureNoWarnings(TestResult tr) {
256         checkTestResult(tr);
257         if (tr.contains(&quot;warning: Native Memory Tracking&quot;)) {
258             System.err.println(tr.toString());
259             throw new RuntimeException(&quot;Test Fails&quot;);
260         }
261     }
262 
263     void checkTestResult(TestResult tr) {
264         if (!tr.isOK()) {
265             System.err.println(tr.toString());
266             throw new RuntimeException(&quot;Test Fails&quot;);
267         }
268     }
269 }
</pre>
</td>
</tr>
</table>
<center><a href="TestHelper.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="TooSmallStackSize.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>