<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old test/jdk/tools/launcher/HelpFlagsTest.java</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2018, Oracle and/or its affiliates. All rights reserved.
  3  * Copyright (c) 2018 SAP SE. All rights reserved.
  4  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  5  *
  6  * This code is free software; you can redistribute it and/or modify it
  7  * under the terms of the GNU General Public License version 2 only, as
  8  * published by the Free Software Foundation.
  9  *
 10  * This code is distributed in the hope that it will be useful, but WITHOUT
 11  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 12  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 13  * version 2 for more details (a copy is included in the LICENSE file that
 14  * accompanied this code).
 15  *
 16  * You should have received a copy of the GNU General Public License version
 17  * 2 along with this work; if not, write to the Free Software Foundation,
 18  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 19  *
 20  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 21  * or visit www.oracle.com if you need additional information or have any
 22  * questions.
 23  */
 24 
 25 /**
 26  * @test
 27  * @summary Validate and test -?, -h and --help flags. All tools in the jdk
 28  *          should take the same flags to display the help message. These
 29  *          flags should be documented in the printed help message. The
 30  *          tool should quit without error code after displaying the
 31  *          help message (if there  is no other problem with the command
 32  *          line).
 33  *          Also check that tools that used to accept -help still do
 34  *          so. Test that tools that never accepted -help don&#39;t do so
 35  *          in future. I.e., check that the tool returns with the same
 36  *          return code as called with an invalid flag, and does not
 37  *          print anything containing &#39;-help&#39; in that case.
 38  * @compile HelpFlagsTest.java
 39  * @run main HelpFlagsTest
 40  */
 41 
 42 import java.io.File;
 43 import java.io.FileFilter;
 44 import java.util.Map;
 45 import java.util.ArrayList;
 46 import java.util.HashMap;
 47 import java.util.List;
 48 import java.util.HashSet;
 49 import java.util.Set;
 50 
 51 
 52 public class HelpFlagsTest extends TestHelper {
 53 
 54     // Tools that should not be tested because a usage message is pointless.
 55     static final String[] TOOLS_NOT_TO_TEST = {
 56         &quot;appletviewer&quot;,     // deprecated, don&#39;t test
 57         &quot;jaccessinspector&quot;, // gui, don&#39;t test, win only
 58         &quot;jaccesswalker&quot;,    // gui, don&#39;t test, win only
 59         &quot;jconsole&quot;,         // gui, don&#39;t test
 60         &quot;servertool&quot;,       // none. Shell, don&#39;t test.
 61         &quot;javaw&quot;,            // don&#39;t test, win only
 62         // These shall have a help message that resembles that of
 63         // MIT&#39;s tools. Thus -?, -h and --help are supported, but not
 64         // mentioned in the help text.
 65         &quot;kinit&quot;,
 66         &quot;klist&quot;,
 67         &quot;ktab&quot;,
 68         // Oracle proprietary tools without help message.
 69         &quot;javacpl&quot;,
 70         &quot;jmc&quot;,
 71         &quot;jweblauncher&quot;,
 72         &quot;jcontrol&quot;,
 73         &quot;ssvagent&quot;
 74     };
 75 
 76     // Lists which tools support which flags.
 77     private static class ToolHelpSpec {
 78         String toolname;
 79 
 80         // How the flags supposed to be supported are handled.
 81         //
 82         // These flags are supported, i.e.,
 83         // * the tool accepts the flag
 84         // * the tool prints a help message if the flag is specified
 85         // * this help message lists the flag
 86         // * the tool exits with exit code &#39;0&#39;.
 87         boolean supportsQuestionMark;
 88         boolean supportsH;
 89         boolean supportsHelp;
 90 
 91         // One tool returns with exit code != &#39;0&#39;.
 92         int exitcodeOfHelp;
 93 
 94         // How legacy -help is handled.
 95         //
 96         // Tools that so far support -help should still do so, but
 97         // not print documentation about it. Tools that do not
 98         // support -help should not do so in future.
 99         //
100         // The tools accepts legacy -help. -help should not be
101         // documented in the usage message.
102         boolean supportsLegacyHelp;
103 
104         // Java itself documents -help. -help prints to stderr,
105         // while --help prints to stdout. Leave as is.
106         boolean documentsLegacyHelp;
107 
108         // The exit code of the tool if an invalid argument is passed to it.
109         // An exit code != 0 would be expected, but not all tools handle it
110         // that way.
111         int exitcodeOfWrongFlag;
112 
113         ToolHelpSpec(String n, int q, int h, int hp, int ex1, int l, int dl, int ex2) {
114             toolname = n;
115             supportsQuestionMark = ( q  == 1 ? true : false );
116             supportsH            = ( h  == 1 ? true : false );
117             supportsHelp         = ( hp == 1 ? true : false );
118             exitcodeOfHelp       = ex1;
119 
120             supportsLegacyHelp   = (  l == 1 ? true : false );
121             documentsLegacyHelp  = ( dl == 1 ? true : false );
122             exitcodeOfWrongFlag  = ex2;
123         }
124     }
125 
126     static ToolHelpSpec[] jdkTools = {
127         //               name          -?   -h --help exitcode   -help -help  exitcode
128         //                                            of help          docu   of wrong
129         //                                                             mented flag
130         new ToolHelpSpec(&quot;jabswitch&quot;,   0,   0,   0,   0,         0,    0,     0),     // /?, prints help message anyways, win only
131         new ToolHelpSpec(&quot;jaotc&quot;,       1,   1,   1,   0,         0,    0,     2),     // -?, -h, --help
132         new ToolHelpSpec(&quot;jar&quot;,         1,   1,   1,   0,         0,    0,     1),     // -?, -h, --help
133         new ToolHelpSpec(&quot;jarsigner&quot;,   1,   1,   1,   0,         1,    0,     1),     // -?, -h, --help, -help accepted but not documented.
134         new ToolHelpSpec(&quot;java&quot;,        1,   1,   1,   0,         1,    1,     1),     // -?, -h, --help -help, Documents -help
135         new ToolHelpSpec(&quot;javac&quot;,       1,   0,   1,   0,         1,    1,     2),     // -?,     --help -help, Documents -help, -h is already taken for &quot;native header output directory&quot;.
136         new ToolHelpSpec(&quot;javadoc&quot;,     1,   1,   1,   0,         1,    1,     1),     // -?, -h, --help -help, Documents -help
137         new ToolHelpSpec(&quot;javap&quot;,       1,   1,   1,   0,         1,    1,     2),     // -?, -h, --help -help, Documents -help
138         new ToolHelpSpec(&quot;javaw&quot;,       1,   1,   1,   0,         1,    1,     1),     // -?, -h, --help -help, Documents -help, win only
139         new ToolHelpSpec(&quot;jcmd&quot;,        1,   1,   1,   0,         1,    0,     1),     // -?, -h, --help, -help accepted but not documented.
140         new ToolHelpSpec(&quot;jdb&quot;,         1,   1,   1,   0,         1,    1,     0),     // -?, -h, --help -help, Documents -help
141         new ToolHelpSpec(&quot;jdeprscan&quot;,   1,   1,   1,   0,         0,    0,     1),     // -?, -h, --help
142         new ToolHelpSpec(&quot;jdeps&quot;,       1,   1,   1,   0,         1,    0,     2),     // -?, -h, --help, -help accepted but not documented.
143         new ToolHelpSpec(&quot;jfr&quot;,         1,   1,   1,   0,         0,    0,     2),     // -?, -h, --help
144         new ToolHelpSpec(&quot;jhsdb&quot;,       0,   0,   0,   0,         0,    0,     0),     // none, prints help message anyways.
145         new ToolHelpSpec(&quot;jimage&quot;,      1,   1,   1,   0,         0,    0,     2),     // -?, -h, --help
146         new ToolHelpSpec(&quot;jinfo&quot;,       1,   1,   1,   0,         1,    1,     1),     // -?, -h, --help -help, Documents -help
147         new ToolHelpSpec(&quot;jjs&quot;,         0,   1,   1, 100,         0,    0,   100),     //     -h, --help, return code 100
148         new ToolHelpSpec(&quot;jlink&quot;,       1,   1,   1,   0,         0,    0,     2),     // -?, -h, --help
149         new ToolHelpSpec(&quot;jmap&quot;,        1,   1,   1,   0,         1,    0,     1),     // -?, -h, --help, -help accepted but not documented.
150         new ToolHelpSpec(&quot;jmod&quot;,        1,   1,   1,   0,         1,    0,     2),     // -?, -h, --help, -help accepted but not documented.
151         new ToolHelpSpec(&quot;jps&quot;,         1,   1,   1,   0,         1,    1,     1),     // -?, -h, --help -help, Documents -help
152         new ToolHelpSpec(&quot;jrunscript&quot;,  1,   1,   1,   0,         1,    1,     7),     // -?, -h, --help -help, Documents -help
153         new ToolHelpSpec(&quot;jshell&quot;,      1,   1,   1,   0,         1,    0,     1),     // -?, -h, --help, -help accepted but not documented.
154         new ToolHelpSpec(&quot;jstack&quot;,      1,   1,   1,   0,         1,    1,     1),     // -?, -h, --help -help, Documents -help
155         new ToolHelpSpec(&quot;jstat&quot;,       1,   1,   1,   0,         1,    1,     1),     // -?, -h, --help -help, Documents -help
156         new ToolHelpSpec(&quot;jstatd&quot;,      1,   1,   1,   0,         0,    0,     1),     // -?, -h, --help
157         new ToolHelpSpec(&quot;keytool&quot;,     1,   1,   1,   0,         1,    0,     1),     // none, prints help message anyways.
158         new ToolHelpSpec(&quot;pack200&quot;,     1,   1,   1,   0,         1,    0,     2),     // -?, -h, --help, -help accepted but not documented.
159         new ToolHelpSpec(&quot;rmic&quot;,        0,   0,   0,   0,         0,    0,     1),     // none, pirnts help message anyways.
160         new ToolHelpSpec(&quot;rmid&quot;,        0,   0,   0,   0,         0,    0,     1),     // none, prints help message anyways.
161         new ToolHelpSpec(&quot;rmiregistry&quot;, 0,   0,   0,   0,         0,    0,     1),     // none, prints help message anyways.
162         new ToolHelpSpec(&quot;serialver&quot;,   0,   0,   0,   0,         0,    0,     1),     // none, prints help message anyways.
163         new ToolHelpSpec(&quot;unpack200&quot;,   1,   1,   1,   0,         1,    0,     2),     // -?, -h, --help, -help accepted but not documented.
164         // Oracle proprietary tools:
165         new ToolHelpSpec(&quot;javapackager&quot;,0,   0,   0,   0,         1,    0,   255),     // -help accepted but not documented.
166     };
167 
168     // Returns true if the file is not a tool.
169     static boolean notATool(String file) {
170         if (isWindows &amp;&amp; !file.endsWith(EXE_FILE_EXT))
171             return true;
172         return false;
173     }
174 
175     // Returns true if tool is listed in TOOLS_NOT_TO_TEST.
176     static boolean dontTestTool(String tool) {
177         tool = tool.toLowerCase();
178         for (String x : TOOLS_NOT_TO_TEST) {
179             if (tool.toLowerCase().startsWith(x))
180                 return true;
181         }
182         return false;
183     }
184 
185     // Returns corresponding object from jdkTools array.
186     static ToolHelpSpec getToolHelpSpec(String tool) {
187         for (ToolHelpSpec x : jdkTools) {
188             if (tool.toLowerCase().equals(x.toolname) ||
189                 tool.toLowerCase().equals(x.toolname + &quot;.exe&quot;))
190                 return x;
191         }
192         return null;
193     }
194 
195     // Check whether &#39;flag&#39; appears in &#39;line&#39; as a word of itself. It must not
196     // be a substring of a word, as then similar flags might be matched.
197     // E.g.: --help matches in the documentation of --help-extra.
198     // This works only with english locale, as some tools have translated
199     // usage messages.
200     static boolean findFlagInLine(String line, String flag) {
201         if (line.contains(flag) &amp;&amp;
202             !line.contains(&quot;nknown&quot;) &amp;&amp;                       // Some tools say &#39;Unknown option &quot;&lt;flag&gt;&quot;&#39;,
203             !line.contains(&quot;invalid flag&quot;) &amp;&amp;                 // &#39;invalid flag: &lt;flag&gt;&#39;
204             !line.contains(&quot;invalid option&quot;) &amp;&amp;               // or &#39;invalid option: &lt;flag&gt;&#39;. Skip that.
205             !line.contains(&quot;FileNotFoundException: -help&quot;) &amp;&amp; // Special case for idlj.
206             !line.contains(&quot;-h requires an argument&quot;) &amp;&amp;      // Special case for javac.
207             !line.contains(&quot;port argument,&quot;)) {               // Special case for rmiregistry.
208             // There might be several appearances of &#39;flag&#39; in
209             // &#39;line&#39;. (-h as substring of --help).
210             int flagLen = flag.length();
211             int lineLen = line.length();
212             for (int i = line.indexOf(flag); i &gt;= 0; i = line.indexOf(flag, i+1)) {
213                 // There should be a space before &#39;flag&#39; in &#39;line&#39;, or it&#39;s right at the beginning.
214                 if (i &gt; 0 &amp;&amp;
215                     line.charAt(i-1) != &#39; &#39; &amp;&amp;
216                     line.charAt(i-1) != &#39;[&#39; &amp;&amp;  // jarsigner
217                     line.charAt(i-1) != &#39;|&#39; &amp;&amp;  // jstatd
218                     line.charAt(i-1) != &#39;\t&#39;) { // jjs
219                     continue;
220                 }
221                 // There should be a space or comma after &#39;flag&#39; in &#39;line&#39;, or it&#39;s just at the end.
222                 int posAfter = i + flagLen;
223                 if (posAfter &lt; lineLen &amp;&amp;
224                     line.charAt(posAfter) != &#39; &#39; &amp;&amp;
225                     line.charAt(posAfter) != &#39;,&#39; &amp;&amp;
226                     line.charAt(posAfter) != &#39;[&#39; &amp;&amp; // jar
227                     line.charAt(posAfter) != &#39;]&#39; &amp;&amp; // jarsigner
228                     line.charAt(posAfter) != &#39;)&#39; &amp;&amp; // jfr
229                     line.charAt(posAfter) != &#39;|&#39; &amp;&amp; // jstatd
230                     line.charAt(posAfter) != &#39;:&#39; &amp;&amp; // jps
231                     line.charAt(posAfter) != &#39;&quot;&#39;) { // keytool
232                     continue;
233                 }
234                 return true;
235             }
236         }
237         return false;
238     }
239 
240     static TestResult runToolWithFlag(File f, String flag) {
241         String x = f.getAbsolutePath();
242         TestResult tr = doExec(x, flag);
243         System.out.println(&quot;Testing &quot; + f.getName());
244         System.out.println(&quot;#&gt; &quot; + x + &quot; &quot; + flag);
245         tr.testOutput.forEach(System.out::println);
246         System.out.println(&quot;#&gt; echo $?&quot;);
247         System.out.println(tr.exitValue);
248 
249         return tr;
250     }
251 
252     // Checks whether tool supports flag &#39;flag&#39; and documents it
253     // in the help message.
254     static String testTool(File f, String flag, int exitcode) {
255         String result = &quot;&quot;;
256         TestResult tr = runToolWithFlag(f, flag);
257 
258         // Check that the tool accepted the flag.
259         if (exitcode == 0 &amp;&amp; !tr.isOK()) {
260             System.out.println(&quot;failed&quot;);
261             result = &quot;failed: &quot; + f.getName() + &quot; &quot; + flag + &quot; has exit code &quot; + tr.exitValue + &quot;.\n&quot;;
262         }
263 
264         // Check there is a help message listing the flag.
265         boolean foundFlag = false;
266         for (String y : tr.testOutput) {
267             if (!foundFlag &amp;&amp; findFlagInLine(y, flag)) { // javac
268                 foundFlag = true;
269                 System.out.println(&quot;Found documentation of &#39;&quot; + flag + &quot;&#39;: &#39;&quot; + y.trim() +&quot;&#39;&quot;);
270             }
271         }
272         if (!foundFlag) {
273             result += &quot;failed: &quot; + f.getName() + &quot; does not document &quot; +
274                 flag + &quot; in help message.\n&quot;;
275         }
276 
277         if (!result.isEmpty())
278             System.out.println(result);
279 
280         return result;
281     }
282 
283     // Test the tool supports legacy option -help, but does
284     // not document it.
285     static String testLegacyFlag(File f, int exitcode) {
286         String result = &quot;&quot;;
287         TestResult tr = runToolWithFlag(f, &quot;-help&quot;);
288 
289         // Check that the tool accepted the flag.
290         if (exitcode == 0 &amp;&amp; !tr.isOK()) {
291             System.out.println(&quot;failed&quot;);
292             result = &quot;failed: &quot; + f.getName() + &quot; -help has exit code &quot; + tr.exitValue + &quot;.\n&quot;;
293         }
294 
295         // Check there is _no_ documentation of -help.
296         boolean foundFlag = false;
297         for (String y : tr.testOutput) {
298             if (!foundFlag &amp;&amp; findFlagInLine(y, &quot;-help&quot;)) {  // javac
299                 foundFlag = true;
300                 System.out.println(&quot;Found documentation of &#39;-help&#39;: &#39;&quot; + y.trim() +&quot;&#39;&quot;);
301             }
302         }
303         if (foundFlag) {
304             result += &quot;failed: &quot; + f.getName() + &quot; does document -help &quot; +
305                 &quot;in help message. This legacy flag should not be documented.\n&quot;;
306         }
307 
308         if (!result.isEmpty())
309             System.out.println(result);
310 
311         return result;
312     }
313 
314     // Test that the tool exits with the exit code expected for
315     // invalid flags. In general, one would expect this to be != 0,
316     // but currently a row of tools exit with 0 in this case.
317     // The output should not ask to get help with flag &#39;-help&#39;.
318     static String testInvalidFlag(File f, String flag, int exitcode, boolean documentsLegacyHelp) {
319         String result = &quot;&quot;;
320         TestResult tr = runToolWithFlag(f, flag);
321 
322         // Check that the tool did exit with the expected return code.
323         if (!((exitcode == tr.exitValue) ||
324               // Windows reports -1 where unix reports 255.
325               (tr.exitValue &lt; 0 &amp;&amp; exitcode == tr.exitValue + 256))) {
326             System.out.println(&quot;failed&quot;);
327             result = &quot;failed: &quot; + f.getName() + &quot; &quot; + flag + &quot; should not be &quot; +
328                      &quot;accepted. But it has exit code &quot; + tr.exitValue + &quot;.\n&quot;;
329         }
330 
331         if (!documentsLegacyHelp) {
332             // Check there is _no_ documentation of -help.
333             boolean foundFlag = false;
334             for (String y : tr.testOutput) {
335                 if (!foundFlag &amp;&amp; findFlagInLine(y, &quot;-help&quot;)) {  // javac
336                     foundFlag = true;
337                     System.out.println(&quot;Found documentation of &#39;-help&#39;: &#39;&quot; + y.trim() +&quot;&#39;&quot;);
338                 }
339             }
340             if (foundFlag) {
341                 result += &quot;failed: &quot; + f.getName() + &quot; does document -help &quot; +
342                     &quot;in error message. This legacy flag should not be documented.\n&quot;;
343             }
344         }
345 
346         if (!result.isEmpty())
347             System.out.println(result);
348 
349         return result;
350     }
351 
352     public static void main(String[] args) {
353         String errorMessage = &quot;&quot;;
354 
355         // The test analyses the help messages printed. It assumes englisch
356         // help messages. Thus it only works with english locale.
357         if (!isEnglishLocale()) { return; }
358 
359         for (File f : new File(JAVA_BIN).listFiles()) {
360             String toolName = f.getName();
361 
362             if (notATool(toolName)) {
363                 continue;
364             }
365             if (dontTestTool(toolName)) {
366                 System.out.println(&quot;Skipping test of tool &quot; + toolName +
367                                    &quot;. Tool has no help message.&quot;);
368                 continue;
369             }
370 
371             ToolHelpSpec tool = getToolHelpSpec(toolName);
372             if (tool == null) {
373                 errorMessage += &quot;Tool &quot; + toolName + &quot; not covered by this test. &quot; +
374                     &quot;Add specification to jdkTools array!\n&quot;;
375                 continue;
376             }
377 
378             // Test for help flags to be supported.
379             if (tool.supportsQuestionMark == true) {
380                 errorMessage += testTool(f, &quot;-?&quot;, tool.exitcodeOfHelp);
381             } else {
382                 System.out.println(&quot;Skip &quot; + tool.toolname + &quot;. It does not support -?.&quot;);
383             }
384             if (tool.supportsH == true) {
385                 errorMessage += testTool(f, &quot;-h&quot;, tool.exitcodeOfHelp);
386             } else {
387                 System.out.println(&quot;Skip &quot; + tool.toolname + &quot;. It does not support -h.&quot;);
388             }
389             if (tool.supportsHelp == true) {
390                 errorMessage += testTool(f, &quot;--help&quot;, tool.exitcodeOfHelp);
391             } else {
392                 System.out.println(&quot;Skip &quot; + tool.toolname + &quot;. It does not support --help.&quot;);
393             }
394 
395             // Check that the return code listing in jdkTools[] is
396             // correct for an invalid flag.
397             errorMessage += testInvalidFlag(f, &quot;-asdfxgr&quot;, tool.exitcodeOfWrongFlag, tool.documentsLegacyHelp);
398 
399             // Test for legacy -help flag.
400             if (!tool.documentsLegacyHelp) {
401                 if (tool.supportsLegacyHelp == true) {
402                     errorMessage += testLegacyFlag(f, tool.exitcodeOfHelp);
403                 } else {
404                     errorMessage += testInvalidFlag(f, &quot;-help&quot;, tool.exitcodeOfWrongFlag, false);
405                 }
406             }
407         }
408 
409         if (errorMessage.isEmpty()) {
410             System.out.println(&quot;All help string tests: PASS&quot;);
411         } else {
412             throw new AssertionError(&quot;HelpFlagsTest failed:\n&quot; + errorMessage);
413         }
414     }
415 }
    </pre>
  </body>
</html>