<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/jdk/tools/launcher/ArgsFileTest.java</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 2015, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /**
 25  * @test
<a name="1" id="anc1"></a><span class="line-modified"> 26  * @bug 8027634 8231863</span>
 27  * @summary Argument parsing from file
 28  * @modules jdk.compiler
 29  *          jdk.zipfs
 30  * @build TestHelper
 31  * @run main ArgsFileTest
 32  */
 33 import java.io.File;
 34 import java.io.IOException;
 35 import java.util.ArrayList;
 36 import java.util.Arrays;
 37 import java.util.Collections;
 38 import java.util.HashMap;
 39 import java.util.List;
 40 import java.util.Map;
 41 import java.util.regex.Matcher;
 42 import java.util.regex.Pattern;
 43 
 44 public class ArgsFileTest extends TestHelper {
 45     private static File testJar = null;
 46     private static Map&lt;String, String&gt; env = new HashMap&lt;&gt;();
 47 
 48     static void init() throws IOException {
 49         if  (testJar != null) {
 50             return;
 51         }
 52         testJar = new File(&quot;test.jar&quot;);
 53         StringBuilder tsrc = new StringBuilder();
 54         tsrc.append(&quot;public static void main(String... args) {\n&quot;);
 55         tsrc.append(&quot;   for (String x : args) {\n&quot;);
 56         tsrc.append(&quot;        System.out.println(x);\n&quot;);
 57         tsrc.append(&quot;   }\n&quot;);
 58         tsrc.append(&quot;}\n&quot;);
 59         createJar(testJar, new File(&quot;Foo&quot;), tsrc.toString());
 60 
 61         env.put(JLDEBUG_KEY, &quot;true&quot;);
 62     }
 63 
<a name="2" id="anc2"></a><span class="line-modified"> 64     private File createArgFile(String fname, List&lt;String&gt; lines, boolean endWithNewline) throws IOException {</span>
 65         File argFile = new File(fname);
 66         argFile.delete();
<a name="3" id="anc3"></a><span class="line-modified"> 67         createAFile(argFile, lines, endWithNewline);</span>
 68         return argFile;
 69     }
 70 
<a name="4" id="anc4"></a><span class="line-added"> 71     private File createArgFile(String fname, List&lt;String&gt; lines) throws IOException {</span>
<span class="line-added"> 72         return createArgFile(fname, lines, true);</span>
<span class="line-added"> 73     }</span>
<span class="line-added"> 74 </span>
 75     private void verifyOptions(List&lt;String&gt; args, TestResult tr) {
 76         if (args.isEmpty()) {
 77             return;
 78         }
 79 
 80         int i = 1;
 81         for (String x : args) {
 82             tr.matches(&quot;.*argv\\[&quot; + i + &quot;\\] = &quot; + Pattern.quote(x) + &quot;.*&quot;);
 83             i++;
 84         }
 85         if (! tr.testStatus) {
 86             System.out.println(tr);
 87             throw new RuntimeException(&quot;test fails&quot;);
 88         }
 89     }
 90 
 91     private void verifyUserArgs(List&lt;String&gt; args, TestResult tr, int index) {
 92         if (javaCmd != TestHelper.javaCmd) {
 93             tr.contains(&quot;\tFirst application arg index: 1&quot;);
 94         } else {
 95             tr.contains(&quot;\tFirst application arg index: &quot; + index);
 96 
 97             for (String arg: args) {
 98                 tr.matches(&quot;^&quot; + Pattern.quote(arg) + &quot;$&quot;);
 99             }
100         }
101 
102         if (! tr.testStatus) {
103             System.out.println(tr);
104             throw new RuntimeException(&quot;test fails&quot;);
105         }
106     }
107 
108     @Test
109     public void expandAll() throws IOException {
110         List&lt;String&gt; lines = new ArrayList&lt;&gt;();
111         lines.add(&quot;-Xmx32m&quot;);
112         lines.add(&quot;-Xint&quot;);
113         File argFile1 = createArgFile(&quot;argFile1&quot;, lines);
114         lines = new ArrayList&lt;&gt;();
115         lines.add(&quot;-jar&quot;);
116         lines.add(&quot;test.jar&quot;);
117         lines.add(&quot;uarg1 @uarg2 @@uarg3 -uarg4 uarg5&quot;);
118         File argFile2 = createArgFile(&quot;argFile2&quot;, lines);
119 
120         TestResult tr = doExec(env, javaCmd, &quot;@argFile1&quot;, &quot;@argFile2&quot;);
121 
122         List&lt;String&gt; appArgs = new ArrayList&lt;&gt;();
123         appArgs.add(&quot;uarg1&quot;);
124         appArgs.add(&quot;@uarg2&quot;);
125         appArgs.add(&quot;@@uarg3&quot;);
126         appArgs.add(&quot;-uarg4&quot;);
127         appArgs.add(&quot;uarg5&quot;);
128 
129         List&lt;String&gt; options = new ArrayList&lt;&gt;();
130         options.add(&quot;-Xmx32m&quot;);
131         options.add(&quot;-Xint&quot;);
132         options.add(&quot;-jar&quot;);
133         options.add(&quot;test.jar&quot;);
134         options.addAll(appArgs);
135 
136         verifyOptions(options, tr);
137         verifyUserArgs(appArgs, tr, 5);
138         argFile1.delete();
139         argFile2.delete();
140 
141         File cpFile = createArgFile(&quot;cpFile&quot;, Arrays.asList(&quot;-cp&quot;, &quot;test.jar&quot;));
142         List&lt;String&gt; appCmd = new ArrayList&lt;&gt;();
143         appCmd.add(&quot;Foo&quot;);
144         appCmd.addAll(appArgs);
145         File appFile = createArgFile(&quot;appFile&quot;, appCmd);
146 
147         tr = doExec(env, javaCmd, &quot;@cpFile&quot;, &quot;@appFile&quot;);
148         verifyOptions(Arrays.asList(&quot;-cp&quot;, &quot;test.jar&quot;, &quot;Foo&quot;,
149                 &quot;uarg1&quot;, &quot;@uarg2&quot;, &quot;@@uarg3&quot;, &quot;-uarg4&quot;, &quot;uarg5&quot;), tr);
150         verifyUserArgs(appArgs, tr, 4);
151         cpFile.delete();
152         appFile.delete();
153     }
154 
155     @Test
156     public void escapeArg() throws IOException {
157         List&lt;String&gt; lines = new ArrayList&lt;&gt;();
158         lines.add(&quot;-Xmx32m&quot;);
159         lines.add(&quot;-Xint&quot;);
160         File argFile1 = createArgFile(&quot;argFile1&quot;, lines);
161 
162         TestResult tr = doExec(env, javaCmd, &quot;-cp&quot;, &quot;@@arg&quot;, &quot;-cp&quot;, &quot;@&quot;,
163                 &quot;-cp&quot;, &quot;@@@cp&quot;, &quot;@argFile1&quot;, &quot;@@@@Main@@@@&quot;, &quot;-version&quot;);
164         List&lt;String&gt; options = new ArrayList&lt;&gt;();
165         options.add(&quot;-cp&quot;);
166         options.add(&quot;@arg&quot;);
167         options.add(&quot;-cp&quot;);
168         options.add(&quot;@&quot;);
169         options.add(&quot;-cp&quot;);
170         options.add(&quot;@@cp&quot;);
171         options.add(&quot;-Xmx32m&quot;);
172         options.add(&quot;-Xint&quot;);
173         options.add(&quot;@@@Main@@@@&quot;);
174         options.add(&quot;-version&quot;);
175         verifyOptions(options, tr);
176         verifyUserArgs(Collections.emptyList(), tr, options.size());
177         argFile1.delete();
178     }
179 
180     @Test
181     public void killSwitch() throws IOException {
182         List&lt;String&gt; lines = new ArrayList&lt;&gt;();
183         lines.add(&quot;-Xmx32m&quot;);
184         lines.add(&quot;-Xint&quot;);
185         File argFile1 = createArgFile(&quot;argFile1&quot;, lines);
186         lines = new ArrayList&lt;&gt;();
187         lines.add(&quot;-jar&quot;);
188         lines.add(&quot;test.jar&quot;);
189         lines.add(&quot;uarg1 @uarg2 @@uarg3 -uarg4 uarg5&quot;);
190         File argFile2 = createArgFile(&quot;argFile2&quot;, lines);
191         File argKill = createArgFile(&quot;argKill&quot;,
192             Collections.singletonList(&quot;--disable-@files&quot;));
193 
194         TestResult tr = doExec(env, javaCmd, &quot;@argFile1&quot;, &quot;--disable-@files&quot;, &quot;@argFile2&quot;);
195         List&lt;String&gt; options = new ArrayList&lt;&gt;();
196         options.add(&quot;-Xmx32m&quot;);
197         options.add(&quot;-Xint&quot;);
198         options.add(&quot;--disable-@files&quot;);
199         options.add(&quot;@argFile2&quot;);
200         verifyOptions(options, tr);
201         // Main class is @argFile2
202         verifyUserArgs(Collections.emptyList(), tr, 5);
203 
204         // Specify in file is same as specify inline
205         tr = doExec(env, javaCmd, &quot;@argFile1&quot;, &quot;@argKill&quot;, &quot;@argFile2&quot;);
206         verifyOptions(options, tr);
207         // Main class is @argFile2
208         verifyUserArgs(Collections.emptyList(), tr, 5);
209 
210         // multiple is fine, once on is on.
211         tr = doExec(env, javaCmd, &quot;@argKill&quot;, &quot;@argFile1&quot;, &quot;--disable-@files&quot;, &quot;@argFile2&quot;);
212         options = Arrays.asList(&quot;--disable-@files&quot;, &quot;@argFile1&quot;,
213                 &quot;--disable-@files&quot;, &quot;@argFile2&quot;);
214         verifyOptions(options, tr);
215         verifyUserArgs(Collections.emptyList(), tr, 3);
216 
217         // after main class, becoming an user application argument
218         tr = doExec(env, javaCmd, &quot;@argFile2&quot;, &quot;@argKill&quot;);
219         options = Arrays.asList(&quot;-jar&quot;, &quot;test.jar&quot;, &quot;uarg1&quot;, &quot;@uarg2&quot;, &quot;@@uarg3&quot;,
220                 &quot;-uarg4&quot;, &quot;uarg5&quot;, &quot;@argKill&quot;);
221         verifyOptions(options, tr);
222         verifyUserArgs(Arrays.asList(&quot;uarg1&quot;, &quot;@uarg2&quot;, &quot;@@uarg3&quot;,
223                 &quot;-uarg4&quot;, &quot;uarg5&quot;, &quot;@argKill&quot;), tr, 3);
224 
225         argFile1.delete();
226         argFile2.delete();
227         argKill.delete();
228     }
229 
230     @Test
231     public void userApplication() throws IOException {
232         List&lt;String&gt; lines = new ArrayList&lt;&gt;();
233         lines.add(&quot;-Xmx32m&quot;);
234         lines.add(&quot;-Xint&quot;);
235         File vmArgs = createArgFile(&quot;vmArgs&quot;, lines);
236         File jarOpt = createArgFile(&quot;jarOpt&quot;, Arrays.asList(&quot;-jar&quot;));
237         File cpOpt = createArgFile(&quot;cpOpt&quot;, Arrays.asList(&quot;-cp&quot;));
238         File jarArg = createArgFile(&quot;jarArg&quot;, Arrays.asList(&quot;test.jar&quot;));
239         File userArgs = createArgFile(&quot;userArgs&quot;, Arrays.asList(&quot;-opt&quot;, &quot;arg&quot;, &quot;--longopt&quot;));
240 
241         TestResult tr = doExec(env, javaCmd,
242                 &quot;@vmArgs&quot;, &quot;@jarOpt&quot;, &quot;test.jar&quot;, &quot;-opt&quot;, &quot;arg&quot;, &quot;--longopt&quot;);
243         verifyOptions(Arrays.asList(
244                 &quot;-Xmx32m&quot;, &quot;-Xint&quot;, &quot;-jar&quot;, &quot;test.jar&quot;, &quot;-opt&quot;, &quot;arg&quot;, &quot;--longopt&quot;), tr);
245         verifyUserArgs(Arrays.asList(&quot;-opt&quot;, &quot;arg&quot;, &quot;--longopt&quot;), tr, 5);
246 
247         tr = doExec(env, javaCmd, &quot;@jarOpt&quot;, &quot;@jarArg&quot;, &quot;@vmArgs&quot;);
248         verifyOptions(Arrays.asList(&quot;-jar&quot;, &quot;test.jar&quot;, &quot;@vmArgs&quot;), tr);
249         verifyUserArgs(Arrays.asList(&quot;@vmArgs&quot;), tr, 3);
250 
251         tr = doExec(env, javaCmd, &quot;-cp&quot;, &quot;@jarArg&quot;, &quot;@vmArgs&quot;, &quot;Foo&quot;, &quot;@userArgs&quot;);
252         verifyOptions(Arrays.asList(&quot;-cp&quot;, &quot;test.jar&quot;, &quot;-Xmx32m&quot;, &quot;-Xint&quot;,
253                 &quot;Foo&quot;, &quot;@userArgs&quot;), tr);
254         verifyUserArgs(Arrays.asList(&quot;@userArgs&quot;), tr, 6);
255 
256         tr = doExec(env, javaCmd, &quot;@cpOpt&quot;, &quot;@jarArg&quot;, &quot;@vmArgs&quot;, &quot;Foo&quot;, &quot;@userArgs&quot;);
257         verifyOptions(Arrays.asList(&quot;-cp&quot;, &quot;test.jar&quot;, &quot;-Xmx32m&quot;, &quot;-Xint&quot;,
258                 &quot;Foo&quot;, &quot;@userArgs&quot;), tr);
259         verifyUserArgs(Arrays.asList(&quot;@userArgs&quot;), tr, 6);
260 
261         tr = doExec(env, javaCmd, &quot;@cpOpt&quot;, &quot;test.jar&quot;, &quot;@vmArgs&quot;, &quot;Foo&quot;, &quot;@userArgs&quot;);
262         verifyOptions(Arrays.asList(&quot;-cp&quot;, &quot;test.jar&quot;, &quot;-Xmx32m&quot;, &quot;-Xint&quot;,
263                 &quot;Foo&quot;, &quot;@userArgs&quot;), tr);
264         verifyUserArgs(Arrays.asList(&quot;@userArgs&quot;), tr, 6);
265 
266         vmArgs.delete();
267         jarOpt.delete();
268         cpOpt.delete();
269         jarArg.delete();
270         userArgs.delete();
271     }
272 
<a name="5" id="anc5"></a><span class="line-added">273     @Test</span>
<span class="line-added">274     public void userApplicationWithoutEmptyLastLine() throws IOException {</span>
<span class="line-added">275         File cpOpt = createArgFile(&quot;cpOpt&quot;, Arrays.asList(&quot;-classpath .&quot;), false);</span>
<span class="line-added">276         File vmArgs = createArgFile(&quot;vmArgs&quot;, Arrays.asList(&quot;-Xint&quot;), false);</span>
<span class="line-added">277 </span>
<span class="line-added">278         TestResult tr = doExec(env, javaCmd, &quot;-cp&quot;, &quot;test.jar&quot;, &quot;@cpOpt&quot;, &quot;Foo&quot;, &quot;-test&quot;);</span>
<span class="line-added">279         verifyOptions(Arrays.asList(&quot;-cp&quot;, &quot;test.jar&quot;, &quot;-classpath&quot;, &quot;.&quot;, &quot;Foo&quot;, &quot;-test&quot;), tr);</span>
<span class="line-added">280         verifyUserArgs(Arrays.asList(&quot;-test&quot;), tr, 6);</span>
<span class="line-added">281 </span>
<span class="line-added">282         tr = doExec(env, javaCmd,  &quot;-cp&quot;, &quot;test.jar&quot;, &quot;@vmArgs&quot;, &quot;Foo&quot;, &quot;-test&quot;);</span>
<span class="line-added">283         verifyOptions(Arrays.asList(&quot;-cp&quot;, &quot;test.jar&quot;, &quot;-Xint&quot;, &quot;Foo&quot;, &quot;-test&quot;), tr);</span>
<span class="line-added">284         verifyUserArgs(Arrays.asList(&quot;-test&quot;), tr, 5);</span>
<span class="line-added">285 </span>
<span class="line-added">286         cpOpt.delete();</span>
<span class="line-added">287         vmArgs.delete();</span>
<span class="line-added">288     }</span>
<span class="line-added">289 </span>
290     // test with missing file
291     @Test
292     public void missingFileNegativeTest() throws IOException {
293         TestResult tr = doExec(javaCmd, &quot;@&quot; + &quot;missing.cmd&quot;);
294         tr.checkNegative();
295         tr.contains(&quot;Error: could not open `missing.cmd&#39;&quot;);
296         if (!tr.testStatus) {
297             System.out.println(tr);
298             throw new RuntimeException(&quot;test fails&quot;);
299         }
300     }
301 
302     public static void main(String... args) throws Exception {
303         init();
304         ArgsFileTest a = new ArgsFileTest();
305         a.run(args);
306         if (testExitValue &gt; 0) {
307             System.out.println(&quot;Total of &quot; + testExitValue + &quot; failed&quot;);
308             System.exit(1);
309         } else {
310             System.out.println(&quot;All tests pass&quot;);
311         }
312     }
313 }
<a name="6" id="anc6"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="6" type="hidden" />
</body>
</html>