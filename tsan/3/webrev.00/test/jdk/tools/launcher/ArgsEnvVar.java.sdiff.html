<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/tools/launcher/ArgsEnvVar.java</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="../jpackage/resources/icon4.ico.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="ArgsFileTest.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/tools/launcher/ArgsEnvVar.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /**
 25  * @test
 26  * @bug 8170832 8180447
 27  * @summary Arguments passed in environment variable
 28  * @modules jdk.compiler
 29  *          jdk.zipfs
 30  * @build TestHelper
 31  * @run main ArgsEnvVar
 32  */
 33 import java.io.File;
 34 import java.io.IOException;
 35 import java.util.ArrayList;
 36 import java.util.HashMap;
 37 import java.util.List;
 38 import java.util.Map;
 39 import java.util.regex.Pattern;


 40 
 41 public class ArgsEnvVar extends TestHelper {
 42     private static File testJar = null;
 43     private static Map&lt;String, String&gt; env = new HashMap&lt;&gt;();
 44 
 45     private static String JDK_JAVA_OPTIONS = &quot;JDK_JAVA_OPTIONS&quot;;
 46 
 47     static void init() throws IOException {
 48         if  (testJar != null) {
 49             return;
 50         }
 51         testJar = new File(&quot;test.jar&quot;);
 52         StringBuilder tsrc = new StringBuilder();
 53         tsrc.append(&quot;public static void main(String... args) {\n&quot;);
 54         tsrc.append(&quot;   for (String x : args) {\n&quot;);
 55         tsrc.append(&quot;        System.out.println(x);\n&quot;);
 56         tsrc.append(&quot;   }\n&quot;);
 57         tsrc.append(&quot;}\n&quot;);
 58         createJar(testJar, new File(&quot;Foo&quot;), tsrc.toString());
 59 
</pre>
<hr />
<pre>
136 
137     private TestResult testInEnv(List&lt;String&gt; options) {
138         env.put(JDK_JAVA_OPTIONS, String.join(&quot; &quot;, options));
139         return doExec(env, javaCmd, &quot;-jar&quot;, &quot;test.jar&quot;);
140     }
141 
142     private TestResult testInEnvAsArgFile(List&lt;String&gt; options) throws IOException {
143         File argFile = createArgFile(&quot;argFile&quot;, options);
144         env.put(JDK_JAVA_OPTIONS, &quot;@argFile&quot;);
145         TestResult tr = doExec(env, javaCmd, &quot;-jar&quot;, &quot;test.jar&quot;);
146         argFile.delete();
147         return tr;
148     }
149 
150     @Test
151     public void noTerminalOpt() throws IOException {
152         List&lt;List&lt;String&gt;&gt; terminal_opts = List.of(
153                 List.of(&quot;-jar&quot;, &quot;test.jar&quot;),
154                 List.of(&quot;-m&quot;, &quot;test/Foo&quot;),
155                 List.of(&quot;--module&quot;, &quot;test/Foo&quot;),

156                 List.of(&quot;--dry-run&quot;),
157                 List.of(&quot;-h&quot;),
158                 List.of(&quot;-?&quot;),
159                 List.of(&quot;-help&quot;),
160                 List.of(&quot;--help&quot;),
161                 List.of(&quot;-X&quot;),
162                 List.of(&quot;--help-extra&quot;),
163                 List.of(&quot;-version&quot;),
164                 List.of(&quot;--version&quot;),
165                 List.of(&quot;-fullversion&quot;),
166                 List.of(&quot;--full-version&quot;));
167 
168         for (List&lt;String&gt; options: terminal_opts) {
169             // terminal opt in environment variable
170             TestResult tr = testInEnv(options);
171             tr.checkNegative();
172             if (!tr.testStatus) {
173                 System.out.println(tr);
174                 throw new RuntimeException(&quot;test fails&quot;);
175             }
</pre>
<hr />
<pre>
224         env.put(JDK_JAVA_OPTIONS, &quot;-p ?&quot;);
225         tr = doExec(env, javaCmd, &quot;-jar&quot;, &quot;test.jar&quot;, &quot;one&quot;, &quot;two&quot;);
226         verifyOptions(List.of(&quot;-p&quot;, &quot;?&quot;, &quot;-jar&quot;, &quot;test.jar&quot;, &quot;one&quot;, &quot;two&quot;), tr);
227     }
228 
229     @Test
230     public void testTrailingSpaces() {
231         env.put(JDK_JAVA_OPTIONS, &quot;--add-exports java.base/jdk.internal.misc=ALL-UNNAMED &quot;);
232         TestResult tr = doExec(env, javaCmd, &quot;-jar&quot;, &quot;test.jar&quot;);
233         verifyOptions(List.of(&quot;--add-exports&quot;, &quot;java.base/jdk.internal.misc=ALL-UNNAMED&quot;, &quot;-jar&quot;, &quot;test.jar&quot;), tr);
234 
235         env.put(JDK_JAVA_OPTIONS, &quot;--class-path &#39; &#39;&quot;);
236         tr = doExec(env, javaCmd, &quot;-jar&quot;, &quot;test.jar&quot;);
237         verifyOptions(List.of(&quot;--class-path&quot;, &quot; &quot;, &quot;-jar&quot;, &quot;test.jar&quot;), tr);
238 
239         env.put(JDK_JAVA_OPTIONS, &quot;  --add-exports java.base/jdk.internal.misc=ALL-UNNAMED &quot;);
240         tr = doExec(env, javaCmd, &quot;-jar&quot;, &quot;test.jar&quot;);
241         verifyOptions(List.of(&quot;--add-exports&quot;, &quot;java.base/jdk.internal.misc=ALL-UNNAMED&quot;, &quot;-jar&quot;, &quot;test.jar&quot;), tr);
242     }
243 































































244     public static void main(String... args) throws Exception {
245         init();
246         ArgsEnvVar a = new ArgsEnvVar();
247         a.run(args);
248         if (testExitValue &gt; 0) {
249             System.out.println(&quot;Total of &quot; + testExitValue + &quot; failed&quot;);
250             System.exit(1);
251         } else {
252             System.out.println(&quot;All tests pass&quot;);
253         }
254     }
255 }
</pre>
</td>
<td>
<hr />
<pre>
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /**
 25  * @test
 26  * @bug 8170832 8180447
 27  * @summary Arguments passed in environment variable
 28  * @modules jdk.compiler
 29  *          jdk.zipfs
 30  * @build TestHelper
 31  * @run main ArgsEnvVar
 32  */
 33 import java.io.File;
 34 import java.io.IOException;
 35 import java.util.ArrayList;
 36 import java.util.HashMap;
 37 import java.util.List;
 38 import java.util.Map;
 39 import java.util.regex.Pattern;
<span class="line-added"> 40 import java.nio.file.Paths;</span>
<span class="line-added"> 41 import java.nio.file.Path;</span>
 42 
 43 public class ArgsEnvVar extends TestHelper {
 44     private static File testJar = null;
 45     private static Map&lt;String, String&gt; env = new HashMap&lt;&gt;();
 46 
 47     private static String JDK_JAVA_OPTIONS = &quot;JDK_JAVA_OPTIONS&quot;;
 48 
 49     static void init() throws IOException {
 50         if  (testJar != null) {
 51             return;
 52         }
 53         testJar = new File(&quot;test.jar&quot;);
 54         StringBuilder tsrc = new StringBuilder();
 55         tsrc.append(&quot;public static void main(String... args) {\n&quot;);
 56         tsrc.append(&quot;   for (String x : args) {\n&quot;);
 57         tsrc.append(&quot;        System.out.println(x);\n&quot;);
 58         tsrc.append(&quot;   }\n&quot;);
 59         tsrc.append(&quot;}\n&quot;);
 60         createJar(testJar, new File(&quot;Foo&quot;), tsrc.toString());
 61 
</pre>
<hr />
<pre>
138 
139     private TestResult testInEnv(List&lt;String&gt; options) {
140         env.put(JDK_JAVA_OPTIONS, String.join(&quot; &quot;, options));
141         return doExec(env, javaCmd, &quot;-jar&quot;, &quot;test.jar&quot;);
142     }
143 
144     private TestResult testInEnvAsArgFile(List&lt;String&gt; options) throws IOException {
145         File argFile = createArgFile(&quot;argFile&quot;, options);
146         env.put(JDK_JAVA_OPTIONS, &quot;@argFile&quot;);
147         TestResult tr = doExec(env, javaCmd, &quot;-jar&quot;, &quot;test.jar&quot;);
148         argFile.delete();
149         return tr;
150     }
151 
152     @Test
153     public void noTerminalOpt() throws IOException {
154         List&lt;List&lt;String&gt;&gt; terminal_opts = List.of(
155                 List.of(&quot;-jar&quot;, &quot;test.jar&quot;),
156                 List.of(&quot;-m&quot;, &quot;test/Foo&quot;),
157                 List.of(&quot;--module&quot;, &quot;test/Foo&quot;),
<span class="line-added">158                 List.of(&quot;--module=test/Foo&quot;),</span>
159                 List.of(&quot;--dry-run&quot;),
160                 List.of(&quot;-h&quot;),
161                 List.of(&quot;-?&quot;),
162                 List.of(&quot;-help&quot;),
163                 List.of(&quot;--help&quot;),
164                 List.of(&quot;-X&quot;),
165                 List.of(&quot;--help-extra&quot;),
166                 List.of(&quot;-version&quot;),
167                 List.of(&quot;--version&quot;),
168                 List.of(&quot;-fullversion&quot;),
169                 List.of(&quot;--full-version&quot;));
170 
171         for (List&lt;String&gt; options: terminal_opts) {
172             // terminal opt in environment variable
173             TestResult tr = testInEnv(options);
174             tr.checkNegative();
175             if (!tr.testStatus) {
176                 System.out.println(tr);
177                 throw new RuntimeException(&quot;test fails&quot;);
178             }
</pre>
<hr />
<pre>
227         env.put(JDK_JAVA_OPTIONS, &quot;-p ?&quot;);
228         tr = doExec(env, javaCmd, &quot;-jar&quot;, &quot;test.jar&quot;, &quot;one&quot;, &quot;two&quot;);
229         verifyOptions(List.of(&quot;-p&quot;, &quot;?&quot;, &quot;-jar&quot;, &quot;test.jar&quot;, &quot;one&quot;, &quot;two&quot;), tr);
230     }
231 
232     @Test
233     public void testTrailingSpaces() {
234         env.put(JDK_JAVA_OPTIONS, &quot;--add-exports java.base/jdk.internal.misc=ALL-UNNAMED &quot;);
235         TestResult tr = doExec(env, javaCmd, &quot;-jar&quot;, &quot;test.jar&quot;);
236         verifyOptions(List.of(&quot;--add-exports&quot;, &quot;java.base/jdk.internal.misc=ALL-UNNAMED&quot;, &quot;-jar&quot;, &quot;test.jar&quot;), tr);
237 
238         env.put(JDK_JAVA_OPTIONS, &quot;--class-path &#39; &#39;&quot;);
239         tr = doExec(env, javaCmd, &quot;-jar&quot;, &quot;test.jar&quot;);
240         verifyOptions(List.of(&quot;--class-path&quot;, &quot; &quot;, &quot;-jar&quot;, &quot;test.jar&quot;), tr);
241 
242         env.put(JDK_JAVA_OPTIONS, &quot;  --add-exports java.base/jdk.internal.misc=ALL-UNNAMED &quot;);
243         tr = doExec(env, javaCmd, &quot;-jar&quot;, &quot;test.jar&quot;);
244         verifyOptions(List.of(&quot;--add-exports&quot;, &quot;java.base/jdk.internal.misc=ALL-UNNAMED&quot;, &quot;-jar&quot;, &quot;test.jar&quot;), tr);
245     }
246 
<span class="line-added">247 </span>
<span class="line-added">248     @Test</span>
<span class="line-added">249     // That that we can correctly handle the module longform argument option</span>
<span class="line-added">250     // when supplied in an argument file</span>
<span class="line-added">251     public void modulesInArgsFile() throws IOException {</span>
<span class="line-added">252         File cwd = new File(&quot;.&quot;);</span>
<span class="line-added">253         File testModuleDir = new File(cwd, &quot;modules_test&quot;);</span>
<span class="line-added">254 </span>
<span class="line-added">255         createEchoArgumentsModule(testModuleDir);</span>
<span class="line-added">256 </span>
<span class="line-added">257         Path SRC_DIR = Paths.get(testModuleDir.getAbsolutePath(), &quot;src&quot;);</span>
<span class="line-added">258         Path MODS_DIR = Paths.get(testModuleDir.getAbsolutePath(), &quot;mods&quot;);</span>
<span class="line-added">259 </span>
<span class="line-added">260         // test module / main class</span>
<span class="line-added">261         String MODULE_OPTION = &quot;--module=test/launcher.Main&quot;;</span>
<span class="line-added">262         String TEST_MODULE = &quot;test&quot;;</span>
<span class="line-added">263 </span>
<span class="line-added">264         // javac -d mods/test src/test/**</span>
<span class="line-added">265         TestResult tr = doExec(</span>
<span class="line-added">266             javacCmd,</span>
<span class="line-added">267             &quot;-d&quot;, MODS_DIR.toString(),</span>
<span class="line-added">268             &quot;--module-source-path&quot;, SRC_DIR.toString(),</span>
<span class="line-added">269             &quot;--module&quot;, TEST_MODULE);</span>
<span class="line-added">270 </span>
<span class="line-added">271         if (!tr.isOK()) {</span>
<span class="line-added">272             System.out.println(&quot;test did not compile&quot;);</span>
<span class="line-added">273             throw new RuntimeException(&quot;Error: modules test did not compile&quot;);</span>
<span class="line-added">274         }</span>
<span class="line-added">275 </span>
<span class="line-added">276         // verify the terminating ability of --module= through environment variables</span>
<span class="line-added">277         File argFile = createArgFile(&quot;cmdargs&quot;, List.of(&quot;--module-path&quot;, MODS_DIR.toString(), MODULE_OPTION, &quot;--hello&quot;));</span>
<span class="line-added">278         env.put(JDK_JAVA_OPTIONS, &quot;@cmdargs&quot;);</span>
<span class="line-added">279         tr = doExec(env, javaCmd);</span>
<span class="line-added">280         tr.checkNegative();</span>
<span class="line-added">281         tr.contains(&quot;Error: Option &quot; + MODULE_OPTION + &quot; in @cmdargs is not allowed in environment variable JDK_JAVA_OPTIONS&quot;);</span>
<span class="line-added">282         if (!tr.testStatus) {</span>
<span class="line-added">283             System.out.println(tr);</span>
<span class="line-added">284             throw new RuntimeException(&quot;test fails&quot;);</span>
<span class="line-added">285         }</span>
<span class="line-added">286 </span>
<span class="line-added">287         // check that specifying --module and --module-path with file works</span>
<span class="line-added">288         tr = doExec(javaCmd, &quot;-Dfile.encoding=UTF-8&quot;, &quot;@cmdargs&quot;);</span>
<span class="line-added">289         tr.contains(&quot;[--hello]&quot;);</span>
<span class="line-added">290         if (!tr.testStatus) {</span>
<span class="line-added">291             System.out.println(tr);</span>
<span class="line-added">292             throw new RuntimeException(&quot;test fails&quot;);</span>
<span class="line-added">293         }</span>
<span class="line-added">294 </span>
<span class="line-added">295         // check with reversed --module-path and --module in the arguments file, this will fail, --module= is terminating</span>
<span class="line-added">296         File argFile1 = createArgFile(&quot;cmdargs1&quot;, List.of(MODULE_OPTION, &quot;--module-path&quot;, MODS_DIR.toString(), &quot;--hello&quot;));</span>
<span class="line-added">297         tr = doExec(javaCmd, &quot;-Dfile.encoding=UTF-8&quot;, &quot;@cmdargs1&quot;);</span>
<span class="line-added">298         tr.checkNegative();</span>
<span class="line-added">299         if (!tr.testStatus) {</span>
<span class="line-added">300             System.out.println(tr);</span>
<span class="line-added">301             throw new RuntimeException(&quot;test fails&quot;);</span>
<span class="line-added">302         }</span>
<span class="line-added">303 </span>
<span class="line-added">304         // clean-up</span>
<span class="line-added">305         argFile.delete();</span>
<span class="line-added">306         argFile1.delete();</span>
<span class="line-added">307         recursiveDelete(testModuleDir);</span>
<span class="line-added">308     }</span>
<span class="line-added">309 </span>
310     public static void main(String... args) throws Exception {
311         init();
312         ArgsEnvVar a = new ArgsEnvVar();
313         a.run(args);
314         if (testExitValue &gt; 0) {
315             System.out.println(&quot;Total of &quot; + testExitValue + &quot; failed&quot;);
316             System.exit(1);
317         } else {
318             System.out.println(&quot;All tests pass&quot;);
319         }
320     }
321 }
</pre>
</td>
</tr>
</table>
<center><a href="../jpackage/resources/icon4.ico.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="ArgsFileTest.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>