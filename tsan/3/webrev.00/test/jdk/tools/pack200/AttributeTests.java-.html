<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old test/jdk/tools/pack200/AttributeTests.java</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2010, 2013, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 import java.io.File;
 24 import java.util.ArrayList;
 25 import java.util.Arrays;
 26 import java.util.List;
 27 /*
 28  * @test
 29  * @bug 6746111 8005252 8008262
 30  * @summary tests various classfile format and attribute handling by pack200
 31  * @compile -XDignore.symbol.file Utils.java AttributeTests.java
 32  * @run main AttributeTests
 33  * @author ksrini
 34  */
 35 public class AttributeTests {
 36 
 37     public static void main(String... args) throws Exception {
 38         test6746111();
 39         testMethodParameters();
 40         Utils.cleanup();
 41     }
 42 
 43     /*
 44      * this tests ensure that MethodParameters produces by javac is packed
 45      * correctly. Usually this is not the case as new attributes are available
 46      * in the sdk jars, since MethodParameters happens to be an optional
 47      * attribute, thus this test.
 48      */
 49     static void testMethodParameters() throws Exception {
 50         List&lt;String&gt; scratch = new ArrayList&lt;&gt;();
 51         final String fname = &quot;MP&quot;;
 52         String javaFileName = fname + Utils.JAVA_FILE_EXT;
 53         String javaClassName = fname + Utils.CLASS_FILE_EXT;
 54         scratch.add(&quot;class &quot; + fname + &quot; {&quot;);
 55         scratch.add(&quot;void foo2(int j, final int k){}&quot;);
 56         scratch.add(&quot;}&quot;);
 57         File cwd = new File(&quot;.&quot;);
 58         File javaFile = new File(cwd, javaFileName);
 59         Utils.createFile(javaFile, scratch);
 60 
 61         Utils.compiler(javaFile.getName(), &quot;-parameters&quot;);
 62 
 63         // jar the file up
 64         File testjarFile = new File(cwd, &quot;test&quot; + Utils.JAR_FILE_EXT);
 65         Utils.jar(&quot;cvf&quot;, testjarFile.getName(), javaClassName);
 66 
 67         Utils.testWithRepack(testjarFile, &quot;--unknown-attribute=error&quot;);
 68     }
 69     /*
 70      * this test checks to see if we get the expected strings for output
 71      */
 72     static void test6746111() throws Exception {
 73         String pack200Cmd = Utils.getPack200Cmd();
 74         File badAttrJar = new File(&quot;.&quot;, &quot;badattr.jar&quot;);
 75         Utils.copyFile(new File(Utils.TEST_SRC_DIR, &quot;badattr.jar&quot;), badAttrJar);
 76         File testJar = new File(&quot;.&quot;, &quot;test.jar&quot;);
 77         List&lt;String&gt; cmds = new ArrayList&lt;String&gt;();
 78         cmds.add(pack200Cmd);
 79         cmds.add(&quot;--repack&quot;);
 80         cmds.add(&quot;-v&quot;);
 81         cmds.add(testJar.getAbsolutePath());
 82         cmds.add(badAttrJar.getAbsolutePath());
 83         List&lt;String&gt; output = Utils.runExec(cmds);
 84         /*
 85          * compare the repacked jar bit-wise, as all the files
 86          * should be transmitted &quot;as-is&quot;.
 87          */
 88         Utils.doCompareBitWise(badAttrJar.getAbsoluteFile(), testJar.getAbsoluteFile());
 89         String[] expectedStrings = {
 90             &quot;WARNING: Passing class file uncompressed due to unrecognized&quot; +
 91                     &quot; attribute: Foo.class&quot;,
 92             &quot;INFO: com.sun.java.util.jar.pack.Attribute$FormatException: &quot; +
 93                     &quot;class attribute \&quot;XourceFile\&quot;:  is unknown attribute &quot; +
 94                     &quot;in class Foo&quot;,
 95             &quot;INFO: com.sun.java.util.jar.pack.ClassReader$ClassFormatException: &quot; +
 96                     &quot;AnnotationDefault: attribute length cannot be zero, in Test.message()&quot;,
 97             &quot;WARNING: Passing class file uncompressed due to unknown class format: Test.class&quot;
 98         };
 99         List&lt;String&gt; notfoundList = new ArrayList&lt;String&gt;();
100         notfoundList.addAll(Arrays.asList(expectedStrings));
101         // make sure the expected messages are emitted
102         for (String x : output) {
103             findString(x, notfoundList, expectedStrings);
104         }
105         if (!notfoundList.isEmpty()) {
106             System.out.println(&quot;Not found:&quot;);
107             for (String x : notfoundList) {
108                 System.out.println(x);
109             }
110             throw new Exception(&quot;Test fails: &quot; + notfoundList.size() +
111                     &quot; expected strings not found&quot;);
112         }
113         testJar.delete();
114         badAttrJar.delete();
115     }
116 
117     private static void findString(String outputStr, List&lt;String&gt; notfoundList,
118             String[] expectedStrings) {
119         for (String y : expectedStrings) {
120             if (outputStr.contains(y)) {
121                 notfoundList.remove(y);
122                 return;
123             }
124         }
125     }
126 }
    </pre>
  </body>
</html>