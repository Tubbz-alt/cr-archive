<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old test/jdk/tools/pack200/Pack200Props.java</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2010, 2018, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @bug 6575373 6969063
 27  * @summary verify default properties of the packer/unpacker and segment limit
 28  * @modules java.logging
 29  *          jdk.compiler
 30  *          jdk.zipfs
 31  * @compile -XDignore.symbol.file Utils.java Pack200Props.java
 32  * @run main Pack200Props
 33  * @author ksrini
 34  */
 35 
 36 import java.io.File;
 37 import java.util.ArrayList;
 38 import java.util.HashMap;
 39 import java.util.List;
 40 import java.util.Map;
 41 import java.util.jar.Pack200;
 42 import java.util.jar.Pack200.Packer;
 43 import java.util.logging.Logger;
 44 
 45 /*
 46  * Run this against a large jar file, by default the packer should generate only
 47  * one segment, parse the output of the packer to verify if this is indeed true.
 48  */
 49 
 50 public class Pack200Props {
 51 
 52     final static Logger log = Logger.getLogger(&quot;Pack200Props&quot;);
 53 
 54     public static void main(String... args) throws Exception {
 55         verifyDefaults();
 56         File out = new File(&quot;test&quot; + Utils.PACK_FILE_EXT);
 57         out.delete();
 58         verifySegmentLimit(out);
 59         log.info(&quot;cleanup&quot;);
 60         Utils.cleanup();
 61     }
 62 
 63     static void verifySegmentLimit(File outFile) throws Exception {
 64         log.info(&quot;creating jar&quot;);
 65         File testJar = Utils.createRtJar();
 66 
 67         log.info(&quot;using pack200: &quot; + Utils.getPack200Cmd());
 68         List&lt;String&gt; cmdsList = new ArrayList&lt;&gt;();
 69         cmdsList.add(Utils.getPack200Cmd());
 70         cmdsList.add(&quot;-J-Xshare:off&quot;);
 71         cmdsList.add(&quot;-J-Xmx1280m&quot;);
 72         cmdsList.add(&quot;--effort=1&quot;);
 73         cmdsList.add(&quot;--verbose&quot;);
 74         cmdsList.add(&quot;--no-gzip&quot;);
 75         cmdsList.add(outFile.getName());
 76         cmdsList.add(testJar.getAbsolutePath());
 77         List&lt;String&gt; outList = Utils.runExec(cmdsList);
 78 
 79         log.info(&quot;verifying&quot;);
 80         int count = 0;
 81         for (String line : outList) {
 82             System.out.println(line);
 83             if (line.matches(&quot;.*Transmitted.*files of.*input bytes in a segment of.*bytes&quot;)) {
 84                 count++;
 85             }
 86         }
 87         log.info(&quot;fini&quot;);
 88         if (count == 0) {
 89             throw new RuntimeException(&quot;no segments or no output ????&quot;);
 90         } else if (count &gt; 1) {
 91             throw new RuntimeException(&quot;multiple segments detected, expected 1&quot;);
 92         }
 93     }
 94 
 95     private static void verifyDefaults() {
 96         log.info(&quot;start&quot;);
 97         Map&lt;String, String&gt; expectedDefaults = new HashMap&lt;&gt;();
 98         Packer p = Pack200.newPacker();
 99         expectedDefaults.put(&quot;com.sun.java.util.jar.pack.disable.native&quot;,
100                 p.FALSE);
101         expectedDefaults.put(&quot;com.sun.java.util.jar.pack.verbose&quot;, &quot;0&quot;);
102         expectedDefaults.put(p.CLASS_ATTRIBUTE_PFX + &quot;CompilationID&quot;, &quot;RUH&quot;);
103         expectedDefaults.put(p.CLASS_ATTRIBUTE_PFX + &quot;SourceID&quot;, &quot;RUH&quot;);
104         expectedDefaults.put(p.CODE_ATTRIBUTE_PFX + &quot;CharacterRangeTable&quot;,
105                 &quot;NH[PHPOHIIH]&quot;);
106         expectedDefaults.put(p.CODE_ATTRIBUTE_PFX + &quot;CoverageTable&quot;,
107                 &quot;NH[PHHII]&quot;);
108         expectedDefaults.put(p.DEFLATE_HINT, p.KEEP);
109         expectedDefaults.put(p.EFFORT, &quot;5&quot;);
110         expectedDefaults.put(p.KEEP_FILE_ORDER, p.TRUE);
111         expectedDefaults.put(p.MODIFICATION_TIME, p.KEEP);
112         expectedDefaults.put(p.SEGMENT_LIMIT, &quot;-1&quot;);
113         expectedDefaults.put(p.UNKNOWN_ATTRIBUTE, p.PASS);
114 
115         Map&lt;String, String&gt; props = p.properties();
116         int errors = 0;
117         for (String key : expectedDefaults.keySet()) {
118             String def = expectedDefaults.get(key);
119             String x = props.get(key);
120             if (x == null) {
121                 System.out.println(&quot;Error: key not found:&quot; + key);
122                 errors++;
123             } else {
124                 if (!def.equals(x)) {
125                     System.out.println(&quot;Error: key &quot; + key
126                             + &quot;\n  value expected: &quot; + def
127                             + &quot;\n  value obtained: &quot; + x);
128                     errors++;
129                 }
130             }
131         }
132         log.info(&quot;fini&quot;);
133         if (errors &gt; 0) {
134             throw new RuntimeException(errors +
135                     &quot; error(s) encountered in default properties verification&quot;);
136         }
137     }
138 }
139 
    </pre>
  </body>
</html>