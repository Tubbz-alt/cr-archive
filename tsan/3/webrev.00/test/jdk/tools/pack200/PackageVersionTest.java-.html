<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old test/jdk/tools/pack200/PackageVersionTest.java</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2010, 2018, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @bug 6712743 6991164 7168401
 27  * @summary verify package versions
 28  * @compile -XDignore.symbol.file Utils.java PackageVersionTest.java
 29  * @run main PackageVersionTest
 30  * @author ksrini
 31  */
 32 
 33 import java.io.ByteArrayOutputStream;
 34 import java.io.Closeable;
 35 import java.io.File;
 36 import java.io.FileOutputStream;
 37 import java.io.IOException;
 38 import java.io.PrintStream;
 39 import java.util.jar.JarFile;
 40 import java.util.jar.Pack200;
 41 import java.util.jar.Pack200.Packer;
 42 import java.util.jar.Pack200.Unpacker;
 43 
 44 public class PackageVersionTest {
 45     private static final File  javaHome = new File(System.getProperty(&quot;java.home&quot;));
 46 
 47     public final static int JAVA5_PACKAGE_MAJOR_VERSION = 150;
 48     public final static int JAVA5_PACKAGE_MINOR_VERSION = 7;
 49 
 50     public final static int JAVA6_PACKAGE_MAJOR_VERSION = 160;
 51     public final static int JAVA6_PACKAGE_MINOR_VERSION = 1;
 52 
 53     public final static int JAVA7_PACKAGE_MAJOR_VERSION = 170;
 54     public final static int JAVA7_PACKAGE_MINOR_VERSION = 1;
 55 
 56     public static void main(String... args) throws IOException {
 57         File out = new File(&quot;test.pack&quot;);
 58         createClassFile(&quot;Test6&quot;);
 59         createClassFile(&quot;Test7&quot;);
 60 
 61         verify6991164();
 62 
 63         // a jar file devoid of indy classes must generate 160.1 package file
 64         verifyPack(&quot;Test7.class&quot;, JAVA6_PACKAGE_MAJOR_VERSION,
 65                 JAVA6_PACKAGE_MINOR_VERSION);
 66 
 67         // test for resource file, ie. no class files
 68         verifyPack(&quot;Test6.java&quot;, JAVA5_PACKAGE_MAJOR_VERSION,
 69                 JAVA5_PACKAGE_MINOR_VERSION);
 70         Utils.cleanup();
 71     }
 72 
 73     static void verify6991164() {
 74         Unpacker unpacker = Pack200.newUnpacker();
 75         String versionStr = unpacker.toString();
 76         String expected = &quot;Pack200, Vendor: &quot; +
 77                 System.getProperty(&quot;java.vendor&quot;) + &quot;, Version: &quot; +
 78                 JAVA7_PACKAGE_MAJOR_VERSION + &quot;.&quot; + JAVA7_PACKAGE_MINOR_VERSION;
 79         if (!versionStr.equals(expected)) {
 80             System.out.println(&quot;Expected: &quot; + expected);
 81             System.out.println(&quot;Obtained: &quot; + versionStr);
 82             throw new RuntimeException(&quot;did not get expected string &quot; + expected);
 83         }
 84     }
 85 
 86     static void createClassFile(String name) {
 87         createJavaFile(name);
 88         String target = name.substring(name.length() - 1);
 89         String javacCmds[] = {
 90             &quot;-source&quot;,
 91             &quot;7&quot;,
 92             &quot;-target&quot;,
 93             &quot;7&quot;,
 94             &quot;-Xlint:-options&quot;,
 95             name + &quot;.java&quot;
 96         };
 97         Utils.compiler(javacCmds);
 98     }
 99 
100     static void createJavaFile(String name) {
101         PrintStream ps = null;
102         FileOutputStream fos = null;
103         File outputFile = new File(name + &quot;.java&quot;);
104         outputFile.delete();
105         try {
106             fos = new FileOutputStream(outputFile);
107             ps = new PrintStream(fos);
108             ps.format(&quot;public class %s {}&quot;, name);
109         } catch (IOException ioe) {
110             throw new RuntimeException(&quot;creation of test file failed&quot;);
111         } finally {
112             Utils.close(ps);
113             Utils.close(fos);
114         }
115     }
116 
117     static void verifyPack(String filename, int expected_major, int expected_minor) {
118 
119         File jarFileName = new File(&quot;test.jar&quot;);
120         jarFileName.delete();
121         String jargs[] = {
122             &quot;cvf&quot;,
123             jarFileName.getName(),
124             filename
125         };
126         Utils.jar(jargs);
127         JarFile jfin = null;
128 
129         try {
130             jfin = new JarFile(jarFileName);
131             Packer packer = Pack200.newPacker();
132             ByteArrayOutputStream baos = new ByteArrayOutputStream();
133             packer.pack(jfin, baos);
134             baos.flush();
135             baos.close();
136             byte[] buf = baos.toByteArray();
137 
138             int minor = buf[4] &amp; 0x000000ff;
139             int major = buf[5] &amp; 0x000000ff;
140 
141             if (major != expected_major || minor != expected_minor) {
142                 String msg =
143                         String.format(&quot;test fails: expected:%d.%d but got %d.%d\n&quot;,
144                         expected_major, expected_minor,
145                         major, minor);
146                 throw new Error(msg);
147             }
148 
149             System.out.println(filename + &quot;: OK&quot;);
150         } catch (IOException ioe) {
151             throw new RuntimeException(ioe.getMessage());
152         } finally {
153             Utils.close((Closeable) jfin);
154         }
155     }
156 }
    </pre>
  </body>
</html>