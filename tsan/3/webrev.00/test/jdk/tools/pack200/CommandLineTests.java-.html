<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old test/jdk/tools/pack200/CommandLineTests.java</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2007, 2014, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test CommandLineTests.sh
 26  * @bug  6521334 6965836 6965836
 27  * @ignore 8059906
 28  * @compile -XDignore.symbol.file CommandLineTests.java Pack200Test.java
 29  * @run main/timeout=1200 CommandLineTests
 30  * @summary An ad hoc test to verify the behavior of pack200/unpack200 CLIs,
 31  *           and a simulation of pack/unpacking in the install repo.
 32  * @author ksrini
 33  */
 34 
 35 import java.io.File;
 36 import java.io.FileOutputStream;
 37 import java.io.IOException;
 38 import java.io.PrintStream;
 39 import java.util.ArrayList;
 40 import java.util.List;
 41 /*
 42  * We try a potpouri of things ie. we have pack.conf to setup some
 43  * options as well as a couple of command line options. We also test
 44  * the packing and unpacking mechanism using the Java APIs. This also
 45  * simulates pack200 the install workspace, noting that this is a simulation
 46  * and can only test jars that are guaranteed to be available, also the
 47  * configuration may not be in sync with the installer workspace.
 48  */
 49 
 50 public class CommandLineTests {
 51     private static final File CWD = new File(&quot;.&quot;);
 52     private static final File EXP_SDK = new File(CWD, &quot;exp-sdk-image&quot;);
 53     private static final File EXP_SDK_LIB_DIR = new File(EXP_SDK, &quot;lib&quot;);
 54     private static final File EXP_SDK_BIN_DIR = new File(EXP_SDK, &quot;bin&quot;);
 55     private static final File EXP_JRE_DIR = new File(EXP_SDK, &quot;jre&quot;);
 56     private static final File EXP_JRE_LIB_DIR = new File(EXP_JRE_DIR, &quot;lib&quot;);
 57     private static final File RtJar = new File(EXP_JRE_LIB_DIR, &quot;rt.jar&quot;);
 58     private static final File CharsetsJar = new File(EXP_JRE_LIB_DIR, &quot;charsets.jar&quot;);
 59     private static final File JsseJar = new File(EXP_JRE_LIB_DIR, &quot;jsse.jar&quot;);
 60     private static final File ToolsJar = new File(EXP_SDK_LIB_DIR, &quot;tools.jar&quot;);
 61     private static final File javaCmd;
 62     private static final File javacCmd;
 63     private static final File ConfigFile = new File(&quot;pack.conf&quot;);
 64     private static final List&lt;File&gt; jarList;
 65 
 66     static {
 67         javaCmd = Utils.IsWindows
 68                     ? new File(EXP_SDK_BIN_DIR, &quot;java.exe&quot;)
 69                     : new File(EXP_SDK_BIN_DIR, &quot;java&quot;);
 70 
 71         javacCmd = Utils.IsWindows
 72                     ? new File(EXP_SDK_BIN_DIR, &quot;javac.exe&quot;)
 73                     : new File(EXP_SDK_BIN_DIR, &quot;javac&quot;);
 74 
 75         jarList = new ArrayList&lt;File&gt;();
 76         jarList.add(RtJar);
 77         jarList.add(CharsetsJar);
 78         jarList.add(JsseJar);
 79         jarList.add(ToolsJar);
 80     }
 81 
 82     // init test area with a copy of the sdk
 83     static void init() throws IOException {
 84             Utils.recursiveCopy(Utils.JavaSDK, EXP_SDK);
 85             creatConfigFile();
 86     }
 87     // cleanup the test area
 88     static void cleanup() throws IOException {
 89         Utils.recursiveDelete(EXP_SDK);
 90         Utils.cleanup();
 91     }
 92 
 93     // Hopefully, this should be kept in sync with what the installer does.
 94     static void creatConfigFile() throws IOException {
 95         FileOutputStream fos = null;
 96         PrintStream ps = null;
 97         try {
 98             fos = new FileOutputStream(ConfigFile);
 99             ps = new PrintStream(fos);
100             ps.println(&quot;com.sun.java.util.jar.pack.debug.verbose=0&quot;);
101             ps.println(&quot;pack.modification.time=keep&quot;);
102             ps.println(&quot;pack.keep.class.order=true&quot;);
103             ps.println(&quot;pack.deflate.hint=false&quot;);
104             // Fail the build, if new or unknown attributes are introduced.
105             ps.println(&quot;pack.unknown.attribute=error&quot;);
106             ps.println(&quot;pack.segment.limit=-1&quot;);
107             // BugId: 6328502,  These files will be passed-through as-is.
108             ps.println(&quot;pack.pass.file.0=java/lang/Error.class&quot;);
109             ps.println(&quot;pack.pass.file.1=java/lang/LinkageError.class&quot;);
110             ps.println(&quot;pack.pass.file.2=java/lang/Object.class&quot;);
111             ps.println(&quot;pack.pass.file.3=java/lang/Throwable.class&quot;);
112             ps.println(&quot;pack.pass.file.4=java/lang/VerifyError.class&quot;);
113         } finally {
114             Utils.close(ps);
115             Utils.close(fos);
116         }
117     }
118 
119     static void runPack200(boolean jre) throws IOException {
120         List&lt;String&gt; cmdsList = new ArrayList&lt;String&gt;();
121         for (File f : jarList) {
122             if (jre &amp;&amp; f.getName().equals(&quot;tools.jar&quot;)) {
123                 continue;  // need not worry about tools.jar for JRE
124             }
125             // make a backup copy for re-use
126             File bakFile = new File(f.getName() + &quot;.bak&quot;);
127             if (!bakFile.exists()) {  // backup
128                 Utils.copyFile(f, bakFile);
129             } else {  // restore
130                 Utils.copyFile(bakFile, f);
131             }
132             cmdsList.clear();
133             cmdsList.add(Utils.getPack200Cmd());
134             cmdsList.add(&quot;-J-esa&quot;);
135             cmdsList.add(&quot;-J-ea&quot;);
136             cmdsList.add(Utils.Is64Bit ? &quot;-J-Xmx1g&quot; : &quot;-J-Xmx512m&quot;);
137             cmdsList.add(&quot;--repack&quot;);
138             cmdsList.add(&quot;--config-file=&quot; + ConfigFile.getAbsolutePath());
139             if (jre) {
140                 cmdsList.add(&quot;--strip-debug&quot;);
141             }
142             // NOTE: commented until 6965836 is fixed
143             // cmdsList.add(&quot;--code-attribute=StackMapTable=strip&quot;);
144             cmdsList.add(f.getAbsolutePath());
145             Utils.runExec(cmdsList);
146         }
147     }
148 
149     static void testJRE() throws IOException {
150         runPack200(true);
151         // the speciment JRE
152         List&lt;String&gt; cmdsList = new ArrayList&lt;String&gt;();
153         cmdsList.add(javaCmd.getAbsolutePath());
154         cmdsList.add(&quot;-verify&quot;);
155         cmdsList.add(&quot;-version&quot;);
156         Utils.runExec(cmdsList);
157     }
158 
159     static void testJDK() throws IOException {
160         runPack200(false);
161         // test the specimen JDK
162         List&lt;String&gt; cmdsList = new ArrayList&lt;String&gt;();
163         cmdsList.add(javaCmd.getAbsolutePath());
164         cmdsList.add(&quot;-verify&quot;);
165         cmdsList.add(&quot;-version&quot;);
166         Utils.runExec(cmdsList);
167 
168         // invoke javac to test the tools.jar
169         cmdsList.clear();
170         cmdsList.add(javacCmd.getAbsolutePath());
171         cmdsList.add(&quot;-J-verify&quot;);
172         cmdsList.add(&quot;-help&quot;);
173         Utils.runExec(cmdsList);
174     }
175     public static void main(String... args) {
176         try {
177             init();
178             testJRE();
179             testJDK();
180             cleanup(); // cleanup only if we pass successfully
181         } catch (IOException ioe) {
182             throw new RuntimeException(ioe);
183         }
184     }
185 }
    </pre>
  </body>
</html>