<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New test/jdk/tools/jpackage/run_tests.sh</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
  <body>
    <pre>
  1 #!/bin/bash
  2 
  3 #
  4 # Script to run jpackage tests.
  5 #
  6 
  7 
  8 # Fail fast
  9 set -e; set -o pipefail;
 10 
 11 # $JT_BUNDLE_URL (Link can be obtained from https://openjdk.java.net/jtreg/ page)
 12 jtreg_bundle=$JT_BUNDLE_URL
 13 workdir=/tmp/jpackage_jtreg_testing
 14 jtreg_jar=$workdir/jtreg/lib/jtreg.jar
 15 jpackage_test_selector=test/jdk/tools/jpackage
 16 
 17 
 18 find_packaging_tests ()
 19 {
 20   (cd &quot;$open_jdk_with_jpackage_jtreg_tests&quot; &amp;&amp; \
 21     find &quot;$jpackage_test_selector/$1&quot; -type f -name &#39;*.java&#39; \
 22     | xargs grep -E -l &#39;@key[[:space:]]+jpackagePlatformPackage&#39;)
 23 }
 24 
 25 
 26 find_all_packaging_tests ()
 27 {
 28   find_packaging_tests share
 29   case &quot;$(uname -s)&quot; in
 30     Darwin)
 31       find_packaging_tests macosx;;
 32     Linux)
 33       find_packaging_tests linux;;
 34     CYGWIN*|MINGW32*|MSYS*)
 35       find_packaging_tests windows;;
 36     *)
 37       fatal Failed to detect OS type;;
 38   esac
 39 }
 40 
 41 
 42 help_usage ()
 43 {
 44   echo &quot;Usage: `basename $0` [options] [--] [jtreg_options|test_names]&quot;
 45   echo &quot;Options:&quot;
 46   echo &quot;  -h              - print this message&quot;
 47   echo &quot;  -v              - verbose output&quot;
 48   echo &quot;  -c              - keep jtreg cache&quot;
 49   echo &quot;  -a              - run all, not only SQE tests&quot;
 50   echo &quot;  -d              - dry run. Print jtreg command line, but don&#39;t execute it&quot;
 51   echo &quot;  -t &lt;jdk&gt;        - path to JDK to be tested [ mandatory ]&quot;
 52   echo &quot;  -j &lt;openjdk&gt;    - path to local copy of openjdk repo with jpackage jtreg tests&quot;
 53   echo &quot;                    Optional, default is openjdk repo where this script resides&quot;
 54   echo &quot;  -o &lt;outputdir&gt;  - path to folder where to copy artifacts for testing.&quot;
 55   echo &quot;                    Optional, default is the current directory.&quot;
 56   echo &#39;  -r &lt;runtimedir&gt; - value for `jpackage.test.runtime-image` property.&#39;
 57   echo &quot;                    Optional, for jtreg tests debug purposes only.&quot;
 58   echo &#39;  -l &lt;logfile&gt;    - value for `jpackage.test.logfile` property.&#39;
 59   echo &quot;                    Optional, for jtreg tests debug purposes only.&quot;
 60   echo &quot;  -m &lt;mode&gt;       - mode to run jtreg tests.&quot;
 61   echo &#39;                    Should be one of `create`, `update` or `print-default-tests`.&#39;
 62   echo &#39;                    Optional, default mode is `update`.&#39;
 63   echo &#39;                    - `create`&#39;
 64   echo &#39;                      Remove all package bundles from the output directory before running jtreg tests.&#39;
 65   echo &#39;                    - `update`&#39;
 66   echo &#39;                      Run jtreg tests and overrite existing package bundles in the output directory.&#39;
 67   echo &#39;                    - `print-default-tests`&#39;
 68   echo &#39;                      Print default list of packaging tests and exit.&#39;
 69 }
 70 
 71 error ()
 72 {
 73   echo &quot;$@&quot; &gt; /dev/stderr
 74 }
 75 
 76 fatal ()
 77 {
 78   error &quot;$@&quot;
 79   exit 1
 80 }
 81 
 82 fatal_with_help_usage ()
 83 {
 84   error &quot;$@&quot;
 85   help_usage
 86   exit 1
 87 }
 88 
 89 if command -v cygpath &amp;&gt; /dev/null; then
 90 to_native_path ()
 91 {
 92   cygpath -m &quot;$@&quot;
 93 }
 94 else
 95 to_native_path ()
 96 {
 97   echo &quot;$@&quot;
 98 }
 99 fi
100 
101 exec_command ()
102 {
103   if [ -n &quot;$dry_run&quot; ]; then
104     echo &quot;$@&quot;
105   else
106     eval &quot;$@&quot;
107   fi
108 }
109 
110 
111 # Path to JDK to be tested.
112 test_jdk=
113 
114 # Path to local copy of open jdk repo with jpackage jtreg tests
115 # hg clone http://hg.openjdk.java.net/jdk/sandbox
116 # cd sandbox; hg update -r JDK-8200758-branch
117 open_jdk_with_jpackage_jtreg_tests=$(dirname $0)/../../../../
118 
119 # Directory where to save artifacts for testing.
120 output_dir=$PWD
121 
122 # Script and jtreg debug.
123 verbose=
124 jtreg_verbose=&quot;-verbose:fail,error,summary&quot;
125 
126 keep_jtreg_cache=
127 
128 # Mode in which to run jtreg tests
129 mode=update
130 
131 # jtreg extra arguments
132 declare -a jtreg_args
133 
134 # Create packages only
135 jtreg_args+=(&quot;-Djpackage.test.action=create&quot;)
136 
137 # run all tests
138 run_all_tests=
139 
140 mapfile -t tests &lt; &lt;(find_all_packaging_tests)
141 
142 while getopts &quot;vahdct:j:o:r:m:l:&quot; argname; do
143   case &quot;$argname&quot; in
144     v) verbose=yes;;
145     a) run_all_tests=yes;;
146     d) dry_run=yes;;
147     c) keep_jtreg_cache=yes;;
148     t) test_jdk=&quot;$OPTARG&quot;;;
149     j) open_jdk_with_jpackage_jtreg_tests=&quot;$OPTARG&quot;;;
150     o) output_dir=&quot;$OPTARG&quot;;;
151     r) runtime_dir=&quot;$OPTARG&quot;;;
152     l) logfile=&quot;$OPTARG&quot;;;
153     m) mode=&quot;$OPTARG&quot;;;
154     h) help_usage; exit 0;;
155     ?) help_usage; exit 1;;
156   esac
157 done
158 shift $(( OPTIND - 1 ))
159 
160 [ -z &quot;$verbose&quot; ] || { set -x; jtreg_verbose=-va; }
161 
162 if [ -z &quot;$open_jdk_with_jpackage_jtreg_tests&quot; ]; then
163   fatal_with_help_usage &quot;Path to openjdk repo with jpackage jtreg tests not specified&quot;
164 fi
165 
166 if [ &quot;$mode&quot; = &quot;print-default-tests&quot; ]; then
167   exec_command for t in ${tests[@]}&quot;;&quot; do echo &#39;$t;&#39; done
168   exit
169 fi
170 
171 if [ -z &quot;$test_jdk&quot; ]; then
172   fatal_with_help_usage Path to test JDK not specified
173 fi
174 
175 if [ -z &quot;$JAVA_HOME&quot; ]; then
176   echo JAVA_HOME environment variable not set, will use java from test JDK [$test_jdk] to run jtreg
177   JAVA_HOME=&quot;$test_jdk&quot;
178 fi
179 if [ ! -e &quot;$JAVA_HOME/bin/java&quot; ]; then
180   fatal JAVA_HOME variable is set to [$JAVA_HOME] value, but $JAVA_HOME/bin/java not found.
181 fi
182 
183 if [ -z &quot;$JT_HOME&quot; ]; then
184   if [ -z &quot;$JT_BUNDLE_URL&quot; ]; then
185     fatal &#39;JT_HOME or JT_BUNDLE_URL environment variable is not set. Link to JTREG bundle can be found at https://openjdk.java.net/jtreg/&#39;.
186   fi
187 fi
188 
189 if [ -n &quot;$runtime_dir&quot; ]; then
190   if [ ! -d &quot;$runtime_dir&quot; ]; then
191     fatal &#39;Value of `-r` option is set to non-existing directory&#39;.
192   fi
193   jtreg_args+=(&quot;-Djpackage.test.runtime-image=$(to_native_path &quot;$(cd &quot;$runtime_dir&quot; &amp;&amp; pwd)&quot;)&quot;)
194 fi
195 
196 if [ -n &quot;$logfile&quot; ]; then
197   if [ ! -d &quot;$(dirname &quot;$logfile&quot;)&quot; ]; then
198     fatal &#39;Value of `-l` option specified a file in non-existing directory&#39;.
199   fi
200   logfile=&quot;$(cd &quot;$(dirname &quot;$logfile&quot;)&quot; &amp;&amp; pwd)/$(basename &quot;$logfile&quot;)&quot;
201   jtreg_args+=(&quot;-Djpackage.test.logfile=$(to_native_path &quot;$logfile&quot;)&quot;)
202 fi
203 
204 if [ &quot;$mode&quot; = create ]; then
205   true
206 elif [ &quot;$mode&quot; = update ]; then
207   true
208 else
209   fatal_with_help_usage &#39;Invalid value of -m option:&#39; [$mode]
210 fi
211 
212 if [ -z &quot;$run_all_tests&quot; ]; then
213   jtreg_args+=(-Djpackage.test.SQETest=yes)
214 fi
215 
216 # Drop arguments separator
217 [ &quot;$1&quot; != &quot;--&quot; ] || shift
218 
219 # All remaining command line arguments are tests to run
220 # that should override the defaults and explicit jtreg arguments
221 [ $# -eq 0 ] || tests=($@)
222 
223 
224 installJtreg ()
225 {
226   # Install jtreg if missing
227   if [ -z &quot;$JT_HOME&quot; ]; then
228     if [ ! -f &quot;$jtreg_jar&quot; ]; then
229       exec_command mkdir -p &quot;$workdir&quot;
230       if [[ ${jtreg_bundle: -7} == &quot;.tar.gz&quot; ]]; then
231         exec_command &quot;(&quot; cd &quot;$workdir&quot; &quot;&amp;&amp;&quot; wget &quot;$jtreg_bundle&quot; &quot;&amp;&amp;&quot; tar -xzf &quot;$(basename $jtreg_bundle)&quot; &quot;;&quot; rm -f &quot;$(basename $jtreg_bundle)&quot; &quot;)&quot;
232       else
233         if [[ ${jtreg_bundle: -4} == &quot;.zip&quot; ]]; then
234           exec_command &quot;(&quot; cd &quot;$workdir&quot; &quot;&amp;&amp;&quot; wget &quot;$jtreg_bundle&quot; &quot;&amp;&amp;&quot; unzip &quot;$(basename $jtreg_bundle)&quot; &quot;;&quot; rm -f &quot;$(basename $jtreg_bundle)&quot; &quot;)&quot;
235         else
236           fatal &#39;Unsupported extension of JREG bundle [&#39;$JT_BUNDLE_URL&#39;]. Only *.zip or *.tar.gz is supported.&#39;
237         fi
238       fi
239     fi
240   else
241     # use jtreg provided via JT_HOME
242     jtreg_jar=$JT_HOME/lib/jtreg.jar
243   fi
244 
245   echo &#39;jtreg jar file: &#39;$jtreg_jar
246 }
247 
248 
249 preRun ()
250 {
251   local xargs_args=(-t --no-run-if-empty rm)
252   if [ -n &quot;$dry_run&quot; ]; then
253     xargs_args=(--no-run-if-empty echo rm)
254   fi
255 
256   if [ ! -d &quot;$output_dir&quot; ]; then
257     exec_command mkdir -p &quot;$output_dir&quot;
258   fi
259   [ ! -d &quot;$output_dir&quot; ] || output_dir=$(cd &quot;$output_dir&quot; &amp;&amp; pwd)
260 
261   # Clean output directory
262   [ &quot;$mode&quot; != &quot;create&quot; ] || find $output_dir -maxdepth 1 -type f -name &#39;*.exe&#39; -or -name &#39;*.msi&#39; -or -name &#39;*.rpm&#39; -or -name &#39;*.deb&#39; | xargs &quot;${xargs_args[@]}&quot;
263 }
264 
265 
266 run ()
267 {
268   local jtreg_cmdline=(\
269     $JAVA_HOME/bin/java -jar $(to_native_path &quot;$jtreg_jar&quot;) \
270     &quot;-Djpackage.test.output=$(to_native_path &quot;$output_dir&quot;)&quot; \
271     &quot;${jtreg_args[@]}&quot; \
272     -nr \
273     &quot;$jtreg_verbose&quot; \
274     -retain:all \
275     -automatic \
276     -ignore:run \
277     -testjdk:&quot;$(to_native_path $test_jdk)&quot; \
278     -dir:&quot;$(to_native_path $open_jdk_with_jpackage_jtreg_tests)&quot; \
279     -reportDir:&quot;$(to_native_path $workdir/run/results)&quot; \
280     -workDir:&quot;$(to_native_path $workdir/run/support)&quot; \
281     &quot;${tests[@]}&quot; \
282   )
283 
284   # Clear previous results
285   [ -n &quot;$keep_jtreg_cache&quot; ] || exec_command rm -rf &quot;$workdir&quot;/run
286 
287   # Run jpackage jtreg tests to create artifacts for testing
288   exec_command ${jtreg_cmdline[@]}
289 }
290 
291 
292 installJtreg
293 preRun
294 run
    </pre>
  </body>
</html>