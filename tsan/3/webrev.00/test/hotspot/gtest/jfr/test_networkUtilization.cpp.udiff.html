<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/hotspot/gtest/jfr/test_networkUtilization.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="../gtestMain.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="test_threadCpuLoad.cpp.udiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/gtest/jfr/test_networkUtilization.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2018, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -49,11 +49,11 @@</span>
  #include &lt;map&gt;
  
  namespace {
  
    class MockFastUnorderedElapsedCounterSource : public ::FastUnorderedElapsedCounterSource {
<span class="udiff-line-modified-removed">-   public:</span>
<span class="udiff-line-modified-added">+    public:</span>
      static jlong current_ticks;
      static Type now() {
        return current_ticks;
      }
      static uint64_t nanoseconds(Type value) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -63,11 +63,11 @@</span>
  
    typedef TimeInstant&lt;CounterRepresentation, MockFastUnorderedElapsedCounterSource&gt; MockJfrTicks;
    typedef TimeInterval&lt;CounterRepresentation, MockFastUnorderedElapsedCounterSource&gt; MockJfrTickspan;
  
    class MockJfrCheckpointWriter {
<span class="udiff-line-modified-removed">-   public:</span>
<span class="udiff-line-modified-added">+    public:</span>
      traceid current;
      std::map&lt;traceid, std::string&gt; ids;
  
      const JfrCheckpointContext context() const {
        return JfrCheckpointContext();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -76,48 +76,101 @@</span>
        return 0;
      }
      void write_key(traceid id) {
        current = id;
      }
<span class="udiff-line-modified-removed">-     void write(const char* data) {</span>
<span class="udiff-line-modified-removed">-       ids[current] = data;</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+     void write_type(JfrTypeId id) {}</span>
<span class="udiff-line-modified-added">+     MockJfrCheckpointWriter() {}</span>
<span class="udiff-line-modified-added">+     void write(const char* data) {}</span>
      void set_context(const JfrCheckpointContext ctx) { }
<span class="udiff-line-modified-removed">-     void write_count(u4 nof_entries, jlong offset) { }</span>
<span class="udiff-line-modified-added">+     void write_count(u4 nof_entries) { }</span>
    };
  
    class MockJfrSerializer {
<span class="udiff-line-modified-removed">-   public:</span>
<span class="udiff-line-modified-removed">-     static MockJfrSerializer* current;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     static bool register_serializer(JfrTypeId id, bool require_safepoint, bool permit_cache, MockJfrSerializer* serializer) {</span>
<span class="udiff-line-removed">-       current = serializer;</span>
<span class="udiff-line-modified-added">+    public:</span>
<span class="udiff-line-modified-added">+     static bool register_serializer(JfrTypeId id, bool permit_cache, MockJfrSerializer* serializer) {</span>
        return true;
      }
<span class="udiff-line-added">+     virtual void on_rotation() {}</span>
<span class="udiff-line-added">+     virtual void serialize(MockJfrCheckpointWriter&amp; writer) {}</span>
<span class="udiff-line-added">+   };</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   struct MockNetworkInterface {</span>
<span class="udiff-line-added">+     std::string name;</span>
<span class="udiff-line-added">+     uint64_t bytes_in;</span>
<span class="udiff-line-added">+     uint64_t bytes_out;</span>
<span class="udiff-line-added">+     traceid id;</span>
<span class="udiff-line-added">+     MockNetworkInterface(std::string name, uint64_t bytes_in, uint64_t bytes_out, traceid id) :</span>
<span class="udiff-line-added">+       name(name), bytes_in(bytes_in), bytes_out(bytes_out), id(id) {}</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     bool operator==(const MockNetworkInterface&amp; rhs) const {</span>
<span class="udiff-line-added">+       return name == rhs.name;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+   };</span>
  
<span class="udiff-line-modified-removed">-     virtual void serialize(MockJfrCheckpointWriter&amp; writer) = 0;</span>
<span class="udiff-line-modified-added">+   class NetworkInterface : public ::NetworkInterface {</span>
<span class="udiff-line-added">+    public:</span>
<span class="udiff-line-added">+     NetworkInterface(const char* name, uint64_t bytes_in, uint64_t bytes_out, NetworkInterface* next) :</span>
<span class="udiff-line-added">+       ::NetworkInterface(name, bytes_in, bytes_out, next) {}</span>
<span class="udiff-line-added">+     NetworkInterface* next(void) const {</span>
<span class="udiff-line-added">+       return reinterpret_cast&lt;NetworkInterface*&gt;(::NetworkInterface::next());</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+   };</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   class MockJfrOSInterface {</span>
<span class="udiff-line-added">+     static std::list&lt;MockNetworkInterface&gt; _interfaces;</span>
<span class="udiff-line-added">+    public:</span>
<span class="udiff-line-added">+     MockJfrOSInterface() {}</span>
<span class="udiff-line-added">+     static int network_utilization(NetworkInterface** network_interfaces) {</span>
<span class="udiff-line-added">+       *network_interfaces = NULL;</span>
<span class="udiff-line-added">+       for (std::list&lt;MockNetworkInterface&gt;::const_iterator i = _interfaces.begin();</span>
<span class="udiff-line-added">+            i != _interfaces.end();</span>
<span class="udiff-line-added">+            ++i) {</span>
<span class="udiff-line-added">+         NetworkInterface* cur = new NetworkInterface(i-&gt;name.c_str(), i-&gt;bytes_in, i-&gt;bytes_out, *network_interfaces);</span>
<span class="udiff-line-added">+         *network_interfaces = cur;</span>
<span class="udiff-line-added">+       }</span>
<span class="udiff-line-added">+       return OS_OK;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+     static MockNetworkInterface&amp; add_interface(const std::string&amp; name, traceid id) {</span>
<span class="udiff-line-added">+       MockNetworkInterface iface(name, 0, 0, id);</span>
<span class="udiff-line-added">+       _interfaces.push_front(iface);</span>
<span class="udiff-line-added">+       return _interfaces.front();</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+     static void remove_interface(const MockNetworkInterface&amp; iface) {</span>
<span class="udiff-line-added">+       _interfaces.remove(iface);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+     static void clear_interfaces() {</span>
<span class="udiff-line-added">+       _interfaces.clear();</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+     static const MockNetworkInterface&amp; get_interface(traceid id) {</span>
<span class="udiff-line-added">+       std::list&lt;MockNetworkInterface&gt;::const_iterator i = _interfaces.begin();</span>
<span class="udiff-line-added">+       for (; i != _interfaces.end(); ++i) {</span>
<span class="udiff-line-added">+         if (i-&gt;id == id) {</span>
<span class="udiff-line-added">+           break;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+       }</span>
<span class="udiff-line-added">+       return *i;</span>
<span class="udiff-line-added">+     }</span>
    };
  
<span class="udiff-line-modified-removed">-   MockJfrSerializer* MockJfrSerializer::current;</span>
<span class="udiff-line-modified-added">+   std::list&lt;MockNetworkInterface&gt; MockJfrOSInterface::_interfaces;</span>
  
<span class="udiff-line-modified-removed">-   class MockEventNetworkUtilization : public ::EventNetworkUtilization</span>
<span class="udiff-line-modified-removed">-   {</span>
<span class="udiff-line-removed">-   public:</span>
<span class="udiff-line-modified-added">+   class MockEventNetworkUtilization : public ::EventNetworkUtilization {</span>
<span class="udiff-line-modified-added">+    public:</span>
      std::string iface;
      s8 readRate;
      s8 writeRate;
      static std::vector&lt;MockEventNetworkUtilization&gt; committed;
      MockJfrCheckpointWriter writer;
  
<span class="udiff-line-modified-removed">-   public:</span>
<span class="udiff-line-modified-added">+    public:</span>
      MockEventNetworkUtilization(EventStartTime timing=TIMED) :
<span class="udiff-line-modified-removed">-     ::EventNetworkUtilization(timing) {</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-modified-added">+     ::EventNetworkUtilization(timing) {}</span>
  
      void set_networkInterface(traceid new_value) {
<span class="udiff-line-modified-removed">-       MockJfrSerializer::current-&gt;serialize(writer);</span>
<span class="udiff-line-modified-removed">-       iface = writer.ids[new_value];</span>
<span class="udiff-line-modified-added">+       const MockNetworkInterface&amp; entry  = MockJfrOSInterface::get_interface(new_value);</span>
<span class="udiff-line-modified-added">+       iface = entry.name;</span>
      }
      void set_readRate(s8 new_value) {
        readRate = new_value;
      }
      void set_writeRate(s8 new_value) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -127,11 +180,10 @@</span>
      void commit() {
        committed.push_back(*this);
      }
  
      void set_starttime(const MockJfrTicks&amp; time) {}
<span class="udiff-line-removed">- </span>
      void set_endtime(const MockJfrTicks&amp; time) {}
  
      static const MockEventNetworkUtilization&amp; get_committed(const std::string&amp; name) {
        static MockEventNetworkUtilization placeholder;
        for (std::vector&lt;MockEventNetworkUtilization&gt;::const_iterator i = committed.begin();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -147,66 +199,10 @@</span>
  
    std::vector&lt;MockEventNetworkUtilization&gt; MockEventNetworkUtilization::committed;
  
    jlong MockFastUnorderedElapsedCounterSource::current_ticks;
  
<span class="udiff-line-removed">-   struct MockNetworkInterface {</span>
<span class="udiff-line-removed">-     std::string name;</span>
<span class="udiff-line-removed">-     uint64_t bytes_in;</span>
<span class="udiff-line-removed">-     uint64_t bytes_out;</span>
<span class="udiff-line-removed">-     MockNetworkInterface(std::string name, uint64_t bytes_in, uint64_t bytes_out)</span>
<span class="udiff-line-removed">-     : name(name),</span>
<span class="udiff-line-removed">-     bytes_in(bytes_in),</span>
<span class="udiff-line-removed">-     bytes_out(bytes_out) {</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-     bool operator==(const MockNetworkInterface&amp; rhs) const {</span>
<span class="udiff-line-removed">-       return name == rhs.name;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-   };</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   class NetworkInterface : public ::NetworkInterface {</span>
<span class="udiff-line-removed">-   public:</span>
<span class="udiff-line-removed">-     NetworkInterface(const char* name, uint64_t bytes_in, uint64_t bytes_out, NetworkInterface* next)</span>
<span class="udiff-line-removed">-     : ::NetworkInterface(name, bytes_in, bytes_out, next) {</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-     NetworkInterface* next(void) const {</span>
<span class="udiff-line-removed">-       return reinterpret_cast&lt;NetworkInterface*&gt;(::NetworkInterface::next());</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-   };</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   class MockJfrOSInterface {</span>
<span class="udiff-line-removed">-     static std::list&lt;MockNetworkInterface&gt; _interfaces;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   public:</span>
<span class="udiff-line-removed">-     MockJfrOSInterface() {</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-     static int network_utilization(NetworkInterface** network_interfaces) {</span>
<span class="udiff-line-removed">-       *network_interfaces = NULL;</span>
<span class="udiff-line-removed">-       for (std::list&lt;MockNetworkInterface&gt;::const_iterator i = _interfaces.begin();</span>
<span class="udiff-line-removed">-            i != _interfaces.end();</span>
<span class="udiff-line-removed">-            ++i) {</span>
<span class="udiff-line-removed">-         NetworkInterface* cur = new NetworkInterface(i-&gt;name.c_str(), i-&gt;bytes_in, i-&gt;bytes_out, *network_interfaces);</span>
<span class="udiff-line-removed">-         *network_interfaces = cur;</span>
<span class="udiff-line-removed">-       }</span>
<span class="udiff-line-removed">-       return OS_OK;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-     static MockNetworkInterface&amp; add_interface(const std::string&amp; name) {</span>
<span class="udiff-line-removed">-       MockNetworkInterface iface(name, 0, 0);</span>
<span class="udiff-line-removed">-       _interfaces.push_back(iface);</span>
<span class="udiff-line-removed">-       return _interfaces.back();</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-     static void remove_interface(const MockNetworkInterface&amp; iface) {</span>
<span class="udiff-line-removed">-       _interfaces.remove(iface);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-     static void clear_interfaces() {</span>
<span class="udiff-line-removed">-       _interfaces.clear();</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-   };</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   std::list&lt;MockNetworkInterface&gt; MockJfrOSInterface::_interfaces;</span>
<span class="udiff-line-removed">- </span>
  // Reincluding source files in the anonymous namespace unfortunately seems to
  // behave strangely with precompiled headers (only when using gcc though)
  #ifndef DONT_USE_PRECOMPILED_HEADER
  #define DONT_USE_PRECOMPILED_HEADER
  #endif
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -246,11 +242,11 @@</span>
    }
  };
  
  TEST_VM_F(JfrTestNetworkUtilization, RequestFunctionBasic) {
  
<span class="udiff-line-modified-removed">-   MockNetworkInterface&amp; eth0 = MockJfrOSInterface::add_interface(&quot;eth0&quot;);</span>
<span class="udiff-line-modified-added">+   MockNetworkInterface&amp; eth0 = MockJfrOSInterface::add_interface(&quot;eth0&quot;, 1);</span>
    JfrNetworkUtilization::send_events();
    ASSERT_EQ(0u, MockEventNetworkUtilization::committed.size());
  
    eth0.bytes_in += 10;
    MockFastUnorderedElapsedCounterSource::current_ticks += 2 * NANOSECS_PER_SEC;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -263,13 +259,13 @@</span>
    EXPECT_STREQ(&quot;eth0&quot;, e.iface.c_str());
  }
  
  TEST_VM_F(JfrTestNetworkUtilization, RequestFunctionMultiple) {
  
<span class="udiff-line-modified-removed">-   MockNetworkInterface&amp; eth0 = MockJfrOSInterface::add_interface(&quot;eth0&quot;);</span>
<span class="udiff-line-modified-removed">-   MockNetworkInterface&amp; eth1 = MockJfrOSInterface::add_interface(&quot;eth1&quot;);</span>
<span class="udiff-line-modified-removed">-   MockNetworkInterface&amp; ppp0 = MockJfrOSInterface::add_interface(&quot;ppp0&quot;);</span>
<span class="udiff-line-modified-added">+   MockNetworkInterface&amp; eth0 = MockJfrOSInterface::add_interface(&quot;eth0&quot;, 2);</span>
<span class="udiff-line-modified-added">+   MockNetworkInterface&amp; eth1 = MockJfrOSInterface::add_interface(&quot;eth1&quot;, 3);</span>
<span class="udiff-line-modified-added">+   MockNetworkInterface&amp; ppp0 = MockJfrOSInterface::add_interface(&quot;ppp0&quot;, 4);</span>
    JfrNetworkUtilization::send_events();
    ASSERT_EQ(0u, MockEventNetworkUtilization::committed.size());
  
    eth0.bytes_in += 10;
    eth1.bytes_in += 100;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -294,12 +290,12 @@</span>
    EXPECT_EQ(200, ppp0_event.writeRate);
    EXPECT_STREQ(&quot;ppp0&quot;, ppp0_event.iface.c_str());
  }
  
  TEST_VM_F(JfrTestNetworkUtilization, InterfaceRemoved) {
<span class="udiff-line-modified-removed">-   MockNetworkInterface&amp; eth0 = MockJfrOSInterface::add_interface(&quot;eth0&quot;);</span>
<span class="udiff-line-modified-removed">-   MockNetworkInterface&amp; eth1 = MockJfrOSInterface::add_interface(&quot;eth1&quot;);</span>
<span class="udiff-line-modified-added">+   MockNetworkInterface&amp; eth0 = MockJfrOSInterface::add_interface(&quot;eth0&quot;, 5);</span>
<span class="udiff-line-modified-added">+   MockNetworkInterface&amp; eth1 = MockJfrOSInterface::add_interface(&quot;eth1&quot;, 6);</span>
    JfrNetworkUtilization::send_events();
    ASSERT_EQ(0u, MockEventNetworkUtilization::committed.size());
  
    eth0.bytes_in += 10;
    eth1.bytes_in += 20;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -331,11 +327,11 @@</span>
    EXPECT_EQ(0, eth1_event_v2.writeRate);
    EXPECT_STREQ(&quot;eth1&quot;, eth1_event_v2.iface.c_str());
  }
  
  TEST_VM_F(JfrTestNetworkUtilization, InterfaceReset) {
<span class="udiff-line-modified-removed">-   MockNetworkInterface&amp; eth0 = MockJfrOSInterface::add_interface(&quot;eth0&quot;);</span>
<span class="udiff-line-modified-added">+   MockNetworkInterface&amp; eth0 = MockJfrOSInterface::add_interface(&quot;eth0&quot;, 7);</span>
    JfrNetworkUtilization::send_events();
    ASSERT_EQ(0u, MockEventNetworkUtilization::committed.size());
  
    eth0.bytes_in += 10;
    MockFastUnorderedElapsedCounterSource::current_ticks += 2 * NANOSECS_PER_SEC;
</pre>
<center><a href="../gtestMain.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="test_threadCpuLoad.cpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>