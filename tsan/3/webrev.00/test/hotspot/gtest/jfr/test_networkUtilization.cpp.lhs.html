<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/hotspot/gtest/jfr/test_networkUtilization.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
 23  */
 24 
 25 #include &quot;precompiled.hpp&quot;
 26 
 27 // This test performs mocking of certain JVM functionality. This works by
 28 // including the source file under test inside an anonymous namespace (which
 29 // prevents linking conflicts) with the mocked symbols redefined.
 30 
 31 // The include list should mirror the one found in the included source file -
 32 // with the ones that should pick up the mocks removed. Those should be included
 33 // later after the mocks have been defined.
 34 
 35 #include &quot;logging/log.hpp&quot;
 36 #include &quot;jfr/jfrEvents.hpp&quot;
 37 #include &quot;jfr/metadata/jfrSerializer.hpp&quot;
 38 #include &quot;jfr/periodic/jfrOSInterface.hpp&quot;
 39 #include &quot;jfr/utilities/jfrTime.hpp&quot;
 40 #include &quot;jfr/utilities/jfrTypes.hpp&quot;
 41 #include &quot;runtime/os_perf.hpp&quot;
 42 #include &quot;utilities/globalDefinitions.hpp&quot;
 43 #include &quot;utilities/growableArray.hpp&quot;
 44 
 45 #include &quot;unittest.hpp&quot;
 46 
 47 #include &lt;vector&gt;
 48 #include &lt;list&gt;
 49 #include &lt;map&gt;
 50 
 51 namespace {
 52 
 53   class MockFastUnorderedElapsedCounterSource : public ::FastUnorderedElapsedCounterSource {
<a name="2" id="anc2"></a><span class="line-modified"> 54   public:</span>
 55     static jlong current_ticks;
 56     static Type now() {
 57       return current_ticks;
 58     }
 59     static uint64_t nanoseconds(Type value) {
 60       return value;
 61     }
 62   };
 63 
 64   typedef TimeInstant&lt;CounterRepresentation, MockFastUnorderedElapsedCounterSource&gt; MockJfrTicks;
 65   typedef TimeInterval&lt;CounterRepresentation, MockFastUnorderedElapsedCounterSource&gt; MockJfrTickspan;
 66 
 67   class MockJfrCheckpointWriter {
<a name="3" id="anc3"></a><span class="line-modified"> 68   public:</span>
 69     traceid current;
 70     std::map&lt;traceid, std::string&gt; ids;
 71 
 72     const JfrCheckpointContext context() const {
 73       return JfrCheckpointContext();
 74     }
 75     intptr_t reserve(size_t size) {
 76       return 0;
 77     }
 78     void write_key(traceid id) {
 79       current = id;
 80     }
<a name="4" id="anc4"></a><span class="line-modified"> 81     void write(const char* data) {</span>
<span class="line-modified"> 82       ids[current] = data;</span>
<span class="line-modified"> 83     }</span>
 84     void set_context(const JfrCheckpointContext ctx) { }
<a name="5" id="anc5"></a><span class="line-modified"> 85     void write_count(u4 nof_entries, jlong offset) { }</span>
 86   };
 87 
 88   class MockJfrSerializer {
<a name="6" id="anc6"></a><span class="line-modified"> 89   public:</span>
<span class="line-modified"> 90     static MockJfrSerializer* current;</span>
<span class="line-removed"> 91 </span>
<span class="line-removed"> 92     static bool register_serializer(JfrTypeId id, bool require_safepoint, bool permit_cache, MockJfrSerializer* serializer) {</span>
<span class="line-removed"> 93       current = serializer;</span>
 94       return true;
 95     }
<a name="7" id="anc7"></a>















 96 
<a name="8" id="anc8"></a><span class="line-modified"> 97     virtual void serialize(MockJfrCheckpointWriter&amp; writer) = 0;</span>










































 98   };
 99 
<a name="9" id="anc9"></a><span class="line-modified">100   MockJfrSerializer* MockJfrSerializer::current;</span>
101 
<a name="10" id="anc10"></a><span class="line-modified">102   class MockEventNetworkUtilization : public ::EventNetworkUtilization</span>
<span class="line-modified">103   {</span>
<span class="line-removed">104   public:</span>
105     std::string iface;
106     s8 readRate;
107     s8 writeRate;
108     static std::vector&lt;MockEventNetworkUtilization&gt; committed;
109     MockJfrCheckpointWriter writer;
110 
<a name="11" id="anc11"></a><span class="line-modified">111   public:</span>
112     MockEventNetworkUtilization(EventStartTime timing=TIMED) :
<a name="12" id="anc12"></a><span class="line-modified">113     ::EventNetworkUtilization(timing) {</span>
<span class="line-removed">114     }</span>
115 
116     void set_networkInterface(traceid new_value) {
<a name="13" id="anc13"></a><span class="line-modified">117       MockJfrSerializer::current-&gt;serialize(writer);</span>
<span class="line-modified">118       iface = writer.ids[new_value];</span>
119     }
120     void set_readRate(s8 new_value) {
121       readRate = new_value;
122     }
123     void set_writeRate(s8 new_value) {
124       writeRate = new_value;
125     }
126 
127     void commit() {
128       committed.push_back(*this);
129     }
130 
131     void set_starttime(const MockJfrTicks&amp; time) {}
<a name="14" id="anc14"></a><span class="line-removed">132 </span>
133     void set_endtime(const MockJfrTicks&amp; time) {}
134 
135     static const MockEventNetworkUtilization&amp; get_committed(const std::string&amp; name) {
136       static MockEventNetworkUtilization placeholder;
137       for (std::vector&lt;MockEventNetworkUtilization&gt;::const_iterator i = committed.begin();
138            i != committed.end();
139            ++i) {
140         if (name == i-&gt;iface) {
141           return *i;
142         }
143       }
144       return placeholder;
145     }
146   };
147 
148   std::vector&lt;MockEventNetworkUtilization&gt; MockEventNetworkUtilization::committed;
149 
150   jlong MockFastUnorderedElapsedCounterSource::current_ticks;
151 
<a name="15" id="anc15"></a><span class="line-removed">152   struct MockNetworkInterface {</span>
<span class="line-removed">153     std::string name;</span>
<span class="line-removed">154     uint64_t bytes_in;</span>
<span class="line-removed">155     uint64_t bytes_out;</span>
<span class="line-removed">156     MockNetworkInterface(std::string name, uint64_t bytes_in, uint64_t bytes_out)</span>
<span class="line-removed">157     : name(name),</span>
<span class="line-removed">158     bytes_in(bytes_in),</span>
<span class="line-removed">159     bytes_out(bytes_out) {</span>
<span class="line-removed">160 </span>
<span class="line-removed">161     }</span>
<span class="line-removed">162     bool operator==(const MockNetworkInterface&amp; rhs) const {</span>
<span class="line-removed">163       return name == rhs.name;</span>
<span class="line-removed">164     }</span>
<span class="line-removed">165   };</span>
<span class="line-removed">166 </span>
<span class="line-removed">167   class NetworkInterface : public ::NetworkInterface {</span>
<span class="line-removed">168   public:</span>
<span class="line-removed">169     NetworkInterface(const char* name, uint64_t bytes_in, uint64_t bytes_out, NetworkInterface* next)</span>
<span class="line-removed">170     : ::NetworkInterface(name, bytes_in, bytes_out, next) {</span>
<span class="line-removed">171     }</span>
<span class="line-removed">172     NetworkInterface* next(void) const {</span>
<span class="line-removed">173       return reinterpret_cast&lt;NetworkInterface*&gt;(::NetworkInterface::next());</span>
<span class="line-removed">174     }</span>
<span class="line-removed">175   };</span>
<span class="line-removed">176 </span>
<span class="line-removed">177   class MockJfrOSInterface {</span>
<span class="line-removed">178     static std::list&lt;MockNetworkInterface&gt; _interfaces;</span>
<span class="line-removed">179 </span>
<span class="line-removed">180   public:</span>
<span class="line-removed">181     MockJfrOSInterface() {</span>
<span class="line-removed">182     }</span>
<span class="line-removed">183     static int network_utilization(NetworkInterface** network_interfaces) {</span>
<span class="line-removed">184       *network_interfaces = NULL;</span>
<span class="line-removed">185       for (std::list&lt;MockNetworkInterface&gt;::const_iterator i = _interfaces.begin();</span>
<span class="line-removed">186            i != _interfaces.end();</span>
<span class="line-removed">187            ++i) {</span>
<span class="line-removed">188         NetworkInterface* cur = new NetworkInterface(i-&gt;name.c_str(), i-&gt;bytes_in, i-&gt;bytes_out, *network_interfaces);</span>
<span class="line-removed">189         *network_interfaces = cur;</span>
<span class="line-removed">190       }</span>
<span class="line-removed">191       return OS_OK;</span>
<span class="line-removed">192     }</span>
<span class="line-removed">193     static MockNetworkInterface&amp; add_interface(const std::string&amp; name) {</span>
<span class="line-removed">194       MockNetworkInterface iface(name, 0, 0);</span>
<span class="line-removed">195       _interfaces.push_back(iface);</span>
<span class="line-removed">196       return _interfaces.back();</span>
<span class="line-removed">197     }</span>
<span class="line-removed">198     static void remove_interface(const MockNetworkInterface&amp; iface) {</span>
<span class="line-removed">199       _interfaces.remove(iface);</span>
<span class="line-removed">200     }</span>
<span class="line-removed">201     static void clear_interfaces() {</span>
<span class="line-removed">202       _interfaces.clear();</span>
<span class="line-removed">203     }</span>
<span class="line-removed">204   };</span>
<span class="line-removed">205 </span>
<span class="line-removed">206   std::list&lt;MockNetworkInterface&gt; MockJfrOSInterface::_interfaces;</span>
<span class="line-removed">207 </span>
208 // Reincluding source files in the anonymous namespace unfortunately seems to
209 // behave strangely with precompiled headers (only when using gcc though)
210 #ifndef DONT_USE_PRECOMPILED_HEADER
211 #define DONT_USE_PRECOMPILED_HEADER
212 #endif
213 
214 #define EventNetworkUtilization MockEventNetworkUtilization
215 #define FastUnorderedElapsedCounterSource MockFastUnorderedElapsedCounterSource
216 #define JfrOSInterface MockJfrOSInterface
217 #define JfrSerializer MockJfrSerializer
218 #define JfrCheckpointWriter MockJfrCheckpointWriter
219 #define JfrTicks MockJfrTicks
220 #define JfrTickspan MockJfrTickspan
221 
222 #include &quot;jfr/periodic/jfrNetworkUtilization.hpp&quot;
223 #include &quot;jfr/periodic/jfrNetworkUtilization.cpp&quot;
224 
225 #undef EventNetworkUtilization
226 #undef FastUnorderedElapsedCounterSource
227 #undef JfrOSInterface
228 #undef JfrSerializer
229 #undef JfrCheckpointWriter
230 #undef JfrTicks
231 #undef JfrTickspan
232 
233 } // anonymous namespace
234 
235 class JfrTestNetworkUtilization : public ::testing::Test {
236 protected:
237   void SetUp() {
238     MockEventNetworkUtilization::committed.clear();
239     MockJfrOSInterface::clear_interfaces();
240     // Ensure that tests are separated in time
241     MockFastUnorderedElapsedCounterSource::current_ticks += 1 * NANOSECS_PER_SEC;
242   }
243 
244   void TearDown() {
245     JfrNetworkUtilization::destroy();
246   }
247 };
248 
249 TEST_VM_F(JfrTestNetworkUtilization, RequestFunctionBasic) {
250 
<a name="16" id="anc16"></a><span class="line-modified">251   MockNetworkInterface&amp; eth0 = MockJfrOSInterface::add_interface(&quot;eth0&quot;);</span>
252   JfrNetworkUtilization::send_events();
253   ASSERT_EQ(0u, MockEventNetworkUtilization::committed.size());
254 
255   eth0.bytes_in += 10;
256   MockFastUnorderedElapsedCounterSource::current_ticks += 2 * NANOSECS_PER_SEC;
257 
258   JfrNetworkUtilization::send_events();
259   ASSERT_EQ(1u, MockEventNetworkUtilization::committed.size());
260   MockEventNetworkUtilization&amp; e = MockEventNetworkUtilization::committed[0];
261   EXPECT_EQ(40, e.readRate);
262   EXPECT_EQ(0, e.writeRate);
263   EXPECT_STREQ(&quot;eth0&quot;, e.iface.c_str());
264 }
265 
266 TEST_VM_F(JfrTestNetworkUtilization, RequestFunctionMultiple) {
267 
<a name="17" id="anc17"></a><span class="line-modified">268   MockNetworkInterface&amp; eth0 = MockJfrOSInterface::add_interface(&quot;eth0&quot;);</span>
<span class="line-modified">269   MockNetworkInterface&amp; eth1 = MockJfrOSInterface::add_interface(&quot;eth1&quot;);</span>
<span class="line-modified">270   MockNetworkInterface&amp; ppp0 = MockJfrOSInterface::add_interface(&quot;ppp0&quot;);</span>
271   JfrNetworkUtilization::send_events();
272   ASSERT_EQ(0u, MockEventNetworkUtilization::committed.size());
273 
274   eth0.bytes_in += 10;
275   eth1.bytes_in += 100;
276   ppp0.bytes_out += 50;
277   MockFastUnorderedElapsedCounterSource::current_ticks += 2 * NANOSECS_PER_SEC;
278 
279   JfrNetworkUtilization::send_events();
280   ASSERT_EQ(3u, MockEventNetworkUtilization::committed.size());
281   const MockEventNetworkUtilization&amp; eth0_event = MockEventNetworkUtilization::get_committed(&quot;eth0&quot;);
282   const MockEventNetworkUtilization&amp; eth1_event = MockEventNetworkUtilization::get_committed(&quot;eth1&quot;);
283   const MockEventNetworkUtilization&amp; ppp0_event = MockEventNetworkUtilization::get_committed(&quot;ppp0&quot;);
284 
285   EXPECT_EQ(40, eth0_event.readRate);
286   EXPECT_EQ(0, eth0_event.writeRate);
287   EXPECT_STREQ(&quot;eth0&quot;, eth0_event.iface.c_str());
288 
289   EXPECT_EQ(400, eth1_event.readRate);
290   EXPECT_EQ(0, eth1_event.writeRate);
291   EXPECT_STREQ(&quot;eth1&quot;, eth1_event.iface.c_str());
292 
293   EXPECT_EQ(0, ppp0_event.readRate);
294   EXPECT_EQ(200, ppp0_event.writeRate);
295   EXPECT_STREQ(&quot;ppp0&quot;, ppp0_event.iface.c_str());
296 }
297 
298 TEST_VM_F(JfrTestNetworkUtilization, InterfaceRemoved) {
<a name="18" id="anc18"></a><span class="line-modified">299   MockNetworkInterface&amp; eth0 = MockJfrOSInterface::add_interface(&quot;eth0&quot;);</span>
<span class="line-modified">300   MockNetworkInterface&amp; eth1 = MockJfrOSInterface::add_interface(&quot;eth1&quot;);</span>
301   JfrNetworkUtilization::send_events();
302   ASSERT_EQ(0u, MockEventNetworkUtilization::committed.size());
303 
304   eth0.bytes_in += 10;
305   eth1.bytes_in += 20;
306   MockFastUnorderedElapsedCounterSource::current_ticks += 2 * NANOSECS_PER_SEC;
307 
308   JfrNetworkUtilization::send_events();
309   ASSERT_EQ(2u, MockEventNetworkUtilization::committed.size());
310   const MockEventNetworkUtilization&amp; eth0_event = MockEventNetworkUtilization::get_committed(&quot;eth0&quot;);
311   const MockEventNetworkUtilization&amp; eth1_event = MockEventNetworkUtilization::get_committed(&quot;eth1&quot;);
312 
313   EXPECT_EQ(40, eth0_event.readRate);
314   EXPECT_EQ(0, eth0_event.writeRate);
315   EXPECT_STREQ(&quot;eth0&quot;, eth0_event.iface.c_str());
316 
317   EXPECT_EQ(80, eth1_event.readRate);
318   EXPECT_EQ(0, eth1_event.writeRate);
319   EXPECT_STREQ(&quot;eth1&quot;, eth1_event.iface.c_str());
320 
321   MockJfrOSInterface::remove_interface(eth0);
322   MockEventNetworkUtilization::committed.clear();
323 
324   eth1.bytes_in += 10;
325   MockFastUnorderedElapsedCounterSource::current_ticks += 2 * NANOSECS_PER_SEC;
326   JfrNetworkUtilization::send_events();
327   ASSERT_EQ(1u, MockEventNetworkUtilization::committed.size());
328   const MockEventNetworkUtilization&amp; eth1_event_v2 = MockEventNetworkUtilization::get_committed(&quot;eth1&quot;);
329 
330   EXPECT_EQ(40, eth1_event_v2.readRate);
331   EXPECT_EQ(0, eth1_event_v2.writeRate);
332   EXPECT_STREQ(&quot;eth1&quot;, eth1_event_v2.iface.c_str());
333 }
334 
335 TEST_VM_F(JfrTestNetworkUtilization, InterfaceReset) {
<a name="19" id="anc19"></a><span class="line-modified">336   MockNetworkInterface&amp; eth0 = MockJfrOSInterface::add_interface(&quot;eth0&quot;);</span>
337   JfrNetworkUtilization::send_events();
338   ASSERT_EQ(0u, MockEventNetworkUtilization::committed.size());
339 
340   eth0.bytes_in += 10;
341   MockFastUnorderedElapsedCounterSource::current_ticks += 2 * NANOSECS_PER_SEC;
342 
343   JfrNetworkUtilization::send_events();
344   ASSERT_EQ(1u, MockEventNetworkUtilization::committed.size());
345   const MockEventNetworkUtilization&amp; event = MockEventNetworkUtilization::committed[0];
346   EXPECT_EQ(40, event.readRate);
347   EXPECT_EQ(0, event.writeRate);
348   EXPECT_STREQ(&quot;eth0&quot;, event.iface.c_str());
349 
350   eth0.bytes_in = 0;
351   MockFastUnorderedElapsedCounterSource::current_ticks += 2 * NANOSECS_PER_SEC;
352   MockEventNetworkUtilization::committed.clear();
353 
354   JfrNetworkUtilization::send_events();
355   ASSERT_EQ(0u, MockEventNetworkUtilization::committed.size());
356 
357   eth0.bytes_in = 10;
358   MockFastUnorderedElapsedCounterSource::current_ticks += 2 * NANOSECS_PER_SEC;
359 
360   JfrNetworkUtilization::send_events();
361   ASSERT_EQ(1u, MockEventNetworkUtilization::committed.size());
362   const MockEventNetworkUtilization&amp; event_v2 = MockEventNetworkUtilization::committed[0];
363   EXPECT_EQ(40, event_v2.readRate);
364   EXPECT_EQ(0, event_v2.writeRate);
365   EXPECT_STREQ(&quot;eth0&quot;, event_v2.iface.c_str());
366 }
<a name="20" id="anc20"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="20" type="hidden" />
</body>
</html>