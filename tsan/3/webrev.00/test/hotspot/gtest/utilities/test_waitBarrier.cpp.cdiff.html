<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff test/hotspot/gtest/utilities/test_waitBarrier.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="test_singleWriterSynchronizer.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="../../jtreg/ProblemList-graal.txt.cdiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/gtest/utilities/test_waitBarrier.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 47,24 ***</span>
      _wrt_start-&gt;signal();
      int vv, tag;
      // Similar to how a JavaThread would stop in a safepoint.
      while (!_exit) {
        // Load the published tag.
<span class="line-modified">!       tag = OrderAccess::load_acquire(&amp;wait_tag);</span>
        // Publish the tag this thread is going to wait for.
<span class="line-modified">!       OrderAccess::release_store(&amp;_on_barrier, tag);</span>
        if (_on_barrier == 0) {
          SpinPause();
          continue;
        }
        OrderAccess::storeload(); // Loads in WB must not float up.
        // Wait until we are woken.
        _wait_barrier-&gt;wait(tag);
        // Verify that we do not see an invalid value.
<span class="line-modified">!       vv = OrderAccess::load_acquire(&amp;valid_value);</span>
        ASSERT_EQ((vv &amp; 0x1), 0);
<span class="line-modified">!       OrderAccess::release_store(&amp;_on_barrier, 0);</span>
      }
    }
  };
  
  template &lt;typename WaitBarrierImpl&gt;
<span class="line-new-header">--- 47,24 ---</span>
      _wrt_start-&gt;signal();
      int vv, tag;
      // Similar to how a JavaThread would stop in a safepoint.
      while (!_exit) {
        // Load the published tag.
<span class="line-modified">!       tag = Atomic::load_acquire(&amp;wait_tag);</span>
        // Publish the tag this thread is going to wait for.
<span class="line-modified">!       Atomic::release_store(&amp;_on_barrier, tag);</span>
        if (_on_barrier == 0) {
          SpinPause();
          continue;
        }
        OrderAccess::storeload(); // Loads in WB must not float up.
        // Wait until we are woken.
        _wait_barrier-&gt;wait(tag);
        // Verify that we do not see an invalid value.
<span class="line-modified">!       vv = Atomic::load_acquire(&amp;valid_value);</span>
        ASSERT_EQ((vv &amp; 0x1), 0);
<span class="line-modified">!       Atomic::release_store(&amp;_on_barrier, 0);</span>
      }
    }
  };
  
  template &lt;typename WaitBarrierImpl&gt;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 102,27 ***</span>
      // Similar to how the VM thread would use a WaitBarrier in a safepoint.
      while (stop_ms &gt; os::javaTimeMillis()) {
        // Arm next tag.
        wb.arm(next_tag);
        // Publish tag.
<span class="line-modified">!       OrderAccess::release_store_fence(&amp;wait_tag, next_tag);</span>
  
        // Wait until threads picked up new tag.
        while (reader1-&gt;_on_barrier != wait_tag ||
               reader2-&gt;_on_barrier != wait_tag ||
               reader3-&gt;_on_barrier != wait_tag ||
               reader4-&gt;_on_barrier != wait_tag) {
          SpinPause();
        }
  
        // Set an invalid value.
<span class="line-modified">!       OrderAccess::release_store(&amp;valid_value, valid_value + 1); // odd</span>
        os::naked_yield();
        // Set a valid value.
<span class="line-modified">!       OrderAccess::release_store(&amp;valid_value, valid_value + 1); // even</span>
        // Publish inactive tag.
<span class="line-modified">!       OrderAccess::release_store_fence(&amp;wait_tag, 0); // Stores in WB must not float up.</span>
        wb.disarm();
  
        // Wait until threads done valid_value verification.
        while (reader1-&gt;_on_barrier != 0 ||
               reader2-&gt;_on_barrier != 0 ||
<span class="line-new-header">--- 102,27 ---</span>
      // Similar to how the VM thread would use a WaitBarrier in a safepoint.
      while (stop_ms &gt; os::javaTimeMillis()) {
        // Arm next tag.
        wb.arm(next_tag);
        // Publish tag.
<span class="line-modified">!       Atomic::release_store_fence(&amp;wait_tag, next_tag);</span>
  
        // Wait until threads picked up new tag.
        while (reader1-&gt;_on_barrier != wait_tag ||
               reader2-&gt;_on_barrier != wait_tag ||
               reader3-&gt;_on_barrier != wait_tag ||
               reader4-&gt;_on_barrier != wait_tag) {
          SpinPause();
        }
  
        // Set an invalid value.
<span class="line-modified">!       Atomic::release_store(&amp;valid_value, valid_value + 1); // odd</span>
        os::naked_yield();
        // Set a valid value.
<span class="line-modified">!       Atomic::release_store(&amp;valid_value, valid_value + 1); // even</span>
        // Publish inactive tag.
<span class="line-modified">!       Atomic::release_store_fence(&amp;wait_tag, 0); // Stores in WB must not float up.</span>
        wb.disarm();
  
        // Wait until threads done valid_value verification.
        while (reader1-&gt;_on_barrier != 0 ||
               reader2-&gt;_on_barrier != 0 ||
</pre>
<center><a href="test_singleWriterSynchronizer.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="../../jtreg/ProblemList-graal.txt.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>