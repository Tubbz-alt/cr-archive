<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff test/hotspot/gtest/runtime/test_synchronizer.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="test_os_windows.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="../threadHelper.inline.hpp.cdiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/gtest/runtime/test_synchronizer.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2018, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2018, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 28,42 ***</span>
  #include &quot;unittest.hpp&quot;
  
  class SynchronizerTest : public ::testing::Test {
    public:
      static u_char* get_gvars_addr() { return ObjectSynchronizer::get_gvars_addr(); }
<span class="line-modified">!     static u_char* get_gvars_hcSequence_addr() { return ObjectSynchronizer::get_gvars_hcSequence_addr(); }</span>
      static size_t get_gvars_size() { return ObjectSynchronizer::get_gvars_size(); }
<span class="line-modified">!     static u_char* get_gvars_stwRandom_addr() { return ObjectSynchronizer::get_gvars_stwRandom_addr(); }</span>
  };
  
  TEST_VM(SynchronizerTest, sanity) {
    uint cache_line_size = VM_Version::L1_data_cache_line_size();
    if (cache_line_size != 0) {
      // We were able to determine the L1 data cache line size so
      // do some cache line specific sanity checks
  
      u_char *addr_begin = SynchronizerTest::get_gvars_addr();
<span class="line-modified">!     u_char *addr_stwRandom = SynchronizerTest::get_gvars_stwRandom_addr();</span>
<span class="line-modified">!     u_char *addr_hcSequence = SynchronizerTest::get_gvars_hcSequence_addr();</span>
      size_t gvars_size = SynchronizerTest::get_gvars_size();
  
<span class="line-modified">!     uint offset_stwRandom = (uint) (addr_stwRandom - addr_begin);</span>
<span class="line-modified">!     uint offset_hcSequence = (uint) (addr_hcSequence - addr_begin);</span>
<span class="line-modified">!     uint offset_hcSequence_stwRandom = offset_hcSequence - offset_stwRandom;</span>
<span class="line-modified">!     uint offset_hcSequence_struct_end = (uint) gvars_size - offset_hcSequence;</span>
  
<span class="line-modified">!     EXPECT_GE(offset_stwRandom, cache_line_size)</span>
<span class="line-modified">!             &lt;&lt; &quot;the SharedGlobals.stwRandom field is closer &quot;</span>
              &lt;&lt; &quot;to the struct beginning than a cache line which permits &quot;
              &lt;&lt; &quot;false sharing.&quot;;
  
<span class="line-modified">!     EXPECT_GE(offset_hcSequence_stwRandom, cache_line_size)</span>
<span class="line-modified">!             &lt;&lt; &quot;the SharedGlobals.stwRandom and &quot;</span>
<span class="line-modified">!             &lt;&lt; &quot;SharedGlobals.hcSequence fields are closer than a cache &quot;</span>
              &lt;&lt; &quot;line which permits false sharing.&quot;;
  
<span class="line-modified">!     EXPECT_GE(offset_hcSequence_struct_end, cache_line_size)</span>
<span class="line-modified">!             &lt;&lt; &quot;the SharedGlobals.hcSequence field is closer &quot;</span>
              &lt;&lt; &quot;to the struct end than a cache line which permits false &quot;
              &lt;&lt; &quot;sharing.&quot;;
    }
  }
<span class="line-new-header">--- 28,42 ---</span>
  #include &quot;unittest.hpp&quot;
  
  class SynchronizerTest : public ::testing::Test {
    public:
      static u_char* get_gvars_addr() { return ObjectSynchronizer::get_gvars_addr(); }
<span class="line-modified">!     static u_char* get_gvars_hc_sequence_addr() { return ObjectSynchronizer::get_gvars_hc_sequence_addr(); }</span>
      static size_t get_gvars_size() { return ObjectSynchronizer::get_gvars_size(); }
<span class="line-modified">!     static u_char* get_gvars_stw_random_addr() { return ObjectSynchronizer::get_gvars_stw_random_addr(); }</span>
  };
  
  TEST_VM(SynchronizerTest, sanity) {
    uint cache_line_size = VM_Version::L1_data_cache_line_size();
    if (cache_line_size != 0) {
      // We were able to determine the L1 data cache line size so
      // do some cache line specific sanity checks
  
      u_char *addr_begin = SynchronizerTest::get_gvars_addr();
<span class="line-modified">!     u_char *addr_stw_random = SynchronizerTest::get_gvars_stw_random_addr();</span>
<span class="line-modified">!     u_char *addr_hc_sequence = SynchronizerTest::get_gvars_hc_sequence_addr();</span>
      size_t gvars_size = SynchronizerTest::get_gvars_size();
  
<span class="line-modified">!     uint offset_stw_random = (uint) (addr_stw_random - addr_begin);</span>
<span class="line-modified">!     uint offset_hc_sequence = (uint) (addr_hc_sequence - addr_begin);</span>
<span class="line-modified">!     uint offset_hc_sequence_stw_random = offset_hc_sequence - offset_stw_random;</span>
<span class="line-modified">!     uint offset_hc_sequence_struct_end = (uint) gvars_size - offset_hc_sequence;</span>
  
<span class="line-modified">!     EXPECT_GE(offset_stw_random, cache_line_size)</span>
<span class="line-modified">!             &lt;&lt; &quot;the SharedGlobals.stw_random field is closer &quot;</span>
              &lt;&lt; &quot;to the struct beginning than a cache line which permits &quot;
              &lt;&lt; &quot;false sharing.&quot;;
  
<span class="line-modified">!     EXPECT_GE(offset_hc_sequence_stw_random, cache_line_size)</span>
<span class="line-modified">!             &lt;&lt; &quot;the SharedGlobals.stw_random and &quot;</span>
<span class="line-modified">!             &lt;&lt; &quot;SharedGlobals.hc_sequence fields are closer than a cache &quot;</span>
              &lt;&lt; &quot;line which permits false sharing.&quot;;
  
<span class="line-modified">!     EXPECT_GE(offset_hc_sequence_struct_end, cache_line_size)</span>
<span class="line-modified">!             &lt;&lt; &quot;the SharedGlobals.hc_sequence field is closer &quot;</span>
              &lt;&lt; &quot;to the struct end than a cache line which permits false &quot;
              &lt;&lt; &quot;sharing.&quot;;
    }
  }
</pre>
<center><a href="test_os_windows.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="../threadHelper.inline.hpp.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>