<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff test/hotspot/gtest/gc/g1/test_g1Predictions.cpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="test_g1HeapVerifier.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="test_heapRegion.cpp.cdiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/gtest/gc/g1/test_g1Predictions.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2016, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2016, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 24,52 ***</span>
  
  #include &quot;precompiled.hpp&quot;
  #include &quot;gc/g1/g1Predictions.hpp&quot;
  #include &quot;unittest.hpp&quot;
  
  static const double epsilon = 1e-6;
  
  // Some basic formula tests with confidence = 0.0
  TEST_VM(G1Predictions, basic_predictions) {
    G1Predictions predictor(0.0);
    TruncatedSeq s;
  
<span class="line-modified">!   double p0 = predictor.get_new_prediction(&amp;s);</span>
    ASSERT_LT(p0, epsilon) &lt;&lt; &quot;Initial prediction of empty sequence must be 0.0&quot;;
  
    s.add(5.0);
<span class="line-modified">!   double p1 = predictor.get_new_prediction(&amp;s);</span>
    ASSERT_NEAR(p1, 5.0, epsilon);
  
    for (int i = 0; i &lt; 40; i++) {
      s.add(5.0);
    }
<span class="line-modified">!   double p2 = predictor.get_new_prediction(&amp;s);</span>
    ASSERT_NEAR(p2, 5.0, epsilon);
  }
  
  // The following tests checks that the initial predictions are based on
  // the average of the sequence and not on the stddev (which is 0).
  TEST_VM(G1Predictions, average_not_stdev_predictions) {
    G1Predictions predictor(0.5);
    TruncatedSeq s;
  
    s.add(1.0);
<span class="line-modified">!   double p1 = predictor.get_new_prediction(&amp;s);</span>
    ASSERT_GT(p1, s.davg()) &lt;&lt; &quot;First prediction must be greater than average&quot;;
  
    s.add(1.0);
<span class="line-modified">!   double p2 = predictor.get_new_prediction(&amp;s);</span>
    ASSERT_GT(p1, p2) &lt;&lt; &quot;First prediction must be greater than second&quot;;
  
    s.add(1.0);
<span class="line-modified">!   double p3 = predictor.get_new_prediction(&amp;s);</span>
    ASSERT_GT(p2, p3) &lt;&lt; &quot;Second prediction must be greater than third&quot;;
  
    s.add(1.0);
    s.add(1.0); // Five elements are now in the sequence.
<span class="line-modified">!   double p4 = predictor.get_new_prediction(&amp;s);</span>
    ASSERT_LT(p4, p3) &lt;&lt; &quot;Fourth prediction must be smaller than third&quot;;
    ASSERT_NEAR(p4, 1.0, epsilon);
  }
  
  // The following tests checks that initially prediction based on
<span class="line-new-header">--- 24,54 ---</span>
  
  #include &quot;precompiled.hpp&quot;
  #include &quot;gc/g1/g1Predictions.hpp&quot;
  #include &quot;unittest.hpp&quot;
  
<span class="line-added">+ #include &quot;utilities/ostream.hpp&quot;</span>
<span class="line-added">+ </span>
  static const double epsilon = 1e-6;
  
  // Some basic formula tests with confidence = 0.0
  TEST_VM(G1Predictions, basic_predictions) {
    G1Predictions predictor(0.0);
    TruncatedSeq s;
  
<span class="line-modified">!   double p0 = predictor.predict(&amp;s);</span>
    ASSERT_LT(p0, epsilon) &lt;&lt; &quot;Initial prediction of empty sequence must be 0.0&quot;;
  
    s.add(5.0);
<span class="line-modified">!   double p1 = predictor.predict(&amp;s);</span>
    ASSERT_NEAR(p1, 5.0, epsilon);
  
    for (int i = 0; i &lt; 40; i++) {
      s.add(5.0);
    }
<span class="line-modified">!   double p2 = predictor.predict(&amp;s);</span>
    ASSERT_NEAR(p2, 5.0, epsilon);
  }
  
  // The following tests checks that the initial predictions are based on
  // the average of the sequence and not on the stddev (which is 0).
  TEST_VM(G1Predictions, average_not_stdev_predictions) {
    G1Predictions predictor(0.5);
    TruncatedSeq s;
  
    s.add(1.0);
<span class="line-modified">!   double p1 = predictor.predict(&amp;s);</span>
    ASSERT_GT(p1, s.davg()) &lt;&lt; &quot;First prediction must be greater than average&quot;;
  
    s.add(1.0);
<span class="line-modified">!   double p2 = predictor.predict(&amp;s);</span>
    ASSERT_GT(p1, p2) &lt;&lt; &quot;First prediction must be greater than second&quot;;
  
    s.add(1.0);
<span class="line-modified">!   double p3 = predictor.predict(&amp;s);</span>
    ASSERT_GT(p2, p3) &lt;&lt; &quot;Second prediction must be greater than third&quot;;
  
    s.add(1.0);
    s.add(1.0); // Five elements are now in the sequence.
<span class="line-modified">!   double p4 = predictor.predict(&amp;s);</span>
    ASSERT_LT(p4, p3) &lt;&lt; &quot;Fourth prediction must be smaller than third&quot;;
    ASSERT_NEAR(p4, 1.0, epsilon);
  }
  
  // The following tests checks that initially prediction based on
</pre>
<hr />
<pre>
<span class="line-old-header">*** 78,21 ***</span>
  TEST_VM(G1Predictions, average_stdev_predictions) {
    G1Predictions predictor(0.5);
    TruncatedSeq s;
  
    s.add(0.5);
<span class="line-modified">!   double p1 = predictor.get_new_prediction(&amp;s);</span>
    ASSERT_GT(p1, s.davg()) &lt;&lt; &quot;First prediction must be greater than average&quot;;
  
    s.add(0.2);
<span class="line-modified">!   double p2 = predictor.get_new_prediction(&amp;s);</span>
    ASSERT_GT(p1, p2) &lt;&lt; &quot;First prediction must be greater than second&quot;;
  
    s.add(0.5);
<span class="line-modified">!   double p3 = predictor.get_new_prediction(&amp;s);</span>
    ASSERT_GT(p2, p3) &lt;&lt; &quot;Second prediction must be greater than third&quot;;
  
    s.add(0.2);
    s.add(2.0);
<span class="line-modified">!   double p4 = predictor.get_new_prediction(&amp;s);</span>
    ASSERT_GT(p4, p3) &lt;&lt; &quot;Fourth prediction must be greater than third&quot;;
  }
<span class="line-new-header">--- 80,69 ---</span>
  TEST_VM(G1Predictions, average_stdev_predictions) {
    G1Predictions predictor(0.5);
    TruncatedSeq s;
  
    s.add(0.5);
<span class="line-modified">!   double p1 = predictor.predict(&amp;s);</span>
    ASSERT_GT(p1, s.davg()) &lt;&lt; &quot;First prediction must be greater than average&quot;;
  
    s.add(0.2);
<span class="line-modified">!   double p2 = predictor.predict(&amp;s);</span>
    ASSERT_GT(p1, p2) &lt;&lt; &quot;First prediction must be greater than second&quot;;
  
    s.add(0.5);
<span class="line-modified">!   double p3 = predictor.predict(&amp;s);</span>
    ASSERT_GT(p2, p3) &lt;&lt; &quot;Second prediction must be greater than third&quot;;
  
    s.add(0.2);
    s.add(2.0);
<span class="line-modified">!   double p4 = predictor.predict(&amp;s);</span>
    ASSERT_GT(p4, p3) &lt;&lt; &quot;Fourth prediction must be greater than third&quot;;
  }
<span class="line-added">+ </span>
<span class="line-added">+ // Some tests to verify bounding between [0 .. 1]</span>
<span class="line-added">+ TEST_VM(G1Predictions, unit_predictions) {</span>
<span class="line-added">+   G1Predictions predictor(0.5);</span>
<span class="line-added">+   TruncatedSeq s;</span>
<span class="line-added">+ </span>
<span class="line-added">+   double p0 = predictor.predict_in_unit_interval(&amp;s);</span>
<span class="line-added">+   ASSERT_LT(p0, epsilon) &lt;&lt; &quot;Initial prediction of empty sequence must be 0.0&quot;;</span>
<span class="line-added">+ </span>
<span class="line-added">+   s.add(100.0);</span>
<span class="line-added">+   double p1 = predictor.predict_in_unit_interval(&amp;s);</span>
<span class="line-added">+   ASSERT_NEAR(p1, 1.0, epsilon);</span>
<span class="line-added">+ </span>
<span class="line-added">+   // Feed the sequence additional positive values to test the high bound.</span>
<span class="line-added">+   for (int i = 0; i &lt; 3; i++) {</span>
<span class="line-added">+     s.add(2.0);</span>
<span class="line-added">+   }</span>
<span class="line-added">+   ASSERT_NEAR(predictor.predict_in_unit_interval(&amp;s), 1.0, epsilon);</span>
<span class="line-added">+ </span>
<span class="line-added">+   // Feed the sequence additional large negative value to test the low bound.</span>
<span class="line-added">+   for (int i = 0; i &lt; 4; i++) {</span>
<span class="line-added">+     s.add(-200.0);</span>
<span class="line-added">+   }</span>
<span class="line-added">+   ASSERT_NEAR(predictor.predict_in_unit_interval(&amp;s), 0.0, epsilon);</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ // Some tests to verify bounding between [0 .. +inf]</span>
<span class="line-added">+ TEST_VM(G1Predictions, lower_bound_zero_predictions) {</span>
<span class="line-added">+   G1Predictions predictor(0.5);</span>
<span class="line-added">+   TruncatedSeq s;</span>
<span class="line-added">+ </span>
<span class="line-added">+   double p0 = predictor.predict_zero_bounded(&amp;s);</span>
<span class="line-added">+   ASSERT_LT(p0, epsilon) &lt;&lt; &quot;Initial prediction of empty sequence must be 0.0&quot;;</span>
<span class="line-added">+ </span>
<span class="line-added">+   s.add(100.0);</span>
<span class="line-added">+   // Feed the sequence additional positive values to see that the high bound is not</span>
<span class="line-added">+   // bounded by e.g. 1.0</span>
<span class="line-added">+   for (int i = 0; i &lt; 3; i++) {</span>
<span class="line-added">+     s.add(2.0);</span>
<span class="line-added">+   }</span>
<span class="line-added">+   ASSERT_GT(predictor.predict_zero_bounded(&amp;s), 1.0);</span>
<span class="line-added">+ </span>
<span class="line-added">+   // Feed the sequence additional large negative value to test the low bound.</span>
<span class="line-added">+   for (int i = 0; i &lt; 4; i++) {</span>
<span class="line-added">+     s.add(-200.0);</span>
<span class="line-added">+   }</span>
<span class="line-added">+   ASSERT_NEAR(predictor.predict_zero_bounded(&amp;s), 0.0, epsilon);</span>
<span class="line-added">+ }</span>
</pre>
<center><a href="test_g1HeapVerifier.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="test_heapRegion.cpp.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>