<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff test/hotspot/gtest/gc/shared/test_preservedMarks.cpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="test_oopStorage.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="test_ptrQueueBufferAllocator.cpp.cdiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/gtest/gc/shared/test_preservedMarks.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2017, 2018 Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2017, 2018, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 40,21 ***</span>
  
  public:
    FakeOop() : _oop() { _oop.set_mark_raw(originalMark()); }
  
    oop get_oop() { return &amp;_oop; }
<span class="line-modified">!   markOop mark() { return _oop.mark_raw(); }</span>
<span class="line-modified">!   void set_mark(markOop m) { _oop.set_mark_raw(m); }</span>
    void forward_to(oop obj) {
<span class="line-modified">!     markOop m = markOopDesc::encode_pointer_as_mark(obj);</span>
      _oop.set_mark_raw(m);
    }
  
<span class="line-modified">!   static markOop originalMark() { return markOop(markOopDesc::lock_mask_in_place); }</span>
<span class="line-modified">!   static markOop changedMark()  { return markOop(0x4711); }</span>
  };
  
  TEST_VM(PreservedMarks, iterate_and_restore) {
    // Need to disable biased locking to easily
    // create oops that &quot;must_be_preseved&quot;
    ScopedDisabledBiasedLocking dbl;
  
<span class="line-new-header">--- 40,23 ---</span>
  
  public:
    FakeOop() : _oop() { _oop.set_mark_raw(originalMark()); }
  
    oop get_oop() { return &amp;_oop; }
<span class="line-modified">!   markWord mark() { return _oop.mark_raw(); }</span>
<span class="line-modified">!   void set_mark(markWord m) { _oop.set_mark_raw(m); }</span>
    void forward_to(oop obj) {
<span class="line-modified">!     markWord m = markWord::encode_pointer_as_mark(obj);</span>
      _oop.set_mark_raw(m);
    }
  
<span class="line-modified">!   static markWord originalMark() { return markWord(markWord::lock_mask_in_place); }</span>
<span class="line-modified">!   static markWord changedMark()  { return markWord(0x4711); }</span>
  };
  
<span class="line-added">+ #define ASSERT_MARK_WORD_EQ(a, b) ASSERT_EQ((a).value(), (b).value())</span>
<span class="line-added">+ </span>
  TEST_VM(PreservedMarks, iterate_and_restore) {
    // Need to disable biased locking to easily
    // create oops that &quot;must_be_preseved&quot;
    ScopedDisabledBiasedLocking dbl;
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 63,20 ***</span>
    FakeOop o2;
    FakeOop o3;
    FakeOop o4;
  
    // Make sure initial marks are correct.
<span class="line-modified">!   ASSERT_EQ(o1.mark(), FakeOop::originalMark());</span>
<span class="line-modified">!   ASSERT_EQ(o2.mark(), FakeOop::originalMark());</span>
<span class="line-modified">!   ASSERT_EQ(o3.mark(), FakeOop::originalMark());</span>
<span class="line-modified">!   ASSERT_EQ(o4.mark(), FakeOop::originalMark());</span>
  
    // Change the marks and verify change.
    o1.set_mark(FakeOop::changedMark());
    o2.set_mark(FakeOop::changedMark());
<span class="line-modified">!   ASSERT_EQ(o1.mark(), FakeOop::changedMark());</span>
<span class="line-modified">!   ASSERT_EQ(o2.mark(), FakeOop::changedMark());</span>
  
    // Push o1 and o2 to have their marks preserved.
    pm.push(o1.get_oop(), o1.mark());
    pm.push(o2.get_oop(), o2.mark());
  
<span class="line-new-header">--- 65,20 ---</span>
    FakeOop o2;
    FakeOop o3;
    FakeOop o4;
  
    // Make sure initial marks are correct.
<span class="line-modified">!   ASSERT_MARK_WORD_EQ(o1.mark(), FakeOop::originalMark());</span>
<span class="line-modified">!   ASSERT_MARK_WORD_EQ(o2.mark(), FakeOop::originalMark());</span>
<span class="line-modified">!   ASSERT_MARK_WORD_EQ(o3.mark(), FakeOop::originalMark());</span>
<span class="line-modified">!   ASSERT_MARK_WORD_EQ(o4.mark(), FakeOop::originalMark());</span>
  
    // Change the marks and verify change.
    o1.set_mark(FakeOop::changedMark());
    o2.set_mark(FakeOop::changedMark());
<span class="line-modified">!   ASSERT_MARK_WORD_EQ(o1.mark(), FakeOop::changedMark());</span>
<span class="line-modified">!   ASSERT_MARK_WORD_EQ(o2.mark(), FakeOop::changedMark());</span>
  
    // Push o1 and o2 to have their marks preserved.
    pm.push(o1.get_oop(), o1.mark());
    pm.push(o2.get_oop(), o2.mark());
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 90,8 ***</span>
    pm.adjust_during_full_gc();
  
    // Restore all preserved and verify that the changed
    // mark is now present at o3 and o4.
    pm.restore();
<span class="line-modified">!   ASSERT_EQ(o3.mark(), FakeOop::changedMark());</span>
<span class="line-modified">!   ASSERT_EQ(o4.mark(), FakeOop::changedMark());</span>
  }
<span class="line-new-header">--- 92,8 ---</span>
    pm.adjust_during_full_gc();
  
    // Restore all preserved and verify that the changed
    // mark is now present at o3 and o4.
    pm.restore();
<span class="line-modified">!   ASSERT_MARK_WORD_EQ(o3.mark(), FakeOop::changedMark());</span>
<span class="line-modified">!   ASSERT_MARK_WORD_EQ(o4.mark(), FakeOop::changedMark());</span>
  }
</pre>
<center><a href="test_oopStorage.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="test_ptrQueueBufferAllocator.cpp.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>