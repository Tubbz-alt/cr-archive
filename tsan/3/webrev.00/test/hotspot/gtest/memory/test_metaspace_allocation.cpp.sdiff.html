<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/hotspot/gtest/memory/test_metaspace_allocation.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="test_metaspace.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="../runtime/test_globals.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/gtest/memory/test_metaspace_allocation.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * Copyright (c) 2018, SAP.
  4  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  5  *
  6  * This code is free software; you can redistribute it and/or modify it
  7  * under the terms of the GNU General Public License version 2 only, as
  8  * published by the Free Software Foundation.
  9  *
 10  * This code is distributed in the hope that it will be useful, but WITHOUT
 11  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 12  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 13  * version 2 for more details (a copy is included in the LICENSE file that
 14  * accompanied this code).
 15  *
 16  * You should have received a copy of the GNU General Public License version
 17  * 2 along with this work; if not, write to the Free Software Foundation,
 18  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 19  *
 20  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 21  * or visit www.oracle.com if you need additional information or have any
 22  * questions.
</pre>
<hr />
<pre>
 91       if (_spaces[i].space != NULL) {
 92         delete _spaces[i].space;
 93         delete _spaces[i].lock;
 94       }
 95     }
 96   }
 97 
 98   void create_space(int i) {
 99     assert(i &gt;= 0 &amp;&amp; i &lt; NUM_PARALLEL_METASPACES, &quot;Sanity&quot;);
100     assert(_spaces[i].space == NULL &amp;&amp; _spaces[i].allocated == 0, &quot;Sanity&quot;);
101     if (_spaces[i].lock == NULL) {
102       _spaces[i].lock = new Mutex(Monitor::native, &quot;gtest-MetaspaceAllocationTest-lock&quot;, false, Monitor::_safepoint_check_never);
103       ASSERT_TRUE(_spaces[i].lock != NULL);
104     }
105     // Let every ~10th space be an unsafe anonymous one to test different allocation patterns.
106     const Metaspace::MetaspaceType msType = (os::random() % 100 &lt; 10) ?
107       Metaspace::UnsafeAnonymousMetaspaceType : Metaspace::StandardMetaspaceType;
108     {
109       // Pull lock during space creation, since this is what happens in the VM too
110       // (see ClassLoaderData::metaspace_non_null(), which we mimick here).
<span class="line-modified">111       MutexLockerEx ml(_spaces[i].lock,  Mutex::_no_safepoint_check_flag);</span>
112       _spaces[i].space = new ClassLoaderMetaspace(_spaces[i].lock, msType);
113     }
114     _spaces[i].allocated = 0;
115     ASSERT_TRUE(_spaces[i].space != NULL);
116   }
117 
118   // Returns the index of a random space where index is [0..metaspaces) and which is
119   //   empty, non-empty or full.
120   // Returns -1 if no matching space exists.
121   enum fillgrade { fg_empty, fg_non_empty, fg_full };
122   int get_random_matching_space(int metaspaces, fillgrade fg) {
123     const int start_index = os::random() % metaspaces;
124     int i = start_index;
125     do {
126       if (fg == fg_empty &amp;&amp; _spaces[i].is_empty()) {
127         return i;
128       } else if ((fg == fg_full &amp;&amp; _spaces[i].is_full()) ||
129                  (fg == fg_non_empty &amp;&amp; !_spaces[i].is_full() &amp;&amp; !_spaces[i].is_empty())) {
130         return i;
131       }
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2018, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * Copyright (c) 2018, SAP.
  4  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  5  *
  6  * This code is free software; you can redistribute it and/or modify it
  7  * under the terms of the GNU General Public License version 2 only, as
  8  * published by the Free Software Foundation.
  9  *
 10  * This code is distributed in the hope that it will be useful, but WITHOUT
 11  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 12  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 13  * version 2 for more details (a copy is included in the LICENSE file that
 14  * accompanied this code).
 15  *
 16  * You should have received a copy of the GNU General Public License version
 17  * 2 along with this work; if not, write to the Free Software Foundation,
 18  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 19  *
 20  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 21  * or visit www.oracle.com if you need additional information or have any
 22  * questions.
</pre>
<hr />
<pre>
 91       if (_spaces[i].space != NULL) {
 92         delete _spaces[i].space;
 93         delete _spaces[i].lock;
 94       }
 95     }
 96   }
 97 
 98   void create_space(int i) {
 99     assert(i &gt;= 0 &amp;&amp; i &lt; NUM_PARALLEL_METASPACES, &quot;Sanity&quot;);
100     assert(_spaces[i].space == NULL &amp;&amp; _spaces[i].allocated == 0, &quot;Sanity&quot;);
101     if (_spaces[i].lock == NULL) {
102       _spaces[i].lock = new Mutex(Monitor::native, &quot;gtest-MetaspaceAllocationTest-lock&quot;, false, Monitor::_safepoint_check_never);
103       ASSERT_TRUE(_spaces[i].lock != NULL);
104     }
105     // Let every ~10th space be an unsafe anonymous one to test different allocation patterns.
106     const Metaspace::MetaspaceType msType = (os::random() % 100 &lt; 10) ?
107       Metaspace::UnsafeAnonymousMetaspaceType : Metaspace::StandardMetaspaceType;
108     {
109       // Pull lock during space creation, since this is what happens in the VM too
110       // (see ClassLoaderData::metaspace_non_null(), which we mimick here).
<span class="line-modified">111       MutexLocker ml(_spaces[i].lock,  Mutex::_no_safepoint_check_flag);</span>
112       _spaces[i].space = new ClassLoaderMetaspace(_spaces[i].lock, msType);
113     }
114     _spaces[i].allocated = 0;
115     ASSERT_TRUE(_spaces[i].space != NULL);
116   }
117 
118   // Returns the index of a random space where index is [0..metaspaces) and which is
119   //   empty, non-empty or full.
120   // Returns -1 if no matching space exists.
121   enum fillgrade { fg_empty, fg_non_empty, fg_full };
122   int get_random_matching_space(int metaspaces, fillgrade fg) {
123     const int start_index = os::random() % metaspaces;
124     int i = start_index;
125     do {
126       if (fg == fg_empty &amp;&amp; _spaces[i].is_empty()) {
127         return i;
128       } else if ((fg == fg_full &amp;&amp; _spaces[i].is_full()) ||
129                  (fg == fg_non_empty &amp;&amp; !_spaces[i].is_full() &amp;&amp; !_spaces[i].is_empty())) {
130         return i;
131       }
</pre>
</td>
</tr>
</table>
<center><a href="test_metaspace.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="../runtime/test_globals.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>