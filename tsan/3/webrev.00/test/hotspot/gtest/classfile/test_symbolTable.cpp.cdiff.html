<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff test/hotspot/gtest/classfile/test_symbolTable.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="../../../fmw/gtest/googletest/LICENSE.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="../gc/g1/test_g1FreeIdSet.cpp.cdiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/gtest/classfile/test_symbolTable.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2016, 2018, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2016, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 32,18 ***</span>
    // one, but code does not rely on this.
    JavaThread* THREAD = JavaThread::current();
    // the thread should be in vm to use locks
    ThreadInVMfromNative ThreadInVMfromNative(THREAD);
  
<span class="line-modified">!   Symbol* abc = SymbolTable::new_symbol(&quot;abc&quot;, CATCH);</span>
    int abccount = abc-&gt;refcount();
    TempNewSymbol ss = abc;
    ASSERT_EQ(ss-&gt;refcount(), abccount) &lt;&lt; &quot;only one abc&quot;;
    ASSERT_EQ(ss-&gt;refcount(), abc-&gt;refcount()) &lt;&lt; &quot;should match TempNewSymbol&quot;;
  
<span class="line-modified">!   Symbol* efg = SymbolTable::new_symbol(&quot;efg&quot;, CATCH);</span>
<span class="line-modified">!   Symbol* hij = SymbolTable::new_symbol(&quot;hij&quot;, CATCH);</span>
    int efgcount = efg-&gt;refcount();
    int hijcount = hij-&gt;refcount();
  
    TempNewSymbol s1 = efg;
    TempNewSymbol s2 = hij;
<span class="line-new-header">--- 32,18 ---</span>
    // one, but code does not rely on this.
    JavaThread* THREAD = JavaThread::current();
    // the thread should be in vm to use locks
    ThreadInVMfromNative ThreadInVMfromNative(THREAD);
  
<span class="line-modified">!   Symbol* abc = SymbolTable::new_symbol(&quot;abc&quot;);</span>
    int abccount = abc-&gt;refcount();
    TempNewSymbol ss = abc;
    ASSERT_EQ(ss-&gt;refcount(), abccount) &lt;&lt; &quot;only one abc&quot;;
    ASSERT_EQ(ss-&gt;refcount(), abc-&gt;refcount()) &lt;&lt; &quot;should match TempNewSymbol&quot;;
  
<span class="line-modified">!   Symbol* efg = SymbolTable::new_symbol(&quot;efg&quot;);</span>
<span class="line-modified">!   Symbol* hij = SymbolTable::new_symbol(&quot;hij&quot;);</span>
    int efgcount = efg-&gt;refcount();
    int hijcount = hij-&gt;refcount();
  
    TempNewSymbol s1 = efg;
    TempNewSymbol s2 = hij;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 61,25 ***</span>
  
    s1 = s1; // self assignment
    ASSERT_EQ(s1-&gt;refcount(), abccount + 1) &lt;&lt; &quot;should still be two abc (s1 and ss)&quot;;
  
    TempNewSymbol s3;
<span class="line-modified">!   Symbol* klm = SymbolTable::new_symbol(&quot;klm&quot;, CATCH);</span>
    int klmcount = klm-&gt;refcount();
    s3 = klm; // assignment
    ASSERT_EQ(s3-&gt;refcount(), klmcount) &lt;&lt; &quot;only one klm now&quot;;
  
<span class="line-modified">!   Symbol* xyz = SymbolTable::new_symbol(&quot;xyz&quot;, CATCH);</span>
    int xyzcount = xyz-&gt;refcount();
    { // inner scope
      TempNewSymbol s_inner = xyz;
    }
    ASSERT_EQ(xyz-&gt;refcount(), xyzcount - 1)
            &lt;&lt; &quot;Should have been decremented by dtor in inner scope&quot;;
  
    // Test overflowing refcount making symbol permanent
<span class="line-modified">!   Symbol* bigsym = SymbolTable::new_symbol(&quot;bigsym&quot;, CATCH);</span>
    for (int i = 0; i &lt; PERM_REFCOUNT + 100; i++) {
      bigsym-&gt;increment_refcount();
    }
    ASSERT_EQ(bigsym-&gt;refcount(), PERM_REFCOUNT) &lt;&lt; &quot;should not have overflowed&quot;;
  
<span class="line-new-header">--- 61,25 ---</span>
  
    s1 = s1; // self assignment
    ASSERT_EQ(s1-&gt;refcount(), abccount + 1) &lt;&lt; &quot;should still be two abc (s1 and ss)&quot;;
  
    TempNewSymbol s3;
<span class="line-modified">!   Symbol* klm = SymbolTable::new_symbol(&quot;klm&quot;);</span>
    int klmcount = klm-&gt;refcount();
    s3 = klm; // assignment
    ASSERT_EQ(s3-&gt;refcount(), klmcount) &lt;&lt; &quot;only one klm now&quot;;
  
<span class="line-modified">!   Symbol* xyz = SymbolTable::new_symbol(&quot;xyz&quot;);</span>
    int xyzcount = xyz-&gt;refcount();
    { // inner scope
      TempNewSymbol s_inner = xyz;
    }
    ASSERT_EQ(xyz-&gt;refcount(), xyzcount - 1)
            &lt;&lt; &quot;Should have been decremented by dtor in inner scope&quot;;
  
    // Test overflowing refcount making symbol permanent
<span class="line-modified">!   Symbol* bigsym = SymbolTable::new_symbol(&quot;bigsym&quot;);</span>
    for (int i = 0; i &lt; PERM_REFCOUNT + 100; i++) {
      bigsym-&gt;increment_refcount();
    }
    ASSERT_EQ(bigsym-&gt;refcount(), PERM_REFCOUNT) &lt;&lt; &quot;should not have overflowed&quot;;
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 99,13 ***</span>
  class SymbolThread : public JavaTestThread {
    public:
    SymbolThread(Semaphore* post) : JavaTestThread(post) {}
    virtual ~SymbolThread() {}
    void main_run() {
<span class="line-removed">-     Thread* THREAD = Thread::current();</span>
      for (int i = 0; i &lt; 1000; i++) {
<span class="line-modified">!       TempNewSymbol sym = SymbolTable::new_symbol(symbol_name, CATCH);</span>
        // Create and destroy new symbol
        EXPECT_TRUE(sym-&gt;refcount() != 0) &lt;&lt; &quot;Symbol refcount unexpectedly zeroed&quot;;
      }
    }
  };
<span class="line-new-header">--- 99,12 ---</span>
  class SymbolThread : public JavaTestThread {
    public:
    SymbolThread(Semaphore* post) : JavaTestThread(post) {}
    virtual ~SymbolThread() {}
    void main_run() {
      for (int i = 0; i &lt; 1000; i++) {
<span class="line-modified">!       TempNewSymbol sym = SymbolTable::new_symbol(symbol_name);</span>
        // Create and destroy new symbol
        EXPECT_TRUE(sym-&gt;refcount() != 0) &lt;&lt; &quot;Symbol refcount unexpectedly zeroed&quot;;
      }
    }
  };
</pre>
<hr />
<pre>
<span class="line-old-header">*** 119,16 ***</span>
    virtual ~DriverSymbolThread(){}
  
    void main_run() {
      Semaphore done(0);
  
<span class="line-removed">-     Thread* THREAD = Thread::current();</span>
<span class="line-removed">- </span>
      // Find a symbol where there will probably be only one instance.
      for (int i = 0; i &lt; 100; i++) {
         os::snprintf(symbol_name, SYM_NAME_LENGTH, &quot;some_symbol%d&quot;, i);
<span class="line-modified">!        TempNewSymbol ts = SymbolTable::new_symbol(symbol_name, CATCH);</span>
         if (ts-&gt;refcount() == 1) {
           EXPECT_TRUE(ts-&gt;refcount() == 1) &lt;&lt; &quot;Symbol is just created&quot;;
           break;  // found a unique symbol
         }
      }
<span class="line-new-header">--- 118,14 ---</span>
    virtual ~DriverSymbolThread(){}
  
    void main_run() {
      Semaphore done(0);
  
      // Find a symbol where there will probably be only one instance.
      for (int i = 0; i &lt; 100; i++) {
         os::snprintf(symbol_name, SYM_NAME_LENGTH, &quot;some_symbol%d&quot;, i);
<span class="line-modified">!        TempNewSymbol ts = SymbolTable::new_symbol(symbol_name);</span>
         if (ts-&gt;refcount() == 1) {
           EXPECT_TRUE(ts-&gt;refcount() == 1) &lt;&lt; &quot;Symbol is just created&quot;;
           break;  // found a unique symbol
         }
      }
</pre>
<center><a href="../../../fmw/gtest/googletest/LICENSE.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="../gc/g1/test_g1FreeIdSet.cpp.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>