<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old test/hotspot/jtreg/serviceability/tmtools/jstat/utils/JstatGcCapacityResults.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2015, 2017, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * Results of running the JstatGcTool (&quot;jstat -gccapacity &lt;pid&gt;&quot;)
 26  *
 27  * Output example:
 28  * NGCMN    NGCMX     NGC     S0C   S1C       EC      OGCMN      OGCMX       OGC         OC       MCMN     MCMX      MC     YGC    FGC
 29  * 41984.0 671744.0  41984.0 5248.0 5248.0  31488.0    83968.0  1343488.0    83968.0    83968.0    512.0 110592.0   4480.0      0     0
 30 
 31  * Output description:
 32  * NGCMN   Minimum new generation capacity (KB).
 33  * NGCMX   Maximum new generation capacity (KB).
 34  * NGC         Current new generation capacity (KB).
 35  * S0C          Current survivor space 0 capacity (KB).
 36  * S1C          Current survivor space 1 capacity (KB).
 37  * EC            Current eden space capacity (KB).
 38  * OGCMN   Minimum old generation capacity (KB).
 39  * OGCMX   Maximum old generation capacity (KB).
 40  * OGC         Current old generation capacity (KB).
 41  * OC            Current old space capacity (KB).
 42  * MCMN    Minimum metaspace capacity (KB).
 43  * MCMX    Maximum metaspace capacity (KB).
 44  * MC          Current metaspace capacity (KB).
 45  * YGC         Number of Young generation GC Events.
 46  * FGC         Number of Full GC Events.
 47  */
 48 package utils;
 49 
 50 import common.ToolResults;
 51 import java.lang.management.GarbageCollectorMXBean;
 52 import java.lang.management.ManagementFactory;
 53 import java.util.Arrays;
 54 import java.util.List;
 55 
 56 public class JstatGcCapacityResults extends JstatResults {
 57 
 58     public JstatGcCapacityResults(ToolResults rawResults) {
 59         super(rawResults);
 60     }
 61 
 62     /**
 63      * Checks the overall consistency of the results reported by the tool
 64      */
 65     @Override
 66     public void assertConsistency() {
 67 
 68         // Check exit code
 69         assertThat(getExitCode() == 0, &quot;Unexpected exit code: &quot; + getExitCode());
 70 
 71         // Check Young Gen consistency
 72         float NGCMN = getFloatValue(&quot;NGCMN&quot;);
 73         float NGCMX = getFloatValue(&quot;NGCMX&quot;);
 74         assertThat(NGCMX &gt;= NGCMN, &quot;NGCMN &gt; NGCMX (min generation capacity &gt; max generation capacity)&quot;);
 75 
 76         float NGC = getFloatValue(&quot;NGC&quot;);
 77         assertThat(NGC &gt;= NGCMN, &quot;NGC &lt; NGCMN (generation capacity &lt; min generation capacity)&quot;);
 78         assertThat(NGC &lt;= NGCMX, &quot;NGC &gt; NGCMX (generation capacity &gt; max generation capacity)&quot;);
 79 
 80         float S0C = getFloatValue(&quot;S0C&quot;);
 81         assertThat(S0C &lt;= NGC, &quot;S0C &gt; NGC (survivor space 0 capacity &gt; new generation capacity)&quot;);
 82 
 83         float S1C = getFloatValue(&quot;S1C&quot;);
 84         assertThat(S1C &lt;= NGC, &quot;S1C &gt; NGC (survivor space 1 capacity &gt; new generation capacity)&quot;);
 85 
 86         float EC = getFloatValue(&quot;EC&quot;);
 87         assertThat(EC &lt;= NGC, &quot;EC &gt; NGC (eden space capacity &gt; new generation capacity)&quot;);
 88 
 89         // Verify relative size of NGC and S0C + S1C + EC.
 90         // The rule depends on if the tenured GC is parallel or not.
 91         // For parallell GC:     NGC &gt;= S0C + S1C + EC
 92         // For non-parallell GC: NGC == S0C + S1C + EC
 93         boolean isTenuredParallelGC = isTenuredParallelGC();
 94         String errMsg = String.format(
 95                 &quot;NGC %s (S0C + S1C + EC) (NGC = %.1f, S0C = %.1f, S1C = %.1f, EC = %.1f, (S0C + S1C + EC) = %.1f)&quot;,
 96                 isTenuredParallelGC ? &quot;&lt;&quot; : &quot;!=&quot;, NGC, S0C, S1C, EC, S0C + S1C + EC);
 97         if (isTenuredParallelGC) {
 98             assertThat(NGC &gt;= S0C + S1C + EC, errMsg);
 99         } else {
100             assertThat(checkFloatIsSum(NGC, S0C, S1C, EC), errMsg);
101         }
102 
103         // Check Old Gen consistency
104         float OGCMN = getFloatValue(&quot;OGCMN&quot;);
105         float OGCMX = getFloatValue(&quot;OGCMX&quot;);
106         assertThat(OGCMX &gt;= OGCMN, &quot;OGCMN &gt; OGCMX (min generation capacity &gt; max generation capacity)&quot;);
107 
108         float OGC = getFloatValue(&quot;OGC&quot;);
109         assertThat(OGC &gt;= OGCMN, &quot;OGC &lt; OGCMN (generation capacity &lt; min generation capacity)&quot;);
110         assertThat(OGC &lt;= OGCMX, &quot;OGC &gt; OGCMX (generation capacity &gt; max generation capacity)&quot;);
111         float OC = getFloatValue(&quot;OC&quot;);
112         assertThat(OC == OGC, &quot;OC != OGC (old generation capacity != old space capacity (these values should be equal since old space is made up only from one old generation))&quot;);
113 
114         // Check Metaspace consistency
115         float MCMN = getFloatValue(&quot;MCMN&quot;);
116         float MCMX = getFloatValue(&quot;MCMX&quot;);
117         assertThat(MCMX &gt;= MCMN, &quot;MCMN &gt; MCMX (min generation capacity &gt; max generation capacity)&quot;);
118         float MC = getFloatValue(&quot;MC&quot;);
119         assertThat(MC &gt;= MCMN, &quot;MC &lt; MCMN (generation capacity &lt; min generation capacity)&quot;);
120         assertThat(MC &lt;= MCMX, &quot;MGC &gt; MCMX (generation capacity &gt; max generation capacity)&quot;);
121     }
122 
123     /**
124      * Check if the tenured generation are currently using a parallel GC.
125      */
126     protected static boolean isTenuredParallelGC() {
127         // Currently the only parallel GC for the tenured generation is PS MarkSweep.
128         List&lt;String&gt; parallelGCs = Arrays.asList(new String[] { &quot;PS MarkSweep&quot;});
129         try {
130             List&lt;GarbageCollectorMXBean&gt; beans = ManagementFactory.getGarbageCollectorMXBeans();
131             for (GarbageCollectorMXBean bean : beans) {
132                 if (parallelGCs.contains(bean.getName())) {
133                     return true;
134                 }
135             }
136         } catch (Exception e) {
137             e.printStackTrace();
138         }
139         return false;
140     }
141 }
    </pre>
  </body>
</html>