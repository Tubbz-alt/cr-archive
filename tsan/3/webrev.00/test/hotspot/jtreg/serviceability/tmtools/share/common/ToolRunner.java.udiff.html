<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/hotspot/jtreg/serviceability/tmtools/share/common/ToolRunner.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../jstat/utils/JstatGcCapacityResults.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../../../../testlibrary/ctw/src/sun/hotspot/tools/ctw/CompileTheWorld.java.udiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/jtreg/serviceability/tmtools/share/common/ToolRunner.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2015, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2015, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -20,59 +20,46 @@</span>
   * or visit www.oracle.com if you need additional information or have any
   * questions.
   */
  package common;
  
<span class="udiff-line-modified-removed">- import java.io.BufferedReader;</span>
<span class="udiff-line-modified-removed">- import java.io.IOException;</span>
<span class="udiff-line-modified-removed">- import java.io.StringReader;</span>
<span class="udiff-line-modified-removed">- import java.util.ArrayList;</span>
<span class="udiff-line-modified-removed">- import java.util.LinkedList;</span>
<span class="udiff-line-removed">- import java.util.List;</span>
<span class="udiff-line-removed">- import java.util.StringTokenizer;</span>
<span class="udiff-line-removed">- import jdk.test.lib.process.OutputAnalyzer;</span>
<span class="udiff-line-removed">- import jdk.test.lib.process.ProcessTools;</span>
<span class="udiff-line-modified-added">+ import java.nio.file.Files;</span>
<span class="udiff-line-modified-added">+ import java.nio.file.Path;</span>
<span class="udiff-line-modified-added">+ import java.nio.file.Paths;</span>
<span class="udiff-line-modified-added">+ import java.util.Arrays;</span>
<span class="udiff-line-modified-added">+ import java.time.Instant;</span>
  
  /**
   * This class starts a process specified by the passed command line waits till
   * the process completes and returns the process exit code and stdout and stderr
   * output as ToolResults
   */
  class ToolRunner {
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-removed">-     private final List&lt;String&gt; cmdArgs = new LinkedList&lt;&gt;();</span>
<span class="udiff-line-modified-added">+     private final String[] cmdArgs;</span>
  
      ToolRunner(String cmdLine) {
<span class="udiff-line-modified-removed">-         StringTokenizer st = new StringTokenizer(cmdLine);</span>
<span class="udiff-line-removed">-         while (st.hasMoreTokens()) {</span>
<span class="udiff-line-removed">-             cmdArgs.add(st.nextToken());</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-modified-added">+         cmdArgs = cmdLine.split(&quot; +&quot;);</span>
      }
  
      /**
       * Starts the process, waits for the process completion and returns the
       * results
       *
       * @return process results
       * @throws Exception if anything goes wrong
       */
      ToolResults runToCompletion() throws Exception {
<span class="udiff-line-removed">- </span>
          ProcessBuilder pb = new ProcessBuilder(cmdArgs);
<span class="udiff-line-modified-removed">-         OutputAnalyzer oa = ProcessTools.executeProcess(pb);</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-removed">-         return new ToolResults(oa.getExitValue(),</span>
<span class="udiff-line-removed">-                 stringToList(oa.getStdout()),</span>
<span class="udiff-line-removed">-                 stringToList(oa.getStderr()));</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-modified-added">+         Path out = Files.createTempFile(Paths.get(&quot;.&quot;), &quot;out.&quot;, &quot;.txt&quot;);</span>
<span class="udiff-line-modified-added">+         Path err = out.resolveSibling(out.getFileName().toString().replaceFirst(&quot;out&quot;, &quot;err&quot;));</span>
  
<span class="udiff-line-modified-removed">-     private static List&lt;String&gt; stringToList(String s) throws IOException {</span>
<span class="udiff-line-modified-removed">-         BufferedReader reader = new BufferedReader(new StringReader(s));</span>
<span class="udiff-line-modified-removed">-         List&lt;String&gt; strings = new ArrayList&lt;&gt;();</span>
<span class="udiff-line-modified-removed">-         for (String line = reader.readLine(); line != null; line = reader.readLine()) {</span>
<span class="udiff-line-modified-removed">-             strings.add(line);</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-removed">-         reader.close();</span>
<span class="udiff-line-modified-removed">-         return strings;</span>
<span class="udiff-line-modified-added">+         Process p = pb.redirectOutput(ProcessBuilder.Redirect.to(out.toFile()))</span>
<span class="udiff-line-modified-added">+                       .redirectError(ProcessBuilder.Redirect.to(err.toFile()))</span>
<span class="udiff-line-modified-added">+                       .start();</span>
<span class="udiff-line-modified-added">+         System.out.printf(&quot;[%s] started process %d %s with out/err redirected to &#39;%s&#39; and &#39;%s&#39;%n&quot;,</span>
<span class="udiff-line-modified-added">+                 Instant.now().toString(), p.pid(), pb.command(), out.toString(), err.toString());</span>
<span class="udiff-line-modified-added">+         int exitCode = p.waitFor();</span>
<span class="udiff-line-modified-added">+         System.out.printf(&quot;[%s] process %d finished with exit code = %d%n&quot;,</span>
<span class="udiff-line-modified-added">+                 Instant.now().toString(), p.pid(), exitCode);</span>
<span class="udiff-line-added">+         return new ToolResults(exitCode, Files.readAllLines(out), Files.readAllLines(err));</span>
      }
  }
</pre>
<center><a href="../../jstat/utils/JstatGcCapacityResults.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../../../../testlibrary/ctw/src/sun/hotspot/tools/ctw/CompileTheWorld.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>