<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/hotspot/jtreg/serviceability/sa/ClhsdbCDSCore.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="ClhsdbAttach.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="ClhsdbCDSJstackPrintAll.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/jtreg/serviceability/sa/ClhsdbCDSCore.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /**
 25  * @test
 26  * @bug 8174994 8200613
 27  * @summary Test the clhsdb commands &#39;printmdo&#39;, &#39;printall&#39;, &#39;jstack&#39; on a CDS enabled corefile.
 28  * @requires vm.cds
 29  * @requires vm.hasSA
 30  * @requires os.family != &quot;windows&quot;
 31  * @requires vm.flavor == &quot;server&quot;
 32  * @library /test/lib
 33  * @modules java.base/jdk.internal.misc
 34  * @run main/othervm/timeout=2400 -Xmx1g ClhsdbCDSCore
 35  */
 36 
<span class="line-removed"> 37 import java.util.List;</span>
<span class="line-removed"> 38 import java.util.ArrayList;</span>
<span class="line-removed"> 39 import java.util.Arrays;</span>
<span class="line-removed"> 40 import java.util.Map;</span>
<span class="line-removed"> 41 import java.util.HashMap;</span>
<span class="line-removed"> 42 import jdk.test.lib.process.ProcessTools;</span>
<span class="line-removed"> 43 import jdk.test.lib.Platform;</span>
<span class="line-removed"> 44 import jdk.test.lib.process.OutputAnalyzer;</span>
<span class="line-removed"> 45 import jdk.test.lib.cds.CDSTestUtils;</span>
<span class="line-removed"> 46 import jdk.test.lib.cds.CDSOptions;</span>
<span class="line-removed"> 47 import java.io.IOException;</span>
 48 import java.io.File;

 49 import java.nio.file.Files;
 50 import java.nio.file.Path;
 51 import java.nio.file.Paths;
<span class="line-modified"> 52 import jdk.test.lib.Asserts;</span>
<span class="line-modified"> 53 import java.util.regex.Pattern;</span>




 54 import java.util.regex.Matcher;


 55 import jdk.internal.misc.Unsafe;
<span class="line-modified"> 56 import java.util.Scanner;</span>








 57 import jtreg.SkippedException;
 58 
 59 class CrashApp {
 60     public static void main(String[] args) {
 61         Unsafe.getUnsafe().putInt(0L, 0);
 62     }
 63 }
 64 
 65 public class ClhsdbCDSCore {
 66 
 67     private static final String TEST_CDS_CORE_FILE_NAME = &quot;cds_core_file&quot;;
 68     private static final String LOCATIONS_STRING = &quot;location: &quot;;
 69     private static final String RUN_SHELL_NO_LIMIT = &quot;ulimit -c unlimited &amp;&amp; &quot;;
 70     private static final String SHARED_ARCHIVE_NAME = &quot;ArchiveForClhsdbCDSCore.jsa&quot;;
 71     private static final String CORE_PATTERN_FILE_NAME = &quot;/proc/sys/kernel/core_pattern&quot;;
 72 
 73     public static void main(String[] args) throws Exception {
 74         System.out.println(&quot;Starting ClhsdbCDSCore test&quot;);
 75         cleanup();
 76 
</pre>
<hr />
<pre>
 85                 &quot;-XX:+CreateCoredumpOnCrash&quot;,
 86                 &quot;-Xshare:auto&quot;,
 87                 &quot;-XX:+ProfileInterpreter&quot;,
 88                 &quot;--add-exports=java.base/jdk.internal.misc=ALL-UNNAMED&quot;,
 89                 CrashApp.class.getName()
 90             };
 91 
 92             OutputAnalyzer crashOut;
 93             try {
 94                List&lt;String&gt; options = new ArrayList&lt;&gt;();
 95                options.addAll(Arrays.asList(jArgs));
 96                crashOut =
 97                    ProcessTools.executeProcess(getTestJavaCommandlineWithPrefix(
 98                    RUN_SHELL_NO_LIMIT, options.toArray(new String[0])));
 99             } catch (Throwable t) {
100                throw new Error(&quot;Can&#39;t execute the java cds process.&quot;, t);
101             }
102 
103             System.out.println(crashOut.getOutput());
104             String crashOutputString = crashOut.getOutput();

105             String coreFileLocation = getCoreFileLocation(crashOutputString);
106             if (coreFileLocation == null) {
107                 if (Platform.isOSX()) {
108                     File coresDir = new File(&quot;/cores&quot;);
<span class="line-modified">109                     if (!coresDir.isDirectory() || !coresDir.canWrite()) {</span>
<span class="line-modified">110                         throw new Error(&quot;cores is not a directory or does not have write permissions&quot;);</span>







111                     }
112                 } else if (Platform.isLinux()) {
113                     // Check if a crash report tool is installed.
114                     File corePatternFile = new File(CORE_PATTERN_FILE_NAME);
<span class="line-modified">115                     Scanner scanner = new Scanner(corePatternFile);</span>
<span class="line-modified">116                     while (scanner.hasNextLine()) {</span>
<span class="line-modified">117                         String line = scanner.nextLine();</span>
<span class="line-modified">118                         line = line.trim();</span>
<span class="line-modified">119                         System.out.println(line);</span>
<span class="line-modified">120                         if (line.startsWith(&quot;|&quot;)) {</span>
<span class="line-modified">121                             System.out.println(</span>
<span class="line-modified">122                                 &quot;\nThis system uses a crash report tool ($cat /proc/sys/kernel/core_pattern).\n&quot; +</span>
<span class="line-modified">123                                 &quot;Core files might not be generated. Please reset /proc/sys/kernel/core_pattern\n&quot; +</span>
<span class="line-modified">124                                 &quot;to enable core generation. Skipping this test.&quot;);</span>
<span class="line-modified">125                             cleanup();</span>
<span class="line-modified">126                             throw new SkippedException(&quot;This system uses a crash report tool&quot;);</span>

127                         }
128                     }
129                 }
130                 throw new Error(&quot;Couldn&#39;t find core file location in: &#39;&quot; + crashOutputString + &quot;&#39;&quot;);
131             }
132             try {
133                 Asserts.assertGT(new File(coreFileLocation).length(), 0L, &quot;Unexpected core size&quot;);
134                 Files.move(Paths.get(coreFileLocation), Paths.get(TEST_CDS_CORE_FILE_NAME));
135             } catch (IOException ioe) {
136                 throw new Error(&quot;Can&#39;t move core file: &quot; + ioe, ioe);
137             }
138 
139             ClhsdbLauncher test = new ClhsdbLauncher();
140 
141             // Ensure that UseSharedSpaces is turned on.
142             List&lt;String&gt; cmds = List.of(&quot;flags UseSharedSpaces&quot;);
143 
144             String useSharedSpacesOutput = test.runOnCore(TEST_CDS_CORE_FILE_NAME, cmds,
145                                                           null, null);
146 
</pre>
</td>
<td>
<hr />
<pre>
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /**
 25  * @test
 26  * @bug 8174994 8200613
 27  * @summary Test the clhsdb commands &#39;printmdo&#39;, &#39;printall&#39;, &#39;jstack&#39; on a CDS enabled corefile.
 28  * @requires vm.cds
 29  * @requires vm.hasSA
 30  * @requires os.family != &quot;windows&quot;
 31  * @requires vm.flavor == &quot;server&quot;
 32  * @library /test/lib
 33  * @modules java.base/jdk.internal.misc
 34  * @run main/othervm/timeout=2400 -Xmx1g ClhsdbCDSCore
 35  */
 36 











 37 import java.io.File;
<span class="line-added"> 38 import java.io.IOException;</span>
 39 import java.nio.file.Files;
 40 import java.nio.file.Path;
 41 import java.nio.file.Paths;
<span class="line-modified"> 42 import java.util.ArrayList;</span>
<span class="line-modified"> 43 import java.util.Arrays;</span>
<span class="line-added"> 44 import java.util.HashMap;</span>
<span class="line-added"> 45 import java.util.List;</span>
<span class="line-added"> 46 import java.util.Map;</span>
<span class="line-added"> 47 import java.util.Scanner;</span>
 48 import java.util.regex.Matcher;
<span class="line-added"> 49 import java.util.regex.Pattern;</span>
<span class="line-added"> 50 </span>
 51 import jdk.internal.misc.Unsafe;
<span class="line-modified"> 52 </span>
<span class="line-added"> 53 import jdk.test.lib.Asserts;</span>
<span class="line-added"> 54 import jdk.test.lib.Platform;</span>
<span class="line-added"> 55 import jdk.test.lib.cds.CDSOptions;</span>
<span class="line-added"> 56 import jdk.test.lib.cds.CDSTestUtils;</span>
<span class="line-added"> 57 import jdk.test.lib.process.OutputAnalyzer;</span>
<span class="line-added"> 58 import jdk.test.lib.process.ProcessTools;</span>
<span class="line-added"> 59 import jdk.test.lib.SA.SATestUtils;</span>
<span class="line-added"> 60 </span>
 61 import jtreg.SkippedException;
 62 
 63 class CrashApp {
 64     public static void main(String[] args) {
 65         Unsafe.getUnsafe().putInt(0L, 0);
 66     }
 67 }
 68 
 69 public class ClhsdbCDSCore {
 70 
 71     private static final String TEST_CDS_CORE_FILE_NAME = &quot;cds_core_file&quot;;
 72     private static final String LOCATIONS_STRING = &quot;location: &quot;;
 73     private static final String RUN_SHELL_NO_LIMIT = &quot;ulimit -c unlimited &amp;&amp; &quot;;
 74     private static final String SHARED_ARCHIVE_NAME = &quot;ArchiveForClhsdbCDSCore.jsa&quot;;
 75     private static final String CORE_PATTERN_FILE_NAME = &quot;/proc/sys/kernel/core_pattern&quot;;
 76 
 77     public static void main(String[] args) throws Exception {
 78         System.out.println(&quot;Starting ClhsdbCDSCore test&quot;);
 79         cleanup();
 80 
</pre>
<hr />
<pre>
 89                 &quot;-XX:+CreateCoredumpOnCrash&quot;,
 90                 &quot;-Xshare:auto&quot;,
 91                 &quot;-XX:+ProfileInterpreter&quot;,
 92                 &quot;--add-exports=java.base/jdk.internal.misc=ALL-UNNAMED&quot;,
 93                 CrashApp.class.getName()
 94             };
 95 
 96             OutputAnalyzer crashOut;
 97             try {
 98                List&lt;String&gt; options = new ArrayList&lt;&gt;();
 99                options.addAll(Arrays.asList(jArgs));
100                crashOut =
101                    ProcessTools.executeProcess(getTestJavaCommandlineWithPrefix(
102                    RUN_SHELL_NO_LIMIT, options.toArray(new String[0])));
103             } catch (Throwable t) {
104                throw new Error(&quot;Can&#39;t execute the java cds process.&quot;, t);
105             }
106 
107             System.out.println(crashOut.getOutput());
108             String crashOutputString = crashOut.getOutput();
<span class="line-added">109             SATestUtils.unzipCores(new File(&quot;.&quot;));</span>
110             String coreFileLocation = getCoreFileLocation(crashOutputString);
111             if (coreFileLocation == null) {
112                 if (Platform.isOSX()) {
113                     File coresDir = new File(&quot;/cores&quot;);
<span class="line-modified">114                     if (!coresDir.isDirectory()) {</span>
<span class="line-modified">115                         cleanup();</span>
<span class="line-added">116                         throw new Error(coresDir + &quot; is not a directory&quot;);</span>
<span class="line-added">117                     }</span>
<span class="line-added">118                     // the /cores directory is usually not writable on macOS 10.15</span>
<span class="line-added">119                     if (!coresDir.canWrite()) {</span>
<span class="line-added">120                         cleanup();</span>
<span class="line-added">121                         throw new SkippedException(&quot;Directory \&quot;&quot; + coresDir +</span>
<span class="line-added">122                             &quot;\&quot; is not writable&quot;);</span>
123                     }
124                 } else if (Platform.isLinux()) {
125                     // Check if a crash report tool is installed.
126                     File corePatternFile = new File(CORE_PATTERN_FILE_NAME);
<span class="line-modified">127                     try (Scanner scanner = new Scanner(corePatternFile)) {</span>
<span class="line-modified">128                         while (scanner.hasNextLine()) {</span>
<span class="line-modified">129                             String line = scanner.nextLine();</span>
<span class="line-modified">130                             line = line.trim();</span>
<span class="line-modified">131                             System.out.println(line);</span>
<span class="line-modified">132                             if (line.startsWith(&quot;|&quot;)) {</span>
<span class="line-modified">133                                 System.out.println(</span>
<span class="line-modified">134                                     &quot;\nThis system uses a crash report tool ($cat /proc/sys/kernel/core_pattern).\n&quot; +</span>
<span class="line-modified">135                                     &quot;Core files might not be generated. Please reset /proc/sys/kernel/core_pattern\n&quot; +</span>
<span class="line-modified">136                                     &quot;to enable core generation. Skipping this test.&quot;);</span>
<span class="line-modified">137                                 cleanup();</span>
<span class="line-modified">138                                 throw new SkippedException(&quot;This system uses a crash report tool&quot;);</span>
<span class="line-added">139                             }</span>
140                         }
141                     }
142                 }
143                 throw new Error(&quot;Couldn&#39;t find core file location in: &#39;&quot; + crashOutputString + &quot;&#39;&quot;);
144             }
145             try {
146                 Asserts.assertGT(new File(coreFileLocation).length(), 0L, &quot;Unexpected core size&quot;);
147                 Files.move(Paths.get(coreFileLocation), Paths.get(TEST_CDS_CORE_FILE_NAME));
148             } catch (IOException ioe) {
149                 throw new Error(&quot;Can&#39;t move core file: &quot; + ioe, ioe);
150             }
151 
152             ClhsdbLauncher test = new ClhsdbLauncher();
153 
154             // Ensure that UseSharedSpaces is turned on.
155             List&lt;String&gt; cmds = List.of(&quot;flags UseSharedSpaces&quot;);
156 
157             String useSharedSpacesOutput = test.runOnCore(TEST_CDS_CORE_FILE_NAME, cmds,
158                                                           null, null);
159 
</pre>
</td>
</tr>
</table>
<center><a href="ClhsdbAttach.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="ClhsdbCDSJstackPrintAll.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>