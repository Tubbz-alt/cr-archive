<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/hotspot/jtreg/serviceability/sa/TestInstanceKlassSize.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="TestHeapDumpForInvokeDynamic.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="TestInstanceKlassSizeForInterface.java.udiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/jtreg/serviceability/sa/TestInstanceKlassSize.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2015, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2015, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -48,102 +48,76 @@</span>
   * @modules java.base/jdk.internal.misc
   *          jdk.hotspot.agent/sun.jvm.hotspot
   *          jdk.hotspot.agent/sun.jvm.hotspot.utilities
   *          jdk.hotspot.agent/sun.jvm.hotspot.oops
   *          jdk.hotspot.agent/sun.jvm.hotspot.debugger
<span class="udiff-line-modified-removed">-  * @run main/othervm TestInstanceKlassSize</span>
<span class="udiff-line-modified-added">+  * @build sun.hotspot.WhiteBox</span>
<span class="udiff-line-added">+  * @run driver ClassFileInstaller sun.hotspot.WhiteBox sun.hotspot.WhiteBox$WhiteBoxPermission</span>
<span class="udiff-line-added">+  * @run main/othervm -XX:+UnlockDiagnosticVMOptions -XX:+WhiteBoxAPI -Xbootclasspath/a:. TestInstanceKlassSize</span>
   */
  
<span class="udiff-line-modified-removed">- public class TestInstanceKlassSize {</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private static String getJcmdInstanceKlassSize(OutputAnalyzer output,</span>
<span class="udiff-line-removed">-                                                    String instanceKlassName) {</span>
<span class="udiff-line-removed">-         for (String s : output.asLines()) {</span>
<span class="udiff-line-removed">-             if (s.contains(instanceKlassName)) {</span>
<span class="udiff-line-removed">-                 String tokens[];</span>
<span class="udiff-line-removed">-                 System.out.println(s);</span>
<span class="udiff-line-removed">-                 tokens = s.split(&quot;\\s+&quot;);</span>
<span class="udiff-line-removed">-                 return tokens[3];</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         return null;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-modified-added">+ import sun.hotspot.WhiteBox;</span>
  
<span class="udiff-line-modified-removed">-     private static OutputAnalyzer jcmd(Long pid,</span>
<span class="udiff-line-removed">-                                        String... toolArgs) throws Exception {</span>
<span class="udiff-line-removed">-         ProcessBuilder processBuilder = new ProcessBuilder();</span>
<span class="udiff-line-removed">-         JDKToolLauncher launcher = JDKToolLauncher.createUsingTestJDK(&quot;jcmd&quot;);</span>
<span class="udiff-line-removed">-         launcher.addToolArg(Long.toString(pid));</span>
<span class="udiff-line-removed">-         if (toolArgs != null) {</span>
<span class="udiff-line-removed">-             for (String toolArg : toolArgs) {</span>
<span class="udiff-line-removed">-                 launcher.addToolArg(toolArg);</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-modified-added">+ public class TestInstanceKlassSize {</span>
  
<span class="udiff-line-modified-removed">-         processBuilder.command(launcher.getCommand());</span>
<span class="udiff-line-modified-removed">-         System.out.println(</span>
<span class="udiff-line-modified-removed">-             processBuilder.command().stream().collect(Collectors.joining(&quot; &quot;)));</span>
<span class="udiff-line-modified-removed">-         return ProcessTools.executeProcess(processBuilder);</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+     public static WhiteBox wb = WhiteBox.getWhiteBox();</span>
<span class="udiff-line-modified-added">+     private static String[] SAInstanceKlassNames = new String[] {</span>
<span class="udiff-line-modified-added">+                                                 &quot;java.lang.Object&quot;,</span>
<span class="udiff-line-modified-added">+                                                 &quot;java.util.ArrayList&quot;,</span>
<span class="udiff-line-modified-added">+                                                 &quot;java.lang.String&quot;,</span>
<span class="udiff-line-added">+                                                 &quot;java.lang.Thread&quot;,</span>
<span class="udiff-line-added">+                                                 &quot;java.lang.Byte&quot;</span>
<span class="udiff-line-added">+                                              };</span>
  
      private static void startMeWithArgs() throws Exception {
  
          LingeredApp app = null;
          OutputAnalyzer output = null;
          try {
<span class="udiff-line-modified-removed">-             List&lt;String&gt; vmArgs = new ArrayList&lt;String&gt;();</span>
<span class="udiff-line-removed">-             vmArgs.add(&quot;-XX:+UsePerfData&quot;);</span>
<span class="udiff-line-removed">-             vmArgs.addAll(Utils.getVmOptions());</span>
<span class="udiff-line-modified-added">+             String[] vmArgs = Utils.appendTestJavaOpts(&quot;-XX:+UsePerfData&quot;);</span>
              app = LingeredApp.startApp(vmArgs);
              System.out.println (&quot;Started LingeredApp with pid &quot; + app.getPid());
          } catch (Exception ex) {
              ex.printStackTrace();
              throw new RuntimeException(ex);
          }
          try {
<span class="udiff-line-modified-removed">-             String[] instanceKlassNames = new String[] {</span>
<span class="udiff-line-removed">-                                               &quot; java.lang.Object&quot;,</span>
<span class="udiff-line-removed">-                                               &quot; java.util.Vector&quot;,</span>
<span class="udiff-line-removed">-                                               &quot; java.lang.String&quot;,</span>
<span class="udiff-line-removed">-                                               &quot; java.lang.Thread&quot;,</span>
<span class="udiff-line-removed">-                                               &quot; java.lang.Byte&quot;,</span>
<span class="udiff-line-removed">-                                           };</span>
<span class="udiff-line-modified-added">+             // Run this app with the LingeredApp PID to get SA output from the LingeredApp</span>
              String[] toolArgs = {
                  &quot;--add-modules=jdk.hotspot.agent&quot;,
                  &quot;--add-exports=jdk.hotspot.agent/sun.jvm.hotspot=ALL-UNNAMED&quot;,
                  &quot;--add-exports=jdk.hotspot.agent/sun.jvm.hotspot.utilities=ALL-UNNAMED&quot;,
                  &quot;--add-exports=jdk.hotspot.agent/sun.jvm.hotspot.oops=ALL-UNNAMED&quot;,
                  &quot;--add-exports=jdk.hotspot.agent/sun.jvm.hotspot.debugger=ALL-UNNAMED&quot;,
<span class="udiff-line-added">+                 &quot;-XX:+UnlockDiagnosticVMOptions&quot;,</span>
<span class="udiff-line-added">+                 &quot;-XX:+WhiteBoxAPI&quot;,</span>
<span class="udiff-line-added">+                 &quot;-Xbootclasspath/a:.&quot;,</span>
                  &quot;TestInstanceKlassSize&quot;,
                  Long.toString(app.getPid())
              };
  
<span class="udiff-line-removed">-             OutputAnalyzer jcmdOutput = jcmd(</span>
<span class="udiff-line-removed">-                            app.getPid(),</span>
<span class="udiff-line-removed">-                            &quot;GC.class_stats&quot;, &quot;VTab,ITab,OopMap,KlassBytes&quot;);</span>
              ProcessBuilder processBuilder = ProcessTools
                                              .createJavaProcessBuilder(toolArgs);
              output = ProcessTools.executeProcess(processBuilder);
              System.out.println(output.getOutput());
              output.shouldHaveExitValue(0);
  
<span class="udiff-line-modified-removed">-             // Check whether the size matches that which jcmd outputs</span>
<span class="udiff-line-modified-removed">-             for (String instanceKlassName : instanceKlassNames) {</span>
<span class="udiff-line-modified-removed">-                 System.out.println (&quot;Trying to match for&quot; + instanceKlassName);</span>
<span class="udiff-line-modified-removed">-                 String jcmdInstanceKlassSize = getJcmdInstanceKlassSize(</span>
<span class="udiff-line-modified-removed">-                                                       jcmdOutput,</span>
<span class="udiff-line-modified-removed">-                                                       instanceKlassName);</span>
<span class="udiff-line-removed">-                 Asserts.assertNotNull(jcmdInstanceKlassSize,</span>
<span class="udiff-line-removed">-                     &quot;Could not get the instance klass size from the jcmd output&quot;);</span>
<span class="udiff-line-modified-added">+             // Check whether the size matches with value from VM.</span>
<span class="udiff-line-modified-added">+             for (String instanceKlassName : SAInstanceKlassNames) {</span>
<span class="udiff-line-modified-added">+                 Class&lt;?&gt; iklass = Class.forName(instanceKlassName);</span>
<span class="udiff-line-modified-added">+                 System.out.println (&quot;Trying to match for &quot; + instanceKlassName);</span>
<span class="udiff-line-modified-added">+                 String size = String.valueOf(wb.getKlassMetadataSize(iklass));</span>
<span class="udiff-line-modified-added">+                 boolean match = false;</span>
                  for (String s : output.asLines()) {
                      if (s.contains(instanceKlassName)) {
                         Asserts.assertTrue(
<span class="udiff-line-modified-removed">-                           s.contains(jcmdInstanceKlassSize),</span>
<span class="udiff-line-removed">-                           &quot;The size computed by SA for&quot; +</span>
<span class="udiff-line-modified-added">+                           s.contains(size), &quot;The size computed by SA for&quot; +</span>
                            instanceKlassName + &quot; does not match.&quot;);
<span class="udiff-line-added">+                        match = true;</span>
                      }
                  }
<span class="udiff-line-added">+                 Asserts.assertTrue(match, &quot;Found a match for &quot; + instanceKlassName);</span>
              }
          } finally {
              LingeredApp.stopApp(app);
          }
      }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -177,17 +151,9 @@</span>
  
          if (args == null || args.length == 0) {
              System.out.println (&quot;No args run. Starting with args now.&quot;);
              startMeWithArgs();
          } else {
<span class="udiff-line-removed">-             String[] SAInstanceKlassNames = new String[] {</span>
<span class="udiff-line-removed">-                                                 &quot;java.lang.Object&quot;,</span>
<span class="udiff-line-removed">-                                                 &quot;java.util.Vector&quot;,</span>
<span class="udiff-line-removed">-                                                 &quot;java.lang.String&quot;,</span>
<span class="udiff-line-removed">-                                                 &quot;java.lang.Thread&quot;,</span>
<span class="udiff-line-removed">-                                                 &quot;java.lang.Byte&quot;</span>
<span class="udiff-line-removed">-                                              };</span>
              SAInstanceKlassSize(Integer.parseInt(args[0]), SAInstanceKlassNames);
          }
      }
  }
<span class="udiff-line-removed">- </span>
</pre>
<center><a href="TestHeapDumpForInvokeDynamic.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="TestInstanceKlassSizeForInterface.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>