<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New test/hotspot/jtreg/serviceability/jvmti/GetOwnedMonitorInfo/libGetOwnedMonitorInfoWithEATest.c</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2019 SAP SE. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 #include &lt;stdio.h&gt;
 25 #include &lt;string.h&gt;
 26 #include &quot;jvmti.h&quot;
 27 #include &quot;jni.h&quot;
 28 
 29 #ifdef __cplusplus
 30 extern &quot;C&quot; {
 31 #endif
 32 
 33 #ifndef JNI_ENV_ARG
 34 
 35 #ifdef __cplusplus
 36 #define JNI_ENV_ARG(x, y) y
 37 #define JNI_ENV_PTR(x) x
 38 #else
 39 #define JNI_ENV_ARG(x,y) x, y
 40 #define JNI_ENV_PTR(x) (*x)
 41 #endif
 42 
 43 #endif
 44 
 45 #define FAILED -1
 46 
 47 static jvmtiEnv *jvmti;
 48 
 49 static jint Agent_Initialize(JavaVM *jvm, char *options, void *reserved);
 50 
 51 static void ShowErrorMessage(jvmtiEnv *jvmti, jvmtiError errCode, const char *message) {
 52     char *errMsg;
 53     jvmtiError result;
 54 
 55     result = (*jvmti)-&gt;GetErrorName(jvmti, errCode, &amp;errMsg);
 56     if (result == JVMTI_ERROR_NONE) {
 57         fprintf(stderr, &quot;%s: %s (%d)\n&quot;, message, errMsg, errCode);
 58         (*jvmti)-&gt;Deallocate(jvmti, (unsigned char *)errMsg);
 59     } else {
 60         fprintf(stderr, &quot;%s (%d)\n&quot;, message, errCode);
 61     }
 62 }
 63 
 64 JNIEXPORT jint JNICALL
 65 Agent_OnLoad(JavaVM *jvm, char *options, void *reserved) {
 66     return Agent_Initialize(jvm, options, reserved);
 67 }
 68 
 69 JNIEXPORT jint JNICALL
 70 Agent_OnAttach(JavaVM *jvm, char *options, void *reserved) {
 71     return Agent_Initialize(jvm, options, reserved);
 72 }
 73 
 74 JNIEXPORT jint JNICALL
 75 JNI_OnLoad(JavaVM *jvm, void *reserved) {
 76     jint res;
 77     JNIEnv *env;
 78 
 79     res = JNI_ENV_PTR(jvm)-&gt;GetEnv(JNI_ENV_ARG(jvm, (void **) &amp;env),
 80                                    JNI_VERSION_9);
 81     if (res != JNI_OK || env == NULL) {
 82         fprintf(stderr, &quot;Error: GetEnv call failed(%d)!\n&quot;, res);
 83         return JNI_ERR;
 84     }
 85 
 86     return JNI_VERSION_9;
 87 }
 88 
 89 static
 90 jint Agent_Initialize(JavaVM *jvm, char *options, void *reserved) {
 91     jint res;
 92     jvmtiError err;
 93     jvmtiCapabilities caps;
 94 
 95     printf(&quot;Agent_OnLoad started\n&quot;);
 96 
 97     memset(&amp;caps, 0, sizeof(caps));
 98 
 99     res = JNI_ENV_PTR(jvm)-&gt;GetEnv(JNI_ENV_ARG(jvm, (void **) &amp;jvmti),
100                                    JVMTI_VERSION_9);
101     if (res != JNI_OK || jvmti == NULL) {
102         fprintf(stderr, &quot;Error: wrong result of a valid call to GetEnv!\n&quot;);
103         return JNI_ERR;
104     }
105 
106     caps.can_get_owned_monitor_info = 1;
107 
108     err = (*jvmti)-&gt;AddCapabilities(jvmti, &amp;caps);
109     if (err != JVMTI_ERROR_NONE) {
110         ShowErrorMessage(jvmti, err,
111                          &quot;Agent_OnLoad: error in JVMTI AddCapabilities&quot;);
112         return JNI_ERR;
113     }
114 
115     err = (*jvmti)-&gt;GetCapabilities(jvmti, &amp;caps);
116     if (err != JVMTI_ERROR_NONE) {
117         ShowErrorMessage(jvmti, err,
118                          &quot;Agent_OnLoad: error in JVMTI GetCapabilities&quot;);
119         return JNI_ERR;
120     }
121 
122     if (!caps.can_get_owned_monitor_info) {
123         fprintf(stderr, &quot;Warning: GetOwnedMonitorInfo is not implemented\n&quot;);
124         return JNI_ERR;
125     }
126 
127     printf(&quot;Agent_OnLoad finished\n&quot;);
128     return JNI_OK;
129 }
130 
131 JNIEXPORT jint JNICALL
132 Java_GetOwnedMonitorInfoWithEATest_getOwnedMonitorInfo(JNIEnv *env, jclass cls, jobject targetThread, jobjectArray resOwnedMonitors) {
133     jvmtiError err;
134     jvmtiThreadInfo threadInfo;
135     jint monitorCount;
136     jobject* monitors;
137     jint idx;
138 
139     err = (*jvmti)-&gt;GetThreadInfo(jvmti, targetThread, &amp;threadInfo);
140     if (err != JVMTI_ERROR_NONE) {
141         ShowErrorMessage(jvmti, err,
142                 &quot;getOwnedMonitorsFor: error in JVMTI GetThreadInfo&quot;);
143         return FAILED;
144     }
145 
146     err = (*jvmti)-&gt;GetOwnedMonitorInfo(jvmti, targetThread, &amp;monitorCount, &amp;monitors);
147     if (err != JVMTI_ERROR_NONE) {
148         ShowErrorMessage(jvmti, err,
149                 &quot;getOwnedMonitorsFor: error in JVMTI GetOwnedMonitorInfo&quot;);
150         return FAILED;
151     }
152 
153     printf(&quot;getOwnedMonitorsFor: %s owns %d monitor(s)\n&quot;, threadInfo.name, monitorCount);
154 
155     for (idx = 0; idx &lt; monitorCount; idx++) {
156       (*env)-&gt;SetObjectArrayElement(env, resOwnedMonitors, idx, monitors[idx]);
157     }
158 
159     (*jvmti)-&gt;Deallocate(jvmti, (unsigned char *) monitors);
160     (*jvmti)-&gt;Deallocate(jvmti, (unsigned char *) threadInfo.name);
161     return monitorCount;
162 }
163 
164 #ifdef __cplusplus
165 }
166 #endif
    </pre>
  </body>
</html>