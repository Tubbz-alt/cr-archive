<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/hotspot/jtreg/gtest/GTestWrapper.java</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="../gc/survivorAlignment/TestPromotionToSurvivor.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="../resourcehogs/TEST.properties.udiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/jtreg/gtest/GTestWrapper.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -23,27 +23,25 @@</span>
  
  /* @test
   * @summary a jtreg wrapper for gtest tests
   * @library /test/lib
   * @modules java.base/jdk.internal.misc
<span class="udiff-line-added">+  *          java.xml</span>
   * @run main/native GTestWrapper
   */
  
<span class="udiff-line-removed">- import java.util.Arrays;</span>
<span class="udiff-line-removed">- import java.util.List;</span>
<span class="udiff-line-removed">- import java.util.Map;</span>
<span class="udiff-line-removed">- import java.util.stream.Stream;</span>
<span class="udiff-line-removed">- import java.util.stream.Collectors;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- import java.io.File;</span>
<span class="udiff-line-removed">- import java.nio.file.Paths;</span>
<span class="udiff-line-removed">- import java.nio.file.Path;</span>
<span class="udiff-line-removed">- </span>
  import jdk.test.lib.Platform;
  import jdk.test.lib.Utils;
  import jdk.test.lib.process.ProcessTools;
<span class="udiff-line-modified-removed">- import jdk.test.lib.process.OutputAnalyzer;</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-added">+ import java.io.File;</span>
<span class="udiff-line-added">+ import java.nio.file.Files;</span>
<span class="udiff-line-added">+ import java.nio.file.Path;</span>
<span class="udiff-line-added">+ import java.nio.file.Paths;</span>
<span class="udiff-line-added">+ import java.util.Collections;</span>
<span class="udiff-line-added">+ import java.util.List;</span>
<span class="udiff-line-added">+ import java.util.Map;</span>
  
  public class GTestWrapper {
      public static void main(String[] args) throws Throwable {
          // gtestLauncher is located in &lt;test_image&gt;/hotspot/gtest/&lt;vm_variant&gt;/
          // nativePath points either to &lt;test_image&gt;/hotspot/jtreg/native or to &lt;test_image&gt;/hotspot/gtest
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -74,16 +72,37 @@</span>
          String ldLibraryPath = System.getenv(pathVar);
          if (ldLibraryPath != null) {
              env.put(pathVar, path + File.pathSeparator + ldLibraryPath);
          }
  
<span class="udiff-line-modified-removed">-         pb.command(new String[] {</span>
<span class="udiff-line-modified-removed">-             execPath.toString(),</span>
<span class="udiff-line-modified-removed">-             &quot;-jdk&quot;,</span>
<span class="udiff-line-modified-removed">-             System.getProperty(&quot;test.jdk&quot;)</span>
<span class="udiff-line-modified-removed">-         });</span>
<span class="udiff-line-modified-removed">-         ProcessTools.executeCommand(pb).shouldHaveExitValue(0);</span>
<span class="udiff-line-modified-added">+         Path resultFile = Paths.get(&quot;test_result.xml&quot;);</span>
<span class="udiff-line-modified-added">+         pb.command(execPath.toAbsolutePath().toString(),</span>
<span class="udiff-line-modified-added">+                 &quot;-jdk&quot;, Utils.TEST_JDK,</span>
<span class="udiff-line-modified-added">+                 &quot;--gtest_output=xml:&quot; + resultFile);</span>
<span class="udiff-line-modified-added">+         int exitCode = ProcessTools.executeCommand(pb).getExitValue();</span>
<span class="udiff-line-modified-added">+         if (exitCode != 0) {</span>
<span class="udiff-line-added">+             List&lt;String&gt; failedTests = failedTests(resultFile);</span>
<span class="udiff-line-added">+             String message = &quot;gtest execution failed; exit code = &quot; + exitCode + &quot;.&quot;;</span>
<span class="udiff-line-added">+             if (!failedTests.isEmpty()) {</span>
<span class="udiff-line-added">+                 message += &quot; the failed tests: &quot; + failedTests;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             throw new AssertionError(message);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private static List&lt;String&gt; failedTests(Path xml) {</span>
<span class="udiff-line-added">+         if (!Files.exists(xml)) {</span>
<span class="udiff-line-added">+             System.err.println(&quot;WARNING: test result file (&quot; + xml + &quot;) hasn&#39;t been found&quot;);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         try {</span>
<span class="udiff-line-added">+             return new GTestResultParser(xml).failedTests();</span>
<span class="udiff-line-added">+         } catch (Throwable t) {</span>
<span class="udiff-line-added">+             System.err.println(&quot;WARNING: failed to parse result file (&quot; + xml + &quot;) &quot; + t);</span>
<span class="udiff-line-added">+             t.printStackTrace();</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         return Collections.emptyList();</span>
      }
  
      private static String getJVMVariantSubDir() {
          if (Platform.isServer()) {
              return &quot;server&quot;;
</pre>
<center><a href="../gc/survivorAlignment/TestPromotionToSurvivor.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="../resourcehogs/TEST.properties.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>