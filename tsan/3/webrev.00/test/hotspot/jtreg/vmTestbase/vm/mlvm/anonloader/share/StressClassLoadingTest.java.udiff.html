<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/hotspot/jtreg/vmTestbase/vm/mlvm/anonloader/share/StressClassLoadingTest.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../nsk/stress/thread/thread006.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../stress/parallelLoad/Test.java.udiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/jtreg/vmTestbase/vm/mlvm/anonloader/share/StressClassLoadingTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -25,10 +25,11 @@</span>
  
  import java.io.File;
  import java.util.Objects;
  import java.util.concurrent.atomic.AtomicBoolean;
  import java.nio.file.Files;
<span class="udiff-line-added">+ import java.nio.file.Path;</span>
  import java.nio.file.Paths;
  import nsk.share.test.Stresser;
  import vm.share.options.Option;
  import vm.share.options.OptionSupport;
  import vm.share.options.IgnoreUnknownArgumentsHandler;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -73,11 +74,11 @@</span>
   *
   * @see vm.mlvm.tools.LoadClass
   */
  public abstract class StressClassLoadingTest extends MlvmTest {
      private static final String RESCUE_FILE_NAME = &quot;_AnonkTestee01.class&quot;;
<span class="udiff-line-modified-removed">-     private static final String HUNG_CLASS_FILE_NAME = &quot;hang%02d.class&quot;;</span>
<span class="udiff-line-modified-added">+     private static final String HUNG_CLASS_FILE_NAME = &quot;hang.class&quot;;</span>
  
      @Option(name = &quot;iterations&quot;, default_value = &quot;100000&quot;,
              description = &quot;How many times generate a class and parse it&quot;)
      private static int iterations;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -133,12 +134,10 @@</span>
      }
  
      public boolean run() throws Exception {
          setupOptions(this);
  
<span class="udiff-line-removed">-         int hangNum = 0;</span>
<span class="udiff-line-removed">- </span>
          Stresser stresser = createStresser();
          stresser.start(iterations);
  
          while (stresser.continueExecution()) {
              stresser.iteration();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -174,43 +173,43 @@</span>
                          Env.traceVerbose(e, &quot;parser caught exception&quot;);
                      }
                  }
              };
  
<span class="udiff-line-removed">-             parserThread.setDaemon(true);</span>
              parserThread.start();
              parserThread.join(parseTimeout);
  
              if (parserThread.isAlive()) {
<span class="udiff-line-modified-removed">-                 Env.complain(&quot;Killing parser thread&quot;);</span>
<span class="udiff-line-modified-added">+                 Env.traceImportant(&quot;parser thread may be hung!&quot;);</span>
                  StackTraceElement[] stack = parserThread.getStackTrace();
<span class="udiff-line-added">+                 Env.traceImportant(&quot;parser thread stack len: &quot; + stack.length);</span>
                  Env.traceImportant(parserThread + &quot; stack trace:&quot;);
                  for (int i = 0; i &lt; stack.length; ++i) {
                      Env.traceImportant(parserThread + &quot;\tat &quot; + stack[i]);
                  }
  
<span class="udiff-line-added">+                 Path savedClassPath = Paths.get(fileNamePrefix + HUNG_CLASS_FILE_NAME);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+                 if (saveClassFile) {</span>
<span class="udiff-line-added">+                     Files.move(rescueFile.toPath(), savedClassPath);</span>
<span class="udiff-line-added">+                     Env.traceImportant(&quot;There was a possible hangup during parsing.&quot;</span>
<span class="udiff-line-added">+                         + &quot; The class file, which produced the possible hangup, was saved as &quot;</span>
<span class="udiff-line-added">+                         + fileNamePrefix + HUNG_CLASS_FILE_NAME</span>
<span class="udiff-line-added">+                         + &quot;... in the test directory. You may want to analyse it &quot;</span>
<span class="udiff-line-added">+                         + &quot;if this test times out.&quot;);</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+                 parserThread.join(); // Wait until either thread finishes or test times out.</span>
                  if (saveClassFile) {
<span class="udiff-line-modified-removed">-                     Files.move(rescueFile.toPath(), Paths.get(fileNamePrefix</span>
<span class="udiff-line-removed">-                             + String.format(HUNG_CLASS_FILE_NAME, hangNum)));</span>
<span class="udiff-line-modified-added">+                     savedClassPath.toFile().delete();</span>
                  }
<span class="udiff-line-removed">-                 ++hangNum;</span>
              } else if (saveClassFile) {
                  rescueFile.delete();
              }
          }
  
          stresser.finish();
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         if (hangNum &gt; 0) {</span>
<span class="udiff-line-removed">-             Env.complain(&quot;There were &quot; + hangNum + &quot; hangups during parsing.&quot;</span>
<span class="udiff-line-removed">-                     + &quot; The class files, which produced hangup were saved as &quot;</span>
<span class="udiff-line-removed">-                     + fileNamePrefix + String.format(HUNG_CLASS_FILE_NAME, 0)</span>
<span class="udiff-line-removed">-                     + &quot;... in the test directory. You may want to analyse them.&quot;</span>
<span class="udiff-line-removed">-                     + &quot; Failing this test because of hangups.&quot;);</span>
<span class="udiff-line-removed">-             return false;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
          return true;
      }
  
      /**
       * Generated class bytes. The method is called for each iteration.
</pre>
<center><a href="../../../../nsk/stress/thread/thread006.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../stress/parallelLoad/Test.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>