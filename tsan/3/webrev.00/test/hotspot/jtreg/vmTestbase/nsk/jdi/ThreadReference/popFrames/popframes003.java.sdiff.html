<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/hotspot/jtreg/vmTestbase/nsk/jdi/ThreadReference/popFrames/popframes003.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="popframes002.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="popframes004.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/jtreg/vmTestbase/nsk/jdi/ThreadReference/popFrames/popframes003.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
141 
142     static int waitTime;
143 
144     static VirtualMachine      vm            = null;
145     static EventRequestManager eventRManager = null;
146     static EventQueue          eventQueue    = null;
147     static EventSet            eventSet      = null;
148     static EventIterator       eventIterator = null;
149 
150     static ReferenceType       debuggeeClass = null;
151 
152     static int  testExitCode = PASSED;
153 
154     BreakpointRequest  bpRequest;
155     MethodEntryRequest meRequest;
156 
157     BreakpointRequest  bpRequest2;
158     MethodEntryRequest meRequest3;
159 
160 
<span class="line-removed">161     class JDITestRuntimeException extends RuntimeException {</span>
<span class="line-removed">162         JDITestRuntimeException(String str) {</span>
<span class="line-removed">163             super(&quot;JDITestRuntimeException : &quot; + str);</span>
<span class="line-removed">164         }</span>
<span class="line-removed">165     }</span>
<span class="line-removed">166 </span>
167     //------------------------------------------------------ methods
168 
169     private int runThis (String argv[], PrintStream out) {
170 
171         argsHandler     = new ArgumentHandler(argv);
172         logHandler      = new Log(out, argsHandler);
173         Binder binder   = new Binder(argsHandler, logHandler);
174 
175         waitTime        = argsHandler.getWaitTime() * 60000;
176 
177         try {
178             log2(&quot;launching a debuggee :&quot;);
179             log2(&quot;       &quot; + debuggeeName);
180             if (argsHandler.verbose()) {
181                 debuggee = binder.bindToDebugee(debuggeeName + &quot; -vbs&quot;);
182             } else {
183                 debuggee = binder.bindToDebugee(debuggeeName);
184             }
185             if (debuggee == null) {
186                 log3(&quot;ERROR: no debuggee launched&quot;);
</pre>
<hr />
<pre>
296         cpRequest.disable();
297 
298         ClassPrepareEvent event = (ClassPrepareEvent) eventIterator.next();
299         debuggeeClass = event.referenceType();
300 
301         if (!debuggeeClass.name().equals(debuggeeName))
302            throw new JDITestRuntimeException(&quot;** Unexpected ClassName for ClassPrepareEvent **&quot;);
303 
304         log2(&quot;      received: ClassPrepareEvent for debuggeeClass&quot;);
305 
306 
307         if ( !vm.canPopFrames() ) {
308             log2(&quot;......vm.canPopFrames() == false : test is cancelled&quot;);
309             vm.resume();
310             return;
311         }
312 
313         String bPointMethod = &quot;methodForCommunication&quot;;
314         String lineForComm  = &quot;lineForComm&quot;;
315 
<span class="line-modified">316         ThreadReference threadMainRef = threadByName(&quot;main&quot;);</span>
317         try {
318             bpRequest = settingBreakpoint(threadMainRef,
319                                           debuggeeClass,
320                                           bPointMethod, lineForComm, &quot;zero&quot;);
321         } catch ( Exception e ) {
322             throw e;
323         }
324         bpRequest.enable();
325 
326     //------------------------------------------------------  testing section
327 
328         log1(&quot;     TESTING BEGINS&quot;);
329 
330         EventSet mainThreadEventSet = null;
331 
332         int flag = 0;
333 
334 
335         vm.resume();
336         breakpointForCommunication();
337 
338         log2(&quot;......setting MethodEntryRequest (meRequest) in ForCommunication.methodForCommunication&quot;);
339         meRequest = settingMethodEntryRequest(threadMainRef,
340                                               debuggeeName + &quot;$ForCommunication&quot;,
341                                               &quot;zero&quot;);
342         log2(&quot;meRequest.enable();&quot;);
343         meRequest.enable();
344 
345 
346         String thread2Name         = &quot;thread2&quot;;
<span class="line-modified">347         ThreadReference thread2Ref = threadByName(thread2Name);</span>
348 
349         String thread3Name         = &quot;thread3&quot;;
<span class="line-modified">350         ThreadReference thread3Ref = threadByName(thread3Name);</span>
351 
352         String poppedMethod    = &quot;poppedMethod&quot;;
353         String breakpointLine  = &quot;breakpointLine&quot;;
354         String testVariable    = &quot;testVar1&quot;;
355 
356         log2(&quot;......setting BreakpointRequest (bpRequest2) in poppedMethod&quot;);
357         List classes = vm.classesByName(debuggeeName + &quot;$Popped&quot;);
358         ReferenceType poppedClass = (ReferenceType) classes.get(0);
359         bpRequest2 = settingBreakpoint(thread2Ref, poppedClass,
360                                           poppedMethod, breakpointLine, &quot;one&quot;);
361         log2(&quot;......bpRequest2.enable();&quot;);
362         bpRequest2.enable();
363 
364         log2(&quot;......setting MethodEntryRequest (meRequest3) in poppedMethod&quot;);
365         meRequest3 = settingMethodEntryRequest(thread3Ref, debuggeeName + &quot;$Popped&quot;,
366                                           &quot;two&quot;);
367         log2(&quot;......meRequest3.enable();&quot;);
368         meRequest3.enable();
369 
370         log2(&quot;......eventSet.resume();&quot;);
</pre>
<hr />
<pre>
461                         log2(&quot;......MethodEntry in mainThread&quot;);
462                     } else {
463                         flag |= 2;
464                         log2(&quot;......MethodEntry in thread3&quot;);
465                     }
466                 }
467             }
468 
469         }
470 
471         log2(&quot;......disabling requests and resuming vm&quot;);
472         meRequest3.disable();
473         vm.resume();
474 
475     //~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
476 
477         log1(&quot;    TESTING ENDS&quot;);
478         return;
479     }
480 
<span class="line-removed">481     private ThreadReference threadByName(String name)</span>
<span class="line-removed">482                  throws JDITestRuntimeException {</span>
<span class="line-removed">483 </span>
<span class="line-removed">484         List         all = vm.allThreads();</span>
<span class="line-removed">485         ListIterator li  = all.listIterator();</span>
<span class="line-removed">486 </span>
<span class="line-removed">487         for (; li.hasNext(); ) {</span>
<span class="line-removed">488             ThreadReference thread = (ThreadReference) li.next();</span>
<span class="line-removed">489             if (thread.name().equals(name))</span>
<span class="line-removed">490                 return thread;</span>
<span class="line-removed">491         }</span>
<span class="line-removed">492         throw new JDITestRuntimeException(&quot;** Thread IS NOT found ** : &quot; + name);</span>
<span class="line-removed">493     }</span>
<span class="line-removed">494 </span>
<span class="line-removed">495 </span>
496   /*
497     * private BreakpointRequest settingBreakpoint(ThreadReference, ReferenceType,
498     *                                             String, String, String)
499     *
500     * It sets up a breakpoint at given line number within a given method in a given class
501     * for a given thread.
502     *
503     * Return value: BreakpointRequest object  in case of success
504     *
505     * JDITestRuntimeException   in case of an Exception thrown within the method
506     */
507 
508     private BreakpointRequest settingBreakpoint ( ThreadReference thread,
509                                                   ReferenceType testedClass,
510                                                   String methodName,
511                                                   String bpLine,
512                                                   String property)
513             throws JDITestRuntimeException {
514 
515         log2(&quot;......setting up a breakpoint:&quot;);
</pre>
</td>
<td>
<hr />
<pre>
141 
142     static int waitTime;
143 
144     static VirtualMachine      vm            = null;
145     static EventRequestManager eventRManager = null;
146     static EventQueue          eventQueue    = null;
147     static EventSet            eventSet      = null;
148     static EventIterator       eventIterator = null;
149 
150     static ReferenceType       debuggeeClass = null;
151 
152     static int  testExitCode = PASSED;
153 
154     BreakpointRequest  bpRequest;
155     MethodEntryRequest meRequest;
156 
157     BreakpointRequest  bpRequest2;
158     MethodEntryRequest meRequest3;
159 
160 






161     //------------------------------------------------------ methods
162 
163     private int runThis (String argv[], PrintStream out) {
164 
165         argsHandler     = new ArgumentHandler(argv);
166         logHandler      = new Log(out, argsHandler);
167         Binder binder   = new Binder(argsHandler, logHandler);
168 
169         waitTime        = argsHandler.getWaitTime() * 60000;
170 
171         try {
172             log2(&quot;launching a debuggee :&quot;);
173             log2(&quot;       &quot; + debuggeeName);
174             if (argsHandler.verbose()) {
175                 debuggee = binder.bindToDebugee(debuggeeName + &quot; -vbs&quot;);
176             } else {
177                 debuggee = binder.bindToDebugee(debuggeeName);
178             }
179             if (debuggee == null) {
180                 log3(&quot;ERROR: no debuggee launched&quot;);
</pre>
<hr />
<pre>
290         cpRequest.disable();
291 
292         ClassPrepareEvent event = (ClassPrepareEvent) eventIterator.next();
293         debuggeeClass = event.referenceType();
294 
295         if (!debuggeeClass.name().equals(debuggeeName))
296            throw new JDITestRuntimeException(&quot;** Unexpected ClassName for ClassPrepareEvent **&quot;);
297 
298         log2(&quot;      received: ClassPrepareEvent for debuggeeClass&quot;);
299 
300 
301         if ( !vm.canPopFrames() ) {
302             log2(&quot;......vm.canPopFrames() == false : test is cancelled&quot;);
303             vm.resume();
304             return;
305         }
306 
307         String bPointMethod = &quot;methodForCommunication&quot;;
308         String lineForComm  = &quot;lineForComm&quot;;
309 
<span class="line-modified">310         ThreadReference threadMainRef = debuggee.threadByNameOrThrow(&quot;main&quot;);</span>
311         try {
312             bpRequest = settingBreakpoint(threadMainRef,
313                                           debuggeeClass,
314                                           bPointMethod, lineForComm, &quot;zero&quot;);
315         } catch ( Exception e ) {
316             throw e;
317         }
318         bpRequest.enable();
319 
320     //------------------------------------------------------  testing section
321 
322         log1(&quot;     TESTING BEGINS&quot;);
323 
324         EventSet mainThreadEventSet = null;
325 
326         int flag = 0;
327 
328 
329         vm.resume();
330         breakpointForCommunication();
331 
332         log2(&quot;......setting MethodEntryRequest (meRequest) in ForCommunication.methodForCommunication&quot;);
333         meRequest = settingMethodEntryRequest(threadMainRef,
334                                               debuggeeName + &quot;$ForCommunication&quot;,
335                                               &quot;zero&quot;);
336         log2(&quot;meRequest.enable();&quot;);
337         meRequest.enable();
338 
339 
340         String thread2Name         = &quot;thread2&quot;;
<span class="line-modified">341         ThreadReference thread2Ref = debuggee.threadByNameOrThrow(thread2Name);</span>
342 
343         String thread3Name         = &quot;thread3&quot;;
<span class="line-modified">344         ThreadReference thread3Ref = debuggee.threadByNameOrThrow(thread3Name);</span>
345 
346         String poppedMethod    = &quot;poppedMethod&quot;;
347         String breakpointLine  = &quot;breakpointLine&quot;;
348         String testVariable    = &quot;testVar1&quot;;
349 
350         log2(&quot;......setting BreakpointRequest (bpRequest2) in poppedMethod&quot;);
351         List classes = vm.classesByName(debuggeeName + &quot;$Popped&quot;);
352         ReferenceType poppedClass = (ReferenceType) classes.get(0);
353         bpRequest2 = settingBreakpoint(thread2Ref, poppedClass,
354                                           poppedMethod, breakpointLine, &quot;one&quot;);
355         log2(&quot;......bpRequest2.enable();&quot;);
356         bpRequest2.enable();
357 
358         log2(&quot;......setting MethodEntryRequest (meRequest3) in poppedMethod&quot;);
359         meRequest3 = settingMethodEntryRequest(thread3Ref, debuggeeName + &quot;$Popped&quot;,
360                                           &quot;two&quot;);
361         log2(&quot;......meRequest3.enable();&quot;);
362         meRequest3.enable();
363 
364         log2(&quot;......eventSet.resume();&quot;);
</pre>
<hr />
<pre>
455                         log2(&quot;......MethodEntry in mainThread&quot;);
456                     } else {
457                         flag |= 2;
458                         log2(&quot;......MethodEntry in thread3&quot;);
459                     }
460                 }
461             }
462 
463         }
464 
465         log2(&quot;......disabling requests and resuming vm&quot;);
466         meRequest3.disable();
467         vm.resume();
468 
469     //~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
470 
471         log1(&quot;    TESTING ENDS&quot;);
472         return;
473     }
474 















475   /*
476     * private BreakpointRequest settingBreakpoint(ThreadReference, ReferenceType,
477     *                                             String, String, String)
478     *
479     * It sets up a breakpoint at given line number within a given method in a given class
480     * for a given thread.
481     *
482     * Return value: BreakpointRequest object  in case of success
483     *
484     * JDITestRuntimeException   in case of an Exception thrown within the method
485     */
486 
487     private BreakpointRequest settingBreakpoint ( ThreadReference thread,
488                                                   ReferenceType testedClass,
489                                                   String methodName,
490                                                   String bpLine,
491                                                   String property)
492             throws JDITestRuntimeException {
493 
494         log2(&quot;......setting up a breakpoint:&quot;);
</pre>
</td>
</tr>
</table>
<center><a href="popframes002.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="popframes004.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>