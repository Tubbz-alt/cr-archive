<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/hotspot/jtreg/vmTestbase/nsk/share/jni/ExceptionCheckingJniEnv.cpp</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2018, 2019, Oracle and/or its affiliates. All rights reserved.</span>
<span class="line-modified">  3  * Copyright (c) 2018, 2019, Google and/or its affiliates. All rights reserved.</span>
  4  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  5  *
  6  * This code is free software; you can redistribute it and/or modify it
  7  * under the terms of the GNU General Public License version 2 only, as
  8  * published by the Free Software Foundation.
  9  *
 10  * This code is distributed in the hope that it will be useful, but WITHOUT
 11  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 12  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 13  * version 2 for more details (a copy is included in the LICENSE file that
 14  * accompanied this code).
 15  *
 16  * You should have received a copy of the GNU General Public License version
 17  * 2 along with this work; if not, write to the Free Software Foundation,
 18  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 19  *
 20  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 21  * or visit www.oracle.com if you need additional information or have any
 22  * questions.
 23  */
 24 
<a name="2" id="anc2"></a><span class="line-added"> 25 #include &lt;stdint.h&gt;</span>
 26 #include &lt;stdlib.h&gt;
 27 #include &lt;string.h&gt;
 28 
 29 #include &quot;ExceptionCheckingJniEnv.hpp&quot;
<a name="3" id="anc3"></a><span class="line-added"> 30 #include &quot;nsk_tools.h&quot;</span>
 31 
 32 namespace {
 33 
<a name="4" id="anc4"></a><span class="line-added"> 34 static const char* get_dirname(const char* fullname) {</span>
<span class="line-added"> 35   const char* p;</span>
<span class="line-added"> 36   const char* base = fullname;;</span>
<span class="line-added"> 37 </span>
<span class="line-added"> 38   if (fullname == NULL) {</span>
<span class="line-added"> 39     return NULL;</span>
<span class="line-added"> 40   }</span>
<span class="line-added"> 41 </span>
<span class="line-added"> 42   for (p = fullname; *p != &#39;\0&#39;; p++) {</span>
<span class="line-added"> 43     if (*p == &#39;/&#39; || *p == &#39;\\&#39;) {</span>
<span class="line-added"> 44       base = p + 1;</span>
<span class="line-added"> 45     }</span>
<span class="line-added"> 46   }</span>
<span class="line-added"> 47   return base;</span>
<span class="line-added"> 48 }</span>
<span class="line-added"> 49 </span>
 50 template&lt;class T = void*&gt;
 51 class JNIVerifier {
 52  public:
<a name="5" id="anc5"></a><span class="line-modified"> 53   JNIVerifier(ExceptionCheckingJniEnv *env, const char* base_message,</span>
<span class="line-modified"> 54               int line, const char* file)</span>
<span class="line-added"> 55       : _env(env), _base_message(base_message), _error_message(NULL),</span>
<span class="line-added"> 56         _line(line), _file(get_dirname(file)) {</span>
<span class="line-added"> 57   }</span>
<span class="line-added"> 58 </span>
<span class="line-added"> 59   // Until C++11 is supported, we have to write multiple template constructors.</span>
<span class="line-added"> 60   template &lt;typename U&gt;</span>
<span class="line-added"> 61   JNIVerifier(ExceptionCheckingJniEnv *env, const char* base_message,</span>
<span class="line-added"> 62               U parameter,</span>
<span class="line-added"> 63               int line, const char* file)</span>
<span class="line-added"> 64       : _env(env), _base_message(base_message), _error_message(NULL),</span>
<span class="line-added"> 65         _line(line), _file(get_dirname(file)) {</span>
<span class="line-added"> 66           PrintPreCall(parameter);</span>
<span class="line-added"> 67   }</span>
<span class="line-added"> 68 </span>
<span class="line-added"> 69   template &lt;typename U, typename V&gt;</span>
<span class="line-added"> 70   JNIVerifier(ExceptionCheckingJniEnv *env, const char* base_message,</span>
<span class="line-added"> 71               U parameter1,</span>
<span class="line-added"> 72               V parameter2,</span>
<span class="line-added"> 73               int line, const char* file)</span>
<span class="line-added"> 74       : _env(env), _base_message(base_message), _error_message(NULL),</span>
<span class="line-added"> 75         _line(line), _file(get_dirname(file)) {</span>
<span class="line-added"> 76           PrintPreCall(parameter1, parameter2);</span>
<span class="line-added"> 77   }</span>
<span class="line-added"> 78 </span>
<span class="line-added"> 79   template &lt;typename U, typename V, typename W&gt;</span>
<span class="line-added"> 80   JNIVerifier(ExceptionCheckingJniEnv *env, const char* base_message,</span>
<span class="line-added"> 81               U parameter1, V parameter2, W parameter3,</span>
<span class="line-added"> 82               int line, const char* file)</span>
<span class="line-added"> 83       : _env(env), _base_message(base_message), _error_message(NULL),</span>
<span class="line-added"> 84         _line(line), _file(get_dirname(file)) {</span>
<span class="line-added"> 85           PrintPreCall(parameter1, parameter2, parameter3);</span>
 86   }
 87 
 88   ~JNIVerifier() {
<a name="6" id="anc6"></a><span class="line-added"> 89     PrintPostCall();</span>
<span class="line-added"> 90 </span>
 91     JNIEnv* jni_env = _env-&gt;GetJNIEnv();
<a name="7" id="anc7"></a><span class="line-modified"> 92     if (jni_env-&gt;ExceptionCheck() &amp;&amp; !_error_message) {</span>
<span class="line-modified"> 93       _error_message = &quot;internal error&quot;;</span>
<span class="line-added"> 94     }</span>
<span class="line-added"> 95 </span>
<span class="line-added"> 96     if (_error_message != NULL) {</span>
<span class="line-added"> 97       GenerateErrorMessage();</span>
<span class="line-added"> 98     }</span>
<span class="line-added"> 99   }</span>
<span class="line-added">100 </span>
<span class="line-added">101   int DecimalToAsciiRec(char *str, int line) {</span>
<span class="line-added">102     if (line == 0) {</span>
<span class="line-added">103       return 0;</span>
<span class="line-added">104     }</span>
<span class="line-added">105 </span>
<span class="line-added">106     int remainder = line % 10;</span>
<span class="line-added">107     long quotient = line / 10;</span>
<span class="line-added">108 </span>
<span class="line-added">109     int pos = DecimalToAsciiRec(str, quotient);</span>
<span class="line-added">110     str[pos] = &#39;0&#39; + remainder;</span>
<span class="line-added">111     return pos + 1;</span>
<span class="line-added">112   }</span>
<span class="line-added">113 </span>
<span class="line-added">114   // Implementing a simple version of sprintf for &quot;%d&quot;...</span>
<span class="line-added">115   void DecimalToAscii(char *str, int line) {</span>
<span class="line-added">116     if (line == 0) {</span>
<span class="line-added">117       str[0] = &#39;0&#39;;</span>
<span class="line-added">118       str[1] = &#39;\0&#39;;</span>
<span class="line-added">119       return;</span>
<span class="line-added">120     }</span>
<span class="line-added">121 </span>
<span class="line-added">122     // Special case for INT32_MIN because otherwise the *1 below will overflow</span>
<span class="line-added">123     // and it won&#39;t work. Let us just be simple here due to this being for</span>
<span class="line-added">124     // tests.</span>
<span class="line-added">125     if (line == INT32_MIN) {</span>
<span class="line-added">126       strcat(str, &quot;-2147483648&quot;);</span>
127       return;
128     }
129 
<a name="8" id="anc8"></a><span class="line-modified">130     if (line &lt; 0) {</span>
<span class="line-modified">131       *str = &#39;-&#39;;</span>
<span class="line-added">132       line *= -1;</span>
<span class="line-added">133       str++;</span>
134     }
<a name="9" id="anc9"></a><span class="line-added">135 </span>
<span class="line-added">136     str[DecimalToAsciiRec(str, line)] = &#39;\0&#39;;</span>
137   }
138 
<a name="10" id="anc10"></a><span class="line-modified">139   void GenerateErrorMessage() {</span>
140     // This is error prone, but:
141     //   - Seems like we cannot use std::string (due to windows/solaris not
142     //   building when used, seemingly due to exception libraries not linking).
143     //   - Seems like we cannot use sprintf due to VS2013 (JDK-8213622).
144     //
145     //   We are aiming to do:
<a name="11" id="anc11"></a><span class="line-modified">146     //     snprintf(full_message, len, &quot;JNI method %s : %s from %s : %d&quot;, _base_message, _error_message,</span>
<span class="line-added">147     //              _file, _line);</span>
148     //   but will use strlen + memcpy instead.
<a name="12" id="anc12"></a><span class="line-modified">149     const char* pre_message = &quot;JNI method &quot;;</span>
150     const char* between_msg = &quot; : &quot;;
<a name="13" id="anc13"></a><span class="line-modified">151     const char* from_msg = &quot; from &quot;;</span>
<span class="line-modified">152 </span>
<span class="line-added">153     const char* file_name = _file ? _file : &quot;Unknown File&quot;;</span>
<span class="line-added">154     const char* strs[] = {</span>
<span class="line-added">155       pre_message,</span>
<span class="line-added">156       _base_message,</span>
<span class="line-added">157       between_msg,</span>
<span class="line-added">158       _error_message,</span>
<span class="line-added">159       from_msg,</span>
<span class="line-added">160       file_name,</span>
<span class="line-added">161       between_msg,</span>
<span class="line-added">162     };</span>
163 
<a name="14" id="anc14"></a><span class="line-modified">164     size_t msg_number = sizeof(strs) / sizeof(strs[0]);</span>
<span class="line-modified">165     size_t len = 0;</span>
<span class="line-added">166     for (size_t i = 0; i &lt; msg_number; i++) {</span>
<span class="line-added">167       len += strlen(strs[i]);</span>
<span class="line-added">168     }</span>
<span class="line-added">169 </span>
<span class="line-added">170     // 32-bit signed means 11 characters due to the &#39;-&#39;.</span>
<span class="line-added">171     const int MAX_INTEGER_DIGITS = 11;</span>
<span class="line-added">172     // Add for the line number and 1 for the &#39;\0&#39;.</span>
<span class="line-added">173     len += MAX_INTEGER_DIGITS + 1;</span>
174 
175     char* full_message = (char*) malloc(len);
176     if (full_message == NULL) {
<a name="15" id="anc15"></a><span class="line-modified">177       _env-&gt;HandleError(_error_message);</span>
178       return;
179     }
180 
<a name="16" id="anc16"></a><span class="line-modified">181     // Now we construct the string using strcat to not use sprintf/std::string</span>
182     // instead of:
<a name="17" id="anc17"></a><span class="line-modified">183     //     snprintf(full_message, len, &quot;JNI method %s : %s from %s:%d&quot;, _base_message,</span>
<span class="line-modified">184     //         _error_message, _file, _line);</span>
<span class="line-modified">185     full_message[0] = &#39;\0&#39;;</span>
<span class="line-modified">186     for (size_t i = 0; i &lt; msg_number; i++) {</span>
<span class="line-modified">187       strcat(full_message, strs[i]);</span>
<span class="line-added">188     }</span>
189 
<a name="18" id="anc18"></a><span class="line-modified">190     // Add line number to end of the string.</span>
<span class="line-modified">191     DecimalToAscii(full_message + strlen(full_message), _line);</span>
<span class="line-modified">192 </span>
<span class="line-added">193     if (strlen(full_message) &gt;= len) {</span>
<span class="line-added">194       _env-&gt;GetJNIEnv()-&gt;FatalError(&quot;Final length of message is not what was expected&quot;);</span>
195     }
196 
197     _env-&gt;HandleError(full_message);
198     free(full_message);
199   }
200 
201   T ResultNotNull(T ptr) {
202     if (ptr == NULL) {
<a name="19" id="anc19"></a><span class="line-modified">203       _error_message = &quot;Return is NULL&quot;;</span>
204     }
205     return ptr;
206   }
207 
<a name="20" id="anc20"></a><span class="line-added">208   T ResultIsZero(T value) {</span>
<span class="line-added">209     if (value != 0) {</span>
<span class="line-added">210       _error_message = &quot;Return is not zero&quot;;</span>
<span class="line-added">211     }</span>
<span class="line-added">212     return value;</span>
<span class="line-added">213   }</span>
<span class="line-added">214 </span>
<span class="line-added">215   void PrintPreCallHeader() {</span>
<span class="line-added">216     if (!nsk_getVerboseMode()) {</span>
<span class="line-added">217       return;</span>
<span class="line-added">218     }</span>
<span class="line-added">219 </span>
<span class="line-added">220     fprintf(stdout, &quot;&gt;&gt; Calling JNI method %s from %s:%d\n&quot;,</span>
<span class="line-added">221             _base_message, _file, _line);</span>
<span class="line-added">222     fprintf(stdout, &quot;&gt;&gt; Calling with these parameter(s):\n&quot;);</span>
<span class="line-added">223   }</span>
<span class="line-added">224 </span>
<span class="line-added">225   // Until we can actually link with C++ more uniformely across architectures,</span>
<span class="line-added">226   // we have to do this...</span>
<span class="line-added">227   template&lt;class U&gt;</span>
<span class="line-added">228   void PrintParameter(U* ptr) {</span>
<span class="line-added">229     fprintf(stdout, &quot;\t%p\n&quot;, ptr);</span>
<span class="line-added">230   }</span>
<span class="line-added">231 </span>
<span class="line-added">232   void PrintParameter(int value) {</span>
<span class="line-added">233     fprintf(stdout, &quot;\t%d\n&quot;, value);</span>
<span class="line-added">234   }</span>
<span class="line-added">235 </span>
<span class="line-added">236   // Until C++11 is supported, we have to write multiple PrintPreCall.</span>
<span class="line-added">237   template&lt;class U&gt;</span>
<span class="line-added">238   void PrintPreCall(U first_parameter) {</span>
<span class="line-added">239     if (!nsk_getVerboseMode()) {</span>
<span class="line-added">240       return;</span>
<span class="line-added">241     }</span>
<span class="line-added">242 </span>
<span class="line-added">243     PrintPreCallHeader();</span>
<span class="line-added">244     PrintParameter(first_parameter);</span>
<span class="line-added">245   }</span>
<span class="line-added">246 </span>
<span class="line-added">247   template&lt;class U, class V&gt;</span>
<span class="line-added">248   void PrintPreCall(U parameter1, V parameter2) {</span>
<span class="line-added">249     if (!nsk_getVerboseMode()) {</span>
<span class="line-added">250       return;</span>
<span class="line-added">251     }</span>
<span class="line-added">252 </span>
<span class="line-added">253     PrintPreCallHeader();</span>
<span class="line-added">254     PrintParameter(parameter1);</span>
<span class="line-added">255     PrintParameter(parameter2);</span>
<span class="line-added">256   }</span>
<span class="line-added">257 </span>
<span class="line-added">258   template&lt;class U, class V, class W&gt;</span>
<span class="line-added">259   void PrintPreCall(U parameter1, V parameter2, W parameter3) {</span>
<span class="line-added">260     if (!nsk_getVerboseMode()) {</span>
<span class="line-added">261       return;</span>
<span class="line-added">262     }</span>
<span class="line-added">263 </span>
<span class="line-added">264     PrintPreCallHeader();</span>
<span class="line-added">265     PrintParameter(parameter1);</span>
<span class="line-added">266     PrintParameter(parameter2);</span>
<span class="line-added">267     PrintParameter(parameter3);</span>
<span class="line-added">268   }</span>
<span class="line-added">269 </span>
<span class="line-added">270   void PrintPostCall() {</span>
<span class="line-added">271     if (!nsk_getVerboseMode()) {</span>
<span class="line-added">272       return;</span>
<span class="line-added">273     }</span>
<span class="line-added">274 </span>
<span class="line-added">275     fprintf(stderr, &quot;&lt;&lt; Called JNI method %s from %s:%d\n&quot;,</span>
<span class="line-added">276             _base_message, _file, _line);</span>
<span class="line-added">277   }</span>
<span class="line-added">278 </span>
279  private:
280   ExceptionCheckingJniEnv* _env;
<a name="21" id="anc21"></a><span class="line-modified">281   const char* const _base_message;</span>
<span class="line-modified">282   const char* _error_message;</span>
<span class="line-added">283   int _line;</span>
<span class="line-added">284   const char* const _file;</span>
285 };
286 
287 }
288 
<a name="22" id="anc22"></a><span class="line-modified">289 jclass ExceptionCheckingJniEnv::FindClass(const char *class_name,</span>
<span class="line-modified">290                                           int line, const char* file_name) {</span>
<span class="line-added">291   JNIVerifier&lt;jclass&gt; marker(this, &quot;FindClass&quot;, class_name, line, file_name);</span>
<span class="line-added">292   return marker.ResultNotNull(_jni_env-&gt;FindClass(class_name));</span>
<span class="line-added">293 }</span>
<span class="line-added">294 </span>
<span class="line-added">295 jint ExceptionCheckingJniEnv::RegisterNatives(jclass clazz,</span>
<span class="line-added">296                                               const JNINativeMethod *methods,</span>
<span class="line-added">297                                               jint nMethods,</span>
<span class="line-added">298                                               int line,</span>
<span class="line-added">299                                               const char* file_name) {</span>
<span class="line-added">300   JNIVerifier&lt;jint&gt; marker(this, &quot;RegisterNatives&quot;, methods, nMethods, line, file_name);</span>
<span class="line-added">301   return marker.ResultIsZero(_jni_env-&gt;RegisterNatives(clazz, methods, nMethods));</span>
<span class="line-added">302 }</span>
<span class="line-added">303 </span>
<span class="line-added">304 jclass ExceptionCheckingJniEnv::GetObjectClass(jobject obj, int line,</span>
<span class="line-added">305                                                const char* file_name) {</span>
<span class="line-added">306   JNIVerifier&lt;jclass&gt; marker(this, &quot;GetObjectClass&quot;, obj, line, file_name);</span>
307   return marker.ResultNotNull(_jni_env-&gt;GetObjectClass(obj));
308 }
309 
<a name="23" id="anc23"></a><span class="line-modified">310 jfieldID ExceptionCheckingJniEnv::GetStaticFieldID(jclass klass, const char *name,</span>
<span class="line-modified">311                                                    const char* type,</span>
<span class="line-added">312                                                    int line, const char* file_name) {</span>
<span class="line-added">313   JNIVerifier&lt;jfieldID&gt; marker(this, &quot;GetStaticFieldID&quot;, klass, name, type,</span>
<span class="line-added">314                                line, file_name);</span>
<span class="line-added">315   return marker.ResultNotNull(_jni_env-&gt;GetStaticFieldID(klass, name, type));</span>
<span class="line-added">316 }</span>
<span class="line-added">317 </span>
<span class="line-added">318 jfieldID ExceptionCheckingJniEnv::GetFieldID(jclass klass, const char *name,</span>
<span class="line-added">319                                              const char* type,</span>
<span class="line-added">320                                              int line, const char* file_name) {</span>
<span class="line-added">321   JNIVerifier&lt;jfieldID&gt; marker(this, &quot;GetFieldID&quot;, klass, name, type, line, file_name);</span>
322   return marker.ResultNotNull(_jni_env-&gt;GetFieldID(klass, name, type));
323 }
324 
<a name="24" id="anc24"></a><span class="line-modified">325 jobject ExceptionCheckingJniEnv::GetStaticObjectField(jclass klass, jfieldID field,</span>
<span class="line-modified">326                                                       int line, const char* file_name) {</span>
<span class="line-added">327   JNIVerifier&lt;jobject&gt; marker(this, &quot;GetStaticObjectField&quot;, klass, field,</span>
<span class="line-added">328                               line, file_name);</span>
<span class="line-added">329   return marker.ResultNotNull(_jni_env-&gt;GetStaticObjectField(klass, field));</span>
<span class="line-added">330 }</span>
<span class="line-added">331 </span>
<span class="line-added">332 jobject ExceptionCheckingJniEnv::GetObjectField(jobject obj, jfieldID field,</span>
<span class="line-added">333                                                 int line, const char* file_name) {</span>
<span class="line-added">334   JNIVerifier&lt;jobject&gt; marker(this, &quot;GetObjectField&quot;, obj, field, line, file_name);</span>
335   return marker.ResultNotNull(_jni_env-&gt;GetObjectField(obj, field));
336 }
337 
<a name="25" id="anc25"></a><span class="line-modified">338 void ExceptionCheckingJniEnv::SetObjectField(jobject obj, jfieldID field, jobject value,</span>
<span class="line-modified">339                                              int line, const char* file_name) {</span>
<span class="line-added">340   JNIVerifier&lt;&gt; marker(this, &quot;SetObjectField&quot;, obj, field, value, line, file_name);</span>
341   _jni_env-&gt;SetObjectField(obj, field, value);
342 }
343 
<a name="26" id="anc26"></a><span class="line-modified">344 jobject ExceptionCheckingJniEnv::NewGlobalRef(jobject obj, int line, const char* file_name) {</span>
<span class="line-modified">345   JNIVerifier&lt;jobject&gt; marker(this, &quot;NewGlobalRef&quot;, obj, line, file_name);</span>
346   return marker.ResultNotNull(_jni_env-&gt;NewGlobalRef(obj));
347 }
348 
<a name="27" id="anc27"></a><span class="line-modified">349 void ExceptionCheckingJniEnv::DeleteGlobalRef(jobject obj, int line, const char* file_name) {</span>
<span class="line-modified">350   JNIVerifier&lt;&gt; marker(this, &quot;DeleteGlobalRef&quot;, obj, line, file_name);</span>
351   _jni_env-&gt;DeleteGlobalRef(obj);
352 }
353 
<a name="28" id="anc28"></a><span class="line-modified">354 jobject ExceptionCheckingJniEnv::NewLocalRef(jobject obj, int line, const char* file_name) {</span>
<span class="line-modified">355   JNIVerifier&lt;jobject&gt; marker(this, &quot;NewLocalRef&quot;, obj, line, file_name);</span>
356   return marker.ResultNotNull(_jni_env-&gt;NewLocalRef(obj));
357 }
358 
<a name="29" id="anc29"></a><span class="line-modified">359 void ExceptionCheckingJniEnv::DeleteLocalRef(jobject obj, int line, const char* file_name) {</span>
<span class="line-modified">360   JNIVerifier&lt;&gt; marker(this, &quot;DeleteLocalRef&quot;, obj, line, file_name);</span>
361   _jni_env-&gt;DeleteLocalRef(obj);
362 }
363 
<a name="30" id="anc30"></a><span class="line-modified">364 jweak ExceptionCheckingJniEnv::NewWeakGlobalRef(jobject obj, int line, const char* file_name) {</span>
<span class="line-modified">365   JNIVerifier&lt;jweak&gt; marker(this, &quot;NewWeakGlobalRef&quot;, obj, line, file_name);</span>
366   return marker.ResultNotNull(_jni_env-&gt;NewWeakGlobalRef(obj));
367 }
368 
<a name="31" id="anc31"></a><span class="line-modified">369 void ExceptionCheckingJniEnv::DeleteWeakGlobalRef(jweak weak_ref, int line, const char* file_name) {</span>
<span class="line-modified">370   JNIVerifier&lt;&gt; marker(this, &quot;DeleteWeakGlobalRef&quot;, weak_ref, line, file_name);</span>
371   _jni_env-&gt;DeleteWeakGlobalRef(weak_ref);
372 }
373 
<a name="32" id="anc32"></a><span class="line-modified">374 jsize ExceptionCheckingJniEnv::GetArrayLength(jarray array, int line, const char* file_name) {</span>
<span class="line-modified">375   JNIVerifier&lt;&gt; marker(this, &quot;GetArrayLength&quot;, array, line, file_name);</span>
376   return _jni_env-&gt;GetArrayLength(array);
377 }
378 
<a name="33" id="anc33"></a><span class="line-modified">379 jsize ExceptionCheckingJniEnv::GetStringLength(jstring str, int line, const char* file_name) {</span>
<span class="line-modified">380   JNIVerifier&lt;&gt; marker(this, &quot;GetStringLength&quot;, str, line, file_name);</span>
381   return _jni_env-&gt;GetStringLength(str);
382 }
383 
<a name="34" id="anc34"></a><span class="line-modified">384 void* ExceptionCheckingJniEnv::GetPrimitiveArrayCritical(jarray array, jboolean* is_copy,</span>
<span class="line-modified">385                                                          int line, const char* file_name) {</span>
<span class="line-modified">386   JNIVerifier&lt;&gt; marker(this, &quot;GetPrimitiveArrayCritical&quot;, array, is_copy, line, file_name);</span>
<span class="line-added">387   return marker.ResultNotNull(_jni_env-&gt;GetPrimitiveArrayCritical(array, is_copy));</span>
388 }
389 
<a name="35" id="anc35"></a><span class="line-modified">390 void ExceptionCheckingJniEnv::ReleasePrimitiveArrayCritical(jarray array, void* carray, jint mode,</span>
<span class="line-modified">391                                                             int line, const char* file_name) {</span>
<span class="line-added">392   JNIVerifier&lt;&gt; marker(this, &quot;ReleasePrimitiveArrayCritical&quot;, array, carray, mode,</span>
<span class="line-added">393                        line, file_name);</span>
394   _jni_env-&gt;ReleasePrimitiveArrayCritical(array, carray, mode);
395 }
396 
<a name="36" id="anc36"></a><span class="line-modified">397 const jchar* ExceptionCheckingJniEnv::GetStringCritical(jstring str, jboolean* is_copy,</span>
<span class="line-modified">398                                                         int line, const char* file_name) {</span>
<span class="line-modified">399   JNIVerifier&lt;const jchar*&gt; marker(this, &quot;GetPrimitiveArrayCritical&quot;, str, is_copy,</span>
<span class="line-added">400                                    line, file_name);</span>
<span class="line-added">401   return marker.ResultNotNull(_jni_env-&gt;GetStringCritical(str, is_copy));</span>
402 }
403 
<a name="37" id="anc37"></a><span class="line-modified">404 void ExceptionCheckingJniEnv::ReleaseStringCritical(jstring str, const jchar* carray,</span>
<span class="line-modified">405                                                     int line, const char* file_name) {</span>
<span class="line-added">406   JNIVerifier&lt;&gt; marker(this, &quot;ReleaseStringCritical&quot;, str, carray, line, file_name);</span>
407   _jni_env-&gt;ReleaseStringCritical(str, carray);
408 }
<a name="38" id="anc38"></a><span class="line-added">409 </span>
<span class="line-added">410 jbyte* ExceptionCheckingJniEnv::GetByteArrayElements(jbyteArray array, jboolean* is_copy,</span>
<span class="line-added">411                                                    int line, const char* file_name) {</span>
<span class="line-added">412   JNIVerifier&lt;jbyte*&gt; marker(this, &quot;GetByteArrayElements&quot;, array, is_copy, line, file_name);</span>
<span class="line-added">413   return marker.ResultNotNull(_jni_env-&gt;GetByteArrayElements(array, is_copy));</span>
<span class="line-added">414 }</span>
<span class="line-added">415 </span>
<span class="line-added">416 void ExceptionCheckingJniEnv::ReleaseByteArrayElements(jbyteArray array, jbyte* byte_array, jint mode,</span>
<span class="line-added">417                                                        int line, const char* file_name) {</span>
<span class="line-added">418   JNIVerifier&lt;&gt; marker(this, &quot;ReleaseByteArrayElements&quot;, array, byte_array, mode,</span>
<span class="line-added">419                        line, file_name);</span>
<span class="line-added">420   _jni_env-&gt;ReleaseByteArrayElements(array, byte_array, mode);</span>
<span class="line-added">421 }</span>
<span class="line-added">422 </span>
<span class="line-added">423 jmethodID ExceptionCheckingJniEnv::GetMethodID(jclass klass, const char* name, const char* sig,</span>
<span class="line-added">424                                                int line, const char* file_name) {</span>
<span class="line-added">425   JNIVerifier&lt;jmethodID&gt; marker(this, &quot;GetMethodID&quot;, klass, name, sig, line, file_name);</span>
<span class="line-added">426   return marker.ResultNotNull(_jni_env-&gt;GetMethodID(klass, name, sig));</span>
<span class="line-added">427 }</span>
<span class="line-added">428 </span>
<span class="line-added">429 jmethodID ExceptionCheckingJniEnv::GetStaticMethodID(jclass klass, const char* name, const char* sig,</span>
<span class="line-added">430                                                      int line, const char* file_name) {</span>
<span class="line-added">431   JNIVerifier&lt;jmethodID&gt; marker(this, &quot;GetStaticMethodID&quot;, klass, name, sig, line, file_name);</span>
<span class="line-added">432   return marker.ResultNotNull(_jni_env-&gt;GetStaticMethodID(klass, name, sig));</span>
<span class="line-added">433 }</span>
<span class="line-added">434 </span>
<span class="line-added">435 jboolean ExceptionCheckingJniEnv::IsSameObject(jobject ref1, jobject ref2, int line, const char* file_name) {</span>
<span class="line-added">436   JNIVerifier&lt;&gt; marker(this, &quot;IsSameObject&quot;, ref1, ref2, line, file_name);</span>
<span class="line-added">437   return _jni_env-&gt;IsSameObject(ref1, ref2);</span>
<span class="line-added">438 }</span>
<span class="line-added">439 </span>
<span class="line-added">440 jobject ExceptionCheckingJniEnv::NewObject(jclass klass, jmethodID methodID,</span>
<span class="line-added">441                                            int line, const char* file_name, ...) {</span>
<span class="line-added">442   // In the case of NewObject, we miss the extra arguments passed to NewObject sadly.</span>
<span class="line-added">443   JNIVerifier&lt;jobject&gt; marker(this, &quot;NewObject&quot;, klass, methodID, line, file_name);</span>
<span class="line-added">444 </span>
<span class="line-added">445   va_list args;</span>
<span class="line-added">446   va_start(args, file_name);</span>
<span class="line-added">447   jobject result = marker.ResultNotNull(_jni_env-&gt;NewObjectV(klass, methodID, args));</span>
<span class="line-added">448   va_end(args);</span>
<span class="line-added">449   return result;</span>
<span class="line-added">450 }</span>
<span class="line-added">451 </span>
<span class="line-added">452 jobject ExceptionCheckingJniEnv::CallObjectMethod(jobject obj, jmethodID methodID, int line,</span>
<span class="line-added">453                          const char* file_name, ...) {</span>
<span class="line-added">454   JNIVerifier&lt;&gt; marker(this, &quot;CallObjectMethod&quot;, obj, methodID, line, file_name);</span>
<span class="line-added">455 </span>
<span class="line-added">456   va_list args;</span>
<span class="line-added">457   va_start(args, file_name);</span>
<span class="line-added">458   jobject result = _jni_env-&gt;CallObjectMethodV(obj, methodID, args);</span>
<span class="line-added">459   va_end(args);</span>
<span class="line-added">460   return result;</span>
<span class="line-added">461 }</span>
<span class="line-added">462 </span>
<span class="line-added">463 void ExceptionCheckingJniEnv::CallVoidMethod(jobject obj, jmethodID methodID, int line,</span>
<span class="line-added">464                     const char* file_name, ...) {</span>
<span class="line-added">465   JNIVerifier&lt;&gt; marker(this, &quot;CallVoidMethod&quot;, obj, methodID, line, file_name);</span>
<span class="line-added">466 </span>
<span class="line-added">467   va_list args;</span>
<span class="line-added">468   va_start(args, file_name);</span>
<span class="line-added">469   _jni_env-&gt;CallVoidMethodV(obj, methodID, args);</span>
<span class="line-added">470   va_end(args);</span>
<span class="line-added">471 }</span>
<a name="39" id="anc39"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="39" type="hidden" />
</body>
</html>