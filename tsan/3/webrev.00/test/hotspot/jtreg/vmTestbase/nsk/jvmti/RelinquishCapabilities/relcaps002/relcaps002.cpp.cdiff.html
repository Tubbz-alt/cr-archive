<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff test/hotspot/jtreg/vmTestbase/nsk/jvmti/RelinquishCapabilities/relcaps002/relcaps002.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../relcaps001/relcaps001.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../../ResourceExhausted/resexhausted002/TestDescription.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/jtreg/vmTestbase/nsk/jvmti/RelinquishCapabilities/relcaps002/relcaps002.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 122,24 ***</span>
      /* :16 */
  }
  
  #define CHECK_CAP(initCaps, caps, name)                                         \
      if (caps-&gt;name != 0) {                                                      \
<span class="line-modified">!         success = NSK_FALSE;                                                    \</span>
          NSK_COMPLAIN4(&quot;GetCapabilities() in %s returned capability after add and relinguish all potential capabilities:\n&quot;  \
                        &quot;#   capability: %s\n&quot;                                    \
                        &quot;#   got value:  %d\n&quot;                                    \
                        &quot;#   expected:   %d\n&quot;,                                   \
                          where, #name, (int)caps-&gt;name, 0)       ;               \
      }
  
  /**
   * Check value of known capabilities.
<span class="line-modified">!  * @returns NSK_FALSE if any error occured.</span>
   */
<span class="line-modified">! static int checkCapabilitiesValue(jvmtiCapabilities* caps, jvmtiCapabilities* initCaps, const char where[]) {</span>
<span class="line-modified">!     int success = NSK_TRUE;</span>
  
      CHECK_CAP(initCaps, caps, can_tag_objects);
      CHECK_CAP(initCaps, caps, can_generate_field_modification_events);
      CHECK_CAP(initCaps, caps, can_generate_field_access_events);
      CHECK_CAP(initCaps, caps, can_get_bytecodes);
<span class="line-new-header">--- 122,24 ---</span>
      /* :16 */
  }
  
  #define CHECK_CAP(initCaps, caps, name)                                         \
      if (caps-&gt;name != 0) {                                                      \
<span class="line-modified">!         success = false;                                                        \</span>
          NSK_COMPLAIN4(&quot;GetCapabilities() in %s returned capability after add and relinguish all potential capabilities:\n&quot;  \
                        &quot;#   capability: %s\n&quot;                                    \
                        &quot;#   got value:  %d\n&quot;                                    \
                        &quot;#   expected:   %d\n&quot;,                                   \
                          where, #name, (int)caps-&gt;name, 0)       ;               \
      }
  
  /**
   * Check value of known capabilities.
<span class="line-modified">!  * @returns false if any error occured.</span>
   */
<span class="line-modified">! static bool checkCapabilitiesValue(jvmtiCapabilities* caps, jvmtiCapabilities* initCaps, const char where[]) {</span>
<span class="line-modified">!     bool success = true;</span>
  
      CHECK_CAP(initCaps, caps, can_tag_objects);
      CHECK_CAP(initCaps, caps, can_generate_field_modification_events);
      CHECK_CAP(initCaps, caps, can_generate_field_access_events);
      CHECK_CAP(initCaps, caps, can_get_bytecodes);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 182,21 ***</span>
      return success;
  }
  
  /**
   * Get and check current capabilities.
<span class="line-modified">!  * @returns NSK_FALSE if any error occured.</span>
   */
<span class="line-modified">! static int checkCapabilities(jvmtiEnv* jvmti, jvmtiCapabilities* initCaps, const char where[]) {</span>
<span class="line-modified">!     int success = NSK_TRUE;</span>
      jvmtiCapabilities caps;
  
      memset(&amp;caps, 0, sizeof(jvmtiCapabilities));
  
      NSK_DISPLAY0(&quot;GetCapabilities() for current JVMTI env\n&quot;);
      if (!NSK_JVMTI_VERIFY(jvmti-&gt;GetCapabilities(&amp;caps))) {
<span class="line-modified">!         return NSK_FALSE;</span>
      }
  
      NSK_DISPLAY0(&quot;Got raw capabilities:\n&quot;);
      printRawCapabilities(&amp;caps);
  
<span class="line-new-header">--- 182,21 ---</span>
      return success;
  }
  
  /**
   * Get and check current capabilities.
<span class="line-modified">!  * @returns false if any error occured.</span>
   */
<span class="line-modified">! static bool checkCapabilities(jvmtiEnv* jvmti, jvmtiCapabilities* initCaps, const char where[]) {</span>
<span class="line-modified">!     bool success = true;</span>
      jvmtiCapabilities caps;
  
      memset(&amp;caps, 0, sizeof(jvmtiCapabilities));
  
      NSK_DISPLAY0(&quot;GetCapabilities() for current JVMTI env\n&quot;);
      if (!NSK_JVMTI_VERIFY(jvmti-&gt;GetCapabilities(&amp;caps))) {
<span class="line-modified">!         return false;</span>
      }
  
      NSK_DISPLAY0(&quot;Got raw capabilities:\n&quot;);
      printRawCapabilities(&amp;caps);
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 210,53 ***</span>
      return success;
  }
  
  /**
   * Add given capabilities list.
<span class="line-modified">!  * @returns NSK_FALSE if any error occured.</span>
   */
<span class="line-modified">! static int addCapabilities(jvmtiEnv* jvmti, jvmtiCapabilities* caps) {</span>
      NSK_DISPLAY0(&quot;AddCapabilities() for current JVMTI env\n&quot;);
      if (!NSK_JVMTI_VERIFY(jvmti-&gt;AddCapabilities(caps))) {
<span class="line-modified">!         return NSK_FALSE;</span>
      }
      NSK_DISPLAY0(&quot;  ... set\n&quot;);
  
<span class="line-modified">!     return NSK_TRUE;</span>
  }
  
  /**
   * Remove given capabilities list.
<span class="line-modified">!  * @returns NSK_FALSE if any error occured.</span>
   */
<span class="line-modified">! static int removeCapabilities(jvmtiEnv* jvmti, jvmtiCapabilities* caps, const char where[]) {</span>
      NSK_DISPLAY0(&quot;RelinquishCapabilities() for current JVMTI env\n&quot;);
      if (!NSK_JVMTI_VERIFY(jvmti-&gt;RelinquishCapabilities(caps))) {
<span class="line-modified">!         return NSK_FALSE;</span>
      }
      NSK_DISPLAY0(&quot;  ... relinguished\n&quot;);
  
<span class="line-modified">!     return NSK_TRUE;</span>
  }
  
  /**
   * Get potential capabilities to the given list.
<span class="line-modified">!  * @returns NSK_FALSE if any error occured.</span>
   */
<span class="line-modified">! static int getPotentialCapabilities(jvmtiEnv* jvmti, jvmtiCapabilities* caps) {</span>
      NSK_DISPLAY0(&quot;GetPotentialCapabilities() for current JVMTI env\n&quot;);
      if (!NSK_JVMTI_VERIFY(jvmti-&gt;GetPotentialCapabilities(caps))) {
<span class="line-modified">!         return NSK_FALSE;</span>
      }
  
      NSK_DISPLAY0(&quot;Got raw capabilities:\n&quot;);
      printRawCapabilities(caps);
  
      NSK_DISPLAY0(&quot;Known capabilities:\n&quot;);
      printKnownCapabilities(caps);
  
<span class="line-modified">!     return NSK_TRUE;</span>
  }
  
  /* ============================================================================= */
  
  /** Agent algorithm. */
<span class="line-new-header">--- 210,53 ---</span>
      return success;
  }
  
  /**
   * Add given capabilities list.
<span class="line-modified">!  * @returns false if any error occured.</span>
   */
<span class="line-modified">! static bool addCapabilities(jvmtiEnv* jvmti, jvmtiCapabilities* caps) {</span>
      NSK_DISPLAY0(&quot;AddCapabilities() for current JVMTI env\n&quot;);
      if (!NSK_JVMTI_VERIFY(jvmti-&gt;AddCapabilities(caps))) {
<span class="line-modified">!         return false;</span>
      }
      NSK_DISPLAY0(&quot;  ... set\n&quot;);
  
<span class="line-modified">!     return true;</span>
  }
  
  /**
   * Remove given capabilities list.
<span class="line-modified">!  * @returns false if any error occured.</span>
   */
<span class="line-modified">! static bool removeCapabilities(jvmtiEnv* jvmti, jvmtiCapabilities* caps, const char where[]) {</span>
      NSK_DISPLAY0(&quot;RelinquishCapabilities() for current JVMTI env\n&quot;);
      if (!NSK_JVMTI_VERIFY(jvmti-&gt;RelinquishCapabilities(caps))) {
<span class="line-modified">!         return false;</span>
      }
      NSK_DISPLAY0(&quot;  ... relinguished\n&quot;);
  
<span class="line-modified">!     return true;</span>
  }
  
  /**
   * Get potential capabilities to the given list.
<span class="line-modified">!  * @returns false if any error occured.</span>
   */
<span class="line-modified">! static bool getPotentialCapabilities(jvmtiEnv* jvmti, jvmtiCapabilities* caps) {</span>
      NSK_DISPLAY0(&quot;GetPotentialCapabilities() for current JVMTI env\n&quot;);
      if (!NSK_JVMTI_VERIFY(jvmti-&gt;GetPotentialCapabilities(caps))) {
<span class="line-modified">!         return false;</span>
      }
  
      NSK_DISPLAY0(&quot;Got raw capabilities:\n&quot;);
      printRawCapabilities(caps);
  
      NSK_DISPLAY0(&quot;Known capabilities:\n&quot;);
      printKnownCapabilities(caps);
  
<span class="line-modified">!     return true;</span>
  }
  
  /* ============================================================================= */
  
  /** Agent algorithm. */
</pre>
<hr />
<pre>
<span class="line-old-header">*** 293,23 ***</span>
  /**
   * Callback for VM_DEATH event.
   */
  JNIEXPORT void JNICALL
  callbackVMDeath(jvmtiEnv* jvmti, JNIEnv* jni) {
<span class="line-modified">!     int success = NSK_TRUE;</span>
  
      NSK_DISPLAY0(&quot;&gt;&gt;&gt; Testcase #4: Check capabilities in VM_DEATH callback\n&quot;);
      success = checkCapabilities(jvmti, &amp;initCaps, &quot;VM_DEATH callback&quot;);
  
      NSK_DISPLAY1(&quot;Disable events: %d events\n&quot;, EVENTS_COUNT);
      if (!nsk_jvmti_enableEvents(JVMTI_DISABLE, EVENTS_COUNT, events, NULL)) {
<span class="line-modified">!         success = NSK_FALSE;</span>
      } else {
          NSK_DISPLAY0(&quot;  ... disabled\n&quot;);
      }
  
<span class="line-modified">!     if (success != NSK_TRUE) {</span>
          NSK_DISPLAY1(&quot;Exit with FAIL exit status: %d\n&quot;, STATUS_FAIL);
          NSK_BEFORE_TRACE(exit(STATUS_FAIL));
      }
  }
  
<span class="line-new-header">--- 293,23 ---</span>
  /**
   * Callback for VM_DEATH event.
   */
  JNIEXPORT void JNICALL
  callbackVMDeath(jvmtiEnv* jvmti, JNIEnv* jni) {
<span class="line-modified">!     bool success = true;</span>
  
      NSK_DISPLAY0(&quot;&gt;&gt;&gt; Testcase #4: Check capabilities in VM_DEATH callback\n&quot;);
      success = checkCapabilities(jvmti, &amp;initCaps, &quot;VM_DEATH callback&quot;);
  
      NSK_DISPLAY1(&quot;Disable events: %d events\n&quot;, EVENTS_COUNT);
      if (!nsk_jvmti_enableEvents(JVMTI_DISABLE, EVENTS_COUNT, events, NULL)) {
<span class="line-modified">!         success = false;</span>
      } else {
          NSK_DISPLAY0(&quot;  ... disabled\n&quot;);
      }
  
<span class="line-modified">!     if (success != true) {</span>
          NSK_DISPLAY1(&quot;Exit with FAIL exit status: %d\n&quot;, STATUS_FAIL);
          NSK_BEFORE_TRACE(exit(STATUS_FAIL));
      }
  }
  
</pre>
<center><a href="../relcaps001/relcaps001.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../../ResourceExhausted/resexhausted002/TestDescription.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>