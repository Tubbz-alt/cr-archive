<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/hotspot/jtreg/vmTestbase/nsk/jdi/ListeningConnector/startListening/startlis001.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../IntegerType/_itself_/integertype001.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../../LocatableEvent/thread/thread001.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/jtreg/vmTestbase/nsk/jdi/ListeningConnector/startListening/startlis001.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2000, 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 package nsk.jdi.ListeningConnector.startListening;
 25 
 26 import com.sun.jdi.Bootstrap;
 27 import com.sun.jdi.connect.*;
 28 import com.sun.jdi.VirtualMachine;
 29 
 30 import java.io.*;
 31 
 32 import java.net.InetAddress;
 33 import java.net.UnknownHostException;
 34 

 35 import java.util.Iterator;

 36 import java.util.List;
 37 import java.util.Map;

 38 
 39 import nsk.share.*;
 40 import nsk.share.jpda.*;
 41 import nsk.share.jdi.*;
 42 
 43 
 44 /**
 45  * The test exercises JDI function &lt;code&gt;ListeningConnector.startListening&lt;/code&gt;.
 46  * The &lt;b&gt;Socket Listening Connector&lt;/b&gt; is using as listening
 47  * connector.&lt;br&gt;
 48  * The test cases include:
 49  * &lt;li&gt; checking that listening address returned by
 50  * &lt;code&gt;ListeningConnector.startListening()&lt;/code&gt; matches the address
 51  * which was set via connector&#39;s arguments;
 52  * &lt;li&gt; checking that address generated by
 53  * &lt;code&gt;ListeningConnector.startListening()&lt;/code&gt; is valid i.e.
 54  * debugee VM is accessible via this address.
 55  */
 56 public class startlis001 {
 57     static final int PASSED = 0;
</pre>
<hr />
<pre>
 68     private ListeningConnector connector;
 69     private Map&lt;java.lang.String,? extends com.sun.jdi.connect.Connector.Argument&gt; connArgs;
 70     private PrintStream out;
 71 
 72     IORedirector outRedirector;
 73     IORedirector errRedirector;
 74 
 75     boolean totalRes = true;
 76 
 77     public static void main (String argv[]) {
 78         System.exit(run(argv,System.out) + JCK_STATUS_BASE);
 79     }
 80 
 81     public static int run(String argv[], PrintStream out) {
 82         return new startlis001().runIt(argv, out);
 83     }
 84 
 85     private int runIt(String argv[], PrintStream out) {
 86         String port;
 87         String addr;
<span class="line-removed"> 88         InetAddress inetAddr = null;</span>
 89         ArgumentHandler argHandler = new ArgumentHandler(argv);
 90 
 91 // pass if CONNECTOR_NAME is not implemented
 92 // on this platform
 93         if (argHandler.shouldPass(CONNECTOR_NAME))
 94             return PASSED;
 95         this.out = out;
 96         log = new Log(out, argHandler);
 97 
 98         long timeout = argHandler.getWaitTime() * 60 * 1000;
 99 
<span class="line-modified">100 /* Check that listening address returned by ListeningConnector.startListening()</span>
<span class="line-modified">101    matches the address which was set via connector&#39;s arguments */</span>





102         try {
<span class="line-modified">103             inetAddr = InetAddress.getLocalHost();</span>

104         } catch (UnknownHostException e) {
105             log.complain(&quot;FAILURE: caught UnknownHostException &quot; +
<span class="line-modified">106                 e.getMessage());</span>
107             totalRes = false;
108         }
<span class="line-modified">109         String hostname = inetAddr.getHostName();</span>
<span class="line-removed">110         String ip = inetAddr.getHostAddress();</span>
111         port = argHandler.getTransportPortIfNotDynamic();
112 
113         initConnector(port);
114         if ((addr = startListen()) == null) {
115             log.complain(&quot;Test case #1 FAILED: unable to start listening&quot;);
116             totalRes = false;
<span class="line-modified">117         }</span>
<span class="line-modified">118         else {</span>


119             log.display(&quot;Test case #1: start listening the address &quot; + addr);
<span class="line-modified">120             log.display(&quot;Expected address: &quot;+ hostname + &quot;:&quot; + port +</span>
<span class="line-modified">121                 &quot;\n\tor &quot;+ ip + &quot;:&quot; + port);</span>
<span class="line-modified">122             if ( (!addr.startsWith(hostname) &amp;&amp; !addr.startsWith(ip)) ||</span>
<span class="line-modified">123                  (port != null &amp;&amp; !addr.endsWith(port)) ) {</span>

124                 log.complain(&quot;Test case #1 FAILED: listening address &quot; + addr +
<span class="line-modified">125                     &quot;\ndoes not match expected address:\n&quot; +</span>
<span class="line-removed">126                     hostname + &quot;:&quot; + port + &quot; or &quot; +</span>
<span class="line-removed">127                     ip + &quot;:&quot; + port);</span>
128                 totalRes = false;
129             }
130             if (!stopListen()) {
131                 log.complain(&quot;TEST: unable to stop listening #1&quot;);
132                 totalRes = false;
133             }
134             else
135                log.display(&quot;Test case #1 PASSED: listening address matches expected address&quot;);
136         }
137 
<span class="line-modified">138 /* Check that an address generated by ListeningConnector.startListening()</span>
<span class="line-modified">139    is valid i.e. debugee VM is accessible via this address */</span>
140         initConnector(null);
141         if ((addr = startListen()) == null) {
142             log.complain(&quot;Test case #2 FAILED: unable to start listening&quot;);
143             return FAILED;
144         }
145         else
146             log.display(&quot;Test case #2: start listening the address &quot; + addr);
147 
148         String java = argHandler.getLaunchExecPath()
149                           + &quot; &quot; + argHandler.getLaunchOptions();
150 
151         String cmd = java +
152             &quot; -Xdebug -Xnoagent -Xrunjdwp:transport=dt_socket,server=n,address=&quot; +
153             addr + &quot; &quot; + DEBUGEE_CLASS;
154 
155         Binder binder = new Binder(argHandler, log);
156         Debugee debugee = null;
157 
158         log.display(&quot;command: &quot; + cmd);
159         try {
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 package nsk.jdi.ListeningConnector.startListening;
 25 
 26 import com.sun.jdi.Bootstrap;
 27 import com.sun.jdi.connect.*;
 28 import com.sun.jdi.VirtualMachine;
 29 
 30 import java.io.*;
 31 
 32 import java.net.InetAddress;
 33 import java.net.UnknownHostException;
 34 
<span class="line-added"> 35 import java.util.Arrays;</span>
 36 import java.util.Iterator;
<span class="line-added"> 37 import java.util.LinkedList;</span>
 38 import java.util.List;
 39 import java.util.Map;
<span class="line-added"> 40 import java.util.stream.Collectors;</span>
 41 
 42 import nsk.share.*;
 43 import nsk.share.jpda.*;
 44 import nsk.share.jdi.*;
 45 
 46 
 47 /**
 48  * The test exercises JDI function &lt;code&gt;ListeningConnector.startListening&lt;/code&gt;.
 49  * The &lt;b&gt;Socket Listening Connector&lt;/b&gt; is using as listening
 50  * connector.&lt;br&gt;
 51  * The test cases include:
 52  * &lt;li&gt; checking that listening address returned by
 53  * &lt;code&gt;ListeningConnector.startListening()&lt;/code&gt; matches the address
 54  * which was set via connector&#39;s arguments;
 55  * &lt;li&gt; checking that address generated by
 56  * &lt;code&gt;ListeningConnector.startListening()&lt;/code&gt; is valid i.e.
 57  * debugee VM is accessible via this address.
 58  */
 59 public class startlis001 {
 60     static final int PASSED = 0;
</pre>
<hr />
<pre>
 71     private ListeningConnector connector;
 72     private Map&lt;java.lang.String,? extends com.sun.jdi.connect.Connector.Argument&gt; connArgs;
 73     private PrintStream out;
 74 
 75     IORedirector outRedirector;
 76     IORedirector errRedirector;
 77 
 78     boolean totalRes = true;
 79 
 80     public static void main (String argv[]) {
 81         System.exit(run(argv,System.out) + JCK_STATUS_BASE);
 82     }
 83 
 84     public static int run(String argv[], PrintStream out) {
 85         return new startlis001().runIt(argv, out);
 86     }
 87 
 88     private int runIt(String argv[], PrintStream out) {
 89         String port;
 90         String addr;

 91         ArgumentHandler argHandler = new ArgumentHandler(argv);
 92 
 93 // pass if CONNECTOR_NAME is not implemented
 94 // on this platform
 95         if (argHandler.shouldPass(CONNECTOR_NAME))
 96             return PASSED;
 97         this.out = out;
 98         log = new Log(out, argHandler);
 99 
100         long timeout = argHandler.getWaitTime() * 60 * 1000;
101 
<span class="line-modified">102         /* Check that listening address returned by ListeningConnector.startListening()</span>
<span class="line-modified">103          * matches the address which was set via connector&#39;s arguments.</span>
<span class="line-added">104          * Empty host address causes listening for local connections only (loopback interface).</span>
<span class="line-added">105          * */</span>
<span class="line-added">106         String hostname = &quot;localhost&quot;;</span>
<span class="line-added">107         List&lt;String&gt; validAddresses = new LinkedList&lt;&gt;();</span>
<span class="line-added">108         validAddresses.add(hostname);</span>
109         try {
<span class="line-modified">110             Arrays.stream(InetAddress.getAllByName(hostname))</span>
<span class="line-added">111                     .forEach(address -&gt; validAddresses.add(address.getHostAddress()));</span>
112         } catch (UnknownHostException e) {
113             log.complain(&quot;FAILURE: caught UnknownHostException &quot; +
<span class="line-modified">114                     e.getMessage());</span>
115             totalRes = false;
116         }
<span class="line-modified">117 </span>

118         port = argHandler.getTransportPortIfNotDynamic();
119 
120         initConnector(port);
121         if ((addr = startListen()) == null) {
122             log.complain(&quot;Test case #1 FAILED: unable to start listening&quot;);
123             totalRes = false;
<span class="line-modified">124         } else {</span>
<span class="line-modified">125             String validAddrList = validAddresses.stream()</span>
<span class="line-added">126                     .map(value -&gt; value + &quot;:&quot; + port)</span>
<span class="line-added">127                     .collect(Collectors.joining(&quot; or &quot;));</span>
128             log.display(&quot;Test case #1: start listening the address &quot; + addr);
<span class="line-modified">129             log.display(&quot;Expected addresses: &quot; + validAddrList);</span>
<span class="line-modified">130             final String listenAddr = addr;</span>
<span class="line-modified">131             boolean isValid = validAddresses.stream()</span>
<span class="line-modified">132                     .anyMatch(value -&gt; listenAddr.startsWith(value) &amp;&amp; (port == null || listenAddr.endsWith(port)));</span>
<span class="line-added">133             if (!isValid) {</span>
134                 log.complain(&quot;Test case #1 FAILED: listening address &quot; + addr +
<span class="line-modified">135                     &quot;\ndoes not match expected address:\n&quot; + validAddrList);</span>


136                 totalRes = false;
137             }
138             if (!stopListen()) {
139                 log.complain(&quot;TEST: unable to stop listening #1&quot;);
140                 totalRes = false;
141             }
142             else
143                log.display(&quot;Test case #1 PASSED: listening address matches expected address&quot;);
144         }
145 
<span class="line-modified">146         /* Check that an address generated by ListeningConnector.startListening()</span>
<span class="line-modified">147            is valid i.e. debugee VM is accessible via this address */</span>
148         initConnector(null);
149         if ((addr = startListen()) == null) {
150             log.complain(&quot;Test case #2 FAILED: unable to start listening&quot;);
151             return FAILED;
152         }
153         else
154             log.display(&quot;Test case #2: start listening the address &quot; + addr);
155 
156         String java = argHandler.getLaunchExecPath()
157                           + &quot; &quot; + argHandler.getLaunchOptions();
158 
159         String cmd = java +
160             &quot; -Xdebug -Xnoagent -Xrunjdwp:transport=dt_socket,server=n,address=&quot; +
161             addr + &quot; &quot; + DEBUGEE_CLASS;
162 
163         Binder binder = new Binder(argHandler, log);
164         Debugee debugee = null;
165 
166         log.display(&quot;command: &quot; + cmd);
167         try {
</pre>
</td>
</tr>
</table>
<center><a href="../../IntegerType/_itself_/integertype001.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../../LocatableEvent/thread/thread001.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>