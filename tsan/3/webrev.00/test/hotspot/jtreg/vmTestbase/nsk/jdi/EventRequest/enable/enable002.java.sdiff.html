<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/hotspot/jtreg/vmTestbase/nsk/jdi/EventRequest/enable/enable002.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="enable001.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../getProperty/getproperty001.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/jtreg/vmTestbase/nsk/jdi/EventRequest/enable/enable002.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
137 
138     //====================================================== test program
139     //------------------------------------------------------ common section
140 
141     static Debugee          debuggee;
142     static ArgumentHandler  argsHandler;
143 
144     static int waitTime;
145 
146     static VirtualMachine      vm            = null;
147     static EventRequestManager eventRManager = null;
148     static EventQueue          eventQueue    = null;
149     static EventSet            eventSet      = null;
150     static EventIterator       eventIterator = null;
151 
152     static ReferenceType       debuggeeClass = null;
153 
154     static int  testExitCode = PASSED;
155 
156 
<span class="line-removed">157     class JDITestRuntimeException extends RuntimeException {</span>
<span class="line-removed">158         JDITestRuntimeException(String str) {</span>
<span class="line-removed">159             super(&quot;JDITestRuntimeException : &quot; + str);</span>
<span class="line-removed">160         }</span>
<span class="line-removed">161     }</span>
<span class="line-removed">162 </span>
163     //------------------------------------------------------ methods
164 
165     private int runThis (String argv[], PrintStream out) {
166 
167         argsHandler     = new ArgumentHandler(argv);
168         logHandler      = new Log(out, argsHandler);
169         Binder binder   = new Binder(argsHandler, logHandler);
170 
171         waitTime        = argsHandler.getWaitTime() * 60000;
172 
173         try {
174             log2(&quot;launching a debuggee :&quot;);
175             log2(&quot;       &quot; + debuggeeName);
176             if (argsHandler.verbose()) {
177                 debuggee = binder.bindToDebugee(debuggeeName + &quot; -vbs&quot;);
178             } else {
179                 debuggee = binder.bindToDebugee(debuggeeName);
180             }
181             if (debuggee == null) {
182                 log3(&quot;ERROR: no debuggee launched&quot;);
</pre>
<hr />
<pre>
285         ClassPrepareRequest cpRequest = eventRManager.createClassPrepareRequest();
286         cpRequest.setSuspendPolicy( EventRequest.SUSPEND_EVENT_THREAD);
287         cpRequest.addClassFilter(debuggeeName);
288 
289         cpRequest.enable();
290         vm.resume();
291         getEventSet();
292         cpRequest.disable();
293 
294         ClassPrepareEvent event = (ClassPrepareEvent) eventIterator.next();
295         debuggeeClass = event.referenceType();
296 
297         if (!debuggeeClass.name().equals(debuggeeName))
298            throw new JDITestRuntimeException(&quot;** Unexpected ClassName for ClassPrepareEvent **&quot;);
299 
300         log2(&quot;      received: ClassPrepareEvent for debuggeeClass&quot;);
301 
302         String bPointMethod = &quot;methodForCommunication&quot;;
303         String lineForComm  = &quot;lineForComm&quot;;
304 
<span class="line-modified">305         ThreadReference   mainThread = threadByName(&quot;main&quot;);</span>
306 
307         BreakpointRequest bpRequest = settingBreakpoint(mainThread,
308                                              debuggeeClass,
309                                             bPointMethod, lineForComm, &quot;zero&quot;);
310         bpRequest.enable();
311 
312     //------------------------------------------------------  testing section
313 
314 
315         EventRequest  eventRequest1 = null;
316 
317         String        fieldName1    = &quot;var101&quot;;
318         String        fieldName2    = &quot;excObj&quot;;
319 
320         ThreadReference thread1     = null;
321         String          threadName1 = &quot;thread1&quot;;
322 
323         ReferenceType testClassReference = null;
324 
325 
</pre>
<hr />
<pre>
329 
330             vm.resume();
331             breakpointForCommunication();
332 
333             int instruction = ((IntegerValue)
334                                (debuggeeClass.getValue(debuggeeClass.fieldByName(&quot;instruction&quot;)))).value();
335 
336             if (instruction == 0) {
337                 vm.resume();
338                 break;
339             }
340 
341             log1(&quot;:::::: case: # &quot; + i);
342 
343             //~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ variable part
344 
345 
346             switch (i) {
347 
348               case 0:
<span class="line-modified">349                      thread1 = threadByName(threadName1);</span>
350 
351                      log2(&quot;......setting up StepRequest&quot;);
352                      eventRequest1 = eventRManager.createStepRequest
353                                      (thread1, StepRequest.STEP_MIN, StepRequest.STEP_INTO);
354                      vm.resume();
355                      breakpointForCommunication();
356                      break;
357 
358               case 1:
359                      testClassReference = (ReferenceType) vm.classesByName(testedClassName).get(0);
360 
361                      log2(&quot;......setting up AccessWatchpointRequest&quot;);
362                      eventRequest1 = eventRManager.createAccessWatchpointRequest
363                                     (testClassReference.fieldByName(fieldName1));
364                      break;
365 
366               case 2:
367                      log2(&quot;.....setting up ModificationWatchpointRequest&quot;);
368                      eventRequest1 = eventRManager.createModificationWatchpointRequest
369                                     (testClassReference.fieldByName(fieldName1));
</pre>
<hr />
<pre>
433                 }
434             }
435 
436             log2(&quot;......eventRManager.deleteEventRequest(eventRequest1);&quot;);
437             eventRManager.deleteEventRequest(eventRequest1);
438             try {
439                 log2(&quot;......eventRequest1.enable();  InvalidRequestStateException is expected&quot;);
440                 eventRequest1.enable();
441                 testExitCode = FAILED;
442                 log3(&quot;ERROR:  NO  InvalidRequestStateException&quot;);
443             } catch ( InvalidRequestStateException e ) {
444                     log2(&quot;       InvalidRequestStateException&quot;);
445             }
446 
447             //~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
448         }
449         log1(&quot;    TESTING ENDS&quot;);
450         return;
451     }
452 
<span class="line-removed">453     private ThreadReference threadByName(String name)</span>
<span class="line-removed">454                  throws JDITestRuntimeException {</span>
<span class="line-removed">455 </span>
<span class="line-removed">456         List         all = vm.allThreads();</span>
<span class="line-removed">457         ListIterator li  = all.listIterator();</span>
<span class="line-removed">458 </span>
<span class="line-removed">459         for (; li.hasNext(); ) {</span>
<span class="line-removed">460             ThreadReference thread = (ThreadReference) li.next();</span>
<span class="line-removed">461             if (thread.name().equals(name))</span>
<span class="line-removed">462                 return thread;</span>
<span class="line-removed">463         }</span>
<span class="line-removed">464         throw new JDITestRuntimeException(&quot;** Thread IS NOT found ** : &quot; + name);</span>
<span class="line-removed">465     }</span>
<span class="line-removed">466 </span>
467    /*
468     * private BreakpointRequest settingBreakpoint(ThreadReference, ReferenceType,
469     *                                             String, String, String)
470     *
471     * It sets up a breakpoint at given line number within a given method in a given class
472     * for a given thread.
473     *
474     * Return value: BreakpointRequest object  in case of success
475     *
476     * JDITestRuntimeException   in case of an Exception thrown within the method
477     */
478 
479     private BreakpointRequest settingBreakpoint ( ThreadReference thread,
480                                                   ReferenceType testedClass,
481                                                   String methodName,
482                                                   String bpLine,
483                                                   String property)
484             throws JDITestRuntimeException {
485 
486         log2(&quot;......setting up a breakpoint:&quot;);
</pre>
</td>
<td>
<hr />
<pre>
137 
138     //====================================================== test program
139     //------------------------------------------------------ common section
140 
141     static Debugee          debuggee;
142     static ArgumentHandler  argsHandler;
143 
144     static int waitTime;
145 
146     static VirtualMachine      vm            = null;
147     static EventRequestManager eventRManager = null;
148     static EventQueue          eventQueue    = null;
149     static EventSet            eventSet      = null;
150     static EventIterator       eventIterator = null;
151 
152     static ReferenceType       debuggeeClass = null;
153 
154     static int  testExitCode = PASSED;
155 
156 






157     //------------------------------------------------------ methods
158 
159     private int runThis (String argv[], PrintStream out) {
160 
161         argsHandler     = new ArgumentHandler(argv);
162         logHandler      = new Log(out, argsHandler);
163         Binder binder   = new Binder(argsHandler, logHandler);
164 
165         waitTime        = argsHandler.getWaitTime() * 60000;
166 
167         try {
168             log2(&quot;launching a debuggee :&quot;);
169             log2(&quot;       &quot; + debuggeeName);
170             if (argsHandler.verbose()) {
171                 debuggee = binder.bindToDebugee(debuggeeName + &quot; -vbs&quot;);
172             } else {
173                 debuggee = binder.bindToDebugee(debuggeeName);
174             }
175             if (debuggee == null) {
176                 log3(&quot;ERROR: no debuggee launched&quot;);
</pre>
<hr />
<pre>
279         ClassPrepareRequest cpRequest = eventRManager.createClassPrepareRequest();
280         cpRequest.setSuspendPolicy( EventRequest.SUSPEND_EVENT_THREAD);
281         cpRequest.addClassFilter(debuggeeName);
282 
283         cpRequest.enable();
284         vm.resume();
285         getEventSet();
286         cpRequest.disable();
287 
288         ClassPrepareEvent event = (ClassPrepareEvent) eventIterator.next();
289         debuggeeClass = event.referenceType();
290 
291         if (!debuggeeClass.name().equals(debuggeeName))
292            throw new JDITestRuntimeException(&quot;** Unexpected ClassName for ClassPrepareEvent **&quot;);
293 
294         log2(&quot;      received: ClassPrepareEvent for debuggeeClass&quot;);
295 
296         String bPointMethod = &quot;methodForCommunication&quot;;
297         String lineForComm  = &quot;lineForComm&quot;;
298 
<span class="line-modified">299         ThreadReference   mainThread = debuggee.threadByNameOrThrow(&quot;main&quot;);</span>
300 
301         BreakpointRequest bpRequest = settingBreakpoint(mainThread,
302                                              debuggeeClass,
303                                             bPointMethod, lineForComm, &quot;zero&quot;);
304         bpRequest.enable();
305 
306     //------------------------------------------------------  testing section
307 
308 
309         EventRequest  eventRequest1 = null;
310 
311         String        fieldName1    = &quot;var101&quot;;
312         String        fieldName2    = &quot;excObj&quot;;
313 
314         ThreadReference thread1     = null;
315         String          threadName1 = &quot;thread1&quot;;
316 
317         ReferenceType testClassReference = null;
318 
319 
</pre>
<hr />
<pre>
323 
324             vm.resume();
325             breakpointForCommunication();
326 
327             int instruction = ((IntegerValue)
328                                (debuggeeClass.getValue(debuggeeClass.fieldByName(&quot;instruction&quot;)))).value();
329 
330             if (instruction == 0) {
331                 vm.resume();
332                 break;
333             }
334 
335             log1(&quot;:::::: case: # &quot; + i);
336 
337             //~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ variable part
338 
339 
340             switch (i) {
341 
342               case 0:
<span class="line-modified">343                      thread1 = debuggee.threadByNameOrThrow(threadName1);</span>
344 
345                      log2(&quot;......setting up StepRequest&quot;);
346                      eventRequest1 = eventRManager.createStepRequest
347                                      (thread1, StepRequest.STEP_MIN, StepRequest.STEP_INTO);
348                      vm.resume();
349                      breakpointForCommunication();
350                      break;
351 
352               case 1:
353                      testClassReference = (ReferenceType) vm.classesByName(testedClassName).get(0);
354 
355                      log2(&quot;......setting up AccessWatchpointRequest&quot;);
356                      eventRequest1 = eventRManager.createAccessWatchpointRequest
357                                     (testClassReference.fieldByName(fieldName1));
358                      break;
359 
360               case 2:
361                      log2(&quot;.....setting up ModificationWatchpointRequest&quot;);
362                      eventRequest1 = eventRManager.createModificationWatchpointRequest
363                                     (testClassReference.fieldByName(fieldName1));
</pre>
<hr />
<pre>
427                 }
428             }
429 
430             log2(&quot;......eventRManager.deleteEventRequest(eventRequest1);&quot;);
431             eventRManager.deleteEventRequest(eventRequest1);
432             try {
433                 log2(&quot;......eventRequest1.enable();  InvalidRequestStateException is expected&quot;);
434                 eventRequest1.enable();
435                 testExitCode = FAILED;
436                 log3(&quot;ERROR:  NO  InvalidRequestStateException&quot;);
437             } catch ( InvalidRequestStateException e ) {
438                     log2(&quot;       InvalidRequestStateException&quot;);
439             }
440 
441             //~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
442         }
443         log1(&quot;    TESTING ENDS&quot;);
444         return;
445     }
446 














447    /*
448     * private BreakpointRequest settingBreakpoint(ThreadReference, ReferenceType,
449     *                                             String, String, String)
450     *
451     * It sets up a breakpoint at given line number within a given method in a given class
452     * for a given thread.
453     *
454     * Return value: BreakpointRequest object  in case of success
455     *
456     * JDITestRuntimeException   in case of an Exception thrown within the method
457     */
458 
459     private BreakpointRequest settingBreakpoint ( ThreadReference thread,
460                                                   ReferenceType testedClass,
461                                                   String methodName,
462                                                   String bpLine,
463                                                   String property)
464             throws JDITestRuntimeException {
465 
466         log2(&quot;......setting up a breakpoint:&quot;);
</pre>
</td>
</tr>
</table>
<center><a href="enable001.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../getProperty/getproperty001.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>