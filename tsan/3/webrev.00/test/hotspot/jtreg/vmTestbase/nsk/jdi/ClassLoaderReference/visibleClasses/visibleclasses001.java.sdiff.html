<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/hotspot/jtreg/vmTestbase/nsk/jdi/ClassLoaderReference/visibleClasses/visibleclasses001.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../definedClasses/definedclasses001.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../../ClassPrepareRequest/addClassExclusionFilter/filter003.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/jtreg/vmTestbase/nsk/jdi/ClassLoaderReference/visibleClasses/visibleclasses001.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
143 
144     static Debugee          debuggee;
145     static ArgumentHandler  argsHandler;
146 
147     static int waitTime;
148 
149     static VirtualMachine      vm            = null;
150     static EventRequestManager eventRManager = null;
151     static EventQueue          eventQueue    = null;
152     static EventSet            eventSet      = null;
153     static EventIterator       eventIterator = null;
154 
155     static ReferenceType       debuggeeClass = null;
156 
157     static int  testExitCode = PASSED;
158     static List&lt;String&gt; primitiveArraysNamesPatterns = Arrays.asList(new String[] {
159         &quot;^boolean(\\[\\])+&quot;, &quot;^byte(\\[\\])+&quot;, &quot;^char(\\[\\])+&quot;, &quot;^int(\\[\\])+&quot;,
160         &quot;^short(\\[\\])+&quot;, &quot;^long(\\[\\])+&quot;, &quot;^float(\\[\\])+&quot;, &quot;^double(\\[\\])+&quot;});
161 
162 
<span class="line-removed">163     class JDITestRuntimeException extends RuntimeException {</span>
<span class="line-removed">164         JDITestRuntimeException(String str) {</span>
<span class="line-removed">165             super(&quot;JDITestRuntimeException : &quot; + str);</span>
<span class="line-removed">166         }</span>
<span class="line-removed">167     }</span>
<span class="line-removed">168 </span>
169     //------------------------------------------------------ methods
170 
171     private int runThis (String argv[], PrintStream out) {
172 
173         argsHandler     = new ArgumentHandler(argv);
174         logHandler      = new Log(out, argsHandler);
175         Binder binder   = new Binder(argsHandler, logHandler);
176 
177         waitTime        = argsHandler.getWaitTime() * 60000;
178 
179         try {
180             log2(&quot;launching a debuggee :&quot;);
181             log2(&quot;       &quot; + debuggeeName);
182             if (argsHandler.verbose()) {
183                 debuggee = binder.bindToDebugee(debuggeeName + &quot; -vbs&quot;);
184             } else {
185                 debuggee = binder.bindToDebugee(debuggeeName);
186             }
187             if (debuggee == null) {
188                 log3(&quot;ERROR: no debuggee launched&quot;);
</pre>
<hr />
<pre>
292         cpRequest.setSuspendPolicy( EventRequest.SUSPEND_EVENT_THREAD);
293         cpRequest.addClassFilter(debuggeeName);
294 
295         cpRequest.enable();
296         vm.resume();
297         getEventSet();
298         cpRequest.disable();
299 
300         ClassPrepareEvent event = (ClassPrepareEvent) eventIterator.next();
301         debuggeeClass = event.referenceType();
302 
303         if (!debuggeeClass.name().equals(debuggeeName))
304            throw new JDITestRuntimeException(&quot;** Unexpected ClassName for ClassPrepareEvent **&quot;);
305 
306         log2(&quot;      received: ClassPrepareEvent for debuggeeClass&quot;);
307 
308         String bPointMethod = &quot;methodForCommunication&quot;;
309         String lineForComm  = &quot;lineForComm&quot;;
310         BreakpointRequest bpRequest;
311 
<span class="line-modified">312         bpRequest = settingBreakpoint(threadByName(&quot;main&quot;),</span>
313                                       debuggeeClass,
314                                       bPointMethod, lineForComm, &quot;zero&quot;);
315         bpRequest.enable();
316 
317     //------------------------------------------------------  testing section
318 
319         log1(&quot;     TESTING BEGINS&quot;);
320 
321         for (int i = 0; ; i++) {
322 
323             vm.resume();
324             breakpointForCommunication();
325 
326             int instruction = ((IntegerValue)
327                                (debuggeeClass.getValue(debuggeeClass.fieldByName(&quot;instruction&quot;)))).value();
328 
329             if (instruction == 0) {
330                 vm.resume();
331                 break;
332             }
</pre>
<hr />
<pre>
373                     if (primitiveArraysNamesPatterns.stream().anyMatch(vcl.name()::matches)) {
374                         log2(&quot;     : visibleClasses[&quot; + vclIndex + &quot;].name() == &quot; + vclName +
375                             &quot; Correct - primitive arrays are visible for class loader&quot;);
376                     } else {
377                         log3(&quot;     : visibleClasses[&quot; + vclIndex + &quot;].name() == &quot; + vclName);
378 
379                         classes.stream().filter(cl -&gt; cl.name().equals(vclName))
380                                         .forEach(cl -&gt; log3(&quot;     :  List classes contains an object with the name: &quot; + cl.name()));
381 
382                         testExitCode = FAILED;
383                     }
384                 }
385             }
386 
387             //~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
388         }
389         log1(&quot;    TESTING ENDS&quot;);
390         return;
391     }
392 
<span class="line-removed">393     private ThreadReference threadByName(String name)</span>
<span class="line-removed">394                  throws JDITestRuntimeException {</span>
<span class="line-removed">395 </span>
<span class="line-removed">396         List         all = vm.allThreads();</span>
<span class="line-removed">397         ListIterator li  = all.listIterator();</span>
<span class="line-removed">398 </span>
<span class="line-removed">399         for (; li.hasNext(); ) {</span>
<span class="line-removed">400             ThreadReference thread = (ThreadReference) li.next();</span>
<span class="line-removed">401             if (thread.name().equals(name))</span>
<span class="line-removed">402                 return thread;</span>
<span class="line-removed">403         }</span>
<span class="line-removed">404         throw new JDITestRuntimeException(&quot;** Thread IS NOT found ** : &quot; + name);</span>
<span class="line-removed">405     }</span>
<span class="line-removed">406 </span>
<span class="line-removed">407 </span>
408    /*
409     * private BreakpointRequest settingBreakpoint(ThreadReference, ReferenceType,
410     *                                             String, String, String)
411     *
412     * It sets up a breakpoint at given line number within a given method in a given class
413     * for a given thread.
414     *
415     * Return value: BreakpointRequest object  in case of success
416     *
417     * JDITestRuntimeException   in case of an Exception thrown within the method
418     */
419 
420     private BreakpointRequest settingBreakpoint ( ThreadReference thread,
421                                                   ReferenceType testedClass,
422                                                   String methodName,
423                                                   String bpLine,
424                                                   String property)
425             throws JDITestRuntimeException {
426 
427         log2(&quot;......setting up a breakpoint:&quot;);
</pre>
</td>
<td>
<hr />
<pre>
143 
144     static Debugee          debuggee;
145     static ArgumentHandler  argsHandler;
146 
147     static int waitTime;
148 
149     static VirtualMachine      vm            = null;
150     static EventRequestManager eventRManager = null;
151     static EventQueue          eventQueue    = null;
152     static EventSet            eventSet      = null;
153     static EventIterator       eventIterator = null;
154 
155     static ReferenceType       debuggeeClass = null;
156 
157     static int  testExitCode = PASSED;
158     static List&lt;String&gt; primitiveArraysNamesPatterns = Arrays.asList(new String[] {
159         &quot;^boolean(\\[\\])+&quot;, &quot;^byte(\\[\\])+&quot;, &quot;^char(\\[\\])+&quot;, &quot;^int(\\[\\])+&quot;,
160         &quot;^short(\\[\\])+&quot;, &quot;^long(\\[\\])+&quot;, &quot;^float(\\[\\])+&quot;, &quot;^double(\\[\\])+&quot;});
161 
162 






163     //------------------------------------------------------ methods
164 
165     private int runThis (String argv[], PrintStream out) {
166 
167         argsHandler     = new ArgumentHandler(argv);
168         logHandler      = new Log(out, argsHandler);
169         Binder binder   = new Binder(argsHandler, logHandler);
170 
171         waitTime        = argsHandler.getWaitTime() * 60000;
172 
173         try {
174             log2(&quot;launching a debuggee :&quot;);
175             log2(&quot;       &quot; + debuggeeName);
176             if (argsHandler.verbose()) {
177                 debuggee = binder.bindToDebugee(debuggeeName + &quot; -vbs&quot;);
178             } else {
179                 debuggee = binder.bindToDebugee(debuggeeName);
180             }
181             if (debuggee == null) {
182                 log3(&quot;ERROR: no debuggee launched&quot;);
</pre>
<hr />
<pre>
286         cpRequest.setSuspendPolicy( EventRequest.SUSPEND_EVENT_THREAD);
287         cpRequest.addClassFilter(debuggeeName);
288 
289         cpRequest.enable();
290         vm.resume();
291         getEventSet();
292         cpRequest.disable();
293 
294         ClassPrepareEvent event = (ClassPrepareEvent) eventIterator.next();
295         debuggeeClass = event.referenceType();
296 
297         if (!debuggeeClass.name().equals(debuggeeName))
298            throw new JDITestRuntimeException(&quot;** Unexpected ClassName for ClassPrepareEvent **&quot;);
299 
300         log2(&quot;      received: ClassPrepareEvent for debuggeeClass&quot;);
301 
302         String bPointMethod = &quot;methodForCommunication&quot;;
303         String lineForComm  = &quot;lineForComm&quot;;
304         BreakpointRequest bpRequest;
305 
<span class="line-modified">306         bpRequest = settingBreakpoint(debuggee.threadByNameOrThrow(&quot;main&quot;),</span>
307                                       debuggeeClass,
308                                       bPointMethod, lineForComm, &quot;zero&quot;);
309         bpRequest.enable();
310 
311     //------------------------------------------------------  testing section
312 
313         log1(&quot;     TESTING BEGINS&quot;);
314 
315         for (int i = 0; ; i++) {
316 
317             vm.resume();
318             breakpointForCommunication();
319 
320             int instruction = ((IntegerValue)
321                                (debuggeeClass.getValue(debuggeeClass.fieldByName(&quot;instruction&quot;)))).value();
322 
323             if (instruction == 0) {
324                 vm.resume();
325                 break;
326             }
</pre>
<hr />
<pre>
367                     if (primitiveArraysNamesPatterns.stream().anyMatch(vcl.name()::matches)) {
368                         log2(&quot;     : visibleClasses[&quot; + vclIndex + &quot;].name() == &quot; + vclName +
369                             &quot; Correct - primitive arrays are visible for class loader&quot;);
370                     } else {
371                         log3(&quot;     : visibleClasses[&quot; + vclIndex + &quot;].name() == &quot; + vclName);
372 
373                         classes.stream().filter(cl -&gt; cl.name().equals(vclName))
374                                         .forEach(cl -&gt; log3(&quot;     :  List classes contains an object with the name: &quot; + cl.name()));
375 
376                         testExitCode = FAILED;
377                     }
378                 }
379             }
380 
381             //~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
382         }
383         log1(&quot;    TESTING ENDS&quot;);
384         return;
385     }
386 















387    /*
388     * private BreakpointRequest settingBreakpoint(ThreadReference, ReferenceType,
389     *                                             String, String, String)
390     *
391     * It sets up a breakpoint at given line number within a given method in a given class
392     * for a given thread.
393     *
394     * Return value: BreakpointRequest object  in case of success
395     *
396     * JDITestRuntimeException   in case of an Exception thrown within the method
397     */
398 
399     private BreakpointRequest settingBreakpoint ( ThreadReference thread,
400                                                   ReferenceType testedClass,
401                                                   String methodName,
402                                                   String bpLine,
403                                                   String property)
404             throws JDITestRuntimeException {
405 
406         log2(&quot;......setting up a breakpoint:&quot;);
</pre>
</td>
</tr>
</table>
<center><a href="../definedClasses/definedclasses001.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../../ClassPrepareRequest/addClassExclusionFilter/filter003.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>