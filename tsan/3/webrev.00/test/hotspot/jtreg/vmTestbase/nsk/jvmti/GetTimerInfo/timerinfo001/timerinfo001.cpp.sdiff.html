<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/hotspot/jtreg/vmTestbase/nsk/jvmti/GetTimerInfo/timerinfo001/timerinfo001.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../GetTime/gettime001/gettime001.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../../RawMonitorWait/rawmnwait005/rawmnwait005.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/jtreg/vmTestbase/nsk/jvmti/GetTimerInfo/timerinfo001/timerinfo001.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 32 
 33 /* ============================================================================= */
 34 
 35 static jlong timeout = 0;
 36 
 37 #define STATUS_FAIL     97
 38 
 39 #define EVENTS_COUNT    2
 40 
 41 static jvmtiEvent events[EVENTS_COUNT] = {
 42     JVMTI_EVENT_VM_INIT,
 43     JVMTI_EVENT_VM_DEATH
 44 };
 45 
 46 static jvmtiTimerInfo initInfo;
 47 
 48 /* ============================================================================= */
 49 
 50 /**
 51  * Get timer info and optionally compares it with initial one.
<span class="line-modified"> 52  * @returns NSK_FALSE if any error occured.</span>
 53  */
<span class="line-modified"> 54 static int checkTimerInfo(jvmtiEnv* jvmti, jvmtiTimerInfo* info,</span>
<span class="line-modified"> 55                             jvmtiTimerInfo* initInfo, const char where[]) {</span>
 56 
 57     char buf[32], buf2[32];
<span class="line-modified"> 58     int success = NSK_TRUE;</span>
 59 
 60     NSK_DISPLAY0(&quot;GetTimerInfo() for current JVMTI env\n&quot;);
 61     if (!NSK_JVMTI_VERIFY(
 62             jvmti-&gt;GetTimerInfo(info))) {
<span class="line-modified"> 63         return NSK_FALSE;</span>
 64     }
 65     NSK_DISPLAY0(&quot;Got timer info:\n&quot;);
 66 
 67     NSK_DISPLAY1(&quot;    max_value:         %s\n&quot;,
 68                  julong_to_string((julong)info-&gt;max_value, buf));
 69     NSK_DISPLAY1(&quot;    may_skip_forward:  %d\n&quot;, (int)info-&gt;may_skip_forward);
 70     NSK_DISPLAY1(&quot;    may_skip_backward: %d\n&quot;, (int)info-&gt;may_skip_backward);
 71 
 72     if (initInfo != NULL) {
 73         NSK_DISPLAY0(&quot;Compare with initial timer info\n&quot;);
 74         if (info-&gt;max_value != initInfo-&gt;max_value) {
 75             NSK_COMPLAIN4(&quot;In %s GetTimerInfo() returned different info:\n&quot;
 76                           &quot;#   field:     %s\n&quot;
 77                           &quot;#   got value: %s\n&quot;
 78                           &quot;#   initial:   %s\n&quot;,
 79                           where, &quot;max_value&quot;,
 80                           julong_to_string((julong)info-&gt;max_value, buf),
 81                           julong_to_string((julong)initInfo-&gt;max_value, buf2));
<span class="line-modified"> 82             success = NSK_FALSE;</span>
 83         }
 84         if (info-&gt;may_skip_forward != initInfo-&gt;may_skip_forward) {
 85             NSK_COMPLAIN4(&quot;In %s GetTimerInfo() returned different info:\n&quot;
 86                           &quot;#   field:     %s\n&quot;
 87                           &quot;#   got value: %d\n&quot;
 88                           &quot;#   initial:   %d\n&quot;,
 89                             where, &quot;may_skip_forward&quot;,
 90                             (int)info-&gt;may_skip_forward,
 91                             (int)initInfo-&gt;may_skip_forward);
<span class="line-modified"> 92             success = NSK_FALSE;</span>
 93         }
 94         if (info-&gt;may_skip_backward != initInfo-&gt;may_skip_backward) {
 95             NSK_COMPLAIN4(&quot;In %s GetTimerInfo() returned different info:\n&quot;
 96                           &quot;#   field:     %s\n&quot;
 97                           &quot;#   got value: %d\n&quot;
 98                           &quot;#   initial:   %d\n&quot;,
 99                             where, &quot;may_skip_backward&quot;,
100                             (int)info-&gt;may_skip_backward,
101                             (int)initInfo-&gt;may_skip_backward);
<span class="line-modified">102             success = NSK_FALSE;</span>
103         }
104     }
105 
106     return success;
107 }
108 /* ============================================================================= */
109 
110 /** Agent algorithm. */
111 static void JNICALL
112 agentProc(jvmtiEnv* jvmti, JNIEnv* jni, void* arg) {
113     NSK_DISPLAY0(&quot;Wait for debugee to become ready\n&quot;);
114     if (!nsk_jvmti_waitForSync(timeout))
115         return;
116 
117     NSK_DISPLAY0(&quot;&gt;&gt;&gt; Testcase #3: Check timer info in agent thread\n&quot;);
118     {
119         jvmtiTimerInfo info;
120         if (!checkTimerInfo(jvmti, &amp;info, &amp;initInfo, &quot;agent thread&quot;)) {
121             nsk_jvmti_setFailStatus();
122         }
</pre>
<hr />
<pre>
132 /**
133  * Callback for VM_INIT event.
134  */
135 JNIEXPORT void JNICALL
136 callbackVMInit(jvmtiEnv* jvmti, JNIEnv* jni, jthread thread) {
137 
138     NSK_DISPLAY0(&quot;&gt;&gt;&gt; Testcase #2: Check timer info in VM_INIT callback\n&quot;);
139     {
140         jvmtiTimerInfo info;
141         if (!checkTimerInfo(jvmti, &amp;info, &amp;initInfo, &quot;VM_INIT callback&quot;)) {
142             nsk_jvmti_setFailStatus();
143         }
144     }
145 }
146 
147 /**
148  * Callback for VM_DEATH event.
149  */
150 JNIEXPORT void JNICALL
151 callbackVMDeath(jvmtiEnv* jvmti, JNIEnv* jni) {
<span class="line-modified">152     int success = NSK_TRUE;</span>
153 
154     NSK_DISPLAY0(&quot;&gt;&gt;&gt; Testcase #4: Check timer info in VM_DEATH callback\n&quot;);
155     {
156         jvmtiTimerInfo info;
157         success = checkTimerInfo(jvmti, &amp;info, &amp;initInfo, &quot;VM_DEATH callback&quot;);
158     }
159 
160     NSK_DISPLAY1(&quot;Disable events: %d events\n&quot;, EVENTS_COUNT);
161     if (!nsk_jvmti_enableEvents(JVMTI_DISABLE, EVENTS_COUNT, events, NULL)) {
<span class="line-modified">162         success = NSK_FALSE;</span>
163     } else {
164         NSK_DISPLAY0(&quot;  ... disabled\n&quot;);
165     }
166 
<span class="line-modified">167     if (success != NSK_TRUE) {</span>
168         NSK_DISPLAY1(&quot;Exit with FAIL exit status: %d\n&quot;, STATUS_FAIL);
169         NSK_BEFORE_TRACE(exit(STATUS_FAIL));
170     }
171 }
172 
173 /* ============================================================================= */
174 
175 /** Agent library initialization. */
176 #ifdef STATIC_BUILD
177 JNIEXPORT jint JNICALL Agent_OnLoad_timerinfo001(JavaVM *jvm, char *options, void *reserved) {
178     return Agent_Initialize(jvm, options, reserved);
179 }
180 JNIEXPORT jint JNICALL Agent_OnAttach_timerinfo001(JavaVM *jvm, char *options, void *reserved) {
181     return Agent_Initialize(jvm, options, reserved);
182 }
183 JNIEXPORT jint JNI_OnLoad_timerinfo001(JavaVM *jvm, char *options, void *reserved) {
184     return JNI_VERSION_1_8;
185 }
186 #endif
187 jint Agent_Initialize(JavaVM *jvm, char *options, void *reserved) {
</pre>
</td>
<td>
<hr />
<pre>
 32 
 33 /* ============================================================================= */
 34 
 35 static jlong timeout = 0;
 36 
 37 #define STATUS_FAIL     97
 38 
 39 #define EVENTS_COUNT    2
 40 
 41 static jvmtiEvent events[EVENTS_COUNT] = {
 42     JVMTI_EVENT_VM_INIT,
 43     JVMTI_EVENT_VM_DEATH
 44 };
 45 
 46 static jvmtiTimerInfo initInfo;
 47 
 48 /* ============================================================================= */
 49 
 50 /**
 51  * Get timer info and optionally compares it with initial one.
<span class="line-modified"> 52  * @returns false if any error occured.</span>
 53  */
<span class="line-modified"> 54 static bool checkTimerInfo(jvmtiEnv* jvmti, jvmtiTimerInfo* info,</span>
<span class="line-modified"> 55                            jvmtiTimerInfo* initInfo, const char where[]) {</span>
 56 
 57     char buf[32], buf2[32];
<span class="line-modified"> 58     bool success = true;</span>
 59 
 60     NSK_DISPLAY0(&quot;GetTimerInfo() for current JVMTI env\n&quot;);
 61     if (!NSK_JVMTI_VERIFY(
 62             jvmti-&gt;GetTimerInfo(info))) {
<span class="line-modified"> 63         return false;</span>
 64     }
 65     NSK_DISPLAY0(&quot;Got timer info:\n&quot;);
 66 
 67     NSK_DISPLAY1(&quot;    max_value:         %s\n&quot;,
 68                  julong_to_string((julong)info-&gt;max_value, buf));
 69     NSK_DISPLAY1(&quot;    may_skip_forward:  %d\n&quot;, (int)info-&gt;may_skip_forward);
 70     NSK_DISPLAY1(&quot;    may_skip_backward: %d\n&quot;, (int)info-&gt;may_skip_backward);
 71 
 72     if (initInfo != NULL) {
 73         NSK_DISPLAY0(&quot;Compare with initial timer info\n&quot;);
 74         if (info-&gt;max_value != initInfo-&gt;max_value) {
 75             NSK_COMPLAIN4(&quot;In %s GetTimerInfo() returned different info:\n&quot;
 76                           &quot;#   field:     %s\n&quot;
 77                           &quot;#   got value: %s\n&quot;
 78                           &quot;#   initial:   %s\n&quot;,
 79                           where, &quot;max_value&quot;,
 80                           julong_to_string((julong)info-&gt;max_value, buf),
 81                           julong_to_string((julong)initInfo-&gt;max_value, buf2));
<span class="line-modified"> 82             success = false;</span>
 83         }
 84         if (info-&gt;may_skip_forward != initInfo-&gt;may_skip_forward) {
 85             NSK_COMPLAIN4(&quot;In %s GetTimerInfo() returned different info:\n&quot;
 86                           &quot;#   field:     %s\n&quot;
 87                           &quot;#   got value: %d\n&quot;
 88                           &quot;#   initial:   %d\n&quot;,
 89                             where, &quot;may_skip_forward&quot;,
 90                             (int)info-&gt;may_skip_forward,
 91                             (int)initInfo-&gt;may_skip_forward);
<span class="line-modified"> 92             success = false;</span>
 93         }
 94         if (info-&gt;may_skip_backward != initInfo-&gt;may_skip_backward) {
 95             NSK_COMPLAIN4(&quot;In %s GetTimerInfo() returned different info:\n&quot;
 96                           &quot;#   field:     %s\n&quot;
 97                           &quot;#   got value: %d\n&quot;
 98                           &quot;#   initial:   %d\n&quot;,
 99                             where, &quot;may_skip_backward&quot;,
100                             (int)info-&gt;may_skip_backward,
101                             (int)initInfo-&gt;may_skip_backward);
<span class="line-modified">102             success = false;</span>
103         }
104     }
105 
106     return success;
107 }
108 /* ============================================================================= */
109 
110 /** Agent algorithm. */
111 static void JNICALL
112 agentProc(jvmtiEnv* jvmti, JNIEnv* jni, void* arg) {
113     NSK_DISPLAY0(&quot;Wait for debugee to become ready\n&quot;);
114     if (!nsk_jvmti_waitForSync(timeout))
115         return;
116 
117     NSK_DISPLAY0(&quot;&gt;&gt;&gt; Testcase #3: Check timer info in agent thread\n&quot;);
118     {
119         jvmtiTimerInfo info;
120         if (!checkTimerInfo(jvmti, &amp;info, &amp;initInfo, &quot;agent thread&quot;)) {
121             nsk_jvmti_setFailStatus();
122         }
</pre>
<hr />
<pre>
132 /**
133  * Callback for VM_INIT event.
134  */
135 JNIEXPORT void JNICALL
136 callbackVMInit(jvmtiEnv* jvmti, JNIEnv* jni, jthread thread) {
137 
138     NSK_DISPLAY0(&quot;&gt;&gt;&gt; Testcase #2: Check timer info in VM_INIT callback\n&quot;);
139     {
140         jvmtiTimerInfo info;
141         if (!checkTimerInfo(jvmti, &amp;info, &amp;initInfo, &quot;VM_INIT callback&quot;)) {
142             nsk_jvmti_setFailStatus();
143         }
144     }
145 }
146 
147 /**
148  * Callback for VM_DEATH event.
149  */
150 JNIEXPORT void JNICALL
151 callbackVMDeath(jvmtiEnv* jvmti, JNIEnv* jni) {
<span class="line-modified">152     bool success = true;</span>
153 
154     NSK_DISPLAY0(&quot;&gt;&gt;&gt; Testcase #4: Check timer info in VM_DEATH callback\n&quot;);
155     {
156         jvmtiTimerInfo info;
157         success = checkTimerInfo(jvmti, &amp;info, &amp;initInfo, &quot;VM_DEATH callback&quot;);
158     }
159 
160     NSK_DISPLAY1(&quot;Disable events: %d events\n&quot;, EVENTS_COUNT);
161     if (!nsk_jvmti_enableEvents(JVMTI_DISABLE, EVENTS_COUNT, events, NULL)) {
<span class="line-modified">162         success = false;</span>
163     } else {
164         NSK_DISPLAY0(&quot;  ... disabled\n&quot;);
165     }
166 
<span class="line-modified">167     if (!success) {</span>
168         NSK_DISPLAY1(&quot;Exit with FAIL exit status: %d\n&quot;, STATUS_FAIL);
169         NSK_BEFORE_TRACE(exit(STATUS_FAIL));
170     }
171 }
172 
173 /* ============================================================================= */
174 
175 /** Agent library initialization. */
176 #ifdef STATIC_BUILD
177 JNIEXPORT jint JNICALL Agent_OnLoad_timerinfo001(JavaVM *jvm, char *options, void *reserved) {
178     return Agent_Initialize(jvm, options, reserved);
179 }
180 JNIEXPORT jint JNICALL Agent_OnAttach_timerinfo001(JavaVM *jvm, char *options, void *reserved) {
181     return Agent_Initialize(jvm, options, reserved);
182 }
183 JNIEXPORT jint JNI_OnLoad_timerinfo001(JavaVM *jvm, char *options, void *reserved) {
184     return JNI_VERSION_1_8;
185 }
186 #endif
187 jint Agent_Initialize(JavaVM *jvm, char *options, void *reserved) {
</pre>
</td>
</tr>
</table>
<center><a href="../../GetTime/gettime001/gettime001.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../../RawMonitorWait/rawmnwait005/rawmnwait005.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>