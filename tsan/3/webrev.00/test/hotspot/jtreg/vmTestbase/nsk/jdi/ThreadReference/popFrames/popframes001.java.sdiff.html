<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/hotspot/jtreg/vmTestbase/nsk/jdi/ThreadReference/popFrames/popframes001.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../ThreadDeathRequest/addThreadFilter/addthreadfilter005.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="popframes002.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/jtreg/vmTestbase/nsk/jdi/ThreadReference/popFrames/popframes001.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
145     //====================================================== test program
146     //------------------------------------------------------ common section
147 
148     static Debugee          debuggee;
149     static ArgumentHandler  argsHandler;
150 
151     static int waitTime;
152 
153     static VirtualMachine      vm            = null;
154     static EventRequestManager eventRManager = null;
155     static EventQueue          eventQueue    = null;
156     static EventSet            eventSet      = null;
157     static EventIterator       eventIterator = null;
158 
159     static ReferenceType       debuggeeClass = null;
160 
161     static int  testExitCode = PASSED;
162 
163     BreakpointRequest breakpointRequest;
164 
<span class="line-removed">165     class JDITestRuntimeException extends RuntimeException {</span>
<span class="line-removed">166         JDITestRuntimeException(String str) {</span>
<span class="line-removed">167             super(&quot;JDITestRuntimeException : &quot; + str);</span>
<span class="line-removed">168         }</span>
<span class="line-removed">169     }</span>
<span class="line-removed">170 </span>
171     //------------------------------------------------------ methods
172 
173     private int runThis (String argv[], PrintStream out) {
174 
175         argsHandler     = new ArgumentHandler(argv);
176         logHandler      = new Log(out, argsHandler);
177         Binder binder   = new Binder(argsHandler, logHandler);
178 
179         waitTime        = argsHandler.getWaitTime() * 60000;
180 
181         try {
182             log2(&quot;launching a debuggee :&quot;);
183             log2(&quot;       &quot; + debuggeeName);
184             if (argsHandler.verbose()) {
185                 debuggee = binder.bindToDebugee(debuggeeName + &quot; -vbs&quot;);
186             } else {
187                 debuggee = binder.bindToDebugee(debuggeeName);
188             }
189             if (debuggee == null) {
190                 log3(&quot;ERROR: no debuggee launched&quot;);
</pre>
<hr />
<pre>
295         cpRequest.addClassFilter(debuggeeName);
296 
297         cpRequest.enable();
298         vm.resume();
299         getEventSet();
300         cpRequest.disable();
301 
302         ClassPrepareEvent event = (ClassPrepareEvent) eventIterator.next();
303         debuggeeClass = event.referenceType();
304 
305         if (!debuggeeClass.name().equals(debuggeeName))
306            throw new JDITestRuntimeException(&quot;** Unexpected ClassName for ClassPrepareEvent **&quot;);
307 
308         log2(&quot;      received: ClassPrepareEvent for debuggeeClass&quot;);
309 
310         String bPointMethod = &quot;methodForCommunication&quot;;
311         String lineForComm  = &quot;lineForComm&quot;;
312         BreakpointRequest bpRequest;
313 
314         try {
<span class="line-modified">315             bpRequest = settingBreakpoint(threadByName(&quot;main&quot;),</span>
316                                           debuggeeClass,
317                                           bPointMethod, lineForComm, &quot;zero&quot;);
318         } catch ( Exception e ) {
319             throw e;
320         }
321         bpRequest.enable();
322 
323     //------------------------------------------------------  testing section
324 
325         log1(&quot;     TESTING BEGINS&quot;);
326 
327         log2(&quot;......vm.resume();  resuming debuggee&#39;s main thread&quot;);
328         vm.resume();
329 
330         for (int i = 0; ; i++) {
331 
332 //            vm.resume();
333 
334             breakpointForCommunication();
335 
</pre>
<hr />
<pre>
343                 log3(&quot;ERROR: Exception when &#39;instruction = ((IntegerValue)...&#39; : &quot; + e);
344                 testExitCode = FAILED;
345                 return;
346             }
347 
348             if (instruction == 0) {
349                 vm.resume();
350                 break;
351             }
352 
353             log1(&quot;  new check: # &quot; + i);
354 
355             //~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ variable part
356 
357             if ( !vm.canPopFrames() ) {
358                 log2(&quot;......vm.canPopFrames() == false : test is cancelled&quot;);
359                 return;
360             }
361 
362             String thread2Name         = &quot;thread2&quot;;
<span class="line-modified">363             ThreadReference thread2Ref = threadByName(thread2Name);</span>
364 
365 
366             String poppedMethod    = &quot;poppedMethod&quot;;
367             String breakpointLine  = &quot;breakpointLine&quot;;
368             String testVariable    = &quot;testVar1&quot;;
369 
370             log2(&quot;......setting breakpoint in poppedMethod&quot;);
371             try {
<span class="line-modified">372                 breakpointRequest = settingBreakpoint(threadByName(thread2Name),</span>
373                                           debuggeeClass,
374                                           poppedMethod, breakpointLine, &quot;one&quot;);
375             } catch ( Exception e ) {
376                 throw e;
377             }
378             log2(&quot;......breakpointRequest.enable();&quot;);
379             breakpointRequest.enable();
380 
381             log2(&quot;......eventSet.resume();   resuming debuggee&#39;s main thread&quot;);
382             log2(&quot;                           to get new rendevous at the breakpointForCommunication&quot;);
383             eventSet.resume();
384             log2(&quot;......breakpointInMethod();&quot;);
385             breakpointInMethod();
386 
387             log2(&quot;......getting value of &#39;testVar1&#39;; 1 is expected&quot;);
388             Value val = debuggeeClass.getValue(debuggeeClass.fieldByName(testVariable));
389             int intVal = ((IntegerValue) val).value();
390             if (intVal != 1) {
391                 log3(&quot;ERROR: intVal != 1&quot;);
392                 testExitCode = FAILED;
</pre>
<hr />
<pre>
411             breakpointInMethod();
412 
413             log2(&quot;......getting value of &#39;testVar1&#39;; 2 is expected&quot;);
414             val = debuggeeClass.getValue(debuggeeClass.fieldByName(testVariable));
415             intVal = ((IntegerValue) val).value();
416             if (intVal != 2) {
417                 log3(&quot;ERROR: intVal != 2&quot;);
418                 testExitCode = FAILED;
419                 break;
420             }
421 
422             log2(&quot;......thread2Ref.resume();&quot;);
423             thread2Ref.resume();
424 
425             //~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
426         }
427         log1(&quot;    TESTING ENDS&quot;);
428         return;
429     }
430 
<span class="line-removed">431     private ThreadReference threadByName(String name)</span>
<span class="line-removed">432                  throws JDITestRuntimeException {</span>
<span class="line-removed">433 </span>
<span class="line-removed">434         List         all = vm.allThreads();</span>
<span class="line-removed">435         ListIterator li  = all.listIterator();</span>
<span class="line-removed">436 </span>
<span class="line-removed">437         for (; li.hasNext(); ) {</span>
<span class="line-removed">438             ThreadReference thread = (ThreadReference) li.next();</span>
<span class="line-removed">439             if (thread.name().equals(name))</span>
<span class="line-removed">440                 return thread;</span>
<span class="line-removed">441         }</span>
<span class="line-removed">442         throw new JDITestRuntimeException(&quot;** Thread IS NOT found ** : &quot; + name);</span>
<span class="line-removed">443     }</span>
<span class="line-removed">444 </span>
445    /*
446     * private BreakpointRequest settingBreakpoint(ThreadReference, ReferenceType,
447     *                                             String, String, String)
448     *
449     * It sets up a breakpoint at given line number within a given method in a given class
450     * for a given thread.
451     *
452     * Return value: BreakpointRequest object  in case of success
453     *
454     * JDITestRuntimeException   in case of an Exception thrown within the method
455     */
456 
457     private BreakpointRequest settingBreakpoint ( ThreadReference thread,
458                                                   ReferenceType testedClass,
459                                                   String methodName,
460                                                   String bpLine,
461                                                   String property)
462             throws JDITestRuntimeException {
463 
464         log2(&quot;......setting up a breakpoint:&quot;);
</pre>
</td>
<td>
<hr />
<pre>
145     //====================================================== test program
146     //------------------------------------------------------ common section
147 
148     static Debugee          debuggee;
149     static ArgumentHandler  argsHandler;
150 
151     static int waitTime;
152 
153     static VirtualMachine      vm            = null;
154     static EventRequestManager eventRManager = null;
155     static EventQueue          eventQueue    = null;
156     static EventSet            eventSet      = null;
157     static EventIterator       eventIterator = null;
158 
159     static ReferenceType       debuggeeClass = null;
160 
161     static int  testExitCode = PASSED;
162 
163     BreakpointRequest breakpointRequest;
164 






165     //------------------------------------------------------ methods
166 
167     private int runThis (String argv[], PrintStream out) {
168 
169         argsHandler     = new ArgumentHandler(argv);
170         logHandler      = new Log(out, argsHandler);
171         Binder binder   = new Binder(argsHandler, logHandler);
172 
173         waitTime        = argsHandler.getWaitTime() * 60000;
174 
175         try {
176             log2(&quot;launching a debuggee :&quot;);
177             log2(&quot;       &quot; + debuggeeName);
178             if (argsHandler.verbose()) {
179                 debuggee = binder.bindToDebugee(debuggeeName + &quot; -vbs&quot;);
180             } else {
181                 debuggee = binder.bindToDebugee(debuggeeName);
182             }
183             if (debuggee == null) {
184                 log3(&quot;ERROR: no debuggee launched&quot;);
</pre>
<hr />
<pre>
289         cpRequest.addClassFilter(debuggeeName);
290 
291         cpRequest.enable();
292         vm.resume();
293         getEventSet();
294         cpRequest.disable();
295 
296         ClassPrepareEvent event = (ClassPrepareEvent) eventIterator.next();
297         debuggeeClass = event.referenceType();
298 
299         if (!debuggeeClass.name().equals(debuggeeName))
300            throw new JDITestRuntimeException(&quot;** Unexpected ClassName for ClassPrepareEvent **&quot;);
301 
302         log2(&quot;      received: ClassPrepareEvent for debuggeeClass&quot;);
303 
304         String bPointMethod = &quot;methodForCommunication&quot;;
305         String lineForComm  = &quot;lineForComm&quot;;
306         BreakpointRequest bpRequest;
307 
308         try {
<span class="line-modified">309             bpRequest = settingBreakpoint(debuggee.threadByNameOrThrow(&quot;main&quot;),</span>
310                                           debuggeeClass,
311                                           bPointMethod, lineForComm, &quot;zero&quot;);
312         } catch ( Exception e ) {
313             throw e;
314         }
315         bpRequest.enable();
316 
317     //------------------------------------------------------  testing section
318 
319         log1(&quot;     TESTING BEGINS&quot;);
320 
321         log2(&quot;......vm.resume();  resuming debuggee&#39;s main thread&quot;);
322         vm.resume();
323 
324         for (int i = 0; ; i++) {
325 
326 //            vm.resume();
327 
328             breakpointForCommunication();
329 
</pre>
<hr />
<pre>
337                 log3(&quot;ERROR: Exception when &#39;instruction = ((IntegerValue)...&#39; : &quot; + e);
338                 testExitCode = FAILED;
339                 return;
340             }
341 
342             if (instruction == 0) {
343                 vm.resume();
344                 break;
345             }
346 
347             log1(&quot;  new check: # &quot; + i);
348 
349             //~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ variable part
350 
351             if ( !vm.canPopFrames() ) {
352                 log2(&quot;......vm.canPopFrames() == false : test is cancelled&quot;);
353                 return;
354             }
355 
356             String thread2Name         = &quot;thread2&quot;;
<span class="line-modified">357             ThreadReference thread2Ref = debuggee.threadByNameOrThrow(thread2Name);</span>
358 
359 
360             String poppedMethod    = &quot;poppedMethod&quot;;
361             String breakpointLine  = &quot;breakpointLine&quot;;
362             String testVariable    = &quot;testVar1&quot;;
363 
364             log2(&quot;......setting breakpoint in poppedMethod&quot;);
365             try {
<span class="line-modified">366                 breakpointRequest = settingBreakpoint(debuggee.threadByNameOrThrow(thread2Name),</span>
367                                           debuggeeClass,
368                                           poppedMethod, breakpointLine, &quot;one&quot;);
369             } catch ( Exception e ) {
370                 throw e;
371             }
372             log2(&quot;......breakpointRequest.enable();&quot;);
373             breakpointRequest.enable();
374 
375             log2(&quot;......eventSet.resume();   resuming debuggee&#39;s main thread&quot;);
376             log2(&quot;                           to get new rendevous at the breakpointForCommunication&quot;);
377             eventSet.resume();
378             log2(&quot;......breakpointInMethod();&quot;);
379             breakpointInMethod();
380 
381             log2(&quot;......getting value of &#39;testVar1&#39;; 1 is expected&quot;);
382             Value val = debuggeeClass.getValue(debuggeeClass.fieldByName(testVariable));
383             int intVal = ((IntegerValue) val).value();
384             if (intVal != 1) {
385                 log3(&quot;ERROR: intVal != 1&quot;);
386                 testExitCode = FAILED;
</pre>
<hr />
<pre>
405             breakpointInMethod();
406 
407             log2(&quot;......getting value of &#39;testVar1&#39;; 2 is expected&quot;);
408             val = debuggeeClass.getValue(debuggeeClass.fieldByName(testVariable));
409             intVal = ((IntegerValue) val).value();
410             if (intVal != 2) {
411                 log3(&quot;ERROR: intVal != 2&quot;);
412                 testExitCode = FAILED;
413                 break;
414             }
415 
416             log2(&quot;......thread2Ref.resume();&quot;);
417             thread2Ref.resume();
418 
419             //~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
420         }
421         log1(&quot;    TESTING ENDS&quot;);
422         return;
423     }
424 














425    /*
426     * private BreakpointRequest settingBreakpoint(ThreadReference, ReferenceType,
427     *                                             String, String, String)
428     *
429     * It sets up a breakpoint at given line number within a given method in a given class
430     * for a given thread.
431     *
432     * Return value: BreakpointRequest object  in case of success
433     *
434     * JDITestRuntimeException   in case of an Exception thrown within the method
435     */
436 
437     private BreakpointRequest settingBreakpoint ( ThreadReference thread,
438                                                   ReferenceType testedClass,
439                                                   String methodName,
440                                                   String bpLine,
441                                                   String property)
442             throws JDITestRuntimeException {
443 
444         log2(&quot;......setting up a breakpoint:&quot;);
</pre>
</td>
</tr>
</table>
<center><a href="../../ThreadDeathRequest/addThreadFilter/addthreadfilter005.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="popframes002.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>