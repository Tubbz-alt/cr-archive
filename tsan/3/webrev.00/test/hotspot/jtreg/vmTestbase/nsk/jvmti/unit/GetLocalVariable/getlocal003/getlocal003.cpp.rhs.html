<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/hotspot/jtreg/vmTestbase/nsk/jvmti/unit/GetLocalVariable/getlocal003/getlocal003.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2003, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 #include &lt;stdio.h&gt;
 25 #include &lt;string.h&gt;
 26 #include &quot;jvmti.h&quot;
 27 #include &quot;jni_tools.h&quot;
 28 #include &quot;agent_common.h&quot;
 29 #include &quot;JVMTITools.h&quot;
 30 
 31 extern &quot;C&quot; {
 32 
 33 
 34 #define STATUS_PASSED 0
 35 #define STATUS_FAILED 2
 36 
 37 static jvmtiEnv *jvmti = NULL;
 38 static jvmtiEventCallbacks callbacks;
 39 static jint result = STATUS_PASSED;
 40 static jboolean printdump = JNI_FALSE;
 41 static jmethodID mid = NULL;
 42 static jvmtiLocalVariableEntry *table = NULL;
 43 static jint entryCount = 0;
 44 static jint methodExitCnt = -1;
 45 
 46 void print_LocalVariableEntry(jvmtiLocalVariableEntry *lvt_elem) {
 47   printf(&quot;\n Var name: %s, slot: %d&quot;, lvt_elem-&gt;name, lvt_elem-&gt;slot);
 48   printf(&quot;, start_bci: %&quot; LL &quot;d&quot;, lvt_elem-&gt;start_location);
 49   printf(&quot;, end_bci: %&quot; LL &quot;d&quot;,   lvt_elem-&gt;start_location + lvt_elem-&gt;length);
 50   printf(&quot;, signature: %s\n&quot;, lvt_elem-&gt;signature);
 51 }
 52 
 53 static void
 54 test_locals(jvmtiEnv *jvmti, jthread thr, jlocation location) {
 55     jvmtiError err;
 56     jint intVal;
 57     jlong longVal;
 58     jfloat floatVal;
 59     jdouble doubleVal;
 60     jobject obj;
 61     jint i;
 62 
 63     for (i = 0; i &lt; entryCount; i++) {
 64         if (table[i].start_location &gt; location ||
 65             table[i].start_location + table[i].length &lt; location) {
 66             continue;  /* The local variable is not visible */
 67         }
 68         print_LocalVariableEntry(&amp;table[i]);
 69         char sig = table[i].signature[0];
<a name="2" id="anc2"></a><span class="line-added"> 70         int slot = table[i].slot;</span>
 71 
 72         if (sig == &#39;Z&#39; || sig == &#39;B&#39; || sig == &#39;C&#39; || sig == &#39;S&#39;) {
 73             sig = &#39;I&#39;; // covered by GetLocalInt
 74         }
<a name="3" id="anc3"></a><span class="line-modified"> 75         err = jvmti-&gt;GetLocalInt(thr, 0, slot, &amp;intVal);</span>
 76         printf(&quot; GetLocalInt:     %s (%d)\n&quot;, TranslateError(err), err);
 77         if (err != JVMTI_ERROR_NONE &amp;&amp; sig == &#39;I&#39;) {
 78             printf(&quot;FAIL: GetLocalInt failed to get value of int\n&quot;);
 79             result = STATUS_FAILED;
 80         } else if (err != JVMTI_ERROR_TYPE_MISMATCH &amp;&amp; sig != &#39;I&#39;) {
 81             printf(&quot;FAIL: GetLocalInt did not return JVMTI_ERROR_TYPE_MISMATCH for non-int\n&quot;);
 82             result = STATUS_FAILED;
 83         }
 84 
<a name="4" id="anc4"></a><span class="line-modified"> 85         err = jvmti-&gt;GetLocalLong(thr, 0, slot, &amp;longVal);</span>
 86         printf(&quot; GetLocalLong:    %s (%d)\n&quot;, TranslateError(err), err);
 87         if (err != JVMTI_ERROR_NONE &amp;&amp; sig == &#39;J&#39;) {
 88             printf(&quot;FAIL: GetLocalLong failed to get value of long\n&quot;);
 89             result = STATUS_FAILED;
<a name="5" id="anc5"></a><span class="line-modified"> 90         } else if (err != JVMTI_ERROR_INVALID_SLOT &amp;&amp;</span>
<span class="line-modified"> 91                    err != JVMTI_ERROR_TYPE_MISMATCH &amp;&amp;</span>
<span class="line-added"> 92                    sig != &#39;J&#39;) {</span>
<span class="line-added"> 93             printf(&quot;FAIL: GetLocalLong did not return JVMTI_ERROR_INVALID_SLOT&quot;</span>
<span class="line-added"> 94                    &quot; nor JVMTI_ERROR_TYPE_MISMATCH for non-long\n&quot;);</span>
 95             result = STATUS_FAILED;
 96         }
 97 
<a name="6" id="anc6"></a><span class="line-modified"> 98         err = jvmti-&gt;GetLocalFloat(thr, 0, slot, &amp;floatVal);</span>
 99         printf(&quot; GetLocalFloat:   %s (%d)\n&quot;, TranslateError(err), err);
<a name="7" id="anc7"></a><span class="line-modified">100         if (err != JVMTI_ERROR_NONE &amp;&amp; sig == &#39;F&#39;) {</span>
101             printf(&quot;FAIL: GetLocalFloat failed to get value of float\n&quot;);
102             result = STATUS_FAILED;
<a name="8" id="anc8"></a><span class="line-modified">103         } else if (err != JVMTI_ERROR_TYPE_MISMATCH &amp;&amp; sig != &#39;F&#39;) {</span>
104             printf(&quot;FAIL: GetLocalFloat did not return JVMTI_ERROR_TYPE_MISMATCH for non-float\n&quot;);
105             result = STATUS_FAILED;
106         }
107 
<a name="9" id="anc9"></a><span class="line-modified">108         err = jvmti-&gt;GetLocalDouble(thr, 0, slot, &amp;doubleVal);</span>
109         printf(&quot; GetLocalDouble:  %s (%d)\n&quot;, TranslateError(err), err);
<a name="10" id="anc10"></a><span class="line-modified">110         if (err != JVMTI_ERROR_NONE &amp;&amp; sig == &#39;D&#39;) {</span>
111             printf(&quot;FAIL: GetLocalDouble failed to get value of double\n&quot;);
112             result = STATUS_FAILED;
<a name="11" id="anc11"></a><span class="line-modified">113         } else if (err != JVMTI_ERROR_INVALID_SLOT &amp;&amp;</span>
<span class="line-modified">114                    err != JVMTI_ERROR_TYPE_MISMATCH &amp;&amp;</span>
<span class="line-added">115                    sig != &#39;D&#39;) {</span>
<span class="line-added">116             printf(&quot;FAIL: GetLocalDouble did not return JVMTI_ERROR_INVALID_SLOT&quot;</span>
<span class="line-added">117                    &quot; nor JVMTI_ERROR_TYPE_MISMATCH for non-double\n&quot;);</span>
118             result = STATUS_FAILED;
119         }
120 
<a name="12" id="anc12"></a><span class="line-modified">121         err = jvmti-&gt;GetLocalObject(thr, 0, slot, &amp;obj);</span>
122         printf(&quot; GetLocalObject:  %s (%d)\n&quot;, TranslateError(err), err);
<a name="13" id="anc13"></a><span class="line-modified">123         if (err != JVMTI_ERROR_NONE &amp;&amp; sig == &#39;L&#39;) {</span>
124             printf(&quot;FAIL: GetLocalObject failed to get value of object\n&quot;);
125             result = STATUS_FAILED;
<a name="14" id="anc14"></a><span class="line-modified">126         } else if (err != JVMTI_ERROR_TYPE_MISMATCH &amp;&amp; sig != &#39;L&#39;) {</span>
127             printf(&quot;FAIL: GetLocalObject did not return JVMTI_ERROR_TYPE_MISMATCH for non-object\n&quot;);
128             result = STATUS_FAILED;
129         }
130     }
131 }
132 
133 static void JNICALL
134 MethodExit(jvmtiEnv *jvmti_env,
135            JNIEnv *env,
136            jthread thr,
137            jmethodID method,
138            jboolean was_poped_by_exception,
139            jvalue return_value) {
140 
141     jvmtiError err;
142     jlocation location;
143     jmethodID frame_method = NULL;
144 
145     if (mid != method) {
146         return;
147     }
148     err = jvmti-&gt;GetFrameLocation(thr, 0, &amp;frame_method, &amp;location);
149     if (err != JVMTI_ERROR_NONE) {
150         printf(&quot;\t failure: %s (%d)\n&quot;, TranslateError(err), err);
151         result = STATUS_FAILED;
152         return;
153     }
154     if (frame_method != method) {
155         printf(&quot;\t failure: GetFrameLocation returned wrong jmethodID\n&quot;);
156         result = STATUS_FAILED;
157         return;
158     }
159 
160     printf(&quot;\n MethodExit: BEGIN %d\n&quot;,  ++methodExitCnt);
161 
162     test_locals(jvmti, thr, location);
163 
164     printf(&quot;\n MethodExit: END %d\n\n&quot;, methodExitCnt);
165     fflush(stdout);
166 }
167 
168 #ifdef STATIC_BUILD
169 JNIEXPORT jint JNICALL Agent_OnLoad_getlocal003(JavaVM *jvm, char *options, void *reserved) {
170     return Agent_Initialize(jvm, options, reserved);
171 }
172 JNIEXPORT jint JNICALL Agent_OnAttach_getlocal003(JavaVM *jvm, char *options, void *reserved) {
173     return Agent_Initialize(jvm, options, reserved);
174 }
175 JNIEXPORT jint JNI_OnLoad_getlocal003(JavaVM *jvm, char *options, void *reserved) {
176     return JNI_VERSION_1_8;
177 }
178 #endif
179 jint Agent_Initialize(JavaVM *jvm, char *options, void *reserved) {
180     jint res;
181     jvmtiError err;
182     static jvmtiCapabilities caps;
183 
184     if (options != NULL &amp;&amp; strcmp(options, &quot;printdump&quot;) == 0) {
185         printdump = JNI_TRUE;
186     }
187 
188     res = jvm-&gt;GetEnv((void **) &amp;jvmti, JVMTI_VERSION_1_1);
189     if (res != JNI_OK || jvmti == NULL) {
190         printf(&quot;Wrong result of a valid call to GetEnv!\n&quot;);
191         return JNI_ERR;
192     }
193 
194     err = jvmti-&gt;GetPotentialCapabilities(&amp;caps);
195     if (err != JVMTI_ERROR_NONE) {
196         printf(&quot;(GetPotentialCapabilities) unexpected error: %s (%d)\n&quot;,
197                TranslateError(err), err);
198         return JNI_ERR;
199     }
200 
201     err = jvmti-&gt;AddCapabilities(&amp;caps);
202     if (err != JVMTI_ERROR_NONE) {
203         printf(&quot;(AddCapabilities) unexpected error: %s (%d)\n&quot;,
204                TranslateError(err), err);
205         return JNI_ERR;
206     }
207 
208     err = jvmti-&gt;GetCapabilities(&amp;caps);
209     if (err != JVMTI_ERROR_NONE) {
210         printf(&quot;(GetCapabilities) unexpected error: %s (%d)\n&quot;,
211                TranslateError(err), err);
212         return JNI_ERR;
213     }
214 
215     if (!caps.can_access_local_variables) {
216         printf(&quot;Warning: Access to local variables is not implemented\n&quot;);
217         return JNI_ERR;
218     }
219     if (!caps.can_generate_method_exit_events) {
220         printf(&quot;Warning: MethodExit event is not implemented\n&quot;);
221         return JNI_ERR;
222     }
223     callbacks.MethodExit = &amp;MethodExit;
224     err = jvmti-&gt;SetEventCallbacks(&amp;callbacks, sizeof(callbacks));
225     if (err != JVMTI_ERROR_NONE) {
226         printf(&quot;(SetEventCallbacks) unexpected error: %s (%d)\n&quot;,
227                TranslateError(err), err);
228         return JNI_ERR;
229     }
230     return JNI_OK;
231 }
232 
<a name="15" id="anc15"></a><span class="line-added">233 JNIEXPORT void JNICALL</span>
<span class="line-added">234 Java_nsk_jvmti_unit_GetLocalVariable_getlocal003_instMeth(JNIEnv *env, jobject inst) {</span>
<span class="line-added">235     jvmtiError err;</span>
<span class="line-added">236     jobject obj = NULL;</span>
<span class="line-added">237 </span>
<span class="line-added">238     printf(&quot;\n Native instMeth: started\n&quot;);</span>
<span class="line-added">239 </span>
<span class="line-added">240     // Test GetLocalInstance with native instance method instMeth() frame</span>
<span class="line-added">241     err = jvmti-&gt;GetLocalInstance(NULL, 0, &amp;obj);</span>
<span class="line-added">242     printf(&quot; Native instMeth: GetLocalInstance: %s (%d)\n&quot;, TranslateError(err), err);</span>
<span class="line-added">243     if (err != JVMTI_ERROR_NONE) {</span>
<span class="line-added">244         printf(&quot;FAIL: GetLocalInstance failed to get instance for native instance method frame\n&quot;);</span>
<span class="line-added">245         result = STATUS_FAILED;</span>
<span class="line-added">246     }</span>
<span class="line-added">247     if (env-&gt;IsSameObject(inst, obj) == JNI_FALSE) {</span>
<span class="line-added">248         printf(&quot;FAIL: GetLocalInstance returned unexpected instance for native instance method frame\n&quot;);</span>
<span class="line-added">249         result = STATUS_FAILED;</span>
<span class="line-added">250     }</span>
<span class="line-added">251 </span>
<span class="line-added">252     // Test GetLocalInstance with java instance method meth01() frame</span>
<span class="line-added">253     err = jvmti-&gt;GetLocalInstance(NULL, 1, &amp;obj);</span>
<span class="line-added">254     printf(&quot; Native instMeth: GetLocalInstance: %s (%d)\n&quot;, TranslateError(err), err);</span>
<span class="line-added">255     if (err != JVMTI_ERROR_NONE) {</span>
<span class="line-added">256         printf(&quot;FAIL: GetLocalInstance failed to get instance for java instance method frame\n&quot;);</span>
<span class="line-added">257         result = STATUS_FAILED;</span>
<span class="line-added">258     }</span>
<span class="line-added">259     if (env-&gt;IsSameObject(inst, obj) == JNI_FALSE) {</span>
<span class="line-added">260         printf(&quot;FAIL: GetLocalInstance returned unexpected instance for java instance method frame\n&quot;);</span>
<span class="line-added">261         result = STATUS_FAILED;</span>
<span class="line-added">262     }</span>
<span class="line-added">263     printf(&quot; Native instMeth: finished\n\n&quot;);</span>
<span class="line-added">264 }</span>
<span class="line-added">265 </span>
266 JNIEXPORT void JNICALL
267 Java_nsk_jvmti_unit_GetLocalVariable_getlocal003_getMeth(JNIEnv *env, jclass cls) {
268     jvmtiError err;
<a name="16" id="anc16"></a><span class="line-added">269     jobject obj = NULL;</span>
<span class="line-added">270 </span>
<span class="line-added">271     printf(&quot;\n Native getMeth: started\n&quot;);</span>
272 
273     if (jvmti == NULL) {
274         printf(&quot;JVMTI client was not properly loaded!\n&quot;);
275         result = STATUS_FAILED;
276         return;
277     }
278 
279     mid = env-&gt;GetStaticMethodID(cls, &quot;staticMeth&quot;, &quot;(I)I&quot;);
280     if (mid == NULL) {
281         printf(&quot;Cannot find Method ID for staticMeth\n&quot;);
282         result = STATUS_FAILED;
283         return;
284     }
285 
286     err = jvmti-&gt;GetLocalVariableTable(mid, &amp;entryCount, &amp;table);
287     if (err != JVMTI_ERROR_NONE) {
288         printf(&quot;(GetLocalVariableTable) unexpected error: %s (%d)\n&quot;,
289                TranslateError(err), err);
290         result = STATUS_FAILED;
291         return;
292     }
293 
294     err = jvmti-&gt;SetEventNotificationMode(JVMTI_ENABLE, JVMTI_EVENT_METHOD_EXIT, NULL);
295     if (err != JVMTI_ERROR_NONE) {
296         printf(&quot;Failed to enable metod exit event: %s (%d)\n&quot;,
297                TranslateError(err), err);
298         result = STATUS_FAILED;
299     }
<a name="17" id="anc17"></a><span class="line-added">300 </span>
<span class="line-added">301     // Test GetLocalInstance with native static method getMeth() frame</span>
<span class="line-added">302     err = jvmti-&gt;GetLocalInstance(NULL, 0, &amp;obj);</span>
<span class="line-added">303     printf(&quot; Native getMeth: GetLocalInstance: %s (%d)\n&quot;, TranslateError(err), err);</span>
<span class="line-added">304     if (err != JVMTI_ERROR_INVALID_SLOT) {</span>
<span class="line-added">305         printf(&quot;FAIL: GetLocalInstance failed to return JVMTI_ERROR_INVALID_SLOT for native static method frame\n&quot;);</span>
<span class="line-added">306         result = STATUS_FAILED;</span>
<span class="line-added">307     }</span>
<span class="line-added">308 </span>
<span class="line-added">309     // Test GetLocalInstance with java static method run() frame</span>
<span class="line-added">310     err = jvmti-&gt;GetLocalInstance(NULL, 1, &amp;obj);</span>
<span class="line-added">311     printf(&quot; Native getMeth: GetLocalInstance: %s (%d)\n&quot;, TranslateError(err), err);</span>
<span class="line-added">312     if (err != JVMTI_ERROR_INVALID_SLOT) {</span>
<span class="line-added">313         printf(&quot;FAIL: GetLocalInstance failed to return JVMTI_ERROR_INVALID_SLOT for java static method frame\n&quot;);</span>
<span class="line-added">314         result = STATUS_FAILED;</span>
<span class="line-added">315     }</span>
<span class="line-added">316 </span>
<span class="line-added">317     printf(&quot; Native getMeth: finished\n\n&quot;);</span>
318     fflush(stdout);
319 }
320 
321 JNIEXPORT void JNICALL
322 Java_nsk_jvmti_unit_GetLocalVariable_getlocal003_checkLoc(JNIEnv *env,
323         jclass cls, jthread thr) {
324     jvmtiError err;
325     jvmtiLocalVariableEntry *table;
326     jint entryCount;
327     jmethodID mid;
328     jint locVar;
329     jint i, j;
330     int  overlap = 0;
331 
332     if (jvmti == NULL) {
333         printf(&quot;JVMTI client was not properly loaded!\n&quot;);
334         result = STATUS_FAILED;
335         return;
336     }
337     printf(&quot;\n checkLoc: START\n&quot;);
338 
339     mid = env-&gt;GetStaticMethodID(cls, &quot;staticMeth&quot;, &quot;(I)I&quot;);
340     if (mid == NULL) {
341         printf(&quot;Cannot find Method ID for staticMeth\n&quot;);
342         result = STATUS_FAILED;
343         return;
344     }
345 
346     err = jvmti-&gt;GetLocalVariableTable(mid, &amp;entryCount, &amp;table);
347     if (err != JVMTI_ERROR_NONE) {
348         printf(&quot;(GetLocalVariableTable) unexpected error: %s (%d)\n&quot;,
349                TranslateError(err), err);
350         result = STATUS_FAILED;
351         return;
352     }
353 
354     for (i = 0; i &lt; entryCount; i++) {
355         print_LocalVariableEntry(&amp;table[i]);
356 
357         err = jvmti-&gt;GetLocalInt(thr, 1, table[i].slot, &amp;locVar);
358 
359         if (strcmp(table[i].name, &quot;intArg&quot;) == 0) {
360             if (err != JVMTI_ERROR_NONE) {
361                 printf(&quot; GetLocalInt: %s (%d)\n&quot;, TranslateError(err), err);
362                 printf(&quot; failure: JVMTI_ERROR_NONE is expected\n&quot;);
363                 result = STATUS_FAILED;
364             }
365         }
366         else if (strcmp(table[i].name, &quot;pi&quot;) == 0) {
367             if (err != JVMTI_ERROR_TYPE_MISMATCH) {
368                 printf(&quot; GetLocalInt: %s (%d)\n&quot;, TranslateError(err), err);
369                 printf(&quot; failure: JVMTI_ERROR_TYPE_MISMATCH is expected\n&quot;);
370                 result = STATUS_FAILED;
371             }
372         } else {
373             if (err != JVMTI_ERROR_INVALID_SLOT) {
374                 printf(&quot; GetLocalInt: %s (%d)\n&quot;, TranslateError(err), err);
375                 printf(&quot; failure: JVMTI_ERROR_INVALID_SLOT is expected\n&quot;);
376                 result = STATUS_FAILED;
377             }
378         }
379         if (table[i].slot != 2) {
380            continue;
381         }
382 
383         for (j = 0; j &lt; entryCount; j++) {
384            /* We do cross checks between all variables having slot #2.
385             * No overlapping between location ranges are allowed.
386             */
387            if (table[j].slot != 2 || i == j) {
388               continue;
389            }
390            if (table[i].start_location &gt; table[j].start_location + table[j].length ||
391                table[j].start_location &gt; table[i].start_location + table[i].length
392            ) {
393                continue; /* Everything is Ok */
394            }
395 
396            printf(&quot; failure: locations of vars with slot #2 are overlapped:\n&quot;);
397            print_LocalVariableEntry(&amp;table[i]);
398            print_LocalVariableEntry(&amp;table[j]);
399            overlap++;
400            result = STATUS_FAILED;
401         }
402     }
403     if (!overlap) {
404         printf(&quot;\n Success: locations of vars with slot #2 are NOT overlapped\n&quot;);
405     }
406     printf(&quot;\n checkLoc: END\n\n&quot;);
407     fflush(stdout);
408 }
409 
410 JNIEXPORT jint JNICALL
411 Java_nsk_jvmti_unit_GetLocalVariable_getlocal003_getRes(JNIEnv *env, jclass cls) {
412     return result;
413 }
414 
415 }
<a name="18" id="anc18"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="18" type="hidden" />
</body>
</html>