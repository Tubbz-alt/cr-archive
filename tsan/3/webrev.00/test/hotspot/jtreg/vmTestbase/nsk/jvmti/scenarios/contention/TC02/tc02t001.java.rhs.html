<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/hotspot/jtreg/vmTestbase/nsk/jvmti/scenarios/contention/TC02/tc02t001.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2004, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 package nsk.jvmti.scenarios.contention.TC02;
 25 
 26 import java.io.PrintStream;
 27 
 28 import nsk.share.*;
 29 import nsk.share.jvmti.*;
 30 
<a name="2" id="anc2"></a><span class="line-modified"> 31 //    THIS CLASS IS LINE NUMBER SENSITIVE</span>
<span class="line-added"> 32 </span>
<span class="line-added"> 33 class tc02t001Thread extends Thread {</span>
<span class="line-added"> 34     public Wicket startingBarrier = new Wicket();</span>
<span class="line-added"> 35     public Wicket waitingBarrier1 = new Wicket();</span>
<span class="line-added"> 36     public Wicket waitingBarrier2 = new Wicket();</span>
<span class="line-added"> 37     public Wicket waitingBarrier3 = new Wicket();</span>
<span class="line-added"> 38     public Object M = new Object();</span>
<span class="line-added"> 39 </span>
<span class="line-added"> 40     public tc02t001Thread(String name) {</span>
<span class="line-added"> 41         super(name);</span>
<span class="line-added"> 42     }</span>
<span class="line-added"> 43 </span>
<span class="line-added"> 44     public void run() {</span>
<span class="line-added"> 45         startingBarrier.unlock();</span>
<span class="line-added"> 46 </span>
<span class="line-added"> 47         waitingBarrier1.waitFor();</span>
<span class="line-added"> 48         synchronized (M) { // tc02t001.c::lines[0]</span>
<span class="line-added"> 49             M.notify();</span>
<span class="line-added"> 50         }</span>
<span class="line-added"> 51 </span>
<span class="line-added"> 52         waitingBarrier2.waitFor();</span>
<span class="line-added"> 53         synchronized (M) { // tc02t001.c::lines[1]</span>
<span class="line-added"> 54             M.notify();</span>
<span class="line-added"> 55         }</span>
<span class="line-added"> 56 </span>
<span class="line-added"> 57         waitingBarrier3.waitFor();</span>
<span class="line-added"> 58         synchronized (M) { // tc02t001.c::lines[2]</span>
<span class="line-added"> 59             M.notify();</span>
<span class="line-added"> 60         }</span>
<span class="line-added"> 61     }</span>
<span class="line-added"> 62 }</span>
<span class="line-added"> 63 </span>
<span class="line-added"> 64 /* =================================================================== */</span>
 65 
 66 public class tc02t001 extends DebugeeClass {
 67 
 68     // run test from command line
 69     public static void main(String argv[]) {
 70         argv = nsk.share.jvmti.JVMTITest.commonInit(argv);
 71 
 72         // JCK-compatible exit
 73         System.exit(run(argv, System.out) + Consts.JCK_STATUS_BASE);
 74     }
 75 
 76     // run test from JCK-compatible environment
 77     public static int run(String argv[], PrintStream out) {
 78         return new tc02t001().runIt(argv, out);
 79     }
 80 
 81     /* =================================================================== */
 82 
 83     // scaffold objects
 84     ArgumentHandler argHandler = null;
 85     Log log = null;
 86     int status = Consts.TEST_PASSED;
 87     static long timeout = 0;
 88 
<a name="3" id="anc3"></a><span class="line-added"> 89     private static volatile int lastEnterEventsCount;</span>
<span class="line-added"> 90     private static native   int enterEventsCount();</span>
<span class="line-added"> 91 </span>
 92     // tested thread
 93     tc02t001Thread thread = null;
 94 
<a name="4" id="anc4"></a><span class="line-added"> 95     static void log (String msg) { System.out.println(msg); }</span>
<span class="line-added"> 96 </span>
<span class="line-added"> 97     private void waitForContendedEnterEvent() {</span>
<span class="line-added"> 98         try {</span>
<span class="line-added"> 99             for (int j = 0; j &lt; (timeout / 20); j++) {</span>
<span class="line-added">100                 Thread.sleep(20);</span>
<span class="line-added">101                 if (enterEventsCount() &gt; lastEnterEventsCount) {</span>
<span class="line-added">102                     log(&quot;Got expected MonitorContendedEnter event\n&quot;);</span>
<span class="line-added">103                     break;</span>
<span class="line-added">104                 }</span>
<span class="line-added">105             }</span>
<span class="line-added">106             if (enterEventsCount() == lastEnterEventsCount) {</span>
<span class="line-added">107                 String msg = &quot;Timeout in waiting for a MonitorContendedEnter event&quot;;</span>
<span class="line-added">108                 throw new RuntimeException(msg);</span>
<span class="line-added">109             }</span>
<span class="line-added">110             thread.M.wait(timeout);</span>
<span class="line-added">111         } catch (InterruptedException e) {</span>
<span class="line-added">112             throw new Failure(e);</span>
<span class="line-added">113         }</span>
<span class="line-added">114     }</span>
<span class="line-added">115 </span>
116     // run debuggee
117     public int runIt(String argv[], PrintStream out) {
118         argHandler = new ArgumentHandler(argv);
119         log = new Log(out, argHandler);
120         timeout = argHandler.getWaitTime() * 60 * 1000;
121         log.display(&quot;Timeout = &quot; + timeout + &quot; msc.&quot;);
122 
123         thread = new tc02t001Thread(&quot;Debuggee Thread&quot;);
124         synchronized (thread.M) {
125             thread.start();
126             thread.startingBarrier.waitFor();
127             status = checkStatus(status);
128 
<a name="5" id="anc5"></a><span class="line-added">129             lastEnterEventsCount = enterEventsCount();</span>
130             thread.waitingBarrier1.unlock();
<a name="6" id="anc6"></a><span class="line-modified">131             log(&quot;Waiting for MonitorEnterEvent #1&quot;);</span>
<span class="line-modified">132             waitForContendedEnterEvent();</span>




133 
<a name="7" id="anc7"></a><span class="line-added">134             lastEnterEventsCount = enterEventsCount();</span>
135             thread.waitingBarrier2.unlock();
<a name="8" id="anc8"></a><span class="line-modified">136             log(&quot;Waiting for MonitorEnterEvent #2&quot;);</span>
<span class="line-modified">137             waitForContendedEnterEvent();</span>




138 
<a name="9" id="anc9"></a><span class="line-added">139             lastEnterEventsCount = enterEventsCount();</span>
140             thread.waitingBarrier3.unlock();
<a name="10" id="anc10"></a><span class="line-modified">141             log(&quot;Waiting for MonitorEnterEvent #3&quot;);</span>
<span class="line-modified">142             waitForContendedEnterEvent();</span>




143         }
144 
145         try {
146             thread.join(timeout);
147         } catch (InterruptedException e) {
148             throw new Failure(e);
149         }
150 
151         log.display(&quot;Debugee finished&quot;);
152         status = checkStatus(status);
153 
154         return status;
155     }
156 }
<a name="11" id="anc11"></a>
































<a name="12" id="anc12"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="12" type="hidden" />
</body>
</html>