<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/hotspot/jtreg/vmTestbase/nsk/jvmti/scenarios/allocation/AP04/ap04t003/ap04t003.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../SingleStep/singlestep003/singlestep003.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="libap04t003.cpp.udiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/jtreg/vmTestbase/nsk/jvmti/scenarios/allocation/AP04/ap04t003/ap04t003.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2004, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2004, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -23,11 +23,11 @@</span>
  
  #include &lt;stdio.h&gt;
  #include &lt;string.h&gt;
  #include &lt;jvmti.h&gt;
  #include &quot;agent_common.h&quot;
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-added">+ #include &quot;ExceptionCheckingJniEnv.hpp&quot;</span>
  #include &quot;nsk_tools.h&quot;
  #include &quot;jni_tools.h&quot;
  #include &quot;JVMTITools.h&quot;
  #include &quot;jvmti_tools.h&quot;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -303,11 +303,11 @@</span>
      NSK_DISPLAY0(&quot;Agent thread: finished.\n&quot;);
  }
  
  /***********************************************************************/
  
<span class="udiff-line-modified-removed">- static int startThread(JNIEnv* jni, jthread threadObj) {</span>
<span class="udiff-line-modified-added">+ static int startThread(jthread threadObj) {</span>
      int success = NSK_TRUE;
  
      /* enter startLock */
      if (!NSK_JVMTI_VERIFY(jvmti-&gt;RawMonitorEnter(startLock))) {
          nsk_jvmti_setFailStatus();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -332,62 +332,42 @@</span>
  
      return success;
  }
  
  /** Create thread object for new agent thread. */
<span class="udiff-line-modified-removed">- static jthread newThreadObj(JNIEnv* jni) {</span>
<span class="udiff-line-modified-added">+ static jthread newThreadObj(JNIEnv* jni_env) {</span>
<span class="udiff-line-added">+     ExceptionCheckingJniEnvPtr ec_jni(jni_env);</span>
      jclass thrClass;
      jmethodID cid;
<span class="udiff-line-removed">-     jthread result = NULL;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     thrClass = jni-&gt;FindClass(&quot;java/lang/Thread&quot;);</span>
<span class="udiff-line-removed">-     if (!NSK_JNI_VERIFY(jni, thrClass != NULL)) {</span>
<span class="udiff-line-removed">-         nsk_jvmti_setFailStatus();</span>
<span class="udiff-line-removed">-         return result;</span>
<span class="udiff-line-removed">-     }</span>
  
<span class="udiff-line-modified-removed">-     cid = jni-&gt;GetMethodID(thrClass, &quot;&lt;init&gt;&quot;, &quot;()V&quot;);</span>
<span class="udiff-line-modified-removed">-     if (!NSK_JNI_VERIFY(jni, cid != NULL)) {</span>
<span class="udiff-line-modified-removed">-         nsk_jvmti_setFailStatus();</span>
<span class="udiff-line-removed">-         return result;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     result = jni-&gt;NewObject(thrClass, cid);</span>
<span class="udiff-line-removed">-     if (!NSK_JNI_VERIFY(jni, result != NULL)) {</span>
<span class="udiff-line-removed">-         nsk_jvmti_setFailStatus();</span>
<span class="udiff-line-removed">-         return result;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     return result;</span>
<span class="udiff-line-modified-added">+     thrClass = ec_jni-&gt;FindClass(&quot;java/lang/Thread&quot;, TRACE_JNI_CALL);</span>
<span class="udiff-line-modified-added">+     cid = ec_jni-&gt;GetMethodID(thrClass, &quot;&lt;init&gt;&quot;, &quot;()V&quot;, TRACE_JNI_CALL);</span>
<span class="udiff-line-modified-added">+     return ec_jni-&gt;NewObject(thrClass, cid, TRACE_JNI_CALL);</span>
  }
  
  /***********************************************************************/
  
  /** Clean counters and start new agent thread with agent_start() body. */
<span class="udiff-line-modified-removed">- static int prepareToIteration (JNIEnv* jni) {</span>
<span class="udiff-line-modified-added">+ static int prepareToIteration(JNIEnv* jni) {</span>
      jthread threadObj = NULL;
  
      setCounter(&amp;iterationCount, 0);
      setCounter(&amp;objectCount, 0);
  
      threadObj = newThreadObj(jni);
<span class="udiff-line-removed">-     if (!NSK_VERIFY(threadObj != NULL)) {</span>
<span class="udiff-line-removed">-         nsk_jvmti_setFailStatus();</span>
<span class="udiff-line-removed">-         return NSK_FALSE;</span>
<span class="udiff-line-removed">-     }</span>
  
      /* enter endLock */
      if (!NSK_JVMTI_VERIFY(jvmti-&gt;RawMonitorEnter(endLock))) {
          nsk_jvmti_setFailStatus();
      }
  
      NSK_DISPLAY0(&quot;Starting new agent thread...\n&quot;);
<span class="udiff-line-modified-removed">-     return startThread(jni, threadObj);</span>
<span class="udiff-line-modified-added">+     return startThread(threadObj);</span>
  }
  
  /** Wait for new agent thread to complete. */
<span class="udiff-line-modified-removed">- static void afterIteration (JNIEnv* jni) {</span>
<span class="udiff-line-modified-added">+ static void afterIteration() {</span>
  
      /* notify new agent thread (in case if not yet notified) */
      notifyThread();
  
      NSK_DISPLAY0(&quot;Wait for new agent thread to complete\n&quot;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -431,11 +411,11 @@</span>
                                                   NULL /*user_data*/))) {
          nsk_jvmti_setFailStatus();
      }
      NSK_DISPLAY0(&quot;IterateOverHeap finished.\n&quot;);
  
<span class="udiff-line-modified-removed">-     afterIteration(jni);</span>
<span class="udiff-line-modified-added">+     afterIteration();</span>
  
      found = getCounter(&amp;objectCount);
      NSK_DISPLAY1(&quot;Found tagged objects: %d\n&quot;, found);
  
      modified = OBJ_MAX_COUNT - found;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -462,11 +442,11 @@</span>
                                                               NULL /*user_data*/))) {
          nsk_jvmti_setFailStatus();
      }
      NSK_DISPLAY0(&quot;IterateOverReachableObjects finished.\n&quot;);
  
<span class="udiff-line-modified-removed">-     afterIteration(jni);</span>
<span class="udiff-line-modified-added">+     afterIteration();</span>
  
      found = getCounter(&amp;objectCount);
      NSK_DISPLAY1(&quot;Found tagged objects: %d\n&quot;, found);
  
      modified = OBJ_MAX_COUNT - found;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -493,11 +473,11 @@</span>
                                                               NULL /*user_data*/))) {
          nsk_jvmti_setFailStatus();
      }
      NSK_DISPLAY0(&quot;IterateOverInstancesOfClass finished.\n&quot;);
  
<span class="udiff-line-modified-removed">-     afterIteration(jni);</span>
<span class="udiff-line-modified-added">+     afterIteration();</span>
  
      found = getCounter(&amp;objectCount);
      NSK_DISPLAY1(&quot;Found tagged objects: %d\n&quot;, found);
  
      modified = OBJ_MAX_COUNT - found;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -507,35 +487,31 @@</span>
          nsk_jvmti_setFailStatus();
      }
  }
  
  JNIEXPORT void JNICALL
<span class="udiff-line-modified-removed">- Java_nsk_jvmti_scenarios_allocation_AP04_ap04t003_runIterateOverObjectsReachableFromObject(JNIEnv* jni,</span>
<span class="udiff-line-modified-added">+ Java_nsk_jvmti_scenarios_allocation_AP04_ap04t003_runIterateOverObjectsReachableFromObject(JNIEnv* jni_env,</span>
                                                                                             jclass  klass) {
<span class="udiff-line-added">+     ExceptionCheckingJniEnvPtr ec_jni(jni_env);</span>
      jobject root = NULL;
      int modified = 0;
      int found = 0;
  
<span class="udiff-line-modified-removed">-     root = jni-&gt;GetStaticObjectField(debugeeClass, rootFieldID);</span>
<span class="udiff-line-removed">-     if (!NSK_JNI_VERIFY(jni, root != NULL)) {</span>
<span class="udiff-line-removed">-         NSK_COMPLAIN0(&quot;GetStaticObjectField returned NULL for &#39;root&#39; field value\n\n&quot;);</span>
<span class="udiff-line-removed">-         nsk_jvmti_setFailStatus();</span>
<span class="udiff-line-removed">-         return;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-modified-added">+     root = ec_jni-&gt;GetStaticObjectField(debugeeClass, rootFieldID, TRACE_JNI_CALL);</span>
  
<span class="udiff-line-modified-removed">-     if (!prepareToIteration(jni))</span>
<span class="udiff-line-modified-added">+     if (!prepareToIteration(jni_env))</span>
          return;
  
      NSK_DISPLAY0(&quot;Calling IterateOverObjectsReachableFromObject...\n&quot;);
      if (!NSK_JVMTI_VERIFY(jvmti-&gt;IterateOverObjectsReachableFromObject(root,
                                                                         objectReferenceCallback,
                                                                         NULL /*user_data*/))) {
          nsk_jvmti_setFailStatus();
      }
      NSK_DISPLAY0(&quot;IterateOverObjectsReachableFromObject finished.\n&quot;);
  
<span class="udiff-line-modified-removed">-     afterIteration(jni);</span>
<span class="udiff-line-modified-added">+     afterIteration();</span>
  
      found = getCounter(&amp;objectCount);
      NSK_DISPLAY1(&quot;Found tagged objects: %d\n&quot;, found);
  
      modified = OBJ_MAX_COUNT - found;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -545,12 +521,12 @@</span>
          nsk_jvmti_setFailStatus();
      }
  }
  
  static void JNICALL
<span class="udiff-line-modified-removed">- agentProc(jvmtiEnv* jvmti, JNIEnv* jni, void* arg) {</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-added">+ agentProc(jvmtiEnv* jvmti, JNIEnv* jni_env, void* arg) {</span>
<span class="udiff-line-modified-added">+     ExceptionCheckingJniEnvPtr ec_jni(jni_env);</span>
      NSK_DISPLAY0(&quot;Wait for debugee start\n\n&quot;);
      if (!NSK_VERIFY(nsk_jvmti_waitForSync(timeout)))
          return;
  
      NSK_DISPLAY1(&quot;Find debugee class: %s\n&quot;, DEBUGEE_SIGNATURE);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -558,30 +534,25 @@</span>
      if (debugeeClass == NULL) {
          nsk_jvmti_setFailStatus();
          return;
      }
  
<span class="udiff-line-modified-removed">-     debugeeClass = (jclass) jni-&gt;NewGlobalRef(debugeeClass);</span>
<span class="udiff-line-removed">-     if (!NSK_JNI_VERIFY(jni, debugeeClass != NULL))</span>
<span class="udiff-line-removed">-         return;</span>
<span class="udiff-line-modified-added">+     debugeeClass = (jclass) ec_jni-&gt;NewGlobalRef(debugeeClass, TRACE_JNI_CALL);</span>
  
      NSK_DISPLAY1(&quot;Find ID of &#39;root&#39; field: %s\n&quot;, ROOT_SIGNATURE);
<span class="udiff-line-modified-removed">-     rootFieldID = jni-&gt;GetStaticFieldID(debugeeClass, &quot;root&quot;, ROOT_SIGNATURE);</span>
<span class="udiff-line-modified-removed">-     if (!NSK_JNI_VERIFY(jni, rootFieldID != NULL)) {</span>
<span class="udiff-line-removed">-         nsk_jvmti_setFailStatus();</span>
<span class="udiff-line-removed">-         return;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-modified-added">+     rootFieldID = ec_jni-&gt;GetStaticFieldID(debugeeClass, &quot;root&quot;,</span>
<span class="udiff-line-modified-added">+                                         ROOT_SIGNATURE, TRACE_JNI_CALL);</span>
  
      NSK_DISPLAY0(&quot;Let debugee to run test cases\n&quot;);
      if (!NSK_VERIFY(nsk_jvmti_resumeSync()))
          return;
  
      NSK_DISPLAY0(&quot;Wait for completion of test cases\n\n&quot;);
      if (!NSK_VERIFY(nsk_jvmti_waitForSync(timeout)))
          return;
  
<span class="udiff-line-modified-removed">-     NSK_TRACE(jni-&gt;DeleteGlobalRef(debugeeClass));</span>
<span class="udiff-line-modified-added">+     ec_jni-&gt;DeleteGlobalRef(debugeeClass, TRACE_JNI_CALL);</span>
      NSK_TRACE(jvmti-&gt;DestroyRawMonitor(counterMonitor_ptr));
      NSK_TRACE(jvmti-&gt;DestroyRawMonitor(startLock));
      NSK_TRACE(jvmti-&gt;DestroyRawMonitor(runLock));
      NSK_TRACE(jvmti-&gt;DestroyRawMonitor(endLock));
  
</pre>
<center><a href="../../../../SingleStep/singlestep003/singlestep003.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="libap04t003.cpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>