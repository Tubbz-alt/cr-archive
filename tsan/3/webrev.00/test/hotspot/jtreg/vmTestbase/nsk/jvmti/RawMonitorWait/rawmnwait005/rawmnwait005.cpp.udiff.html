<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/hotspot/jtreg/vmTestbase/nsk/jvmti/RawMonitorWait/rawmnwait005/rawmnwait005.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../GetTimerInfo/timerinfo001/timerinfo001.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../../RelinquishCapabilities/relcaps001/relcaps001.cpp.udiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/jtreg/vmTestbase/nsk/jvmti/RawMonitorWait/rawmnwait005/rawmnwait005.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2003, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2003, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -35,11 +35,11 @@</span>
  #define MILLIS_PER_MINUTE (60 * 1000)
  
  static jvmtiEnv *jvmti = NULL;
  static jvmtiCapabilities caps;
  static jint result = PASSED;
<span class="udiff-line-modified-removed">- static jboolean printdump = JNI_FALSE;</span>
<span class="udiff-line-modified-added">+ static jboolean printdump = JNI_TRUE;</span>
  static jrawMonitorID monitor;
  static jrawMonitorID wait_lock;
  static jlong wait_time;
  
  #ifdef STATIC_BUILD
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -98,20 +98,23 @@</span>
  static void JNICALL
  test_thread(jvmtiEnv* jvmti, JNIEnv* jni, void *unused) {
      jvmtiError err;
      const char* const thread_name = &quot;test thread&quot;;
  
<span class="udiff-line-added">+     // Once we hold this monitor we know we can&#39;t get interrupted</span>
<span class="udiff-line-added">+     // until we have called wait().</span>
      err = jvmti-&gt;RawMonitorEnter(monitor);
      if (err != JVMTI_ERROR_NONE) {
          printf(&quot;(RawMonitorEnter#test) unexpected error: %s (%d)\n&quot;,
                 TranslateError(err), err);
          result = STATUS_FAILED;
      }
      if (printdump == JNI_TRUE) {
          printf(&quot;&gt;&gt;&gt; [%s] acquired lock for &#39;monitor&#39; ...\n&quot;, thread_name);
      }
  
<span class="udiff-line-added">+     // We can&#39;t get this monitor until the main thread has called wait() on it.</span>
      err = jvmti-&gt;RawMonitorEnter(wait_lock);
      if (err != JVMTI_ERROR_NONE) {
          printf(&quot;(RawMonitorEnter#wait) unexpected error: %s (%d)\n&quot;,
                 TranslateError(err), err);
          result = STATUS_FAILED;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -154,10 +157,40 @@</span>
          printf(&quot;(RawMonitorExit#test) unexpected error: %s (%d)\n&quot;,
                 TranslateError(err), err);
          result = STATUS_FAILED;
      }
  
<span class="udiff-line-added">+     // We can&#39;t reacquire this monitor until the main thread is waiting for us to</span>
<span class="udiff-line-added">+     // complete.</span>
<span class="udiff-line-added">+     err = jvmti-&gt;RawMonitorEnter(wait_lock);</span>
<span class="udiff-line-added">+     if (err != JVMTI_ERROR_NONE) {</span>
<span class="udiff-line-added">+         printf(&quot;(RawMonitorEnter#wait) unexpected error: %s (%d)\n&quot;,</span>
<span class="udiff-line-added">+                TranslateError(err), err);</span>
<span class="udiff-line-added">+         result = STATUS_FAILED;</span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (printdump == JNI_TRUE) {</span>
<span class="udiff-line-added">+         printf(&quot;&gt;&gt;&gt; [%s] acquired lock for &#39;wait_lock&#39; ...\n&quot;, thread_name);</span>
<span class="udiff-line-added">+         printf(&quot;&gt;&gt;&gt; [%s] notifying main thread we are done ...\n&quot;, thread_name);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     err = jvmti-&gt;RawMonitorNotify(wait_lock);</span>
<span class="udiff-line-added">+     if (err != JVMTI_ERROR_NONE) {</span>
<span class="udiff-line-added">+         printf(&quot;(RawMonitorWait#wait) unexpected error: %s (%d)\n&quot;,</span>
<span class="udiff-line-added">+                TranslateError(err), err);</span>
<span class="udiff-line-added">+         result = STATUS_FAILED;</span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+     err = jvmti-&gt;RawMonitorExit(wait_lock);</span>
<span class="udiff-line-added">+     if (err != JVMTI_ERROR_NONE) {</span>
<span class="udiff-line-added">+         printf(&quot;(RawMonitorExit#wait) unexpected error: %s (%d)\n&quot;,</span>
<span class="udiff-line-added">+                TranslateError(err), err);</span>
<span class="udiff-line-added">+         result = STATUS_FAILED;</span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      if (printdump == JNI_TRUE) {
          printf(&quot;&gt;&gt;&gt; [%s] all done\n&quot;, thread_name);
      }
  }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -221,10 +254,15 @@</span>
      }
  
      if (printdump == JNI_TRUE) {
          printf(&quot;&gt;&gt;&gt; [%s] starting test thread ...\n&quot;, thread_name);
      }
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     // This starts a daemon thread, so we need to synchronize with it</span>
<span class="udiff-line-added">+     // before we terminate - else the test will end before it checks</span>
<span class="udiff-line-added">+     // it was interrupted!</span>
<span class="udiff-line-added">+ </span>
      err = jvmti-&gt;RunAgentThread(thr, test_thread, NULL,
                                  JVMTI_THREAD_NORM_PRIORITY);
      if (err != JVMTI_ERROR_NONE) {
          printf(&quot;(RunDebugThread) unexpected error: %s (%d)\n&quot;,
                 TranslateError(err), err);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -242,16 +280,11 @@</span>
      }
      if (printdump == JNI_TRUE) {
          printf(&quot;&gt;&gt;&gt; [%s] got notification from test thread ...\n&quot;, thread_name);
      }
  
<span class="udiff-line-modified-removed">-     err = jvmti-&gt;RawMonitorExit(wait_lock);</span>
<span class="udiff-line-removed">-     if (err != JVMTI_ERROR_NONE) {</span>
<span class="udiff-line-removed">-         printf(&quot;(RawMonitorExit#wait) unexpected error: %s (%d)\n&quot;,</span>
<span class="udiff-line-removed">-                TranslateError(err), err);</span>
<span class="udiff-line-removed">-         return STATUS_FAILED;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-modified-added">+     // Keep the wait_lock so we can wait again at the end.</span>
  
      err = jvmti-&gt;RawMonitorEnter(monitor);
      if (err != JVMTI_ERROR_NONE) {
          printf(&quot;(RawMonitorEnter#test) unexpected error: %s (%d)\n&quot;,
                 TranslateError(err), err);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -277,10 +310,30 @@</span>
          printf(&quot;(RawMonitorExit#test) unexpected error: %s (%d)\n&quot;,
                 TranslateError(err), err);
          result = STATUS_FAILED;
      }
  
<span class="udiff-line-added">+     if (printdump == JNI_TRUE) {</span>
<span class="udiff-line-added">+         printf(&quot;&gt;&gt;&gt; [%s] waiting for test thread to complete its wait and notify us ...\n&quot;, thread_name);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+     err = jvmti-&gt;RawMonitorWait(wait_lock, (jlong)0);</span>
<span class="udiff-line-added">+     if (err != JVMTI_ERROR_NONE) {</span>
<span class="udiff-line-added">+         printf(&quot;(RawMonitorWait#wait) unexpected error: %s (%d)\n&quot;,</span>
<span class="udiff-line-added">+                TranslateError(err), err);</span>
<span class="udiff-line-added">+         return STATUS_FAILED;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+     if (printdump == JNI_TRUE) {</span>
<span class="udiff-line-added">+         printf(&quot;&gt;&gt;&gt; [%s] got final notification from test thread ...\n&quot;, thread_name);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     err = jvmti-&gt;RawMonitorExit(wait_lock);</span>
<span class="udiff-line-added">+     if (err != JVMTI_ERROR_NONE) {</span>
<span class="udiff-line-added">+         printf(&quot;(RawMonitorExit#wait) unexpected error: %s (%d)\n&quot;,</span>
<span class="udiff-line-added">+                TranslateError(err), err);</span>
<span class="udiff-line-added">+         return STATUS_FAILED;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      if (printdump == JNI_TRUE) {
          printf(&quot;&gt;&gt;&gt; [%s] all done\n&quot;, thread_name);
      }
  
      return result;
</pre>
<center><a href="../../GetTimerInfo/timerinfo001/timerinfo001.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../../RelinquishCapabilities/relcaps001/relcaps001.cpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>