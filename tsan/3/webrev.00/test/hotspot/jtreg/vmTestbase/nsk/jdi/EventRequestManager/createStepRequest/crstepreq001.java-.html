<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old test/hotspot/jtreg/vmTestbase/nsk/jdi/EventRequestManager/createStepRequest/crstepreq001.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2001, 2018, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 package nsk.jdi.EventRequestManager.createStepRequest;
 25 
 26 import com.sun.jdi.ThreadReference;
 27 import com.sun.jdi.VirtualMachine;
 28 import com.sun.jdi.request.StepRequest;
 29 import com.sun.jdi.request.EventRequestManager;
 30 import com.sun.jdi.request.DuplicateRequestException;
 31 import com.sun.jdi.ObjectCollectedException;
 32 import com.sun.jdi.VMMismatchException;
 33 import java.util.Iterator;
 34 import java.util.LinkedList;
 35 import java.util.List;
 36 import java.io.*;
 37 import nsk.share.*;
 38 import nsk.share.jpda.*;
 39 import nsk.share.jdi.*;
 40 
 41 
 42 /**
 43  * The test checks that only one pending JDI step request is
 44  * allowed per thread, i.e. the JDI method
 45  * &lt;code&gt;com.sun.jdi.request.EventRequestManager.createStepRequest()&lt;/code&gt;
 46  * properly throws a &lt;code&gt;DuplicateRequestException&lt;/code&gt; if there
 47  * is already a pending step request for the specified thread.
 48  */
 49 public class crstepreq001 {
 50     public static final int PASSED = 0;
 51     public static final int FAILED = 2;
 52     public static final int JCK_STATUS_BASE = 95;
 53     static final String DEBUGGEE_CLASS =
 54         &quot;nsk.jdi.EventRequestManager.createStepRequest.crstepreq001t&quot;;
 55     static final String DEBUGGEE_THRD = &quot;debuggee_thr&quot;;
 56     static final String COMMAND_READY = &quot;ready&quot;;
 57     static final String COMMAND_QUIT = &quot;quit&quot;;
 58 
 59     static final int RSTS_NUM = 6;
 60     static final int RESTRICTIONS[][] = {
 61         {StepRequest.STEP_MIN,  StepRequest.STEP_INTO},
 62         {StepRequest.STEP_MIN,  StepRequest.STEP_OVER},
 63         {StepRequest.STEP_MIN,  StepRequest.STEP_OUT},
 64         {StepRequest.STEP_LINE, StepRequest.STEP_INTO},
 65         {StepRequest.STEP_LINE, StepRequest.STEP_OVER},
 66         {StepRequest.STEP_LINE, StepRequest.STEP_OUT}
 67     };
 68 
 69     private Log log;
 70     private IOPipe pipe;
 71     private Debugee debuggee;
 72     private int tot_res = PASSED;
 73 
 74     public static void main (String argv[]) {
 75         System.exit(run(argv,System.out) + JCK_STATUS_BASE);
 76     }
 77 
 78     public static int run(String argv[], PrintStream out) {
 79         return new crstepreq001().runIt(argv, out);
 80     }
 81 
 82     private int runIt(String args[], PrintStream out) {
 83         ArgumentHandler argHandler = new ArgumentHandler(args);
 84         log = new Log(out, argHandler);
 85         Binder binder = new Binder(argHandler, log);
 86         ThreadReference thR = null;
 87         List threads;
 88         List&lt;StepRequest&gt; enabledStepRequests = new LinkedList&lt;&gt;();
 89         String cmd;
 90 
 91         debuggee = binder.bindToDebugee(DEBUGGEE_CLASS);
 92         pipe = debuggee.createIOPipe();
 93         debuggee.redirectStderr(log, &quot;crstepreq001t.err&gt; &quot;);
 94         VirtualMachine vm = debuggee.VM();
 95         EventRequestManager erManager = vm.eventRequestManager();
 96         debuggee.resume();
 97         cmd = pipe.readln();
 98         if (!cmd.equals(COMMAND_READY)) {
 99             log.complain(&quot;TEST BUG: unknown debuggee&#39;s command: &quot;
100                 + cmd);
101             return quitDebuggee(FAILED);
102         }
103 
104         try {
105             threads = vm.allThreads();
106         } catch (Exception e) {
107             log.complain(&quot;TEST FAILURE: allThreads: &quot; + e);
108             return quitDebuggee(FAILED);
109         }
110         Iterator iter = threads.iterator();
111         while (iter.hasNext()) {
112             thR = (ThreadReference) iter.next();
113             if (thR.name().equals(DEBUGGEE_THRD)) {
114                 log.display(&quot;\nCreating StepRequest for the debuggee&#39;s thread \&quot;&quot;
115                     + thR.name() + &quot;\&quot;&quot;);
116                 try {
117                     StepRequest sReq = erManager.createStepRequest(thR,
118                         RESTRICTIONS[0][0],RESTRICTIONS[0][1]);
119                     sReq.enable();
120                     enabledStepRequests.add(sReq);
121                 } catch (DuplicateRequestException e) {
122                     log.complain(&quot;TEST FAILURE: createStepRequest: caught &quot; + e);
123                     return quitDebuggee(FAILED);
124                 } catch (ObjectCollectedException e) {
125                     log.complain(&quot;TEST FAILURE: createStepRequest: caught &quot; + e);
126                     return quitDebuggee(FAILED);
127                 } catch (VMMismatchException e) {
128                     log.complain(&quot;TEST FAILURE: createStepRequest: caught &quot; + e);
129                     return quitDebuggee(FAILED);
130                 }
131                 break;
132             }
133         }
134 
135 // Check that createStepRequest() throws DuplicateRequestException
136 // to indicate a duplicate event request per thread
137         for(int i=0; i&lt;RSTS_NUM; i++) {
138             log.display(&quot;\n&quot; + (i+1)
139                 + &quot;) Trying to create a duplicate StepRequest object\n\twith size=&quot;
140                 + RESTRICTIONS[i][0] + &quot;; depth=&quot;
141                 + RESTRICTIONS[i][1] + &quot; for the debuggee&#39;s thread \&quot;&quot;
142                 + thR.name() + &quot;\&quot;&quot;);
143             try {
144                 StepRequest sReq = erManager.createStepRequest(thR,
145                     RESTRICTIONS[i][0], RESTRICTIONS[i][1]);
146                 log.complain(&quot;TEST CASE #&quot; + (i+1)
147                     + &quot; FAILED: createStepRequest successfully done\n&quot;
148                     + &quot;\tfor a duplicate StepRequest object per the specified thread \&quot;&quot;
149                     + thR.name() + &quot;\&quot;\n&quot;
150                     + &quot;\tbut it should throw DuplicateRequestException&quot;);
151                 tot_res = FAILED;
152             } catch (DuplicateRequestException e) {
153                 log.display(&quot;TEST CASE #&quot; + (i+1)
154                     + &quot; PASSED: createStepRequest: caught &quot; + e);
155             } catch (ObjectCollectedException e) {
156                 log.complain(&quot;TEST CASE #&quot; + (i+1)
157                     + &quot; FAILED: createStepRequest: caught &quot; + e);
158                 log.complain(&quot;\tbut it should throw DuplicateRequestException&quot;);
159                 tot_res = FAILED;
160             } catch (VMMismatchException e) {
161                 log.complain(&quot;TEST CASE #&quot; + (i+1)
162                     + &quot; FAILED: createStepRequest: caught &quot; + e);
163                 log.complain(&quot;\tbut it should throw DuplicateRequestException&quot;);
164                 tot_res = FAILED;
165             }
166         }
167 
168         enabledStepRequests.forEach(s -&gt; erManager.deleteEventRequest(s));
169 
170         return quitDebuggee(tot_res);
171     }
172 
173     private int quitDebuggee(int stat) {
174         pipe.println(COMMAND_QUIT);
175         debuggee.waitFor();
176         return stat;
177     }
178 }
    </pre>
  </body>
</html>