<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/hotspot/jtreg/vmTestbase/nsk/jdi/BreakpointRequest/addThreadFilter/threadfilter003.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="threadfilter002.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../location/location001.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/jtreg/vmTestbase/nsk/jdi/BreakpointRequest/addThreadFilter/threadfilter003.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
139 
140     //====================================================== test program
141     //------------------------------------------------------ common section
142 
143     static Debugee          debuggee;
144     static ArgumentHandler  argsHandler;
145 
146     static int waitTime;
147 
148     static VirtualMachine      vm            = null;
149     static EventRequestManager eventRManager = null;
150     static EventQueue          eventQueue    = null;
151     static EventSet            eventSet      = null;
152     static EventIterator       eventIterator = null;
153 
154     static ReferenceType       debuggeeClass = null;
155 
156     static int  testExitCode = PASSED;
157 
158 
<span class="line-removed">159     class JDITestRuntimeException extends RuntimeException {</span>
<span class="line-removed">160         JDITestRuntimeException(String str) {</span>
<span class="line-removed">161             super(&quot;JDITestRuntimeException : &quot; + str);</span>
<span class="line-removed">162         }</span>
<span class="line-removed">163     }</span>
<span class="line-removed">164 </span>
165     //------------------------------------------------------ methods
166 
167     private int runThis (String argv[], PrintStream out) {
168 
169         argsHandler     = new ArgumentHandler(argv);
170         logHandler      = new Log(out, argsHandler);
171         Binder binder   = new Binder(argsHandler, logHandler);
172 
173         waitTime        = argsHandler.getWaitTime() * 60000;
174 
175         try {
176             log2(&quot;launching a debuggee :&quot;);
177             log2(&quot;       &quot; + debuggeeName);
178             if (argsHandler.verbose()) {
179                 debuggee = binder.bindToDebugee(debuggeeName + &quot; -vbs&quot;);
180             } else {
181                 debuggee = binder.bindToDebugee(debuggeeName);
182             }
183             if (debuggee == null) {
184                 log3(&quot;ERROR: no debuggee launched&quot;);
</pre>
<hr />
<pre>
268                 return 0;
269 
270             log3(&quot;ERROR: last event is not the VMDeathEvent&quot;);
271             return 1;
272         } catch ( VMDisconnectedException e ) {
273             log3(&quot;ERROR: VMDisconnectedException : &quot; + e);
274             return 2;
275         } catch ( Exception e ) {
276             log3(&quot;ERROR: Exception : &quot; + e);
277             return 1;
278         }
279 
280     }
281 
282     private void testRun()
283                  throws JDITestRuntimeException, Exception {
284 
285         eventRManager = vm.eventRequestManager();
286 
287         ClassPrepareRequest cpRequest = eventRManager.createClassPrepareRequest();
<span class="line-modified">288         cpRequest.setSuspendPolicy( EventRequest.SUSPEND_EVENT_THREAD);</span>
289         cpRequest.addClassFilter(debuggeeName);
290 
291         cpRequest.enable();
292         vm.resume();
293         getEventSet();
294         cpRequest.disable();
295 
296         ClassPrepareEvent event = (ClassPrepareEvent) eventIterator.next();
297         debuggeeClass = event.referenceType();
298 
299         if (!debuggeeClass.name().equals(debuggeeName))
<span class="line-modified">300            throw new JDITestRuntimeException(&quot;** Unexpected ClassName for ClassPrepareEvent **&quot;);</span>
301 
302         log2(&quot;      received: ClassPrepareEvent for debuggeeClass&quot;);
303 
304         String bPointMethod = &quot;methodForCommunication&quot;;
<span class="line-modified">305         String lineForComm  = &quot;lineForComm&quot;;</span>
306 
<span class="line-modified">307         ThreadReference   mainThread = threadByName(&quot;main&quot;);</span>
308 
309         BreakpointRequest bpRequest = settingBreakpoint(mainThread,
<span class="line-modified">310                                              debuggeeClass,</span>
<span class="line-modified">311                                             bPointMethod, lineForComm, &quot;zero&quot;);</span>
312         bpRequest.enable();
313 
<span class="line-modified">314     //------------------------------------------------------  testing section</span>
315 
316         log1(&quot;     TESTING BEGINS&quot;);
317 
318         EventRequest eventRequest1 = null;
319         EventRequest eventRequest2 = null;
320         EventRequest eventRequest3 = null;
321 
<span class="line-modified">322         ThreadReference thread1     = null;</span>
<span class="line-modified">323         String          thread1Name = &quot;thread1&quot;;</span>
324 
325         String property1 = &quot;BreakpointRequest1&quot;;
326         String property2 = &quot;BreakpointRequest2&quot;;
327         String property3 = &quot;BreakpointRequest3&quot;;
328 
329         String methodName = &quot;method&quot;;
330         String bpLineName = &quot;breakpointLine&quot;;
331 
332         ReferenceType testClassReference = null;
333 
334         for (int i = 0; ; i++) {
335 
336             vm.resume();
337             breakpointForCommunication();
338 
339             int instruction = ((IntegerValue)
<span class="line-modified">340                                (debuggeeClass.getValue(debuggeeClass.fieldByName(&quot;instruction&quot;)))).value();</span>
341 
342             if (instruction == 0) {
343                 vm.resume();
344                 break;
345             }
346 
347             log1(&quot;:::::: case: # &quot; + i);
348 
349             //~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ variable part
350 
351             switch (i) {
352 
<span class="line-modified">353               case 0:</span>
<span class="line-modified">354                      testClassReference =</span>
355                             (ReferenceType) vm.classesByName(testedClassName).get(0);
356 
<span class="line-modified">357                      thread1 = (ThreadReference) debuggeeClass.getValue(</span>
<span class="line-modified">358                                         debuggeeClass.fieldByName(thread1Name));</span>
<span class="line-modified">359 </span>
<span class="line-modified">360                      eventRequest1 = setting2BreakpointRequest (null,</span>
<span class="line-modified">361                                              testClassReference, methodName, bpLineName,</span>
<span class="line-modified">362                                              EventRequest.SUSPEND_NONE, property1);</span>
<span class="line-modified">363 </span>
<span class="line-modified">364                      try {</span>
<span class="line-modified">365                          log2(&quot;......eventRequest1.addThreadFilter(thread1);&quot;);</span>
<span class="line-modified">366                          log2(&quot;        no Exception expected&quot;);</span>
<span class="line-modified">367                          ((BreakpointRequest)eventRequest1).addThreadFilter(thread1);</span>
<span class="line-modified">368                          log2(&quot;        no Exception&quot;);</span>
<span class="line-modified">369                      } catch ( Exception e ) {</span>
<span class="line-modified">370                          log3(&quot;ERROR: Exception : &quot; + e);</span>
<span class="line-modified">371                          testExitCode = FAILED;</span>
<span class="line-modified">372                      }</span>
<span class="line-modified">373 </span>
<span class="line-modified">374                      break;</span>
<span class="line-modified">375 </span>
<span class="line-modified">376               case 1:</span>
<span class="line-modified">377                      eventRequest2 = setting2BreakpointRequest (null,</span>
<span class="line-modified">378                                              testClassReference, methodName, bpLineName,</span>
<span class="line-modified">379                                              EventRequest.SUSPEND_NONE, property2);</span>
<span class="line-modified">380 </span>
<span class="line-modified">381                      try {</span>
<span class="line-modified">382                          log2(&quot;......eventRequest2.addThreadFilter(thread1);&quot;);</span>
<span class="line-modified">383                          log2(&quot;        no Exception expected&quot;);</span>
<span class="line-modified">384                          ((BreakpointRequest)eventRequest2).addThreadFilter(thread1);</span>
<span class="line-modified">385                          log2(&quot;        no Exception&quot;);</span>
<span class="line-modified">386                      } catch ( Exception e ) {</span>
<span class="line-modified">387                          log3(&quot;ERROR: Exception : &quot; + e);</span>
<span class="line-modified">388                          testExitCode = FAILED;</span>
<span class="line-modified">389                      }</span>
<span class="line-modified">390                      break;</span>
<span class="line-modified">391 </span>
<span class="line-modified">392               case 2:</span>
<span class="line-modified">393                      eventRequest3 = setting2BreakpointRequest (null,</span>
<span class="line-modified">394                                              testClassReference, methodName, bpLineName,</span>
<span class="line-modified">395                                              EventRequest.SUSPEND_NONE, property3);</span>
<span class="line-modified">396 </span>
<span class="line-modified">397                      try {</span>
<span class="line-modified">398                          log2(&quot;......eventRequest3.addThreadFilter(thread1);&quot;);</span>
<span class="line-modified">399                          log2(&quot;        no Exception expected&quot;);</span>
<span class="line-modified">400                          ((BreakpointRequest)eventRequest3).addThreadFilter(thread1);</span>
<span class="line-modified">401                          log2(&quot;        no Exception&quot;);</span>
<span class="line-modified">402                      } catch ( Exception e ) {</span>
<span class="line-modified">403                          log3(&quot;ERROR: Exception : &quot; + e);</span>
<span class="line-modified">404                          testExitCode = FAILED;</span>
<span class="line-modified">405                      }</span>
<span class="line-modified">406                      break;</span>
<span class="line-modified">407 </span>
<span class="line-modified">408               default:</span>
<span class="line-modified">409                       throw new JDITestRuntimeException(&quot;** default case 2 **&quot;);</span>
410             }
411             //~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
412         }
413         log1(&quot;    TESTING ENDS&quot;);
414         return;
415     }
416 
<span class="line-removed">417     private ThreadReference threadByName(String name)</span>
<span class="line-removed">418                  throws JDITestRuntimeException {</span>
<span class="line-removed">419 </span>
<span class="line-removed">420         List         all = vm.allThreads();</span>
<span class="line-removed">421         ListIterator li  = all.listIterator();</span>
<span class="line-removed">422 </span>
<span class="line-removed">423         for (; li.hasNext(); ) {</span>
<span class="line-removed">424             ThreadReference thread = (ThreadReference) li.next();</span>
<span class="line-removed">425             if (thread.name().equals(name))</span>
<span class="line-removed">426                 return thread;</span>
<span class="line-removed">427         }</span>
<span class="line-removed">428         throw new JDITestRuntimeException(&quot;** Thread IS NOT found ** : &quot; + name);</span>
<span class="line-removed">429     }</span>
<span class="line-removed">430 </span>
431    /*
432     * private BreakpointRequest settingBreakpoint(ThreadReference, ReferenceType,
433     *                                             String, String, String)
434     *
435     * It sets up a breakpoint at given line number within a given method in a given class
436     * for a given thread.
437     *
438     * Return value: BreakpointRequest object  in case of success
439     *
440     * JDITestRuntimeException   in case of an Exception thrown within the method
441     */
442 
443     private BreakpointRequest settingBreakpoint ( ThreadReference thread,
444                                                   ReferenceType testedClass,
445                                                   String methodName,
446                                                   String bpLine,
447                                                   String property)
448             throws JDITestRuntimeException {
449 
450         log2(&quot;......setting up a breakpoint:&quot;);
</pre>
</td>
<td>
<hr />
<pre>
139 
140     //====================================================== test program
141     //------------------------------------------------------ common section
142 
143     static Debugee          debuggee;
144     static ArgumentHandler  argsHandler;
145 
146     static int waitTime;
147 
148     static VirtualMachine      vm            = null;
149     static EventRequestManager eventRManager = null;
150     static EventQueue          eventQueue    = null;
151     static EventSet            eventSet      = null;
152     static EventIterator       eventIterator = null;
153 
154     static ReferenceType       debuggeeClass = null;
155 
156     static int  testExitCode = PASSED;
157 
158 






159     //------------------------------------------------------ methods
160 
161     private int runThis (String argv[], PrintStream out) {
162 
163         argsHandler     = new ArgumentHandler(argv);
164         logHandler      = new Log(out, argsHandler);
165         Binder binder   = new Binder(argsHandler, logHandler);
166 
167         waitTime        = argsHandler.getWaitTime() * 60000;
168 
169         try {
170             log2(&quot;launching a debuggee :&quot;);
171             log2(&quot;       &quot; + debuggeeName);
172             if (argsHandler.verbose()) {
173                 debuggee = binder.bindToDebugee(debuggeeName + &quot; -vbs&quot;);
174             } else {
175                 debuggee = binder.bindToDebugee(debuggeeName);
176             }
177             if (debuggee == null) {
178                 log3(&quot;ERROR: no debuggee launched&quot;);
</pre>
<hr />
<pre>
262                 return 0;
263 
264             log3(&quot;ERROR: last event is not the VMDeathEvent&quot;);
265             return 1;
266         } catch ( VMDisconnectedException e ) {
267             log3(&quot;ERROR: VMDisconnectedException : &quot; + e);
268             return 2;
269         } catch ( Exception e ) {
270             log3(&quot;ERROR: Exception : &quot; + e);
271             return 1;
272         }
273 
274     }
275 
276     private void testRun()
277                  throws JDITestRuntimeException, Exception {
278 
279         eventRManager = vm.eventRequestManager();
280 
281         ClassPrepareRequest cpRequest = eventRManager.createClassPrepareRequest();
<span class="line-modified">282         cpRequest.setSuspendPolicy(EventRequest.SUSPEND_EVENT_THREAD);</span>
283         cpRequest.addClassFilter(debuggeeName);
284 
285         cpRequest.enable();
286         vm.resume();
287         getEventSet();
288         cpRequest.disable();
289 
290         ClassPrepareEvent event = (ClassPrepareEvent) eventIterator.next();
291         debuggeeClass = event.referenceType();
292 
293         if (!debuggeeClass.name().equals(debuggeeName))
<span class="line-modified">294             throw new JDITestRuntimeException(&quot;** Unexpected ClassName for ClassPrepareEvent **&quot;);</span>
295 
296         log2(&quot;      received: ClassPrepareEvent for debuggeeClass&quot;);
297 
298         String bPointMethod = &quot;methodForCommunication&quot;;
<span class="line-modified">299         String lineForComm = &quot;lineForComm&quot;;</span>
300 
<span class="line-modified">301         ThreadReference mainThread = debuggee.threadByNameOrThrow(&quot;main&quot;);</span>
302 
303         BreakpointRequest bpRequest = settingBreakpoint(mainThread,
<span class="line-modified">304                 debuggeeClass,</span>
<span class="line-modified">305                 bPointMethod, lineForComm, &quot;zero&quot;);</span>
306         bpRequest.enable();
307 
<span class="line-modified">308         //------------------------------------------------------  testing section</span>
309 
310         log1(&quot;     TESTING BEGINS&quot;);
311 
312         EventRequest eventRequest1 = null;
313         EventRequest eventRequest2 = null;
314         EventRequest eventRequest3 = null;
315 
<span class="line-modified">316         ThreadReference thread1 = null;</span>
<span class="line-modified">317         String thread1Name = &quot;thread1&quot;;</span>
318 
319         String property1 = &quot;BreakpointRequest1&quot;;
320         String property2 = &quot;BreakpointRequest2&quot;;
321         String property3 = &quot;BreakpointRequest3&quot;;
322 
323         String methodName = &quot;method&quot;;
324         String bpLineName = &quot;breakpointLine&quot;;
325 
326         ReferenceType testClassReference = null;
327 
328         for (int i = 0; ; i++) {
329 
330             vm.resume();
331             breakpointForCommunication();
332 
333             int instruction = ((IntegerValue)
<span class="line-modified">334                     (debuggeeClass.getValue(debuggeeClass.fieldByName(&quot;instruction&quot;)))).value();</span>
335 
336             if (instruction == 0) {
337                 vm.resume();
338                 break;
339             }
340 
341             log1(&quot;:::::: case: # &quot; + i);
342 
343             //~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ variable part
344 
345             switch (i) {
346 
<span class="line-modified">347                 case 0:</span>
<span class="line-modified">348                     testClassReference =</span>
349                             (ReferenceType) vm.classesByName(testedClassName).get(0);
350 
<span class="line-modified">351                     thread1 = (ThreadReference) debuggeeClass.getValue(</span>
<span class="line-modified">352                             debuggeeClass.fieldByName(thread1Name));</span>
<span class="line-modified">353 </span>
<span class="line-modified">354                     eventRequest1 = setting2BreakpointRequest(null,</span>
<span class="line-modified">355                             testClassReference, methodName, bpLineName,</span>
<span class="line-modified">356                             EventRequest.SUSPEND_NONE, property1);</span>
<span class="line-modified">357 </span>
<span class="line-modified">358                     try {</span>
<span class="line-modified">359                         log2(&quot;......eventRequest1.addThreadFilter(thread1);&quot;);</span>
<span class="line-modified">360                         log2(&quot;        no Exception expected&quot;);</span>
<span class="line-modified">361                         ((BreakpointRequest) eventRequest1).addThreadFilter(thread1);</span>
<span class="line-modified">362                         log2(&quot;        no Exception&quot;);</span>
<span class="line-modified">363                     } catch (Exception e) {</span>
<span class="line-modified">364                         log3(&quot;ERROR: Exception : &quot; + e);</span>
<span class="line-modified">365                         testExitCode = FAILED;</span>
<span class="line-modified">366                     }</span>
<span class="line-modified">367 </span>
<span class="line-modified">368                     break;</span>
<span class="line-modified">369 </span>
<span class="line-modified">370                 case 1:</span>
<span class="line-modified">371                     eventRequest2 = setting2BreakpointRequest(null,</span>
<span class="line-modified">372                             testClassReference, methodName, bpLineName,</span>
<span class="line-modified">373                             EventRequest.SUSPEND_NONE, property2);</span>
<span class="line-modified">374 </span>
<span class="line-modified">375                     try {</span>
<span class="line-modified">376                         log2(&quot;......eventRequest2.addThreadFilter(thread1);&quot;);</span>
<span class="line-modified">377                         log2(&quot;        no Exception expected&quot;);</span>
<span class="line-modified">378                         ((BreakpointRequest) eventRequest2).addThreadFilter(thread1);</span>
<span class="line-modified">379                         log2(&quot;        no Exception&quot;);</span>
<span class="line-modified">380                     } catch (Exception e) {</span>
<span class="line-modified">381                         log3(&quot;ERROR: Exception : &quot; + e);</span>
<span class="line-modified">382                         testExitCode = FAILED;</span>
<span class="line-modified">383                     }</span>
<span class="line-modified">384                     break;</span>
<span class="line-modified">385 </span>
<span class="line-modified">386                 case 2:</span>
<span class="line-modified">387                     eventRequest3 = setting2BreakpointRequest(null,</span>
<span class="line-modified">388                             testClassReference, methodName, bpLineName,</span>
<span class="line-modified">389                             EventRequest.SUSPEND_NONE, property3);</span>
<span class="line-modified">390 </span>
<span class="line-modified">391                     try {</span>
<span class="line-modified">392                         log2(&quot;......eventRequest3.addThreadFilter(thread1);&quot;);</span>
<span class="line-modified">393                         log2(&quot;        no Exception expected&quot;);</span>
<span class="line-modified">394                         ((BreakpointRequest) eventRequest3).addThreadFilter(thread1);</span>
<span class="line-modified">395                         log2(&quot;        no Exception&quot;);</span>
<span class="line-modified">396                     } catch (Exception e) {</span>
<span class="line-modified">397                         log3(&quot;ERROR: Exception : &quot; + e);</span>
<span class="line-modified">398                         testExitCode = FAILED;</span>
<span class="line-modified">399                     }</span>
<span class="line-modified">400                     break;</span>
<span class="line-modified">401 </span>
<span class="line-modified">402                 default:</span>
<span class="line-modified">403                     throw new JDITestRuntimeException(&quot;** default case 2 **&quot;);</span>
404             }
405             //~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
406         }
407         log1(&quot;    TESTING ENDS&quot;);
408         return;
409     }
410 














411    /*
412     * private BreakpointRequest settingBreakpoint(ThreadReference, ReferenceType,
413     *                                             String, String, String)
414     *
415     * It sets up a breakpoint at given line number within a given method in a given class
416     * for a given thread.
417     *
418     * Return value: BreakpointRequest object  in case of success
419     *
420     * JDITestRuntimeException   in case of an Exception thrown within the method
421     */
422 
423     private BreakpointRequest settingBreakpoint ( ThreadReference thread,
424                                                   ReferenceType testedClass,
425                                                   String methodName,
426                                                   String bpLine,
427                                                   String property)
428             throws JDITestRuntimeException {
429 
430         log2(&quot;......setting up a breakpoint:&quot;);
</pre>
</td>
</tr>
</table>
<center><a href="threadfilter002.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../location/location001.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>