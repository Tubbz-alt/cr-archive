<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff test/hotspot/jtreg/vmTestbase/nsk/share/jni/ExceptionCheckingJniEnv.cpp</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="../jdi/MonitorEventsDebuggee.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="ExceptionCheckingJniEnv.hpp.cdiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/jtreg/vmTestbase/nsk/share/jni/ExceptionCheckingJniEnv.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,8 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="line-modified">!  * Copyright (c) 2018, Google and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
<span class="line-new-header">--- 1,8 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2018, 2019, Oracle and/or its affiliates. All rights reserved.</span>
<span class="line-modified">!  * Copyright (c) 2018, 2019, Google and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 20,165 ***</span>
   * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
   * or visit www.oracle.com if you need additional information or have any
   * questions.
   */
  
  #include &lt;stdlib.h&gt;
  #include &lt;string.h&gt;
  
  #include &quot;ExceptionCheckingJniEnv.hpp&quot;
  
  namespace {
  
  template&lt;class T = void*&gt;
  class JNIVerifier {
   public:
<span class="line-modified">!   JNIVerifier(ExceptionCheckingJniEnv *env, const char* base_msg)</span>
<span class="line-modified">!       : _env(env), _base_msg(base_msg), _return_error(NULL) {</span>
    }
  
    ~JNIVerifier() {
      JNIEnv* jni_env = _env-&gt;GetJNIEnv();
<span class="line-modified">!     if (jni_env-&gt;ExceptionCheck()) {</span>
<span class="line-modified">!       _env-&gt;HandleError(_base_msg);</span>
        return;
      }
  
<span class="line-modified">!     if (_return_error != NULL) {</span>
<span class="line-modified">!       ProcessReturnError();</span>
      }
    }
  
<span class="line-modified">!   void ProcessReturnError() {</span>
      // This is error prone, but:
      //   - Seems like we cannot use std::string (due to windows/solaris not
      //   building when used, seemingly due to exception libraries not linking).
      //   - Seems like we cannot use sprintf due to VS2013 (JDK-8213622).
      //
      //   We are aiming to do:
<span class="line-modified">!     //     snprintf(full_message, len, &quot;%s : %s&quot;, _base_msg, _return_error);</span>
      //   but will use strlen + memcpy instead.
<span class="line-modified">!     size_t base_len = strlen(_base_msg);</span>
      const char* between_msg = &quot; : &quot;;
<span class="line-modified">!     size_t between_len = strlen(between_msg);</span>
<span class="line-modified">!     size_t return_len = strlen(_return_error);</span>
  
<span class="line-modified">!     // +1 for the &#39;\0&#39;</span>
<span class="line-modified">!     size_t len = base_len + between_len + return_len + 1;</span>
  
      char* full_message = (char*) malloc(len);
      if (full_message == NULL) {
<span class="line-modified">!       _env-&gt;HandleError(_return_error);</span>
        return;
      }
  
<span class="line-modified">!     // Now we construct the string using memcpy to not use sprintf/std::string</span>
      // instead of:
<span class="line-modified">!     //     snprintf(full_message, len, &quot;%s : %s&quot;, _base_msg, _return_error);</span>
<span class="line-modified">!     memcpy(full_message, _base_msg, base_len);</span>
<span class="line-modified">!     memcpy(full_message + base_len, between_msg, between_len);</span>
<span class="line-modified">!     memcpy(full_message + base_len + between_len, _return_error, return_len);</span>
<span class="line-modified">!     full_message[len - 1] = &#39;\0&#39;;</span>
  
<span class="line-modified">!     // -1 due to the &#39;\0&#39; not counted by strlen but is counted for the allocation.</span>
<span class="line-modified">!     if (strlen(full_message) != len - 1) {</span>
<span class="line-modified">!       _env-&gt;GetJNIEnv()-&gt;FatalError(&quot;Length of message is not what was expected&quot;);</span>
      }
  
      _env-&gt;HandleError(full_message);
      free(full_message);
    }
  
    T ResultNotNull(T ptr) {
      if (ptr == NULL) {
<span class="line-modified">!       _return_error = &quot;Return is NULL&quot;;</span>
      }
      return ptr;
    }
  
   private:
    ExceptionCheckingJniEnv* _env;
<span class="line-modified">!   const char* const _base_msg;</span>
<span class="line-modified">!   const char* _return_error;</span>
  };
  
  }
  
<span class="line-modified">! jclass ExceptionCheckingJniEnv::GetObjectClass(jobject obj) {</span>
<span class="line-modified">!   JNIVerifier&lt;jclass&gt; marker(this, &quot;GetObjectClass&quot;);</span>
    return marker.ResultNotNull(_jni_env-&gt;GetObjectClass(obj));
  }
  
<span class="line-modified">! jfieldID ExceptionCheckingJniEnv::GetFieldID(jclass klass, const char *name, const char* type) {</span>
<span class="line-modified">!   JNIVerifier&lt;jfieldID&gt; marker(this, &quot;GetFieldID&quot;);</span>
    return marker.ResultNotNull(_jni_env-&gt;GetFieldID(klass, name, type));
  }
  
<span class="line-modified">! jobject ExceptionCheckingJniEnv::GetObjectField(jobject obj, jfieldID field) {</span>
<span class="line-modified">!   JNIVerifier&lt;jobject&gt; marker(this, &quot;GetObjectField&quot;);</span>
    return marker.ResultNotNull(_jni_env-&gt;GetObjectField(obj, field));
  }
  
<span class="line-modified">! void ExceptionCheckingJniEnv::SetObjectField(jobject obj, jfieldID field, jobject value) {</span>
<span class="line-modified">!   JNIVerifier&lt;&gt; marker(this, &quot;SetObjectField&quot;);</span>
    _jni_env-&gt;SetObjectField(obj, field, value);
  }
  
<span class="line-modified">! jobject ExceptionCheckingJniEnv::NewGlobalRef(jobject obj) {</span>
<span class="line-modified">!   JNIVerifier&lt;jobject&gt; marker(this, &quot;NewGlobalRef&quot;);</span>
    return marker.ResultNotNull(_jni_env-&gt;NewGlobalRef(obj));
  }
  
<span class="line-modified">! void ExceptionCheckingJniEnv::DeleteGlobalRef(jobject obj) {</span>
<span class="line-modified">!   JNIVerifier&lt;&gt; marker(this, &quot;DeleteGlobalRef&quot;);</span>
    _jni_env-&gt;DeleteGlobalRef(obj);
  }
  
<span class="line-modified">! jobject ExceptionCheckingJniEnv::NewLocalRef(jobject obj) {</span>
<span class="line-modified">!   JNIVerifier&lt;jobject&gt; marker(this, &quot;NewLocalRef&quot;);</span>
    return marker.ResultNotNull(_jni_env-&gt;NewLocalRef(obj));
  }
  
<span class="line-modified">! void ExceptionCheckingJniEnv::DeleteLocalRef(jobject obj) {</span>
<span class="line-modified">!   JNIVerifier&lt;&gt; marker(this, &quot;DeleteLocalRef&quot;);</span>
    _jni_env-&gt;DeleteLocalRef(obj);
  }
  
<span class="line-modified">! jweak ExceptionCheckingJniEnv::NewWeakGlobalRef(jobject obj) {</span>
<span class="line-modified">!   JNIVerifier&lt;jweak&gt; marker(this, &quot;NewWeakGlobalRef&quot;);</span>
    return marker.ResultNotNull(_jni_env-&gt;NewWeakGlobalRef(obj));
  }
  
<span class="line-modified">! void ExceptionCheckingJniEnv::DeleteWeakGlobalRef(jweak weak_ref) {</span>
<span class="line-modified">!   JNIVerifier&lt;&gt; marker(this, &quot;DeleteWeakGlobalRef&quot;);</span>
    _jni_env-&gt;DeleteWeakGlobalRef(weak_ref);
  }
  
<span class="line-modified">! jsize ExceptionCheckingJniEnv::GetArrayLength(jarray array) {</span>
<span class="line-modified">!   JNIVerifier&lt;&gt; marker(this, &quot;GetArrayLength&quot;);</span>
    return _jni_env-&gt;GetArrayLength(array);
  }
  
<span class="line-modified">! jsize ExceptionCheckingJniEnv::GetStringLength(jstring str) {</span>
<span class="line-modified">!   JNIVerifier&lt;&gt; marker(this, &quot;GetStringLength&quot;);</span>
    return _jni_env-&gt;GetStringLength(str);
  }
  
<span class="line-modified">! void* ExceptionCheckingJniEnv::GetPrimitiveArrayCritical(jarray array, jboolean* isCopy) {</span>
<span class="line-modified">!   JNIVerifier&lt;&gt; marker(this, &quot;GetPrimitiveArrayCritical&quot;);</span>
<span class="line-modified">!   return marker.ResultNotNull(_jni_env-&gt;GetPrimitiveArrayCritical(array, isCopy));</span>
  }
  
<span class="line-modified">! void ExceptionCheckingJniEnv::ReleasePrimitiveArrayCritical(jarray array, void* carray, jint mode) {</span>
<span class="line-modified">!   JNIVerifier&lt;&gt; marker(this, &quot;ReleasePrimitiveArrayCritical&quot;);</span>
    _jni_env-&gt;ReleasePrimitiveArrayCritical(array, carray, mode);
  }
  
<span class="line-modified">! const jchar* ExceptionCheckingJniEnv::GetStringCritical(jstring str, jboolean* isCopy) {</span>
<span class="line-modified">!   JNIVerifier&lt;const jchar*&gt; marker(this, &quot;GetPrimitiveArrayCritical&quot;);</span>
<span class="line-modified">!   return marker.ResultNotNull(_jni_env-&gt;GetStringCritical(str, isCopy));</span>
  }
  
<span class="line-modified">! void ExceptionCheckingJniEnv::ReleaseStringCritical(jstring str, const jchar* carray) {</span>
<span class="line-modified">!   JNIVerifier&lt;&gt; marker(this, &quot;ReleaseStringCritical&quot;);</span>
    _jni_env-&gt;ReleaseStringCritical(str, carray);
  }
<span class="line-new-header">--- 20,452 ---</span>
   * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
   * or visit www.oracle.com if you need additional information or have any
   * questions.
   */
  
<span class="line-added">+ #include &lt;stdint.h&gt;</span>
  #include &lt;stdlib.h&gt;
  #include &lt;string.h&gt;
  
  #include &quot;ExceptionCheckingJniEnv.hpp&quot;
<span class="line-added">+ #include &quot;nsk_tools.h&quot;</span>
  
  namespace {
  
<span class="line-added">+ static const char* get_dirname(const char* fullname) {</span>
<span class="line-added">+   const char* p;</span>
<span class="line-added">+   const char* base = fullname;;</span>
<span class="line-added">+ </span>
<span class="line-added">+   if (fullname == NULL) {</span>
<span class="line-added">+     return NULL;</span>
<span class="line-added">+   }</span>
<span class="line-added">+ </span>
<span class="line-added">+   for (p = fullname; *p != &#39;\0&#39;; p++) {</span>
<span class="line-added">+     if (*p == &#39;/&#39; || *p == &#39;\\&#39;) {</span>
<span class="line-added">+       base = p + 1;</span>
<span class="line-added">+     }</span>
<span class="line-added">+   }</span>
<span class="line-added">+   return base;</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
  template&lt;class T = void*&gt;
  class JNIVerifier {
   public:
<span class="line-modified">!   JNIVerifier(ExceptionCheckingJniEnv *env, const char* base_message,</span>
<span class="line-modified">!               int line, const char* file)</span>
<span class="line-added">+       : _env(env), _base_message(base_message), _error_message(NULL),</span>
<span class="line-added">+         _line(line), _file(get_dirname(file)) {</span>
<span class="line-added">+   }</span>
<span class="line-added">+ </span>
<span class="line-added">+   // Until C++11 is supported, we have to write multiple template constructors.</span>
<span class="line-added">+   template &lt;typename U&gt;</span>
<span class="line-added">+   JNIVerifier(ExceptionCheckingJniEnv *env, const char* base_message,</span>
<span class="line-added">+               U parameter,</span>
<span class="line-added">+               int line, const char* file)</span>
<span class="line-added">+       : _env(env), _base_message(base_message), _error_message(NULL),</span>
<span class="line-added">+         _line(line), _file(get_dirname(file)) {</span>
<span class="line-added">+           PrintPreCall(parameter);</span>
<span class="line-added">+   }</span>
<span class="line-added">+ </span>
<span class="line-added">+   template &lt;typename U, typename V&gt;</span>
<span class="line-added">+   JNIVerifier(ExceptionCheckingJniEnv *env, const char* base_message,</span>
<span class="line-added">+               U parameter1,</span>
<span class="line-added">+               V parameter2,</span>
<span class="line-added">+               int line, const char* file)</span>
<span class="line-added">+       : _env(env), _base_message(base_message), _error_message(NULL),</span>
<span class="line-added">+         _line(line), _file(get_dirname(file)) {</span>
<span class="line-added">+           PrintPreCall(parameter1, parameter2);</span>
<span class="line-added">+   }</span>
<span class="line-added">+ </span>
<span class="line-added">+   template &lt;typename U, typename V, typename W&gt;</span>
<span class="line-added">+   JNIVerifier(ExceptionCheckingJniEnv *env, const char* base_message,</span>
<span class="line-added">+               U parameter1, V parameter2, W parameter3,</span>
<span class="line-added">+               int line, const char* file)</span>
<span class="line-added">+       : _env(env), _base_message(base_message), _error_message(NULL),</span>
<span class="line-added">+         _line(line), _file(get_dirname(file)) {</span>
<span class="line-added">+           PrintPreCall(parameter1, parameter2, parameter3);</span>
    }
  
    ~JNIVerifier() {
<span class="line-added">+     PrintPostCall();</span>
<span class="line-added">+ </span>
      JNIEnv* jni_env = _env-&gt;GetJNIEnv();
<span class="line-modified">!     if (jni_env-&gt;ExceptionCheck() &amp;&amp; !_error_message) {</span>
<span class="line-modified">!       _error_message = &quot;internal error&quot;;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     if (_error_message != NULL) {</span>
<span class="line-added">+       GenerateErrorMessage();</span>
<span class="line-added">+     }</span>
<span class="line-added">+   }</span>
<span class="line-added">+ </span>
<span class="line-added">+   int DecimalToAsciiRec(char *str, int line) {</span>
<span class="line-added">+     if (line == 0) {</span>
<span class="line-added">+       return 0;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     int remainder = line % 10;</span>
<span class="line-added">+     long quotient = line / 10;</span>
<span class="line-added">+ </span>
<span class="line-added">+     int pos = DecimalToAsciiRec(str, quotient);</span>
<span class="line-added">+     str[pos] = &#39;0&#39; + remainder;</span>
<span class="line-added">+     return pos + 1;</span>
<span class="line-added">+   }</span>
<span class="line-added">+ </span>
<span class="line-added">+   // Implementing a simple version of sprintf for &quot;%d&quot;...</span>
<span class="line-added">+   void DecimalToAscii(char *str, int line) {</span>
<span class="line-added">+     if (line == 0) {</span>
<span class="line-added">+       str[0] = &#39;0&#39;;</span>
<span class="line-added">+       str[1] = &#39;\0&#39;;</span>
<span class="line-added">+       return;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     // Special case for INT32_MIN because otherwise the *1 below will overflow</span>
<span class="line-added">+     // and it won&#39;t work. Let us just be simple here due to this being for</span>
<span class="line-added">+     // tests.</span>
<span class="line-added">+     if (line == INT32_MIN) {</span>
<span class="line-added">+       strcat(str, &quot;-2147483648&quot;);</span>
        return;
      }
  
<span class="line-modified">!     if (line &lt; 0) {</span>
<span class="line-modified">!       *str = &#39;-&#39;;</span>
<span class="line-added">+       line *= -1;</span>
<span class="line-added">+       str++;</span>
      }
<span class="line-added">+ </span>
<span class="line-added">+     str[DecimalToAsciiRec(str, line)] = &#39;\0&#39;;</span>
    }
  
<span class="line-modified">!   void GenerateErrorMessage() {</span>
      // This is error prone, but:
      //   - Seems like we cannot use std::string (due to windows/solaris not
      //   building when used, seemingly due to exception libraries not linking).
      //   - Seems like we cannot use sprintf due to VS2013 (JDK-8213622).
      //
      //   We are aiming to do:
<span class="line-modified">!     //     snprintf(full_message, len, &quot;JNI method %s : %s from %s : %d&quot;, _base_message, _error_message,</span>
<span class="line-added">+     //              _file, _line);</span>
      //   but will use strlen + memcpy instead.
<span class="line-modified">!     const char* pre_message = &quot;JNI method &quot;;</span>
      const char* between_msg = &quot; : &quot;;
<span class="line-modified">!     const char* from_msg = &quot; from &quot;;</span>
<span class="line-modified">! </span>
<span class="line-added">+     const char* file_name = _file ? _file : &quot;Unknown File&quot;;</span>
<span class="line-added">+     const char* strs[] = {</span>
<span class="line-added">+       pre_message,</span>
<span class="line-added">+       _base_message,</span>
<span class="line-added">+       between_msg,</span>
<span class="line-added">+       _error_message,</span>
<span class="line-added">+       from_msg,</span>
<span class="line-added">+       file_name,</span>
<span class="line-added">+       between_msg,</span>
<span class="line-added">+     };</span>
  
<span class="line-modified">!     size_t msg_number = sizeof(strs) / sizeof(strs[0]);</span>
<span class="line-modified">!     size_t len = 0;</span>
<span class="line-added">+     for (size_t i = 0; i &lt; msg_number; i++) {</span>
<span class="line-added">+       len += strlen(strs[i]);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     // 32-bit signed means 11 characters due to the &#39;-&#39;.</span>
<span class="line-added">+     const int MAX_INTEGER_DIGITS = 11;</span>
<span class="line-added">+     // Add for the line number and 1 for the &#39;\0&#39;.</span>
<span class="line-added">+     len += MAX_INTEGER_DIGITS + 1;</span>
  
      char* full_message = (char*) malloc(len);
      if (full_message == NULL) {
<span class="line-modified">!       _env-&gt;HandleError(_error_message);</span>
        return;
      }
  
<span class="line-modified">!     // Now we construct the string using strcat to not use sprintf/std::string</span>
      // instead of:
<span class="line-modified">!     //     snprintf(full_message, len, &quot;JNI method %s : %s from %s:%d&quot;, _base_message,</span>
<span class="line-modified">!     //         _error_message, _file, _line);</span>
<span class="line-modified">!     full_message[0] = &#39;\0&#39;;</span>
<span class="line-modified">!     for (size_t i = 0; i &lt; msg_number; i++) {</span>
<span class="line-modified">!       strcat(full_message, strs[i]);</span>
<span class="line-added">+     }</span>
  
<span class="line-modified">!     // Add line number to end of the string.</span>
<span class="line-modified">!     DecimalToAscii(full_message + strlen(full_message), _line);</span>
<span class="line-modified">! </span>
<span class="line-added">+     if (strlen(full_message) &gt;= len) {</span>
<span class="line-added">+       _env-&gt;GetJNIEnv()-&gt;FatalError(&quot;Final length of message is not what was expected&quot;);</span>
      }
  
      _env-&gt;HandleError(full_message);
      free(full_message);
    }
  
    T ResultNotNull(T ptr) {
      if (ptr == NULL) {
<span class="line-modified">!       _error_message = &quot;Return is NULL&quot;;</span>
      }
      return ptr;
    }
  
<span class="line-added">+   T ResultIsZero(T value) {</span>
<span class="line-added">+     if (value != 0) {</span>
<span class="line-added">+       _error_message = &quot;Return is not zero&quot;;</span>
<span class="line-added">+     }</span>
<span class="line-added">+     return value;</span>
<span class="line-added">+   }</span>
<span class="line-added">+ </span>
<span class="line-added">+   void PrintPreCallHeader() {</span>
<span class="line-added">+     if (!nsk_getVerboseMode()) {</span>
<span class="line-added">+       return;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     fprintf(stdout, &quot;&gt;&gt; Calling JNI method %s from %s:%d\n&quot;,</span>
<span class="line-added">+             _base_message, _file, _line);</span>
<span class="line-added">+     fprintf(stdout, &quot;&gt;&gt; Calling with these parameter(s):\n&quot;);</span>
<span class="line-added">+   }</span>
<span class="line-added">+ </span>
<span class="line-added">+   // Until we can actually link with C++ more uniformely across architectures,</span>
<span class="line-added">+   // we have to do this...</span>
<span class="line-added">+   template&lt;class U&gt;</span>
<span class="line-added">+   void PrintParameter(U* ptr) {</span>
<span class="line-added">+     fprintf(stdout, &quot;\t%p\n&quot;, ptr);</span>
<span class="line-added">+   }</span>
<span class="line-added">+ </span>
<span class="line-added">+   void PrintParameter(int value) {</span>
<span class="line-added">+     fprintf(stdout, &quot;\t%d\n&quot;, value);</span>
<span class="line-added">+   }</span>
<span class="line-added">+ </span>
<span class="line-added">+   // Until C++11 is supported, we have to write multiple PrintPreCall.</span>
<span class="line-added">+   template&lt;class U&gt;</span>
<span class="line-added">+   void PrintPreCall(U first_parameter) {</span>
<span class="line-added">+     if (!nsk_getVerboseMode()) {</span>
<span class="line-added">+       return;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     PrintPreCallHeader();</span>
<span class="line-added">+     PrintParameter(first_parameter);</span>
<span class="line-added">+   }</span>
<span class="line-added">+ </span>
<span class="line-added">+   template&lt;class U, class V&gt;</span>
<span class="line-added">+   void PrintPreCall(U parameter1, V parameter2) {</span>
<span class="line-added">+     if (!nsk_getVerboseMode()) {</span>
<span class="line-added">+       return;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     PrintPreCallHeader();</span>
<span class="line-added">+     PrintParameter(parameter1);</span>
<span class="line-added">+     PrintParameter(parameter2);</span>
<span class="line-added">+   }</span>
<span class="line-added">+ </span>
<span class="line-added">+   template&lt;class U, class V, class W&gt;</span>
<span class="line-added">+   void PrintPreCall(U parameter1, V parameter2, W parameter3) {</span>
<span class="line-added">+     if (!nsk_getVerboseMode()) {</span>
<span class="line-added">+       return;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     PrintPreCallHeader();</span>
<span class="line-added">+     PrintParameter(parameter1);</span>
<span class="line-added">+     PrintParameter(parameter2);</span>
<span class="line-added">+     PrintParameter(parameter3);</span>
<span class="line-added">+   }</span>
<span class="line-added">+ </span>
<span class="line-added">+   void PrintPostCall() {</span>
<span class="line-added">+     if (!nsk_getVerboseMode()) {</span>
<span class="line-added">+       return;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     fprintf(stderr, &quot;&lt;&lt; Called JNI method %s from %s:%d\n&quot;,</span>
<span class="line-added">+             _base_message, _file, _line);</span>
<span class="line-added">+   }</span>
<span class="line-added">+ </span>
   private:
    ExceptionCheckingJniEnv* _env;
<span class="line-modified">!   const char* const _base_message;</span>
<span class="line-modified">!   const char* _error_message;</span>
<span class="line-added">+   int _line;</span>
<span class="line-added">+   const char* const _file;</span>
  };
  
  }
  
<span class="line-modified">! jclass ExceptionCheckingJniEnv::FindClass(const char *class_name,</span>
<span class="line-modified">!                                           int line, const char* file_name) {</span>
<span class="line-added">+   JNIVerifier&lt;jclass&gt; marker(this, &quot;FindClass&quot;, class_name, line, file_name);</span>
<span class="line-added">+   return marker.ResultNotNull(_jni_env-&gt;FindClass(class_name));</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ jint ExceptionCheckingJniEnv::RegisterNatives(jclass clazz,</span>
<span class="line-added">+                                               const JNINativeMethod *methods,</span>
<span class="line-added">+                                               jint nMethods,</span>
<span class="line-added">+                                               int line,</span>
<span class="line-added">+                                               const char* file_name) {</span>
<span class="line-added">+   JNIVerifier&lt;jint&gt; marker(this, &quot;RegisterNatives&quot;, methods, nMethods, line, file_name);</span>
<span class="line-added">+   return marker.ResultIsZero(_jni_env-&gt;RegisterNatives(clazz, methods, nMethods));</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ jclass ExceptionCheckingJniEnv::GetObjectClass(jobject obj, int line,</span>
<span class="line-added">+                                                const char* file_name) {</span>
<span class="line-added">+   JNIVerifier&lt;jclass&gt; marker(this, &quot;GetObjectClass&quot;, obj, line, file_name);</span>
    return marker.ResultNotNull(_jni_env-&gt;GetObjectClass(obj));
  }
  
<span class="line-modified">! jfieldID ExceptionCheckingJniEnv::GetStaticFieldID(jclass klass, const char *name,</span>
<span class="line-modified">!                                                    const char* type,</span>
<span class="line-added">+                                                    int line, const char* file_name) {</span>
<span class="line-added">+   JNIVerifier&lt;jfieldID&gt; marker(this, &quot;GetStaticFieldID&quot;, klass, name, type,</span>
<span class="line-added">+                                line, file_name);</span>
<span class="line-added">+   return marker.ResultNotNull(_jni_env-&gt;GetStaticFieldID(klass, name, type));</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ jfieldID ExceptionCheckingJniEnv::GetFieldID(jclass klass, const char *name,</span>
<span class="line-added">+                                              const char* type,</span>
<span class="line-added">+                                              int line, const char* file_name) {</span>
<span class="line-added">+   JNIVerifier&lt;jfieldID&gt; marker(this, &quot;GetFieldID&quot;, klass, name, type, line, file_name);</span>
    return marker.ResultNotNull(_jni_env-&gt;GetFieldID(klass, name, type));
  }
  
<span class="line-modified">! jobject ExceptionCheckingJniEnv::GetStaticObjectField(jclass klass, jfieldID field,</span>
<span class="line-modified">!                                                       int line, const char* file_name) {</span>
<span class="line-added">+   JNIVerifier&lt;jobject&gt; marker(this, &quot;GetStaticObjectField&quot;, klass, field,</span>
<span class="line-added">+                               line, file_name);</span>
<span class="line-added">+   return marker.ResultNotNull(_jni_env-&gt;GetStaticObjectField(klass, field));</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ jobject ExceptionCheckingJniEnv::GetObjectField(jobject obj, jfieldID field,</span>
<span class="line-added">+                                                 int line, const char* file_name) {</span>
<span class="line-added">+   JNIVerifier&lt;jobject&gt; marker(this, &quot;GetObjectField&quot;, obj, field, line, file_name);</span>
    return marker.ResultNotNull(_jni_env-&gt;GetObjectField(obj, field));
  }
  
<span class="line-modified">! void ExceptionCheckingJniEnv::SetObjectField(jobject obj, jfieldID field, jobject value,</span>
<span class="line-modified">!                                              int line, const char* file_name) {</span>
<span class="line-added">+   JNIVerifier&lt;&gt; marker(this, &quot;SetObjectField&quot;, obj, field, value, line, file_name);</span>
    _jni_env-&gt;SetObjectField(obj, field, value);
  }
  
<span class="line-modified">! jobject ExceptionCheckingJniEnv::NewGlobalRef(jobject obj, int line, const char* file_name) {</span>
<span class="line-modified">!   JNIVerifier&lt;jobject&gt; marker(this, &quot;NewGlobalRef&quot;, obj, line, file_name);</span>
    return marker.ResultNotNull(_jni_env-&gt;NewGlobalRef(obj));
  }
  
<span class="line-modified">! void ExceptionCheckingJniEnv::DeleteGlobalRef(jobject obj, int line, const char* file_name) {</span>
<span class="line-modified">!   JNIVerifier&lt;&gt; marker(this, &quot;DeleteGlobalRef&quot;, obj, line, file_name);</span>
    _jni_env-&gt;DeleteGlobalRef(obj);
  }
  
<span class="line-modified">! jobject ExceptionCheckingJniEnv::NewLocalRef(jobject obj, int line, const char* file_name) {</span>
<span class="line-modified">!   JNIVerifier&lt;jobject&gt; marker(this, &quot;NewLocalRef&quot;, obj, line, file_name);</span>
    return marker.ResultNotNull(_jni_env-&gt;NewLocalRef(obj));
  }
  
<span class="line-modified">! void ExceptionCheckingJniEnv::DeleteLocalRef(jobject obj, int line, const char* file_name) {</span>
<span class="line-modified">!   JNIVerifier&lt;&gt; marker(this, &quot;DeleteLocalRef&quot;, obj, line, file_name);</span>
    _jni_env-&gt;DeleteLocalRef(obj);
  }
  
<span class="line-modified">! jweak ExceptionCheckingJniEnv::NewWeakGlobalRef(jobject obj, int line, const char* file_name) {</span>
<span class="line-modified">!   JNIVerifier&lt;jweak&gt; marker(this, &quot;NewWeakGlobalRef&quot;, obj, line, file_name);</span>
    return marker.ResultNotNull(_jni_env-&gt;NewWeakGlobalRef(obj));
  }
  
<span class="line-modified">! void ExceptionCheckingJniEnv::DeleteWeakGlobalRef(jweak weak_ref, int line, const char* file_name) {</span>
<span class="line-modified">!   JNIVerifier&lt;&gt; marker(this, &quot;DeleteWeakGlobalRef&quot;, weak_ref, line, file_name);</span>
    _jni_env-&gt;DeleteWeakGlobalRef(weak_ref);
  }
  
<span class="line-modified">! jsize ExceptionCheckingJniEnv::GetArrayLength(jarray array, int line, const char* file_name) {</span>
<span class="line-modified">!   JNIVerifier&lt;&gt; marker(this, &quot;GetArrayLength&quot;, array, line, file_name);</span>
    return _jni_env-&gt;GetArrayLength(array);
  }
  
<span class="line-modified">! jsize ExceptionCheckingJniEnv::GetStringLength(jstring str, int line, const char* file_name) {</span>
<span class="line-modified">!   JNIVerifier&lt;&gt; marker(this, &quot;GetStringLength&quot;, str, line, file_name);</span>
    return _jni_env-&gt;GetStringLength(str);
  }
  
<span class="line-modified">! void* ExceptionCheckingJniEnv::GetPrimitiveArrayCritical(jarray array, jboolean* is_copy,</span>
<span class="line-modified">!                                                          int line, const char* file_name) {</span>
<span class="line-modified">!   JNIVerifier&lt;&gt; marker(this, &quot;GetPrimitiveArrayCritical&quot;, array, is_copy, line, file_name);</span>
<span class="line-added">+   return marker.ResultNotNull(_jni_env-&gt;GetPrimitiveArrayCritical(array, is_copy));</span>
  }
  
<span class="line-modified">! void ExceptionCheckingJniEnv::ReleasePrimitiveArrayCritical(jarray array, void* carray, jint mode,</span>
<span class="line-modified">!                                                             int line, const char* file_name) {</span>
<span class="line-added">+   JNIVerifier&lt;&gt; marker(this, &quot;ReleasePrimitiveArrayCritical&quot;, array, carray, mode,</span>
<span class="line-added">+                        line, file_name);</span>
    _jni_env-&gt;ReleasePrimitiveArrayCritical(array, carray, mode);
  }
  
<span class="line-modified">! const jchar* ExceptionCheckingJniEnv::GetStringCritical(jstring str, jboolean* is_copy,</span>
<span class="line-modified">!                                                         int line, const char* file_name) {</span>
<span class="line-modified">!   JNIVerifier&lt;const jchar*&gt; marker(this, &quot;GetPrimitiveArrayCritical&quot;, str, is_copy,</span>
<span class="line-added">+                                    line, file_name);</span>
<span class="line-added">+   return marker.ResultNotNull(_jni_env-&gt;GetStringCritical(str, is_copy));</span>
  }
  
<span class="line-modified">! void ExceptionCheckingJniEnv::ReleaseStringCritical(jstring str, const jchar* carray,</span>
<span class="line-modified">!                                                     int line, const char* file_name) {</span>
<span class="line-added">+   JNIVerifier&lt;&gt; marker(this, &quot;ReleaseStringCritical&quot;, str, carray, line, file_name);</span>
    _jni_env-&gt;ReleaseStringCritical(str, carray);
  }
<span class="line-added">+ </span>
<span class="line-added">+ jbyte* ExceptionCheckingJniEnv::GetByteArrayElements(jbyteArray array, jboolean* is_copy,</span>
<span class="line-added">+                                                    int line, const char* file_name) {</span>
<span class="line-added">+   JNIVerifier&lt;jbyte*&gt; marker(this, &quot;GetByteArrayElements&quot;, array, is_copy, line, file_name);</span>
<span class="line-added">+   return marker.ResultNotNull(_jni_env-&gt;GetByteArrayElements(array, is_copy));</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ void ExceptionCheckingJniEnv::ReleaseByteArrayElements(jbyteArray array, jbyte* byte_array, jint mode,</span>
<span class="line-added">+                                                        int line, const char* file_name) {</span>
<span class="line-added">+   JNIVerifier&lt;&gt; marker(this, &quot;ReleaseByteArrayElements&quot;, array, byte_array, mode,</span>
<span class="line-added">+                        line, file_name);</span>
<span class="line-added">+   _jni_env-&gt;ReleaseByteArrayElements(array, byte_array, mode);</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ jmethodID ExceptionCheckingJniEnv::GetMethodID(jclass klass, const char* name, const char* sig,</span>
<span class="line-added">+                                                int line, const char* file_name) {</span>
<span class="line-added">+   JNIVerifier&lt;jmethodID&gt; marker(this, &quot;GetMethodID&quot;, klass, name, sig, line, file_name);</span>
<span class="line-added">+   return marker.ResultNotNull(_jni_env-&gt;GetMethodID(klass, name, sig));</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ jmethodID ExceptionCheckingJniEnv::GetStaticMethodID(jclass klass, const char* name, const char* sig,</span>
<span class="line-added">+                                                      int line, const char* file_name) {</span>
<span class="line-added">+   JNIVerifier&lt;jmethodID&gt; marker(this, &quot;GetStaticMethodID&quot;, klass, name, sig, line, file_name);</span>
<span class="line-added">+   return marker.ResultNotNull(_jni_env-&gt;GetStaticMethodID(klass, name, sig));</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ jboolean ExceptionCheckingJniEnv::IsSameObject(jobject ref1, jobject ref2, int line, const char* file_name) {</span>
<span class="line-added">+   JNIVerifier&lt;&gt; marker(this, &quot;IsSameObject&quot;, ref1, ref2, line, file_name);</span>
<span class="line-added">+   return _jni_env-&gt;IsSameObject(ref1, ref2);</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ jobject ExceptionCheckingJniEnv::NewObject(jclass klass, jmethodID methodID,</span>
<span class="line-added">+                                            int line, const char* file_name, ...) {</span>
<span class="line-added">+   // In the case of NewObject, we miss the extra arguments passed to NewObject sadly.</span>
<span class="line-added">+   JNIVerifier&lt;jobject&gt; marker(this, &quot;NewObject&quot;, klass, methodID, line, file_name);</span>
<span class="line-added">+ </span>
<span class="line-added">+   va_list args;</span>
<span class="line-added">+   va_start(args, file_name);</span>
<span class="line-added">+   jobject result = marker.ResultNotNull(_jni_env-&gt;NewObjectV(klass, methodID, args));</span>
<span class="line-added">+   va_end(args);</span>
<span class="line-added">+   return result;</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ jobject ExceptionCheckingJniEnv::CallObjectMethod(jobject obj, jmethodID methodID, int line,</span>
<span class="line-added">+                          const char* file_name, ...) {</span>
<span class="line-added">+   JNIVerifier&lt;&gt; marker(this, &quot;CallObjectMethod&quot;, obj, methodID, line, file_name);</span>
<span class="line-added">+ </span>
<span class="line-added">+   va_list args;</span>
<span class="line-added">+   va_start(args, file_name);</span>
<span class="line-added">+   jobject result = _jni_env-&gt;CallObjectMethodV(obj, methodID, args);</span>
<span class="line-added">+   va_end(args);</span>
<span class="line-added">+   return result;</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ void ExceptionCheckingJniEnv::CallVoidMethod(jobject obj, jmethodID methodID, int line,</span>
<span class="line-added">+                     const char* file_name, ...) {</span>
<span class="line-added">+   JNIVerifier&lt;&gt; marker(this, &quot;CallVoidMethod&quot;, obj, methodID, line, file_name);</span>
<span class="line-added">+ </span>
<span class="line-added">+   va_list args;</span>
<span class="line-added">+   va_start(args, file_name);</span>
<span class="line-added">+   _jni_env-&gt;CallVoidMethodV(obj, methodID, args);</span>
<span class="line-added">+   va_end(args);</span>
<span class="line-added">+ }</span>
</pre>
<center><a href="../jdi/MonitorEventsDebuggee.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="ExceptionCheckingJniEnv.hpp.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>