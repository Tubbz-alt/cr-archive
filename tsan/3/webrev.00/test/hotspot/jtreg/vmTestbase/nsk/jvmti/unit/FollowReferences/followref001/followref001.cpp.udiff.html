<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/hotspot/jtreg/vmTestbase/nsk/jvmti/unit/FollowReferences/followref001/followref001.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../scenarios/sampling/SP06/sp06t003/sp06t003.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="../followref003/followref003.cpp.udiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/jtreg/vmTestbase/nsk/jvmti/unit/FollowReferences/followref001/followref001.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2007, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2007, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -99,12 +99,11 @@</span>
  
  
  /* ============================================================================= */
  
  static int get_reference_index(jvmtiHeapReferenceKind   reference_kind,
<span class="udiff-line-modified-removed">-                                const jvmtiHeapReferenceInfo* reference_info)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-modified-added">+                                const jvmtiHeapReferenceInfo* reference_info) {</span>
      int referrer_index = 0;
  
      switch (reference_kind) {
          case JVMTI_HEAP_REFERENCE_CONSTANT_POOL:
              referrer_index = reference_info-&gt;constant_pool.index;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -130,24 +129,23 @@</span>
      return referrer_index;
  } /* get_reference_index */
  
  
  /** Initialize objectDescList. */
<span class="udiff-line-modified-removed">- static int initObjectDescList(jvmtiEnv*    jvmti,</span>
<span class="udiff-line-modified-removed">-                               int          chainLength,</span>
<span class="udiff-line-modified-removed">-                               int*         objectsCount,</span>
<span class="udiff-line-modified-removed">-                               ObjectDesc** objectDescList)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-modified-added">+ static bool initObjectDescList(jvmtiEnv*    jvmti,</span>
<span class="udiff-line-modified-added">+                                int          chainLength,</span>
<span class="udiff-line-modified-added">+                                int*         objectsCount,</span>
<span class="udiff-line-modified-added">+                                ObjectDesc** objectDescList) {</span>
      /* root object + reachable and unreachable object chains */
      *objectsCount = 1 + 2 * chainLength;
  
      printf(&quot;Allocate memory for objects list: %d objects\n&quot;, *objectsCount);
      fflush(0);
      if (!NSK_JVMTI_VERIFY(jvmti-&gt;Allocate((*objectsCount * sizeof(ObjectDesc)),
                                            (unsigned char**) objectDescList))) {
          nsk_jvmti_setFailStatus();
<span class="udiff-line-modified-removed">-         return NSK_FALSE;</span>
<span class="udiff-line-modified-added">+         return false;</span>
      }
      printf(&quot;  ... allocated array: 0x%p\n&quot;, (void*)objectDescList);
      fflush(0);
  
      {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -164,34 +162,33 @@</span>
  
      /* Object with tag=100 must be referenced 2 times */
      (*objectDescList)[chainLength].exp_found = 1;
  
  
<span class="udiff-line-modified-removed">-      return NSK_TRUE;</span>
<span class="udiff-line-modified-added">+      return true;</span>
  } /* initObjectDescList */
  
  
  /** Find and tag classes. */
<span class="udiff-line-modified-removed">- static int getAndTagClasses(jvmtiEnv*    jvmti,</span>
<span class="udiff-line-modified-removed">-                             JNIEnv*      jni,</span>
<span class="udiff-line-modified-removed">-                             jclass*      debugeeClass,</span>
<span class="udiff-line-modified-removed">-                             jclass*      rootObjectClass,</span>
<span class="udiff-line-modified-removed">-                             jclass*      chainObjectClass)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-modified-added">+ static bool getAndTagClasses(jvmtiEnv*    jvmti,</span>
<span class="udiff-line-modified-added">+                              JNIEnv*      jni,</span>
<span class="udiff-line-modified-added">+                              jclass*      debugeeClass,</span>
<span class="udiff-line-modified-added">+                              jclass*      rootObjectClass,</span>
<span class="udiff-line-modified-added">+                              jclass*      chainObjectClass) {</span>
  
      if (!NSK_JNI_VERIFY(jni, (*debugeeClass = jni-&gt;FindClass(DEBUGEE_CLASS_NAME)) != NULL)) {
          nsk_jvmti_setFailStatus();
<span class="udiff-line-modified-removed">-         return NSK_FALSE;</span>
<span class="udiff-line-modified-added">+         return false;</span>
      }
      printf(&quot;\nFound debugee class: 0x%p\n  %s\n&quot;,
             (void*) *debugeeClass, DEBUGEE_CLASS_NAME);
      fflush(0);
  
      if (!NSK_JNI_VERIFY(jni, (*rootObjectClass =
              jni-&gt;FindClass(ROOT_OBJECT_CLASS_NAME)) != NULL)) {
          nsk_jvmti_setFailStatus();
<span class="udiff-line-modified-removed">-         return NSK_FALSE;</span>
<span class="udiff-line-modified-added">+         return false;</span>
      }
  
      if (!NSK_JVMTI_VERIFY(jvmti-&gt;SetTag(*rootObjectClass, ROOT_CLASS_TAG))) {
          nsk_jvmti_setFailStatus();
      }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -203,119 +200,117 @@</span>
  
  
      if (!NSK_JNI_VERIFY(jni, (*chainObjectClass =
              jni-&gt;FindClass(CHAIN_OBJECT_CLASS_NAME)) != NULL)) {
          nsk_jvmti_setFailStatus();
<span class="udiff-line-modified-removed">-         return NSK_FALSE;</span>
<span class="udiff-line-modified-added">+         return false;</span>
      }
  
      if (!NSK_JVMTI_VERIFY(jvmti-&gt;SetTag(*chainObjectClass, CHAIN_CLASS_TAG))) {
          nsk_jvmti_setFailStatus();
      }
      printf(&quot;\nFound chain object class: 0x%p, tag=%ld\n  %s\n&quot;,
             (void*) *chainObjectClass, (long) CHAIN_CLASS_TAG,
             CHAIN_OBJECT_CLASS_NAME);
      fflush(0);
  
<span class="udiff-line-modified-removed">-      return NSK_TRUE;</span>
<span class="udiff-line-modified-added">+      return true;</span>
  } /* getAndTagClasses */
  
  
  /** Obtain chain of tested objects and tag them recursively. */
<span class="udiff-line-modified-removed">- static int getFieldsAndObjects(jvmtiEnv*  jvmti,</span>
<span class="udiff-line-modified-removed">-                              JNIEnv*     jni,</span>
<span class="udiff-line-modified-removed">-                              jclass      debugeeClass,</span>
<span class="udiff-line-modified-removed">-                              jclass      rootObjectClass,</span>
<span class="udiff-line-modified-removed">-                              jclass      chainObjectClass,</span>
<span class="udiff-line-modified-removed">-                              jobject*    rootObjectPtr,</span>
<span class="udiff-line-modified-removed">-                              jfieldID*   reachableChainField,</span>
<span class="udiff-line-modified-removed">-                              jfieldID*   unreachableChainField,</span>
<span class="udiff-line-modified-removed">-                              jfieldID*   nextField)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-modified-added">+ static bool getFieldsAndObjects(jvmtiEnv*  jvmti,</span>
<span class="udiff-line-modified-added">+                                 JNIEnv*    jni,</span>
<span class="udiff-line-modified-added">+                                 jclass     debugeeClass,</span>
<span class="udiff-line-modified-added">+                                 jclass     rootObjectClass,</span>
<span class="udiff-line-modified-added">+                                 jclass     chainObjectClass,</span>
<span class="udiff-line-modified-added">+                                 jobject*   rootObjectPtr,</span>
<span class="udiff-line-modified-added">+                                 jfieldID*  reachableChainField,</span>
<span class="udiff-line-modified-added">+                                 jfieldID*  unreachableChainField,</span>
<span class="udiff-line-modified-added">+                                 jfieldID*  nextField) {</span>
      jfieldID rootObjectField = NULL;
  
      if (!NSK_JNI_VERIFY(jni, (rootObjectField =
              jni-&gt;GetStaticFieldID(debugeeClass, OBJECT_FIELD_NAME, ROOT_OBJECT_CLASS_SIG)) != NULL)) {
          nsk_jvmti_setFailStatus();
<span class="udiff-line-modified-removed">-         return NSK_FALSE;</span>
<span class="udiff-line-modified-added">+         return false;</span>
      }
      printf(&quot;\nFound fieldID: 0x%p - \&#39;%s\&#39; static field in debugee class\n&quot;,
             (void*) rootObjectField, OBJECT_FIELD_NAME);
      fflush(0);
  
      if (!NSK_JNI_VERIFY(jni, (*reachableChainField =
              jni-&gt;GetFieldID(rootObjectClass, REACHABLE_CHAIN_FIELD_NAME, CHAIN_OBJECT_CLASS_SIG)) != NULL)) {
          nsk_jvmti_setFailStatus();
<span class="udiff-line-modified-removed">-         return NSK_FALSE;</span>
<span class="udiff-line-modified-added">+         return false;</span>
      }
      printf(&quot;\nFound fieldID: 0x%p - \&#39;%s\&#39; field in root object class\n&quot;,
             (void*) reachableChainField, REACHABLE_CHAIN_FIELD_NAME);
      fflush(0);
  
      if (!NSK_JNI_VERIFY(jni, (*unreachableChainField =
              jni-&gt;GetFieldID(rootObjectClass, UNREACHABLE_CHAIN_FIELD_NAME, CHAIN_OBJECT_CLASS_SIG)) != NULL)) {
          nsk_jvmti_setFailStatus();
<span class="udiff-line-modified-removed">-         return NSK_FALSE;</span>
<span class="udiff-line-modified-added">+         return false;</span>
      }
  
      printf(&quot;\nFound fieldID: 0x%p - \&#39;%s\&#39; field in root object class\n&quot;,
             (void*) unreachableChainField, UNREACHABLE_CHAIN_FIELD_NAME);
      fflush(0);
  
      if (!NSK_JNI_VERIFY(jni, (*nextField =
              jni-&gt;GetFieldID(chainObjectClass, NEXT_FIELD_NAME, CHAIN_OBJECT_CLASS_SIG)) != NULL)) {
          nsk_jvmti_setFailStatus();
<span class="udiff-line-modified-removed">-         return NSK_FALSE;</span>
<span class="udiff-line-modified-added">+         return false;</span>
      }
      printf(&quot;\nFound fieldID: 0x%p - \&#39;%s\&#39; field in chain object class\n&quot;,
             (void*) nextField, NEXT_FIELD_NAME);
      fflush(0);
  
      if (!NSK_JNI_VERIFY(jni, (*rootObjectPtr =
              jni-&gt;GetStaticObjectField(debugeeClass, rootObjectField)) != NULL)) {
          nsk_jvmti_setFailStatus();
<span class="udiff-line-modified-removed">-         return NSK_FALSE;</span>
<span class="udiff-line-modified-added">+         return false;</span>
      }
      printf(&quot;\nFound root object: 0x%p\n&quot;, (void*) *rootObjectPtr);
      fflush(0);
  
      if (!NSK_JNI_VERIFY(jni, (*rootObjectPtr = jni-&gt;NewGlobalRef(*rootObjectPtr)) != NULL)) {
          nsk_jvmti_setFailStatus();
<span class="udiff-line-modified-removed">-         return NSK_FALSE;</span>
<span class="udiff-line-modified-added">+         return false;</span>
      }
      printf(&quot;Created root object global ref: 0x%p\n&quot;, (void*)*rootObjectPtr);
      fflush(0);
  
<span class="udiff-line-modified-removed">-      return NSK_TRUE;</span>
<span class="udiff-line-modified-added">+      return true;</span>
  } /* getFieldsAndObjects */
  
  
  /** Obtain chain of tested objects and tag them recursively. */
<span class="udiff-line-modified-removed">- static int getAndTagChainObjects(</span>
<span class="udiff-line-modified-added">+ static bool getAndTagChainObjects(</span>
      jvmtiEnv*  jvmti,
      JNIEnv*    jni,
      jobject    currObj,
      jfieldID   refField,
      jfieldID   nextField,
      int        count,
      ObjectDesc objectDescList[],
      jlong      tag,
<span class="udiff-line-modified-removed">-     int        reachable)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-modified-added">+     bool       reachable) {</span>
      jobject nextObj = NULL;
      jlong objTag = (reachable ? tag : -tag);
  
      if (count &lt;= 0) {
<span class="udiff-line-modified-removed">-         return NSK_TRUE;</span>
<span class="udiff-line-modified-added">+         return true;</span>
      }
  
      count--;
      tag++;
  
      if (!NSK_JNI_VERIFY(jni, (nextObj = jni-&gt;GetObjectField(currObj, refField)) != NULL)) {
          nsk_jvmti_setFailStatus();
<span class="udiff-line-modified-removed">-         return NSK_FALSE;</span>
<span class="udiff-line-modified-added">+         return false;</span>
      }
  
      objectDescList[count].tag = objTag;
      if (reachable) {
          objectDescList[count].exp_found++;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -336,16 +331,16 @@</span>
                                 count,
                                 objectDescList,
                                 tag,
                                 reachable)
      ) {
<span class="udiff-line-modified-removed">-         return NSK_FALSE;</span>
<span class="udiff-line-modified-added">+         return false;</span>
      }
  
      NSK_TRACE(jni-&gt;DeleteLocalRef(nextObj));
  
<span class="udiff-line-modified-removed">-     return NSK_TRUE;</span>
<span class="udiff-line-modified-added">+     return true;</span>
  } /* getAndTagChainObjects */
  
  /** Obtain all tested objects from debugee class and tag them recursively. */
  static int getAndTagTestedObjects(
      jvmtiEnv*    jvmti,
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -361,35 +356,35 @@</span>
  
      jfieldID reachableChainField   = NULL;
      jfieldID unreachableChainField = NULL;
      jfieldID nextField             = NULL;
  
<span class="udiff-line-modified-removed">-     if (initObjectDescList(jvmti,</span>
<span class="udiff-line-modified-removed">-                            chainLength,</span>
<span class="udiff-line-modified-removed">-                            objectsCount,</span>
<span class="udiff-line-modified-removed">-                            objectDescList) == NSK_FALSE) {</span>
<span class="udiff-line-modified-removed">-         return NSK_FALSE;</span>
<span class="udiff-line-modified-added">+     if (!initObjectDescList(jvmti,</span>
<span class="udiff-line-modified-added">+                             chainLength,</span>
<span class="udiff-line-modified-added">+                             objectsCount,</span>
<span class="udiff-line-modified-added">+                             objectDescList)) {</span>
<span class="udiff-line-modified-added">+         return false;</span>
      }
  
<span class="udiff-line-modified-removed">-     if (getAndTagClasses(jvmti,</span>
<span class="udiff-line-modified-removed">-                          jni,</span>
<span class="udiff-line-modified-removed">-                          &amp;debugeeClass,</span>
<span class="udiff-line-modified-removed">-                          &amp;rootObjectClass,</span>
<span class="udiff-line-modified-removed">-                          &amp;chainObjectClass) == NSK_FALSE) {</span>
<span class="udiff-line-modified-removed">-         return NSK_FALSE;</span>
<span class="udiff-line-modified-added">+     if (!getAndTagClasses(jvmti,</span>
<span class="udiff-line-modified-added">+                           jni,</span>
<span class="udiff-line-modified-added">+                           &amp;debugeeClass,</span>
<span class="udiff-line-modified-added">+                           &amp;rootObjectClass,</span>
<span class="udiff-line-modified-added">+                           &amp;chainObjectClass)) {</span>
<span class="udiff-line-modified-added">+         return false;</span>
      }
  
<span class="udiff-line-modified-removed">-     if (getFieldsAndObjects(jvmti,</span>
<span class="udiff-line-modified-removed">-                             jni,</span>
<span class="udiff-line-modified-removed">-                             debugeeClass,</span>
<span class="udiff-line-modified-removed">-                             rootObjectClass,</span>
<span class="udiff-line-modified-removed">-                             chainObjectClass,</span>
<span class="udiff-line-modified-removed">-                             rootObjectPtr,</span>
<span class="udiff-line-modified-removed">-                             &amp;reachableChainField,</span>
<span class="udiff-line-modified-removed">-                             &amp;unreachableChainField,</span>
<span class="udiff-line-modified-removed">-                             &amp;nextField) == NSK_FALSE) {</span>
<span class="udiff-line-modified-removed">-         return NSK_FALSE;</span>
<span class="udiff-line-modified-added">+     if (!getFieldsAndObjects(jvmti,</span>
<span class="udiff-line-modified-added">+                              jni,</span>
<span class="udiff-line-modified-added">+                              debugeeClass,</span>
<span class="udiff-line-modified-added">+                              rootObjectClass,</span>
<span class="udiff-line-modified-added">+                              chainObjectClass,</span>
<span class="udiff-line-modified-added">+                              rootObjectPtr,</span>
<span class="udiff-line-modified-added">+                              &amp;reachableChainField,</span>
<span class="udiff-line-modified-added">+                              &amp;unreachableChainField,</span>
<span class="udiff-line-modified-added">+                              &amp;nextField)) {</span>
<span class="udiff-line-modified-added">+         return false;</span>
      }
  
      printf(&quot;\nObtain and tag chain objects:\n&quot;);
      printf(&quot;    root tested object:\n&quot;);
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -409,14 +404,14 @@</span>
                                 reachableChainField,
                                 nextField,
                                 chainLength,
                                 (*objectDescList) + 1,
                                 CHAIN_OBJECT_TAG,
<span class="udiff-line-modified-removed">-                                NSK_TRUE)  /* reachable objects */</span>
<span class="udiff-line-modified-added">+                                true)  /* reachable objects */</span>
      ) {
          nsk_jvmti_setFailStatus();
<span class="udiff-line-modified-removed">-         return NSK_FALSE;</span>
<span class="udiff-line-modified-added">+         return false;</span>
      }
  
      printf(&quot;    unreachable objects chain: %d objects\n&quot;, chainLength);
      if (!getAndTagChainObjects(jvmti,
                                 jni,
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -424,26 +419,26 @@</span>
                                 unreachableChainField,
                                 nextField,
                                 chainLength,
                                 (*objectDescList) + 1 + chainLength,
                                 CHAIN_OBJECT_TAG,
<span class="udiff-line-modified-removed">-                                NSK_FALSE) /* unreachable objects */</span>
<span class="udiff-line-modified-added">+                                false) /* unreachable objects */</span>
      ) {
          nsk_jvmti_setFailStatus();
<span class="udiff-line-modified-removed">-         return NSK_FALSE;</span>
<span class="udiff-line-modified-added">+         return false;</span>
      }
  
<span class="udiff-line-modified-removed">-     return NSK_TRUE;</span>
<span class="udiff-line-modified-added">+     return true;</span>
  } /* getAndTagTestedObjects */
  
  /** Check if tagged objects were iterated. */
<span class="udiff-line-modified-removed">- static int checkTestedObjects(jvmtiEnv*  jvmti,</span>
<span class="udiff-line-modified-removed">-                               JNIEnv*    jni,</span>
<span class="udiff-line-modified-removed">-                               int        chainLength,</span>
<span class="udiff-line-modified-removed">-                               ObjectDesc objectDescList[])</span>
<span class="udiff-line-modified-added">+ static bool checkTestedObjects(jvmtiEnv*  jvmti,</span>
<span class="udiff-line-modified-added">+                                JNIEnv*    jni,</span>
<span class="udiff-line-modified-added">+                                int        chainLength,</span>
<span class="udiff-line-modified-added">+                                ObjectDesc objectDescList[])</span>
  {
<span class="udiff-line-modified-removed">-     int success = NSK_TRUE;</span>
<span class="udiff-line-modified-added">+     bool success = true;</span>
      int i, idx;
  
      printf(&quot;Following tagged objects were iterated:\n&quot;);
  
      printf(&quot;Root tested object:\n&quot;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -496,20 +491,20 @@</span>
              nsk_jvmti_setFailStatus();
          }
          fflush(0);
      }
  
<span class="udiff-line-modified-removed">-     return NSK_TRUE;</span>
<span class="udiff-line-modified-added">+     return true;</span>
  } /* checkTestedObjects */
  
  
  /** Release references to the tested objects and free allocated memory. */
<span class="udiff-line-modified-removed">- static int releaseTestedObjects(jvmtiEnv*   jvmti,</span>
<span class="udiff-line-modified-removed">-                                 JNIEnv*     jni,</span>
<span class="udiff-line-modified-removed">-                                 int         chainLength,</span>
<span class="udiff-line-modified-removed">-                                 ObjectDesc* objectDescList,</span>
<span class="udiff-line-modified-removed">-                                 jobject     rootObject)</span>
<span class="udiff-line-modified-added">+ static void releaseTestedObjects(jvmtiEnv*   jvmti,</span>
<span class="udiff-line-modified-added">+                                  JNIEnv*     jni,</span>
<span class="udiff-line-modified-added">+                                  int         chainLength,</span>
<span class="udiff-line-modified-added">+                                  ObjectDesc* objectDescList,</span>
<span class="udiff-line-modified-added">+                                  jobject     rootObject)</span>
  {
      if (rootObject != NULL) {
          printf(&quot;Release object reference to root tested object: 0x%p\n&quot;, rootObject);
          NSK_TRACE(jni-&gt;DeleteGlobalRef(rootObject));
      }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -520,11 +515,10 @@</span>
              nsk_jvmti_setFailStatus();
          }
      }
  
      fflush(0);
<span class="udiff-line-removed">-     return NSK_TRUE;</span>
  } /* releaseTestedObjects */
  
  
  /* ============================================================================= */
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -782,14 +776,11 @@</span>
      }
  
      printf(&quot;&gt;&gt;&gt; Clean used data\n&quot;);
      fflush(0);
  
<span class="udiff-line-modified-removed">-     if (!NSK_VERIFY(releaseTestedObjects(jvmti, jni, chainLength,</span>
<span class="udiff-line-removed">-                                          objectDescList, rootObject))) {</span>
<span class="udiff-line-removed">-         return;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-modified-added">+     releaseTestedObjects(jvmti, jni, chainLength, objectDescList, rootObject);</span>
  
      printf(&quot;&gt;&gt;&gt; Let debugee to finish\n&quot;);
      fflush(0);
      if (!NSK_VERIFY(nsk_jvmti_resumeSync())) {
          return;
</pre>
<center><a href="../../../scenarios/sampling/SP06/sp06t003/sp06t003.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="../followref003/followref003.cpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>