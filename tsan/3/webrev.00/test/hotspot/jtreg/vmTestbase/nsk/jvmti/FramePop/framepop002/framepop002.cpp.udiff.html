<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/hotspot/jtreg/vmTestbase/nsk/jvmti/FramePop/framepop002/framepop002.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../Breakpoint/breakpoint001/breakpoint001.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../../GetThreadState/thrstat001/thrstat001.cpp.udiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/jtreg/vmTestbase/nsk/jvmti/FramePop/framepop002/framepop002.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2003, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2003, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -60,10 +60,13 @@</span>
  static int push_count = 0;
  static int thr_count = 0;
  static int max_depth = 0;
  static thr threads[MAX_THREADS];
  
<span class="udiff-line-added">+ static volatile int callbacksEnabled = NSK_FALSE;</span>
<span class="udiff-line-added">+ static jrawMonitorID agent_lock;</span>
<span class="udiff-line-added">+ </span>
  static
  int isTestThread(jvmtiEnv *jvmti_env, jthread thr) {
      jvmtiError err;
      jvmtiThreadInfo inf;
      const char* TEST_THREAD_NAME_BASE = &quot;Test Thread&quot;;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -209,16 +212,24 @@</span>
      jboolean isNative;
      jint frameCount;
  
      if (watch_events == JNI_FALSE) return;
  
<span class="udiff-line-added">+     jvmti-&gt;RawMonitorEnter(agent_lock);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (!callbacksEnabled) {</span>
<span class="udiff-line-added">+         jvmti-&gt;RawMonitorExit(agent_lock);</span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      err = jvmti_env-&gt;GetFrameCount(thr, &amp;frameCount);
      if (err != JVMTI_ERROR_NONE) {
          printf(&quot;(GetFrameCount#entry) unexpected error: %s (%d)\n&quot;,
                 TranslateError(err), err);
          printInfo(jvmti_env, thr, method, frameCount);
          result = STATUS_FAILED;
<span class="udiff-line-added">+         jvmti-&gt;RawMonitorExit(agent_lock);</span>
          return;
      }
  
      err = jvmti_env-&gt;IsMethodNative(method, &amp;isNative);
      if (err != JVMTI_ERROR_NONE) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -257,23 +268,49 @@</span>
                  printInfo(jvmti_env, thr, method, frameCount);
                  result = STATUS_FAILED;
              }
          }
      }
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     jvmti-&gt;RawMonitorExit(agent_lock);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void JNICALL VMStart(jvmtiEnv *jvmti_env, JNIEnv* jni_env) {</span>
<span class="udiff-line-added">+     jvmti-&gt;RawMonitorEnter(agent_lock);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     callbacksEnabled = NSK_TRUE;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     jvmti-&gt;RawMonitorExit(agent_lock);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void JNICALL VMDeath(jvmtiEnv *jvmti_env, JNIEnv* jni_env) {</span>
<span class="udiff-line-added">+     jvmti-&gt;RawMonitorEnter(agent_lock);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     callbacksEnabled = NSK_FALSE;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     jvmti-&gt;RawMonitorExit(agent_lock);</span>
  }
  
  void JNICALL FramePop(jvmtiEnv *jvmti_env, JNIEnv *env,
          jthread thr, jmethodID method, jboolean wasPopedByException) {
      jvmtiError err;
      jint frameCount;
  
<span class="udiff-line-added">+     jvmti-&gt;RawMonitorEnter(agent_lock);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (!callbacksEnabled) {</span>
<span class="udiff-line-added">+         jvmti-&gt;RawMonitorExit(agent_lock);</span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+     }</span>
      err = jvmti_env-&gt;GetFrameCount(thr, &amp;frameCount);
      if (err != JVMTI_ERROR_NONE) {
          printf(&quot;(GetFrameCount#entry) unexpected error: %s (%d)\n&quot;,
                 TranslateError(err), err);
          printInfo(jvmti_env, thr, method, frameCount);
          result = STATUS_FAILED;
<span class="udiff-line-added">+         jvmti-&gt;RawMonitorExit(agent_lock);</span>
          return;
      }
  
      if (isTestThread(jvmti_env, thr)) {
          if (printdump == JNI_TRUE) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -294,10 +331,12 @@</span>
                     TranslateError(err), err);
              printInfo(jvmti_env, thr, method, frameCount);
              result = STATUS_FAILED;
          }
      }
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     jvmti-&gt;RawMonitorExit(agent_lock);</span>
  }
  
  #ifdef STATIC_BUILD
  JNIEXPORT jint JNICALL Agent_OnLoad_framepop002(JavaVM *jvm, char *options, void *reserved) {
      return Agent_Initialize(jvm, options, reserved);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -353,16 +392,28 @@</span>
  
      if (caps.can_generate_frame_pop_events &amp;&amp;
              caps.can_generate_method_entry_events) {
          callbacks.MethodEntry = &amp;MethodEntry;
          callbacks.FramePop = &amp;FramePop;
<span class="udiff-line-added">+         callbacks.VMStart = &amp;VMStart;</span>
<span class="udiff-line-added">+         callbacks.VMDeath = &amp;VMDeath;</span>
<span class="udiff-line-added">+ </span>
          err = jvmti-&gt;SetEventCallbacks(&amp;callbacks, sizeof(callbacks));
          if (err != JVMTI_ERROR_NONE) {
              printf(&quot;(SetEventCallbacks) unexpected error: %s (%d)\n&quot;,
                     TranslateError(err), err);
              return JNI_ERR;
          }
<span class="udiff-line-added">+         if (!NSK_JVMTI_VERIFY(jvmti-&gt;SetEventNotificationMode(JVMTI_ENABLE, JVMTI_EVENT_VM_START, NULL)))</span>
<span class="udiff-line-added">+             return JNI_ERR;</span>
<span class="udiff-line-added">+         if (!NSK_JVMTI_VERIFY(jvmti-&gt;SetEventNotificationMode(JVMTI_ENABLE, JVMTI_EVENT_VM_DEATH, NULL)))</span>
<span class="udiff-line-added">+             return JNI_ERR;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         if (jvmti-&gt;CreateRawMonitor(&quot;agent_lock&quot;, &amp;agent_lock) != JVMTI_ERROR_NONE) {</span>
<span class="udiff-line-added">+             return JNI_ERR;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
      } else {
          printf(&quot;Warning: FramePop or MethodEntry event is not implemented\n&quot;);
      }
  
      return JNI_OK;
</pre>
<center><a href="../../Breakpoint/breakpoint001/breakpoint001.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../../GetThreadState/thrstat001/thrstat001.cpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>