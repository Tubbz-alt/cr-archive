<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/hotspot/jtreg/vmTestbase/nsk/jvmti/GetTimerInfo/timerinfo001/timerinfo001.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 2003, 2018, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 #include &lt;stdlib.h&gt;
 25 #include &lt;string.h&gt;
 26 #include &quot;jvmti.h&quot;
 27 #include &quot;agent_common.h&quot;
 28 #include &quot;jni_tools.h&quot;
 29 #include &quot;jvmti_tools.h&quot;
 30 
 31 extern &quot;C&quot; {
 32 
 33 /* ============================================================================= */
 34 
 35 static jlong timeout = 0;
 36 
 37 #define STATUS_FAIL     97
 38 
 39 #define EVENTS_COUNT    2
 40 
 41 static jvmtiEvent events[EVENTS_COUNT] = {
 42     JVMTI_EVENT_VM_INIT,
 43     JVMTI_EVENT_VM_DEATH
 44 };
 45 
 46 static jvmtiTimerInfo initInfo;
 47 
 48 /* ============================================================================= */
 49 
 50 /**
 51  * Get timer info and optionally compares it with initial one.
<a name="1" id="anc1"></a><span class="line-modified"> 52  * @returns false if any error occured.</span>
 53  */
<a name="2" id="anc2"></a><span class="line-modified"> 54 static bool checkTimerInfo(jvmtiEnv* jvmti, jvmtiTimerInfo* info,</span>
<span class="line-modified"> 55                            jvmtiTimerInfo* initInfo, const char where[]) {</span>
 56 
 57     char buf[32], buf2[32];
<a name="3" id="anc3"></a><span class="line-modified"> 58     bool success = true;</span>
 59 
 60     NSK_DISPLAY0(&quot;GetTimerInfo() for current JVMTI env\n&quot;);
 61     if (!NSK_JVMTI_VERIFY(
 62             jvmti-&gt;GetTimerInfo(info))) {
<a name="4" id="anc4"></a><span class="line-modified"> 63         return false;</span>
 64     }
 65     NSK_DISPLAY0(&quot;Got timer info:\n&quot;);
 66 
 67     NSK_DISPLAY1(&quot;    max_value:         %s\n&quot;,
 68                  julong_to_string((julong)info-&gt;max_value, buf));
 69     NSK_DISPLAY1(&quot;    may_skip_forward:  %d\n&quot;, (int)info-&gt;may_skip_forward);
 70     NSK_DISPLAY1(&quot;    may_skip_backward: %d\n&quot;, (int)info-&gt;may_skip_backward);
 71 
 72     if (initInfo != NULL) {
 73         NSK_DISPLAY0(&quot;Compare with initial timer info\n&quot;);
 74         if (info-&gt;max_value != initInfo-&gt;max_value) {
 75             NSK_COMPLAIN4(&quot;In %s GetTimerInfo() returned different info:\n&quot;
 76                           &quot;#   field:     %s\n&quot;
 77                           &quot;#   got value: %s\n&quot;
 78                           &quot;#   initial:   %s\n&quot;,
 79                           where, &quot;max_value&quot;,
 80                           julong_to_string((julong)info-&gt;max_value, buf),
 81                           julong_to_string((julong)initInfo-&gt;max_value, buf2));
<a name="5" id="anc5"></a><span class="line-modified"> 82             success = false;</span>
 83         }
 84         if (info-&gt;may_skip_forward != initInfo-&gt;may_skip_forward) {
 85             NSK_COMPLAIN4(&quot;In %s GetTimerInfo() returned different info:\n&quot;
 86                           &quot;#   field:     %s\n&quot;
 87                           &quot;#   got value: %d\n&quot;
 88                           &quot;#   initial:   %d\n&quot;,
 89                             where, &quot;may_skip_forward&quot;,
 90                             (int)info-&gt;may_skip_forward,
 91                             (int)initInfo-&gt;may_skip_forward);
<a name="6" id="anc6"></a><span class="line-modified"> 92             success = false;</span>
 93         }
 94         if (info-&gt;may_skip_backward != initInfo-&gt;may_skip_backward) {
 95             NSK_COMPLAIN4(&quot;In %s GetTimerInfo() returned different info:\n&quot;
 96                           &quot;#   field:     %s\n&quot;
 97                           &quot;#   got value: %d\n&quot;
 98                           &quot;#   initial:   %d\n&quot;,
 99                             where, &quot;may_skip_backward&quot;,
100                             (int)info-&gt;may_skip_backward,
101                             (int)initInfo-&gt;may_skip_backward);
<a name="7" id="anc7"></a><span class="line-modified">102             success = false;</span>
103         }
104     }
105 
106     return success;
107 }
108 /* ============================================================================= */
109 
110 /** Agent algorithm. */
111 static void JNICALL
112 agentProc(jvmtiEnv* jvmti, JNIEnv* jni, void* arg) {
113     NSK_DISPLAY0(&quot;Wait for debugee to become ready\n&quot;);
114     if (!nsk_jvmti_waitForSync(timeout))
115         return;
116 
117     NSK_DISPLAY0(&quot;&gt;&gt;&gt; Testcase #3: Check timer info in agent thread\n&quot;);
118     {
119         jvmtiTimerInfo info;
120         if (!checkTimerInfo(jvmti, &amp;info, &amp;initInfo, &quot;agent thread&quot;)) {
121             nsk_jvmti_setFailStatus();
122         }
123     }
124 
125     NSK_DISPLAY0(&quot;Let debugee to finish\n&quot;);
126     if (!nsk_jvmti_resumeSync())
127         return;
128 }
129 
130 /* ============================================================================= */
131 
132 /**
133  * Callback for VM_INIT event.
134  */
135 JNIEXPORT void JNICALL
136 callbackVMInit(jvmtiEnv* jvmti, JNIEnv* jni, jthread thread) {
137 
138     NSK_DISPLAY0(&quot;&gt;&gt;&gt; Testcase #2: Check timer info in VM_INIT callback\n&quot;);
139     {
140         jvmtiTimerInfo info;
141         if (!checkTimerInfo(jvmti, &amp;info, &amp;initInfo, &quot;VM_INIT callback&quot;)) {
142             nsk_jvmti_setFailStatus();
143         }
144     }
145 }
146 
147 /**
148  * Callback for VM_DEATH event.
149  */
150 JNIEXPORT void JNICALL
151 callbackVMDeath(jvmtiEnv* jvmti, JNIEnv* jni) {
<a name="8" id="anc8"></a><span class="line-modified">152     bool success = true;</span>
153 
154     NSK_DISPLAY0(&quot;&gt;&gt;&gt; Testcase #4: Check timer info in VM_DEATH callback\n&quot;);
155     {
156         jvmtiTimerInfo info;
157         success = checkTimerInfo(jvmti, &amp;info, &amp;initInfo, &quot;VM_DEATH callback&quot;);
158     }
159 
160     NSK_DISPLAY1(&quot;Disable events: %d events\n&quot;, EVENTS_COUNT);
161     if (!nsk_jvmti_enableEvents(JVMTI_DISABLE, EVENTS_COUNT, events, NULL)) {
<a name="9" id="anc9"></a><span class="line-modified">162         success = false;</span>
163     } else {
164         NSK_DISPLAY0(&quot;  ... disabled\n&quot;);
165     }
166 
<a name="10" id="anc10"></a><span class="line-modified">167     if (!success) {</span>
168         NSK_DISPLAY1(&quot;Exit with FAIL exit status: %d\n&quot;, STATUS_FAIL);
169         NSK_BEFORE_TRACE(exit(STATUS_FAIL));
170     }
171 }
172 
173 /* ============================================================================= */
174 
175 /** Agent library initialization. */
176 #ifdef STATIC_BUILD
177 JNIEXPORT jint JNICALL Agent_OnLoad_timerinfo001(JavaVM *jvm, char *options, void *reserved) {
178     return Agent_Initialize(jvm, options, reserved);
179 }
180 JNIEXPORT jint JNICALL Agent_OnAttach_timerinfo001(JavaVM *jvm, char *options, void *reserved) {
181     return Agent_Initialize(jvm, options, reserved);
182 }
183 JNIEXPORT jint JNI_OnLoad_timerinfo001(JavaVM *jvm, char *options, void *reserved) {
184     return JNI_VERSION_1_8;
185 }
186 #endif
187 jint Agent_Initialize(JavaVM *jvm, char *options, void *reserved) {
188     jvmtiEnv* jvmti = NULL;
189 
190     if (!NSK_VERIFY(nsk_jvmti_parseOptions(options)))
191         return JNI_ERR;
192 
193     timeout = nsk_jvmti_getWaitTime() * 60 * 1000;
194 
195     if (!NSK_VERIFY((jvmti =
196             nsk_jvmti_createJVMTIEnv(jvm, reserved)) != NULL))
197         return JNI_ERR;
198 
199     {
200         jvmtiEventCallbacks eventCallbacks;
201 
202         memset(&amp;eventCallbacks, 0, sizeof(eventCallbacks));
203         eventCallbacks.VMInit = callbackVMInit;
204         eventCallbacks.VMDeath = callbackVMDeath;
205         if (!NSK_JVMTI_VERIFY(
206                 jvmti-&gt;SetEventCallbacks(&amp;eventCallbacks, sizeof(eventCallbacks)))) {
207             return JNI_ERR;
208         }
209 
210     }
211 
212     if (!NSK_VERIFY(nsk_jvmti_setAgentProc(agentProc, NULL)))
213         return JNI_ERR;
214 
215     NSK_DISPLAY0(&quot;&gt;&gt;&gt; Testcase #1: Check initial timer info in Agent_OnLoad()\n&quot;);
216     {
217         if (!checkTimerInfo(jvmti, &amp;initInfo, NULL, &quot;Agent_OnLoad()&quot;)) {
218             nsk_jvmti_setFailStatus();
219         }
220     }
221 
222     NSK_DISPLAY1(&quot;Enable events: %d events\n&quot;, EVENTS_COUNT);
223     if (nsk_jvmti_enableEvents(JVMTI_ENABLE, EVENTS_COUNT, events, NULL)) {
224         NSK_DISPLAY0(&quot;  ... enabled\n&quot;);
225     }
226 
227     return JNI_OK;
228 }
229 
230 /* ============================================================================= */
231 
232 }
<a name="11" id="anc11"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="11" type="hidden" />
</body>
</html>