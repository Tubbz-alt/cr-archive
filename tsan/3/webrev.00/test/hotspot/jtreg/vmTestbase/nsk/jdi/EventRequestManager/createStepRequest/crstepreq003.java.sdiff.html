<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/hotspot/jtreg/vmTestbase/nsk/jdi/EventRequestManager/createStepRequest/crstepreq003.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="crstepreq002.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="crstepreq004.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/jtreg/vmTestbase/nsk/jdi/EventRequestManager/createStepRequest/crstepreq003.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
137             }
138 
139         } catch (Exception e) {
140             exitCode = Consts.TEST_FAILED;
141             complain(&quot;Unexpected Exception: &quot; + e.getMessage());
142             e.printStackTrace(out);
143             complain(&quot;The test has not finished normally. Forcing: vm.exit().&quot;);
144             if (vm != null) {
145                 vm.exit(PASSED + PASS_BASE);
146             }
147             debuggee.resume();
148             getEventSet();
149         }
150 
151         return exitCode;
152     }
153 
154     //--------------------------------------------------------- mutable common methods
155 
156     private void execTest() {
<span class="line-modified">157         ThreadReference mainThread = threadByName(&quot;main&quot;);</span>
158 /*
159         BreakpointRequest bpRequest = setBreakpoint( mainThread,
160                                                      debuggeeClass,
161                                                      &quot;methodForCommunication&quot;,
162                                                      2,
163                                                      &quot;breakpointForCommunication&quot;);
164 */
165         BreakpointRequest bpRequest = setBreakpoint( null,
166                                                      debuggeeClass,
167                                                      &quot;breakInThread&quot;,
168                                                      lineForBreakInThread,
169                                                      &quot;breakInThread&quot;);
170         bpRequest.enable();
171 
172         display(&quot;TESTING BEGINS&quot;);
173 
174         label0:
175         for (int testCase = 0; instruction != quit; testCase++) {
176 
177 //            waitForEvent(bpRequest);
</pre>
<hr />
<pre>
235         display(&quot;setStepRequest(): A StepRequest has been set up.&quot;);
236         return stepRequest;
237     }
238 
239     private void setAndCheckStepEvent ( BreakpointRequest bpRequest,
240                                         String caseProperty,
241                                         String threadName,
242                                         int lineOfStepEvent,
243                                         int stepDepth             ) {
244         display(&quot;Wait for brakepoint event in &quot; + threadName);
245         BreakpointEvent bpEvent = (BreakpointEvent)waitForEvent(bpRequest);
246 
247         // check location of breakpoint event
248         int lineOfEvent = ((LocatableEvent)bpEvent).location().lineNumber();
249         if (lineOfEvent != lineForBreakInThread) {
250             complain(&quot;Wrong line number of BreakpointEvent for &quot; + threadName);
251             complain(&quot;\texpected value : &quot; + lineForBreakInThread + &quot;; got one : &quot; + lineOfEvent);
252             exitCode = FAILED;
253         }
254 
<span class="line-modified">255         ThreadReference thread = threadByName(threadName);</span>
256         StepRequest stepRequest = setStepRequest( thread,
257                                                   StepRequest.STEP_LINE,
258                                                   stepDepth,
259                                                   caseProperty);
260         stepRequest.enable();
261 
262         display(&quot;waiting for StepEvent in &quot; + threadName);
263         Event newEvent = waitForEvent(stepRequest);
264         if (newEvent instanceof StepEvent) {
265             String property = (String) newEvent.request().getProperty(&quot;number&quot;);
266             display(&quot;got new StepEvent with property &#39;number&#39; == &quot; + property);
267 
268             if ( !property.equals(caseProperty) ) {
269                 complain(&quot;property is not : &quot; + caseProperty);
270                 exitCode = FAILED;
271             }
272             // check location of step event
273             lineOfEvent = ((LocatableEvent)newEvent).location().lineNumber();
274             if (lineOfEvent != lineOfStepEvent) {
275                 switch (stepDepth) {
</pre>
<hr />
<pre>
404             }
405         } catch (Exception e) {
406             throw new Failure(&quot;Unexpected exception while waiting for an event: &quot; + e);
407         }
408         return resultEvent;
409     }
410 
411 
412     private void getEventSet() {
413         try {
414             eventSet = vm.eventQueue().remove(waitTime);
415             if (eventSet == null) {
416                 throw new Failure(&quot;TIMEOUT while waiting for an event&quot;);
417             }
418             eventIterator = eventSet.eventIterator();
419         } catch (Exception e) {
420             throw new Failure(&quot;getEventSet(): Unexpected exception while waiting for an event: &quot; + e);
421         }
422     }
423 
<span class="line-removed">424 </span>
<span class="line-removed">425     private ThreadReference threadByName(String name) throws Failure{</span>
<span class="line-removed">426         List all = vm.allThreads();</span>
<span class="line-removed">427         ListIterator li = all.listIterator();</span>
<span class="line-removed">428 </span>
<span class="line-removed">429         while (li.hasNext()) {</span>
<span class="line-removed">430             ThreadReference thread = (ThreadReference) li.next();</span>
<span class="line-removed">431             if (thread.name().equals(name))</span>
<span class="line-removed">432                 return thread;</span>
<span class="line-removed">433         }</span>
<span class="line-removed">434         throw new Failure(&quot;Thread with searching for name is not found: &quot; + name);</span>
<span class="line-removed">435     }</span>
<span class="line-removed">436 </span>
437     private ReferenceType waitForDebuggeeClassPrepared () {
438         display(&quot;Creating request for ClassPrepareEvent for debuggee.&quot;);
439         ClassPrepareRequest cpRequest = eventRManager.createClassPrepareRequest();
440         cpRequest.addClassFilter(debuggeeName);
441         cpRequest.addCountFilter(1);
442         cpRequest.enable();
443 
444         ClassPrepareEvent event = (ClassPrepareEvent) waitForEvent(cpRequest);
445         cpRequest.disable();
446 
447         if (!event.referenceType().name().equals(debuggeeName)) {
448            throw new Failure(&quot;Unexpected class name for ClassPrepareEvent : &quot; + debuggeeClass.name());
449         }
450         return event.referenceType();
451     }
452 
453     private int getInstruction () {
454         if (debuggeeClass == null) {
455             throw new Failure(&quot;getInstruction() :: debuggeeClass reference is null&quot;);
456         }
</pre>
</td>
<td>
<hr />
<pre>
137             }
138 
139         } catch (Exception e) {
140             exitCode = Consts.TEST_FAILED;
141             complain(&quot;Unexpected Exception: &quot; + e.getMessage());
142             e.printStackTrace(out);
143             complain(&quot;The test has not finished normally. Forcing: vm.exit().&quot;);
144             if (vm != null) {
145                 vm.exit(PASSED + PASS_BASE);
146             }
147             debuggee.resume();
148             getEventSet();
149         }
150 
151         return exitCode;
152     }
153 
154     //--------------------------------------------------------- mutable common methods
155 
156     private void execTest() {
<span class="line-modified">157         ThreadReference mainThread = debuggee.threadByNameOrThrow(&quot;main&quot;);</span>
158 /*
159         BreakpointRequest bpRequest = setBreakpoint( mainThread,
160                                                      debuggeeClass,
161                                                      &quot;methodForCommunication&quot;,
162                                                      2,
163                                                      &quot;breakpointForCommunication&quot;);
164 */
165         BreakpointRequest bpRequest = setBreakpoint( null,
166                                                      debuggeeClass,
167                                                      &quot;breakInThread&quot;,
168                                                      lineForBreakInThread,
169                                                      &quot;breakInThread&quot;);
170         bpRequest.enable();
171 
172         display(&quot;TESTING BEGINS&quot;);
173 
174         label0:
175         for (int testCase = 0; instruction != quit; testCase++) {
176 
177 //            waitForEvent(bpRequest);
</pre>
<hr />
<pre>
235         display(&quot;setStepRequest(): A StepRequest has been set up.&quot;);
236         return stepRequest;
237     }
238 
239     private void setAndCheckStepEvent ( BreakpointRequest bpRequest,
240                                         String caseProperty,
241                                         String threadName,
242                                         int lineOfStepEvent,
243                                         int stepDepth             ) {
244         display(&quot;Wait for brakepoint event in &quot; + threadName);
245         BreakpointEvent bpEvent = (BreakpointEvent)waitForEvent(bpRequest);
246 
247         // check location of breakpoint event
248         int lineOfEvent = ((LocatableEvent)bpEvent).location().lineNumber();
249         if (lineOfEvent != lineForBreakInThread) {
250             complain(&quot;Wrong line number of BreakpointEvent for &quot; + threadName);
251             complain(&quot;\texpected value : &quot; + lineForBreakInThread + &quot;; got one : &quot; + lineOfEvent);
252             exitCode = FAILED;
253         }
254 
<span class="line-modified">255         ThreadReference thread = debuggee.threadByNameOrThrow(threadName);</span>
256         StepRequest stepRequest = setStepRequest( thread,
257                                                   StepRequest.STEP_LINE,
258                                                   stepDepth,
259                                                   caseProperty);
260         stepRequest.enable();
261 
262         display(&quot;waiting for StepEvent in &quot; + threadName);
263         Event newEvent = waitForEvent(stepRequest);
264         if (newEvent instanceof StepEvent) {
265             String property = (String) newEvent.request().getProperty(&quot;number&quot;);
266             display(&quot;got new StepEvent with property &#39;number&#39; == &quot; + property);
267 
268             if ( !property.equals(caseProperty) ) {
269                 complain(&quot;property is not : &quot; + caseProperty);
270                 exitCode = FAILED;
271             }
272             // check location of step event
273             lineOfEvent = ((LocatableEvent)newEvent).location().lineNumber();
274             if (lineOfEvent != lineOfStepEvent) {
275                 switch (stepDepth) {
</pre>
<hr />
<pre>
404             }
405         } catch (Exception e) {
406             throw new Failure(&quot;Unexpected exception while waiting for an event: &quot; + e);
407         }
408         return resultEvent;
409     }
410 
411 
412     private void getEventSet() {
413         try {
414             eventSet = vm.eventQueue().remove(waitTime);
415             if (eventSet == null) {
416                 throw new Failure(&quot;TIMEOUT while waiting for an event&quot;);
417             }
418             eventIterator = eventSet.eventIterator();
419         } catch (Exception e) {
420             throw new Failure(&quot;getEventSet(): Unexpected exception while waiting for an event: &quot; + e);
421         }
422     }
423 













424     private ReferenceType waitForDebuggeeClassPrepared () {
425         display(&quot;Creating request for ClassPrepareEvent for debuggee.&quot;);
426         ClassPrepareRequest cpRequest = eventRManager.createClassPrepareRequest();
427         cpRequest.addClassFilter(debuggeeName);
428         cpRequest.addCountFilter(1);
429         cpRequest.enable();
430 
431         ClassPrepareEvent event = (ClassPrepareEvent) waitForEvent(cpRequest);
432         cpRequest.disable();
433 
434         if (!event.referenceType().name().equals(debuggeeName)) {
435            throw new Failure(&quot;Unexpected class name for ClassPrepareEvent : &quot; + debuggeeClass.name());
436         }
437         return event.referenceType();
438     }
439 
440     private int getInstruction () {
441         if (debuggeeClass == null) {
442             throw new Failure(&quot;getInstruction() :: debuggeeClass reference is null&quot;);
443         }
</pre>
</td>
</tr>
</table>
<center><a href="crstepreq002.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="crstepreq004.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>