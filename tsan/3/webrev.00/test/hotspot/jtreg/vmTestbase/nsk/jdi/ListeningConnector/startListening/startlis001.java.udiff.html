<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/hotspot/jtreg/vmTestbase/nsk/jdi/ListeningConnector/startListening/startlis001.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../IntegerType/_itself_/integertype001.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../../LocatableEvent/thread/thread001.java.udiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/jtreg/vmTestbase/nsk/jdi/ListeningConnector/startListening/startlis001.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2000, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -30,13 +30,16 @@</span>
  import java.io.*;
  
  import java.net.InetAddress;
  import java.net.UnknownHostException;
  
<span class="udiff-line-added">+ import java.util.Arrays;</span>
  import java.util.Iterator;
<span class="udiff-line-added">+ import java.util.LinkedList;</span>
  import java.util.List;
  import java.util.Map;
<span class="udiff-line-added">+ import java.util.stream.Collectors;</span>
  
  import nsk.share.*;
  import nsk.share.jpda.*;
  import nsk.share.jdi.*;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -83,11 +86,10 @@</span>
      }
  
      private int runIt(String argv[], PrintStream out) {
          String port;
          String addr;
<span class="udiff-line-removed">-         InetAddress inetAddr = null;</span>
          ArgumentHandler argHandler = new ArgumentHandler(argv);
  
  // pass if CONNECTOR_NAME is not implemented
  // on this platform
          if (argHandler.shouldPass(CONNECTOR_NAME))
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -95,50 +97,56 @@</span>
          this.out = out;
          log = new Log(out, argHandler);
  
          long timeout = argHandler.getWaitTime() * 60 * 1000;
  
<span class="udiff-line-modified-removed">- /* Check that listening address returned by ListeningConnector.startListening()</span>
<span class="udiff-line-modified-removed">-    matches the address which was set via connector&#39;s arguments */</span>
<span class="udiff-line-modified-added">+         /* Check that listening address returned by ListeningConnector.startListening()</span>
<span class="udiff-line-modified-added">+          * matches the address which was set via connector&#39;s arguments.</span>
<span class="udiff-line-added">+          * Empty host address causes listening for local connections only (loopback interface).</span>
<span class="udiff-line-added">+          * */</span>
<span class="udiff-line-added">+         String hostname = &quot;localhost&quot;;</span>
<span class="udiff-line-added">+         List&lt;String&gt; validAddresses = new LinkedList&lt;&gt;();</span>
<span class="udiff-line-added">+         validAddresses.add(hostname);</span>
          try {
<span class="udiff-line-modified-removed">-             inetAddr = InetAddress.getLocalHost();</span>
<span class="udiff-line-modified-added">+             Arrays.stream(InetAddress.getAllByName(hostname))</span>
<span class="udiff-line-added">+                     .forEach(address -&gt; validAddresses.add(address.getHostAddress()));</span>
          } catch (UnknownHostException e) {
              log.complain(&quot;FAILURE: caught UnknownHostException &quot; +
<span class="udiff-line-modified-removed">-                 e.getMessage());</span>
<span class="udiff-line-modified-added">+                     e.getMessage());</span>
              totalRes = false;
          }
<span class="udiff-line-modified-removed">-         String hostname = inetAddr.getHostName();</span>
<span class="udiff-line-removed">-         String ip = inetAddr.getHostAddress();</span>
<span class="udiff-line-modified-added">+ </span>
          port = argHandler.getTransportPortIfNotDynamic();
  
          initConnector(port);
          if ((addr = startListen()) == null) {
              log.complain(&quot;Test case #1 FAILED: unable to start listening&quot;);
              totalRes = false;
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-removed">-         else {</span>
<span class="udiff-line-modified-added">+         } else {</span>
<span class="udiff-line-modified-added">+             String validAddrList = validAddresses.stream()</span>
<span class="udiff-line-added">+                     .map(value -&gt; value + &quot;:&quot; + port)</span>
<span class="udiff-line-added">+                     .collect(Collectors.joining(&quot; or &quot;));</span>
              log.display(&quot;Test case #1: start listening the address &quot; + addr);
<span class="udiff-line-modified-removed">-             log.display(&quot;Expected address: &quot;+ hostname + &quot;:&quot; + port +</span>
<span class="udiff-line-modified-removed">-                 &quot;\n\tor &quot;+ ip + &quot;:&quot; + port);</span>
<span class="udiff-line-modified-removed">-             if ( (!addr.startsWith(hostname) &amp;&amp; !addr.startsWith(ip)) ||</span>
<span class="udiff-line-modified-removed">-                  (port != null &amp;&amp; !addr.endsWith(port)) ) {</span>
<span class="udiff-line-modified-added">+             log.display(&quot;Expected addresses: &quot; + validAddrList);</span>
<span class="udiff-line-modified-added">+             final String listenAddr = addr;</span>
<span class="udiff-line-modified-added">+             boolean isValid = validAddresses.stream()</span>
<span class="udiff-line-modified-added">+                     .anyMatch(value -&gt; listenAddr.startsWith(value) &amp;&amp; (port == null || listenAddr.endsWith(port)));</span>
<span class="udiff-line-added">+             if (!isValid) {</span>
                  log.complain(&quot;Test case #1 FAILED: listening address &quot; + addr +
<span class="udiff-line-modified-removed">-                     &quot;\ndoes not match expected address:\n&quot; +</span>
<span class="udiff-line-removed">-                     hostname + &quot;:&quot; + port + &quot; or &quot; +</span>
<span class="udiff-line-removed">-                     ip + &quot;:&quot; + port);</span>
<span class="udiff-line-modified-added">+                     &quot;\ndoes not match expected address:\n&quot; + validAddrList);</span>
                  totalRes = false;
              }
              if (!stopListen()) {
                  log.complain(&quot;TEST: unable to stop listening #1&quot;);
                  totalRes = false;
              }
              else
                 log.display(&quot;Test case #1 PASSED: listening address matches expected address&quot;);
          }
  
<span class="udiff-line-modified-removed">- /* Check that an address generated by ListeningConnector.startListening()</span>
<span class="udiff-line-modified-removed">-    is valid i.e. debugee VM is accessible via this address */</span>
<span class="udiff-line-modified-added">+         /* Check that an address generated by ListeningConnector.startListening()</span>
<span class="udiff-line-modified-added">+            is valid i.e. debugee VM is accessible via this address */</span>
          initConnector(null);
          if ((addr = startListen()) == null) {
              log.complain(&quot;Test case #2 FAILED: unable to start listening&quot;);
              return FAILED;
          }
</pre>
<center><a href="../../IntegerType/_itself_/integertype001.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../../LocatableEvent/thread/thread001.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>