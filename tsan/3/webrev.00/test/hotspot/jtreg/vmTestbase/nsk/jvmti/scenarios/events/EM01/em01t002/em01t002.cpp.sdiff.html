<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/hotspot/jtreg/vmTestbase/nsk/jvmti/scenarios/events/EM01/em01t002/em01t002.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../em01t001/libem01t001.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="libem01t002.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/jtreg/vmTestbase/nsk/jvmti/scenarios/events/EM01/em01t002/em01t002.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2004, 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 #include &lt;string.h&gt;
 25 #include &quot;jvmti.h&quot;
 26 #include &quot;agent_common.h&quot;

 27 #include &quot;jni_tools.h&quot;
 28 #include &quot;jvmti_tools.h&quot;
 29 #include &quot;JVMTITools.h&quot;
 30 
 31 extern &quot;C&quot; {
 32 
 33 /* ============================================================================= */
 34 
 35 /* scaffold objects */
 36 static JNIEnv* jni = NULL;
 37 static jvmtiEnv *jvmti = NULL;
 38 static jlong timeout = 0;
 39 static jrawMonitorID syncLock = NULL;
 40 
 41 /* constant names */
 42 #define JVMTI_EVENT_COUNT   (int)(JVMTI_MAX_EVENT_TYPE_VAL - JVMTI_MIN_EVENT_TYPE_VAL + 1)
 43 #define EXPECTED_CLASS_NAME &quot;Lnsk/jvmti/scenarios/events/EM01/em01t002a;&quot;
 44 #define CLASS_LOADER_COUNT_PARAM &quot;classLoaderCount&quot;
 45 
 46 static int eventCount[JVMTI_EVENT_COUNT];
 47 
 48 static int classLoaderCount = 0;
 49 
 50 static jvmtiPhase currentPhase;
 51 
 52 /* ============================================================================= */
 53 /* ============================================================================= */
 54 
 55 
 56 /*
 57  * Class:     nsk_jvmti_scenarios_events_EM01_em01t002
 58  * Method:    loadClass
 59  * Signature: (Lnsk/share/ClassLoader;Ljava/lang/String;)Ljava/lang/Class;
 60  */
 61 JNIEXPORT jclass JNICALL
 62 Java_nsk_jvmti_scenarios_events_EM01_em01t002_loadClass(JNIEnv *jni_env,
 63                         jobject o, jobject loader, jstring className) {

 64     jclass klass;
 65     jmethodID methodID;
 66     jclass loadedClass;
 67 
<span class="line-modified"> 68     klass = jni_env-&gt;GetObjectClass(loader);</span>
<span class="line-modified"> 69     if (!NSK_JNI_VERIFY(jni_env, klass != NULL)) {</span>
<span class="line-modified"> 70         nsk_jvmti_setFailStatus();</span>
<span class="line-modified"> 71         return NULL;</span>
<span class="line-modified"> 72     }</span>
<span class="line-removed"> 73 </span>
<span class="line-removed"> 74     methodID = jni_env-&gt;GetMethodID(</span>
<span class="line-removed"> 75             klass, &quot;loadClass&quot;, &quot;(Ljava/lang/String;)Ljava/lang/Class;&quot;);</span>
<span class="line-removed"> 76     if (!NSK_JNI_VERIFY(jni_env, methodID != NULL)) {</span>
<span class="line-removed"> 77         nsk_jvmti_setFailStatus();</span>
<span class="line-removed"> 78         return NULL;</span>
<span class="line-removed"> 79     }</span>
<span class="line-removed"> 80 </span>
<span class="line-removed"> 81     loadedClass = (jclass) jni_env-&gt;CallObjectMethod(loader, methodID, className);</span>
<span class="line-removed"> 82     if (!NSK_JNI_VERIFY(jni_env, loadedClass != NULL)) {</span>
<span class="line-removed"> 83         nsk_jvmti_setFailStatus();</span>
<span class="line-removed"> 84         return NULL;</span>
<span class="line-removed"> 85     }</span>
 86 
 87     return loadedClass;
 88 }
 89 
 90 /*
 91  * Class:     nsk_jvmti_scenarios_events_EM01_em01t002
 92  * Method:    prepareClass
 93  * Signature: (Ljava/lang/Class;)Z
 94  */
 95 JNIEXPORT jboolean JNICALL
<span class="line-modified"> 96 Java_nsk_jvmti_scenarios_events_EM01_em01t002_prepareClass(JNIEnv *jni_env,</span>
 97                         jobject o, jclass klass) {

 98     jfieldID fieldID;
 99 
<span class="line-modified">100     fieldID = jni_env-&gt;GetStaticFieldID(klass, &quot;toProvokePreparation&quot;, &quot;I&quot;);</span>
<span class="line-removed">101     if (!NSK_JNI_VERIFY(jni_env, fieldID != NULL)) {</span>
<span class="line-removed">102         nsk_jvmti_setFailStatus();</span>
<span class="line-removed">103         return NSK_FALSE;</span>
<span class="line-removed">104     }</span>
<span class="line-removed">105 </span>
106     return NSK_TRUE;
107 }
108 
109 /*
110  * Class:     nsk_jvmti_scenarios_events_EM01_em01t002
111  * Method:    startThread
112  * Signature: (Ljava/lang/Thread;)Z
113  */
114 JNIEXPORT jboolean JNICALL
115 Java_nsk_jvmti_scenarios_events_EM01_em01t002_startThread(JNIEnv *jni_env,
116                         jobject o, jobject thread) {

117     jclass klass;
118     jmethodID methodID;
119 
<span class="line-modified">120     klass = jni_env-&gt;GetObjectClass(thread);</span>
<span class="line-modified">121     if (!NSK_JNI_VERIFY(jni_env, klass != NULL)) {</span>
<span class="line-modified">122         nsk_jvmti_setFailStatus();</span>
<span class="line-removed">123         return NSK_FALSE;</span>
<span class="line-removed">124     }</span>
<span class="line-removed">125 </span>
<span class="line-removed">126     methodID = jni_env-&gt;GetMethodID(klass, &quot;start&quot;, &quot;()V&quot;);</span>
<span class="line-removed">127     if (!NSK_JNI_VERIFY(jni_env, methodID != NULL)) {</span>
<span class="line-removed">128         nsk_jvmti_setFailStatus();</span>
<span class="line-removed">129         return NSK_FALSE;</span>
<span class="line-removed">130     }</span>
<span class="line-removed">131 </span>
<span class="line-removed">132     if (!NSK_JNI_VERIFY_VOID(jni_env,jni_env-&gt;CallVoidMethod(thread, methodID))) {</span>
<span class="line-removed">133         nsk_jvmti_setFailStatus();</span>
<span class="line-removed">134         return NSK_FALSE;</span>
<span class="line-removed">135     }</span>
<span class="line-removed">136 </span>
137     return NSK_TRUE;
138 }
139 
140 /* ============================================================================= */
141 /* ============================================================================= */
142 
143 static void
144 changeCount(jvmtiEvent event) {
145 
146     if (!NSK_JVMTI_VERIFY(jvmti-&gt;RawMonitorEnter(syncLock)))
147         nsk_jvmti_setFailStatus();
148 
149     eventCount[event - JVMTI_MIN_EVENT_TYPE_VAL]++;
150 
151     if (!NSK_JVMTI_VERIFY(jvmti-&gt;RawMonitorExit(syncLock)))
152         nsk_jvmti_setFailStatus();
153 
154 }
155 
156 /* ============================================================================= */
</pre>
<hr />
<pre>
207         NSK_COMPLAIN4(&quot;%25s was sent during %s(%d)\n\tclass: %s\n&quot;,
208                     TranslateEvent(event),
209                     TranslatePhase(phase),
210                     phase,
211                     className);
212         nsk_jvmti_setFailStatus();
213     }
214 
215     if (!NSK_JVMTI_VERIFY(jvmti_env-&gt;Deallocate((unsigned char*)className))) {
216         nsk_jvmti_setFailStatus();
217     }
218     if (generic != NULL)
219         if (!NSK_JVMTI_VERIFY(jvmti_env-&gt;Deallocate((unsigned char*)generic))) {
220             nsk_jvmti_setFailStatus();
221         }
222 }
223 
224 void
225 threadEventHandler(jvmtiEvent event, jvmtiEnv* jvmti_env, JNIEnv* jni_env,
226                             jthread thread) {

227     jclass classObject;
228     char *className;
229     char *generic;
230     jvmtiPhase phase;
231 
232 
<span class="line-modified">233     classObject = jni_env-&gt;GetObjectClass(thread);</span>
<span class="line-removed">234     if (!NSK_JNI_VERIFY(jni_env, classObject != NULL)) {</span>
<span class="line-removed">235         nsk_jvmti_setFailStatus();</span>
<span class="line-removed">236         return;</span>
<span class="line-removed">237     }</span>
238 
239     if (!NSK_JVMTI_VERIFY(jvmti_env-&gt;GetClassSignature(classObject, &amp;className, &amp;generic))) {
240         nsk_jvmti_setFailStatus();
241         return;
242     }
243 
244     if (strcmp(className, EXPECTED_CLASS_NAME) == 0) {
245         changeCount(event);
246         NSK_DISPLAY3(&quot;%25s(%4d)&gt;&gt;\tclass: %s\n&quot;,
247                             TranslateEvent(event),
248                             eventCount[event - JVMTI_MIN_EVENT_TYPE_VAL],
249                             className);
250     }
251 
252     if (!NSK_JVMTI_VERIFY(jvmti_env-&gt;GetPhase(&amp;phase))) {
253         nsk_jvmti_setFailStatus();
254     }
255 
256     if (phase != currentPhase) {
257         NSK_DISPLAY2(&quot;Unexpected phase %s, but supposed %s&quot;,
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2004, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 #include &lt;string.h&gt;
 25 #include &quot;jvmti.h&quot;
 26 #include &quot;agent_common.h&quot;
<span class="line-added"> 27 #include &quot;ExceptionCheckingJniEnv.hpp&quot;</span>
 28 #include &quot;jni_tools.h&quot;
 29 #include &quot;jvmti_tools.h&quot;
 30 #include &quot;JVMTITools.h&quot;
 31 
 32 extern &quot;C&quot; {
 33 
 34 /* ============================================================================= */
 35 
 36 /* scaffold objects */
 37 static JNIEnv* jni = NULL;
 38 static jvmtiEnv *jvmti = NULL;
 39 static jlong timeout = 0;
 40 static jrawMonitorID syncLock = NULL;
 41 
 42 /* constant names */
 43 #define JVMTI_EVENT_COUNT   (int)(JVMTI_MAX_EVENT_TYPE_VAL - JVMTI_MIN_EVENT_TYPE_VAL + 1)
 44 #define EXPECTED_CLASS_NAME &quot;Lnsk/jvmti/scenarios/events/EM01/em01t002a;&quot;
 45 #define CLASS_LOADER_COUNT_PARAM &quot;classLoaderCount&quot;
 46 
 47 static int eventCount[JVMTI_EVENT_COUNT];
 48 
 49 static int classLoaderCount = 0;
 50 
 51 static jvmtiPhase currentPhase;
 52 
 53 /* ============================================================================= */
 54 /* ============================================================================= */
 55 
 56 
 57 /*
 58  * Class:     nsk_jvmti_scenarios_events_EM01_em01t002
 59  * Method:    loadClass
 60  * Signature: (Lnsk/share/ClassLoader;Ljava/lang/String;)Ljava/lang/Class;
 61  */
 62 JNIEXPORT jclass JNICALL
 63 Java_nsk_jvmti_scenarios_events_EM01_em01t002_loadClass(JNIEnv *jni_env,
 64                         jobject o, jobject loader, jstring className) {
<span class="line-added"> 65     ExceptionCheckingJniEnvPtr ec_jni(jni_env);</span>
 66     jclass klass;
 67     jmethodID methodID;
 68     jclass loadedClass;
 69 
<span class="line-modified"> 70     klass = ec_jni-&gt;GetObjectClass(loader, TRACE_JNI_CALL);</span>
<span class="line-modified"> 71     methodID = ec_jni-&gt;GetMethodID(</span>
<span class="line-modified"> 72             klass, &quot;loadClass&quot;, &quot;(Ljava/lang/String;)Ljava/lang/Class;&quot;, TRACE_JNI_CALL);</span>
<span class="line-modified"> 73     loadedClass = (jclass) ec_jni-&gt;CallObjectMethod(loader, methodID,</span>
<span class="line-modified"> 74                                                     TRACE_JNI_CALL_VARARGS(className));</span>













 75 
 76     return loadedClass;
 77 }
 78 
 79 /*
 80  * Class:     nsk_jvmti_scenarios_events_EM01_em01t002
 81  * Method:    prepareClass
 82  * Signature: (Ljava/lang/Class;)Z
 83  */
 84 JNIEXPORT jboolean JNICALL
<span class="line-modified"> 85 Java_nsk_jvmti_scenarios_events_EM01_em01t002_prepareClass(JNIEnv *jni,</span>
 86                         jobject o, jclass klass) {
<span class="line-added"> 87     ExceptionCheckingJniEnvPtr ec_jni(jni);</span>
 88     jfieldID fieldID;
 89 
<span class="line-modified"> 90     fieldID = ec_jni-&gt;GetStaticFieldID(klass, &quot;toProvokePreparation&quot;, &quot;I&quot;, TRACE_JNI_CALL);</span>





 91     return NSK_TRUE;
 92 }
 93 
 94 /*
 95  * Class:     nsk_jvmti_scenarios_events_EM01_em01t002
 96  * Method:    startThread
 97  * Signature: (Ljava/lang/Thread;)Z
 98  */
 99 JNIEXPORT jboolean JNICALL
100 Java_nsk_jvmti_scenarios_events_EM01_em01t002_startThread(JNIEnv *jni_env,
101                         jobject o, jobject thread) {
<span class="line-added">102     ExceptionCheckingJniEnvPtr ec_jni(jni_env);</span>
103     jclass klass;
104     jmethodID methodID;
105 
<span class="line-modified">106     klass = ec_jni-&gt;GetObjectClass(thread, TRACE_JNI_CALL);</span>
<span class="line-modified">107     methodID = ec_jni-&gt;GetMethodID(klass, &quot;start&quot;, &quot;()V&quot;, TRACE_JNI_CALL);</span>
<span class="line-modified">108     ec_jni-&gt;CallVoidMethod(thread, methodID, TRACE_JNI_CALL);</span>














109     return NSK_TRUE;
110 }
111 
112 /* ============================================================================= */
113 /* ============================================================================= */
114 
115 static void
116 changeCount(jvmtiEvent event) {
117 
118     if (!NSK_JVMTI_VERIFY(jvmti-&gt;RawMonitorEnter(syncLock)))
119         nsk_jvmti_setFailStatus();
120 
121     eventCount[event - JVMTI_MIN_EVENT_TYPE_VAL]++;
122 
123     if (!NSK_JVMTI_VERIFY(jvmti-&gt;RawMonitorExit(syncLock)))
124         nsk_jvmti_setFailStatus();
125 
126 }
127 
128 /* ============================================================================= */
</pre>
<hr />
<pre>
179         NSK_COMPLAIN4(&quot;%25s was sent during %s(%d)\n\tclass: %s\n&quot;,
180                     TranslateEvent(event),
181                     TranslatePhase(phase),
182                     phase,
183                     className);
184         nsk_jvmti_setFailStatus();
185     }
186 
187     if (!NSK_JVMTI_VERIFY(jvmti_env-&gt;Deallocate((unsigned char*)className))) {
188         nsk_jvmti_setFailStatus();
189     }
190     if (generic != NULL)
191         if (!NSK_JVMTI_VERIFY(jvmti_env-&gt;Deallocate((unsigned char*)generic))) {
192             nsk_jvmti_setFailStatus();
193         }
194 }
195 
196 void
197 threadEventHandler(jvmtiEvent event, jvmtiEnv* jvmti_env, JNIEnv* jni_env,
198                             jthread thread) {
<span class="line-added">199     ExceptionCheckingJniEnvPtr ec_jni(jni_env);</span>
200     jclass classObject;
201     char *className;
202     char *generic;
203     jvmtiPhase phase;
204 
205 
<span class="line-modified">206     classObject = ec_jni-&gt;GetObjectClass(thread, TRACE_JNI_CALL);</span>




207 
208     if (!NSK_JVMTI_VERIFY(jvmti_env-&gt;GetClassSignature(classObject, &amp;className, &amp;generic))) {
209         nsk_jvmti_setFailStatus();
210         return;
211     }
212 
213     if (strcmp(className, EXPECTED_CLASS_NAME) == 0) {
214         changeCount(event);
215         NSK_DISPLAY3(&quot;%25s(%4d)&gt;&gt;\tclass: %s\n&quot;,
216                             TranslateEvent(event),
217                             eventCount[event - JVMTI_MIN_EVENT_TYPE_VAL],
218                             className);
219     }
220 
221     if (!NSK_JVMTI_VERIFY(jvmti_env-&gt;GetPhase(&amp;phase))) {
222         nsk_jvmti_setFailStatus();
223     }
224 
225     if (phase != currentPhase) {
226         NSK_DISPLAY2(&quot;Unexpected phase %s, but supposed %s&quot;,
</pre>
</td>
</tr>
</table>
<center><a href="../em01t001/libem01t001.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="libem01t002.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>