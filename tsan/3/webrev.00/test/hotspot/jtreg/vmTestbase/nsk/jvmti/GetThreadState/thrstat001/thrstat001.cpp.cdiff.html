<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff test/hotspot/jtreg/vmTestbase/nsk/jvmti/GetThreadState/thrstat001/thrstat001.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../FramePop/framepop002/framepop002.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../../GetTime/gettime001/gettime001.cpp.cdiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/jtreg/vmTestbase/nsk/jvmti/GetThreadState/thrstat001/thrstat001.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2004, 2018, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2004, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 37,181 ***</span>
  
  static jvmtiEnv *jvmti = NULL;
  static jvmtiCapabilities caps;
  static jvmtiEventCallbacks callbacks;
  static jrawMonitorID access_lock;
  static jint result = PASSED;
<span class="line-removed">- static jboolean printdump = JNI_FALSE;</span>
  static jthread thr_ptr = NULL;
  static jint state[] = {
      JVMTI_THREAD_STATE_RUNNABLE,
      JVMTI_THREAD_STATE_BLOCKED_ON_MONITOR_ENTER,
      JVMTI_THREAD_STATE_IN_OBJECT_WAIT
  };
  
<span class="line-modified">! static int entry_count = 0;</span>
<span class="line-modified">! static int entry_error_count = 0;</span>
<span class="line-modified">! static int exit_count = 0;</span>
<span class="line-removed">- static int exit_error_count = 0;</span>
<span class="line-removed">- </span>
<span class="line-removed">- void JNICALL VMInit(jvmtiEnv *jvmti_env, JNIEnv *env, jthread thr) {</span>
<span class="line-removed">-     jvmtiError err;</span>
<span class="line-removed">- </span>
<span class="line-removed">-     err = jvmti_env-&gt;SetEventNotificationMode(JVMTI_ENABLE,</span>
<span class="line-removed">-         JVMTI_EVENT_THREAD_START, NULL);</span>
      if (err != JVMTI_ERROR_NONE) {
<span class="line-modified">!         printf(&quot;Failed to enable THREAD_START event: %s (%d)\n&quot;,</span>
<span class="line-modified">!                TranslateError(err), err);</span>
          result = STATUS_FAILED;
      }
<span class="line-removed">- </span>
<span class="line-removed">-     if (caps.can_generate_method_entry_events) {</span>
<span class="line-removed">-         err = jvmti_env-&gt;SetEventNotificationMode(JVMTI_ENABLE,</span>
<span class="line-removed">-             JVMTI_EVENT_METHOD_ENTRY, NULL);</span>
<span class="line-removed">-         if (err != JVMTI_ERROR_NONE) {</span>
<span class="line-removed">-             printf(&quot;Failed to enable METHOD_ENTRY event: %s (%d)\n&quot;,</span>
<span class="line-removed">-                    TranslateError(err), err);</span>
<span class="line-removed">-             result = STATUS_FAILED;</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     if (caps.can_generate_method_exit_events) {</span>
<span class="line-removed">-         err = jvmti_env-&gt;SetEventNotificationMode(JVMTI_ENABLE,</span>
<span class="line-removed">-             JVMTI_EVENT_METHOD_EXIT, NULL);</span>
<span class="line-removed">-         if (err != JVMTI_ERROR_NONE) {</span>
<span class="line-removed">-             printf(&quot;Failed to enable METHOD_EXIT event: %s (%d)\n&quot;,</span>
<span class="line-removed">-                    TranslateError(err), err);</span>
<span class="line-removed">-             result = STATUS_FAILED;</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-     }</span>
  }
  
<span class="line-modified">! void JNICALL</span>
<span class="line-modified">! ThreadStart(jvmtiEnv *jvmti_env, JNIEnv *env, jthread thread) {</span>
<span class="line-modified">!     jvmtiError err;</span>
<span class="line-removed">-     jvmtiThreadInfo thrInfo;</span>
<span class="line-removed">- </span>
<span class="line-removed">-     err = jvmti_env-&gt;RawMonitorEnter(access_lock);</span>
<span class="line-removed">-     if (err != JVMTI_ERROR_NONE) {</span>
<span class="line-removed">-         printf(&quot;(RawMonitorEnter#TS) unexpected error: %s (%d)\n&quot;,</span>
<span class="line-removed">-                TranslateError(err), err);</span>
<span class="line-removed">-         result = STATUS_FAILED;</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     err = jvmti_env-&gt;GetThreadInfo(thread, &amp;thrInfo);</span>
<span class="line-removed">-     if (err != JVMTI_ERROR_NONE) {</span>
<span class="line-removed">-         printf(&quot;(GetThreadInfo#TS) unexpected error: %s (%d)\n&quot;,</span>
<span class="line-removed">-                TranslateError(err), err);</span>
<span class="line-removed">-         result = STATUS_FAILED;</span>
<span class="line-removed">-     }</span>
<span class="line-removed">-     if (thrInfo.name != NULL &amp;&amp; strcmp(thrInfo.name, &quot;thr1&quot;) == 0) {</span>
<span class="line-removed">-         thr_ptr = env-&gt;NewGlobalRef(thread);</span>
<span class="line-removed">-         if (printdump == JNI_TRUE) {</span>
<span class="line-removed">-             printf(&quot;&gt;&gt;&gt; ThreadStart: \&quot;%s\&quot;, 0x%p\n&quot;, thrInfo.name, thr_ptr);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     err = jvmti_env-&gt;RawMonitorExit(access_lock);</span>
      if (err != JVMTI_ERROR_NONE) {
<span class="line-modified">!         printf(&quot;(RawMonitorExit#TS) unexpected error: %s (%d)\n&quot;,</span>
<span class="line-modified">!                TranslateError(err), err);</span>
          result = STATUS_FAILED;
      }
  }
  
<span class="line-modified">! void JNICALL MethodEntry(jvmtiEnv *jvmti_env, JNIEnv *env,</span>
<span class="line-modified">!         jthread thread, jmethodID mid) {</span>
<span class="line-modified">!     jvmtiError err;</span>
<span class="line-removed">-     jvmtiThreadInfo thrInfo;</span>
<span class="line-removed">-     jint thrState;</span>
<span class="line-removed">- </span>
<span class="line-removed">-     err = jvmti_env-&gt;RawMonitorEnter(access_lock);</span>
      if (err != JVMTI_ERROR_NONE) {
<span class="line-modified">!         printf(&quot;(RawMonitorEnter#ME) unexpected error: %s (%d)\n&quot;,</span>
<span class="line-modified">!                TranslateError(err), err);</span>
          result = STATUS_FAILED;
      }
  
<span class="line-modified">!     entry_count++;</span>
<span class="line-modified">!     err = jvmti_env-&gt;GetThreadState(thread, &amp;thrState);</span>
<span class="line-modified">!     if (err != JVMTI_ERROR_NONE) {</span>
<span class="line-modified">!         printf(&quot;(GetThreadState#ME) unexpected error: %s (%d)\n&quot;,</span>
<span class="line-modified">!             TranslateError(err), err);</span>
<span class="line-modified">!         result = STATUS_FAILED;</span>
<span class="line-modified">!     }</span>
<span class="line-removed">-     if ((thrState &amp; JVMTI_THREAD_STATE_RUNNABLE) == 0) {</span>
<span class="line-removed">-         if (entry_error_count == 0) {</span>
<span class="line-removed">-             err = jvmti_env-&gt;GetThreadInfo(thread, &amp;thrInfo);</span>
<span class="line-removed">-             if (err != JVMTI_ERROR_NONE) {</span>
<span class="line-removed">-                 printf(&quot;(GetThreadInfo#ME) unexpected error: %s (%d)\n&quot;,</span>
<span class="line-removed">-                        TranslateError(err), err);</span>
<span class="line-removed">-                 result = STATUS_FAILED;</span>
<span class="line-removed">-             }</span>
<span class="line-removed">-             printf(&quot;Wrong thread \&quot;%s\&quot; state on MethodEntry event:\n&quot;,</span>
<span class="line-removed">-                    thrInfo.name);</span>
<span class="line-removed">-             printf(&quot;    expected: JVMTI_THREAD_STATE_RUNNABLE\n&quot;);</span>
<span class="line-removed">-             printf(&quot;    got: %s (%d)\n&quot;,</span>
<span class="line-removed">-                    TranslateState(thrState), thrState);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-         entry_error_count++;</span>
<span class="line-removed">-         result = STATUS_FAILED;</span>
<span class="line-removed">-     }</span>
  
<span class="line-removed">-     err = jvmti_env-&gt;RawMonitorExit(access_lock);</span>
      if (err != JVMTI_ERROR_NONE) {
<span class="line-modified">!         printf(&quot;(RawMonitorExit#ME) unexpected error: %s (%d)\n&quot;,</span>
<span class="line-modified">!                TranslateError(err), err);</span>
          result = STATUS_FAILED;
      }
  
  }
  
<span class="line-modified">! void JNICALL MethodExit(jvmtiEnv *jvmti_env, JNIEnv *env,</span>
<span class="line-modified">!         jthread thread, jmethodID mid,</span>
<span class="line-removed">-         jboolean was_poped_by_exception, jvalue return_value) {</span>
      jvmtiError err;
      jvmtiThreadInfo thrInfo;
<span class="line-removed">-     jint thrState;</span>
  
<span class="line-modified">!     err = jvmti_env-&gt;RawMonitorEnter(access_lock);</span>
<span class="line-removed">-     if (err != JVMTI_ERROR_NONE) {</span>
<span class="line-removed">-         printf(&quot;(RawMonitorEnter#MX) unexpected error: %s (%d)\n&quot;,</span>
<span class="line-removed">-                TranslateError(err), err);</span>
<span class="line-removed">-         result = STATUS_FAILED;</span>
<span class="line-removed">-     }</span>
  
<span class="line-modified">!     exit_count++;</span>
<span class="line-removed">-     err = jvmti_env-&gt;GetThreadState(thread, &amp;thrState);</span>
      if (err != JVMTI_ERROR_NONE) {
<span class="line-modified">!         printf(&quot;(GetThreadState#MX) unexpected error: %s (%d)\n&quot;,</span>
<span class="line-modified">!             TranslateError(err), err);</span>
          result = STATUS_FAILED;
      }
<span class="line-modified">!     if ((thrState &amp; JVMTI_THREAD_STATE_RUNNABLE) == 0) {</span>
<span class="line-modified">!         if (exit_error_count == 0) {</span>
<span class="line-modified">!             err = jvmti_env-&gt;GetThreadInfo(thread, &amp;thrInfo);</span>
<span class="line-modified">!             if (err != JVMTI_ERROR_NONE) {</span>
<span class="line-modified">!                 printf(&quot;(GetThreadInfo#MX) unexpected error: %s (%d)\n&quot;,</span>
<span class="line-removed">-                        TranslateError(err), err);</span>
<span class="line-removed">-                 result = STATUS_FAILED;</span>
<span class="line-removed">-             }</span>
<span class="line-removed">-             printf(&quot;Wrong thread \&quot;%s\&quot; state on MethodExit event:\n&quot;,</span>
<span class="line-removed">-                    thrInfo.name);</span>
<span class="line-removed">-             printf(&quot;    expected: JVMTI_THREAD_STATE_RUNNABLE\n&quot;);</span>
<span class="line-removed">-             printf(&quot;    got: %s (%d)\n&quot;,</span>
<span class="line-removed">-                    TranslateState(thrState), thrState);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-         exit_error_count++;</span>
<span class="line-removed">-         result = STATUS_FAILED;</span>
      }
  
<span class="line-modified">!     err = jvmti_env-&gt;RawMonitorExit(access_lock);</span>
<span class="line-removed">-     if (err != JVMTI_ERROR_NONE) {</span>
<span class="line-removed">-         printf(&quot;(RawMonitorExit#MX) unexpected error: %s (%d)\n&quot;,</span>
<span class="line-removed">-                TranslateError(err), err);</span>
<span class="line-removed">-         result = STATUS_FAILED;</span>
<span class="line-removed">-     }</span>
  }
  
  #ifdef STATIC_BUILD
  JNIEXPORT jint JNICALL Agent_OnLoad_thrstat001(JavaVM *jvm, char *options, void *reserved) {
      return Agent_Initialize(jvm, options, reserved);
<span class="line-new-header">--- 37,91 ---</span>
  
  static jvmtiEnv *jvmti = NULL;
  static jvmtiCapabilities caps;
  static jvmtiEventCallbacks callbacks;
  static jrawMonitorID access_lock;
<span class="line-added">+ static jrawMonitorID wait_lock;</span>
  static jint result = PASSED;
  static jthread thr_ptr = NULL;
<span class="line-added">+ </span>
  static jint state[] = {
      JVMTI_THREAD_STATE_RUNNABLE,
      JVMTI_THREAD_STATE_BLOCKED_ON_MONITOR_ENTER,
      JVMTI_THREAD_STATE_IN_OBJECT_WAIT
  };
  
<span class="line-modified">! static void</span>
<span class="line-modified">! lock(const char* func_name, jrawMonitorID lock) {</span>
<span class="line-modified">!     jvmtiError err = jvmti-&gt;RawMonitorEnter(lock);</span>
      if (err != JVMTI_ERROR_NONE) {
<span class="line-modified">!         printf(&quot;%s: unexpected error in RawMonitorEnter: %s (%d)\n&quot;,</span>
<span class="line-modified">!                func_name, TranslateError(err), err);</span>
          result = STATUS_FAILED;
      }
  }
  
<span class="line-modified">! static void</span>
<span class="line-modified">! unlock(const char* func_name, jrawMonitorID lock) {</span>
<span class="line-modified">!     jvmtiError err = jvmti-&gt;RawMonitorExit(lock);</span>
      if (err != JVMTI_ERROR_NONE) {
<span class="line-modified">!         printf(&quot;%s: unexpected error in RawMonitorExit: %s (%d)\n&quot;,</span>
<span class="line-modified">!                func_name, TranslateError(err), err);</span>
          result = STATUS_FAILED;
      }
  }
  
<span class="line-modified">! static void</span>
<span class="line-modified">! wait(const char* func_name, jrawMonitorID lock, jint millis) {</span>
<span class="line-modified">!     jvmtiError err = jvmti-&gt;RawMonitorWait(lock, (jlong)millis);</span>
      if (err != JVMTI_ERROR_NONE) {
<span class="line-modified">!         printf(&quot;%s: unexpected error in RawMonitorWait: %s (%d)\n&quot;,</span>
<span class="line-modified">!                func_name, TranslateError(err), err);</span>
          result = STATUS_FAILED;
      }
<span class="line-added">+ }</span>
  
<span class="line-modified">! static void</span>
<span class="line-modified">! set_notification_mode(const char* event_name,</span>
<span class="line-modified">!                       jvmtiEventMode mode,</span>
<span class="line-modified">!                       jvmtiEvent event_type,</span>
<span class="line-modified">!                       jthread event_thread) {</span>
<span class="line-modified">!     const char* action = (mode == JVMTI_ENABLE) ? &quot;enable&quot; : &quot;disable&quot;;</span>
<span class="line-modified">!     jvmtiError err = jvmti-&gt;SetEventNotificationMode(mode, event_type, event_thread);</span>
  
      if (err != JVMTI_ERROR_NONE) {
<span class="line-modified">!         printf(&quot;Failed to %s %s event: %s (%d)\n&quot;,</span>
<span class="line-modified">!                action, event_name, TranslateError(err), err);</span>
          result = STATUS_FAILED;
      }
<span class="line-added">+ }</span>
  
<span class="line-added">+ void JNICALL VMInit(jvmtiEnv *jvmti_env, JNIEnv *env, jthread thr) {</span>
<span class="line-added">+     set_notification_mode(&quot;JVMTI_EVENT_THREAD_START&quot;, JVMTI_ENABLE,</span>
<span class="line-added">+                           JVMTI_EVENT_THREAD_START, NULL);</span>
  }
  
<span class="line-modified">! void JNICALL</span>
<span class="line-modified">! ThreadStart(jvmtiEnv *jvmti_env, JNIEnv *env, jthread thread) {</span>
      jvmtiError err;
      jvmtiThreadInfo thrInfo;
  
<span class="line-modified">!     lock(&quot;ThreadStart&quot;, access_lock);</span>
  
<span class="line-modified">!     err = jvmti_env-&gt;GetThreadInfo(thread, &amp;thrInfo);</span>
      if (err != JVMTI_ERROR_NONE) {
<span class="line-modified">!         printf(&quot;(GetThreadInfo#TS) unexpected error: %s (%d)\n&quot;,</span>
<span class="line-modified">!                TranslateError(err), err);</span>
          result = STATUS_FAILED;
      }
<span class="line-modified">!     if (thrInfo.name != NULL &amp;&amp; strcmp(thrInfo.name, &quot;thr1&quot;) == 0) {</span>
<span class="line-modified">!         thr_ptr = env-&gt;NewGlobalRef(thread);</span>
<span class="line-modified">!         printf(&quot;&gt;&gt;&gt; ThreadStart: \&quot;%s\&quot;, 0x%p\n&quot;, thrInfo.name, thr_ptr);</span>
<span class="line-modified">!         set_notification_mode(&quot;JVMTI_EVENT_THREAD_START&quot;, JVMTI_DISABLE,</span>
<span class="line-modified">!                               JVMTI_EVENT_THREAD_START, NULL);</span>
      }
  
<span class="line-modified">!     unlock(&quot;ThreadStart&quot;, access_lock);</span>
  }
  
  #ifdef STATIC_BUILD
  JNIEXPORT jint JNICALL Agent_OnLoad_thrstat001(JavaVM *jvm, char *options, void *reserved) {
      return Agent_Initialize(jvm, options, reserved);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 221,17 ***</span>
  }
  JNIEXPORT jint JNI_OnLoad_thrstat001(JavaVM *jvm, char *options, void *reserved) {
      return JNI_VERSION_1_8;
  }
  #endif
  jint  Agent_Initialize(JavaVM *jvm, char *options, void *reserved) {
      jint res;
      jvmtiError err;
  
<span class="line-modified">!     if (options != NULL &amp;&amp; strcmp(options, &quot;printdump&quot;) == 0) {</span>
<span class="line-removed">-         printdump = JNI_TRUE;</span>
<span class="line-removed">-     }</span>
  
      res = jvm-&gt;GetEnv((void **) &amp;jvmti, JVMTI_VERSION_1_1);
      if (res != JNI_OK || jvmti == NULL) {
          printf(&quot;Wrong result of a valid call to GetEnv!\n&quot;);
          return JNI_ERR;
<span class="line-new-header">--- 131,16 ---</span>
  }
  JNIEXPORT jint JNI_OnLoad_thrstat001(JavaVM *jvm, char *options, void *reserved) {
      return JNI_VERSION_1_8;
  }
  #endif
<span class="line-added">+ </span>
  jint  Agent_Initialize(JavaVM *jvm, char *options, void *reserved) {
      jint res;
      jvmtiError err;
  
<span class="line-modified">!     printf(&quot;Agent_Initialize started\n&quot;);</span>
  
      res = jvm-&gt;GetEnv((void **) &amp;jvmti, JVMTI_VERSION_1_1);
      if (res != JNI_OK || jvmti == NULL) {
          printf(&quot;Wrong result of a valid call to GetEnv!\n&quot;);
          return JNI_ERR;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 258,53 ***</span>
          return JNI_ERR;
      }
  
      err = jvmti-&gt;CreateRawMonitor(&quot;_access_lock&quot;, &amp;access_lock);
      if (err != JVMTI_ERROR_NONE) {
<span class="line-modified">!         printf(&quot;(CreateRawMonitor) unexpected error: %s (%d)\n&quot;,</span>
                 TranslateError(err), err);
          return JNI_ERR;
      }
  
      callbacks.VMInit = &amp;VMInit;
      callbacks.ThreadStart = &amp;ThreadStart;
<span class="line-removed">-     if (caps.can_generate_method_entry_events) {</span>
<span class="line-removed">-         callbacks.MethodEntry = &amp;MethodEntry;</span>
<span class="line-removed">-     } else {</span>
<span class="line-removed">-         printf(&quot;Warning: MethodEntry event is not implemented\n&quot;);</span>
<span class="line-removed">-     }</span>
<span class="line-removed">-     if (caps.can_generate_method_exit_events) {</span>
<span class="line-removed">-         callbacks.MethodExit = &amp;MethodExit;</span>
<span class="line-removed">-     } else {</span>
<span class="line-removed">-         printf(&quot;Warning: MethodExit event is not implemented\n&quot;);</span>
<span class="line-removed">-     }</span>
      err = jvmti-&gt;SetEventCallbacks(&amp;callbacks, sizeof(callbacks));
      if (err != JVMTI_ERROR_NONE) {
          printf(&quot;(SetEventCallbacks) unexpected error: %s (%d)\n&quot;,
                 TranslateError(err), err);
          return JNI_ERR;
      }
  
<span class="line-modified">!     err = jvmti-&gt;SetEventNotificationMode(JVMTI_ENABLE,</span>
<span class="line-modified">!         JVMTI_EVENT_VM_INIT, NULL);</span>
<span class="line-removed">-     if (err != JVMTI_ERROR_NONE) {</span>
<span class="line-removed">-         printf(&quot;Failed to enable VM_INIT event: %s (%d)\n&quot;,</span>
<span class="line-removed">-                TranslateError(err), err);</span>
<span class="line-removed">-         result = STATUS_FAILED;</span>
<span class="line-removed">-     }</span>
  
      return JNI_OK;
  }
  
  JNIEXPORT void JNICALL
  Java_nsk_jvmti_GetThreadState_thrstat001_checkStatus(JNIEnv *env,
          jclass cls, jint statInd) {
      jvmtiError err;
<span class="line-removed">-     jrawMonitorID wait_lock;</span>
      jint thrState;
      jint millis;
  
      if (jvmti == NULL) {
          printf(&quot;JVMTI client was not properly loaded!\n&quot;);
          result = STATUS_FAILED;
          return;
      }
<span class="line-new-header">--- 167,46 ---</span>
          return JNI_ERR;
      }
  
      err = jvmti-&gt;CreateRawMonitor(&quot;_access_lock&quot;, &amp;access_lock);
      if (err != JVMTI_ERROR_NONE) {
<span class="line-modified">!         printf(&quot;(CreateRawMonitor)#access_lock unexpected error: %s (%d)\n&quot;,</span>
<span class="line-added">+                TranslateError(err), err);</span>
<span class="line-added">+         return JNI_ERR;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     err = jvmti-&gt;CreateRawMonitor(&quot;_wait_lock&quot;, &amp;wait_lock);</span>
<span class="line-added">+     if (err != JVMTI_ERROR_NONE) {</span>
<span class="line-added">+         printf(&quot;(CreateRawMonitor#wait_lock) unexpected error: %s (%d)\n&quot;,</span>
                 TranslateError(err), err);
          return JNI_ERR;
      }
  
      callbacks.VMInit = &amp;VMInit;
      callbacks.ThreadStart = &amp;ThreadStart;
      err = jvmti-&gt;SetEventCallbacks(&amp;callbacks, sizeof(callbacks));
      if (err != JVMTI_ERROR_NONE) {
          printf(&quot;(SetEventCallbacks) unexpected error: %s (%d)\n&quot;,
                 TranslateError(err), err);
          return JNI_ERR;
      }
  
<span class="line-modified">!     set_notification_mode(&quot;JVMTI_EVENT_VM_INIT&quot;, JVMTI_ENABLE,</span>
<span class="line-modified">!                           JVMTI_EVENT_VM_INIT, NULL);</span>
  
<span class="line-added">+     printf(&quot;Agent_Initialize finished\n\n&quot;);</span>
      return JNI_OK;
  }
  
  JNIEXPORT void JNICALL
  Java_nsk_jvmti_GetThreadState_thrstat001_checkStatus(JNIEnv *env,
          jclass cls, jint statInd) {
      jvmtiError err;
      jint thrState;
      jint millis;
  
<span class="line-added">+     printf(&quot;native method checkStatus started\n&quot;);</span>
      if (jvmti == NULL) {
          printf(&quot;JVMTI client was not properly loaded!\n&quot;);
          result = STATUS_FAILED;
          return;
      }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 314,113 ***</span>
          result = STATUS_FAILED;
          return;
      }
  
      /* wait until thread gets an expected state */
<span class="line-removed">-     err = jvmti-&gt;CreateRawMonitor(&quot;_wait_lock&quot;, &amp;wait_lock);</span>
<span class="line-removed">-     if (err != JVMTI_ERROR_NONE) {</span>
<span class="line-removed">-         printf(&quot;(CreateRawMonitor) unexpected error: %s (%d)\n&quot;,</span>
<span class="line-removed">-                TranslateError(err), err);</span>
<span class="line-removed">-         result = STATUS_FAILED;</span>
<span class="line-removed">-     }</span>
      for (millis = WAIT_START; millis &lt; WAIT_TIME; millis &lt;&lt;= 1) {
          err = jvmti-&gt;GetThreadState(thr_ptr, &amp;thrState);
          if (err != JVMTI_ERROR_NONE) {
              printf(&quot;(GetThreadState#%d) unexpected error: %s (%d)\n&quot;,
                  statInd, TranslateError(err), err);
              result = STATUS_FAILED;
          }
          if ((thrState &amp; state[statInd]) != 0) {
              break;
          }
<span class="line-modified">!         err = jvmti-&gt;RawMonitorEnter(wait_lock);</span>
<span class="line-modified">!         if (err != JVMTI_ERROR_NONE) {</span>
<span class="line-modified">!             printf(&quot;(RawMonitorEnter) unexpected error: %s (%d)\n&quot;,</span>
<span class="line-removed">-                    TranslateError(err), err);</span>
<span class="line-removed">-             result = STATUS_FAILED;</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-         err = jvmti-&gt;RawMonitorWait(wait_lock, (jlong)millis);</span>
<span class="line-removed">-         if (err != JVMTI_ERROR_NONE) {</span>
<span class="line-removed">-             printf(&quot;(RawMonitorWait) unexpected error: %s (%d)\n&quot;,</span>
<span class="line-removed">-                    TranslateError(err), err);</span>
<span class="line-removed">-             result = STATUS_FAILED;</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-         err = jvmti-&gt;RawMonitorExit(wait_lock);</span>
<span class="line-removed">-         if (err != JVMTI_ERROR_NONE) {</span>
<span class="line-removed">-             printf(&quot;(RawMonitorExit) unexpected error: %s (%d)\n&quot;,</span>
<span class="line-removed">-                    TranslateError(err), err);</span>
<span class="line-removed">-             result = STATUS_FAILED;</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-     }</span>
<span class="line-removed">-     err = jvmti-&gt;DestroyRawMonitor(wait_lock);</span>
<span class="line-removed">-     if (err != JVMTI_ERROR_NONE) {</span>
<span class="line-removed">-         printf(&quot;(DestroyRawMonitor) unexpected error: %s (%d)\n&quot;,</span>
<span class="line-removed">-                TranslateError(err), err);</span>
<span class="line-removed">-         result = STATUS_FAILED;</span>
      }
  
<span class="line-modified">!     if (printdump == JNI_TRUE) {</span>
<span class="line-removed">-         printf(&quot;&gt;&gt;&gt; thread \&quot;thr1\&quot; (0x%p) state: %s (%d)\n&quot;,</span>
              thr_ptr, TranslateState(thrState), thrState);
<span class="line-removed">-     }</span>
  
      if ((thrState &amp; state[statInd]) == 0) {
          printf(&quot;Wrong thread \&quot;thr1\&quot; (0x%p) state:\n&quot;, thr_ptr);
          printf(&quot;    expected: %s (%d)\n&quot;,
              TranslateState(state[statInd]), state[statInd]);
          printf(&quot;      actual: %s (%d)\n&quot;,
              TranslateState(thrState), thrState);
          result = STATUS_FAILED;
      }
  }
  
  JNIEXPORT jint JNICALL
  Java_nsk_jvmti_GetThreadState_thrstat001_getRes(JNIEnv *env, jclass cls) {
<span class="line-modified">!     jvmtiError err;</span>
<span class="line-removed">- </span>
<span class="line-removed">-     err = jvmti-&gt;SetEventNotificationMode(JVMTI_DISABLE,</span>
<span class="line-removed">-         JVMTI_EVENT_THREAD_START, NULL);</span>
<span class="line-removed">-     if (err != JVMTI_ERROR_NONE) {</span>
<span class="line-removed">-         printf(&quot;Failed to disable THREAD_START event: %s (%d)\n&quot;,</span>
<span class="line-removed">-                TranslateError(err), err);</span>
<span class="line-removed">-         result = STATUS_FAILED;</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     if (caps.can_generate_method_entry_events) {</span>
<span class="line-removed">-         err = jvmti-&gt;SetEventNotificationMode(JVMTI_DISABLE,</span>
<span class="line-removed">-             JVMTI_EVENT_METHOD_ENTRY, NULL);</span>
<span class="line-removed">-         if (err != JVMTI_ERROR_NONE) {</span>
<span class="line-removed">-             printf(&quot;Failed to disable METHOD_ENTRY event: %s (%d)\n&quot;,</span>
<span class="line-removed">-                    TranslateError(err), err);</span>
<span class="line-removed">-             result = STATUS_FAILED;</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     if (caps.can_generate_method_exit_events) {</span>
<span class="line-removed">-         err = jvmti-&gt;SetEventNotificationMode(JVMTI_DISABLE,</span>
<span class="line-removed">-             JVMTI_EVENT_METHOD_EXIT, NULL);</span>
<span class="line-removed">-         if (err != JVMTI_ERROR_NONE) {</span>
<span class="line-removed">-             printf(&quot;Failed to disable METHOD_EXIT event: %s (%d)\n&quot;,</span>
<span class="line-removed">-                    TranslateError(err), err);</span>
<span class="line-removed">-             result = STATUS_FAILED;</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     if (printdump == JNI_TRUE) {</span>
<span class="line-removed">-         printf(&quot;&gt;&gt;&gt; total number of method entry events = %d\n&quot;, entry_count);</span>
<span class="line-removed">-         printf(&quot;&gt;&gt;&gt; total number of method exit events = %d\n&quot;, exit_count);</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     if (entry_error_count != 0) {</span>
<span class="line-removed">-         printf(&quot;Total number of errors on METHOD_ENTRY: %d of %d events\n&quot;,</span>
<span class="line-removed">-                entry_error_count, entry_count);</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     if (exit_error_count != 0) {</span>
<span class="line-removed">-         printf(&quot;Total number of errors on METHOD_EXIT: %d of %d events\n&quot;,</span>
<span class="line-removed">-                exit_error_count, exit_count);</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
      return result;
  }
  
  }
<span class="line-new-header">--- 216,41 ---</span>
          result = STATUS_FAILED;
          return;
      }
  
      /* wait until thread gets an expected state */
      for (millis = WAIT_START; millis &lt; WAIT_TIME; millis &lt;&lt;= 1) {
          err = jvmti-&gt;GetThreadState(thr_ptr, &amp;thrState);
          if (err != JVMTI_ERROR_NONE) {
              printf(&quot;(GetThreadState#%d) unexpected error: %s (%d)\n&quot;,
                  statInd, TranslateError(err), err);
              result = STATUS_FAILED;
          }
          if ((thrState &amp; state[statInd]) != 0) {
              break;
          }
<span class="line-modified">!         lock(&quot;checkStatus&quot;, wait_lock);</span>
<span class="line-modified">!         wait(&quot;checkStatus&quot;, wait_lock, millis);</span>
<span class="line-modified">!         unlock(&quot;checkStatus&quot;, wait_lock);</span>
      }
  
<span class="line-modified">!     printf(&quot;&gt;&gt;&gt; thread \&quot;thr1\&quot; (0x%p) state: %s (%d)\n&quot;,</span>
              thr_ptr, TranslateState(thrState), thrState);
  
      if ((thrState &amp; state[statInd]) == 0) {
          printf(&quot;Wrong thread \&quot;thr1\&quot; (0x%p) state:\n&quot;, thr_ptr);
          printf(&quot;    expected: %s (%d)\n&quot;,
              TranslateState(state[statInd]), state[statInd]);
          printf(&quot;      actual: %s (%d)\n&quot;,
              TranslateState(thrState), thrState);
          result = STATUS_FAILED;
      }
<span class="line-added">+     printf(&quot;native method checkStatus finished\n\n&quot;);</span>
  }
  
  JNIEXPORT jint JNICALL
  Java_nsk_jvmti_GetThreadState_thrstat001_getRes(JNIEnv *env, jclass cls) {
<span class="line-modified">!     printf(&quot;native method getRes: result: %d\n\n&quot;, result);</span>
      return result;
  }
  
  }
</pre>
<center><a href="../../FramePop/framepop002/framepop002.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../../GetTime/gettime001/gettime001.cpp.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>