<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/hotspot/jtreg/vmTestbase/nsk/jvmti/scenarios/events/EM01/em01t001/em01t001.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../contention/TC05/tc05t001/tc05t001.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="libem01t001.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/jtreg/vmTestbase/nsk/jvmti/scenarios/events/EM01/em01t001/em01t001.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2004, 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 #include &lt;string.h&gt;
 25 #include &quot;jvmti.h&quot;
 26 #include &quot;agent_common.h&quot;

 27 #include &quot;jni_tools.h&quot;
 28 #include &quot;jvmti_tools.h&quot;
 29 #include &quot;JVMTITools.h&quot;
 30 
 31 extern &quot;C&quot; {
 32 
 33 /* ============================================================================= */
 34 
 35 /* scaffold objects */
 36 static JNIEnv* jni = NULL;
 37 static jvmtiEnv *jvmti = NULL;
 38 static jlong timeout = 0;
 39 static jrawMonitorID syncLock = NULL;
 40 
 41 /* constant names */
 42 #define JVMTI_EVENT_COUNT   (int)(JVMTI_MAX_EVENT_TYPE_VAL - JVMTI_MIN_EVENT_TYPE_VAL + 1)
 43 #define EXPECTED_CLASS_NAME &quot;Lnsk/jvmti/scenarios/events/EM01/em01t001a;&quot;
 44 #define CLASS_LOADER_COUNT_PARAM &quot;classLoaderCount&quot;
 45 
 46 static int eventCount[JVMTI_EVENT_COUNT];
</pre>
<hr />
<pre>
118         NSK_COMPLAIN4(&quot;%25s was sent during %s(%d)\n\tclass: %s\n&quot;,
119                     TranslateEvent(event),
120                     TranslatePhase(phase),
121                     phase,
122                     className);
123         nsk_jvmti_setFailStatus();
124     }
125 
126     if (!NSK_JVMTI_VERIFY(jvmti_env-&gt;Deallocate((unsigned char*)className))) {
127         nsk_jvmti_setFailStatus();
128     }
129     if (generic != NULL)
130         if (!NSK_JVMTI_VERIFY(jvmti_env-&gt;Deallocate((unsigned char*)generic))) {
131             nsk_jvmti_setFailStatus();
132         }
133 }
134 
135 void
136 threadEventHandler(jvmtiEvent event, jvmtiEnv* jvmti_env, JNIEnv* jni_env,
137                             jthread thread) {

138     jclass classObject;
139     char *className;
140     char *generic;
141     jvmtiPhase phase;
142 
<span class="line-modified">143 </span>
<span class="line-removed">144     classObject = jni_env-&gt;GetObjectClass(thread);</span>
<span class="line-removed">145     if (!NSK_JNI_VERIFY(jni_env, classObject != NULL)) {</span>
<span class="line-removed">146         nsk_jvmti_setFailStatus();</span>
<span class="line-removed">147         return;</span>
<span class="line-removed">148     }</span>
149 
150     if (!NSK_JVMTI_VERIFY(jvmti_env-&gt;GetClassSignature(classObject, &amp;className, &amp;generic))) {
151         nsk_jvmti_setFailStatus();
152         return;
153     }
154 
155     if (strcmp(className, EXPECTED_CLASS_NAME) == 0) {
156         changeCount(event);
157         NSK_DISPLAY3(&quot;%25s(%4d)&gt;&gt;\tclass: %s\n&quot;,
158                             TranslateEvent(event),
159                             eventCount[event - JVMTI_MIN_EVENT_TYPE_VAL],
160                             className);
161     }
162 
163     if (!NSK_JVMTI_VERIFY(jvmti_env-&gt;GetPhase(&amp;phase))) {
164         nsk_jvmti_setFailStatus();
165     }
166 
167     if (phase != currentPhase) {
168         NSK_DISPLAY2(&quot;Unexpected phase %s, but supposed %s&quot;,
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2004, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 #include &lt;string.h&gt;
 25 #include &quot;jvmti.h&quot;
 26 #include &quot;agent_common.h&quot;
<span class="line-added"> 27 #include &quot;ExceptionCheckingJniEnv.hpp&quot;</span>
 28 #include &quot;jni_tools.h&quot;
 29 #include &quot;jvmti_tools.h&quot;
 30 #include &quot;JVMTITools.h&quot;
 31 
 32 extern &quot;C&quot; {
 33 
 34 /* ============================================================================= */
 35 
 36 /* scaffold objects */
 37 static JNIEnv* jni = NULL;
 38 static jvmtiEnv *jvmti = NULL;
 39 static jlong timeout = 0;
 40 static jrawMonitorID syncLock = NULL;
 41 
 42 /* constant names */
 43 #define JVMTI_EVENT_COUNT   (int)(JVMTI_MAX_EVENT_TYPE_VAL - JVMTI_MIN_EVENT_TYPE_VAL + 1)
 44 #define EXPECTED_CLASS_NAME &quot;Lnsk/jvmti/scenarios/events/EM01/em01t001a;&quot;
 45 #define CLASS_LOADER_COUNT_PARAM &quot;classLoaderCount&quot;
 46 
 47 static int eventCount[JVMTI_EVENT_COUNT];
</pre>
<hr />
<pre>
119         NSK_COMPLAIN4(&quot;%25s was sent during %s(%d)\n\tclass: %s\n&quot;,
120                     TranslateEvent(event),
121                     TranslatePhase(phase),
122                     phase,
123                     className);
124         nsk_jvmti_setFailStatus();
125     }
126 
127     if (!NSK_JVMTI_VERIFY(jvmti_env-&gt;Deallocate((unsigned char*)className))) {
128         nsk_jvmti_setFailStatus();
129     }
130     if (generic != NULL)
131         if (!NSK_JVMTI_VERIFY(jvmti_env-&gt;Deallocate((unsigned char*)generic))) {
132             nsk_jvmti_setFailStatus();
133         }
134 }
135 
136 void
137 threadEventHandler(jvmtiEvent event, jvmtiEnv* jvmti_env, JNIEnv* jni_env,
138                             jthread thread) {
<span class="line-added">139     ExceptionCheckingJniEnvPtr ec_jni(jni_env);</span>
140     jclass classObject;
141     char *className;
142     char *generic;
143     jvmtiPhase phase;
144 
<span class="line-modified">145     classObject = ec_jni-&gt;GetObjectClass(thread, TRACE_JNI_CALL);</span>





146 
147     if (!NSK_JVMTI_VERIFY(jvmti_env-&gt;GetClassSignature(classObject, &amp;className, &amp;generic))) {
148         nsk_jvmti_setFailStatus();
149         return;
150     }
151 
152     if (strcmp(className, EXPECTED_CLASS_NAME) == 0) {
153         changeCount(event);
154         NSK_DISPLAY3(&quot;%25s(%4d)&gt;&gt;\tclass: %s\n&quot;,
155                             TranslateEvent(event),
156                             eventCount[event - JVMTI_MIN_EVENT_TYPE_VAL],
157                             className);
158     }
159 
160     if (!NSK_JVMTI_VERIFY(jvmti_env-&gt;GetPhase(&amp;phase))) {
161         nsk_jvmti_setFailStatus();
162     }
163 
164     if (phase != currentPhase) {
165         NSK_DISPLAY2(&quot;Unexpected phase %s, but supposed %s&quot;,
</pre>
</td>
</tr>
</table>
<center><a href="../../../contention/TC05/tc05t001/tc05t001.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="libem01t001.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>