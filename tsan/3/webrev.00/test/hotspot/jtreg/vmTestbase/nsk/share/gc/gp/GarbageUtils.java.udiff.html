<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/hotspot/jtreg/vmTestbase/nsk/share/gc/gp/GarbageUtils.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../README.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../lock/jni/BooleanArrayCriticalLocker.cpp.udiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/jtreg/vmTestbase/nsk/share/gc/gp/GarbageUtils.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2007, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2007, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -24,10 +24,11 @@</span>
  package nsk.share.gc.gp;
  
  import java.io.IOException;
  import java.io.PrintWriter;
  import java.io.StringWriter;
<span class="udiff-line-added">+ import java.lang.invoke.*;</span>
  import java.util.*;
  import nsk.share.gc.gp.array.*;
  import nsk.share.gc.gp.string.*;
  import nsk.share.gc.gp.list.*;
  import nsk.share.gc.gp.tree.*;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -55,14 +56,14 @@</span>
              OOM_TYPE(String... expectedStrings) {
                  this.expectedStrings = expectedStrings;
              }
  
              /**
<span class="udiff-line-modified-removed">-                          * Returns true if the given error message matches</span>
<span class="udiff-line-modified-removed">-                          * one of expected strings.</span>
<span class="udiff-line-modified-removed">-                          */</span>
<span class="udiff-line-modified-removed">-                         public boolean accept(String errorMessage) {</span>
<span class="udiff-line-modified-added">+              * Returns true if the given error message matches</span>
<span class="udiff-line-modified-added">+              * one of expected strings.</span>
<span class="udiff-line-modified-added">+              */</span>
<span class="udiff-line-modified-added">+             public boolean accept(String errorMessage) {</span>
                  if (expectedStrings == null || expectedStrings.length == 0 || errorMessage == null) {
                      return true;
                  }
                  for (String s: expectedStrings) {
                      if (errorMessage.indexOf(s) != -1) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -71,17 +72,18 @@</span>
                  }
                  return false;
              }
          };
  
<span class="udiff-line-modified-removed">-         // Force loading of OOM_TYPE and calling of enum contrusctors when loading GarbageUtils class.</span>
<span class="udiff-line-modified-added">+         // Force loading of OOM_TYPE and calling of enum constructors when loading GarbageUtils class.</span>
          public static final Object[] thisIsGarbageArray_theOnlyPurposeForCreatingItAndDeclaringItPublicIsToInitializeIntancesOfOOMEnumberation = new Object[] { OOM_TYPE.ANY, OOM_TYPE.HEAP, OOM_TYPE.METASPACE };
  
          // Force early loading of classes that might otherwise unexpectedly fail
          // class loading during testing due to high memory pressure.
          public static final StringWriter preloadStringWriter = new StringWriter(1);
          public static final PrintWriter preloadPrintWriter = new PrintWriter(preloadStringWriter);
<span class="udiff-line-added">+         public static final Throwable preloadThrowable = new Throwable(&quot;preload&quot;);</span>
  
          private GarbageUtils() {
          }
  
          /**
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -191,10 +193,40 @@</span>
           */
          public static int eatMemory(ExecutionController stresser, GarbageProducer gp, long initialFactor, long minMemoryChunk, long factor) {
              return eatMemory(stresser, gp, initialFactor, minMemoryChunk, factor, OOM_TYPE.ANY);
          }
  
<span class="udiff-line-added">+          static int numberOfOOMEs = 0;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+          /**</span>
<span class="udiff-line-added">+           * Minimal wrapper of the main implementation. Catches any OOM</span>
<span class="udiff-line-added">+           * that might be thrown when rematerializing Objects when deoptimizing.</span>
<span class="udiff-line-added">+           *</span>
<span class="udiff-line-added">+           * It is Important that the impl is not inlined.</span>
<span class="udiff-line-added">+           */</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+          public static int eatMemory(ExecutionController stresser, GarbageProducer gp, long initialFactor, long minMemoryChunk, long factor, OOM_TYPE type) {</span>
<span class="udiff-line-added">+             try {</span>
<span class="udiff-line-added">+                // Using a methodhandle invoke of eatMemoryImpl to prevent inlining of it</span>
<span class="udiff-line-added">+                MethodHandles.Lookup lookup = MethodHandles.lookup();</span>
<span class="udiff-line-added">+                MethodType mt = MethodType.methodType(</span>
<span class="udiff-line-added">+                      int.class,</span>
<span class="udiff-line-added">+                      ExecutionController.class,</span>
<span class="udiff-line-added">+                      GarbageProducer.class,</span>
<span class="udiff-line-added">+                      long.class,</span>
<span class="udiff-line-added">+                      long.class,</span>
<span class="udiff-line-added">+                      long.class,</span>
<span class="udiff-line-added">+                      OOM_TYPE.class);</span>
<span class="udiff-line-added">+                MethodHandle eat = lookup.findStatic(GarbageUtils.class, &quot;eatMemoryImpl&quot;, mt);</span>
<span class="udiff-line-added">+                return (int) eat.invoke(stresser, gp, initialFactor, minMemoryChunk, factor, type);</span>
<span class="udiff-line-added">+             } catch (OutOfMemoryError e) {</span>
<span class="udiff-line-added">+                return numberOfOOMEs++;</span>
<span class="udiff-line-added">+             } catch (Throwable t) {</span>
<span class="udiff-line-added">+                throw new RuntimeException(t);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+          }</span>
<span class="udiff-line-added">+ </span>
          /**
           * Eat memory using given garbage producer.
           *
           * Note that this method can throw Failure if any exception
           * is thrown while eating memory. To avoid OOM while allocating
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -208,15 +240,14 @@</span>
           * @param minMemoryChunk determines when to stop
           * @param factor factor to divide the array size by. A value of 0 means that method returns after first  OOME
           * @param type of OutOfMemory Exception: Java heap space or Metadata space
           * @return number of OOME occured
           */
<span class="udiff-line-modified-removed">-         public static int eatMemory(ExecutionController stresser, GarbageProducer gp, long initialFactor, long minMemoryChunk, long factor, OOM_TYPE type) {</span>
<span class="udiff-line-modified-removed">-                 int numberOfOOMEs = 0;</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+          public static int eatMemoryImpl(ExecutionController stresser, GarbageProducer gp, long initialFactor, long minMemoryChunk, long factor, OOM_TYPE type) {</span>
<span class="udiff-line-added">+                 numberOfOOMEs = 0;</span>
                  try {
<span class="udiff-line-removed">-                         StringWriter sw = new StringWriter(10000);</span>
<span class="udiff-line-removed">-                         PrintWriter pw = new PrintWriter(sw);</span>
                          byte[] someMemory = new byte[200000]; //200 Kb
                          try {
                                  Runtime runtime = Runtime.getRuntime();
                                  long maxMemory = runtime.maxMemory();
                                  long maxMemoryChunk = maxMemory / initialFactor;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -239,17 +270,15 @@</span>
                                                      allocations = 0;
                                                  }
                                          } catch (OutOfMemoryError e) {
                                              someMemory = null;
                                              if (type != OOM_TYPE.ANY) {
<span class="udiff-line-modified-removed">-                                                 e.printStackTrace(pw);</span>
<span class="udiff-line-removed">-                                                 pw.close();</span>
<span class="udiff-line-removed">-                                                 if (type.accept(sw.toString())) {</span>
<span class="udiff-line-modified-added">+                                                 if (type.accept(e.toString())) {</span>
                                                      numberOfOOMEs++;
                                                  } else {
                                                      // Trying to catch situation when Java generates OOM different type that test trying to catch
<span class="udiff-line-modified-removed">-                                                     throw new TestBug(&quot;Test throw OOM of unexpected type.&quot; + sw.toString());</span>
<span class="udiff-line-modified-added">+                                                     throw new TestBug(&quot;Test throw OOM of unexpected type.&quot; + e.toString());</span>
                                                  }
                                              } else {
                                                 numberOfOOMEs++;
                                              }
                                              allocations = 0;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -261,17 +290,15 @@</span>
                                          }
                                  }
                          } catch (OutOfMemoryError e) {
                              someMemory = null;
                              if (type != OOM_TYPE.ANY) {
<span class="udiff-line-modified-removed">-                                 e.printStackTrace(pw);</span>
<span class="udiff-line-removed">-                                 pw.close();</span>
<span class="udiff-line-removed">-                                 if (type.accept(sw.toString())) {</span>
<span class="udiff-line-modified-added">+                                 if (type.accept(e.toString())) {</span>
                                      numberOfOOMEs++;
                                  } else {
                                      // Trying to catch situation when Java generates OOM different type that test trying to catch
<span class="udiff-line-modified-removed">-                                     throw new TestBug(&quot;Test throw OOM of unexpected type.&quot; + sw.toString());</span>
<span class="udiff-line-modified-added">+                                     throw new TestBug(&quot;Test throw OOM of unexpected type.&quot; + e.toString());</span>
                                  }
                              } else {
                                  numberOfOOMEs++;
                              }
                           // all memory is eaten now even before we start, just return
</pre>
<center><a href="../../README.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../lock/jni/BooleanArrayCriticalLocker.cpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>