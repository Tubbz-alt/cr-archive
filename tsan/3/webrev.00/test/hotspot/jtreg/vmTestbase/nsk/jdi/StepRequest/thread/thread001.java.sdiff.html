<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/hotspot/jtreg/vmTestbase/nsk/jdi/StepRequest/thread/thread001.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../size/size002.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../../ThreadDeathRequest/addThreadFilter/addthreadfilter001.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/jtreg/vmTestbase/nsk/jdi/StepRequest/thread/thread001.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
135 
136     //====================================================== test program
137     //------------------------------------------------------ common section
138 
139     static Debugee          debuggee;
140     static ArgumentHandler  argsHandler;
141 
142     static int waitTime;
143 
144     static VirtualMachine      vm            = null;
145     static EventRequestManager eventRManager = null;
146     static EventQueue          eventQueue    = null;
147     static EventSet            eventSet      = null;
148     static EventIterator       eventIterator = null;
149 
150     static ReferenceType       debuggeeClass = null;
151 
152     static int  testExitCode = PASSED;
153 
154 
<span class="line-removed">155     class JDITestRuntimeException extends RuntimeException {</span>
<span class="line-removed">156         JDITestRuntimeException(String str) {</span>
<span class="line-removed">157             super(&quot;JDITestRuntimeException : &quot; + str);</span>
<span class="line-removed">158         }</span>
<span class="line-removed">159     }</span>
<span class="line-removed">160 </span>
161     //------------------------------------------------------ methods
162 
163     private int runThis (String argv[], PrintStream out) {
164 
165         argsHandler     = new ArgumentHandler(argv);
166         logHandler      = new Log(out, argsHandler);
167         Binder binder   = new Binder(argsHandler, logHandler);
168 
169         waitTime        = argsHandler.getWaitTime() * 60000;
170 
171         try {
172             log2(&quot;launching a debuggee :&quot;);
173             log2(&quot;       &quot; + debuggeeName);
174             if (argsHandler.verbose()) {
175                 debuggee = binder.bindToDebugee(debuggeeName + &quot; -vbs&quot;);
176             } else {
177                 debuggee = binder.bindToDebugee(debuggeeName);
178             }
179             if (debuggee == null) {
180                 log3(&quot;ERROR: no debuggee launched&quot;);
</pre>
<hr />
<pre>
283         ClassPrepareRequest cpRequest = eventRManager.createClassPrepareRequest();
284         cpRequest.setSuspendPolicy( EventRequest.SUSPEND_EVENT_THREAD);
285         cpRequest.addClassFilter(debuggeeName);
286 
287         cpRequest.enable();
288         vm.resume();
289         getEventSet();
290         cpRequest.disable();
291 
292         ClassPrepareEvent event = (ClassPrepareEvent) eventIterator.next();
293         debuggeeClass = event.referenceType();
294 
295         if (!debuggeeClass.name().equals(debuggeeName))
296            throw new JDITestRuntimeException(&quot;** Unexpected ClassName for ClassPrepareEvent **&quot;);
297 
298         log2(&quot;      received: ClassPrepareEvent for debuggeeClass&quot;);
299 
300         String bPointMethod = &quot;methodForCommunication&quot;;
301         String lineForComm  = &quot;lineForComm&quot;;
302 
<span class="line-modified">303         ThreadReference   mainThread = threadByName(&quot;main&quot;);</span>
304 
305         BreakpointRequest bpRequest = settingBreakpoint(mainThread,
306                                              debuggeeClass,
307                                             bPointMethod, lineForComm, &quot;zero&quot;);
308         bpRequest.enable();
309 
310     //------------------------------------------------------  testing section
311 
312         log1(&quot;     TESTING BEGINS&quot;);
313 
314         EventRequest  eventRequest1 = null;
315 
316         ThreadReference thread1     = null;
317         String          threadName1 = &quot;thread1&quot;;
318 
319         ThreadReference thread2;
320 
321 
322         for (int i = 0; ; i++) {
323 
324             vm.resume();
325             breakpointForCommunication();
326 
327             int instruction = ((IntegerValue)
328                                (debuggeeClass.getValue(debuggeeClass.fieldByName(&quot;instruction&quot;)))).value();
329 
330             if (instruction == 0) {
331                 vm.resume();
332                 break;
333             }
334 
335 
336             log1(&quot;:::::: case: # &quot; + i);
337 
338             //~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ variable part
339 
340             switch (i) {
341 
342               case 0:
<span class="line-modified">343                      thread1 = threadByName(threadName1);</span>
344 
345                      log2(&quot;......setting up StepRequest with size StepRequest.STEP_MIN&quot;);
346                      eventRequest1 = setting24StepRequest(thread1, StepRequest.STEP_MIN,
347                                               StepRequest.STEP_INTO);
348 
349                      log2(&quot;......getting: size = ((StepRequest) eventRequest1).thread();&quot;);
350                      thread2 = ((StepRequest) eventRequest1).thread();
351 
352                      log2(&quot;      checking up on equality of values&quot;);
353                      if ( !thread2.equals(thread1) ) {
354                          testExitCode = FAILED;
355                          log3(&quot;ERROR: !thread2.equals(thread1) : &quot; + thread2);
356                      }
357 
358                       break;
359 
360               default:
361                       throw new JDITestRuntimeException(&quot;** default case 2 **&quot;);
362             }
363 
364             //~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
365         }
366         log1(&quot;    TESTING ENDS&quot;);
367         return;
368     }
369 
<span class="line-removed">370     private ThreadReference threadByName(String name)</span>
<span class="line-removed">371                  throws JDITestRuntimeException {</span>
<span class="line-removed">372 </span>
<span class="line-removed">373         List         all = vm.allThreads();</span>
<span class="line-removed">374         ListIterator li  = all.listIterator();</span>
<span class="line-removed">375 </span>
<span class="line-removed">376         for (; li.hasNext(); ) {</span>
<span class="line-removed">377             ThreadReference thread = (ThreadReference) li.next();</span>
<span class="line-removed">378             if (thread.name().equals(name))</span>
<span class="line-removed">379                 return thread;</span>
<span class="line-removed">380         }</span>
<span class="line-removed">381         throw new JDITestRuntimeException(&quot;** Thread IS NOT found ** : &quot; + name);</span>
<span class="line-removed">382     }</span>
<span class="line-removed">383 </span>
384    /*
385     * private BreakpointRequest settingBreakpoint(ThreadReference, ReferenceType,
386     *                                             String, String, String)
387     *
388     * It sets up a breakpoint at given line number within a given method in a given class
389     * for a given thread.
390     *
391     * Return value: BreakpointRequest object  in case of success
392     *
393     * JDITestRuntimeException   in case of an Exception thrown within the method
394     */
395 
396     private BreakpointRequest settingBreakpoint ( ThreadReference thread,
397                                                   ReferenceType testedClass,
398                                                   String methodName,
399                                                   String bpLine,
400                                                   String property)
401             throws JDITestRuntimeException {
402 
403         log2(&quot;......setting up a breakpoint:&quot;);
</pre>
</td>
<td>
<hr />
<pre>
135 
136     //====================================================== test program
137     //------------------------------------------------------ common section
138 
139     static Debugee          debuggee;
140     static ArgumentHandler  argsHandler;
141 
142     static int waitTime;
143 
144     static VirtualMachine      vm            = null;
145     static EventRequestManager eventRManager = null;
146     static EventQueue          eventQueue    = null;
147     static EventSet            eventSet      = null;
148     static EventIterator       eventIterator = null;
149 
150     static ReferenceType       debuggeeClass = null;
151 
152     static int  testExitCode = PASSED;
153 
154 






155     //------------------------------------------------------ methods
156 
157     private int runThis (String argv[], PrintStream out) {
158 
159         argsHandler     = new ArgumentHandler(argv);
160         logHandler      = new Log(out, argsHandler);
161         Binder binder   = new Binder(argsHandler, logHandler);
162 
163         waitTime        = argsHandler.getWaitTime() * 60000;
164 
165         try {
166             log2(&quot;launching a debuggee :&quot;);
167             log2(&quot;       &quot; + debuggeeName);
168             if (argsHandler.verbose()) {
169                 debuggee = binder.bindToDebugee(debuggeeName + &quot; -vbs&quot;);
170             } else {
171                 debuggee = binder.bindToDebugee(debuggeeName);
172             }
173             if (debuggee == null) {
174                 log3(&quot;ERROR: no debuggee launched&quot;);
</pre>
<hr />
<pre>
277         ClassPrepareRequest cpRequest = eventRManager.createClassPrepareRequest();
278         cpRequest.setSuspendPolicy( EventRequest.SUSPEND_EVENT_THREAD);
279         cpRequest.addClassFilter(debuggeeName);
280 
281         cpRequest.enable();
282         vm.resume();
283         getEventSet();
284         cpRequest.disable();
285 
286         ClassPrepareEvent event = (ClassPrepareEvent) eventIterator.next();
287         debuggeeClass = event.referenceType();
288 
289         if (!debuggeeClass.name().equals(debuggeeName))
290            throw new JDITestRuntimeException(&quot;** Unexpected ClassName for ClassPrepareEvent **&quot;);
291 
292         log2(&quot;      received: ClassPrepareEvent for debuggeeClass&quot;);
293 
294         String bPointMethod = &quot;methodForCommunication&quot;;
295         String lineForComm  = &quot;lineForComm&quot;;
296 
<span class="line-modified">297         ThreadReference   mainThread = debuggee.threadByNameOrThrow(&quot;main&quot;);</span>
298 
299         BreakpointRequest bpRequest = settingBreakpoint(mainThread,
300                                              debuggeeClass,
301                                             bPointMethod, lineForComm, &quot;zero&quot;);
302         bpRequest.enable();
303 
304     //------------------------------------------------------  testing section
305 
306         log1(&quot;     TESTING BEGINS&quot;);
307 
308         EventRequest  eventRequest1 = null;
309 
310         ThreadReference thread1     = null;
311         String          threadName1 = &quot;thread1&quot;;
312 
313         ThreadReference thread2;
314 
315 
316         for (int i = 0; ; i++) {
317 
318             vm.resume();
319             breakpointForCommunication();
320 
321             int instruction = ((IntegerValue)
322                                (debuggeeClass.getValue(debuggeeClass.fieldByName(&quot;instruction&quot;)))).value();
323 
324             if (instruction == 0) {
325                 vm.resume();
326                 break;
327             }
328 
329 
330             log1(&quot;:::::: case: # &quot; + i);
331 
332             //~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ variable part
333 
334             switch (i) {
335 
336               case 0:
<span class="line-modified">337                      thread1 = debuggee.threadByNameOrThrow(threadName1);</span>
338 
339                      log2(&quot;......setting up StepRequest with size StepRequest.STEP_MIN&quot;);
340                      eventRequest1 = setting24StepRequest(thread1, StepRequest.STEP_MIN,
341                                               StepRequest.STEP_INTO);
342 
343                      log2(&quot;......getting: size = ((StepRequest) eventRequest1).thread();&quot;);
344                      thread2 = ((StepRequest) eventRequest1).thread();
345 
346                      log2(&quot;      checking up on equality of values&quot;);
347                      if ( !thread2.equals(thread1) ) {
348                          testExitCode = FAILED;
349                          log3(&quot;ERROR: !thread2.equals(thread1) : &quot; + thread2);
350                      }
351 
352                       break;
353 
354               default:
355                       throw new JDITestRuntimeException(&quot;** default case 2 **&quot;);
356             }
357 
358             //~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
359         }
360         log1(&quot;    TESTING ENDS&quot;);
361         return;
362     }
363 














364    /*
365     * private BreakpointRequest settingBreakpoint(ThreadReference, ReferenceType,
366     *                                             String, String, String)
367     *
368     * It sets up a breakpoint at given line number within a given method in a given class
369     * for a given thread.
370     *
371     * Return value: BreakpointRequest object  in case of success
372     *
373     * JDITestRuntimeException   in case of an Exception thrown within the method
374     */
375 
376     private BreakpointRequest settingBreakpoint ( ThreadReference thread,
377                                                   ReferenceType testedClass,
378                                                   String methodName,
379                                                   String bpLine,
380                                                   String property)
381             throws JDITestRuntimeException {
382 
383         log2(&quot;......setting up a breakpoint:&quot;);
</pre>
</td>
</tr>
</table>
<center><a href="../size/size002.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../../ThreadDeathRequest/addThreadFilter/addthreadfilter001.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>