<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/hotspot/jtreg/vmTestbase/nsk/jdi/VirtualMachine/redefineClasses/redefineclasses001.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../canWatchFieldModification/canwatchmod001.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../../VoidType/_itself_/voidtype001.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/jtreg/vmTestbase/nsk/jdi/VirtualMachine/redefineClasses/redefineclasses001.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
147 
148     //====================================================== test program
149     //------------------------------------------------------ common section
150 
151     static Debugee          debuggee;
152     static ArgumentHandler  argsHandler;
153 
154     static int waitTime;
155 
156     static VirtualMachine      vm            = null;
157     static EventRequestManager eventRManager = null;
158     static EventQueue          eventQueue    = null;
159     static EventSet            eventSet      = null;
160     static EventIterator       eventIterator = null;
161 
162     static ReferenceType       debuggeeClass = null;
163 
164     static int  testExitCode = PASSED;
165 
166 
<span class="line-removed">167     class JDITestRuntimeException extends RuntimeException {</span>
<span class="line-removed">168         JDITestRuntimeException(String str) {</span>
<span class="line-removed">169             super(&quot;JDITestRuntimeException : &quot; + str);</span>
<span class="line-removed">170         }</span>
<span class="line-removed">171     }</span>
<span class="line-removed">172     //------------------------------------------------------ methods</span>
173 
174     private int runThis (String argv[], PrintStream out) {
175 
176         argsHandler     = new ArgumentHandler(argv);
177         logHandler      = new Log(out, argsHandler);
178         Binder binder   = new Binder(argsHandler, logHandler);
179 
180         waitTime        = argsHandler.getWaitTime() * 60000;
181 
182         try {
183             log2(&quot;launching a debuggee :&quot;);
184             log2(&quot;       &quot; + debuggeeName);
185 
186             debuggee = binder.bindToDebugee(debuggeeName);
187 
188             if (debuggee == null) {
189                 log3(&quot;ERROR: no debuggee launched&quot;);
190                 return FAILED;
191             }
192             log2(&quot;debuggee launched&quot;);
</pre>
<hr />
<pre>
301         ClassPrepareEvent event = (ClassPrepareEvent) eventIterator.next();
302         debuggeeClass = event.referenceType();
303 
304         if (!debuggeeClass.name().equals(debuggeeName))
305            throw new JDITestRuntimeException(&quot;** Unexpected ClassName for ClassPrepareEvent **&quot;);
306 
307         log2(&quot;      received: ClassPrepareEvent for debuggeeClass&quot;);
308 
309 
310         if ( !vm.canRedefineClasses() ) {
311             log2(&quot;......vm.canRedefineClasses() == false : test is cancelled&quot;);
312             vm.resume();
313             return;
314         }
315 
316 
317         String bPointMethod = &quot;methodForCommunication&quot;;
318         String lineForComm  = &quot;lineForComm&quot;;
319         BreakpointRequest bpRequest;
320 
<span class="line-modified">321         bpRequest = settingBreakpoint(threadByName(&quot;main&quot;),</span>
322                                       debuggeeClass,
323                                       bPointMethod, lineForComm, &quot;zero&quot;);
324         bpRequest.enable();
325 
326     //------------------------------------------------------  testing section
327 
328         log1(&quot;     TESTING BEGINS&quot;);
329 
330         String bpClassName  = &quot;nsk.jdi.VirtualMachine.redefineClasses.redefineclasses001b&quot;;
331         String bpMethodName = &quot;m2&quot;;
332         String bpLineName   = &quot;bpline&quot;;
333         String varName      = &quot;i1&quot;;
334         int    varValue     = 2;
335 
336         BreakpointRequest bpRequest2 = null;
337         BreakpointRequest bpRequest3 = null;
338         ReferenceType     bpClass    = null;
339 
340 
341         for (int i = 0; ; i++) {
342 
343             vm.resume();
344             breakpointForCommunication();
345 
346             int instruction = ((IntegerValue)
347                                (debuggeeClass.getValue(debuggeeClass.fieldByName(&quot;instruction&quot;)))).value();
348 
349             if (instruction == 0) {
350                 vm.resume();
351                 break;
352             }
353 
354             log1(&quot;:::::: case: # &quot; + i);
355 
356             //~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ variable part
357 
358             switch (i) {
359               case 0:
360                   List          classes = vm.classesByName(bpClassName);
361                   bpClass = (ReferenceType) classes.get(0);
<span class="line-modified">362                   bpRequest2 = settingBreakpoint(threadByName(&quot;main&quot;),</span>
363                                           bpClass,
364                                           bpMethodName, bpLineName, &quot;one&quot;);
365                   bpRequest2.enable();
366 
367                   vm.resume();
368                   breakpointInMethod(&quot;one&quot;);
369                   bpRequest2.disable();
370 
371                   try {
372                       log2(&quot;......vm.redefineClasses(mapClassToBytes());&quot;);
373                       vm.redefineClasses(mapClassToBytes());
374                   } catch ( Exception e ) {
375                       log3(&quot;ERROR:  Exception: &quot; + e);
376                       testExitCode = FAILED;
377                       throw e;
378                   } catch ( Error e ) {
379                       log3(&quot;ERROR:  Error: &quot; + e);
380                       testExitCode = FAILED;
381                       throw e;
382                   }
383                   break;
384 
385               case 1:
386 
<span class="line-modified">387                   bpRequest3 = settingBreakpoint(threadByName(&quot;main&quot;),</span>
388                                           bpClass,
389                                           bpMethodName, bpLineName, &quot;one&quot;);
390 
391                   bpRequest3.enable();
392 
393                   vm.resume();
394                   breakpointInMethod(&quot;one&quot;);
395                   bpRequest3.disable();
396 
397                   int i1 = ( (IntegerValue)
398                       bpClass.getValue(bpClass.fieldByName(varName) ) ).value();
399 
400                   if (i1 != varValue) {
401                       testExitCode = FAILED;
402                       log3(&quot;ERROR: value of i1 != 2 (expected) but : &quot; + i1);
403                   }
404                   break;
405 
406               default:
407                   throw new JDITestRuntimeException (&quot;** default case **&quot;);
408             }
409             //~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
410         }
411 // this is for debugging
412 // testExitCode = FAILED;
413 
414         vm.resume();
415         log1(&quot;    TESTING ENDS&quot;);
416         return;
417     }
418 
<span class="line-removed">419     private ThreadReference threadByName(String name)</span>
<span class="line-removed">420                  throws JDITestRuntimeException {</span>
<span class="line-removed">421 </span>
<span class="line-removed">422         List         all = vm.allThreads();</span>
<span class="line-removed">423         ListIterator li  = all.listIterator();</span>
<span class="line-removed">424 </span>
<span class="line-removed">425         for (; li.hasNext(); ) {</span>
<span class="line-removed">426             ThreadReference thread = (ThreadReference) li.next();</span>
<span class="line-removed">427             if (thread.name().equals(name))</span>
<span class="line-removed">428                 return thread;</span>
<span class="line-removed">429         }</span>
<span class="line-removed">430         throw new JDITestRuntimeException(&quot;** Thread IS NOT found ** : &quot; + name);</span>
<span class="line-removed">431     }</span>
<span class="line-removed">432 </span>
433    /*
434     * private BreakpointRequest settingBreakpoint(ThreadReference, ReferenceType,
435     *                                             String, String, String)
436     *
437     * It sets up a breakpoint at given line number within a given method in a given class
438     * for a given thread.
439     *
440     * Return value: BreakpointRequest object  in case of success
441     *
442     * JDITestRuntimeException   in case of an Exception thrown within the method
443     */
444 
445     private BreakpointRequest settingBreakpoint ( ThreadReference thread,
446                                                   ReferenceType testedClass,
447                                                   String methodName,
448                                                   String bpLine,
449                                                   String property)
450             throws JDITestRuntimeException {
451 
452         log2(&quot;......setting up a breakpoint:&quot;);
</pre>
</td>
<td>
<hr />
<pre>
147 
148     //====================================================== test program
149     //------------------------------------------------------ common section
150 
151     static Debugee          debuggee;
152     static ArgumentHandler  argsHandler;
153 
154     static int waitTime;
155 
156     static VirtualMachine      vm            = null;
157     static EventRequestManager eventRManager = null;
158     static EventQueue          eventQueue    = null;
159     static EventSet            eventSet      = null;
160     static EventIterator       eventIterator = null;
161 
162     static ReferenceType       debuggeeClass = null;
163 
164     static int  testExitCode = PASSED;
165 
166 






167 
168     private int runThis (String argv[], PrintStream out) {
169 
170         argsHandler     = new ArgumentHandler(argv);
171         logHandler      = new Log(out, argsHandler);
172         Binder binder   = new Binder(argsHandler, logHandler);
173 
174         waitTime        = argsHandler.getWaitTime() * 60000;
175 
176         try {
177             log2(&quot;launching a debuggee :&quot;);
178             log2(&quot;       &quot; + debuggeeName);
179 
180             debuggee = binder.bindToDebugee(debuggeeName);
181 
182             if (debuggee == null) {
183                 log3(&quot;ERROR: no debuggee launched&quot;);
184                 return FAILED;
185             }
186             log2(&quot;debuggee launched&quot;);
</pre>
<hr />
<pre>
295         ClassPrepareEvent event = (ClassPrepareEvent) eventIterator.next();
296         debuggeeClass = event.referenceType();
297 
298         if (!debuggeeClass.name().equals(debuggeeName))
299            throw new JDITestRuntimeException(&quot;** Unexpected ClassName for ClassPrepareEvent **&quot;);
300 
301         log2(&quot;      received: ClassPrepareEvent for debuggeeClass&quot;);
302 
303 
304         if ( !vm.canRedefineClasses() ) {
305             log2(&quot;......vm.canRedefineClasses() == false : test is cancelled&quot;);
306             vm.resume();
307             return;
308         }
309 
310 
311         String bPointMethod = &quot;methodForCommunication&quot;;
312         String lineForComm  = &quot;lineForComm&quot;;
313         BreakpointRequest bpRequest;
314 
<span class="line-modified">315         bpRequest = settingBreakpoint(debuggee.threadByNameOrThrow(&quot;main&quot;),</span>
316                                       debuggeeClass,
317                                       bPointMethod, lineForComm, &quot;zero&quot;);
318         bpRequest.enable();
319 
320     //------------------------------------------------------  testing section
321 
322         log1(&quot;     TESTING BEGINS&quot;);
323 
324         String bpClassName  = &quot;nsk.jdi.VirtualMachine.redefineClasses.redefineclasses001b&quot;;
325         String bpMethodName = &quot;m2&quot;;
326         String bpLineName   = &quot;bpline&quot;;
327         String varName      = &quot;i1&quot;;
328         int    varValue     = 2;
329 
330         BreakpointRequest bpRequest2 = null;
331         BreakpointRequest bpRequest3 = null;
332         ReferenceType     bpClass    = null;
333 
334 
335         for (int i = 0; ; i++) {
336 
337             vm.resume();
338             breakpointForCommunication();
339 
340             int instruction = ((IntegerValue)
341                                (debuggeeClass.getValue(debuggeeClass.fieldByName(&quot;instruction&quot;)))).value();
342 
343             if (instruction == 0) {
344                 vm.resume();
345                 break;
346             }
347 
348             log1(&quot;:::::: case: # &quot; + i);
349 
350             //~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ variable part
351 
352             switch (i) {
353               case 0:
354                   List          classes = vm.classesByName(bpClassName);
355                   bpClass = (ReferenceType) classes.get(0);
<span class="line-modified">356                   bpRequest2 = settingBreakpoint(debuggee.threadByNameOrThrow(&quot;main&quot;),</span>
357                                           bpClass,
358                                           bpMethodName, bpLineName, &quot;one&quot;);
359                   bpRequest2.enable();
360 
361                   vm.resume();
362                   breakpointInMethod(&quot;one&quot;);
363                   bpRequest2.disable();
364 
365                   try {
366                       log2(&quot;......vm.redefineClasses(mapClassToBytes());&quot;);
367                       vm.redefineClasses(mapClassToBytes());
368                   } catch ( Exception e ) {
369                       log3(&quot;ERROR:  Exception: &quot; + e);
370                       testExitCode = FAILED;
371                       throw e;
372                   } catch ( Error e ) {
373                       log3(&quot;ERROR:  Error: &quot; + e);
374                       testExitCode = FAILED;
375                       throw e;
376                   }
377                   break;
378 
379               case 1:
380 
<span class="line-modified">381                   bpRequest3 = settingBreakpoint(debuggee.threadByNameOrThrow(&quot;main&quot;),</span>
382                                           bpClass,
383                                           bpMethodName, bpLineName, &quot;one&quot;);
384 
385                   bpRequest3.enable();
386 
387                   vm.resume();
388                   breakpointInMethod(&quot;one&quot;);
389                   bpRequest3.disable();
390 
391                   int i1 = ( (IntegerValue)
392                       bpClass.getValue(bpClass.fieldByName(varName) ) ).value();
393 
394                   if (i1 != varValue) {
395                       testExitCode = FAILED;
396                       log3(&quot;ERROR: value of i1 != 2 (expected) but : &quot; + i1);
397                   }
398                   break;
399 
400               default:
401                   throw new JDITestRuntimeException (&quot;** default case **&quot;);
402             }
403             //~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
404         }
405 // this is for debugging
406 // testExitCode = FAILED;
407 
408         vm.resume();
409         log1(&quot;    TESTING ENDS&quot;);
410         return;
411     }
412 














413    /*
414     * private BreakpointRequest settingBreakpoint(ThreadReference, ReferenceType,
415     *                                             String, String, String)
416     *
417     * It sets up a breakpoint at given line number within a given method in a given class
418     * for a given thread.
419     *
420     * Return value: BreakpointRequest object  in case of success
421     *
422     * JDITestRuntimeException   in case of an Exception thrown within the method
423     */
424 
425     private BreakpointRequest settingBreakpoint ( ThreadReference thread,
426                                                   ReferenceType testedClass,
427                                                   String methodName,
428                                                   String bpLine,
429                                                   String property)
430             throws JDITestRuntimeException {
431 
432         log2(&quot;......setting up a breakpoint:&quot;);
</pre>
</td>
</tr>
</table>
<center><a href="../canWatchFieldModification/canwatchmod001.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../../VoidType/_itself_/voidtype001.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>