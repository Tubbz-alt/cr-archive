<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old test/hotspot/jtreg/vmTestbase/nsk/jvmti/unit/ForceEarlyReturn/earlyretbase/earlyretbase.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2007, 2018, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 #include &lt;stdio.h&gt;
 25 #include &lt;string.h&gt;
 26 #include &quot;jvmti.h&quot;
 27 #include &quot;agent_common.h&quot;
 28 #include &quot;JVMTITools.h&quot;
 29 
 30 extern &quot;C&quot; {
 31 
 32 
 33 #define STATUS_FAILED 2
 34 #define PASSED 0
 35 
 36 #define RETURN_FAILED errCode = STATUS_FAILED; fflush(0); return errCode
 37 
 38 static jvmtiEnv *jvmti = NULL;
 39 static jvmtiCapabilities caps;
 40 static jvmtiEventCallbacks callbacks;
 41 
 42 /* MethodExit and PopFrame events expected */
 43 static int meth_exit_exp_events = 0;
 44 static int pop_frame_exp_events = 0;
 45 
 46 /* MethodExit and PopFrame events generated */
 47 static int meth_exit_gen_events = 0;
 48 static int pop_frame_gen_events = 0;
 49 
 50 static int errCode = PASSED;
 51 
 52 static const char *sig_exp       = &quot;()J&quot;;
 53 static const char *name_exp      = &quot;activeMethod&quot;;
 54 static jmethodID midActiveMethod = NULL;
 55 
 56 void JNICALL
 57 MethodExit(jvmtiEnv *jvmti_env, JNIEnv *env, jthread thr,
 58         jmethodID method, jboolean was_poped_by_exc, jvalue return_value) {
 59 
 60     if (method == midActiveMethod) {
 61         printf(&quot;#### MethodExit event occurred ####\n&quot;);
 62         fflush(0);
 63         meth_exit_gen_events++;
 64     }
 65 }
 66 
 67 void JNICALL
 68 FramePop(jvmtiEnv *jvmti_env, JNIEnv *env, jthread thread,
 69         jmethodID method, jboolean wasPopedByException) {
 70 
 71     if (method == midActiveMethod) {
 72         printf(&quot;#### FramePop event occurred ####\n&quot;);
 73         fflush(0);
 74         pop_frame_gen_events++;
 75     }
 76 }
 77 
 78 JNIEXPORT jint JNICALL
 79 Java_nsk_jvmti_unit_ForceEarlyReturn_earlyretbase_suspThread(JNIEnv *env,
 80         jclass cls, jobject earlyretThr) {
 81 
 82     if (!caps.can_force_early_return || !caps.can_suspend) {
 83         return PASSED;
 84     }
 85 
 86     jclass clazz = env-&gt;GetObjectClass(earlyretThr);
 87     if (clazz == NULL) {
 88         printf(&quot;Cannot get class of thread object\n&quot;);
 89         RETURN_FAILED;
 90     }
 91 
 92     midActiveMethod = env-&gt;GetMethodID(clazz, name_exp, sig_exp);
 93     if (midActiveMethod == NULL) {
 94         printf(&quot;Cannot find Method ID for method %s\n&quot;, name_exp);
 95         RETURN_FAILED;
 96     }
 97 
 98     int result = suspendThreadAtMethod(jvmti, cls, earlyretThr, midActiveMethod);
 99     if( result == NSK_TRUE) {
100         return PASSED;
101     } else {
102         RETURN_FAILED;
103     }
104 }
105 
106 JNIEXPORT jint JNICALL
107 Java_nsk_jvmti_unit_ForceEarlyReturn_earlyretbase_resThread(JNIEnv *env,
108         jclass cls, jobject earlyretThr) {
109     jvmtiError err;
110 
111     if (!caps.can_force_early_return || !caps.can_suspend) {
112         return PASSED;
113     }
114 
115     printf(&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Invoke ResumeThread()\n&quot;);
116     err = jvmti-&gt;ResumeThread(earlyretThr);
117     if (err != JVMTI_ERROR_NONE) {
118         printf(&quot;%s: Failed to call ResumeThread(): error=%d: %s\n&quot;,
119             __FILE__, err, TranslateError(err));
120         return JNI_ERR;
121     }
122     printf(&quot;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; ResumeThread() is successfully done\n&quot;);
123     fflush(0);
124     return PASSED;
125 }
126 
127 JNIEXPORT jint JNICALL
128 Java_nsk_jvmti_unit_ForceEarlyReturn_earlyretbase_doForceEarlyReturn(JNIEnv *env,
129         jclass cls, jthread earlyretThr, jlong valToRet) {
130     jvmtiError err;
131 
132     if (!caps.can_force_early_return || !caps.can_suspend) {
133         return PASSED;
134     }
135 
136     /* Turn on the JVMTI MetodExit and PopFrame events to check
137      * that ForceEarlyReturn correctly generates them */
138 
139     err = jvmti-&gt;SetEventNotificationMode(JVMTI_ENABLE,
140         JVMTI_EVENT_METHOD_EXIT, NULL);
141     if (err != JVMTI_ERROR_NONE) {
142         printf(&quot;Failed to enable METHOD_EXIT event: %s (%d)\n&quot;,
143                TranslateError(err), err);
144         RETURN_FAILED;
145     } else {
146         meth_exit_exp_events++;
147     }
148 
149     err = jvmti-&gt;SetEventNotificationMode(JVMTI_ENABLE,
150         JVMTI_EVENT_FRAME_POP, NULL);
151     if (err != JVMTI_ERROR_NONE) {
152         printf(&quot;Failed to enable FRAME_POP event: %s (%d)\n&quot;,
153                TranslateError(err), err);
154         RETURN_FAILED;
155     }
156 
157     err = jvmti-&gt;NotifyFramePop(earlyretThr, 0);
158     if (err == JVMTI_ERROR_MUST_POSSESS_CAPABILITY &amp;&amp;
159                !caps.can_generate_frame_pop_events) {
160         /* Ok, it&#39;s expected */
161     } else if (err != JVMTI_ERROR_NONE) {
162         printf(&quot;(NotifyFramePop) unexpected error: %s (%d)\n&quot;,
163                TranslateError(err), err);
164         RETURN_FAILED;
165     } else {
166         pop_frame_exp_events++;
167     }
168     printf(&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Invoke ForceEarlyReturn()\n&quot;);
169 
170     err = jvmti-&gt;ForceEarlyReturnLong(earlyretThr, valToRet);
171     if (err != JVMTI_ERROR_NONE) {
172         printf(&quot;TEST FAILED: the function ForceEarlyReturn()&quot;
173                &quot; returned the error %d: %s\n&quot;,
174                err, TranslateError(err));
175         printf(&quot;\tFor more info about this error see the JVMTI spec.\n&quot;);
176         RETURN_FAILED;
177     }
178     printf(&quot;Check #1 PASSED: ForceEarlyReturn() is successfully done\n&quot;);
179     fflush(0);
180 
181     return(errCode);
182 }
183 
184 #ifdef STATIC_BUILD
185 JNIEXPORT jint JNICALL Agent_OnLoad_earlyretbase(JavaVM *jvm, char *options, void *reserved) {
186     return Agent_Initialize(jvm, options, reserved);
187 }
188 JNIEXPORT jint JNICALL Agent_OnAttach_earlyretbase(JavaVM *jvm, char *options, void *reserved) {
189     return Agent_Initialize(jvm, options, reserved);
190 }
191 JNIEXPORT jint JNI_OnLoad_earlyretbase(JavaVM *jvm, char *options, void *reserved) {
192     return JNI_VERSION_1_8;
193 }
194 #endif
195 jint  Agent_Initialize(JavaVM *jvm, char *options, void *reserved) {
196     jint res;
197     jvmtiError err;
198 
199     res = jvm-&gt;GetEnv((void **) &amp;jvmti, JVMTI_VERSION_1_1);
200     if (res != JNI_OK || jvmti == NULL) {
201         printf(&quot;Wrong error code from a valid call to GetEnv!\n&quot;);
202         return JNI_ERR;
203     }
204 
205     err = jvmti-&gt;GetPotentialCapabilities(&amp;caps);
206     if (err != JVMTI_ERROR_NONE) {
207         printf(&quot;(GetPotentialCapabilities) unexpected error: %s (%d)\n&quot;,
208                TranslateError(err), err);
209         return JNI_ERR;
210     }
211 
212     err = jvmti-&gt;AddCapabilities(&amp;caps);
213     if (err != JVMTI_ERROR_NONE) {
214         printf(&quot;(AddCapabilities) unexpected error: %s (%d)\n&quot;,
215                TranslateError(err), err);
216         return JNI_ERR;
217     }
218 
219     err = jvmti-&gt;GetCapabilities(&amp;caps);
220     if (err != JVMTI_ERROR_NONE) {
221         printf(&quot;(GetCapabilities) unexpected error: %s (%d)\n&quot;,
222                TranslateError(err), err);
223         return JNI_ERR;
224     }
225 
226     if (!caps.can_force_early_return) {
227         printf(&quot;Warning: ForceEarlyReturn is not implemented\n&quot;);
228         return JNI_OK;
229     }
230 
231     if (!caps.can_suspend) {
232         printf(&quot;Warning: suspend/resume is not implemented\n&quot;);
233         return JNI_OK;
234     }
235 
236     if (caps.can_generate_frame_pop_events &amp;&amp; caps.can_generate_method_exit_events) {
237         callbacks.MethodExit = &amp;MethodExit;
238         callbacks.FramePop   = &amp;FramePop;
239         err = jvmti-&gt;SetEventCallbacks(&amp;callbacks, sizeof(callbacks));
240         if (err != JVMTI_ERROR_NONE) {
241             printf(&quot;(SetEventCallbacks) unexpected error: %s (%d)\n&quot;,
242                    TranslateError(err), err);
243             return JNI_ERR;
244         }
245     } else {
246         printf(&quot;Warning: FramePop or MethodExit event is not implemented\n&quot;);
247     }
248     return JNI_OK;
249 }
250 
251 JNIEXPORT jint JNICALL
252 Java_nsk_jvmti_unit_ForceEarlyReturn_earlyretbase_check(JNIEnv *env, jclass cls) {
253 
254     printf(&quot;JVMTI  PopFrame  events: expected: %d, generated: %d\n&quot;,
255             meth_exit_exp_events, meth_exit_gen_events);
256 
257     printf(&quot;JVMTI MethodExit events: expected: %d, generated: %d\n&quot;,
258             pop_frame_exp_events, pop_frame_gen_events);
259 
260     /* Check if the JVMTI events were generated correctly by ForceEarlyReturn */
261     if (meth_exit_exp_events != meth_exit_gen_events ||
262         pop_frame_exp_events != pop_frame_gen_events) {
263         printf(&quot;TEST FAILED: JVMTI MethodExit or PopFrame events &quot;
264                &quot;generated incorrectly\n&quot;);
265         errCode = STATUS_FAILED;
266     } else {
267         printf(&quot;Check #2 PASSED: JVMTI MethodExit and PopFrame &quot;
268                &quot;events generated correctly\n&quot;);
269         errCode = PASSED;
270     }
271     fflush(0);
272     return errCode;
273 }
274 
275 }
    </pre>
  </body>
</html>