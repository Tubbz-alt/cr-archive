<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/hotspot/jtreg/vmTestbase/nsk/jvmti/SingleStep/singlestep001/singlestep001.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2003, 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 #include &lt;stdio.h&gt;
 25 #include &lt;string.h&gt;
 26 #include &lt;jvmti.h&gt;
 27 #include &quot;agent_common.h&quot;
 28 
 29 #include &quot;nsk_tools.h&quot;
 30 #include &quot;JVMTITools.h&quot;
 31 #include &quot;jvmti_tools.h&quot;
 32 #include &quot;jni_tools.h&quot;
 33 
 34 extern &quot;C&quot; {
 35 
 36 #define STATUS_FAILED 2
 37 #define PASSED 0
 38 
 39 #define METH_NUM 2
 40 
 41 static const char *METHODS[] = {
 42     &quot;bpMethod&quot;,
 43     &quot;runThis&quot;
 44 };
 45 
 46 static const char *METHOD_SIGS[] = {
 47     &quot;()V&quot;,
 48     &quot;([Ljava/lang/String;Ljava/io/PrintStream;)I&quot;
 49 };
 50 
 51 static volatile long stepEv[] = { 0, 0 };
 52 
 53 static const char *CLASS_SIG =
 54     &quot;Lnsk/jvmti/SingleStep/singlestep001;&quot;;
 55 
 56 static volatile jint result = PASSED;
 57 static jvmtiEnv *jvmti = NULL;
 58 static jvmtiEventCallbacks callbacks;
 59 
<a name="2" id="anc2"></a><span class="line-modified"> 60 static int vm_started = 0;</span>
 61 static jrawMonitorID agent_lock;
 62 
 63 static void setBP(jvmtiEnv *jvmti_env, JNIEnv *env, jclass klass) {
 64     jmethodID mid;
 65 
 66     if (!NSK_JNI_VERIFY(env, (mid = env-&gt;GetMethodID(klass, METHODS[0], METHOD_SIGS[0])) != NULL))
 67         env-&gt;FatalError(&quot;failed to get ID for the java method\n&quot;);
 68 
 69     if (!NSK_JVMTI_VERIFY(jvmti_env-&gt;SetBreakpoint(mid, 0)))
 70         env-&gt;FatalError(&quot;failed to set breakpoint\n&quot;);
 71 }
 72 
 73 /** callback functions **/
 74 void JNICALL
 75 ClassLoad(jvmtiEnv *jvmti_env, JNIEnv *env, jthread thread, jclass klass) {
 76     char *sig, *generic;
 77 
 78     jvmti-&gt;RawMonitorEnter(agent_lock);
 79 
<a name="3" id="anc3"></a><span class="line-modified"> 80     if (vm_started) {</span>
 81         if (!NSK_JVMTI_VERIFY(jvmti_env-&gt;GetClassSignature(klass, &amp;sig, &amp;generic)))
 82             env-&gt;FatalError(&quot;failed to obtain a class signature\n&quot;);
 83 
 84         if (sig != NULL &amp;&amp; (strcmp(sig, CLASS_SIG) == 0)) {
 85             NSK_DISPLAY1(
 86                 &quot;ClassLoad event received for the class \&quot;%s\&quot;\n&quot;
 87                 &quot;\tsetting breakpoint ...\n&quot;,
 88                 sig);
 89             setBP(jvmti_env, env, klass);
 90         }
 91     }
 92 
 93     jvmti-&gt;RawMonitorExit(agent_lock);
 94 }
 95 
 96 void JNICALL
 97 Breakpoint(jvmtiEnv *jvmti_env, JNIEnv *env, jthread thr, jmethodID method,
 98         jlocation loc) {
 99     jclass klass;
100     char *sig, *generic;
101 
<a name="4" id="anc4"></a>






102     NSK_DISPLAY0(&quot;Breakpoint event received\n&quot;);
103     if (!NSK_JVMTI_VERIFY(jvmti_env-&gt;GetMethodDeclaringClass(method, &amp;klass)))
104         NSK_COMPLAIN0(&quot;TEST FAILURE: unable to get method declaring class\n\n&quot;);
105 
106     if (!NSK_JVMTI_VERIFY(jvmti_env-&gt;GetClassSignature(klass, &amp;sig, &amp;generic)))
107         env-&gt;FatalError(&quot;Breakpoint: failed to obtain a class signature\n&quot;);
108 
109     if (sig != NULL &amp;&amp; (strcmp(sig, CLASS_SIG) == 0)) {
110         NSK_DISPLAY1(&quot;method declaring class \&quot;%s\&quot;\n\tenabling SingleStep events ...\n&quot;,
111             sig);
112         if (!NSK_JVMTI_VERIFY(jvmti_env-&gt;SetEventNotificationMode(JVMTI_ENABLE, JVMTI_EVENT_SINGLE_STEP, thr))) {
113             result = STATUS_FAILED;
114             NSK_COMPLAIN0(&quot;TEST FAILURE: cannot enable SingleStep events\n\n&quot;);
115         }
116     } else {
117         result = STATUS_FAILED;
118         NSK_COMPLAIN1(&quot;TEST FAILURE: unexpected breakpoint event in method of class \&quot;%s\&quot;\n\n&quot;,
119             sig);
120     }
<a name="5" id="anc5"></a>
121 }
122 
123 void JNICALL
124 SingleStep(jvmtiEnv *jvmti_env, JNIEnv* jni_env, jthread thread,
125         jmethodID method, jlocation location) {
126     jclass klass;
127     char *sig, *generic, *methNam, *methSig;
128 
129     if (result == STATUS_FAILED) {
130         return;
131     }
132 
133     NSK_DISPLAY0(&quot;&gt;&gt;&gt;&gt; SingleStep event received\n&quot;);
134 
135     if (!NSK_JVMTI_VERIFY(jvmti_env-&gt;GetMethodName(method, &amp;methNam, &amp;methSig, NULL))) {
136         result = STATUS_FAILED;
137         NSK_COMPLAIN0(&quot;TEST FAILED: unable to get method name during SingleStep callback\n\n&quot;);
138         return;
139     }
140     if (!NSK_JVMTI_VERIFY(jvmti_env-&gt;GetMethodDeclaringClass(method, &amp;klass))) {
141         result = STATUS_FAILED;
142         NSK_COMPLAIN0(&quot;TEST FAILED: unable to get method declaring class during SingleStep callback\n\n&quot;);
143         return;
144     }
145     if (!NSK_JVMTI_VERIFY(jvmti_env-&gt;GetClassSignature(klass, &amp;sig, &amp;generic))) {
146         result = STATUS_FAILED;
147         NSK_COMPLAIN0(&quot;TEST FAILED: unable to obtain a class signature during SingleStep callback\n\n&quot;);
148         return;
149     }
150 
151     if (sig != NULL) {
152         NSK_DISPLAY3(
153             &quot;\tmethod name: \&quot;%s\&quot;\n&quot;
154             &quot;\tsignature: \&quot;%s\&quot;\n&quot;
155             &quot;\tmethod declaring class: \&quot;%s\&quot;\n&quot;,
156             methNam, methSig, sig);
157 
158         if (stepEv[1] == 1) {
159             result = STATUS_FAILED;
160             NSK_COMPLAIN0(&quot;TEST FAILED: SingleStep event received after disabling the event generation\n\n&quot;);
161         }
162         else if ((strcmp(methNam,METHODS[0]) == 0) &amp;&amp;
163                 (strcmp(methSig,METHOD_SIGS[0]) == 0) &amp;&amp;
164                 (strcmp(sig,CLASS_SIG) == 0)) {
165             stepEv[0]++;
166             NSK_DISPLAY1(&quot;CHECK PASSED: SingleStep event received for the method \&quot;%s\&quot; as expected\n&quot;,
167                 methNam);
168         }
169         else if ((strcmp(methNam,METHODS[1]) == 0) &amp;&amp;
170                 (strcmp(methSig,METHOD_SIGS[1]) == 0) &amp;&amp;
171                 (strcmp(sig,CLASS_SIG) == 0)) {
172             stepEv[1]++;
173             NSK_DISPLAY1(
174                 &quot;CHECK PASSED: SingleStep event received for the method \&quot;%s\&quot; as expected\n&quot;
175                 &quot;\tdisabling the event generation\n&quot;,
176                 methNam);
177             if (!NSK_JVMTI_VERIFY(jvmti_env-&gt;SetEventNotificationMode(JVMTI_DISABLE, JVMTI_EVENT_SINGLE_STEP, thread))) {
178                 result = STATUS_FAILED;
179                 NSK_COMPLAIN0(&quot;TEST FAILED: cannot disable SingleStep events\n\n&quot;);
180             }
181         }
182     }
183 
184     if (!NSK_JVMTI_VERIFY(jvmti_env-&gt;Deallocate((unsigned char*) methNam))) {
185         result = STATUS_FAILED;
186         NSK_COMPLAIN0(&quot;TEST FAILED: unable to deallocate memory pointed to method name\n\n&quot;);
187     }
188     if (!NSK_JVMTI_VERIFY(jvmti_env-&gt;Deallocate((unsigned char*) methSig))) {
189         result = STATUS_FAILED;
190         NSK_COMPLAIN0(&quot;TEST FAILED: unable to deallocate memory pointed to method signature\n\n&quot;);
191     }
192 
193     NSK_DISPLAY0(&quot;&lt;&lt;&lt;&lt;\n\n&quot;);
194 }
195 
196 void JNICALL
197 VMStart(jvmtiEnv *jvmti_env, JNIEnv* jni_env) {
198     jvmti-&gt;RawMonitorEnter(agent_lock);
199 
<a name="6" id="anc6"></a><span class="line-modified">200     vm_started = 1;</span>









201 
202     jvmti-&gt;RawMonitorExit(agent_lock);
203 }
204 /************************/
205 
206 JNIEXPORT jint JNICALL
207 Java_nsk_jvmti_SingleStep_singlestep001_check(
208         JNIEnv *env, jobject obj) {
209     int i;
210 
211     for (i=0; i&lt;METH_NUM; i++)
212         if (stepEv[i] == 0) {
213             result = STATUS_FAILED;
214             NSK_COMPLAIN1(&quot;TEST FAILED: no SingleStep events for the method \&quot;%s\&quot;\n\n&quot;,
215                 METHODS[i]);
216         }
217 
218     return result;
219 }
220 
221 #ifdef STATIC_BUILD
222 JNIEXPORT jint JNICALL Agent_OnLoad_singlestep001(JavaVM *jvm, char *options, void *reserved) {
223     return Agent_Initialize(jvm, options, reserved);
224 }
225 JNIEXPORT jint JNICALL Agent_OnAttach_singlestep001(JavaVM *jvm, char *options, void *reserved) {
226     return Agent_Initialize(jvm, options, reserved);
227 }
228 JNIEXPORT jint JNI_OnLoad_singlestep001(JavaVM *jvm, char *options, void *reserved) {
229     return JNI_VERSION_1_8;
230 }
231 #endif
232 jint Agent_Initialize(JavaVM *jvm, char *options, void *reserved) {
233     jvmtiCapabilities caps;
234 
235     /* init framework and parse options */
236     if (!NSK_VERIFY(nsk_jvmti_parseOptions(options)))
237         return JNI_ERR;
238 
239     /* create JVMTI environment */
240     if (!NSK_VERIFY((jvmti =
241             nsk_jvmti_createJVMTIEnv(jvm, reserved)) != NULL))
242         return JNI_ERR;
243 
244     /* add capability to generate compiled method events */
245     memset(&amp;caps, 0, sizeof(jvmtiCapabilities));
246     caps.can_generate_breakpoint_events = 1;
247     caps.can_generate_single_step_events = 1;
248     if (!NSK_JVMTI_VERIFY(jvmti-&gt;AddCapabilities(&amp;caps)))
249         return JNI_ERR;
250 
251     if (!NSK_JVMTI_VERIFY(jvmti-&gt;GetCapabilities(&amp;caps)))
252         return JNI_ERR;
253 
254     if (!caps.can_generate_single_step_events)
255         NSK_DISPLAY0(&quot;Warning: generation of single step events is not implemented\n&quot;);
256 
257     /* set event callback */
258     NSK_DISPLAY0(&quot;setting event callbacks ...\n&quot;);
259     (void) memset(&amp;callbacks, 0, sizeof(callbacks));
260     callbacks.ClassLoad = &amp;ClassLoad;
261     callbacks.Breakpoint = &amp;Breakpoint;
262     callbacks.SingleStep = &amp;SingleStep;
263     callbacks.VMStart = &amp;VMStart;
<a name="7" id="anc7"></a>
264     if (!NSK_JVMTI_VERIFY(jvmti-&gt;SetEventCallbacks(&amp;callbacks, sizeof(callbacks))))
265         return JNI_ERR;
266 
267     NSK_DISPLAY0(&quot;setting event callbacks done\nenabling JVMTI events ...\n&quot;);
268     if (!NSK_JVMTI_VERIFY(jvmti-&gt;SetEventNotificationMode(JVMTI_ENABLE, JVMTI_EVENT_VM_START, NULL)))
269         return JNI_ERR;
<a name="8" id="anc8"></a>

270     if (!NSK_JVMTI_VERIFY(jvmti-&gt;SetEventNotificationMode(JVMTI_ENABLE, JVMTI_EVENT_CLASS_LOAD, NULL)))
271         return JNI_ERR;
272     if (!NSK_JVMTI_VERIFY(jvmti-&gt;SetEventNotificationMode(JVMTI_ENABLE, JVMTI_EVENT_BREAKPOINT, NULL)))
273         return JNI_ERR;
274     NSK_DISPLAY0(&quot;enabling the events done\n\n&quot;);
275 
276     if (!NSK_JVMTI_VERIFY(jvmti-&gt;CreateRawMonitor(&quot;agent lock&quot;, &amp;agent_lock)))
277         return JNI_ERR;
278 
279     return JNI_OK;
280 }
281 
282 }
<a name="9" id="anc9"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="9" type="hidden" />
</body>
</html>