<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/hotspot/jtreg/vmTestbase/nsk/jvmti/scenarios/contention/TC02/tc02t001.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../bcinstr/BI04/bi04t002/newclass02/java.base/java/lang/Object.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="tc02t001/tc02t001.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/jtreg/vmTestbase/nsk/jvmti/scenarios/contention/TC02/tc02t001.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2004, 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 package nsk.jvmti.scenarios.contention.TC02;
 25 
 26 import java.io.PrintStream;
 27 
 28 import nsk.share.*;
 29 import nsk.share.jvmti.*;
 30 
<span class="line-modified"> 31 //    THIS TEST IS LINE NUMBER SENSITIVE</span>

































 32 
 33 public class tc02t001 extends DebugeeClass {
 34 
 35     // run test from command line
 36     public static void main(String argv[]) {
 37         argv = nsk.share.jvmti.JVMTITest.commonInit(argv);
 38 
 39         // JCK-compatible exit
 40         System.exit(run(argv, System.out) + Consts.JCK_STATUS_BASE);
 41     }
 42 
 43     // run test from JCK-compatible environment
 44     public static int run(String argv[], PrintStream out) {
 45         return new tc02t001().runIt(argv, out);
 46     }
 47 
 48     /* =================================================================== */
 49 
 50     // scaffold objects
 51     ArgumentHandler argHandler = null;
 52     Log log = null;
 53     int status = Consts.TEST_PASSED;
 54     static long timeout = 0;
 55 



 56     // tested thread
 57     tc02t001Thread thread = null;
 58 





















 59     // run debuggee
 60     public int runIt(String argv[], PrintStream out) {
 61         argHandler = new ArgumentHandler(argv);
 62         log = new Log(out, argHandler);
 63         timeout = argHandler.getWaitTime() * 60 * 1000;
 64         log.display(&quot;Timeout = &quot; + timeout + &quot; msc.&quot;);
 65 
 66         thread = new tc02t001Thread(&quot;Debuggee Thread&quot;);
 67         synchronized (thread.M) {
 68             thread.start();
 69             thread.startingBarrier.waitFor();
 70             status = checkStatus(status);
 71 

 72             thread.waitingBarrier1.unlock();
<span class="line-modified"> 73             try {</span>
<span class="line-modified"> 74                 Thread.sleep(1000); // Wait for contended &quot;synchronized (M)&quot;</span>
<span class="line-removed"> 75                 thread.M.wait(timeout);</span>
<span class="line-removed"> 76             } catch (InterruptedException e) {</span>
<span class="line-removed"> 77                 throw new Failure(e);</span>
<span class="line-removed"> 78             }</span>
 79 

 80             thread.waitingBarrier2.unlock();
<span class="line-modified"> 81             try {</span>
<span class="line-modified"> 82                 Thread.sleep(1000); // Wait for contended &quot;synchronized (M)&quot;</span>
<span class="line-removed"> 83                 thread.M.wait(timeout);</span>
<span class="line-removed"> 84             } catch (InterruptedException e) {</span>
<span class="line-removed"> 85                 throw new Failure(e);</span>
<span class="line-removed"> 86             }</span>
 87 

 88             thread.waitingBarrier3.unlock();
<span class="line-modified"> 89             try {</span>
<span class="line-modified"> 90                 Thread.sleep(1000); // Wait for contended &quot;synchronized (M)&quot;</span>
<span class="line-removed"> 91                 thread.M.wait(timeout);</span>
<span class="line-removed"> 92             } catch (InterruptedException e) {</span>
<span class="line-removed"> 93                 throw new Failure(e);</span>
<span class="line-removed"> 94             }</span>
 95         }
 96 
 97         try {
 98             thread.join(timeout);
 99         } catch (InterruptedException e) {
100             throw new Failure(e);
101         }
102 
103         log.display(&quot;Debugee finished&quot;);
104         status = checkStatus(status);
105 
106         return status;
107     }
108 }
<span class="line-removed">109 </span>
<span class="line-removed">110 /* =================================================================== */</span>
<span class="line-removed">111 </span>
<span class="line-removed">112 class tc02t001Thread extends Thread {</span>
<span class="line-removed">113     public Wicket startingBarrier = new Wicket();</span>
<span class="line-removed">114     public Wicket waitingBarrier1 = new Wicket();</span>
<span class="line-removed">115     public Wicket waitingBarrier2 = new Wicket();</span>
<span class="line-removed">116     public Wicket waitingBarrier3 = new Wicket();</span>
<span class="line-removed">117     public Object M = new Object();</span>
<span class="line-removed">118 </span>
<span class="line-removed">119     public tc02t001Thread(String name) {</span>
<span class="line-removed">120         super(name);</span>
<span class="line-removed">121     }</span>
<span class="line-removed">122 </span>
<span class="line-removed">123     public void run() {</span>
<span class="line-removed">124         startingBarrier.unlock();</span>
<span class="line-removed">125 </span>
<span class="line-removed">126         waitingBarrier1.waitFor();</span>
<span class="line-removed">127         synchronized (M) { // tc02t001.c::lines[0]</span>
<span class="line-removed">128             M.notify();</span>
<span class="line-removed">129         }</span>
<span class="line-removed">130 </span>
<span class="line-removed">131         waitingBarrier2.waitFor();</span>
<span class="line-removed">132         synchronized (M) { // tc02t001.c::lines[1]</span>
<span class="line-removed">133             M.notify();</span>
<span class="line-removed">134         }</span>
<span class="line-removed">135 </span>
<span class="line-removed">136         waitingBarrier3.waitFor();</span>
<span class="line-removed">137         synchronized (M) { // tc02t001.c::lines[2]</span>
<span class="line-removed">138             M.notify();</span>
<span class="line-removed">139         }</span>
<span class="line-removed">140     }</span>
<span class="line-removed">141 }</span>
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2004, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 package nsk.jvmti.scenarios.contention.TC02;
 25 
 26 import java.io.PrintStream;
 27 
 28 import nsk.share.*;
 29 import nsk.share.jvmti.*;
 30 
<span class="line-modified"> 31 //    THIS CLASS IS LINE NUMBER SENSITIVE</span>
<span class="line-added"> 32 </span>
<span class="line-added"> 33 class tc02t001Thread extends Thread {</span>
<span class="line-added"> 34     public Wicket startingBarrier = new Wicket();</span>
<span class="line-added"> 35     public Wicket waitingBarrier1 = new Wicket();</span>
<span class="line-added"> 36     public Wicket waitingBarrier2 = new Wicket();</span>
<span class="line-added"> 37     public Wicket waitingBarrier3 = new Wicket();</span>
<span class="line-added"> 38     public Object M = new Object();</span>
<span class="line-added"> 39 </span>
<span class="line-added"> 40     public tc02t001Thread(String name) {</span>
<span class="line-added"> 41         super(name);</span>
<span class="line-added"> 42     }</span>
<span class="line-added"> 43 </span>
<span class="line-added"> 44     public void run() {</span>
<span class="line-added"> 45         startingBarrier.unlock();</span>
<span class="line-added"> 46 </span>
<span class="line-added"> 47         waitingBarrier1.waitFor();</span>
<span class="line-added"> 48         synchronized (M) { // tc02t001.c::lines[0]</span>
<span class="line-added"> 49             M.notify();</span>
<span class="line-added"> 50         }</span>
<span class="line-added"> 51 </span>
<span class="line-added"> 52         waitingBarrier2.waitFor();</span>
<span class="line-added"> 53         synchronized (M) { // tc02t001.c::lines[1]</span>
<span class="line-added"> 54             M.notify();</span>
<span class="line-added"> 55         }</span>
<span class="line-added"> 56 </span>
<span class="line-added"> 57         waitingBarrier3.waitFor();</span>
<span class="line-added"> 58         synchronized (M) { // tc02t001.c::lines[2]</span>
<span class="line-added"> 59             M.notify();</span>
<span class="line-added"> 60         }</span>
<span class="line-added"> 61     }</span>
<span class="line-added"> 62 }</span>
<span class="line-added"> 63 </span>
<span class="line-added"> 64 /* =================================================================== */</span>
 65 
 66 public class tc02t001 extends DebugeeClass {
 67 
 68     // run test from command line
 69     public static void main(String argv[]) {
 70         argv = nsk.share.jvmti.JVMTITest.commonInit(argv);
 71 
 72         // JCK-compatible exit
 73         System.exit(run(argv, System.out) + Consts.JCK_STATUS_BASE);
 74     }
 75 
 76     // run test from JCK-compatible environment
 77     public static int run(String argv[], PrintStream out) {
 78         return new tc02t001().runIt(argv, out);
 79     }
 80 
 81     /* =================================================================== */
 82 
 83     // scaffold objects
 84     ArgumentHandler argHandler = null;
 85     Log log = null;
 86     int status = Consts.TEST_PASSED;
 87     static long timeout = 0;
 88 
<span class="line-added"> 89     private static volatile int lastEnterEventsCount;</span>
<span class="line-added"> 90     private static native   int enterEventsCount();</span>
<span class="line-added"> 91 </span>
 92     // tested thread
 93     tc02t001Thread thread = null;
 94 
<span class="line-added"> 95     static void log (String msg) { System.out.println(msg); }</span>
<span class="line-added"> 96 </span>
<span class="line-added"> 97     private void waitForContendedEnterEvent() {</span>
<span class="line-added"> 98         try {</span>
<span class="line-added"> 99             for (int j = 0; j &lt; (timeout / 20); j++) {</span>
<span class="line-added">100                 Thread.sleep(20);</span>
<span class="line-added">101                 if (enterEventsCount() &gt; lastEnterEventsCount) {</span>
<span class="line-added">102                     log(&quot;Got expected MonitorContendedEnter event\n&quot;);</span>
<span class="line-added">103                     break;</span>
<span class="line-added">104                 }</span>
<span class="line-added">105             }</span>
<span class="line-added">106             if (enterEventsCount() == lastEnterEventsCount) {</span>
<span class="line-added">107                 String msg = &quot;Timeout in waiting for a MonitorContendedEnter event&quot;;</span>
<span class="line-added">108                 throw new RuntimeException(msg);</span>
<span class="line-added">109             }</span>
<span class="line-added">110             thread.M.wait(timeout);</span>
<span class="line-added">111         } catch (InterruptedException e) {</span>
<span class="line-added">112             throw new Failure(e);</span>
<span class="line-added">113         }</span>
<span class="line-added">114     }</span>
<span class="line-added">115 </span>
116     // run debuggee
117     public int runIt(String argv[], PrintStream out) {
118         argHandler = new ArgumentHandler(argv);
119         log = new Log(out, argHandler);
120         timeout = argHandler.getWaitTime() * 60 * 1000;
121         log.display(&quot;Timeout = &quot; + timeout + &quot; msc.&quot;);
122 
123         thread = new tc02t001Thread(&quot;Debuggee Thread&quot;);
124         synchronized (thread.M) {
125             thread.start();
126             thread.startingBarrier.waitFor();
127             status = checkStatus(status);
128 
<span class="line-added">129             lastEnterEventsCount = enterEventsCount();</span>
130             thread.waitingBarrier1.unlock();
<span class="line-modified">131             log(&quot;Waiting for MonitorEnterEvent #1&quot;);</span>
<span class="line-modified">132             waitForContendedEnterEvent();</span>




133 
<span class="line-added">134             lastEnterEventsCount = enterEventsCount();</span>
135             thread.waitingBarrier2.unlock();
<span class="line-modified">136             log(&quot;Waiting for MonitorEnterEvent #2&quot;);</span>
<span class="line-modified">137             waitForContendedEnterEvent();</span>




138 
<span class="line-added">139             lastEnterEventsCount = enterEventsCount();</span>
140             thread.waitingBarrier3.unlock();
<span class="line-modified">141             log(&quot;Waiting for MonitorEnterEvent #3&quot;);</span>
<span class="line-modified">142             waitForContendedEnterEvent();</span>




143         }
144 
145         try {
146             thread.join(timeout);
147         } catch (InterruptedException e) {
148             throw new Failure(e);
149         }
150 
151         log.display(&quot;Debugee finished&quot;);
152         status = checkStatus(status);
153 
154         return status;
155     }
156 }

































</pre>
</td>
</tr>
</table>
<center><a href="../../bcinstr/BI04/bi04t002/newclass02/java.base/java/lang/Object.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="tc02t001/tc02t001.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>