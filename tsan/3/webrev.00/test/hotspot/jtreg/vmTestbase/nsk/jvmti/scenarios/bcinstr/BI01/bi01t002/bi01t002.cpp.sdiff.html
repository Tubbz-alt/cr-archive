<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/hotspot/jtreg/vmTestbase/nsk/jvmti/scenarios/bcinstr/BI01/bi01t002/bi01t002.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../bi01t001/libbi01t001.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="libbi01t002.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/jtreg/vmTestbase/nsk/jvmti/scenarios/bcinstr/BI01/bi01t002/bi01t002.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2004, 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 #include &lt;string.h&gt;
 25 #include &quot;jvmti.h&quot;
 26 #include &quot;agent_common.h&quot;

 27 #include &quot;jni_tools.h&quot;
 28 #include &quot;jvmti_tools.h&quot;
 29 
 30 extern &quot;C&quot; {
 31 
 32 /* scaffold objects */
 33 static jvmtiEnv *jvmti = NULL;
 34 static jlong timeout = 0;
 35 
 36 #define TESTED_CLASS_NAME   &quot;nsk/jvmti/scenarios/bcinstr/BI01/bi01t002a&quot;
 37 #define TOTAL_INSTRUMENTED_CLASSES 2
 38 
 39 static int clsLoadedIdx=0;
 40 static jint newClassSize[TOTAL_INSTRUMENTED_CLASSES];
 41 static unsigned char* newClassBytes[TOTAL_INSTRUMENTED_CLASSES];
 42 static jvmtiClassDefinition oldClassDef[TOTAL_INSTRUMENTED_CLASSES];
 43 
 44 /* ============================================================================= */
 45 /*
 46  * Class:     nsk_jvmti_scenarios_bcinstr_BI01_bi01t002
 47  * Method:    setNewByteCode
 48  * Signature: (I[B)Z
 49  */
 50 JNIEXPORT jboolean JNICALL
 51 Java_nsk_jvmti_scenarios_bcinstr_BI01_bi01t002_setNewByteCode(JNIEnv *jni_env,
 52                         jobject o, jint ind, jbyteArray byteCode) {
 53 

 54     jbyte* elements;
 55     jboolean isCopy;
 56 
<span class="line-modified"> 57     newClassSize[ind] = jni_env-&gt;GetArrayLength(byteCode);</span>
<span class="line-modified"> 58     if (!NSK_JNI_VERIFY(jni_env, newClassSize[ind] &gt; 0)) {</span>
 59         nsk_jvmti_setFailStatus();
 60         return NSK_FALSE;
 61     }
 62     NSK_DISPLAY1(&quot;\t... got array size: %d\n&quot;, newClassSize[ind]);
 63 
<span class="line-modified"> 64     elements = jni_env-&gt;GetByteArrayElements(byteCode, &amp;isCopy);</span>
<span class="line-removed"> 65     if (!NSK_JNI_VERIFY(jni_env, elements != NULL)) {</span>
<span class="line-removed"> 66         nsk_jvmti_setFailStatus();</span>
<span class="line-removed"> 67         return NSK_FALSE;</span>
<span class="line-removed"> 68     }</span>
 69     NSK_DISPLAY1(&quot;\t... got elements list: 0x%p\n&quot;, (void*)elements);
 70 
 71     if (!NSK_JVMTI_VERIFY(jvmti-&gt;Allocate(newClassSize[ind], &amp;newClassBytes[ind]))) {
 72         nsk_jvmti_setFailStatus();
 73         return NSK_FALSE;
 74     }
 75     NSK_DISPLAY1(&quot;\t... created bytes array: 0x%p\n&quot;, (void*)newClassBytes[ind]);
 76 
 77     {
 78         int j;
 79         for (j = 0; j &lt; newClassSize[ind]; j++)
 80             newClassBytes[ind][j] = (unsigned char)elements[j];
 81     }
 82     NSK_DISPLAY1(&quot;\t... copied bytecode: %d bytes\n&quot;, (int)newClassSize[ind]);
 83 
 84     NSK_DISPLAY1(&quot;\t... release elements list: 0x%p\n&quot;, (void*)elements);
<span class="line-modified"> 85     NSK_TRACE(jni_env-&gt;ReleaseByteArrayElements(byteCode, elements, JNI_ABORT));</span>
 86     NSK_DISPLAY0(&quot;\t... released\n&quot;);
 87     return NSK_TRUE;
 88 }
 89 
 90 /* ============================================================================= */
 91 /*
 92  * Class:     nsk_jvmti_scenarios_bcinstr_BI01_bi01t002
 93  * Method:    setClass
 94  * Signature: (ILjava/lang/Class;)V
 95  */
 96 JNIEXPORT void JNICALL
 97 Java_nsk_jvmti_scenarios_bcinstr_BI01_bi01t002_setClass(JNIEnv *jni_env,
 98                         jobject o, jint ind, jclass cls) {
 99 
<span class="line-modified">100     oldClassDef[ind].klass = (jclass) jni_env-&gt;NewGlobalRef(cls);</span>
<span class="line-modified">101     if (!NSK_JNI_VERIFY(jni_env, oldClassDef[ind].klass != NULL)) {</span>
<span class="line-removed">102         nsk_jvmti_setFailStatus();</span>
<span class="line-removed">103     }</span>
104 }
105 
106 /* ============================================================================= */
107 
108 /** Callback function for ClassFileLoadHook event. */
109 JNIEXPORT void JNICALL
110 cbClassFileLoadHook(jvmtiEnv *jvmti_env, JNIEnv* jni_env,
111             jclass class_being_redefined, jobject loader, const char* name,
112             jobject protection_domain, jint class_data_len,
113             const unsigned char* class_data, jint* new_class_data_len,
114             unsigned char** new_class_data) {
115 
116     if (name == NULL || strcmp(name, TESTED_CLASS_NAME)) {
117         return;
118     }
119 
120     NSK_DISPLAY3(&quot;CLASS_FILE_LOAD_HOOK event: %s\n\treceived bytecode: 0x%p:%d\n&quot;,
121                         name, (void *)class_data, class_data_len);
122     if (nsk_getVerboseMode()) {
123         nsk_printHexBytes(&quot;   &quot;, 16, class_data_len, class_data);
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2004, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 #include &lt;string.h&gt;
 25 #include &quot;jvmti.h&quot;
 26 #include &quot;agent_common.h&quot;
<span class="line-added"> 27 #include &quot;ExceptionCheckingJniEnv.hpp&quot;</span>
 28 #include &quot;jni_tools.h&quot;
 29 #include &quot;jvmti_tools.h&quot;
 30 
 31 extern &quot;C&quot; {
 32 
 33 /* scaffold objects */
 34 static jvmtiEnv *jvmti = NULL;
 35 static jlong timeout = 0;
 36 
 37 #define TESTED_CLASS_NAME   &quot;nsk/jvmti/scenarios/bcinstr/BI01/bi01t002a&quot;
 38 #define TOTAL_INSTRUMENTED_CLASSES 2
 39 
 40 static int clsLoadedIdx=0;
 41 static jint newClassSize[TOTAL_INSTRUMENTED_CLASSES];
 42 static unsigned char* newClassBytes[TOTAL_INSTRUMENTED_CLASSES];
 43 static jvmtiClassDefinition oldClassDef[TOTAL_INSTRUMENTED_CLASSES];
 44 
 45 /* ============================================================================= */
 46 /*
 47  * Class:     nsk_jvmti_scenarios_bcinstr_BI01_bi01t002
 48  * Method:    setNewByteCode
 49  * Signature: (I[B)Z
 50  */
 51 JNIEXPORT jboolean JNICALL
 52 Java_nsk_jvmti_scenarios_bcinstr_BI01_bi01t002_setNewByteCode(JNIEnv *jni_env,
 53                         jobject o, jint ind, jbyteArray byteCode) {
 54 
<span class="line-added"> 55     ExceptionCheckingJniEnvPtr ec_jni(jni_env);</span>
 56     jbyte* elements;
 57     jboolean isCopy;
 58 
<span class="line-modified"> 59     newClassSize[ind] = ec_jni-&gt;GetArrayLength(byteCode, TRACE_JNI_CALL);</span>
<span class="line-modified"> 60     if (!NSK_VERIFY(newClassSize[ind] &gt; 0)) {</span>
 61         nsk_jvmti_setFailStatus();
 62         return NSK_FALSE;
 63     }
 64     NSK_DISPLAY1(&quot;\t... got array size: %d\n&quot;, newClassSize[ind]);
 65 
<span class="line-modified"> 66     elements = ec_jni-&gt;GetByteArrayElements(byteCode, &amp;isCopy, TRACE_JNI_CALL);</span>




 67     NSK_DISPLAY1(&quot;\t... got elements list: 0x%p\n&quot;, (void*)elements);
 68 
 69     if (!NSK_JVMTI_VERIFY(jvmti-&gt;Allocate(newClassSize[ind], &amp;newClassBytes[ind]))) {
 70         nsk_jvmti_setFailStatus();
 71         return NSK_FALSE;
 72     }
 73     NSK_DISPLAY1(&quot;\t... created bytes array: 0x%p\n&quot;, (void*)newClassBytes[ind]);
 74 
 75     {
 76         int j;
 77         for (j = 0; j &lt; newClassSize[ind]; j++)
 78             newClassBytes[ind][j] = (unsigned char)elements[j];
 79     }
 80     NSK_DISPLAY1(&quot;\t... copied bytecode: %d bytes\n&quot;, (int)newClassSize[ind]);
 81 
 82     NSK_DISPLAY1(&quot;\t... release elements list: 0x%p\n&quot;, (void*)elements);
<span class="line-modified"> 83     NSK_TRACE(ec_jni-&gt;ReleaseByteArrayElements(byteCode, elements, JNI_ABORT, TRACE_JNI_CALL));</span>
 84     NSK_DISPLAY0(&quot;\t... released\n&quot;);
 85     return NSK_TRUE;
 86 }
 87 
 88 /* ============================================================================= */
 89 /*
 90  * Class:     nsk_jvmti_scenarios_bcinstr_BI01_bi01t002
 91  * Method:    setClass
 92  * Signature: (ILjava/lang/Class;)V
 93  */
 94 JNIEXPORT void JNICALL
 95 Java_nsk_jvmti_scenarios_bcinstr_BI01_bi01t002_setClass(JNIEnv *jni_env,
 96                         jobject o, jint ind, jclass cls) {
 97 
<span class="line-modified"> 98     ExceptionCheckingJniEnvPtr ec_jni(jni_env);</span>
<span class="line-modified"> 99     oldClassDef[ind].klass = (jclass) ec_jni-&gt;NewGlobalRef(cls, TRACE_JNI_CALL);</span>


100 }
101 
102 /* ============================================================================= */
103 
104 /** Callback function for ClassFileLoadHook event. */
105 JNIEXPORT void JNICALL
106 cbClassFileLoadHook(jvmtiEnv *jvmti_env, JNIEnv* jni_env,
107             jclass class_being_redefined, jobject loader, const char* name,
108             jobject protection_domain, jint class_data_len,
109             const unsigned char* class_data, jint* new_class_data_len,
110             unsigned char** new_class_data) {
111 
112     if (name == NULL || strcmp(name, TESTED_CLASS_NAME)) {
113         return;
114     }
115 
116     NSK_DISPLAY3(&quot;CLASS_FILE_LOAD_HOOK event: %s\n\treceived bytecode: 0x%p:%d\n&quot;,
117                         name, (void *)class_data, class_data_len);
118     if (nsk_getVerboseMode()) {
119         nsk_printHexBytes(&quot;   &quot;, 16, class_data_len, class_data);
</pre>
</td>
</tr>
</table>
<center><a href="../bi01t001/libbi01t001.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="libbi01t002.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>