<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/hotspot/jtreg/vmTestbase/nsk/share/jni/ExceptionCheckingJniEnv.cpp</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="line-modified">  3  * Copyright (c) 2018, Google and/or its affiliates. All rights reserved.</span>
  4  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  5  *
  6  * This code is free software; you can redistribute it and/or modify it
  7  * under the terms of the GNU General Public License version 2 only, as
  8  * published by the Free Software Foundation.
  9  *
 10  * This code is distributed in the hope that it will be useful, but WITHOUT
 11  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 12  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 13  * version 2 for more details (a copy is included in the LICENSE file that
 14  * accompanied this code).
 15  *
 16  * You should have received a copy of the GNU General Public License version
 17  * 2 along with this work; if not, write to the Free Software Foundation,
 18  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 19  *
 20  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 21  * or visit www.oracle.com if you need additional information or have any
 22  * questions.
 23  */
 24 
<a name="2" id="anc2"></a>
 25 #include &lt;stdlib.h&gt;
 26 #include &lt;string.h&gt;
 27 
 28 #include &quot;ExceptionCheckingJniEnv.hpp&quot;
<a name="3" id="anc3"></a>
 29 
 30 namespace {
 31 
<a name="4" id="anc4"></a>















 32 template&lt;class T = void*&gt;
 33 class JNIVerifier {
 34  public:
<a name="5" id="anc5"></a><span class="line-modified"> 35   JNIVerifier(ExceptionCheckingJniEnv *env, const char* base_msg)</span>
<span class="line-modified"> 36       : _env(env), _base_msg(base_msg), _return_error(NULL) {</span>































 37   }
 38 
 39   ~JNIVerifier() {
<a name="6" id="anc6"></a>

 40     JNIEnv* jni_env = _env-&gt;GetJNIEnv();
<a name="7" id="anc7"></a><span class="line-modified"> 41     if (jni_env-&gt;ExceptionCheck()) {</span>
<span class="line-modified"> 42       _env-&gt;HandleError(_base_msg);</span>

































 43       return;
 44     }
 45 
<a name="8" id="anc8"></a><span class="line-modified"> 46     if (_return_error != NULL) {</span>
<span class="line-modified"> 47       ProcessReturnError();</span>


 48     }
<a name="9" id="anc9"></a>

 49   }
 50 
<a name="10" id="anc10"></a><span class="line-modified"> 51   void ProcessReturnError() {</span>
 52     // This is error prone, but:
 53     //   - Seems like we cannot use std::string (due to windows/solaris not
 54     //   building when used, seemingly due to exception libraries not linking).
 55     //   - Seems like we cannot use sprintf due to VS2013 (JDK-8213622).
 56     //
 57     //   We are aiming to do:
<a name="11" id="anc11"></a><span class="line-modified"> 58     //     snprintf(full_message, len, &quot;%s : %s&quot;, _base_msg, _return_error);</span>

 59     //   but will use strlen + memcpy instead.
<a name="12" id="anc12"></a><span class="line-modified"> 60     size_t base_len = strlen(_base_msg);</span>
 61     const char* between_msg = &quot; : &quot;;
<a name="13" id="anc13"></a><span class="line-modified"> 62     size_t between_len = strlen(between_msg);</span>
<span class="line-modified"> 63     size_t return_len = strlen(_return_error);</span>










 64 
<a name="14" id="anc14"></a><span class="line-modified"> 65     // +1 for the &#39;\0&#39;</span>
<span class="line-modified"> 66     size_t len = base_len + between_len + return_len + 1;</span>








 67 
 68     char* full_message = (char*) malloc(len);
 69     if (full_message == NULL) {
<a name="15" id="anc15"></a><span class="line-modified"> 70       _env-&gt;HandleError(_return_error);</span>
 71       return;
 72     }
 73 
<a name="16" id="anc16"></a><span class="line-modified"> 74     // Now we construct the string using memcpy to not use sprintf/std::string</span>
 75     // instead of:
<a name="17" id="anc17"></a><span class="line-modified"> 76     //     snprintf(full_message, len, &quot;%s : %s&quot;, _base_msg, _return_error);</span>
<span class="line-modified"> 77     memcpy(full_message, _base_msg, base_len);</span>
<span class="line-modified"> 78     memcpy(full_message + base_len, between_msg, between_len);</span>
<span class="line-modified"> 79     memcpy(full_message + base_len + between_len, _return_error, return_len);</span>
<span class="line-modified"> 80     full_message[len - 1] = &#39;\0&#39;;</span>

 81 
<a name="18" id="anc18"></a><span class="line-modified"> 82     // -1 due to the &#39;\0&#39; not counted by strlen but is counted for the allocation.</span>
<span class="line-modified"> 83     if (strlen(full_message) != len - 1) {</span>
<span class="line-modified"> 84       _env-&gt;GetJNIEnv()-&gt;FatalError(&quot;Length of message is not what was expected&quot;);</span>


 85     }
 86 
 87     _env-&gt;HandleError(full_message);
 88     free(full_message);
 89   }
 90 
 91   T ResultNotNull(T ptr) {
 92     if (ptr == NULL) {
<a name="19" id="anc19"></a><span class="line-modified"> 93       _return_error = &quot;Return is NULL&quot;;</span>
 94     }
 95     return ptr;
 96   }
 97 
<a name="20" id="anc20"></a>






































































 98  private:
 99   ExceptionCheckingJniEnv* _env;
<a name="21" id="anc21"></a><span class="line-modified">100   const char* const _base_msg;</span>
<span class="line-modified">101   const char* _return_error;</span>


102 };
103 
104 }
105 
<a name="22" id="anc22"></a><span class="line-modified">106 jclass ExceptionCheckingJniEnv::GetObjectClass(jobject obj) {</span>
<span class="line-modified">107   JNIVerifier&lt;jclass&gt; marker(this, &quot;GetObjectClass&quot;);</span>
















108   return marker.ResultNotNull(_jni_env-&gt;GetObjectClass(obj));
109 }
110 
<a name="23" id="anc23"></a><span class="line-modified">111 jfieldID ExceptionCheckingJniEnv::GetFieldID(jclass klass, const char *name, const char* type) {</span>
<span class="line-modified">112   JNIVerifier&lt;jfieldID&gt; marker(this, &quot;GetFieldID&quot;);</span>










113   return marker.ResultNotNull(_jni_env-&gt;GetFieldID(klass, name, type));
114 }
115 
<a name="24" id="anc24"></a><span class="line-modified">116 jobject ExceptionCheckingJniEnv::GetObjectField(jobject obj, jfieldID field) {</span>
<span class="line-modified">117   JNIVerifier&lt;jobject&gt; marker(this, &quot;GetObjectField&quot;);</span>








118   return marker.ResultNotNull(_jni_env-&gt;GetObjectField(obj, field));
119 }
120 
<a name="25" id="anc25"></a><span class="line-modified">121 void ExceptionCheckingJniEnv::SetObjectField(jobject obj, jfieldID field, jobject value) {</span>
<span class="line-modified">122   JNIVerifier&lt;&gt; marker(this, &quot;SetObjectField&quot;);</span>

123   _jni_env-&gt;SetObjectField(obj, field, value);
124 }
125 
<a name="26" id="anc26"></a><span class="line-modified">126 jobject ExceptionCheckingJniEnv::NewGlobalRef(jobject obj) {</span>
<span class="line-modified">127   JNIVerifier&lt;jobject&gt; marker(this, &quot;NewGlobalRef&quot;);</span>
128   return marker.ResultNotNull(_jni_env-&gt;NewGlobalRef(obj));
129 }
130 
<a name="27" id="anc27"></a><span class="line-modified">131 void ExceptionCheckingJniEnv::DeleteGlobalRef(jobject obj) {</span>
<span class="line-modified">132   JNIVerifier&lt;&gt; marker(this, &quot;DeleteGlobalRef&quot;);</span>
133   _jni_env-&gt;DeleteGlobalRef(obj);
134 }
135 
<a name="28" id="anc28"></a><span class="line-modified">136 jobject ExceptionCheckingJniEnv::NewLocalRef(jobject obj) {</span>
<span class="line-modified">137   JNIVerifier&lt;jobject&gt; marker(this, &quot;NewLocalRef&quot;);</span>
138   return marker.ResultNotNull(_jni_env-&gt;NewLocalRef(obj));
139 }
140 
<a name="29" id="anc29"></a><span class="line-modified">141 void ExceptionCheckingJniEnv::DeleteLocalRef(jobject obj) {</span>
<span class="line-modified">142   JNIVerifier&lt;&gt; marker(this, &quot;DeleteLocalRef&quot;);</span>
143   _jni_env-&gt;DeleteLocalRef(obj);
144 }
145 
<a name="30" id="anc30"></a><span class="line-modified">146 jweak ExceptionCheckingJniEnv::NewWeakGlobalRef(jobject obj) {</span>
<span class="line-modified">147   JNIVerifier&lt;jweak&gt; marker(this, &quot;NewWeakGlobalRef&quot;);</span>
148   return marker.ResultNotNull(_jni_env-&gt;NewWeakGlobalRef(obj));
149 }
150 
<a name="31" id="anc31"></a><span class="line-modified">151 void ExceptionCheckingJniEnv::DeleteWeakGlobalRef(jweak weak_ref) {</span>
<span class="line-modified">152   JNIVerifier&lt;&gt; marker(this, &quot;DeleteWeakGlobalRef&quot;);</span>
153   _jni_env-&gt;DeleteWeakGlobalRef(weak_ref);
154 }
155 
<a name="32" id="anc32"></a><span class="line-modified">156 jsize ExceptionCheckingJniEnv::GetArrayLength(jarray array) {</span>
<span class="line-modified">157   JNIVerifier&lt;&gt; marker(this, &quot;GetArrayLength&quot;);</span>
158   return _jni_env-&gt;GetArrayLength(array);
159 }
160 
<a name="33" id="anc33"></a><span class="line-modified">161 jsize ExceptionCheckingJniEnv::GetStringLength(jstring str) {</span>
<span class="line-modified">162   JNIVerifier&lt;&gt; marker(this, &quot;GetStringLength&quot;);</span>
163   return _jni_env-&gt;GetStringLength(str);
164 }
165 
<a name="34" id="anc34"></a><span class="line-modified">166 void* ExceptionCheckingJniEnv::GetPrimitiveArrayCritical(jarray array, jboolean* isCopy) {</span>
<span class="line-modified">167   JNIVerifier&lt;&gt; marker(this, &quot;GetPrimitiveArrayCritical&quot;);</span>
<span class="line-modified">168   return marker.ResultNotNull(_jni_env-&gt;GetPrimitiveArrayCritical(array, isCopy));</span>

169 }
170 
<a name="35" id="anc35"></a><span class="line-modified">171 void ExceptionCheckingJniEnv::ReleasePrimitiveArrayCritical(jarray array, void* carray, jint mode) {</span>
<span class="line-modified">172   JNIVerifier&lt;&gt; marker(this, &quot;ReleasePrimitiveArrayCritical&quot;);</span>


173   _jni_env-&gt;ReleasePrimitiveArrayCritical(array, carray, mode);
174 }
175 
<a name="36" id="anc36"></a><span class="line-modified">176 const jchar* ExceptionCheckingJniEnv::GetStringCritical(jstring str, jboolean* isCopy) {</span>
<span class="line-modified">177   JNIVerifier&lt;const jchar*&gt; marker(this, &quot;GetPrimitiveArrayCritical&quot;);</span>
<span class="line-modified">178   return marker.ResultNotNull(_jni_env-&gt;GetStringCritical(str, isCopy));</span>


179 }
180 
<a name="37" id="anc37"></a><span class="line-modified">181 void ExceptionCheckingJniEnv::ReleaseStringCritical(jstring str, const jchar* carray) {</span>
<span class="line-modified">182   JNIVerifier&lt;&gt; marker(this, &quot;ReleaseStringCritical&quot;);</span>

183   _jni_env-&gt;ReleaseStringCritical(str, carray);
184 }
<a name="38" id="anc38"></a>






























































<a name="39" id="anc39"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="39" type="hidden" />
</body>
</html>