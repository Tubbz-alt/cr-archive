<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff test/hotspot/jtreg/vmTestbase/nsk/jvmti/unit/FollowReferences/followref001/followref001.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../scenarios/sampling/SP06/sp06t003/sp06t003.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="../followref003/followref003.cpp.cdiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/jtreg/vmTestbase/nsk/jvmti/unit/FollowReferences/followref001/followref001.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2007, 2018, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2007, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 99,12 ***</span>
  
  
  /* ============================================================================= */
  
  static int get_reference_index(jvmtiHeapReferenceKind   reference_kind,
<span class="line-modified">!                                const jvmtiHeapReferenceInfo* reference_info)</span>
<span class="line-removed">- {</span>
      int referrer_index = 0;
  
      switch (reference_kind) {
          case JVMTI_HEAP_REFERENCE_CONSTANT_POOL:
              referrer_index = reference_info-&gt;constant_pool.index;
<span class="line-new-header">--- 99,11 ---</span>
  
  
  /* ============================================================================= */
  
  static int get_reference_index(jvmtiHeapReferenceKind   reference_kind,
<span class="line-modified">!                                const jvmtiHeapReferenceInfo* reference_info) {</span>
      int referrer_index = 0;
  
      switch (reference_kind) {
          case JVMTI_HEAP_REFERENCE_CONSTANT_POOL:
              referrer_index = reference_info-&gt;constant_pool.index;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 130,24 ***</span>
      return referrer_index;
  } /* get_reference_index */
  
  
  /** Initialize objectDescList. */
<span class="line-modified">! static int initObjectDescList(jvmtiEnv*    jvmti,</span>
<span class="line-modified">!                               int          chainLength,</span>
<span class="line-modified">!                               int*         objectsCount,</span>
<span class="line-modified">!                               ObjectDesc** objectDescList)</span>
<span class="line-removed">- {</span>
      /* root object + reachable and unreachable object chains */
      *objectsCount = 1 + 2 * chainLength;
  
      printf(&quot;Allocate memory for objects list: %d objects\n&quot;, *objectsCount);
      fflush(0);
      if (!NSK_JVMTI_VERIFY(jvmti-&gt;Allocate((*objectsCount * sizeof(ObjectDesc)),
                                            (unsigned char**) objectDescList))) {
          nsk_jvmti_setFailStatus();
<span class="line-modified">!         return NSK_FALSE;</span>
      }
      printf(&quot;  ... allocated array: 0x%p\n&quot;, (void*)objectDescList);
      fflush(0);
  
      {
<span class="line-new-header">--- 129,23 ---</span>
      return referrer_index;
  } /* get_reference_index */
  
  
  /** Initialize objectDescList. */
<span class="line-modified">! static bool initObjectDescList(jvmtiEnv*    jvmti,</span>
<span class="line-modified">!                                int          chainLength,</span>
<span class="line-modified">!                                int*         objectsCount,</span>
<span class="line-modified">!                                ObjectDesc** objectDescList) {</span>
      /* root object + reachable and unreachable object chains */
      *objectsCount = 1 + 2 * chainLength;
  
      printf(&quot;Allocate memory for objects list: %d objects\n&quot;, *objectsCount);
      fflush(0);
      if (!NSK_JVMTI_VERIFY(jvmti-&gt;Allocate((*objectsCount * sizeof(ObjectDesc)),
                                            (unsigned char**) objectDescList))) {
          nsk_jvmti_setFailStatus();
<span class="line-modified">!         return false;</span>
      }
      printf(&quot;  ... allocated array: 0x%p\n&quot;, (void*)objectDescList);
      fflush(0);
  
      {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 164,34 ***</span>
  
      /* Object with tag=100 must be referenced 2 times */
      (*objectDescList)[chainLength].exp_found = 1;
  
  
<span class="line-modified">!      return NSK_TRUE;</span>
  } /* initObjectDescList */
  
  
  /** Find and tag classes. */
<span class="line-modified">! static int getAndTagClasses(jvmtiEnv*    jvmti,</span>
<span class="line-modified">!                             JNIEnv*      jni,</span>
<span class="line-modified">!                             jclass*      debugeeClass,</span>
<span class="line-modified">!                             jclass*      rootObjectClass,</span>
<span class="line-modified">!                             jclass*      chainObjectClass)</span>
<span class="line-removed">- {</span>
  
      if (!NSK_JNI_VERIFY(jni, (*debugeeClass = jni-&gt;FindClass(DEBUGEE_CLASS_NAME)) != NULL)) {
          nsk_jvmti_setFailStatus();
<span class="line-modified">!         return NSK_FALSE;</span>
      }
      printf(&quot;\nFound debugee class: 0x%p\n  %s\n&quot;,
             (void*) *debugeeClass, DEBUGEE_CLASS_NAME);
      fflush(0);
  
      if (!NSK_JNI_VERIFY(jni, (*rootObjectClass =
              jni-&gt;FindClass(ROOT_OBJECT_CLASS_NAME)) != NULL)) {
          nsk_jvmti_setFailStatus();
<span class="line-modified">!         return NSK_FALSE;</span>
      }
  
      if (!NSK_JVMTI_VERIFY(jvmti-&gt;SetTag(*rootObjectClass, ROOT_CLASS_TAG))) {
          nsk_jvmti_setFailStatus();
      }
<span class="line-new-header">--- 162,33 ---</span>
  
      /* Object with tag=100 must be referenced 2 times */
      (*objectDescList)[chainLength].exp_found = 1;
  
  
<span class="line-modified">!      return true;</span>
  } /* initObjectDescList */
  
  
  /** Find and tag classes. */
<span class="line-modified">! static bool getAndTagClasses(jvmtiEnv*    jvmti,</span>
<span class="line-modified">!                              JNIEnv*      jni,</span>
<span class="line-modified">!                              jclass*      debugeeClass,</span>
<span class="line-modified">!                              jclass*      rootObjectClass,</span>
<span class="line-modified">!                              jclass*      chainObjectClass) {</span>
  
      if (!NSK_JNI_VERIFY(jni, (*debugeeClass = jni-&gt;FindClass(DEBUGEE_CLASS_NAME)) != NULL)) {
          nsk_jvmti_setFailStatus();
<span class="line-modified">!         return false;</span>
      }
      printf(&quot;\nFound debugee class: 0x%p\n  %s\n&quot;,
             (void*) *debugeeClass, DEBUGEE_CLASS_NAME);
      fflush(0);
  
      if (!NSK_JNI_VERIFY(jni, (*rootObjectClass =
              jni-&gt;FindClass(ROOT_OBJECT_CLASS_NAME)) != NULL)) {
          nsk_jvmti_setFailStatus();
<span class="line-modified">!         return false;</span>
      }
  
      if (!NSK_JVMTI_VERIFY(jvmti-&gt;SetTag(*rootObjectClass, ROOT_CLASS_TAG))) {
          nsk_jvmti_setFailStatus();
      }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 203,119 ***</span>
  
  
      if (!NSK_JNI_VERIFY(jni, (*chainObjectClass =
              jni-&gt;FindClass(CHAIN_OBJECT_CLASS_NAME)) != NULL)) {
          nsk_jvmti_setFailStatus();
<span class="line-modified">!         return NSK_FALSE;</span>
      }
  
      if (!NSK_JVMTI_VERIFY(jvmti-&gt;SetTag(*chainObjectClass, CHAIN_CLASS_TAG))) {
          nsk_jvmti_setFailStatus();
      }
      printf(&quot;\nFound chain object class: 0x%p, tag=%ld\n  %s\n&quot;,
             (void*) *chainObjectClass, (long) CHAIN_CLASS_TAG,
             CHAIN_OBJECT_CLASS_NAME);
      fflush(0);
  
<span class="line-modified">!      return NSK_TRUE;</span>
  } /* getAndTagClasses */
  
  
  /** Obtain chain of tested objects and tag them recursively. */
<span class="line-modified">! static int getFieldsAndObjects(jvmtiEnv*  jvmti,</span>
<span class="line-modified">!                              JNIEnv*     jni,</span>
<span class="line-modified">!                              jclass      debugeeClass,</span>
<span class="line-modified">!                              jclass      rootObjectClass,</span>
<span class="line-modified">!                              jclass      chainObjectClass,</span>
<span class="line-modified">!                              jobject*    rootObjectPtr,</span>
<span class="line-modified">!                              jfieldID*   reachableChainField,</span>
<span class="line-modified">!                              jfieldID*   unreachableChainField,</span>
<span class="line-modified">!                              jfieldID*   nextField)</span>
<span class="line-removed">- {</span>
      jfieldID rootObjectField = NULL;
  
      if (!NSK_JNI_VERIFY(jni, (rootObjectField =
              jni-&gt;GetStaticFieldID(debugeeClass, OBJECT_FIELD_NAME, ROOT_OBJECT_CLASS_SIG)) != NULL)) {
          nsk_jvmti_setFailStatus();
<span class="line-modified">!         return NSK_FALSE;</span>
      }
      printf(&quot;\nFound fieldID: 0x%p - \&#39;%s\&#39; static field in debugee class\n&quot;,
             (void*) rootObjectField, OBJECT_FIELD_NAME);
      fflush(0);
  
      if (!NSK_JNI_VERIFY(jni, (*reachableChainField =
              jni-&gt;GetFieldID(rootObjectClass, REACHABLE_CHAIN_FIELD_NAME, CHAIN_OBJECT_CLASS_SIG)) != NULL)) {
          nsk_jvmti_setFailStatus();
<span class="line-modified">!         return NSK_FALSE;</span>
      }
      printf(&quot;\nFound fieldID: 0x%p - \&#39;%s\&#39; field in root object class\n&quot;,
             (void*) reachableChainField, REACHABLE_CHAIN_FIELD_NAME);
      fflush(0);
  
      if (!NSK_JNI_VERIFY(jni, (*unreachableChainField =
              jni-&gt;GetFieldID(rootObjectClass, UNREACHABLE_CHAIN_FIELD_NAME, CHAIN_OBJECT_CLASS_SIG)) != NULL)) {
          nsk_jvmti_setFailStatus();
<span class="line-modified">!         return NSK_FALSE;</span>
      }
  
      printf(&quot;\nFound fieldID: 0x%p - \&#39;%s\&#39; field in root object class\n&quot;,
             (void*) unreachableChainField, UNREACHABLE_CHAIN_FIELD_NAME);
      fflush(0);
  
      if (!NSK_JNI_VERIFY(jni, (*nextField =
              jni-&gt;GetFieldID(chainObjectClass, NEXT_FIELD_NAME, CHAIN_OBJECT_CLASS_SIG)) != NULL)) {
          nsk_jvmti_setFailStatus();
<span class="line-modified">!         return NSK_FALSE;</span>
      }
      printf(&quot;\nFound fieldID: 0x%p - \&#39;%s\&#39; field in chain object class\n&quot;,
             (void*) nextField, NEXT_FIELD_NAME);
      fflush(0);
  
      if (!NSK_JNI_VERIFY(jni, (*rootObjectPtr =
              jni-&gt;GetStaticObjectField(debugeeClass, rootObjectField)) != NULL)) {
          nsk_jvmti_setFailStatus();
<span class="line-modified">!         return NSK_FALSE;</span>
      }
      printf(&quot;\nFound root object: 0x%p\n&quot;, (void*) *rootObjectPtr);
      fflush(0);
  
      if (!NSK_JNI_VERIFY(jni, (*rootObjectPtr = jni-&gt;NewGlobalRef(*rootObjectPtr)) != NULL)) {
          nsk_jvmti_setFailStatus();
<span class="line-modified">!         return NSK_FALSE;</span>
      }
      printf(&quot;Created root object global ref: 0x%p\n&quot;, (void*)*rootObjectPtr);
      fflush(0);
  
<span class="line-modified">!      return NSK_TRUE;</span>
  } /* getFieldsAndObjects */
  
  
  /** Obtain chain of tested objects and tag them recursively. */
<span class="line-modified">! static int getAndTagChainObjects(</span>
      jvmtiEnv*  jvmti,
      JNIEnv*    jni,
      jobject    currObj,
      jfieldID   refField,
      jfieldID   nextField,
      int        count,
      ObjectDesc objectDescList[],
      jlong      tag,
<span class="line-modified">!     int        reachable)</span>
<span class="line-removed">- {</span>
      jobject nextObj = NULL;
      jlong objTag = (reachable ? tag : -tag);
  
      if (count &lt;= 0) {
<span class="line-modified">!         return NSK_TRUE;</span>
      }
  
      count--;
      tag++;
  
      if (!NSK_JNI_VERIFY(jni, (nextObj = jni-&gt;GetObjectField(currObj, refField)) != NULL)) {
          nsk_jvmti_setFailStatus();
<span class="line-modified">!         return NSK_FALSE;</span>
      }
  
      objectDescList[count].tag = objTag;
      if (reachable) {
          objectDescList[count].exp_found++;
<span class="line-new-header">--- 200,117 ---</span>
  
  
      if (!NSK_JNI_VERIFY(jni, (*chainObjectClass =
              jni-&gt;FindClass(CHAIN_OBJECT_CLASS_NAME)) != NULL)) {
          nsk_jvmti_setFailStatus();
<span class="line-modified">!         return false;</span>
      }
  
      if (!NSK_JVMTI_VERIFY(jvmti-&gt;SetTag(*chainObjectClass, CHAIN_CLASS_TAG))) {
          nsk_jvmti_setFailStatus();
      }
      printf(&quot;\nFound chain object class: 0x%p, tag=%ld\n  %s\n&quot;,
             (void*) *chainObjectClass, (long) CHAIN_CLASS_TAG,
             CHAIN_OBJECT_CLASS_NAME);
      fflush(0);
  
<span class="line-modified">!      return true;</span>
  } /* getAndTagClasses */
  
  
  /** Obtain chain of tested objects and tag them recursively. */
<span class="line-modified">! static bool getFieldsAndObjects(jvmtiEnv*  jvmti,</span>
<span class="line-modified">!                                 JNIEnv*    jni,</span>
<span class="line-modified">!                                 jclass     debugeeClass,</span>
<span class="line-modified">!                                 jclass     rootObjectClass,</span>
<span class="line-modified">!                                 jclass     chainObjectClass,</span>
<span class="line-modified">!                                 jobject*   rootObjectPtr,</span>
<span class="line-modified">!                                 jfieldID*  reachableChainField,</span>
<span class="line-modified">!                                 jfieldID*  unreachableChainField,</span>
<span class="line-modified">!                                 jfieldID*  nextField) {</span>
      jfieldID rootObjectField = NULL;
  
      if (!NSK_JNI_VERIFY(jni, (rootObjectField =
              jni-&gt;GetStaticFieldID(debugeeClass, OBJECT_FIELD_NAME, ROOT_OBJECT_CLASS_SIG)) != NULL)) {
          nsk_jvmti_setFailStatus();
<span class="line-modified">!         return false;</span>
      }
      printf(&quot;\nFound fieldID: 0x%p - \&#39;%s\&#39; static field in debugee class\n&quot;,
             (void*) rootObjectField, OBJECT_FIELD_NAME);
      fflush(0);
  
      if (!NSK_JNI_VERIFY(jni, (*reachableChainField =
              jni-&gt;GetFieldID(rootObjectClass, REACHABLE_CHAIN_FIELD_NAME, CHAIN_OBJECT_CLASS_SIG)) != NULL)) {
          nsk_jvmti_setFailStatus();
<span class="line-modified">!         return false;</span>
      }
      printf(&quot;\nFound fieldID: 0x%p - \&#39;%s\&#39; field in root object class\n&quot;,
             (void*) reachableChainField, REACHABLE_CHAIN_FIELD_NAME);
      fflush(0);
  
      if (!NSK_JNI_VERIFY(jni, (*unreachableChainField =
              jni-&gt;GetFieldID(rootObjectClass, UNREACHABLE_CHAIN_FIELD_NAME, CHAIN_OBJECT_CLASS_SIG)) != NULL)) {
          nsk_jvmti_setFailStatus();
<span class="line-modified">!         return false;</span>
      }
  
      printf(&quot;\nFound fieldID: 0x%p - \&#39;%s\&#39; field in root object class\n&quot;,
             (void*) unreachableChainField, UNREACHABLE_CHAIN_FIELD_NAME);
      fflush(0);
  
      if (!NSK_JNI_VERIFY(jni, (*nextField =
              jni-&gt;GetFieldID(chainObjectClass, NEXT_FIELD_NAME, CHAIN_OBJECT_CLASS_SIG)) != NULL)) {
          nsk_jvmti_setFailStatus();
<span class="line-modified">!         return false;</span>
      }
      printf(&quot;\nFound fieldID: 0x%p - \&#39;%s\&#39; field in chain object class\n&quot;,
             (void*) nextField, NEXT_FIELD_NAME);
      fflush(0);
  
      if (!NSK_JNI_VERIFY(jni, (*rootObjectPtr =
              jni-&gt;GetStaticObjectField(debugeeClass, rootObjectField)) != NULL)) {
          nsk_jvmti_setFailStatus();
<span class="line-modified">!         return false;</span>
      }
      printf(&quot;\nFound root object: 0x%p\n&quot;, (void*) *rootObjectPtr);
      fflush(0);
  
      if (!NSK_JNI_VERIFY(jni, (*rootObjectPtr = jni-&gt;NewGlobalRef(*rootObjectPtr)) != NULL)) {
          nsk_jvmti_setFailStatus();
<span class="line-modified">!         return false;</span>
      }
      printf(&quot;Created root object global ref: 0x%p\n&quot;, (void*)*rootObjectPtr);
      fflush(0);
  
<span class="line-modified">!      return true;</span>
  } /* getFieldsAndObjects */
  
  
  /** Obtain chain of tested objects and tag them recursively. */
<span class="line-modified">! static bool getAndTagChainObjects(</span>
      jvmtiEnv*  jvmti,
      JNIEnv*    jni,
      jobject    currObj,
      jfieldID   refField,
      jfieldID   nextField,
      int        count,
      ObjectDesc objectDescList[],
      jlong      tag,
<span class="line-modified">!     bool       reachable) {</span>
      jobject nextObj = NULL;
      jlong objTag = (reachable ? tag : -tag);
  
      if (count &lt;= 0) {
<span class="line-modified">!         return true;</span>
      }
  
      count--;
      tag++;
  
      if (!NSK_JNI_VERIFY(jni, (nextObj = jni-&gt;GetObjectField(currObj, refField)) != NULL)) {
          nsk_jvmti_setFailStatus();
<span class="line-modified">!         return false;</span>
      }
  
      objectDescList[count].tag = objTag;
      if (reachable) {
          objectDescList[count].exp_found++;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 336,16 ***</span>
                                 count,
                                 objectDescList,
                                 tag,
                                 reachable)
      ) {
<span class="line-modified">!         return NSK_FALSE;</span>
      }
  
      NSK_TRACE(jni-&gt;DeleteLocalRef(nextObj));
  
<span class="line-modified">!     return NSK_TRUE;</span>
  } /* getAndTagChainObjects */
  
  /** Obtain all tested objects from debugee class and tag them recursively. */
  static int getAndTagTestedObjects(
      jvmtiEnv*    jvmti,
<span class="line-new-header">--- 331,16 ---</span>
                                 count,
                                 objectDescList,
                                 tag,
                                 reachable)
      ) {
<span class="line-modified">!         return false;</span>
      }
  
      NSK_TRACE(jni-&gt;DeleteLocalRef(nextObj));
  
<span class="line-modified">!     return true;</span>
  } /* getAndTagChainObjects */
  
  /** Obtain all tested objects from debugee class and tag them recursively. */
  static int getAndTagTestedObjects(
      jvmtiEnv*    jvmti,
</pre>
<hr />
<pre>
<span class="line-old-header">*** 361,35 ***</span>
  
      jfieldID reachableChainField   = NULL;
      jfieldID unreachableChainField = NULL;
      jfieldID nextField             = NULL;
  
<span class="line-modified">!     if (initObjectDescList(jvmti,</span>
<span class="line-modified">!                            chainLength,</span>
<span class="line-modified">!                            objectsCount,</span>
<span class="line-modified">!                            objectDescList) == NSK_FALSE) {</span>
<span class="line-modified">!         return NSK_FALSE;</span>
      }
  
<span class="line-modified">!     if (getAndTagClasses(jvmti,</span>
<span class="line-modified">!                          jni,</span>
<span class="line-modified">!                          &amp;debugeeClass,</span>
<span class="line-modified">!                          &amp;rootObjectClass,</span>
<span class="line-modified">!                          &amp;chainObjectClass) == NSK_FALSE) {</span>
<span class="line-modified">!         return NSK_FALSE;</span>
      }
  
<span class="line-modified">!     if (getFieldsAndObjects(jvmti,</span>
<span class="line-modified">!                             jni,</span>
<span class="line-modified">!                             debugeeClass,</span>
<span class="line-modified">!                             rootObjectClass,</span>
<span class="line-modified">!                             chainObjectClass,</span>
<span class="line-modified">!                             rootObjectPtr,</span>
<span class="line-modified">!                             &amp;reachableChainField,</span>
<span class="line-modified">!                             &amp;unreachableChainField,</span>
<span class="line-modified">!                             &amp;nextField) == NSK_FALSE) {</span>
<span class="line-modified">!         return NSK_FALSE;</span>
      }
  
      printf(&quot;\nObtain and tag chain objects:\n&quot;);
      printf(&quot;    root tested object:\n&quot;);
  
<span class="line-new-header">--- 356,35 ---</span>
  
      jfieldID reachableChainField   = NULL;
      jfieldID unreachableChainField = NULL;
      jfieldID nextField             = NULL;
  
<span class="line-modified">!     if (!initObjectDescList(jvmti,</span>
<span class="line-modified">!                             chainLength,</span>
<span class="line-modified">!                             objectsCount,</span>
<span class="line-modified">!                             objectDescList)) {</span>
<span class="line-modified">!         return false;</span>
      }
  
<span class="line-modified">!     if (!getAndTagClasses(jvmti,</span>
<span class="line-modified">!                           jni,</span>
<span class="line-modified">!                           &amp;debugeeClass,</span>
<span class="line-modified">!                           &amp;rootObjectClass,</span>
<span class="line-modified">!                           &amp;chainObjectClass)) {</span>
<span class="line-modified">!         return false;</span>
      }
  
<span class="line-modified">!     if (!getFieldsAndObjects(jvmti,</span>
<span class="line-modified">!                              jni,</span>
<span class="line-modified">!                              debugeeClass,</span>
<span class="line-modified">!                              rootObjectClass,</span>
<span class="line-modified">!                              chainObjectClass,</span>
<span class="line-modified">!                              rootObjectPtr,</span>
<span class="line-modified">!                              &amp;reachableChainField,</span>
<span class="line-modified">!                              &amp;unreachableChainField,</span>
<span class="line-modified">!                              &amp;nextField)) {</span>
<span class="line-modified">!         return false;</span>
      }
  
      printf(&quot;\nObtain and tag chain objects:\n&quot;);
      printf(&quot;    root tested object:\n&quot;);
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 409,14 ***</span>
                                 reachableChainField,
                                 nextField,
                                 chainLength,
                                 (*objectDescList) + 1,
                                 CHAIN_OBJECT_TAG,
<span class="line-modified">!                                NSK_TRUE)  /* reachable objects */</span>
      ) {
          nsk_jvmti_setFailStatus();
<span class="line-modified">!         return NSK_FALSE;</span>
      }
  
      printf(&quot;    unreachable objects chain: %d objects\n&quot;, chainLength);
      if (!getAndTagChainObjects(jvmti,
                                 jni,
<span class="line-new-header">--- 404,14 ---</span>
                                 reachableChainField,
                                 nextField,
                                 chainLength,
                                 (*objectDescList) + 1,
                                 CHAIN_OBJECT_TAG,
<span class="line-modified">!                                true)  /* reachable objects */</span>
      ) {
          nsk_jvmti_setFailStatus();
<span class="line-modified">!         return false;</span>
      }
  
      printf(&quot;    unreachable objects chain: %d objects\n&quot;, chainLength);
      if (!getAndTagChainObjects(jvmti,
                                 jni,
</pre>
<hr />
<pre>
<span class="line-old-header">*** 424,26 ***</span>
                                 unreachableChainField,
                                 nextField,
                                 chainLength,
                                 (*objectDescList) + 1 + chainLength,
                                 CHAIN_OBJECT_TAG,
<span class="line-modified">!                                NSK_FALSE) /* unreachable objects */</span>
      ) {
          nsk_jvmti_setFailStatus();
<span class="line-modified">!         return NSK_FALSE;</span>
      }
  
<span class="line-modified">!     return NSK_TRUE;</span>
  } /* getAndTagTestedObjects */
  
  /** Check if tagged objects were iterated. */
<span class="line-modified">! static int checkTestedObjects(jvmtiEnv*  jvmti,</span>
<span class="line-modified">!                               JNIEnv*    jni,</span>
<span class="line-modified">!                               int        chainLength,</span>
<span class="line-modified">!                               ObjectDesc objectDescList[])</span>
  {
<span class="line-modified">!     int success = NSK_TRUE;</span>
      int i, idx;
  
      printf(&quot;Following tagged objects were iterated:\n&quot;);
  
      printf(&quot;Root tested object:\n&quot;);
<span class="line-new-header">--- 419,26 ---</span>
                                 unreachableChainField,
                                 nextField,
                                 chainLength,
                                 (*objectDescList) + 1 + chainLength,
                                 CHAIN_OBJECT_TAG,
<span class="line-modified">!                                false) /* unreachable objects */</span>
      ) {
          nsk_jvmti_setFailStatus();
<span class="line-modified">!         return false;</span>
      }
  
<span class="line-modified">!     return true;</span>
  } /* getAndTagTestedObjects */
  
  /** Check if tagged objects were iterated. */
<span class="line-modified">! static bool checkTestedObjects(jvmtiEnv*  jvmti,</span>
<span class="line-modified">!                                JNIEnv*    jni,</span>
<span class="line-modified">!                                int        chainLength,</span>
<span class="line-modified">!                                ObjectDesc objectDescList[])</span>
  {
<span class="line-modified">!     bool success = true;</span>
      int i, idx;
  
      printf(&quot;Following tagged objects were iterated:\n&quot;);
  
      printf(&quot;Root tested object:\n&quot;);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 496,20 ***</span>
              nsk_jvmti_setFailStatus();
          }
          fflush(0);
      }
  
<span class="line-modified">!     return NSK_TRUE;</span>
  } /* checkTestedObjects */
  
  
  /** Release references to the tested objects and free allocated memory. */
<span class="line-modified">! static int releaseTestedObjects(jvmtiEnv*   jvmti,</span>
<span class="line-modified">!                                 JNIEnv*     jni,</span>
<span class="line-modified">!                                 int         chainLength,</span>
<span class="line-modified">!                                 ObjectDesc* objectDescList,</span>
<span class="line-modified">!                                 jobject     rootObject)</span>
  {
      if (rootObject != NULL) {
          printf(&quot;Release object reference to root tested object: 0x%p\n&quot;, rootObject);
          NSK_TRACE(jni-&gt;DeleteGlobalRef(rootObject));
      }
<span class="line-new-header">--- 491,20 ---</span>
              nsk_jvmti_setFailStatus();
          }
          fflush(0);
      }
  
<span class="line-modified">!     return true;</span>
  } /* checkTestedObjects */
  
  
  /** Release references to the tested objects and free allocated memory. */
<span class="line-modified">! static void releaseTestedObjects(jvmtiEnv*   jvmti,</span>
<span class="line-modified">!                                  JNIEnv*     jni,</span>
<span class="line-modified">!                                  int         chainLength,</span>
<span class="line-modified">!                                  ObjectDesc* objectDescList,</span>
<span class="line-modified">!                                  jobject     rootObject)</span>
  {
      if (rootObject != NULL) {
          printf(&quot;Release object reference to root tested object: 0x%p\n&quot;, rootObject);
          NSK_TRACE(jni-&gt;DeleteGlobalRef(rootObject));
      }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 520,11 ***</span>
              nsk_jvmti_setFailStatus();
          }
      }
  
      fflush(0);
<span class="line-removed">-     return NSK_TRUE;</span>
  } /* releaseTestedObjects */
  
  
  /* ============================================================================= */
  
<span class="line-new-header">--- 515,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 782,14 ***</span>
      }
  
      printf(&quot;&gt;&gt;&gt; Clean used data\n&quot;);
      fflush(0);
  
<span class="line-modified">!     if (!NSK_VERIFY(releaseTestedObjects(jvmti, jni, chainLength,</span>
<span class="line-removed">-                                          objectDescList, rootObject))) {</span>
<span class="line-removed">-         return;</span>
<span class="line-removed">-     }</span>
  
      printf(&quot;&gt;&gt;&gt; Let debugee to finish\n&quot;);
      fflush(0);
      if (!NSK_VERIFY(nsk_jvmti_resumeSync())) {
          return;
<span class="line-new-header">--- 776,11 ---</span>
      }
  
      printf(&quot;&gt;&gt;&gt; Clean used data\n&quot;);
      fflush(0);
  
<span class="line-modified">!     releaseTestedObjects(jvmti, jni, chainLength, objectDescList, rootObject);</span>
  
      printf(&quot;&gt;&gt;&gt; Let debugee to finish\n&quot;);
      fflush(0);
      if (!NSK_VERIFY(nsk_jvmti_resumeSync())) {
          return;
</pre>
<center><a href="../../../scenarios/sampling/SP06/sp06t003/sp06t003.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="../followref003/followref003.cpp.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>