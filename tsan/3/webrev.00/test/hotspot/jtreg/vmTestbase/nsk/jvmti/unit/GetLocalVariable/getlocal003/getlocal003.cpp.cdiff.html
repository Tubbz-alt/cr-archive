<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff test/hotspot/jtreg/vmTestbase/nsk/jvmti/unit/GetLocalVariable/getlocal003/getlocal003.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../getlocal003.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../monitoring/ThreadMXBean/GetThreadAllocatedBytes/BaseBehaviorTest.README.cdiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/jtreg/vmTestbase/nsk/jvmti/unit/GetLocalVariable/getlocal003/getlocal003.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2003, 2018, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2003, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 65,60 ***</span>
              table[i].start_location + table[i].length &lt; location) {
              continue;  /* The local variable is not visible */
          }
          print_LocalVariableEntry(&amp;table[i]);
          char sig = table[i].signature[0];
  
          if (sig == &#39;Z&#39; || sig == &#39;B&#39; || sig == &#39;C&#39; || sig == &#39;S&#39;) {
              sig = &#39;I&#39;; // covered by GetLocalInt
          }
<span class="line-modified">!         err = jvmti-&gt;GetLocalInt(thr, 0, table[i].slot, &amp;intVal);</span>
          printf(&quot; GetLocalInt:     %s (%d)\n&quot;, TranslateError(err), err);
          if (err != JVMTI_ERROR_NONE &amp;&amp; sig == &#39;I&#39;) {
              printf(&quot;FAIL: GetLocalInt failed to get value of int\n&quot;);
              result = STATUS_FAILED;
          } else if (err != JVMTI_ERROR_TYPE_MISMATCH &amp;&amp; sig != &#39;I&#39;) {
              printf(&quot;FAIL: GetLocalInt did not return JVMTI_ERROR_TYPE_MISMATCH for non-int\n&quot;);
              result = STATUS_FAILED;
          }
  
<span class="line-modified">!         err = jvmti-&gt;GetLocalLong(thr, 0, table[i].slot, &amp;longVal);</span>
          printf(&quot; GetLocalLong:    %s (%d)\n&quot;, TranslateError(err), err);
          if (err != JVMTI_ERROR_NONE &amp;&amp; sig == &#39;J&#39;) {
              printf(&quot;FAIL: GetLocalLong failed to get value of long\n&quot;);
              result = STATUS_FAILED;
<span class="line-modified">!         } else if (err != JVMTI_ERROR_TYPE_MISMATCH &amp;&amp; sig != &#39;J&#39;) {</span>
<span class="line-modified">!             printf(&quot;FAIL: GetLocalLong did not return JVMTI_ERROR_TYPE_MISMATCH for non-long\n&quot;);</span>
              result = STATUS_FAILED;
          }
  
<span class="line-modified">!         err = jvmti-&gt;GetLocalFloat(thr, 0, table[i].slot, &amp;floatVal);</span>
          printf(&quot; GetLocalFloat:   %s (%d)\n&quot;, TranslateError(err), err);
<span class="line-modified">!         if (err != JVMTI_ERROR_NONE &amp;&amp; table[i].signature[0] == &#39;F&#39;) {</span>
              printf(&quot;FAIL: GetLocalFloat failed to get value of float\n&quot;);
              result = STATUS_FAILED;
<span class="line-modified">!         } else if (err != JVMTI_ERROR_TYPE_MISMATCH &amp;&amp; table[i].signature[0] != &#39;F&#39;) {</span>
              printf(&quot;FAIL: GetLocalFloat did not return JVMTI_ERROR_TYPE_MISMATCH for non-float\n&quot;);
              result = STATUS_FAILED;
          }
  
<span class="line-modified">!         err = jvmti-&gt;GetLocalDouble(thr, 0, table[i].slot, &amp;doubleVal);</span>
          printf(&quot; GetLocalDouble:  %s (%d)\n&quot;, TranslateError(err), err);
<span class="line-modified">!         if (err != JVMTI_ERROR_NONE &amp;&amp; table[i].signature[0] == &#39;D&#39;) {</span>
              printf(&quot;FAIL: GetLocalDouble failed to get value of double\n&quot;);
              result = STATUS_FAILED;
<span class="line-modified">!         } else if (err != JVMTI_ERROR_TYPE_MISMATCH &amp;&amp; table[i].signature[0] != &#39;D&#39;) {</span>
<span class="line-modified">!             printf(&quot;FAIL: GetLocalDouble did not return JVMTI_ERROR_TYPE_MISMATCH for non-double\n&quot;);</span>
              result = STATUS_FAILED;
          }
  
<span class="line-modified">!         err = jvmti-&gt;GetLocalObject(thr, 0, table[i].slot, &amp;obj);</span>
          printf(&quot; GetLocalObject:  %s (%d)\n&quot;, TranslateError(err), err);
<span class="line-modified">!         if (err != JVMTI_ERROR_NONE &amp;&amp; table[i].signature[0] == &#39;L&#39;) {</span>
              printf(&quot;FAIL: GetLocalObject failed to get value of object\n&quot;);
              result = STATUS_FAILED;
<span class="line-modified">!         } else if (err != JVMTI_ERROR_TYPE_MISMATCH &amp;&amp; table[i].signature[0] != &#39;L&#39;) {</span>
              printf(&quot;FAIL: GetLocalObject did not return JVMTI_ERROR_TYPE_MISMATCH for non-object\n&quot;);
              result = STATUS_FAILED;
          }
      }
  }
<span class="line-new-header">--- 65,67 ---</span>
              table[i].start_location + table[i].length &lt; location) {
              continue;  /* The local variable is not visible */
          }
          print_LocalVariableEntry(&amp;table[i]);
          char sig = table[i].signature[0];
<span class="line-added">+         int slot = table[i].slot;</span>
  
          if (sig == &#39;Z&#39; || sig == &#39;B&#39; || sig == &#39;C&#39; || sig == &#39;S&#39;) {
              sig = &#39;I&#39;; // covered by GetLocalInt
          }
<span class="line-modified">!         err = jvmti-&gt;GetLocalInt(thr, 0, slot, &amp;intVal);</span>
          printf(&quot; GetLocalInt:     %s (%d)\n&quot;, TranslateError(err), err);
          if (err != JVMTI_ERROR_NONE &amp;&amp; sig == &#39;I&#39;) {
              printf(&quot;FAIL: GetLocalInt failed to get value of int\n&quot;);
              result = STATUS_FAILED;
          } else if (err != JVMTI_ERROR_TYPE_MISMATCH &amp;&amp; sig != &#39;I&#39;) {
              printf(&quot;FAIL: GetLocalInt did not return JVMTI_ERROR_TYPE_MISMATCH for non-int\n&quot;);
              result = STATUS_FAILED;
          }
  
<span class="line-modified">!         err = jvmti-&gt;GetLocalLong(thr, 0, slot, &amp;longVal);</span>
          printf(&quot; GetLocalLong:    %s (%d)\n&quot;, TranslateError(err), err);
          if (err != JVMTI_ERROR_NONE &amp;&amp; sig == &#39;J&#39;) {
              printf(&quot;FAIL: GetLocalLong failed to get value of long\n&quot;);
              result = STATUS_FAILED;
<span class="line-modified">!         } else if (err != JVMTI_ERROR_INVALID_SLOT &amp;&amp;</span>
<span class="line-modified">!                    err != JVMTI_ERROR_TYPE_MISMATCH &amp;&amp;</span>
<span class="line-added">+                    sig != &#39;J&#39;) {</span>
<span class="line-added">+             printf(&quot;FAIL: GetLocalLong did not return JVMTI_ERROR_INVALID_SLOT&quot;</span>
<span class="line-added">+                    &quot; nor JVMTI_ERROR_TYPE_MISMATCH for non-long\n&quot;);</span>
              result = STATUS_FAILED;
          }
  
<span class="line-modified">!         err = jvmti-&gt;GetLocalFloat(thr, 0, slot, &amp;floatVal);</span>
          printf(&quot; GetLocalFloat:   %s (%d)\n&quot;, TranslateError(err), err);
<span class="line-modified">!         if (err != JVMTI_ERROR_NONE &amp;&amp; sig == &#39;F&#39;) {</span>
              printf(&quot;FAIL: GetLocalFloat failed to get value of float\n&quot;);
              result = STATUS_FAILED;
<span class="line-modified">!         } else if (err != JVMTI_ERROR_TYPE_MISMATCH &amp;&amp; sig != &#39;F&#39;) {</span>
              printf(&quot;FAIL: GetLocalFloat did not return JVMTI_ERROR_TYPE_MISMATCH for non-float\n&quot;);
              result = STATUS_FAILED;
          }
  
<span class="line-modified">!         err = jvmti-&gt;GetLocalDouble(thr, 0, slot, &amp;doubleVal);</span>
          printf(&quot; GetLocalDouble:  %s (%d)\n&quot;, TranslateError(err), err);
<span class="line-modified">!         if (err != JVMTI_ERROR_NONE &amp;&amp; sig == &#39;D&#39;) {</span>
              printf(&quot;FAIL: GetLocalDouble failed to get value of double\n&quot;);
              result = STATUS_FAILED;
<span class="line-modified">!         } else if (err != JVMTI_ERROR_INVALID_SLOT &amp;&amp;</span>
<span class="line-modified">!                    err != JVMTI_ERROR_TYPE_MISMATCH &amp;&amp;</span>
<span class="line-added">+                    sig != &#39;D&#39;) {</span>
<span class="line-added">+             printf(&quot;FAIL: GetLocalDouble did not return JVMTI_ERROR_INVALID_SLOT&quot;</span>
<span class="line-added">+                    &quot; nor JVMTI_ERROR_TYPE_MISMATCH for non-double\n&quot;);</span>
              result = STATUS_FAILED;
          }
  
<span class="line-modified">!         err = jvmti-&gt;GetLocalObject(thr, 0, slot, &amp;obj);</span>
          printf(&quot; GetLocalObject:  %s (%d)\n&quot;, TranslateError(err), err);
<span class="line-modified">!         if (err != JVMTI_ERROR_NONE &amp;&amp; sig == &#39;L&#39;) {</span>
              printf(&quot;FAIL: GetLocalObject failed to get value of object\n&quot;);
              result = STATUS_FAILED;
<span class="line-modified">!         } else if (err != JVMTI_ERROR_TYPE_MISMATCH &amp;&amp; sig != &#39;L&#39;) {</span>
              printf(&quot;FAIL: GetLocalObject did not return JVMTI_ERROR_TYPE_MISMATCH for non-object\n&quot;);
              result = STATUS_FAILED;
          }
      }
  }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 221,13 ***</span>
<span class="line-new-header">--- 228,49 ---</span>
          return JNI_ERR;
      }
      return JNI_OK;
  }
  
<span class="line-added">+ JNIEXPORT void JNICALL</span>
<span class="line-added">+ Java_nsk_jvmti_unit_GetLocalVariable_getlocal003_instMeth(JNIEnv *env, jobject inst) {</span>
<span class="line-added">+     jvmtiError err;</span>
<span class="line-added">+     jobject obj = NULL;</span>
<span class="line-added">+ </span>
<span class="line-added">+     printf(&quot;\n Native instMeth: started\n&quot;);</span>
<span class="line-added">+ </span>
<span class="line-added">+     // Test GetLocalInstance with native instance method instMeth() frame</span>
<span class="line-added">+     err = jvmti-&gt;GetLocalInstance(NULL, 0, &amp;obj);</span>
<span class="line-added">+     printf(&quot; Native instMeth: GetLocalInstance: %s (%d)\n&quot;, TranslateError(err), err);</span>
<span class="line-added">+     if (err != JVMTI_ERROR_NONE) {</span>
<span class="line-added">+         printf(&quot;FAIL: GetLocalInstance failed to get instance for native instance method frame\n&quot;);</span>
<span class="line-added">+         result = STATUS_FAILED;</span>
<span class="line-added">+     }</span>
<span class="line-added">+     if (env-&gt;IsSameObject(inst, obj) == JNI_FALSE) {</span>
<span class="line-added">+         printf(&quot;FAIL: GetLocalInstance returned unexpected instance for native instance method frame\n&quot;);</span>
<span class="line-added">+         result = STATUS_FAILED;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     // Test GetLocalInstance with java instance method meth01() frame</span>
<span class="line-added">+     err = jvmti-&gt;GetLocalInstance(NULL, 1, &amp;obj);</span>
<span class="line-added">+     printf(&quot; Native instMeth: GetLocalInstance: %s (%d)\n&quot;, TranslateError(err), err);</span>
<span class="line-added">+     if (err != JVMTI_ERROR_NONE) {</span>
<span class="line-added">+         printf(&quot;FAIL: GetLocalInstance failed to get instance for java instance method frame\n&quot;);</span>
<span class="line-added">+         result = STATUS_FAILED;</span>
<span class="line-added">+     }</span>
<span class="line-added">+     if (env-&gt;IsSameObject(inst, obj) == JNI_FALSE) {</span>
<span class="line-added">+         printf(&quot;FAIL: GetLocalInstance returned unexpected instance for java instance method frame\n&quot;);</span>
<span class="line-added">+         result = STATUS_FAILED;</span>
<span class="line-added">+     }</span>
<span class="line-added">+     printf(&quot; Native instMeth: finished\n\n&quot;);</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
  JNIEXPORT void JNICALL
  Java_nsk_jvmti_unit_GetLocalVariable_getlocal003_getMeth(JNIEnv *env, jclass cls) {
      jvmtiError err;
<span class="line-added">+     jobject obj = NULL;</span>
<span class="line-added">+ </span>
<span class="line-added">+     printf(&quot;\n Native getMeth: started\n&quot;);</span>
  
      if (jvmti == NULL) {
          printf(&quot;JVMTI client was not properly loaded!\n&quot;);
          result = STATUS_FAILED;
          return;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 252,10 ***</span>
<span class="line-new-header">--- 295,28 ---</span>
      if (err != JVMTI_ERROR_NONE) {
          printf(&quot;Failed to enable metod exit event: %s (%d)\n&quot;,
                 TranslateError(err), err);
          result = STATUS_FAILED;
      }
<span class="line-added">+ </span>
<span class="line-added">+     // Test GetLocalInstance with native static method getMeth() frame</span>
<span class="line-added">+     err = jvmti-&gt;GetLocalInstance(NULL, 0, &amp;obj);</span>
<span class="line-added">+     printf(&quot; Native getMeth: GetLocalInstance: %s (%d)\n&quot;, TranslateError(err), err);</span>
<span class="line-added">+     if (err != JVMTI_ERROR_INVALID_SLOT) {</span>
<span class="line-added">+         printf(&quot;FAIL: GetLocalInstance failed to return JVMTI_ERROR_INVALID_SLOT for native static method frame\n&quot;);</span>
<span class="line-added">+         result = STATUS_FAILED;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     // Test GetLocalInstance with java static method run() frame</span>
<span class="line-added">+     err = jvmti-&gt;GetLocalInstance(NULL, 1, &amp;obj);</span>
<span class="line-added">+     printf(&quot; Native getMeth: GetLocalInstance: %s (%d)\n&quot;, TranslateError(err), err);</span>
<span class="line-added">+     if (err != JVMTI_ERROR_INVALID_SLOT) {</span>
<span class="line-added">+         printf(&quot;FAIL: GetLocalInstance failed to return JVMTI_ERROR_INVALID_SLOT for java static method frame\n&quot;);</span>
<span class="line-added">+         result = STATUS_FAILED;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     printf(&quot; Native getMeth: finished\n\n&quot;);</span>
      fflush(stdout);
  }
  
  JNIEXPORT void JNICALL
  Java_nsk_jvmti_unit_GetLocalVariable_getlocal003_checkLoc(JNIEnv *env,
</pre>
<center><a href="../getlocal003.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../monitoring/ThreadMXBean/GetThreadAllocatedBytes/BaseBehaviorTest.README.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>