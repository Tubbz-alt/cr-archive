<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/hotspot/jtreg/vmTestbase/nsk/jvmti/scenarios/contention/TC04/tc04t001.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../TC02/tc02t001/tc02t001.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="tc04t001/tc04t001.cpp.udiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/jtreg/vmTestbase/nsk/jvmti/scenarios/contention/TC04/tc04t001.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2004, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2004, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -22,17 +22,19 @@</span>
   */
  
  package nsk.jvmti.scenarios.contention.TC04;
  
  import java.io.PrintStream;
<span class="udiff-line-added">+ import java.util.concurrent.*;</span>
  
  import nsk.share.*;
  import nsk.share.jvmti.*;
  
  public class tc04t001 extends DebugeeClass {
  
      final static int THREADS_LIMIT = 2;
<span class="udiff-line-added">+     final static CountDownLatch threadsDoneSignal = new CountDownLatch(THREADS_LIMIT);</span>
  
      // run test from command line
      public static void main(String argv[]) {
          argv = nsk.share.jvmti.JVMTITest.commonInit(argv);
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -66,12 +68,12 @@</span>
              threads[i] = new tc04t001Thread(i);
              threads[i].start();
          }
  
          try {
<span class="udiff-line-modified-removed">-             for (int i = 0; i &lt; THREADS_LIMIT; i++) {</span>
<span class="udiff-line-modified-removed">-                 threads[i].join(timeout/THREADS_LIMIT);</span>
<span class="udiff-line-modified-added">+             if (!threadsDoneSignal.await(timeout, TimeUnit.MILLISECONDS)) {</span>
<span class="udiff-line-modified-added">+                 throw new RuntimeException(&quot;Threads timeout&quot;);</span>
              }
          } catch (InterruptedException e) {
              throw new Failure(e);
          }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -82,27 +84,10 @@</span>
                  THREADS_LIMIT*tc04t001Thread.INCREMENT_LIMIT) {
              log.complain(&quot;Wrong value: &quot; + tc04t001Thread.value +
                  &quot;, expected: &quot; + THREADS_LIMIT*tc04t001Thread.INCREMENT_LIMIT);
              status = Consts.TEST_FAILED;
          }
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- /* DEBUG -- to check if the threads taking turns in right order</span>
<span class="udiff-line-removed">-         boolean race = false;</span>
<span class="udiff-line-removed">-         for (int i = 1; i &lt; 2*tc04t001Thread.INCREMENT_LIMIT; i++) {</span>
<span class="udiff-line-removed">-              if (tc04t001Thread.passOrder[i] == tc04t001Thread.passOrder[i-1]) {</span>
<span class="udiff-line-removed">-                 race = true;</span>
<span class="udiff-line-removed">-                 System.out.println(&quot;Race condition in the test:&quot;);</span>
<span class="udiff-line-removed">-                 System.out.println(&quot;passOrder[&quot; + (i-1) + &quot;]:&quot;</span>
<span class="udiff-line-removed">-                     + tc04t001Thread.passOrder[i-1]);</span>
<span class="udiff-line-removed">-                 System.out.println(&quot;passOrder[&quot; + (i) + &quot;]:&quot;</span>
<span class="udiff-line-removed">-                     + tc04t001Thread.passOrder[i]);</span>
<span class="udiff-line-removed">-              }</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         if (race)</span>
<span class="udiff-line-removed">-             System.out.println(&quot;There was a race condition in the test.&quot;);</span>
<span class="udiff-line-removed">- */</span>
<span class="udiff-line-removed">- </span>
          return status;
      }
  }
  
  /* =================================================================== */
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -113,17 +98,14 @@</span>
      final static int DELAY = 1000;
  
      static volatile int value = 0;
  
      static Flicker flicker = new Flicker();
<span class="udiff-line-removed">- /* DEBUG -- to check if the threads taking turns in right order</span>
<span class="udiff-line-removed">-     static volatile int iter = 0;</span>
<span class="udiff-line-removed">-     static volatile int passOrder[] =</span>
<span class="udiff-line-removed">-         new int[INCREMENT_LIMIT*tc04t001.THREADS_LIMIT];</span>
<span class="udiff-line-removed">- */</span>
  
      private int id;
<span class="udiff-line-added">+     private static volatile int lastEnterEventsCount;</span>
<span class="udiff-line-added">+     private static native   int enterEventsCount();</span>
  
      public tc04t001Thread(int i) {
          super(&quot;Debuggee Thread &quot; + i);
          id = i;
      }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -134,23 +116,41 @@</span>
              increment(id);
              try {
                  wait(1);
              } catch (InterruptedException e) {}
          }
<span class="udiff-line-added">+         tc04t001.threadsDoneSignal.countDown();</span>
      }
  
      static synchronized void increment(int i) {
<span class="udiff-line-removed">- /* DEBUG -- to check if the threads taking turns in right order</span>
<span class="udiff-line-removed">-         passOrder[iter++] = i;</span>
<span class="udiff-line-removed">- */</span>
          flicker.unlock(i);
          int temp = value;
<span class="udiff-line-modified-removed">-         for (int j = 0; j &lt; DELAY; j++) ;</span>
<span class="udiff-line-modified-removed">-         try {</span>
<span class="udiff-line-modified-removed">-             sleep(500);</span>
<span class="udiff-line-modified-removed">-         } catch (InterruptedException e) {}</span>
<span class="udiff-line-modified-added">+         boolean done = false;</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+         // Wait in a loop for a MonitorContendedEnter event.</span>
<span class="udiff-line-modified-added">+         // Timeout is: 20ms * DELAY.</span>
<span class="udiff-line-added">+         for (int j = 0; j &lt; DELAY; j++) {</span>
<span class="udiff-line-added">+             try {</span>
<span class="udiff-line-added">+                 sleep(20);</span>
<span class="udiff-line-added">+             } catch (InterruptedException e) {}</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             done = (tc04t001.threadsDoneSignal.getCount() == 1);</span>
<span class="udiff-line-added">+             if (done) {</span>
<span class="udiff-line-added">+                 break; // This thread is the only remaining thread, no more contention</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             if (enterEventsCount() &gt; lastEnterEventsCount) {</span>
<span class="udiff-line-added">+                 System.out.println(&quot;Thread-&quot; + i + &quot;: increment event: &quot; + enterEventsCount());</span>
<span class="udiff-line-added">+                 break; // Got an expected MonitorContendedEnter event</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         if (!done &amp;&amp; enterEventsCount() == lastEnterEventsCount) {</span>
<span class="udiff-line-added">+             String msg = &quot;Timeout in waiting for a MonitorContendedEnter event&quot;;</span>
<span class="udiff-line-added">+             throw new RuntimeException(msg);</span>
<span class="udiff-line-added">+         }</span>
          value = temp + 1;
<span class="udiff-line-added">+         lastEnterEventsCount = enterEventsCount();</span>
      }
  }
  
  class Flicker {
  
</pre>
<center><a href="../TC02/tc02t001/tc02t001.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="tc04t001/tc04t001.cpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>