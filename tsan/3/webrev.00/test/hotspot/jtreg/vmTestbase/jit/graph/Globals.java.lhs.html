<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/hotspot/jtreg/vmTestbase/jit/graph/Globals.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 1998, 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 package jit.graph;
<a name="2" id="anc2"></a><span class="line-modified"> 25 import java.io.*;</span>
<span class="line-modified"> 26 import java.util.*;</span>
<span class="line-removed"> 27 import java.lang.*;</span>
<span class="line-removed"> 28 import java.lang.reflect.*;</span>
 29 import nsk.share.TestFailure;
 30 
<a name="3" id="anc3"></a>









 31 
<a name="4" id="anc4"></a><span class="line-modified"> 32 public final class Globals</span>
<span class="line-removed"> 33 {</span>
<span class="line-removed"> 34     // Minimum and Maximum number of threads</span>
<span class="line-removed"> 35     public static int     NUM_THREADS      = 1;</span>
<span class="line-removed"> 36     public static long    RANDOM_SEED      = System.currentTimeMillis();</span>
<span class="line-removed"> 37     public static int     STATIC_LOOP      = 0;</span>
<span class="line-removed"> 38     public static int     NUM_TEST_CLASSES = 7;</span>
<span class="line-removed"> 39     public static long    RANDOM_LOOP      = 100;</span>
<span class="line-removed"> 40     public static boolean VERBOSE          = false;</span>
<span class="line-removed"> 41     private static Random indexGenerator   = null;</span>
 42 
<a name="5" id="anc5"></a><span class="line-removed"> 43   //private static TestLoader CGTTestLoader = null;</span>
<span class="line-removed"> 44     private static String [] ClassArray = null;</span>
<span class="line-removed"> 45     private static Class [] ClassInstanceArray = null;</span>
<span class="line-removed"> 46     private static int       maxClassIndex    = 0;</span>
 47 
<a name="6" id="anc6"></a><span class="line-modified"> 48     private static String [] MethodName_Array = null;</span>
<span class="line-modified"> 49     private static Method [] MethodInstance_Array = null;</span>


 50 
<a name="7" id="anc7"></a><span class="line-modified"> 51     //Should be prime, so that odds of an incorrect verification reduced</span>
<span class="line-modified"> 52     public static  int    [] MethodID_Array   = null;</span>


 53 
<a name="8" id="anc8"></a>

 54 
<a name="9" id="anc9"></a><span class="line-modified"> 55     //Number of threads will be reduced as threads finish</span>
<span class="line-modified"> 56     public static synchronized void decNumThreads(){NUM_THREADS--;};</span>
 57 
<a name="10" id="anc10"></a><span class="line-modified"> 58     public static synchronized void initialize(String testListPath)</span>
<span class="line-modified"> 59     {</span>



 60 
<a name="11" id="anc11"></a><span class="line-modified"> 61         File td = new File (testListPath);</span>
<span class="line-modified"> 62         if (!td.exists())</span>
<span class="line-modified"> 63             {</span>
<span class="line-removed"> 64                 System.err.println(&quot;File &quot; + testListPath + &quot; Not found&quot;);</span>
<span class="line-removed"> 65                 System.exit(1);</span>
<span class="line-removed"> 66             }</span>
<span class="line-removed"> 67         if (!td.isFile())</span>
<span class="line-removed"> 68             {</span>
<span class="line-removed"> 69                 System.err.println(testListPath + &quot; Must be a File&quot;);</span>
<span class="line-removed"> 70                 System.exit(1);</span>
<span class="line-removed"> 71             }</span>
 72 
 73         BufferedReader classList = null;
<a name="12" id="anc12"></a>





 74 
<a name="13" id="anc13"></a><span class="line-modified"> 75         try</span>
<span class="line-modified"> 76           {</span>
<span class="line-removed"> 77             classList = new BufferedReader(new FileReader(td));</span>
<span class="line-removed"> 78           }</span>
<span class="line-removed"> 79         catch (FileNotFoundException  fnfx)</span>
<span class="line-removed"> 80           {</span>
<span class="line-removed"> 81             System.err.println(&quot;Error finding Classlist&quot;);</span>
<span class="line-removed"> 82             System.exit(1);</span>
<span class="line-removed"> 83           }</span>
<span class="line-removed"> 84 </span>
<span class="line-removed"> 85         String line = null;</span>
<span class="line-removed"> 86         try</span>
<span class="line-removed"> 87             {</span>
 88                 line = classList.readLine();
<a name="14" id="anc14"></a><span class="line-modified"> 89             }</span>
<span class="line-modified"> 90         catch (IOException iox)</span>
<span class="line-removed"> 91             {</span>
<span class="line-removed"> 92                 System.err.println(&quot;Error reading Classlist&quot;);</span>
<span class="line-removed"> 93                 System.exit(1);</span>
 94             }
 95 
<a name="15" id="anc15"></a><span class="line-modified"> 96         try</span>
<span class="line-modified"> 97             {</span>
<span class="line-modified"> 98                 maxClassIndex = Math.abs(Integer.parseInt(line));//ClassArray.length;</span>


 99             }
<a name="16" id="anc16"></a><span class="line-removed">100         catch (NumberFormatException nfx)</span>
<span class="line-removed">101             {</span>
<span class="line-removed">102                 System.err.println(&quot;Error reading Classlist - first number must be number of methods defined&quot;);</span>
<span class="line-removed">103                 System.exit(1);</span>
<span class="line-removed">104             }</span>
<span class="line-removed">105 </span>
<span class="line-removed">106         ClassArray = new String [maxClassIndex];</span>
<span class="line-removed">107 ClassInstanceArray = new Class [maxClassIndex];</span>
<span class="line-removed">108         MethodName_Array = new String [maxClassIndex];</span>
<span class="line-removed">109         MethodInstance_Array = new Method [maxClassIndex];</span>
<span class="line-removed">110         MethodID_Array = new int [maxClassIndex];</span>
111 
<a name="17" id="anc17"></a><span class="line-modified">112         int i;</span>
<span class="line-modified">113         for (i = 0; (i&lt;maxClassIndex) &amp;&amp; (line != null); i++)</span>
<span class="line-modified">114             {</span>
<span class="line-modified">115                 try</span>
<span class="line-modified">116                     {</span>
<span class="line-modified">117                         line = classList.readLine();</span>
<span class="line-modified">118                     }</span>
<span class="line-modified">119                 catch (IOException iox)</span>
<span class="line-modified">120                     {</span>
<span class="line-modified">121                         System.err.println(&quot;Error reading ClasslistFile: testListPath&quot;);</span>
<span class="line-modified">122                         System.exit(1);</span>
<span class="line-modified">123                     }</span>

124                 StringTokenizer lineTokens = new StringTokenizer(line, &quot;\t &quot;);
<a name="18" id="anc18"></a><span class="line-modified">125                 if (lineTokens.countTokens() &lt;3)</span>
<span class="line-modified">126                   {</span>
<span class="line-modified">127                     System.out.println(&quot;Error reading ClasslistFile: Errored line&quot;);</span>
<span class="line-removed">128                     i--;</span>
<span class="line-removed">129                   }</span>
<span class="line-removed">130                 else</span>
<span class="line-removed">131                   {</span>
132                     ClassArray[i] = lineTokens.nextToken();
<a name="19" id="anc19"></a><span class="line-modified">133                     MethodName_Array[i] =lineTokens.nextToken();</span>
134                     MethodID_Array[i] = Integer.parseInt(lineTokens.nextToken());
<a name="20" id="anc20"></a><span class="line-modified">135                   }</span>
136             }
<a name="21" id="anc21"></a><span class="line-modified">137         maxClassIndex = i;</span>









138 
<a name="22" id="anc22"></a><span class="line-modified">139         indexGenerator = new Random(RANDOM_SEED);</span>
<span class="line-modified">140         if ((NUM_TEST_CLASSES &lt; ClassArray.length) &amp;&amp; (NUM_TEST_CLASSES &gt; 0))</span>
<span class="line-modified">141           maxClassIndex = NUM_TEST_CLASSES;</span>
<span class="line-modified">142         else</span>
<span class="line-modified">143           NUM_TEST_CLASSES = maxClassIndex;</span>
144     }
145 
<a name="23" id="anc23"></a><span class="line-modified">146     //does a binary serach to find the index for the ID of a method</span>
<span class="line-modified">147     private static int ID_BinSearch(int begin, int end, int ID)</span>
<span class="line-modified">148     {</span>
<span class="line-modified">149         if (end &lt; begin)</span>
<span class="line-modified">150             return(-1);</span>
151 
<a name="24" id="anc24"></a><span class="line-modified">152         int mid = (begin + end)/2;</span>
153         int midvalue = MethodID_Array[mid];
154 
<a name="25" id="anc25"></a><span class="line-modified">155         if (ID == midvalue)</span>
156             return (mid);
<a name="26" id="anc26"></a><span class="line-modified">157         else if (ID &lt; midvalue)</span>
<span class="line-modified">158             return(ID_BinSearch(begin, mid-1, ID));</span>
<span class="line-modified">159         else</span>
<span class="line-modified">160             return(ID_BinSearch(mid+1, end, ID));</span>

161     }
162 
163 
<a name="27" id="anc27"></a><span class="line-modified">164     //based off a static index, this function selects the method to be called</span>
<span class="line-modified">165     public static MethodData returnNextStaticMethod(int Method_ID)</span>
<span class="line-modified">166     {</span>
<span class="line-modified">167       //int i = ID_BinSearch(0, MethodID_Array.length - 1, Method_ID);</span>
<span class="line-removed">168       int i = ID_BinSearch(0, maxClassIndex - 1, Method_ID);</span>
169 
<a name="28" id="anc28"></a><span class="line-modified">170       return(nextStaticMethod((i==-1)?0:i));</span>
171     }
172 
<a name="29" id="anc29"></a><span class="line-modified">173     //this function randomly selects the next method to be called by the test class</span>
<span class="line-modified">174     public static MethodData nextRandomMethod()</span>
<span class="line-removed">175     {</span>
<span class="line-removed">176 </span>
177         int i = indexGenerator.nextInt(maxClassIndex);
<a name="30" id="anc30"></a><span class="line-modified">178         return(nextStaticMethod(i));</span>
179     }
180 
<a name="31" id="anc31"></a><span class="line-modified">181     private static MethodData nextStaticMethod(int i)</span>
<span class="line-removed">182     {</span>
183         Class methodsClass = null;
184         Method nextMethod = null;
185 
<a name="32" id="anc32"></a><span class="line-modified">186         try</span>
<span class="line-modified">187             {</span>
<span class="line-modified">188               //methodsClass = CGTTestLoader.findClass(ClassArray[i]);</span>
<span class="line-modified">189               methodsClass = ClassInstanceArray[i];</span>
<span class="line-modified">190               if (methodsClass == null)</span>
<span class="line-removed">191               {</span>
<span class="line-removed">192                   methodsClass = Class.forName(ClassArray[i]);</span>
<span class="line-removed">193                   ClassInstanceArray[i] = methodsClass;</span>
<span class="line-removed">194               }</span>
<span class="line-removed">195               nextMethod = MethodInstance_Array[i];</span>
<span class="line-removed">196               if (nextMethod == null )</span>
<span class="line-removed">197               {</span>
<span class="line-removed">198               nextMethod =</span>
<span class="line-removed">199                 methodsClass.getMethod(MethodName_Array[i],</span>
<span class="line-removed">200                                        new Class[]{java.util.Vector.class, java.util.Vector.class,</span>
<span class="line-removed">201                                                      java.lang.Long.class, java.lang.Integer.class});</span>
<span class="line-removed">202               //sum vector, ID vector, function depth, static function call depth</span>
<span class="line-removed">203               MethodInstance_Array[i] = nextMethod;</span>
<span class="line-removed">204               }</span>
<span class="line-removed">205             }</span>
<span class="line-removed">206         catch (ClassNotFoundException cnfx)</span>
<span class="line-removed">207             {</span>
<span class="line-removed">208                 System.out.println(&quot;Class: &quot; +ClassArray[i]+ &quot; Not Found&quot;);</span>
<span class="line-removed">209                 System.exit(-1);</span>
<span class="line-removed">210             }</span>
<span class="line-removed">211         catch (NoSuchMethodException nsmx)</span>
<span class="line-removed">212             {</span>
<span class="line-removed">213                 System.out.println(&quot;Class: &quot; +ClassArray[i]);</span>
<span class="line-removed">214                 System.out.println(&quot;Method: &quot; +MethodName_Array[i]+&quot; Not Found&quot;);</span>
<span class="line-removed">215                 System.exit(-1);</span>
216             }
<a name="33" id="anc33"></a><span class="line-modified">217         catch (SecurityException sx)</span>
<span class="line-modified">218             {</span>
<span class="line-modified">219                 System.out.println(&quot;Class: &quot; +ClassArray[i]);</span>
<span class="line-modified">220                 System.out.println(&quot;Method: &quot; +MethodName_Array[i]);</span>
<span class="line-modified">221                 System.out.println(&quot;Security Exception Generated, by above method call&quot;);</span>
<span class="line-modified">222                 System.exit(-1);</span>
223             }
<a name="34" id="anc34"></a><span class="line-modified">224         return(new MethodData(ClassArray[i], MethodName_Array[i], methodsClass, nextMethod, MethodID_Array[i]));</span>







225     }
226 
227 
<a name="35" id="anc35"></a><span class="line-modified">228     /*These two functions are used to verify that all function were called in the proper order*/</span>
229 
<a name="36" id="anc36"></a><span class="line-modified">230     //called by &quot;parent&quot; function to add childs ID to vector</span>
<span class="line-modified">231     public static void addFunctionIDToVector(int FunctionIndex, Vector IDVector)</span>
<span class="line-modified">232     {</span>
<span class="line-removed">233         IDVector.addElement(new Integer(FunctionIndex));</span>
234     }
235 
<a name="37" id="anc37"></a><span class="line-modified">236     //called by &quot;child&quot; to add Function Index to Vector</span>
<span class="line-modified">237     public static void appendSumToSumationVector(int FunctionIndex, Vector SummationVector)</span>
<span class="line-modified">238     {</span>
<span class="line-modified">239         if (SummationVector.isEmpty())</span>
<span class="line-modified">240             SummationVector.addElement(new Long(FunctionIndex));</span>
<span class="line-modified">241         else</span>
<span class="line-modified">242             SummationVector.addElement(new Long(((Long)SummationVector.lastElement()).longValue() + FunctionIndex));</span>
243     }
244 
<a name="38" id="anc38"></a><span class="line-modified">245     //This function calls a method based off of MethodData</span>
246     public static void callMethod(MethodData methodCallStr,
247                                   Vector summation, Vector ID,
248                                   Long numFcalls, Integer staticFcalls)
<a name="39" id="anc39"></a><span class="line-modified">249                                   throws InvocationTargetException</span>
<span class="line-modified">250 </span>
<span class="line-modified">251     {</span>
<span class="line-modified">252                 if(NUM_THREADS &gt;1)</span>
<span class="line-modified">253                     {</span>
<span class="line-modified">254                         if ((staticFcalls.intValue() + numFcalls.longValue()) %23 == 0)</span>
<span class="line-modified">255                             {</span>
<span class="line-modified">256                                 try</span>
<span class="line-removed">257                                     {</span>
<span class="line-removed">258                                         Thread.sleep(225);</span>
<span class="line-removed">259                                     }</span>
<span class="line-removed">260                                 catch (InterruptedException ie)</span>
<span class="line-removed">261                                     {}</span>
<span class="line-removed">262                                 if (VERBOSE)</span>
<span class="line-removed">263                                     System.out.println(&quot;\t\tCurrentThread:&quot; + Thread.currentThread().getName());</span>
<span class="line-removed">264                             }</span>
<span class="line-removed">265                     }</span>
<span class="line-removed">266 </span>
<span class="line-removed">267                 try</span>
<span class="line-removed">268             {</span>
<span class="line-removed">269                         methodCallStr.nextMethod.invoke(methodCallStr.instance,</span>
<span class="line-removed">270                                 new Object []{summation, ID, numFcalls, staticFcalls});</span>
<span class="line-removed">271             }</span>
<span class="line-removed">272                 catch (IllegalAccessException iax)  //should never happen with a valid testfile</span>
<span class="line-removed">273             {</span>
<span class="line-removed">274                         throw new TestFailure(&quot;Illegal Access Exception&quot;);</span>
<span class="line-removed">275             }</span>
<span class="line-removed">276                     /*</span>
<span class="line-removed">277                 catch (InvocationTargetException itx)</span>
<span class="line-removed">278                     {</span>
<span class="line-removed">279                         itx.printStackTrace();</span>
<span class="line-removed">280                         System.out.println(&quot;Invocation Target Exception&quot;);</span>
<span class="line-removed">281                         System.exit(1);</span>
<span class="line-removed">282                     }*/</span>
283     }
284 }
<a name="40" id="anc40"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="40" type="hidden" />
</body>
</html>