<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/hotspot/jtreg/vmTestbase/jit/graph/Globals.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 1998, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 package jit.graph;
<a name="2" id="anc2"></a><span class="line-modified"> 25 </span>
<span class="line-modified"> 26 import jdk.test.lib.Utils;</span>


 27 import nsk.share.TestFailure;
 28 
<a name="3" id="anc3"></a><span class="line-added"> 29 import java.io.BufferedReader;</span>
<span class="line-added"> 30 import java.io.File;</span>
<span class="line-added"> 31 import java.io.FileNotFoundException;</span>
<span class="line-added"> 32 import java.io.FileReader;</span>
<span class="line-added"> 33 import java.io.IOException;</span>
<span class="line-added"> 34 import java.lang.reflect.InvocationTargetException;</span>
<span class="line-added"> 35 import java.lang.reflect.Method;</span>
<span class="line-added"> 36 import java.util.Random;</span>
<span class="line-added"> 37 import java.util.StringTokenizer;</span>
<span class="line-added"> 38 import java.util.Vector;</span>
 39 
<a name="4" id="anc4"></a><span class="line-modified"> 40 public final class Globals {</span>









 41 
<a name="5" id="anc5"></a>



 42 
<a name="6" id="anc6"></a><span class="line-modified"> 43     public static int STATIC_LOOP = 0;</span>
<span class="line-modified"> 44     public static int NUM_TEST_CLASSES = 7;</span>
<span class="line-added"> 45     public static long RANDOM_LOOP = 100;</span>
<span class="line-added"> 46     public static boolean VERBOSE = false;</span>
 47 
<a name="7" id="anc7"></a><span class="line-modified"> 48     private static final Random indexGenerator = Utils.getRandomInstance();</span>
<span class="line-modified"> 49     private static String[] ClassArray = null;</span>
<span class="line-added"> 50     private static Class[] ClassInstanceArray = null;</span>
<span class="line-added"> 51     private static int maxClassIndex = 0;</span>
 52 
<a name="8" id="anc8"></a><span class="line-added"> 53     private static String[] MethodName_Array = null;</span>
<span class="line-added"> 54     private static Method[] MethodInstance_Array = null;</span>
 55 
<a name="9" id="anc9"></a><span class="line-modified"> 56     // Should be prime, so that odds of an incorrect verification reduced</span>
<span class="line-modified"> 57     public static int[] MethodID_Array = null;</span>
 58 
<a name="10" id="anc10"></a><span class="line-modified"> 59     public static synchronized void initialize(String testListPath) {</span>
<span class="line-modified"> 60         File td = new File(testListPath);</span>
<span class="line-added"> 61         if (!td.exists()) {</span>
<span class="line-added"> 62             throw new Error(&quot;TESTBUG: File &quot; + testListPath + &quot; Not found&quot;);</span>
<span class="line-added"> 63         }</span>
 64 
<a name="11" id="anc11"></a><span class="line-modified"> 65         if (!td.isFile()) {</span>
<span class="line-modified"> 66             throw new Error(&quot;TESTBUG: &quot; + testListPath + &quot; Must be a File&quot;);</span>
<span class="line-modified"> 67         }</span>








 68 
 69         BufferedReader classList = null;
<a name="12" id="anc12"></a><span class="line-added"> 70         try {</span>
<span class="line-added"> 71             try {</span>
<span class="line-added"> 72                 classList = new BufferedReader(new FileReader(td));</span>
<span class="line-added"> 73             } catch (FileNotFoundException e) {</span>
<span class="line-added"> 74                 throw new Error(&quot;TESTBUG: Error finding Classlist&quot;, e);</span>
<span class="line-added"> 75             }</span>
 76 
<a name="13" id="anc13"></a><span class="line-modified"> 77             String line = null;</span>
<span class="line-modified"> 78             try {</span>











 79                 line = classList.readLine();
<a name="14" id="anc14"></a><span class="line-modified"> 80             } catch (IOException e) {</span>
<span class="line-modified"> 81                 throw new Error(&quot;TESTBUG: Error reading Classlist&quot;, e);</span>



 82             }
 83 
<a name="15" id="anc15"></a><span class="line-modified"> 84             try {</span>
<span class="line-modified"> 85                 // ClassArray.length;</span>
<span class="line-modified"> 86                 maxClassIndex = Math.abs(Integer.parseInt(line));</span>
<span class="line-added"> 87             } catch (NumberFormatException e) {</span>
<span class="line-added"> 88                 throw new Error(&quot;TESTBUG: Error reading Classlist - first number must be number of methods defined&quot;, e);</span>
 89             }
<a name="16" id="anc16"></a>










 90 
<a name="17" id="anc17"></a><span class="line-modified"> 91             ClassArray = new String[maxClassIndex];</span>
<span class="line-modified"> 92             ClassInstanceArray = new Class[maxClassIndex];</span>
<span class="line-modified"> 93             MethodName_Array = new String[maxClassIndex];</span>
<span class="line-modified"> 94             MethodInstance_Array = new Method[maxClassIndex];</span>
<span class="line-modified"> 95             MethodID_Array = new int[maxClassIndex];</span>
<span class="line-modified"> 96 </span>
<span class="line-modified"> 97             int i;</span>
<span class="line-modified"> 98             for (i = 0; i &lt; maxClassIndex; i++) {</span>
<span class="line-modified"> 99                 try {</span>
<span class="line-modified">100                     line = classList.readLine();</span>
<span class="line-modified">101                 } catch (IOException e) {</span>
<span class="line-modified">102                     throw new Error(&quot;TESTBUG: Error reading ClasslistFile: testListPath&quot;, e);</span>
<span class="line-added">103                 }</span>
104                 StringTokenizer lineTokens = new StringTokenizer(line, &quot;\t &quot;);
<a name="18" id="anc18"></a><span class="line-modified">105                 if (lineTokens.countTokens() &lt; 3) {</span>
<span class="line-modified">106                     throw new Error(&quot;TESTBUG: ClasslistFile: unexpected line:&quot; + line);</span>
<span class="line-modified">107                 } else {</span>




108                     ClassArray[i] = lineTokens.nextToken();
<a name="19" id="anc19"></a><span class="line-modified">109                     MethodName_Array[i] = lineTokens.nextToken();</span>
110                     MethodID_Array[i] = Integer.parseInt(lineTokens.nextToken());
<a name="20" id="anc20"></a><span class="line-modified">111                 }</span>
112             }
<a name="21" id="anc21"></a><span class="line-modified">113             maxClassIndex = i;</span>
<span class="line-added">114         } finally {</span>
<span class="line-added">115             if (classList != null) {</span>
<span class="line-added">116                 try {</span>
<span class="line-added">117                     classList.close();</span>
<span class="line-added">118                 } catch (IOException e) {</span>
<span class="line-added">119                     throw new Error(&quot;can&#39;t close file&quot;, e);</span>
<span class="line-added">120                 }</span>
<span class="line-added">121             }</span>
<span class="line-added">122         }</span>
123 
<a name="22" id="anc22"></a><span class="line-modified">124         if ((NUM_TEST_CLASSES &lt; ClassArray.length) &amp;&amp; (NUM_TEST_CLASSES &gt; 0)) {</span>
<span class="line-modified">125             maxClassIndex = NUM_TEST_CLASSES;</span>
<span class="line-modified">126         } else {</span>
<span class="line-modified">127             NUM_TEST_CLASSES = maxClassIndex;</span>
<span class="line-modified">128         }</span>
129     }
130 
<a name="23" id="anc23"></a><span class="line-modified">131     // does a binary search to find the index for the ID of a method</span>
<span class="line-modified">132     private static int ID_BinSearch(int begin, int end, int ID) {</span>
<span class="line-modified">133         if (end &lt; begin) {</span>
<span class="line-modified">134             return (-1);</span>
<span class="line-modified">135         }</span>
136 
<a name="24" id="anc24"></a><span class="line-modified">137         int mid = (begin + end) / 2;</span>
138         int midvalue = MethodID_Array[mid];
139 
<a name="25" id="anc25"></a><span class="line-modified">140         if (ID == midvalue) {</span>
141             return (mid);
<a name="26" id="anc26"></a><span class="line-modified">142         } else if (ID &lt; midvalue) {</span>
<span class="line-modified">143             return (ID_BinSearch(begin, mid - 1, ID));</span>
<span class="line-modified">144         } else {</span>
<span class="line-modified">145             return (ID_BinSearch(mid + 1, end, ID));</span>
<span class="line-added">146         }</span>
147     }
148 
149 
<a name="27" id="anc27"></a><span class="line-modified">150     // based off a static index, this function selects the method to be called</span>
<span class="line-modified">151     public static MethodData returnNextStaticMethod(int Method_ID) {</span>
<span class="line-modified">152         //int i = ID_BinSearch(0, MethodID_Array.length - 1, Method_ID);</span>
<span class="line-modified">153         int i = ID_BinSearch(0, maxClassIndex - 1, Method_ID);</span>

154 
<a name="28" id="anc28"></a><span class="line-modified">155         return (nextStaticMethod((i == -1) ? 0 : i));</span>
156     }
157 
<a name="29" id="anc29"></a><span class="line-modified">158     // this function randomly selects the next method to be called by the test class</span>
<span class="line-modified">159     public static MethodData nextRandomMethod() {</span>


160         int i = indexGenerator.nextInt(maxClassIndex);
<a name="30" id="anc30"></a><span class="line-modified">161         return (nextStaticMethod(i));</span>
162     }
163 
<a name="31" id="anc31"></a><span class="line-modified">164     private static MethodData nextStaticMethod(int i) {</span>

165         Class methodsClass = null;
166         Method nextMethod = null;
167 
<a name="32" id="anc32"></a><span class="line-modified">168         try {</span>
<span class="line-modified">169             methodsClass = ClassInstanceArray[i];</span>
<span class="line-modified">170             if (methodsClass == null) {</span>
<span class="line-modified">171                 methodsClass = Class.forName(ClassArray[i]);</span>
<span class="line-modified">172                 ClassInstanceArray[i] = methodsClass;</span>

























173             }
<a name="33" id="anc33"></a><span class="line-modified">174             nextMethod = MethodInstance_Array[i];</span>
<span class="line-modified">175             if (nextMethod == null) {</span>
<span class="line-modified">176                 nextMethod = methodsClass.getMethod(MethodName_Array[i],</span>
<span class="line-modified">177                         Vector.class, Vector.class,  Long.class, Integer.class);</span>
<span class="line-modified">178                 // sum vector, ID vector, function depth, static function call depth</span>
<span class="line-modified">179                 MethodInstance_Array[i] = nextMethod;</span>
180             }
<a name="34" id="anc34"></a><span class="line-modified">181         } catch (ClassNotFoundException e) {</span>
<span class="line-added">182             throw new Error(&quot;TESTBUG Class: &quot; + ClassArray[i] + &quot; Not Found&quot;, e);</span>
<span class="line-added">183         } catch (NoSuchMethodException e) {</span>
<span class="line-added">184             throw new Error(&quot;TESTBUG Method: &quot; + ClassArray[i] + &quot;::&quot; + MethodName_Array[i] + &quot; Not Found&quot;, e);</span>
<span class="line-added">185         } catch (SecurityException e) {</span>
<span class="line-added">186             throw new Error(&quot;TESTBUG Security Exception Generated by &quot; + ClassArray[i] + &quot;::&quot; + MethodName_Array[i], e);</span>
<span class="line-added">187         }</span>
<span class="line-added">188         return new MethodData(ClassArray[i], MethodName_Array[i], methodsClass, nextMethod, MethodID_Array[i]);</span>
189     }
190 
191 
<a name="35" id="anc35"></a><span class="line-modified">192     /* These two functions are used to verify that all function were called in the proper order */</span>
193 
<a name="36" id="anc36"></a><span class="line-modified">194     // called by &quot;parent&quot; function to add childs ID to vector</span>
<span class="line-modified">195     public static void addFunctionIDToVector(int FunctionIndex, Vector IDVector) {</span>
<span class="line-modified">196         IDVector.addElement(FunctionIndex);</span>

197     }
198 
<a name="37" id="anc37"></a><span class="line-modified">199     // called by &quot;child&quot; to add Function Index to Vector</span>
<span class="line-modified">200     public static void appendSumToSummationVector(int FunctionIndex, Vector SummationVector) {</span>
<span class="line-modified">201         if (SummationVector.isEmpty()) {</span>
<span class="line-modified">202             SummationVector.addElement((long) FunctionIndex);</span>
<span class="line-modified">203         } else {</span>
<span class="line-modified">204             SummationVector.addElement((Long) SummationVector.lastElement() + FunctionIndex);</span>
<span class="line-modified">205         }</span>
206     }
207 
<a name="38" id="anc38"></a><span class="line-modified">208     // This function calls a method based off of MethodData</span>
209     public static void callMethod(MethodData methodCallStr,
210                                   Vector summation, Vector ID,
211                                   Long numFcalls, Integer staticFcalls)
<a name="39" id="anc39"></a><span class="line-modified">212             throws InvocationTargetException {</span>
<span class="line-modified">213         try {</span>
<span class="line-modified">214             methodCallStr.nextMethod.invoke(methodCallStr.instance,</span>
<span class="line-modified">215                     summation, ID, numFcalls, staticFcalls);</span>
<span class="line-modified">216         } catch (IllegalAccessException e) {</span>
<span class="line-modified">217             // should never happen with a valid testfile</span>
<span class="line-modified">218             throw new TestFailure(&quot;Illegal Access Exception&quot;, e);</span>
<span class="line-modified">219         }</span>


























220     }
221 }
<a name="40" id="anc40"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="40" type="hidden" />
</body>
</html>