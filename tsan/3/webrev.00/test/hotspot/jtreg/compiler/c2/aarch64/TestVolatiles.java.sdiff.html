<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/hotspot/jtreg/compiler/c2/aarch64/TestVolatiles.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="../Test8004741.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../cr6340864/TestDoubleVect.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/jtreg/compiler/c2/aarch64/TestVolatiles.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 
  24 /*
  25  * common code to run and validate tests of code generation for
  26  * volatile ops on AArch64
  27  *
  28  * incoming args are &lt;testclass&gt; &lt;testtype&gt;
  29  *
  30  * where &lt;testclass&gt; in {TestVolatileLoad,
  31  *                       TestVolatileStore,
  32  *                       TestUnsafeVolatileLoad,
  33  *                       TestUnsafeVolatileStore,
  34  *                       TestUnsafeVolatileCAS,
  35  *                       TestUnsafeVolatileWeakCAS,
  36  *                       TestUnsafeVolatileCAE,
  37  *                       TestUnsafeVolatileGAS}
  38  * and &lt;testtype&gt; in {G1,
<span class="line-removed">  39  *                    CMS,</span>
<span class="line-removed">  40  *                    CMSCondMark,</span>
  41  *                    Serial,
  42  *                    Parallel,
  43  *                    Shenandoah,
  44  *                    ShenandoahTraversal}
  45  */
  46 
  47 
  48 package compiler.c2.aarch64;
  49 
  50 import java.util.List;
  51 import java.util.ListIterator;
  52 import java.util.Iterator;
  53 import java.util.regex.Pattern;
  54 import java.io.*;
  55 
  56 import jdk.test.lib.Asserts;
  57 import jdk.test.lib.compiler.InMemoryJavaCompiler;
  58 import jdk.test.lib.process.OutputAnalyzer;
  59 import jdk.test.lib.process.ProcessTools;
  60 import sun.hotspot.WhiteBox;
</pre>
<hr />
<pre>
  73         String[] procArgs;
  74         int argcount;
  75         // add one or two extra arguments according to test type
  76         // i.e. GC type plus GC conifg
  77         switch(testType) {
  78         case &quot;G1&quot;:
  79             argcount = 9;
  80             procArgs = new String[argcount];
  81             procArgs[argcount - 2] = &quot;-XX:+UseG1GC&quot;;
  82             break;
  83         case &quot;Parallel&quot;:
  84             argcount = 9;
  85             procArgs = new String[argcount];
  86             procArgs[argcount - 2] = &quot;-XX:+UseParallelGC&quot;;
  87             break;
  88         case &quot;Serial&quot;:
  89             argcount = 9;
  90             procArgs = new String[argcount];
  91             procArgs[argcount - 2] = &quot;-XX:+UseSerialGC&quot;;
  92             break;
<span class="line-removed">  93         case &quot;CMS&quot;:</span>
<span class="line-removed">  94             argcount = 10;</span>
<span class="line-removed">  95             procArgs = new String[argcount];</span>
<span class="line-removed">  96             procArgs[argcount - 3] = &quot;-XX:+UseConcMarkSweepGC&quot;;</span>
<span class="line-removed">  97             procArgs[argcount - 2] = &quot;-XX:-UseCondCardMark&quot;;</span>
<span class="line-removed">  98             break;</span>
<span class="line-removed">  99         case &quot;CMSCondMark&quot;:</span>
<span class="line-removed"> 100             argcount = 10;</span>
<span class="line-removed"> 101             procArgs = new String[argcount];</span>
<span class="line-removed"> 102             procArgs[argcount - 3] = &quot;-XX:+UseConcMarkSweepGC&quot;;</span>
<span class="line-removed"> 103             procArgs[argcount - 2] = &quot;-XX:+UseCondCardMark&quot;;</span>
<span class="line-removed"> 104             break;</span>
 105         case &quot;Shenandoah&quot;:
 106             argcount = 10;
 107             procArgs = new String[argcount];
 108             procArgs[argcount - 3] = &quot;-XX:+UnlockExperimentalVMOptions&quot;;
 109             procArgs[argcount - 2] = &quot;-XX:+UseShenandoahGC&quot;;
 110             break;
 111         case &quot;ShenandoahTraversal&quot;:
 112             argcount = 11;
 113             procArgs = new String[argcount];
 114             procArgs[argcount - 4] = &quot;-XX:+UnlockExperimentalVMOptions&quot;;
 115             procArgs[argcount - 3] = &quot;-XX:+UseShenandoahGC&quot;;
<span class="line-modified"> 116             procArgs[argcount - 2] = &quot;-XX:ShenandoahGCHeuristics=traversal&quot;;</span>
 117             break;
 118         default:
 119             throw new RuntimeException(&quot;unexpected test type &quot; + testType);
 120         }
 121 
 122         // fill in arguments common to all cases
 123 
 124         // the first round of test enables transform of barriers to
 125         // use acquiring loads and releasing stores by setting arg
 126         // zero appropriately. this arg is reset in the second run to
 127         // disable the transform.
 128 
 129         procArgs[0] = &quot;-XX:-UseBarriersForVolatile&quot;;
 130         procArgs[1] = &quot;-XX:+UseCompressedOops&quot;;
 131 
 132         procArgs[2] = &quot;-XX:-TieredCompilation&quot;;
 133         procArgs[3] = &quot;-XX:+PrintOptoAssembly&quot;;
 134         procArgs[4] = &quot;-XX:CompileCommand=compileonly,&quot; + fullclassname + &quot;::&quot; + &quot;test*&quot;;
 135         procArgs[5] = &quot;--add-exports&quot;;
 136         procArgs[6] = &quot;java.base/jdk.internal.misc=ALL-UNNAMED&quot;;
</pre>
<hr />
<pre>
 313 
 314         checkCompile(iter, &quot;testInt&quot;, matches, output, true);
 315 
 316         // object stores will be as above except for when the GC
 317         // introduces barriers for card marking
 318 
 319         if (!useBarriersForVolatile) {
 320             switch (testType) {
 321             default:
 322                 // this is the basic sequence of instructions
 323                 matches = new String[] {
 324                     &quot;membar_release \\(elided\\)&quot;,
 325                     useCompressedOops ? &quot;stlrw?&quot; : &quot;stlr&quot;,
 326                     &quot;membar_volatile \\(elided\\)&quot;,
 327                     &quot;ret&quot;
 328                 };
 329                 break;
 330             case &quot;G1&quot;:
 331                 // a card mark volatile barrier should be generated
 332                 // before the card mark strb




 333                 matches = new String[] {
 334                     &quot;membar_release \\(elided\\)&quot;,
 335                     useCompressedOops ? &quot;stlrw?&quot; : &quot;stlr&quot;,
<span class="line-removed"> 336                     &quot;membar_volatile&quot;,</span>
<span class="line-removed"> 337                     &quot;dmb ish&quot;,</span>
<span class="line-removed"> 338                     &quot;strb&quot;,</span>
 339                     &quot;membar_volatile \\(elided\\)&quot;,
<span class="line-modified"> 340                     &quot;ret&quot;</span>
<span class="line-removed"> 341                 };</span>
<span class="line-removed"> 342                 break;</span>
<span class="line-removed"> 343             case &quot;CMSCondMark&quot;:</span>
<span class="line-removed"> 344                 // a card mark volatile barrier should be generated</span>
<span class="line-removed"> 345                 // before the card mark strb from the StoreCM and the</span>
<span class="line-removed"> 346                 // storestore barrier from the StoreCM should be elided</span>
<span class="line-removed"> 347                 matches = new String[] {</span>
<span class="line-removed"> 348                     &quot;membar_release \\(elided\\)&quot;,</span>
<span class="line-removed"> 349                     useCompressedOops ? &quot;stlrw?&quot; : &quot;stlr&quot;,</span>
 350                     &quot;membar_volatile&quot;,
 351                     &quot;dmb ish&quot;,
<span class="line-modified"> 352                     &quot;storestore \\(elided\\)&quot;,</span>
<span class="line-removed"> 353                     &quot;strb&quot;,</span>
<span class="line-removed"> 354                     &quot;membar_volatile \\(elided\\)&quot;,</span>
<span class="line-removed"> 355                     &quot;ret&quot;</span>
<span class="line-removed"> 356                 };</span>
<span class="line-removed"> 357                 break;</span>
<span class="line-removed"> 358             case &quot;CMS&quot;:</span>
<span class="line-removed"> 359                 // a volatile card mark membar should not be generated</span>
<span class="line-removed"> 360                 // before the card mark strb from the StoreCM and the</span>
<span class="line-removed"> 361                 // storestore barrier from the StoreCM should be</span>
<span class="line-removed"> 362                 // generated as &quot;dmb ishst&quot;</span>
<span class="line-removed"> 363                 matches = new String[] {</span>
<span class="line-removed"> 364                     &quot;membar_release \\(elided\\)&quot;,</span>
<span class="line-removed"> 365                     useCompressedOops ? &quot;stlrw?&quot; : &quot;stlr&quot;,</span>
<span class="line-removed"> 366                     &quot;storestore&quot;,</span>
<span class="line-removed"> 367                     &quot;dmb ishst&quot;,</span>
<span class="line-removed"> 368                     &quot;strb&quot;,</span>
<span class="line-removed"> 369                     &quot;membar_volatile \\(elided\\)&quot;,</span>
<span class="line-removed"> 370                     &quot;ret&quot;</span>
 371                 };
 372                 break;
 373             case &quot;Shenandoah&quot;:
 374             case &quot;ShenandoahTraversal&quot;:
 375                  // Shenandoah generates normal object graphs for
 376                  // volatile stores
 377                 matches = new String[] {
 378                     &quot;membar_release \\(elided\\)&quot;,
 379                     useCompressedOops ? &quot;stlrw?&quot; : &quot;stlr&quot;,
 380                     &quot;membar_volatile \\(elided\\)&quot;,
 381                     &quot;ret&quot;
 382                 };
 383                 break;
 384             }
 385         } else {
 386             switch (testType) {
 387             default:
 388                 // this is the basic sequence of instructions
 389                 matches = new String[] {
 390                     &quot;membar_release&quot;,
 391                     &quot;dmb ish&quot;,
 392                     useCompressedOops ? &quot;strw?&quot; : &quot;str&quot;,
 393                     &quot;membar_volatile&quot;,
 394                     &quot;dmb ish&quot;,
 395                     &quot;ret&quot;
 396                 };
 397                 break;
 398             case &quot;G1&quot;:
 399                 // a card mark volatile barrier should be generated
 400                 // before the card mark strb




 401                 matches = new String[] {
 402                     &quot;membar_release&quot;,
 403                     &quot;dmb ish&quot;,
 404                     useCompressedOops ? &quot;strw?&quot; : &quot;str&quot;,
 405                     &quot;membar_volatile&quot;,
 406                     &quot;dmb ish&quot;,
<span class="line-modified"> 407                     &quot;strb&quot;,</span>
 408                     &quot;membar_volatile&quot;,
 409                     &quot;dmb ish&quot;,
<span class="line-modified"> 410                     &quot;ret&quot;</span>
 411                 };
 412                 break;
 413             case &quot;CMSCondMark&quot;:
 414                 // a card mark volatile barrier should be generated
 415                 // before the card mark strb from the StoreCM and the
 416                 // storestore barrier from the StoreCM should be elided
 417                 matches = new String[] {
 418                     &quot;membar_release&quot;,
 419                     &quot;dmb ish&quot;,
 420                     useCompressedOops ? &quot;strw?&quot; : &quot;str&quot;,
 421                     &quot;membar_volatile&quot;,
 422                     &quot;dmb ish&quot;,
 423                     &quot;storestore \\(elided\\)&quot;,
 424                     &quot;strb&quot;,
 425                     &quot;membar_volatile&quot;,
 426                     &quot;dmb ish&quot;,
 427                     &quot;ret&quot;
 428                 };
 429                 break;
 430             case &quot;CMS&quot;:
</pre>
<hr />
<pre>
 504         }
 505 
 506         // object stores will be as above except for when the GC
 507         // introduces barriers for card marking
 508 
 509         if (!useBarriersForVolatile) {
 510             switch (testType) {
 511             default:
 512                 // this is the basic sequence of instructions
 513                 matches = new String[] {
 514                     &quot;membar_release \\(elided\\)&quot;,
 515                     useCompressedOops ? &quot;cmpxchgw?_acq&quot; : &quot;cmpxchg_acq&quot;,
 516                     &quot;strb&quot;,
 517                     &quot;membar_acquire \\(elided\\)&quot;,
 518                     &quot;ret&quot;
 519                 };
 520                 break;
 521             case &quot;G1&quot;:
 522                 // a card mark volatile barrier should be generated
 523                 // before the card mark strb




 524                 matches = new String[] {
 525                     &quot;membar_release \\(elided\\)&quot;,
 526                     useCompressedOops ? &quot;cmpxchgw?_acq&quot; : &quot;cmpxchg_acq&quot;,
<span class="line-removed"> 527                     &quot;membar_volatile&quot;,</span>
<span class="line-removed"> 528                     &quot;dmb ish&quot;,</span>
<span class="line-removed"> 529                     &quot;strb&quot;,</span>
 530                     &quot;membar_acquire \\(elided\\)&quot;,
<span class="line-modified"> 531                     &quot;ret&quot;</span>
<span class="line-removed"> 532                 };</span>
<span class="line-removed"> 533                 break;</span>
<span class="line-removed"> 534             case &quot;CMSCondMark&quot;:</span>
<span class="line-removed"> 535                 // a card mark volatile barrier should be generated</span>
<span class="line-removed"> 536                 // before the card mark strb from the StoreCM and the</span>
<span class="line-removed"> 537                 // storestore barrier from the StoreCM should be elided</span>
<span class="line-removed"> 538                 matches = new String[] {</span>
<span class="line-removed"> 539                     &quot;membar_release \\(elided\\)&quot;,</span>
<span class="line-removed"> 540                     useCompressedOops ? &quot;cmpxchgw?_acq&quot; : &quot;cmpxchg_acq&quot;,</span>
 541                     &quot;membar_volatile&quot;,
 542                     &quot;dmb ish&quot;,
<span class="line-modified"> 543                     &quot;storestore \\(elided\\)&quot;,</span>
<span class="line-removed"> 544                     &quot;strb&quot;,</span>
<span class="line-removed"> 545                     &quot;membar_acquire \\(elided\\)&quot;,</span>
<span class="line-removed"> 546                     &quot;ret&quot;</span>
<span class="line-removed"> 547                 };</span>
<span class="line-removed"> 548                 break;</span>
<span class="line-removed"> 549             case &quot;CMS&quot;:</span>
<span class="line-removed"> 550                 // a volatile card mark membar should not be generated</span>
<span class="line-removed"> 551                 // before the card mark strb from the StoreCM and the</span>
<span class="line-removed"> 552                 // storestore barrier from the StoreCM should be elided</span>
<span class="line-removed"> 553                 matches = new String[] {</span>
<span class="line-removed"> 554                     &quot;membar_release \\(elided\\)&quot;,</span>
<span class="line-removed"> 555                     useCompressedOops ? &quot;cmpxchgw?_acq&quot; : &quot;cmpxchg_acq&quot;,</span>
<span class="line-removed"> 556                     &quot;storestore&quot;,</span>
<span class="line-removed"> 557                     &quot;dmb ishst&quot;,</span>
<span class="line-removed"> 558                     &quot;strb&quot;,</span>
<span class="line-removed"> 559                     &quot;membar_acquire \\(elided\\)&quot;,</span>
<span class="line-removed"> 560                     &quot;ret&quot;</span>
 561                 };
 562                 break;
 563             case &quot;Shenandoah&quot;:
 564             case &quot;ShenandoahTraversal&quot;:
 565                 // For volatile CAS, Shenanodoah generates normal
 566                 // graphs with a shenandoah-specific cmpxchg
 567                 matches = new String[] {
 568                     &quot;membar_release \\(elided\\)&quot;,
 569                     useCompressedOops ? &quot;cmpxchgw?_acq_shenandoah&quot; : &quot;cmpxchg_acq_shenandoah&quot;,
 570                     &quot;membar_acquire \\(elided\\)&quot;,
 571                     &quot;ret&quot;
 572                 };
 573                 break;
 574             }
 575         } else {
 576             switch (testType) {
 577             default:
 578                 // this is the basic sequence of instructions
 579                 matches = new String[] {
 580                     &quot;membar_release&quot;,
 581                     &quot;dmb ish&quot;,
 582                     useCompressedOops ? &quot;cmpxchgw? &quot; : &quot;cmpxchg &quot;,
 583                     &quot;membar_acquire&quot;,
 584                     &quot;dmb ish&quot;,
 585                     &quot;ret&quot;
 586                 };
 587                 break;
 588             case &quot;G1&quot;:
 589                 // a card mark volatile barrier should be generated
 590                 // before the card mark strb




 591                 matches = new String[] {
 592                     &quot;membar_release&quot;,
 593                     &quot;dmb ish&quot;,
 594                     useCompressedOops ? &quot;cmpxchgw? &quot; : &quot;cmpxchg &quot;,
<span class="line-removed"> 595                     &quot;membar_volatile&quot;,</span>
<span class="line-removed"> 596                     &quot;dmb ish&quot;,</span>
<span class="line-removed"> 597                     &quot;strb&quot;,</span>
 598                     &quot;membar_acquire&quot;,
 599                     &quot;dmb ish&quot;,
<span class="line-modified"> 600                     &quot;ret&quot;</span>



 601                 };
 602                 break;
 603             case &quot;CMSCondMark&quot;:
 604                 // a card mark volatile barrier should be generated
 605                 // before the card mark strb from the StoreCM and the
 606                 // storestore barrier from the StoreCM should be elided
 607                 matches = new String[] {
 608                     &quot;membar_release&quot;,
 609                     &quot;dmb ish&quot;,
 610                     useCompressedOops ? &quot;cmpxchgw? &quot; : &quot;cmpxchg &quot;,
 611                     &quot;membar_volatile&quot;,
 612                     &quot;dmb ish&quot;,
 613                     &quot;storestore \\(elided\\)&quot;,
 614                     &quot;strb&quot;,
 615                     &quot;membar_acquire&quot;,
 616                     &quot;dmb ish&quot;,
 617                     &quot;ret&quot;
 618                 };
 619                 break;
 620             case &quot;CMS&quot;:
</pre>
<hr />
<pre>
 709                 // the cmpxchg so try both sequences.
 710                 int idx = iter.nextIndex();
 711                 if (!checkCompile(iter, &quot;testObj&quot;, matches, output, false)) {
 712                     iter = output.asLines().listIterator(idx);
 713 
 714                     matches = new String[] {
 715                         &quot;membar_release \\(elided\\)&quot;,
 716                         useCompressedOops ? &quot;cmpxchgw?_acq&quot; : &quot;cmpxchg_acq&quot;,
 717                         &quot;strb&quot;,
 718                         &quot;membar_acquire \\(elided\\)&quot;,
 719                         &quot;ret&quot;
 720                     };
 721 
 722                     checkCompile(iter, &quot;testObj&quot;, matches, output, true);
 723                 }
 724                 return;
 725 
 726             case &quot;G1&quot;:
 727                 // a card mark volatile barrier should be generated
 728                 // before the card mark strb




 729                 matches = new String[] {
 730                     &quot;membar_release \\(elided\\)&quot;,
 731                     useCompressedOops ? &quot;cmpxchgw?_acq&quot; : &quot;cmpxchg_acq&quot;,
<span class="line-removed"> 732                     &quot;membar_volatile&quot;,</span>
<span class="line-removed"> 733                     &quot;dmb ish&quot;,</span>
<span class="line-removed"> 734                     &quot;strb&quot;,</span>
 735                     &quot;membar_acquire \\(elided\\)&quot;,
<span class="line-modified"> 736                     &quot;ret&quot;</span>
<span class="line-removed"> 737                 };</span>
<span class="line-removed"> 738                 break;</span>
<span class="line-removed"> 739             case &quot;CMSCondMark&quot;:</span>
<span class="line-removed"> 740                 // a card mark volatile barrier should be generated</span>
<span class="line-removed"> 741                 // before the card mark strb from the StoreCM and the</span>
<span class="line-removed"> 742                 // storestore barrier from the StoreCM should be elided</span>
<span class="line-removed"> 743                 matches = new String[] {</span>
<span class="line-removed"> 744                     &quot;membar_release \\(elided\\)&quot;,</span>
<span class="line-removed"> 745                     useCompressedOops ? &quot;cmpxchgw?_acq&quot; : &quot;cmpxchg_acq&quot;,</span>
 746                     &quot;membar_volatile&quot;,
 747                     &quot;dmb ish&quot;,
<span class="line-modified"> 748                     &quot;storestore \\(elided\\)&quot;,</span>
<span class="line-removed"> 749                     &quot;strb&quot;,</span>
<span class="line-removed"> 750                     &quot;membar_acquire \\(elided\\)&quot;,</span>
<span class="line-removed"> 751                     &quot;ret&quot;</span>
<span class="line-removed"> 752                 };</span>
<span class="line-removed"> 753                 break;</span>
<span class="line-removed"> 754             case &quot;CMS&quot;:</span>
<span class="line-removed"> 755                 // a volatile card mark membar should not be generated</span>
<span class="line-removed"> 756                 // before the card mark strb from the StoreCM and the</span>
<span class="line-removed"> 757                 // storestore barrier from the StoreCM should be elided</span>
<span class="line-removed"> 758                 matches = new String[] {</span>
<span class="line-removed"> 759                     &quot;membar_release \\(elided\\)&quot;,</span>
<span class="line-removed"> 760                     useCompressedOops ? &quot;cmpxchgw?_acq&quot; : &quot;cmpxchg_acq&quot;,</span>
<span class="line-removed"> 761                     &quot;storestore&quot;,</span>
<span class="line-removed"> 762                     &quot;dmb ishst&quot;,</span>
<span class="line-removed"> 763                     &quot;strb&quot;,</span>
<span class="line-removed"> 764                     &quot;membar_acquire \\(elided\\)&quot;,</span>
<span class="line-removed"> 765                     &quot;ret&quot;</span>
 766                 };
 767                 break;
 768             case &quot;Shenandoah&quot;:
 769             case &quot;ShenandoahTraversal&quot;:
 770                 // For volatile CAS, Shenanodoah generates normal
 771                 // graphs with a shenandoah-specific cmpxchg
 772                 matches = new String[] {
 773                     &quot;membar_release \\(elided\\)&quot;,
 774                     useCompressedOops ? &quot;cmpxchgw?_acq_shenandoah&quot; : &quot;cmpxchg_acq_shenandoah&quot;,
 775                     &quot;membar_acquire \\(elided\\)&quot;,
 776                     &quot;ret&quot;
 777                 };
 778                 break;
 779             }
 780         } else {
 781             switch (testType) {
 782             default:
 783                 // this is the basic sequence of instructions
 784                 matches = new String[] {
 785                     &quot;membar_release&quot;,
 786                     &quot;dmb ish&quot;,
 787                     useCompressedOops ? &quot;cmpxchgw? &quot; : &quot;cmpxchg &quot;,
 788                     &quot;membar_acquire&quot;,
 789                     &quot;dmb ish&quot;,
 790                     &quot;ret&quot;
 791                 };
 792                 break;
 793             case &quot;G1&quot;:
 794                 // a card mark volatile barrier should be generated
 795                 // before the card mark strb




 796                 matches = new String[] {
 797                     &quot;membar_release&quot;,
 798                     &quot;dmb ish&quot;,
 799                     useCompressedOops ? &quot;cmpxchgw? &quot; : &quot;cmpxchg &quot;,
<span class="line-removed"> 800                     &quot;membar_volatile&quot;,</span>
<span class="line-removed"> 801                     &quot;dmb ish&quot;,</span>
<span class="line-removed"> 802                     &quot;strb&quot;,</span>
 803                     &quot;membar_acquire&quot;,
 804                     &quot;dmb ish&quot;,
<span class="line-modified"> 805                     &quot;ret&quot;</span>



 806                 };
 807                 break;
 808             case &quot;CMSCondMark&quot;:
 809                 // a card mark volatile barrier should be generated
 810                 // before the card mark strb from the StoreCM and the
 811                 // storestore barrier from the StoreCM should be elided
 812                 matches = new String[] {
 813                     &quot;membar_release&quot;,
 814                     &quot;dmb ish&quot;,
 815                     useCompressedOops ? &quot;cmpxchgw? &quot; : &quot;cmpxchg &quot;,
 816                     &quot;membar_volatile&quot;,
 817                     &quot;dmb ish&quot;,
 818                     &quot;storestore \\(elided\\)&quot;,
 819                     &quot;strb&quot;,
 820                     &quot;membar_acquire&quot;,
 821                     &quot;dmb ish&quot;,
 822                     &quot;ret&quot;
 823                 };
 824                 break;
 825             case &quot;CMS&quot;:
</pre>
<hr />
<pre>
 894         }
 895 
 896         // object stores will be as above except for when the GC
 897         // introduces barriers for card marking
 898 
 899         if (!useBarriersForVolatile) {
 900             switch (testType) {
 901             default:
 902                 // this is the basic sequence of instructions
 903                 matches = new String[] {
 904                     &quot;membar_release \\(elided\\)&quot;,
 905                     useCompressedOops ? &quot;atomic_xchgw?_acq&quot; : &quot;atomic_xchg_acq&quot;,
 906                     &quot;strb&quot;,
 907                     &quot;membar_acquire \\(elided\\)&quot;,
 908                     &quot;ret&quot;
 909                 };
 910                 break;
 911             case &quot;G1&quot;:
 912                 // a card mark volatile barrier should be generated
 913                 // before the card mark strb




 914                 matches = new String[] {
 915                     &quot;membar_release \\(elided\\)&quot;,
 916                     useCompressedOops ? &quot;atomic_xchgw?_acq&quot; : &quot;atomic_xchg_acq&quot;,
<span class="line-removed"> 917                     &quot;membar_volatile&quot;,</span>
<span class="line-removed"> 918                     &quot;dmb ish&quot;,</span>
<span class="line-removed"> 919                     &quot;strb&quot;,</span>
 920                     &quot;membar_acquire \\(elided\\)&quot;,
<span class="line-modified"> 921                     &quot;ret&quot;</span>
<span class="line-removed"> 922                 };</span>
<span class="line-removed"> 923                 break;</span>
<span class="line-removed"> 924             case &quot;CMSCondMark&quot;:</span>
<span class="line-removed"> 925                 // a card mark volatile barrier should be generated</span>
<span class="line-removed"> 926                 // before the card mark strb from the StoreCM and the</span>
<span class="line-removed"> 927                 // storestore barrier from the StoreCM should be elided</span>
<span class="line-removed"> 928                 matches = new String[] {</span>
<span class="line-removed"> 929                     &quot;membar_release \\(elided\\)&quot;,</span>
<span class="line-removed"> 930                     useCompressedOops ? &quot;atomic_xchgw?_acq&quot; : &quot;atomic_xchg_acq&quot;,</span>
 931                     &quot;membar_volatile&quot;,
 932                     &quot;dmb ish&quot;,
<span class="line-modified"> 933                     &quot;storestore \\(elided\\)&quot;,</span>
<span class="line-removed"> 934                     &quot;strb&quot;,</span>
<span class="line-removed"> 935                     &quot;membar_acquire \\(elided\\)&quot;,</span>
<span class="line-removed"> 936                     &quot;ret&quot;</span>
<span class="line-removed"> 937                 };</span>
<span class="line-removed"> 938                 break;</span>
<span class="line-removed"> 939             case &quot;CMS&quot;:</span>
<span class="line-removed"> 940                 // a volatile card mark membar should not be generated</span>
<span class="line-removed"> 941                 // before the card mark strb from the StoreCM and the</span>
<span class="line-removed"> 942                 // storestore barrier from the StoreCM should be elided</span>
<span class="line-removed"> 943                 matches = new String[] {</span>
<span class="line-removed"> 944                     &quot;membar_release \\(elided\\)&quot;,</span>
<span class="line-removed"> 945                     useCompressedOops ? &quot;atomic_xchgw?_acq&quot; : &quot;atomic_xchg_acq&quot;,</span>
<span class="line-removed"> 946                     &quot;storestore&quot;,</span>
<span class="line-removed"> 947                     &quot;dmb ishst&quot;,</span>
<span class="line-removed"> 948                     &quot;strb&quot;,</span>
<span class="line-removed"> 949                     &quot;membar_acquire \\(elided\\)&quot;,</span>
<span class="line-removed"> 950                     &quot;ret&quot;</span>
 951                 };
 952                 break;
 953             case &quot;Shenandoah&quot;:
 954             case &quot;ShenandoahTraversal&quot;:
 955                 matches = new String[] {
 956                     &quot;membar_release \\(elided\\)&quot;,
 957                     useCompressedOops ? &quot;atomic_xchgw?_acq&quot; : &quot;atomic_xchg_acq&quot;,
 958                     &quot;membar_acquire \\(elided\\)&quot;,
 959                     &quot;ret&quot;
 960                 };
 961                 break;
 962             }
 963         } else {
 964             switch (testType) {
 965             default:
 966                 // this is the basic sequence of instructions
 967                 matches = new String[] {
 968                     &quot;membar_release&quot;,
 969                     &quot;dmb ish&quot;,
 970                     useCompressedOops ? &quot;atomic_xchgw? &quot; : &quot;atomic_xchg &quot;,
 971                     &quot;membar_acquire&quot;,
 972                     &quot;dmb ish&quot;,
 973                     &quot;ret&quot;
 974                 };
 975                 break;
 976             case &quot;G1&quot;:
 977                 // a card mark volatile barrier should be generated
 978                 // before the card mark strb




 979                 matches = new String[] {
 980                     &quot;membar_release&quot;,
 981                     &quot;dmb ish&quot;,
 982                     useCompressedOops ? &quot;atomic_xchgw? &quot; : &quot;atomic_xchg &quot;,
<span class="line-removed"> 983                     &quot;membar_volatile&quot;,</span>
<span class="line-removed"> 984                     &quot;dmb ish&quot;,</span>
<span class="line-removed"> 985                     &quot;strb&quot;,</span>
 986                     &quot;membar_acquire&quot;,
 987                     &quot;dmb ish&quot;,
<span class="line-modified"> 988                     &quot;ret&quot;</span>



 989                 };
 990                 break;
 991             case &quot;CMSCondMark&quot;:
 992                 // a card mark volatile barrier should be generated
 993                 // before the card mark strb from the StoreCM and the
 994                 // storestore barrier from the StoreCM should be elided
 995                 matches = new String[] {
 996                     &quot;membar_release&quot;,
 997                     &quot;dmb ish&quot;,
 998                     useCompressedOops ? &quot;atomic_xchgw? &quot; : &quot;atomic_xchg &quot;,
 999                     &quot;membar_volatile&quot;,
1000                     &quot;dmb ish&quot;,
1001                     &quot;storestore \\(elided\\)&quot;,
1002                     &quot;strb&quot;,
1003                     &quot;membar_acquire&quot;,
1004                     &quot;dmb ish&quot;,
1005                     &quot;ret&quot;
1006                 };
1007                 break;
1008             case &quot;CMS&quot;:
</pre>
</td>
<td>
<hr />
<pre>
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 
  24 /*
  25  * common code to run and validate tests of code generation for
  26  * volatile ops on AArch64
  27  *
  28  * incoming args are &lt;testclass&gt; &lt;testtype&gt;
  29  *
  30  * where &lt;testclass&gt; in {TestVolatileLoad,
  31  *                       TestVolatileStore,
  32  *                       TestUnsafeVolatileLoad,
  33  *                       TestUnsafeVolatileStore,
  34  *                       TestUnsafeVolatileCAS,
  35  *                       TestUnsafeVolatileWeakCAS,
  36  *                       TestUnsafeVolatileCAE,
  37  *                       TestUnsafeVolatileGAS}
  38  * and &lt;testtype&gt; in {G1,


  39  *                    Serial,
  40  *                    Parallel,
  41  *                    Shenandoah,
  42  *                    ShenandoahTraversal}
  43  */
  44 
  45 
  46 package compiler.c2.aarch64;
  47 
  48 import java.util.List;
  49 import java.util.ListIterator;
  50 import java.util.Iterator;
  51 import java.util.regex.Pattern;
  52 import java.io.*;
  53 
  54 import jdk.test.lib.Asserts;
  55 import jdk.test.lib.compiler.InMemoryJavaCompiler;
  56 import jdk.test.lib.process.OutputAnalyzer;
  57 import jdk.test.lib.process.ProcessTools;
  58 import sun.hotspot.WhiteBox;
</pre>
<hr />
<pre>
  71         String[] procArgs;
  72         int argcount;
  73         // add one or two extra arguments according to test type
  74         // i.e. GC type plus GC conifg
  75         switch(testType) {
  76         case &quot;G1&quot;:
  77             argcount = 9;
  78             procArgs = new String[argcount];
  79             procArgs[argcount - 2] = &quot;-XX:+UseG1GC&quot;;
  80             break;
  81         case &quot;Parallel&quot;:
  82             argcount = 9;
  83             procArgs = new String[argcount];
  84             procArgs[argcount - 2] = &quot;-XX:+UseParallelGC&quot;;
  85             break;
  86         case &quot;Serial&quot;:
  87             argcount = 9;
  88             procArgs = new String[argcount];
  89             procArgs[argcount - 2] = &quot;-XX:+UseSerialGC&quot;;
  90             break;












  91         case &quot;Shenandoah&quot;:
  92             argcount = 10;
  93             procArgs = new String[argcount];
  94             procArgs[argcount - 3] = &quot;-XX:+UnlockExperimentalVMOptions&quot;;
  95             procArgs[argcount - 2] = &quot;-XX:+UseShenandoahGC&quot;;
  96             break;
  97         case &quot;ShenandoahTraversal&quot;:
  98             argcount = 11;
  99             procArgs = new String[argcount];
 100             procArgs[argcount - 4] = &quot;-XX:+UnlockExperimentalVMOptions&quot;;
 101             procArgs[argcount - 3] = &quot;-XX:+UseShenandoahGC&quot;;
<span class="line-modified"> 102             procArgs[argcount - 2] = &quot;-XX:ShenandoahGCMode=traversal&quot;;</span>
 103             break;
 104         default:
 105             throw new RuntimeException(&quot;unexpected test type &quot; + testType);
 106         }
 107 
 108         // fill in arguments common to all cases
 109 
 110         // the first round of test enables transform of barriers to
 111         // use acquiring loads and releasing stores by setting arg
 112         // zero appropriately. this arg is reset in the second run to
 113         // disable the transform.
 114 
 115         procArgs[0] = &quot;-XX:-UseBarriersForVolatile&quot;;
 116         procArgs[1] = &quot;-XX:+UseCompressedOops&quot;;
 117 
 118         procArgs[2] = &quot;-XX:-TieredCompilation&quot;;
 119         procArgs[3] = &quot;-XX:+PrintOptoAssembly&quot;;
 120         procArgs[4] = &quot;-XX:CompileCommand=compileonly,&quot; + fullclassname + &quot;::&quot; + &quot;test*&quot;;
 121         procArgs[5] = &quot;--add-exports&quot;;
 122         procArgs[6] = &quot;java.base/jdk.internal.misc=ALL-UNNAMED&quot;;
</pre>
<hr />
<pre>
 299 
 300         checkCompile(iter, &quot;testInt&quot;, matches, output, true);
 301 
 302         // object stores will be as above except for when the GC
 303         // introduces barriers for card marking
 304 
 305         if (!useBarriersForVolatile) {
 306             switch (testType) {
 307             default:
 308                 // this is the basic sequence of instructions
 309                 matches = new String[] {
 310                     &quot;membar_release \\(elided\\)&quot;,
 311                     useCompressedOops ? &quot;stlrw?&quot; : &quot;stlr&quot;,
 312                     &quot;membar_volatile \\(elided\\)&quot;,
 313                     &quot;ret&quot;
 314                 };
 315                 break;
 316             case &quot;G1&quot;:
 317                 // a card mark volatile barrier should be generated
 318                 // before the card mark strb
<span class="line-added"> 319                 //</span>
<span class="line-added"> 320                 // following the fix for 8225776 the G1 barrier is now</span>
<span class="line-added"> 321                 // scheduled out of line after the membar volatile and</span>
<span class="line-added"> 322                 // and subsequent return</span>
 323                 matches = new String[] {
 324                     &quot;membar_release \\(elided\\)&quot;,
 325                     useCompressedOops ? &quot;stlrw?&quot; : &quot;stlr&quot;,



 326                     &quot;membar_volatile \\(elided\\)&quot;,
<span class="line-modified"> 327                     &quot;ret&quot;,</span>









 328                     &quot;membar_volatile&quot;,
 329                     &quot;dmb ish&quot;,
<span class="line-modified"> 330                     &quot;strb&quot;</span>


















 331                 };
 332                 break;
 333             case &quot;Shenandoah&quot;:
 334             case &quot;ShenandoahTraversal&quot;:
 335                  // Shenandoah generates normal object graphs for
 336                  // volatile stores
 337                 matches = new String[] {
 338                     &quot;membar_release \\(elided\\)&quot;,
 339                     useCompressedOops ? &quot;stlrw?&quot; : &quot;stlr&quot;,
 340                     &quot;membar_volatile \\(elided\\)&quot;,
 341                     &quot;ret&quot;
 342                 };
 343                 break;
 344             }
 345         } else {
 346             switch (testType) {
 347             default:
 348                 // this is the basic sequence of instructions
 349                 matches = new String[] {
 350                     &quot;membar_release&quot;,
 351                     &quot;dmb ish&quot;,
 352                     useCompressedOops ? &quot;strw?&quot; : &quot;str&quot;,
 353                     &quot;membar_volatile&quot;,
 354                     &quot;dmb ish&quot;,
 355                     &quot;ret&quot;
 356                 };
 357                 break;
 358             case &quot;G1&quot;:
 359                 // a card mark volatile barrier should be generated
 360                 // before the card mark strb
<span class="line-added"> 361                 //</span>
<span class="line-added"> 362                 // following the fix for 8225776 the G1 barrier is now</span>
<span class="line-added"> 363                 // scheduled out of line after the membar volatile and</span>
<span class="line-added"> 364                 // and subsequent return</span>
 365                 matches = new String[] {
 366                     &quot;membar_release&quot;,
 367                     &quot;dmb ish&quot;,
 368                     useCompressedOops ? &quot;strw?&quot; : &quot;str&quot;,
 369                     &quot;membar_volatile&quot;,
 370                     &quot;dmb ish&quot;,
<span class="line-modified"> 371                     &quot;ret&quot;,</span>
 372                     &quot;membar_volatile&quot;,
 373                     &quot;dmb ish&quot;,
<span class="line-modified"> 374                     &quot;strb&quot;</span>
 375                 };
 376                 break;
 377             case &quot;CMSCondMark&quot;:
 378                 // a card mark volatile barrier should be generated
 379                 // before the card mark strb from the StoreCM and the
 380                 // storestore barrier from the StoreCM should be elided
 381                 matches = new String[] {
 382                     &quot;membar_release&quot;,
 383                     &quot;dmb ish&quot;,
 384                     useCompressedOops ? &quot;strw?&quot; : &quot;str&quot;,
 385                     &quot;membar_volatile&quot;,
 386                     &quot;dmb ish&quot;,
 387                     &quot;storestore \\(elided\\)&quot;,
 388                     &quot;strb&quot;,
 389                     &quot;membar_volatile&quot;,
 390                     &quot;dmb ish&quot;,
 391                     &quot;ret&quot;
 392                 };
 393                 break;
 394             case &quot;CMS&quot;:
</pre>
<hr />
<pre>
 468         }
 469 
 470         // object stores will be as above except for when the GC
 471         // introduces barriers for card marking
 472 
 473         if (!useBarriersForVolatile) {
 474             switch (testType) {
 475             default:
 476                 // this is the basic sequence of instructions
 477                 matches = new String[] {
 478                     &quot;membar_release \\(elided\\)&quot;,
 479                     useCompressedOops ? &quot;cmpxchgw?_acq&quot; : &quot;cmpxchg_acq&quot;,
 480                     &quot;strb&quot;,
 481                     &quot;membar_acquire \\(elided\\)&quot;,
 482                     &quot;ret&quot;
 483                 };
 484                 break;
 485             case &quot;G1&quot;:
 486                 // a card mark volatile barrier should be generated
 487                 // before the card mark strb
<span class="line-added"> 488                 //</span>
<span class="line-added"> 489                 // following the fix for 8225776 the G1 barrier is now</span>
<span class="line-added"> 490                 // scheduled out of line after the membar acquire and</span>
<span class="line-added"> 491                 // and subsequent return</span>
 492                 matches = new String[] {
 493                     &quot;membar_release \\(elided\\)&quot;,
 494                     useCompressedOops ? &quot;cmpxchgw?_acq&quot; : &quot;cmpxchg_acq&quot;,



 495                     &quot;membar_acquire \\(elided\\)&quot;,
<span class="line-modified"> 496                     &quot;ret&quot;,</span>









 497                     &quot;membar_volatile&quot;,
 498                     &quot;dmb ish&quot;,
<span class="line-modified"> 499                     &quot;strb&quot;</span>

















 500                 };
 501                 break;
 502             case &quot;Shenandoah&quot;:
 503             case &quot;ShenandoahTraversal&quot;:
 504                 // For volatile CAS, Shenanodoah generates normal
 505                 // graphs with a shenandoah-specific cmpxchg
 506                 matches = new String[] {
 507                     &quot;membar_release \\(elided\\)&quot;,
 508                     useCompressedOops ? &quot;cmpxchgw?_acq_shenandoah&quot; : &quot;cmpxchg_acq_shenandoah&quot;,
 509                     &quot;membar_acquire \\(elided\\)&quot;,
 510                     &quot;ret&quot;
 511                 };
 512                 break;
 513             }
 514         } else {
 515             switch (testType) {
 516             default:
 517                 // this is the basic sequence of instructions
 518                 matches = new String[] {
 519                     &quot;membar_release&quot;,
 520                     &quot;dmb ish&quot;,
 521                     useCompressedOops ? &quot;cmpxchgw? &quot; : &quot;cmpxchg &quot;,
 522                     &quot;membar_acquire&quot;,
 523                     &quot;dmb ish&quot;,
 524                     &quot;ret&quot;
 525                 };
 526                 break;
 527             case &quot;G1&quot;:
 528                 // a card mark volatile barrier should be generated
 529                 // before the card mark strb
<span class="line-added"> 530                 //</span>
<span class="line-added"> 531                 // following the fix for 8225776 the G1 barrier is now</span>
<span class="line-added"> 532                 // scheduled out of line after the membar acquire and</span>
<span class="line-added"> 533                 // and subsequent return</span>
 534                 matches = new String[] {
 535                     &quot;membar_release&quot;,
 536                     &quot;dmb ish&quot;,
 537                     useCompressedOops ? &quot;cmpxchgw? &quot; : &quot;cmpxchg &quot;,



 538                     &quot;membar_acquire&quot;,
 539                     &quot;dmb ish&quot;,
<span class="line-modified"> 540                     &quot;ret&quot;,</span>
<span class="line-added"> 541                     &quot;membar_volatile&quot;,</span>
<span class="line-added"> 542                     &quot;dmb ish&quot;,</span>
<span class="line-added"> 543                     &quot;strb&quot;</span>
 544                 };
 545                 break;
 546             case &quot;CMSCondMark&quot;:
 547                 // a card mark volatile barrier should be generated
 548                 // before the card mark strb from the StoreCM and the
 549                 // storestore barrier from the StoreCM should be elided
 550                 matches = new String[] {
 551                     &quot;membar_release&quot;,
 552                     &quot;dmb ish&quot;,
 553                     useCompressedOops ? &quot;cmpxchgw? &quot; : &quot;cmpxchg &quot;,
 554                     &quot;membar_volatile&quot;,
 555                     &quot;dmb ish&quot;,
 556                     &quot;storestore \\(elided\\)&quot;,
 557                     &quot;strb&quot;,
 558                     &quot;membar_acquire&quot;,
 559                     &quot;dmb ish&quot;,
 560                     &quot;ret&quot;
 561                 };
 562                 break;
 563             case &quot;CMS&quot;:
</pre>
<hr />
<pre>
 652                 // the cmpxchg so try both sequences.
 653                 int idx = iter.nextIndex();
 654                 if (!checkCompile(iter, &quot;testObj&quot;, matches, output, false)) {
 655                     iter = output.asLines().listIterator(idx);
 656 
 657                     matches = new String[] {
 658                         &quot;membar_release \\(elided\\)&quot;,
 659                         useCompressedOops ? &quot;cmpxchgw?_acq&quot; : &quot;cmpxchg_acq&quot;,
 660                         &quot;strb&quot;,
 661                         &quot;membar_acquire \\(elided\\)&quot;,
 662                         &quot;ret&quot;
 663                     };
 664 
 665                     checkCompile(iter, &quot;testObj&quot;, matches, output, true);
 666                 }
 667                 return;
 668 
 669             case &quot;G1&quot;:
 670                 // a card mark volatile barrier should be generated
 671                 // before the card mark strb
<span class="line-added"> 672                 //</span>
<span class="line-added"> 673                 // following the fix for 8225776 the G1 barrier is now</span>
<span class="line-added"> 674                 // scheduled out of line after the membar acquire and</span>
<span class="line-added"> 675                 // and subsequent return</span>
 676                 matches = new String[] {
 677                     &quot;membar_release \\(elided\\)&quot;,
 678                     useCompressedOops ? &quot;cmpxchgw?_acq&quot; : &quot;cmpxchg_acq&quot;,



 679                     &quot;membar_acquire \\(elided\\)&quot;,
<span class="line-modified"> 680                     &quot;ret&quot;,</span>









 681                     &quot;membar_volatile&quot;,
 682                     &quot;dmb ish&quot;,
<span class="line-modified"> 683                     &quot;strb&quot;</span>

















 684                 };
 685                 break;
 686             case &quot;Shenandoah&quot;:
 687             case &quot;ShenandoahTraversal&quot;:
 688                 // For volatile CAS, Shenanodoah generates normal
 689                 // graphs with a shenandoah-specific cmpxchg
 690                 matches = new String[] {
 691                     &quot;membar_release \\(elided\\)&quot;,
 692                     useCompressedOops ? &quot;cmpxchgw?_acq_shenandoah&quot; : &quot;cmpxchg_acq_shenandoah&quot;,
 693                     &quot;membar_acquire \\(elided\\)&quot;,
 694                     &quot;ret&quot;
 695                 };
 696                 break;
 697             }
 698         } else {
 699             switch (testType) {
 700             default:
 701                 // this is the basic sequence of instructions
 702                 matches = new String[] {
 703                     &quot;membar_release&quot;,
 704                     &quot;dmb ish&quot;,
 705                     useCompressedOops ? &quot;cmpxchgw? &quot; : &quot;cmpxchg &quot;,
 706                     &quot;membar_acquire&quot;,
 707                     &quot;dmb ish&quot;,
 708                     &quot;ret&quot;
 709                 };
 710                 break;
 711             case &quot;G1&quot;:
 712                 // a card mark volatile barrier should be generated
 713                 // before the card mark strb
<span class="line-added"> 714                 //</span>
<span class="line-added"> 715                 // following the fix for 8225776 the G1 barrier is now</span>
<span class="line-added"> 716                 // scheduled out of line after the membar acquire and</span>
<span class="line-added"> 717                 // and subsequent return</span>
 718                 matches = new String[] {
 719                     &quot;membar_release&quot;,
 720                     &quot;dmb ish&quot;,
 721                     useCompressedOops ? &quot;cmpxchgw? &quot; : &quot;cmpxchg &quot;,



 722                     &quot;membar_acquire&quot;,
 723                     &quot;dmb ish&quot;,
<span class="line-modified"> 724                     &quot;ret&quot;,</span>
<span class="line-added"> 725                     &quot;membar_volatile&quot;,</span>
<span class="line-added"> 726                     &quot;dmb ish&quot;,</span>
<span class="line-added"> 727                     &quot;strb&quot;</span>
 728                 };
 729                 break;
 730             case &quot;CMSCondMark&quot;:
 731                 // a card mark volatile barrier should be generated
 732                 // before the card mark strb from the StoreCM and the
 733                 // storestore barrier from the StoreCM should be elided
 734                 matches = new String[] {
 735                     &quot;membar_release&quot;,
 736                     &quot;dmb ish&quot;,
 737                     useCompressedOops ? &quot;cmpxchgw? &quot; : &quot;cmpxchg &quot;,
 738                     &quot;membar_volatile&quot;,
 739                     &quot;dmb ish&quot;,
 740                     &quot;storestore \\(elided\\)&quot;,
 741                     &quot;strb&quot;,
 742                     &quot;membar_acquire&quot;,
 743                     &quot;dmb ish&quot;,
 744                     &quot;ret&quot;
 745                 };
 746                 break;
 747             case &quot;CMS&quot;:
</pre>
<hr />
<pre>
 816         }
 817 
 818         // object stores will be as above except for when the GC
 819         // introduces barriers for card marking
 820 
 821         if (!useBarriersForVolatile) {
 822             switch (testType) {
 823             default:
 824                 // this is the basic sequence of instructions
 825                 matches = new String[] {
 826                     &quot;membar_release \\(elided\\)&quot;,
 827                     useCompressedOops ? &quot;atomic_xchgw?_acq&quot; : &quot;atomic_xchg_acq&quot;,
 828                     &quot;strb&quot;,
 829                     &quot;membar_acquire \\(elided\\)&quot;,
 830                     &quot;ret&quot;
 831                 };
 832                 break;
 833             case &quot;G1&quot;:
 834                 // a card mark volatile barrier should be generated
 835                 // before the card mark strb
<span class="line-added"> 836                 //</span>
<span class="line-added"> 837                 // following the fix for 8225776 the G1 barrier is now</span>
<span class="line-added"> 838                 // scheduled out of line after the membar acquire and</span>
<span class="line-added"> 839                 // and subsequent return</span>
 840                 matches = new String[] {
 841                     &quot;membar_release \\(elided\\)&quot;,
 842                     useCompressedOops ? &quot;atomic_xchgw?_acq&quot; : &quot;atomic_xchg_acq&quot;,



 843                     &quot;membar_acquire \\(elided\\)&quot;,
<span class="line-modified"> 844                     &quot;ret&quot;,</span>









 845                     &quot;membar_volatile&quot;,
 846                     &quot;dmb ish&quot;,
<span class="line-modified"> 847                     &quot;strb&quot;</span>

















 848                 };
 849                 break;
 850             case &quot;Shenandoah&quot;:
 851             case &quot;ShenandoahTraversal&quot;:
 852                 matches = new String[] {
 853                     &quot;membar_release \\(elided\\)&quot;,
 854                     useCompressedOops ? &quot;atomic_xchgw?_acq&quot; : &quot;atomic_xchg_acq&quot;,
 855                     &quot;membar_acquire \\(elided\\)&quot;,
 856                     &quot;ret&quot;
 857                 };
 858                 break;
 859             }
 860         } else {
 861             switch (testType) {
 862             default:
 863                 // this is the basic sequence of instructions
 864                 matches = new String[] {
 865                     &quot;membar_release&quot;,
 866                     &quot;dmb ish&quot;,
 867                     useCompressedOops ? &quot;atomic_xchgw? &quot; : &quot;atomic_xchg &quot;,
 868                     &quot;membar_acquire&quot;,
 869                     &quot;dmb ish&quot;,
 870                     &quot;ret&quot;
 871                 };
 872                 break;
 873             case &quot;G1&quot;:
 874                 // a card mark volatile barrier should be generated
 875                 // before the card mark strb
<span class="line-added"> 876                 //</span>
<span class="line-added"> 877                 // following the fix for 8225776 the G1 barrier is now</span>
<span class="line-added"> 878                 // scheduled out of line after the membar acquire and</span>
<span class="line-added"> 879                 // and subsequent return</span>
 880                 matches = new String[] {
 881                     &quot;membar_release&quot;,
 882                     &quot;dmb ish&quot;,
 883                     useCompressedOops ? &quot;atomic_xchgw? &quot; : &quot;atomic_xchg &quot;,



 884                     &quot;membar_acquire&quot;,
 885                     &quot;dmb ish&quot;,
<span class="line-modified"> 886                     &quot;ret&quot;,</span>
<span class="line-added"> 887                     &quot;membar_volatile&quot;,</span>
<span class="line-added"> 888                     &quot;dmb ish&quot;,</span>
<span class="line-added"> 889                     &quot;strb&quot;</span>
 890                 };
 891                 break;
 892             case &quot;CMSCondMark&quot;:
 893                 // a card mark volatile barrier should be generated
 894                 // before the card mark strb from the StoreCM and the
 895                 // storestore barrier from the StoreCM should be elided
 896                 matches = new String[] {
 897                     &quot;membar_release&quot;,
 898                     &quot;dmb ish&quot;,
 899                     useCompressedOops ? &quot;atomic_xchgw? &quot; : &quot;atomic_xchg &quot;,
 900                     &quot;membar_volatile&quot;,
 901                     &quot;dmb ish&quot;,
 902                     &quot;storestore \\(elided\\)&quot;,
 903                     &quot;strb&quot;,
 904                     &quot;membar_acquire&quot;,
 905                     &quot;dmb ish&quot;,
 906                     &quot;ret&quot;
 907                 };
 908                 break;
 909             case &quot;CMS&quot;:
</pre>
</td>
</tr>
</table>
<center><a href="../Test8004741.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../cr6340864/TestDoubleVect.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>