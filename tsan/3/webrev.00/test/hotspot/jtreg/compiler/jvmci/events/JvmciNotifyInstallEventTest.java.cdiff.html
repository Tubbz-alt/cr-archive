<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff test/hotspot/jtreg/compiler/jvmci/events/JvmciNotifyInstallEventTest.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="JvmciNotifyBootstrapFinishedEventTest.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="JvmciShutdownEventListener.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/jtreg/compiler/jvmci/events/JvmciNotifyInstallEventTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2015, 2016, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2015, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 22,11 ***</span>
   */
  
  /*
   * @test
   * @bug 8136421
<span class="line-modified">!  * @requires vm.jvmci</span>
   * @library / /test/lib
   * @library ../common/patches
   * @modules java.base/jdk.internal.misc
   * @modules java.base/jdk.internal.org.objectweb.asm
   *          java.base/jdk.internal.org.objectweb.asm.tree
<span class="line-new-header">--- 22,11 ---</span>
   */
  
  /*
   * @test
   * @bug 8136421
<span class="line-modified">!  * @requires vm.jvmci &amp; !vm.graal.enabled &amp; vm.compMode == &quot;Xmixed&quot;</span>
   * @library / /test/lib
   * @library ../common/patches
   * @modules java.base/jdk.internal.misc
   * @modules java.base/jdk.internal.org.objectweb.asm
   *          java.base/jdk.internal.org.objectweb.asm.tree
</pre>
<hr />
<pre>
<span class="line-old-header">*** 45,20 ***</span>
   *      compiler.jvmci.common.JVMCIHelpers$EmptyHotspotCompiler
   *      compiler.jvmci.common.JVMCIHelpers$EmptyCompilerFactory
   *      compiler.jvmci.common.JVMCIHelpers$EmptyCompilationRequestResult
   *      compiler.jvmci.common.JVMCIHelpers$EmptyVMEventListener
   * @run main/othervm -XX:+UnlockExperimentalVMOptions
<span class="line-modified">!  *     -Xbootclasspath/a:. -Xmixed</span>
<span class="line-modified">!  *     -XX:+UseJVMCICompiler -XX:-BootstrapJVMCI</span>
   *     compiler.jvmci.events.JvmciNotifyInstallEventTest
   * @run main/othervm -XX:+UnlockExperimentalVMOptions
<span class="line-modified">!  *     -Djvmci.Compiler=EmptyCompiler -Xbootclasspath/a:. -Xmixed</span>
<span class="line-removed">-  *     -XX:+UseJVMCICompiler -XX:-BootstrapJVMCI</span>
<span class="line-removed">-  *     compiler.jvmci.events.JvmciNotifyInstallEventTest</span>
<span class="line-removed">-  * @run main/othervm -XX:+UnlockExperimentalVMOptions</span>
<span class="line-removed">-  *     -Djvmci.Compiler=EmptyCompiler -Xbootclasspath/a:. -Xmixed</span>
   *     -XX:+UseJVMCICompiler -XX:-BootstrapJVMCI -XX:JVMCINMethodSizeLimit=0
   *     compiler.jvmci.events.JvmciNotifyInstallEventTest
   */
  
  package compiler.jvmci.events;
  
<span class="line-new-header">--- 45,17 ---</span>
   *      compiler.jvmci.common.JVMCIHelpers$EmptyHotspotCompiler
   *      compiler.jvmci.common.JVMCIHelpers$EmptyCompilerFactory
   *      compiler.jvmci.common.JVMCIHelpers$EmptyCompilationRequestResult
   *      compiler.jvmci.common.JVMCIHelpers$EmptyVMEventListener
   * @run main/othervm -XX:+UnlockExperimentalVMOptions
<span class="line-modified">!  *     -Djvmci.Compiler=EmptyCompiler -Xbootclasspath/a:.</span>
<span class="line-modified">!  *     -XX:+UseJVMCICompiler -XX:-BootstrapJVMCI -XX:-UseJVMCINativeLibrary</span>
   *     compiler.jvmci.events.JvmciNotifyInstallEventTest
   * @run main/othervm -XX:+UnlockExperimentalVMOptions
<span class="line-modified">!  *     -Djvmci.Compiler=EmptyCompiler -Xbootclasspath/a:.</span>
   *     -XX:+UseJVMCICompiler -XX:-BootstrapJVMCI -XX:JVMCINMethodSizeLimit=0
<span class="line-added">+  *     -XX:-UseJVMCINativeLibrary</span>
   *     compiler.jvmci.events.JvmciNotifyInstallEventTest
   */
  
  package compiler.jvmci.events;
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 72,10 ***</span>
<span class="line-new-header">--- 69,11 ---</span>
  import jdk.vm.ci.code.site.DataPatch;
  import jdk.vm.ci.code.site.Site;
  import jdk.vm.ci.hotspot.HotSpotCodeCacheProvider;
  import jdk.vm.ci.hotspot.HotSpotCompiledCode;
  import jdk.vm.ci.hotspot.HotSpotCompiledCode.Comment;
<span class="line-added">+ import jdk.vm.ci.hotspot.HotSpotCompiledNmethod;</span>
  import jdk.vm.ci.hotspot.HotSpotJVMCIRuntime;
  import jdk.vm.ci.hotspot.HotSpotResolvedJavaMethod;
  import jdk.vm.ci.hotspot.HotSpotVMEventListener;
  import jdk.vm.ci.meta.Assumptions.Assumption;
  import jdk.vm.ci.meta.ResolvedJavaMethod;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 116,14 ***</span>
          } catch (NoSuchMethodException e) {
              throw new Error(&quot;TEST BUG: Can&#39;t find &quot; + METHOD_NAME, e);
          }
          HotSpotResolvedJavaMethod method = CTVMUtilities
                  .getResolvedMethod(SimpleClass.class, testMethod);
<span class="line-modified">!         HotSpotCompiledCode compiledCode = new HotSpotCompiledCode(METHOD_NAME,</span>
                  new byte[0], 0, new Site[0], new Assumption[0],
                  new ResolvedJavaMethod[]{method}, new Comment[0], new byte[0],
<span class="line-modified">!                 16, new DataPatch[0], false, 0, null);</span>
          codeCache.installCode(method, compiledCode, /* installedCode = */ null,
                  /* speculationLog = */ null, /* isDefault = */ false);
          Asserts.assertEQ(gotInstallNotification, 1,
                  &quot;Got unexpected event count after 1st install attempt&quot;);
          // since &quot;empty&quot; compilation result is ok, a second attempt should be ok
<span class="line-new-header">--- 114,15 ---</span>
          } catch (NoSuchMethodException e) {
              throw new Error(&quot;TEST BUG: Can&#39;t find &quot; + METHOD_NAME, e);
          }
          HotSpotResolvedJavaMethod method = CTVMUtilities
                  .getResolvedMethod(SimpleClass.class, testMethod);
<span class="line-modified">!         HotSpotCompiledCode compiledCode = new HotSpotCompiledNmethod(METHOD_NAME,</span>
                  new byte[0], 0, new Site[0], new Assumption[0],
                  new ResolvedJavaMethod[]{method}, new Comment[0], new byte[0],
<span class="line-modified">!                 16, new DataPatch[0], false, 0, null,</span>
<span class="line-added">+                 method, 0, 1, 0L, false);</span>
          codeCache.installCode(method, compiledCode, /* installedCode = */ null,
                  /* speculationLog = */ null, /* isDefault = */ false);
          Asserts.assertEQ(gotInstallNotification, 1,
                  &quot;Got unexpected event count after 1st install attempt&quot;);
          // since &quot;empty&quot; compilation result is ok, a second attempt should be ok
</pre>
<center><a href="JvmciNotifyBootstrapFinishedEventTest.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="JvmciShutdownEventListener.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>