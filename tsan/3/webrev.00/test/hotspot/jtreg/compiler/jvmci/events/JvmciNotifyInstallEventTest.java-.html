<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old test/hotspot/jtreg/compiler/jvmci/events/JvmciNotifyInstallEventTest.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2015, 2016, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @bug 8136421
 27  * @requires vm.jvmci
 28  * @library / /test/lib
 29  * @library ../common/patches
 30  * @modules java.base/jdk.internal.misc
 31  * @modules java.base/jdk.internal.org.objectweb.asm
 32  *          java.base/jdk.internal.org.objectweb.asm.tree
 33  *          jdk.internal.vm.ci/jdk.vm.ci.hotspot
 34  *          jdk.internal.vm.ci/jdk.vm.ci.code
 35  *          jdk.internal.vm.ci/jdk.vm.ci.code.site
 36  *          jdk.internal.vm.ci/jdk.vm.ci.meta
 37  *          jdk.internal.vm.ci/jdk.vm.ci.runtime
 38  *          jdk.internal.vm.ci/jdk.vm.ci.services
 39  *
 40  * @build jdk.internal.vm.ci/jdk.vm.ci.hotspot.CompilerToVMHelper
 41  * @build compiler.jvmci.common.JVMCIHelpers
 42  * @run driver jdk.test.lib.FileInstaller ./JvmciNotifyInstallEventTest.config
 43  *     ./META-INF/services/jdk.vm.ci.services.JVMCIServiceLocator
 44  * @run driver ClassFileInstaller
 45  *      compiler.jvmci.common.JVMCIHelpers$EmptyHotspotCompiler
 46  *      compiler.jvmci.common.JVMCIHelpers$EmptyCompilerFactory
 47  *      compiler.jvmci.common.JVMCIHelpers$EmptyCompilationRequestResult
 48  *      compiler.jvmci.common.JVMCIHelpers$EmptyVMEventListener
 49  * @run main/othervm -XX:+UnlockExperimentalVMOptions
 50  *     -Xbootclasspath/a:. -Xmixed
 51  *     -XX:+UseJVMCICompiler -XX:-BootstrapJVMCI
 52  *     compiler.jvmci.events.JvmciNotifyInstallEventTest
 53  * @run main/othervm -XX:+UnlockExperimentalVMOptions
 54  *     -Djvmci.Compiler=EmptyCompiler -Xbootclasspath/a:. -Xmixed
 55  *     -XX:+UseJVMCICompiler -XX:-BootstrapJVMCI
 56  *     compiler.jvmci.events.JvmciNotifyInstallEventTest
 57  * @run main/othervm -XX:+UnlockExperimentalVMOptions
 58  *     -Djvmci.Compiler=EmptyCompiler -Xbootclasspath/a:. -Xmixed
 59  *     -XX:+UseJVMCICompiler -XX:-BootstrapJVMCI -XX:JVMCINMethodSizeLimit=0
 60  *     compiler.jvmci.events.JvmciNotifyInstallEventTest
 61  */
 62 
 63 package compiler.jvmci.events;
 64 
 65 import compiler.jvmci.common.CTVMUtilities;
 66 import compiler.jvmci.common.testcases.SimpleClass;
 67 import jdk.test.lib.Asserts;
 68 import jdk.test.lib.Utils;
 69 import jdk.vm.ci.services.JVMCIServiceLocator;
 70 import jdk.vm.ci.code.CompiledCode;
 71 import jdk.vm.ci.code.InstalledCode;
 72 import jdk.vm.ci.code.site.DataPatch;
 73 import jdk.vm.ci.code.site.Site;
 74 import jdk.vm.ci.hotspot.HotSpotCodeCacheProvider;
 75 import jdk.vm.ci.hotspot.HotSpotCompiledCode;
 76 import jdk.vm.ci.hotspot.HotSpotCompiledCode.Comment;
 77 import jdk.vm.ci.hotspot.HotSpotJVMCIRuntime;
 78 import jdk.vm.ci.hotspot.HotSpotResolvedJavaMethod;
 79 import jdk.vm.ci.hotspot.HotSpotVMEventListener;
 80 import jdk.vm.ci.meta.Assumptions.Assumption;
 81 import jdk.vm.ci.meta.ResolvedJavaMethod;
 82 
 83 import java.lang.reflect.Method;
 84 
 85 public class JvmciNotifyInstallEventTest extends JVMCIServiceLocator implements HotSpotVMEventListener {
 86     private static final String METHOD_NAME = &quot;testMethod&quot;;
 87     private static volatile int gotInstallNotification = 0;
 88 
 89     public static void main(String args[]) {
 90         new JvmciNotifyInstallEventTest().runTest();
 91     }
 92 
 93     @Override
 94     public &lt;S&gt; S getProvider(Class&lt;S&gt; service) {
 95         if (service == HotSpotVMEventListener.class) {
 96             return service.cast(this);
 97         }
 98         return null;
 99     }
100 
101     private void runTest() {
102         if (gotInstallNotification != 0) {
103             throw new Error(&quot;Got install notification before test actions&quot;);
104         }
105         HotSpotCodeCacheProvider codeCache;
106         try {
107             codeCache = (HotSpotCodeCacheProvider) HotSpotJVMCIRuntime.runtime()
108                     .getHostJVMCIBackend().getCodeCache();
109         } catch (InternalError ie) {
110             // passed
111             return;
112         }
113         Method testMethod;
114         try {
115             testMethod = SimpleClass.class.getDeclaredMethod(METHOD_NAME);
116         } catch (NoSuchMethodException e) {
117             throw new Error(&quot;TEST BUG: Can&#39;t find &quot; + METHOD_NAME, e);
118         }
119         HotSpotResolvedJavaMethod method = CTVMUtilities
120                 .getResolvedMethod(SimpleClass.class, testMethod);
121         HotSpotCompiledCode compiledCode = new HotSpotCompiledCode(METHOD_NAME,
122                 new byte[0], 0, new Site[0], new Assumption[0],
123                 new ResolvedJavaMethod[]{method}, new Comment[0], new byte[0],
124                 16, new DataPatch[0], false, 0, null);
125         codeCache.installCode(method, compiledCode, /* installedCode = */ null,
126                 /* speculationLog = */ null, /* isDefault = */ false);
127         Asserts.assertEQ(gotInstallNotification, 1,
128                 &quot;Got unexpected event count after 1st install attempt&quot;);
129         // since &quot;empty&quot; compilation result is ok, a second attempt should be ok
130         codeCache.installCode(method, compiledCode, /* installedCode = */ null,
131                 /* speculationLog = */ null, /* isDefault = */ false);
132         Asserts.assertEQ(gotInstallNotification, 2,
133                 &quot;Got unexpected event count after 2nd install attempt&quot;);
134         // and an incorrect cases
135         Utils.runAndCheckException(() -&gt; {
136             codeCache.installCode(method, null, null, null, true);
137         }, NullPointerException.class);
138         Asserts.assertEQ(gotInstallNotification, 2,
139                 &quot;Got unexpected event count after 3rd install attempt&quot;);
140         Utils.runAndCheckException(() -&gt; {
141             codeCache.installCode(null, null, null, null, true);
142         }, NullPointerException.class);
143         Asserts.assertEQ(gotInstallNotification, 2,
144                 &quot;Got unexpected event count after 4th install attempt&quot;);
145     }
146 
147     @Override
148     public void notifyInstall(HotSpotCodeCacheProvider hotSpotCodeCacheProvider,
149             InstalledCode installedCode, CompiledCode compiledCode) {
150         gotInstallNotification++;
151     }
152 }
    </pre>
  </body>
</html>