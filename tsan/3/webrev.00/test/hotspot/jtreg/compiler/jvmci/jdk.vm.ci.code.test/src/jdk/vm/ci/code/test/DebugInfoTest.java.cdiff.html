<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff test/hotspot/jtreg/compiler/jvmci/jdk.vm.ci.code.test/src/jdk/vm/ci/code/test/DebugInfoTest.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="DataPatchTest.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../../index.html" target="_top">index</a> <a href="InterpreterFrameSizeTest.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/jtreg/compiler/jvmci/jdk.vm.ci.code.test/src/jdk/vm/ci/code/test/DebugInfoTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2015, 2016, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2015, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 60,36 ***</span>
          JavaValue[] values = new JavaValue[slotKinds.length];
          test(asm -&gt; {
              /*
               * Ensure that any objects mentioned in the VirtualObjects are also in the OopMap.
               */
<span class="line-modified">!             List&lt;Location&gt; newLocations = new ArrayList&lt;Location&gt;(Arrays.asList(objects));</span>
<span class="line-modified">!             List&lt;Location&gt; newDerived = new ArrayList&lt;Location&gt;(Arrays.asList(derivedBase));</span>
              int[] newSizeInBytes = sizeInBytes;
              VirtualObject[] vobjs = compiler.compile(asm, values);
              if (vobjs != null) {
                  for (VirtualObject obj : vobjs) {
                      JavaValue[] objValues = obj.getValues();
                      for (int i = 0; i &lt; objValues.length; i++) {
<span class="line-modified">!                             if (obj.getSlotKind(i) == JavaKind.Object) {</span>
<span class="line-modified">!                                     Location oopLocation = null;</span>
<span class="line-modified">!                                     int bytes = -1;</span>
<span class="line-modified">!                                     if (objValues[i] instanceof RegisterValue) {</span>
<span class="line-modified">!                                             RegisterValue reg = (RegisterValue) objValues[i];</span>
<span class="line-modified">!                                             oopLocation = Location.register(reg.getRegister());</span>
<span class="line-modified">!                                             bytes = reg.getValueKind().getPlatformKind().getSizeInBytes();</span>
<span class="line-modified">!                                     } else if (objValues[i] instanceof StackSlot) {</span>
<span class="line-modified">!                                             StackSlot slot = (StackSlot) objValues[i];</span>
<span class="line-modified">!                                             oopLocation = Location.stack(asm.getOffset(slot));</span>
<span class="line-modified">!                                             bytes = slot.getValueKind().getPlatformKind().getSizeInBytes();</span>
<span class="line-modified">!                                     }</span>
<span class="line-modified">!                                     if (oopLocation != null &amp;&amp; !newLocations.contains(oopLocation)) {</span>
<span class="line-modified">!                                             newLocations.add(oopLocation);</span>
<span class="line-modified">!                                             newDerived.add(null);</span>
<span class="line-modified">!                                             newSizeInBytes = Arrays.copyOf(newSizeInBytes, newSizeInBytes.length + 1);</span>
<span class="line-modified">!                                         newSizeInBytes[newSizeInBytes.length - 1] = bytes;</span>
<span class="line-modified">!                                 }</span>
                          }
                      }
                  }
              }
  
<span class="line-new-header">--- 60,36 ---</span>
          JavaValue[] values = new JavaValue[slotKinds.length];
          test(asm -&gt; {
              /*
               * Ensure that any objects mentioned in the VirtualObjects are also in the OopMap.
               */
<span class="line-modified">!             List&lt;Location&gt; newLocations = new ArrayList&lt;&gt;(Arrays.asList(objects));</span>
<span class="line-modified">!             List&lt;Location&gt; newDerived = new ArrayList&lt;&gt;(Arrays.asList(derivedBase));</span>
              int[] newSizeInBytes = sizeInBytes;
              VirtualObject[] vobjs = compiler.compile(asm, values);
              if (vobjs != null) {
                  for (VirtualObject obj : vobjs) {
                      JavaValue[] objValues = obj.getValues();
                      for (int i = 0; i &lt; objValues.length; i++) {
<span class="line-modified">!                         if (obj.getSlotKind(i) == JavaKind.Object) {</span>
<span class="line-modified">!                             Location oopLocation = null;</span>
<span class="line-modified">!                             int bytes = -1;</span>
<span class="line-modified">!                             if (objValues[i] instanceof RegisterValue) {</span>
<span class="line-modified">!                                 RegisterValue reg = (RegisterValue) objValues[i];</span>
<span class="line-modified">!                                 oopLocation = Location.register(reg.getRegister());</span>
<span class="line-modified">!                                 bytes = reg.getValueKind().getPlatformKind().getSizeInBytes();</span>
<span class="line-modified">!                             } else if (objValues[i] instanceof StackSlot) {</span>
<span class="line-modified">!                                 StackSlot slot = (StackSlot) objValues[i];</span>
<span class="line-modified">!                                 oopLocation = Location.stack(asm.getOffset(slot));</span>
<span class="line-modified">!                                 bytes = slot.getValueKind().getPlatformKind().getSizeInBytes();</span>
<span class="line-modified">!                             }</span>
<span class="line-modified">!                             if (oopLocation != null &amp;&amp; !newLocations.contains(oopLocation)) {</span>
<span class="line-modified">!                                 newLocations.add(oopLocation);</span>
<span class="line-modified">!                                 newDerived.add(null);</span>
<span class="line-modified">!                                 newSizeInBytes = Arrays.copyOf(newSizeInBytes, newSizeInBytes.length + 1);</span>
<span class="line-modified">!                                 newSizeInBytes[newSizeInBytes.length - 1] = bytes;</span>
<span class="line-modified">!                             }</span>
                          }
                      }
                  }
              }
  
</pre>
<center><a href="DataPatchTest.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../../index.html" target="_top">index</a> <a href="InterpreterFrameSizeTest.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>