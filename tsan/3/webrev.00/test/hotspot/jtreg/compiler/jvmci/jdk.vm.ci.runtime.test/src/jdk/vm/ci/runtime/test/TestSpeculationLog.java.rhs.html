<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/hotspot/jtreg/compiler/jvmci/jdk.vm.ci.runtime.test/src/jdk/vm/ci/runtime/test/TestSpeculationLog.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2018, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
<a name="2" id="anc2"></a><span class="line-modified">  7  * published by the Free Software Foundation.</span>


  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 package jdk.vm.ci.runtime.test;
 24 
<a name="3" id="anc3"></a><span class="line-added"> 25 import java.util.ArrayList;</span>
<span class="line-added"> 26 import java.util.Arrays;</span>
<span class="line-added"> 27 import java.util.Collection;</span>
<span class="line-added"> 28 import java.util.function.Supplier;</span>
<span class="line-added"> 29 </span>
 30 import org.junit.Assert;
 31 import org.junit.Test;
 32 
<a name="4" id="anc4"></a><span class="line-added"> 33 import jdk.vm.ci.code.CodeCacheProvider;</span>
 34 import jdk.vm.ci.meta.JavaConstant;
<a name="5" id="anc5"></a><span class="line-added"> 35 import jdk.vm.ci.meta.ResolvedJavaMethod;</span>
<span class="line-added"> 36 import jdk.vm.ci.meta.ResolvedJavaType;</span>
 37 import jdk.vm.ci.meta.SpeculationLog;
<a name="6" id="anc6"></a><span class="line-added"> 38 import jdk.vm.ci.meta.SpeculationLog.SpeculationReasonEncoding;</span>
<span class="line-added"> 39 import jdk.vm.ci.runtime.JVMCI;</span>
 40 
 41 public class TestSpeculationLog extends MethodUniverse {
 42 
<a name="7" id="anc7"></a><span class="line-modified"> 43     static final class Dummy implements SpeculationLog.SpeculationReason {</span>
<span class="line-added"> 44 </span>
<span class="line-added"> 45         final int[] ints = {Integer.MIN_VALUE, -42, -1, 0, 1, 42, Integer.MAX_VALUE};</span>
<span class="line-added"> 46         final long[] longs = {Long.MIN_VALUE, -42, -1, 0, 1, 42, Long.MAX_VALUE};</span>
<span class="line-added"> 47         final String[] strings = {null, &quot;non-empty string&quot;, &quot;&quot;};</span>
<span class="line-added"> 48         final Collection&lt;ResolvedJavaMethod&gt; methods = new ArrayList&lt;&gt;(MethodUniverse.methods.values()).subList(0, 10);</span>
<span class="line-added"> 49         final Collection&lt;ResolvedJavaMethod&gt; constructors = new ArrayList&lt;&gt;(MethodUniverse.constructors.values()).subList(0, 10);</span>
<span class="line-added"> 50         final Collection&lt;ResolvedJavaType&gt; types = new ArrayList&lt;&gt;(TypeUniverse.javaTypes).subList(0, 10);</span>
<span class="line-added"> 51 </span>
<span class="line-added"> 52         private final boolean useCache;</span>
<span class="line-added"> 53         private SpeculationReasonEncoding cachedEncoding;</span>
<span class="line-added"> 54 </span>
<span class="line-added"> 55         Dummy(boolean useCache) {</span>
<span class="line-added"> 56             this.useCache = useCache;</span>
<span class="line-added"> 57         }</span>
<span class="line-added"> 58 </span>
<span class="line-added"> 59         @Override</span>
<span class="line-added"> 60         public SpeculationReasonEncoding encode(Supplier&lt;SpeculationReasonEncoding&gt; encodingSupplier) {</span>
<span class="line-added"> 61             SpeculationReasonEncoding encoding = cachedEncoding;</span>
<span class="line-added"> 62             if (encoding == null) {</span>
<span class="line-added"> 63                 encoding = encodingSupplier.get();</span>
<span class="line-added"> 64                 for (int i : ints) {</span>
<span class="line-added"> 65                     encoding.addInt(i);</span>
<span class="line-added"> 66                 }</span>
<span class="line-added"> 67                 for (long l : longs) {</span>
<span class="line-added"> 68                     encoding.addLong(l);</span>
<span class="line-added"> 69                 }</span>
<span class="line-added"> 70                 for (String s : strings) {</span>
<span class="line-added"> 71                     encoding.addString(s);</span>
<span class="line-added"> 72                 }</span>
<span class="line-added"> 73                 for (ResolvedJavaMethod m : methods) {</span>
<span class="line-added"> 74                     encoding.addMethod(m);</span>
<span class="line-added"> 75                 }</span>
<span class="line-added"> 76                 for (ResolvedJavaMethod c : constructors) {</span>
<span class="line-added"> 77                     encoding.addMethod(c);</span>
<span class="line-added"> 78                 }</span>
<span class="line-added"> 79                 for (ResolvedJavaType t : types) {</span>
<span class="line-added"> 80                     encoding.addType(t);</span>
<span class="line-added"> 81                 }</span>
<span class="line-added"> 82                 encoding.addMethod(null);</span>
<span class="line-added"> 83                 encoding.addType(null);</span>
<span class="line-added"> 84             }</span>
<span class="line-added"> 85             if (useCache) {</span>
<span class="line-added"> 86                 cachedEncoding = encoding;</span>
<span class="line-added"> 87             }</span>
<span class="line-added"> 88             return encoding;</span>
<span class="line-added"> 89         }</span>
<span class="line-added"> 90 </span>
<span class="line-added"> 91         @Override</span>
<span class="line-added"> 92         public boolean equals(Object obj) {</span>
<span class="line-added"> 93             if (obj instanceof Dummy) {</span>
<span class="line-added"> 94                 Dummy that = (Dummy) obj;</span>
<span class="line-added"> 95                 return Arrays.equals(this.ints, that.ints) &amp;&amp;</span>
<span class="line-added"> 96                                 Arrays.equals(this.longs, that.longs) &amp;&amp;</span>
<span class="line-added"> 97                                 Arrays.equals(this.strings, that.strings) &amp;&amp;</span>
<span class="line-added"> 98                                 this.methods.equals(that.methods) &amp;&amp;</span>
<span class="line-added"> 99                                 this.constructors.equals(that.constructors) &amp;&amp;</span>
<span class="line-added">100                                 this.types.equals(that.types);</span>
<span class="line-added">101             }</span>
<span class="line-added">102             return super.equals(obj);</span>
<span class="line-added">103         }</span>
104 
<a name="8" id="anc8"></a><span class="line-added">105         @Override</span>
<span class="line-added">106         public int hashCode() {</span>
<span class="line-added">107             return 31 * Arrays.hashCode(ints) ^</span>
<span class="line-added">108                             Arrays.hashCode(longs) ^</span>
<span class="line-added">109                             Arrays.hashCode(strings) ^</span>
<span class="line-added">110                             methods.hashCode() ^</span>
<span class="line-added">111                             constructors.hashCode() ^</span>
<span class="line-added">112                             types.hashCode();</span>
<span class="line-added">113         }</span>
114     }
115 
116     @Test
<a name="9" id="anc9"></a><span class="line-modified">117     public synchronized void testSpeculationIdentity() {</span>
<span class="line-modified">118         CodeCacheProvider codeCache = JVMCI.getRuntime().getHostJVMCIBackend().getCodeCache();</span>
<span class="line-modified">119         SpeculationLog log = codeCache.createSpeculationLog();</span>
<span class="line-modified">120         Dummy spec1 = new Dummy(true);</span>
<span class="line-modified">121         Dummy spec2 = new Dummy(false);</span>
<span class="line-added">122         Assert.assertTrue(log.maySpeculate(spec1));</span>
<span class="line-added">123         Assert.assertTrue(log.maySpeculate(spec2));</span>
<span class="line-added">124         SpeculationLog.Speculation s1 = log.speculate(spec1);</span>
<span class="line-added">125         SpeculationLog.Speculation s2 = log.speculate(spec2);</span>
126         Assert.assertTrue(&quot;Speculation should maintain identity&quot;, s1.equals(s2));
127         JavaConstant e1 = metaAccess.encodeSpeculation(s1);
128         JavaConstant e2 = metaAccess.encodeSpeculation(s2);
129         Assert.assertTrue(&quot;speculation encoding should maintain identity&quot;, e1.equals(e2));
130     }
131 }
<a name="10" id="anc10"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="10" type="hidden" />
</body>
</html>