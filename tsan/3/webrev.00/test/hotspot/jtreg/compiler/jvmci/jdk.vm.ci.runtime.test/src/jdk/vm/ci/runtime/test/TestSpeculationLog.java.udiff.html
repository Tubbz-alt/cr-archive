<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/hotspot/jtreg/compiler/jvmci/jdk.vm.ci.runtime.test/src/jdk/vm/ci/runtime/test/TestSpeculationLog.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="TestResolvedJavaType.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../../index.html" target="_top">index</a> <a href="TypeUniverse.java.udiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/jtreg/compiler/jvmci/jdk.vm.ci.runtime.test/src/jdk/vm/ci/runtime/test/TestSpeculationLog.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,14 +1,12 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2018, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
<span class="udiff-line-modified-removed">-  * published by the Free Software Foundation.  Oracle designates this</span>
<span class="udiff-line-removed">-  * particular file as subject to the &quot;Classpath&quot; exception as provided</span>
<span class="udiff-line-removed">-  * by Oracle in the LICENSE file that accompanied this code.</span>
<span class="udiff-line-modified-added">+  * published by the Free Software Foundation.</span>
   *
   * This code is distributed in the hope that it will be useful, but WITHOUT
   * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
   * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
   * version 2 for more details (a copy is included in the LICENSE file that
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -22,28 +20,111 @@</span>
   * or visit www.oracle.com if you need additional information or have any
   * questions.
   */
  package jdk.vm.ci.runtime.test;
  
<span class="udiff-line-added">+ import java.util.ArrayList;</span>
<span class="udiff-line-added">+ import java.util.Arrays;</span>
<span class="udiff-line-added">+ import java.util.Collection;</span>
<span class="udiff-line-added">+ import java.util.function.Supplier;</span>
<span class="udiff-line-added">+ </span>
  import org.junit.Assert;
  import org.junit.Test;
  
<span class="udiff-line-added">+ import jdk.vm.ci.code.CodeCacheProvider;</span>
  import jdk.vm.ci.meta.JavaConstant;
<span class="udiff-line-added">+ import jdk.vm.ci.meta.ResolvedJavaMethod;</span>
<span class="udiff-line-added">+ import jdk.vm.ci.meta.ResolvedJavaType;</span>
  import jdk.vm.ci.meta.SpeculationLog;
<span class="udiff-line-added">+ import jdk.vm.ci.meta.SpeculationLog.SpeculationReasonEncoding;</span>
<span class="udiff-line-added">+ import jdk.vm.ci.runtime.JVMCI;</span>
  
  public class TestSpeculationLog extends MethodUniverse {
  
<span class="udiff-line-modified-removed">-     static class Dummy implements SpeculationLog.SpeculationReason {</span>
<span class="udiff-line-modified-added">+     static final class Dummy implements SpeculationLog.SpeculationReason {</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         final int[] ints = {Integer.MIN_VALUE, -42, -1, 0, 1, 42, Integer.MAX_VALUE};</span>
<span class="udiff-line-added">+         final long[] longs = {Long.MIN_VALUE, -42, -1, 0, 1, 42, Long.MAX_VALUE};</span>
<span class="udiff-line-added">+         final String[] strings = {null, &quot;non-empty string&quot;, &quot;&quot;};</span>
<span class="udiff-line-added">+         final Collection&lt;ResolvedJavaMethod&gt; methods = new ArrayList&lt;&gt;(MethodUniverse.methods.values()).subList(0, 10);</span>
<span class="udiff-line-added">+         final Collection&lt;ResolvedJavaMethod&gt; constructors = new ArrayList&lt;&gt;(MethodUniverse.constructors.values()).subList(0, 10);</span>
<span class="udiff-line-added">+         final Collection&lt;ResolvedJavaType&gt; types = new ArrayList&lt;&gt;(TypeUniverse.javaTypes).subList(0, 10);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         private final boolean useCache;</span>
<span class="udiff-line-added">+         private SpeculationReasonEncoding cachedEncoding;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         Dummy(boolean useCache) {</span>
<span class="udiff-line-added">+             this.useCache = useCache;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         @Override</span>
<span class="udiff-line-added">+         public SpeculationReasonEncoding encode(Supplier&lt;SpeculationReasonEncoding&gt; encodingSupplier) {</span>
<span class="udiff-line-added">+             SpeculationReasonEncoding encoding = cachedEncoding;</span>
<span class="udiff-line-added">+             if (encoding == null) {</span>
<span class="udiff-line-added">+                 encoding = encodingSupplier.get();</span>
<span class="udiff-line-added">+                 for (int i : ints) {</span>
<span class="udiff-line-added">+                     encoding.addInt(i);</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+                 for (long l : longs) {</span>
<span class="udiff-line-added">+                     encoding.addLong(l);</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+                 for (String s : strings) {</span>
<span class="udiff-line-added">+                     encoding.addString(s);</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+                 for (ResolvedJavaMethod m : methods) {</span>
<span class="udiff-line-added">+                     encoding.addMethod(m);</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+                 for (ResolvedJavaMethod c : constructors) {</span>
<span class="udiff-line-added">+                     encoding.addMethod(c);</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+                 for (ResolvedJavaType t : types) {</span>
<span class="udiff-line-added">+                     encoding.addType(t);</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+                 encoding.addMethod(null);</span>
<span class="udiff-line-added">+                 encoding.addType(null);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             if (useCache) {</span>
<span class="udiff-line-added">+                 cachedEncoding = encoding;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             return encoding;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         @Override</span>
<span class="udiff-line-added">+         public boolean equals(Object obj) {</span>
<span class="udiff-line-added">+             if (obj instanceof Dummy) {</span>
<span class="udiff-line-added">+                 Dummy that = (Dummy) obj;</span>
<span class="udiff-line-added">+                 return Arrays.equals(this.ints, that.ints) &amp;&amp;</span>
<span class="udiff-line-added">+                                 Arrays.equals(this.longs, that.longs) &amp;&amp;</span>
<span class="udiff-line-added">+                                 Arrays.equals(this.strings, that.strings) &amp;&amp;</span>
<span class="udiff-line-added">+                                 this.methods.equals(that.methods) &amp;&amp;</span>
<span class="udiff-line-added">+                                 this.constructors.equals(that.constructors) &amp;&amp;</span>
<span class="udiff-line-added">+                                 this.types.equals(that.types);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             return super.equals(obj);</span>
<span class="udiff-line-added">+         }</span>
  
<span class="udiff-line-added">+         @Override</span>
<span class="udiff-line-added">+         public int hashCode() {</span>
<span class="udiff-line-added">+             return 31 * Arrays.hashCode(ints) ^</span>
<span class="udiff-line-added">+                             Arrays.hashCode(longs) ^</span>
<span class="udiff-line-added">+                             Arrays.hashCode(strings) ^</span>
<span class="udiff-line-added">+                             methods.hashCode() ^</span>
<span class="udiff-line-added">+                             constructors.hashCode() ^</span>
<span class="udiff-line-added">+                             types.hashCode();</span>
<span class="udiff-line-added">+         }</span>
      }
  
      @Test
<span class="udiff-line-modified-removed">-     public void testSpeculationIdentity() {</span>
<span class="udiff-line-modified-removed">-         Dummy spec = new Dummy();</span>
<span class="udiff-line-modified-removed">-         SpeculationLog log = methods.entrySet().iterator().next().getValue().getSpeculationLog();</span>
<span class="udiff-line-modified-removed">-         SpeculationLog.Speculation s1 = log.speculate(spec);</span>
<span class="udiff-line-modified-removed">-         SpeculationLog.Speculation s2 = log.speculate(spec);</span>
<span class="udiff-line-modified-added">+     public synchronized void testSpeculationIdentity() {</span>
<span class="udiff-line-modified-added">+         CodeCacheProvider codeCache = JVMCI.getRuntime().getHostJVMCIBackend().getCodeCache();</span>
<span class="udiff-line-modified-added">+         SpeculationLog log = codeCache.createSpeculationLog();</span>
<span class="udiff-line-modified-added">+         Dummy spec1 = new Dummy(true);</span>
<span class="udiff-line-modified-added">+         Dummy spec2 = new Dummy(false);</span>
<span class="udiff-line-added">+         Assert.assertTrue(log.maySpeculate(spec1));</span>
<span class="udiff-line-added">+         Assert.assertTrue(log.maySpeculate(spec2));</span>
<span class="udiff-line-added">+         SpeculationLog.Speculation s1 = log.speculate(spec1);</span>
<span class="udiff-line-added">+         SpeculationLog.Speculation s2 = log.speculate(spec2);</span>
          Assert.assertTrue(&quot;Speculation should maintain identity&quot;, s1.equals(s2));
          JavaConstant e1 = metaAccess.encodeSpeculation(s1);
          JavaConstant e2 = metaAccess.encodeSpeculation(s2);
          Assert.assertTrue(&quot;speculation encoding should maintain identity&quot;, e1.equals(e2));
      }
</pre>
<center><a href="TestResolvedJavaType.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../../index.html" target="_top">index</a> <a href="TypeUniverse.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>