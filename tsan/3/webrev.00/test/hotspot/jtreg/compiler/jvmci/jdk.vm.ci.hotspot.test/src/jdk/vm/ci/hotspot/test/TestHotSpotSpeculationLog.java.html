<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New test/hotspot/jtreg/compiler/jvmci/jdk.vm.ci.hotspot.test/src/jdk/vm/ci/hotspot/test/TestHotSpotSpeculationLog.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2018, 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @requires vm.jvmci
 27  * @modules jdk.internal.vm.ci/jdk.vm.ci.hotspot
 28  *          jdk.internal.vm.ci/jdk.vm.ci.meta
 29  * @library /compiler/jvmci/jdk.vm.ci.hotspot.test/src
 30  * @run testng/othervm
 31  *      -XX:+UnlockExperimentalVMOptions -XX:+EnableJVMCI -XX:-UseJVMCICompiler
 32  *      jdk.vm.ci.hotspot.test.TestHotSpotSpeculationLog
 33  */
 34 
 35 package jdk.vm.ci.hotspot.test;
 36 
 37 import java.util.function.Supplier;
 38 
 39 import org.testng.Assert;
 40 import org.testng.SkipException;
 41 import org.testng.annotations.Test;
 42 
 43 import jdk.vm.ci.hotspot.HotSpotSpeculationLog;
 44 import jdk.vm.ci.meta.SpeculationLog;
 45 import jdk.vm.ci.meta.SpeculationLog.SpeculationReasonEncoding;
 46 
 47 public class TestHotSpotSpeculationLog {
 48 
 49     static final class DummyReason implements SpeculationLog.SpeculationReason {
 50 
 51         final String name;
 52         private SpeculationReasonEncoding cachedEncoding;
 53 
 54         DummyReason(String name) {
 55             this.name = name;
 56         }
 57 
 58         @Override
 59         public SpeculationReasonEncoding encode(Supplier&lt;SpeculationReasonEncoding&gt; encodingSupplier) {
 60             SpeculationReasonEncoding encoding = cachedEncoding;
 61             if (encoding == null) {
 62                 encoding = encodingSupplier.get();
 63                 encoding.addString(name);
 64             }
 65             cachedEncoding = encoding;
 66             return encoding;
 67         }
 68 
 69         @Override
 70         public boolean equals(Object obj) {
 71             if (obj instanceof DummyReason) {
 72                 DummyReason that = (DummyReason) obj;
 73                 return this.name.equals(that.name);
 74             }
 75             return super.equals(obj);
 76         }
 77 
 78         @Override
 79         public int hashCode() {
 80             return name.hashCode();
 81         }
 82 
 83         @Override
 84         public String toString() {
 85             return name;
 86         }
 87     }
 88 
 89     @Test
 90     public synchronized void testFailedSpeculations() {
 91         HotSpotSpeculationLog log = new HotSpotSpeculationLog();
 92         DummyReason reason1 = new DummyReason(&quot;dummy1&quot;);
 93         String longName = new String(new char[2000]).replace(&#39;\0&#39;, &#39;X&#39;);
 94         DummyReason reason2 = new DummyReason(longName);
 95         Assert.assertTrue(log.maySpeculate(reason1));
 96         Assert.assertTrue(log.maySpeculate(reason2));
 97 
 98         SpeculationLog.Speculation s1 = log.speculate(reason1);
 99         SpeculationLog.Speculation s2 = log.speculate(reason2);
100 
101         boolean added = log.addFailedSpeculation(s1);
102         if (!added) {
103             throw new SkipException(&quot;log.addFailedSpeculation(s1) is false&quot;);
104         }
105 
106         log.collectFailedSpeculations();
107         Assert.assertFalse(log.maySpeculate(reason1));
108         Assert.assertTrue(log.maySpeculate(reason2));
109 
110         added = log.addFailedSpeculation(s2);
111         if (!added) {
112             throw new SkipException(&quot;log.addFailedSpeculation(s2) is false&quot;);
113         }
114         log.collectFailedSpeculations();
115         Assert.assertFalse(log.maySpeculate(reason1));
116         Assert.assertFalse(log.maySpeculate(reason2), log.toString());
117     }
118 }
    </pre>
  </body>
</html>