<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/hotspot/jtreg/compiler/codecache/stress/Helper.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="../../classUnloading/methodUnloading/TestOverloadCompileQueues.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="RandomAllocationTest.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/jtreg/compiler/codecache/stress/Helper.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 23 
 24 package compiler.codecache.stress;
 25 
 26 import jdk.test.lib.Asserts;
 27 import jdk.test.lib.ByteCodeLoader;
 28 import jdk.test.lib.InfiniteLoop;
 29 import jdk.test.lib.Utils;
 30 import sun.hotspot.WhiteBox;
 31 
 32 import java.io.BufferedInputStream;
 33 import java.io.ByteArrayOutputStream;
 34 import java.io.IOException;
 35 import java.util.Random;
 36 import java.util.concurrent.Callable;
 37 
 38 public final class Helper {
 39     public static final WhiteBox WHITE_BOX = WhiteBox.getWhiteBox();
 40     public static final Random RNG = Utils.getRandomInstance();
 41 
 42     private static final long THRESHOLD = WHITE_BOX.getIntxVMFlag(&quot;CompileThreshold&quot;);
<span class="line-modified"> 43     private static final String TEST_CASE_IMPL_CLASS_NAME = &quot;compiler.codecache.stress.Helper$TestCaseImpl&quot;;</span>
 44     private static byte[] CLASS_DATA;
 45     static {
 46         try {
 47             CLASS_DATA = loadClassData(TEST_CASE_IMPL_CLASS_NAME);
 48         } catch (IOException e) {
 49             throw new Error(&quot;TESTBUG: cannot load class byte code &quot; + TEST_CASE_IMPL_CLASS_NAME, e);
 50         }
 51     }
 52 
 53     private Helper() {
 54     }
 55 
 56     public static void startInfiniteLoopThread(Runnable action) {
 57         startInfiniteLoopThread(action, 0L);
 58     }
 59 
 60     public static void startInfiniteLoopThread(Runnable action, long millis) {
 61         Thread t = new Thread(new InfiniteLoop(action, millis));
 62         t.setDaemon(true);
 63         t.start();
</pre>
<hr />
<pre>
 92     }
 93 
 94     public interface TestCase {
 95 
 96         public static TestCase get() {
 97             try {
 98                 Class clazz = ByteCodeLoader.load(
 99                         TEST_CASE_IMPL_CLASS_NAME, CLASS_DATA);
100                 return (TestCase) clazz.newInstance();
101             } catch (ReflectiveOperationException e) {
102                 throw new Error(String.format(
103                         &quot;TESTBUG: error while creating %s instance from reloaded class&quot;,
104                         TEST_CASE_IMPL_CLASS_NAME), e);
105             }
106         }
107 
108         Callable&lt;Integer&gt; getCallable();
109         int method();
110         int expectedValue();
111     }
<span class="line-removed">112 </span>
<span class="line-removed">113     public static class TestCaseImpl implements TestCase {</span>
<span class="line-removed">114         private static final int RETURN_VALUE = 42;</span>
<span class="line-removed">115         private static final int RECURSION_DEPTH = 10;</span>
<span class="line-removed">116         private volatile int i;</span>
<span class="line-removed">117 </span>
<span class="line-removed">118         @Override</span>
<span class="line-removed">119         public Callable&lt;Integer&gt; getCallable() {</span>
<span class="line-removed">120             return () -&gt; {</span>
<span class="line-removed">121                 i = 0;</span>
<span class="line-removed">122                 return method();</span>
<span class="line-removed">123             };</span>
<span class="line-removed">124         }</span>
<span class="line-removed">125 </span>
<span class="line-removed">126         @Override</span>
<span class="line-removed">127         public int method() {</span>
<span class="line-removed">128             ++i;</span>
<span class="line-removed">129             int result = RETURN_VALUE;</span>
<span class="line-removed">130             if (i &lt; RECURSION_DEPTH) {</span>
<span class="line-removed">131                 return result + method();</span>
<span class="line-removed">132             }</span>
<span class="line-removed">133             return result;</span>
<span class="line-removed">134         }</span>
<span class="line-removed">135 </span>
<span class="line-removed">136         @Override</span>
<span class="line-removed">137         public int expectedValue() {</span>
<span class="line-removed">138             return RETURN_VALUE * RECURSION_DEPTH;</span>
<span class="line-removed">139         }</span>
<span class="line-removed">140     }</span>
<span class="line-removed">141 </span>
142 }
</pre>
</td>
<td>
<hr />
<pre>
 23 
 24 package compiler.codecache.stress;
 25 
 26 import jdk.test.lib.Asserts;
 27 import jdk.test.lib.ByteCodeLoader;
 28 import jdk.test.lib.InfiniteLoop;
 29 import jdk.test.lib.Utils;
 30 import sun.hotspot.WhiteBox;
 31 
 32 import java.io.BufferedInputStream;
 33 import java.io.ByteArrayOutputStream;
 34 import java.io.IOException;
 35 import java.util.Random;
 36 import java.util.concurrent.Callable;
 37 
 38 public final class Helper {
 39     public static final WhiteBox WHITE_BOX = WhiteBox.getWhiteBox();
 40     public static final Random RNG = Utils.getRandomInstance();
 41 
 42     private static final long THRESHOLD = WHITE_BOX.getIntxVMFlag(&quot;CompileThreshold&quot;);
<span class="line-modified"> 43     private static final String TEST_CASE_IMPL_CLASS_NAME = &quot;compiler.codecache.stress.TestCaseImpl&quot;;</span>
 44     private static byte[] CLASS_DATA;
 45     static {
 46         try {
 47             CLASS_DATA = loadClassData(TEST_CASE_IMPL_CLASS_NAME);
 48         } catch (IOException e) {
 49             throw new Error(&quot;TESTBUG: cannot load class byte code &quot; + TEST_CASE_IMPL_CLASS_NAME, e);
 50         }
 51     }
 52 
 53     private Helper() {
 54     }
 55 
 56     public static void startInfiniteLoopThread(Runnable action) {
 57         startInfiniteLoopThread(action, 0L);
 58     }
 59 
 60     public static void startInfiniteLoopThread(Runnable action, long millis) {
 61         Thread t = new Thread(new InfiniteLoop(action, millis));
 62         t.setDaemon(true);
 63         t.start();
</pre>
<hr />
<pre>
 92     }
 93 
 94     public interface TestCase {
 95 
 96         public static TestCase get() {
 97             try {
 98                 Class clazz = ByteCodeLoader.load(
 99                         TEST_CASE_IMPL_CLASS_NAME, CLASS_DATA);
100                 return (TestCase) clazz.newInstance();
101             } catch (ReflectiveOperationException e) {
102                 throw new Error(String.format(
103                         &quot;TESTBUG: error while creating %s instance from reloaded class&quot;,
104                         TEST_CASE_IMPL_CLASS_NAME), e);
105             }
106         }
107 
108         Callable&lt;Integer&gt; getCallable();
109         int method();
110         int expectedValue();
111     }






























112 }
</pre>
</td>
</tr>
</table>
<center><a href="../../classUnloading/methodUnloading/TestOverloadCompileQueues.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="RandomAllocationTest.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>