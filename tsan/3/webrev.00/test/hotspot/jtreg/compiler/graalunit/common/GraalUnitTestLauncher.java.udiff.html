<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/hotspot/jtreg/compiler/graalunit/common/GraalUnitTestLauncher.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="../com.oracle.mxtool.junit/com/oracle/mxtool/junit/TimingDecorator.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../generateTests.sh.udiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/jtreg/compiler/graalunit/common/GraalUnitTestLauncher.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2018, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -227,23 +227,29 @@</span>
          // add modules and exports
          javaFlags.add(&quot;--add-modules&quot;);
          javaFlags.add(&quot;jdk.internal.vm.compiler,jdk.internal.vm.ci&quot;);
          javaFlags.add(&quot;--add-exports&quot;);
          javaFlags.add(&quot;java.base/jdk.internal.module=ALL-UNNAMED&quot;);
<span class="udiff-line-added">+         javaFlags.add(&quot;--add-exports&quot;);</span>
<span class="udiff-line-added">+         javaFlags.add(&quot;java.base/jdk.internal.misc=ALL-UNNAMED&quot;);</span>
          javaFlags.addAll(getModuleExports(&quot;jdk.internal.vm.compiler&quot;, &quot;ALL-UNNAMED&quot;));
          javaFlags.addAll(getModuleExports(&quot;jdk.internal.vm.ci&quot;, &quot;ALL-UNNAMED,jdk.internal.vm.compiler&quot;));
  
<span class="udiff-line-added">+         // add opens, see JDK-8236211</span>
<span class="udiff-line-added">+         javaFlags.add(&quot;--add-opens&quot;);</span>
<span class="udiff-line-added">+         javaFlags.add(&quot;jdk.internal.vm.compiler/org.graalvm.graphio=ALL-UNNAMED&quot;);</span>
  
          // add VM flags
          javaFlags.add(&quot;-XX:+UnlockExperimentalVMOptions&quot;);
          javaFlags.add(&quot;-XX:+EnableJVMCI&quot;);
          javaFlags.add(&quot;-Djava.awt.headless=true&quot;);
          javaFlags.add(&quot;-esa&quot;);
          javaFlags.add(&quot;-ea&quot;);
          // Make sure exception message is never null
          javaFlags.add(&quot;-XX:-OmitStackTraceInFastThrow&quot;);
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-added">+         // set timeout factor based on jtreg harness settings</span>
<span class="udiff-line-added">+         javaFlags.add(&quot;-Dgraaltest.timeout.factor=&quot; + System.getProperty(&quot;test.timeout.factor&quot;, &quot;1.0&quot;));</span>
  
          // generate class path
          ArrayList&lt;String&gt; graalJars = new ArrayList&lt;String&gt;(Arrays.asList(GRAAL_EXTRA_JARS));
          graalJars.add(MXTOOL_JARFILE);
          graalJars.add(GRAAL_UNITTESTS_JARFILE);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -251,11 +257,15 @@</span>
          String graalJarsCP = graalJars.stream()
                                        .map(s -&gt; String.join(File.separator, libsDir, s))
                                        .collect(Collectors.joining(File.pathSeparator));
  
          javaFlags.add(&quot;-cp&quot;);
<span class="udiff-line-modified-removed">-         javaFlags.add(String.join(File.pathSeparator, System.getProperty(&quot;java.class.path&quot;), graalJarsCP));</span>
<span class="udiff-line-modified-added">+         // Existing classpath returned by System.getProperty(&quot;java.class.path&quot;) may contain another</span>
<span class="udiff-line-added">+         // version of junit with which the jtreg tool is built. It may be incompatible with required</span>
<span class="udiff-line-added">+         // junit version. So we put graalJarsCP before existing classpath when generating a new one</span>
<span class="udiff-line-added">+         // to avoid incompatibility issues.</span>
<span class="udiff-line-added">+         javaFlags.add(String.join(File.pathSeparator, graalJarsCP, System.getProperty(&quot;java.class.path&quot;)));</span>
  
          //
          javaFlags.add(&quot;com.oracle.mxtool.junit.MxJUnitWrapper&quot;);
          javaFlags.add(&quot;-JUnitVerbose&quot;);
          javaFlags.add(&quot;-JUnitEagerStackTrace&quot;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -267,12 +277,11 @@</span>
                  javaFlags.toArray(new String[javaFlags.size()]));
  
          // Some tests rely on MX_SUBPROCESS_COMMAND_FILE env variable which contains
          // name of the file with java executable and java args used to launch the current process.
          Path cmdFile = Files.createTempFile(Path.of(&quot;&quot;), &quot;mx_subprocess_&quot;, &quot;.cmd&quot;);
<span class="udiff-line-modified-removed">-         Files.writeString(cmdFile, JDKToolFinder.getJDKTool(&quot;java&quot;) + System.lineSeparator());</span>
<span class="udiff-line-removed">-         Files.write(cmdFile, javaFlags, StandardOpenOption.APPEND);</span>
<span class="udiff-line-modified-added">+         Files.write(cmdFile, javaPB.command());</span>
          javaPB.environment().put(&quot;MX_SUBPROCESS_COMMAND_FILE&quot;, cmdFile.toAbsolutePath().toString());
  
          System.out.println(&quot;INFO: run command: &quot; + String.join(&quot; &quot;, javaPB.command()));
  
          OutputAnalyzer outputAnalyzer = new OutputAnalyzer(javaPB.start());
</pre>
<center><a href="../com.oracle.mxtool.junit/com/oracle/mxtool/junit/TimingDecorator.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../generateTests.sh.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>