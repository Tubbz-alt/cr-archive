<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/hotspot/jtreg/compiler/graalunit/common/GraalUnitTestLauncher.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="../com.oracle.mxtool.junit/com/oracle/mxtool/junit/TimingDecorator.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../generateTests.sh.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/jtreg/compiler/graalunit/common/GraalUnitTestLauncher.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
</pre>
<hr />
<pre>
212         Set&lt;String&gt; excludeTests = null;
213         if (excludeFileName != null) {
214             excludeTests = loadExcludeList(excludeFileName);
215         }
216 
217         // Find list of tests which match provided predicate and write into GENERATED_TESTCLASSES_FILENAME file
218         ArrayList&lt;String&gt; tests = getListOfTestsByPrefix(testPrefix, excludeTests);
219         if (tests.size() &gt; 0) {
220             Files.write(Paths.get(GENERATED_TESTCLASSES_FILENAME), String.join(System.lineSeparator(), tests).getBytes());
221         } else {
222             throw new Error(&quot;TESTBUG: no tests found for prefix &quot; + testPrefix);
223         }
224 
225         ArrayList&lt;String&gt; javaFlags = new ArrayList&lt;String&gt;();
226 
227         // add modules and exports
228         javaFlags.add(&quot;--add-modules&quot;);
229         javaFlags.add(&quot;jdk.internal.vm.compiler,jdk.internal.vm.ci&quot;);
230         javaFlags.add(&quot;--add-exports&quot;);
231         javaFlags.add(&quot;java.base/jdk.internal.module=ALL-UNNAMED&quot;);


232         javaFlags.addAll(getModuleExports(&quot;jdk.internal.vm.compiler&quot;, &quot;ALL-UNNAMED&quot;));
233         javaFlags.addAll(getModuleExports(&quot;jdk.internal.vm.ci&quot;, &quot;ALL-UNNAMED,jdk.internal.vm.compiler&quot;));
234 



235 
236         // add VM flags
237         javaFlags.add(&quot;-XX:+UnlockExperimentalVMOptions&quot;);
238         javaFlags.add(&quot;-XX:+EnableJVMCI&quot;);
239         javaFlags.add(&quot;-Djava.awt.headless=true&quot;);
240         javaFlags.add(&quot;-esa&quot;);
241         javaFlags.add(&quot;-ea&quot;);
242         // Make sure exception message is never null
243         javaFlags.add(&quot;-XX:-OmitStackTraceInFastThrow&quot;);
<span class="line-modified">244 </span>

245 
246         // generate class path
247         ArrayList&lt;String&gt; graalJars = new ArrayList&lt;String&gt;(Arrays.asList(GRAAL_EXTRA_JARS));
248         graalJars.add(MXTOOL_JARFILE);
249         graalJars.add(GRAAL_UNITTESTS_JARFILE);
250 
251         String graalJarsCP = graalJars.stream()
252                                       .map(s -&gt; String.join(File.separator, libsDir, s))
253                                       .collect(Collectors.joining(File.pathSeparator));
254 
255         javaFlags.add(&quot;-cp&quot;);
<span class="line-modified">256         javaFlags.add(String.join(File.pathSeparator, System.getProperty(&quot;java.class.path&quot;), graalJarsCP));</span>




257 
258         //
259         javaFlags.add(&quot;com.oracle.mxtool.junit.MxJUnitWrapper&quot;);
260         javaFlags.add(&quot;-JUnitVerbose&quot;);
261         javaFlags.add(&quot;-JUnitEagerStackTrace&quot;);
262         javaFlags.add(&quot;-JUnitEnableTiming&quot;);
263 
264         javaFlags.add(&quot;@&quot;+GENERATED_TESTCLASSES_FILENAME);
265 
266         ProcessBuilder javaPB = ProcessTools.createJavaProcessBuilder(true,
267                 javaFlags.toArray(new String[javaFlags.size()]));
268 
269         // Some tests rely on MX_SUBPROCESS_COMMAND_FILE env variable which contains
270         // name of the file with java executable and java args used to launch the current process.
271         Path cmdFile = Files.createTempFile(Path.of(&quot;&quot;), &quot;mx_subprocess_&quot;, &quot;.cmd&quot;);
<span class="line-modified">272         Files.writeString(cmdFile, JDKToolFinder.getJDKTool(&quot;java&quot;) + System.lineSeparator());</span>
<span class="line-removed">273         Files.write(cmdFile, javaFlags, StandardOpenOption.APPEND);</span>
274         javaPB.environment().put(&quot;MX_SUBPROCESS_COMMAND_FILE&quot;, cmdFile.toAbsolutePath().toString());
275 
276         System.out.println(&quot;INFO: run command: &quot; + String.join(&quot; &quot;, javaPB.command()));
277 
278         OutputAnalyzer outputAnalyzer = new OutputAnalyzer(javaPB.start());
279         System.out.println(&quot;INFO: execution result: &quot; + outputAnalyzer.getOutput());
280         outputAnalyzer.shouldHaveExitValue(0);
281     }
282 }
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2018, 2020, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
</pre>
<hr />
<pre>
212         Set&lt;String&gt; excludeTests = null;
213         if (excludeFileName != null) {
214             excludeTests = loadExcludeList(excludeFileName);
215         }
216 
217         // Find list of tests which match provided predicate and write into GENERATED_TESTCLASSES_FILENAME file
218         ArrayList&lt;String&gt; tests = getListOfTestsByPrefix(testPrefix, excludeTests);
219         if (tests.size() &gt; 0) {
220             Files.write(Paths.get(GENERATED_TESTCLASSES_FILENAME), String.join(System.lineSeparator(), tests).getBytes());
221         } else {
222             throw new Error(&quot;TESTBUG: no tests found for prefix &quot; + testPrefix);
223         }
224 
225         ArrayList&lt;String&gt; javaFlags = new ArrayList&lt;String&gt;();
226 
227         // add modules and exports
228         javaFlags.add(&quot;--add-modules&quot;);
229         javaFlags.add(&quot;jdk.internal.vm.compiler,jdk.internal.vm.ci&quot;);
230         javaFlags.add(&quot;--add-exports&quot;);
231         javaFlags.add(&quot;java.base/jdk.internal.module=ALL-UNNAMED&quot;);
<span class="line-added">232         javaFlags.add(&quot;--add-exports&quot;);</span>
<span class="line-added">233         javaFlags.add(&quot;java.base/jdk.internal.misc=ALL-UNNAMED&quot;);</span>
234         javaFlags.addAll(getModuleExports(&quot;jdk.internal.vm.compiler&quot;, &quot;ALL-UNNAMED&quot;));
235         javaFlags.addAll(getModuleExports(&quot;jdk.internal.vm.ci&quot;, &quot;ALL-UNNAMED,jdk.internal.vm.compiler&quot;));
236 
<span class="line-added">237         // add opens, see JDK-8236211</span>
<span class="line-added">238         javaFlags.add(&quot;--add-opens&quot;);</span>
<span class="line-added">239         javaFlags.add(&quot;jdk.internal.vm.compiler/org.graalvm.graphio=ALL-UNNAMED&quot;);</span>
240 
241         // add VM flags
242         javaFlags.add(&quot;-XX:+UnlockExperimentalVMOptions&quot;);
243         javaFlags.add(&quot;-XX:+EnableJVMCI&quot;);
244         javaFlags.add(&quot;-Djava.awt.headless=true&quot;);
245         javaFlags.add(&quot;-esa&quot;);
246         javaFlags.add(&quot;-ea&quot;);
247         // Make sure exception message is never null
248         javaFlags.add(&quot;-XX:-OmitStackTraceInFastThrow&quot;);
<span class="line-modified">249         // set timeout factor based on jtreg harness settings</span>
<span class="line-added">250         javaFlags.add(&quot;-Dgraaltest.timeout.factor=&quot; + System.getProperty(&quot;test.timeout.factor&quot;, &quot;1.0&quot;));</span>
251 
252         // generate class path
253         ArrayList&lt;String&gt; graalJars = new ArrayList&lt;String&gt;(Arrays.asList(GRAAL_EXTRA_JARS));
254         graalJars.add(MXTOOL_JARFILE);
255         graalJars.add(GRAAL_UNITTESTS_JARFILE);
256 
257         String graalJarsCP = graalJars.stream()
258                                       .map(s -&gt; String.join(File.separator, libsDir, s))
259                                       .collect(Collectors.joining(File.pathSeparator));
260 
261         javaFlags.add(&quot;-cp&quot;);
<span class="line-modified">262         // Existing classpath returned by System.getProperty(&quot;java.class.path&quot;) may contain another</span>
<span class="line-added">263         // version of junit with which the jtreg tool is built. It may be incompatible with required</span>
<span class="line-added">264         // junit version. So we put graalJarsCP before existing classpath when generating a new one</span>
<span class="line-added">265         // to avoid incompatibility issues.</span>
<span class="line-added">266         javaFlags.add(String.join(File.pathSeparator, graalJarsCP, System.getProperty(&quot;java.class.path&quot;)));</span>
267 
268         //
269         javaFlags.add(&quot;com.oracle.mxtool.junit.MxJUnitWrapper&quot;);
270         javaFlags.add(&quot;-JUnitVerbose&quot;);
271         javaFlags.add(&quot;-JUnitEagerStackTrace&quot;);
272         javaFlags.add(&quot;-JUnitEnableTiming&quot;);
273 
274         javaFlags.add(&quot;@&quot;+GENERATED_TESTCLASSES_FILENAME);
275 
276         ProcessBuilder javaPB = ProcessTools.createJavaProcessBuilder(true,
277                 javaFlags.toArray(new String[javaFlags.size()]));
278 
279         // Some tests rely on MX_SUBPROCESS_COMMAND_FILE env variable which contains
280         // name of the file with java executable and java args used to launch the current process.
281         Path cmdFile = Files.createTempFile(Path.of(&quot;&quot;), &quot;mx_subprocess_&quot;, &quot;.cmd&quot;);
<span class="line-modified">282         Files.write(cmdFile, javaPB.command());</span>

283         javaPB.environment().put(&quot;MX_SUBPROCESS_COMMAND_FILE&quot;, cmdFile.toAbsolutePath().toString());
284 
285         System.out.println(&quot;INFO: run command: &quot; + String.join(&quot; &quot;, javaPB.command()));
286 
287         OutputAnalyzer outputAnalyzer = new OutputAnalyzer(javaPB.start());
288         System.out.println(&quot;INFO: execution result: &quot; + outputAnalyzer.getOutput());
289         outputAnalyzer.shouldHaveExitValue(0);
290     }
291 }
</pre>
</td>
</tr>
</table>
<center><a href="../com.oracle.mxtool.junit/com/oracle/mxtool/junit/TimingDecorator.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../generateTests.sh.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>