<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/hotspot/jtreg/compiler/graalunit/com.oracle.mxtool.junit/com/oracle/mxtool/junit/MxJUnitWrapper.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="FindClassesByAnnotatedMethods.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="TextRunListener.java.udiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/jtreg/compiler/graalunit/com.oracle.mxtool.junit/com/oracle/mxtool/junit/MxJUnitWrapper.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -27,22 +27,17 @@</span>
  import java.io.FileNotFoundException;
  import java.io.FileOutputStream;
  import java.io.FileReader;
  import java.io.IOException;
  import java.io.PrintStream;
<span class="udiff-line-removed">- import java.lang.annotation.Annotation;</span>
<span class="udiff-line-removed">- import java.lang.reflect.Method;</span>
  import java.util.ArrayList;
  import java.util.Collections;
<span class="udiff-line-removed">- import java.util.HashSet;</span>
  import java.util.List;
  import java.util.Map;
<span class="udiff-line-removed">- import java.util.Optional;</span>
  import java.util.ServiceLoader;
  import java.util.Set;
<span class="udiff-line-modified-removed">- import java.util.regex.Matcher;</span>
<span class="udiff-line-removed">- import java.util.regex.Pattern;</span>
<span class="udiff-line-modified-added">+ import java.util.TreeSet;</span>
  
  import org.junit.internal.JUnitSystem;
  import org.junit.internal.RealSystem;
  import org.junit.runner.Description;
  import org.junit.runner.JUnitCore;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -57,10 +52,18 @@</span>
  
  import junit.runner.Version;
  
  public class MxJUnitWrapper {
  
<span class="udiff-line-added">+     // Unit tests that start a JVM subprocess can use these system properties to</span>
<span class="udiff-line-added">+     // add --add-exports and --add-opens as necessary to the JVM command line.</span>
<span class="udiff-line-added">+     //</span>
<span class="udiff-line-added">+     // Known usages:</span>
<span class="udiff-line-added">+     // org.graalvm.compiler.test.SubprocessUtil.getPackageOpeningOptions()</span>
<span class="udiff-line-added">+     public static final String OPENED_PACKAGES_PROPERTY_NAME = &quot;com.oracle.mxtool.junit.opens&quot;;</span>
<span class="udiff-line-added">+     public static final String EXPORTED_PACKAGES_PROPERTY_NAME = &quot;com.oracle.mxtool.junit.exports&quot;;</span>
<span class="udiff-line-added">+ </span>
      public static class MxJUnitConfig {
  
          public boolean verbose = false;
          public boolean veryVerbose = false;
          public boolean enableTiming = false;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -134,18 +137,29 @@</span>
          MxJUnitRequest.Builder builder = new MxJUnitRequest.Builder();
          MxJUnitConfig config = new MxJUnitConfig();
  
          String[] expandedArgs = expandArgs(args);
          int i = 0;
<span class="udiff-line-added">+         List&lt;String&gt; testSpecs = new ArrayList&lt;&gt;();</span>
<span class="udiff-line-added">+         List&lt;String&gt; openPackagesSpecs = new ArrayList&lt;&gt;();</span>
          while (i &lt; expandedArgs.length) {
              String each = expandedArgs[i];
              if (each.charAt(0) == &#39;-&#39;) {
                  // command line arguments
                  if (each.contentEquals(&quot;-JUnitVerbose&quot;)) {
                      config.verbose = true;
<span class="udiff-line-added">+                     config.enableTiming = true;</span>
<span class="udiff-line-added">+                 } else if (each.contentEquals(&quot;-JUnitOpenPackages&quot;)) {</span>
<span class="udiff-line-added">+                     if (i + 1 &gt;= expandedArgs.length) {</span>
<span class="udiff-line-added">+                         system.out().println(&quot;Must include argument for -JUnitAddExports&quot;);</span>
<span class="udiff-line-added">+                         System.exit(1);</span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+                     openPackagesSpecs.add(expandedArgs[++i]);</span>
                  } else if (each.contentEquals(&quot;-JUnitVeryVerbose&quot;)) {
<span class="udiff-line-added">+                     config.verbose = true;</span>
                      config.veryVerbose = true;
<span class="udiff-line-added">+                     config.enableTiming = true;</span>
                  } else if (each.contentEquals(&quot;-JUnitFailFast&quot;)) {
                      config.failFast = true;
                  } else if (each.contentEquals(&quot;-JUnitEnableTiming&quot;)) {
                      config.enableTiming = true;
                  } else if (each.contentEquals(&quot;-JUnitColor&quot;)) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -170,25 +184,39 @@</span>
                  } else {
                      system.out().println(&quot;Unknown command line argument: &quot; + each);
                  }
  
              } else {
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-removed">-                 try {</span>
<span class="udiff-line-removed">-                     builder.addTestSpec(each);</span>
<span class="udiff-line-removed">-                 } catch (MxJUnitRequest.BuilderException ex) {</span>
<span class="udiff-line-removed">-                     system.out().println(ex.getMessage());</span>
<span class="udiff-line-removed">-                     System.exit(1);</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-modified-added">+                 testSpecs.add(each);</span>
              }
              i++;
          }
  
<span class="udiff-line-added">+         ModuleSupport moduleSupport = new ModuleSupport(system.out());</span>
<span class="udiff-line-added">+         Set&lt;String&gt; opened = new TreeSet&lt;&gt;();</span>
<span class="udiff-line-added">+         Set&lt;String&gt; exported = new TreeSet&lt;&gt;();</span>
<span class="udiff-line-added">+         for (String spec : openPackagesSpecs) {</span>
<span class="udiff-line-added">+             moduleSupport.openPackages(spec, &quot;-JUnitOpenPackages&quot;, opened, exported);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         for (String spec : testSpecs) {</span>
<span class="udiff-line-added">+             try {</span>
<span class="udiff-line-added">+                 builder.addTestSpec(spec);</span>
<span class="udiff-line-added">+             } catch (MxJUnitRequest.BuilderException ex) {</span>
<span class="udiff-line-added">+                 system.out().println(ex.getMessage());</span>
<span class="udiff-line-added">+                 System.exit(1);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
          MxJUnitRequest request = builder.build();
<span class="udiff-line-added">+         moduleSupport.processAddExportsAnnotations(request.classes, opened, exported);</span>
  
<span class="udiff-line-modified-removed">-         if (System.getProperty(&quot;java.specification.version&quot;).compareTo(&quot;1.9&quot;) &gt;= 0) {</span>
<span class="udiff-line-modified-removed">-             addExports(request.classes, system.out());</span>
<span class="udiff-line-modified-added">+         if (!opened.isEmpty()) {</span>
<span class="udiff-line-modified-added">+             System.setProperty(OPENED_PACKAGES_PROPERTY_NAME, String.join(System.lineSeparator(), opened));</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         if (!exported.isEmpty()) {</span>
<span class="udiff-line-added">+             System.setProperty(EXPORTED_PACKAGES_PROPERTY_NAME, String.join(System.lineSeparator(), exported));</span>
          }
  
          for (RunListener p : ServiceLoader.load(RunListener.class)) {
              junitCore.addListener(p);
          }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -283,12 +311,10 @@</span>
          }
  
          return result;
      }
  
<span class="udiff-line-removed">-     private static final Pattern MODULE_PACKAGE_RE = Pattern.compile(&quot;([^/]+)/(.+)&quot;);</span>
<span class="udiff-line-removed">- </span>
      private static class Timing&lt;T&gt; implements Comparable&lt;Timing&lt;T&gt;&gt; {
          final T subject;
          final long value;
  
          Timing(T subject, long value) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -341,97 +367,10 @@</span>
              }
  
          }
      }
  
<span class="udiff-line-removed">-     /**</span>
<span class="udiff-line-removed">-      * Adds the super types of {@code cls} to {@code supertypes}.</span>
<span class="udiff-line-removed">-      */</span>
<span class="udiff-line-removed">-     private static void gatherSupertypes(Class&lt;?&gt; cls, Set&lt;Class&lt;?&gt;&gt; supertypes) {</span>
<span class="udiff-line-removed">-         if (!supertypes.contains(cls)) {</span>
<span class="udiff-line-removed">-             supertypes.add(cls);</span>
<span class="udiff-line-removed">-             Class&lt;?&gt; superclass = cls.getSuperclass();</span>
<span class="udiff-line-removed">-             if (superclass != null) {</span>
<span class="udiff-line-removed">-                 gatherSupertypes(superclass, supertypes);</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             for (Class&lt;?&gt; iface : cls.getInterfaces()) {</span>
<span class="udiff-line-removed">-                 gatherSupertypes(iface, supertypes);</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     /**</span>
<span class="udiff-line-removed">-      * Updates modules specified in {@code AddExport} annotations on {@code classes} to export</span>
<span class="udiff-line-removed">-      * concealed packages to the annotation classes&#39; declaring modules.</span>
<span class="udiff-line-removed">-      */</span>
<span class="udiff-line-removed">-     private static void addExports(Set&lt;Class&lt;?&gt;&gt; classes, PrintStream out) {</span>
<span class="udiff-line-removed">-         Set&lt;Class&lt;?&gt;&gt; types = new HashSet&lt;&gt;();</span>
<span class="udiff-line-removed">-         for (Class&lt;?&gt; cls : classes) {</span>
<span class="udiff-line-removed">-             gatherSupertypes(cls, types);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         for (Class&lt;?&gt; cls : types) {</span>
<span class="udiff-line-removed">-             Annotation[] annos = cls.getAnnotations();</span>
<span class="udiff-line-removed">-             for (Annotation a : annos) {</span>
<span class="udiff-line-removed">-                 Class&lt;? extends Annotation&gt; annotationType = a.annotationType();</span>
<span class="udiff-line-removed">-                 if (annotationType.getSimpleName().equals(&quot;AddExports&quot;)) {</span>
<span class="udiff-line-removed">-                     Optional&lt;String[]&gt; value = getElement(&quot;value&quot;, String[].class, a);</span>
<span class="udiff-line-removed">-                     if (value.isPresent()) {</span>
<span class="udiff-line-removed">-                         for (String export : value.get()) {</span>
<span class="udiff-line-removed">-                             Matcher m = MODULE_PACKAGE_RE.matcher(export);</span>
<span class="udiff-line-removed">-                             if (m.matches()) {</span>
<span class="udiff-line-removed">-                                 String moduleName = m.group(1);</span>
<span class="udiff-line-removed">-                                 String packageName = m.group(2);</span>
<span class="udiff-line-removed">-                                 JLModule module = JLModule.find(moduleName);</span>
<span class="udiff-line-removed">-                                 if (module == null) {</span>
<span class="udiff-line-removed">-                                     out.printf(&quot;%s: Cannot find module named %s specified in \&quot;AddExports\&quot; annotation: %s%n&quot;, cls.getName(), moduleName, a);</span>
<span class="udiff-line-removed">-                                 } else {</span>
<span class="udiff-line-removed">-                                     if (packageName.equals(&quot;*&quot;)) {</span>
<span class="udiff-line-removed">-                                         module.exportAllPackagesTo(JLModule.fromClass(cls));</span>
<span class="udiff-line-removed">-                                     } else {</span>
<span class="udiff-line-removed">-                                         module.addExports(packageName, JLModule.fromClass(cls));</span>
<span class="udiff-line-removed">-                                         module.addOpens(packageName, JLModule.fromClass(cls));</span>
<span class="udiff-line-removed">-                                     }</span>
<span class="udiff-line-removed">-                                 }</span>
<span class="udiff-line-removed">-                             } else {</span>
<span class="udiff-line-removed">-                                 out.printf(&quot;%s: Ignoring \&quot;AddExports\&quot; annotation with value not matching &lt;module&gt;/&lt;package&gt; pattern: %s%n&quot;, cls.getName(), a);</span>
<span class="udiff-line-removed">-                             }</span>
<span class="udiff-line-removed">-                         }</span>
<span class="udiff-line-removed">-                     } else {</span>
<span class="udiff-line-removed">-                         out.printf(&quot;%s: Ignoring \&quot;AddExports\&quot; annotation without `String value` element: %s%n&quot;, cls.getName(), a);</span>
<span class="udiff-line-removed">-                     }</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     /**</span>
<span class="udiff-line-removed">-      * Gets the value of the element named {@code name} of type {@code type} from {@code annotation}</span>
<span class="udiff-line-removed">-      * if present.</span>
<span class="udiff-line-removed">-      *</span>
<span class="udiff-line-removed">-      * @return the requested element value wrapped in an {@link Optional} or</span>
<span class="udiff-line-removed">-      *         {@link Optional#empty()} if {@code annotation} has no element named {@code name}</span>
<span class="udiff-line-removed">-      * @throws AssertionError if {@code annotation} has an element of the given name but whose type</span>
<span class="udiff-line-removed">-      *             is not {@code type} or if there&#39;s some problem reading the value via reflection</span>
<span class="udiff-line-removed">-      */</span>
<span class="udiff-line-removed">-     private static &lt;T&gt; Optional&lt;T&gt; getElement(String name, Class&lt;T&gt; type, Annotation annotation) {</span>
<span class="udiff-line-removed">-         Class&lt;? extends Annotation&gt; annotationType = annotation.annotationType();</span>
<span class="udiff-line-removed">-         Method valueAccessor;</span>
<span class="udiff-line-removed">-         try {</span>
<span class="udiff-line-removed">-             valueAccessor = annotationType.getMethod(name);</span>
<span class="udiff-line-removed">-             if (!valueAccessor.getReturnType().equals(type)) {</span>
<span class="udiff-line-removed">-                 throw new AssertionError(String.format(&quot;Element %s of %s is of type %s, not %s &quot;, name, annotationType.getName(), valueAccessor.getReturnType().getName(), type.getName()));</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-         } catch (NoSuchMethodException e) {</span>
<span class="udiff-line-removed">-             return Optional.empty();</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         try {</span>
<span class="udiff-line-removed">-             return Optional.of(type.cast(valueAccessor.invoke(annotation)));</span>
<span class="udiff-line-removed">-         } catch (Exception e) {</span>
<span class="udiff-line-removed">-             throw new AssertionError(String.format(&quot;Could not read %s element from %s&quot;, name, annotation), e);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
      /**
       * Expand any arguments starting with @ and return the resulting argument array.
       *
       * @return the expanded argument array
       */
</pre>
<center><a href="FindClassesByAnnotatedMethods.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="TextRunListener.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>