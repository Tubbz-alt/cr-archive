<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff test/hotspot/jtreg/compiler/graalunit/com.oracle.mxtool.junit/com/oracle/mxtool/junit/FindClassesByAnnotatedMethods.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../UtilTest.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="MxJUnitWrapper.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/jtreg/compiler/graalunit/com.oracle.mxtool.junit/com/oracle/mxtool/junit/FindClassesByAnnotatedMethods.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 71,21 ***</span>
              Enumeration&lt;JarEntry&gt; e = jarFile.entries();
              int unsupportedClasses = 0;
              System.out.print(jarFilePath);
              while (e.hasMoreElements()) {
                  JarEntry je = e.nextElement();
<span class="line-modified">!                 if (je.isDirectory() || !je.getName().endsWith(&quot;.class&quot;)) {</span>
                      continue;
                  }
                  Set&lt;String&gt; methodAnnotationTypes = new HashSet&lt;&gt;();
                  DataInputStream stream = new DataInputStream(new BufferedInputStream(jarFile.getInputStream(je), (int) je.getSize()));
                  boolean isSupported = true;
                  try {
                      readClassfile(stream, methodAnnotationTypes);
                  } catch (UnsupportedClassVersionError ucve) {
                      isSupported = false;
                      unsupportedClasses++;
                  }
                  String className = je.getName().substring(0, je.getName().length() - &quot;.class&quot;.length()).replaceAll(&quot;/&quot;, &quot;.&quot;);
                  if (!isSupported) {
                      System.out.print(&quot; !&quot; + className);
                  }
<span class="line-new-header">--- 71,23 ---</span>
              Enumeration&lt;JarEntry&gt; e = jarFile.entries();
              int unsupportedClasses = 0;
              System.out.print(jarFilePath);
              while (e.hasMoreElements()) {
                  JarEntry je = e.nextElement();
<span class="line-modified">!                 if (je.isDirectory() || !je.getName().endsWith(&quot;.class&quot;) || je.getName().equals(&quot;module-info.class&quot;)) {</span>
                      continue;
                  }
                  Set&lt;String&gt; methodAnnotationTypes = new HashSet&lt;&gt;();
                  DataInputStream stream = new DataInputStream(new BufferedInputStream(jarFile.getInputStream(je), (int) je.getSize()));
                  boolean isSupported = true;
                  try {
                      readClassfile(stream, methodAnnotationTypes);
                  } catch (UnsupportedClassVersionError ucve) {
                      isSupported = false;
                      unsupportedClasses++;
<span class="line-added">+                 } catch (Throwable t) {</span>
<span class="line-added">+                     throw new InternalError(&quot;Error while parsing class from &quot; + je + &quot; in &quot; + jarFilePath, t);</span>
                  }
                  String className = je.getName().substring(0, je.getName().length() - &quot;.class&quot;.length()).replaceAll(&quot;/&quot;, &quot;.&quot;);
                  if (!isSupported) {
                      System.out.print(&quot; !&quot; + className);
                  }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 127,11 ***</span>
      }
  
      /*
       * Small bytecode parser that extract annotations.
       */
<span class="line-modified">!     private static final int MAJOR_VERSION_JAVA7 = 51;</span>
      private static final int MAJOR_VERSION_OFFSET = 44;
      private static final byte CONSTANT_Utf8 = 1;
      private static final byte CONSTANT_Integer = 3;
      private static final byte CONSTANT_Float = 4;
      private static final byte CONSTANT_Long = 5;
<span class="line-new-header">--- 129,11 ---</span>
      }
  
      /*
       * Small bytecode parser that extract annotations.
       */
<span class="line-modified">!     private static final int MAJOR_VERSION_JAVA6 = 50;</span>
      private static final int MAJOR_VERSION_OFFSET = 44;
      private static final byte CONSTANT_Utf8 = 1;
      private static final byte CONSTANT_Integer = 3;
      private static final byte CONSTANT_Float = 4;
      private static final byte CONSTANT_Long = 5;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 144,19 ***</span>
      private static final byte CONSTANT_NameAndType = 12;
      private static final byte CONSTANT_MethodHandle = 15;
      private static final byte CONSTANT_MethodType = 16;
      private static final byte CONSTANT_Dynamic = 17;
      private static final byte CONSTANT_InvokeDynamic = 18;
  
      private static void readClassfile(DataInputStream stream, Collection&lt;String&gt; methodAnnotationTypes) throws IOException {
          // magic
          int magic = stream.readInt();
          assert magic == 0xCAFEBABE;
  
          int minor = stream.readUnsignedShort();
          int major = stream.readUnsignedShort();
<span class="line-modified">!         if (major &lt; MAJOR_VERSION_JAVA7) {</span>
              throw new UnsupportedClassVersionError(&quot;Unsupported class file version: &quot; + major + &quot;.&quot; + minor);
          }
          // Starting with JDK8, ignore a classfile that has a newer format than the current JDK.
          String javaVersion = System.getProperties().get(&quot;java.specification.version&quot;).toString();
          int majorJavaVersion;
<span class="line-new-header">--- 146,21 ---</span>
      private static final byte CONSTANT_NameAndType = 12;
      private static final byte CONSTANT_MethodHandle = 15;
      private static final byte CONSTANT_MethodType = 16;
      private static final byte CONSTANT_Dynamic = 17;
      private static final byte CONSTANT_InvokeDynamic = 18;
<span class="line-added">+     private static final byte CONSTANT_Module = 19;</span>
<span class="line-added">+     private static final byte CONSTANT_Package = 20;</span>
  
      private static void readClassfile(DataInputStream stream, Collection&lt;String&gt; methodAnnotationTypes) throws IOException {
          // magic
          int magic = stream.readInt();
          assert magic == 0xCAFEBABE;
  
          int minor = stream.readUnsignedShort();
          int major = stream.readUnsignedShort();
<span class="line-modified">!         if (major &lt; MAJOR_VERSION_JAVA6) {</span>
              throw new UnsupportedClassVersionError(&quot;Unsupported class file version: &quot; + major + &quot;.&quot; + minor);
          }
          // Starting with JDK8, ignore a classfile that has a newer format than the current JDK.
          String javaVersion = System.getProperties().get(&quot;java.specification.version&quot;).toString();
          int majorJavaVersion;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 208,11 ***</span>
          while (i &lt; count) {
              byte tag = stream.readByte();
              switch (tag) {
                  case CONSTANT_Class:
                  case CONSTANT_String:
<span class="line-modified">!                 case CONSTANT_MethodType: {</span>
                      skipFully(stream, 2);
                      break;
                  }
                  case CONSTANT_InterfaceMethodref:
                  case CONSTANT_Methodref:
<span class="line-new-header">--- 212,13 ---</span>
          while (i &lt; count) {
              byte tag = stream.readByte();
              switch (tag) {
                  case CONSTANT_Class:
                  case CONSTANT_String:
<span class="line-modified">!                 case CONSTANT_MethodType:</span>
<span class="line-added">+                 case CONSTANT_Module:</span>
<span class="line-added">+                 case CONSTANT_Package: {</span>
                      skipFully(stream, 2);
                      break;
                  }
                  case CONSTANT_InterfaceMethodref:
                  case CONSTANT_Methodref:
</pre>
<center><a href="../../../../../UtilTest.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="MxJUnitWrapper.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>