<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/hotspot/jtreg/compiler/intrinsics/klass/CastNullCheckDroppingsTest.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="../base64/TestBase64.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="TestIsPrimitive.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/jtreg/compiler/intrinsics/klass/CastNullCheckDroppingsTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2014, 2016, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test NullCheckDroppingsTest
 26  * @bug 8054492
 27  * @summary Casting can result in redundant null checks in generated code

 28  * @requires vm.flavor == &quot;server&quot; &amp; !vm.emulatedClient &amp; !vm.graal.enabled
 29  * @library /test/lib
 30  * @modules java.base/jdk.internal.misc
 31  *          java.management
 32  *
 33  * @build sun.hotspot.WhiteBox
 34  * @run driver ClassFileInstaller sun.hotspot.WhiteBox
 35  *                                sun.hotspot.WhiteBox$WhiteBoxPermission
 36  * @run main/othervm -Xbootclasspath/a:. -XX:+IgnoreUnrecognizedVMOptions -XX:+UnlockDiagnosticVMOptions -XX:+WhiteBoxAPI
 37  *                   -Xmixed -XX:-BackgroundCompilation -XX:-TieredCompilation -XX:CompileThreshold=1000
 38  *                   -XX:CompileCommand=exclude,compiler.intrinsics.klass.CastNullCheckDroppingsTest::runTest
 39  *                   compiler.intrinsics.klass.CastNullCheckDroppingsTest
 40  */
 41 
 42 package compiler.intrinsics.klass;
 43 


 44 import jdk.test.lib.Platform;


 45 import sun.hotspot.WhiteBox;
 46 import sun.hotspot.code.NMethod;
 47 

 48 import java.lang.invoke.MethodHandle;
 49 import java.lang.invoke.MethodHandles;
 50 import java.lang.invoke.MethodType;
 51 import java.lang.reflect.Method;

 52 import java.util.function.BiFunction;
 53 
 54 public class CastNullCheckDroppingsTest {
 55 
 56     private static final WhiteBox WHITE_BOX = WhiteBox.getWhiteBox();
 57 
 58     static final BiFunction&lt;Class, Object, Object&gt; fCast = (c, o) -&gt; c.cast(o);
 59 
 60     static final MethodHandle SET_SSINK;
 61     static final MethodHandle MH_CAST;
 62 
 63     static {
 64         try {
 65             SET_SSINK = MethodHandles.lookup().findSetter(CastNullCheckDroppingsTest.class, &quot;ssink&quot;, String.class);
 66             MH_CAST = MethodHandles.lookup().findVirtual(Class.class,
 67                                                          &quot;cast&quot;,
 68                                                          MethodType.methodType(Object.class, Object.class));
 69         }
 70         catch (Exception e) {
 71             throw new Error(e);
 72         }
 73     }
 74 
 75     static volatile String svalue = &quot;A&quot;;
<span class="line-modified"> 76     static volatile String snull = null;</span>
 77     static volatile Integer iobj = new Integer(0);
 78     static volatile int[] arr = new int[2];
 79     static volatile Class objClass = String.class;
 80     static volatile Class nullClass = null;
 81 
 82     String  ssink;
 83     Integer isink;
 84     int[]   asink;
 85 
 86     public static void main(String[] args) throws Exception {
 87         if (!Platform.isServer() || Platform.isEmulatedClient()) {
 88             throw new Error(&quot;TESTBUG: Not server mode&quot;);
 89         }
 90         // Make sure background compilation is disabled
 91         if (WHITE_BOX.getBooleanVMFlag(&quot;BackgroundCompilation&quot;)) {
 92             throw new Error(&quot;TESTBUG: Background compilation enabled&quot;);
 93         }
 94         // Make sure Tiered compilation is disabled
 95         if (WHITE_BOX.getBooleanVMFlag(&quot;TieredCompilation&quot;)) {
 96             throw new Error(&quot;TESTBUG: Tiered compilation enabled&quot;);
 97         }
 98 
 99         Method methodClassCast = CastNullCheckDroppingsTest.class.getDeclaredMethod(&quot;testClassCast&quot;, String.class);
100         Method methodMHCast    = CastNullCheckDroppingsTest.class.getDeclaredMethod(&quot;testMHCast&quot;,    String.class);
101         Method methodMHSetter  = CastNullCheckDroppingsTest.class.getDeclaredMethod(&quot;testMHSetter&quot;,  String.class);
102         Method methodFunction  = CastNullCheckDroppingsTest.class.getDeclaredMethod(&quot;testFunction&quot;,  String.class);
103 
104         CastNullCheckDroppingsTest t = new CastNullCheckDroppingsTest();
<span class="line-modified">105         t.runTest(methodClassCast, false);</span>
<span class="line-modified">106         t.runTest(methodMHCast,    false);</span>
<span class="line-modified">107         t.runTest(methodMHSetter,  false);</span>
<span class="line-modified">108         t.runTest(methodFunction,  false);</span>
109 
110         // Edge cases
111         Method methodClassCastNull = CastNullCheckDroppingsTest.class.getDeclaredMethod(&quot;testClassCastNull&quot;, String.class);
112         Method methodNullClassCast = CastNullCheckDroppingsTest.class.getDeclaredMethod(&quot;testNullClassCast&quot;, String.class);
113         Method methodClassCastObj  = CastNullCheckDroppingsTest.class.getDeclaredMethod(&quot;testClassCastObj&quot;,  Object.class);
114         Method methodObjClassCast  = CastNullCheckDroppingsTest.class.getDeclaredMethod(&quot;testObjClassCast&quot;,  String.class);
<span class="line-removed">115         Method methodVarClassCast  = CastNullCheckDroppingsTest.class.getDeclaredMethod(&quot;testVarClassCast&quot;,  String.class);</span>
116         Method methodClassCastInt  = CastNullCheckDroppingsTest.class.getDeclaredMethod(&quot;testClassCastInt&quot;,  Object.class);
117         Method methodIntClassCast  = CastNullCheckDroppingsTest.class.getDeclaredMethod(&quot;testIntClassCast&quot;,  Object.class);
118         Method methodClassCastint  = CastNullCheckDroppingsTest.class.getDeclaredMethod(&quot;testClassCastint&quot;,  Object.class);
119         Method methodintClassCast  = CastNullCheckDroppingsTest.class.getDeclaredMethod(&quot;testintClassCast&quot;,  Object.class);
120         Method methodClassCastPrim = CastNullCheckDroppingsTest.class.getDeclaredMethod(&quot;testClassCastPrim&quot;, Object.class);
121         Method methodPrimClassCast = CastNullCheckDroppingsTest.class.getDeclaredMethod(&quot;testPrimClassCast&quot;, Object.class);
<span class="line-modified">122 </span>
<span class="line-modified">123         t.runTest(methodClassCastNull, false);</span>
<span class="line-modified">124         t.runTest(methodNullClassCast, false);</span>
<span class="line-modified">125         t.runTest(methodClassCastObj,  false);</span>
<span class="line-modified">126         t.runTest(methodObjClassCast,  true);</span>
<span class="line-modified">127         t.runTest(methodVarClassCast,  true);</span>
<span class="line-modified">128         t.runTest(methodClassCastInt,  false);</span>
<span class="line-modified">129         t.runTest(methodIntClassCast,  true);</span>
<span class="line-modified">130         t.runTest(methodClassCastint,  false);</span>
<span class="line-modified">131         t.runTest(methodintClassCast,  false);</span>
<span class="line-modified">132         t.runTest(methodClassCastPrim, false);</span>
<span class="line-modified">133         t.runTest(methodPrimClassCast, true);</span>

134     }
135 
136     void testClassCast(String s) {
137         try {
138             ssink = String.class.cast(s);
139         } catch (Throwable t) {
140             throw new Error(t);
141         }
142     }
143 
144     void testClassCastNull(String s) {
145         try {
146             ssink = String.class.cast(null);
147         } catch (Throwable t) {
148             throw new Error(t);
149         }
150     }
151 
152     void testNullClassCast(String s) {
153         try {
</pre>
<hr />
<pre>
159             throw new Error(t);
160         }
161     }
162 
163     void testClassCastObj(Object s) {
164         try {
165             ssink = String.class.cast(s);
166         } catch (Throwable t) {
167             throw new Error(t);
168         }
169     }
170 
171     void testObjClassCast(String s) {
172         try {
173             ssink = (String)objClass.cast(s);
174         } catch (Throwable t) {
175             throw new Error(t);
176         }
177     }
178 
<span class="line-modified">179     void testVarClassCast(String s) {</span>
<span class="line-removed">180         Class cl = (s == null) ? null : String.class;</span>
181         try {
182             ssink = (String)cl.cast(svalue);
<span class="line-modified">183             if (s == null) {</span>
184                 throw new AssertionError(&quot;NullPointerException is not thrown&quot;);
185             }
186         } catch (NullPointerException t) {
187             // Ignore NullPointerException
188         } catch (Throwable t) {
189             throw new Error(t);
190         }
191     }
192 
193     void testClassCastInt(Object s) {
194         try {
195             ssink = String.class.cast(iobj);
196             throw new AssertionError(&quot;ClassCastException is not thrown&quot;);
197         } catch (ClassCastException t) {
198             // Ignore ClassCastException: Cannot cast java.lang.Integer to java.lang.String
199         } catch (Throwable t) {
200             throw new Error(t);
201         }
202     }
203 
</pre>
<hr />
<pre>
269             throw new Error(t);
270         }
271     }
272 
273     void testMHSetter(String s) {
274         try {
275             SET_SSINK.invokeExact(this, s);
276         } catch (Throwable t) {
277             throw new Error(t);
278         }
279     }
280 
281     void testFunction(String s) {
282         try {
283             ssink = (String) fCast.apply(String.class, s);
284         } catch (Throwable t) {
285             throw new Error(t);
286         }
287     }
288 
<span class="line-modified">289     void runTest(Method method, boolean deopt) {</span>
290         if (method == null) {
291             throw new AssertionError(&quot;method was not found&quot;);
292         }
293         // Ensure method is compiled
294         WHITE_BOX.testSetDontInlineMethod(method, true);




295         for (int i = 0; i &lt; 3000; i++) {
296             try {
<span class="line-modified">297                 method.invoke(this, svalue);</span>
298             } catch (Exception e) {
299                 throw new Error(&quot;Unexpected exception: &quot;, e);
300             }
301         }
302         NMethod nm = getNMethod(method);
303 
304         // Passing null should cause a de-optimization
305         // if method is compiled with a null-check.
306         try {
<span class="line-modified">307             method.invoke(this, snull);</span>
308         } catch (Exception e) {
309             throw new Error(&quot;Unexpected exception: &quot;, e);
310         }
<span class="line-modified">311         checkDeoptimization(method, nm, deopt);</span>












312     }
313 
314     static NMethod getNMethod(Method test) {
315         // Because background compilation is disabled, method should now be compiled
316         if (!WHITE_BOX.isMethodCompiled(test)) {
317             throw new AssertionError(test + &quot; not compiled&quot;);
318         }
319 
320         NMethod nm = NMethod.get(test, false); // not OSR nmethod
321         if (nm == null) {
322             throw new AssertionError(test + &quot; missing nmethod?&quot;);
323         }
324         if (nm.comp_level != 4) {
325             throw new AssertionError(test + &quot; compiled by not C2: &quot; + nm);
326         }
327         return nm;
328     }
329 
<span class="line-modified">330     static void checkDeoptimization(Method method, NMethod nmOrig, boolean deopt) {</span>
<span class="line-modified">331         // Check deoptimization event (intrinsic Class.cast() works).</span>
<span class="line-modified">332         if (WHITE_BOX.isMethodCompiled(method) == deopt) {</span>
<span class="line-modified">333             throw new AssertionError(method + &quot; was&quot; + (deopt ? &quot; not&quot; : &quot;&quot;) + &quot; deoptimized&quot;);</span>





334         }
<span class="line-modified">335         if (deopt) {</span>
<span class="line-modified">336             return;</span>






337         }
<span class="line-modified">338         // Ensure no recompilation when no deoptimization is expected.</span>



339         NMethod nm = NMethod.get(method, false); // not OSR nmethod
340         if (nm == null) {
341             throw new AssertionError(method + &quot; missing nmethod?&quot;);
342         }
343         if (nm.comp_level != 4) {
344             throw new AssertionError(method + &quot; compiled by not C2: &quot; + nm);
345         }
346         if (nm.compile_id != nmOrig.compile_id) {
347             throw new AssertionError(method + &quot; was recompiled: old nmethod=&quot; + nmOrig + &quot;, new nmethod=&quot; + nm);
348         }
349     }
350 }
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2014, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test NullCheckDroppingsTest
 26  * @bug 8054492
 27  * @summary Casting can result in redundant null checks in generated code
<span class="line-added"> 28  * @requires vm.hasJFR</span>
 29  * @requires vm.flavor == &quot;server&quot; &amp; !vm.emulatedClient &amp; !vm.graal.enabled
 30  * @library /test/lib
 31  * @modules java.base/jdk.internal.misc
 32  *          java.management
 33  *
 34  * @build sun.hotspot.WhiteBox
 35  * @run driver ClassFileInstaller sun.hotspot.WhiteBox
 36  *                                sun.hotspot.WhiteBox$WhiteBoxPermission
 37  * @run main/othervm -Xbootclasspath/a:. -XX:+IgnoreUnrecognizedVMOptions -XX:+UnlockDiagnosticVMOptions -XX:+WhiteBoxAPI
 38  *                   -Xmixed -XX:-BackgroundCompilation -XX:-TieredCompilation -XX:CompileThreshold=1000
 39  *                   -XX:CompileCommand=exclude,compiler.intrinsics.klass.CastNullCheckDroppingsTest::runTest
 40  *                   compiler.intrinsics.klass.CastNullCheckDroppingsTest
 41  */
 42 
 43 package compiler.intrinsics.klass;
 44 
<span class="line-added"> 45 import jdk.jfr.Recording;</span>
<span class="line-added"> 46 import jdk.jfr.consumer.RecordedEvent;</span>
 47 import jdk.test.lib.Platform;
<span class="line-added"> 48 import jdk.test.lib.jfr.EventNames;</span>
<span class="line-added"> 49 import jdk.test.lib.jfr.Events;</span>
 50 import sun.hotspot.WhiteBox;
 51 import sun.hotspot.code.NMethod;
 52 
<span class="line-added"> 53 import java.io.IOException;</span>
 54 import java.lang.invoke.MethodHandle;
 55 import java.lang.invoke.MethodHandles;
 56 import java.lang.invoke.MethodType;
 57 import java.lang.reflect.Method;
<span class="line-added"> 58 import java.util.List;</span>
 59 import java.util.function.BiFunction;
 60 
 61 public class CastNullCheckDroppingsTest {
 62 
 63     private static final WhiteBox WHITE_BOX = WhiteBox.getWhiteBox();
 64 
 65     static final BiFunction&lt;Class, Object, Object&gt; fCast = (c, o) -&gt; c.cast(o);
 66 
 67     static final MethodHandle SET_SSINK;
 68     static final MethodHandle MH_CAST;
 69 
 70     static {
 71         try {
 72             SET_SSINK = MethodHandles.lookup().findSetter(CastNullCheckDroppingsTest.class, &quot;ssink&quot;, String.class);
 73             MH_CAST = MethodHandles.lookup().findVirtual(Class.class,
 74                                                          &quot;cast&quot;,
 75                                                          MethodType.methodType(Object.class, Object.class));
 76         }
 77         catch (Exception e) {
 78             throw new Error(e);
 79         }
 80     }
 81 
 82     static volatile String svalue = &quot;A&quot;;
<span class="line-modified"> 83     static volatile Object onull = null;</span>
 84     static volatile Integer iobj = new Integer(0);
 85     static volatile int[] arr = new int[2];
 86     static volatile Class objClass = String.class;
 87     static volatile Class nullClass = null;
 88 
 89     String  ssink;
 90     Integer isink;
 91     int[]   asink;
 92 
 93     public static void main(String[] args) throws Exception {
 94         if (!Platform.isServer() || Platform.isEmulatedClient()) {
 95             throw new Error(&quot;TESTBUG: Not server mode&quot;);
 96         }
 97         // Make sure background compilation is disabled
 98         if (WHITE_BOX.getBooleanVMFlag(&quot;BackgroundCompilation&quot;)) {
 99             throw new Error(&quot;TESTBUG: Background compilation enabled&quot;);
100         }
101         // Make sure Tiered compilation is disabled
102         if (WHITE_BOX.getBooleanVMFlag(&quot;TieredCompilation&quot;)) {
103             throw new Error(&quot;TESTBUG: Tiered compilation enabled&quot;);
104         }
105 
106         Method methodClassCast = CastNullCheckDroppingsTest.class.getDeclaredMethod(&quot;testClassCast&quot;, String.class);
107         Method methodMHCast    = CastNullCheckDroppingsTest.class.getDeclaredMethod(&quot;testMHCast&quot;,    String.class);
108         Method methodMHSetter  = CastNullCheckDroppingsTest.class.getDeclaredMethod(&quot;testMHSetter&quot;,  String.class);
109         Method methodFunction  = CastNullCheckDroppingsTest.class.getDeclaredMethod(&quot;testFunction&quot;,  String.class);
110 
111         CastNullCheckDroppingsTest t = new CastNullCheckDroppingsTest();
<span class="line-modified">112         t.runTest(methodClassCast, false, svalue);</span>
<span class="line-modified">113         t.runTest(methodMHCast,    false, svalue);</span>
<span class="line-modified">114         t.runTest(methodMHSetter,  false, svalue);</span>
<span class="line-modified">115         t.runTest(methodFunction,  false, svalue);</span>
116 
117         // Edge cases
118         Method methodClassCastNull = CastNullCheckDroppingsTest.class.getDeclaredMethod(&quot;testClassCastNull&quot;, String.class);
119         Method methodNullClassCast = CastNullCheckDroppingsTest.class.getDeclaredMethod(&quot;testNullClassCast&quot;, String.class);
120         Method methodClassCastObj  = CastNullCheckDroppingsTest.class.getDeclaredMethod(&quot;testClassCastObj&quot;,  Object.class);
121         Method methodObjClassCast  = CastNullCheckDroppingsTest.class.getDeclaredMethod(&quot;testObjClassCast&quot;,  String.class);

122         Method methodClassCastInt  = CastNullCheckDroppingsTest.class.getDeclaredMethod(&quot;testClassCastInt&quot;,  Object.class);
123         Method methodIntClassCast  = CastNullCheckDroppingsTest.class.getDeclaredMethod(&quot;testIntClassCast&quot;,  Object.class);
124         Method methodClassCastint  = CastNullCheckDroppingsTest.class.getDeclaredMethod(&quot;testClassCastint&quot;,  Object.class);
125         Method methodintClassCast  = CastNullCheckDroppingsTest.class.getDeclaredMethod(&quot;testintClassCast&quot;,  Object.class);
126         Method methodClassCastPrim = CastNullCheckDroppingsTest.class.getDeclaredMethod(&quot;testClassCastPrim&quot;, Object.class);
127         Method methodPrimClassCast = CastNullCheckDroppingsTest.class.getDeclaredMethod(&quot;testPrimClassCast&quot;, Object.class);
<span class="line-modified">128         Method methodVarClassCast  = CastNullCheckDroppingsTest.class.getDeclaredMethod(&quot;testVarClassCast&quot;,  Class.class);</span>
<span class="line-modified">129 </span>
<span class="line-modified">130         t.runTest(methodClassCastNull, false, svalue);</span>
<span class="line-modified">131         t.runTest(methodNullClassCast, false, svalue);</span>
<span class="line-modified">132         t.runTest(methodClassCastObj,  false, svalue);</span>
<span class="line-modified">133         t.runTest(methodObjClassCast,  true,  svalue);</span>
<span class="line-modified">134         t.runTest(methodClassCastInt,  false, svalue);</span>
<span class="line-modified">135         t.runTest(methodIntClassCast,  true,  svalue);</span>
<span class="line-modified">136         t.runTest(methodClassCastint,  false, svalue);</span>
<span class="line-modified">137         t.runTest(methodintClassCast,  false, svalue);</span>
<span class="line-modified">138         t.runTest(methodClassCastPrim, false, svalue);</span>
<span class="line-modified">139         t.runTest(methodPrimClassCast, true,  svalue);</span>
<span class="line-added">140         t.runTest(methodVarClassCast,  true,  objClass);</span>
141     }
142 
143     void testClassCast(String s) {
144         try {
145             ssink = String.class.cast(s);
146         } catch (Throwable t) {
147             throw new Error(t);
148         }
149     }
150 
151     void testClassCastNull(String s) {
152         try {
153             ssink = String.class.cast(null);
154         } catch (Throwable t) {
155             throw new Error(t);
156         }
157     }
158 
159     void testNullClassCast(String s) {
160         try {
</pre>
<hr />
<pre>
166             throw new Error(t);
167         }
168     }
169 
170     void testClassCastObj(Object s) {
171         try {
172             ssink = String.class.cast(s);
173         } catch (Throwable t) {
174             throw new Error(t);
175         }
176     }
177 
178     void testObjClassCast(String s) {
179         try {
180             ssink = (String)objClass.cast(s);
181         } catch (Throwable t) {
182             throw new Error(t);
183         }
184     }
185 
<span class="line-modified">186     void testVarClassCast(Class cl) {</span>

187         try {
188             ssink = (String)cl.cast(svalue);
<span class="line-modified">189             if (cl == null) {</span>
190                 throw new AssertionError(&quot;NullPointerException is not thrown&quot;);
191             }
192         } catch (NullPointerException t) {
193             // Ignore NullPointerException
194         } catch (Throwable t) {
195             throw new Error(t);
196         }
197     }
198 
199     void testClassCastInt(Object s) {
200         try {
201             ssink = String.class.cast(iobj);
202             throw new AssertionError(&quot;ClassCastException is not thrown&quot;);
203         } catch (ClassCastException t) {
204             // Ignore ClassCastException: Cannot cast java.lang.Integer to java.lang.String
205         } catch (Throwable t) {
206             throw new Error(t);
207         }
208     }
209 
</pre>
<hr />
<pre>
275             throw new Error(t);
276         }
277     }
278 
279     void testMHSetter(String s) {
280         try {
281             SET_SSINK.invokeExact(this, s);
282         } catch (Throwable t) {
283             throw new Error(t);
284         }
285     }
286 
287     void testFunction(String s) {
288         try {
289             ssink = (String) fCast.apply(String.class, s);
290         } catch (Throwable t) {
291             throw new Error(t);
292         }
293     }
294 
<span class="line-modified">295     void runTest(Method method, boolean deopt, Object value) {</span>
296         if (method == null) {
297             throw new AssertionError(&quot;method was not found&quot;);
298         }
299         // Ensure method is compiled
300         WHITE_BOX.testSetDontInlineMethod(method, true);
<span class="line-added">301         Recording recording = new Recording();</span>
<span class="line-added">302         recording.enable(EventNames.Deoptimization);</span>
<span class="line-added">303         recording.start();</span>
<span class="line-added">304 </span>
305         for (int i = 0; i &lt; 3000; i++) {
306             try {
<span class="line-modified">307                 method.invoke(this, value);</span>
308             } catch (Exception e) {
309                 throw new Error(&quot;Unexpected exception: &quot;, e);
310             }
311         }
312         NMethod nm = getNMethod(method);
313 
314         // Passing null should cause a de-optimization
315         // if method is compiled with a null-check.
316         try {
<span class="line-modified">317             method.invoke(this, onull);</span>
318         } catch (Exception e) {
319             throw new Error(&quot;Unexpected exception: &quot;, e);
320         }
<span class="line-modified">321         recording.stop();</span>
<span class="line-added">322         List&lt;RecordedEvent&gt; events;</span>
<span class="line-added">323         try {</span>
<span class="line-added">324             events = Events.fromRecording(recording);</span>
<span class="line-added">325         } catch (IOException e) {</span>
<span class="line-added">326             throw new Error(&quot;failed to read jfr events&quot;, e);</span>
<span class="line-added">327         }</span>
<span class="line-added">328 </span>
<span class="line-added">329         checkDeoptimization(events, nm.compile_id, deopt);</span>
<span class="line-added">330 </span>
<span class="line-added">331         if (!deopt) {</span>
<span class="line-added">332             checkNoRecompilation(method, nm);</span>
<span class="line-added">333         }</span>
334     }
335 
336     static NMethod getNMethod(Method test) {
337         // Because background compilation is disabled, method should now be compiled
338         if (!WHITE_BOX.isMethodCompiled(test)) {
339             throw new AssertionError(test + &quot; not compiled&quot;);
340         }
341 
342         NMethod nm = NMethod.get(test, false); // not OSR nmethod
343         if (nm == null) {
344             throw new AssertionError(test + &quot; missing nmethod?&quot;);
345         }
346         if (nm.comp_level != 4) {
347             throw new AssertionError(test + &quot; compiled by not C2: &quot; + nm);
348         }
349         return nm;
350     }
351 
<span class="line-modified">352     static void checkDeoptimization(List&lt;RecordedEvent&gt; events, int compilerId, boolean mustExist) {</span>
<span class="line-modified">353         boolean exist = events.stream()</span>
<span class="line-modified">354                 .filter(e -&gt; e.getEventType().getName().equals(EventNames.Deoptimization))</span>
<span class="line-modified">355                 .anyMatch(e -&gt; compilerId == Events.assertField(e, &quot;compileId&quot;).&lt;Integer&gt;getValue());</span>
<span class="line-added">356 </span>
<span class="line-added">357         if (exist != mustExist) {</span>
<span class="line-added">358             System.err.println(&quot;events:&quot;);</span>
<span class="line-added">359             System.err.println(events);</span>
<span class="line-added">360             throw new AssertionError(&quot;compilation must &quot; + (mustExist ? &quot;&quot; : &quot; not &quot;) + &quot; got deoptimized&quot;);</span>
361         }
<span class="line-modified">362 </span>
<span class="line-modified">363         if (mustExist &amp;&amp; events.stream()</span>
<span class="line-added">364                   .filter(e -&gt; e.getEventType().getName().equals(EventNames.Deoptimization))</span>
<span class="line-added">365                   .filter(e -&gt; compilerId == Events.assertField(e, &quot;compileId&quot;).&lt;Integer&gt;getValue())</span>
<span class="line-added">366                   .noneMatch(e -&gt; &quot;null_check&quot;.equals(Events.assertField(e, &quot;reason&quot;).getValue()))) {</span>
<span class="line-added">367             System.err.println(&quot;events:&quot;);</span>
<span class="line-added">368             System.err.println(events);</span>
<span class="line-added">369             throw new AssertionError(&quot;no deoptimizations due to null_check found&quot;);</span>
370         }
<span class="line-modified">371 </span>
<span class="line-added">372     }</span>
<span class="line-added">373 </span>
<span class="line-added">374     static void checkNoRecompilation(Method method, NMethod nmOrig) {</span>
375         NMethod nm = NMethod.get(method, false); // not OSR nmethod
376         if (nm == null) {
377             throw new AssertionError(method + &quot; missing nmethod?&quot;);
378         }
379         if (nm.comp_level != 4) {
380             throw new AssertionError(method + &quot; compiled by not C2: &quot; + nm);
381         }
382         if (nm.compile_id != nmOrig.compile_id) {
383             throw new AssertionError(method + &quot; was recompiled: old nmethod=&quot; + nmOrig + &quot;, new nmethod=&quot; + nm);
384         }
385     }
386 }
</pre>
</td>
</tr>
</table>
<center><a href="../base64/TestBase64.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="TestIsPrimitive.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>