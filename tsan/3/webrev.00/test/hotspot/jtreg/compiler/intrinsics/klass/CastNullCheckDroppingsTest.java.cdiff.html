<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff test/hotspot/jtreg/compiler/intrinsics/klass/CastNullCheckDroppingsTest.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="../base64/TestBase64.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="TestIsPrimitive.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/jtreg/compiler/intrinsics/klass/CastNullCheckDroppingsTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2014, 2016, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2014, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 23,10 ***</span>
<span class="line-new-header">--- 23,11 ---</span>
  
  /*
   * @test NullCheckDroppingsTest
   * @bug 8054492
   * @summary Casting can result in redundant null checks in generated code
<span class="line-added">+  * @requires vm.hasJFR</span>
   * @requires vm.flavor == &quot;server&quot; &amp; !vm.emulatedClient &amp; !vm.graal.enabled
   * @library /test/lib
   * @modules java.base/jdk.internal.misc
   *          java.management
   *
</pre>
<hr />
<pre>
<span class="line-old-header">*** 39,18 ***</span>
<span class="line-new-header">--- 40,24 ---</span>
   *                   compiler.intrinsics.klass.CastNullCheckDroppingsTest
   */
  
  package compiler.intrinsics.klass;
  
<span class="line-added">+ import jdk.jfr.Recording;</span>
<span class="line-added">+ import jdk.jfr.consumer.RecordedEvent;</span>
  import jdk.test.lib.Platform;
<span class="line-added">+ import jdk.test.lib.jfr.EventNames;</span>
<span class="line-added">+ import jdk.test.lib.jfr.Events;</span>
  import sun.hotspot.WhiteBox;
  import sun.hotspot.code.NMethod;
  
<span class="line-added">+ import java.io.IOException;</span>
  import java.lang.invoke.MethodHandle;
  import java.lang.invoke.MethodHandles;
  import java.lang.invoke.MethodType;
  import java.lang.reflect.Method;
<span class="line-added">+ import java.util.List;</span>
  import java.util.function.BiFunction;
  
  public class CastNullCheckDroppingsTest {
  
      private static final WhiteBox WHITE_BOX = WhiteBox.getWhiteBox();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 71,11 ***</span>
              throw new Error(e);
          }
      }
  
      static volatile String svalue = &quot;A&quot;;
<span class="line-modified">!     static volatile String snull = null;</span>
      static volatile Integer iobj = new Integer(0);
      static volatile int[] arr = new int[2];
      static volatile Class objClass = String.class;
      static volatile Class nullClass = null;
  
<span class="line-new-header">--- 78,11 ---</span>
              throw new Error(e);
          }
      }
  
      static volatile String svalue = &quot;A&quot;;
<span class="line-modified">!     static volatile Object onull = null;</span>
      static volatile Integer iobj = new Integer(0);
      static volatile int[] arr = new int[2];
      static volatile Class objClass = String.class;
      static volatile Class nullClass = null;
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 100,39 ***</span>
          Method methodMHCast    = CastNullCheckDroppingsTest.class.getDeclaredMethod(&quot;testMHCast&quot;,    String.class);
          Method methodMHSetter  = CastNullCheckDroppingsTest.class.getDeclaredMethod(&quot;testMHSetter&quot;,  String.class);
          Method methodFunction  = CastNullCheckDroppingsTest.class.getDeclaredMethod(&quot;testFunction&quot;,  String.class);
  
          CastNullCheckDroppingsTest t = new CastNullCheckDroppingsTest();
<span class="line-modified">!         t.runTest(methodClassCast, false);</span>
<span class="line-modified">!         t.runTest(methodMHCast,    false);</span>
<span class="line-modified">!         t.runTest(methodMHSetter,  false);</span>
<span class="line-modified">!         t.runTest(methodFunction,  false);</span>
  
          // Edge cases
          Method methodClassCastNull = CastNullCheckDroppingsTest.class.getDeclaredMethod(&quot;testClassCastNull&quot;, String.class);
          Method methodNullClassCast = CastNullCheckDroppingsTest.class.getDeclaredMethod(&quot;testNullClassCast&quot;, String.class);
          Method methodClassCastObj  = CastNullCheckDroppingsTest.class.getDeclaredMethod(&quot;testClassCastObj&quot;,  Object.class);
          Method methodObjClassCast  = CastNullCheckDroppingsTest.class.getDeclaredMethod(&quot;testObjClassCast&quot;,  String.class);
<span class="line-removed">-         Method methodVarClassCast  = CastNullCheckDroppingsTest.class.getDeclaredMethod(&quot;testVarClassCast&quot;,  String.class);</span>
          Method methodClassCastInt  = CastNullCheckDroppingsTest.class.getDeclaredMethod(&quot;testClassCastInt&quot;,  Object.class);
          Method methodIntClassCast  = CastNullCheckDroppingsTest.class.getDeclaredMethod(&quot;testIntClassCast&quot;,  Object.class);
          Method methodClassCastint  = CastNullCheckDroppingsTest.class.getDeclaredMethod(&quot;testClassCastint&quot;,  Object.class);
          Method methodintClassCast  = CastNullCheckDroppingsTest.class.getDeclaredMethod(&quot;testintClassCast&quot;,  Object.class);
          Method methodClassCastPrim = CastNullCheckDroppingsTest.class.getDeclaredMethod(&quot;testClassCastPrim&quot;, Object.class);
          Method methodPrimClassCast = CastNullCheckDroppingsTest.class.getDeclaredMethod(&quot;testPrimClassCast&quot;, Object.class);
<span class="line-modified">! </span>
<span class="line-modified">!         t.runTest(methodClassCastNull, false);</span>
<span class="line-modified">!         t.runTest(methodNullClassCast, false);</span>
<span class="line-modified">!         t.runTest(methodClassCastObj,  false);</span>
<span class="line-modified">!         t.runTest(methodObjClassCast,  true);</span>
<span class="line-modified">!         t.runTest(methodVarClassCast,  true);</span>
<span class="line-modified">!         t.runTest(methodClassCastInt,  false);</span>
<span class="line-modified">!         t.runTest(methodIntClassCast,  true);</span>
<span class="line-modified">!         t.runTest(methodClassCastint,  false);</span>
<span class="line-modified">!         t.runTest(methodintClassCast,  false);</span>
<span class="line-modified">!         t.runTest(methodClassCastPrim, false);</span>
<span class="line-modified">!         t.runTest(methodPrimClassCast, true);</span>
      }
  
      void testClassCast(String s) {
          try {
              ssink = String.class.cast(s);
<span class="line-new-header">--- 107,39 ---</span>
          Method methodMHCast    = CastNullCheckDroppingsTest.class.getDeclaredMethod(&quot;testMHCast&quot;,    String.class);
          Method methodMHSetter  = CastNullCheckDroppingsTest.class.getDeclaredMethod(&quot;testMHSetter&quot;,  String.class);
          Method methodFunction  = CastNullCheckDroppingsTest.class.getDeclaredMethod(&quot;testFunction&quot;,  String.class);
  
          CastNullCheckDroppingsTest t = new CastNullCheckDroppingsTest();
<span class="line-modified">!         t.runTest(methodClassCast, false, svalue);</span>
<span class="line-modified">!         t.runTest(methodMHCast,    false, svalue);</span>
<span class="line-modified">!         t.runTest(methodMHSetter,  false, svalue);</span>
<span class="line-modified">!         t.runTest(methodFunction,  false, svalue);</span>
  
          // Edge cases
          Method methodClassCastNull = CastNullCheckDroppingsTest.class.getDeclaredMethod(&quot;testClassCastNull&quot;, String.class);
          Method methodNullClassCast = CastNullCheckDroppingsTest.class.getDeclaredMethod(&quot;testNullClassCast&quot;, String.class);
          Method methodClassCastObj  = CastNullCheckDroppingsTest.class.getDeclaredMethod(&quot;testClassCastObj&quot;,  Object.class);
          Method methodObjClassCast  = CastNullCheckDroppingsTest.class.getDeclaredMethod(&quot;testObjClassCast&quot;,  String.class);
          Method methodClassCastInt  = CastNullCheckDroppingsTest.class.getDeclaredMethod(&quot;testClassCastInt&quot;,  Object.class);
          Method methodIntClassCast  = CastNullCheckDroppingsTest.class.getDeclaredMethod(&quot;testIntClassCast&quot;,  Object.class);
          Method methodClassCastint  = CastNullCheckDroppingsTest.class.getDeclaredMethod(&quot;testClassCastint&quot;,  Object.class);
          Method methodintClassCast  = CastNullCheckDroppingsTest.class.getDeclaredMethod(&quot;testintClassCast&quot;,  Object.class);
          Method methodClassCastPrim = CastNullCheckDroppingsTest.class.getDeclaredMethod(&quot;testClassCastPrim&quot;, Object.class);
          Method methodPrimClassCast = CastNullCheckDroppingsTest.class.getDeclaredMethod(&quot;testPrimClassCast&quot;, Object.class);
<span class="line-modified">!         Method methodVarClassCast  = CastNullCheckDroppingsTest.class.getDeclaredMethod(&quot;testVarClassCast&quot;,  Class.class);</span>
<span class="line-modified">! </span>
<span class="line-modified">!         t.runTest(methodClassCastNull, false, svalue);</span>
<span class="line-modified">!         t.runTest(methodNullClassCast, false, svalue);</span>
<span class="line-modified">!         t.runTest(methodClassCastObj,  false, svalue);</span>
<span class="line-modified">!         t.runTest(methodObjClassCast,  true,  svalue);</span>
<span class="line-modified">!         t.runTest(methodClassCastInt,  false, svalue);</span>
<span class="line-modified">!         t.runTest(methodIntClassCast,  true,  svalue);</span>
<span class="line-modified">!         t.runTest(methodClassCastint,  false, svalue);</span>
<span class="line-modified">!         t.runTest(methodintClassCast,  false, svalue);</span>
<span class="line-modified">!         t.runTest(methodClassCastPrim, false, svalue);</span>
<span class="line-modified">!         t.runTest(methodPrimClassCast, true,  svalue);</span>
<span class="line-added">+         t.runTest(methodVarClassCast,  true,  objClass);</span>
      }
  
      void testClassCast(String s) {
          try {
              ssink = String.class.cast(s);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 174,15 ***</span>
          } catch (Throwable t) {
              throw new Error(t);
          }
      }
  
<span class="line-modified">!     void testVarClassCast(String s) {</span>
<span class="line-removed">-         Class cl = (s == null) ? null : String.class;</span>
          try {
              ssink = (String)cl.cast(svalue);
<span class="line-modified">!             if (s == null) {</span>
                  throw new AssertionError(&quot;NullPointerException is not thrown&quot;);
              }
          } catch (NullPointerException t) {
              // Ignore NullPointerException
          } catch (Throwable t) {
<span class="line-new-header">--- 181,14 ---</span>
          } catch (Throwable t) {
              throw new Error(t);
          }
      }
  
<span class="line-modified">!     void testVarClassCast(Class cl) {</span>
          try {
              ssink = (String)cl.cast(svalue);
<span class="line-modified">!             if (cl == null) {</span>
                  throw new AssertionError(&quot;NullPointerException is not thrown&quot;);
              }
          } catch (NullPointerException t) {
              // Ignore NullPointerException
          } catch (Throwable t) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 284,33 ***</span>
          } catch (Throwable t) {
              throw new Error(t);
          }
      }
  
<span class="line-modified">!     void runTest(Method method, boolean deopt) {</span>
          if (method == null) {
              throw new AssertionError(&quot;method was not found&quot;);
          }
          // Ensure method is compiled
          WHITE_BOX.testSetDontInlineMethod(method, true);
          for (int i = 0; i &lt; 3000; i++) {
              try {
<span class="line-modified">!                 method.invoke(this, svalue);</span>
              } catch (Exception e) {
                  throw new Error(&quot;Unexpected exception: &quot;, e);
              }
          }
          NMethod nm = getNMethod(method);
  
          // Passing null should cause a de-optimization
          // if method is compiled with a null-check.
          try {
<span class="line-modified">!             method.invoke(this, snull);</span>
          } catch (Exception e) {
              throw new Error(&quot;Unexpected exception: &quot;, e);
          }
<span class="line-modified">!         checkDeoptimization(method, nm, deopt);</span>
      }
  
      static NMethod getNMethod(Method test) {
          // Because background compilation is disabled, method should now be compiled
          if (!WHITE_BOX.isMethodCompiled(test)) {
<span class="line-new-header">--- 290,49 ---</span>
          } catch (Throwable t) {
              throw new Error(t);
          }
      }
  
<span class="line-modified">!     void runTest(Method method, boolean deopt, Object value) {</span>
          if (method == null) {
              throw new AssertionError(&quot;method was not found&quot;);
          }
          // Ensure method is compiled
          WHITE_BOX.testSetDontInlineMethod(method, true);
<span class="line-added">+         Recording recording = new Recording();</span>
<span class="line-added">+         recording.enable(EventNames.Deoptimization);</span>
<span class="line-added">+         recording.start();</span>
<span class="line-added">+ </span>
          for (int i = 0; i &lt; 3000; i++) {
              try {
<span class="line-modified">!                 method.invoke(this, value);</span>
              } catch (Exception e) {
                  throw new Error(&quot;Unexpected exception: &quot;, e);
              }
          }
          NMethod nm = getNMethod(method);
  
          // Passing null should cause a de-optimization
          // if method is compiled with a null-check.
          try {
<span class="line-modified">!             method.invoke(this, onull);</span>
          } catch (Exception e) {
              throw new Error(&quot;Unexpected exception: &quot;, e);
          }
<span class="line-modified">!         recording.stop();</span>
<span class="line-added">+         List&lt;RecordedEvent&gt; events;</span>
<span class="line-added">+         try {</span>
<span class="line-added">+             events = Events.fromRecording(recording);</span>
<span class="line-added">+         } catch (IOException e) {</span>
<span class="line-added">+             throw new Error(&quot;failed to read jfr events&quot;, e);</span>
<span class="line-added">+         }</span>
<span class="line-added">+ </span>
<span class="line-added">+         checkDeoptimization(events, nm.compile_id, deopt);</span>
<span class="line-added">+ </span>
<span class="line-added">+         if (!deopt) {</span>
<span class="line-added">+             checkNoRecompilation(method, nm);</span>
<span class="line-added">+         }</span>
      }
  
      static NMethod getNMethod(Method test) {
          // Because background compilation is disabled, method should now be compiled
          if (!WHITE_BOX.isMethodCompiled(test)) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 325,19 ***</span>
              throw new AssertionError(test + &quot; compiled by not C2: &quot; + nm);
          }
          return nm;
      }
  
<span class="line-modified">!     static void checkDeoptimization(Method method, NMethod nmOrig, boolean deopt) {</span>
<span class="line-modified">!         // Check deoptimization event (intrinsic Class.cast() works).</span>
<span class="line-modified">!         if (WHITE_BOX.isMethodCompiled(method) == deopt) {</span>
<span class="line-modified">!             throw new AssertionError(method + &quot; was&quot; + (deopt ? &quot; not&quot; : &quot;&quot;) + &quot; deoptimized&quot;);</span>
          }
<span class="line-modified">!         if (deopt) {</span>
<span class="line-modified">!             return;</span>
          }
<span class="line-modified">!         // Ensure no recompilation when no deoptimization is expected.</span>
          NMethod nm = NMethod.get(method, false); // not OSR nmethod
          if (nm == null) {
              throw new AssertionError(method + &quot; missing nmethod?&quot;);
          }
          if (nm.comp_level != 4) {
<span class="line-new-header">--- 347,33 ---</span>
              throw new AssertionError(test + &quot; compiled by not C2: &quot; + nm);
          }
          return nm;
      }
  
<span class="line-modified">!     static void checkDeoptimization(List&lt;RecordedEvent&gt; events, int compilerId, boolean mustExist) {</span>
<span class="line-modified">!         boolean exist = events.stream()</span>
<span class="line-modified">!                 .filter(e -&gt; e.getEventType().getName().equals(EventNames.Deoptimization))</span>
<span class="line-modified">!                 .anyMatch(e -&gt; compilerId == Events.assertField(e, &quot;compileId&quot;).&lt;Integer&gt;getValue());</span>
<span class="line-added">+ </span>
<span class="line-added">+         if (exist != mustExist) {</span>
<span class="line-added">+             System.err.println(&quot;events:&quot;);</span>
<span class="line-added">+             System.err.println(events);</span>
<span class="line-added">+             throw new AssertionError(&quot;compilation must &quot; + (mustExist ? &quot;&quot; : &quot; not &quot;) + &quot; got deoptimized&quot;);</span>
          }
<span class="line-modified">! </span>
<span class="line-modified">!         if (mustExist &amp;&amp; events.stream()</span>
<span class="line-added">+                   .filter(e -&gt; e.getEventType().getName().equals(EventNames.Deoptimization))</span>
<span class="line-added">+                   .filter(e -&gt; compilerId == Events.assertField(e, &quot;compileId&quot;).&lt;Integer&gt;getValue())</span>
<span class="line-added">+                   .noneMatch(e -&gt; &quot;null_check&quot;.equals(Events.assertField(e, &quot;reason&quot;).getValue()))) {</span>
<span class="line-added">+             System.err.println(&quot;events:&quot;);</span>
<span class="line-added">+             System.err.println(events);</span>
<span class="line-added">+             throw new AssertionError(&quot;no deoptimizations due to null_check found&quot;);</span>
          }
<span class="line-modified">! </span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     static void checkNoRecompilation(Method method, NMethod nmOrig) {</span>
          NMethod nm = NMethod.get(method, false); // not OSR nmethod
          if (nm == null) {
              throw new AssertionError(method + &quot; missing nmethod?&quot;);
          }
          if (nm.comp_level != 4) {
</pre>
<center><a href="../base64/TestBase64.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="TestIsPrimitive.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>