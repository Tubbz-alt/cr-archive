<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/hotspot/jtreg/testlibrary/ctw/src/sun/hotspot/tools/ctw/CtwRunner.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 2017, 2018, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 package sun.hotspot.tools.ctw;
 25 
 26 import jdk.test.lib.Asserts;
 27 import jdk.test.lib.Utils;
 28 import jdk.test.lib.process.ProcessTools;
 29 import jdk.test.lib.util.Pair;
 30 
 31 import java.io.BufferedReader;
 32 import java.io.IOException;
 33 import java.nio.file.Files;
 34 import java.nio.file.Path;
 35 import java.nio.file.Paths;
 36 import java.util.ArrayList;
 37 import java.util.List;
 38 import java.util.concurrent.TimeUnit;
 39 import java.util.function.Predicate;
 40 import java.util.regex.Pattern;
 41 import java.util.stream.Collectors;
 42 
 43 /**
 44  * Runs CompileTheWorld for exact one target. If an error occurs during
 45  * compilation of class N, this driver class saves error information and
 46  * restarts CTW from class N + 1. All saved errors are reported at the end.
 47  * &lt;pre&gt;
 48  * Usage: &lt;target to compile&gt;
 49  * &lt;/pre&gt;
 50  */
 51 public class CtwRunner {
 52     private static final Predicate&lt;String&gt; IS_CLASS_LINE = Pattern.compile(
 53             &quot;^\\[\\d+\\]\\s*\\S+\\s*$&quot;).asPredicate();
 54 
 55     private static final String USAGE = &quot;Usage: CtwRunner &lt;artifact to compile&gt; [start[%] stop[%]]&quot;;
 56 
 57     public static void main(String[] args) throws Exception {
 58         CtwRunner runner;
 59         switch (args.length) {
 60             case 1: runner = new CtwRunner(args[0]); break;
 61             case 3: runner = new CtwRunner(args[0], args[1], args[2]); break;
 62             default: throw new Error(USAGE);
 63         }
 64 
 65         runner.run();
 66     }
 67 
 68     private final List&lt;Throwable&gt; errors;
 69     private final String target;
 70     private final Path targetPath;
 71     private final String targetName;
 72 
 73     private final int start, stop;
 74     private final boolean isStartStopPercentage;
 75 
 76     private CtwRunner(String target, String start, String stop) {
 77         if (target.startsWith(&quot;modules&quot;)) {
 78             targetPath = Paths
 79                     .get(Utils.TEST_JDK)
 80                     .resolve(&quot;lib&quot;)
 81                     .resolve(&quot;modules&quot;);
 82             if (target.equals(&quot;modules&quot;)){
 83                 target = targetPath.toString();
 84             }
 85             targetName = target.replace(&#39;:&#39;, &#39;_&#39;)
 86                                .replace(&#39;.&#39;, &#39;_&#39;)
 87                                .replace(&#39;,&#39;, &#39;_&#39;);
 88         } else {
 89             targetPath = Paths.get(target).toAbsolutePath();
 90             targetName = targetPath.getFileName().toString();
 91         }
 92         this.target = target;
 93         errors = new ArrayList&lt;&gt;();
 94 
 95         if (start.endsWith(&quot;%&quot;) &amp;&amp; stop.endsWith(&quot;%&quot;)) {
 96             int startPercentage = Integer.parseInt(start.substring(0, start.length() - 1));;
 97             int stopPercentage = Integer.parseInt(stop.substring(0, stop.length() - 1));
 98             if (startPercentage &lt; 0 || startPercentage &gt; 100 ||
 99                 stopPercentage &lt; 0 || stopPercentage &gt; 100) {
100                 throw new Error(USAGE);
101             }
102             this.start = startPercentage;
103             this.stop = stopPercentage;
104             this.isStartStopPercentage = true;
105         } else if (!start.endsWith(&quot;%&quot;) &amp;&amp; !stop.endsWith(&quot;%&quot;)) {
106             this.start = Integer.parseInt(start);
107             this.stop = Integer.parseInt(stop);
108             this.isStartStopPercentage = false;
109         } else {
110             throw new Error(USAGE);
111         }
112     }
113 
114     private CtwRunner(String target) {
115         this(target, &quot;0%&quot;, &quot;100%&quot;);
116     }
117 
118     private void run() {
119         startCtwforAllClasses();
120         if (!errors.isEmpty()) {
121             StringBuilder sb = new StringBuilder();
122             sb.append(&quot;There were &quot;)
123               .append(errors.size())
124               .append(&quot; errors:[&quot;);
125             System.err.println(sb.toString());
126             for (Throwable e : errors) {
127                 sb.append(&quot;{&quot;)
128                   .append(e.getMessage())
129                   .append(&quot;}&quot;);
130                 e.printStackTrace(System.err);
131                 System.err.println();
132             }
133             sb.append(&quot;]&quot;);
134             throw new AssertionError(sb.toString());
135         }
136     }
137 
138     private long start(long totalClassCount) {
139         if (isStartStopPercentage) {
140             return totalClassCount * start / 100;
141         } else if (start &gt; totalClassCount) {
142             System.err.println(&quot;WARNING: start [&quot; + start + &quot;] &gt; totalClassCount [&quot; + totalClassCount + &quot;]&quot;);
143             return totalClassCount;
144         } else {
145             return start;
146         }
147     }
148 
149     private long stop(long totalClassCount) {
150         if (isStartStopPercentage) {
151             return totalClassCount * stop / 100;
152         } else if (stop &gt; totalClassCount) {
153             System.err.println(&quot;WARNING: stop [&quot; + start + &quot;] &gt; totalClassCount [&quot; + totalClassCount + &quot;]&quot;);
154             return totalClassCount;
155         } else {
156             return stop;
157         }
158     }
159 
160     private void startCtwforAllClasses() {
161         long totalClassCount = classCount();
162 
163         long classStart = start(totalClassCount);
164         long classStop = stop(totalClassCount);
165 
166         long classCount = classStop - classStart;
167         Asserts.assertGreaterThan(classCount, 0L,
168                 target + &quot;(at &quot; + targetPath + &quot;) does not have any classes&quot;);
169 
170         System.out.printf(&quot;Compiling %d classes (of %d total classes) starting at %d and ending at %d\n&quot;,
171                           classCount, totalClassCount, classStart, classStop);
172 
173         boolean done = false;
174         while (!done) {
175             String[] cmd = cmd(classStart, classStop);
176             try {
177                 ProcessBuilder pb = ProcessTools.createJavaProcessBuilder(
178                         /* addTestVmAndJavaOptions = */ true,
179                         cmd);
180                 String commandLine = pb.command()
181                         .stream()
182                         .collect(Collectors.joining(&quot; &quot;));
183                 String phase = phaseName(classStart);
184                 Path out = Paths.get(&quot;.&quot;, phase + &quot;.out&quot;);
185                 Path err = Paths.get(&quot;.&quot;, phase + &quot;.err&quot;);
186                 System.out.printf(&quot;%s %dms START : [%s]%n&quot; +
187                         &quot;cout/cerr are redirected to %s%n&quot;,
188                         phase, TimeUnit.NANOSECONDS.toMillis(System.nanoTime()),
189                         commandLine, phase);
190                 int exitCode = pb.redirectOutput(out.toFile())
191                                  .redirectError(err.toFile())
192                                  .start()
193                                  .waitFor();
194                 System.out.printf(&quot;%s %dms END : exit code = %d%n&quot;,
195                         phase, TimeUnit.NANOSECONDS.toMillis(System.nanoTime()),
196                         exitCode);
197                 Pair&lt;String, Long&gt; lastClass = getLastClass(out);
198                 if (exitCode == 0) {
199                     long lastIndex = lastClass == null ? -1 : lastClass.second;
200                     if (lastIndex != classStop) {
201                         errors.add(new Error(phase + &quot;: Unexpected zero exit code&quot;
202                                 + &quot;before finishing all compilations.&quot;
203                                 + &quot; lastClass[&quot; + lastIndex
204                                 + &quot;] != classStop[&quot; + classStop + &quot;]&quot;));
205                     } else {
206                         System.out.println(&quot;Executed CTW for all &quot; + classCount
207                                 + &quot; classes in &quot; + target + &quot;(at &quot; + targetPath + &quot;)&quot;);
208                     }
209                     done = true;
210                 } else {
211                     if (lastClass == null) {
212                         errors.add(new Error(phase + &quot;: failed during preload&quot;
213                                 + &quot; with classStart = &quot; + classStart));
214                         // skip one class
215                         ++classStart;
216                     } else {
217                         errors.add(new Error(phase + &quot;: failed during&quot;
218                                 + &quot; compilation of class #&quot; + lastClass.second
219                                 + &quot; : &quot; + lastClass.first));
220                         // continue with the next class
221                         classStart = lastClass.second + 1;
222                     }
223                 }
224             } catch (Exception e) {
225                 throw new Error(&quot;failed to run from &quot; + classStart, e);
226             }
227         }
228     }
229 
230     private long classCount() {
231         List&lt;PathHandler&gt; phs = PathHandler.create(target);
232         long result = phs.stream()
233                          .mapToLong(PathHandler::classCount)
234                          .sum();
235         phs.forEach(PathHandler::close);
236         return result;
237     }
238 
239     private Pair&lt;String, Long&gt; getLastClass(Path errFile) {
240         try (BufferedReader reader = Files.newBufferedReader(errFile)) {
241             String line = reader.lines()
242                     .filter(IS_CLASS_LINE)
243                     .reduce((a, b) -&gt; b)
244                     .orElse(null);
245             if (line != null) {
246                 int open = line.indexOf(&#39;[&#39;) + 1;
247                 int close = line.indexOf(&#39;]&#39;);
248                 long index = Long.parseLong(line.substring(open, close));
249                 String name = line.substring(close + 1).trim().replace(&#39;.&#39;, &#39;/&#39;);
250                 return new Pair&lt;&gt;(name, index);
251             }
252         } catch (IOException ioe) {
253             throw new Error(&quot;can not read &quot; + errFile + &quot; : &quot;
254                     + ioe.getMessage(), ioe);
255         }
256         return null;
257     }
258 
259     private String[] cmd(long classStart, long classStop) {
260         String phase = phaseName(classStart);
<a name="1" id="anc1"></a><span class="line-modified">261         Path file = Paths.get(phase + &quot;.cmd&quot;);</span>
<span class="line-modified">262         try {</span>
<span class="line-modified">263             Files.write(file, List.of(</span>
<span class="line-modified">264                     &quot;-Xbatch&quot;,</span>
<span class="line-modified">265                     &quot;-XX:-UseCounterDecay&quot;,</span>
<span class="line-modified">266                     &quot;-XX:-ShowMessageBoxOnError&quot;,</span>
<span class="line-modified">267                     &quot;-XX:+UnlockDiagnosticVMOptions&quot;,</span>
<span class="line-modified">268                     // redirect VM output to cerr so it won&#39;t collide w/ ctw output</span>
<span class="line-modified">269                     &quot;-XX:+DisplayVMOutputToStderr&quot;,</span>
<span class="line-modified">270                     // define phase start</span>
<span class="line-modified">271                     &quot;-DCompileTheWorldStartAt=&quot; + classStart,</span>
<span class="line-modified">272                     &quot;-DCompileTheWorldStopAt=&quot; + classStop,</span>
<span class="line-modified">273                     // CTW library uses WhiteBox API</span>
<span class="line-modified">274                     &quot;-XX:+WhiteBoxAPI&quot;, &quot;-Xbootclasspath/a:.&quot;,</span>
<span class="line-modified">275                     // export jdk.internal packages used by CTW library</span>
<span class="line-modified">276                     &quot;--add-exports&quot;, &quot;java.base/jdk.internal.jimage=ALL-UNNAMED&quot;,</span>
<span class="line-modified">277                     &quot;--add-exports&quot;, &quot;java.base/jdk.internal.misc=ALL-UNNAMED&quot;,</span>
<span class="line-modified">278                     &quot;--add-exports&quot;, &quot;java.base/jdk.internal.reflect=ALL-UNNAMED&quot;,</span>
<span class="line-modified">279                     &quot;--add-exports&quot;, &quot;java.base/jdk.internal.access=ALL-UNNAMED&quot;,</span>
<span class="line-modified">280                     // enable diagnostic logging</span>
<span class="line-modified">281                     &quot;-XX:+LogCompilation&quot;,</span>
<span class="line-modified">282                     // use phase specific log, hs_err and ciReplay files</span>
<span class="line-modified">283                     String.format(&quot;-XX:LogFile=hotspot_%s_%%p.log&quot;, phase),</span>
<span class="line-modified">284                     String.format(&quot;-XX:ErrorFile=hs_err_%s_%%p.log&quot;, phase),</span>
<span class="line-modified">285                     String.format(&quot;-XX:ReplayDataFile=replay_%s_%%p.log&quot;, phase),</span>
<span class="line-modified">286                     // MethodHandle MUST NOT be compiled</span>
<span class="line-modified">287                     &quot;-XX:CompileCommand=exclude,java/lang/invoke/MethodHandle.*&quot;,</span>
<span class="line-modified">288                     // CTW entry point</span>
<span class="line-modified">289                     CompileTheWorld.class.getName(),</span>
<span class="line-added">290                     target));</span>
<span class="line-added">291         } catch (IOException e) {</span>
<span class="line-added">292             throw new Error(&quot;can&#39;t create &quot; + file, e);</span>
<span class="line-added">293         }</span>
<span class="line-added">294         return new String[]{ &quot;@&quot; + file.toAbsolutePath() };</span>
295     }
296 
297     private String phaseName(long classStart) {
298         return String.format(&quot;%s_%d&quot;, targetName, classStart);
299     }
300 
301 }
<a name="2" id="anc2"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="2" type="hidden" />
</body>
</html>