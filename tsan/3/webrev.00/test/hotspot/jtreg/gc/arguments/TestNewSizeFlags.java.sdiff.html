<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/hotspot/jtreg/gc/arguments/TestNewSizeFlags.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="TestNewRatioFlag.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="TestNewSizeThreadIncrease.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/jtreg/gc/arguments/TestNewSizeFlags.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
151             long heapSize, long maxHeapSize,
152             long expectedNewSize, long expectedMaxNewSize) throws Exception, IOException {
153         LinkedList&lt;String&gt; vmOptions = new LinkedList&lt;&gt;(options);
154         Collections.addAll(vmOptions,
155                 &quot;-Xbootclasspath/a:.&quot;,
156                 &quot;-XX:+UnlockDiagnosticVMOptions&quot;,
157                 &quot;-XX:+WhiteBoxAPI&quot;,
158                 (newSize &gt;= 0 ? &quot;-XX:NewSize=&quot; + newSize : &quot;&quot;),
159                 (maxNewSize &gt;= 0 ? &quot;-XX:MaxNewSize=&quot; + maxNewSize : &quot;&quot;),
160                 &quot;-Xmx&quot; + maxHeapSize,
161                 &quot;-Xms&quot; + heapSize,
162                 &quot;-XX:GCLockerEdenExpansionPercent=0&quot;,
163                 &quot;-XX:-UseLargePages&quot;,
164                 NewSizeVerifier.class.getName(),
165                 Long.toString(expectedNewSize),
166                 Long.toString(expectedMaxNewSize),
167                 Long.toString(heapSize),
168                 Long.toString(maxHeapSize)
169         );
170         vmOptions.removeIf(String::isEmpty);
<span class="line-modified">171         ProcessBuilder procBuilder = ProcessTools.createJavaProcessBuilder(vmOptions.toArray(new String[vmOptions.size()]));</span>
172         OutputAnalyzer analyzer = new OutputAnalyzer(procBuilder.start());
173         return analyzer;
174     }
175 
176     /**
177      * NewSizeVerifier checks that initial young gen size is equal to expected
178      * regardful to alignment and that young gen size will not be greater than
179      * expected max size.
180      * In order to verify that young gen size will not be greater then expected
181      * max size, NewSizeVerifier do some object allocation to force garbage
182      * collection and heap expansion.
183      */
184     public static class NewSizeVerifier {
185 
186         private static final WhiteBox WB = WhiteBox.getWhiteBox();
187         private static final GCTypes.YoungGCType YOUNG_GC_TYPE = GCTypes.YoungGCType.getYoungGCType();
188         private static final long HEAP_SPACE_ALIGNMENT = WB.getHeapSpaceAlignment();
189         private static final long HEAP_ALIGNMENT = WB.getHeapAlignment();
190         private static final long PS_VIRTUAL_SPACE_ALIGNMENT =
191                 (YOUNG_GC_TYPE == GCTypes.YoungGCType.PSNew) ? WB.psVirtualSpaceAlignment() : 0;
</pre>
<hr />
<pre>
289             long edenUsageCommited = edenUsage.getCommitted();
290             long survivorUsageInit = survivorUsage.getInit();
291             long survivorUsageCommited = survivorUsage.getCommitted();
292 
293             if (YOUNG_GC_TYPE == GCTypes.YoungGCType.G1) {
294                 return new MemoryUsage(edenUsageInit + survivorUsageInit, 0,
295                         edenUsageCommited + survivorUsageCommited, Long.MAX_VALUE);
296             } else {
297                 return new MemoryUsage(edenUsageInit + survivorUsageInit * 2, 0,
298                         edenUsageCommited + survivorUsageCommited * 2,
299                         edenUsage.getMax() + survivorUsage.getMax() * 2);
300             }
301         }
302 
303         /**
304          * Align generation size regardful to used young GC.
305          */
306         public static long alignGenSize(long value) {
307             switch (YOUNG_GC_TYPE) {
308                 case DefNew:
<span class="line-removed">309                 case ParNew:</span>
310                     return HeapRegionUsageTool.alignDown(value, HEAP_SPACE_ALIGNMENT);
311                 case PSNew:
312                     return HeapRegionUsageTool.alignUp(HeapRegionUsageTool.alignDown(value,
313                             HEAP_SPACE_ALIGNMENT),
314                             PS_VIRTUAL_SPACE_ALIGNMENT);
315                 case G1:
316                     return HeapRegionUsageTool.alignUp(value, WB.g1RegionSize());
317                 default:
318                     throw new RuntimeException(&quot;Unexpected young GC type&quot;);
319             }
320         }
321 
322         /**
323          * Align heap size.
324          */
325         public static long alignHeapSize(long value){
326             return HeapRegionUsageTool.alignUp(value,HEAP_ALIGNMENT);
327         }
328     }
329 }
</pre>
</td>
<td>
<hr />
<pre>
151             long heapSize, long maxHeapSize,
152             long expectedNewSize, long expectedMaxNewSize) throws Exception, IOException {
153         LinkedList&lt;String&gt; vmOptions = new LinkedList&lt;&gt;(options);
154         Collections.addAll(vmOptions,
155                 &quot;-Xbootclasspath/a:.&quot;,
156                 &quot;-XX:+UnlockDiagnosticVMOptions&quot;,
157                 &quot;-XX:+WhiteBoxAPI&quot;,
158                 (newSize &gt;= 0 ? &quot;-XX:NewSize=&quot; + newSize : &quot;&quot;),
159                 (maxNewSize &gt;= 0 ? &quot;-XX:MaxNewSize=&quot; + maxNewSize : &quot;&quot;),
160                 &quot;-Xmx&quot; + maxHeapSize,
161                 &quot;-Xms&quot; + heapSize,
162                 &quot;-XX:GCLockerEdenExpansionPercent=0&quot;,
163                 &quot;-XX:-UseLargePages&quot;,
164                 NewSizeVerifier.class.getName(),
165                 Long.toString(expectedNewSize),
166                 Long.toString(expectedMaxNewSize),
167                 Long.toString(heapSize),
168                 Long.toString(maxHeapSize)
169         );
170         vmOptions.removeIf(String::isEmpty);
<span class="line-modified">171         ProcessBuilder procBuilder = GCArguments.createJavaProcessBuilder(vmOptions.toArray(new String[vmOptions.size()]));</span>
172         OutputAnalyzer analyzer = new OutputAnalyzer(procBuilder.start());
173         return analyzer;
174     }
175 
176     /**
177      * NewSizeVerifier checks that initial young gen size is equal to expected
178      * regardful to alignment and that young gen size will not be greater than
179      * expected max size.
180      * In order to verify that young gen size will not be greater then expected
181      * max size, NewSizeVerifier do some object allocation to force garbage
182      * collection and heap expansion.
183      */
184     public static class NewSizeVerifier {
185 
186         private static final WhiteBox WB = WhiteBox.getWhiteBox();
187         private static final GCTypes.YoungGCType YOUNG_GC_TYPE = GCTypes.YoungGCType.getYoungGCType();
188         private static final long HEAP_SPACE_ALIGNMENT = WB.getHeapSpaceAlignment();
189         private static final long HEAP_ALIGNMENT = WB.getHeapAlignment();
190         private static final long PS_VIRTUAL_SPACE_ALIGNMENT =
191                 (YOUNG_GC_TYPE == GCTypes.YoungGCType.PSNew) ? WB.psVirtualSpaceAlignment() : 0;
</pre>
<hr />
<pre>
289             long edenUsageCommited = edenUsage.getCommitted();
290             long survivorUsageInit = survivorUsage.getInit();
291             long survivorUsageCommited = survivorUsage.getCommitted();
292 
293             if (YOUNG_GC_TYPE == GCTypes.YoungGCType.G1) {
294                 return new MemoryUsage(edenUsageInit + survivorUsageInit, 0,
295                         edenUsageCommited + survivorUsageCommited, Long.MAX_VALUE);
296             } else {
297                 return new MemoryUsage(edenUsageInit + survivorUsageInit * 2, 0,
298                         edenUsageCommited + survivorUsageCommited * 2,
299                         edenUsage.getMax() + survivorUsage.getMax() * 2);
300             }
301         }
302 
303         /**
304          * Align generation size regardful to used young GC.
305          */
306         public static long alignGenSize(long value) {
307             switch (YOUNG_GC_TYPE) {
308                 case DefNew:

309                     return HeapRegionUsageTool.alignDown(value, HEAP_SPACE_ALIGNMENT);
310                 case PSNew:
311                     return HeapRegionUsageTool.alignUp(HeapRegionUsageTool.alignDown(value,
312                             HEAP_SPACE_ALIGNMENT),
313                             PS_VIRTUAL_SPACE_ALIGNMENT);
314                 case G1:
315                     return HeapRegionUsageTool.alignUp(value, WB.g1RegionSize());
316                 default:
317                     throw new RuntimeException(&quot;Unexpected young GC type&quot;);
318             }
319         }
320 
321         /**
322          * Align heap size.
323          */
324         public static long alignHeapSize(long value){
325             return HeapRegionUsageTool.alignUp(value,HEAP_ALIGNMENT);
326         }
327     }
328 }
</pre>
</td>
</tr>
</table>
<center><a href="TestNewRatioFlag.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="TestNewSizeThreadIncrease.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>