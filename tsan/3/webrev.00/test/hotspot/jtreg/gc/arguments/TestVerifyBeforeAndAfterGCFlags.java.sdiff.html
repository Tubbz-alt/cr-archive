<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/hotspot/jtreg/gc/arguments/TestVerifyBeforeAndAfterGCFlags.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="TestUseNUMAInterleaving.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../class_unloading/TestClassUnloadingDisabled.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/jtreg/gc/arguments/TestVerifyBeforeAndAfterGCFlags.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 package gc.arguments;
 25 
 26 /*
 27  * @test TestVerifyBeforeAndAfterGCFlags
 28  * @key gc
 29  * @bug 8000831
 30  * @summary Runs an simple application (GarbageProducer) with various
 31          combinations of -XX:{+|-}Verify{After|Before}GC flags and checks that
 32          output contain or doesn&#39;t contain expected patterns
 33  * @requires vm.gc != &quot;Z&quot; &amp; vm.gc != &quot;Shenandoah&quot;
 34  * @modules java.base/jdk.internal.misc
 35  * @modules java.management
 36  * @library /test/lib

 37  * @run driver gc.arguments.TestVerifyBeforeAndAfterGCFlags
 38  */
 39 
 40 import java.util.ArrayList;
 41 import java.util.Collections;
 42 
 43 import jdk.test.lib.Utils;
 44 import jdk.test.lib.process.OutputAnalyzer;
 45 import jdk.test.lib.process.ProcessTools;
 46 
 47 public class TestVerifyBeforeAndAfterGCFlags {
 48 
 49     // VerifyBeforeGC:[Verifying threads heap tenured eden syms strs zone dict metaspace chunks hand code cache ]
 50     public static final String VERIFY_BEFORE_GC_PATTERN = &quot;Verifying Before GC&quot;;
 51     // VerifyBeforeGC: VerifyBeforeGC: VerifyBeforeGC:
 52     public static final String VERIFY_BEFORE_GC_CORRUPTED_PATTERN = &quot;VerifyBeforeGC:(?!\\[Verifying[^]]+\\])&quot;;
 53 
 54     // VerifyAfterGC:[Verifying threads heap tenured eden syms strs zone dict metaspace chunks hand code cache ]
 55     public static final String VERIFY_AFTER_GC_PATTERN = &quot;Verifying After GC&quot;;
 56     // VerifyAfterGC: VerifyAfterGC: VerifyAfterGC:
</pre>
<hr />
<pre>
 59     public static void main(String args[]) throws Exception {
 60         String[] filteredOpts = Utils.getFilteredTestJavaOpts(
 61                                     new String[] { &quot;-Xlog:gc+verify=debug&quot;,
 62                                                    &quot;-XX:+UseGCLogFileRotation&quot;,
 63                                                    &quot;-XX:-DisplayVMOutput&quot;,
 64                                                    &quot;VerifyBeforeGC&quot;,
 65                                                    &quot;VerifyAfterGC&quot; });
 66         testVerifyFlags(false, false, filteredOpts);
 67         testVerifyFlags(true,  true,  filteredOpts);
 68         testVerifyFlags(true,  false, filteredOpts);
 69         testVerifyFlags(false, true,  filteredOpts);
 70     }
 71 
 72     public static void testVerifyFlags(boolean verifyBeforeGC,
 73                                        boolean verifyAfterGC,
 74                                        String[] opts) throws Exception {
 75         ArrayList&lt;String&gt; vmOpts = new ArrayList&lt;&gt;();
 76         if (opts != null &amp;&amp; (opts.length &gt; 0)) {
 77             Collections.addAll(vmOpts, opts);
 78         }
<span class="line-removed"> 79 </span>
 80         Collections.addAll(vmOpts, new String[] {
 81                                        &quot;-Xlog:gc+verify=debug&quot;,
 82                                        &quot;-Xmx5m&quot;,
 83                                        &quot;-Xms5m&quot;,
 84                                        &quot;-Xmn3m&quot;,
 85                                        &quot;-XX:+UnlockDiagnosticVMOptions&quot;,
 86                                        (verifyBeforeGC ? &quot;-XX:+VerifyBeforeGC&quot;
 87                                                        : &quot;-XX:-VerifyBeforeGC&quot;),
 88                                        (verifyAfterGC ? &quot;-XX:+VerifyAfterGC&quot;
 89                                                       : &quot;-XX:-VerifyAfterGC&quot;),
 90                                        GarbageProducer.class.getName() });
 91         ProcessBuilder procBuilder =
<span class="line-modified"> 92             ProcessTools.createJavaProcessBuilder(vmOpts.toArray(</span>
<span class="line-modified"> 93                                                    new String[vmOpts.size()]));</span>
 94         OutputAnalyzer analyzer = new OutputAnalyzer(procBuilder.start());
 95 
 96         analyzer.shouldHaveExitValue(0);
 97         analyzer.shouldNotMatch(VERIFY_BEFORE_GC_CORRUPTED_PATTERN);
 98         analyzer.shouldNotMatch(VERIFY_AFTER_GC_CORRUPTED_PATTERN);
 99 
100         if (verifyBeforeGC) {
101             analyzer.shouldMatch(VERIFY_BEFORE_GC_PATTERN);
102         } else {
103             analyzer.shouldNotMatch(VERIFY_BEFORE_GC_PATTERN);
104         }
105 
106         if (verifyAfterGC) {
107             analyzer.shouldMatch(VERIFY_AFTER_GC_PATTERN);
108         } else {
109             analyzer.shouldNotMatch(VERIFY_AFTER_GC_PATTERN);
110         }
111     }
112 
113     public static class GarbageProducer {
</pre>
</td>
<td>
<hr />
<pre>
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 package gc.arguments;
 25 
 26 /*
 27  * @test TestVerifyBeforeAndAfterGCFlags
 28  * @key gc
 29  * @bug 8000831
 30  * @summary Runs an simple application (GarbageProducer) with various
 31          combinations of -XX:{+|-}Verify{After|Before}GC flags and checks that
 32          output contain or doesn&#39;t contain expected patterns
 33  * @requires vm.gc != &quot;Z&quot; &amp; vm.gc != &quot;Shenandoah&quot;
 34  * @modules java.base/jdk.internal.misc
 35  * @modules java.management
 36  * @library /test/lib
<span class="line-added"> 37  * @library /</span>
 38  * @run driver gc.arguments.TestVerifyBeforeAndAfterGCFlags
 39  */
 40 
 41 import java.util.ArrayList;
 42 import java.util.Collections;
 43 
 44 import jdk.test.lib.Utils;
 45 import jdk.test.lib.process.OutputAnalyzer;
 46 import jdk.test.lib.process.ProcessTools;
 47 
 48 public class TestVerifyBeforeAndAfterGCFlags {
 49 
 50     // VerifyBeforeGC:[Verifying threads heap tenured eden syms strs zone dict metaspace chunks hand code cache ]
 51     public static final String VERIFY_BEFORE_GC_PATTERN = &quot;Verifying Before GC&quot;;
 52     // VerifyBeforeGC: VerifyBeforeGC: VerifyBeforeGC:
 53     public static final String VERIFY_BEFORE_GC_CORRUPTED_PATTERN = &quot;VerifyBeforeGC:(?!\\[Verifying[^]]+\\])&quot;;
 54 
 55     // VerifyAfterGC:[Verifying threads heap tenured eden syms strs zone dict metaspace chunks hand code cache ]
 56     public static final String VERIFY_AFTER_GC_PATTERN = &quot;Verifying After GC&quot;;
 57     // VerifyAfterGC: VerifyAfterGC: VerifyAfterGC:
</pre>
<hr />
<pre>
 60     public static void main(String args[]) throws Exception {
 61         String[] filteredOpts = Utils.getFilteredTestJavaOpts(
 62                                     new String[] { &quot;-Xlog:gc+verify=debug&quot;,
 63                                                    &quot;-XX:+UseGCLogFileRotation&quot;,
 64                                                    &quot;-XX:-DisplayVMOutput&quot;,
 65                                                    &quot;VerifyBeforeGC&quot;,
 66                                                    &quot;VerifyAfterGC&quot; });
 67         testVerifyFlags(false, false, filteredOpts);
 68         testVerifyFlags(true,  true,  filteredOpts);
 69         testVerifyFlags(true,  false, filteredOpts);
 70         testVerifyFlags(false, true,  filteredOpts);
 71     }
 72 
 73     public static void testVerifyFlags(boolean verifyBeforeGC,
 74                                        boolean verifyAfterGC,
 75                                        String[] opts) throws Exception {
 76         ArrayList&lt;String&gt; vmOpts = new ArrayList&lt;&gt;();
 77         if (opts != null &amp;&amp; (opts.length &gt; 0)) {
 78             Collections.addAll(vmOpts, opts);
 79         }

 80         Collections.addAll(vmOpts, new String[] {
 81                                        &quot;-Xlog:gc+verify=debug&quot;,
 82                                        &quot;-Xmx5m&quot;,
 83                                        &quot;-Xms5m&quot;,
 84                                        &quot;-Xmn3m&quot;,
 85                                        &quot;-XX:+UnlockDiagnosticVMOptions&quot;,
 86                                        (verifyBeforeGC ? &quot;-XX:+VerifyBeforeGC&quot;
 87                                                        : &quot;-XX:-VerifyBeforeGC&quot;),
 88                                        (verifyAfterGC ? &quot;-XX:+VerifyAfterGC&quot;
 89                                                       : &quot;-XX:-VerifyAfterGC&quot;),
 90                                        GarbageProducer.class.getName() });
 91         ProcessBuilder procBuilder =
<span class="line-modified"> 92             GCArguments.createJavaProcessBuilder(vmOpts.toArray(</span>
<span class="line-modified"> 93                                                      new String[vmOpts.size()]));</span>
 94         OutputAnalyzer analyzer = new OutputAnalyzer(procBuilder.start());
 95 
 96         analyzer.shouldHaveExitValue(0);
 97         analyzer.shouldNotMatch(VERIFY_BEFORE_GC_CORRUPTED_PATTERN);
 98         analyzer.shouldNotMatch(VERIFY_AFTER_GC_CORRUPTED_PATTERN);
 99 
100         if (verifyBeforeGC) {
101             analyzer.shouldMatch(VERIFY_BEFORE_GC_PATTERN);
102         } else {
103             analyzer.shouldNotMatch(VERIFY_BEFORE_GC_PATTERN);
104         }
105 
106         if (verifyAfterGC) {
107             analyzer.shouldMatch(VERIFY_AFTER_GC_PATTERN);
108         } else {
109             analyzer.shouldNotMatch(VERIFY_AFTER_GC_PATTERN);
110         }
111     }
112 
113     public static class GarbageProducer {
</pre>
</td>
</tr>
</table>
<center><a href="TestUseNUMAInterleaving.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../class_unloading/TestClassUnloadingDisabled.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>