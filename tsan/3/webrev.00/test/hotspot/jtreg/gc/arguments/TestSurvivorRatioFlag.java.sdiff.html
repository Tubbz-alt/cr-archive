<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/hotspot/jtreg/gc/arguments/TestSurvivorRatioFlag.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="TestSurvivorAlignmentInBytesOption.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="TestTargetSurvivorRatioFlag.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/jtreg/gc/arguments/TestSurvivorRatioFlag.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 72      */
 73     public static void testSurvivorRatio(int ratio, LinkedList&lt;String&gt; options) throws Exception {
 74 
 75         LinkedList&lt;String&gt; vmOptions = new LinkedList&lt;&gt;(options);
 76 
 77         Collections.addAll(vmOptions,
 78                 &quot;-Xbootclasspath/a:.&quot;,
 79                 &quot;--add-exports=java.base/jdk.internal.misc=ALL-UNNAMED&quot;,
 80                 &quot;-XX:+UnlockDiagnosticVMOptions&quot;,
 81                 &quot;-XX:+WhiteBoxAPI&quot;,
 82                 &quot;-XX:GCLockerEdenExpansionPercent=0&quot;,
 83                 &quot;-XX:MaxNewSize=&quot; + NEW_SIZE,
 84                 &quot;-XX:NewSize=&quot; + NEW_SIZE,
 85                 &quot;-Xmx&quot; + HEAP_SIZE,
 86                 &quot;-Xms&quot; + HEAP_SIZE,
 87                 &quot;-XX:SurvivorRatio=&quot; + ratio,
 88                 SurvivorRatioVerifier.class.getName(),
 89                 Integer.toString(ratio)
 90         );
 91 
<span class="line-modified"> 92         ProcessBuilder procBuilder = ProcessTools.createJavaProcessBuilder(vmOptions.toArray(new String[vmOptions.size()]));</span>
 93         OutputAnalyzer analyzer = new OutputAnalyzer(procBuilder.start());
 94         analyzer.shouldHaveExitValue(0);
 95     }
 96 
 97     /**
 98      * Class that verifies survivor ratio.
 99      */
100     public static class SurvivorRatioVerifier {
101 
102         static WhiteBox wb = WhiteBox.getWhiteBox();
103 
104         public static final int MAX_ITERATIONS = 10;
105         public static final int ARRAY_LENGTH = 10000;
106         public static final int CHUNK_SIZE = 10000;
107 
108         public static void main(String args[]) throws Exception {
109             if (args.length != 1) {
110                 throw new IllegalArgumentException(&quot;Expected 1 arg: &lt;ratio&gt;&quot;);
111             }
112             final int ratio = Integer.valueOf(args[0]);
113 
114             AllocationHelper allocator = new AllocationHelper(MAX_ITERATIONS, ARRAY_LENGTH, CHUNK_SIZE, () -&gt; (verifySurvivorRatio(ratio)));
115             allocator.allocateMemoryAndVerify();
116         }
117 
118         /**
119          * Verify that actual survivor ratio is equal to expected.
120          * Depending on selected young GC we verify that:
121          * - for DefNew and ParNew: eden_size / survivor_size is close to expectedRatio;
122          * - for PSNew:             survivor_size equal to young_gen_size / expectedRatio;
123          * - for G1:                survivor_regions &lt;= young_list_length / expectedRatio.
124          */
125         public static Void verifySurvivorRatio(int expectedRatio) {
126             GCTypes.YoungGCType type = GCTypes.YoungGCType.getYoungGCType();
127             switch (type) {
128                 case DefNew:
<span class="line-removed">129                 case ParNew:</span>
130                     verifyDefNewSurvivorRatio(expectedRatio);
131                     break;
132                 case PSNew:
133                     verifyPSSurvivorRatio(expectedRatio);
134                     break;
135                 case G1:
136                     verifyG1SurvivorRatio(expectedRatio);
137                     break;
138                 default:
139                     throw new RuntimeException(&quot;Unexpected young GC type&quot;);
140             }
141             return null;
142         }
143 
144         private static void verifyDefNewSurvivorRatio(int expectedRatio) {
145             MemoryUsage edenUsage = HeapRegionUsageTool.getEdenUsage();
146             MemoryUsage survivorUsage = HeapRegionUsageTool.getSurvivorUsage();
147 
148             int actualRatio = (int) (edenUsage.getCommitted() / survivorUsage.getCommitted());
149             if (Math.abs(actualRatio - expectedRatio) &gt; 1) {
</pre>
</td>
<td>
<hr />
<pre>
 72      */
 73     public static void testSurvivorRatio(int ratio, LinkedList&lt;String&gt; options) throws Exception {
 74 
 75         LinkedList&lt;String&gt; vmOptions = new LinkedList&lt;&gt;(options);
 76 
 77         Collections.addAll(vmOptions,
 78                 &quot;-Xbootclasspath/a:.&quot;,
 79                 &quot;--add-exports=java.base/jdk.internal.misc=ALL-UNNAMED&quot;,
 80                 &quot;-XX:+UnlockDiagnosticVMOptions&quot;,
 81                 &quot;-XX:+WhiteBoxAPI&quot;,
 82                 &quot;-XX:GCLockerEdenExpansionPercent=0&quot;,
 83                 &quot;-XX:MaxNewSize=&quot; + NEW_SIZE,
 84                 &quot;-XX:NewSize=&quot; + NEW_SIZE,
 85                 &quot;-Xmx&quot; + HEAP_SIZE,
 86                 &quot;-Xms&quot; + HEAP_SIZE,
 87                 &quot;-XX:SurvivorRatio=&quot; + ratio,
 88                 SurvivorRatioVerifier.class.getName(),
 89                 Integer.toString(ratio)
 90         );
 91 
<span class="line-modified"> 92         ProcessBuilder procBuilder = GCArguments.createJavaProcessBuilder(vmOptions.toArray(new String[vmOptions.size()]));</span>
 93         OutputAnalyzer analyzer = new OutputAnalyzer(procBuilder.start());
 94         analyzer.shouldHaveExitValue(0);
 95     }
 96 
 97     /**
 98      * Class that verifies survivor ratio.
 99      */
100     public static class SurvivorRatioVerifier {
101 
102         static WhiteBox wb = WhiteBox.getWhiteBox();
103 
104         public static final int MAX_ITERATIONS = 10;
105         public static final int ARRAY_LENGTH = 10000;
106         public static final int CHUNK_SIZE = 10000;
107 
108         public static void main(String args[]) throws Exception {
109             if (args.length != 1) {
110                 throw new IllegalArgumentException(&quot;Expected 1 arg: &lt;ratio&gt;&quot;);
111             }
112             final int ratio = Integer.valueOf(args[0]);
113 
114             AllocationHelper allocator = new AllocationHelper(MAX_ITERATIONS, ARRAY_LENGTH, CHUNK_SIZE, () -&gt; (verifySurvivorRatio(ratio)));
115             allocator.allocateMemoryAndVerify();
116         }
117 
118         /**
119          * Verify that actual survivor ratio is equal to expected.
120          * Depending on selected young GC we verify that:
121          * - for DefNew and ParNew: eden_size / survivor_size is close to expectedRatio;
122          * - for PSNew:             survivor_size equal to young_gen_size / expectedRatio;
123          * - for G1:                survivor_regions &lt;= young_list_length / expectedRatio.
124          */
125         public static Void verifySurvivorRatio(int expectedRatio) {
126             GCTypes.YoungGCType type = GCTypes.YoungGCType.getYoungGCType();
127             switch (type) {
128                 case DefNew:

129                     verifyDefNewSurvivorRatio(expectedRatio);
130                     break;
131                 case PSNew:
132                     verifyPSSurvivorRatio(expectedRatio);
133                     break;
134                 case G1:
135                     verifyG1SurvivorRatio(expectedRatio);
136                     break;
137                 default:
138                     throw new RuntimeException(&quot;Unexpected young GC type&quot;);
139             }
140             return null;
141         }
142 
143         private static void verifyDefNewSurvivorRatio(int expectedRatio) {
144             MemoryUsage edenUsage = HeapRegionUsageTool.getEdenUsage();
145             MemoryUsage survivorUsage = HeapRegionUsageTool.getSurvivorUsage();
146 
147             int actualRatio = (int) (edenUsage.getCommitted() / survivorUsage.getCommitted());
148             if (Math.abs(actualRatio - expectedRatio) &gt; 1) {
</pre>
</td>
</tr>
</table>
<center><a href="TestSurvivorAlignmentInBytesOption.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="TestTargetSurvivorRatioFlag.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>