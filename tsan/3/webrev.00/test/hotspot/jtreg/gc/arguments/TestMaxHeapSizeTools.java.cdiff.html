<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff test/hotspot/jtreg/gc/arguments/TestMaxHeapSizeTools.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="TestInitialTenuringThreshold.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="TestMaxMinHeapFreeRatioFlags.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/jtreg/gc/arguments/TestMaxHeapSizeTools.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 53,10 ***</span>
<span class="line-new-header">--- 53,12 ---</span>
    public static void checkMinInitialMaxHeapFlags(String gcflag) throws Exception {
      checkInvalidMinInitialHeapCombinations(gcflag);
      checkValidMinInitialHeapCombinations(gcflag);
      checkInvalidInitialMaxHeapCombinations(gcflag);
      checkValidInitialMaxHeapCombinations(gcflag);
<span class="line-added">+     checkInvalidMinMaxHeapCombinations(gcflag);</span>
<span class="line-added">+     checkValidMinMaxHeapCombinations(gcflag);</span>
    }
  
    public static void checkMinInitialErgonomics(String gcflag) throws Exception {
      // heap sizing ergonomics use the value NewSize + OldSize as default values
      // for ergonomics calculation. Retrieve these values.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 69,38 ***</span>
      long largeValue = newPlusOldSize * 2;
      long maxHeapSize = largeValue + (2 * 1024 * 1024);
  
      // -Xms is not set
      checkErgonomics(new String[] { gcflag, &quot;-Xmx&quot; + maxHeapSize }, values, -1, -1);
      checkErgonomics(new String[] { gcflag, &quot;-Xmx&quot; + maxHeapSize, &quot;-XX:InitialHeapSize=&quot; + smallValue }, values, -1, smallValue);
      checkErgonomics(new String[] { gcflag, &quot;-Xmx&quot; + maxHeapSize, &quot;-XX:InitialHeapSize=&quot; + largeValue }, values, -1, largeValue);
      checkErgonomics(new String[] { gcflag, &quot;-Xmx&quot; + maxHeapSize, &quot;-XX:InitialHeapSize=0&quot; }, values, -1, -1);
  
      // -Xms is set to zero
      checkErgonomics(new String[] { gcflag, &quot;-Xmx&quot; + maxHeapSize, &quot;-Xms0&quot; }, values, -1, -1);
      checkErgonomics(new String[] { gcflag, &quot;-Xmx&quot; + maxHeapSize, &quot;-Xms0&quot;, &quot;-XX:InitialHeapSize=&quot; + smallValue }, values, -1, smallValue);
      checkErgonomics(new String[] { gcflag, &quot;-Xmx&quot; + maxHeapSize, &quot;-Xms0&quot;, &quot;-XX:InitialHeapSize=&quot; + largeValue }, values, -1, largeValue);
      checkErgonomics(new String[] { gcflag, &quot;-Xmx&quot; + maxHeapSize, &quot;-Xms0&quot;, &quot;-XX:InitialHeapSize=0&quot; }, values, -1, -1);
  
      // -Xms is set to small value
      checkErgonomics(new String[] { gcflag, &quot;-Xmx&quot; + maxHeapSize, &quot;-Xms&quot; + smallValue }, values, -1, -1);
      checkErgonomics(new String[] { gcflag, &quot;-Xmx&quot; + maxHeapSize, &quot;-Xms&quot; + smallValue, &quot;-XX:InitialHeapSize=&quot; + smallValue }, values, smallValue, smallValue);
      checkErgonomics(new String[] { gcflag, &quot;-Xmx&quot; + maxHeapSize, &quot;-Xms&quot; + smallValue, &quot;-XX:InitialHeapSize=&quot; + largeValue }, values, smallValue, largeValue);
      checkErgonomics(new String[] { gcflag, &quot;-Xmx&quot; + maxHeapSize, &quot;-Xms&quot; + smallValue, &quot;-XX:InitialHeapSize=0&quot; }, values, smallValue, -1);
  
      // -Xms is set to large value
      checkErgonomics(new String[] { gcflag, &quot;-Xmx&quot; + maxHeapSize, &quot;-Xms&quot; + largeValue }, values, largeValue, largeValue);
      checkErgonomics(new String[] { gcflag, &quot;-Xmx&quot; + maxHeapSize, &quot;-Xms&quot; + largeValue, &quot;-XX:InitialHeapSize=0&quot; }, values, largeValue, -1);
    }
  
    private static long align_up(long value, long alignment) {
      long alignmentMinusOne = alignment - 1;
      return (value + alignmentMinusOne) &amp; ~alignmentMinusOne;
    }
  
    private static void getNewOldSize(String gcflag, long[] values) throws Exception {
<span class="line-modified">!     ProcessBuilder pb = ProcessTools.createJavaProcessBuilder(gcflag,</span>
        &quot;-XX:+PrintFlagsFinal&quot;, &quot;-version&quot;);
      OutputAnalyzer output = new OutputAnalyzer(pb.start());
      output.shouldHaveExitValue(0);
  
      String stdout = output.getStdout();
<span class="line-new-header">--- 71,54 ---</span>
      long largeValue = newPlusOldSize * 2;
      long maxHeapSize = largeValue + (2 * 1024 * 1024);
  
      // -Xms is not set
      checkErgonomics(new String[] { gcflag, &quot;-Xmx&quot; + maxHeapSize }, values, -1, -1);
<span class="line-added">+     checkErgonomics(new String[] { gcflag, &quot;-Xmx&quot; + maxHeapSize, &quot;-XX:MinHeapSize=&quot; + smallValue }, values, smallValue, -1);</span>
<span class="line-added">+     checkErgonomics(new String[] { gcflag, &quot;-Xmx&quot; + maxHeapSize, &quot;-XX:MinHeapSize=&quot; + largeValue }, values, largeValue, -1);</span>
<span class="line-added">+     checkErgonomics(new String[] { gcflag, &quot;-Xmx&quot; + maxHeapSize, &quot;-XX:MinHeapSize=0&quot; }, values, -1, -1);</span>
      checkErgonomics(new String[] { gcflag, &quot;-Xmx&quot; + maxHeapSize, &quot;-XX:InitialHeapSize=&quot; + smallValue }, values, -1, smallValue);
      checkErgonomics(new String[] { gcflag, &quot;-Xmx&quot; + maxHeapSize, &quot;-XX:InitialHeapSize=&quot; + largeValue }, values, -1, largeValue);
      checkErgonomics(new String[] { gcflag, &quot;-Xmx&quot; + maxHeapSize, &quot;-XX:InitialHeapSize=0&quot; }, values, -1, -1);
<span class="line-added">+     // Some extra checks when both are set.</span>
<span class="line-added">+     checkErgonomics(new String[] { gcflag, &quot;-Xmx&quot; + maxHeapSize, &quot;-XX:MinHeapSize=&quot; + smallValue, &quot;-XX:InitialHeapSize=&quot; + smallValue }, values, smallValue, smallValue);</span>
<span class="line-added">+     checkErgonomics(new String[] { gcflag, &quot;-Xmx&quot; + maxHeapSize, &quot;-XX:MinHeapSize=&quot; + smallValue, &quot;-XX:InitialHeapSize=&quot; + largeValue }, values, smallValue, largeValue);</span>
<span class="line-added">+     checkErgonomics(new String[] { gcflag, &quot;-Xmx&quot; + maxHeapSize, &quot;-XX:MinHeapSize=&quot; + largeValue, &quot;-XX:InitialHeapSize=&quot; + largeValue }, values, largeValue, largeValue);</span>
  
      // -Xms is set to zero
      checkErgonomics(new String[] { gcflag, &quot;-Xmx&quot; + maxHeapSize, &quot;-Xms0&quot; }, values, -1, -1);
<span class="line-added">+     checkErgonomics(new String[] { gcflag, &quot;-Xmx&quot; + maxHeapSize, &quot;-Xms0&quot;, &quot;-XX:MinHeapSize=&quot; + smallValue }, values, smallValue, -1);</span>
<span class="line-added">+     checkErgonomics(new String[] { gcflag, &quot;-Xmx&quot; + maxHeapSize, &quot;-Xms0&quot;, &quot;-XX:MinHeapSize=&quot; + largeValue }, values, largeValue, -1);</span>
<span class="line-added">+     checkErgonomics(new String[] { gcflag, &quot;-Xmx&quot; + maxHeapSize, &quot;-Xms0&quot;, &quot;-XX:MinHeapSize=0&quot; }, values, -1, -1);</span>
      checkErgonomics(new String[] { gcflag, &quot;-Xmx&quot; + maxHeapSize, &quot;-Xms0&quot;, &quot;-XX:InitialHeapSize=&quot; + smallValue }, values, -1, smallValue);
      checkErgonomics(new String[] { gcflag, &quot;-Xmx&quot; + maxHeapSize, &quot;-Xms0&quot;, &quot;-XX:InitialHeapSize=&quot; + largeValue }, values, -1, largeValue);
      checkErgonomics(new String[] { gcflag, &quot;-Xmx&quot; + maxHeapSize, &quot;-Xms0&quot;, &quot;-XX:InitialHeapSize=0&quot; }, values, -1, -1);
<span class="line-added">+     checkErgonomics(new String[] { gcflag, &quot;-Xmx&quot; + maxHeapSize, &quot;-Xms0&quot;, &quot;-XX:MinHeapSize=&quot; + smallValue, &quot;-XX:InitialHeapSize=&quot; + smallValue }, values, smallValue, smallValue);</span>
<span class="line-added">+     checkErgonomics(new String[] { gcflag, &quot;-Xmx&quot; + maxHeapSize, &quot;-Xms0&quot;, &quot;-XX:MinHeapSize=&quot; + smallValue, &quot;-XX:InitialHeapSize=&quot; + largeValue }, values, smallValue, largeValue);</span>
<span class="line-added">+     checkErgonomics(new String[] { gcflag, &quot;-Xmx&quot; + maxHeapSize, &quot;-Xms0&quot;, &quot;-XX:MinHeapSize=&quot; + largeValue, &quot;-XX:InitialHeapSize=&quot; + largeValue }, values, largeValue, largeValue);</span>
  
      // -Xms is set to small value
      checkErgonomics(new String[] { gcflag, &quot;-Xmx&quot; + maxHeapSize, &quot;-Xms&quot; + smallValue }, values, -1, -1);
<span class="line-added">+     checkErgonomics(new String[] { gcflag, &quot;-Xmx&quot; + maxHeapSize, &quot;-Xms&quot; + smallValue, &quot;-XX:MinHeapSize=&quot; + smallValue }, values, smallValue, smallValue);</span>
<span class="line-added">+     checkErgonomics(new String[] { gcflag, &quot;-Xmx&quot; + maxHeapSize, &quot;-Xms&quot; + smallValue, &quot;-XX:MinHeapSize=0&quot; }, values, -1, smallValue);</span>
      checkErgonomics(new String[] { gcflag, &quot;-Xmx&quot; + maxHeapSize, &quot;-Xms&quot; + smallValue, &quot;-XX:InitialHeapSize=&quot; + smallValue }, values, smallValue, smallValue);
      checkErgonomics(new String[] { gcflag, &quot;-Xmx&quot; + maxHeapSize, &quot;-Xms&quot; + smallValue, &quot;-XX:InitialHeapSize=&quot; + largeValue }, values, smallValue, largeValue);
      checkErgonomics(new String[] { gcflag, &quot;-Xmx&quot; + maxHeapSize, &quot;-Xms&quot; + smallValue, &quot;-XX:InitialHeapSize=0&quot; }, values, smallValue, -1);
  
      // -Xms is set to large value
      checkErgonomics(new String[] { gcflag, &quot;-Xmx&quot; + maxHeapSize, &quot;-Xms&quot; + largeValue }, values, largeValue, largeValue);
      checkErgonomics(new String[] { gcflag, &quot;-Xmx&quot; + maxHeapSize, &quot;-Xms&quot; + largeValue, &quot;-XX:InitialHeapSize=0&quot; }, values, largeValue, -1);
<span class="line-added">+     checkErgonomics(new String[] { gcflag, &quot;-Xmx&quot; + maxHeapSize, &quot;-Xms&quot; + largeValue, &quot;-XX:MinHeapSize=0&quot; }, values, -1, largeValue);</span>
    }
  
    private static long align_up(long value, long alignment) {
      long alignmentMinusOne = alignment - 1;
      return (value + alignmentMinusOne) &amp; ~alignmentMinusOne;
    }
  
    private static void getNewOldSize(String gcflag, long[] values) throws Exception {
<span class="line-modified">!     ProcessBuilder pb = GCArguments.createJavaProcessBuilder(gcflag,</span>
        &quot;-XX:+PrintFlagsFinal&quot;, &quot;-version&quot;);
      OutputAnalyzer output = new OutputAnalyzer(pb.start());
      output.shouldHaveExitValue(0);
  
      String stdout = output.getStdout();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 114,35 ***</span>
<span class="line-new-header">--- 132,58 ---</span>
    }
  
    private static void checkInvalidMinInitialHeapCombinations(String gcflag) throws Exception {
      expectError(new String[] { gcflag, &quot;-XX:InitialHeapSize=1023K&quot;, &quot;-version&quot; });
      expectError(new String[] { gcflag, &quot;-Xms64M&quot;, &quot;-XX:InitialHeapSize=32M&quot;, &quot;-version&quot; });
<span class="line-added">+     expectError(new String[] { gcflag, &quot;-XX:MinHeapSize=1023K&quot;, &quot;-version&quot; });</span>
<span class="line-added">+     // Note: MinHeapSize values get aligned up by HeapAlignment which is 32M with 64k pages.</span>
<span class="line-added">+     expectError(new String[] { gcflag, &quot;-Xms4M&quot;, &quot;-XX:MinHeapSize=64M&quot;, &quot;-version&quot; });</span>
<span class="line-added">+     expectError(new String[] { gcflag, &quot;-XX:MinHeapSize=8M -XX:InitialHeapSize=4m&quot; });</span>
    }
  
    private static void checkValidMinInitialHeapCombinations(String gcflag) throws Exception {
      expectValid(new String[] { gcflag, &quot;-XX:InitialHeapSize=1024K&quot;, &quot;-version&quot; });
      expectValid(new String[] { gcflag, &quot;-XX:InitialHeapSize=8M&quot;, &quot;-Xms4M&quot;, &quot;-version&quot; });
      expectValid(new String[] { gcflag, &quot;-Xms4M&quot;, &quot;-XX:InitialHeapSize=8M&quot;, &quot;-version&quot; });
      expectValid(new String[] { gcflag, &quot;-XX:InitialHeapSize=8M&quot;, &quot;-Xms8M&quot;, &quot;-version&quot; });
<span class="line-added">+     expectValid(new String[] { gcflag, &quot;-XX:MinHeapSize=1024K&quot;, &quot;-version&quot; });</span>
<span class="line-added">+     expectValid(new String[] { gcflag, &quot;-XX:MinHeapSize=8M&quot;, &quot;-Xms4M&quot;, &quot;-version&quot; });</span>
<span class="line-added">+     expectValid(new String[] { gcflag, &quot;-XX:MinHeapSize=8M&quot;, &quot;-Xms8M&quot;, &quot;-version&quot; });</span>
<span class="line-added">+     expectValid(new String[] { gcflag, &quot;-Xms8M&quot;, &quot;-XX:MinHeapSize=4M&quot;, &quot;-version&quot; });</span>
      // the following is not an error as -Xms sets both minimal and initial heap size
      expectValid(new String[] { gcflag, &quot;-XX:InitialHeapSize=4M&quot;, &quot;-Xms8M&quot;, &quot;-version&quot; });
<span class="line-added">+     expectValid(new String[] { gcflag, &quot;-XX:MinHeapSize=4M&quot;, &quot;-Xms8M&quot;, &quot;-version&quot; });</span>
    }
  
    private static void checkInvalidInitialMaxHeapCombinations(String gcflag) throws Exception {
      expectError(new String[] { gcflag, &quot;-XX:MaxHeapSize=2047K&quot;, &quot;-version&quot; });
      expectError(new String[] { gcflag, &quot;-XX:MaxHeapSize=4M&quot;, &quot;-XX:InitialHeapSize=8M&quot;, &quot;-version&quot; });
      expectError(new String[] { gcflag, &quot;-XX:InitialHeapSize=8M&quot;, &quot;-XX:MaxHeapSize=4M&quot;, &quot;-version&quot; });
    }
  
<span class="line-added">+   private static void checkInvalidMinMaxHeapCombinations(String gcflag) throws Exception {</span>
<span class="line-added">+     expectError(new String[] { gcflag, &quot;-XX:MaxHeapSize=4M&quot;, &quot;-XX:MinHeapSize=8M&quot;, &quot;-version&quot; });</span>
<span class="line-added">+     expectError(new String[] { gcflag, &quot;-XX:MinHeapSize=8M&quot;, &quot;-XX:MaxHeapSize=4M&quot;, &quot;-version&quot; });</span>
<span class="line-added">+   }</span>
<span class="line-added">+ </span>
<span class="line-added">+ </span>
    private static void checkValidInitialMaxHeapCombinations(String gcflag) throws Exception {
      expectValid(new String[] { gcflag, &quot;-XX:InitialHeapSize=4M&quot;, &quot;-XX:MaxHeapSize=8M&quot;, &quot;-version&quot; });
      expectValid(new String[] { gcflag, &quot;-XX:MaxHeapSize=8M&quot;, &quot;-XX:InitialHeapSize=4M&quot;, &quot;-version&quot; });
      expectValid(new String[] { gcflag, &quot;-XX:MaxHeapSize=4M&quot;, &quot;-XX:InitialHeapSize=4M&quot;, &quot;-version&quot; });
      // a value of &quot;0&quot; for initial heap size means auto-detect
      expectValid(new String[] { gcflag, &quot;-XX:MaxHeapSize=4M&quot;, &quot;-XX:InitialHeapSize=0M&quot;, &quot;-version&quot; });
    }
  
<span class="line-added">+   private static void checkValidMinMaxHeapCombinations(String gcflag) throws Exception {</span>
<span class="line-added">+     expectValid(new String[] { gcflag, &quot;-XX:MinHeapSize=4M&quot;, &quot;-XX:MaxHeapSize=8M&quot;, &quot;-version&quot; });</span>
<span class="line-added">+     expectValid(new String[] { gcflag, &quot;-XX:MaxHeapSize=8M&quot;, &quot;-XX:MinHeapSize=4M&quot;, &quot;-version&quot; });</span>
<span class="line-added">+     expectValid(new String[] { gcflag, &quot;-XX:MaxHeapSize=4M&quot;, &quot;-XX:MinHeapSize=4M&quot;, &quot;-version&quot; });</span>
<span class="line-added">+     // a value of &quot;0&quot; for min heap size means auto-detect</span>
<span class="line-added">+     expectValid(new String[] { gcflag, &quot;-XX:MaxHeapSize=4M&quot;, &quot;-XX:MinHeapSize=0M&quot;, &quot;-version&quot; });</span>
<span class="line-added">+   }</span>
<span class="line-added">+ </span>
    private static long valueAfter(String source, String match) {
      int start = source.indexOf(match) + match.length();
      String tail = source.substring(start).split(&quot; &quot;)[0];
      return Long.parseLong(tail);
    }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 177,11 ***</span>
      finalargs.addAll(Arrays.asList(vmargs));
      finalargs.addAll(Arrays.asList(whiteboxOpts));
      finalargs.add(classname);
      finalargs.addAll(Arrays.asList(arguments));
  
<span class="line-modified">!     ProcessBuilder pb = ProcessTools.createJavaProcessBuilder(finalargs.toArray(new String[0]));</span>
      OutputAnalyzer output = new OutputAnalyzer(pb.start());
      output.shouldHaveExitValue(0);
  
      return output;
    }
<span class="line-new-header">--- 218,11 ---</span>
      finalargs.addAll(Arrays.asList(vmargs));
      finalargs.addAll(Arrays.asList(whiteboxOpts));
      finalargs.add(classname);
      finalargs.addAll(Arrays.asList(arguments));
  
<span class="line-modified">!     ProcessBuilder pb = GCArguments.createJavaProcessBuilder(finalargs.toArray(new String[0]));</span>
      OutputAnalyzer output = new OutputAnalyzer(pb.start());
      output.shouldHaveExitValue(0);
  
      return output;
    }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 277,11 ***</span>
        output.shouldNotContain(message);
      }
    }
  
    private static void expect(String[] flags, boolean hasWarning, boolean hasError, int errorcode) throws Exception {
<span class="line-modified">!     ProcessBuilder pb = ProcessTools.createJavaProcessBuilder(flags);</span>
      OutputAnalyzer output = new OutputAnalyzer(pb.start());
      shouldContainOrNot(output, hasWarning, &quot;Warning&quot;);
      shouldContainOrNot(output, hasError, &quot;Error&quot;);
      output.shouldHaveExitValue(errorcode);
    }
<span class="line-new-header">--- 318,11 ---</span>
        output.shouldNotContain(message);
      }
    }
  
    private static void expect(String[] flags, boolean hasWarning, boolean hasError, int errorcode) throws Exception {
<span class="line-modified">!     ProcessBuilder pb = GCArguments.createJavaProcessBuilder(flags);</span>
      OutputAnalyzer output = new OutputAnalyzer(pb.start());
      shouldContainOrNot(output, hasWarning, &quot;Warning&quot;);
      shouldContainOrNot(output, hasError, &quot;Error&quot;);
      output.shouldHaveExitValue(errorcode);
    }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 292,6 ***</span>
  
    private static void expectValid(String[] flags) throws Exception {
      expect(flags, false, false, 0);
    }
  }
<span class="line-removed">- </span>
<span class="line-new-header">--- 333,5 ---</span>
</pre>
<center><a href="TestInitialTenuringThreshold.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="TestMaxMinHeapFreeRatioFlags.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>