<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/hotspot/jtreg/gc/g1/mixedgc/TestLogging.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="../humongousObjects/TestNoAllocationsInHRegions.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="TestOldGenCollectionUsage.java.udiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/jtreg/gc/g1/mixedgc/TestLogging.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2015, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2015, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -19,70 +19,65 @@</span>
   * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
   * or visit www.oracle.com if you need additional information or have any
   * questions.
   */
  
<span class="udiff-line-added">+ package gc.g1.mixedgc;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ import java.util.ArrayList;</span>
<span class="udiff-line-added">+ import java.util.Collections;</span>
<span class="udiff-line-added">+ import java.util.List;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ import gc.testlibrary.g1.MixedGCProvoker;</span>
<span class="udiff-line-added">+ import jdk.test.lib.process.OutputAnalyzer;</span>
<span class="udiff-line-added">+ import jdk.test.lib.process.ProcessTools;</span>
<span class="udiff-line-added">+ </span>
  /*
   * @test TestLogging
   * @summary Check that a mixed GC is reflected in the gc logs
   * @requires vm.gc.G1
   * @requires vm.opt.MaxGCPauseMillis == &quot;null&quot;
<span class="udiff-line-modified-removed">-  * @library /test/lib</span>
<span class="udiff-line-modified-added">+  * @library /test/lib /</span>
   * @modules java.base/jdk.internal.misc
   * @modules java.management
   * @build sun.hotspot.WhiteBox
   * @run driver ClassFileInstaller sun.hotspot.WhiteBox
   * @run driver gc.g1.mixedgc.TestLogging
   */
  
<span class="udiff-line-removed">- package gc.g1.mixedgc;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- import jdk.test.lib.process.OutputAnalyzer;</span>
<span class="udiff-line-removed">- import jdk.test.lib.process.ProcessTools;</span>
<span class="udiff-line-removed">- import jdk.test.lib.Asserts;</span>
<span class="udiff-line-removed">- import sun.hotspot.WhiteBox;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- import java.util.ArrayList;</span>
<span class="udiff-line-removed">- import java.util.List;</span>
<span class="udiff-line-removed">- import java.util.Collections;</span>
<span class="udiff-line-removed">- </span>
  /**
   * Test spawns MixedGCProvoker in a separate VM and expects to find a message
   * telling that a mixed gc has happened
   */
  public class TestLogging {
      private static final String[] COMMON_OPTIONS = new String[]{
              &quot;-Xbootclasspath/a:.&quot;, &quot;-XX:+UseG1GC&quot;,
              &quot;-XX:+UnlockExperimentalVMOptions&quot;,
              &quot;-XX:+UnlockDiagnosticVMOptions&quot;,
              &quot;-XX:+WhiteBoxAPI&quot;,
<span class="udiff-line-modified-removed">-             &quot;-XX:SurvivorRatio=1&quot;, // Survivor-to-eden ratio is 1:1</span>
<span class="udiff-line-modified-removed">-             &quot;-Xms10M&quot;, &quot;-Xmx10M&quot;,</span>
<span class="udiff-line-removed">-             &quot;-XX:MaxTenuringThreshold=1&quot;, // promote objects after first gc</span>
<span class="udiff-line-modified-added">+             &quot;-Xms10M&quot;, &quot;-Xmx10M&quot;, &quot;-XX:NewSize=2M&quot;, &quot;-XX:MaxNewSize=2M&quot;,</span>
<span class="udiff-line-modified-added">+             &quot;-XX:+AlwaysTenure&quot;, // surviving promote objects immediately</span>
              &quot;-XX:InitiatingHeapOccupancyPercent=100&quot;, // set initial CMC threshold and disable adaptive IHOP
              &quot;-XX:-G1UseAdaptiveIHOP&quot;,                 // to avoid additional concurrent cycles caused by ergonomics
              &quot;-XX:G1MixedGCCountTarget=4&quot;,
              &quot;-XX:MaxGCPauseMillis=30000&quot;, // to have enough time
              &quot;-XX:G1HeapRegionSize=1m&quot;, &quot;-XX:G1HeapWastePercent=0&quot;,
              &quot;-XX:G1MixedGCLiveThresholdPercent=100&quot;};
  
<span class="udiff-line-removed">-     public static final int ALLOCATION_SIZE = 20000;</span>
<span class="udiff-line-removed">-     public static final int ALLOCATION_COUNT = 15;</span>
<span class="udiff-line-removed">- </span>
      public static void main(String args[]) throws Exception {
          // Test turns logging on by giving -Xlog:gc flag
<span class="udiff-line-modified-removed">-         test(&quot;-Xlog:gc&quot;);</span>
<span class="udiff-line-modified-added">+         test(&quot;-Xlog:gc,gc+heap=debug&quot;);</span>
          // Test turns logging on by giving -Xlog:gc=debug flag
<span class="udiff-line-modified-removed">-         test(&quot;-Xlog:gc=debug&quot;);</span>
<span class="udiff-line-modified-added">+         test(&quot;-Xlog:gc=debug,gc+heap=debug&quot;);</span>
      }
  
      private static void test(String vmFlag) throws Exception {
          System.out.println(String.format(&quot;%s: running with %s flag&quot;, TestLogging.class.getSimpleName(), vmFlag));
          OutputAnalyzer output = spawnMixedGCProvoker(vmFlag);
          System.out.println(output.getStdout());
          output.shouldHaveExitValue(0);
<span class="udiff-line-modified-removed">-         output.shouldContain(&quot;Pause Young (Mixed) (G1 Evacuation Pause)&quot;);</span>
<span class="udiff-line-modified-added">+         output.shouldContain(&quot;Pause Young (Mixed)&quot;);</span>
      }
  
      /**
       * Method spawns MixedGCProvoker with addition flags set
       *
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -91,92 +86,20 @@</span>
      private static OutputAnalyzer spawnMixedGCProvoker(String... extraFlags)
              throws Exception {
          List&lt;String&gt; testOpts = new ArrayList&lt;&gt;();
          Collections.addAll(testOpts, COMMON_OPTIONS);
          Collections.addAll(testOpts, extraFlags);
<span class="udiff-line-modified-removed">-         testOpts.add(MixedGCProvoker.class.getName());</span>
<span class="udiff-line-modified-added">+         testOpts.add(RunMixedGC.class.getName());</span>
          System.out.println(testOpts);
          ProcessBuilder pb = ProcessTools.createJavaProcessBuilder(false,
                  testOpts.toArray(new String[testOpts.size()]));
          return new OutputAnalyzer(pb.start());
      }
  }
  
<span class="udiff-line-modified-removed">- /**</span>
<span class="udiff-line-modified-removed">-  * Utility class to guarantee a mixed GC. The class allocates several arrays and</span>
<span class="udiff-line-modified-removed">-  * promotes them to the oldgen. After that it tries to provoke mixed GC by</span>
<span class="udiff-line-modified-removed">-  * allocating new objects.</span>
<span class="udiff-line-removed">-  *</span>
<span class="udiff-line-removed">-  * The necessary condition for guaranteed mixed GC is running MixedGCProvoker is</span>
<span class="udiff-line-removed">-  * running in VM with the following flags: -XX:MaxTenuringThreshold=1, -Xms10M,</span>
<span class="udiff-line-removed">-  * -Xmx10M, -XX:G1MixedGCLiveThresholdPercent=100, -XX:G1HeapWastePercent=0,</span>
<span class="udiff-line-removed">-  * -XX:G1HeapRegionSize=1m</span>
<span class="udiff-line-removed">-  */</span>
<span class="udiff-line-removed">- class MixedGCProvoker {</span>
<span class="udiff-line-removed">-     private static final WhiteBox WB = WhiteBox.getWhiteBox();</span>
<span class="udiff-line-removed">-     private static final List&lt;byte[]&gt; liveOldObjects = new ArrayList&lt;&gt;();</span>
<span class="udiff-line-removed">-     private static final List&lt;byte[]&gt; newObjects = new ArrayList&lt;&gt;();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private static void allocateOldObjects() throws Exception {</span>
<span class="udiff-line-removed">-         List&lt;byte[]&gt; deadOldObjects = new ArrayList&lt;&gt;();</span>
<span class="udiff-line-removed">-         // Allocates buffer and promotes it to the old gen. Mix live and dead old</span>
<span class="udiff-line-removed">-         // objects</span>
<span class="udiff-line-removed">-         for (int i = 0; i &lt; TestLogging.ALLOCATION_COUNT; ++i) {</span>
<span class="udiff-line-removed">-             liveOldObjects.add(new byte[TestLogging.ALLOCATION_SIZE * 5]);</span>
<span class="udiff-line-removed">-             deadOldObjects.add(new byte[TestLogging.ALLOCATION_SIZE * 5]);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         // need only 2 promotions to promote objects to the old gen</span>
<span class="udiff-line-removed">-         WB.youngGC();</span>
<span class="udiff-line-removed">-         WB.youngGC();</span>
<span class="udiff-line-removed">-         // check it is promoted &amp; keep alive</span>
<span class="udiff-line-removed">-         Asserts.assertTrue(WB.isObjectInOldGen(liveOldObjects),</span>
<span class="udiff-line-removed">-                 &quot;List of the objects is suppose to be in OldGen&quot;);</span>
<span class="udiff-line-removed">-         Asserts.assertTrue(WB.isObjectInOldGen(deadOldObjects),</span>
<span class="udiff-line-removed">-                 &quot;List of the objects is suppose to be in OldGen&quot;);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     /**</span>
<span class="udiff-line-removed">-      * Waits until Concurent Mark Cycle finishes</span>
<span class="udiff-line-removed">-      * @param wb  Whitebox instance</span>
<span class="udiff-line-removed">-      * @param sleepTime sleep time</span>
<span class="udiff-line-removed">-      */</span>
<span class="udiff-line-removed">-     public static void waitTillCMCFinished(WhiteBox wb, int sleepTime) {</span>
<span class="udiff-line-removed">-         while (wb.g1InConcurrentMark()) {</span>
<span class="udiff-line-removed">-             if (sleepTime &gt; -1) {</span>
<span class="udiff-line-removed">-                 try {</span>
<span class="udiff-line-removed">-                     Thread.sleep(sleepTime);</span>
<span class="udiff-line-removed">-                 } catch (InterruptedException e) {</span>
<span class="udiff-line-removed">-                     System.out.println(&quot;Got InterruptedException while waiting for ConcMarkCycle to finish&quot;);</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     public static void main(String args[]) throws Exception {</span>
<span class="udiff-line-removed">-         // allocate old objects</span>
<span class="udiff-line-removed">-         allocateOldObjects();</span>
<span class="udiff-line-removed">-         waitTillCMCFinished(WB, 0);</span>
<span class="udiff-line-removed">-         WB.g1StartConcMarkCycle();</span>
<span class="udiff-line-removed">-         waitTillCMCFinished(WB, 0);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         WB.youngGC();</span>
<span class="udiff-line-removed">-         System.out.println(&quot;Allocating new objects to provoke mixed GC&quot;);</span>
<span class="udiff-line-removed">-         // allocate more objects to provoke GC</span>
<span class="udiff-line-removed">-         for (int i = 0; i &lt; (TestLogging.ALLOCATION_COUNT * 20); i++) {</span>
<span class="udiff-line-removed">-             try {</span>
<span class="udiff-line-removed">-                 newObjects.add(new byte[TestLogging.ALLOCATION_SIZE]);</span>
<span class="udiff-line-removed">-             } catch (OutOfMemoryError e) {</span>
<span class="udiff-line-removed">-                 newObjects.clear();</span>
<span class="udiff-line-removed">-                 WB.youngGC();</span>
<span class="udiff-line-removed">-                 WB.youngGC();</span>
<span class="udiff-line-removed">-                 break;</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         // check that liveOldObjects still alive</span>
<span class="udiff-line-removed">-         Asserts.assertTrue(WB.isObjectInOldGen(liveOldObjects),</span>
<span class="udiff-line-removed">-                 &quot;List of the objects is suppose to be in OldGen&quot;);</span>
<span class="udiff-line-modified-added">+ class RunMixedGC {</span>
<span class="udiff-line-modified-added">+     public static void main(String[] args) {</span>
<span class="udiff-line-modified-added">+         final int MB = 1024 * 1024;</span>
<span class="udiff-line-modified-added">+         MixedGCProvoker.allocateAndProvokeMixedGC(MB);</span>
      }
  }
<span class="udiff-line-added">+ </span>
</pre>
<center><a href="../humongousObjects/TestNoAllocationsInHRegions.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="TestOldGenCollectionUsage.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>