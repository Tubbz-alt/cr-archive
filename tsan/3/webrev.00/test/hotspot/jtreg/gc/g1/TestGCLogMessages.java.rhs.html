<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/hotspot/jtreg/gc/g1/TestGCLogMessages.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
    <script type="text/javascript" src="../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2014, 2020, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 package gc.g1;
 25 
 26 /*
 27  * @test TestGCLogMessages
 28  * @bug 8035406 8027295 8035398 8019342 8027959 8048179 8027962 8069330 8076463 8150630 8160055 8177059 8166191
 29  * @summary Ensure the output for a minor GC with G1
 30  * includes the expected necessary messages.
 31  * @key gc
 32  * @requires vm.gc.G1
 33  * @library /test/lib
 34  * @modules java.base/jdk.internal.misc
 35  *          java.management
 36  * @build sun.hotspot.WhiteBox
 37  * @run driver ClassFileInstaller sun.hotspot.WhiteBox
<a name="2" id="anc2"></a><span class="line-modified"> 38  *                                sun.hotspot.WhiteBox$WhiteBoxPermission</span>
<span class="line-added"> 39  * @run main/othervm -Xbootclasspath/a:. -XX:+UnlockDiagnosticVMOptions -XX:+WhiteBoxAPI</span>
<span class="line-added"> 40  *                   gc.g1.TestGCLogMessages</span>
 41  */
 42 
 43 import jdk.test.lib.process.OutputAnalyzer;
 44 import jdk.test.lib.process.ProcessTools;
<a name="3" id="anc3"></a><span class="line-modified"> 45 import sun.hotspot.code.Compiler;</span>
 46 
 47 public class TestGCLogMessages {
 48 
 49     private enum Level {
 50         OFF(&quot;&quot;),
 51         INFO(&quot;info&quot;),
 52         DEBUG(&quot;debug&quot;),
 53         TRACE(&quot;trace&quot;);
 54 
 55         private String logName;
 56 
 57         Level(String logName) {
 58             this.logName = logName;
 59         }
 60 
 61         public boolean lessThan(Level other) {
 62             return this.compareTo(other) &lt; 0;
 63         }
 64 
 65         public String toString() {
 66             return logName;
 67         }
 68     }
 69 
 70     private class LogMessageWithLevel {
 71         String message;
 72         Level level;
 73 
 74         public LogMessageWithLevel(String message, Level level) {
 75             this.message = message;
 76             this.level = level;
 77         }
 78 
 79         public boolean isAvailable() {
 80             return true;
 81         }
 82     };
 83 
 84     private class LogMessageWithLevelC2OrJVMCIOnly extends LogMessageWithLevel {
 85         public LogMessageWithLevelC2OrJVMCIOnly(String message, Level level) {
 86             super(message, level);
 87         }
 88 
 89         public boolean isAvailable() {
<a name="4" id="anc4"></a><span class="line-modified"> 90             return Compiler.isC2OrJVMCIIncludedInVmBuild();</span>
 91         }
 92     }
 93 
 94     private LogMessageWithLevel allLogMessages[] = new LogMessageWithLevel[] {
 95         new LogMessageWithLevel(&quot;Pre Evacuate Collection Set&quot;, Level.INFO),
 96         new LogMessageWithLevel(&quot;Evacuate Collection Set&quot;, Level.INFO),
 97         new LogMessageWithLevel(&quot;Post Evacuate Collection Set&quot;, Level.INFO),
 98         new LogMessageWithLevel(&quot;Other&quot;, Level.INFO),
 99 
<a name="5" id="anc5"></a><span class="line-modified">100         // Merge Heap Roots</span>
<span class="line-modified">101         new LogMessageWithLevel(&quot;Merge Heap Roots&quot;, Level.INFO),</span>
<span class="line-modified">102         new LogMessageWithLevel(&quot;Prepare Merge Heap Roots&quot;, Level.DEBUG),</span>
<span class="line-modified">103         new LogMessageWithLevel(&quot;Eager Reclaim&quot;, Level.DEBUG),</span>
<span class="line-added">104         new LogMessageWithLevel(&quot;Remembered Sets&quot;, Level.DEBUG),</span>
<span class="line-added">105         new LogMessageWithLevel(&quot;Merged Sparse&quot;, Level.DEBUG),</span>
<span class="line-added">106         new LogMessageWithLevel(&quot;Merged Fine&quot;, Level.DEBUG),</span>
<span class="line-added">107         new LogMessageWithLevel(&quot;Merged Coarse&quot;, Level.DEBUG),</span>
<span class="line-added">108         new LogMessageWithLevel(&quot;Hot Card Cache&quot;, Level.DEBUG),</span>
<span class="line-added">109         new LogMessageWithLevel(&quot;Log Buffers&quot;, Level.DEBUG),</span>
<span class="line-added">110         new LogMessageWithLevel(&quot;Dirty Cards&quot;, Level.DEBUG),</span>
111         new LogMessageWithLevel(&quot;Skipped Cards&quot;, Level.DEBUG),
<a name="6" id="anc6"></a><span class="line-modified">112         // Scan Heap Roots</span>
<span class="line-modified">113         new LogMessageWithLevel(&quot;Scan Heap Roots&quot;, Level.DEBUG),</span>

114         new LogMessageWithLevel(&quot;Scanned Cards&quot;, Level.DEBUG),
<a name="7" id="anc7"></a><span class="line-modified">115         new LogMessageWithLevel(&quot;Scanned Blocks&quot;, Level.DEBUG),</span>
<span class="line-modified">116         new LogMessageWithLevel(&quot;Claimed Chunks&quot;, Level.DEBUG),</span>
<span class="line-added">117         // Code Roots Scan</span>
<span class="line-added">118         new LogMessageWithLevel(&quot;Code Root Scan&quot;, Level.DEBUG),</span>
119         // Object Copy
120         new LogMessageWithLevel(&quot;Object Copy&quot;, Level.DEBUG),
<a name="8" id="anc8"></a><span class="line-modified">121         new LogMessageWithLevel(&quot;Copied Bytes&quot;, Level.DEBUG),</span>
<span class="line-modified">122         new LogMessageWithLevel(&quot;LAB Waste&quot;, Level.DEBUG),</span>
<span class="line-added">123         new LogMessageWithLevel(&quot;LAB Undo Waste&quot;, Level.DEBUG),</span>
124         // Ext Root Scan
125         new LogMessageWithLevel(&quot;Thread Roots&quot;, Level.TRACE),
126         new LogMessageWithLevel(&quot;Universe Roots&quot;, Level.TRACE),
127         new LogMessageWithLevel(&quot;JNI Handles Roots&quot;, Level.TRACE),
128         new LogMessageWithLevel(&quot;ObjectSynchronizer Roots&quot;, Level.TRACE),
129         new LogMessageWithLevel(&quot;Management Roots&quot;, Level.TRACE),
130         new LogMessageWithLevel(&quot;SystemDictionary Roots&quot;, Level.TRACE),
131         new LogMessageWithLevel(&quot;CLDG Roots&quot;, Level.TRACE),
132         new LogMessageWithLevel(&quot;JVMTI Roots&quot;, Level.TRACE),
<a name="9" id="anc9"></a>
133         new LogMessageWithLevel(&quot;CM RefProcessor Roots&quot;, Level.TRACE),
<a name="10" id="anc10"></a>

134         // Redirty Cards
135         new LogMessageWithLevel(&quot;Redirty Cards&quot;, Level.DEBUG),
136         new LogMessageWithLevel(&quot;Parallel Redirty&quot;, Level.TRACE),
137         new LogMessageWithLevel(&quot;Redirtied Cards&quot;, Level.TRACE),
138         // Misc Top-level
139         new LogMessageWithLevel(&quot;Code Roots Purge&quot;, Level.DEBUG),
140         new LogMessageWithLevel(&quot;String Deduplication&quot;, Level.DEBUG),
141         new LogMessageWithLevel(&quot;Queue Fixup&quot;, Level.DEBUG),
142         new LogMessageWithLevel(&quot;Table Fixup&quot;, Level.DEBUG),
143         new LogMessageWithLevel(&quot;Expand Heap After Collection&quot;, Level.DEBUG),
<a name="11" id="anc11"></a><span class="line-added">144         new LogMessageWithLevel(&quot;Region Register&quot;, Level.DEBUG),</span>
<span class="line-added">145         new LogMessageWithLevel(&quot;Prepare Heap Roots&quot;, Level.DEBUG),</span>
146         // Free CSet
147         new LogMessageWithLevel(&quot;Free Collection Set&quot;, Level.DEBUG),
<a name="12" id="anc12"></a><span class="line-modified">148         new LogMessageWithLevel(&quot;Serial Free Collection Set&quot;, Level.TRACE),</span>
<span class="line-added">149         new LogMessageWithLevel(&quot;Parallel Free Collection Set&quot;, Level.TRACE),</span>
150         new LogMessageWithLevel(&quot;Young Free Collection Set&quot;, Level.TRACE),
151         new LogMessageWithLevel(&quot;Non-Young Free Collection Set&quot;, Level.TRACE),
<a name="13" id="anc13"></a><span class="line-added">152         // Rebuild Free List</span>
<span class="line-added">153         new LogMessageWithLevel(&quot;Rebuild Free List&quot;, Level.DEBUG),</span>
<span class="line-added">154         new LogMessageWithLevel(&quot;Serial Rebuild Free List&quot;, Level.TRACE),</span>
<span class="line-added">155         new LogMessageWithLevel(&quot;Parallel Rebuild Free List&quot;, Level.TRACE),</span>
<span class="line-added">156 </span>
157         // Humongous Eager Reclaim
158         new LogMessageWithLevel(&quot;Humongous Reclaim&quot;, Level.DEBUG),
<a name="14" id="anc14"></a>
159         // Merge PSS
160         new LogMessageWithLevel(&quot;Merge Per-Thread State&quot;, Level.DEBUG),
161         // TLAB handling
162         new LogMessageWithLevel(&quot;Prepare TLABs&quot;, Level.DEBUG),
163         new LogMessageWithLevel(&quot;Resize TLABs&quot;, Level.DEBUG),
164         // Reference Processing
165         new LogMessageWithLevel(&quot;Reference Processing&quot;, Level.DEBUG),
166         // VM internal reference processing
167         new LogMessageWithLevel(&quot;Weak Processing&quot;, Level.DEBUG),
<a name="15" id="anc15"></a><span class="line-modified">168         new LogMessageWithLevel(&quot;JNI weak&quot;, Level.DEBUG),</span>
<span class="line-modified">169         new LogMessageWithLevel(&quot;StringTable weak&quot;, Level.DEBUG),</span>
<span class="line-modified">170         new LogMessageWithLevel(&quot;ResolvedMethodTable weak&quot;, Level.DEBUG),</span>
<span class="line-added">171         new LogMessageWithLevel(&quot;VM weak&quot;, Level.DEBUG),</span>
172 
173         new LogMessageWithLevelC2OrJVMCIOnly(&quot;DerivedPointerTable Update&quot;, Level.DEBUG),
174         new LogMessageWithLevel(&quot;Start New Collection Set&quot;, Level.DEBUG),
175     };
176 
177     void checkMessagesAtLevel(OutputAnalyzer output, LogMessageWithLevel messages[], Level level) throws Exception {
178         for (LogMessageWithLevel l : messages) {
179             if (level.lessThan(l.level) || !l.isAvailable()) {
180                 output.shouldNotContain(l.message);
181             } else {
182                 output.shouldMatch(&quot;\\[&quot; + l.level + &quot;.*&quot; + l.message);
183             }
184         }
185     }
186 
187     public static void main(String[] args) throws Exception {
188         new TestGCLogMessages().testNormalLogs();
189         new TestGCLogMessages().testWithToSpaceExhaustionLogs();
190         new TestGCLogMessages().testWithInitialMark();
191         new TestGCLogMessages().testExpandHeap();
192     }
193 
194     private void testNormalLogs() throws Exception {
195 
196         ProcessBuilder pb = ProcessTools.createJavaProcessBuilder(&quot;-XX:+UseG1GC&quot;,
197                                                                   &quot;-Xmx10M&quot;,
198                                                                   GCTest.class.getName());
199 
200         OutputAnalyzer output = new OutputAnalyzer(pb.start());
201         checkMessagesAtLevel(output, allLogMessages, Level.OFF);
202         output.shouldHaveExitValue(0);
203 
204         pb = ProcessTools.createJavaProcessBuilder(&quot;-XX:+UseG1GC&quot;,
205                                                    &quot;-XX:+UseStringDeduplication&quot;,
206                                                    &quot;-Xmx10M&quot;,
207                                                    &quot;-Xlog:gc+phases=debug&quot;,
208                                                    GCTest.class.getName());
209 
210         output = new OutputAnalyzer(pb.start());
211         checkMessagesAtLevel(output, allLogMessages, Level.DEBUG);
212 
213         pb = ProcessTools.createJavaProcessBuilder(&quot;-XX:+UseG1GC&quot;,
214                                                    &quot;-XX:+UseStringDeduplication&quot;,
215                                                    &quot;-Xmx10M&quot;,
216                                                    &quot;-Xlog:gc+phases=trace&quot;,
217                                                    GCTest.class.getName());
218 
219         output = new OutputAnalyzer(pb.start());
220         checkMessagesAtLevel(output, allLogMessages, Level.TRACE);
221         output.shouldHaveExitValue(0);
222     }
223 
224     LogMessageWithLevel exhFailureMessages[] = new LogMessageWithLevel[] {
225         new LogMessageWithLevel(&quot;Evacuation Failure&quot;, Level.DEBUG),
226         new LogMessageWithLevel(&quot;Recalculate Used&quot;, Level.TRACE),
227         new LogMessageWithLevel(&quot;Remove Self Forwards&quot;, Level.TRACE),
228     };
229 
230     private void testWithToSpaceExhaustionLogs() throws Exception {
231         ProcessBuilder pb = ProcessTools.createJavaProcessBuilder(&quot;-XX:+UseG1GC&quot;,
232                                                                   &quot;-Xmx32M&quot;,
233                                                                   &quot;-Xmn16M&quot;,
234                                                                   &quot;-Xlog:gc+phases=debug&quot;,
235                                                                   GCTestWithToSpaceExhaustion.class.getName());
236 
237         OutputAnalyzer output = new OutputAnalyzer(pb.start());
238         checkMessagesAtLevel(output, exhFailureMessages, Level.DEBUG);
239         output.shouldHaveExitValue(0);
240 
241         pb = ProcessTools.createJavaProcessBuilder(&quot;-XX:+UseG1GC&quot;,
242                                                    &quot;-Xmx32M&quot;,
243                                                    &quot;-Xmn16M&quot;,
244                                                    &quot;-Xlog:gc+phases=trace&quot;,
245                                                    GCTestWithToSpaceExhaustion.class.getName());
246 
247         output = new OutputAnalyzer(pb.start());
248         checkMessagesAtLevel(output, exhFailureMessages, Level.TRACE);
249         output.shouldHaveExitValue(0);
250     }
251 
252     private void testWithInitialMark() throws Exception {
253         ProcessBuilder pb = ProcessTools.createJavaProcessBuilder(&quot;-XX:+UseG1GC&quot;,
254                                                                   &quot;-Xmx10M&quot;,
255                                                                   &quot;-Xbootclasspath/a:.&quot;,
256                                                                   &quot;-Xlog:gc*=debug&quot;,
257                                                                   &quot;-XX:+UnlockDiagnosticVMOptions&quot;,
258                                                                   &quot;-XX:+WhiteBoxAPI&quot;,
259                                                                   GCTestWithInitialMark.class.getName());
260 
261         OutputAnalyzer output = new OutputAnalyzer(pb.start());
262         output.shouldContain(&quot;Clear Claimed Marks&quot;);
263         output.shouldHaveExitValue(0);
264     }
265 
266     private void testExpandHeap() throws Exception {
267         ProcessBuilder pb = ProcessTools.createJavaProcessBuilder(&quot;-XX:+UseG1GC&quot;,
268                                                                   &quot;-Xmx10M&quot;,
269                                                                   &quot;-Xbootclasspath/a:.&quot;,
270                                                                   &quot;-Xlog:gc+ergo+heap=debug&quot;,
271                                                                   &quot;-XX:+UnlockDiagnosticVMOptions&quot;,
272                                                                   &quot;-XX:+WhiteBoxAPI&quot;,
273                                                                   GCTest.class.getName());
274 
275         OutputAnalyzer output = new OutputAnalyzer(pb.start());
276         output.shouldContain(&quot;Expand the heap. requested expansion amount: &quot;);
277         output.shouldContain(&quot;B expansion amount: &quot;);
278         output.shouldHaveExitValue(0);
279     }
280 
281 
282     static class GCTest {
283         private static byte[] garbage;
284         public static void main(String [] args) {
285             System.out.println(&quot;Creating garbage&quot;);
286             // create 128MB of garbage. This should result in at least one GC
287             for (int i = 0; i &lt; 1024; i++) {
288                 garbage = new byte[128 * 1024];
289             }
290             System.out.println(&quot;Done&quot;);
291         }
292     }
293 
294     static class GCTestWithToSpaceExhaustion {
295         private static byte[] garbage;
296         private static byte[] largeObject;
297         public static void main(String [] args) {
298             largeObject = new byte[16*1024*1024];
299             System.out.println(&quot;Creating garbage&quot;);
300             // create 128MB of garbage. This should result in at least one GC,
301             // some of them with to-space exhaustion.
302             for (int i = 0; i &lt; 1024; i++) {
303                 garbage = new byte[128 * 1024];
304             }
305             System.out.println(&quot;Done&quot;);
306         }
307     }
308 
309     static class GCTestWithInitialMark {
310         public static void main(String [] args) {
311             sun.hotspot.WhiteBox WB = sun.hotspot.WhiteBox.getWhiteBox();
312             WB.g1StartConcMarkCycle();
313         }
314     }
315 
316 }
317 
<a name="16" id="anc16"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="16" type="hidden" />
</body>
</html>