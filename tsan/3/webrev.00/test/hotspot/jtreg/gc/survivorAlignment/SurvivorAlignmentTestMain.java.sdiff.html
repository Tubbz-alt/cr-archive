<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/hotspot/jtreg/gc/survivorAlignment/SurvivorAlignmentTestMain.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="../stress/systemgc/TestSystemGCWithShenandoah.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="TestAllocationInEden.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/jtreg/gc/survivorAlignment/SurvivorAlignmentTestMain.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 54     public static final long MAX_TENURING_THRESHOLD = Optional.ofNullable(
 55             SurvivorAlignmentTestMain.WHITE_BOX.getIntxVMFlag(
 56                     &quot;MaxTenuringThreshold&quot;)).orElse(15L);
 57 
 58     /**
 59      * Regexp used to parse memory size params, like 2G, 34m or 15k.
 60      */
 61     private static final Pattern SIZE_REGEX
 62             = Pattern.compile(&quot;(?&lt;size&gt;[0-9]+)(?&lt;multiplier&gt;[GMKgmk])?&quot;);
 63 
 64     // Names of different heap spaces.
 65     private static final String DEF_NEW_EDEN = &quot;Eden Space&quot;;
 66     private static final String DEF_NEW_SURVIVOR = &quot;Survivor Space&quot;;
 67     private static final String PAR_NEW_EDEN = &quot;Par Eden Space&quot;;
 68     private static final String PAR_NEW_SURVIVOR = &quot;Par Survivor Space&quot;;
 69     private static final String PS_EDEN = &quot;PS Eden Space&quot;;
 70     private static final String PS_SURVIVOR = &quot;PS Survivor Space&quot;;
 71     private static final String G1_EDEN = &quot;G1 Eden Space&quot;;
 72     private static final String G1_SURVIVOR = &quot;G1 Survivor Space&quot;;
 73     private static final String SERIAL_TENURED = &quot;Tenured Gen&quot;;
<span class="line-removed"> 74     private static final String CMS_TENURED = &quot;CMS Old Gen&quot;;</span>
 75     private static final String PS_TENURED = &quot;PS Old Gen&quot;;
 76     private static final String G1_TENURED = &quot;G1 Old Gen&quot;;
 77 
 78     private static final long G1_HEAP_REGION_SIZE = Optional.ofNullable(
 79             SurvivorAlignmentTestMain.WHITE_BOX.getUintxVMFlag(
 80                     &quot;G1HeapRegionSize&quot;)).orElse(-1L);
 81 
<span class="line-removed"> 82     /**</span>
<span class="line-removed"> 83      * Min size of free chunk in CMS generation.</span>
<span class="line-removed"> 84      * An object allocated in CMS generation will at least occupy this amount</span>
<span class="line-removed"> 85      * of bytes.</span>
<span class="line-removed"> 86      */</span>
<span class="line-removed"> 87     private static final long CMS_MIN_FREE_CHUNK_SIZE</span>
<span class="line-removed"> 88             = 3L * Unsafe.ADDRESS_SIZE;</span>
<span class="line-removed"> 89 </span>
 90     private static final AlignmentHelper EDEN_SPACE_HELPER;
 91     private static final AlignmentHelper SURVIVOR_SPACE_HELPER;
 92     private static final AlignmentHelper TENURED_SPACE_HELPER;
 93     /**
 94      * Amount of memory that should be filled during a test run.
 95      */
 96     private final long memoryToFill;
 97     /**
 98      * The size of an objects that will be allocated during a test run.
 99      */
100     private final long objectSize;
101     /**
102      * Amount of memory that will be actually occupied by an object in eden
103      * space.
104      */
105     private final long actualObjectSize;
106     /**
107      * Storage for allocated objects.
108      */
109     private final Object[] garbage;
110     /**
111      * Heap space whose memory usage is a subject of assertions during the test
112      * run.
113      */
114     private final HeapSpace testedSpace;
115 
116     private long[] baselinedThreadMemoryUsage = null;
117     private long[] threadIds = null;
118 
119     /**
120      * Initialize {@code EDEN_SPACE_HELPER}, {@code SURVIVOR_SPACE_HELPER} and
121      * {@code TENURED_SPACE_HELPER} to represent heap spaces in use.
122      *
123      * Note that regardless to GC object&#39;s alignment in survivor space is
124      * expected to be equal to {@code SurvivorAlignmentInBytes} value and
125      * alignment in other spaces is expected to be equal to
126      * {@code ObjectAlignmentInBytes} value.
127      *
<span class="line-removed">128      * In CMS generation we can&#39;t allocate less then {@code MinFreeChunk} value,</span>
<span class="line-removed">129      * for other CGs we expect that object of size {@code MIN_OBJECT_SIZE}</span>
<span class="line-removed">130      * could be allocated as it is (of course, its size could be aligned</span>
<span class="line-removed">131      * according to alignment value used in a particular space).</span>
<span class="line-removed">132      *</span>
133      * For G1 GC MXBeans could report memory usage only with region size
134      * precision (if an object allocated in some G1 heap region, then all region
135      * will claimed as used), so for G1&#39;s spaces precision is equal to
136      * {@code G1HeapRegionSize} value.
137      */
138     static {
139         AlignmentHelper edenHelper = null;
140         AlignmentHelper survivorHelper = null;
141         AlignmentHelper tenuredHelper = null;
142         for (MemoryPoolMXBean pool : ManagementFactory.getMemoryPoolMXBeans()) {
143             switch (pool.getName()) {
144                 case SurvivorAlignmentTestMain.DEF_NEW_EDEN:
145                 case SurvivorAlignmentTestMain.PAR_NEW_EDEN:
146                 case SurvivorAlignmentTestMain.PS_EDEN:
147                     Asserts.assertNull(edenHelper,
148                             &quot;Only one bean for eden space is expected.&quot;);
149                     edenHelper = new AlignmentHelper(
150                             AlignmentHelper.OBJECT_ALIGNMENT_IN_BYTES,
151                             AlignmentHelper.OBJECT_ALIGNMENT_IN_BYTES,
152                             AlignmentHelper.MIN_OBJECT_SIZE, pool);
</pre>
<hr />
<pre>
170                             AlignmentHelper.MIN_OBJECT_SIZE, pool);
171                     break;
172                 case SurvivorAlignmentTestMain.G1_SURVIVOR:
173                     Asserts.assertNull(survivorHelper,
174                             &quot;Only one bean for survivor space is expected.&quot;);
175                     survivorHelper = new AlignmentHelper(
176                             SurvivorAlignmentTestMain.G1_HEAP_REGION_SIZE,
177                             AlignmentHelper.SURVIVOR_ALIGNMENT_IN_BYTES,
178                             AlignmentHelper.MIN_OBJECT_SIZE, pool);
179                     break;
180                 case SurvivorAlignmentTestMain.SERIAL_TENURED:
181                 case SurvivorAlignmentTestMain.PS_TENURED:
182                 case SurvivorAlignmentTestMain.G1_TENURED:
183                     Asserts.assertNull(tenuredHelper,
184                             &quot;Only one bean for tenured space is expected.&quot;);
185                     tenuredHelper = new AlignmentHelper(
186                             AlignmentHelper.OBJECT_ALIGNMENT_IN_BYTES,
187                             AlignmentHelper.OBJECT_ALIGNMENT_IN_BYTES,
188                             AlignmentHelper.MIN_OBJECT_SIZE, pool);
189                     break;
<span class="line-removed">190                 case SurvivorAlignmentTestMain.CMS_TENURED:</span>
<span class="line-removed">191                     Asserts.assertNull(tenuredHelper,</span>
<span class="line-removed">192                             &quot;Only one bean for tenured space is expected.&quot;);</span>
<span class="line-removed">193                     tenuredHelper = new AlignmentHelper(</span>
<span class="line-removed">194                             AlignmentHelper.OBJECT_ALIGNMENT_IN_BYTES,</span>
<span class="line-removed">195                             AlignmentHelper.OBJECT_ALIGNMENT_IN_BYTES,</span>
<span class="line-removed">196                             SurvivorAlignmentTestMain.CMS_MIN_FREE_CHUNK_SIZE,</span>
<span class="line-removed">197                             pool);</span>
<span class="line-removed">198                     break;</span>
199             }
200         }
201         EDEN_SPACE_HELPER = Objects.requireNonNull(edenHelper,
202                 &quot;AlignmentHelper for eden space should be initialized.&quot;);
203         SURVIVOR_SPACE_HELPER = Objects.requireNonNull(survivorHelper,
204                 &quot;AlignmentHelper for survivor space should be initialized.&quot;);
205         TENURED_SPACE_HELPER = Objects.requireNonNull(tenuredHelper,
206                 &quot;AlignmentHelper for tenured space should be initialized.&quot;);
207     }
208     /**
209      * Returns an SurvivorAlignmentTestMain instance constructed using CLI
210      * options.
211      *
212      * Following options are expected:
213      * &lt;ul&gt;
214      *     &lt;li&gt;memoryToFill&lt;/li&gt;
215      *     &lt;li&gt;objectSize&lt;/li&gt;
216      * &lt;/ul&gt;
217      *
218      * Both argument may contain multiplier suffix k, m or g.
</pre>
</td>
<td>
<hr />
<pre>
 54     public static final long MAX_TENURING_THRESHOLD = Optional.ofNullable(
 55             SurvivorAlignmentTestMain.WHITE_BOX.getIntxVMFlag(
 56                     &quot;MaxTenuringThreshold&quot;)).orElse(15L);
 57 
 58     /**
 59      * Regexp used to parse memory size params, like 2G, 34m or 15k.
 60      */
 61     private static final Pattern SIZE_REGEX
 62             = Pattern.compile(&quot;(?&lt;size&gt;[0-9]+)(?&lt;multiplier&gt;[GMKgmk])?&quot;);
 63 
 64     // Names of different heap spaces.
 65     private static final String DEF_NEW_EDEN = &quot;Eden Space&quot;;
 66     private static final String DEF_NEW_SURVIVOR = &quot;Survivor Space&quot;;
 67     private static final String PAR_NEW_EDEN = &quot;Par Eden Space&quot;;
 68     private static final String PAR_NEW_SURVIVOR = &quot;Par Survivor Space&quot;;
 69     private static final String PS_EDEN = &quot;PS Eden Space&quot;;
 70     private static final String PS_SURVIVOR = &quot;PS Survivor Space&quot;;
 71     private static final String G1_EDEN = &quot;G1 Eden Space&quot;;
 72     private static final String G1_SURVIVOR = &quot;G1 Survivor Space&quot;;
 73     private static final String SERIAL_TENURED = &quot;Tenured Gen&quot;;

 74     private static final String PS_TENURED = &quot;PS Old Gen&quot;;
 75     private static final String G1_TENURED = &quot;G1 Old Gen&quot;;
 76 
 77     private static final long G1_HEAP_REGION_SIZE = Optional.ofNullable(
 78             SurvivorAlignmentTestMain.WHITE_BOX.getUintxVMFlag(
 79                     &quot;G1HeapRegionSize&quot;)).orElse(-1L);
 80 








 81     private static final AlignmentHelper EDEN_SPACE_HELPER;
 82     private static final AlignmentHelper SURVIVOR_SPACE_HELPER;
 83     private static final AlignmentHelper TENURED_SPACE_HELPER;
 84     /**
 85      * Amount of memory that should be filled during a test run.
 86      */
 87     private final long memoryToFill;
 88     /**
 89      * The size of an objects that will be allocated during a test run.
 90      */
 91     private final long objectSize;
 92     /**
 93      * Amount of memory that will be actually occupied by an object in eden
 94      * space.
 95      */
 96     private final long actualObjectSize;
 97     /**
 98      * Storage for allocated objects.
 99      */
100     private final Object[] garbage;
101     /**
102      * Heap space whose memory usage is a subject of assertions during the test
103      * run.
104      */
105     private final HeapSpace testedSpace;
106 
107     private long[] baselinedThreadMemoryUsage = null;
108     private long[] threadIds = null;
109 
110     /**
111      * Initialize {@code EDEN_SPACE_HELPER}, {@code SURVIVOR_SPACE_HELPER} and
112      * {@code TENURED_SPACE_HELPER} to represent heap spaces in use.
113      *
114      * Note that regardless to GC object&#39;s alignment in survivor space is
115      * expected to be equal to {@code SurvivorAlignmentInBytes} value and
116      * alignment in other spaces is expected to be equal to
117      * {@code ObjectAlignmentInBytes} value.
118      *





119      * For G1 GC MXBeans could report memory usage only with region size
120      * precision (if an object allocated in some G1 heap region, then all region
121      * will claimed as used), so for G1&#39;s spaces precision is equal to
122      * {@code G1HeapRegionSize} value.
123      */
124     static {
125         AlignmentHelper edenHelper = null;
126         AlignmentHelper survivorHelper = null;
127         AlignmentHelper tenuredHelper = null;
128         for (MemoryPoolMXBean pool : ManagementFactory.getMemoryPoolMXBeans()) {
129             switch (pool.getName()) {
130                 case SurvivorAlignmentTestMain.DEF_NEW_EDEN:
131                 case SurvivorAlignmentTestMain.PAR_NEW_EDEN:
132                 case SurvivorAlignmentTestMain.PS_EDEN:
133                     Asserts.assertNull(edenHelper,
134                             &quot;Only one bean for eden space is expected.&quot;);
135                     edenHelper = new AlignmentHelper(
136                             AlignmentHelper.OBJECT_ALIGNMENT_IN_BYTES,
137                             AlignmentHelper.OBJECT_ALIGNMENT_IN_BYTES,
138                             AlignmentHelper.MIN_OBJECT_SIZE, pool);
</pre>
<hr />
<pre>
156                             AlignmentHelper.MIN_OBJECT_SIZE, pool);
157                     break;
158                 case SurvivorAlignmentTestMain.G1_SURVIVOR:
159                     Asserts.assertNull(survivorHelper,
160                             &quot;Only one bean for survivor space is expected.&quot;);
161                     survivorHelper = new AlignmentHelper(
162                             SurvivorAlignmentTestMain.G1_HEAP_REGION_SIZE,
163                             AlignmentHelper.SURVIVOR_ALIGNMENT_IN_BYTES,
164                             AlignmentHelper.MIN_OBJECT_SIZE, pool);
165                     break;
166                 case SurvivorAlignmentTestMain.SERIAL_TENURED:
167                 case SurvivorAlignmentTestMain.PS_TENURED:
168                 case SurvivorAlignmentTestMain.G1_TENURED:
169                     Asserts.assertNull(tenuredHelper,
170                             &quot;Only one bean for tenured space is expected.&quot;);
171                     tenuredHelper = new AlignmentHelper(
172                             AlignmentHelper.OBJECT_ALIGNMENT_IN_BYTES,
173                             AlignmentHelper.OBJECT_ALIGNMENT_IN_BYTES,
174                             AlignmentHelper.MIN_OBJECT_SIZE, pool);
175                     break;









176             }
177         }
178         EDEN_SPACE_HELPER = Objects.requireNonNull(edenHelper,
179                 &quot;AlignmentHelper for eden space should be initialized.&quot;);
180         SURVIVOR_SPACE_HELPER = Objects.requireNonNull(survivorHelper,
181                 &quot;AlignmentHelper for survivor space should be initialized.&quot;);
182         TENURED_SPACE_HELPER = Objects.requireNonNull(tenuredHelper,
183                 &quot;AlignmentHelper for tenured space should be initialized.&quot;);
184     }
185     /**
186      * Returns an SurvivorAlignmentTestMain instance constructed using CLI
187      * options.
188      *
189      * Following options are expected:
190      * &lt;ul&gt;
191      *     &lt;li&gt;memoryToFill&lt;/li&gt;
192      *     &lt;li&gt;objectSize&lt;/li&gt;
193      * &lt;/ul&gt;
194      *
195      * Both argument may contain multiplier suffix k, m or g.
</pre>
</td>
</tr>
</table>
<center><a href="../stress/systemgc/TestSystemGCWithShenandoah.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="TestAllocationInEden.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>