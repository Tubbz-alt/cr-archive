<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old test/hotspot/jtreg/gc/logging/TestMetaSpaceLog.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2018, 2019, Oracle and/or its affiliates. All rights reserved.
  3  * Copyright (c) 2018, Google and/or its affiliates. All rights reserved.
  4  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  5  *
  6  * This code is free software; you can redistribute it and/or modify it
  7  * under the terms of the GNU General Public License version 2 only, as
  8  * published by the Free Software Foundation.
  9  *
 10  * This code is distributed in the hope that it will be useful, but WITHOUT
 11  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 12  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 13  * version 2 for more details (a copy is included in the LICENSE file that
 14  * accompanied this code).
 15  *
 16  * You should have received a copy of the GNU General Public License version
 17  * 2 along with this work; if not, write to the Free Software Foundation,
 18  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 19  *
 20  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 21  * or visit www.oracle.com if you need additional information or have any
 22  * questions.
 23  */
 24 
 25 package gc.logging;
 26 
 27 import java.io.File;
 28 import java.net.URL;
 29 import java.net.URLClassLoader;
 30 import java.util.regex.Pattern;
 31 import java.util.regex.Matcher;
 32 
 33 import jdk.test.lib.Asserts;
 34 import jdk.test.lib.process.OutputAnalyzer;
 35 import jdk.test.lib.process.ProcessTools;
 36 import sun.hotspot.WhiteBox;
 37 
 38 /*
 39  * @test TestMetaSpaceLog
 40  * @bug 8211123
 41  * @summary Ensure that the Metaspace is updated in the log
 42  * @requires vm.gc==&quot;null&quot;
 43  * @key gc
 44  * @library /test/lib
 45  * @modules java.base/jdk.internal.misc
 46  *          java.management
 47  *
 48  * @compile TestMetaSpaceLog.java
 49  * @run driver ClassFileInstaller sun.hotspot.WhiteBox
 50  * @run main gc.logging.TestMetaSpaceLog
 51  */
 52 
 53 public class TestMetaSpaceLog {
 54   private static Pattern metaSpaceRegexp;
 55 
 56   static {
 57     // Do this once here.
 58     metaSpaceRegexp = Pattern.compile(&quot;.*Metaspace: ([0-9]+).*-&gt;([0-9]+).*&quot;);
 59   }
 60 
 61   public static void main(String[] args) throws Exception {
 62     testMetaSpaceUpdate(&quot;UseParallelGC&quot;);
 63     testMetaSpaceUpdate(&quot;UseG1GC&quot;);
 64     testMetaSpaceUpdate(&quot;UseConcMarkSweepGC&quot;);
 65     testMetaSpaceUpdate(&quot;UseSerialGC&quot;);
 66   }
 67 
 68   private static void verifyContainsMetaSpaceUpdate(OutputAnalyzer output) {
 69     // At least one metaspace line from GC should show GC being collected.
 70     boolean foundCollectedMetaSpace = output.asLines().stream()
 71         .filter(s -&gt; s.contains(&quot;[gc,metaspace&quot;))
 72         .anyMatch(TestMetaSpaceLog::check);
 73     Asserts.assertTrue(foundCollectedMetaSpace);
 74   }
 75 
 76   private static boolean check(String line) {
 77     Matcher m = metaSpaceRegexp.matcher(line);
 78     Asserts.assertTrue(m.matches(), &quot;Unexpected line for metaspace logging: &quot; + line);
 79     long before = Long.parseLong(m.group(1));
 80     long after  = Long.parseLong(m.group(2));
 81     return before &gt; after;
 82   }
 83 
 84   private static void testMetaSpaceUpdate(String gcFlag) throws Exception {
 85     // Propagate test.src for the jar file.
 86     String testSrc= &quot;-Dtest.src=&quot; + System.getProperty(&quot;test.src&quot;, &quot;.&quot;);
 87 
 88     System.err.println(&quot;Testing with GC Flag: &quot; + gcFlag);
 89     ProcessBuilder pb =
 90       ProcessTools.createJavaProcessBuilder(
 91           &quot;-XX:+&quot; + gcFlag,
 92           &quot;-Xlog:gc*&quot;,
 93           &quot;-Xbootclasspath/a:.&quot;,
 94           &quot;-XX:+UnlockDiagnosticVMOptions&quot;,
 95           &quot;-XX:+WhiteBoxAPI&quot;,
 96           &quot;-Xmx1000M&quot;,
 97           &quot;-Xms1000M&quot;,
 98           testSrc, StressMetaSpace.class.getName());
 99 
100     OutputAnalyzer output = null;
101     try {
102       output = new OutputAnalyzer(pb.start());
103       verifyContainsMetaSpaceUpdate(output);
104     } catch (Exception e) {
105       // For error diagnosis: print and throw.
106       e.printStackTrace();
107       output.reportDiagnosticSummary();
108       throw e;
109     }
110   }
111 
112   static class StressMetaSpace {
113     private static URL[] urls = new URL[1];
114 
115     static {
116       try {
117         File jarFile = new File(System.getProperty(&quot;test.src&quot;) + &quot;/testcases.jar&quot;);
118         urls[0] = jarFile.toURI().toURL();
119       } catch (Exception e) {
120         e.printStackTrace();
121       }
122     }
123 
124     public static void main(String args[]) {
125       WhiteBox wb = WhiteBox.getWhiteBox();
126       for(int i = 0; i &lt; 10000; i++) {
127         loadClass(wb);
128       }
129       wb.fullGC();
130     }
131 
132     public static void loadClass(WhiteBox wb) {
133       try {
134         URLClassLoader ucl = new URLClassLoader(urls);
135         Class.forName(&quot;case00&quot;, false, ucl);
136       } catch (Exception e) {
137         e.printStackTrace();
138       }
139     }
140   }
141 }
    </pre>
  </body>
</html>