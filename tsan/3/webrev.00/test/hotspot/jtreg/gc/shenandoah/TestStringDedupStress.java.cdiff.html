<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff test/hotspot/jtreg/gc/shenandoah/TestStringDedupStress.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="TestStringDedup.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="TestStringInternCleanup.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/jtreg/gc/shenandoah/TestStringDedupStress.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
<span class="line-new-header">--- 1,8 ---</span>
  /*
   * Copyright (c) 2017, 2018, Red Hat, Inc. All rights reserved.
<span class="line-added">+  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.</span>
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
   *
</pre>
<hr />
<pre>
<span class="line-old-header">*** 19,74 ***</span>
   * or visit www.oracle.com if you need additional information or have any
   * questions.
   *
   */
  
<span class="line-modified">!  /*</span>
   * @test TestStringDedupStress
   * @summary Test Shenandoah string deduplication implementation
   * @key gc
<span class="line-modified">!  * @requires vm.gc.Shenandoah</span>
   * @library /test/lib
   * @modules java.base/jdk.internal.misc:open
   * @modules java.base/java.lang:open
   *          java.management
<span class="line-removed">-  * @run main/othervm -XX:+UnlockDiagnosticVMOptions -XX:+UnlockExperimentalVMOptions -XX:+UseShenandoahGC -XX:+UseStringDeduplication -Xmx512M -Xlog:gc+stats</span>
<span class="line-removed">-  *                   -DtargetStrings=3000000</span>
<span class="line-removed">-  *                   TestStringDedupStress</span>
   *
<span class="line-modified">!  * @run main/othervm -XX:+UnlockDiagnosticVMOptions -XX:+UnlockExperimentalVMOptions -XX:+UseShenandoahGC -XX:+UseStringDeduplication -Xmx512M -Xlog:gc+stats</span>
<span class="line-modified">!  *                   -XX:ShenandoahGCHeuristics=aggressive -DtargetStrings=2000000</span>
<span class="line-modified">!  *                   TestStringDedupStress</span>
   *
<span class="line-modified">!  * @run main/othervm -XX:+UnlockDiagnosticVMOptions -XX:+UnlockExperimentalVMOptions -XX:+UseShenandoahGC -XX:+UseStringDeduplication -Xmx512M -Xlog:gc+stats</span>
<span class="line-modified">!  *                   -XX:ShenandoahGCHeuristics=aggressive -XX:+ShenandoahOOMDuringEvacALot -DtargetStrings=2000000</span>
<span class="line-modified">!  *                    TestStringDedupStress</span>
   *
<span class="line-modified">!  * @run main/othervm -XX:+UnlockDiagnosticVMOptions -XX:+UnlockExperimentalVMOptions -XX:+UseShenandoahGC -XX:+UseStringDeduplication -Xmx512M -Xlog:gc+stats</span>
<span class="line-modified">!  *                   -XX:ShenandoahGCHeuristics=static -DtargetStrings=4000000</span>
<span class="line-modified">!  *                   TestStringDedupStress</span>
   *
<span class="line-modified">!  * @run main/othervm -XX:+UnlockDiagnosticVMOptions -XX:+UnlockExperimentalVMOptions -XX:+UseShenandoahGC -XX:+UseStringDeduplication -Xmx512M -Xlog:gc+stats</span>
<span class="line-modified">!  *                   -XX:ShenandoahGCHeuristics=compact</span>
<span class="line-modified">!  *                   TestStringDedupStress</span>
   *
<span class="line-modified">!  * @run main/othervm -XX:+UnlockDiagnosticVMOptions -XX:+UnlockExperimentalVMOptions -XX:+UseShenandoahGC -XX:+UseStringDeduplication -Xmx512M -Xlog:gc+stats</span>
<span class="line-modified">!  *                   -XX:ShenandoahGCHeuristics=passive -XX:+ShenandoahDegeneratedGC -DtargetOverwrites=40000000</span>
<span class="line-modified">!  *                   TestStringDedupStress</span>
   *
<span class="line-modified">!  * @run main/othervm -XX:+UnlockDiagnosticVMOptions -XX:+UnlockExperimentalVMOptions -XX:+UseShenandoahGC -XX:+UseStringDeduplication -Xmx512M -Xlog:gc+stats</span>
<span class="line-modified">!  *                   -XX:ShenandoahGCHeuristics=passive -XX:-ShenandoahDegeneratedGC -DtargetOverwrites=40000000</span>
<span class="line-modified">!  *                   TestStringDedupStress</span>
   *
<span class="line-modified">!  * @run main/othervm -XX:+UnlockDiagnosticVMOptions -XX:+UnlockExperimentalVMOptions -XX:+UseShenandoahGC -XX:+UseStringDeduplication -Xmx512M -Xlog:gc+stats</span>
<span class="line-modified">!  *                   -XX:ShenandoahGCHeuristics=traversal</span>
<span class="line-modified">!  *                   TestStringDedupStress</span>
   *
<span class="line-modified">!  * @run main/othervm -XX:+UnlockDiagnosticVMOptions -XX:+UnlockExperimentalVMOptions -XX:+UseShenandoahGC -XX:+UseStringDeduplication -Xmx512M -Xlog:gc+stats</span>
<span class="line-modified">!  *                   -XX:ShenandoahUpdateRefsEarly=off -DtargetStrings=3000000</span>
<span class="line-modified">!  *                   TestStringDedupStress</span>
   *
<span class="line-modified">!  * @run main/othervm -XX:+UnlockDiagnosticVMOptions -XX:+UnlockExperimentalVMOptions -XX:+UseShenandoahGC -XX:+UseStringDeduplication -Xmx512M -Xlog:gc+stats</span>
<span class="line-modified">!  *                   -XX:ShenandoahGCHeuristics=compact -XX:ShenandoahUpdateRefsEarly=off -DtargetStrings=2000000</span>
<span class="line-modified">!  *                   TestStringDedupStress</span>
   *
<span class="line-modified">!  * @run main/othervm -XX:+UnlockDiagnosticVMOptions -XX:+UnlockExperimentalVMOptions -XX:+UseShenandoahGC -XX:+UseStringDeduplication -Xmx512M -Xlog:gc+stats</span>
<span class="line-modified">!  *                   -XX:ShenandoahGCHeuristics=aggressive -XX:ShenandoahUpdateRefsEarly=off -DtargetStrings=2000000</span>
<span class="line-modified">!  *                   TestStringDedupStress</span>
   *
<span class="line-modified">!  * @run main/othervm -XX:+UnlockDiagnosticVMOptions -XX:+UnlockExperimentalVMOptions -XX:+UseShenandoahGC -XX:+UseStringDeduplication -Xmx512M -Xlog:gc+stats</span>
<span class="line-modified">!  *                   -XX:ShenandoahGCHeuristics=static -XX:ShenandoahUpdateRefsEarly=off -DtargetOverwrites=4000000</span>
<span class="line-modified">!  *                   TestStringDedupStress</span>
   *
<span class="line-modified">!  * @run main/othervm -XX:+UnlockDiagnosticVMOptions -XX:+UnlockExperimentalVMOptions -XX:+UseShenandoahGC -XX:+UseStringDeduplication -Xmx512M -Xlog:gc+stats</span>
<span class="line-modified">!  *                   -XX:ShenandoahGCHeuristics=aggressive -XX:ShenandoahUpdateRefsEarly=off -XX:+ShenandoahOOMDuringEvacALot -DtargetStrings=2000000</span>
<span class="line-modified">!  *                   TestStringDedupStress</span>
   *
<span class="line-modified">!  * @run main/othervm -XX:+UnlockDiagnosticVMOptions -XX:+UnlockExperimentalVMOptions -XX:+UseShenandoahGC -XX:+UseStringDeduplication -Xmx512M -Xlog:gc+stats</span>
<span class="line-modified">!  *                   -XX:ShenandoahGCHeuristics=traversal -XX:+ShenandoahOOMDuringEvacALot -DtargetStrings=2000000</span>
<span class="line-modified">!  *                   TestStringDedupStress</span>
   */
  
  import java.lang.management.*;
  import java.lang.reflect.*;
  import java.util.*;
<span class="line-new-header">--- 20,116 ---</span>
   * or visit www.oracle.com if you need additional information or have any
   * questions.
   *
   */
  
<span class="line-modified">! /*</span>
   * @test TestStringDedupStress
   * @summary Test Shenandoah string deduplication implementation
   * @key gc
<span class="line-modified">!  * @requires vm.gc.Shenandoah &amp; !vm.graal.enabled</span>
   * @library /test/lib
   * @modules java.base/jdk.internal.misc:open
   * @modules java.base/java.lang:open
   *          java.management
   *
<span class="line-modified">!  * @run main/othervm -Xmx1g -Xlog:gc+stats -Xlog:gc -XX:+UnlockDiagnosticVMOptions -XX:+UnlockExperimentalVMOptions -XX:+UseStringDeduplication</span>
<span class="line-modified">!  *      -XX:+UseShenandoahGC -XX:ShenandoahGCMode=passive</span>
<span class="line-modified">!  *      -XX:+ShenandoahDegeneratedGC</span>
<span class="line-added">+  *      TestStringDedupStress</span>
<span class="line-added">+  *</span>
<span class="line-added">+  * @run main/othervm -Xmx1g -Xlog:gc+stats -Xlog:gc -XX:+UnlockDiagnosticVMOptions -XX:+UnlockExperimentalVMOptions -XX:+UseStringDeduplication</span>
<span class="line-added">+  *      -XX:+UseShenandoahGC -XX:ShenandoahGCMode=passive</span>
<span class="line-added">+  *      -XX:-ShenandoahDegeneratedGC</span>
<span class="line-added">+  *      TestStringDedupStress</span>
<span class="line-added">+  */</span>
<span class="line-added">+ </span>
<span class="line-added">+ /*</span>
<span class="line-added">+  * @test TestStringDedupStress</span>
<span class="line-added">+  * @summary Test Shenandoah string deduplication implementation</span>
<span class="line-added">+  * @key gc</span>
<span class="line-added">+  * @requires vm.gc.Shenandoah &amp; !vm.graal.enabled</span>
<span class="line-added">+  * @library /test/lib</span>
<span class="line-added">+  * @modules java.base/jdk.internal.misc:open</span>
<span class="line-added">+  * @modules java.base/java.lang:open</span>
<span class="line-added">+  *          java.management</span>
   *
<span class="line-modified">!  * @run main/othervm -Xmx1g -Xlog:gc+stats -Xlog:gc -XX:+UnlockDiagnosticVMOptions -XX:+UnlockExperimentalVMOptions -XX:+UseStringDeduplication</span>
<span class="line-modified">!  *      -XX:+UseShenandoahGC</span>
<span class="line-modified">!  *      -DtargetStrings=3000000</span>
<span class="line-added">+  *      TestStringDedupStress</span>
   *
<span class="line-modified">!  * @run main/othervm -Xmx1g -Xlog:gc+stats -Xlog:gc -XX:+UnlockDiagnosticVMOptions -XX:+UnlockExperimentalVMOptions -XX:+UseStringDeduplication</span>
<span class="line-modified">!  *      -XX:+UseShenandoahGC -XX:ShenandoahGCHeuristics=aggressive</span>
<span class="line-modified">!  *      -DtargetStrings=2000000</span>
<span class="line-added">+  *      TestStringDedupStress</span>
   *
<span class="line-modified">!  * @run main/othervm -Xmx1g -Xlog:gc+stats -Xlog:gc -XX:+UnlockDiagnosticVMOptions -XX:+UnlockExperimentalVMOptions -XX:+UseStringDeduplication</span>
<span class="line-modified">!  *      -XX:+UseShenandoahGC -XX:ShenandoahGCHeuristics=aggressive</span>
<span class="line-modified">!  *      -XX:+ShenandoahOOMDuringEvacALot</span>
<span class="line-added">+  *      -DtargetStrings=2000000</span>
<span class="line-added">+  *      TestStringDedupStress</span>
   *
<span class="line-modified">!  * @run main/othervm -Xmx1g -Xlog:gc+stats -Xlog:gc -XX:+UnlockDiagnosticVMOptions -XX:+UnlockExperimentalVMOptions -XX:+UseStringDeduplication</span>
<span class="line-modified">!  *      -XX:+UseShenandoahGC -XX:ShenandoahGCHeuristics=compact</span>
<span class="line-modified">!  *      TestStringDedupStress</span>
   *
<span class="line-modified">!  * @run main/othervm -Xmx1g -Xlog:gc+stats -Xlog:gc -XX:+UnlockDiagnosticVMOptions -XX:+UnlockExperimentalVMOptions -XX:+UseStringDeduplication</span>
<span class="line-modified">!  *      -XX:+UseShenandoahGC</span>
<span class="line-modified">!  *      -XX:ShenandoahUpdateRefsEarly=off</span>
<span class="line-added">+  *      -DtargetStrings=3000000</span>
<span class="line-added">+  *      TestStringDedupStress</span>
   *
<span class="line-modified">!  * @run main/othervm -Xmx1g -Xlog:gc+stats -Xlog:gc -XX:+UnlockDiagnosticVMOptions -XX:+UnlockExperimentalVMOptions -XX:+UseStringDeduplication</span>
<span class="line-modified">!  *      -XX:+UseShenandoahGC -XX:ShenandoahGCHeuristics=compact</span>
<span class="line-modified">!  *      -XX:ShenandoahUpdateRefsEarly=off</span>
<span class="line-added">+  *      -DtargetStrings=2000000</span>
<span class="line-added">+  *      TestStringDedupStress</span>
   *
<span class="line-modified">!  * @run main/othervm -Xmx1g -Xlog:gc+stats -Xlog:gc -XX:+UnlockDiagnosticVMOptions -XX:+UnlockExperimentalVMOptions -XX:+UseStringDeduplication</span>
<span class="line-modified">!  *      -XX:+UseShenandoahGC -XX:ShenandoahGCHeuristics=aggressive</span>
<span class="line-modified">!  *      -XX:ShenandoahUpdateRefsEarly=off</span>
<span class="line-added">+  *      -DtargetStrings=2000000</span>
<span class="line-added">+  *      TestStringDedupStress</span>
   *
<span class="line-modified">!  * @run main/othervm -Xmx1g -Xlog:gc+stats -Xlog:gc -XX:+UnlockDiagnosticVMOptions -XX:+UnlockExperimentalVMOptions -XX:+UseStringDeduplication</span>
<span class="line-modified">!  *      -XX:+UseShenandoahGC -XX:ShenandoahGCHeuristics=aggressive</span>
<span class="line-modified">!  *      -XX:ShenandoahUpdateRefsEarly=off -XX:+ShenandoahOOMDuringEvacALot</span>
<span class="line-added">+  *      -DtargetStrings=2000000</span>
<span class="line-added">+  *      TestStringDedupStress</span>
<span class="line-added">+  */</span>
<span class="line-added">+ </span>
<span class="line-added">+  /*</span>
<span class="line-added">+  * @test TestStringDedupStress</span>
<span class="line-added">+  * @summary Test Shenandoah string deduplication implementation</span>
<span class="line-added">+  * @key gc</span>
<span class="line-added">+  * @requires vm.gc.Shenandoah &amp; !vm.graal.enabled</span>
<span class="line-added">+  * @library /test/lib</span>
<span class="line-added">+  * @modules java.base/jdk.internal.misc:open</span>
<span class="line-added">+  * @modules java.base/java.lang:open</span>
<span class="line-added">+  *          java.management</span>
   *
<span class="line-modified">!  * @run main/othervm -Xmx1g -Xlog:gc+stats -Xlog:gc -XX:+UnlockDiagnosticVMOptions -XX:+UnlockExperimentalVMOptions -XX:+UseStringDeduplication</span>
<span class="line-modified">!  *      -XX:+UseShenandoahGC -XX:ShenandoahGCMode=traversal</span>
<span class="line-modified">!  *      TestStringDedupStress</span>
   *
<span class="line-modified">!  * @run main/othervm -Xmx1g -Xlog:gc+stats -Xlog:gc -XX:+UnlockDiagnosticVMOptions -XX:+UnlockExperimentalVMOptions -XX:+UseStringDeduplication</span>
<span class="line-modified">!  *      -XX:+UseShenandoahGC -XX:ShenandoahGCMode=traversal -XX:ShenandoahGCHeuristics=aggressive</span>
<span class="line-modified">!  *      -DtargetStrings=2000000</span>
<span class="line-added">+  *      TestStringDedupStress</span>
   *
<span class="line-modified">!  * @run main/othervm -Xmx1g -Xlog:gc+stats -Xlog:gc -XX:+UnlockDiagnosticVMOptions -XX:+UnlockExperimentalVMOptions -XX:+UseStringDeduplication</span>
<span class="line-modified">!  *      -XX:+UseShenandoahGC -XX:ShenandoahGCMode=traversal</span>
<span class="line-modified">!  *      -XX:+ShenandoahOOMDuringEvacALot</span>
<span class="line-added">+  *      -DtargetStrings=2000000</span>
<span class="line-added">+  *      TestStringDedupStress</span>
   *
<span class="line-modified">!  * @run main/othervm -Xmx1g -Xlog:gc+stats -Xlog:gc -XX:+UnlockDiagnosticVMOptions -XX:+UnlockExperimentalVMOptions -XX:+UseStringDeduplication</span>
<span class="line-modified">!  *      -XX:+UseShenandoahGC -XX:ShenandoahGCMode=traversal -XX:ShenandoahGCHeuristics=aggressive</span>
<span class="line-modified">!  *      -XX:+ShenandoahOOMDuringEvacALot</span>
<span class="line-added">+  *      -DtargetStrings=2000000</span>
<span class="line-added">+  *      TestStringDedupStress</span>
   */
  
  import java.lang.management.*;
  import java.lang.reflect.*;
  import java.util.*;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 95,13 ***</span>
  
  public class TestStringDedupStress {
      private static Field valueField;
      private static Unsafe unsafe;
  
<span class="line-modified">!     private static long TARGET_STRINGS = Long.getLong(&quot;targetStrings&quot;, 2_500_000);</span>
<span class="line-removed">-     private static long TARGET_OVERWRITES = Long.getLong(&quot;targetOverwrites&quot;, 600_000);</span>
      private static final long MAX_REWRITE_GC_CYCLES = 6;
  
      private static final int UNIQUE_STRINGS = 20;
  
      static {
          try {
<span class="line-new-header">--- 138,13 ---</span>
  
  public class TestStringDedupStress {
      private static Field valueField;
      private static Unsafe unsafe;
  
<span class="line-modified">!     private static final int TARGET_STRINGS = Integer.getInteger(&quot;targetStrings&quot;, 2_500_000);</span>
      private static final long MAX_REWRITE_GC_CYCLES = 6;
<span class="line-added">+     private static final long MAX_REWRITE_TIME = 30*1000; // ms</span>
  
      private static final int UNIQUE_STRINGS = 20;
  
      static {
          try {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 149,12 ***</span>
              int n = rn.nextInt(uniqueStrings);
              strs.add(new StringAndId(&quot;Unique String &quot; + n, n));
          }
      }
  
<span class="line-modified">!     private static int verifyDedepString(ArrayList&lt;StringAndId&gt; strs) {</span>
<span class="line-modified">!         HashMap&lt;Object, StringAndId&gt; seen = new HashMap&lt;&gt;();</span>
          int total = 0;
          int dedup = 0;
  
          for (StringAndId item : strs) {
              total++;
<span class="line-new-header">--- 192,12 ---</span>
              int n = rn.nextInt(uniqueStrings);
              strs.add(new StringAndId(&quot;Unique String &quot; + n, n));
          }
      }
  
<span class="line-modified">!     private static int verifyDedupString(ArrayList&lt;StringAndId&gt; strs) {</span>
<span class="line-modified">!         Map&lt;Object, StringAndId&gt; seen = new HashMap&lt;&gt;(TARGET_STRINGS*2);</span>
          int total = 0;
          int dedup = 0;
  
          for (StringAndId item : strs) {
              total++;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 193,30 ***</span>
          if (gcCycleMBean == null) {
              throw new RuntimeException(&quot;Can not find Shenandoah GC cycle mbean&quot;);
          }
  
          // Generate roughly TARGET_STRINGS strings, only UNIQUE_STRINGS are unique
<span class="line-modified">!         long genIters = TARGET_STRINGS / UNIQUE_STRINGS;</span>
<span class="line-modified">!         for (long index = 0; index &lt; genIters; index++) {</span>
              generateStrings(astrs, UNIQUE_STRINGS);
          }
  
          long cycleBeforeRewrite = gcCycleMBean.getCollectionCount();
  
<span class="line-modified">!         for (long loop = 1; loop &lt; TARGET_OVERWRITES; loop++) {</span>
              int arrSize = astrs.size();
              int index = rn.nextInt(arrSize);
              StringAndId item = astrs.get(index);
              int n = rn.nextInt(UNIQUE_STRINGS);
              item.str = &quot;Unique String &quot; + n;
              item.id = n;
  
<span class="line-modified">!             if (loop % 1000 == 0) {</span>
                  // enough GC cycles for rewritten strings to be deduplicated
                  if (gcCycleMBean.getCollectionCount() - cycleBeforeRewrite &gt;= MAX_REWRITE_GC_CYCLES) {
                      break;
                  }
              }
          }
<span class="line-modified">!         verifyDedepString(astrs);</span>
      }
  }
<span class="line-new-header">--- 236,37 ---</span>
          if (gcCycleMBean == null) {
              throw new RuntimeException(&quot;Can not find Shenandoah GC cycle mbean&quot;);
          }
  
          // Generate roughly TARGET_STRINGS strings, only UNIQUE_STRINGS are unique
<span class="line-modified">!         int genIters = TARGET_STRINGS / UNIQUE_STRINGS;</span>
<span class="line-modified">!         for (int index = 0; index &lt; genIters; index++) {</span>
              generateStrings(astrs, UNIQUE_STRINGS);
          }
  
          long cycleBeforeRewrite = gcCycleMBean.getCollectionCount();
<span class="line-added">+         long timeBeforeRewrite = System.currentTimeMillis();</span>
  
<span class="line-modified">!         long loop = 1;</span>
<span class="line-added">+         while (true) {</span>
              int arrSize = astrs.size();
              int index = rn.nextInt(arrSize);
              StringAndId item = astrs.get(index);
              int n = rn.nextInt(UNIQUE_STRINGS);
              item.str = &quot;Unique String &quot; + n;
              item.id = n;
  
<span class="line-modified">!             if (loop++ % 1000 == 0) {</span>
                  // enough GC cycles for rewritten strings to be deduplicated
                  if (gcCycleMBean.getCollectionCount() - cycleBeforeRewrite &gt;= MAX_REWRITE_GC_CYCLES) {
                      break;
                  }
<span class="line-added">+ </span>
<span class="line-added">+                 // enough time is spent waiting for GC to happen</span>
<span class="line-added">+                 if (System.currentTimeMillis() - timeBeforeRewrite &gt;= MAX_REWRITE_TIME) {</span>
<span class="line-added">+                     break;</span>
<span class="line-added">+                 }</span>
              }
          }
<span class="line-modified">!         verifyDedupString(astrs);</span>
      }
  }
</pre>
<center><a href="TestStringDedup.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="TestStringInternCleanup.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>