<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New test/hotspot/jtreg/gc/shenandoah/compiler/TestReferenceCAS.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2016, 2018, Red Hat, Inc. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
 23  */
 24 
 25 /*
 26  * Run standalone with: --add-exports java.base/jdk.internal.misc=ALL-UNNAMED --add-opens java.base/jdk.internal.misc=ALL-UNNAMED
 27  */
 28 
 29 /*
 30  * @test TestReferenceCAS
 31  * @summary Shenandoah reference CAS test
 32  * @key gc
 33  * @requires vm.gc.Shenandoah &amp; !vm.graal.enabled
 34  * @modules java.base/jdk.internal.misc:+open
 35  *
 36  * @run main/othervm -Diters=20000 -XX:+UnlockDiagnosticVMOptions -XX:+UnlockExperimentalVMOptions -XX:ShenandoahGCHeuristics=aggressive -XX:+UseShenandoahGC                                                 TestReferenceCAS
 37  * @run main/othervm -Diters=100   -XX:+UnlockDiagnosticVMOptions -XX:+UnlockExperimentalVMOptions -XX:ShenandoahGCHeuristics=aggressive -XX:+UseShenandoahGC -Xint                                           TestReferenceCAS
 38  * @run main/othervm -Diters=20000 -XX:+UnlockDiagnosticVMOptions -XX:+UnlockExperimentalVMOptions -XX:ShenandoahGCHeuristics=aggressive -XX:+UseShenandoahGC -XX:-TieredCompilation                          TestReferenceCAS
 39  * @run main/othervm -Diters=20000 -XX:+UnlockDiagnosticVMOptions -XX:+UnlockExperimentalVMOptions -XX:ShenandoahGCHeuristics=aggressive -XX:+UseShenandoahGC -XX:TieredStopAtLevel=1                         TestReferenceCAS
 40  * @run main/othervm -Diters=20000 -XX:+UnlockDiagnosticVMOptions -XX:+UnlockExperimentalVMOptions -XX:ShenandoahGCHeuristics=aggressive -XX:+UseShenandoahGC -XX:TieredStopAtLevel=4                         TestReferenceCAS
 41  */
 42 
 43 /*
 44  * @test TestReferenceCAS
 45  * @summary Shenandoah reference CAS test
 46  * @key gc
 47  * @requires vm.gc.Shenandoah &amp; !vm.graal.enabled &amp; (vm.bits == &quot;64&quot;)
 48  * @modules java.base/jdk.internal.misc:+open
 49  *
 50  * @run main/othervm -Diters=20000 -XX:+UnlockDiagnosticVMOptions -XX:+UnlockExperimentalVMOptions -XX:ShenandoahGCHeuristics=aggressive -XX:+UseShenandoahGC -XX:-UseCompressedOops                          TestReferenceCAS
 51  * @run main/othervm -Diters=100   -XX:+UnlockDiagnosticVMOptions -XX:+UnlockExperimentalVMOptions -XX:ShenandoahGCHeuristics=aggressive -XX:+UseShenandoahGC -XX:-UseCompressedOops -Xint                    TestReferenceCAS
 52  * @run main/othervm -Diters=20000 -XX:+UnlockDiagnosticVMOptions -XX:+UnlockExperimentalVMOptions -XX:ShenandoahGCHeuristics=aggressive -XX:+UseShenandoahGC -XX:-UseCompressedOops -XX:-TieredCompilation   TestReferenceCAS
 53  * @run main/othervm -Diters=20000 -XX:+UnlockDiagnosticVMOptions -XX:+UnlockExperimentalVMOptions -XX:ShenandoahGCHeuristics=aggressive -XX:+UseShenandoahGC -XX:-UseCompressedOops -XX:TieredStopAtLevel=1  TestReferenceCAS
 54  * @run main/othervm -Diters=20000 -XX:+UnlockDiagnosticVMOptions -XX:+UnlockExperimentalVMOptions -XX:ShenandoahGCHeuristics=aggressive -XX:+UseShenandoahGC -XX:-UseCompressedOops -XX:TieredStopAtLevel=4  TestReferenceCAS
 55  */
 56 
 57 import java.lang.reflect.Field;
 58 
 59 public class TestReferenceCAS {
 60 
 61     static final int ITERS = Integer.getInteger(&quot;iters&quot;, 1);
 62     static final int WEAK_ATTEMPTS = Integer.getInteger(&quot;weakAttempts&quot;, 10);
 63 
 64     static final jdk.internal.misc.Unsafe UNSAFE;
 65     static final long V_OFFSET;
 66 
 67     static {
 68         try {
 69             Field f = jdk.internal.misc.Unsafe.class.getDeclaredField(&quot;theUnsafe&quot;);
 70             f.setAccessible(true);
 71             UNSAFE = (jdk.internal.misc.Unsafe) f.get(null);
 72         } catch (Exception e) {
 73             throw new RuntimeException(&quot;Unable to get Unsafe instance.&quot;, e);
 74         }
 75 
 76         try {
 77             Field vField = TestReferenceCAS.class.getDeclaredField(&quot;v&quot;);
 78             V_OFFSET = UNSAFE.objectFieldOffset(vField);
 79         } catch (Exception e) {
 80             throw new RuntimeException(e);
 81         }
 82     }
 83 
 84     Object v;
 85 
 86     private static void assertEquals(boolean a, boolean b, String msg) {
 87         if (a != b) {
 88             throw new RuntimeException(&quot;a (&quot; + a + &quot;) != b (&quot; + b + &quot;): &quot; + msg);
 89         }
 90     }
 91 
 92     private static void assertEquals(Object a, Object b, String msg) {
 93         if (!a.equals(b)) {
 94             throw new RuntimeException(&quot;a (&quot; + a.toString() + &quot;) != b (&quot; + b.toString() + &quot;): &quot; + msg);
 95         }
 96     }
 97 
 98     public static void main(String[] args) {
 99         TestReferenceCAS t = new TestReferenceCAS();
100         for (int c = 0; c &lt; ITERS; c++) {
101             testAccess(t, V_OFFSET);
102         }
103     }
104 
105     static void testAccess(Object base, long offset) {
106         String foo = new String(&quot;foo&quot;);
107         String bar = new String(&quot;bar&quot;);
108         String baz = new String(&quot;baz&quot;);
109         UNSAFE.putReference(base, offset, &quot;foo&quot;);
110         {
111             String newval = bar;
112             boolean r = UNSAFE.compareAndSetReference(base, offset, &quot;foo&quot;, newval);
113             assertEquals(r, true, &quot;success compareAndSet Object&quot;);
114             assertEquals(newval, &quot;bar&quot;, &quot;must not destroy newval&quot;);
115             Object x = UNSAFE.getReference(base, offset);
116             assertEquals(x, &quot;bar&quot;, &quot;success compareAndSet Object value&quot;);
117         }
118 
119         {
120             String newval = baz;
121             boolean r = UNSAFE.compareAndSetReference(base, offset, &quot;foo&quot;, newval);
122             assertEquals(r, false, &quot;failing compareAndSet Object&quot;);
123             assertEquals(newval, &quot;baz&quot;, &quot;must not destroy newval&quot;);
124             Object x = UNSAFE.getReference(base, offset);
125             assertEquals(x, &quot;bar&quot;, &quot;failing compareAndSet Object value&quot;);
126         }
127 
128         UNSAFE.putReference(base, offset, &quot;bar&quot;);
129         {
130             String newval = foo;
131             Object r = UNSAFE.compareAndExchangeReference(base, offset, &quot;bar&quot;, newval);
132             assertEquals(r, &quot;bar&quot;, &quot;success compareAndExchange Object&quot;);
133             assertEquals(newval, &quot;foo&quot;, &quot;must not destroy newval&quot;);
134             Object x = UNSAFE.getReference(base, offset);
135             assertEquals(x, &quot;foo&quot;, &quot;success compareAndExchange Object value&quot;);
136         }
137 
138         {
139             String newval = baz;
140             Object r = UNSAFE.compareAndExchangeReference(base, offset, &quot;bar&quot;, newval);
141             assertEquals(r, &quot;foo&quot;, &quot;failing compareAndExchange Object&quot;);
142             assertEquals(newval, &quot;baz&quot;, &quot;must not destroy newval&quot;);
143             Object x = UNSAFE.getReference(base, offset);
144             assertEquals(x, &quot;foo&quot;, &quot;failing compareAndExchange Object value&quot;);
145         }
146 
147         UNSAFE.putReference(base, offset, &quot;bar&quot;);
148         {
149             String newval = foo;
150             boolean success = false;
151             for (int c = 0; c &lt; WEAK_ATTEMPTS &amp;&amp; !success; c++) {
152                 success = UNSAFE.weakCompareAndSetReference(base, offset, &quot;bar&quot;, newval);
153                 assertEquals(newval, &quot;foo&quot;, &quot;must not destroy newval&quot;);
154             }
155             assertEquals(success, true, &quot;weakCompareAndSet Object&quot;);
156             Object x = UNSAFE.getReference(base, offset);
157             assertEquals(x, &quot;foo&quot;, &quot;weakCompareAndSet Object&quot;);
158         }
159     }
160 
161 }
    </pre>
  </body>
</html>