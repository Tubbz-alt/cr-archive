<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old test/hotspot/jtreg/runtime/LoaderConstraints/itableLdrConstraint/Test.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
  <body>
    <pre>
 1 /*
 2  * Copyright (c) 2017, 2018, Oracle and/or its affiliates. All rights reserved.
 3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 4  *
 5  * This code is free software; you can redistribute it and/or modify it
 6  * under the terms of the GNU General Public License version 2 only, as
 7  * published by the Free Software Foundation.
 8  *
 9  * This code is distributed in the hope that it will be useful, but WITHOUT
10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
12  * version 2 for more details (a copy is included in the LICENSE file that
13  * accompanied this code).
14  *
15  * You should have received a copy of the GNU General Public License version
16  * 2 along with this work; if not, write to the Free Software Foundation,
17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
18  *
19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
20  * or visit www.oracle.com if you need additional information or have any
21  * questions.
22  */
23 
24 /*
25  * @test
26  * @bug 8186092 8199852
27  * @compile ../common/Foo.java
28  *          ../common/J.java
29  *          I.java
30  *          ../common/C.jasm
31  *          Task.java
32  *          ../common/PreemptingClassLoader.java
33  * @run main/othervm Test
34  */
35 
36 public class Test {
37 
38     // Break expected error messages into 3 parts since the loader name includes its identity
39     // hash which is unique and can&#39;t be compared against.
40     static String expectedErrorMessage1_part1 = &quot;loader constraint violation in interface itable initialization for &quot; +
41                                                 &quot;class test.C: when selecting method test.I.m()Ltest/Foo; the class loader &quot; +
42                                                 &quot;PreemptingClassLoader @&quot;;
43     static String expectedErrorMessage1_part2 = &quot; for super interface test.I, and the class loader &#39;app&#39; of the &quot; +
44                                                 &quot;selected method&#39;s type, test.J have different Class objects for the &quot; +
45                                                 &quot;type test.Foo used in the signature (test.I is in unnamed module of loader &quot; +
46                                                 &quot;PreemptingClassLoader @&quot;;
47     static String expectedErrorMessage1_part3 = &quot;, parent loader &#39;app&#39;; test.J is in unnamed module of loader &#39;app&#39;)&quot;;
48 
49     static String expectedErrorMessage2_part1 = &quot;loader constraint violation in interface itable initialization for &quot; +
50                                                 &quot;class test.C: when selecting method test.I.m()Ltest/Foo; the class loader &quot; +
51                                                 &quot;&#39;ItableLdrCnstrnt_Test_Loader&#39; @&quot;;
52     static String expectedErrorMessage2_part2 = &quot; for super interface test.I, and the class loader &#39;app&#39; of the &quot; +
53                                                 &quot;selected method&#39;s type, test.J have different Class objects for the &quot; +
54                                                 &quot;type test.Foo used in the signature (test.I is in unnamed module of loader &quot; +
55                                                 &quot;&#39;ItableLdrCnstrnt_Test_Loader&#39; @&quot;;
56     static String expectedErrorMessage2_part3 = &quot;, parent loader &#39;app&#39;; test.J is in unnamed module of loader &#39;app&#39;)&quot;;
57 
58     // Test that the error message is correct when a loader constraint error is
59     // detected during itable creation.
60     //
61     // In this test, during itable creation for class C, method &quot;m()LFoo;&quot; for
62     // C&#39;s super interface I has a different class Foo than the selected method&#39;s
63     // type super interface J.  The selected method is not an overpass method nor
64     // otherwise excluded from loader constraint checking.  So, a LinkageError
65     // exception should be thrown because the loader constraint check will fail.
66     public static void test(String loaderName,
67                             String expectedErrorMessage_part1,
68                             String expectedErrorMessage_part2,
69                             String expectedErrorMessage_part3) throws Exception {
70         Class&lt;?&gt; c = test.Foo.class; // Forces standard class loader to load Foo.
71         String[] classNames = {&quot;test.Task&quot;, &quot;test.Foo&quot;, &quot;test.C&quot;, &quot;test.I&quot;};
72         ClassLoader l = new PreemptingClassLoader(loaderName, classNames);
73         Runnable r = (Runnable) l.loadClass(&quot;test.Task&quot;).newInstance();
74         try {
75             r.run();
76             throw new RuntimeException(&quot;Expected LinkageError exception not thrown&quot;);
77         } catch (LinkageError e) {
78             String errorMsg = e.getMessage();
79             if (!errorMsg.contains(expectedErrorMessage_part1) ||
80                 !errorMsg.contains(expectedErrorMessage_part2) ||
81                 !errorMsg.contains(expectedErrorMessage_part3)) {
82                 System.out.println(&quot;Expected: &quot; + expectedErrorMessage_part1 + &quot;&lt;id&gt;&quot; + expectedErrorMessage_part2 + &quot;\n&quot; +
83                                    &quot;but got:  &quot; + errorMsg);
84                 throw new RuntimeException(&quot;Wrong LinkageError exception thrown: &quot; + errorMsg);
85             }
86             System.out.println(&quot;Passed with message: &quot; + errorMsg);
87         }
88     }
89 
90     public static void main(String... args) throws Exception {
91         test(null, expectedErrorMessage1_part1, expectedErrorMessage1_part2, expectedErrorMessage1_part3);
92         test(&quot;ItableLdrCnstrnt_Test_Loader&quot;, expectedErrorMessage2_part1, expectedErrorMessage2_part2, expectedErrorMessage2_part3);
93     }
94 }
    </pre>
  </body>
</html>