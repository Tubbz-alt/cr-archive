<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/hotspot/jtreg/runtime/8007320/ConstMethodTest.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
    <script type="text/javascript" src="../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2013, 2016, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @bug 8007320 8014709 8163231
 27  * @summary Test all optional fields in ConstMethod
 28  * @compile -g -parameters ConstMethodTest.java
 29  * @run main ConstMethodTest
 30  */
 31 
 32 import java.util.*;
 33 import java.lang.annotation.*;
 34 import java.lang.reflect.*;
 35 import java.io.Serializable;
 36 
 37 @Retention(RetentionPolicy.RUNTIME)
 38 @interface MyAnnotation {
 39     public String name();
 40     public String value();
 41     public String date() default &quot;today&quot;;
 42 }
 43 
 44 @Target(ElementType.TYPE_USE)
 45 @Retention(RetentionPolicy.RUNTIME)
 46 @interface TypeAnno {
 47     String value();
 48 }
 49 
 50 @Target(ElementType.TYPE_USE)
 51 @Retention(RetentionPolicy.RUNTIME)
 52 @interface TypeAnno2 {
 53     String value();
 54 }
 55 
 56 @Retention(RetentionPolicy.RUNTIME)
 57 @Target(ElementType.PARAMETER)
 58 @interface Named {
 59   String value();
 60 }
 61 
 62 @Retention(RetentionPolicy.RUNTIME)
 63 @interface ScalarTypesWithDefault {
 64     byte     b()    default 11;
 65     short    s()    default 12;
 66     int      i()    default 13;
 67     long     l()    default 14;
 68     char     c()    default &#39;V&#39;;
 69 }
 70 
 71 // Some exception class
 72 class OkException extends RuntimeException {};
 73 
 74 
 75 @MyAnnotation(name=&quot;someName&quot;, value = &quot;Hello World&quot;)
 76 public class ConstMethodTest {
 77     public @TypeAnno(&quot;constructor&quot;) ConstMethodTest() { }
 78 
 79     public ConstMethodTest(int i) {
 80         // needs a second unannotated constructor
 81     }
 82 
 83     private static void check(boolean b) {
 84         if (!b)
 85             throw new RuntimeException();
 86     }
 87     private static void fail(String msg) {
 88        System.err.println(msg);
 89        throw new RuntimeException();
 90     }
 91     private static void equal(Object x, Object y) {
 92         if (x == null ? y == null : x.equals(y)) {
 93         } else {
 94             fail(x + &quot; not equal to &quot; + y);
 95         }
 96     }
 97     private static final String[] parameter_names = {
 98         &quot;parameter&quot;, &quot;parameter2&quot;, &quot;x&quot;
 99     };
100 
101     // Declare a function with everything in it.
102     @MyAnnotation(name=&quot;someName&quot;, value=&quot;Hello World&quot;)
103     static &lt;T&gt; void kitchenSinkFunc(@Named(value=&quot;aName&quot;) String parameter,
104               @Named(&quot;bName&quot;) String parameter2,
105               @ScalarTypesWithDefault T x)
106             throws @TypeAnno(&quot;RE&quot;) @TypeAnno2(&quot;RE2&quot;) RuntimeException,
107                 NullPointerException,
108                 @TypeAnno(&quot;AIOOBE&quot;) ArrayIndexOutOfBoundsException {
109       int i, j, k;
110       try {
111         System.out.println(&quot;calling kitchenSinkFunc &quot; + parameter);
112         throw new OkException();  // to see stack trace with line numbers
113       } catch (Exception e) {
114        e.printStackTrace();
115       }
116     }
117 
118     private static void test1() throws Throwable {
119         for (Method m : ConstMethodTest.class.getDeclaredMethods()) {
120             if (m.getName().equals(&quot;kitchenSinkFunc&quot;)) {
121                 Annotation[][] ann = m.getParameterAnnotations();
122                 equal(ann.length, 3);
123                 Annotation foo = ann[0][0];
124                 Annotation bar = ann[1][0];
<a name="2" id="anc2"></a><span class="line-modified">125                 equal(foo.toString(), &quot;@Named(value=\&quot;aName\&quot;)&quot;);</span>
<span class="line-modified">126                 equal(bar.toString(), &quot;@Named(value=\&quot;bName\&quot;)&quot;);</span>
127                 check(foo.equals(foo));
128                 check(bar.equals(bar));
129                 check(! foo.equals(bar));
130                 // method annotations
131                 Annotation[] ann2 = m.getAnnotations();
132                 equal(ann2.length, 1);
133                 Annotation mann = ann2[0];
134                 equal(mann.toString(), &quot;@MyAnnotation(date=\&quot;today\&quot;, name=\&quot;someName\&quot;, value=\&quot;Hello World\&quot;)&quot;);
135                 // Test Method parameter names
136                 Parameter[] parameters = m.getParameters();
137                 if(parameters == null)
138                     throw new Exception(&quot;getParameters should never be null&quot;);
139                 for(int i = 0; i &lt; parameters.length; i++) {
140                     Parameter p = parameters[i];
141                     equal(parameters[i].getName(), parameter_names[i]);
142                 }
143             }
144         }
145     }
146 
147     private static void testConstructor() throws Exception {
148         for (Constructor c : ConstMethodTest.class.getDeclaredConstructors()) {
149             Annotation[] aa = c.getAnnotatedReturnType().getAnnotations();
150             if (c.getParameterTypes().length == 1) { // should be un-annotated
151                 check(aa.length == 0);
152             } else if (c.getParameterTypes().length == 0) { //should be annotated
153                 check(aa.length == 1);
154                 check(((TypeAnno)aa[0]).value().equals(&quot;constructor&quot;));
155             } else {
156                 //should not happen
157                 check(false);
158             }
159         }
160     }
161 
162     public static void main(java.lang.String[] unused) throws Throwable {
163         // pass 5 so kitchenSinkFunc is instantiated with an int
164         kitchenSinkFunc(&quot;parameter&quot;, &quot;param2&quot;, 5);
165         test1();
166         testConstructor();
167     }
168 };
169 
<a name="3" id="anc3"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="3" type="hidden" />
</body>
</html>