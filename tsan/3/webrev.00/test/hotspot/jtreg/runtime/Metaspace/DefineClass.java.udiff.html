<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/hotspot/jtreg/runtime/Metaspace/DefineClass.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="../MemberName/MemberNameLeak.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="PrintMetaspaceDcmd.java.udiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/jtreg/runtime/Metaspace/DefineClass.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2018, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   * Copyright (c) 2017 SAP SE. All rights reserved.
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -27,18 +27,25 @@</span>
   * @bug 8173743
   * @requires vm.compMode != &quot;Xcomp&quot;
   * @summary Failures during class definition can lead to memory leaks in metaspace
   * @requires vm.opt.final.ClassUnloading
   * @library /test/lib
<span class="udiff-line-modified-removed">-  * @run main/othervm test.DefineClass defineClass</span>
<span class="udiff-line-modified-removed">-  * @run main/othervm test.DefineClass defineSystemClass</span>
<span class="udiff-line-modified-removed">-  * @run main/othervm -XX:+AllowParallelDefineClass</span>
<span class="udiff-line-modified-removed">-                      test.DefineClass defineClassParallel</span>
<span class="udiff-line-modified-removed">-  * @run main/othervm -XX:-AllowParallelDefineClass</span>
<span class="udiff-line-modified-removed">-                      test.DefineClass defineClassParallel</span>
<span class="udiff-line-modified-removed">-  * @run main/othervm -Djdk.attach.allowAttachSelf test.DefineClass redefineClass</span>
<span class="udiff-line-modified-removed">-  * @run main/othervm -Djdk.attach.allowAttachSelf test.DefineClass redefineClassWithError</span>
<span class="udiff-line-modified-added">+  * @build sun.hotspot.WhiteBox</span>
<span class="udiff-line-modified-added">+  * @run main ClassFileInstaller sun.hotspot.WhiteBox</span>
<span class="udiff-line-modified-added">+  *                              sun.hotspot.WhiteBox$WhiteBoxPermission</span>
<span class="udiff-line-modified-added">+  * @run main/othervm -Xbootclasspath/a:. -XX:+UnlockDiagnosticVMOptions -XX:+WhiteBoxAPI test.DefineClass defineClass</span>
<span class="udiff-line-modified-added">+  * @run main/othervm -Xbootclasspath/a:. -XX:+UnlockDiagnosticVMOptions -XX:+WhiteBoxAPI test.DefineClass defineSystemClass</span>
<span class="udiff-line-modified-added">+  * @run main/othervm -Xbootclasspath/a:. -XX:+UnlockDiagnosticVMOptions -XX:+WhiteBoxAPI</span>
<span class="udiff-line-modified-added">+  *                   -XX:+AllowParallelDefineClass</span>
<span class="udiff-line-modified-added">+  *                   test.DefineClass defineClassParallel</span>
<span class="udiff-line-added">+  * @run main/othervm -Xbootclasspath/a:. -XX:+UnlockDiagnosticVMOptions -XX:+WhiteBoxAPI</span>
<span class="udiff-line-added">+  *                   -XX:-AllowParallelDefineClass</span>
<span class="udiff-line-added">+  *                   test.DefineClass defineClassParallel</span>
<span class="udiff-line-added">+  * @run main/othervm -Xbootclasspath/a:. -XX:+UnlockDiagnosticVMOptions -XX:+WhiteBoxAPI</span>
<span class="udiff-line-added">+  *                   -Djdk.attach.allowAttachSelf test.DefineClass redefineClass</span>
<span class="udiff-line-added">+  * @run main/othervm -Xbootclasspath/a:. -XX:+UnlockDiagnosticVMOptions -XX:+WhiteBoxAPI</span>
<span class="udiff-line-added">+  *                   -Djdk.attach.allowAttachSelf test.DefineClass redefineClassWithError</span>
   * @author volker.simonis@gmail.com
   */
  
  package test;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -46,24 +53,20 @@</span>
  import java.io.File;
  import java.io.FileOutputStream;
  import java.io.InputStream;
  import java.lang.instrument.ClassDefinition;
  import java.lang.instrument.Instrumentation;
<span class="udiff-line-removed">- import java.lang.management.ManagementFactory;</span>
<span class="udiff-line-removed">- import java.util.Scanner;</span>
  import java.util.concurrent.CountDownLatch;
  import java.util.jar.Attributes;
  import java.util.jar.JarEntry;
  import java.util.jar.JarOutputStream;
  import java.util.jar.Manifest;
  
<span class="udiff-line-removed">- import javax.management.MBeanServer;</span>
<span class="udiff-line-removed">- import javax.management.ObjectName;</span>
<span class="udiff-line-removed">- </span>
  import com.sun.tools.attach.VirtualMachine;
  
  import jdk.test.lib.process.ProcessTools;
<span class="udiff-line-added">+ import sun.hotspot.WhiteBox;</span>
  
  public class DefineClass {
  
      private static Instrumentation instrumentation;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -203,49 +206,39 @@</span>
          for (int i = index; i &lt; index + name.length(); i++) {
              buf[i] = (byte)name.charAt(i - index);
          }
      }
  
<span class="udiff-line-modified-removed">-     private static MBeanServer mbserver = ManagementFactory.getPlatformMBeanServer();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private static int getClassStats(String pattern) {</span>
<span class="udiff-line-removed">-         try {</span>
<span class="udiff-line-removed">-             ObjectName diagCmd = new ObjectName(&quot;com.sun.management:type=DiagnosticCommand&quot;);</span>
<span class="udiff-line-modified-added">+     public static WhiteBox wb = WhiteBox.getWhiteBox();</span>
  
<span class="udiff-line-modified-removed">-             String result = (String)mbserver.invoke(diagCmd , &quot;gcClassStats&quot; , new Object[] { null }, new String[] {String[].class.getName()});</span>
<span class="udiff-line-modified-removed">-             int count = 0;</span>
<span class="udiff-line-removed">-             try (Scanner s = new Scanner(result)) {</span>
<span class="udiff-line-removed">-                 if (s.hasNextLine()) {</span>
<span class="udiff-line-removed">-                     System.out.println(s.nextLine());</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-                 while (s.hasNextLine()) {</span>
<span class="udiff-line-removed">-                     String l = s.nextLine();</span>
<span class="udiff-line-removed">-                     if (l.endsWith(pattern)) {</span>
<span class="udiff-line-removed">-                         count++;</span>
<span class="udiff-line-removed">-                         System.out.println(l);</span>
<span class="udiff-line-removed">-                     }</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             return count;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         catch (Exception e) {</span>
<span class="udiff-line-removed">-             throw new RuntimeException(&quot;Test failed because we can&#39;t read the class statistics!&quot;, e);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private static void printClassStats(int expectedCount, boolean reportError) {</span>
<span class="udiff-line-removed">-         int count = getClassStats(&quot;DefineClass&quot;);</span>
<span class="udiff-line-modified-added">+     private static void checkClasses(int expectedCount, boolean reportError) {</span>
<span class="udiff-line-modified-added">+         int count = wb.countAliveClasses(&quot;test.DefineClass&quot;);</span>
          String res = &quot;Should have &quot; + expectedCount +
                       &quot; DefineClass instances and we have: &quot; + count;
          System.out.println(res);
          if (reportError &amp;&amp; count != expectedCount) {
              throw new RuntimeException(res);
          }
      }
  
      public static final int ITERATIONS = 10;
  
<span class="udiff-line-added">+     private static void checkClassesAfterGC(int expectedCount) {</span>
<span class="udiff-line-added">+         // The first System.gc() doesn&#39;t clean metaspaces but triggers cleaning</span>
<span class="udiff-line-added">+         // for the next safepoint.</span>
<span class="udiff-line-added">+         // In the future the ServiceThread may clean metaspaces, but this loop</span>
<span class="udiff-line-added">+         // should give it enough time to run, when that is changed.</span>
<span class="udiff-line-added">+         // We might need to revisit this test though.</span>
<span class="udiff-line-added">+         for (int i = 0; i &lt; ITERATIONS; i++) {</span>
<span class="udiff-line-added">+             System.gc();</span>
<span class="udiff-line-added">+             System.out.println(&quot;System.gc()&quot;);</span>
<span class="udiff-line-added">+             // Break if the GC has cleaned metaspace before iterations.</span>
<span class="udiff-line-added">+             if (wb.countAliveClasses(&quot;test.DefineClass&quot;) == expectedCount) break;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         checkClasses(expectedCount, true);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      public static void main(String[] args) throws Exception {
          String myName = DefineClass.class.getName();
          byte[] buf = getBytecodes(myName.substring(myName.lastIndexOf(&quot;.&quot;) + 1));
          int iterations = (args.length &gt; 1 ? Integer.parseInt(args[1]) : ITERATIONS);
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -263,15 +256,14 @@</span>
                  }
              }
              // We expect to have two instances of DefineClass here: the initial version in which we are
              // executing and another version which was loaded into our own classloader &#39;MyClassLoader&#39;.
              // All the subsequent attempts to reload DefineClass into our &#39;MyClassLoader&#39; should have failed.
<span class="udiff-line-modified-removed">-             printClassStats(2, false);</span>
<span class="udiff-line-modified-removed">-             System.gc();</span>
<span class="udiff-line-modified-removed">-             System.out.println(&quot;System.gc()&quot;);</span>
<span class="udiff-line-modified-removed">-             // At least after System.gc() the failed loading attempts should leave no instances around!</span>
<span class="udiff-line-removed">-             printClassStats(2, true);</span>
<span class="udiff-line-modified-added">+             // The ClassLoaderDataGraph has the failed instances recorded at least until the next GC.</span>
<span class="udiff-line-modified-added">+             checkClasses(2, false);</span>
<span class="udiff-line-modified-added">+             // At least after some System.gc() the failed loading attempts should leave no instances around!</span>
<span class="udiff-line-modified-added">+             checkClassesAfterGC(2);</span>
          }
          else if (&quot;defineSystemClass&quot;.equals(args[0])) {
              MyClassLoader cl = new MyClassLoader();
              int index = getStringIndex(&quot;test/DefineClass&quot;, buf);
              replaceString(buf, &quot;java/DefineClass&quot;, index);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -291,15 +283,13 @@</span>
                      // Expected, because we&#39;re not allowed to define a class in the &#39;java&#39; package
                  }
              }
              // We expect to stay with one (the initial) instances of DefineClass.
              // All the subsequent attempts to reload DefineClass into the &#39;java&#39; package should have failed.
<span class="udiff-line-modified-removed">-             printClassStats(1, false);</span>
<span class="udiff-line-modified-removed">-             System.gc();</span>
<span class="udiff-line-modified-removed">-             System.out.println(&quot;System.gc()&quot;);</span>
<span class="udiff-line-removed">-             // At least after System.gc() the failed loading attempts should leave no instances around!</span>
<span class="udiff-line-removed">-             printClassStats(1, true);</span>
<span class="udiff-line-modified-added">+             // The ClassLoaderDataGraph has the failed instances recorded at least until the next GC.</span>
<span class="udiff-line-modified-added">+             checkClasses(1, false);</span>
<span class="udiff-line-modified-added">+             checkClassesAfterGC(1);</span>
          }
          else if (&quot;defineClassParallel&quot;.equals(args[0])) {
              MyParallelClassLoader pcl = new MyParallelClassLoader();
              CountDownLatch stop = new CountDownLatch(1);
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -313,15 +303,13 @@</span>
                  threads[i].join();
              }
              System.out.print(&quot;Counted &quot; + pcl.getLinkageErrors() + &quot; LinkageErrors &quot;);
              System.out.println(pcl.getLinkageErrors() == 0 ?
                      &quot;&quot; : &quot;(use -XX:+AllowParallelDefineClass to avoid this)&quot;);
<span class="udiff-line-removed">-             System.gc();</span>
<span class="udiff-line-removed">-             System.out.println(&quot;System.gc()&quot;);</span>
              // After System.gc() we expect to remain with two instances: one is the initial version which is
              // kept alive by this main method and another one in the parallel class loader.
<span class="udiff-line-modified-removed">-             printClassStats(2, true);</span>
<span class="udiff-line-modified-added">+             checkClassesAfterGC(2);</span>
          }
          else if (&quot;redefineClass&quot;.equals(args[0])) {
              loadInstrumentationAgent(myName, buf);
              int index = getStringIndex(&quot;AAAAAAAA&quot;, buf);
              CountDownLatch stop = new CountDownLatch(1);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -335,21 +323,19 @@</span>
                  (threads[i] = new MyThread(dc, start, stop)).start();
                  start.await(); // Wait until the new thread entered the getID() method
              }
              // We expect to have one instance for each redefinition because they are all kept alive by an activation
              // plus the initial version which is kept active by this main method.
<span class="udiff-line-modified-removed">-             printClassStats(iterations + 1, false);</span>
<span class="udiff-line-modified-added">+             checkClasses(iterations + 1, true);</span>
              stop.countDown(); // Let all threads leave the DefineClass.getID() activation..
              // ..and wait until really all of them returned from DefineClass.getID()
              for (int i = 0; i &lt; iterations; i++) {
                  threads[i].join();
              }
<span class="udiff-line-removed">-             System.gc();</span>
<span class="udiff-line-removed">-             System.out.println(&quot;System.gc()&quot;);</span>
              // After System.gc() we expect to remain with two instances: one is the initial version which is
              // kept alive by this main method and another one which is the latest redefined version.
<span class="udiff-line-modified-removed">-             printClassStats(2, true);</span>
<span class="udiff-line-modified-added">+             checkClassesAfterGC(2);</span>
          }
          else if (&quot;redefineClassWithError&quot;.equals(args[0])) {
              loadInstrumentationAgent(myName, buf);
              int index = getStringIndex(&quot;getID&quot;, buf);
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -363,13 +349,12 @@</span>
                      // Expected because redefinition can&#39;t change the name of methods
                  }
              }
              // We expect just a single DefineClass instance because failed redefinitions should
              // leave no garbage around.
<span class="udiff-line-modified-removed">-             printClassStats(1, false);</span>
<span class="udiff-line-modified-removed">-             System.gc();</span>
<span class="udiff-line-removed">-             System.out.println(&quot;System.gc()&quot;);</span>
<span class="udiff-line-modified-added">+             // The ClassLoaderDataGraph has the failed instances recorded at least until the next GC.</span>
<span class="udiff-line-modified-added">+             checkClasses(1, false);</span>
              // At least after a System.gc() we should definitely stay with a single instance!
<span class="udiff-line-modified-removed">-             printClassStats(1, true);</span>
<span class="udiff-line-modified-added">+             checkClassesAfterGC(1);</span>
          }
      }
  }
</pre>
<center><a href="../MemberName/MemberNameLeak.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="PrintMetaspaceDcmd.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>