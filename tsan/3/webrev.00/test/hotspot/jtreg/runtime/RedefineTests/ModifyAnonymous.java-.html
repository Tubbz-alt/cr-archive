<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old test/hotspot/jtreg/runtime/RedefineTests/ModifyAnonymous.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2016, 2018, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @library /test/lib
 27  * @summary Test that retransforming and redefining anonymous classes gets UnmodifiableClassException
 28  * @modules java.base/jdk.internal.misc
 29  * @modules java.instrument
 30  *          jdk.jartool/sun.tools.jar
 31  * @run main ModifyAnonymous buildagent
 32  * @run main/othervm -javaagent:redefineagent.jar ModifyAnonymous
 33  */
 34 
 35 import java.io.File;
 36 import java.io.FileNotFoundException;
 37 import java.io.FileOutputStream;
 38 import java.io.PrintWriter;
 39 import java.lang.RuntimeException;
 40 import java.lang.instrument.ClassDefinition;
 41 import java.lang.instrument.ClassFileTransformer;
 42 import java.lang.instrument.IllegalClassFormatException;
 43 import java.lang.instrument.Instrumentation;
 44 import java.security.ProtectionDomain;
 45 
 46 import jdk.test.lib.compiler.InMemoryJavaCompiler;
 47 
 48 public class ModifyAnonymous {
 49 
 50     public static class LambdaTransformer implements ClassFileTransformer {
 51         @Override
 52         public byte[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined,
 53                                 ProtectionDomain protectionDomain, byte[] classfileBuffer)
 54         throws IllegalClassFormatException {
 55             return null;
 56         }
 57     }
 58 
 59     static Instrumentation inst = null;
 60     static volatile boolean done = false;
 61 
 62     public static void premain(String args, Instrumentation instrumentation) {
 63 
 64         inst = instrumentation;
 65         System.out.println(&quot;javaagent in da house!&quot;);
 66         instrumentation.addTransformer(new LambdaTransformer());
 67     }
 68 
 69     private static void buildAgent() {
 70         try {
 71             ClassFileInstaller.main(&quot;ModifyAnonymous&quot;);
 72         } catch (Exception e) {
 73             throw new RuntimeException(&quot;Could not write agent classfile&quot;, e);
 74         }
 75 
 76         try {
 77             PrintWriter pw = new PrintWriter(&quot;MANIFEST.MF&quot;);
 78             pw.println(&quot;Premain-Class: ModifyAnonymous&quot;);
 79             pw.println(&quot;Agent-Class: ModifyAnonymous&quot;);
 80             pw.println(&quot;Can-Retransform-Classes: true&quot;);
 81             pw.println(&quot;Can-Redefine-Classes: true&quot;);
 82             pw.close();
 83         } catch (FileNotFoundException e) {
 84             throw new RuntimeException(&quot;Could not write manifest file for the agent&quot;, e);
 85         }
 86 
 87         sun.tools.jar.Main jarTool = new sun.tools.jar.Main(System.out, System.err, &quot;jar&quot;);
 88         if (!jarTool.run(new String[] { &quot;-cmf&quot;, &quot;MANIFEST.MF&quot;, &quot;redefineagent.jar&quot;, &quot;ModifyAnonymous.class&quot; })) {
 89             throw new RuntimeException(&quot;Could not write the agent jar file&quot;);
 90         }
 91     }
 92 
 93     public static class InstanceMethodCallSiteApp {
 94 
 95         public static void test() throws InterruptedException {
 96             for (int i = 0; i &lt; 2; i++) {
 97                 InstanceMethodCallSiteApp app = new InstanceMethodCallSiteApp();
 98                 Runnable r = app::doWork;   // this creates an anonymous class
 99                 while (!done) {
100                     r.run();
101                     Thread.sleep(10);
102                 }
103             }
104         }
105 
106         public void doWork() {
107             System.out.print(&quot;.&quot;);
108         }
109     }
110 
111     static void runTest() {
112         PrintWriter pw;
113         String logName = System.getProperty(&quot;test.classes&quot;) +
114             File.separator + &quot;loadedClasses.log&quot;;
115         // Create a log file to capture the names of the classes in the
116         // allLoadedClasses array. The log file is for assisting in debugging
117         // in case a null class is encountered in the allLoadedClasses array.
118         try {
119             pw = new PrintWriter(new FileOutputStream(
120                 new File(logName), true));
121         } catch (FileNotFoundException e) {
122             throw new RuntimeException(&quot;Could not write loaded classes to log&quot;, e);
123         }
124         while (!done) {
125             Class[] allLoadedClasses = inst.getAllLoadedClasses();
126             int len = allLoadedClasses.length;
127             pw.println(&quot;    allLoadedClasses length: &quot; + len);
128             for (int idx = 0; idx &lt; len; idx++) {
129                 Class cls = allLoadedClasses[idx];
130                 pw.println(&quot;    &quot; + idx + &quot; &quot; +
131                     ((cls != null) ? cls.getName() : &quot;null&quot;));
132             }
133             for (int idx = 0; idx &lt; len; idx++) {
134                 Class clazz = allLoadedClasses[idx];
135                 if (clazz == null) {
136                     pw.flush();
137                     pw.close();
138                     throw new RuntimeException(&quot;null class encountered&quot;);
139                 }
140                 final String name = clazz.getName();
141                 if (name.contains(&quot;$$Lambda$&quot;) &amp;&amp; name.contains(&quot;App&quot;)) {
142                     if (inst.isModifiableClass(clazz)) {
143                         pw.flush();
144                         pw.close();
145                         throw new RuntimeException (&quot;Class should not be modifiable&quot;);
146                     }
147                     // Try to modify them anyway.
148                     try {
149                         System.out.println(&quot;retransform called for &quot; + name);
150                         inst.retransformClasses(clazz);
151                     } catch(java.lang.instrument.UnmodifiableClassException t) {
152                         System.out.println(&quot;PASSED: expecting UnmodifiableClassException&quot;);
153                         t.printStackTrace();
154                     }
155                     try {
156                         System.out.println(&quot;redefine called for &quot; + name);
157                         String newclass = &quot;class Dummy {}&quot;;
158                         byte[] bytecode = InMemoryJavaCompiler.compile(&quot;Dummy&quot;, newclass);
159                         ClassDefinition cld = new ClassDefinition(clazz, bytecode);
160                         inst.redefineClasses(new ClassDefinition[] { cld });
161                     } catch(java.lang.instrument.UnmodifiableClassException t) {
162                         System.out.println(&quot;PASSED: expecting UnmodifiableClassException&quot;);
163                         t.printStackTrace();
164                     } catch(java.lang.ClassNotFoundException e) {
165                         pw.flush();
166                         pw.close();
167                         throw new RuntimeException (&quot;ClassNotFoundException thrown&quot;);
168                     }
169                     done = true;
170                 }
171             }
172         }
173         pw.flush();
174         pw.close();
175     }
176 
177     public static void main(String argv[]) throws InterruptedException, RuntimeException {
178         if (argv.length == 1 &amp;&amp; argv[0].equals(&quot;buildagent&quot;)) {
179             buildAgent();
180             return;
181         }
182 
183         if (inst == null) {
184             throw new RuntimeException(&quot;Instrumentation object was null&quot;);
185         }
186 
187         new Thread() {
188             public void run() {
189                 runTest();
190             }
191         }.start();
192 
193         // Test that NCDFE is not thrown for anonymous class:
194         // ModifyAnonymous$InstanceMethodCallSiteApp$$Lambda$18
195         try {
196             ModifyAnonymous test = new ModifyAnonymous();
197             InstanceMethodCallSiteApp.test();
198         } catch (NoClassDefFoundError e) {
199             throw new RuntimeException(&quot;FAILED: NoClassDefFoundError thrown for &quot; + e.getMessage());
200         }
201         System.out.println(&quot;PASSED: NoClassDefFound error not thrown&quot;);
202     }
203 }
    </pre>
  </body>
</html>