<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/hotspot/jtreg/runtime/MemberName/MemberNameLeak.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
    <script type="text/javascript" src="../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 2017, 2018, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @bug 8174749 8213307
 27  * @summary MemberNameTable should reuse entries
<a name="1" id="anc1"></a><span class="line-modified"> 28  * @library /test/lib /runtime/testlibrary</span>
<span class="line-modified"> 29  * @modules java.base/jdk.internal.misc</span>
<span class="line-added"> 30  * @modules java.compiler</span>
 31  * @build sun.hotspot.WhiteBox
 32  * @run driver ClassFileInstaller sun.hotspot.WhiteBox sun.hotspot.WhiteBox$WhiteBoxPermission
 33  * @run main/othervm -XX:+UnlockDiagnosticVMOptions -XX:+WhiteBoxAPI -Xbootclasspath/a:. MemberNameLeak
 34  */
 35 
<a name="2" id="anc2"></a><span class="line-added"> 36 import java.io.*;</span>
<span class="line-added"> 37 import java.nio.file.*;</span>
 38 import java.lang.invoke.*;
<a name="3" id="anc3"></a><span class="line-added"> 39 import java.lang.reflect.*;</span>
<span class="line-added"> 40 import java.text.*;</span>
<span class="line-added"> 41 import java.util.*;</span>
 42 import jdk.test.lib.process.OutputAnalyzer;
 43 import jdk.test.lib.process.ProcessTools;
<a name="4" id="anc4"></a><span class="line-added"> 44 import jdk.test.lib.Utils;</span>
 45 import sun.hotspot.WhiteBox;
 46 import sun.hotspot.code.Compiler;
 47 import sun.hotspot.gc.GC;
 48 
 49 public class MemberNameLeak {
<a name="5" id="anc5"></a><span class="line-added"> 50     private static String className  = &quot;MemberNameLeakTestClass&quot;;</span>
<span class="line-added"> 51     private static String methodPrefix = &quot;method&quot;;</span>
<span class="line-added"> 52     // The size of the ResolvedMethodTable is 1024. 2000 entries</span>
<span class="line-added"> 53     // is enough to trigger a grow/cleaning of the table after a GC.</span>
<span class="line-added"> 54     private static int methodCount = 2000;</span>
<span class="line-added"> 55     public static ArrayList&lt;MethodHandle&gt; keepAlive;</span>
<span class="line-added"> 56 </span>
 57     static class Leak {
 58       public void callMe() {
 59       }
 60 
 61       public static void main(String[] args) throws Throwable {
 62         Leak leak = new Leak();
 63         WhiteBox wb = WhiteBox.getWhiteBox();
<a name="6" id="anc6"></a>

 64 
<a name="7" id="anc7"></a><span class="line-modified"> 65         keepAlive = new ArrayList&lt;&gt;(methodCount);</span>
<span class="line-modified"> 66 </span>
<span class="line-modified"> 67         ClassWithManyMethodsClassLoader classLoader = new ClassWithManyMethodsClassLoader();</span>
<span class="line-added"> 68         Class&lt;?&gt; clazz = classLoader.create(className, methodPrefix, methodCount);</span>
<span class="line-added"> 69 </span>
<span class="line-added"> 70         long before = wb.resolvedMethodItemsCount();</span>
<span class="line-added"> 71 </span>
<span class="line-added"> 72         Object o = clazz.newInstance();</span>
<span class="line-added"> 73         MethodHandles.Lookup lookup = MethodHandles.privateLookupIn(clazz, MethodHandles.lookup());</span>
<span class="line-added"> 74 </span>
<span class="line-added"> 75         for (int i = 0; i &lt; methodCount; i++) {</span>
<span class="line-added"> 76           MethodType mt = MethodType.fromMethodDescriptorString(&quot;()V&quot;, classLoader);</span>
<span class="line-added"> 77           String methodName = methodPrefix + i;</span>
 78           // findSpecial leaks some native mem
<a name="8" id="anc8"></a><span class="line-modified"> 79           // Add entry to ResolvedMethodTable.</span>
<span class="line-modified"> 80           MethodHandle mh0 = lookup.findSpecial(clazz, methodName, mt, clazz);</span>
<span class="line-added"> 81           // Find entry in ResolvedMethodTable.</span>
<span class="line-added"> 82           MethodHandle mh1 = lookup.findSpecial(clazz, methodName, mt, clazz);</span>
<span class="line-added"> 83 </span>
<span class="line-added"> 84           mh1.invoke(o);</span>
<span class="line-added"> 85 </span>
<span class="line-added"> 86           keepAlive.add(mh1);</span>
 87         }
 88 
<a name="9" id="anc9"></a><span class="line-added"> 89         long after = wb.resolvedMethodItemsCount();</span>
<span class="line-added"> 90 </span>
<span class="line-added"> 91         System.out.println(&quot;wb.resolvedMethodItemsCount() after setup: &quot; + after);</span>
<span class="line-added"> 92 </span>
<span class="line-added"> 93         if (after == before) {</span>
<span class="line-added"> 94           throw new RuntimeException(&quot;Too few resolved methods&quot;);</span>
<span class="line-added"> 95         }</span>
<span class="line-added"> 96 </span>
<span class="line-added"> 97         keepAlive = null;</span>
<span class="line-added"> 98 </span>
 99         // Wait until ServiceThread cleans ResolvedMethod table
100         int cnt = 0;
101         while (true) {
102           if (cnt++ % 30 == 0) {
103             System.gc();  // make mh unused
104           }
<a name="10" id="anc10"></a><span class="line-modified">105 </span>
<span class="line-modified">106           if (after != wb.resolvedMethodItemsCount()) {</span>
<span class="line-added">107             // Entries have been removed.</span>
108             break;
109           }
<a name="11" id="anc11"></a><span class="line-added">110 </span>
111           Thread.sleep(100);
112         }
113       }
114     }
115 
<a name="12" id="anc12"></a><span class="line-modified">116     private static Path createGcLogPath(String prefix) throws IOException {</span>
<span class="line-added">117         Path gcLog = Utils.createTempFile(prefix, &quot;log&quot;);</span>
<span class="line-added">118         Files.delete(gcLog);</span>
<span class="line-added">119         return gcLog;</span>
<span class="line-added">120     }</span>
<span class="line-added">121 </span>
<span class="line-added">122     private static DateFormat dateFormat = new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;);</span>
<span class="line-added">123 </span>
<span class="line-added">124     public static void test(GC gc, boolean doConcurrent) throws Throwable {</span>
<span class="line-added">125         Path gcLogPath = createGcLogPath(&quot;gc.&quot; + gc + &quot;.&quot; + doConcurrent);</span>
<span class="line-added">126         System.err.println(&quot;test(&quot; + gc + &quot;, &quot; + doConcurrent + &quot;)&quot; + &quot; &quot; + dateFormat.format(new Date()));</span>
127         // Run this Leak class with logging
128         ProcessBuilder pb = ProcessTools.createJavaProcessBuilder(
<a name="13" id="anc13"></a><span class="line-modified">129                                       &quot;-Xlog:membername+table=trace,gc+verify=debug,gc:&quot; + gcLogPath + &quot;:time,utctime,uptime,pid,level,tags&quot;,</span>
130                                       &quot;-XX:+UnlockExperimentalVMOptions&quot;,
131                                       &quot;-XX:+UnlockDiagnosticVMOptions&quot;,
132                                       &quot;-XX:+WhiteBoxAPI&quot;,
133                                       &quot;-Xbootclasspath/a:.&quot;,
<a name="14" id="anc14"></a><span class="line-added">134                                       &quot;-XX:+VerifyBeforeGC&quot;,</span>
<span class="line-added">135                                       &quot;-XX:+VerifyAfterGC&quot;,</span>
136                                       doConcurrent ? &quot;-XX:+ExplicitGCInvokesConcurrent&quot; : &quot;-XX:-ExplicitGCInvokesConcurrent&quot;,
137                                       &quot;-XX:+ClassUnloading&quot;,
138                                       &quot;-XX:+ClassUnloadingWithConcurrentMark&quot;,
<a name="15" id="anc15"></a><span class="line-modified">139                                       &quot;-XX:+Use&quot; + gc + &quot;GC&quot;,</span>
<span class="line-added">140                                       Leak.class.getName());</span>
<span class="line-added">141 </span>
<span class="line-added">142         // Check process</span>
143         OutputAnalyzer output = new OutputAnalyzer(pb.start());
<a name="16" id="anc16"></a><span class="line-modified">144         output.outputTo(System.out);</span>
<span class="line-modified">145         output.errorTo(System.err);</span>

146         output.shouldHaveExitValue(0);
<a name="17" id="anc17"></a><span class="line-added">147 </span>
<span class="line-added">148         // Check gc log file</span>
<span class="line-added">149         OutputAnalyzer gcLogOutput = new OutputAnalyzer(gcLogPath);</span>
<span class="line-added">150 </span>
<span class="line-added">151         // Hardcoded names for classes generated by GeneratedClassLoader</span>
<span class="line-added">152         String descriptor = className + &quot;.&quot; + methodPrefix + &quot;0()V&quot;;</span>
<span class="line-added">153         gcLogOutput.shouldContain(&quot;ResolvedMethod entry added for &quot; + descriptor);</span>
<span class="line-added">154         gcLogOutput.shouldContain(&quot;ResolvedMethod entry found for &quot; + descriptor);</span>
<span class="line-added">155         gcLogOutput.shouldContain(&quot;ResolvedMethod entry removed&quot;);</span>
<span class="line-added">156 </span>
<span class="line-added">157         System.err.println(&quot;test(&quot; + gc + &quot;, &quot; + doConcurrent + &quot;)&quot; + &quot; done &quot; + dateFormat.format(new Date()));</span>
158     }
159 
<a name="18" id="anc18"></a><span class="line-modified">160     private static boolean supportsSTW(GC gc) {</span>
<span class="line-modified">161         return !(gc == GC.Epsilon);</span>
<span class="line-modified">162     }</span>
<span class="line-modified">163 </span>
<span class="line-modified">164     private static boolean supportsConcurrent(GC gc) {</span>
<span class="line-modified">165         return !(gc == GC.Epsilon || gc == GC.Serial || gc == GC.Parallel);</span>
<span class="line-modified">166     }</span>
<span class="line-modified">167 </span>
<span class="line-modified">168     private static void test(GC gc) throws Throwable {</span>
<span class="line-modified">169         if (supportsSTW(gc)) {</span>
<span class="line-modified">170             test(gc, false);</span>
<span class="line-modified">171         }</span>
<span class="line-modified">172         if (supportsConcurrent(gc)) {</span>
<span class="line-added">173             test(gc, true);</span>
174         }
175     }
<a name="19" id="anc19"></a><span class="line-added">176 </span>
<span class="line-added">177     public static void main(java.lang.String[] unused) throws Throwable {</span>
<span class="line-added">178       test(GC.selected());</span>
<span class="line-added">179     }</span>
180 }
<a name="20" id="anc20"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="20" type="hidden" />
</body>
</html>