<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/hotspot/jtreg/runtime/ErrorHandling/TimeoutInErrorHandlingTest.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="SafeFetchInErrorHandlingTest.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../LoadClass/LongBCP.java.udiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/jtreg/runtime/ErrorHandling/TimeoutInErrorHandlingTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2017, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2017, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -41,13 +41,22 @@</span>
   * @author Thomas Stuefe (SAP)
   */
  
  public class TimeoutInErrorHandlingTest {
  
<span class="udiff-line-added">+     public static final boolean verbose = System.getProperty(&quot;verbose&quot;) != null;</span>
<span class="udiff-line-added">+     // 16 seconds for hs_err generation timeout = 4 seconds per step timeout</span>
<span class="udiff-line-added">+     public static final int ERROR_LOG_TIMEOUT = 16;</span>
  
      public static void main(String[] args) throws Exception {
  
<span class="udiff-line-added">+         int error_log_timeout = ERROR_LOG_TIMEOUT;</span>
<span class="udiff-line-added">+         if (&quot;SunOS&quot;.equals(System.getProperty(&quot;os.name&quot;))) {</span>
<span class="udiff-line-added">+             // Give Solaris machines 3X as much time:</span>
<span class="udiff-line-added">+             error_log_timeout *= 3;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
          /* Start the VM and let it crash. Specify TestUnresponsiveErrorHandler which will
           * let five subsequent error reporting steps hang. The Timeout handling triggered
           * by the WatcherThread should kick in and interrupt those steps. In theory, the
           * text &quot;timeout occurred during error reporting in step ..&quot; (the little timeouts)
           * should occur in the error log up to four times, followed by the final big timeout
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -70,31 +79,47 @@</span>
          ProcessBuilder pb = ProcessTools.createJavaProcessBuilder(
              &quot;-XX:+UnlockDiagnosticVMOptions&quot;,
              &quot;-Xmx100M&quot;,
              &quot;-XX:ErrorHandlerTest=14&quot;,
              &quot;-XX:+TestUnresponsiveErrorHandler&quot;,
<span class="udiff-line-modified-removed">-             &quot;-XX:ErrorLogTimeout=16&quot;, // 16 seconds big timeout = 4 seconds per little timeout</span>
<span class="udiff-line-modified-added">+             &quot;-XX:ErrorLogTimeout=&quot; + error_log_timeout,</span>
              &quot;-XX:-CreateCoredumpOnCrash&quot;,
              &quot;-version&quot;);
  
          OutputAnalyzer output_detail = new OutputAnalyzer(pb.start());
  
<span class="udiff-line-added">+         if (verbose) {</span>
<span class="udiff-line-added">+             System.err.println(&quot;&lt;begin cmd output&gt;&quot;);</span>
<span class="udiff-line-added">+             System.err.println(output_detail.getOutput());</span>
<span class="udiff-line-added">+             System.err.println(&quot;&lt;end cmd output&gt;&quot;);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
          // we should have crashed with a SIGSEGV
          output_detail.shouldMatch(&quot;# A fatal error has been detected by the Java Runtime Environment:.*&quot;);
<span class="udiff-line-modified-removed">-         output_detail.shouldMatch(&quot;# +(?:SIGSEGV|EXCEPTION_ACCESS_VIOLATION).*&quot;);</span>
<span class="udiff-line-modified-added">+         output_detail.shouldMatch(&quot;# +(?:SIGSEGV|SIGBUS|EXCEPTION_ACCESS_VIOLATION).*&quot;);</span>
  
          // VM should have been aborted by WatcherThread
          output_detail.shouldMatch(&quot;.*timer expired, abort.*&quot;);
  
          // extract hs-err file
          String hs_err_file = output_detail.firstMatch(&quot;# *(\\S*hs_err_pid\\d+\\.log)&quot;, 1);
          if (hs_err_file == null) {
<span class="udiff-line-added">+             if (!verbose) {</span>
<span class="udiff-line-added">+                 System.err.println(&quot;&lt;begin cmd output&gt;&quot;);</span>
<span class="udiff-line-added">+                 System.err.println(output_detail.getOutput());</span>
<span class="udiff-line-added">+                 System.err.println(&quot;&lt;end cmd output&gt;&quot;);</span>
<span class="udiff-line-added">+             }</span>
              throw new RuntimeException(&quot;Did not find hs-err file in output.\n&quot;);
          }
  
          File f = new File(hs_err_file);
          if (!f.exists()) {
<span class="udiff-line-added">+             if (!verbose) {</span>
<span class="udiff-line-added">+                 System.err.println(&quot;&lt;begin cmd output&gt;&quot;);</span>
<span class="udiff-line-added">+                 System.err.println(output_detail.getOutput());</span>
<span class="udiff-line-added">+                 System.err.println(&quot;&lt;end cmd output&gt;&quot;);</span>
<span class="udiff-line-added">+             }</span>
              throw new RuntimeException(&quot;hs-err file missing at &quot;
                  + f.getAbsolutePath() + &quot;.\n&quot;);
          }
  
          System.out.println(&quot;Found hs_err file. Scanning...&quot;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -102,34 +127,45 @@</span>
          FileInputStream fis = new FileInputStream(f);
          BufferedReader br = new BufferedReader(new InputStreamReader(fis));
          String line = null;
  
  
<span class="udiff-line-removed">- </span>
          Pattern [] pattern = new Pattern[] {
              Pattern.compile(&quot;.*timeout occurred during error reporting in step.*&quot;),
              Pattern.compile(&quot;.*timeout occurred during error reporting in step.*&quot;)
          };
          int currentPattern = 0;
  
          String lastLine = null;
<span class="udiff-line-added">+         StringBuilder saved_hs_err = new StringBuilder();</span>
          while ((line = br.readLine()) != null) {
<span class="udiff-line-added">+             saved_hs_err.append(line + System.lineSeparator());</span>
              if (currentPattern &lt; pattern.length) {
<span class="udiff-line-modified-removed">-               if (pattern[currentPattern].matcher(line).matches()) {</span>
<span class="udiff-line-modified-removed">-                 System.out.println(&quot;Found: &quot; + line + &quot;.&quot;);</span>
<span class="udiff-line-modified-removed">-                 currentPattern ++;</span>
<span class="udiff-line-modified-removed">-               }</span>
<span class="udiff-line-modified-added">+                 if (pattern[currentPattern].matcher(line).matches()) {</span>
<span class="udiff-line-modified-added">+                     System.out.println(&quot;Found: &quot; + line + &quot;.&quot;);</span>
<span class="udiff-line-modified-added">+                     currentPattern ++;</span>
<span class="udiff-line-modified-added">+                 }</span>
              }
              lastLine = line;
          }
          br.close();
  
<span class="udiff-line-added">+         if (verbose) {</span>
<span class="udiff-line-added">+             System.err.println(&quot;&lt;begin hs_err contents&gt;&quot;);</span>
<span class="udiff-line-added">+             System.err.print(saved_hs_err);</span>
<span class="udiff-line-added">+             System.err.println(&quot;&lt;end hs_err contents&gt;&quot;);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
          if (currentPattern &lt; pattern.length) {
<span class="udiff-line-added">+             if (!verbose) {</span>
<span class="udiff-line-added">+                 System.err.println(&quot;&lt;begin hs_err contents&gt;&quot;);</span>
<span class="udiff-line-added">+                 System.err.print(saved_hs_err);</span>
<span class="udiff-line-added">+                 System.err.println(&quot;&lt;end hs_err contents&gt;&quot;);</span>
<span class="udiff-line-added">+             }</span>
              throw new RuntimeException(&quot;hs-err file incomplete (first missing pattern: &quot; +  currentPattern + &quot;)&quot;);
          }
  
          System.out.println(&quot;OK.&quot;);
  
      }
  
  }
<span class="udiff-line-removed">- </span>
</pre>
<center><a href="SafeFetchInErrorHandlingTest.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../LoadClass/LongBCP.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>