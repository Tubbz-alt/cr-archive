<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/hotspot/jtreg/runtime/CommandLine/OptionsValidation/common/optionsvalidation/JVMOption.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../TestOptionsWithRanges_generate.sh.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="JVMOptionsUtils.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/jtreg/runtime/CommandLine/OptionsValidation/common/optionsvalidation/JVMOption.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2015, 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
</pre>
<hr />
<pre>
 27 import java.util.ArrayList;
 28 import java.util.Arrays;
 29 import java.util.HashSet;
 30 import java.util.List;
 31 import java.util.Set;
 32 import jdk.test.lib.management.DynamicVMOption;
 33 import jdk.test.lib.process.OutputAnalyzer;
 34 import jdk.test.lib.process.ProcessTools;
 35 import jdk.test.lib.dcmd.CommandExecutor;
 36 import jdk.test.lib.dcmd.JMXExecutor;
 37 import jdk.test.lib.Platform;
 38 import sun.tools.attach.HotSpotVirtualMachine;
 39 
 40 import static optionsvalidation.JVMOptionsUtils.failedMessage;
 41 import static optionsvalidation.JVMOptionsUtils.GCType;
 42 import static optionsvalidation.JVMOptionsUtils.printOutputContent;
 43 import static optionsvalidation.JVMOptionsUtils.VMType;
 44 
 45 public abstract class JVMOption {
 46 



 47     /**
 48      * Executor for JCMD
 49      */
 50     private final static CommandExecutor executor = new JMXExecutor();
 51 
 52     /**
 53      * Name of the tested parameter
 54      */
 55     protected String name;
 56 
 57     /**
 58      * Range is defined for option inside VM
 59      */
 60     protected boolean withRange;
 61 
 62     /**
 63      * Test valid min range value and additional small values
 64      */
 65     protected boolean testMinRange;
 66 
</pre>
<hr />
<pre>
129         String toAdd;
130 
131         for (String option : options) {
132             if (option.startsWith(&quot;-&quot;)) {
133                 toAdd = option;
134             } else {
135                 /* Add &quot;-&quot; before parameter name */
136                 toAdd = &quot;-&quot; + option;
137 
138             }
139             prepend.add(toAdd);
140             prependString.append(toAdd).append(&quot; &quot;);
141         }
142     }
143 
144     /**
145      * Get name of the option
146      *
147      * @return name of the option
148      */
<span class="line-modified">149     final String getName() {</span>
150         return name;
151     }
152 
153     /**
154      * Mark this option as option which range is defined inside VM
155      */
156     final void optionWithRange() {
157         withRange = true;
158     }
159 
160     /**
161      * Exclude testing of min range value for this option
162      */
163     public final void excludeTestMinRange() {
164         testMinRange = false;
165     }
166 
167     /**
168      * Exclude testing of max range value for this option
169      */
</pre>
<hr />
<pre>
380         String explicitGC = null;
381         List&lt;String&gt; runJava = new ArrayList&lt;&gt;();
382         OutputAnalyzer out = null;
383 
384         if (VMType != null) {
385             runJava.add(VMType);
386         }
387 
388         // Run with a small heap to avoid excessive execution time
389         long max = Runtime.getRuntime().maxMemory() / 1024 / 1024;
390         if (max &gt; 1024) {
391             runJava.add(&quot;-Xmx1024m&quot;);
392         }
393 
394         if (Platform.isDebugBuild()) {
395             // Avoid excessive execution time.
396             runJava.add(&quot;-XX:-ZapUnusedHeapArea&quot;);
397         }
398 
399         if (GCType != null &amp;&amp;
<span class="line-modified">400             !(prepend.contains(&quot;-XX:+UseConcMarkSweepGC&quot;) ||</span>
<span class="line-removed">401               prepend.contains(&quot;-XX:+UseSerialGC&quot;) ||</span>
402               prepend.contains(&quot;-XX:+UseParallelGC&quot;) ||
403               prepend.contains(&quot;-XX:+UseG1GC&quot;))) {
404             explicitGC = GCType;
405         }
406 
407         if (explicitGC != null) {
408             runJava.add(explicitGC);
409         }
410 



411         runJava.addAll(prepend);
412         runJava.add(optionValue);
413         runJava.add(JVMStartup.class.getName());
414 
415         out = new OutputAnalyzer(ProcessTools.createJavaProcessBuilder(runJava.toArray(new String[0])).start());
416 
417         exitCode = out.getExitValue();
418         String exitCodeString = null;
419         if (exitCode != 0) {
420             exitCodeString = exitCode + &quot; [0x&quot; + Integer.toHexString(exitCode).toUpperCase() + &quot;]&quot;;
421         }
422 
423         if (out.getOutput().contains(&quot;A fatal error has been detected by the Java Runtime Environment&quot;)) {
424             /* Always consider &quot;fatal error&quot; in output as fail */
425             errorMessage = &quot;JVM output reports a fatal error. JVM exited with code &quot; + exitCodeString + &quot;!&quot;;
426         } else if (out.getStderr().contains(&quot;Ignoring option &quot; + name)) {
427             // Watch for newly obsoleted, but not yet removed, flags
428             System.out.println(&quot;SKIPPED: Ignoring test result for obsolete flag &quot; + name);
429         } else if (valid == true) {
430             if (!allowedExitCodes.contains(exitCode)) {
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2015, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
</pre>
<hr />
<pre>
 27 import java.util.ArrayList;
 28 import java.util.Arrays;
 29 import java.util.HashSet;
 30 import java.util.List;
 31 import java.util.Set;
 32 import jdk.test.lib.management.DynamicVMOption;
 33 import jdk.test.lib.process.OutputAnalyzer;
 34 import jdk.test.lib.process.ProcessTools;
 35 import jdk.test.lib.dcmd.CommandExecutor;
 36 import jdk.test.lib.dcmd.JMXExecutor;
 37 import jdk.test.lib.Platform;
 38 import sun.tools.attach.HotSpotVirtualMachine;
 39 
 40 import static optionsvalidation.JVMOptionsUtils.failedMessage;
 41 import static optionsvalidation.JVMOptionsUtils.GCType;
 42 import static optionsvalidation.JVMOptionsUtils.printOutputContent;
 43 import static optionsvalidation.JVMOptionsUtils.VMType;
 44 
 45 public abstract class JVMOption {
 46 
<span class="line-added"> 47     private static final String UNLOCK_FLAG1 = &quot;-XX:+UnlockDiagnosticVMOptions&quot;;</span>
<span class="line-added"> 48     private static final String UNLOCK_FLAG2 = &quot;-XX:+UnlockExperimentalVMOptions&quot;;</span>
<span class="line-added"> 49 </span>
 50     /**
 51      * Executor for JCMD
 52      */
 53     private final static CommandExecutor executor = new JMXExecutor();
 54 
 55     /**
 56      * Name of the tested parameter
 57      */
 58     protected String name;
 59 
 60     /**
 61      * Range is defined for option inside VM
 62      */
 63     protected boolean withRange;
 64 
 65     /**
 66      * Test valid min range value and additional small values
 67      */
 68     protected boolean testMinRange;
 69 
</pre>
<hr />
<pre>
132         String toAdd;
133 
134         for (String option : options) {
135             if (option.startsWith(&quot;-&quot;)) {
136                 toAdd = option;
137             } else {
138                 /* Add &quot;-&quot; before parameter name */
139                 toAdd = &quot;-&quot; + option;
140 
141             }
142             prepend.add(toAdd);
143             prependString.append(toAdd).append(&quot; &quot;);
144         }
145     }
146 
147     /**
148      * Get name of the option
149      *
150      * @return name of the option
151      */
<span class="line-modified">152     public final String getName() {</span>
153         return name;
154     }
155 
156     /**
157      * Mark this option as option which range is defined inside VM
158      */
159     final void optionWithRange() {
160         withRange = true;
161     }
162 
163     /**
164      * Exclude testing of min range value for this option
165      */
166     public final void excludeTestMinRange() {
167         testMinRange = false;
168     }
169 
170     /**
171      * Exclude testing of max range value for this option
172      */
</pre>
<hr />
<pre>
383         String explicitGC = null;
384         List&lt;String&gt; runJava = new ArrayList&lt;&gt;();
385         OutputAnalyzer out = null;
386 
387         if (VMType != null) {
388             runJava.add(VMType);
389         }
390 
391         // Run with a small heap to avoid excessive execution time
392         long max = Runtime.getRuntime().maxMemory() / 1024 / 1024;
393         if (max &gt; 1024) {
394             runJava.add(&quot;-Xmx1024m&quot;);
395         }
396 
397         if (Platform.isDebugBuild()) {
398             // Avoid excessive execution time.
399             runJava.add(&quot;-XX:-ZapUnusedHeapArea&quot;);
400         }
401 
402         if (GCType != null &amp;&amp;
<span class="line-modified">403             !(prepend.contains(&quot;-XX:+UseSerialGC&quot;) ||</span>

404               prepend.contains(&quot;-XX:+UseParallelGC&quot;) ||
405               prepend.contains(&quot;-XX:+UseG1GC&quot;))) {
406             explicitGC = GCType;
407         }
408 
409         if (explicitGC != null) {
410             runJava.add(explicitGC);
411         }
412 
<span class="line-added">413         runJava.add(UNLOCK_FLAG1);</span>
<span class="line-added">414         runJava.add(UNLOCK_FLAG2);</span>
<span class="line-added">415 </span>
416         runJava.addAll(prepend);
417         runJava.add(optionValue);
418         runJava.add(JVMStartup.class.getName());
419 
420         out = new OutputAnalyzer(ProcessTools.createJavaProcessBuilder(runJava.toArray(new String[0])).start());
421 
422         exitCode = out.getExitValue();
423         String exitCodeString = null;
424         if (exitCode != 0) {
425             exitCodeString = exitCode + &quot; [0x&quot; + Integer.toHexString(exitCode).toUpperCase() + &quot;]&quot;;
426         }
427 
428         if (out.getOutput().contains(&quot;A fatal error has been detected by the Java Runtime Environment&quot;)) {
429             /* Always consider &quot;fatal error&quot; in output as fail */
430             errorMessage = &quot;JVM output reports a fatal error. JVM exited with code &quot; + exitCodeString + &quot;!&quot;;
431         } else if (out.getStderr().contains(&quot;Ignoring option &quot; + name)) {
432             // Watch for newly obsoleted, but not yet removed, flags
433             System.out.println(&quot;SKIPPED: Ignoring test result for obsolete flag &quot; + name);
434         } else if (valid == true) {
435             if (!allowedExitCodes.contains(exitCode)) {
</pre>
</td>
</tr>
</table>
<center><a href="../../TestOptionsWithRanges_generate.sh.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="JVMOptionsUtils.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>