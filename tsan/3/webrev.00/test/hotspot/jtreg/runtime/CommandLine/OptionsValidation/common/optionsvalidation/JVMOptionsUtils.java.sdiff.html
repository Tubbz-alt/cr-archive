<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/hotspot/jtreg/runtime/CommandLine/OptionsValidation/common/optionsvalidation/JVMOptionsUtils.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="JVMOption.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../../../TestNullTerminatedFlags.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/jtreg/runtime/CommandLine/OptionsValidation/common/optionsvalidation/JVMOptionsUtils.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2015, 2017, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
</pre>
<hr />
<pre>
 29 import java.io.Reader;
 30 import java.lang.management.GarbageCollectorMXBean;
 31 import java.lang.management.ManagementFactory;
 32 import java.math.BigDecimal;
 33 import java.util.ArrayList;
 34 import java.util.Arrays;
 35 import java.util.List;
 36 import java.util.LinkedHashMap;
 37 import java.util.Map;
 38 import java.util.StringTokenizer;
 39 import java.util.function.Predicate;
 40 import jdk.test.lib.process.OutputAnalyzer;
 41 import jdk.test.lib.Platform;
 42 import jdk.test.lib.process.ProcessTools;
 43 
 44 public class JVMOptionsUtils {
 45 
 46     /* Java option which print options with ranges */
 47     private static final String PRINT_FLAGS_RANGES = &quot;-XX:+PrintFlagsRanges&quot;;
 48 



 49     /* StringBuilder to accumulate failed message */
 50     private static final StringBuilder finalFailedMessage = new StringBuilder();
 51 
 52     /* Used to start the JVM with the same type as current */
 53     static String VMType;
 54 
 55     /* Used to start the JVM with the same GC type as current */
 56     static String GCType;
 57 
 58     private static Map&lt;String, JVMOption&gt; optionsAsMap;
 59 
 60     static {
 61         if (Platform.isServer()) {
 62             VMType = &quot;-server&quot;;
 63         } else if (Platform.isClient()) {
 64             VMType = &quot;-client&quot;;
 65         } else if (Platform.isMinimal()) {
 66             VMType = &quot;-minimal&quot;;
<span class="line-removed"> 67         } else if (Platform.isGraal()) {</span>
<span class="line-removed"> 68             VMType = &quot;-graal&quot;;</span>
 69         } else {
 70             VMType = null;
 71         }
 72 
 73         List&lt;GarbageCollectorMXBean&gt; gcMxBeans = ManagementFactory.getGarbageCollectorMXBeans();
 74 
 75         GCType = null;
 76 
 77         for (GarbageCollectorMXBean gcMxBean : gcMxBeans) {
 78             switch (gcMxBean.getName()) {
<span class="line-removed"> 79                 case &quot;ConcurrentMarkSweep&quot;:</span>
<span class="line-removed"> 80                     GCType = &quot;-XX:+UseConcMarkSweepGC&quot;;</span>
<span class="line-removed"> 81                     break;</span>
 82                 case &quot;MarkSweepCompact&quot;:
 83                     GCType = &quot;-XX:+UseSerialGC&quot;;
 84                     break;
 85                 case &quot;PS Scavenge&quot;:
 86                     GCType = &quot;-XX:+UseParallelGC&quot;;
 87                     break;
 88                 case &quot;G1 Old Generation&quot;:
 89                     GCType = &quot;-XX:+UseG1GC&quot;;
 90                     break;
 91             }
 92         }
 93     }
 94 
 95     public static boolean fitsRange(String optionName, BigDecimal number) throws Exception {
 96         JVMOption option;
 97         String minRangeString = null;
 98         String maxRangeString = null;
 99         boolean fits = true;
100 
101         if (optionsAsMap == null) {
</pre>
<hr />
<pre>
166         if (option != null) {
167             maxRange = option.getMax();
168         }
169 
170         return maxRange;
171     }
172 
173     /**
174      * Add dependency for option depending on it&#39;s name. E.g. enable G1 GC for
175      * G1 options or add prepend options to not hit constraints.
176      *
177      * @param option option
178      */
179     private static void addNameDependency(JVMOption option) {
180         String name = option.getName();
181 
182         if (name.startsWith(&quot;G1&quot;)) {
183             option.addPrepend(&quot;-XX:+UseG1GC&quot;);
184         }
185 
<span class="line-removed">186         if (name.startsWith(&quot;CMS&quot;)) {</span>
<span class="line-removed">187             option.addPrepend(&quot;-XX:+UseConcMarkSweepGC&quot;);</span>
<span class="line-removed">188         }</span>
<span class="line-removed">189 </span>
190         if (name.startsWith(&quot;NUMA&quot;)) {
191             option.addPrepend(&quot;-XX:+UseNUMA&quot;);
192         }
193 
194         switch (name) {
195             case &quot;MinHeapFreeRatio&quot;:
196                 option.addPrepend(&quot;-XX:MaxHeapFreeRatio=100&quot;);
197                 break;
198             case &quot;MaxHeapFreeRatio&quot;:
199                 option.addPrepend(&quot;-XX:MinHeapFreeRatio=0&quot;);
200                 break;
201             case &quot;MinMetaspaceFreeRatio&quot;:
202                 option.addPrepend(&quot;-XX:MaxMetaspaceFreeRatio=100&quot;);
203                 break;
204             case &quot;MaxMetaspaceFreeRatio&quot;:
205                 option.addPrepend(&quot;-XX:MinMetaspaceFreeRatio=0&quot;);
206                 break;
<span class="line-removed">207             case &quot;CMSOldPLABMin&quot;:</span>
<span class="line-removed">208                 option.addPrepend(&quot;-XX:CMSOldPLABMax=&quot; + option.getMax());</span>
<span class="line-removed">209                 break;</span>
<span class="line-removed">210             case &quot;CMSOldPLABMax&quot;:</span>
<span class="line-removed">211                 option.addPrepend(&quot;-XX:CMSOldPLABMin=&quot; + option.getMin());</span>
<span class="line-removed">212                 break;</span>
<span class="line-removed">213             case &quot;CMSPrecleanNumerator&quot;:</span>
<span class="line-removed">214                 option.addPrepend(&quot;-XX:CMSPrecleanDenominator=&quot; + option.getMax());</span>
<span class="line-removed">215                 break;</span>
<span class="line-removed">216             case &quot;CMSPrecleanDenominator&quot;:</span>
<span class="line-removed">217                 option.addPrepend(&quot;-XX:CMSPrecleanNumerator=&quot; + ((new Integer(option.getMin())) - 1));</span>
<span class="line-removed">218                 break;</span>
219             case &quot;G1RefProcDrainInterval&quot;:
220                 option.addPrepend(&quot;-XX:+ExplicitGCInvokesConcurrent&quot;);
221                 break;
222             case &quot;InitialTenuringThreshold&quot;:
223                 option.addPrepend(&quot;-XX:MaxTenuringThreshold=&quot; + option.getMax());
224                 break;
225             case &quot;NUMAInterleaveGranularity&quot;:
226                 option.addPrepend(&quot;-XX:+UseNUMAInterleaving&quot;);
227                 break;
<span class="line-removed">228             case &quot;CPUForCMSThread&quot;:</span>
<span class="line-removed">229                 option.addPrepend(&quot;-XX:+BindCMSThreadToCPU&quot;);</span>
<span class="line-removed">230                 break;</span>
231             case &quot;VerifyGCStartAt&quot;:
232                 option.addPrepend(&quot;-XX:+VerifyBeforeGC&quot;);
233                 option.addPrepend(&quot;-XX:+VerifyAfterGC&quot;);
234                 break;
235             case &quot;NewSizeThreadIncrease&quot;:
236                 option.addPrepend(&quot;-XX:+UseSerialGC&quot;);
237                 break;
238             case &quot;SharedBaseAddress&quot;:
239             case &quot;SharedSymbolTableBucketSize&quot;:
240                 option.addPrepend(&quot;-XX:+UnlockDiagnosticVMOptions&quot;);
241                 option.addPrepend(&quot;-XX:SharedArchiveFile=TestOptionsWithRanges.jsa&quot;);
242                 option.addPrepend(&quot;-Xshare:dump&quot;);
243                 break;
244             case &quot;TLABWasteIncrement&quot;:
245                 option.addPrepend(&quot;-XX:+UseParallelGC&quot;);
246                 break;
247             default:
248                 /* Do nothing */
249                 break;
250         }
</pre>
<hr />
<pre>
441         }
442 
443         return failed;
444     }
445 
446     /**
447      * Get JVM options as map. Can return options with defined ranges or options
448      * without range depending on &quot;withRanges&quot; argument. &quot;acceptOrigin&quot;
449      * predicate can be used to filter option origin.
450      *
451      * @param withRanges true if needed options with defined ranges inside JVM
452      * @param acceptOrigin predicate for option origins. Origins can be
453      * &quot;product&quot;, &quot;diagnostic&quot; etc. Accept option only if acceptOrigin evaluates
454      * to true.
455      * @param additionalArgs additional arguments to the Java process which ran
456      * with &quot;-XX:+PrintFlagsRanges&quot;
457      * @return map from option name to the JVMOption object
458      * @throws Exception if a new process can not be created or an error
459      * occurred while reading the data
460      */
<span class="line-modified">461     public static Map&lt;String, JVMOption&gt; getOptionsAsMap(boolean withRanges, Predicate&lt;String&gt; acceptOrigin,</span>
462             String... additionalArgs) throws Exception {
463         Map&lt;String, JVMOption&gt; result;
464         Process p;
465         List&lt;String&gt; runJava = new ArrayList&lt;&gt;();
466 
467         if (additionalArgs.length &gt; 0) {
468             runJava.addAll(Arrays.asList(additionalArgs));
469         }
470 
471         if (VMType != null) {
472             runJava.add(VMType);
473         }
474 
475         if (GCType != null) {
476             runJava.add(GCType);
477         }


478         runJava.add(PRINT_FLAGS_RANGES);
479         runJava.add(&quot;-version&quot;);
480 
481         p = ProcessTools.createJavaProcessBuilder(runJava.toArray(new String[0])).start();
482 
483         result = getJVMOptions(new InputStreamReader(p.getInputStream()), withRanges, acceptOrigin);
484 
485         p.waitFor();
486 
487         return result;
488     }
489 
490     /**
491      * Get JVM options as list. Can return options with defined ranges or
492      * options without range depending on &quot;withRanges&quot; argument. &quot;acceptOrigin&quot;
493      * predicate can be used to filter option origin.
494      *
495      * @param withRanges true if needed options with defined ranges inside JVM
496      * @param acceptOrigin predicate for option origins. Origins can be
497      * &quot;product&quot;, &quot;diagnostic&quot; etc. Accept option only if acceptOrigin evaluates
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2015, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
</pre>
<hr />
<pre>
 29 import java.io.Reader;
 30 import java.lang.management.GarbageCollectorMXBean;
 31 import java.lang.management.ManagementFactory;
 32 import java.math.BigDecimal;
 33 import java.util.ArrayList;
 34 import java.util.Arrays;
 35 import java.util.List;
 36 import java.util.LinkedHashMap;
 37 import java.util.Map;
 38 import java.util.StringTokenizer;
 39 import java.util.function.Predicate;
 40 import jdk.test.lib.process.OutputAnalyzer;
 41 import jdk.test.lib.Platform;
 42 import jdk.test.lib.process.ProcessTools;
 43 
 44 public class JVMOptionsUtils {
 45 
 46     /* Java option which print options with ranges */
 47     private static final String PRINT_FLAGS_RANGES = &quot;-XX:+PrintFlagsRanges&quot;;
 48 
<span class="line-added"> 49     private static final String UNLOCK_FLAG1 = &quot;-XX:+UnlockDiagnosticVMOptions&quot;;</span>
<span class="line-added"> 50     private static final String UNLOCK_FLAG2 = &quot;-XX:+UnlockExperimentalVMOptions&quot;;</span>
<span class="line-added"> 51 </span>
 52     /* StringBuilder to accumulate failed message */
 53     private static final StringBuilder finalFailedMessage = new StringBuilder();
 54 
 55     /* Used to start the JVM with the same type as current */
 56     static String VMType;
 57 
 58     /* Used to start the JVM with the same GC type as current */
 59     static String GCType;
 60 
 61     private static Map&lt;String, JVMOption&gt; optionsAsMap;
 62 
 63     static {
 64         if (Platform.isServer()) {
 65             VMType = &quot;-server&quot;;
 66         } else if (Platform.isClient()) {
 67             VMType = &quot;-client&quot;;
 68         } else if (Platform.isMinimal()) {
 69             VMType = &quot;-minimal&quot;;


 70         } else {
 71             VMType = null;
 72         }
 73 
 74         List&lt;GarbageCollectorMXBean&gt; gcMxBeans = ManagementFactory.getGarbageCollectorMXBeans();
 75 
 76         GCType = null;
 77 
 78         for (GarbageCollectorMXBean gcMxBean : gcMxBeans) {
 79             switch (gcMxBean.getName()) {



 80                 case &quot;MarkSweepCompact&quot;:
 81                     GCType = &quot;-XX:+UseSerialGC&quot;;
 82                     break;
 83                 case &quot;PS Scavenge&quot;:
 84                     GCType = &quot;-XX:+UseParallelGC&quot;;
 85                     break;
 86                 case &quot;G1 Old Generation&quot;:
 87                     GCType = &quot;-XX:+UseG1GC&quot;;
 88                     break;
 89             }
 90         }
 91     }
 92 
 93     public static boolean fitsRange(String optionName, BigDecimal number) throws Exception {
 94         JVMOption option;
 95         String minRangeString = null;
 96         String maxRangeString = null;
 97         boolean fits = true;
 98 
 99         if (optionsAsMap == null) {
</pre>
<hr />
<pre>
164         if (option != null) {
165             maxRange = option.getMax();
166         }
167 
168         return maxRange;
169     }
170 
171     /**
172      * Add dependency for option depending on it&#39;s name. E.g. enable G1 GC for
173      * G1 options or add prepend options to not hit constraints.
174      *
175      * @param option option
176      */
177     private static void addNameDependency(JVMOption option) {
178         String name = option.getName();
179 
180         if (name.startsWith(&quot;G1&quot;)) {
181             option.addPrepend(&quot;-XX:+UseG1GC&quot;);
182         }
183 




184         if (name.startsWith(&quot;NUMA&quot;)) {
185             option.addPrepend(&quot;-XX:+UseNUMA&quot;);
186         }
187 
188         switch (name) {
189             case &quot;MinHeapFreeRatio&quot;:
190                 option.addPrepend(&quot;-XX:MaxHeapFreeRatio=100&quot;);
191                 break;
192             case &quot;MaxHeapFreeRatio&quot;:
193                 option.addPrepend(&quot;-XX:MinHeapFreeRatio=0&quot;);
194                 break;
195             case &quot;MinMetaspaceFreeRatio&quot;:
196                 option.addPrepend(&quot;-XX:MaxMetaspaceFreeRatio=100&quot;);
197                 break;
198             case &quot;MaxMetaspaceFreeRatio&quot;:
199                 option.addPrepend(&quot;-XX:MinMetaspaceFreeRatio=0&quot;);
200                 break;












201             case &quot;G1RefProcDrainInterval&quot;:
202                 option.addPrepend(&quot;-XX:+ExplicitGCInvokesConcurrent&quot;);
203                 break;
204             case &quot;InitialTenuringThreshold&quot;:
205                 option.addPrepend(&quot;-XX:MaxTenuringThreshold=&quot; + option.getMax());
206                 break;
207             case &quot;NUMAInterleaveGranularity&quot;:
208                 option.addPrepend(&quot;-XX:+UseNUMAInterleaving&quot;);
209                 break;



210             case &quot;VerifyGCStartAt&quot;:
211                 option.addPrepend(&quot;-XX:+VerifyBeforeGC&quot;);
212                 option.addPrepend(&quot;-XX:+VerifyAfterGC&quot;);
213                 break;
214             case &quot;NewSizeThreadIncrease&quot;:
215                 option.addPrepend(&quot;-XX:+UseSerialGC&quot;);
216                 break;
217             case &quot;SharedBaseAddress&quot;:
218             case &quot;SharedSymbolTableBucketSize&quot;:
219                 option.addPrepend(&quot;-XX:+UnlockDiagnosticVMOptions&quot;);
220                 option.addPrepend(&quot;-XX:SharedArchiveFile=TestOptionsWithRanges.jsa&quot;);
221                 option.addPrepend(&quot;-Xshare:dump&quot;);
222                 break;
223             case &quot;TLABWasteIncrement&quot;:
224                 option.addPrepend(&quot;-XX:+UseParallelGC&quot;);
225                 break;
226             default:
227                 /* Do nothing */
228                 break;
229         }
</pre>
<hr />
<pre>
420         }
421 
422         return failed;
423     }
424 
425     /**
426      * Get JVM options as map. Can return options with defined ranges or options
427      * without range depending on &quot;withRanges&quot; argument. &quot;acceptOrigin&quot;
428      * predicate can be used to filter option origin.
429      *
430      * @param withRanges true if needed options with defined ranges inside JVM
431      * @param acceptOrigin predicate for option origins. Origins can be
432      * &quot;product&quot;, &quot;diagnostic&quot; etc. Accept option only if acceptOrigin evaluates
433      * to true.
434      * @param additionalArgs additional arguments to the Java process which ran
435      * with &quot;-XX:+PrintFlagsRanges&quot;
436      * @return map from option name to the JVMOption object
437      * @throws Exception if a new process can not be created or an error
438      * occurred while reading the data
439      */
<span class="line-modified">440     private static Map&lt;String, JVMOption&gt; getOptionsAsMap(boolean withRanges, Predicate&lt;String&gt; acceptOrigin,</span>
441             String... additionalArgs) throws Exception {
442         Map&lt;String, JVMOption&gt; result;
443         Process p;
444         List&lt;String&gt; runJava = new ArrayList&lt;&gt;();
445 
446         if (additionalArgs.length &gt; 0) {
447             runJava.addAll(Arrays.asList(additionalArgs));
448         }
449 
450         if (VMType != null) {
451             runJava.add(VMType);
452         }
453 
454         if (GCType != null) {
455             runJava.add(GCType);
456         }
<span class="line-added">457         runJava.add(UNLOCK_FLAG1);</span>
<span class="line-added">458         runJava.add(UNLOCK_FLAG2);</span>
459         runJava.add(PRINT_FLAGS_RANGES);
460         runJava.add(&quot;-version&quot;);
461 
462         p = ProcessTools.createJavaProcessBuilder(runJava.toArray(new String[0])).start();
463 
464         result = getJVMOptions(new InputStreamReader(p.getInputStream()), withRanges, acceptOrigin);
465 
466         p.waitFor();
467 
468         return result;
469     }
470 
471     /**
472      * Get JVM options as list. Can return options with defined ranges or
473      * options without range depending on &quot;withRanges&quot; argument. &quot;acceptOrigin&quot;
474      * predicate can be used to filter option origin.
475      *
476      * @param withRanges true if needed options with defined ranges inside JVM
477      * @param acceptOrigin predicate for option origins. Origins can be
478      * &quot;product&quot;, &quot;diagnostic&quot; etc. Accept option only if acceptOrigin evaluates
</pre>
</td>
</tr>
</table>
<center><a href="JVMOption.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../../../TestNullTerminatedFlags.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>