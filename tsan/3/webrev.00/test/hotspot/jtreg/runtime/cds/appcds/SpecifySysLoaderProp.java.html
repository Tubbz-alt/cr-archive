<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New test/hotspot/jtreg/runtime/cds/appcds/SpecifySysLoaderProp.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
  <body>
    <pre>
 1 /*
 2  * Copyright (c) 2014, 2019, Oracle and/or its affiliates. All rights reserved.
 3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 4  *
 5  * This code is free software; you can redistribute it and/or modify it
 6  * under the terms of the GNU General Public License version 2 only, as
 7  * published by the Free Software Foundation.
 8  *
 9  * This code is distributed in the hope that it will be useful, but WITHOUT
10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
12  * version 2 for more details (a copy is included in the LICENSE file that
13  * accompanied this code).
14  *
15  * You should have received a copy of the GNU General Public License version
16  * 2 along with this work; if not, write to the Free Software Foundation,
17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
18  *
19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
20  * or visit www.oracle.com if you need additional information or have any
21  * questions.
22  *
23  */
24 
25 /*
26  * @test
27  * @summary If -Djava.system.class.loader=xxx is specified in command-line, disable archived non-system classes
28  * @requires vm.cds
29  * @library /test/lib
30  * @compile test-classes/TestClassLoader.java
31  * @compile test-classes/ReportMyLoader.java
32  * @compile test-classes/TrySwitchMyLoader.java
33  * @run driver SpecifySysLoaderProp
34  */
35 
36 import java.io.*;
37 import jdk.test.lib.process.OutputAnalyzer;
38 
39 public class SpecifySysLoaderProp {
40 
41   public static void main(String[] args) throws Exception {
42     JarBuilder.build(&quot;sysloader&quot;, &quot;TestClassLoader&quot;, &quot;ReportMyLoader&quot;, &quot;TrySwitchMyLoader&quot;);
43 
44     String jarFileName = &quot;sysloader.jar&quot;;
45     String appJar = TestCommon.getTestJar(jarFileName);
46     TestCommon.testDump(appJar, TestCommon.list(&quot;ReportMyLoader&quot;));
47     String warning = &quot;VM warning: Archived non-system classes are disabled because the java.system.class.loader property is specified&quot;;
48 
49 
50     // (0) Baseline. Do not specify -Djava.system.class.loader
51     //     The test class should be loaded from archive
52     TestCommon.run(
53         &quot;-verbose:class&quot;,
54         &quot;-cp&quot;, appJar,
55         &quot;ReportMyLoader&quot;)
56       .assertNormalExit(&quot;[class,load] ReportMyLoader source: shared objects file&quot;,
57                         &quot;ReportMyLoader&#39;s loader = jdk.internal.loader.ClassLoaders$AppClassLoader@&quot;);
58 
59     // (1) Try to execute the archive with -Djava.system.class.loader=no.such.Klass,
60     //     it should fail
61     TestCommon.run(
62         &quot;-cp&quot;, appJar,
63         &quot;-Djava.system.class.loader=no.such.Klass&quot;,
64         &quot;ReportMyLoader&quot;)
65       .assertAbnormalExit(output -&gt; {
66           output.shouldContain(warning);
67           output.shouldContain(&quot;ClassNotFoundException: no.such.Klass&quot;);
68         });
69 
70     // (2) Try to execute the archive with -Djava.system.class.loader=TestClassLoader,
71     //     it should run, but archived non-system classes should be disabled
72     TestCommon.run(
73         &quot;-verbose:class&quot;,
74         &quot;-cp&quot;, appJar,
75         &quot;-Djava.system.class.loader=TestClassLoader&quot;,
76         &quot;ReportMyLoader&quot;)
77       .assertNormalExit(&quot;ReportMyLoader&#39;s loader = jdk.internal.loader.ClassLoaders$AppClassLoader@&quot;, //&lt;-this is still printed because TestClassLoader simply delegates to Launcher$AppLoader, but ...
78              &quot;TestClassLoader.called = true&quot;, //&lt;-but this proves that TestClassLoader was indeed called.
79              &quot;TestClassLoader: loadClass(\&quot;ReportMyLoader\&quot;,&quot;) //&lt;- this also proves that TestClassLoader was indeed called.
80       .assertNormalExit(output -&gt; {
81         output.shouldMatch(&quot;.class,load. TestClassLoader source: file:&quot;);
82         output.shouldMatch(&quot;.class,load. ReportMyLoader source: file:.*&quot; + jarFileName);
83         });
84 
85     // (3) Try to change the java.system.class.loader programmatically after
86     //     the app&#39;s main method is executed. This should have no effect in terms of
87     //     changing or switching the actual system class loader that&#39;s already in use.
88     TestCommon.run(
89         &quot;-verbose:class&quot;,
90         &quot;-cp&quot;, appJar,
91         &quot;TrySwitchMyLoader&quot;)
92       .assertNormalExit(&quot;[class,load] ReportMyLoader source: shared objects file&quot;,
93              &quot;TrySwitchMyLoader&#39;s loader = jdk.internal.loader.ClassLoaders$AppClassLoader@&quot;,
94              &quot;ReportMyLoader&#39;s loader = jdk.internal.loader.ClassLoaders$AppClassLoader@&quot;,
95              &quot;TestClassLoader.called = false&quot;);
96   }
97 }
    </pre>
  </body>
</html>