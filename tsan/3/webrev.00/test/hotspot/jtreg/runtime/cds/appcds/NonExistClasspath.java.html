<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New test/hotspot/jtreg/runtime/cds/appcds/NonExistClasspath.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
 23  */
 24 
 25 /*
 26  * @test
 27  * @summary Handling of non-existent classpath elements during dump time and run time
 28  * @requires vm.cds
 29  * @library /test/lib
 30  * @compile test-classes/Hello.java
 31  * @compile test-classes/HelloMore.java
 32  * @run driver NonExistClasspath
 33  */
 34 
 35 import java.io.File;
 36 import java.nio.file.Files;
 37 import java.nio.file.Paths;
 38 import java.nio.file.StandardCopyOption;
 39 import jdk.test.lib.process.OutputAnalyzer;
 40 
 41 public class NonExistClasspath {
 42     public static void main(String[] args) throws Exception {
 43         String appJar = JarBuilder.getOrCreateHelloJar();
 44         doTest(appJar, false);
 45         doTest(appJar, true);
 46     }
 47 
 48     static void doTest(String appJar, boolean bootcp) throws Exception {
 49         String classDir = System.getProperty(&quot;test.classes&quot;);
 50         String newFile = &quot;non-exist.jar&quot;;
 51         String nonExistPath = classDir + File.separator + newFile;
 52         final String errorMessage1 = &quot;Unable to use shared archive&quot;;
 53         final String errorMessage2 = &quot;shared class paths mismatch&quot;;
 54         final String errorMessage3 = (bootcp ? &quot;BOOT&quot; : &quot;APP&quot;) + &quot; classpath mismatch&quot;;
 55 
 56         (new File(nonExistPath)).delete();
 57 
 58         String classPath = nonExistPath + File.pathSeparator + appJar;
 59         TestCommon.testDump(&quot;foobar&quot;, TestCommon.list(&quot;Hello&quot;), make_args(bootcp, classPath));
 60 
 61         // The nonExistPath doesn&#39;t exist yet, so we should be able to run without problem
 62         TestCommon.run(make_args(bootcp,
 63                                  classPath,
 64                                  &quot;-Xlog:class+path=trace&quot;,
 65                                  &quot;Hello&quot;))
 66             .assertNormalExit();
 67 
 68         // Replace nonExistPath with another non-existent file in the CP, it should still work
 69         TestCommon.run(make_args(bootcp,
 70                                  nonExistPath + &quot;.duh&quot;  + File.pathSeparator + appJar,
 71                                  &quot;-Xlog:class+path=trace&quot;,
 72                                  &quot;Hello&quot;))
 73             .assertNormalExit();
 74 
 75         // Add a few more non-existent files in the CP, it should still work
 76         TestCommon.run(make_args(bootcp,
 77                                  nonExistPath + &quot;.duh&quot;  + File.pathSeparator +
 78                                  nonExistPath + &quot;.daa&quot;  + File.pathSeparator +
 79                                  nonExistPath + &quot;.boo&quot;  + File.pathSeparator +
 80                                  appJar,
 81                                  &quot;-Xlog:class+path=trace&quot;,
 82                                  &quot;Hello&quot;))
 83             .assertNormalExit();
 84 
 85         // Or, remove all non-existent paths from the CP, it should still work
 86         TestCommon.run(make_args(bootcp,
 87                                  appJar,
 88                                  &quot;-Xlog:class+path=trace&quot;,
 89                                  &quot;Hello&quot;))
 90             .assertNormalExit();
 91 
 92         // Now make nonExistPath exist. CDS will fail to load.
 93         Files.copy(Paths.get(classDir, &quot;hello.jar&quot;),
 94                    Paths.get(classDir, newFile),
 95                    StandardCopyOption.REPLACE_EXISTING);
 96 
 97         TestCommon.run(make_args(bootcp,
 98                                  classPath,
 99                                  &quot;-Xlog:class+path=trace&quot;,
100                                  &quot;Hello&quot;))
101             .assertAbnormalExit(errorMessage1, errorMessage2, errorMessage3);
102     }
103 
104     static String[] make_args(boolean bootcp, String cp, String... suffix) {
105         String args[];
106         if (bootcp) {
107             args = TestCommon.concat(&quot;-Xbootclasspath/a:&quot; + cp);
108         } else {
109             args = TestCommon.concat(&quot;-cp&quot;, cp);
110         }
111 
112         return TestCommon.concat(args, suffix);
113     }
114 }
    </pre>
  </body>
</html>