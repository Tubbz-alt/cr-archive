<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New test/hotspot/jtreg/runtime/cds/TestInterpreterMethodEntries.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
  <body>
    <pre>
 1 /*
 2  * Copyright (c) 2016, 2019, Oracle and/or its affiliates. All rights reserved.
 3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 4  *
 5  * This code is free software; you can redistribute it and/or modify it
 6  * under the terms of the GNU General Public License version 2 only, as
 7  * published by the Free Software Foundation.
 8  *
 9  * This code is distributed in the hope that it will be useful, but WITHOUT
10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
12  * version 2 for more details (a copy is included in the LICENSE file that
13  * accompanied this code).
14  *
15  * You should have received a copy of the GNU General Public License version
16  * 2 along with this work; if not, write to the Free Software Foundation,
17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
18  *
19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
20  * or visit www.oracle.com if you need additional information or have any
21  * questions.
22  */
23 
24 /**
25  * @test InterpreterMethodEntries
26  * @bug 8169711
27  * @summary Test interpreter method entries for intrinsics with CDS (class data sharing)
28  *          and the intrinsic flag enabled during dump and disabled during use of the archive.
29  * @requires vm.cds
30  * @comment the test disables intrinsics, so it can&#39;t be run w/ AOT&#39;ed java module
31  * @requires !vm.aot.enabled
32  * @library /test/lib
33  * @run driver TestInterpreterMethodEntries true false
34  */
35 
36 /**
37  * @test InterpreterMethodEntries
38  * @bug 8169711
39  * @summary Test interpreter method entries for intrinsics with CDS (class data sharing)
40  *          and the intrinsic flag disabled during dump and enabled during use of the archive.
41  * @requires vm.cds
42  * @library /test/lib
43  * @run driver TestInterpreterMethodEntries false true
44  */
45 
46 import java.lang.Math;
47 import java.util.zip.CRC32;
48 import java.util.zip.CRC32C;
49 import jdk.test.lib.cds.CDSOptions;
50 import jdk.test.lib.cds.CDSTestUtils;
51 import jdk.test.lib.process.OutputAnalyzer;
52 
53 public class TestInterpreterMethodEntries {
54 
55     public static void main(String[] args) throws Exception {
56         if (args.length &gt; 1) {
57           boolean dump = Boolean.parseBoolean(args[0]);
58           boolean use  = Boolean.parseBoolean(args[1]);
59 
60           // Dump and use shared archive with different flag combinations
61           dumpAndUseSharedArchive(dump ? &quot;+&quot; : &quot;-&quot;, use ? &quot;+&quot; : &quot;-&quot;);
62         } else {
63           // Call intrinsified java.lang.Math::fma()
64           Math.fma(1.0, 2.0, 3.0);
65 
66           byte[] buffer = new byte[256];
67           // Call intrinsified java.util.zip.CRC32::update()
68           CRC32 crc32 = new CRC32();
69           crc32.update(buffer, 0, 256);
70 
71           // Call intrinsified java.util.zip.CRC32C::updateBytes(..)
72           CRC32C crc32c = new CRC32C();
73           crc32c.update(buffer, 0, 256);
74         }
75     }
76 
77     private static void dumpAndUseSharedArchive(String dump, String use) throws Exception {
78         String unlock     = &quot;-XX:+UnlockDiagnosticVMOptions&quot;;
79 
80         String dumpFMA    = &quot;-XX:&quot; + dump + &quot;UseFMA&quot;;
81         String dumpCRC32  = &quot;-XX:&quot; + dump + &quot;UseCRC32Intrinsics&quot;;
82         String dumpCRC32C = &quot;-XX:&quot; + dump + &quot;UseCRC32CIntrinsics&quot;;
83         String useFMA     = &quot;-XX:&quot; + use  + &quot;UseFMA&quot;;
84         String useCRC32   = &quot;-XX:&quot; + use  + &quot;UseCRC32Intrinsics&quot;;
85         String useCRC32C  = &quot;-XX:&quot; + use  + &quot;UseCRC32CIntrinsics&quot;;
86 
87         CDSTestUtils.createArchiveAndCheck(unlock, dumpFMA, dumpCRC32, dumpCRC32C);
88 
89         CDSOptions opts = (new CDSOptions())
90             .addPrefix(unlock, useFMA, useCRC32, useCRC32C, &quot;-showversion&quot;)
91             .addSuffix(&quot;TestInterpreterMethodEntries&quot;, &quot;run&quot;)
92             .setUseVersion(false);
93         CDSTestUtils.runWithArchiveAndCheck(opts);
94     }
95 }
96 
    </pre>
  </body>
</html>