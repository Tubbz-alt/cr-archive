<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New test/hotspot/jtreg/runtime/cds/appcds/MultiReleaseJars.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2016, 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
 23  */
 24 
 25 /*
 26  * @test MultiReleaseJars
 27  * @summary Test multi-release jar with AppCDS.
 28  * @requires vm.cds
 29  * @library /test/lib
 30  * @run main/othervm/timeout=2400 MultiReleaseJars
 31  */
 32 
 33 import java.io.File;
 34 import java.io.FileOutputStream;
 35 import java.io.PrintStream;
 36 import java.io.IOException;
 37 import jdk.test.lib.process.OutputAnalyzer;
 38 
 39 public class MultiReleaseJars {
 40 
 41     static final int MAJOR_VERSION = Runtime.version().major();
 42     static final String MAJOR_VERSION_STRING = String.valueOf(MAJOR_VERSION);
 43 
 44     static String[] getMain() {
 45         String[] sts = {
 46             &quot;package version;&quot;,
 47             &quot;public class Main {&quot;,
 48             &quot;    public static void main(String[] args) {&quot;,
 49             &quot;        Version version = new Version();&quot;,
 50             &quot;        System.out.println(\&quot;I am running on version \&quot; + version.getVersion());&quot;,
 51             &quot;    }&quot;,
 52             &quot;}&quot;
 53         };
 54         return sts;
 55     }
 56 
 57     static String[] getVersion(int version) {
 58         String[] sts = {
 59             &quot;package version;&quot;,
 60             &quot;public class Version {&quot;,
 61             &quot;    public int getVersion(){ return &quot; + version + &quot;; }&quot;,
 62             &quot;}&quot;
 63         };
 64         return sts;
 65     }
 66 
 67     static void writeFile(File file, String... contents) throws Exception {
 68         if (contents == null) {
 69             throw new java.lang.RuntimeException(&quot;No input for writing to file&quot; + file);
 70         }
 71         try (
 72              FileOutputStream fos = new FileOutputStream(file);
 73              PrintStream ps = new PrintStream(fos)
 74         ) {
 75             for (String str : contents) {
 76                 ps.println(str);
 77             }
 78         }
 79     }
 80 
 81     /* version.jar entries and files:
 82      * META-INF/
 83      * META-INF/MANIFEST.MF
 84      * version/
 85      * version/Main.class
 86      * version/Version.class
 87      * META-INF/versions/
 88      * META-INF/versions/&lt;major-version&gt;/
 89      * META-INF/versions/&lt;major-version&gt;/version/
 90      * META-INF/versions/&lt;major-version&gt;/version/Version.class
 91      */
 92     static void createClassFilesAndJar() throws Exception {
 93         String tempDir = System.getProperty(&quot;test.classes&quot;);
 94         File baseDir = new File(tempDir + File.separator + &quot;base&quot;);
 95         File vDir    = new File(tempDir + File.separator + MAJOR_VERSION_STRING);
 96 
 97         baseDir.mkdirs();
 98         vDir.mkdirs();
 99 
100         File fileMain = TestCommon.getOutputSourceFile(&quot;Main.java&quot;);
101         writeFile(fileMain, getMain());
102 
103         File fileVersion = TestCommon.getOutputSourceFile(&quot;Version.java&quot;);
104         writeFile(fileVersion, getVersion(7));
105         JarBuilder.compile(baseDir.getAbsolutePath(), fileVersion.getAbsolutePath(), &quot;--release&quot;, &quot;7&quot;);
106         JarBuilder.compile(baseDir.getAbsolutePath(), fileMain.getAbsolutePath(),
107             &quot;-cp&quot;, baseDir.getAbsolutePath(), &quot;--release&quot;, MAJOR_VERSION_STRING);
108 
109         String[] meta = {
110             &quot;Multi-Release: true&quot;,
111             &quot;Main-Class: version.Main&quot;
112         };
113         File metainf = new File(tempDir, &quot;mf.txt&quot;);
114         writeFile(metainf, meta);
115 
116         fileVersion = TestCommon.getOutputSourceFile(&quot;Version.java&quot;);
117         writeFile(fileVersion, getVersion(MAJOR_VERSION));
118         JarBuilder.compile(vDir.getAbsolutePath(), fileVersion.getAbsolutePath(), &quot;--release&quot;, MAJOR_VERSION_STRING);
119 
120         JarBuilder.build(&quot;version&quot;, baseDir, metainf.getAbsolutePath(),
121             &quot;--release&quot;, MAJOR_VERSION_STRING, &quot;-C&quot;, vDir.getAbsolutePath(), &quot;.&quot;);
122 
123         // the following jar file is for testing case-insensitive &quot;Multi-Release&quot;
124         // attibute name
125         String[] meta2 = {
126             &quot;multi-Release: true&quot;,
127             &quot;Main-Class: version.Main&quot;
128         };
129         metainf = new File(tempDir, &quot;mf2.txt&quot;);
130         writeFile(metainf, meta2);
131         JarBuilder.build(&quot;version2&quot;, baseDir, metainf.getAbsolutePath(),
132             &quot;--release&quot;, MAJOR_VERSION_STRING, &quot;-C&quot;, vDir.getAbsolutePath(), &quot;.&quot;);
133     }
134 
135     static void checkExecOutput(OutputAnalyzer output, String expectedOutput) throws Exception {
136         try {
137             TestCommon.checkExec(output, expectedOutput);
138         } catch (java.lang.RuntimeException re) {
139             String cause = re.getMessage();
140             if (!expectedOutput.equals(cause)) {
141                 throw re;
142             }
143         }
144     }
145 
146     public static void main(String... args) throws Exception {
147         // create version.jar which contains Main.class and Version.class.
148         // Version.class has two versions: 8 and the current version.
149         createClassFilesAndJar();
150 
151         String mainClass          = &quot;version.Main&quot;;
152         String loadInfo           = &quot;[class,load] version.Version source: shared objects file&quot;;
153         String appClasses[]       = {&quot;version/Main&quot;, &quot;version/Version&quot;};
154         String appJar             = TestCommon.getTestJar(&quot;version.jar&quot;);
155         String appJar2            = TestCommon.getTestJar(&quot;version2.jar&quot;);
156         String enableMultiRelease = &quot;-Djdk.util.jar.enableMultiRelease=true&quot;;
157         String jarVersion         = null;
158         String expectedOutput     = null;
159 
160         // 1. default to highest version
161         //    if META-INF/versions exists, no other commandline options like -Djdk.util.jar.version and
162         //    -Djdk.util.jar.enableMultiRelease passed to vm
163         OutputAnalyzer output = TestCommon.dump(appJar, appClasses);
164         output.shouldContain(&quot;Loading classes to share: done.&quot;);
165         output.shouldHaveExitValue(0);
166 
167         output = TestCommon.exec(appJar, mainClass);
168         checkExecOutput(output, &quot;I am running on version &quot; + MAJOR_VERSION_STRING);
169 
170         // 2. Test versions 7 and the current major version.
171         //    -Djdk.util.jar.enableMultiRelease=true (or force), default is true.
172         //    a) -Djdk.util.jar.version=7 does not exist in jar.
173         //        It will fallback to the root version which is also 7 in this test.
174         //    b) -Djdk.util.jar.version=MAJOR_VERSION exists in the jar.
175         for (int i : new int[] {7, MAJOR_VERSION}) {
176             jarVersion = &quot;-Djdk.util.jar.version=&quot; + i;
177             expectedOutput = &quot;I am running on version &quot; + i;
178             output = TestCommon.dump(appJar, appClasses, enableMultiRelease, jarVersion);
179             output.shouldContain(&quot;Loading classes to share: done.&quot;);
180             output.shouldHaveExitValue(0);
181 
182             output = TestCommon.exec(appJar, mainClass);
183             checkExecOutput(output, expectedOutput);
184         }
185 
186         // 3. For unsupported version, 5 and current major version + 1, the multiversion
187         // will be turned off, so it will use the default (root) version.
188         for (int i : new int[] {5, MAJOR_VERSION + 1}) {
189             jarVersion = &quot;-Djdk.util.jar.version=&quot; + i;
190             output = TestCommon.dump(appJar, appClasses, enableMultiRelease, jarVersion);
191             output.shouldHaveExitValue(0);
192             // With the fix for 8172218, multi-release jar is being handled in
193             // jdk corelib which doesn&#39;t emit the following warning message.
194             //output.shouldContain(&quot;JDK&quot; + i + &quot; is not supported in multiple version jars&quot;);
195 
196             output = TestCommon.exec(appJar, mainClass);
197             if (i == 5)
198                 checkExecOutput(output, &quot;I am running on version 7&quot;);
199             else
200                 checkExecOutput(output, &quot;I am running on version &quot; + MAJOR_VERSION_STRING);
201         }
202 
203         // 4. If explicitly disabled from command line for multiversion jar, it will use default
204         //    version at root regardless multiversion versions exists.
205         //    -Djdk.util.jar.enableMultiRelease=false (not &#39;true&#39; or &#39;force&#39;)
206         for (int i = 6; i &lt; MAJOR_VERSION + 1; i++) {
207             jarVersion = &quot;-Djdk.util.jar.version=&quot; + i;
208             output = TestCommon.dump(appJar, appClasses, &quot;-Djdk.util.jar.enableMultiRelease=false&quot;, jarVersion);
209             output.shouldHaveExitValue(0);
210 
211             output = TestCommon.exec(appJar, mainClass);
212             expectedOutput = &quot;I am running on version 7&quot;;
213             checkExecOutput(output, expectedOutput);
214         }
215 
216         // 5. Sanity test with -Xbootclasspath/a
217         //    AppCDS behaves the same as the non-AppCDS case. A multi-release
218         //    jar file in the -Xbootclasspath/a will be ignored.
219         output = TestCommon.dump(appJar, appClasses, &quot;-Xbootclasspath/a:&quot; + appJar, enableMultiRelease, jarVersion);
220         output.shouldContain(&quot;Loading classes to share: done.&quot;);
221         output.shouldHaveExitValue(0);
222 
223         output = TestCommon.exec(appJar, &quot;-Xbootclasspath/a:&quot; + appJar, mainClass);
224         checkExecOutput(output, &quot;I am running on version 7&quot;);
225 
226         // 6. Sanity test case-insensitive &quot;Multi-Release&quot; attribute name
227         output = TestCommon.dump(appJar2, appClasses);
228         output.shouldContain(&quot;Loading classes to share: done.&quot;);
229         output.shouldHaveExitValue(0);
230 
231         output = TestCommon.exec(appJar2, mainClass);
232         checkExecOutput(output, &quot;I am running on version &quot; + MAJOR_VERSION_STRING);
233     }
234 }
    </pre>
  </body>
</html>