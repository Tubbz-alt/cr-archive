<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New test/hotspot/jtreg/runtime/cds/appcds/jigsaw/classpathtests/EmptyClassInBootClassPath.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2015, 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
 23  */
 24 
 25 /*
 26  * @test
 27  * @summary Test a few scenarios if an empty class, which has the same name as the one in the jimage, is specified in the -Xbootclasspath/a
 28  *     1) boot loader will always load the class from the bootclasspath
 29  *     2) app loader will load the class from the jimage by default;
 30  *        app loader will load the class from the bootclasspath if the
 31  *        &quot;--limit-modules java.base&quot; option is specified
 32  * @requires vm.cds &amp; !vm.graal.enabled
 33  * @library /test/lib /test/hotspot/jtreg/runtime/cds/appcds
 34  * @modules java.base/jdk.internal.access
 35  * @compile ../../test-classes/EmptyClassHelper.java
 36  * @compile ../../test-classes/com/sun/tools/javac/Main.jasm
 37  * @run driver EmptyClassInBootClassPath
 38  */
 39 
 40 import java.io.File;
 41 import java.lang.*;
 42 import java.lang.reflect.*;
 43 import java.util.List;
 44 import java.util.ArrayList;
 45 import jdk.test.lib.process.OutputAnalyzer;
 46 
 47 public class EmptyClassInBootClassPath {
 48     static final String EXPECTED_EXCEPTION =
 49         &quot;java.lang.NoSuchMethodException: com.sun.tools.javac.Main.main([Ljava.lang.String;)&quot;;
 50     public static void main(String[] args) throws Exception {
 51         String[] className = {&quot;com/sun/tools/javac/Main&quot;};
 52         JarBuilder.build(&quot;emptyClass&quot;, className);
 53         String appJar = TestCommon.getTestJar(&quot;emptyClass.jar&quot;);
 54         JarBuilder.build(&quot;EmptyClassHelper&quot;, &quot;EmptyClassHelper&quot;);
 55         String helperJar = TestCommon.getTestJar(&quot;EmptyClassHelper.jar&quot;);
 56         OutputAnalyzer dumpOutput = TestCommon.dump(
 57             appJar, className, &quot;-Xbootclasspath/a:&quot; + appJar);
 58         TestCommon.checkDump(dumpOutput);
 59         dumpOutput.shouldNotContain(&quot;Preload Warning: skipping class from -Xbootclasspath/a &quot; + className[0]);
 60 
 61         String bootclasspath = &quot;-Xbootclasspath/a:&quot; + appJar;
 62         String classPath = &quot;-Djava.class.path=&quot; + appJar + File.pathSeparator + helperJar;
 63         List&lt;String&gt; argsList = new ArrayList&lt;String&gt;();
 64         argsList.add(classPath);
 65         argsList.add(bootclasspath);
 66         argsList.add(&quot;--add-exports=java.base/jdk.internal.access=ALL-UNNAMED&quot;);
 67         argsList.add(&quot;EmptyClassHelper&quot;);
 68 
 69         // case 1: load class in bootclasspath using app loader
 70         argsList.add(&quot;useAppLoader&quot;);
 71         String[] opts = new String[argsList.size()];
 72         opts = argsList.toArray(opts);
 73         TestCommon.run(opts).assertNormalExit(&quot;appLoader found method main&quot;);
 74 
 75         // case 2: load class in bootclasspath using boot loader
 76         argsList.remove(argsList.size() - 1);
 77         argsList.add(&quot;useBootLoader&quot;);
 78         opts = new String[argsList.size()];
 79         opts = argsList.toArray(opts);
 80         TestCommon.run(opts).assertNormalExit(EXPECTED_EXCEPTION);
 81 
 82         // case 3: load class in bootclasspath using app loader with &#39;--limit-modules java.base&#39;
 83         argsList.add(0, &quot;--limit-modules&quot;);
 84         argsList.add(1, &quot;java.base&quot;);
 85         argsList.remove(argsList.size() - 1);
 86         argsList.add(&quot;useAppLoader&quot;);
 87         opts = new String[argsList.size()];
 88         opts = argsList.toArray(opts);
 89         TestCommon.run(opts)
 90             .assertSilentlyDisabledCDS(0, EXPECTED_EXCEPTION);
 91 
 92         // case 4: load class in bootclasspath using boot loader with &#39;--limit-modules java.base&#39;
 93         argsList.remove(argsList.size() - 1);
 94         argsList.add(&quot;useBootLoader&quot;);
 95         opts = new String[argsList.size()];
 96         opts = argsList.toArray(opts);
 97         TestCommon.run(opts)
 98             .assertSilentlyDisabledCDS(0, EXPECTED_EXCEPTION);
 99     }
100 }
    </pre>
  </body>
</html>