<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New test/hotspot/jtreg/runtime/cds/appcds/ClassPathAttr.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2014, 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
 23  */
 24 
 25 /*
 26  * @test
 27  * @summary Class-Path: attribute in MANIFEST file
 28  * @requires vm.cds
 29  * @library /test/lib
 30  * @run driver/timeout=240 ClassPathAttr
 31  */
 32 
 33 import jdk.test.lib.process.OutputAnalyzer;
 34 import java.io.File;
 35 import java.nio.file.Files;
 36 import java.nio.file.FileAlreadyExistsException;
 37 import java.nio.file.StandardCopyOption;
 38 import java.nio.file.Paths;
 39 
 40 
 41 public class ClassPathAttr {
 42 
 43   public static void main(String[] args) throws Exception {
 44     testNormalOps();
 45     testNonExistentJars();
 46   }
 47 
 48   static void testNormalOps() throws Exception {
 49     buildCpAttr(&quot;cpattr1&quot;, &quot;cpattr1.mf&quot;, &quot;CpAttr1&quot;, &quot;CpAttr1&quot;);
 50     buildCpAttr(&quot;cpattr1_long&quot;, &quot;cpattr1_long.mf&quot;, &quot;CpAttr1&quot;, &quot;CpAttr1&quot;);
 51     buildCpAttr(&quot;cpattr2&quot;, &quot;cpattr2.mf&quot;, &quot;CpAttr2&quot;, &quot;CpAttr2&quot;);
 52     buildCpAttr(&quot;cpattr3&quot;, &quot;cpattr3.mf&quot;, &quot;CpAttr3&quot;, &quot;CpAttr2&quot;, &quot;CpAttr3&quot;);
 53     buildCpAttr(&quot;cpattr4&quot;, &quot;cpattr4.mf&quot;, &quot;CpAttr4&quot;,
 54         &quot;CpAttr2&quot;, &quot;CpAttr3&quot;, &quot;CpAttr4&quot;, &quot;CpAttr5&quot;);
 55     buildCpAttr(&quot;cpattr5_123456789_223456789_323456789_423456789_523456789_623456789&quot;, &quot;cpattr5_extra_long.mf&quot;, &quot;CpAttr5&quot;, &quot;CpAttr5&quot;);
 56 
 57     for (int i=1; i&lt;=2; i++) {
 58       String jar1 = TestCommon.getTestJar(&quot;cpattr1.jar&quot;);
 59       String jar4 = TestCommon.getTestJar(&quot;cpattr4.jar&quot;);
 60       if (i == 2) {
 61         // Test case #2 -- same as #1, except we use cpattr1_long.jar, which has a super-long
 62         // Class-Path: attribute.
 63         jar1 = TestCommon.getTestJar(&quot;cpattr1_long.jar&quot;);
 64       }
 65       String cp = jar1 + File.pathSeparator + jar4;
 66 
 67       TestCommon.testDump(cp, TestCommon.list(&quot;CpAttr1&quot;,
 68                                                           &quot;CpAttr2&quot;,
 69                                                           &quot;CpAttr3&quot;,
 70                                                           &quot;CpAttr4&quot;,
 71                                                           &quot;CpAttr5&quot;));
 72 
 73       TestCommon.run(
 74           &quot;-cp&quot;, cp,
 75           &quot;CpAttr1&quot;)
 76         .assertNormalExit();
 77 
 78       // Logging test for class+path.
 79       TestCommon.run(
 80           &quot;-Xlog:class+path&quot;,
 81           &quot;-cp&quot;, cp,
 82           &quot;CpAttr1&quot;)
 83         .assertNormalExit(output -&gt; {
 84             output.shouldMatch(&quot;checking shared classpath entry: .*cpattr2.jar&quot;);
 85             output.shouldMatch(&quot;checking shared classpath entry: .*cpattr3.jar&quot;);
 86           });
 87 
 88       //  Make sure aliased TraceClassPaths still works
 89       TestCommon.run(
 90           &quot;-XX:+TraceClassPaths&quot;,
 91           &quot;-cp&quot;, cp,
 92           &quot;CpAttr1&quot;)
 93         .assertNormalExit(output -&gt; {
 94             output.shouldMatch(&quot;checking shared classpath entry: .*cpattr2.jar&quot;);
 95             output.shouldMatch(&quot;checking shared classpath entry: .*cpattr3.jar&quot;);
 96           });
 97     }
 98   }
 99 
100   static void testNonExistentJars() throws Exception {
101     buildCpAttr(&quot;cpattr6&quot;, &quot;cpattr6.mf&quot;, &quot;CpAttr6&quot;, &quot;CpAttr6&quot;);
102 
103     String cp = TestCommon.getTestJar(&quot;cpattr6.jar&quot;);
104     String nonExistPath = System.getProperty(&quot;test.classes&quot;) + File.separator + &quot;cpattrX.jar&quot;;
105     (new File(nonExistPath)).delete();
106 
107     TestCommon.testDump(cp, TestCommon.list(&quot;CpAttr6&quot;),
108         &quot;-Xlog:class+path&quot;);
109 
110     TestCommon.run(
111         &quot;-Xlog:class+path&quot;,
112         &quot;-cp&quot;, cp,
113         &quot;CpAttr6&quot;)
114       .assertNormalExit(output -&gt; {
115           output.shouldMatch(&quot;should be non-existent: .*cpattrX.jar&quot;);
116         });
117 
118     // Now make nonExistPath exist. CDS still loads, but archived non-system classes will not be used.
119     Files.copy(Paths.get(cp), Paths.get(nonExistPath),
120                StandardCopyOption.REPLACE_EXISTING);
121 
122     TestCommon.run(
123         &quot;-Xlog:class+path&quot;,
124         &quot;-cp&quot;, cp,
125         &quot;CpAttr6&quot;)
126       .assertNormalExit(output -&gt; {
127           output.shouldMatch(&quot;Archived non-system classes are disabled because the file .*cpattrX.jar exists&quot;);
128         });
129   }
130 
131   private static void buildCpAttr(String jarName, String manifest, String enclosingClassName, String ...testClassNames) throws Exception {
132     String jarClassesDir = System.getProperty(&quot;test.classes&quot;) + File.separator + jarName + &quot;_classes&quot;;
133     try { Files.createDirectory(Paths.get(jarClassesDir)); } catch (FileAlreadyExistsException e) { }
134 
135     JarBuilder.compile(jarClassesDir, System.getProperty(&quot;test.src&quot;) + File.separator +
136         &quot;test-classes&quot; + File.separator + enclosingClassName + &quot;.java&quot;);
137     JarBuilder.buildWithManifest(jarName, manifest, jarClassesDir, testClassNames);
138   }
139 }
    </pre>
  </body>
</html>