<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New test/hotspot/jtreg/runtime/cds/appcds/jigsaw/modulepath/ExportModule.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2018, 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
 23  */
 24 
 25 /**
 26  * @test
 27  * @requires vm.cds
 28  * @library /test/lib /test/hotspot/jtreg/runtime/cds/appcds
 29  * @run driver ExportModule
 30  * @summary Tests involve exporting a module from the module path to a jar in the -cp.
 31  */
 32 
 33 import java.io.File;
 34 import java.nio.file.Files;
 35 import java.nio.file.Path;
 36 import java.nio.file.Paths;
 37 
 38 import jdk.test.lib.compiler.CompilerUtils;
 39 import jdk.test.lib.process.OutputAnalyzer;
 40 import jdk.test.lib.Asserts;
 41 
 42 public class ExportModule {
 43 
 44     private static final Path USER_DIR = Paths.get(System.getProperty(&quot;user.dir&quot;));
 45 
 46     private static final String TEST_SRC = System.getProperty(&quot;test.src&quot;);
 47 
 48     private static final Path SRC_DIR = Paths.get(TEST_SRC, &quot;src&quot;);
 49     private static final Path MODS_DIR = Paths.get(&quot;mods&quot;);
 50 
 51     // the module name of the test module
 52     private static final String TEST_MODULE1 = &quot;com.greetings&quot;;
 53     private static final String TEST_MODULE2 = &quot;org.astro&quot;;
 54 
 55     // unnamed module package name
 56     private static final String PKG_NAME = &quot;com.nomodule&quot;;
 57 
 58     // the module main class
 59     private static final String MAIN_CLASS = &quot;com.greetings.Main&quot;;
 60     private static final String APP_CLASS = &quot;org.astro.World&quot;;
 61 
 62     // unnamed module main class
 63     private static final String UNNAMED_MAIN = &quot;com.nomodule.Main&quot;;
 64 
 65     private static Path moduleDir = null;
 66     private static Path moduleDir2 = null;
 67     private static Path appJar = null;
 68     private static Path appJar2 = null;
 69 
 70     public static void buildTestModule() throws Exception {
 71 
 72         // javac -d mods/$TESTMODULE src/$TESTMODULE/**
 73         JarBuilder.compileModule(SRC_DIR.resolve(TEST_MODULE2),
 74                                  MODS_DIR.resolve(TEST_MODULE2),
 75                                  null);
 76 
 77         // javac -d mods/$TESTMODULE --module-path MOD_DIR src/$TESTMODULE/**
 78         JarBuilder.compileModule(SRC_DIR.resolve(TEST_MODULE1),
 79                                  MODS_DIR.resolve(TEST_MODULE1),
 80                                  MODS_DIR.toString());
 81 
 82         moduleDir = Files.createTempDirectory(USER_DIR, &quot;mlib&quot;);
 83         Path jar = moduleDir.resolve(TEST_MODULE2 + &quot;.jar&quot;);
 84         String classes = MODS_DIR.resolve(TEST_MODULE2).toString();
 85         JarBuilder.createModularJar(jar.toString(), classes, null);
 86 
 87         moduleDir2 = Files.createTempDirectory(USER_DIR, &quot;mlib2&quot;);
 88         appJar = moduleDir2.resolve(TEST_MODULE1 + &quot;.jar&quot;);
 89         classes = MODS_DIR.resolve(TEST_MODULE1).toString();
 90         JarBuilder.createModularJar(appJar.toString(), classes, MAIN_CLASS);
 91 
 92         // build a non-modular jar containing the main class which
 93         // requires the org.astro package
 94         boolean compiled
 95             = CompilerUtils.compile(SRC_DIR.resolve(PKG_NAME),
 96                                     MODS_DIR.resolve(PKG_NAME),
 97                                     &quot;--module-path&quot;, MODS_DIR.toString(),
 98                                     &quot;--add-modules&quot;, TEST_MODULE2,
 99                                     &quot;--add-exports&quot;, &quot;org.astro/org.astro=ALL-UNNAMED&quot;);
100         Asserts.assertTrue(compiled, &quot;test package did not compile&quot;);
101 
102         appJar2 = moduleDir2.resolve(PKG_NAME + &quot;.jar&quot;);
103         classes = MODS_DIR.resolve(PKG_NAME).toString();
104         JarBuilder.createModularJar(appJar2.toString(), classes, null);
105     }
106 
107     public static void main(String... args) throws Exception {
108         // compile the modules and create the modular jar files
109         buildTestModule();
110         String appClasses[] = {MAIN_CLASS, APP_CLASS};
111         // create an archive with the class in the org.astro module built in the
112         // previous step and the main class from the modular jar in the -cp
113         // note: the main class is in the modular jar in the -cp which requires
114         // the module in the --module-path
115         OutputAnalyzer output = TestCommon.createArchive(
116                                         appJar.toString(), appClasses,
117                                         &quot;--module-path&quot;, moduleDir.toString(),
118                                         &quot;--add-modules&quot;, TEST_MODULE2, MAIN_CLASS);
119         TestCommon.checkDump(output);
120 
121         // run it using the archive
122         // both the main class and the class from the org.astro module should
123         // be loaded from the archive
124         TestCommon.run(&quot;-Xlog:class+load=trace&quot;,
125                               &quot;-cp&quot;, appJar.toString(),
126                               &quot;--module-path&quot;, moduleDir.toString(),
127                               &quot;--add-modules&quot;, TEST_MODULE2, MAIN_CLASS)
128             .assertNormalExit(
129                 &quot;[class,load] org.astro.World source: shared objects file&quot;,
130                 &quot;[class,load] com.greetings.Main source: shared objects file&quot;);
131 
132         String appClasses2[] = {UNNAMED_MAIN, APP_CLASS};
133         // create an archive with the main class from a non-modular jar in the
134         // -cp and the class from the org.astro module
135         // note: the org.astro package needs to be exported to &quot;ALL-UNNAMED&quot;
136         // module since the jar in the -cp is a non-modular jar and thus it is
137         // unnmaed.
138         output = TestCommon.createArchive(
139                                         appJar2.toString(), appClasses2,
140                                         &quot;--module-path&quot;, moduleDir.toString(),
141                                         &quot;--add-modules&quot;, TEST_MODULE2,
142                                         &quot;--add-exports&quot;, &quot;org.astro/org.astro=ALL-UNNAMED&quot;,
143                                         UNNAMED_MAIN);
144         TestCommon.checkDump(output);
145 
146         // both the main class and the class from the org.astro module should
147         // be loaded from the archive
148         TestCommon.run(&quot;-Xlog:class+load=trace&quot;,
149                        &quot;-cp&quot;, appJar2.toString(),
150                        &quot;--module-path&quot;, moduleDir.toString(),
151                        &quot;--add-modules&quot;, TEST_MODULE2,
152                        &quot;--add-exports&quot;, &quot;org.astro/org.astro=ALL-UNNAMED&quot;,
153                        UNNAMED_MAIN)
154             .assertNormalExit(
155                 &quot;[class,load] org.astro.World source: shared objects file&quot;,
156                 &quot;[class,load] com.nomodule.Main source: shared objects file&quot;);
157     }
158 }
    </pre>
  </body>
</html>