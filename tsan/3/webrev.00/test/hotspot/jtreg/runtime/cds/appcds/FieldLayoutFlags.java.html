<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New test/hotspot/jtreg/runtime/cds/appcds/FieldLayoutFlags.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2019, 2020, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
 23  */
 24 
 25 /*
 26  * @test
 27  * @summary VM should work even if different field layout options are chosen between dump time and run time.
 28  * @bug 8233086
 29  * @requires vm.cds
 30  * @modules java.base/jdk.internal.misc
 31  * @modules java.base/jdk.internal.vm.annotation
 32  * @library /test/lib /test/hotspot/jtreg/runtime/cds/appcds /test/hotspot/jtreg/runtime/cds/appcds/test-classes
 33  * @build FieldLayoutApp
 34  * @run driver ClassFileInstaller -jar field_layout.jar
 35  *     FieldLayoutApp
 36  *     FieldLayoutApp$TestObject
 37  *     FieldLayoutApp$Base1
 38  *     FieldLayoutApp$Base2
 39  *     FieldLayoutApp$Child1
 40  *     FieldLayoutApp$Child2
 41  * @run driver FieldLayoutFlags
 42  */
 43 
 44 import jdk.test.lib.Platform;
 45 
 46 public class FieldLayoutFlags {
 47     static final String[][] flags = {
 48         // Dump time                             // Run time
 49         {},                                      {},   // All defaults. Ensure that the test itself is correct.
 50         {&quot;-XX:+EnableContended&quot;},                {&quot;-XX:-EnableContended&quot;},
 51         {&quot;-XX:-EnableContended&quot;},                {&quot;-XX:+EnableContended&quot;},
 52 
 53         {&quot;-XX:ContendedPaddingWidth=128&quot;},       {&quot;-XX:ContendedPaddingWidth=256&quot;},
 54         {&quot;-XX:ContendedPaddingWidth=256&quot;},       {&quot;-XX:ContendedPaddingWidth=128&quot;},
 55     };
 56 
 57     static final String appJar = ClassFileInstaller.getJarPath(&quot;field_layout.jar&quot;);
 58 
 59     public static void main(String[] args) throws Exception {
 60         for (int i = 0; i &lt; flags.length; i += 2) {
 61             String[] dumpFlags = flags[i+0];
 62             String[] runFlags  = flags[i+1];
 63 
 64             System.out.println(&quot;====================================================== Cases &quot; + i + &quot; and &quot; + (i + 1));
 65             logFlags(&quot;Dump:&quot;, dumpFlags);
 66             logFlags(&quot;Run :&quot;, runFlags);
 67 
 68             testDump(dontRestrict(dumpFlags));
 69             testRun (dontRestrict(runFlags));
 70         }
 71     }
 72 
 73     static void logFlags(String which, String[] flags) {
 74         System.out.print(which);
 75         String prefix = &quot; &quot;;
 76         for (String s : flags) {
 77             System.out.print(prefix);
 78             System.out.print(s);
 79             prefix = &quot;, &quot;;
 80         }
 81         System.out.println();
 82     }
 83 
 84     // Don&#39;t restrict @Contended to trusted classes, so we can use it in FieldLayoutApp
 85     static String[] dontRestrict(String args[]) {
 86         return TestCommon.concat(&quot;-XX:-RestrictContended&quot;, args);
 87     }
 88 
 89     static void testDump(String[] dumpFlags) throws Exception {
 90         String classlist[] = new String[] {
 91             &quot;FieldLayoutApp&quot;,
 92             &quot;FieldLayoutApp$TestObject&quot;,
 93             &quot;FieldLayoutApp$Base1&quot;,
 94             &quot;FieldLayoutApp$Base2&quot;,
 95 
 96             /*
 97              * Note, the following classes are not archived, and will be loaded
 98              * dynamically at run time. We check that their field layout is compatible with
 99              * their super classes, which are archived.
100              */
101             // &quot;FieldLayoutApp$Child1&quot;,
102             // &quot;FieldLayoutApp$Child2&quot;,
103         };
104 
105         TestCommon.testDump(appJar, classlist, dumpFlags);
106     }
107 
108     static void testRun(String[] runFlags) throws Exception {
109         String[] cmds = TestCommon.concat(runFlags, &quot;-cp&quot;, appJar);
110         if (Platform.isDebugBuild()) {
111             cmds = TestCommon.concat(cmds, &quot;-XX:+PrintFieldLayout&quot;);
112         }
113         cmds = TestCommon.concat(cmds, &quot;FieldLayoutApp&quot;);
114 
115         TestCommon.run(cmds).assertNormalExit();
116     }
117 }
    </pre>
  </body>
</html>