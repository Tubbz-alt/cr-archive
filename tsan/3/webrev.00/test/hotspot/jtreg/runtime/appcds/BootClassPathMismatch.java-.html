<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old test/hotspot/jtreg/runtime/appcds/BootClassPathMismatch.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2014, 2018, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
 23  */
 24 
 25 /*
 26  * @test
 27  * @summary bootclasspath mismatch test.
 28  * @requires vm.cds
 29  * @library /test/lib
 30  * @modules java.base/jdk.internal.misc
 31  *          java.management
 32  *          jdk.jartool/sun.tools.jar
 33  * @compile test-classes/Hello.java
 34  * @run driver BootClassPathMismatch
 35  */
 36 
 37 import jdk.test.lib.cds.CDSOptions;
 38 import jdk.test.lib.cds.CDSTestUtils;
 39 import jdk.test.lib.process.OutputAnalyzer;
 40 import java.io.File;
 41 import java.nio.file.Files;
 42 import java.nio.file.FileAlreadyExistsException;
 43 import java.nio.file.StandardCopyOption;
 44 import java.nio.file.Paths;
 45 
 46 
 47 public class BootClassPathMismatch {
 48     private static final String mismatchMessage = &quot;shared class paths mismatch&quot;;
 49 
 50     public static void main(String[] args) throws Exception {
 51         JarBuilder.getOrCreateHelloJar();
 52         copyHelloToNewDir();
 53 
 54         BootClassPathMismatch test = new BootClassPathMismatch();
 55         test.testBootClassPathMismatch();
 56         test.testBootClassPathMismatchWithAppClass();
 57         test.testBootClassPathMismatchWithBadPath();
 58         test.testBootClassPathMatchWithAppend();
 59         test.testBootClassPathMatch();
 60     }
 61 
 62     /* Archive contains boot classes only, with Hello class on -Xbootclasspath/a path.
 63      *
 64      * Error should be detected if:
 65      * dump time: -Xbootclasspath/a:${testdir}/hello.jar
 66      * run-time : -Xbootclasspath/a:${testdir}/newdir/hello.jar
 67      *
 68      * or
 69      * dump time: -Xbootclasspath/a:${testdir}/newdir/hello.jar
 70      * run-time : -Xbootclasspath/a:${testdir}/hello.jar
 71      */
 72     public void testBootClassPathMismatch() throws Exception {
 73         String appJar = JarBuilder.getOrCreateHelloJar();
 74         String appClasses[] = {&quot;Hello&quot;};
 75         String testDir = TestCommon.getTestDir(&quot;newdir&quot;);
 76         String otherJar = testDir + File.separator + &quot;hello.jar&quot;;
 77 
 78         TestCommon.dump(appJar, appClasses, &quot;-Xbootclasspath/a:&quot; + appJar);
 79         TestCommon.run(
 80                 &quot;-cp&quot;, appJar, &quot;-Xbootclasspath/a:&quot; + otherJar, &quot;Hello&quot;)
 81             .assertAbnormalExit(mismatchMessage);
 82 
 83         TestCommon.dump(appJar, appClasses, &quot;-Xbootclasspath/a:&quot; + otherJar);
 84         TestCommon.run(
 85                 &quot;-cp&quot;, appJar, &quot;-Xbootclasspath/a:&quot; + appJar, &quot;Hello&quot;)
 86             .assertAbnormalExit(mismatchMessage);
 87     }
 88 
 89     /* Archive contains boot classes only.
 90      *
 91      * Error should be detected if:
 92      * dump time: -Xbootclasspath/a:${testdir}/newdir/hello.jar
 93      * run-time : -Xbootclasspath/a:${testdir}/newdir/hello.jar1
 94      */
 95     public void testBootClassPathMismatchWithBadPath() throws Exception {
 96         String appClasses[] = {&quot;Hello&quot;};
 97         String testDir = TestCommon.getTestDir(&quot;newdir&quot;);
 98         String appJar = testDir + File.separator + &quot;hello.jar&quot;;
 99         String otherJar = testDir + File.separator + &quot;hello.jar1&quot;;
100 
101         TestCommon.dump(appJar, appClasses, &quot;-Xbootclasspath/a:&quot; + appJar);
102         TestCommon.run(
103                 &quot;-cp&quot;, appJar, &quot;-Xbootclasspath/a:&quot; + otherJar, &quot;Hello&quot;)
104             .assertAbnormalExit(mismatchMessage);
105     }
106 
107     /* Archive contains boot classes only, with Hello loaded from -Xbootclasspath/a at dump time.
108      *
109      * No error if:
110      * dump time: -Xbootclasspath/a:${testdir}/hello.jar
111      * run-time : -Xbootclasspath/a:${testdir}/hello.jar
112      */
113     public void testBootClassPathMatch() throws Exception {
114         String appJar = TestCommon.getTestJar(&quot;hello.jar&quot;);
115         String appClasses[] = {&quot;Hello&quot;};
116         TestCommon.dump(
117             appJar, appClasses, &quot;-Xbootclasspath/a:&quot; + appJar);
118         TestCommon.run(
119                 &quot;-cp&quot;, appJar, &quot;-verbose:class&quot;,
120                 &quot;-Xbootclasspath/a:&quot; + appJar, &quot;Hello&quot;)
121             .assertNormalExit(&quot;[class,load] Hello source: shared objects file&quot;);
122     }
123 
124     /* Archive contains boot classes only, runtime add -Xbootclasspath/a path.
125      *
126      * No error:
127      * dump time: No -Xbootclasspath/a
128      * run-time : -Xbootclasspath/a:${testdir}/hello.jar
129      */
130     public void testBootClassPathMatchWithAppend() throws Exception {
131       CDSOptions opts = new CDSOptions().setUseVersion(false);
132       OutputAnalyzer out = CDSTestUtils.createArchive(opts);
133       CDSTestUtils.checkDump(out);
134 
135       String appJar = JarBuilder.getOrCreateHelloJar();
136       opts.addPrefix(&quot;-Xbootclasspath/a:&quot; + appJar, &quot;-showversion&quot;).addSuffix(&quot;Hello&quot;);
137       CDSTestUtils.runWithArchiveAndCheck(opts);
138     }
139 
140     /* Archive contains app classes, with Hello on -cp path at dump time.
141      *
142      * Error should be detected if:
143      * dump time: &lt;no bootclasspath specified&gt;
144      * run-time : -Xbootclasspath/a:${testdir}/hello.jar
145      */
146     public void testBootClassPathMismatchWithAppClass() throws Exception {
147         String appJar = JarBuilder.getOrCreateHelloJar();
148         String appClasses[] = {&quot;Hello&quot;};
149         TestCommon.dump(appJar, appClasses);
150         TestCommon.run(
151                 &quot;-cp&quot;, appJar, &quot;-Xbootclasspath/a:&quot; + appJar, &quot;Hello&quot;)
152             .assertAbnormalExit(mismatchMessage);
153     }
154 
155     private static void copyHelloToNewDir() throws Exception {
156         String classDir = System.getProperty(&quot;test.classes&quot;);
157         String dstDir = classDir + File.separator + &quot;newdir&quot;;
158         try {
159             Files.createDirectory(Paths.get(dstDir));
160         } catch (FileAlreadyExistsException e) { }
161 
162         // copy as hello.jar
163         Files.copy(Paths.get(classDir, &quot;hello.jar&quot;),
164             Paths.get(dstDir, &quot;hello.jar&quot;),
165             StandardCopyOption.REPLACE_EXISTING);
166 
167         // copy as hello.jar1
168         Files.copy(Paths.get(classDir, &quot;hello.jar&quot;),
169             Paths.get(dstDir, &quot;hello.jar1&quot;),
170             StandardCopyOption.REPLACE_EXISTING);
171     }
172 }
    </pre>
  </body>
</html>