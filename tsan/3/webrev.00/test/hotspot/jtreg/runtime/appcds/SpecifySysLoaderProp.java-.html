<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old test/hotspot/jtreg/runtime/appcds/SpecifySysLoaderProp.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
  <body>
    <pre>
 1 /*
 2  * Copyright (c) 2014, 2018, Oracle and/or its affiliates. All rights reserved.
 3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 4  *
 5  * This code is free software; you can redistribute it and/or modify it
 6  * under the terms of the GNU General Public License version 2 only, as
 7  * published by the Free Software Foundation.
 8  *
 9  * This code is distributed in the hope that it will be useful, but WITHOUT
10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
12  * version 2 for more details (a copy is included in the LICENSE file that
13  * accompanied this code).
14  *
15  * You should have received a copy of the GNU General Public License version
16  * 2 along with this work; if not, write to the Free Software Foundation,
17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
18  *
19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
20  * or visit www.oracle.com if you need additional information or have any
21  * questions.
22  *
23  */
24 
25 /*
26  * @test
27  * @summary If -Djava.system.class.loader=xxx is specified in command-line, disable archived non-system classes
28  * @requires vm.cds
29  * @library /test/lib
30  * @modules java.base/jdk.internal.misc
31  *      jdk.jartool/sun.tools.jar
32  * @compile test-classes/TestClassLoader.java
33  * @compile test-classes/ReportMyLoader.java
34  * @compile test-classes/TrySwitchMyLoader.java
35  * @run driver SpecifySysLoaderProp
36  */
37 
38 import java.io.*;
39 import jdk.test.lib.process.OutputAnalyzer;
40 
41 public class SpecifySysLoaderProp {
42 
43   public static void main(String[] args) throws Exception {
44     JarBuilder.build(&quot;sysloader&quot;, &quot;TestClassLoader&quot;, &quot;ReportMyLoader&quot;, &quot;TrySwitchMyLoader&quot;);
45 
46     String jarFileName = &quot;sysloader.jar&quot;;
47     String appJar = TestCommon.getTestJar(jarFileName);
48     TestCommon.testDump(appJar, TestCommon.list(&quot;ReportMyLoader&quot;));
49     String warning = &quot;VM warning: Archived non-system classes are disabled because the java.system.class.loader property is specified&quot;;
50 
51 
52     // (0) Baseline. Do not specify -Djava.system.class.loader
53     //     The test class should be loaded from archive
54     TestCommon.run(
55         &quot;-verbose:class&quot;,
56         &quot;-cp&quot;, appJar,
57         &quot;ReportMyLoader&quot;)
58       .assertNormalExit(&quot;[class,load] ReportMyLoader source: shared objects file&quot;,
59                         &quot;ReportMyLoader&#39;s loader = jdk.internal.loader.ClassLoaders$AppClassLoader@&quot;);
60 
61     // (1) Try to execute the archive with -Djava.system.class.loader=no.such.Klass,
62     //     it should fail
63     TestCommon.run(
64         &quot;-cp&quot;, appJar,
65         &quot;-Djava.system.class.loader=no.such.Klass&quot;,
66         &quot;ReportMyLoader&quot;)
67       .assertAbnormalExit(output -&gt; {
68           output.shouldContain(warning);
69           output.shouldContain(&quot;ClassNotFoundException: no.such.Klass&quot;);
70         });
71 
72     // (2) Try to execute the archive with -Djava.system.class.loader=TestClassLoader,
73     //     it should run, but archived non-system classes should be disabled
74     TestCommon.run(
75         &quot;-verbose:class&quot;,
76         &quot;-cp&quot;, appJar,
77         &quot;-Djava.system.class.loader=TestClassLoader&quot;,
78         &quot;ReportMyLoader&quot;)
79       .assertNormalExit(&quot;ReportMyLoader&#39;s loader = jdk.internal.loader.ClassLoaders$AppClassLoader@&quot;, //&lt;-this is still printed because TestClassLoader simply delegates to Launcher$AppLoader, but ...
80              &quot;TestClassLoader.called = true&quot;, //&lt;-but this proves that TestClassLoader was indeed called.
81              &quot;TestClassLoader: loadClass(\&quot;ReportMyLoader\&quot;,&quot;) //&lt;- this also proves that TestClassLoader was indeed called.
82       .assertNormalExit(output -&gt; {
83         output.shouldMatch(&quot;.class,load. TestClassLoader source: file:&quot;);
84         output.shouldMatch(&quot;.class,load. ReportMyLoader source: file:.*&quot; + jarFileName);
85         });
86 
87     // (3) Try to change the java.system.class.loader programmatically after
88     //     the app&#39;s main method is executed. This should have no effect in terms of
89     //     changing or switching the actual system class loader that&#39;s already in use.
90     TestCommon.run(
91         &quot;-verbose:class&quot;,
92         &quot;-cp&quot;, appJar,
93         &quot;TrySwitchMyLoader&quot;)
94       .assertNormalExit(&quot;[class,load] ReportMyLoader source: shared objects file&quot;,
95              &quot;TrySwitchMyLoader&#39;s loader = jdk.internal.loader.ClassLoaders$AppClassLoader@&quot;,
96              &quot;ReportMyLoader&#39;s loader = jdk.internal.loader.ClassLoaders$AppClassLoader@&quot;,
97              &quot;TestClassLoader.called = false&quot;);
98   }
99 }
    </pre>
  </body>
</html>