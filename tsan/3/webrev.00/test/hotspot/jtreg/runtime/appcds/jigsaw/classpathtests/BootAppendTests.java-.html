<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old test/hotspot/jtreg/runtime/appcds/jigsaw/classpathtests/BootAppendTests.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2015, 2018, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
 23  */
 24 
 25 /**
 26  * @test
 27  * @summary AppCDS tests for testing -Xbootclasspath/a
 28  * @requires vm.cds &amp; !vm.graal.enabled
 29  * @library /test/lib /test/hotspot/jtreg/runtime/appcds
 30  * @modules java.base/jdk.internal.misc
 31  *          java.management
 32  *          jdk.jartool/sun.tools.jar
 33  *          jdk.internal.jvmstat/sun.jvmstat.monitor
 34  * @compile src/jdk/test/Main.java
 35  * @compile src/com/sun/tools/javac/MyMain.jasm
 36  * @compile src/sun/nio/cs/ext/MyClass.java
 37  * @compile src/sun/nio/cs/ext1/MyClass.java
 38  * @run driver BootAppendTests
 39  */
 40 
 41 import java.io.File;
 42 import java.nio.file.Path;
 43 import java.nio.file.Paths;
 44 import jdk.test.lib.cds.CDSOptions;
 45 import jdk.test.lib.cds.CDSTestUtils;
 46 import jdk.test.lib.process.ProcessTools;
 47 import jdk.test.lib.process.OutputAnalyzer;
 48 
 49 public class BootAppendTests {
 50     private static final String TEST_SRC = System.getProperty(&quot;test.src&quot;);
 51     private static final Path SRC_DIR = Paths.get(TEST_SRC, &quot;src&quot;);
 52     private static final Path CLASSES_DIR = Paths.get(&quot;classes&quot;);
 53 
 54     private static final String MAIN_CLASS = &quot;jdk.test.Main&quot;;
 55     private static final String APP_MODULE_CLASS = &quot;com/sun/tools/javac/MyMain&quot;;
 56     private static final String BOOT_APPEND_MODULE_CLASS = &quot;sun/nio/cs/ext/MyClass&quot;;
 57     private static final String BOOT_APPEND_CLASS = &quot;sun/nio/cs/ext1/MyClass&quot;;
 58     private static final String[] ARCHIVE_CLASSES =
 59          {APP_MODULE_CLASS, BOOT_APPEND_MODULE_CLASS, BOOT_APPEND_CLASS};
 60 
 61     private static String appJar;
 62     private static String bootAppendJar;
 63     private static String testArchiveName;
 64 
 65     public static void main(String... args) throws Exception {
 66         dumpArchive();
 67 
 68         System.out.println(&quot;TESTCASE: 1: testBootAppendModuleClassWithoutAppCDS&quot;);
 69         testBootAppendModuleClassWithoutAppCDS();
 70 
 71         System.out.println(&quot;TESTCASE: 2&quot; );
 72         testBootAppendModuleClassWithAppCDS();
 73 
 74         System.out.println(&quot;TESTCASE: 3&quot; );
 75         testBootAppendExcludedModuleClassWithoutAppCDS();
 76 
 77         System.out.println(&quot;TESTCASE: 4&quot; );
 78         testBootAppendExcludedModuleClassWithAppCDS();
 79 
 80         System.out.println(&quot;TESTCASE: 5&quot; );
 81         testBootAppendClassWithoutAppCDS();
 82 
 83         System.out.println(&quot;TESTCASE: 6&quot; );
 84         testBootAppendClassWithAppCDS();
 85 
 86         System.out.println(&quot;TESTCASE: 7&quot; );
 87         testBootAppendAppModuleClassWithoutAppCDS();
 88 
 89         System.out.println(&quot;TESTCASE: 9&quot; );
 90         testBootAppendAppModuleClassWithAppCDS();
 91 
 92         System.out.println(&quot;TESTCASE: 9&quot; );
 93         testBootAppendAppExcludeModuleClassWithoutAppCDS();
 94 
 95         System.out.println(&quot;TESTCASE: 10&quot; );
 96         testBootAppendAppExcludeModuleClassAppCDS();
 97     }
 98 
 99     static void dumpArchive() throws Exception {
100         JarBuilder.build(&quot;classpathtests&quot;, &quot;jdk/test/Main&quot;);
101         appJar = TestCommon.getTestJar(&quot;classpathtests.jar&quot;);
102 
103         JarBuilder.build(&quot;bootAppend&quot;,
104                          APP_MODULE_CLASS, BOOT_APPEND_MODULE_CLASS, BOOT_APPEND_CLASS);
105         bootAppendJar = TestCommon.getTestJar(&quot;bootAppend.jar&quot;);
106 
107         OutputAnalyzer output1  = TestCommon.dump(
108             appJar, TestCommon.list(ARCHIVE_CLASSES), &quot;-Xbootclasspath/a:&quot; + bootAppendJar);
109         TestCommon.checkDump(output1);
110 
111         if (!TestCommon.isUnableToMap(output1)) {
112             // Make sure all the classes were successfully archived.
113             for (String archiveClass : ARCHIVE_CLASSES) {
114                 output1.shouldNotContain(&quot;Preload Warning: Cannot find &quot; + archiveClass);
115             }
116         }
117 
118         testArchiveName = TestCommon.getCurrentArchiveName();
119     }
120 
121     // Test #1: A class in package defined in boot module
122     //    - should not be loaded from the -Xbootclasspath/a without AppCDS
123     public static void testBootAppendModuleClassWithoutAppCDS() throws Exception {
124         CDSOptions opts = (new CDSOptions())
125             .addPrefix(&quot;-Xbootclasspath/a:&quot; + bootAppendJar, &quot;-cp&quot;, appJar)
126             .setArchiveName(testArchiveName)
127             .addSuffix(MAIN_CLASS, &quot;Test #1&quot;, BOOT_APPEND_MODULE_CLASS, &quot;false&quot;);
128 
129         CDSTestUtils.runWithArchiveAndCheck(opts);
130     }
131 
132     // Test #2: A shared class in package defined in boot module that&#39;s archived
133     //          from -Xbootclasspath/a
134     //     - should not be loaded by AppCDS
135     public static void testBootAppendModuleClassWithAppCDS() throws Exception {
136         OutputAnalyzer output = TestCommon.exec(
137             appJar,
138             &quot;-Xbootclasspath/a:&quot; + bootAppendJar,
139             MAIN_CLASS,
140             &quot;Test #2&quot;, BOOT_APPEND_MODULE_CLASS, &quot;false&quot;);
141         TestCommon.checkExec(output);
142     }
143 
144 
145     // Test #3: A class in excluded package defined in boot module
146     //     - should be loaded from the -Xbootclasspath/a by the boot classloader
147     public static void testBootAppendExcludedModuleClassWithoutAppCDS() throws Exception {
148         TestCommon.run(
149             &quot;-Xbootclasspath/a:&quot; + bootAppendJar, &quot;-cp&quot;, appJar,
150             &quot;-Xlog:class+load=info&quot;,
151             &quot;--limit-modules&quot;, &quot;java.base&quot;,
152             MAIN_CLASS, &quot;Test #3&quot;, BOOT_APPEND_MODULE_CLASS, &quot;true&quot;, &quot;BOOT&quot;)
153             .assertSilentlyDisabledCDS(out -&gt; {
154                 out.shouldHaveExitValue(0)
155                    .shouldMatch(&quot;.class.load. sun.nio.cs.ext.MyClass source:.*bootAppend.jar&quot;);
156             });
157     }
158 
159     // Test #4: A shared class in excluded package that&#39;s archived from
160     //          -Xbootclasspath/a
161     //     - should be loaded from the jar since AppCDS will be disabled with
162     //       the --limit-modules option
163     public static void testBootAppendExcludedModuleClassWithAppCDS() throws Exception {
164         TestCommon.run(
165             &quot;-cp&quot;, appJar, &quot;-Xbootclasspath/a:&quot; + bootAppendJar,
166             &quot;-Xlog:class+load=info&quot;,
167             &quot;--limit-modules&quot;, &quot;java.base&quot;,
168             MAIN_CLASS,
169             &quot;Test #4&quot;, BOOT_APPEND_MODULE_CLASS, &quot;true&quot;, &quot;BOOT&quot;)
170             .assertSilentlyDisabledCDS(out -&gt; {
171                 out.shouldHaveExitValue(0)
172                    .shouldMatch(&quot;.class.load. sun.nio.cs.ext.MyClass source:.*bootAppend.jar&quot;);
173             });
174     }
175 
176 
177     // Test #5: A class not in package defined in boot module
178     //    - should be loaded from the -Xbootclasspath/a without AppCDS
179     public static void testBootAppendClassWithoutAppCDS() throws Exception {
180         CDSOptions opts = (new CDSOptions())
181             .addPrefix(&quot;-Xbootclasspath/a:&quot; + bootAppendJar, &quot;-cp&quot;, appJar)
182             .setArchiveName(testArchiveName)
183             .addSuffix(MAIN_CLASS, &quot;Test #5&quot;, BOOT_APPEND_CLASS, &quot;true&quot;, &quot;BOOT&quot;);
184 
185         CDSTestUtils.runWithArchiveAndCheck(opts);
186     }
187 
188 
189     // Test #6: A shared class not in package defined in boot module that&#39;s
190     //          archived from -Xbootclasspath/a
191     //    - should be loaded from the archive by the bootstrap class loader
192     public static void testBootAppendClassWithAppCDS() throws Exception {
193         OutputAnalyzer output = TestCommon.exec(
194             appJar,
195             &quot;-Xbootclasspath/a:&quot; + bootAppendJar,
196             &quot;-XX:+TraceClassLoading&quot;,
197             MAIN_CLASS,
198             &quot;Test #6&quot;, BOOT_APPEND_CLASS, &quot;true&quot;, &quot;BOOT&quot;);
199         TestCommon.checkExec(output);
200         if (!TestCommon.isUnableToMap(output))
201             output.shouldContain(&quot;[class,load] sun.nio.cs.ext1.MyClass source: shared objects file&quot;);
202     }
203 
204 
205     // Test #7: A class in package defined in jimage app module
206     //    - should not be loaded from the -Xbootclasspath/a without AppCDS
207     public static void testBootAppendAppModuleClassWithoutAppCDS() throws Exception {
208         CDSOptions opts = (new CDSOptions())
209             .addPrefix(&quot;-Xbootclasspath/a:&quot; + bootAppendJar, &quot;-cp&quot;, appJar)
210             .setArchiveName(testArchiveName)
211             .addSuffix(MAIN_CLASS, &quot;Test #7&quot;, APP_MODULE_CLASS, &quot;false&quot;);
212 
213         CDSTestUtils.runWithArchiveAndCheck(opts);
214     }
215 
216 
217     // Test #8: A shared class in package defined in jimage app module that&#39;s
218     //          archived from -Xbootclasspath/a
219     //    - should not be loaded from the archive
220     public static void testBootAppendAppModuleClassWithAppCDS() throws Exception {
221         OutputAnalyzer output = TestCommon.exec(
222             appJar,
223             &quot;-Xbootclasspath/a:&quot; + bootAppendJar,
224             MAIN_CLASS,
225             &quot;Test #8&quot;, APP_MODULE_CLASS, &quot;false&quot;);
226         TestCommon.checkExec(output);
227     }
228 
229 
230     // Test #9: A class in excluded package defined in jimage app module
231     //    - should be loaded from the -Xbootclasspath/a without AppCDS
232     public static void testBootAppendAppExcludeModuleClassWithoutAppCDS()
233         throws Exception {
234 
235         TestCommon.run(
236             &quot;-Xbootclasspath/a:&quot; + bootAppendJar, &quot;-cp&quot;, appJar,
237             &quot;-Xlog:class+load=info&quot;,
238             &quot;--limit-modules&quot;, &quot;java.base&quot;,
239             MAIN_CLASS, &quot;Test #9&quot;, APP_MODULE_CLASS, &quot;true&quot;, &quot;BOOT&quot;)
240             .assertSilentlyDisabledCDS(out -&gt; {
241                 out.shouldHaveExitValue(0)
242                    .shouldMatch(&quot;.class.load. com.sun.tools.javac.MyMain source:.*bootAppend.jar&quot;);
243             });
244     }
245 
246     // Test #10: A shared class in excluded package defined in jimage app module
247     //    - should be loaded from the -Xbootclasspath/a with AppCDS
248     public static void testBootAppendAppExcludeModuleClassAppCDS() throws Exception {
249         TestCommon.run(
250             &quot;-cp&quot;, appJar, &quot;-Xbootclasspath/a:&quot; + bootAppendJar,
251             &quot;-Xlog:class+load=info&quot;,
252             &quot;--limit-modules&quot;, &quot;java.base&quot;,
253             MAIN_CLASS, &quot;Test #10&quot;, APP_MODULE_CLASS, &quot;true&quot;, &quot;BOOT&quot;)
254             .assertSilentlyDisabledCDS(out -&gt; {
255                 out.shouldHaveExitValue(0)
256                    .shouldMatch(&quot;.class.load. com.sun.tools.javac.MyMain source:.*bootAppend.jar&quot;);
257             });
258     }
259 }
    </pre>
  </body>
</html>