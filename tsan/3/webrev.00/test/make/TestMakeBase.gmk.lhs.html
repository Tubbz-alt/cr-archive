<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/make/TestMakeBase.gmk</title>
    <link rel="stylesheet" href="../../style.css" />
    <script type="text/javascript" src="../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 #
<a name="1" id="anc1"></a><span class="line-modified">  2 # Copyright (c) 2014, 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3 # DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4 #
  5 # This code is free software; you can redistribute it and/or modify it
  6 # under the terms of the GNU General Public License version 2 only, as
  7 # published by the Free Software Foundation.  Oracle designates this
  8 # particular file as subject to the &quot;Classpath&quot; exception as provided
  9 # by Oracle in the LICENSE file that accompanied this code.
 10 #
 11 # This code is distributed in the hope that it will be useful, but WITHOUT
 12 # ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13 # FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14 # version 2 for more details (a copy is included in the LICENSE file that
 15 # accompanied this code).
 16 #
 17 # You should have received a copy of the GNU General Public License version
 18 # 2 along with this work; if not, write to the Free Software Foundation,
 19 # Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20 #
 21 # Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22 # or visit www.oracle.com if you need additional information or have any
 23 # questions.
 24 #
 25 
 26 default: all
 27 
 28 include $(SPEC)
 29 include MakeBase.gmk
 30 include UtilsForTests.gmk
 31 
 32 THIS_FILE := $(TOPDIR)/test/make/TestMakeBase.gmk
 33 DEPS := $(THIS_FILE) \
 34     $(TOPDIR)/make/common/MakeBase.gmk \
 35     #
 36 
 37 OUTPUT_DIR := $(TESTMAKE_OUTPUTDIR)/make-base
 38 $(call MakeDir, $(OUTPUT_DIR))
 39 
 40 ################################################################################
 41 # Escape $
 42 ifneq ($(call EscapeDollar, foo$$bar), foo\$$bar)
 43   $(error EscapeDollar failed $(call EscapeDollar, foo$$bar) foo\$$bar)
 44 endif
 45 
 46 ESCAPE_DOLLAR_DIR := $(OUTPUT_DIR)/escape-dollar
 47 
 48 $(ESCAPE_DOLLAR_DIR)/_escape_dollar: $(DEPS)
 49 	$(RM) -r $(@D)
 50 	$(MKDIR) -p $(@D)
 51 	$(ECHO) foo\$$bar &gt; $(@D)/file1
 52 	$(ECHO) $(call EscapeDollar, foo$$bar) &gt; $(@D)/file2
 53 	$(ECHO) $(call EscapeDollar, foo\$$bar) &gt; $(@D)/file3
 54 	$(DIFF) $(@D)/file1 $(@D)/file2
 55 	$(DIFF) $(@D)/file1 $(@D)/file3
 56 	$(TOUCH) $@
 57 
 58 TEST_TARGETS += $(ESCAPE_DOLLAR_DIR)/_escape_dollar
 59 
 60 ################################################################################
 61 # Test containing and not-containing
 62 
 63 CONT_LIST := foo bar baz foobar foobaz
 64 
 65 # Param 1 - string to look for
 66 # Param 2 - expected result
 67 define TestContaining
 68   value := $$(call containing, $1, $(CONT_LIST))
 69   ifneq ($$(value), $2)
 70     $$(info (call containing, $1, $(CONT_LIST)))
 71     $$(error result &gt;$$(value)&lt;, expected &gt;$2&lt;)
 72   endif
 73 endef
 74 
 75 $(eval $(call TestContaining,bar,bar foobar))
 76 $(eval $(call TestContaining,foo bar,foo bar foobar foobaz))
 77 
 78 # Param 1 - string to look for
 79 # Param 2 - expected result
 80 define TestNotContaining
 81   value := $$(call not-containing, $1, $(CONT_LIST))
 82   ifneq ($$(value), $2)
 83     $$(info (call not-containing, $1, $(CONT_LIST)))
 84     $$(error result &gt;$$(value)&lt;, expected &gt;$2&lt;)
 85   endif
 86 endef
 87 
 88 $(eval $(call TestNotContaining,bar,foo baz foobaz))
 89 $(eval $(call TestNotContaining,foo bar,baz))
 90 
 91 ################################################################################
 92 # Test Equals
 93 
 94 EQUALS_VALUE1 := value1$(SPACE)
 95 EQUALS_VALUE2 := value2
 96 EQUALS_EMPTY :=
 97 
 98 ifneq ($(call equals, $(EQUALS_VALUE1), $(EQUALS_VALUE2)), )
 99   $(error The strings &gt;$(EQUALS_VALUE1)&lt; and &gt;$(EQUALS_VALUE2)&lt; are equal)
100 endif
101 
102 ifeq ($(call equals, $(EQUALS_VALUE1), $(EQUALS_VALUE1)), )
103   $(error The strings &gt;$(EQUALS_VALUE1)&lt; and &gt;$(EQUALS_VALUE1)&lt; are not equal)
104 endif
105 
106 ifeq ($(call equals, $(EQUALS_EMPTY), $(EQUALS_EMPTY)), )
107   $(error The strings &gt;$(EQUALS_EMPTY)&lt; and &gt;$(EQUALS_EMPTY)&lt; are not equal)
108 endif
109 
110 ifneq ($(call equals, $(EQUALS_EMPTY), $(EQUALS_VALUE2)), )
111   $(error The strings &gt;$(EQUALS_EMPTY)&lt; and &gt;$(EQUALS_VALUE2)&lt; are equal)
112 endif
113 
114 ifneq ($(call equals, $(EQUALS_VALUE2), $(EQUALS_EMPTY)), )
115   $(error The strings &gt;$(EQUALS_VALUE2)&lt; and &gt;$(EQUALS_EMPTY)&lt; are equal)
116 endif
117 
118 ################################################################################
119 # Test boolean operators
120 
121 $(eval $(call assert-equals, $(call And,  true  true  true ), true))
122 $(eval $(call assert-equals, $(call And,  true  false true ), false))
123 $(eval $(call assert-equals, $(call And,  false false false ), false))
124 $(eval $(call assert-equals, $(call And, true), true))
125 $(eval $(call assert-equals, $(call And, false), false))
126 $(eval $(call assert-equals, $(call And,    ), true))
127 
128 $(eval $(call assert-equals, $(call Or,  true  true  true ), true))
129 $(eval $(call assert-equals, $(call Or,  true  false true ), true))
130 $(eval $(call assert-equals, $(call Or,  false false false ), false))
131 $(eval $(call assert-equals, $(call Or, true), true))
132 $(eval $(call assert-equals, $(call Or, false), false))
133 $(eval $(call assert-equals, $(call Or,    ), false))
134 
135 # We cannot catch $(error) while testing, but you can enable this manually
136 # by uncommenting and watch make fails.
137 #$(eval $(call assert-equals, $(call And,  non-boolean  ), $(error ...)))
138 #$(eval $(call assert-equals, $(call Or,  non-boolean  ), $(error ...)))
139 
140 ################################################################################
141 # Test remove-prefixes
142 
<a name="2" id="anc2"></a><span class="line-modified">143 $(eval $(call assert-equals, \</span>
144     $(call remove-prefixes, pre, prefix postfix), fix postfix, \
<a name="3" id="anc3"></a><span class="line-modified">145     Prefixes not properly removed))</span>
146 
<a name="4" id="anc4"></a><span class="line-modified">147 $(eval $(call assert-equals, \</span>
148     $(call remove-prefixes, pre post, prefix postfix), fix fix, \
<a name="5" id="anc5"></a><span class="line-modified">149     Prefixes not properly removed))</span>
150 
151 ################################################################################
152 # Test ShellQuote
153 
154 SHELL_QUOTE_VALUE := foo &#39;&quot;&quot;&#39; &quot;&#39;&#39;&quot; bar
155 SHELL_QUOTE_RESULT := $(shell $(ECHO) $(call ShellQuote, \
156     $(SHELL_QUOTE_VALUE)))
157 
158 ifneq ($(SHELL_QUOTE_VALUE), $(SHELL_QUOTE_RESULT))
159   $(error Expected: &gt;$(SHELL_QUOTE_VALUE)&lt; - Result: &gt;$(SHELL_QUOTE_RESULT)&lt;)
160 endif
161 
162 ################################################################################
163 # Test read and write to file
164 
165 READ_WRITE_FILE := $(OUTPUT_DIR)/read-write
166 READ_WRITE_VALUE := foo &#39;&quot;&quot;&#39; &quot;&#39;&#39;&quot; \t\n\\ bar
167 $(call WriteFile, $(READ_WRITE_VALUE), $(READ_WRITE_FILE))
168 READ_WRITE_RESULT := $(call ReadFile, $(READ_WRITE_FILE))
169 
170 ifneq ($(READ_WRITE_VALUE), $(READ_WRITE_RESULT))
171   $(error Expected: &gt;$(READ_WRITE_VALUE)&lt; - Result: &gt;$(READ_WRITE_RESULT)&lt;)
172 endif
173 
174 ################################################################################
175 # Test creating dependencies on make variables
176 
177 VARDEP_DIR := $(OUTPUT_DIR)/vardep
178 VARDEP_SRC_FILE := $(VARDEP_DIR)/src-file
179 VARDEP_TARGET_FILE := $(VARDEP_DIR)/target-file
180 VARDEP_FLAG_FILE := $(VARDEP_DIR)/flag-file
181 
182 $(VARDEP_DIR)/src-file:
183 	$(MKDIR) -p $(@D)
184 	$(ECHO) &quot;some string XXX&quot; &gt; $@
185 
186 $(VARDEP_TARGET_FILE): $(VARDEP_DIR)/src-file \
187     $(call DependOnVariable, VARDEP_TEST_VAR)
188 	$(MKDIR) -p $(@D)
189 	$(SED) -e &#39;s/XXX/$(VARDEP_TEST_VAR)/g&#39; $&lt; &gt; $@
190 	$(TOUCH) $(VARDEP_FLAG_FILE)
191 
192 test-vardep:
193 	$(RM) $(VARDEP_SRC_FILE) $(VARDEP_TARGET_FILE) $(VARDEP_FLAG_FILE)
194         #
195         # Simply create the target file and verify that it has the correct value
196         #
197 	$(MAKE) -f $(THIS_FILE) VARDEP_TEST_VAR=value1 $(VARDEP_TARGET_FILE)
198 	$(PRINTF) &quot;Expecting value1: %s\n&quot; &quot;`$(CAT) $(VARDEP_DIR)/target-file`&quot;
199 	test &quot;some string value1&quot; = &quot;`$(CAT) $(VARDEP_DIR)/target-file`&quot;
200 	test -e $(VARDEP_FLAG_FILE)
201         #
202         # Make the target file again and verify that the value is updated with
203         # the new value
204         #
205 	$(SLEEP_ON_MAC)
206 	$(MAKE) -f $(THIS_FILE) VARDEP_TEST_VAR=value2 $(VARDEP_TARGET_FILE)
207 	$(PRINTF) &quot;Expecting value2: %s\n&quot; &quot;`$(CAT) $(VARDEP_DIR)/target-file`&quot;
208 	test &quot;some string value2&quot; = &quot;`$(CAT) $(VARDEP_DIR)/target-file`&quot;
209 	test -e $(VARDEP_FLAG_FILE)
210         #
211         # Make the target again with the same value and verify that the recipe
212         # was never run by checking that the flag file was not recreated
213         #
214 	$(SLEEP_ON_MAC)
215 	$(RM) $(VARDEP_FLAG_FILE)
216 	$(MAKE) -f $(THIS_FILE) VARDEP_TEST_VAR=value2 $(VARDEP_TARGET_FILE)
217 	$(PRINTF) &quot;Expecting value2: %s\n&quot; &quot;`$(CAT) $(VARDEP_DIR)/target-file`&quot;
218 	test &quot;some string value2&quot; = &quot;`$(CAT) $(VARDEP_DIR)/target-file`&quot;
219 	test ! -e $(VARDEP_FLAG_FILE)
220         #
221         # Test running with spaces at the end and the middle of the value
222         # and verify that the file isn&#39;t rewritten the second time
223         #
224 	$(MAKE) -f $(THIS_FILE) VARDEP_TEST_VAR=&quot;value3  foo &quot; $(VARDEP_TARGET_FILE)
225 	$(RM) $(VARDEP_FLAG_FILE)
226 	$(MAKE) -f $(THIS_FILE) VARDEP_TEST_VAR=&quot;value3 foo&quot; $(VARDEP_TARGET_FILE)
227 	test ! -e $(VARDEP_FLAG_FILE)
228 	$(MAKE) -f $(THIS_FILE) VARDEP_TEST_VAR=&quot; value3  foo&quot; $(VARDEP_TARGET_FILE)
229 	test ! -e $(VARDEP_FLAG_FILE)
230         #
231         # Test including some problematic characters
232 	$(MAKE) -f $(THIS_FILE) VARDEP_TEST_VAR=&#39;value4 \$$ORIGIN&#39; $(VARDEP_TARGET_FILE)
233 	$(RM) $(VARDEP_FLAG_FILE)
234 	$(MAKE) -f $(THIS_FILE) VARDEP_TEST_VAR=&#39;value4 \$$ORIGIN&#39; $(VARDEP_TARGET_FILE)
235 	test ! -e $(VARDEP_FLAG_FILE)
236 
237 # Test specifying a specific value file to store variable in
238 VARDEP_VALUE_FILE := $(VARDEP_DIR)/value-file
239 VARDEP_TEST_VAR2 := value3
240 
241 VARDEP_RETURN_VALUE := $(call DependOnVariable, VARDEP_TEST_VAR2, $(VARDEP_VALUE_FILE))
<a name="6" id="anc6"></a><span class="line-modified">242 $(eval $(call assert-equals, $(VARDEP_RETURN_VALUE), $(VARDEP_VALUE_FILE), \</span>
<span class="line-modified">243     Wrong filename returned))</span>
244 -include $(VARDEP_VALUE_FILE)
<a name="7" id="anc7"></a><span class="line-modified">245 $(eval $(call assert-equals, $(VARDEP_TEST_VAR2_old), $(VARDEP_TEST_VAR2), \</span>
<span class="line-modified">246     Wrong contents in vardeps file))</span>
247 
248 # Test with a variable value containing some problematic characters
249 VARDEP_TEST_VAR3 := foo &#39;&quot;&quot;&#39; &quot;&#39;&#39;&quot; bar \$$ORIGIN &amp;\#x00a9
250 VARDEP_VALUE_FILE := $(call DependOnVariable, VARDEP_TEST_VAR3)
251 -include $(VARDEP_VALUE_FILE)
<a name="8" id="anc8"></a><span class="line-modified">252 $(eval $(call assert-equals, $(call EscapeHash,$(VARDEP_TEST_VAR3_old)), \</span>
253     $(call EscapeHash,$(VARDEP_TEST_VAR3)), \
<a name="9" id="anc9"></a><span class="line-modified">254     Wrong contents in vardep file))</span>
255 
256 TEST_TARGETS += test-vardep
257 
258 ################################################################################
259 # Test sequence
260 
261 ifneq ($(call sequence, 1, 1), 1)
262   $(error Sequence 1, 1 should be &quot;1&quot;, but was $(call sequence, 1, 1))
263 endif
264 
265 ifneq ($(call sequence, 2, 3), 2 3)
266   $(error Sequence 2, 3 should be &quot;2 3&quot;, but was $(call sequence, 2, 3))
267 endif
268 
269 ifneq ($(call sequence, 4, 9), 4 5 6 7 8 9)
270   $(error Sequence 4, 9 should be &quot;4 5 6 7 8 9&quot;, but was $(call sequence, 4, 9))
271 endif
272 
273 ifneq ($(call sequence, 5, 15), 5 6 7 8 9 10 11 12 13 14 15)
274   $(error Sequence 5, 15 should be &quot;5 6 7 8 9 10 11 12 13 14 15&quot;, \
275       but was $(call sequence, 5, 15))
276 endif
277 
278 ################################################################################
279 # Test that PathList is safe when called multiple nested times.
280 
281 PATHLIST_INPUT := foo bar baz
282 
<a name="10" id="anc10"></a><span class="line-modified">283 $(eval $(call assert-equals, \</span>
284     $(call PathList, $(call PathList, $(PATHLIST_INPUT))), \
285     $(call PathList, $(PATHLIST_INPUT)), \
<a name="11" id="anc11"></a><span class="line-modified">286     PathList call not safe for calling twice))</span>

287 
288 ################################################################################
289 # Test FindCommonPathPrefix
290 
<a name="12" id="anc12"></a><span class="line-modified">291 $(eval $(call assert-equals, \</span>
292     $(call FindCommonPathPrefix, /foo/bar/baz, /foo/bar/banan), \
293     /foo/bar, \
294     FindCommonPathPrefix, \
<a name="13" id="anc13"></a><span class="line-modified">295 ))</span>
296 
<a name="14" id="anc14"></a><span class="line-modified">297 $(eval $(call assert-equals, \</span>
298     $(call FindCommonPathPrefix, /foo/bar/baz, /foo/bar), \
299     /foo/bar, \
300     FindCommonPathPrefix, \
<a name="15" id="anc15"></a><span class="line-modified">301 ))</span>
302 
<a name="16" id="anc16"></a><span class="line-modified">303 $(eval $(call assert-equals, \</span>
304     $(call FindCommonPathPrefix, /foo/bar/baz, /foo/bar/), \
305     /foo/bar, \
306     FindCommonPathPrefix, \
<a name="17" id="anc17"></a><span class="line-modified">307 ))</span>
308 
<a name="18" id="anc18"></a><span class="line-modified">309 $(eval $(call assert-equals, \</span>
310     $(call FindCommonPathPrefix, foo/bar/baz, foo/bar/banan), \
311     foo/bar, \
312     FindCommonPathPrefix, \
<a name="19" id="anc19"></a><span class="line-modified">313 ))</span>
314 
<a name="20" id="anc20"></a><span class="line-modified">315 $(eval $(call assert-equals, \</span>
316     $(call FindCommonPathPrefix, foo/bar/baz, /foo/bar/banan), \
317     , \
318     FindCommonPathPrefix, \
<a name="21" id="anc21"></a><span class="line-modified">319 ))</span>
320 
321 ################################################################################
322 # DirToDotDot
323 
<a name="22" id="anc22"></a><span class="line-modified">324 $(eval $(call assert-equals, \</span>
325     $(call DirToDotDot, foo/bar/baz/), \
326     ../../.., \
327     DirToDotDot, \
<a name="23" id="anc23"></a><span class="line-modified">328 ))</span>
329 
<a name="24" id="anc24"></a><span class="line-modified">330 $(eval $(call assert-equals, \</span>
331     $(call DirToDotDot, foo/bar), \
332     ../.., \
333     DirToDotDot, \
<a name="25" id="anc25"></a><span class="line-modified">334 ))</span>
335 
<a name="26" id="anc26"></a><span class="line-modified">336 $(eval $(call assert-equals, \</span>
337     $(call DirToDotDot, /foo), \
338     .., \
339     DirToDotDot, \
<a name="27" id="anc27"></a><span class="line-modified">340 ))</span>
341 
342 ################################################################################
343 # RelativePath
344 
<a name="28" id="anc28"></a><span class="line-modified">345 $(eval $(call assert-equals, \</span>
346     $(call RelativePath, foo/bar/baz, foo/bar/banan), \
347     ../baz, \
348     RelativePath, \
<a name="29" id="anc29"></a><span class="line-modified">349 ))</span>
350 
<a name="30" id="anc30"></a><span class="line-modified">351 $(eval $(call assert-equals, \</span>
352     $(call RelativePath, foo/bar/baz/banan/kung, foo/bar/banan/kung), \
353     ../../baz/banan/kung, \
354     RelativePath, \
<a name="31" id="anc31"></a><span class="line-modified">355 ))</span>
356 
<a name="32" id="anc32"></a><span class="line-modified">357 $(eval $(call assert-equals, \</span>
358     $(call RelativePath, /foo/bar/baz/banan/kung, /foo/bar/banan/kung/), \
359     ../../baz/banan/kung, \
360     RelativePath, \
<a name="33" id="anc33"></a><span class="line-modified">361 ))</span>












362 
363 ################################################################################
364 # Test ParseKeywordVariable
365 
366 KWBASE := APA=banan;GURKA=tomat;COUNT=1%202%203%204%205;SUM=1+2+3+4+5;MANY_WORDS=I have the best words.
367 
368 $(eval $(call ParseKeywordVariable, KWBASE, \
369     SINGLE_KEYWORDS := APA GURKA SUM, \
370     STRING_KEYWORDS := COUNT MANY_WORDS, \
371 ))
372 
<a name="34" id="anc34"></a><span class="line-modified">373 $(eval $(call assert-equals, \</span>
374     $(KWBASE_APA), \
375     banan, \
376     ParseKeywordVariable failed to parse APA, \
<a name="35" id="anc35"></a><span class="line-modified">377 ))</span>
378 
<a name="36" id="anc36"></a><span class="line-modified">379 $(eval $(call assert-equals, \</span>
380     $(KWBASE_COUNT), \
381     1 2 3 4 5, \
382     ParseKeywordVariable failed to parse COUNT, \
<a name="37" id="anc37"></a><span class="line-modified">383 ))</span>
384 
<a name="38" id="anc38"></a><span class="line-modified">385 $(eval $(call assert-equals, \</span>
386     $(KWBASE_SUM), \
387     1+2+3+4+5, \
388     ParseKeywordVariable failed to parse SUM, \
<a name="39" id="anc39"></a><span class="line-modified">389 ))</span>
390 
<a name="40" id="anc40"></a><span class="line-modified">391 $(eval $(call assert-equals, \</span>
392     $(KWBASE_MANY_WORDS), \
393     I have the best words., \
394     ParseKeywordVariable failed to parse MANY_WORDS, \
<a name="41" id="anc41"></a><span class="line-modified">395 ))</span>
396 
397 # Simulate variable set from command line by using &quot;override&quot;
398 override KWBASE_WEIRD_GURKA := paprika
399 KWBASE_WEIRD := ;;APA=banan;;;GURKA=apelsin;APA=skansen;;
400 
401 $(eval $(call ParseKeywordVariable, KWBASE_WEIRD, \
402     SINGLE_KEYWORDS := APA GURKA SUM, \
403     STRING_KEYWORDS := COUNT, \
404 ))
405 
<a name="42" id="anc42"></a><span class="line-modified">406 $(eval $(call assert-equals, \</span>
407     $(KWBASE_WEIRD_APA), \
408     skansen, \
409     ParseKeywordVariable failed to overwrite APA, \
<a name="43" id="anc43"></a><span class="line-modified">410 ))</span>
411 
<a name="44" id="anc44"></a><span class="line-modified">412 $(eval $(call assert-equals, \</span>
413     $(KWBASE_WEIRD_GURKA), \
414     paprika, \
415     ParseKeywordVariable failed to preserve GURKA, \
<a name="45" id="anc45"></a><span class="line-modified">416 ))</span>


































































































































































































417 
418 ################################################################################
419 
420 all: $(TEST_TARGETS)
<a name="46" id="anc46"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="46" type="hidden" />
</body>
</html>