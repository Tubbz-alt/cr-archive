<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New test/langtools/tools/javac/plugin/AutostartPlugins.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2018, 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /**
 25  *  @test
 26  *  @bug 8234211
 27  *  @summary allow discoverable javac plugins to be invoked by default
 28  *  @library /tools/lib
 29  *  @modules jdk.compiler/com.sun.tools.javac.api
 30  *           jdk.compiler/com.sun.tools.javac.main
 31  *           jdk.jlink
 32  *  @build toolbox.ToolBox toolbox.JavacTask toolbox.JarTask
 33  *  @run main AutostartPlugins
 34  */
 35 
 36 import java.io.IOException;
 37 import java.util.List;
 38 import java.nio.file.Files;
 39 import java.nio.file.Path;
 40 import java.util.spi.ToolProvider;
 41 
 42 import toolbox.ExecTask;
 43 import toolbox.JarTask;
 44 import toolbox.JavacTask;
 45 import toolbox.Task;
 46 import toolbox.TestRunner;
 47 import toolbox.ToolBox;
 48 
 49 public class AutostartPlugins extends TestRunner {
 50     public static void main(String... args) throws Exception {
 51         new AutostartPlugins().run();
 52     }
 53 
 54     AutostartPlugins() {
 55         super(System.out);
 56     }
 57 
 58     ToolBox tb = new ToolBox();
 59 
 60     Path pluginJar;
 61     Path mclasses;
 62 
 63     void run() throws Exception {
 64         Path src = Path.of(&quot;src&quot;);
 65         tb.writeJavaFiles(src,
 66             &quot;package p;\n&quot;
 67             + &quot;import com.sun.source.util.*;\n&quot;
 68             + &quot;public class C implements Plugin {\n&quot;
 69             + &quot;    public String getName() { return \&quot;TestPlugin\&quot;; }\n&quot;
 70             + &quot;    public boolean autoStart() { return true; }\n&quot;
 71             + &quot;    public void init(JavacTask task, String... args) {\n&quot;
 72             + &quot;        System.out.println(\&quot;C.init \&quot; + java.util.Arrays.toString(args));\n&quot;
 73             + &quot;    }\n&quot;
 74             + &quot;}\n&quot;);
 75 
 76         Path msrc = Path.of(&quot;msrc&quot;);
 77         tb.writeJavaFiles(msrc,
 78             &quot;module m {\n&quot;
 79             + &quot;    requires jdk.compiler;\n&quot;
 80             + &quot;    provides com.sun.source.util.Plugin with p.C;\n&quot;
 81             + &quot;}\n&quot;);
 82 
 83         Path classes = Files.createDirectories(Path.of(&quot;classes&quot;));
 84         new JavacTask(tb)
 85             .outdir(classes)
 86             .files(tb.findJavaFiles(src))
 87             .run()
 88             .writeAll();
 89 
 90         tb.writeFile(classes.resolve(&quot;META-INF&quot;).resolve(&quot;services&quot;).resolve(&quot;com.sun.source.util.Plugin&quot;),
 91                 &quot;p.C\n&quot;);
 92 
 93         pluginJar = Path.of(&quot;plugin.jar&quot;);
 94         new JarTask(tb, pluginJar)
 95                 .baseDir(classes)
 96                 .files(&quot;.&quot;)
 97                 .run();
 98 
 99         mclasses = Files.createDirectories(Path.of(&quot;mclasses&quot;));
100         new JavacTask(tb)
101             .outdir(mclasses)
102             .sourcepath(msrc, src)
103             .files(tb.findJavaFiles(msrc))
104             .run()
105             .writeAll();
106 
107         Path hw = Path.of(&quot;hw&quot;);
108         tb.writeJavaFiles(hw,
109                 &quot;public class HelloWorld {\n&quot;
110                 + &quot;    public static void main(String... args) {\n&quot;
111                 + &quot;        System.out.println(\&quot;Hello World!\&quot;);\n&quot;
112                 + &quot;    }\n&quot;
113                 + &quot;}\n&quot;);
114 
115         runTests(m -&gt; new Object[] { Path.of(m.getName()) });
116     }
117 
118     @Test
119     public void testClassPath(Path base) throws Exception {
120         List&lt;String&gt; stdout = new JavacTask(tb)
121                 .classpath(pluginJar)
122                 .outdir(Files.createDirectories(base.resolve(&quot;out&quot;)))
123                 .files(tb.findJavaFiles(Path.of(&quot;hw&quot;)))
124                 .run()
125                 .writeAll()
126                 .getOutputLines(Task.OutputKind.STDOUT);
127         tb.checkEqual(stdout, List.of(&quot;C.init []&quot;));
128     }
129 
130     @Test
131     public void testModulePath(Path base) throws IOException {
132         List&lt;String&gt; stdout = new JavacTask(tb)
133                 .options(&quot;--processor-module-path&quot;, mclasses.toString())
134                 .outdir(Files.createDirectories(base.resolve(&quot;out&quot;)))
135                 .files(tb.findJavaFiles(Path.of(&quot;hw&quot;)))
136                 .run()
137                 .writeAll()
138                 .getOutputLines(Task.OutputKind.STDOUT);
139         tb.checkEqual(stdout, List.of(&quot;C.init []&quot;));
140     }
141 
142     @Test
143     public void testImage(Path base) throws Exception {
144         // does not work on exploded image: cannot jlink an image from exploded modules; skip the test
145         if (Files.exists(Path.of(System.getProperty(&quot;java.home&quot;)).resolve(&quot;modules&quot;))) {
146             out.println(&quot;JDK using exploded modules; test skipped&quot;);
147             return;
148         }
149 
150         Path tmpJDK = base.resolve(&quot;tmpJDK&quot;);
151         ToolProvider jlink = ToolProvider.findFirst(&quot;jlink&quot;)
152                 .orElseThrow(() -&gt; new Exception(&quot;cannot find jlink&quot;));
153         jlink.run(System.out, System.err,
154                 &quot;--module-path&quot;, mclasses.toString(),
155                 &quot;--add-modules&quot;, &quot;jdk.compiler,jdk.zipfs,m&quot;,
156                 &quot;--output&quot;, tmpJDK.toString());
157 
158         String suffix = tb.isWindows() ? &quot;.exe&quot; : &quot;&quot;;
159         List&lt;String&gt; stdout = new ExecTask(tb, tmpJDK.resolve(&quot;bin&quot;).resolve(&quot;javac&quot; + suffix))
160                 .args(&quot;-d&quot;, Files.createDirectories(base.resolve(&quot;out&quot;)).toString(),
161                         Path.of(&quot;hw&quot;).resolve(&quot;HelloWorld.java&quot;).toString())
162                 .run()
163                 .writeAll()
164                 .getOutputLines(Task.OutputKind.STDOUT);
165         tb.checkEqual(stdout, List.of(&quot;C.init []&quot;));
166     }
167 
168     @Test
169     public void testOverride(Path base) throws IOException {
170         List&lt;String&gt; stdout = new JavacTask(tb)
171                 .classpath(pluginJar)
172                 .outdir(Files.createDirectories(base.resolve(&quot;out&quot;)))
173                 .options(&quot;-Xplugin:TestPlugin -args&quot;)
174                 .files(tb.findJavaFiles(Path.of(&quot;hw&quot;)))
175                 .run()
176                 .writeAll()
177                 .getOutputLines(Task.OutputKind.STDOUT);
178         tb.checkEqual(stdout, List.of(&quot;C.init [-args]&quot;));
179     }
180 }
181 
    </pre>
  </body>
</html>