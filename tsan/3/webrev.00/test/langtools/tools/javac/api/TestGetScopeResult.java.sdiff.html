<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/langtools/tools/javac/api/TestGetScopeResult.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="TestGetElementReferenceData.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="file/SJFM_GetFileObjects.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/langtools/tools/javac/api/TestGetScopeResult.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
<span class="line-modified"> 26  * @bug 8205418 8207229 8207230</span>
 27  * @summary Test the outcomes from Trees.getScope
 28  * @modules jdk.compiler/com.sun.tools.javac.api
 29  *          jdk.compiler/com.sun.tools.javac.comp
 30  *          jdk.compiler/com.sun.tools.javac.tree
 31  *          jdk.compiler/com.sun.tools.javac.util
 32  */
 33 
 34 import java.io.IOException;
 35 import java.net.URI;
 36 import java.util.ArrayList;
 37 import java.util.List;
 38 
 39 import javax.lang.model.element.Element;
 40 import javax.tools.JavaCompiler;
 41 import javax.tools.SimpleJavaFileObject;
 42 import javax.tools.StandardJavaFileManager;
 43 import javax.tools.ToolProvider;
 44 

 45 import com.sun.source.tree.CompilationUnitTree;


 46 import com.sun.source.tree.LambdaExpressionTree;


 47 import com.sun.source.tree.Scope;

 48 import com.sun.source.tree.VariableTree;
 49 import com.sun.source.util.JavacTask;


 50 import com.sun.source.util.TreePath;
 51 import com.sun.source.util.TreePathScanner;
 52 import com.sun.source.util.Trees;
 53 
 54 import com.sun.tools.javac.api.JavacTool;
 55 import com.sun.tools.javac.comp.Analyzer;
 56 import com.sun.tools.javac.comp.AttrContext;
 57 import com.sun.tools.javac.comp.Env;
 58 import com.sun.tools.javac.tree.JCTree.JCStatement;
 59 import com.sun.tools.javac.util.Context;
 60 import com.sun.tools.javac.util.Context.Factory;
 61 
 62 import static javax.tools.JavaFileObject.Kind.SOURCE;
 63 
 64 public class TestGetScopeResult {
 65     public static void main(String... args) throws IOException {
 66         new TestGetScopeResult().run();
 67         new TestGetScopeResult().testAnalyzerDisabled();





 68     }
 69 
 70     public void run() throws IOException {
 71         String[] simpleLambda = {
 72             &quot;s:java.lang.String&quot;,
 73             &quot;i:Test.I&quot;,
 74             &quot;super:java.lang.Object&quot;,
 75             &quot;this:Test&quot;
 76         };
 77         doTest(&quot;class Test { void test() { I i = s -&gt; { }; } interface I { public void test(String s); } }&quot;,
 78                simpleLambda);
 79         doTest(&quot;class Test { void test() { I i = s -&gt; { }; } interface I { public int test(String s); } }&quot;,
 80                simpleLambda);
 81         doTest(&quot;class Test { void test() { I i = s -&gt; { }; } interface I { public String test(String s); } }&quot;,
 82                simpleLambda);
 83         doTest(&quot;class Test { void test() { I i; inv(s -&gt; { }); } void inv(I i) { } interface I { public void test(String s); } }&quot;,
 84                simpleLambda);
 85         doTest(&quot;class Test { void test() { I i; inv(s -&gt; { }); } void inv(I i) { } interface I { public int test(String s); } }&quot;,
 86                simpleLambda);
 87         doTest(&quot;class Test { void test() { I i; inv(s -&gt; { }); } void inv(I i) { } interface I { public String test(String s); } }&quot;,
</pre>
<hr />
<pre>
242     }
243 
244     private static final class TestAnalyzer extends Analyzer {
245 
246         public static void preRegister(Context context) {
247             context.put(analyzerKey, (Factory&lt;Analyzer&gt;) ctx -&gt; new TestAnalyzer(ctx));
248         }
249 
250         private boolean analyzeCalled;
251 
252         public TestAnalyzer(Context context) {
253             super(context);
254         }
255 
256         @Override
257         protected void analyze(JCStatement statement, Env&lt;AttrContext&gt; env) {
258             analyzeCalled = true;
259             super.analyze(statement, env);
260         }
261     }
<span class="line-removed">262 }</span>
263 





























































































































































































































</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2018, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
<span class="line-modified"> 26  * @bug 8205418 8207229 8207230 8230847</span>
 27  * @summary Test the outcomes from Trees.getScope
 28  * @modules jdk.compiler/com.sun.tools.javac.api
 29  *          jdk.compiler/com.sun.tools.javac.comp
 30  *          jdk.compiler/com.sun.tools.javac.tree
 31  *          jdk.compiler/com.sun.tools.javac.util
 32  */
 33 
 34 import java.io.IOException;
 35 import java.net.URI;
 36 import java.util.ArrayList;
 37 import java.util.List;
 38 
 39 import javax.lang.model.element.Element;
 40 import javax.tools.JavaCompiler;
 41 import javax.tools.SimpleJavaFileObject;
 42 import javax.tools.StandardJavaFileManager;
 43 import javax.tools.ToolProvider;
 44 
<span class="line-added"> 45 import com.sun.source.tree.BlockTree;</span>
 46 import com.sun.source.tree.CompilationUnitTree;
<span class="line-added"> 47 import com.sun.source.tree.ConditionalExpressionTree;</span>
<span class="line-added"> 48 import com.sun.source.tree.IdentifierTree;</span>
 49 import com.sun.source.tree.LambdaExpressionTree;
<span class="line-added"> 50 import com.sun.source.tree.MethodInvocationTree;</span>
<span class="line-added"> 51 import com.sun.source.tree.MethodTree;</span>
 52 import com.sun.source.tree.Scope;
<span class="line-added"> 53 import com.sun.source.tree.Tree;</span>
 54 import com.sun.source.tree.VariableTree;
 55 import com.sun.source.util.JavacTask;
<span class="line-added"> 56 import com.sun.source.util.TaskEvent;</span>
<span class="line-added"> 57 import com.sun.source.util.TaskListener;</span>
 58 import com.sun.source.util.TreePath;
 59 import com.sun.source.util.TreePathScanner;
 60 import com.sun.source.util.Trees;
 61 
 62 import com.sun.tools.javac.api.JavacTool;
 63 import com.sun.tools.javac.comp.Analyzer;
 64 import com.sun.tools.javac.comp.AttrContext;
 65 import com.sun.tools.javac.comp.Env;
 66 import com.sun.tools.javac.tree.JCTree.JCStatement;
 67 import com.sun.tools.javac.util.Context;
 68 import com.sun.tools.javac.util.Context.Factory;
 69 
 70 import static javax.tools.JavaFileObject.Kind.SOURCE;
 71 
 72 public class TestGetScopeResult {
 73     public static void main(String... args) throws IOException {
 74         new TestGetScopeResult().run();
 75         new TestGetScopeResult().testAnalyzerDisabled();
<span class="line-added"> 76         new TestGetScopeResult().testVariablesInSwitch();</span>
<span class="line-added"> 77         new TestGetScopeResult().testMemberRefs();</span>
<span class="line-added"> 78         new TestGetScopeResult().testAnnotations();</span>
<span class="line-added"> 79         new TestGetScopeResult().testAnnotationsLazy();</span>
<span class="line-added"> 80         new TestGetScopeResult().testCircular();</span>
 81     }
 82 
 83     public void run() throws IOException {
 84         String[] simpleLambda = {
 85             &quot;s:java.lang.String&quot;,
 86             &quot;i:Test.I&quot;,
 87             &quot;super:java.lang.Object&quot;,
 88             &quot;this:Test&quot;
 89         };
 90         doTest(&quot;class Test { void test() { I i = s -&gt; { }; } interface I { public void test(String s); } }&quot;,
 91                simpleLambda);
 92         doTest(&quot;class Test { void test() { I i = s -&gt; { }; } interface I { public int test(String s); } }&quot;,
 93                simpleLambda);
 94         doTest(&quot;class Test { void test() { I i = s -&gt; { }; } interface I { public String test(String s); } }&quot;,
 95                simpleLambda);
 96         doTest(&quot;class Test { void test() { I i; inv(s -&gt; { }); } void inv(I i) { } interface I { public void test(String s); } }&quot;,
 97                simpleLambda);
 98         doTest(&quot;class Test { void test() { I i; inv(s -&gt; { }); } void inv(I i) { } interface I { public int test(String s); } }&quot;,
 99                simpleLambda);
100         doTest(&quot;class Test { void test() { I i; inv(s -&gt; { }); } void inv(I i) { } interface I { public String test(String s); } }&quot;,
</pre>
<hr />
<pre>
255     }
256 
257     private static final class TestAnalyzer extends Analyzer {
258 
259         public static void preRegister(Context context) {
260             context.put(analyzerKey, (Factory&lt;Analyzer&gt;) ctx -&gt; new TestAnalyzer(ctx));
261         }
262 
263         private boolean analyzeCalled;
264 
265         public TestAnalyzer(Context context) {
266             super(context);
267         }
268 
269         @Override
270         protected void analyze(JCStatement statement, Env&lt;AttrContext&gt; env) {
271             analyzeCalled = true;
272             super.analyze(statement, env);
273         }
274     }

275 
<span class="line-added">276     void testVariablesInSwitch() throws IOException {</span>
<span class="line-added">277         JavacTool c = JavacTool.create();</span>
<span class="line-added">278         try (StandardJavaFileManager fm = c.getStandardFileManager(null, null, null)) {</span>
<span class="line-added">279             class MyFileObject extends SimpleJavaFileObject {</span>
<span class="line-added">280                 MyFileObject() {</span>
<span class="line-added">281                     super(URI.create(&quot;myfo:///Test.java&quot;), SOURCE);</span>
<span class="line-added">282                 }</span>
<span class="line-added">283                 @Override</span>
<span class="line-added">284                 public String getCharContent(boolean ignoreEncodingErrors) {</span>
<span class="line-added">285                     return &quot;class Test {&quot; +</span>
<span class="line-added">286                            &quot;    void test() {\n&quot; +</span>
<span class="line-added">287                            &quot;        E e = E.A;\n&quot; +</span>
<span class="line-added">288                            &quot;        Object o = E.A;\n&quot; +</span>
<span class="line-added">289                            &quot;        switch (e) {\n&quot; +</span>
<span class="line-added">290                            &quot;            case A:\n&quot; +</span>
<span class="line-added">291                            &quot;                return;\n&quot; +</span>
<span class="line-added">292                            &quot;            case B:\n&quot; +</span>
<span class="line-added">293                            &quot;                test();\n&quot; +</span>
<span class="line-added">294                            &quot;                E ee = null;\n&quot; +</span>
<span class="line-added">295                            &quot;                break;\n&quot; +</span>
<span class="line-added">296                            &quot;        }\n&quot; +</span>
<span class="line-added">297                            &quot;    }\n&quot; +</span>
<span class="line-added">298                            &quot;    enum E {A, B}\n&quot; +</span>
<span class="line-added">299                            &quot;}&quot;;</span>
<span class="line-added">300                 }</span>
<span class="line-added">301             }</span>
<span class="line-added">302             Context ctx = new Context();</span>
<span class="line-added">303             TestAnalyzer.preRegister(ctx);</span>
<span class="line-added">304             JavacTask t = (JavacTask) c.getTask(null, fm, null, null, null,</span>
<span class="line-added">305                                                 List.of(new MyFileObject()), ctx);</span>
<span class="line-added">306             CompilationUnitTree cut = t.parse().iterator().next();</span>
<span class="line-added">307             t.analyze();</span>
<span class="line-added">308 </span>
<span class="line-added">309             new TreePathScanner&lt;Void, Void&gt;() {</span>
<span class="line-added">310                 @Override</span>
<span class="line-added">311                 public Void visitMethodInvocation(MethodInvocationTree node, Void p) {</span>
<span class="line-added">312                     Trees.instance(t).getScope(getCurrentPath());</span>
<span class="line-added">313                     return super.visitMethodInvocation(node, p);</span>
<span class="line-added">314                 }</span>
<span class="line-added">315             }.scan(cut, null);</span>
<span class="line-added">316         }</span>
<span class="line-added">317     }</span>
<span class="line-added">318 </span>
<span class="line-added">319     void testMemberRefs() throws IOException {</span>
<span class="line-added">320         JavacTool c = JavacTool.create();</span>
<span class="line-added">321         try (StandardJavaFileManager fm = c.getStandardFileManager(null, null, null)) {</span>
<span class="line-added">322             class MyFileObject extends SimpleJavaFileObject {</span>
<span class="line-added">323                 MyFileObject() {</span>
<span class="line-added">324                     super(URI.create(&quot;myfo:///Test.java&quot;), SOURCE);</span>
<span class="line-added">325                 }</span>
<span class="line-added">326                 @Override</span>
<span class="line-added">327                 public String getCharContent(boolean ignoreEncodingErrors) {</span>
<span class="line-added">328                     return &quot;class Test {&quot; +</span>
<span class="line-added">329                            &quot;    void test() {\n&quot; +</span>
<span class="line-added">330                            &quot;        Test t = this;\n&quot; +</span>
<span class="line-added">331                            &quot;        Runnable r1 = t::test;\n&quot; +</span>
<span class="line-added">332                            &quot;        Runnable r2 = true ? t::test : t::test;\n&quot; +</span>
<span class="line-added">333                            &quot;        c(t::test);\n&quot; +</span>
<span class="line-added">334                            &quot;        c(true ? t::test : t::test);\n&quot; +</span>
<span class="line-added">335                            &quot;    }\n&quot; +</span>
<span class="line-added">336                            &quot;    void c(Runnable r) {}\n&quot; +</span>
<span class="line-added">337                            &quot;}&quot;;</span>
<span class="line-added">338                 }</span>
<span class="line-added">339             }</span>
<span class="line-added">340             Context ctx = new Context();</span>
<span class="line-added">341             TestAnalyzer.preRegister(ctx);</span>
<span class="line-added">342             JavacTask t = (JavacTask) c.getTask(null, fm, null, null, null,</span>
<span class="line-added">343                                                 List.of(new MyFileObject()), ctx);</span>
<span class="line-added">344             CompilationUnitTree cut = t.parse().iterator().next();</span>
<span class="line-added">345             t.analyze();</span>
<span class="line-added">346 </span>
<span class="line-added">347             new TreePathScanner&lt;Void, Void&gt;() {</span>
<span class="line-added">348                 @Override</span>
<span class="line-added">349                 public Void visitConditionalExpression(ConditionalExpressionTree node, Void p) {</span>
<span class="line-added">350                     Trees.instance(t).getScope(new TreePath(getCurrentPath(), node.getCondition()));</span>
<span class="line-added">351                     return super.visitConditionalExpression(node, p);</span>
<span class="line-added">352                 }</span>
<span class="line-added">353 </span>
<span class="line-added">354                 @Override</span>
<span class="line-added">355                 public Void visitBlock(BlockTree node, Void p) {</span>
<span class="line-added">356                     Trees.instance(t).getScope(getCurrentPath());</span>
<span class="line-added">357                     return super.visitBlock(node, p);</span>
<span class="line-added">358                 }</span>
<span class="line-added">359             }.scan(cut, null);</span>
<span class="line-added">360         }</span>
<span class="line-added">361     }</span>
<span class="line-added">362 </span>
<span class="line-added">363     void testAnnotations() throws IOException {</span>
<span class="line-added">364         JavacTool c = JavacTool.create();</span>
<span class="line-added">365         try (StandardJavaFileManager fm = c.getStandardFileManager(null, null, null)) {</span>
<span class="line-added">366             class MyFileObject extends SimpleJavaFileObject {</span>
<span class="line-added">367                 MyFileObject() {</span>
<span class="line-added">368                     super(URI.create(&quot;myfo:///Test.java&quot;), SOURCE);</span>
<span class="line-added">369                 }</span>
<span class="line-added">370                 @Override</span>
<span class="line-added">371                 public String getCharContent(boolean ignoreEncodingErrors) {</span>
<span class="line-added">372                     return &quot;class Test {&quot; +</span>
<span class="line-added">373                            &quot;    void test() {\n&quot; +</span>
<span class="line-added">374                            &quot;        new Object() {\n&quot; +</span>
<span class="line-added">375                            &quot;            @A\n&quot; +</span>
<span class="line-added">376                            &quot;            public String t() { return null; }\n&quot; +</span>
<span class="line-added">377                            &quot;        };\n&quot; +</span>
<span class="line-added">378                            &quot;    }\n&quot; +</span>
<span class="line-added">379                            &quot;    @interface A {}\n&quot; +</span>
<span class="line-added">380                            &quot;}&quot;;</span>
<span class="line-added">381                 }</span>
<span class="line-added">382             }</span>
<span class="line-added">383             Context ctx = new Context();</span>
<span class="line-added">384             TestAnalyzer.preRegister(ctx);</span>
<span class="line-added">385             JavacTask t = (JavacTask) c.getTask(null, fm, null, null, null,</span>
<span class="line-added">386                                                 List.of(new MyFileObject()), ctx);</span>
<span class="line-added">387             CompilationUnitTree cut = t.parse().iterator().next();</span>
<span class="line-added">388             t.analyze();</span>
<span class="line-added">389 </span>
<span class="line-added">390             new TreePathScanner&lt;Void, Void&gt;() {</span>
<span class="line-added">391                 @Override</span>
<span class="line-added">392                 public Void visitIdentifier(IdentifierTree node, Void p) {</span>
<span class="line-added">393                     if (node.getName().contentEquals(&quot;A&quot;)) {</span>
<span class="line-added">394                         Trees.instance(t).getScope(getCurrentPath());</span>
<span class="line-added">395                     }</span>
<span class="line-added">396                     return super.visitIdentifier(node, p);</span>
<span class="line-added">397                 }</span>
<span class="line-added">398 </span>
<span class="line-added">399                 @Override</span>
<span class="line-added">400                 public Void visitMethod(MethodTree node, Void p) {</span>
<span class="line-added">401                     super.visitMethod(node, p);</span>
<span class="line-added">402                     if (node.getReturnType() != null) {</span>
<span class="line-added">403                         Trees.instance(t).getScope(new TreePath(getCurrentPath(), node.getReturnType()));</span>
<span class="line-added">404                     }</span>
<span class="line-added">405                     return null;</span>
<span class="line-added">406                 }</span>
<span class="line-added">407             }.scan(cut, null);</span>
<span class="line-added">408         }</span>
<span class="line-added">409     }</span>
<span class="line-added">410 </span>
<span class="line-added">411     void testAnnotationsLazy() throws IOException {</span>
<span class="line-added">412         JavacTool c = JavacTool.create();</span>
<span class="line-added">413         try (StandardJavaFileManager fm = c.getStandardFileManager(null, null, null)) {</span>
<span class="line-added">414             class MyFileObject extends SimpleJavaFileObject {</span>
<span class="line-added">415                 MyFileObject() {</span>
<span class="line-added">416                     super(URI.create(&quot;myfo:///Test.java&quot;), SOURCE);</span>
<span class="line-added">417                 }</span>
<span class="line-added">418                 @Override</span>
<span class="line-added">419                 public String getCharContent(boolean ignoreEncodingErrors) {</span>
<span class="line-added">420                     return &quot;import java.lang.annotation.*;\n&quot; +</span>
<span class="line-added">421                            &quot;\n&quot; +</span>
<span class="line-added">422                            &quot;class ClassA {\n&quot; +</span>
<span class="line-added">423                            &quot;    Object o = ClassB.lcv;\n&quot; +</span>
<span class="line-added">424                            &quot;}\n&quot; +</span>
<span class="line-added">425                            &quot;\n&quot; +</span>
<span class="line-added">426                            &quot;class ClassB {\n&quot; +</span>
<span class="line-added">427                            &quot;    static final String[] lcv = new @TA String[0];\n&quot; +</span>
<span class="line-added">428                            &quot;}\n&quot; +</span>
<span class="line-added">429                            &quot;\n&quot; +</span>
<span class="line-added">430                            &quot;class ClassC {\n&quot; +</span>
<span class="line-added">431                            &quot;    static final Object o = (@TA Object) null;\n&quot; +</span>
<span class="line-added">432                            &quot;}\n&quot; +</span>
<span class="line-added">433                            &quot;\n&quot; +</span>
<span class="line-added">434                            &quot;@Target({ElementType.TYPE_USE, ElementType.TYPE_PARAMETER})\n&quot; +</span>
<span class="line-added">435                            &quot;@interface TA {}\n&quot;;</span>
<span class="line-added">436                 }</span>
<span class="line-added">437             }</span>
<span class="line-added">438             Context ctx = new Context();</span>
<span class="line-added">439             TestAnalyzer.preRegister(ctx);</span>
<span class="line-added">440             JavacTask t = (JavacTask) c.getTask(null, fm, null, null, null,</span>
<span class="line-added">441                                                 List.of(new MyFileObject()), ctx);</span>
<span class="line-added">442             t.addTaskListener(new TaskListener() {</span>
<span class="line-added">443                 @Override</span>
<span class="line-added">444                 public void finished(TaskEvent e) {</span>
<span class="line-added">445                     if (e.getKind() == TaskEvent.Kind.ANALYZE) {</span>
<span class="line-added">446                         new TreePathScanner&lt;Void, Void&gt;() {</span>
<span class="line-added">447                             @Override</span>
<span class="line-added">448                             public Void scan(Tree tree, Void p) {</span>
<span class="line-added">449                                 if (tree != null) {</span>
<span class="line-added">450                                     Trees.instance(t).getScope(new TreePath(getCurrentPath(), tree));</span>
<span class="line-added">451                                 }</span>
<span class="line-added">452                                 return super.scan(tree, p);</span>
<span class="line-added">453                             }</span>
<span class="line-added">454                         }.scan(Trees.instance(t).getPath(e.getTypeElement()), null);</span>
<span class="line-added">455                     }</span>
<span class="line-added">456                 }</span>
<span class="line-added">457             });</span>
<span class="line-added">458 </span>
<span class="line-added">459             t.call();</span>
<span class="line-added">460         }</span>
<span class="line-added">461     }</span>
<span class="line-added">462 </span>
<span class="line-added">463     void testCircular() throws IOException {</span>
<span class="line-added">464         JavacTool c = JavacTool.create();</span>
<span class="line-added">465         try (StandardJavaFileManager fm = c.getStandardFileManager(null, null, null)) {</span>
<span class="line-added">466             class MyFileObject extends SimpleJavaFileObject {</span>
<span class="line-added">467                 MyFileObject() {</span>
<span class="line-added">468                     super(URI.create(&quot;myfo:///Test.java&quot;), SOURCE);</span>
<span class="line-added">469                 }</span>
<span class="line-added">470                 @Override</span>
<span class="line-added">471                 public String getCharContent(boolean ignoreEncodingErrors) {</span>
<span class="line-added">472                     return &quot;class Test extends Test {&quot; +</span>
<span class="line-added">473                            &quot;    {\n&quot; +</span>
<span class="line-added">474                            &quot;        int i;\n&quot; +</span>
<span class="line-added">475                            &quot;    }\n&quot; +</span>
<span class="line-added">476                            &quot;}&quot;;</span>
<span class="line-added">477                 }</span>
<span class="line-added">478             }</span>
<span class="line-added">479             Context ctx = new Context();</span>
<span class="line-added">480             TestAnalyzer.preRegister(ctx);</span>
<span class="line-added">481             JavacTask t = (JavacTask) c.getTask(null, fm, null, null, null,</span>
<span class="line-added">482                                                 List.of(new MyFileObject()), ctx);</span>
<span class="line-added">483             CompilationUnitTree cut = t.parse().iterator().next();</span>
<span class="line-added">484             t.analyze();</span>
<span class="line-added">485 </span>
<span class="line-added">486             new TreePathScanner&lt;Void, Void&gt;() {</span>
<span class="line-added">487                 @Override</span>
<span class="line-added">488                 public Void visitBlock(BlockTree node, Void p) {</span>
<span class="line-added">489                     Trees.instance(t).getScope(getCurrentPath());</span>
<span class="line-added">490                     return super.visitBlock(node, p);</span>
<span class="line-added">491                 }</span>
<span class="line-added">492             }.scan(cut, null);</span>
<span class="line-added">493         }</span>
<span class="line-added">494     }</span>
<span class="line-added">495 </span>
<span class="line-added">496 }</span>
</pre>
</td>
</tr>
</table>
<center><a href="TestGetElementReferenceData.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="file/SJFM_GetFileObjects.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>