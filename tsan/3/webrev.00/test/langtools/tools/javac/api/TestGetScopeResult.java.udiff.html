<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/langtools/tools/javac/api/TestGetScopeResult.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="TestGetElementReferenceData.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="file/SJFM_GetFileObjects.java.udiff.html" target="_top">next &gt;</a></center>    <h2>test/langtools/tools/javac/api/TestGetScopeResult.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2018, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -21,11 +21,11 @@</span>
   * questions.
   */
  
  /*
   * @test
<span class="udiff-line-modified-removed">-  * @bug 8205418 8207229 8207230</span>
<span class="udiff-line-modified-added">+  * @bug 8205418 8207229 8207230 8230847</span>
   * @summary Test the outcomes from Trees.getScope
   * @modules jdk.compiler/com.sun.tools.javac.api
   *          jdk.compiler/com.sun.tools.javac.comp
   *          jdk.compiler/com.sun.tools.javac.tree
   *          jdk.compiler/com.sun.tools.javac.util
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -40,15 +40,23 @@</span>
  import javax.tools.JavaCompiler;
  import javax.tools.SimpleJavaFileObject;
  import javax.tools.StandardJavaFileManager;
  import javax.tools.ToolProvider;
  
<span class="udiff-line-added">+ import com.sun.source.tree.BlockTree;</span>
  import com.sun.source.tree.CompilationUnitTree;
<span class="udiff-line-added">+ import com.sun.source.tree.ConditionalExpressionTree;</span>
<span class="udiff-line-added">+ import com.sun.source.tree.IdentifierTree;</span>
  import com.sun.source.tree.LambdaExpressionTree;
<span class="udiff-line-added">+ import com.sun.source.tree.MethodInvocationTree;</span>
<span class="udiff-line-added">+ import com.sun.source.tree.MethodTree;</span>
  import com.sun.source.tree.Scope;
<span class="udiff-line-added">+ import com.sun.source.tree.Tree;</span>
  import com.sun.source.tree.VariableTree;
  import com.sun.source.util.JavacTask;
<span class="udiff-line-added">+ import com.sun.source.util.TaskEvent;</span>
<span class="udiff-line-added">+ import com.sun.source.util.TaskListener;</span>
  import com.sun.source.util.TreePath;
  import com.sun.source.util.TreePathScanner;
  import com.sun.source.util.Trees;
  
  import com.sun.tools.javac.api.JavacTool;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -63,10 +71,15 @@</span>
  
  public class TestGetScopeResult {
      public static void main(String... args) throws IOException {
          new TestGetScopeResult().run();
          new TestGetScopeResult().testAnalyzerDisabled();
<span class="udiff-line-added">+         new TestGetScopeResult().testVariablesInSwitch();</span>
<span class="udiff-line-added">+         new TestGetScopeResult().testMemberRefs();</span>
<span class="udiff-line-added">+         new TestGetScopeResult().testAnnotations();</span>
<span class="udiff-line-added">+         new TestGetScopeResult().testAnnotationsLazy();</span>
<span class="udiff-line-added">+         new TestGetScopeResult().testCircular();</span>
      }
  
      public void run() throws IOException {
          String[] simpleLambda = {
              &quot;s:java.lang.String&quot;,
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -257,7 +270,227 @@</span>
          protected void analyze(JCStatement statement, Env&lt;AttrContext&gt; env) {
              analyzeCalled = true;
              super.analyze(statement, env);
          }
      }
<span class="udiff-line-removed">- }</span>
  
<span class="udiff-line-added">+     void testVariablesInSwitch() throws IOException {</span>
<span class="udiff-line-added">+         JavacTool c = JavacTool.create();</span>
<span class="udiff-line-added">+         try (StandardJavaFileManager fm = c.getStandardFileManager(null, null, null)) {</span>
<span class="udiff-line-added">+             class MyFileObject extends SimpleJavaFileObject {</span>
<span class="udiff-line-added">+                 MyFileObject() {</span>
<span class="udiff-line-added">+                     super(URI.create(&quot;myfo:///Test.java&quot;), SOURCE);</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+                 @Override</span>
<span class="udiff-line-added">+                 public String getCharContent(boolean ignoreEncodingErrors) {</span>
<span class="udiff-line-added">+                     return &quot;class Test {&quot; +</span>
<span class="udiff-line-added">+                            &quot;    void test() {\n&quot; +</span>
<span class="udiff-line-added">+                            &quot;        E e = E.A;\n&quot; +</span>
<span class="udiff-line-added">+                            &quot;        Object o = E.A;\n&quot; +</span>
<span class="udiff-line-added">+                            &quot;        switch (e) {\n&quot; +</span>
<span class="udiff-line-added">+                            &quot;            case A:\n&quot; +</span>
<span class="udiff-line-added">+                            &quot;                return;\n&quot; +</span>
<span class="udiff-line-added">+                            &quot;            case B:\n&quot; +</span>
<span class="udiff-line-added">+                            &quot;                test();\n&quot; +</span>
<span class="udiff-line-added">+                            &quot;                E ee = null;\n&quot; +</span>
<span class="udiff-line-added">+                            &quot;                break;\n&quot; +</span>
<span class="udiff-line-added">+                            &quot;        }\n&quot; +</span>
<span class="udiff-line-added">+                            &quot;    }\n&quot; +</span>
<span class="udiff-line-added">+                            &quot;    enum E {A, B}\n&quot; +</span>
<span class="udiff-line-added">+                            &quot;}&quot;;</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             Context ctx = new Context();</span>
<span class="udiff-line-added">+             TestAnalyzer.preRegister(ctx);</span>
<span class="udiff-line-added">+             JavacTask t = (JavacTask) c.getTask(null, fm, null, null, null,</span>
<span class="udiff-line-added">+                                                 List.of(new MyFileObject()), ctx);</span>
<span class="udiff-line-added">+             CompilationUnitTree cut = t.parse().iterator().next();</span>
<span class="udiff-line-added">+             t.analyze();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             new TreePathScanner&lt;Void, Void&gt;() {</span>
<span class="udiff-line-added">+                 @Override</span>
<span class="udiff-line-added">+                 public Void visitMethodInvocation(MethodInvocationTree node, Void p) {</span>
<span class="udiff-line-added">+                     Trees.instance(t).getScope(getCurrentPath());</span>
<span class="udiff-line-added">+                     return super.visitMethodInvocation(node, p);</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }.scan(cut, null);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     void testMemberRefs() throws IOException {</span>
<span class="udiff-line-added">+         JavacTool c = JavacTool.create();</span>
<span class="udiff-line-added">+         try (StandardJavaFileManager fm = c.getStandardFileManager(null, null, null)) {</span>
<span class="udiff-line-added">+             class MyFileObject extends SimpleJavaFileObject {</span>
<span class="udiff-line-added">+                 MyFileObject() {</span>
<span class="udiff-line-added">+                     super(URI.create(&quot;myfo:///Test.java&quot;), SOURCE);</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+                 @Override</span>
<span class="udiff-line-added">+                 public String getCharContent(boolean ignoreEncodingErrors) {</span>
<span class="udiff-line-added">+                     return &quot;class Test {&quot; +</span>
<span class="udiff-line-added">+                            &quot;    void test() {\n&quot; +</span>
<span class="udiff-line-added">+                            &quot;        Test t = this;\n&quot; +</span>
<span class="udiff-line-added">+                            &quot;        Runnable r1 = t::test;\n&quot; +</span>
<span class="udiff-line-added">+                            &quot;        Runnable r2 = true ? t::test : t::test;\n&quot; +</span>
<span class="udiff-line-added">+                            &quot;        c(t::test);\n&quot; +</span>
<span class="udiff-line-added">+                            &quot;        c(true ? t::test : t::test);\n&quot; +</span>
<span class="udiff-line-added">+                            &quot;    }\n&quot; +</span>
<span class="udiff-line-added">+                            &quot;    void c(Runnable r) {}\n&quot; +</span>
<span class="udiff-line-added">+                            &quot;}&quot;;</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             Context ctx = new Context();</span>
<span class="udiff-line-added">+             TestAnalyzer.preRegister(ctx);</span>
<span class="udiff-line-added">+             JavacTask t = (JavacTask) c.getTask(null, fm, null, null, null,</span>
<span class="udiff-line-added">+                                                 List.of(new MyFileObject()), ctx);</span>
<span class="udiff-line-added">+             CompilationUnitTree cut = t.parse().iterator().next();</span>
<span class="udiff-line-added">+             t.analyze();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             new TreePathScanner&lt;Void, Void&gt;() {</span>
<span class="udiff-line-added">+                 @Override</span>
<span class="udiff-line-added">+                 public Void visitConditionalExpression(ConditionalExpressionTree node, Void p) {</span>
<span class="udiff-line-added">+                     Trees.instance(t).getScope(new TreePath(getCurrentPath(), node.getCondition()));</span>
<span class="udiff-line-added">+                     return super.visitConditionalExpression(node, p);</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+                 @Override</span>
<span class="udiff-line-added">+                 public Void visitBlock(BlockTree node, Void p) {</span>
<span class="udiff-line-added">+                     Trees.instance(t).getScope(getCurrentPath());</span>
<span class="udiff-line-added">+                     return super.visitBlock(node, p);</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }.scan(cut, null);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     void testAnnotations() throws IOException {</span>
<span class="udiff-line-added">+         JavacTool c = JavacTool.create();</span>
<span class="udiff-line-added">+         try (StandardJavaFileManager fm = c.getStandardFileManager(null, null, null)) {</span>
<span class="udiff-line-added">+             class MyFileObject extends SimpleJavaFileObject {</span>
<span class="udiff-line-added">+                 MyFileObject() {</span>
<span class="udiff-line-added">+                     super(URI.create(&quot;myfo:///Test.java&quot;), SOURCE);</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+                 @Override</span>
<span class="udiff-line-added">+                 public String getCharContent(boolean ignoreEncodingErrors) {</span>
<span class="udiff-line-added">+                     return &quot;class Test {&quot; +</span>
<span class="udiff-line-added">+                            &quot;    void test() {\n&quot; +</span>
<span class="udiff-line-added">+                            &quot;        new Object() {\n&quot; +</span>
<span class="udiff-line-added">+                            &quot;            @A\n&quot; +</span>
<span class="udiff-line-added">+                            &quot;            public String t() { return null; }\n&quot; +</span>
<span class="udiff-line-added">+                            &quot;        };\n&quot; +</span>
<span class="udiff-line-added">+                            &quot;    }\n&quot; +</span>
<span class="udiff-line-added">+                            &quot;    @interface A {}\n&quot; +</span>
<span class="udiff-line-added">+                            &quot;}&quot;;</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             Context ctx = new Context();</span>
<span class="udiff-line-added">+             TestAnalyzer.preRegister(ctx);</span>
<span class="udiff-line-added">+             JavacTask t = (JavacTask) c.getTask(null, fm, null, null, null,</span>
<span class="udiff-line-added">+                                                 List.of(new MyFileObject()), ctx);</span>
<span class="udiff-line-added">+             CompilationUnitTree cut = t.parse().iterator().next();</span>
<span class="udiff-line-added">+             t.analyze();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             new TreePathScanner&lt;Void, Void&gt;() {</span>
<span class="udiff-line-added">+                 @Override</span>
<span class="udiff-line-added">+                 public Void visitIdentifier(IdentifierTree node, Void p) {</span>
<span class="udiff-line-added">+                     if (node.getName().contentEquals(&quot;A&quot;)) {</span>
<span class="udiff-line-added">+                         Trees.instance(t).getScope(getCurrentPath());</span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+                     return super.visitIdentifier(node, p);</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+                 @Override</span>
<span class="udiff-line-added">+                 public Void visitMethod(MethodTree node, Void p) {</span>
<span class="udiff-line-added">+                     super.visitMethod(node, p);</span>
<span class="udiff-line-added">+                     if (node.getReturnType() != null) {</span>
<span class="udiff-line-added">+                         Trees.instance(t).getScope(new TreePath(getCurrentPath(), node.getReturnType()));</span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+                     return null;</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }.scan(cut, null);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     void testAnnotationsLazy() throws IOException {</span>
<span class="udiff-line-added">+         JavacTool c = JavacTool.create();</span>
<span class="udiff-line-added">+         try (StandardJavaFileManager fm = c.getStandardFileManager(null, null, null)) {</span>
<span class="udiff-line-added">+             class MyFileObject extends SimpleJavaFileObject {</span>
<span class="udiff-line-added">+                 MyFileObject() {</span>
<span class="udiff-line-added">+                     super(URI.create(&quot;myfo:///Test.java&quot;), SOURCE);</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+                 @Override</span>
<span class="udiff-line-added">+                 public String getCharContent(boolean ignoreEncodingErrors) {</span>
<span class="udiff-line-added">+                     return &quot;import java.lang.annotation.*;\n&quot; +</span>
<span class="udiff-line-added">+                            &quot;\n&quot; +</span>
<span class="udiff-line-added">+                            &quot;class ClassA {\n&quot; +</span>
<span class="udiff-line-added">+                            &quot;    Object o = ClassB.lcv;\n&quot; +</span>
<span class="udiff-line-added">+                            &quot;}\n&quot; +</span>
<span class="udiff-line-added">+                            &quot;\n&quot; +</span>
<span class="udiff-line-added">+                            &quot;class ClassB {\n&quot; +</span>
<span class="udiff-line-added">+                            &quot;    static final String[] lcv = new @TA String[0];\n&quot; +</span>
<span class="udiff-line-added">+                            &quot;}\n&quot; +</span>
<span class="udiff-line-added">+                            &quot;\n&quot; +</span>
<span class="udiff-line-added">+                            &quot;class ClassC {\n&quot; +</span>
<span class="udiff-line-added">+                            &quot;    static final Object o = (@TA Object) null;\n&quot; +</span>
<span class="udiff-line-added">+                            &quot;}\n&quot; +</span>
<span class="udiff-line-added">+                            &quot;\n&quot; +</span>
<span class="udiff-line-added">+                            &quot;@Target({ElementType.TYPE_USE, ElementType.TYPE_PARAMETER})\n&quot; +</span>
<span class="udiff-line-added">+                            &quot;@interface TA {}\n&quot;;</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             Context ctx = new Context();</span>
<span class="udiff-line-added">+             TestAnalyzer.preRegister(ctx);</span>
<span class="udiff-line-added">+             JavacTask t = (JavacTask) c.getTask(null, fm, null, null, null,</span>
<span class="udiff-line-added">+                                                 List.of(new MyFileObject()), ctx);</span>
<span class="udiff-line-added">+             t.addTaskListener(new TaskListener() {</span>
<span class="udiff-line-added">+                 @Override</span>
<span class="udiff-line-added">+                 public void finished(TaskEvent e) {</span>
<span class="udiff-line-added">+                     if (e.getKind() == TaskEvent.Kind.ANALYZE) {</span>
<span class="udiff-line-added">+                         new TreePathScanner&lt;Void, Void&gt;() {</span>
<span class="udiff-line-added">+                             @Override</span>
<span class="udiff-line-added">+                             public Void scan(Tree tree, Void p) {</span>
<span class="udiff-line-added">+                                 if (tree != null) {</span>
<span class="udiff-line-added">+                                     Trees.instance(t).getScope(new TreePath(getCurrentPath(), tree));</span>
<span class="udiff-line-added">+                                 }</span>
<span class="udiff-line-added">+                                 return super.scan(tree, p);</span>
<span class="udiff-line-added">+                             }</span>
<span class="udiff-line-added">+                         }.scan(Trees.instance(t).getPath(e.getTypeElement()), null);</span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             });</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             t.call();</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     void testCircular() throws IOException {</span>
<span class="udiff-line-added">+         JavacTool c = JavacTool.create();</span>
<span class="udiff-line-added">+         try (StandardJavaFileManager fm = c.getStandardFileManager(null, null, null)) {</span>
<span class="udiff-line-added">+             class MyFileObject extends SimpleJavaFileObject {</span>
<span class="udiff-line-added">+                 MyFileObject() {</span>
<span class="udiff-line-added">+                     super(URI.create(&quot;myfo:///Test.java&quot;), SOURCE);</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+                 @Override</span>
<span class="udiff-line-added">+                 public String getCharContent(boolean ignoreEncodingErrors) {</span>
<span class="udiff-line-added">+                     return &quot;class Test extends Test {&quot; +</span>
<span class="udiff-line-added">+                            &quot;    {\n&quot; +</span>
<span class="udiff-line-added">+                            &quot;        int i;\n&quot; +</span>
<span class="udiff-line-added">+                            &quot;    }\n&quot; +</span>
<span class="udiff-line-added">+                            &quot;}&quot;;</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             Context ctx = new Context();</span>
<span class="udiff-line-added">+             TestAnalyzer.preRegister(ctx);</span>
<span class="udiff-line-added">+             JavacTask t = (JavacTask) c.getTask(null, fm, null, null, null,</span>
<span class="udiff-line-added">+                                                 List.of(new MyFileObject()), ctx);</span>
<span class="udiff-line-added">+             CompilationUnitTree cut = t.parse().iterator().next();</span>
<span class="udiff-line-added">+             t.analyze();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             new TreePathScanner&lt;Void, Void&gt;() {</span>
<span class="udiff-line-added">+                 @Override</span>
<span class="udiff-line-added">+                 public Void visitBlock(BlockTree node, Void p) {</span>
<span class="udiff-line-added">+                     Trees.instance(t).getScope(getCurrentPath());</span>
<span class="udiff-line-added">+                     return super.visitBlock(node, p);</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }.scan(cut, null);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ }</span>
</pre>
<center><a href="TestGetElementReferenceData.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="file/SJFM_GetFileObjects.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>