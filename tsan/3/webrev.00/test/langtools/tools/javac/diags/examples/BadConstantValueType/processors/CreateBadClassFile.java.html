<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New test/langtools/tools/javac/diags/examples/BadConstantValueType/processors/CreateBadClassFile.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
 1 /*
 2  * Copyright (c) 2013, 2019, Oracle and/or its affiliates. All rights reserved.
 3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 4  *
 5  * This code is free software; you can redistribute it and/or modify it
 6  * under the terms of the GNU General Public License version 2 only, as
 7  * published by the Free Software Foundation.
 8  *
 9  * This code is distributed in the hope that it will be useful, but WITHOUT
10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
12  * version 2 for more details (a copy is included in the LICENSE file that
13  * accompanied this code).
14  *
15  * You should have received a copy of the GNU General Public License version
16  * 2 along with this work; if not, write to the Free Software Foundation,
17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
18  *
19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
20  * or visit www.oracle.com if you need additional information or have any
21  * questions.
22  */
23 
24 import java.io.*;
25 import java.util.*;
26 import javax.annotation.processing.*;
27 import javax.lang.model.*;
28 import javax.lang.model.element.*;
29 import javax.tools.*;
30 
31 import com.sun.tools.classfile.*;
32 import com.sun.tools.classfile.ConstantPool.CONSTANT_Class_info;
33 import com.sun.tools.classfile.ConstantPool.CONSTANT_Utf8_info;
34 import com.sun.tools.classfile.ConstantPool.CPInfo;
35 
36 /* Create an invalid classfile with a static final field of type object with
37  * ConstantValue of type String.
38  */
39 @SupportedAnnotationTypes(&quot;*&quot;)
40 public class CreateBadClassFile extends AbstractProcessor {
41     public boolean process(Set&lt;? extends TypeElement&gt; elems, RoundEnvironment renv) {
42         if (++round == 1) {
43             ConstantPool cp = new ConstantPool(new CPInfo[] {
44                 new CONSTANT_Utf8_info(&quot;&quot;),                     //0
45                 new CONSTANT_Utf8_info(&quot;Test&quot;),                 //1
46                 new CONSTANT_Class_info(null, 1),               //2
47                 new CONSTANT_Utf8_info(&quot;java/lang/Object&quot;),     //3
48                 new CONSTANT_Class_info(null, 3),               //4
49                 new CONSTANT_Utf8_info(&quot;test&quot;),                 //5
50                 new CONSTANT_Utf8_info(&quot;Ljava/lang/Object;&quot;),   //6
51                 new CONSTANT_Utf8_info(&quot;ConstantValue&quot;),        //7
52             });
53             ClassFile cf = new ClassFile(0xCAFEBABE,
54                           0,
55                           51,
56                           cp,
57                           new AccessFlags(AccessFlags.ACC_ABSTRACT |
58                                           AccessFlags.ACC_INTERFACE |
59                                           AccessFlags.ACC_PUBLIC),
60                           2,
61                           4,
62                           new int[0],
63                           new Field[] {
64                               new Field(new AccessFlags(AccessFlags.ACC_PUBLIC |
65                                                         AccessFlags.ACC_STATIC |
66                                                         AccessFlags.ACC_FINAL),
67                                         5,
68                                       new Descriptor(6),
69                                       new Attributes(cp, new Attribute[] {
70                                           new ConstantValue_attribute(7, 6)
71                                       }))
72                           },
73                           new Method[0],
74                           new Attributes(cp, new Attribute[0]));
75             try {
76                 JavaFileObject clazz = processingEnv.getFiler().createClassFile(&quot;Test&quot;);
77                 try (OutputStream out = clazz.openOutputStream()) {
78                     new ClassWriter().write(cf, out);
79                 }
80             } catch (IOException ex) {
81                 ex.printStackTrace();
82             }
83         }
84         return false;
85     }
86 
87     public SourceVersion getSupportedSourceVersion() {
88         return SourceVersion.latest();
89     }
90 
91     int round = 0;
92 }
    </pre>
  </body>
</html>