<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/langtools/tools/javac/varargs/warning/Warn5.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 2010, 2015, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /**
 25  * @test
 26  * @bug     6993978 7097436 8006694 7196160
 27  * @summary Project Coin: Annotation to reduce varargs warnings
 28  *  temporarily workaround combo tests are causing time out in several platforms
 29  * @library /tools/javac/lib
 30  * @modules jdk.compiler/com.sun.tools.javac.api
<a name="1" id="anc1"></a><span class="line-modified"> 31  *          jdk.compiler/com.sun.tools.javac.file</span>



 32  *          jdk.compiler/com.sun.tools.javac.util
 33  * @build combo.ComboTestHelper
 34  * @run main/othervm Warn5
 35  */
 36 
 37 import java.io.IOException;
 38 import java.util.EnumSet;
 39 import javax.tools.Diagnostic;
 40 import javax.tools.Diagnostic.Kind;
 41 import javax.tools.JavaFileObject;
 42 
 43 import combo.ComboInstance;
 44 import combo.ComboParameter;
 45 import combo.ComboTask.Result;
 46 import combo.ComboTestHelper;
 47 
 48 
 49 public class Warn5 extends ComboInstance&lt;Warn5&gt; {
 50 
 51     enum XlintOption {
 52         NONE(&quot;none&quot;),
 53         ALL(&quot;all&quot;);
 54 
 55         String opt;
 56 
 57         XlintOption(String opt) {
 58             this.opt = opt;
 59         }
 60 
 61         String getXlintOption() {
 62             return &quot;-Xlint:&quot; + opt;
 63         }
 64     }
 65 
 66     enum TrustMe implements ComboParameter {
 67         DONT_TRUST(&quot;&quot;),
 68         TRUST(&quot;@java.lang.SafeVarargs&quot;);
 69 
 70         String anno;
 71 
 72         TrustMe(String anno) {
 73             this.anno = anno;
 74         }
 75 
 76         @Override
 77         public String expand(String optParameter) {
 78             return anno;
 79         }
 80     }
 81 
 82     enum SuppressLevel implements ComboParameter {
 83         NONE,
 84         VARARGS;
 85 
 86         @Override
 87         public String expand(String optParameter) {
 88             return this == VARARGS ?
 89                 &quot;@SuppressWarnings(\&quot;varargs\&quot;)&quot; :
 90                 &quot;&quot;;
 91         }
 92     }
 93 
 94     enum ModifierKind implements ComboParameter {
 95         NONE(&quot;&quot;),
 96         FINAL(&quot;final&quot;),
 97         STATIC(&quot;static&quot;),
 98         PRIVATE(&quot;private&quot;);
 99 
100         String mod;
101 
102         ModifierKind(String mod) {
103             this.mod = mod;
104         }
105 
106         @Override
107         public String expand(String optParameter) {
108             return mod;
109         }
110     }
111 
112     enum MethodKind implements ComboParameter {
113         METHOD(&quot;void m&quot;),
114         CONSTRUCTOR(&quot;Test&quot;);
115 
116         String name;
117 
118         MethodKind(String name) {
119             this.name = name;
120         }
121 
122         @Override
123         public String expand(String optParameter) {
124             return name;
125         }
126     }
127 
128     enum SourceLevel {
129         JDK_6(&quot;6&quot;),
130         JDK_7(&quot;7&quot;),
131         JDK_9(&quot;9&quot;);
132 
133         String sourceKey;
134 
135         SourceLevel(String sourceKey) {
136             this.sourceKey = sourceKey;
137         }
138     }
139 
140     enum SignatureKind implements ComboParameter {
141         VARARGS_X(&quot;&lt;X&gt;#{NAME}(X... x)&quot;, false, true),
142         VARARGS_STRING(&quot;#{NAME}(String... x)&quot;, true, true),
143         ARRAY_X(&quot;&lt;X&gt;#{NAME}(X[] x)&quot;, false, false),
144         ARRAY_STRING(&quot;#{NAME}(String[] x)&quot;, true, false);
145 
146         String stub;
147         boolean isReifiableArg;
148         boolean isVarargs;
149 
150         SignatureKind(String stub, boolean isReifiableArg, boolean isVarargs) {
151             this.stub = stub;
152             this.isReifiableArg = isReifiableArg;
153             this.isVarargs = isVarargs;
154         }
155 
156         @Override
157         public String expand(String optParameter) {
158             return stub;
159         }
160     }
161 
162     enum BodyKind implements ComboParameter {
163         ASSIGN(&quot;Object o = x;&quot;, true),
164         CAST(&quot;Object o = (Object)x;&quot;, true),
165         METH(&quot;test(x);&quot;, true),
166         PRINT(&quot;System.out.println(x.toString());&quot;, false),
167         ARRAY_ASSIGN(&quot;Object[] o = x;&quot;, true),
168         ARRAY_CAST(&quot;Object[] o = (Object[])x;&quot;, true),
169         ARRAY_METH(&quot;testArr(x);&quot;, true);
170 
171         String body;
172         boolean hasAliasing;
173 
174         BodyKind(String body, boolean hasAliasing) {
175             this.body = body;
176             this.hasAliasing = hasAliasing;
177         }
178 
179         @Override
180         public String expand(String optParameter) {
181             return body;
182         }
183     }
184 
185     enum WarningKind {
186         UNSAFE_BODY(&quot;compiler.warn.varargs.unsafe.use.varargs.param&quot;),
187         UNSAFE_DECL(&quot;compiler.warn.unchecked.varargs.non.reifiable.type&quot;),
188         MALFORMED_SAFEVARARGS(&quot;compiler.err.varargs.invalid.trustme.anno&quot;),
189         REDUNDANT_SAFEVARARGS(&quot;compiler.warn.varargs.redundant.trustme.anno&quot;);
190 
191         String code;
192 
193         WarningKind(String code) {
194             this.code = code;
195         }
196     }
197 
198     public static void main(String[] args) {
199         new ComboTestHelper&lt;Warn5&gt;()
200                 .withFilter(Warn5::badTestFilter)
201                 .withDimension(&quot;SOURCE&quot;, (x, level) -&gt; x.sourceLevel = level, SourceLevel.values())
202                 .withDimension(&quot;LINT&quot;, (x, lint) -&gt; x.xlint = lint, XlintOption.values())
203                 .withDimension(&quot;TRUSTME&quot;, (x, trustme) -&gt; x.trustMe = trustme, TrustMe.values())
204                 .withDimension(&quot;SUPPRESS&quot;, (x, suppress) -&gt; x.suppressLevel = suppress, SuppressLevel.values())
205                 .withDimension(&quot;MOD&quot;, (x, mod) -&gt; x.modKind = mod, ModifierKind.values())
206                 .withDimension(&quot;NAME&quot;, (x, name) -&gt; x.methKind = name, MethodKind.values())
207                 .withDimension(&quot;SIG&quot;, (x, sig) -&gt; x.sig = sig, SignatureKind.values())
208                 .withDimension(&quot;BODY&quot;, (x, body) -&gt; x.body = body, BodyKind.values())
209                 .run(Warn5::new);
210     }
211 
212     SourceLevel sourceLevel;
213     XlintOption xlint;
214     TrustMe trustMe;
215     SuppressLevel suppressLevel;
216     ModifierKind modKind;
217     MethodKind methKind;
218     SignatureKind sig;
219     BodyKind body;
220 
221     boolean badTestFilter() {
222         return (methKind != MethodKind.CONSTRUCTOR || modKind == ModifierKind.NONE);
223     }
224 
225     String template = &quot;import com.sun.tools.javac.api.*;\n&quot; +
226                       &quot;import java.util.List;\n&quot; +
227                       &quot;class Test {\n&quot; +
228                       &quot;   static void test(Object o) {}\n&quot; +
229                       &quot;   static void testArr(Object[] o) {}\n&quot; +
230                       &quot;   #{TRUSTME} #{SUPPRESS} #{MOD} #{SIG} { #{BODY} }\n&quot; +
231                       &quot;}\n&quot;;
232 
233     @Override
234     public void doWork() throws IOException {
235         newCompilationTask()
236                 .withOption(xlint.getXlintOption())
237                 .withOption(&quot;-source&quot;)
238                 .withOption(sourceLevel.sourceKey)
239                 .withSourceFromTemplate(template)
240                 .analyze(this::check);
241     }
242 
243     void check(Result&lt;?&gt; res) {
244 
245         EnumSet&lt;WarningKind&gt; foundWarnings = EnumSet.noneOf(WarningKind.class);
246         for (Diagnostic.Kind kind : new Kind[] { Kind.ERROR, Kind.MANDATORY_WARNING, Kind.WARNING}) {
247             for (Diagnostic&lt;? extends JavaFileObject&gt; diag : res.diagnosticsForKind(kind)) {
248                 for (WarningKind wk : WarningKind.values()) {
249                     if (wk.code.equals(diag.getCode())) {
250                         foundWarnings.add(wk);
251                     }
252                 }
253             }
254         }
255 
256         EnumSet&lt;WarningKind&gt; expectedWarnings =
257                 EnumSet.noneOf(WarningKind.class);
258 
259         if (sourceLevel.compareTo(SourceLevel.JDK_7) &gt;= 0 &amp;&amp;
260                 trustMe == TrustMe.TRUST &amp;&amp;
261                 suppressLevel != SuppressLevel.VARARGS &amp;&amp;
262                 xlint != XlintOption.NONE &amp;&amp;
263                 sig.isVarargs &amp;&amp;
264                 !sig.isReifiableArg &amp;&amp;
265                 body.hasAliasing &amp;&amp;
266                 (methKind == MethodKind.CONSTRUCTOR ||
267                 (methKind == MethodKind.METHOD &amp;&amp;
268                  modKind == ModifierKind.FINAL || modKind == ModifierKind.STATIC ||
269                  (modKind == ModifierKind.PRIVATE &amp;&amp; sourceLevel.compareTo(SourceLevel.JDK_9) &gt;= 0)))) {
270             expectedWarnings.add(WarningKind.UNSAFE_BODY);
271         }
272 
273         if (sourceLevel.compareTo(SourceLevel.JDK_7) &gt;= 0 &amp;&amp;
274                 trustMe == TrustMe.DONT_TRUST &amp;&amp;
275                 sig.isVarargs &amp;&amp;
276                 !sig.isReifiableArg &amp;&amp;
277                 xlint == XlintOption.ALL) {
278             expectedWarnings.add(WarningKind.UNSAFE_DECL);
279         }
280 
281         if (sourceLevel.compareTo(SourceLevel.JDK_7) &gt;= 0 &amp;&amp;
282                 trustMe == TrustMe.TRUST &amp;&amp;
283                 (!sig.isVarargs ||
284                  ((modKind == ModifierKind.NONE ||
285                  modKind == ModifierKind.PRIVATE &amp;&amp; sourceLevel.compareTo(SourceLevel.JDK_9) &lt; 0 ) &amp;&amp;
286                  methKind == MethodKind.METHOD))) {
287             expectedWarnings.add(WarningKind.MALFORMED_SAFEVARARGS);
288         }
289 
290         if (sourceLevel.compareTo(SourceLevel.JDK_7) &gt;= 0 &amp;&amp;
291                 trustMe == TrustMe.TRUST &amp;&amp;
292                 xlint != XlintOption.NONE &amp;&amp;
293                 suppressLevel != SuppressLevel.VARARGS &amp;&amp;
294                 (modKind == ModifierKind.FINAL || modKind == ModifierKind.STATIC ||
295                  (modKind == ModifierKind.PRIVATE &amp;&amp; sourceLevel.compareTo(SourceLevel.JDK_9) &gt;= 0) ||
296                  methKind == MethodKind.CONSTRUCTOR) &amp;&amp;
297                 sig.isVarargs &amp;&amp;
298                 sig.isReifiableArg) {
299             expectedWarnings.add(WarningKind.REDUNDANT_SAFEVARARGS);
300         }
301 
302         if (!expectedWarnings.containsAll(foundWarnings) ||
303                 !foundWarnings.containsAll(expectedWarnings)) {
304             fail(&quot;invalid diagnostics for source:\n&quot; +
305                     res.compilationInfo() +
306                     &quot;\nOptions: &quot; + xlint.getXlintOption() +
307                     &quot;\nSource Level: &quot; + sourceLevel +
308                     &quot;\nExpected warnings: &quot; + expectedWarnings +
309                     &quot;\nFound warnings: &quot; + foundWarnings);
310         }
311     }
312 }
<a name="2" id="anc2"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="2" type="hidden" />
</body>
</html>