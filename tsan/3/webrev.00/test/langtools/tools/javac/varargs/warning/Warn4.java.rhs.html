<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/langtools/tools/javac/varargs/warning/Warn4.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 2010, 2018, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /**
 25  * @test
 26  * @bug     6945418 6993978 8006694 7196160 8129962
 27  * @summary Project Coin: Simplified Varargs Method Invocation
 28  *  temporarily workaround combo tests are causing time out in several platforms
 29  * @library /tools/javac/lib
 30  * @modules jdk.compiler/com.sun.tools.javac.api
<a name="1" id="anc1"></a><span class="line-modified"> 31  *          jdk.compiler/com.sun.tools.javac.file</span>



 32  *          jdk.compiler/com.sun.tools.javac.util
 33  * @build combo.ComboTestHelper
 34  * @run main Warn4
 35  */
 36 
 37 import java.io.IOException;
 38 import java.util.Set;
 39 import java.util.HashSet;
 40 import javax.tools.Diagnostic;
 41 import javax.tools.Diagnostic.Kind;
 42 import javax.tools.JavaFileObject;
 43 
 44 import combo.ComboInstance;
 45 import combo.ComboParameter;
 46 import combo.ComboTask.Result;
 47 import combo.ComboTestHelper;
 48 
 49 public class Warn4 extends ComboInstance&lt;Warn4&gt; {
 50 
 51     final static Warning[] error = null;
 52     final static Warning[] none = new Warning[] {};
 53     final static Warning[] vararg = new Warning[] { Warning.VARARGS };
 54     final static Warning[] unchecked = new Warning[] { Warning.UNCHECKED };
 55     final static Warning[] both = new Warning[] { Warning.VARARGS, Warning.UNCHECKED };
 56 
 57     enum Warning {
 58         UNCHECKED(&quot;generic.array.creation&quot;),
 59         VARARGS(&quot;varargs.non.reifiable.type&quot;);
 60 
 61         String key;
 62 
 63         Warning(String key) {
 64             this.key = key;
 65         }
 66 
 67         boolean isSuppressed(TrustMe trustMe, SourceLevel source,
 68                 SuppressLevel suppressLevelClient,
 69                 SuppressLevel suppressLevelDecl,
 70                 ModifierKind modKind) {
 71             switch(this) {
 72                 case VARARGS:
 73                     return source.compareTo(SourceLevel.JDK_7) &lt; 0 ||
 74                             suppressLevelDecl == SuppressLevel.UNCHECKED ||
 75                             trustMe == TrustMe.TRUST;
 76                 case UNCHECKED:
 77                     return suppressLevelClient == SuppressLevel.UNCHECKED ||
 78                         (trustMe == TrustMe.TRUST &amp;&amp;
 79                          (((modKind == ModifierKind.FINAL || modKind == ModifierKind.STATIC) &amp;&amp;
 80                            source.compareTo( SourceLevel.JDK_7) &gt;= 0 ) ||
 81                           (modKind == ModifierKind.PRIVATE &amp;&amp; source.compareTo( SourceLevel.JDK_9) &gt;= 0 )));
 82             }
 83 
 84             SuppressLevel supLev = this == VARARGS ?
 85                 suppressLevelDecl :
 86                 suppressLevelClient;
 87             return supLev == SuppressLevel.UNCHECKED ||
 88                     (trustMe == TrustMe.TRUST &amp;&amp; modKind != ModifierKind.NONE);
 89         }
 90     }
 91 
 92     enum SourceLevel {
 93         JDK_7(&quot;7&quot;),
 94         JDK_9(&quot;9&quot;);
 95 
 96         String sourceKey;
 97 
 98         SourceLevel(String sourceKey) {
 99             this.sourceKey = sourceKey;
100         }
101     }
102 
103     enum TrustMe implements ComboParameter {
104         DONT_TRUST(&quot;&quot;),
105         TRUST(&quot;@java.lang.SafeVarargs&quot;);
106 
107         String anno;
108 
109         TrustMe(String anno) {
110             this.anno = anno;
111         }
112 
113         @Override
114         public String expand(String optParameter) {
115             return anno;
116         }
117     }
118 
119     enum ModifierKind implements ComboParameter {
120         NONE(&quot; &quot;),
121         FINAL(&quot;final &quot;),
122         STATIC(&quot;static &quot;),
123         PRIVATE(&quot;private &quot;);
124 
125         String mod;
126 
127         ModifierKind(String mod) {
128             this.mod = mod;
129         }
130 
131         @Override
132         public String expand(String optParameter) {
133             return mod;
134         }
135     }
136 
137     enum SuppressLevel implements ComboParameter {
138         NONE(&quot;&quot;),
139         UNCHECKED(&quot;unchecked&quot;);
140 
141         String lint;
142 
143         SuppressLevel(String lint) {
144             this.lint = lint;
145         }
146 
147         @Override
148         public String expand(String optParameter) {
149             return &quot;@SuppressWarnings(\&quot;&quot; + lint + &quot;\&quot;)&quot;;
150         }
151     }
152 
153     enum Signature implements ComboParameter {
154         UNBOUND(&quot;void #NAME(List&lt;?&gt;#ARITY arg) { #BODY }&quot;,
155             new Warning[][] {none, none, none, none, error}),
156         INVARIANT_TVAR(&quot;&lt;Z&gt; void #NAME(List&lt;Z&gt;#ARITY arg) { #BODY }&quot;,
157             new Warning[][] {both, both, error, both, error}),
158         TVAR(&quot;&lt;Z&gt; void #NAME(Z#ARITY arg) { #BODY }&quot;,
159             new Warning[][] {both, both, both, both, vararg}),
160         INVARIANT(&quot;void #NAME(List&lt;String&gt;#ARITY arg) { #BODY }&quot;,
161             new Warning[][] {error, error, error, both, error}),
162         UNPARAMETERIZED(&quot;void #NAME(String#ARITY arg) { #BODY }&quot;,
163             new Warning[][] {error, error, error, error, none});
164 
165         String template;
166         Warning[][] warnings;
167 
168         Signature(String template, Warning[][] warnings) {
169             this.template = template;
170             this.warnings = warnings;
171         }
172 
173         boolean isApplicableTo(Signature other) {
174             return warnings[other.ordinal()] != null;
175         }
176 
177         boolean giveUnchecked(Signature other) {
178             return warnings[other.ordinal()] == unchecked ||
179                     warnings[other.ordinal()] == both;
180         }
181 
182         boolean giveVarargs(Signature other) {
183             return warnings[other.ordinal()] == vararg ||
184                     warnings[other.ordinal()] == both;
185         }
186 
187         @Override
188         public String expand(String optParameter) {
189             if (optParameter.equals(&quot;CLIENT&quot;)) {
190                 return template.replaceAll(&quot;#ARITY&quot;, &quot;&quot;)
191                         .replaceAll(&quot;#NAME&quot;, &quot;test&quot;)
192                         .replaceAll(&quot;#BODY&quot;, &quot;m(arg)&quot;);
193             } else {
194                 return template.replaceAll(&quot;#ARITY&quot;, &quot;...&quot;)
195                         .replaceAll(&quot;#NAME&quot;, &quot;m&quot;)
196                         .replaceAll(&quot;#BODY&quot;, &quot;&quot;);
197             }
198         }
199     }
200 
201     public static void main(String... args) {
202         new ComboTestHelper&lt;Warn4&gt;()
203                 .withFilter(Warn4::badTestFilter)
204                 .withDimension(&quot;SOURCE&quot;, (x, level) -&gt; x.sourceLevel = level, SourceLevel.values())
205                 .withDimension(&quot;TRUSTME&quot;, (x, trustme) -&gt; x.trustMe = trustme, TrustMe.values())
206                 .withArrayDimension(&quot;SUPPRESS&quot;, (x, suppress, idx) -&gt; x.suppress[idx] = suppress, 2, SuppressLevel.values())
207                 .withDimension(&quot;MOD&quot;, (x, mod) -&gt; x.modKind = mod, ModifierKind.values())
208                 .withArrayDimension(&quot;MTH&quot;, (x, sig, idx) -&gt; x.sigs[idx] = sig, 2, Signature.values())
209                 .run(Warn4::new);
210     }
211 
212     SourceLevel sourceLevel;
213     TrustMe trustMe;
214     SuppressLevel[] suppress = new SuppressLevel[2];
215     ModifierKind modKind;
216     Signature[] sigs = new Signature[2];
217 
218     boolean badTestFilter() {
219         return sigs[0].isApplicableTo(sigs[1]);
220     }
221 
222     final String template = &quot;import java.util.List;\n&quot; +
223                             &quot;class Test {\n&quot; +
224                             &quot;   #{TRUSTME} #{SUPPRESS[0]} #{MOD} #{MTH[0].VARARG}\n&quot; +
225                             &quot;   #{SUPPRESS[1]} #{MTH[1].CLIENT}\n&quot; +
226                             &quot;}&quot;;
227 
228     @Override
229     public void doWork() throws IOException {
230         newCompilationTask()
231                 .withOption(&quot;-Xlint:unchecked&quot;)
232                 .withOption(&quot;-source&quot;)
233                 .withOption(sourceLevel.sourceKey)
234                 .withSourceFromTemplate(template)
235                 .analyze(this::check);
236     }
237 
238     void check(Result&lt;?&gt; res) {
239         boolean[] warnArr = new boolean[] {sigs[0].giveUnchecked(sigs[1]),
240                                sigs[0].giveVarargs(sigs[1])};
241 
242         Set&lt;Warning&gt; warnings = new HashSet&lt;&gt;();
243         for (Diagnostic&lt;? extends JavaFileObject&gt; d : res.diagnosticsForKind(Kind.MANDATORY_WARNING)) {
244             if (d.getCode().contains(Warning.VARARGS.key)) {
245                     warnings.add(Warning.VARARGS);
246             } else if(d.getCode().contains(Warning.UNCHECKED.key)) {
247                 warnings.add(Warning.UNCHECKED);
248             }
249         }
250 
251         boolean badOutput = false;
252         for (Warning wkind : Warning.values()) {
253             boolean isSuppressed = wkind.isSuppressed(trustMe, sourceLevel,
254                     suppress[1], suppress[0], modKind);
255             badOutput |= (warnArr[wkind.ordinal()] &amp;&amp; !isSuppressed) !=
256                     warnings.contains(wkind);
257         }
258         if (badOutput) {
259             fail(&quot;invalid diagnostics for source:\n&quot; +
260                     res.compilationInfo() +
261                     &quot;\nExpected unchecked warning: &quot; + warnArr[0] +
262                     &quot;\nExpected unsafe vararg warning: &quot; + warnArr[1] +
263                     &quot;\nWarnings: &quot; + warnings +
264                     &quot;\nSource level: &quot; + sourceLevel);
265         }
266     }
267 }
<a name="2" id="anc2"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="2" type="hidden" />
</body>
</html>