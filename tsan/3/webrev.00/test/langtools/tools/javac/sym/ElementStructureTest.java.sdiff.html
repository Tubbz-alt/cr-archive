<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/langtools/tools/javac/sym/ElementStructureTest.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="../switchextra/SwitchStatementScopesIsolated.out.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../tree/AbstractTreeScannerTest.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/langtools/tools/javac/sym/ElementStructureTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2015, 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
</pre>
<hr />
<pre>
111  *
112  *     java ElementStructureTest generate-hashes classes-6 6 classes-7 7 classes-8 8
113  *
114  * To inspect differences between the actual and expected output for version N, invoke this class like:
115  *
116  *     java ElementStructureTest generate-output $LANGTOOLS_DIR/make/data/symbols/include.list (&lt;classes-for-N&gt; N &lt;actual-output-file&gt; &lt;expected-output-file&gt;)+
117  *
118  * For example, to get the actual and expected output for 6 in /tmp/actual and /tmp/expected, respectively:
119  *
120  *     java ElementStructureTest generate-output $LANGTOOLS_DIR/make/data/symbols/include.list classes-6 6 /tmp/actual /tmp/expected
121  */
122 public class ElementStructureTest {
123 
124     static final byte[] hash6 = new byte[] {
125         (byte) 0x99, (byte) 0x34, (byte) 0x82, (byte) 0xCF,
126         (byte) 0xE0, (byte) 0x53, (byte) 0xF3, (byte) 0x13,
127         (byte) 0x4E, (byte) 0xCF, (byte) 0x49, (byte) 0x32,
128         (byte) 0xB7, (byte) 0x52, (byte) 0x0F, (byte) 0x68
129     };
130     static final byte[] hash7 = new byte[] {
<span class="line-modified">131         (byte) 0x6B, (byte) 0xA2, (byte) 0xE9, (byte) 0x8E,</span>
<span class="line-modified">132         (byte) 0xE1, (byte) 0x8E, (byte) 0x60, (byte) 0xBE,</span>
<span class="line-modified">133         (byte) 0x54, (byte) 0xC4, (byte) 0x33, (byte) 0x3E,</span>
<span class="line-modified">134         (byte) 0x0C, (byte) 0x2D, (byte) 0x3A, (byte) 0x7C</span>
135     };
136     static final byte[] hash8 = new byte[] {
<span class="line-modified">137         (byte) 0x44, (byte) 0x77, (byte) 0x6E, (byte) 0x52,</span>
<span class="line-modified">138         (byte) 0x2B, (byte) 0x16, (byte) 0xD3, (byte) 0x3C,</span>
<span class="line-modified">139         (byte) 0x78, (byte) 0x75, (byte) 0xF5, (byte) 0x0A,</span>
<span class="line-modified">140         (byte) 0x01, (byte) 0x24, (byte) 0xBD, (byte) 0x2A</span>
141     };
142 
143     final static Map&lt;String, byte[]&gt; version2Hash = new HashMap&lt;&gt;();
144 
145     static {
146         version2Hash.put(&quot;6&quot;, hash6);
147         version2Hash.put(&quot;7&quot;, hash7);
148         version2Hash.put(&quot;8&quot;, hash8);
149     }
150 
151     public static void main(String... args) throws Exception {
152         if (args.length == 0) {
153             new ElementStructureTest().doTest();
154             return ;
155         }
156         switch (args[0]) {
157             case &quot;generate-hashes&quot;:
158                 new ElementStructureTest().generateHashes(args);
159                 break;
160             case &quot;generate-output&quot;:
</pre>
<hr />
<pre>
392                 out.write(e.getSimpleName().toString());
393             } catch (IOException ex) {
394                 ex.printStackTrace();
395             }
396         }
397 
398         boolean acceptAccess(Element e) {
399             return e.getModifiers().contains(Modifier.PUBLIC) || e.getModifiers().contains(Modifier.PROTECTED);
400         }
401 
402         @Override
403         public Void visitExecutable(ExecutableElement e, Void p) {
404             if (!acceptAccess(e))
405                 return null;
406             try {
407                 analyzeElement(e);
408                 out.write(String.valueOf(e.getDefaultValue()));
409                 for (VariableElement param : e.getParameters()) {
410                     visit(param, p);
411                 }
<span class="line-modified">412                 out.write(String.valueOf(e.getReceiverType()));</span>
413                 write(e.getReturnType());
414                 out.write(e.getSimpleName().toString());
415                 writeTypes(e.getThrownTypes());
416                 for (TypeParameterElement param : e.getTypeParameters()) {
417                     visit(param, p);
418                 }
419                 out.write(String.valueOf(e.isDefault()));
420                 out.write(String.valueOf(e.isVarArgs()));
421                 out.write(&quot;\n&quot;);
422             } catch (IOException ex) {
423                 ex.printStackTrace();
424             }
425             return null;
426         }
427 












428         @Override
429         public Void visitPackage(PackageElement e, Void p) {
430             List&lt;Element&gt; types = new ArrayList&lt;&gt;(e.getEnclosedElements());
431             Collections.sort(types, (e1, e2) -&gt; e1.getSimpleName().toString().compareTo(e2.getSimpleName().toString()));
432             for (Element encl : types) {
433                 visit(encl, p);
434             }
435             return null;
436         }
437 
438         @Override
439         public Void visitType(TypeElement e, Void p) {
440             if (!acceptAccess(e))
441                 return null;
442             writeType(e);
443             return null;
444         }
445 
446         void writeType(TypeElement e) {
447             if (!acceptType.test(task.getElements().getBinaryName(e).toString()))
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2015, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
</pre>
<hr />
<pre>
111  *
112  *     java ElementStructureTest generate-hashes classes-6 6 classes-7 7 classes-8 8
113  *
114  * To inspect differences between the actual and expected output for version N, invoke this class like:
115  *
116  *     java ElementStructureTest generate-output $LANGTOOLS_DIR/make/data/symbols/include.list (&lt;classes-for-N&gt; N &lt;actual-output-file&gt; &lt;expected-output-file&gt;)+
117  *
118  * For example, to get the actual and expected output for 6 in /tmp/actual and /tmp/expected, respectively:
119  *
120  *     java ElementStructureTest generate-output $LANGTOOLS_DIR/make/data/symbols/include.list classes-6 6 /tmp/actual /tmp/expected
121  */
122 public class ElementStructureTest {
123 
124     static final byte[] hash6 = new byte[] {
125         (byte) 0x99, (byte) 0x34, (byte) 0x82, (byte) 0xCF,
126         (byte) 0xE0, (byte) 0x53, (byte) 0xF3, (byte) 0x13,
127         (byte) 0x4E, (byte) 0xCF, (byte) 0x49, (byte) 0x32,
128         (byte) 0xB7, (byte) 0x52, (byte) 0x0F, (byte) 0x68
129     };
130     static final byte[] hash7 = new byte[] {
<span class="line-modified">131         (byte) 0x3C, (byte) 0x03, (byte) 0xEA, (byte) 0x4A,</span>
<span class="line-modified">132         (byte) 0x62, (byte) 0xD2, (byte) 0x18, (byte) 0xE5,</span>
<span class="line-modified">133         (byte) 0xA5, (byte) 0xC2, (byte) 0xB7, (byte) 0x85,</span>
<span class="line-modified">134         (byte) 0x90, (byte) 0xFA, (byte) 0x98, (byte) 0xCD</span>
135     };
136     static final byte[] hash8 = new byte[] {
<span class="line-modified">137         (byte) 0x0B, (byte) 0xEB, (byte) 0x16, (byte) 0xF5,</span>
<span class="line-modified">138         (byte) 0x7F, (byte) 0xB0, (byte) 0x18, (byte) 0xF1,</span>
<span class="line-modified">139         (byte) 0x78, (byte) 0x11, (byte) 0xED, (byte) 0x30,</span>
<span class="line-modified">140         (byte) 0x19, (byte) 0x4D, (byte) 0xDE, (byte) 0x8A</span>
141     };
142 
143     final static Map&lt;String, byte[]&gt; version2Hash = new HashMap&lt;&gt;();
144 
145     static {
146         version2Hash.put(&quot;6&quot;, hash6);
147         version2Hash.put(&quot;7&quot;, hash7);
148         version2Hash.put(&quot;8&quot;, hash8);
149     }
150 
151     public static void main(String... args) throws Exception {
152         if (args.length == 0) {
153             new ElementStructureTest().doTest();
154             return ;
155         }
156         switch (args[0]) {
157             case &quot;generate-hashes&quot;:
158                 new ElementStructureTest().generateHashes(args);
159                 break;
160             case &quot;generate-output&quot;:
</pre>
<hr />
<pre>
392                 out.write(e.getSimpleName().toString());
393             } catch (IOException ex) {
394                 ex.printStackTrace();
395             }
396         }
397 
398         boolean acceptAccess(Element e) {
399             return e.getModifiers().contains(Modifier.PUBLIC) || e.getModifiers().contains(Modifier.PROTECTED);
400         }
401 
402         @Override
403         public Void visitExecutable(ExecutableElement e, Void p) {
404             if (!acceptAccess(e))
405                 return null;
406             try {
407                 analyzeElement(e);
408                 out.write(String.valueOf(e.getDefaultValue()));
409                 for (VariableElement param : e.getParameters()) {
410                     visit(param, p);
411                 }
<span class="line-modified">412                 out.write(String.valueOf(typeMirrorTranslate(e.getReceiverType())));</span>
413                 write(e.getReturnType());
414                 out.write(e.getSimpleName().toString());
415                 writeTypes(e.getThrownTypes());
416                 for (TypeParameterElement param : e.getTypeParameters()) {
417                     visit(param, p);
418                 }
419                 out.write(String.valueOf(e.isDefault()));
420                 out.write(String.valueOf(e.isVarArgs()));
421                 out.write(&quot;\n&quot;);
422             } catch (IOException ex) {
423                 ex.printStackTrace();
424             }
425             return null;
426         }
427 
<span class="line-added">428         /**</span>
<span class="line-added">429          * Original implementation of getReceiverType returned null</span>
<span class="line-added">430          * for many cases where TypeKind.NONE was specified; translate</span>
<span class="line-added">431          * back to null to compare against old hashes.</span>
<span class="line-added">432          */</span>
<span class="line-added">433         private TypeMirror typeMirrorTranslate(TypeMirror type) {</span>
<span class="line-added">434             if (type.getKind() == javax.lang.model.type.TypeKind.NONE)</span>
<span class="line-added">435                 return null;</span>
<span class="line-added">436             else</span>
<span class="line-added">437                 return type;</span>
<span class="line-added">438         }</span>
<span class="line-added">439 </span>
440         @Override
441         public Void visitPackage(PackageElement e, Void p) {
442             List&lt;Element&gt; types = new ArrayList&lt;&gt;(e.getEnclosedElements());
443             Collections.sort(types, (e1, e2) -&gt; e1.getSimpleName().toString().compareTo(e2.getSimpleName().toString()));
444             for (Element encl : types) {
445                 visit(encl, p);
446             }
447             return null;
448         }
449 
450         @Override
451         public Void visitType(TypeElement e, Void p) {
452             if (!acceptAccess(e))
453                 return null;
454             writeType(e);
455             return null;
456         }
457 
458         void writeType(TypeElement e) {
459             if (!acceptType.test(task.getElements().getBinaryName(e).toString()))
</pre>
</td>
</tr>
</table>
<center><a href="../switchextra/SwitchStatementScopesIsolated.out.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../tree/AbstractTreeScannerTest.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>