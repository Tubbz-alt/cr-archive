<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/langtools/tools/javac/defaultMethods/BadClassfile.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
    <script type="text/javascript" src="../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 2013, 2016, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @bug 8025087
 27  * @summary Verify that pre-JDK8 classfiles with default and/or static methods
 28  *          are refused correctly.
 29  * @modules jdk.jdeps/com.sun.tools.classfile
 30  *          jdk.compiler/com.sun.tools.javac.api
 31  *          jdk.compiler/com.sun.tools.javac.code
 32  *          jdk.compiler/com.sun.tools.javac.comp
 33  *          jdk.compiler/com.sun.tools.javac.jvm
 34  *          jdk.compiler/com.sun.tools.javac.main
 35  *          jdk.compiler/com.sun.tools.javac.util
 36  * @build BadClassfile
 37  * @run main BadClassfile
 38  */
 39 
 40 import com.sun.tools.classfile.*;
 41 import com.sun.tools.javac.api.JavacTaskImpl;
 42 import com.sun.tools.javac.code.ClassFinder.BadClassFile;
 43 import com.sun.tools.javac.code.Symbol;
 44 import com.sun.tools.javac.code.Symtab;
 45 import com.sun.tools.javac.jvm.Target;
 46 import com.sun.tools.javac.util.Assert;
 47 import com.sun.tools.javac.util.JCDiagnostic;
 48 import java.io.File;
 49 import java.util.Arrays;
 50 import java.util.Objects;
 51 import javax.tools.JavaCompiler;
 52 import javax.tools.ToolProvider;
 53 
 54 public class BadClassfile {
 55     public static void main(String... args) throws Exception {
 56         test(&quot;BadClassfile$DefaultMethodTest&quot;, &quot;compiler.misc.invalid.default.interface&quot;);
 57         test(&quot;BadClassfile$StaticMethodTest&quot;, &quot;compiler.misc.invalid.static.interface&quot;);
 58     }
 59 
 60     private static void test(String classname, String expected) throws Exception {
 61         File classfile = new File(System.getProperty(&quot;test.classes&quot;, &quot;.&quot;), classname + &quot;.class&quot;);
 62         ClassFile cf = ClassFile.read(classfile);
 63 
 64         cf = new ClassFile(cf.magic, Target.JDK1_7.minorVersion,
 65                  Target.JDK1_7.majorVersion, cf.constant_pool, cf.access_flags,
 66                 cf.this_class, cf.super_class, cf.interfaces, cf.fields,
 67                 cf.methods, cf.attributes);
 68 
 69         new ClassWriter().write(cf, classfile);
 70 
 71         JavaCompiler c = ToolProvider.getSystemJavaCompiler();
 72         JavacTaskImpl task = (JavacTaskImpl) c.getTask(null, null, null, Arrays.asList(&quot;-classpath&quot;, System.getProperty(&quot;test.classes&quot;, &quot;.&quot;)), null, null);
 73         Symtab syms = Symtab.instance(task.getContext());
 74 
 75         task.ensureEntered();
 76 
 77         try {
 78             Symbol clazz = com.sun.tools.javac.main.JavaCompiler.instance(task.getContext()).resolveIdent(syms.unnamedModule, classname);
 79 
 80             clazz.complete();
 81         } catch (BadClassFile f) {
<a name="1" id="anc1"></a><span class="line-modified"> 82             JCDiagnostic embeddedDiag = (JCDiagnostic) f.diag.getArgs()[1];</span>
 83             assertEquals(expected, embeddedDiag.getCode());
 84             assertEquals(Integer.toString(Target.JDK1_7.majorVersion), embeddedDiag.getArgs()[0]);
 85             assertEquals(Integer.toString(Target.JDK1_7.minorVersion), embeddedDiag.getArgs()[1]);
 86         }
 87     }
 88 
 89     private static void assertEquals(Object expected, Object actual) {
 90         Assert.check(Objects.equals(expected, actual),
 91                      &quot;expected: &quot; + expected + &quot;, but was: &quot; + actual);
 92     }
 93 
 94     interface DefaultMethodTest {
 95         default void test() { }
 96     }
 97     interface StaticMethodTest {
 98         static void test() { }
 99     }
100 }
<a name="2" id="anc2"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="2" type="hidden" />
</body>
</html>