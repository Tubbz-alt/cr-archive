<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/langtools/tools/javac/modules/MOptionTest.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="ContainsTest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="T8159439/NPEForModuleInfoWithNonZeroSuperClassTest.out.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/langtools/tools/javac/modules/MOptionTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2016, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /**
 25  * @test
<span class="line-modified"> 26  * @bug 8146946 8176743</span>
 27  * @summary implement javac -m option
 28  * @library /tools/lib
 29  * @modules
 30  *      jdk.compiler/com.sun.tools.javac.api
 31  *      jdk.compiler/com.sun.tools.javac.main
 32  * @build toolbox.ToolBox toolbox.JavacTask ModuleTestBase
 33  * @run main MOptionTest
 34  */
 35 
 36 import java.nio.file.Files;
 37 import java.nio.file.Path;
 38 import java.nio.file.attribute.FileTime;
 39 
 40 import toolbox.JavacTask;
 41 import toolbox.Task;
<span class="line-removed"> 42 import toolbox.ToolBox;</span>
 43 
 44 public class MOptionTest extends ModuleTestBase {
 45     public static void main(String... args) throws Exception {
 46         new MOptionTest().runTests();
 47     }
 48 
 49     @Test
 50     public void testOneModule(Path base) throws Exception {
 51         Path src = base.resolve(&quot;src&quot;);
 52         Path m1 = src.resolve(&quot;m1x&quot;);
 53         Path build = base.resolve(&quot;build&quot;);
 54         Files.createDirectories(build);
 55 
 56         tb.writeJavaFiles(m1,
 57                 &quot;module m1x {}&quot;,
 58                 &quot;package test; public class Test {}&quot;);
 59 
 60         new JavacTask(tb)
 61                 .options(&quot;-m&quot;, &quot;m1x&quot;, &quot;--module-source-path&quot;, src.toString(), &quot;-d&quot;, build.toString())
 62                 .run(Task.Expect.SUCCESS)
</pre>
<hr />
<pre>
 76         Path testTest = m1.resolve(&quot;test/Test.java&quot;);
 77         if (testTestTimeStamp.compareTo(Files.getLastModifiedTime(testTest)) &lt; 0) {
 78             throw new AssertionError(&quot;Classfiles too old!&quot;);
 79         }
 80 
 81         Thread.sleep(2000); //timestamps
 82 
 83         new JavacTask(tb)
 84                 .options(&quot;-m&quot;, &quot;m1x&quot;, &quot;--module-source-path&quot;, src.toString(), &quot;-d&quot;, build.toString())
 85                 .run(Task.Expect.SUCCESS)
 86                 .writeAll();
 87 
 88         if (!moduleInfoTimeStamp.equals(Files.getLastModifiedTime(moduleInfoClass))) {
 89             throw new AssertionError(&quot;Classfile update!&quot;);
 90         }
 91 
 92         if (!testTestTimeStamp.equals(Files.getLastModifiedTime(testTestClass))) {
 93             throw new AssertionError(&quot;Classfile update!&quot;);
 94         }
 95 
<span class="line-modified"> 96         Thread.sleep(2000); //timestamps</span>
<span class="line-modified"> 97 </span>
<span class="line-modified"> 98         Files.setLastModifiedTime(testTest, FileTime.fromMillis(System.currentTimeMillis()));</span>

 99 
100         new JavacTask(tb)
101                 .options(&quot;-m&quot;, &quot;m1x&quot;, &quot;--module-source-path&quot;, src.toString(), &quot;-d&quot;, build.toString())
102                 .run(Task.Expect.SUCCESS)
103                 .writeAll();
104 
105         if (!moduleInfoTimeStamp.equals(Files.getLastModifiedTime(moduleInfoClass))) {
106             throw new AssertionError(&quot;Classfile update!&quot;);
107         }
108 
109         if (Files.getLastModifiedTime(testTestClass).compareTo(Files.getLastModifiedTime(testTest)) &lt; 0) {
110             throw new AssertionError(&quot;Classfiles too old!&quot;);
111         }
112     }
113 
114     @Test
115     public void testNoOutputDir(Path base) throws Exception {
116         Path src = base.resolve(&quot;src&quot;);
117         Path m1 = src.resolve(&quot;m1x&quot;);
118         Path build = base.resolve(&quot;build&quot;);
</pre>
<hr />
<pre>
218                 .options(&quot;-m&quot;, &quot;m1x,m2x&quot;, &quot;--module-source-path&quot;, src.toString(), &quot;-d&quot;, build.toString())
219                 .run(Task.Expect.SUCCESS)
220                 .writeAll();
221 
222         if (!m1ModuleInfoTimeStamp.equals(Files.getLastModifiedTime(m1ModuleInfoClass))) {
223             throw new AssertionError(&quot;Classfile update!&quot;);
224         }
225 
226         if (!m2ModuleInfoTimeStamp.equals(Files.getLastModifiedTime(m2ModuleInfoClass))) {
227             throw new AssertionError(&quot;Classfile update!&quot;);
228         }
229 
230         if (!C1TimeStamp.equals(Files.getLastModifiedTime(classC1))) {
231             throw new AssertionError(&quot;Classfile update!&quot;);
232         }
233 
234         if (!C2TimeStamp.equals(Files.getLastModifiedTime(classC2))) {
235             throw new AssertionError(&quot;Classfile update!&quot;);
236         }
237 
<span class="line-modified">238         Thread.sleep(2000); //timestamps</span>
<span class="line-modified">239 </span>
<span class="line-modified">240         Files.setLastModifiedTime(C1Source, FileTime.fromMillis(System.currentTimeMillis()));</span>
<span class="line-modified">241         Files.setLastModifiedTime(C2Source, FileTime.fromMillis(System.currentTimeMillis()));</span>

242 
243         new JavacTask(tb)
244                 .options(&quot;-m&quot;, &quot;m1x,m2x&quot;, &quot;--module-source-path&quot;, src.toString(), &quot;-d&quot;, build.toString())
245                 .run(Task.Expect.SUCCESS)
246                 .writeAll();
247 
248         if (!m1ModuleInfoTimeStamp.equals(Files.getLastModifiedTime(m1ModuleInfoClass))) {
249             throw new AssertionError(&quot;Classfile update!&quot;);
250         }
251 
252         if (!m2ModuleInfoTimeStamp.equals(Files.getLastModifiedTime(m2ModuleInfoClass))) {
253             throw new AssertionError(&quot;Classfile update!&quot;);
254         }
255 
256         if (Files.getLastModifiedTime(classC1).compareTo(Files.getLastModifiedTime(C1Source)) &lt; 0) {
257             throw new AssertionError(&quot;Classfiles too old!&quot;);
258         }
259 
260         if (Files.getLastModifiedTime(classC2).compareTo(Files.getLastModifiedTime(C2Source)) &lt; 0) {
261             throw new AssertionError(&quot;Classfiles too old!&quot;);
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2016, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /**
 25  * @test
<span class="line-modified"> 26  * @bug 8146946 8176743 8200286</span>
 27  * @summary implement javac -m option
 28  * @library /tools/lib
 29  * @modules
 30  *      jdk.compiler/com.sun.tools.javac.api
 31  *      jdk.compiler/com.sun.tools.javac.main
 32  * @build toolbox.ToolBox toolbox.JavacTask ModuleTestBase
 33  * @run main MOptionTest
 34  */
 35 
 36 import java.nio.file.Files;
 37 import java.nio.file.Path;
 38 import java.nio.file.attribute.FileTime;
 39 
 40 import toolbox.JavacTask;
 41 import toolbox.Task;

 42 
 43 public class MOptionTest extends ModuleTestBase {
 44     public static void main(String... args) throws Exception {
 45         new MOptionTest().runTests();
 46     }
 47 
 48     @Test
 49     public void testOneModule(Path base) throws Exception {
 50         Path src = base.resolve(&quot;src&quot;);
 51         Path m1 = src.resolve(&quot;m1x&quot;);
 52         Path build = base.resolve(&quot;build&quot;);
 53         Files.createDirectories(build);
 54 
 55         tb.writeJavaFiles(m1,
 56                 &quot;module m1x {}&quot;,
 57                 &quot;package test; public class Test {}&quot;);
 58 
 59         new JavacTask(tb)
 60                 .options(&quot;-m&quot;, &quot;m1x&quot;, &quot;--module-source-path&quot;, src.toString(), &quot;-d&quot;, build.toString())
 61                 .run(Task.Expect.SUCCESS)
</pre>
<hr />
<pre>
 75         Path testTest = m1.resolve(&quot;test/Test.java&quot;);
 76         if (testTestTimeStamp.compareTo(Files.getLastModifiedTime(testTest)) &lt; 0) {
 77             throw new AssertionError(&quot;Classfiles too old!&quot;);
 78         }
 79 
 80         Thread.sleep(2000); //timestamps
 81 
 82         new JavacTask(tb)
 83                 .options(&quot;-m&quot;, &quot;m1x&quot;, &quot;--module-source-path&quot;, src.toString(), &quot;-d&quot;, build.toString())
 84                 .run(Task.Expect.SUCCESS)
 85                 .writeAll();
 86 
 87         if (!moduleInfoTimeStamp.equals(Files.getLastModifiedTime(moduleInfoClass))) {
 88             throw new AssertionError(&quot;Classfile update!&quot;);
 89         }
 90 
 91         if (!testTestTimeStamp.equals(Files.getLastModifiedTime(testTestClass))) {
 92             throw new AssertionError(&quot;Classfile update!&quot;);
 93         }
 94 
<span class="line-modified"> 95         // Date back the source file by one second compared to the current time.</span>
<span class="line-modified"> 96         // Cases have been observed where the resulting class file had an earlier</span>
<span class="line-modified"> 97         // timestamp than the java source.</span>
<span class="line-added"> 98         Files.setLastModifiedTime(testTest, FileTime.fromMillis(System.currentTimeMillis() - 1000));</span>
 99 
100         new JavacTask(tb)
101                 .options(&quot;-m&quot;, &quot;m1x&quot;, &quot;--module-source-path&quot;, src.toString(), &quot;-d&quot;, build.toString())
102                 .run(Task.Expect.SUCCESS)
103                 .writeAll();
104 
105         if (!moduleInfoTimeStamp.equals(Files.getLastModifiedTime(moduleInfoClass))) {
106             throw new AssertionError(&quot;Classfile update!&quot;);
107         }
108 
109         if (Files.getLastModifiedTime(testTestClass).compareTo(Files.getLastModifiedTime(testTest)) &lt; 0) {
110             throw new AssertionError(&quot;Classfiles too old!&quot;);
111         }
112     }
113 
114     @Test
115     public void testNoOutputDir(Path base) throws Exception {
116         Path src = base.resolve(&quot;src&quot;);
117         Path m1 = src.resolve(&quot;m1x&quot;);
118         Path build = base.resolve(&quot;build&quot;);
</pre>
<hr />
<pre>
218                 .options(&quot;-m&quot;, &quot;m1x,m2x&quot;, &quot;--module-source-path&quot;, src.toString(), &quot;-d&quot;, build.toString())
219                 .run(Task.Expect.SUCCESS)
220                 .writeAll();
221 
222         if (!m1ModuleInfoTimeStamp.equals(Files.getLastModifiedTime(m1ModuleInfoClass))) {
223             throw new AssertionError(&quot;Classfile update!&quot;);
224         }
225 
226         if (!m2ModuleInfoTimeStamp.equals(Files.getLastModifiedTime(m2ModuleInfoClass))) {
227             throw new AssertionError(&quot;Classfile update!&quot;);
228         }
229 
230         if (!C1TimeStamp.equals(Files.getLastModifiedTime(classC1))) {
231             throw new AssertionError(&quot;Classfile update!&quot;);
232         }
233 
234         if (!C2TimeStamp.equals(Files.getLastModifiedTime(classC2))) {
235             throw new AssertionError(&quot;Classfile update!&quot;);
236         }
237 
<span class="line-modified">238         // Date back the source file by one second compared to the current time.</span>
<span class="line-modified">239         // Cases have been observed where the resulting class file had an earlier</span>
<span class="line-modified">240         // timestamp than the java source.</span>
<span class="line-modified">241         Files.setLastModifiedTime(C1Source, FileTime.fromMillis(System.currentTimeMillis() - 1000));</span>
<span class="line-added">242         Files.setLastModifiedTime(C2Source, FileTime.fromMillis(System.currentTimeMillis() - 1000));</span>
243 
244         new JavacTask(tb)
245                 .options(&quot;-m&quot;, &quot;m1x,m2x&quot;, &quot;--module-source-path&quot;, src.toString(), &quot;-d&quot;, build.toString())
246                 .run(Task.Expect.SUCCESS)
247                 .writeAll();
248 
249         if (!m1ModuleInfoTimeStamp.equals(Files.getLastModifiedTime(m1ModuleInfoClass))) {
250             throw new AssertionError(&quot;Classfile update!&quot;);
251         }
252 
253         if (!m2ModuleInfoTimeStamp.equals(Files.getLastModifiedTime(m2ModuleInfoClass))) {
254             throw new AssertionError(&quot;Classfile update!&quot;);
255         }
256 
257         if (Files.getLastModifiedTime(classC1).compareTo(Files.getLastModifiedTime(C1Source)) &lt; 0) {
258             throw new AssertionError(&quot;Classfiles too old!&quot;);
259         }
260 
261         if (Files.getLastModifiedTime(classC2).compareTo(Files.getLastModifiedTime(C2Source)) &lt; 0) {
262             throw new AssertionError(&quot;Classfiles too old!&quot;);
</pre>
</td>
</tr>
</table>
<center><a href="ContainsTest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="T8159439/NPEForModuleInfoWithNonZeroSuperClassTest.out.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>