<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old test/langtools/tools/javac/switchexpr/CRT.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2018, 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @bug 8214031
 27  * @summary Test the CharacterRangeTable generated for switch expressions
 28  * @library /tools/lib
 29  * @modules jdk.compiler/com.sun.tools.javac.api
 30  *          jdk.compiler/com.sun.tools.javac.main
 31  *          jdk.jdeps/com.sun.tools.javap
 32  * @build toolbox.Assert toolbox.ToolBox toolbox.JavacTask
 33  * @run main CRT
 34  */
 35 
 36 
 37 import java.nio.file.Path;
 38 import java.nio.file.Paths;
 39 import java.util.stream.Collectors;
 40 
 41 import toolbox.JavacTask;
 42 import toolbox.JavapTask;
 43 import toolbox.Task.OutputKind;
 44 import toolbox.ToolBox;
 45 
 46 public class CRT {
 47     public static void main(String... args) throws Exception {
 48         new CRT().run();
 49     }
 50 
 51     private static final String SOURCE_VERSION = Integer.toString(Runtime.version().feature());
 52 
 53     private ToolBox tb = new ToolBox();
 54 
 55     private void run() throws Exception {
 56         doTest(&quot;    private String convert(int i) {\n&quot; +
 57                &quot;        String res;&quot; +
 58                &quot;        switch (i) {\n&quot; +
 59                &quot;            case 0: res = \&quot;a\&quot;; break;\n&quot; +
 60                &quot;            default: res = \&quot;\&quot;; break;\n&quot; +
 61                &quot;        };\n&quot; +
 62                &quot;        return res;\n&quot; +
 63                &quot;    }\n&quot;,
 64                &quot;CharacterRangeTable:\n&quot; +
 65                &quot;             0,  0,    c24,    c25,    8        //  0,  0,    3:36,    3:37, flow-controller\n&quot; +
 66                &quot;            20, 22,   1015,   101f,    1        // 20, 22,    4:21,    4:31, statement\n&quot; +
 67                &quot;            23, 25,   1020,   1026,    1        // 23, 25,    4:32,    4:38, statement\n&quot; +
 68                &quot;            20, 25,   1015,   1026,   10        // 20, 25,    4:21,    4:38, flow-target\n&quot; +
 69                &quot;            26, 28,   1416,   141f,    1        // 26, 28,    5:22,    5:31, statement\n&quot; +
 70                &quot;            29, 31,   1420,   1426,    1        // 29, 31,    5:32,    5:38, statement\n&quot; +
 71                &quot;            26, 31,   1416,   1426,   10        // 26, 31,    5:22,    5:38, flow-target\n&quot; +
 72                &quot;             0, 31,    c1c,   180a,    1        //  0, 31,    3:28,    6:10, statement\n&quot; +
 73                &quot;            32, 33,   1c09,   1c14,    1        // 32, 33,    7:09,    7:20, statement\n&quot; +
 74                &quot;             0, 33,    823,   2006,    2        //  0, 33,    2:35,    8:06, block\n&quot;);
 75         doTest(&quot;    private String convert(int i) {\n&quot; +
 76                &quot;        return switch (i) {\n&quot; +
 77                &quot;            case 0 -&gt; \&quot;a\&quot;;\n&quot; +
 78                &quot;            default -&gt; \&quot;\&quot;;\n&quot; +
 79                &quot;        };\n&quot; +
 80                &quot;    }\n&quot;,
 81                &quot;CharacterRangeTable:\n&quot; +
 82                &quot;             0,  0,    c18,    c19,    8        //  0,  0,    3:24,    3:25, flow-controller\n&quot; +
 83                &quot;            20, 24,   1017,   101b,   11        // 20, 24,    4:23,    4:27, statement, flow-target\n&quot; +
 84                &quot;            25, 29,   1418,   141b,   11        // 25, 29,    5:24,    5:27, statement, flow-target\n&quot; +
 85                &quot;             0, 30,    c09,   180b,    1        //  0, 30,    3:09,    6:11, statement\n&quot; +
 86                &quot;             0, 30,    823,   1c06,    2        //  0, 30,    2:35,    7:06, block&quot;);
 87         doTest(&quot;    private boolean convert(int i) {\n&quot; +
 88                &quot;        return switch (i) {\n&quot; +
 89                &quot;            case 0 -&gt; true;\n&quot; +
 90                &quot;            default -&gt; false;\n&quot; +
 91                &quot;        } &amp;&amp; i == 0;\n&quot; +
 92                &quot;    }\n&quot;,
 93                &quot;CharacterRangeTable:\n&quot; +
 94                &quot;             0,  0,    c18,    c19,    8        //  0,  0,    3:24,    3:25, flow-controller\n&quot; +
 95                &quot;            20, 22,   1017,   101c,   11        // 20, 22,    4:23,    4:28, statement, flow-target\n&quot; +
 96                &quot;            23, 25,   1418,   141e,   11        // 23, 25,    5:24,    5:30, statement, flow-target\n&quot; +
 97                &quot;             0, 25,    c10,   180a,    8        //  0, 25,    3:16,    6:10, flow-controller\n&quot; +
 98                &quot;            26, 26,   180e,   1814,   10        // 26, 26,    6:14,    6:20, flow-target\n&quot; +
 99                &quot;             0, 35,    c09,   1815,    1        //  0, 35,    3:09,    6:21, statement\n&quot; +
100                &quot;             0, 35,    824,   1c06,    2        //  0, 35,    2:36,    7:06, block\n&quot;);
101         doTest(&quot;    private boolean convert(int i) {\n&quot; +
102                &quot;        return i &gt;= 0 ? i == 0\n&quot; +
103                &quot;                        ? true\n&quot; +
104                &quot;                        : false\n&quot; +
105                &quot;                      : i == -1\n&quot; +
106                &quot;                        ? false\n&quot; +
107                &quot;                        : true;\n&quot; +
108                &quot;    }\n&quot;,
109                &quot;CharacterRangeTable:\n&quot; +
110                &quot;             0,  0,    c10,    c16,    8        //  0,  0,    3:16,    3:22, flow-controller\n&quot; +
111                &quot;             1,  3,    c10,    c16,  100        //  1,  3,    3:16,    3:22, branch-false\n&quot; +
112                &quot;             4,  4,    c19,    c1f,    8        //  4,  4,    3:25,    3:31, flow-controller\n&quot; +
113                &quot;             5,  7,    c19,    c1f,  100        //  5,  7,    3:25,    3:31, branch-false\n&quot; +
114                &quot;             8,  8,   101b,   101f,   10        //  8,  8,    4:27,    4:31, flow-target\n&quot; +
115                &quot;            12, 12,   141b,   1420,   10        // 12, 12,    5:27,    5:32, flow-target\n&quot; +
116                &quot;             4, 12,    c19,   1420,   10        //  4, 12,    3:25,    5:32, flow-target\n&quot; +
117                &quot;            16, 17,   1819,   1820,    8        // 16, 17,    6:25,    6:32, flow-controller\n&quot; +
118                &quot;            18, 20,   1819,   1820,  100        // 18, 20,    6:25,    6:32, branch-false\n&quot; +
119                &quot;            21, 21,   1c1b,   1c20,   10        // 21, 21,    7:27,    7:32, flow-target\n&quot; +
120                &quot;            25, 25,   201b,   201f,   10        // 25, 25,    8:27,    8:31, flow-target\n&quot; +
121                &quot;            16, 25,   1819,   201f,   10        // 16, 25,    6:25,    8:31, flow-target\n&quot; +
122                &quot;             0, 26,    c09,   2020,    1        //  0, 26,    3:09,    8:32, statement\n&quot; +
123                &quot;             0, 26,    824,   2406,    2        //  0, 26,    2:36,    9:06, block\n&quot;);
124         doTest(&quot;    private boolean convert(int i) {\n&quot; +
125                &quot;        return i &gt;= 0 ? switch (i) {\n&quot; +
126                &quot;            case 0 -&gt; true;\n&quot; +
127                &quot;            default -&gt; false;\n&quot; +
128                &quot;        } : switch (i) {\n&quot; +
129                &quot;            case -1 -&gt; false;\n&quot; +
130                &quot;            default -&gt; true;\n&quot; +
131                &quot;        };\n&quot; +
132                &quot;    }\n&quot;,
133                &quot;CharacterRangeTable:\n&quot; +
134                &quot;             0,  0,    c10,    c16,    8        //  0,  0,    3:16,    3:22, flow-controller\n&quot; +
135                &quot;             1,  3,    c10,    c16,  100        //  1,  3,    3:16,    3:22, branch-false\n&quot; +
136                &quot;             4,  4,    c21,    c22,    8        //  4,  4,    3:33,    3:34, flow-controller\n&quot; +
137                &quot;            24, 27,   1017,   101c,   11        // 24, 27,    4:23,    4:28, statement, flow-target\n&quot; +
138                &quot;            28, 31,   1418,   141e,   11        // 28, 31,    5:24,    5:30, statement, flow-target\n&quot; +
139                &quot;             4, 31,    c19,   180a,   10        //  4, 31,    3:25,    6:10, flow-target\n&quot; +
140                &quot;            35, 35,   1815,   1816,    8        // 35, 35,    6:21,    6:22, flow-controller\n&quot; +
141                &quot;            56, 59,   1c18,   1c1e,   11        // 56, 59,    7:24,    7:30, statement, flow-target\n&quot; +
142                &quot;            60, 63,   2018,   201d,   11        // 60, 63,    8:24,    8:29, statement, flow-target\n&quot; +
143                &quot;            35, 63,   180d,   240a,   10        // 35, 63,    6:13,    9:10, flow-target\n&quot; +
144                &quot;             0, 64,    c09,   240b,    1        //  0, 64,    3:09,    9:11, statement\n&quot; +
145                &quot;             0, 64,    824,   2806,    2        //  0, 64,    2:36,   10:06, block\n&quot;);
146     }
147 
148     private void doTest(String code, String expected) throws Exception {
149         Path base = Paths.get(&quot;.&quot;);
150         Path classes = base.resolve(&quot;classes&quot;);
151         tb.createDirectories(classes);
152         tb.cleanDirectory(classes);
153         new JavacTask(tb)
154                 .options(&quot;-Xjcov&quot;,
155                          &quot;--enable-preview&quot;,
156                          &quot;-source&quot;, SOURCE_VERSION)
157                 .outdir(classes)
158                 .sources(&quot;public class Test {\n&quot; +
159                          code +
160                          &quot;}\n&quot;)
161                 .run()
162                 .writeAll();
163         String out = new JavapTask(tb)
164                 .options(&quot;-private&quot;,
165                          &quot;-verbose&quot;,
166                          &quot;-s&quot;)
167                 .classpath(classes.toString())
168                 .classes(&quot;Test&quot;)
169                 .run()
170                 .writeAll()
171                 .getOutputLines(OutputKind.DIRECT)
172                 .stream()
173                 .collect(Collectors.joining(&quot;\n&quot;));
174         String crt = cutCRT(out);
175         if (!expected.trim().equals(crt.trim())) {
176             throw new AssertionError(&quot;Expected CharacterRangeTable not found, found: &quot; + crt);
177         }
178     }
179 
180     private static String cutCRT(String from) {
181         int start = from.indexOf(&quot;CharacterRangeTable:&quot;, from.indexOf(&quot;convert(int);&quot;));
182         int end = from.indexOf(&quot;StackMapTable:&quot;);
183         return from.substring(start, end);
184     }
185 
186 }
    </pre>
  </body>
</html>