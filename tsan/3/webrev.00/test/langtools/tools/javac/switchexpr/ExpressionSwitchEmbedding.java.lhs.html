<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/langtools/tools/javac/switchexpr/ExpressionSwitchEmbedding.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
    <script type="text/javascript" src="../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2018, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
<a name="2" id="anc2"></a><span class="line-modified"> 26  * @bug 8214031 8214114</span>
 27  * @summary Verify switch expressions embedded in various statements work properly.
<a name="3" id="anc3"></a><span class="line-modified"> 28  * @compile --enable-preview -source ${jdk.version} ExpressionSwitchEmbedding.java</span>
<span class="line-modified"> 29  * @run main/othervm --enable-preview ExpressionSwitchEmbedding</span>
 30  */
 31 
 32 public class ExpressionSwitchEmbedding {
 33     public static void main(String... args) {
 34         new ExpressionSwitchEmbedding().run();
 35     }
 36 
 37     private void run() {
 38         {
 39             int i = 6;
 40             int o = 0;
 41             while (switch (i) {
<a name="4" id="anc4"></a><span class="line-modified"> 42                 case 1: i = 0; break true;</span>
<span class="line-modified"> 43                 case 2: i = 1; break true;</span>
 44                 case 3, 4: i--;
 45                     if (i == 2 || i == 4) {
<a name="5" id="anc5"></a><span class="line-modified"> 46                         break switch (i) {</span>
 47                             case 2 -&gt; true;
 48                             case 4 -&gt; false;
 49                             default -&gt; throw new IllegalStateException();
 50                         };
 51                     } else {
<a name="6" id="anc6"></a><span class="line-modified"> 52                         break true;</span>
 53                     }
<a name="7" id="anc7"></a><span class="line-modified"> 54                 default: i--; break switch (i) {</span>
 55                     case -1 -&gt; false;
 56                     case 3 -&gt; true;
 57                     default -&gt; true;
 58                 };
 59             }) {
 60                 o++;
 61             }
 62             if (o != 6 &amp;&amp; i &gt;= 0) {
 63                 throw new IllegalStateException();
 64             }
 65         }
 66         {
 67             int i = 6;
 68             int o = 0;
 69             while (switch (i) {
<a name="8" id="anc8"></a><span class="line-modified"> 70                 case 1: try { new ExpressionSwitchEmbedding().throwException(); } catch (Throwable t) { i = 0; break true; }</span>
<span class="line-modified"> 71                 case 2: try { new ExpressionSwitchEmbedding().throwException(); } catch (Throwable t) { i = 1; break true; }</span>
 72                 case 3, 4:
 73                     try {
 74                         new ExpressionSwitchEmbedding().throwException();
 75                     } catch (Throwable t) {
 76                         i--;
 77                         if (i == 2 || i == 4) {
 78                             try {
<a name="9" id="anc9"></a><span class="line-modified"> 79                                 break switch (i) {</span>
 80                                     case 2 -&gt; throw new ResultException(true);
 81                                     case 4 -&gt; false;
 82                                     default -&gt; throw new IllegalStateException();
 83                                 };
 84                             } catch (ResultException ex) {
<a name="10" id="anc10"></a><span class="line-modified"> 85                                 break ex.result;</span>
 86                             }
 87                         } else {
<a name="11" id="anc11"></a><span class="line-modified"> 88                             break true;</span>
 89                         }
 90                     }
 91                 default:
 92                     try {
 93                         new ExpressionSwitchEmbedding().throwException();
 94                     } catch (Throwable t) {
 95                         i--;
<a name="12" id="anc12"></a><span class="line-modified"> 96                         break switch (i) {</span>
 97                             case -1 -&gt; false;
 98                             case 3 -&gt; true;
 99                             default -&gt; true;
100                         };
101                     }
102                     throw new AssertionError();
103             }) {
104                 o++;
105             }
106             if (o != 6 &amp;&amp; i &gt;= 0) {
107                 throw new IllegalStateException();
108             }
109         }
110         {
111             int i = 6;
112             int o = 0;
113             if (switch (i) {
<a name="13" id="anc13"></a><span class="line-modified">114                 case 1: i = 0; break true;</span>
<span class="line-modified">115                 case 2: i = 1; break true;</span>
116                 case 3, 4: i--;
117                     if (i == 2 || i == 4) {
<a name="14" id="anc14"></a><span class="line-modified">118                         break (switch (i) {</span>
119                             case 2 -&gt; 3;
120                             case 4 -&gt; 5;
121                             default -&gt; throw new IllegalStateException();
122                         }) == i + 1;
123                     } else {
<a name="15" id="anc15"></a><span class="line-modified">124                         break true;</span>
125                     }
<a name="16" id="anc16"></a><span class="line-modified">126                 default: i--; break switch (i) {</span>
127                     case -1 -&gt; false;
128                     case 3 -&gt; true;
129                     default -&gt; true;
130                 };
131             }) {
132                 o++;
133             }
134             if (o != 1 &amp;&amp; i != 5) {
135                 throw new IllegalStateException();
136             }
137         }
138         {
139             int i = 6;
140             int o = 0;
141             if (switch (i) {
<a name="17" id="anc17"></a><span class="line-modified">142                 case 1: try { new ExpressionSwitchEmbedding().throwException(); } catch (Throwable t) { i = 0; break true; }</span>
<span class="line-modified">143                 case 2: try { new ExpressionSwitchEmbedding().throwException(); } catch (Throwable t) { i = 1; break true; }</span>
144                 case 3, 4:
145                     try {
146                         new ExpressionSwitchEmbedding().throwException();
147                     } catch (Throwable t) {
148                         i--;
149                         if (i == 2 || i == 4) {
150                             try {
<a name="18" id="anc18"></a><span class="line-modified">151                                 break switch (i) {</span>
152                                     case 2 -&gt; throw new ResultException(true);
153                                     case 4 -&gt; false;
154                                     default -&gt; throw new IllegalStateException();
155                                 };
156                             } catch (ResultException ex) {
<a name="19" id="anc19"></a><span class="line-modified">157                                 break ex.result;</span>
158                             }
159                         } else {
<a name="20" id="anc20"></a><span class="line-modified">160                             break true;</span>
161                         }
162                     }
163                 default:
164                     try {
165                         new ExpressionSwitchEmbedding().throwException();
166                     } catch (Throwable t) {
167                         i--;
<a name="21" id="anc21"></a><span class="line-modified">168                         break switch (i) {</span>
169                             case -1 -&gt; false;
170                             case 3 -&gt; true;
171                             default -&gt; true;
172                         };
173                     }
174                     throw new AssertionError();
175             }) {
176                 o++;
177             }
178             if (o != 1 &amp;&amp; i != 5) {
179                 throw new IllegalStateException();
180             }
181         }
182         {
183             int o = 0;
184             for (int i = 6; (switch (i) {
<a name="22" id="anc22"></a><span class="line-modified">185                 case 1: i = 0; break true;</span>
<span class="line-modified">186                 case 2: i = 1; break true;</span>
187                 case 3, 4: i--;
188                     if (i == 2 || i == 4) {
<a name="23" id="anc23"></a><span class="line-modified">189                         break switch (i) {</span>
190                             case 2 -&gt; true;
191                             case 4 -&gt; false;
192                             default -&gt; throw new IllegalStateException();
193                         };
194                     } else {
<a name="24" id="anc24"></a><span class="line-modified">195                         break true;</span>
196                     }
<a name="25" id="anc25"></a><span class="line-modified">197                 default: i--; break switch (i) {</span>
198                     case -1 -&gt; false;
199                     case 3 -&gt; true;
200                     default -&gt; true;
201                 };
202             }); ) {
203                 o++;
204             }
205             if (o != 6) {
206                 throw new IllegalStateException();
207             }
208         }
209         {
210             int o = 0;
211             for (int i = 6; (switch (i) {
<a name="26" id="anc26"></a><span class="line-modified">212                 case 1: try { new ExpressionSwitchEmbedding().throwException(); } catch (Throwable t) { i = 0; break true; }</span>
<span class="line-modified">213                 case 2: try { new ExpressionSwitchEmbedding().throwException(); } catch (Throwable t) { i = 1; break true; }</span>
214                 case 3, 4:
215                     try {
216                         new ExpressionSwitchEmbedding().throwException();
217                     } catch (Throwable t) {
218                         i--;
219                         if (i == 2 || i == 4) {
220                             try {
<a name="27" id="anc27"></a><span class="line-modified">221                                 break switch (i) {</span>
222                                     case 2 -&gt; throw new ResultException(true);
223                                     case 4 -&gt; false;
224                                     default -&gt; throw new IllegalStateException();
225                                 };
226                             } catch (ResultException ex) {
<a name="28" id="anc28"></a><span class="line-modified">227                                 break ex.result;</span>
228                             }
229                         } else {
<a name="29" id="anc29"></a><span class="line-modified">230                             break true;</span>
231                         }
232                     }
233                 default:
234                     try {
235                         new ExpressionSwitchEmbedding().throwException();
236                     } catch (Throwable t) {
237                         i--;
<a name="30" id="anc30"></a><span class="line-modified">238                         break switch (i) {</span>
239                             case -1 -&gt; false;
240                             case 3 -&gt; true;
241                             default -&gt; true;
242                         };
243                     }
244                     throw new AssertionError();
245             }); ) {
246                 o++;
247             }
248             if (o != 6) {
249                 throw new IllegalStateException();
250             }
251         }
252         {
253             int i = 6;
254             int o = 0;
255             do {
256                 o++;
257             } while (switch (i) {
<a name="31" id="anc31"></a><span class="line-modified">258                 case 1: i = 0; break true;</span>
<span class="line-modified">259                 case 2: i = 1; break true;</span>
260                 case 3, 4: i--;
261                     if (i == 2 || i == 4) {
<a name="32" id="anc32"></a><span class="line-modified">262                         break switch (i) {</span>
263                             case 2 -&gt; true;
264                             case 4 -&gt; false;
265                             default -&gt; throw new IllegalStateException();
266                         };
267                     } else {
<a name="33" id="anc33"></a><span class="line-modified">268                         break true;</span>
269                     }
<a name="34" id="anc34"></a><span class="line-modified">270                 default: i--; break switch (i) {</span>
271                     case -1 -&gt; false;
272                     case 3 -&gt; true;
273                     default -&gt; true;
274                 };
275             });
276             if (o != 6 &amp;&amp; i &gt;= 0) {
277                 throw new IllegalStateException();
278             }
279         }
280         {
281             int i = 6;
282             int o = 0;
283             do {
284                 o++;
285             } while (switch (i) {
<a name="35" id="anc35"></a><span class="line-modified">286                 case 1: try { new ExpressionSwitchEmbedding().throwException(); } catch (Throwable t) { i = 0; break true; }</span>
<span class="line-modified">287                 case 2: try { new ExpressionSwitchEmbedding().throwException(); } catch (Throwable t) { i = 1; break true; }</span>
288                 case 3, 4:
289                     try {
290                         new ExpressionSwitchEmbedding().throwException();
291                     } catch (Throwable t) {
292                         i--;
293                         if (i == 2 || i == 4) {
294                             try {
<a name="36" id="anc36"></a><span class="line-modified">295                                 break switch (i) {</span>
296                                     case 2 -&gt; throw new ResultException(true);
297                                     case 4 -&gt; false;
298                                     default -&gt; throw new IllegalStateException();
299                                 };
300                             } catch (ResultException ex) {
<a name="37" id="anc37"></a><span class="line-modified">301                                 break ex.result;</span>
302                             }
303                         } else {
<a name="38" id="anc38"></a><span class="line-modified">304                             break true;</span>
305                         }
306                     }
307                 default:
308                     try {
309                         new ExpressionSwitchEmbedding().throwException();
310                     } catch (Throwable t) {
311                         i--;
<a name="39" id="anc39"></a><span class="line-modified">312                         break switch (i) {</span>
313                             case -1 -&gt; false;
314                             case 3 -&gt; true;
315                             default -&gt; true;
316                         };
317                     }
318                     throw new AssertionError();
319             });
320             if (o != 6 &amp;&amp; i &gt;= 0) {
321                 throw new IllegalStateException();
322             }
323         }
<a name="40" id="anc40"></a>






324     }
325 
326     private void throwException() {
327         throw new RuntimeException();
328     }
329 
330     private static final class ResultException extends RuntimeException {
331         public final boolean result;
332         public ResultException(boolean result) {
333             this.result = result;
334         }
335     }
336 }
<a name="41" id="anc41"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="41" type="hidden" />
</body>
</html>