<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff test/langtools/tools/javac/lambda/methodReference/BridgeMethod.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="../lambdaExpression/LambdaTest6.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../mostSpecific/StructuralMostSpecificTest.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>test/langtools/tools/javac/lambda/methodReference/BridgeMethod.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 24,15 ***</span>
<span class="line-new-header">--- 24,19 ---</span>
  /**
   * @test
   * @bug 8003280
   * @summary Add lambda tests
   *   Test bridge methods in certain SAM conversion
<span class="line-added">+  *   Tests that jdk.internal.lambda.disableEagerInitialization=true creates a</span>
<span class="line-added">+  *   get$Lambda method for non-capturing lambdas</span>
   * @compile BridgeMethod.java
   * @run main BridgeMethod
<span class="line-added">+  * @run main/othervm -Djdk.internal.lambda.disableEagerInitialization=true BridgeMethod</span>
   */
  
  import java.lang.reflect.Method;
<span class="line-added">+ import java.util.Arrays;</span>
  import java.util.HashSet;
  import java.util.Set;
  
  public class BridgeMethod {
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 66,38 ***</span>
          s.add(&quot;java.lang.String&quot;);
          s.add(&quot;java.lang.Object&quot;);
          return s;
      }
  
      public static void main(String[] args) {
          L la = BridgeMethod::bar; //static reference
          la.m(&quot;hi&quot;);
          Class&lt;? extends L&gt; c1 = la.getClass();
          Method[] methods = c1.getDeclaredMethods();
          Set&lt;String&gt; types = setOfStringObject();
          System.out.println(&quot;methods in SAM conversion of L:&quot;);
          for(Method m : methods) {
<span class="line-modified">!             System.out.println(m.toGenericString());</span>
<span class="line-modified">!             assertTrue(m.getName().equals(&quot;m&quot;));</span>
<span class="line-modified">!             Class[] parameterTypes = m.getParameterTypes();</span>
<span class="line-modified">!             assertTrue(parameterTypes.length == 1);</span>
<span class="line-modified">!             assertTrue(types.remove(parameterTypes[0].getName()));</span>
          }
          assertTrue(types.isEmpty() || (types.size() == 1 &amp;&amp; types.contains(&quot;java.lang.String&quot;)));
  
          KM km = BridgeMethod::bar;
          //km.m(&quot;hi&quot;); //will be uncommented when CR7028808 fixed
          Class&lt;? extends KM&gt; c2 = km.getClass();
          methods = c2.getDeclaredMethods();
          types = setOfStringObject();
          System.out.println(&quot;methods in SAM conversion of KM:&quot;);
          for(Method m : methods) {
<span class="line-modified">!             System.out.println(m.toGenericString());</span>
<span class="line-modified">!             assertTrue(m.getName().equals(&quot;m&quot;));</span>
<span class="line-modified">!             Class&lt;?&gt;[] parameterTypes = m.getParameterTypes();</span>
<span class="line-modified">!             assertTrue(parameterTypes.length == 1);</span>
<span class="line-modified">!             assertTrue(types.remove(parameterTypes[0].getName()));</span>
          }
          assertTrue(types.isEmpty());
  
          N n = new BridgeMethod()::moo; //instance reference
          assertTrue( n.m().equals(&quot;moo&quot;) );
<span class="line-new-header">--- 70,59 ---</span>
          s.add(&quot;java.lang.String&quot;);
          s.add(&quot;java.lang.Object&quot;);
          return s;
      }
  
<span class="line-added">+     private static Set&lt;String&gt; allowedMethods() {</span>
<span class="line-added">+         Set&lt;String&gt; s = new HashSet&lt;&gt;();</span>
<span class="line-added">+         s.add(&quot;m&quot;);</span>
<span class="line-added">+         if (Boolean.getBoolean(&quot;jdk.internal.lambda.disableEagerInitialization&quot;)) {</span>
<span class="line-added">+             s.add(&quot;get$Lambda&quot;);</span>
<span class="line-added">+         }</span>
<span class="line-added">+         return s;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     private static boolean matchingMethodNames(Method[] methods) {</span>
<span class="line-added">+         Set&lt;String&gt; methodNames = new HashSet&lt;&gt;();</span>
<span class="line-added">+         for (Method m : methods) {</span>
<span class="line-added">+             methodNames.add(m.getName());</span>
<span class="line-added">+         }</span>
<span class="line-added">+         return methodNames.equals(allowedMethods());</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
      public static void main(String[] args) {
          L la = BridgeMethod::bar; //static reference
          la.m(&quot;hi&quot;);
          Class&lt;? extends L&gt; c1 = la.getClass();
          Method[] methods = c1.getDeclaredMethods();
<span class="line-added">+         assertTrue(matchingMethodNames(methods));</span>
          Set&lt;String&gt; types = setOfStringObject();
          System.out.println(&quot;methods in SAM conversion of L:&quot;);
          for(Method m : methods) {
<span class="line-modified">!             if (m.getName().equals(&quot;m&quot;)) {</span>
<span class="line-modified">!                 System.out.println(m.toGenericString());</span>
<span class="line-modified">!                 Class[] parameterTypes = m.getParameterTypes();</span>
<span class="line-modified">!                 assertTrue(parameterTypes.length == 1);</span>
<span class="line-modified">!                 assertTrue(types.remove(parameterTypes[0].getName()));</span>
<span class="line-added">+             }</span>
          }
          assertTrue(types.isEmpty() || (types.size() == 1 &amp;&amp; types.contains(&quot;java.lang.String&quot;)));
  
          KM km = BridgeMethod::bar;
          //km.m(&quot;hi&quot;); //will be uncommented when CR7028808 fixed
          Class&lt;? extends KM&gt; c2 = km.getClass();
          methods = c2.getDeclaredMethods();
<span class="line-added">+         assertTrue(matchingMethodNames(methods));</span>
          types = setOfStringObject();
          System.out.println(&quot;methods in SAM conversion of KM:&quot;);
          for(Method m : methods) {
<span class="line-modified">!             if (m.getName().equals(&quot;m&quot;)) {</span>
<span class="line-modified">!                 System.out.println(m.toGenericString());</span>
<span class="line-modified">!                 Class&lt;?&gt;[] parameterTypes = m.getParameterTypes();</span>
<span class="line-modified">!                 assertTrue(parameterTypes.length == 1);</span>
<span class="line-modified">!                 assertTrue(types.remove(parameterTypes[0].getName()));</span>
<span class="line-added">+             }</span>
          }
          assertTrue(types.isEmpty());
  
          N n = new BridgeMethod()::moo; //instance reference
          assertTrue( n.m().equals(&quot;moo&quot;) );
</pre>
<center><a href="../lambdaExpression/LambdaTest6.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../mostSpecific/StructuralMostSpecificTest.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>