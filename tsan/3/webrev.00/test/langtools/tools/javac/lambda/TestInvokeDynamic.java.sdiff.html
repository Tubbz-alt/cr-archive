<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/langtools/tools/javac/lambda/TestInvokeDynamic.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="TestBootstrapMethodsCount.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="TestLambdaToMethodStats.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/langtools/tools/javac/lambda/TestInvokeDynamic.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @bug 7194586 8003280 8006694 8010404 8129962
 27  * @summary Add lambda tests
 28  *  Add back-end support for invokedynamic
 29  *  temporarily workaround combo tests are causing time out in several platforms
 30  * @library /tools/javac/lib
 31  * @modules jdk.jdeps/com.sun.tools.classfile
 32  *          jdk.compiler/com.sun.tools.javac.api
 33  *          jdk.compiler/com.sun.tools.javac.code
<span class="line-modified"> 34  *          jdk.compiler/com.sun.tools.javac.comp</span>
<span class="line-removed"> 35  *          jdk.compiler/com.sun.tools.javac.main</span>
 36  *          jdk.compiler/com.sun.tools.javac.jvm
 37  *          jdk.compiler/com.sun.tools.javac.tree
 38  *          jdk.compiler/com.sun.tools.javac.util
 39  * @build combo.ComboTestHelper
 40  * @run main TestInvokeDynamic
 41  */
 42 
 43 import java.io.IOException;
 44 import java.io.InputStream;
 45 
 46 import javax.tools.JavaFileObject;
 47 
 48 import com.sun.source.tree.MethodInvocationTree;
 49 import com.sun.source.tree.MethodTree;
 50 import com.sun.source.util.TaskEvent;
 51 import com.sun.source.util.TaskListener;
 52 import com.sun.source.util.TreeScanner;
 53 
 54 import com.sun.tools.classfile.Attribute;
 55 import com.sun.tools.classfile.BootstrapMethods_attribute;
 56 import com.sun.tools.classfile.ClassFile;
 57 import com.sun.tools.classfile.Code_attribute;
 58 import com.sun.tools.classfile.ConstantPool.*;
 59 import com.sun.tools.classfile.Instruction;
 60 import com.sun.tools.classfile.LineNumberTable_attribute;
 61 import com.sun.tools.classfile.Method;
 62 
<span class="line-removed"> 63 import com.sun.tools.javac.api.JavacTaskImpl;</span>
 64 import com.sun.tools.javac.code.Symbol;
<span class="line-modified"> 65 import com.sun.tools.javac.code.Symbol.MethodSymbol;</span>
 66 import com.sun.tools.javac.code.Symtab;


 67 import com.sun.tools.javac.code.Types;
<span class="line-modified"> 68 import com.sun.tools.javac.jvm.Pool;</span>
 69 import com.sun.tools.javac.tree.JCTree.JCMethodInvocation;
 70 import com.sun.tools.javac.tree.JCTree.JCMethodDecl;
 71 import com.sun.tools.javac.tree.JCTree.JCIdent;
<span class="line-removed"> 72 import com.sun.tools.javac.util.Context;</span>
 73 import com.sun.tools.javac.util.Names;
 74 
 75 import combo.ComboParameter;
<span class="line-removed"> 76 import combo.ComboTask;</span>
 77 import combo.ComboTestHelper;
 78 import combo.ComboInstance;
 79 import combo.ComboTask.Result;
 80 
<span class="line-removed"> 81 import static com.sun.tools.javac.jvm.ClassFile.*;</span>
<span class="line-removed"> 82 </span>
 83 public class TestInvokeDynamic extends ComboInstance&lt;TestInvokeDynamic&gt; {
 84 
 85     enum StaticArgumentKind implements ComboParameter {
 86         STRING(&quot;Hello!&quot;, &quot;String&quot;, &quot;Ljava/lang/String;&quot;) {
 87             @Override
 88             boolean check(CPInfo cpInfo) throws Exception {
 89                 return (cpInfo instanceof CONSTANT_String_info) &amp;&amp;
 90                         ((CONSTANT_String_info)cpInfo).getString()
 91                         .equals(value);
 92             }
 93         },
 94         CLASS(null, &quot;Class&lt;?&gt;&quot;, &quot;Ljava/lang/Class;&quot;) {
 95             @Override
 96             boolean check(CPInfo cpInfo) throws Exception {
 97                 return (cpInfo instanceof CONSTANT_Class_info) &amp;&amp;
 98                         ((CONSTANT_Class_info)cpInfo).getName()
 99                         .equals(&quot;java/lang/String&quot;);
100             }
101         },
102         INTEGER(1, &quot;int&quot;, &quot;I&quot;) {
</pre>
<hr />
<pre>
151             boolean check(CPInfo cpInfo) throws Exception {
152                 return (cpInfo instanceof CONSTANT_MethodType_info) &amp;&amp;
153                         ((CONSTANT_MethodType_info)cpInfo).getType()
154                         .equals(&quot;()Ljava/lang/Object;&quot;);
155             }
156         };
157 
158         Object value;
159         String sourceTypeStr;
160         String bytecodeTypeStr;
161 
162         StaticArgumentKind(Object value, String sourceTypeStr,
163                 String bytecodeTypeStr) {
164             this.value = value;
165             this.sourceTypeStr = sourceTypeStr;
166             this.bytecodeTypeStr = bytecodeTypeStr;
167         }
168 
169         abstract boolean check(CPInfo cpInfo) throws Exception;
170 
<span class="line-modified">171         Object getValue(Symtab syms, Names names, Types types) {</span>
172             switch (this) {
173                 case STRING:

174                 case INTEGER:

175                 case LONG:

176                 case FLOAT:

177                 case DOUBLE:
<span class="line-modified">178                     return value;</span>
179                 case CLASS:
<span class="line-modified">180                     return syms.stringType.tsym;</span>
181                 case METHOD_HANDLE:
<span class="line-modified">182                     return new Pool.MethodHandle(REF_invokeVirtual,</span>
<span class="line-removed">183                             syms.arrayCloneMethod, types);</span>
184                 case METHOD_TYPE:
<span class="line-modified">185                     return syms.arrayCloneMethod.type;</span>
186                 default:
187                     throw new AssertionError();
188             }
189         }
190 
191         @Override
192         public String expand(String optParameter) {
193             return sourceTypeStr;
194         }
195     }
196 
197     enum StaticArgumentsArity implements ComboParameter {
198         ZERO(0, &quot;&quot;),
199         ONE(1, &quot;,#{SARG[0]} s1&quot;),
200         TWO(2, &quot;,#{SARG[0]} s1, #{SARG[1]} s2&quot;),
201         THREE(3, &quot;,#{SARG[0]} s1, #{SARG[1]} s2, #{SARG[2]} s3&quot;);
202 
203         int arity;
204         String argsTemplate;
205 
</pre>
<hr />
<pre>
377             }
378         } catch (Exception e) {
379             e.printStackTrace();
380             fail(&quot;error reading classfile: &quot; + res.compilationInfo());
381             return;
382         }
383     }
384 
385     String asBSMSignatureString() {
386         StringBuilder buf = new StringBuilder();
387         buf.append(&quot;(Ljava/lang/invoke/MethodHandles$Lookup;Ljava/lang/String;Ljava/lang/invoke/MethodType;&quot;);
388         for (int i = 0 ; i &lt; arity.arity ; i++) {
389             buf.append(saks[i].bytecodeTypeStr);
390         }
391         buf.append(&quot;)Ljava/lang/invoke/CallSite;&quot;);
392         return buf.toString();
393     }
394 
395     class Indifier extends TreeScanner&lt;Void, Void&gt; implements TaskListener {
396 
<span class="line-modified">397         MethodSymbol bsm;</span>
398         Symtab syms;
399         Names names;
400         Types types;
401 
402         Indifier(Symtab syms, Names names, Types types) {
403             this.syms = syms;
404             this.names = names;
405             this.types = types;
406         }
407 
408         @Override
409         public void started(TaskEvent e) {
410             //do nothing
411         }
412 
413         @Override
414         public void finished(TaskEvent e) {
415             if (e.getKind() == TaskEvent.Kind.ANALYZE) {
416                 scan(e.getCompilationUnit(), null);
417             }
418         }
419 
420         @Override
421         public Void visitMethodInvocation(MethodInvocationTree node, Void p) {
422             super.visitMethodInvocation(node, p);
423             JCMethodInvocation apply = (JCMethodInvocation)node;
424             JCIdent ident = (JCIdent)apply.meth;
425             Symbol oldSym = ident.sym;
426             if (!oldSym.isConstructor()) {
<span class="line-modified">427                 Object[] staticArgs = new Object[arity.arity];</span>
428                 for (int i = 0; i &lt; arity.arity ; i++) {
<span class="line-modified">429                     staticArgs[i] = saks[i].getValue(syms, names, types);</span>
430                 }
431                 ident.sym = new Symbol.DynamicMethodSymbol(oldSym.name,
<span class="line-modified">432                         oldSym.owner, REF_invokeStatic, bsm, oldSym.type, staticArgs);</span>
433             }
434             return null;
435         }
436 
437         @Override
438         public Void visitMethod(MethodTree node, Void p) {
439             super.visitMethod(node, p);
440             if (node.getName().toString().equals(&quot;bsm&quot;)) {
<span class="line-modified">441                 bsm = ((JCMethodDecl)node).sym;</span>
442             }
443             return null;
444         }
445     }
446 }
</pre>
</td>
<td>
<hr />
<pre>
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @bug 7194586 8003280 8006694 8010404 8129962
 27  * @summary Add lambda tests
 28  *  Add back-end support for invokedynamic
 29  *  temporarily workaround combo tests are causing time out in several platforms
 30  * @library /tools/javac/lib
 31  * @modules jdk.jdeps/com.sun.tools.classfile
 32  *          jdk.compiler/com.sun.tools.javac.api
 33  *          jdk.compiler/com.sun.tools.javac.code
<span class="line-modified"> 34  *          jdk.compiler/com.sun.tools.javac.file</span>

 35  *          jdk.compiler/com.sun.tools.javac.jvm
 36  *          jdk.compiler/com.sun.tools.javac.tree
 37  *          jdk.compiler/com.sun.tools.javac.util
 38  * @build combo.ComboTestHelper
 39  * @run main TestInvokeDynamic
 40  */
 41 
 42 import java.io.IOException;
 43 import java.io.InputStream;
 44 
 45 import javax.tools.JavaFileObject;
 46 
 47 import com.sun.source.tree.MethodInvocationTree;
 48 import com.sun.source.tree.MethodTree;
 49 import com.sun.source.util.TaskEvent;
 50 import com.sun.source.util.TaskListener;
 51 import com.sun.source.util.TreeScanner;
 52 
 53 import com.sun.tools.classfile.Attribute;
 54 import com.sun.tools.classfile.BootstrapMethods_attribute;
 55 import com.sun.tools.classfile.ClassFile;
 56 import com.sun.tools.classfile.Code_attribute;
 57 import com.sun.tools.classfile.ConstantPool.*;
 58 import com.sun.tools.classfile.Instruction;
 59 import com.sun.tools.classfile.LineNumberTable_attribute;
 60 import com.sun.tools.classfile.Method;
 61 

 62 import com.sun.tools.javac.code.Symbol;
<span class="line-modified"> 63 import com.sun.tools.javac.code.Symbol.MethodHandleSymbol;</span>
 64 import com.sun.tools.javac.code.Symtab;
<span class="line-added"> 65 import com.sun.tools.javac.code.Type.ClassType;</span>
<span class="line-added"> 66 import com.sun.tools.javac.code.Type.MethodType;</span>
 67 import com.sun.tools.javac.code.Types;
<span class="line-modified"> 68 import com.sun.tools.javac.jvm.PoolConstant.LoadableConstant;</span>
 69 import com.sun.tools.javac.tree.JCTree.JCMethodInvocation;
 70 import com.sun.tools.javac.tree.JCTree.JCMethodDecl;
 71 import com.sun.tools.javac.tree.JCTree.JCIdent;

 72 import com.sun.tools.javac.util.Names;
 73 
 74 import combo.ComboParameter;

 75 import combo.ComboTestHelper;
 76 import combo.ComboInstance;
 77 import combo.ComboTask.Result;
 78 


 79 public class TestInvokeDynamic extends ComboInstance&lt;TestInvokeDynamic&gt; {
 80 
 81     enum StaticArgumentKind implements ComboParameter {
 82         STRING(&quot;Hello!&quot;, &quot;String&quot;, &quot;Ljava/lang/String;&quot;) {
 83             @Override
 84             boolean check(CPInfo cpInfo) throws Exception {
 85                 return (cpInfo instanceof CONSTANT_String_info) &amp;&amp;
 86                         ((CONSTANT_String_info)cpInfo).getString()
 87                         .equals(value);
 88             }
 89         },
 90         CLASS(null, &quot;Class&lt;?&gt;&quot;, &quot;Ljava/lang/Class;&quot;) {
 91             @Override
 92             boolean check(CPInfo cpInfo) throws Exception {
 93                 return (cpInfo instanceof CONSTANT_Class_info) &amp;&amp;
 94                         ((CONSTANT_Class_info)cpInfo).getName()
 95                         .equals(&quot;java/lang/String&quot;);
 96             }
 97         },
 98         INTEGER(1, &quot;int&quot;, &quot;I&quot;) {
</pre>
<hr />
<pre>
147             boolean check(CPInfo cpInfo) throws Exception {
148                 return (cpInfo instanceof CONSTANT_MethodType_info) &amp;&amp;
149                         ((CONSTANT_MethodType_info)cpInfo).getType()
150                         .equals(&quot;()Ljava/lang/Object;&quot;);
151             }
152         };
153 
154         Object value;
155         String sourceTypeStr;
156         String bytecodeTypeStr;
157 
158         StaticArgumentKind(Object value, String sourceTypeStr,
159                 String bytecodeTypeStr) {
160             this.value = value;
161             this.sourceTypeStr = sourceTypeStr;
162             this.bytecodeTypeStr = bytecodeTypeStr;
163         }
164 
165         abstract boolean check(CPInfo cpInfo) throws Exception;
166 
<span class="line-modified">167         LoadableConstant getValue(Symtab syms) {</span>
168             switch (this) {
169                 case STRING:
<span class="line-added">170                     return LoadableConstant.String((String)value);</span>
171                 case INTEGER:
<span class="line-added">172                     return LoadableConstant.Int((Integer)value);</span>
173                 case LONG:
<span class="line-added">174                     return LoadableConstant.Long((Long)value);</span>
175                 case FLOAT:
<span class="line-added">176                     return LoadableConstant.Float((Float)value);</span>
177                 case DOUBLE:
<span class="line-modified">178                     return LoadableConstant.Double((Double)value);</span>
179                 case CLASS:
<span class="line-modified">180                     return (ClassType)syms.stringType;</span>
181                 case METHOD_HANDLE:
<span class="line-modified">182                     return syms.arrayCloneMethod.asHandle();</span>

183                 case METHOD_TYPE:
<span class="line-modified">184                     return ((MethodType)syms.arrayCloneMethod.type);</span>
185                 default:
186                     throw new AssertionError();
187             }
188         }
189 
190         @Override
191         public String expand(String optParameter) {
192             return sourceTypeStr;
193         }
194     }
195 
196     enum StaticArgumentsArity implements ComboParameter {
197         ZERO(0, &quot;&quot;),
198         ONE(1, &quot;,#{SARG[0]} s1&quot;),
199         TWO(2, &quot;,#{SARG[0]} s1, #{SARG[1]} s2&quot;),
200         THREE(3, &quot;,#{SARG[0]} s1, #{SARG[1]} s2, #{SARG[2]} s3&quot;);
201 
202         int arity;
203         String argsTemplate;
204 
</pre>
<hr />
<pre>
376             }
377         } catch (Exception e) {
378             e.printStackTrace();
379             fail(&quot;error reading classfile: &quot; + res.compilationInfo());
380             return;
381         }
382     }
383 
384     String asBSMSignatureString() {
385         StringBuilder buf = new StringBuilder();
386         buf.append(&quot;(Ljava/lang/invoke/MethodHandles$Lookup;Ljava/lang/String;Ljava/lang/invoke/MethodType;&quot;);
387         for (int i = 0 ; i &lt; arity.arity ; i++) {
388             buf.append(saks[i].bytecodeTypeStr);
389         }
390         buf.append(&quot;)Ljava/lang/invoke/CallSite;&quot;);
391         return buf.toString();
392     }
393 
394     class Indifier extends TreeScanner&lt;Void, Void&gt; implements TaskListener {
395 
<span class="line-modified">396         MethodHandleSymbol bsm;</span>
397         Symtab syms;
398         Names names;
399         Types types;
400 
401         Indifier(Symtab syms, Names names, Types types) {
402             this.syms = syms;
403             this.names = names;
404             this.types = types;
405         }
406 
407         @Override
408         public void started(TaskEvent e) {
409             //do nothing
410         }
411 
412         @Override
413         public void finished(TaskEvent e) {
414             if (e.getKind() == TaskEvent.Kind.ANALYZE) {
415                 scan(e.getCompilationUnit(), null);
416             }
417         }
418 
419         @Override
420         public Void visitMethodInvocation(MethodInvocationTree node, Void p) {
421             super.visitMethodInvocation(node, p);
422             JCMethodInvocation apply = (JCMethodInvocation)node;
423             JCIdent ident = (JCIdent)apply.meth;
424             Symbol oldSym = ident.sym;
425             if (!oldSym.isConstructor()) {
<span class="line-modified">426                 LoadableConstant[] staticArgs = new LoadableConstant[arity.arity];</span>
427                 for (int i = 0; i &lt; arity.arity ; i++) {
<span class="line-modified">428                     staticArgs[i] = saks[i].getValue(syms);</span>
429                 }
430                 ident.sym = new Symbol.DynamicMethodSymbol(oldSym.name,
<span class="line-modified">431                         oldSym.owner, bsm, oldSym.type, staticArgs);</span>
432             }
433             return null;
434         }
435 
436         @Override
437         public Void visitMethod(MethodTree node, Void p) {
438             super.visitMethod(node, p);
439             if (node.getName().toString().equals(&quot;bsm&quot;)) {
<span class="line-modified">440                 bsm = ((JCMethodDecl)node).sym.asHandle();</span>
441             }
442             return null;
443         }
444     }
445 }
</pre>
</td>
</tr>
</table>
<center><a href="TestBootstrapMethodsCount.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="TestLambdaToMethodStats.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>