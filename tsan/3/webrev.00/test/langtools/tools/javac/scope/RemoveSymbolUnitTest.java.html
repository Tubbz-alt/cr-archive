<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New test/langtools/tools/javac/scope/RemoveSymbolUnitTest.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2015, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @bug 8080842
 27  * @summary Ensure Scope impl can cope with remove() when a field and method share the name.
 28  * @modules jdk.compiler/com.sun.tools.javac.code
 29  *          jdk.compiler/com.sun.tools.javac.file
 30  *          jdk.compiler/com.sun.tools.javac.util
 31  */
 32 
 33 import com.sun.tools.javac.util.*;
 34 import com.sun.tools.javac.code.*;
 35 import com.sun.tools.javac.code.Scope.*;
 36 import com.sun.tools.javac.code.Symbol;
 37 import com.sun.tools.javac.code.Symbol.*;
 38 import com.sun.tools.javac.file.JavacFileManager;
 39 import java.util.ArrayList;
 40 import java.util.Arrays;
 41 import java.util.Collections;
 42 import java.util.List;
 43 
 44 public class RemoveSymbolUnitTest {
 45 
 46     Context context;
 47     Names names;
 48     Symtab symtab;
 49 
 50     public static void main(String... args) throws Exception {
 51         new RemoveSymbolUnitTest().run();
 52     }
 53 
 54     public void run() {
 55         context = new Context();
 56         JavacFileManager.preRegister(context); // required by ClassReader which is required by Symtab
 57         names = Names.instance(context);
 58         symtab = Symtab.instance(context);
 59 
 60         Name hasNext =  names.fromString(&quot;hasNext&quot;);
 61         ClassSymbol clazz = new ClassSymbol(0,
 62                                             names.fromString(&quot;X&quot;),
 63                                             Type.noType,
 64                                             symtab.unnamedModule.unnamedPackage);
 65 
 66         VarSymbol v = new VarSymbol(0, hasNext, Type.noType, clazz);
 67         MethodSymbol m = new MethodSymbol(0, hasNext, Type.noType, clazz);
 68 
 69         // Try enter and remove in different shuffled combinations.
 70         // working with fresh scope each time.
 71         WriteableScope cs = writeableScope(clazz, v, m);
 72         cs.remove(v);
 73         Symbol s = cs.findFirst(hasNext);
 74         if (s != m)
 75             throw new AssertionError(&quot;Wrong symbol&quot;);
 76 
 77         cs = writeableScope(clazz, m, v);
 78         cs.remove(v);
 79         s = cs.findFirst(hasNext);
 80         if (s != m)
 81             throw new AssertionError(&quot;Wrong symbol&quot;);
 82 
 83         cs = writeableScope(clazz, v, m);
 84         cs.remove(m);
 85         s = cs.findFirst(hasNext);
 86         if (s != v)
 87             throw new AssertionError(&quot;Wrong symbol&quot;);
 88 
 89         cs = writeableScope(clazz);
 90         cs.enter(m);
 91         cs.enter(v);
 92         cs.remove(m);
 93         s = cs.findFirst(hasNext);
 94         if (s != v)
 95             throw new AssertionError(&quot;Wrong symbol&quot;);
 96 
 97         // Test multiple removals in the same scope.
 98         VarSymbol v1 = new VarSymbol(0, names.fromString(&quot;name1&quot;), Type.noType, clazz);
 99         VarSymbol v2 = new VarSymbol(0, names.fromString(&quot;name2&quot;), Type.noType, clazz);
100         VarSymbol v3 = new VarSymbol(0, names.fromString(&quot;name3&quot;), Type.noType, clazz);
101         VarSymbol v4 = new VarSymbol(0, names.fromString(&quot;name4&quot;), Type.noType, clazz);
102 
103         cs = writeableScope(clazz, v1, v2, v3, v4);
104         cs.remove(v2);
105         assertRemainingSymbols(cs, v1, v3, v4);
106         cs.remove(v3);
107         assertRemainingSymbols(cs, v1, v4);
108         cs.remove(v1);
109         assertRemainingSymbols(cs, v4);
110         cs.remove(v4);
111         assertRemainingSymbols(cs);
112     }
113 
114     private WriteableScope writeableScope(ClassSymbol classSymbol, Symbol... symbols) {
115         WriteableScope cs = WriteableScope.create(classSymbol);
116         for (Symbol symbol : symbols) {
117             cs.enter(symbol);
118         }
119         return cs;
120     }
121 
122     private void assertRemainingSymbols(WriteableScope cs, Symbol... symbols) {
123       List&lt;Symbol&gt; expectedSymbols = Arrays.asList(symbols);
124       List&lt;Symbol&gt; actualSymbols = new ArrayList&lt;&gt;();
125       cs.getSymbols().forEach(symbol -&gt; actualSymbols.add(symbol));
126       // The symbols are stored in reverse order
127       Collections.reverse(actualSymbols);
128       if (!actualSymbols.equals(expectedSymbols)) {
129           throw new AssertionError(
130               String.format(&quot;Wrong symbols: %s. Expected %s&quot;, actualSymbols, expectedSymbols));
131       }
132     }
133 }
    </pre>
  </body>
</html>