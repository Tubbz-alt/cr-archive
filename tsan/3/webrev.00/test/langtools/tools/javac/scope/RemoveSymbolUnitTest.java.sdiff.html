<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/langtools/tools/javac/scope/RemoveSymbolUnitTest.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="../resolve/BitWiseOperators.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../switchexpr/BlockExpression.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/langtools/tools/javac/scope/RemoveSymbolUnitTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @bug 8080842
 27  * @summary Ensure Scope impl can cope with remove() when a field and method share the name.
 28  * @modules jdk.compiler/com.sun.tools.javac.code
 29  *          jdk.compiler/com.sun.tools.javac.file
 30  *          jdk.compiler/com.sun.tools.javac.util
 31  */
 32 
 33 import com.sun.tools.javac.util.*;
 34 import com.sun.tools.javac.code.*;
 35 import com.sun.tools.javac.code.Scope.*;

 36 import com.sun.tools.javac.code.Symbol.*;
 37 import com.sun.tools.javac.file.JavacFileManager;




 38 
 39 public class RemoveSymbolUnitTest {
 40 
 41     Context context;
 42     Names names;
 43     Symtab symtab;
 44 
 45     public static void main(String... args) throws Exception {
 46         new RemoveSymbolUnitTest().run();
 47     }
 48 
 49     public void run() {
 50         context = new Context();
 51         JavacFileManager.preRegister(context); // required by ClassReader which is required by Symtab
 52         names = Names.instance(context);
 53         symtab = Symtab.instance(context);
 54 
 55         Name hasNext =  names.fromString(&quot;hasNext&quot;);
 56         ClassSymbol clazz = new ClassSymbol(0,
 57                                             names.fromString(&quot;X&quot;),
 58                                             Type.noType,
 59                                             symtab.unnamedModule.unnamedPackage);
 60 
 61         VarSymbol v = new VarSymbol(0, hasNext, Type.noType, clazz);
 62         MethodSymbol m = new MethodSymbol(0, hasNext, Type.noType, clazz);
 63 
 64         // Try enter and remove in different shuffled combinations.
 65         // working with fresh scope each time.
<span class="line-modified"> 66         WriteableScope cs = WriteableScope.create(clazz);</span>
<span class="line-removed"> 67         cs.enter(v);</span>
<span class="line-removed"> 68         cs.enter(m);</span>
 69         cs.remove(v);
 70         Symbol s = cs.findFirst(hasNext);
 71         if (s != m)
 72             throw new AssertionError(&quot;Wrong symbol&quot;);
 73 
<span class="line-modified"> 74         cs = WriteableScope.create(clazz);</span>
<span class="line-removed"> 75         cs.enter(m);</span>
<span class="line-removed"> 76         cs.enter(v);</span>
 77         cs.remove(v);
 78         s = cs.findFirst(hasNext);
 79         if (s != m)
 80             throw new AssertionError(&quot;Wrong symbol&quot;);
 81 
<span class="line-modified"> 82         cs = WriteableScope.create(clazz);</span>
<span class="line-removed"> 83         cs.enter(v);</span>
<span class="line-removed"> 84         cs.enter(m);</span>
 85         cs.remove(m);
 86         s = cs.findFirst(hasNext);
 87         if (s != v)
 88             throw new AssertionError(&quot;Wrong symbol&quot;);
 89 
<span class="line-modified"> 90         cs = WriteableScope.create(clazz);</span>
 91         cs.enter(m);
 92         cs.enter(v);
 93         cs.remove(m);
 94         s = cs.findFirst(hasNext);
 95         if (s != v)
 96             throw new AssertionError(&quot;Wrong symbol&quot;);




































 97     }
 98 }
</pre>
</td>
<td>
<hr />
<pre>
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @bug 8080842
 27  * @summary Ensure Scope impl can cope with remove() when a field and method share the name.
 28  * @modules jdk.compiler/com.sun.tools.javac.code
 29  *          jdk.compiler/com.sun.tools.javac.file
 30  *          jdk.compiler/com.sun.tools.javac.util
 31  */
 32 
 33 import com.sun.tools.javac.util.*;
 34 import com.sun.tools.javac.code.*;
 35 import com.sun.tools.javac.code.Scope.*;
<span class="line-added"> 36 import com.sun.tools.javac.code.Symbol;</span>
 37 import com.sun.tools.javac.code.Symbol.*;
 38 import com.sun.tools.javac.file.JavacFileManager;
<span class="line-added"> 39 import java.util.ArrayList;</span>
<span class="line-added"> 40 import java.util.Arrays;</span>
<span class="line-added"> 41 import java.util.Collections;</span>
<span class="line-added"> 42 import java.util.List;</span>
 43 
 44 public class RemoveSymbolUnitTest {
 45 
 46     Context context;
 47     Names names;
 48     Symtab symtab;
 49 
 50     public static void main(String... args) throws Exception {
 51         new RemoveSymbolUnitTest().run();
 52     }
 53 
 54     public void run() {
 55         context = new Context();
 56         JavacFileManager.preRegister(context); // required by ClassReader which is required by Symtab
 57         names = Names.instance(context);
 58         symtab = Symtab.instance(context);
 59 
 60         Name hasNext =  names.fromString(&quot;hasNext&quot;);
 61         ClassSymbol clazz = new ClassSymbol(0,
 62                                             names.fromString(&quot;X&quot;),
 63                                             Type.noType,
 64                                             symtab.unnamedModule.unnamedPackage);
 65 
 66         VarSymbol v = new VarSymbol(0, hasNext, Type.noType, clazz);
 67         MethodSymbol m = new MethodSymbol(0, hasNext, Type.noType, clazz);
 68 
 69         // Try enter and remove in different shuffled combinations.
 70         // working with fresh scope each time.
<span class="line-modified"> 71         WriteableScope cs = writeableScope(clazz, v, m);</span>


 72         cs.remove(v);
 73         Symbol s = cs.findFirst(hasNext);
 74         if (s != m)
 75             throw new AssertionError(&quot;Wrong symbol&quot;);
 76 
<span class="line-modified"> 77         cs = writeableScope(clazz, m, v);</span>


 78         cs.remove(v);
 79         s = cs.findFirst(hasNext);
 80         if (s != m)
 81             throw new AssertionError(&quot;Wrong symbol&quot;);
 82 
<span class="line-modified"> 83         cs = writeableScope(clazz, v, m);</span>


 84         cs.remove(m);
 85         s = cs.findFirst(hasNext);
 86         if (s != v)
 87             throw new AssertionError(&quot;Wrong symbol&quot;);
 88 
<span class="line-modified"> 89         cs = writeableScope(clazz);</span>
 90         cs.enter(m);
 91         cs.enter(v);
 92         cs.remove(m);
 93         s = cs.findFirst(hasNext);
 94         if (s != v)
 95             throw new AssertionError(&quot;Wrong symbol&quot;);
<span class="line-added"> 96 </span>
<span class="line-added"> 97         // Test multiple removals in the same scope.</span>
<span class="line-added"> 98         VarSymbol v1 = new VarSymbol(0, names.fromString(&quot;name1&quot;), Type.noType, clazz);</span>
<span class="line-added"> 99         VarSymbol v2 = new VarSymbol(0, names.fromString(&quot;name2&quot;), Type.noType, clazz);</span>
<span class="line-added">100         VarSymbol v3 = new VarSymbol(0, names.fromString(&quot;name3&quot;), Type.noType, clazz);</span>
<span class="line-added">101         VarSymbol v4 = new VarSymbol(0, names.fromString(&quot;name4&quot;), Type.noType, clazz);</span>
<span class="line-added">102 </span>
<span class="line-added">103         cs = writeableScope(clazz, v1, v2, v3, v4);</span>
<span class="line-added">104         cs.remove(v2);</span>
<span class="line-added">105         assertRemainingSymbols(cs, v1, v3, v4);</span>
<span class="line-added">106         cs.remove(v3);</span>
<span class="line-added">107         assertRemainingSymbols(cs, v1, v4);</span>
<span class="line-added">108         cs.remove(v1);</span>
<span class="line-added">109         assertRemainingSymbols(cs, v4);</span>
<span class="line-added">110         cs.remove(v4);</span>
<span class="line-added">111         assertRemainingSymbols(cs);</span>
<span class="line-added">112     }</span>
<span class="line-added">113 </span>
<span class="line-added">114     private WriteableScope writeableScope(ClassSymbol classSymbol, Symbol... symbols) {</span>
<span class="line-added">115         WriteableScope cs = WriteableScope.create(classSymbol);</span>
<span class="line-added">116         for (Symbol symbol : symbols) {</span>
<span class="line-added">117             cs.enter(symbol);</span>
<span class="line-added">118         }</span>
<span class="line-added">119         return cs;</span>
<span class="line-added">120     }</span>
<span class="line-added">121 </span>
<span class="line-added">122     private void assertRemainingSymbols(WriteableScope cs, Symbol... symbols) {</span>
<span class="line-added">123       List&lt;Symbol&gt; expectedSymbols = Arrays.asList(symbols);</span>
<span class="line-added">124       List&lt;Symbol&gt; actualSymbols = new ArrayList&lt;&gt;();</span>
<span class="line-added">125       cs.getSymbols().forEach(symbol -&gt; actualSymbols.add(symbol));</span>
<span class="line-added">126       // The symbols are stored in reverse order</span>
<span class="line-added">127       Collections.reverse(actualSymbols);</span>
<span class="line-added">128       if (!actualSymbols.equals(expectedSymbols)) {</span>
<span class="line-added">129           throw new AssertionError(</span>
<span class="line-added">130               String.format(&quot;Wrong symbols: %s. Expected %s&quot;, actualSymbols, expectedSymbols));</span>
<span class="line-added">131       }</span>
132     }
133 }
</pre>
</td>
</tr>
</table>
<center><a href="../resolve/BitWiseOperators.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../switchexpr/BlockExpression.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>