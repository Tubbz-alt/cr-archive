<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/langtools/tools/javac/scope/RemoveSymbolUnitTest.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
    <script type="text/javascript" src="../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 2015, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @bug 8080842
 27  * @summary Ensure Scope impl can cope with remove() when a field and method share the name.
 28  * @modules jdk.compiler/com.sun.tools.javac.code
 29  *          jdk.compiler/com.sun.tools.javac.file
 30  *          jdk.compiler/com.sun.tools.javac.util
 31  */
 32 
 33 import com.sun.tools.javac.util.*;
 34 import com.sun.tools.javac.code.*;
 35 import com.sun.tools.javac.code.Scope.*;
<a name="1" id="anc1"></a><span class="line-added"> 36 import com.sun.tools.javac.code.Symbol;</span>
 37 import com.sun.tools.javac.code.Symbol.*;
 38 import com.sun.tools.javac.file.JavacFileManager;
<a name="2" id="anc2"></a><span class="line-added"> 39 import java.util.ArrayList;</span>
<span class="line-added"> 40 import java.util.Arrays;</span>
<span class="line-added"> 41 import java.util.Collections;</span>
<span class="line-added"> 42 import java.util.List;</span>
 43 
 44 public class RemoveSymbolUnitTest {
 45 
 46     Context context;
 47     Names names;
 48     Symtab symtab;
 49 
 50     public static void main(String... args) throws Exception {
 51         new RemoveSymbolUnitTest().run();
 52     }
 53 
 54     public void run() {
 55         context = new Context();
 56         JavacFileManager.preRegister(context); // required by ClassReader which is required by Symtab
 57         names = Names.instance(context);
 58         symtab = Symtab.instance(context);
 59 
 60         Name hasNext =  names.fromString(&quot;hasNext&quot;);
 61         ClassSymbol clazz = new ClassSymbol(0,
 62                                             names.fromString(&quot;X&quot;),
 63                                             Type.noType,
 64                                             symtab.unnamedModule.unnamedPackage);
 65 
 66         VarSymbol v = new VarSymbol(0, hasNext, Type.noType, clazz);
 67         MethodSymbol m = new MethodSymbol(0, hasNext, Type.noType, clazz);
 68 
 69         // Try enter and remove in different shuffled combinations.
 70         // working with fresh scope each time.
<a name="3" id="anc3"></a><span class="line-modified"> 71         WriteableScope cs = writeableScope(clazz, v, m);</span>


 72         cs.remove(v);
 73         Symbol s = cs.findFirst(hasNext);
 74         if (s != m)
 75             throw new AssertionError(&quot;Wrong symbol&quot;);
 76 
<a name="4" id="anc4"></a><span class="line-modified"> 77         cs = writeableScope(clazz, m, v);</span>


 78         cs.remove(v);
 79         s = cs.findFirst(hasNext);
 80         if (s != m)
 81             throw new AssertionError(&quot;Wrong symbol&quot;);
 82 
<a name="5" id="anc5"></a><span class="line-modified"> 83         cs = writeableScope(clazz, v, m);</span>


 84         cs.remove(m);
 85         s = cs.findFirst(hasNext);
 86         if (s != v)
 87             throw new AssertionError(&quot;Wrong symbol&quot;);
 88 
<a name="6" id="anc6"></a><span class="line-modified"> 89         cs = writeableScope(clazz);</span>
 90         cs.enter(m);
 91         cs.enter(v);
 92         cs.remove(m);
 93         s = cs.findFirst(hasNext);
 94         if (s != v)
 95             throw new AssertionError(&quot;Wrong symbol&quot;);
<a name="7" id="anc7"></a><span class="line-added"> 96 </span>
<span class="line-added"> 97         // Test multiple removals in the same scope.</span>
<span class="line-added"> 98         VarSymbol v1 = new VarSymbol(0, names.fromString(&quot;name1&quot;), Type.noType, clazz);</span>
<span class="line-added"> 99         VarSymbol v2 = new VarSymbol(0, names.fromString(&quot;name2&quot;), Type.noType, clazz);</span>
<span class="line-added">100         VarSymbol v3 = new VarSymbol(0, names.fromString(&quot;name3&quot;), Type.noType, clazz);</span>
<span class="line-added">101         VarSymbol v4 = new VarSymbol(0, names.fromString(&quot;name4&quot;), Type.noType, clazz);</span>
<span class="line-added">102 </span>
<span class="line-added">103         cs = writeableScope(clazz, v1, v2, v3, v4);</span>
<span class="line-added">104         cs.remove(v2);</span>
<span class="line-added">105         assertRemainingSymbols(cs, v1, v3, v4);</span>
<span class="line-added">106         cs.remove(v3);</span>
<span class="line-added">107         assertRemainingSymbols(cs, v1, v4);</span>
<span class="line-added">108         cs.remove(v1);</span>
<span class="line-added">109         assertRemainingSymbols(cs, v4);</span>
<span class="line-added">110         cs.remove(v4);</span>
<span class="line-added">111         assertRemainingSymbols(cs);</span>
<span class="line-added">112     }</span>
<span class="line-added">113 </span>
<span class="line-added">114     private WriteableScope writeableScope(ClassSymbol classSymbol, Symbol... symbols) {</span>
<span class="line-added">115         WriteableScope cs = WriteableScope.create(classSymbol);</span>
<span class="line-added">116         for (Symbol symbol : symbols) {</span>
<span class="line-added">117             cs.enter(symbol);</span>
<span class="line-added">118         }</span>
<span class="line-added">119         return cs;</span>
<span class="line-added">120     }</span>
<span class="line-added">121 </span>
<span class="line-added">122     private void assertRemainingSymbols(WriteableScope cs, Symbol... symbols) {</span>
<span class="line-added">123       List&lt;Symbol&gt; expectedSymbols = Arrays.asList(symbols);</span>
<span class="line-added">124       List&lt;Symbol&gt; actualSymbols = new ArrayList&lt;&gt;();</span>
<span class="line-added">125       cs.getSymbols().forEach(symbol -&gt; actualSymbols.add(symbol));</span>
<span class="line-added">126       // The symbols are stored in reverse order</span>
<span class="line-added">127       Collections.reverse(actualSymbols);</span>
<span class="line-added">128       if (!actualSymbols.equals(expectedSymbols)) {</span>
<span class="line-added">129           throw new AssertionError(</span>
<span class="line-added">130               String.format(&quot;Wrong symbols: %s. Expected %s&quot;, actualSymbols, expectedSymbols));</span>
<span class="line-added">131       }</span>
132     }
133 }
<a name="8" id="anc8"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="8" type="hidden" />
</body>
</html>