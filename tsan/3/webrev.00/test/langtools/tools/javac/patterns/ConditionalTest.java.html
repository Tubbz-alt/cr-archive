<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New test/langtools/tools/javac/patterns/ConditionalTest.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2019, 2020, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @bug 8236670
 27  * @summary Verify proper scope of binding related to loops and breaks.
 28  * @library /tools/lib /tools/javac/lib
 29  * @modules
 30  *      java.base/jdk.internal
 31  *      jdk.compiler/com.sun.tools.javac.api
 32  *      jdk.compiler/com.sun.tools.javac.file
 33  *      jdk.compiler/com.sun.tools.javac.main
 34  *      jdk.compiler/com.sun.tools.javac.util
 35  * @build toolbox.ToolBox toolbox.JavacTask
 36  * @build combo.ComboTestHelper
 37  * @compile --enable-preview -source ${jdk.version} ConditionalTest.java
 38  * @run main/othervm --enable-preview ConditionalTest
 39  */
 40 
 41 import combo.ComboInstance;
 42 import combo.ComboParameter;
 43 import combo.ComboTask;
 44 import combo.ComboTestHelper;
 45 import java.nio.file.Path;
 46 import java.nio.file.Paths;
 47 import toolbox.ToolBox;
 48 
 49 public class ConditionalTest extends ComboInstance&lt;ConditionalTest&gt; {
 50     protected ToolBox tb;
 51 
 52     ConditionalTest() {
 53         super();
 54         tb = new ToolBox();
 55     }
 56 
 57     public static void main(String... args) throws Exception {
 58         new ComboTestHelper&lt;ConditionalTest&gt;()
 59                 .withDimension(&quot;COND&quot;, (x, cond) -&gt; x.cond = cond, Pattern.values())
 60                 .withDimension(&quot;TRUE&quot;, (x, trueSec) -&gt; x.trueSec = trueSec, Pattern.values())
 61                 .withDimension(&quot;FALSE&quot;, (x, falseSec) -&gt; x.falseSec = falseSec, Pattern.values())
 62                 .run(ConditionalTest::new);
 63     }
 64 
 65     private Pattern cond;
 66     private Pattern trueSec;
 67     private Pattern falseSec;
 68 
 69     private static final String MAIN_TEMPLATE =
 70             &quot;&quot;&quot;
 71             public class Test {
 72                 public static boolean doTest(Object o, boolean b) {
 73                     return #{COND} ? #{TRUE} : #{FALSE}
 74                 }
 75             }
 76             &quot;&quot;&quot;;
 77 
 78     @Override
 79     protected void doWork() throws Throwable {
 80         Path base = Paths.get(&quot;.&quot;);
 81 
 82         ComboTask task = newCompilationTask()
 83                 .withSourceFromTemplate(MAIN_TEMPLATE, pname -&gt; switch (pname) {
 84                         case &quot;COND&quot; -&gt; cond;
 85                         case &quot;TRUE&quot; -&gt; trueSec;
 86                         case &quot;FALSE&quot; -&gt; falseSec;
 87                         default -&gt; throw new UnsupportedOperationException(pname);
 88                     })
 89                 .withOption(&quot;--enable-preview&quot;)
 90                 .withOption(&quot;-source&quot;)
 91                 .withOption(String.valueOf(Runtime.version().feature()));
 92 
 93         task.analyze(result -&gt; {
 94             boolean shouldPass;
 95             if (cond == Pattern.TRUE &amp;&amp; (trueSec == Pattern.TRUE || trueSec == Pattern.FALSE)) { //6 cases covered
 96                 shouldPass = false; //already in scope in true section
 97             } else if (cond == Pattern.FALSE &amp;&amp; (falseSec == Pattern.TRUE || falseSec == Pattern.FALSE)) { //6 cases covered
 98                 shouldPass = false; //already in scope in false section
 99             } else if (cond == Pattern.TRUE &amp;&amp; falseSec == Pattern.TRUE) {
100                 shouldPass = false; //JLS 6.3.1.4
101             } else if (cond == Pattern.FALSE &amp;&amp; trueSec == Pattern.TRUE) {
102                 shouldPass = false; //JLS 6.3.1.4
103             } else if (trueSec == Pattern.TRUE &amp;&amp; falseSec == Pattern.TRUE) {
104                 shouldPass = false; //JLS 6.3.1.4
105             } else if (trueSec == Pattern.TRUE &amp;&amp; falseSec == Pattern.TRUE) {
106                 shouldPass = false; //JLS 6.3.1.4
107             } else if (cond == Pattern.TRUE &amp;&amp; falseSec == Pattern.FALSE) {
108                 shouldPass = false; //JLS 6.3.1.4
109             } else if (cond == Pattern.FALSE &amp;&amp; trueSec == Pattern.FALSE) {
110                 shouldPass = false; //JLS 6.3.1.4
111             } else if (trueSec == Pattern.FALSE &amp;&amp; falseSec == Pattern.FALSE) {
112                 shouldPass = false; //JLS 6.3.1.4
113             } else {
114                 shouldPass = true;
115             }
116 
117             if (!shouldPass) {
118                 result.containsKey(&quot;Blabla&quot;);
119             }
120         });
121     }
122 
123     public enum Pattern implements ComboParameter {
124         NONE(&quot;b&quot;),
125         TRUE(&quot;o instanceof String s&quot;),
126         FALSE(&quot;!(o instanceof String s)&quot;);
127         private final String code;
128 
129         private Pattern(String code) {
130             this.code = code;
131         }
132 
133         @Override
134         public String expand(String optParameter) {
135             return code;
136         }
137     }
138 
139 }
    </pre>
  </body>
</html>