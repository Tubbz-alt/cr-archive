<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New test/langtools/tools/javac/patterns/BreakAndLoops.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @bug 8234922
 27  * @summary Verify proper scope of binding related to loops and breaks.
 28  * @library /tools/lib /tools/javac/lib
 29  * @modules
 30  *      java.base/jdk.internal
 31  *      jdk.compiler/com.sun.tools.javac.api
 32  *      jdk.compiler/com.sun.tools.javac.file
 33  *      jdk.compiler/com.sun.tools.javac.main
 34  *      jdk.compiler/com.sun.tools.javac.util
 35  * @build toolbox.ToolBox toolbox.JavacTask
 36  * @build combo.ComboTestHelper
 37  * @compile --enable-preview -source ${jdk.version} BreakAndLoops.java
 38  * @run main/othervm --enable-preview BreakAndLoops
 39  */
 40 
 41 import combo.ComboInstance;
 42 import combo.ComboParameter;
 43 import combo.ComboTask;
 44 import combo.ComboTestHelper;
 45 import java.nio.file.Path;
 46 import java.nio.file.Paths;
 47 import toolbox.ToolBox;
 48 
 49 public class BreakAndLoops extends ComboInstance&lt;BreakAndLoops&gt; {
 50     protected ToolBox tb;
 51 
 52     BreakAndLoops() {
 53         super();
 54         tb = new ToolBox();
 55     }
 56 
 57     public static void main(String... args) throws Exception {
 58         new ComboTestHelper&lt;BreakAndLoops&gt;()
 59                 .withDimension(&quot;OUTTER_LABEL&quot;, (x, outterLabel) -&gt; x.outterLabel = outterLabel, OutterLabel.values())
 60                 .withDimension(&quot;OUTTER_LOOP&quot;, (x, outterLoop) -&gt; x.outterLoop = outterLoop, OutterLoop.values())
 61                 .withDimension(&quot;MAIN_LOOP&quot;, (x, mainLoop) -&gt; x.mainLoop = mainLoop, MainLoop.values())
 62                 .withDimension(&quot;INNER_LABEL&quot;, (x, innerLabel) -&gt; x.innerLabel = innerLabel, Label.values())
 63                 .withDimension(&quot;INNER_LOOP&quot;, (x, innerLoop) -&gt; x.innerLoop = innerLoop, Loop.values())
 64                 .withDimension(&quot;BREAK&quot;, (x, brk) -&gt; x.brk = brk, Break.values())
 65                 .withFilter(bal -&gt; bal.outterLabel != OutterLabel.LABEL || bal.innerLabel != Label.LABEL)
 66                 .run(BreakAndLoops::new);
 67     }
 68 
 69     private OutterLabel outterLabel;
 70     private OutterLoop outterLoop;
 71     private MainLoop mainLoop;
 72     private Label innerLabel;
 73     private Loop innerLoop;
 74     private Break brk;
 75 
 76     private static final String MAIN_TEMPLATE =
 77             &quot;&quot;&quot;
 78             public class Test {
 79                 public static void doTest(Object o, int i, Object[] arr) {
 80                     #{OUTTER_LABEL}
 81                 }
 82             }
 83             &quot;&quot;&quot;;
 84 
 85     @Override
 86     protected void doWork() throws Throwable {
 87         Path base = Paths.get(&quot;.&quot;);
 88 
 89         ComboTask task = newCompilationTask()
 90                 .withSourceFromTemplate(MAIN_TEMPLATE, pname -&gt; switch (pname) {
 91                         case &quot;OUTTER_LABEL&quot; -&gt; outterLabel;
 92                         case &quot;OUTTER_LOOP&quot; -&gt; outterLoop;
 93                         case &quot;MAIN_LOOP&quot; -&gt; mainLoop;
 94                         case &quot;NESTED_LOOP&quot; -&gt; innerLoop;
 95                         case &quot;NESTED&quot; -&gt; brk;
 96                         case &quot;BODY&quot; -&gt; innerLabel;
 97                         default -&gt; throw new UnsupportedOperationException(pname);
 98                     })
 99                 .withOption(&quot;--enable-preview&quot;)
100                 .withOption(&quot;-source&quot;)
101                 .withOption(String.valueOf(Runtime.version().feature()));
102 
103         task.generate(result -&gt; {
104             boolean shouldPass;
105             if (brk == Break.NONE) {
106                 shouldPass = true;
107             } else if (innerLabel == Label.LABEL &amp;&amp; brk == Break.BREAK_LABEL) {
108                 shouldPass = true;
109             } else if (innerLoop.supportsAnonymousBreak &amp;&amp; brk == Break.BREAK) {
110                 shouldPass = true;
111             } else {
112                 shouldPass = false;
113             }
114             if (!(shouldPass ^ result.hasErrors())) {
115                 throw new AssertionError(&quot;Unexpected result: &quot; + result.compilationInfo());
116             }
117         });
118     }
119 
120     public enum MainLoop implements ComboParameter {
121         WHILE(&quot;&quot;&quot;
122               while (!(o instanceof String s)) {
123                   #{BODY}
124               }
125               &quot;&quot;&quot;),
126         FOR(&quot;&quot;&quot;
127             for( ; !(o instanceof String s) ; ) {
128                 #{BODY}
129             }
130             &quot;&quot;&quot;),
131         DO_WHILE(&quot;&quot;&quot;
132                  do {
133                      #{BODY}
134                  } while (!(o instanceof String s));
135                  &quot;&quot;&quot;);
136         private final String body;
137 
138         private MainLoop(String body) {
139             this.body = body;
140         }
141 
142         @Override
143         public String expand(String optParameter) {
144             return body;
145         }
146     }
147 
148     public enum OutterLabel implements ComboParameter {
149         NONE(&quot;#{OUTTER_LOOP}&quot;),
150         LABEL(&quot;LABEL: #{OUTTER_LOOP}&quot;);
151         private final String code;
152 
153         private OutterLabel(String code) {
154             this.code = code;
155         }
156 
157         @Override
158         public String expand(String optParameter) {
159             return code;
160         }
161     }
162 
163     public enum OutterLoop implements ComboParameter {
164         NONE(&quot;#{MAIN_LOOP} System.err.println(s);&quot;),
165         BLOCK(&quot;{ #{MAIN_LOOP} System.err.println(s); }&quot;),
166         WHILE(&quot;while (i-- &gt; 0) { #{MAIN_LOOP} System.err.println(s); }&quot;),
167         FOR(&quot;for ( ; i-- &gt; 0; ) { #{MAIN_LOOP} System.err.println(s); }&quot;),
168         FOR_EACH(&quot;for (Object outterO : arr) { #{MAIN_LOOP} System.err.println(s); }&quot;),
169         DO_WHILE(&quot;do { #{MAIN_LOOP} System.err.println(s); } while (i-- &gt; 0);&quot;);
170         private final String code;
171 
172         private OutterLoop(String code) {
173             this.code = code;
174         }
175 
176         @Override
177         public String expand(String optParameter) {
178             return code;
179         }
180     }
181 
182     public enum Label implements ComboParameter {
183         NONE(&quot;#{NESTED_LOOP}&quot;),
184         LABEL(&quot;LABEL: #{NESTED_LOOP}&quot;);
185         private final String code;
186 
187         private Label(String code) {
188             this.code = code;
189         }
190 
191         @Override
192         public String expand(String optParameter) {
193             return code;
194         }
195     }
196 
197     public enum Loop implements ComboParameter {
198         NONE(&quot;#{NESTED}&quot;, false),
199         BLOCK(&quot;{ #{NESTED} }&quot;, false),
200         WHILE(&quot;while (i-- &gt; 0) { #{NESTED} }&quot;, true),
201         FOR(&quot;for ( ; i-- &gt; 0; ) { #{NESTED} }&quot;, true),
202         FOR_EACH(&quot;for (Object innerO : arr) { #{NESTED} }&quot;, true),
203         DO_WHILE(&quot;do { #{NESTED} } while (i-- &gt; 0);&quot;, true);
204         private final String code;
205         private final boolean supportsAnonymousBreak;
206 
207         private Loop(String code, boolean supportsAnonymousBreak) {
208             this.code = code;
209             this.supportsAnonymousBreak = supportsAnonymousBreak;
210         }
211 
212         @Override
213         public String expand(String optParameter) {
214             return code;
215         }
216     }
217 
218     public enum Break implements ComboParameter {
219         NONE(&quot;;&quot;),
220         BREAK(&quot;break;&quot;),
221         BREAK_LABEL(&quot;break LABEL;&quot;);
222         private final String code;
223 
224         private Break(String code) {
225             this.code = code;
226         }
227 
228         @Override
229         public String expand(String optParameter) {
230             return code;
231         }
232     }
233 }
    </pre>
  </body>
</html>