<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/langtools/tools/javac/annotations/typeAnnotations/classfile/CombinationsTargetTest2.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2013, 2015, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @bug 8005085 8005877 8004829 8005681 8006734 8006775 8006507
 27  * @summary Combinations of Target ElementTypes on (repeated)type annotations.
 28  * @modules jdk.jdeps/com.sun.tools.classfile
 29  */
 30 
 31 import com.sun.tools.classfile.*;
 32 import java.io.File;
<a name="2" id="anc2"></a>
 33 
 34 public class CombinationsTargetTest2 extends ClassfileTestHelper {
 35 
<a name="3" id="anc3"></a>


 36     // Test count helps identify test case in event of failure.
 37     int testcount = 0;
 38 
 39     // Base test case template descriptions;true==annotations in code attribute.
 40     enum srce  {
 41         src1(&quot;(repeating) type annotations on on field in method body&quot;,true),
 42         src2(&quot;(repeating) type annotations on type parameters, bounds and  type arguments&quot;, true),
 43         src3(&quot;(repeating) type annotations on type parameters of class, method return value in method&quot;, true),
 44         src4(&quot;(repeating) type annotations on field in anonymous class&quot;, false),
 45         src5(&quot;(repeating) type annotations on field in anonymous class&quot;, false),
 46         src6(&quot;(repeating) type annotations on void method declaration&quot;, false),
 47         src7(&quot;(repeating) type annotations in use of instanceof&quot;, true),
<a name="4" id="anc4"></a><span class="line-modified"> 48         src8(&quot;(repeating) type annotations in use of instanceof in method&quot;, true);</span>


 49 
 50         String description;
 51         Boolean local;
 52 
 53         srce(String desc, Boolean b) {
 54             this.description = this + &quot;: &quot; +desc;
 55             this.local = b;
 56         }
 57     }
 58 
 59 
 60     String[] ETypes={&quot;TYPE&quot;, &quot;FIELD&quot;, &quot;METHOD&quot;, &quot;PARAMETER&quot;, &quot;CONSTRUCTOR&quot;,
 61                      &quot;LOCAL_VARIABLE&quot;, &quot;ANNOTATION_TYPE&quot;, &quot;PACKAGE&quot;};
 62 
 63     // local class tests will have an inner class.
 64     Boolean hasInnerClass=false;
 65     String innerClassname=&quot;&quot;;
 66 
 67     public static void main(String[] args) throws Exception {
 68         new CombinationsTargetTest2().run();
 69     }
 70 
 71     void run() throws Exception {
 72         // Determines which repeat and order in source(ABMix).
 73         Boolean As= false, BDs=true, ABMix=false;
 74         int testrun=0;
 75         Boolean [][] bRepeat = new Boolean[][]{{false,false,false},//no repeats
 76                                                {true,false,false}, //repeat @A
 77                                                {false,true,false}, //repeat @B
 78                                                {true,true,false},  //repeat both
 79                                                {false,false,true}  //repeat mix
 80         };
 81 
 82         for(Boolean[] bCombo : bRepeat) {
 83             As=bCombo[0]; BDs=bCombo[1]; ABMix=bCombo[2];
 84             for(String et : ETypes) {
 85                switch(et) {
 86                    case &quot;METHOD&quot;:
 87                        test( 8, 0, 0, 0, As, BDs, ABMix, &quot;CLASS&quot;,   et, ++testrun, srce.src1);
 88                        test( 0, 8, 0, 0, As, BDs, ABMix, &quot;RUNTIME&quot;, et, ++testrun, srce.src1);
 89                        test( 2, 0, 2, 0, As, BDs, ABMix, &quot;CLASS&quot;,   et, ++testrun, srce.src5);
 90                        test( 0, 2, 0, 2, As, BDs, ABMix, &quot;RUNTIME&quot;, et, ++testrun, srce.src5);
 91                        test( 0, 0, 2, 0, As, BDs, ABMix, &quot;CLASS&quot;, et, ++testrun, srce.src6);
 92                        test( 0, 0, 0, 2, As, BDs, ABMix, &quot;RUNTIME&quot;, et, ++testrun, srce.src6);
 93                        test( 2, 0, 0, 0, As, BDs, ABMix, &quot;CLASS&quot;, et, ++testrun, srce.src7);
 94                        test( 0, 2, 0, 0, As, BDs, ABMix, &quot;RUNTIME&quot;, et, ++testrun, srce.src7);
<a name="5" id="anc5"></a>

 95                        test( 4, 0, 0, 0, As, BDs, ABMix, &quot;CLASS&quot;, et, ++testrun, srce.src8);
 96                        test( 0, 4, 0, 0, As, BDs, ABMix, &quot;RUNTIME&quot;, et, ++testrun, srce.src8);
<a name="6" id="anc6"></a>

 97                        break;
 98                    case &quot;FIELD&quot;:
 99                        test( 8, 0, 0, 0, As, BDs, ABMix, &quot;CLASS&quot;,   et, ++testrun, srce.src1);
100                        test( 8, 0, 0, 0, As, BDs, ABMix, &quot;CLASS&quot;,   et, ++testrun, srce.src2);
101                        test( 6, 0, 0, 0, As, BDs, ABMix, &quot;CLASS&quot;,   et, ++testrun, srce.src3);
102                        test( 2, 0, 2, 0, As, BDs, ABMix, &quot;CLASS&quot;,   et, ++testrun, srce.src4);
103                        test( 0, 8, 0, 0, As, BDs, ABMix, &quot;RUNTIME&quot;, et, ++testrun, srce.src1);
104                        test( 0, 8, 0, 0, As, BDs, ABMix, &quot;RUNTIME&quot;, et, ++testrun, srce.src2);
105                        test( 0, 6, 0, 0, As, BDs, ABMix, &quot;RUNTIME&quot;, et, ++testrun, srce.src3);
106                        test( 0, 2, 0, 2, As, BDs, ABMix, &quot;RUNTIME&quot;, et, ++testrun, srce.src4);
107                        break;
108                    default:/*TYPE,PARAMETER,LOCAL_VARIABLE,ANNOTATION_TYPE,PACKAGE*/
109                        test( 0, 2, 0, 0, As, BDs, ABMix, &quot;RUNTIME&quot;, et, ++testrun, srce.src4);
110                        test( 0, 2, 0, 0, As, BDs, ABMix, &quot;RUNTIME&quot;, et, ++testrun, srce.src5);
111                        break;
112                }
113             }
114         }
115     }
116 
117     public void test(int tinv, int tvis, int inv, int vis, Boolean Arepeats,
118                      Boolean BDrepeats, Boolean ABmix, String rtn, String et2,
119                      Integer N, srce source) throws Exception {
120         ++testcount;
121         expected_tvisibles = tvis;
122         expected_tinvisibles = tinv;
123         expected_visibles = vis;
124         expected_invisibles = inv;
<a name="7" id="anc7"></a>
125         File testFile = null;
126         String tname=&quot;Test&quot; + N.toString();
127         hasInnerClass=false;
128         String testDef = &quot;Test &quot; + testcount + &quot; parameters: tinv=&quot; + tinv +
129                 &quot;, tvis=&quot; + tvis + &quot;, inv=&quot; + inv + &quot;, vis=&quot; + vis +
130                 &quot;, Arepeats=&quot; + Arepeats + &quot;, BDrepeats=&quot; + BDrepeats +
131                 &quot;, ABmix=&quot; + ABmix + &quot;, retention: &quot; + rtn + &quot;, anno2: &quot; +
132                 et2 + &quot;, src=&quot; + source + &quot;\n    &quot; + source.description;
133 
134         println(testDef);
135         // Create test source and File.
136         String sourceString = sourceString(tname, rtn, et2, Arepeats,
137                                            BDrepeats, ABmix, source);
138         testFile = writeTestFile(tname+&quot;.java&quot;, sourceString);
139         // Compile test source and read classfile.
140         File classFile = null;
141         try {
142             classFile = compile(testFile);
143         } catch (Error err) {
144             System.err.println(&quot;Failed compile. Source:\n&quot; + sourceString);
145             throw err;
146         }
147         //if sourcString() set hasInnerClass it also set innerClassname.
148         if(hasInnerClass) {
149             StringBuffer sb = new StringBuffer(classFile.getAbsolutePath());
150             classFile=new File(sb.insert(sb.lastIndexOf(&quot;.class&quot;),innerClassname).toString());
151             println(&quot;classfile: &quot; + classFile.getAbsolutePath());
152         }
153         ClassFile cf = ClassFile.read(classFile);
154 
155         //Test class,fields and method counts.
156         test(cf);
157 
158         for (Field f : cf.fields) {
159             if(source.local)
160                 test(cf, f, true);
161             else
162                 test(cf,f);
163         }
164         for (Method m: cf.methods) {
165             if(source.local)
166                 test(cf, m, true);
167             else
168                 test(cf, m);
169         }
170         countAnnotations();
171         if (errors &gt; 0) {
172             System.err.println( testDef );
173             System.err.println( &quot;Source:\n&quot; + sourceString );
174             throw new Exception( errors + &quot; errors found&quot; );
175         }
176         println(&quot;Pass&quot;);
177     }
178 
179     // Source for test cases
180     String sourceString(String testname, String retentn, String annot2,
181                         Boolean Arepeats, Boolean BDrepeats, Boolean ABmix,
182                         srce src) {
183 
184         String As = &quot;@A&quot;, Bs = &quot;@B&quot;, Ds = &quot;@D&quot;;
185         if(Arepeats) As = &quot;@A @A&quot;;
186         if(BDrepeats) {
187             Bs = &quot;@B @B&quot;;
188             Ds = &quot;@D @D&quot;;
189         }
190         if(ABmix) { As = &quot;@A @B&quot;; Bs = &quot;@A @B&quot;; Ds = &quot;@D @D&quot;; }
191 
192         // Source to check for TYPE_USE and TYPE_PARAMETER annotations.
193         // Source base (annotations) is same for all test cases.
194         String source = new String();
195         String imports = new String(&quot;import java.lang.annotation.*; \n&quot; +
196             &quot;import static java.lang.annotation.RetentionPolicy.*; \n&quot; +
197             &quot;import static java.lang.annotation.ElementType.*; \n&quot; +
198             &quot;import java.util.List; \n&quot; +
199             &quot;import java.util.HashMap; \n&quot; +
200             &quot;import java.util.Map; \n\n&quot;);
201 
202             String sourceBase = new String(&quot;@Retention(&quot;+retentn+&quot;)\n&quot; +
203             &quot;@Target({TYPE_USE,_OTHER_})\n&quot; +
204             &quot;@Repeatable( AC.class )\n&quot; +
205             &quot;@interface A { }\n\n&quot; +
206 
207             &quot;@Retention(&quot;+retentn+&quot;)\n&quot; +
208             &quot;@Target({TYPE_USE,_OTHER_})\n&quot; +
209             &quot;@interface AC { A[] value(); }\n\n&quot; +
210 
211             &quot;@Retention(&quot;+retentn+&quot;)\n&quot; +
212             &quot;@Target({TYPE_USE,_OTHER_})\n&quot; +
213             &quot;@Repeatable( BC.class )\n&quot; +
214             &quot;@interface B { }\n\n&quot; +
215 
216             &quot;@Retention(&quot;+retentn+&quot;)\n&quot; +
217             &quot;@Target({TYPE_USE,_OTHER_})\n&quot; +
218             &quot;@interface BC { B[] value(); } \n\n&quot; +
219 
220             &quot;@Retention(&quot;+retentn+&quot;)\n&quot; +
221             &quot;@Target({TYPE_USE,TYPE_PARAMETER,_OTHER_})\n&quot; +
222             &quot;@Repeatable(DC.class)\n&quot; +
223             &quot;@interface D { }\n\n&quot; +
224 
225             &quot;@Retention(&quot;+retentn+&quot;)\n&quot; +
226             &quot;@Target({TYPE_USE,TYPE_PARAMETER,_OTHER_})\n&quot; +
227             &quot;@interface DC { D[] value(); }\n\n&quot;);
228 
229         // Test case sources with sample generated source
230         switch(src) {
231             case src1: // (repeating) type annotations on field in method body
232                     /*
233                      * class Test1 {
234                      * Test1(){}
235                      * // type usage in method body
236                      * String test(Test1 this, String param, String ... vararg) {
237                      *     @A @B
238                      *     Object o = new @A @B  String @A @B  [3];
239                      *         return (@A @B  String) null;
240                      * }}
241                       */
242                 source = new String(
243                     &quot;// &quot; + src.description + &quot;\n&quot; +
244                     &quot;class &quot; + testname + &quot; {\n&quot; +
245                     &quot;&quot; + testname +&quot;(){} \n&quot; +
246                     &quot;// type usage in method body \n&quot; +
247                     &quot;String test(&quot;+testname+&quot; this, &quot; +
248                        &quot;String param, String ... vararg) { \n&quot; +
249                     &quot;    _As_ _Bs_\n    Object o = new _As_ _Bs_  String _As_ _Bs_  [3]; \n&quot; +
250                     &quot;        return (_As_ _Bs_  String) null; \n&quot; +
251                     &quot;} \n&quot; +
252                     &quot;} \n&quot;).concat(sourceBase).replace(&quot;_OTHER_&quot;, annot2).replace(&quot;_As_&quot;,As).replace(&quot;_Bs_&quot;,Bs) +
253                     &quot;\n\n&quot;;
254                     break;
255             case src2: // (repeating) annotations on type parameters, bounds and  type arguments in new statement.
256                     /*
257                      * class Test2&lt;T extends Object&gt; {
258                      *     Map&lt;List&lt;String&gt;, Integer&gt; map =
259                      *         new HashMap&lt;@A @B List&lt;@A @B String&gt;, @A @B Integer&gt;();
260                      *     Map&lt;List&lt;String&gt;, Integer&gt; map2 = new @A @B HashMap&lt;&gt;();
261                      *     String test(Test2&lt;T&gt; this) { return null;}
262                      *     &lt;T&gt; String genericMethod(T t) { return null; }
263                      * }
264                      */
265                 source = new String( source +
266                     &quot;// &quot; + src.description + &quot;\n&quot; +
267                     &quot;class &quot; + testname + &quot;&lt;T extends Object&gt; {\n&quot; +
268                     &quot;    Map&lt;List&lt;String&gt;, Integer&gt; map =\n&quot; +
269                     &quot;        new HashMap&lt;_As_ _Bs_ List&lt;_As_ _Bs_ String&gt;, _As_ _Bs_ Integer&gt;();\n&quot; +
270                     &quot;    Map&lt;List&lt;String&gt;, Integer&gt; map2 = new _As_ _Bs_ HashMap&lt;&gt;();\n&quot; +
271                     &quot;    String test(&quot; + testname + &quot;&lt;T&gt; this) { return null;}\n&quot; +
272                     &quot;    &lt;T&gt; String genericMethod(T t) { return null; }\n&quot; +
273                     &quot;}\n&quot;).concat(sourceBase).replace(&quot;_OTHER_&quot;, annot2).replace(&quot;_As_&quot;,As).replace(&quot;_Bs_&quot;,Bs) +
274                     &quot;\n\n&quot;;
275                 break;
276             case src3: // (repeating)annotations on type parameters of class, method return value in method.
277                     /*
278                      * class Test3{
279                      *     &lt;E extends Comparable&gt; Map&lt;List&lt;E&gt;, E &gt; foo(E e) {
280                      *         class maptest &lt;E&gt; {
281                      *             Map&lt;List&lt;E&gt;,E&gt; getMap() {
282                      *                 Map&lt;List&lt;E&gt;,E&gt; Em = new HashMap&lt;List&lt;@A @B @D E&gt;,@A @B @D E&gt;();
283                      *                 return Em;
284                      *             }
285                      *         }
286                      *         return new maptest&lt;E&gt;().getMap();
287                      *    }
288                      *    Map&lt;List&lt;String&gt;,String&gt; shm = foo(new String(&quot;hello&quot;));
289                      * }
290                      */
291                 source = new String( source +
292                     &quot;// &quot; + src.description + &quot;\n&quot; +
293                     &quot;class &quot;+ testname + &quot;{\n&quot; +
294                     &quot;    &lt;E extends Comparable&gt; Map&lt;List&lt;E&gt;, E &gt; foo(E e) {\n&quot; +
295                     &quot;        class maptest &lt;E&gt; {\n&quot; +                  // inner class $1maptest
296                     &quot;            Map&lt;List&lt;E&gt;,E&gt; getMap() { \n&quot; +
297                     &quot;                Map&lt;List&lt;E&gt;,E&gt; Em = new HashMap&lt;List&lt;_As_ _Bs_ _Ds_ E&gt;,_As_ _Bs_ _Ds_ E&gt;();\n&quot; +
298                     &quot;                return Em;\n&quot; +
299                     &quot;            }\n&quot; +
300                     &quot;        }\n&quot; +
301                     &quot;        return new maptest&lt;E&gt;().getMap();\n&quot; +
302                     &quot;   }\n&quot; +
303                     &quot;   Map&lt;List&lt;String&gt;,String&gt; shm = foo(new String(\&quot;hello\&quot;));\n&quot; +
304                     &quot;}\n&quot;).concat(sourceBase).replace(&quot;_OTHER_&quot;, annot2).replace(&quot;_As_&quot;,As).replace(&quot;_Bs_&quot;,Bs).replace(&quot;_Ds_&quot;,Ds) +
305                     &quot;\n\n&quot;;
306                     hasInnerClass=true;
307                     innerClassname=&quot;$1maptest&quot;;
308                 break;
309             case src4: // (repeating)annotations on field in anonymous class
310                     /*
311                      * class Test95{
312                      *     void mtest( Test95 t){  }
313                      *     public void test() {
314                      *         mtest( new Test95() {
315                      *             @A @A @B @B String data2 = &quot;test&quot;;
316                      *         });
317                      *     }
318                      * }
319                      */
320                 source = new String( source +
321                     &quot;// &quot; + src.description + &quot;\n&quot; +
322                     &quot;class &quot;+ testname + &quot;{\n&quot; +
323                     &quot;    void mtest( &quot;+ testname + &quot; t){  }\n&quot; +
324                     &quot;    public void test() {\n&quot; +
325                     &quot;        mtest( new &quot;+ testname + &quot;() {\n&quot; +
326                     &quot;            _As_ _Bs_ String data2 = \&quot;test\&quot;;\n&quot; +
327                     &quot;        });\n&quot; +
328                     &quot;    }\n&quot; +
329                     &quot;}\n&quot;).concat(sourceBase).replace(&quot;_OTHER_&quot;, annot2).replace(&quot;_As_&quot;,As).replace(&quot;_Bs_&quot;,Bs) +
330                     &quot;\n\n&quot;;
331                     hasInnerClass=true;
332                     innerClassname=&quot;$1&quot;;
333                 break;
334             case src5: // (repeating)annotations on method in anonymous class
335                     /*
336                      * class Test120{
337                      *     void mtest( Test120 t){  }
338                      *     public void test() {
339                      *         mtest( new Test120() {
340                      *             @A @B @A @B String m2(){return null;};
341                      *         });
342                      *     }
343                      */
344                 source = new String( source +
345                     &quot;// &quot; + src.description + &quot;\n&quot; +
346                     &quot;class &quot;+ testname + &quot;{\n&quot; +
347                     &quot;    void mtest( &quot;+ testname + &quot; t){  }\n&quot; +
348                     &quot;    public void test() {\n&quot; +
349                     &quot;        mtest( new &quot;+ testname + &quot;() {\n&quot; +
350                     &quot;            _As_ _Bs_ String m2(){return null;};\n&quot; +
351                     &quot;        });\n&quot; +
352                     &quot;    }\n&quot; +
353                     &quot;}\n&quot;).concat(sourceBase).replace(&quot;_OTHER_&quot;, annot2).replace(&quot;_As_&quot;,As).replace(&quot;_Bs_&quot;,Bs) +
354                     &quot;\n\n&quot;;
355                     hasInnerClass=true;
356                     innerClassname=&quot;$1&quot;;
357                 break;
358             case src6: // (repeating)annotations on void method declaration
359                     /*
360                      * class Test95{
361                      *     @A @A @B @B public void test() { };
362                      * }
363                      */
364                 source = new String( source +
365                     &quot;// &quot; + src.description + &quot;\n&quot; +
366                     &quot;class &quot;+ testname + &quot;{\n&quot; +
367                     &quot;    _As_ _Bs_ public void test() { }\n&quot; +
368                     &quot;}\n&quot;).concat(sourceBase).replace(&quot;_OTHER_&quot;, annot2).replace(&quot;_As_&quot;,As).replace(&quot;_Bs_&quot;,Bs) +
369                     &quot;\n\n&quot;;
370                     hasInnerClass=false;
371                 break;
372             case src7: // (repeating) type annotations in use of instanceof
373                     /*
374                      *   class Test10{
375                      *       String data = &quot;test&quot;;
376                      *       boolean dataIsString = ( data instanceof @A @B @A @B String);
377                      *   }
378                      */
379                 source = new String( source +
380                     &quot;// &quot; + src.description + &quot;\n&quot; +
381                     &quot;class &quot;+ testname + &quot;{\n&quot; +
382                     &quot;    String data = \&quot;test\&quot;;\n&quot; +
383                     &quot;    boolean dataIsString = ( data instanceof _As_ _Bs_ String);\n&quot; +
384                     &quot;}\n&quot;).concat(sourceBase).replace(&quot;_OTHER_&quot;, annot2).replace(&quot;_As_&quot;,As).replace(&quot;_Bs_&quot;,Bs) +
385                     &quot;\n\n&quot;;
386                     hasInnerClass=false;
387                 break;
<a name="8" id="anc8"></a>

















388             case src8: // (repeating) type annotations in use of instanceof
389                     /*
390                      *   class Test20{
391                      *       String data = &quot;test&quot;;
392                      *       Boolean isString() {
393                      *           if( data instanceof @A @B @A @B String )
394                      *               return true;
395                      *           else
396                      *               return( data instanceof @A @B @A @B String );
397                      *       }
398                      *   }
399                      */
400                 source = new String( source +
401                     &quot;// &quot; + src.description + &quot;\n&quot; +
402                     &quot;class &quot;+ testname + &quot;{\n&quot; +
403                     &quot;    String data = \&quot;test\&quot;;\n&quot; +
404                     &quot;    Boolean isString() { \n&quot; +
405                     &quot;        if( data instanceof _As_ _Bs_ String )\n&quot; +
406                     &quot;            return true;\n&quot; +
407                     &quot;        else\n&quot; +
408                     &quot;            return( data instanceof _As_ _Bs_ String );\n&quot; +
409                     &quot;    }\n&quot; +
410                     &quot;}\n&quot;).concat(sourceBase).replace(&quot;_OTHER_&quot;, annot2).replace(&quot;_As_&quot;,As).replace(&quot;_Bs_&quot;,Bs) +
411                     &quot;\n\n&quot;;
412                     hasInnerClass=false;
413                 break;
<a name="9" id="anc9"></a>



























414 
415         }
416         return imports + source;
417     }
418 }
<a name="10" id="anc10"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="10" type="hidden" />
</body>
</html>