<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/langtools/tools/javac/expswitch/ExpSwitchNestingTest.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
    <script type="text/javascript" src="../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 2018, 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 import java.io.IOException;
 25 import java.util.List;
 26 
 27 import org.testng.ITestResult;
 28 import org.testng.annotations.AfterMethod;
 29 import org.testng.annotations.Test;
<a name="1" id="anc1"></a><span class="line-added"> 30 import tools.javac.combo.CompilationTestCase;</span>
 31 import tools.javac.combo.JavacTemplateTestBase;
 32 
 33 import static java.util.stream.Collectors.toList;
 34 
 35 @Test
<a name="2" id="anc2"></a><span class="line-modified"> 36 public class ExpSwitchNestingTest extends CompilationTestCase {</span>
 37     private static final String RUNNABLE = &quot;Runnable r = () -&gt; { # };&quot;;
 38     private static final String INT_FN = &quot;java.util.function.IntSupplier r = () -&gt; { # };&quot;;
 39     private static final String LABEL = &quot;label: #&quot;;
 40     private static final String DEF_LABEL_VAR = &quot;int label = 0; { # }&quot;;
 41     private static final String FOR = &quot;for (int i=0; i&lt;10; i++) { # }&quot;;
 42     private static final String FOR_EACH = &quot;for (int i : new int[] {}) { # }&quot;;
 43     private static final String WHILE = &quot;while (cond) { # }&quot;;
 44     private static final String DO = &quot;do { # } while (cond);&quot;;
 45     private static final String SSWITCH = &quot;switch (x) { case 0: # };&quot;;
 46     private static final String ESWITCH_Z = &quot;int res = switch (x) { case 0 -&gt; { # } default -&gt; 0; };&quot;;
 47     private static final String ESWITCH_S = &quot;String res_string = switch (x) { case 0 -&gt; { # } default -&gt; \&quot;default\&quot;; };&quot;;
 48     private static final String INT_FN_ESWITCH = &quot;java.util.function.IntSupplier r = switch (x) { case 0 -&gt; { # } default -&gt; null; };&quot;;
 49     private static final String INT_ESWITCH_DEFAULT = &quot;int res = switch (x) { default -&gt; { # } };&quot;;
 50     private static final String IF = &quot;if (cond) { # } else throw new RuntimeException();&quot;;
 51     private static final String BLOCK = &quot;{ # }&quot;;
<a name="3" id="anc3"></a><span class="line-modified"> 52     private static final String YIELD_Z = &quot;yield 0;&quot;;</span>
<span class="line-modified"> 53     private static final String YIELD_S = &quot;yield \&quot;hello world\&quot;;&quot;;</span>
<span class="line-modified"> 54     private static final String YIELD_INT_FN = &quot;yield () -&gt; 0 ;&quot;;</span>
 55     private static final String BREAK_N = &quot;break;&quot;;
 56     private static final String BREAK_L = &quot;break label;&quot;;
<a name="4" id="anc4"></a><span class="line-added"> 57     private static final String YIELD_L = &quot;yield label;&quot;;</span>
 58     private static final String RETURN_Z = &quot;return 0;&quot;;
 59     private static final String RETURN_N = &quot;return;&quot;;
 60     private static final String RETURN_S = &quot;return \&quot;Hello\&quot;;&quot;;
 61     private static final String CONTINUE_N = &quot;continue;&quot;;
 62     private static final String CONTINUE_L = &quot;continue label;&quot;;
 63     private static final String NOTHING = &quot;System.out.println();&quot;;
 64 
 65     // containers that do not require exhaustiveness
 66     private static final List&lt;String&gt; CONTAINERS
 67             = List.of(RUNNABLE, FOR, WHILE, DO, SSWITCH, IF, BLOCK);
 68     // containers that do not require exhaustiveness that are statements
 69     private static final List&lt;String&gt; CONTAINER_STATEMENTS
 70             = List.of(FOR, WHILE, DO, SSWITCH, IF, BLOCK);
 71 
<a name="5" id="anc5"></a><span class="line-modified"> 72     // @@@ When expression switch becomes a permanent feature, we don&#39;t need these any more</span>
<span class="line-modified"> 73     private static final String SHELL = &quot;class C { static boolean cond = false; static int x = 0; void m() { # } }&quot;;</span>









































 74 
<a name="6" id="anc6"></a><span class="line-modified"> 75     {</span>
<span class="line-modified"> 76         setDefaultFilename(&quot;C.java&quot;);</span>
<span class="line-modified"> 77         setProgramShell(SHELL);</span>








 78     }
 79 
 80     public void testReallySimpleCases() {
 81         for (String s : CONTAINERS)
 82             assertOK(s, NOTHING);
 83         for (String s : CONTAINER_STATEMENTS)
 84             assertOK(LABEL, s, NOTHING);
 85     }
 86 
 87     public void testLambda() {
 88         assertOK(RUNNABLE, RETURN_N);
 89         assertOK(RUNNABLE, NOTHING);
 90         assertOK(INT_FN, RETURN_Z);
 91         assertFail(&quot;compiler.err.break.outside.switch.loop&quot;, RUNNABLE, BREAK_N);
<a name="7" id="anc7"></a><span class="line-modified"> 92         assertFail(&quot;compiler.err.no.switch.expression&quot;, RUNNABLE, YIELD_Z);</span>
<span class="line-modified"> 93         assertFail(&quot;compiler.err.no.switch.expression&quot;, RUNNABLE, YIELD_S);</span>
 94         assertFail(&quot;compiler.err.break.outside.switch.loop&quot;, INT_FN, BREAK_N);
<a name="8" id="anc8"></a><span class="line-modified"> 95         assertFail(&quot;compiler.err.no.switch.expression&quot;, INT_FN, YIELD_Z);</span>
<span class="line-modified"> 96         assertFail(&quot;compiler.err.no.switch.expression&quot;, INT_FN, YIELD_S);</span>
 97         assertFail(&quot;compiler.err.cont.outside.loop&quot;, RUNNABLE, CONTINUE_N);
 98         assertFail(&quot;compiler.err.undef.label&quot;, RUNNABLE, BREAK_L);
 99         assertFail(&quot;compiler.err.undef.label&quot;, RUNNABLE, CONTINUE_L);
100         assertFail(&quot;compiler.err.cont.outside.loop&quot;, INT_FN, CONTINUE_N);
101         assertFail(&quot;compiler.err.undef.label&quot;, INT_FN, BREAK_L);
102         assertFail(&quot;compiler.err.undef.label&quot;, INT_FN, CONTINUE_L);
103         assertFail(&quot;compiler.err.undef.label&quot;, LABEL, BLOCK, RUNNABLE, BREAK_L);
104         assertFail(&quot;compiler.err.undef.label&quot;, LABEL, BLOCK, RUNNABLE, CONTINUE_L);
105         assertFail(&quot;compiler.err.undef.label&quot;, LABEL, BLOCK, INT_FN, BREAK_L);
106         assertFail(&quot;compiler.err.undef.label&quot;, LABEL, BLOCK, INT_FN, CONTINUE_L);
107     }
108 
109     public void testEswitch() {
110         //Int-valued switch expressions
<a name="9" id="anc9"></a><span class="line-modified">111         assertOK(ESWITCH_Z, YIELD_Z);</span>
<span class="line-modified">112         assertOK(LABEL, BLOCK, ESWITCH_Z, YIELD_Z);</span>
<span class="line-modified">113         assertFail(&quot;compiler.err.break.outside.switch.expression&quot;, ESWITCH_Z, BREAK_N);</span>
<span class="line-modified">114         assertFail(&quot;compiler.err.prob.found.req&quot;, ESWITCH_Z, YIELD_S);</span>
<span class="line-modified">115         assertFail(&quot;compiler.err.undef.label&quot;, ESWITCH_Z, BREAK_L);</span>
116         assertFail(&quot;compiler.err.break.outside.switch.expression&quot;, LABEL, BLOCK, ESWITCH_Z, BREAK_L);
117         assertFail(&quot;compiler.err.undef.label&quot;, ESWITCH_Z, CONTINUE_L);
<a name="10" id="anc10"></a><span class="line-modified">118         assertFail(&quot;compiler.err.continue.outside.switch.expression&quot;, ESWITCH_Z, CONTINUE_N);</span>
119         assertFail(&quot;compiler.err.return.outside.switch.expression&quot;, ESWITCH_Z, RETURN_N);
120         assertFail(&quot;compiler.err.return.outside.switch.expression&quot;, ESWITCH_Z, RETURN_Z);
121 
<a name="11" id="anc11"></a><span class="line-modified">122         assertOK(INT_ESWITCH_DEFAULT, YIELD_Z);</span>
<span class="line-modified">123         assertFail(&quot;compiler.err.break.outside.switch.expression&quot;, INT_ESWITCH_DEFAULT, BREAK_N);</span>
<span class="line-modified">124         assertFail(&quot;compiler.err.prob.found.req&quot;, INT_ESWITCH_DEFAULT, YIELD_S);</span>
<span class="line-modified">125         assertFail(&quot;compiler.err.undef.label&quot;, INT_ESWITCH_DEFAULT, BREAK_L);</span>
126 
127 
128         // String-valued switch expressions
<a name="12" id="anc12"></a><span class="line-modified">129         assertOK(ESWITCH_S, YIELD_S);</span>
<span class="line-modified">130         assertOK(LABEL, BLOCK, ESWITCH_S, YIELD_S);</span>
<span class="line-modified">131         assertFail(&quot;compiler.err.break.outside.switch.expression&quot;, ESWITCH_S, BREAK_N);</span>
<span class="line-modified">132         assertFail(&quot;compiler.err.prob.found.req&quot;, ESWITCH_S, YIELD_Z);</span>
<span class="line-modified">133         assertFail(&quot;compiler.err.undef.label&quot;, ESWITCH_S, BREAK_L);</span>
134         assertFail(&quot;compiler.err.break.outside.switch.expression&quot;, LABEL, BLOCK, ESWITCH_S, BREAK_L);
135         assertFail(&quot;compiler.err.undef.label&quot;, ESWITCH_S, CONTINUE_L);
<a name="13" id="anc13"></a><span class="line-modified">136         assertFail(&quot;compiler.err.continue.outside.switch.expression&quot;, ESWITCH_S, CONTINUE_N);</span>
137         assertFail(&quot;compiler.err.return.outside.switch.expression&quot;, ESWITCH_S, RETURN_N);
138         assertFail(&quot;compiler.err.return.outside.switch.expression&quot;, ESWITCH_S, RETURN_S);
139         // Function-valued switch expression
<a name="14" id="anc14"></a><span class="line-modified">140         assertOK(INT_FN_ESWITCH, YIELD_INT_FN);</span>
<span class="line-modified">141         assertFail(&quot;compiler.err.break.outside.switch.expression&quot;, INT_FN_ESWITCH, BREAK_N);</span>
<span class="line-modified">142         assertFail(&quot;compiler.err.prob.found.req&quot;, INT_FN_ESWITCH, YIELD_Z);</span>
<span class="line-modified">143         assertFail(&quot;compiler.err.prob.found.req&quot;, INT_FN_ESWITCH, YIELD_S);</span>
144 
<a name="15" id="anc15"></a><span class="line-modified">145         assertFail(&quot;compiler.err.undef.label&quot;, INT_FN_ESWITCH, BREAK_L);</span>
146         assertFail(&quot;compiler.err.break.outside.switch.expression&quot;, LABEL, BLOCK, INT_FN_ESWITCH, BREAK_L);
147         assertFail(&quot;compiler.err.undef.label&quot;, INT_FN_ESWITCH, CONTINUE_L);
<a name="16" id="anc16"></a><span class="line-modified">148         assertFail(&quot;compiler.err.continue.outside.switch.expression&quot;, INT_FN_ESWITCH, CONTINUE_N);</span>
149         assertFail(&quot;compiler.err.return.outside.switch.expression&quot;, INT_FN_ESWITCH, RETURN_N);
150         assertFail(&quot;compiler.err.return.outside.switch.expression&quot;, INT_FN_ESWITCH, RETURN_S);
151 
152     }
153 
154     public void testNestedInExpSwitch() {
<a name="17" id="anc17"></a><span class="line-modified">155         assertOK(ESWITCH_Z, IF,     YIELD_Z);</span>
<span class="line-modified">156         assertOK(ESWITCH_Z, BLOCK,  YIELD_Z);</span>
157         //
<a name="18" id="anc18"></a><span class="line-modified">158         assertOK(ESWITCH_Z, IF,     IF,     YIELD_Z);</span>
<span class="line-modified">159         assertOK(ESWITCH_Z, IF,     BLOCK,  YIELD_Z);</span>
<span class="line-modified">160         assertOK(ESWITCH_Z, BLOCK,  IF,     YIELD_Z);</span>
<span class="line-modified">161         assertOK(ESWITCH_Z, BLOCK,  BLOCK,  YIELD_Z);</span>
162         //
<a name="19" id="anc19"></a><span class="line-modified">163         assertOK(ESWITCH_Z, IF,     IF,     IF,     YIELD_Z);</span>
<span class="line-modified">164         assertOK(ESWITCH_Z, IF,     IF,     BLOCK,  YIELD_Z);</span>
<span class="line-modified">165         assertOK(ESWITCH_Z, IF,     BLOCK,  IF,     YIELD_Z);</span>
<span class="line-modified">166         assertOK(ESWITCH_Z, IF,     BLOCK,  BLOCK,  YIELD_Z);</span>
<span class="line-modified">167         assertOK(ESWITCH_Z, BLOCK,  IF,     IF,     YIELD_Z);</span>
<span class="line-modified">168         assertOK(ESWITCH_Z, BLOCK,  IF,     BLOCK,  YIELD_Z);</span>
<span class="line-modified">169         assertOK(ESWITCH_Z, BLOCK,  BLOCK,  IF,     YIELD_Z);</span>
<span class="line-modified">170         assertOK(ESWITCH_Z, BLOCK,  BLOCK,  BLOCK,  YIELD_Z);</span>
171         //
<a name="20" id="anc20"></a><span class="line-modified">172         assertOK(ESWITCH_Z, YIELD_Z, SSWITCH, YIELD_Z);</span>
<span class="line-modified">173         assertOK(ESWITCH_Z, YIELD_Z, FOR, YIELD_Z);</span>
<span class="line-modified">174         assertOK(ESWITCH_Z, YIELD_Z, WHILE, YIELD_Z);</span>
<span class="line-modified">175         assertOK(ESWITCH_Z, YIELD_Z, DO, YIELD_Z);</span>
<span class="line-modified">176         assertFail(&quot;compiler.err.no.switch.expression&quot;, ESWITCH_Z, INT_FN, YIELD_Z);</span>
<span class="line-modified">177         assertOK(ESWITCH_Z, YIELD_Z, SSWITCH, IF, YIELD_Z);</span>
<span class="line-modified">178         assertOK(ESWITCH_Z, YIELD_Z, FOR, IF, YIELD_Z);</span>
<span class="line-modified">179         assertOK(ESWITCH_Z, YIELD_Z, WHILE, IF, YIELD_Z);</span>
<span class="line-modified">180         assertOK(ESWITCH_Z, YIELD_Z, DO, IF, YIELD_Z);</span>
<span class="line-modified">181         assertOK(ESWITCH_Z, YIELD_Z, BLOCK, SSWITCH, IF, YIELD_Z);</span>
<span class="line-modified">182         assertOK(ESWITCH_Z, YIELD_Z, BLOCK, FOR, IF, YIELD_Z);</span>
<span class="line-modified">183         assertOK(ESWITCH_Z, YIELD_Z, BLOCK, WHILE, IF, YIELD_Z);</span>
<span class="line-modified">184         assertOK(ESWITCH_Z, YIELD_Z, BLOCK, DO, IF, YIELD_Z);</span>
185     }
186 
187     public void testBreakExpressionLabelDisambiguation() {
<a name="21" id="anc21"></a><span class="line-modified">188         assertOK(DEF_LABEL_VAR, ESWITCH_Z, YIELD_L);</span>
<span class="line-modified">189         assertFail(&quot;compiler.err.undef.label&quot;, DEF_LABEL_VAR, ESWITCH_Z, BREAK_L);</span>
<span class="line-modified">190         assertFail(&quot;compiler.err.break.outside.switch.expression&quot;, LABEL, FOR, BLOCK, DEF_LABEL_VAR, ESWITCH_Z, BREAK_L);</span>
<span class="line-modified">191         assertOK(DEF_LABEL_VAR, ESWITCH_Z, YIELD_Z, LABEL, FOR, BREAK_L); //label break</span>
<span class="line-added">192         assertFail(&quot;compiler.err.break.outside.switch.expression&quot;, DEF_LABEL_VAR, LABEL, BLOCK, ESWITCH_Z, BREAK_L);</span>
<span class="line-added">193         assertOK(DEF_LABEL_VAR, LABEL, BLOCK, ESWITCH_Z, YIELD_L); //expression break</span>
194         //
195     }
196 
197     public void testFunReturningSwitchExp() {
<a name="22" id="anc22"></a><span class="line-modified">198         assertOK(INT_FN_ESWITCH, YIELD_INT_FN);</span>
199     }
200 
201     public void testContinueLoops() {
202         assertOK(LABEL, FOR, CONTINUE_L);
203         assertOK(LABEL, FOR_EACH, CONTINUE_L);
204         assertOK(LABEL, WHILE, CONTINUE_L);
205         assertOK(LABEL, DO, CONTINUE_L);
206         assertFail(&quot;compiler.err.not.loop.label&quot;, LABEL, CONTINUE_L);
207     }
208 }
<a name="23" id="anc23"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="23" type="hidden" />
</body>
</html>