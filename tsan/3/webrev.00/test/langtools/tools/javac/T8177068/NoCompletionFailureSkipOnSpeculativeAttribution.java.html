<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New test/langtools/tools/javac/T8177068/NoCompletionFailureSkipOnSpeculativeAttribution.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @bug 8177068 8233655
 27  * @summary CompletionFailures occurring during speculative attribution should
 28  *          not be lost forever.
 29  * @library /tools/lib
 30  * @modules jdk.compiler/com.sun.tools.javac.api
 31  *          jdk.compiler/com.sun.tools.javac.main
 32  *          jdk.compiler/com.sun.tools.javac.util
 33  * @build toolbox.ToolBox
 34  * @run main NoCompletionFailureSkipOnSpeculativeAttribution
 35  */
 36 
 37 import java.io.File;
 38 import java.nio.file.Paths;
 39 import java.util.List;
 40 
 41 import com.sun.tools.javac.util.Assert;
 42 
 43 import toolbox.JavacTask;
 44 import toolbox.Task;
 45 import toolbox.ToolBox;
 46 
 47 public class NoCompletionFailureSkipOnSpeculativeAttribution {
 48 
 49     private static final String TSrc =
 50         &quot;import one.A;\n&quot; +
 51         &quot;class T {\n&quot; +
 52         &quot;  {\n&quot; +
 53         &quot;    System.err.println(two.C.D.g());\n&quot; +
 54         &quot;  }\n&quot; +
 55         &quot;}&quot;;
 56 
 57     private static final String CSrc =
 58         &quot;package two;\n&quot; +
 59         &quot;public class C {\n&quot; +
 60         &quot;  public static class D {\n&quot; +
 61         &quot;    public static int g() {\n&quot; +
 62         &quot;      return 1;\n&quot; +
 63         &quot;    }\n&quot; +
 64         &quot;  }\n&quot; +
 65         &quot;}&quot;;
 66 
 67     private static final String ASrc =
 68         &quot;package one;\n&quot; +
 69         &quot;public class A {\n&quot; +
 70         &quot;  public A(two.C.D x) {}\n&quot; +
 71         &quot;}&quot;;
 72 
 73     public static void main(String[] args) throws Exception {
 74         new NoCompletionFailureSkipOnSpeculativeAttribution().test();
 75         new NoCompletionFailureSkipOnSpeculativeAttribution().test8233655();
 76     }
 77 
 78     public void test() throws Exception {
 79         ToolBox tb = new ToolBox();
 80         tb.writeJavaFiles(Paths.get(&quot;.&quot;), ASrc, CSrc, TSrc);
 81 
 82         new JavacTask(tb)
 83                 .classpath(&quot;.&quot;)
 84                 .files(&quot;T.java&quot;)
 85                 .run();
 86 
 87         tb.deleteFiles(&quot;two/C.class&quot;, &quot;two/C$D.class&quot;);
 88 
 89         List&lt;String&gt; output = new JavacTask(tb)
 90                 .sourcepath(File.pathSeparator)
 91                 .options(&quot;-XDrawDiagnostics&quot;, &quot;-XDshould-stop.ifError=FLOW&quot;)
 92                 .classpath(&quot;.&quot;)
 93                 .files(&quot;T.java&quot;)
 94                 .run(Task.Expect.FAIL)
 95                 .writeAll()
 96                 .getOutputLines(Task.OutputKind.DIRECT);
 97 
 98         List&lt;String&gt; expectedOutput = List.of(
 99                 &quot;T.java:4:29: compiler.err.cant.access: two.C.D, (compiler.misc.class.file.not.found: two.C$D)&quot;,
100                 &quot;1 error&quot;
101         );
102 
103         Assert.check(output.equals(expectedOutput));
104     }
105 
106     public void test8233655() throws Exception {
107         ToolBox tb = new ToolBox();
108         tb.writeJavaFiles(Paths.get(&quot;.&quot;),
109                           &quot;public class Test {&quot; +
110                           &quot;    private &lt;T&gt; T test(Class&lt;?&gt; c) {\n&quot; +
111                           &quot;        Class&lt;?&gt; c2 = test(test(Helper.class));\n&quot; +
112                           &quot;        return null;\n&quot; +
113                           &quot;    }\n&quot; +
114                           &quot;}&quot;,
115                           &quot;public class Helper extends Unknown {}&quot;);
116 
117         List&lt;String&gt; output = new JavacTask(tb)
118                 .sourcepath(&quot;.&quot;)
119                 .options(&quot;-XDrawDiagnostics&quot;)
120                 .classpath(&quot;.&quot;)
121                 .files(&quot;Test.java&quot;)
122                 .run(Task.Expect.FAIL)
123                 .writeAll()
124                 .getOutputLines(Task.OutputKind.DIRECT);
125 
126         List&lt;String&gt; expectedOutput = List.of(
127                 &quot;Helper.java:1:29: compiler.err.cant.resolve: kindname.class, Unknown, , &quot;,
128                 &quot;1 error&quot;
129         );
130 
131         Assert.check(output.equals(expectedOutput));
132     }
133 }
    </pre>
  </body>
</html>