<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New test/langtools/tools/javac/preview/PreviewErrors.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @bug 8226585
 27  * @summary Verify behavior w.r.t. preview feature API errors and warnings
 28  * @library /tools/lib /tools/javac/lib
 29  * @modules
 30  *      java.base/jdk.internal
 31  *      jdk.compiler/com.sun.tools.javac.api
 32  *      jdk.compiler/com.sun.tools.javac.file
 33  *      jdk.compiler/com.sun.tools.javac.main
 34  *      jdk.compiler/com.sun.tools.javac.util
 35  * @build toolbox.ToolBox toolbox.JavacTask
 36  * @build combo.ComboTestHelper
 37  * @compile --enable-preview -source ${jdk.version} PreviewErrors.java
 38  * @run main/othervm --enable-preview PreviewErrors
 39  */
 40 
 41 import java.io.IOException;
 42 import java.nio.file.Files;
 43 import java.nio.file.Path;
 44 import java.nio.file.Paths;
 45 
 46 import combo.ComboInstance;
 47 import combo.ComboParameter;
 48 import combo.ComboTask;
 49 import combo.ComboTestHelper;
 50 import java.util.Arrays;
 51 import java.util.Set;
 52 import java.util.stream.Collectors;
 53 import javax.tools.Diagnostic;
 54 
 55 import jdk.internal.PreviewFeature;
 56 
 57 import toolbox.JavacTask;
 58 import toolbox.ToolBox;
 59 
 60 public class PreviewErrors extends ComboInstance&lt;PreviewErrors&gt; {
 61 
 62     protected ToolBox tb;
 63 
 64     PreviewErrors() {
 65         super();
 66         tb = new ToolBox();
 67     }
 68 
 69     public static void main(String... args) throws Exception {
 70         new ComboTestHelper&lt;PreviewErrors&gt;()
 71                 .withDimension(&quot;ESSENTIAL&quot;, (x, essential) -&gt; x.essential = essential, EssentialAPI.values())
 72                 .withDimension(&quot;PREVIEW&quot;, (x, preview) -&gt; x.preview = preview, Preview.values())
 73                 .withDimension(&quot;LINT&quot;, (x, lint) -&gt; x.lint = lint, Lint.values())
 74                 .withDimension(&quot;SUPPRESS&quot;, (x, suppress) -&gt; x.suppress = suppress, Suppress.values())
 75                 .withDimension(&quot;FROM&quot;, (x, from) -&gt; x.from = from, PreviewFrom.values())
 76                 .run(PreviewErrors::new);
 77     }
 78 
 79     private EssentialAPI essential;
 80     private Preview preview;
 81     private Lint lint;
 82     private Suppress suppress;
 83     private PreviewFrom from;
 84 
 85     @Override
 86     public void doWork() throws IOException {
 87         Path base = Paths.get(&quot;.&quot;);
 88         Path src = base.resolve(&quot;src&quot;);
 89         Path srcJavaBase = src.resolve(&quot;java.base&quot;);
 90         Path classes = base.resolve(&quot;classes&quot;);
 91         Path classesJavaBase = classes.resolve(&quot;java.base&quot;);
 92 
 93         Files.createDirectories(classesJavaBase);
 94 
 95         String previewAPI = &quot;&quot;&quot;
 96                             package preview.api;
 97                             public class Extra {
 98                                 @jdk.internal.PreviewFeature(feature=jdk.internal.PreviewFeature.Feature.${preview}
 99                                                              ${essential})
100                                 public static void test() { }
101                                 @jdk.internal.PreviewFeature(feature=jdk.internal.PreviewFeature.Feature.${preview}
102                                                              ${essential})
103                                 public static class Clazz {}
104                             }
105                             &quot;&quot;&quot;.replace(&quot;${preview}&quot;, PreviewFeature.Feature.values()[0].name())
106                                .replace(&quot;${essential}&quot;, essential.expand(null));
107 
108          if (from == PreviewFrom.CLASS) {
109             tb.writeJavaFiles(srcJavaBase, previewAPI);
110 
111             new JavacTask(tb)
112                     .outdir(classesJavaBase)
113                     .options(&quot;--patch-module&quot;, &quot;java.base=&quot; + srcJavaBase.toString())
114                     .files(tb.findJavaFiles(srcJavaBase))
115                     .run()
116                     .writeAll();
117          }
118 
119         ComboTask task = newCompilationTask()
120                 .withSourceFromTemplate(&quot;&quot;&quot;
121                                         package test;
122                                         public class Test {
123                                             #{SUPPRESS}
124                                             public void test() {
125                                                 preview.api.Extra.test();
126                                                 preview.api.Extra.Clazz c;
127                                             }
128                                         }
129                                         &quot;&quot;&quot;)
130                 .withOption(&quot;-XDrawDiagnostics&quot;)
131                 .withOption(&quot;-source&quot;)
132                 .withOption(String.valueOf(Runtime.version().feature()));
133 
134         if (from == PreviewFrom.CLASS) {
135             task.withOption(&quot;--patch-module&quot;)
136                 .withOption(&quot;java.base=&quot; + classesJavaBase.toString())
137                 .withOption(&quot;--add-exports&quot;)
138                 .withOption(&quot;java.base/preview.api=ALL-UNNAMED&quot;);
139         } else {
140             task.withSourceFromTemplate(&quot;Extra&quot;, previewAPI)
141                 .withOption(&quot;--add-exports&quot;)
142                 .withOption(&quot;java.base/jdk.internal=ALL-UNNAMED&quot;);
143         }
144 
145         if (preview.expand(null)!= null) {
146             task = task.withOption(preview.expand(null));
147         }
148 
149         if (lint.expand(null) != null) {
150             task = task.withOption(lint.expand(null));
151         }
152 
153         task.generate(result -&gt; {
154                 Set&lt;String&gt; actual = Arrays.stream(Diagnostic.Kind.values())
155                                             .flatMap(kind -&gt; result.diagnosticsForKind(kind).stream())
156                                             .map(d -&gt; d.getLineNumber() + &quot;:&quot; + d.getColumnNumber() + &quot;:&quot; + d.getCode())
157                                             .collect(Collectors.toSet());
158                 Set&lt;String&gt; expected;
159                 boolean ok;
160                 if (essential == EssentialAPI.YES) {
161                     if (preview == Preview.YES) {
162                         if (suppress == Suppress.YES) {
163                             expected = Set.of();
164                         } else if (lint == Lint.ENABLE_PREVIEW) {
165                             expected = Set.of(&quot;5:26:compiler.warn.is.preview&quot;, &quot;6:26:compiler.warn.is.preview&quot;);
166                         } else {
167                             expected = Set.of(&quot;-1:-1:compiler.note.preview.filename&quot;,
168                                               &quot;-1:-1:compiler.note.preview.recompile&quot;);
169                         }
170                         ok = true;
171                     } else {
172                         expected = Set.of(&quot;5:26:compiler.err.is.preview&quot;, &quot;6:26:compiler.err.is.preview&quot;);
173                         ok = false;
174                     }
175                 } else {
176                     if (suppress == Suppress.YES) {
177                         expected = Set.of();
178                     } else if ((preview == Preview.YES &amp;&amp; (lint == Lint.NONE || lint == Lint.DISABLE_PREVIEW)) ||
179                                (preview == Preview.NO &amp;&amp; lint == Lint.DISABLE_PREVIEW)) {
180                         expected = Set.of(&quot;-1:-1:compiler.note.preview.filename&quot;,
181                                           &quot;-1:-1:compiler.note.preview.recompile&quot;);
182                     } else {
183                         expected = Set.of(&quot;5:26:compiler.warn.is.preview&quot;, &quot;6:26:compiler.warn.is.preview&quot;);
184                     }
185                     ok = true;
186                 }
187                 if (ok) {
188                     if (!result.get().iterator().hasNext()) {
189                         throw new IllegalStateException(&quot;Did not succeed as expected.&quot; + actual);
190                     }
191                 } else {
192                     if (result.get().iterator().hasNext()) {
193                         throw new IllegalStateException(&quot;Succeed unexpectedly.&quot;);
194                     }
195                 }
196                 if (!expected.equals(actual)) {
197                     throw new IllegalStateException(&quot;Unexpected output for &quot; + essential + &quot;, &quot; + preview + &quot;, &quot; + lint + &quot;, &quot; + suppress + &quot;, &quot; + from + &quot;: actual: \&quot;&quot; + actual + &quot;\&quot;, expected: \&quot;&quot; + expected + &quot;\&quot;&quot;);
198                 }
199             });
200     }
201 
202     public enum EssentialAPI implements ComboParameter {
203         YES(&quot;, essentialAPI=true&quot;),
204         NO(&quot;, essentialAPI=false&quot;);
205 
206         private final String code;
207 
208         private EssentialAPI(String code) {
209             this.code = code;
210         }
211 
212         public String expand(String optParameter) {
213             return code;
214         }
215     }
216 
217     public enum Preview implements ComboParameter {
218         YES(&quot;--enable-preview&quot;),
219         NO(null);
220 
221         private final String opt;
222 
223         private Preview(String opt) {
224             this.opt = opt;
225         }
226 
227         public String expand(String optParameter) {
228             return opt;
229         }
230     }
231 
232     public enum Lint implements ComboParameter {
233         NONE(null),
234         ENABLE_PREVIEW(&quot;-Xlint:preview&quot;),
235         DISABLE_PREVIEW(&quot;-Xlint:-preview&quot;);
236 
237         private final String opt;
238 
239         private Lint(String opt) {
240             this.opt = opt;
241         }
242 
243         public String expand(String optParameter) {
244             return opt;
245         }
246     }
247 
248     public enum Suppress implements ComboParameter {
249         YES(&quot;@SuppressWarnings(\&quot;preview\&quot;)&quot;),
250         NO(&quot;&quot;);
251 
252         private final String code;
253 
254         private Suppress(String code) {
255             this.code = code;
256         }
257 
258         public String expand(String optParameter) {
259             return code;
260         }
261     }
262 
263     public enum PreviewFrom implements ComboParameter {
264         CLASS,
265         SOURCE;
266 
267         private PreviewFrom() {
268         }
269 
270         public String expand(String optParameter) {
271             throw new IllegalStateException();
272         }
273     }
274 }
    </pre>
  </body>
</html>