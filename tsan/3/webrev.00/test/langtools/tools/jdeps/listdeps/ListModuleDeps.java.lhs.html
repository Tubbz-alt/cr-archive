<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/langtools/tools/jdeps/listdeps/ListModuleDeps.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
    <script type="text/javascript" src="../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2016, 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @bug 8167057
 27  * @summary Tests --list-deps, --list-reduced-deps, --print-module-deps options
 28  * @modules java.logging
 29  *          java.xml
 30  *          jdk.compiler
 31  *          jdk.jdeps
 32  *          jdk.unsupported
 33  * @library ../lib
 34  * @build CompilerUtils JdepsRunner
 35  * @run testng ListModuleDeps
 36  */
 37 
 38 import java.io.File;
 39 import java.nio.file.Path;
 40 import java.nio.file.Paths;
 41 import java.util.Arrays;
 42 import java.util.List;
 43 import java.util.stream.Collectors;
 44 
 45 import org.testng.annotations.BeforeTest;
 46 import org.testng.annotations.DataProvider;
 47 import org.testng.annotations.Test;
 48 
 49 import static org.testng.Assert.assertEquals;
 50 import static org.testng.Assert.assertTrue;
 51 
 52 public class ListModuleDeps {
 53     private static final String TEST_SRC = System.getProperty(&quot;test.src&quot;);
 54 
 55     private static final Path SRC_DIR = Paths.get(TEST_SRC, &quot;src&quot;);
 56     private static final Path CLASSES_DIR = Paths.get(&quot;classes&quot;);
 57     private static final Path LIB_DIR = Paths.get(&quot;lib&quot;);
 58     private static final Path LIB2_DIR = Paths.get(&quot;lib2&quot;);
 59 
 60     private static final Path HI_CLASS =
 61         CLASSES_DIR.resolve(&quot;hi&quot;).resolve(&quot;Hi.class&quot;);
 62     private static final Path FOO_CLASS =
 63         CLASSES_DIR.resolve(&quot;z&quot;).resolve(&quot;Foo.class&quot;);
 64     private static final Path BAR_CLASS =
 65         CLASSES_DIR.resolve(&quot;z&quot;).resolve(&quot;Bar.class&quot;);
 66     private static final Path UNSAFE_CLASS =
 67         CLASSES_DIR.resolve(&quot;z&quot;).resolve(&quot;UseUnsafe.class&quot;);
 68 
 69     /**
 70      * Compiles classes used by the test
 71      */
 72     @BeforeTest
 73     public void compileAll() throws Exception {
 74         // compile library
 75         assertTrue(CompilerUtils.compile(Paths.get(TEST_SRC, &quot;src&quot;, &quot;lib2&quot;), LIB2_DIR));
 76         assertTrue(CompilerUtils.compile(Paths.get(TEST_SRC, &quot;src&quot;, &quot;lib&quot;), LIB_DIR, &quot;-cp&quot;, LIB2_DIR.toString()));
 77 
 78         // simple program depends only on java.base
 79         assertTrue(CompilerUtils.compile(Paths.get(TEST_SRC, &quot;src&quot;, &quot;hi&quot;), CLASSES_DIR));
 80 
 81         // compile classes in unnamed module
 82         assertTrue(CompilerUtils.compile(Paths.get(TEST_SRC, &quot;src&quot;, &quot;z&quot;),
 83             CLASSES_DIR,
 84             &quot;-cp&quot;, LIB_DIR.toString(),
 85             &quot;--add-exports=java.base/jdk.internal.misc=ALL-UNNAMED&quot;,
 86             &quot;--add-exports=java.base/sun.security.util=ALL-UNNAMED&quot;,
 87             &quot;--add-exports=java.xml/jdk.xml.internal=ALL-UNNAMED&quot;
 88         ));
 89     }
 90 
 91     @DataProvider(name = &quot;jdkModules&quot;)
 92     public Object[][] jdkModules() {
 93         return new Object[][]{
 94             {&quot;jdk.compiler&quot;, new String[]{
<a name="2" id="anc2"></a>
 95                                 &quot;java.base/jdk.internal.jmod&quot;,
 96                                 &quot;java.base/jdk.internal.misc&quot;,
 97                                 &quot;java.base/sun.reflect.annotation&quot;,
 98                                 &quot;java.compiler&quot;,
 99                              }
100             },
101         };
102     }
103 
104     @Test(dataProvider = &quot;jdkModules&quot;)
105     public void testJDKModule(String moduleName, String[] expected) {
106         JdepsRunner jdeps = JdepsRunner.run(
107             &quot;--list-deps&quot;, &quot;-m&quot;, moduleName
108         );
109         String[] output = Arrays.stream(jdeps.output())
110                                 .map(s -&gt; s.trim())
111                                 .toArray(String[]::new);
112         assertEquals(output, expected);
113     }
114 
115     @Test(dataProvider = &quot;listdeps&quot;)
116     public void testListDeps(Path classes, String[] expected) {
117         JdepsRunner jdeps = JdepsRunner.run(
118             &quot;--class-path&quot;, LIB_DIR.toString() + File.pathSeparator + LIB2_DIR.toString(),
119             &quot;--list-deps&quot;, classes.toString()
120         );
121         String[] output = Arrays.stream(jdeps.output())
122                                 .map(s -&gt; s.trim())
123                                 .toArray(String[]::new);
124         assertEquals(output, expected);
125     }
126 
127     @Test(dataProvider = &quot;reduceddeps&quot;)
128     public void testListReducedDeps(Path classes, String[]  expected) {
129         JdepsRunner jdeps = JdepsRunner.run(
130             &quot;--class-path&quot;, LIB_DIR.toString() + File.pathSeparator + LIB2_DIR.toString(),
131             &quot;--list-reduced-deps&quot;, classes.toString()
132         );
133         String[] output = Arrays.stream(jdeps.output())
134                                 .map(s -&gt; s.trim())
135                                 .toArray(String[]::new);
136         assertEquals(output, expected);
137     }
138 
139 
140     @DataProvider(name = &quot;listdeps&quot;)
141     public Object[][] listdeps() {
142         return new Object[][] {
143             { CLASSES_DIR,  new String[] {
144                                 &quot;java.base/jdk.internal.misc&quot;,
145                                 &quot;java.base/sun.security.util&quot;,
146                                 &quot;java.logging&quot;,
147                                 &quot;java.management&quot;,
148                                 &quot;java.sql&quot;,
149                                 &quot;java.xml/jdk.xml.internal&quot;,
150                                 &quot;jdk.unsupported&quot;
151                             }
152             },
153 
154             { HI_CLASS,     new String[] {
155                                 &quot;java.base&quot;
156                             }
157             },
158 
159             { FOO_CLASS,    new String[] {
160                                 &quot;java.base&quot;,
161                                 &quot;java.logging&quot;,
162                                 &quot;java.management&quot;,
163                                 &quot;java.sql&quot;,
164                                 &quot;java.xml&quot;
165                             }
166             },
167 
168             { BAR_CLASS,    new String[] {
169                                 &quot;java.base/sun.security.util&quot;,
170                                 &quot;java.xml/jdk.xml.internal&quot;,
171                             }
172             },
173 
174             { UNSAFE_CLASS, new String[] {
175                                 &quot;java.base/jdk.internal.misc&quot;,
176                                 &quot;jdk.unsupported&quot;
177                             }
178             },
179         };
180     }
181 
182     @DataProvider(name = &quot;reduceddeps&quot;)
183     public Object[][] reduceddeps() {
184         Path barClass = CLASSES_DIR.resolve(&quot;z&quot;).resolve(&quot;Bar.class&quot;);
185 
186         return new Object[][] {
187             { CLASSES_DIR,  new String[] {
188                                 &quot;java.base/jdk.internal.misc&quot;,
189                                 &quot;java.base/sun.security.util&quot;,
190                                 &quot;java.management&quot;,
191                                 &quot;java.sql&quot;,
192                                 &quot;java.xml/jdk.xml.internal&quot;,
193                                 &quot;jdk.unsupported&quot;
194                             }
195             },
196 
197             { HI_CLASS,     new String[] {
198                                 &quot;java.base&quot;
199                             }
200             },
201 
202             { FOO_CLASS,    new String[] {
203                                 &quot;java.base&quot;,
204                                 &quot;java.management&quot;,
205                                 &quot;java.sql&quot;
206                             }
207             },
208 
209             { BAR_CLASS,    new String[] {
210                                 &quot;java.base/sun.security.util&quot;,
211                                 &quot;java.xml/jdk.xml.internal&quot;,
212                             }
213             },
214 
215             { UNSAFE_CLASS, new String[] {
216                                 &quot;java.base/jdk.internal.misc&quot;,
217                                 &quot;jdk.unsupported&quot;
218                             }
219             },
220         };
221     }
222 
223     @Test(dataProvider = &quot;moduledeps&quot;)
224     public void testPrintModuleDeps(Path classes, String expected) {
225         JdepsRunner jdeps = JdepsRunner.run(
226             &quot;--class-path&quot;, LIB_DIR.toString() + File.pathSeparator + LIB2_DIR.toString(),
227             &quot;--print-module-deps&quot;, classes.toString()
228         );
229         String output = Arrays.stream(jdeps.output())
230             .map(s -&gt; s.trim())
231             .collect(Collectors.joining(&quot;,&quot;));
232         assertEquals(output, expected);
233     }
234 
235 
236     @DataProvider(name = &quot;moduledeps&quot;)
237     public Object[][] moduledeps() {
238         Path barClass = CLASSES_DIR.resolve(&quot;z&quot;).resolve(&quot;Bar.class&quot;);
239 
240         return new Object[][] {
241             // java.xml is an implied reads edge from java.sql
242             { CLASSES_DIR,  &quot;java.base,java.management,java.sql,jdk.unsupported&quot;},
243             { HI_CLASS,     &quot;java.base&quot;},
244             { FOO_CLASS,    &quot;java.base,java.management,java.sql&quot;},
245             { BAR_CLASS,    &quot;java.base,java.xml&quot;},
246             { UNSAFE_CLASS, &quot;java.base,jdk.unsupported&quot;},
247         };
248     }
249 
250     @Test(dataProvider = &quot;noRecursiveModuledeps&quot;)
251     public void testNoRecursiveModuleDeps(Path classes, String expected) {
252         JdepsRunner jdeps = JdepsRunner.run(
253             &quot;--class-path&quot;, LIB_DIR.toString() + File.pathSeparator + LIB2_DIR.toString(),
254             &quot;--print-module-deps&quot;, &quot;--no-recursive&quot;, classes.toString()
255         );
256         String output = Arrays.stream(jdeps.output())
257             .map(s -&gt; s.trim())
258             .collect(Collectors.joining(&quot;,&quot;));
259         assertEquals(output, expected);
260     }
261 
262     @DataProvider(name = &quot;noRecursiveModuledeps&quot;)
263     public Object[][] noRecursiveModuledeps() {
264         Path barClass = CLASSES_DIR.resolve(&quot;z&quot;).resolve(&quot;Bar.class&quot;);
265 
266         return new Object[][] {
267             // java.xml is an implied reads edge from java.sql
268             { CLASSES_DIR,  &quot;java.base,java.sql,jdk.unsupported&quot;},
269             { HI_CLASS,     &quot;java.base&quot;},
270             { FOO_CLASS,    &quot;java.base,java.sql&quot;},
271             { BAR_CLASS,    &quot;java.base,java.xml&quot;},
272             { UNSAFE_CLASS, &quot;java.base,jdk.unsupported&quot;},
273         };
274     }
275 
276     @DataProvider(name = &quot;recursiveDeps&quot;)
277     public Object[][] recursiveDeps() {
278         return new Object[][] {
279             {   // lib2 is classpath but not analyzed because lib.Lib is not present
280                 // but it is the only class depending on lib2.Lib2
281                 List.of(&quot;--list-deps&quot;, &quot;--class-path&quot;, LIB2_DIR.toString(),
282                         &quot;--ignore-missing-deps&quot;, CLASSES_DIR.toString()),
283                 new String[] {
284                     &quot;java.base/jdk.internal.misc&quot;,
285                     &quot;java.base/sun.security.util&quot;,
286                     &quot;java.logging&quot;,
287                     &quot;java.sql&quot;,
288                     &quot;java.xml/jdk.xml.internal&quot;,
289                     &quot;jdk.unsupported&quot;
290                 }
291             },
292             {   // lib2 is classpath but not analyzed because lib.Lib is not present
293                 // but it is the only class depending on lib2.Lib2
294                 List.of(&quot;--print-module-deps&quot;, &quot;--class-path&quot;, LIB2_DIR.toString(),
295                         &quot;--ignore-missing-deps&quot;, CLASSES_DIR.toString()),
296                 new String[] {
297                     &quot;java.base,java.sql,jdk.unsupported&quot;
298                 }
299             },
300             {   // Foo depends on lib.Lib which depends on lib2.Libs
301                 List.of(&quot;--print-module-deps&quot;,
302                         &quot;--ignore-missing-deps&quot;, FOO_CLASS.toString()),
303                 new String[] {
304                     &quot;java.base,java.sql&quot;
305                 }
306             },
307         };
308     }
309 
310     @Test(dataProvider = &quot;recursiveDeps&quot;)
311     public void testRecursiveDeps(List&lt;String&gt; options, String[] expected) {
312         JdepsRunner jdeps = JdepsRunner.run(options.toArray(new String[0]));
313         String[] output = Arrays.stream(jdeps.output())
314                                 .map(s -&gt; s.trim())
315                                 .toArray(String[]::new);
316         assertEquals(output, expected);
317     }
318 }
<a name="3" id="anc3"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="3" type="hidden" />
</body>
</html>