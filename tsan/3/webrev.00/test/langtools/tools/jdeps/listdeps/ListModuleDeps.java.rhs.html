<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/langtools/tools/jdeps/listdeps/ListModuleDeps.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
    <script type="text/javascript" src="../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2016, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @bug 8167057
 27  * @summary Tests --list-deps, --list-reduced-deps, --print-module-deps options
 28  * @modules java.logging
 29  *          java.xml
 30  *          jdk.compiler
 31  *          jdk.jdeps
 32  *          jdk.unsupported
 33  * @library ../lib
 34  * @build CompilerUtils JdepsRunner
 35  * @run testng ListModuleDeps
 36  */
 37 
 38 import java.io.File;
 39 import java.nio.file.Path;
 40 import java.nio.file.Paths;
 41 import java.util.Arrays;
 42 import java.util.List;
 43 import java.util.stream.Collectors;
 44 
 45 import org.testng.annotations.BeforeTest;
 46 import org.testng.annotations.DataProvider;
 47 import org.testng.annotations.Test;
 48 
 49 import static org.testng.Assert.assertEquals;
 50 import static org.testng.Assert.assertTrue;
 51 
 52 public class ListModuleDeps {
 53     private static final String TEST_SRC = System.getProperty(&quot;test.src&quot;);
 54 
 55     private static final Path SRC_DIR = Paths.get(TEST_SRC, &quot;src&quot;);
 56     private static final Path CLASSES_DIR = Paths.get(&quot;classes&quot;);
 57     private static final Path LIB_DIR = Paths.get(&quot;lib&quot;);
 58     private static final Path LIB2_DIR = Paths.get(&quot;lib2&quot;);
 59 
 60     private static final Path HI_CLASS =
 61         CLASSES_DIR.resolve(&quot;hi&quot;).resolve(&quot;Hi.class&quot;);
 62     private static final Path FOO_CLASS =
 63         CLASSES_DIR.resolve(&quot;z&quot;).resolve(&quot;Foo.class&quot;);
 64     private static final Path BAR_CLASS =
 65         CLASSES_DIR.resolve(&quot;z&quot;).resolve(&quot;Bar.class&quot;);
 66     private static final Path UNSAFE_CLASS =
 67         CLASSES_DIR.resolve(&quot;z&quot;).resolve(&quot;UseUnsafe.class&quot;);
 68 
 69     /**
 70      * Compiles classes used by the test
 71      */
 72     @BeforeTest
 73     public void compileAll() throws Exception {
 74         // compile library
 75         assertTrue(CompilerUtils.compile(Paths.get(TEST_SRC, &quot;src&quot;, &quot;lib2&quot;), LIB2_DIR));
 76         assertTrue(CompilerUtils.compile(Paths.get(TEST_SRC, &quot;src&quot;, &quot;lib&quot;), LIB_DIR, &quot;-cp&quot;, LIB2_DIR.toString()));
 77 
 78         // simple program depends only on java.base
 79         assertTrue(CompilerUtils.compile(Paths.get(TEST_SRC, &quot;src&quot;, &quot;hi&quot;), CLASSES_DIR));
 80 
 81         // compile classes in unnamed module
 82         assertTrue(CompilerUtils.compile(Paths.get(TEST_SRC, &quot;src&quot;, &quot;z&quot;),
 83             CLASSES_DIR,
 84             &quot;-cp&quot;, LIB_DIR.toString(),
 85             &quot;--add-exports=java.base/jdk.internal.misc=ALL-UNNAMED&quot;,
 86             &quot;--add-exports=java.base/sun.security.util=ALL-UNNAMED&quot;,
 87             &quot;--add-exports=java.xml/jdk.xml.internal=ALL-UNNAMED&quot;
 88         ));
 89     }
 90 
 91     @DataProvider(name = &quot;jdkModules&quot;)
 92     public Object[][] jdkModules() {
 93         return new Object[][]{
 94             {&quot;jdk.compiler&quot;, new String[]{
<a name="2" id="anc2"></a><span class="line-added"> 95                                 &quot;java.base/jdk.internal&quot;,</span>
 96                                 &quot;java.base/jdk.internal.jmod&quot;,
 97                                 &quot;java.base/jdk.internal.misc&quot;,
 98                                 &quot;java.base/sun.reflect.annotation&quot;,
 99                                 &quot;java.compiler&quot;,
100                              }
101             },
102         };
103     }
104 
105     @Test(dataProvider = &quot;jdkModules&quot;)
106     public void testJDKModule(String moduleName, String[] expected) {
107         JdepsRunner jdeps = JdepsRunner.run(
108             &quot;--list-deps&quot;, &quot;-m&quot;, moduleName
109         );
110         String[] output = Arrays.stream(jdeps.output())
111                                 .map(s -&gt; s.trim())
112                                 .toArray(String[]::new);
113         assertEquals(output, expected);
114     }
115 
116     @Test(dataProvider = &quot;listdeps&quot;)
117     public void testListDeps(Path classes, String[] expected) {
118         JdepsRunner jdeps = JdepsRunner.run(
119             &quot;--class-path&quot;, LIB_DIR.toString() + File.pathSeparator + LIB2_DIR.toString(),
120             &quot;--list-deps&quot;, classes.toString()
121         );
122         String[] output = Arrays.stream(jdeps.output())
123                                 .map(s -&gt; s.trim())
124                                 .toArray(String[]::new);
125         assertEquals(output, expected);
126     }
127 
128     @Test(dataProvider = &quot;reduceddeps&quot;)
129     public void testListReducedDeps(Path classes, String[]  expected) {
130         JdepsRunner jdeps = JdepsRunner.run(
131             &quot;--class-path&quot;, LIB_DIR.toString() + File.pathSeparator + LIB2_DIR.toString(),
132             &quot;--list-reduced-deps&quot;, classes.toString()
133         );
134         String[] output = Arrays.stream(jdeps.output())
135                                 .map(s -&gt; s.trim())
136                                 .toArray(String[]::new);
137         assertEquals(output, expected);
138     }
139 
140 
141     @DataProvider(name = &quot;listdeps&quot;)
142     public Object[][] listdeps() {
143         return new Object[][] {
144             { CLASSES_DIR,  new String[] {
145                                 &quot;java.base/jdk.internal.misc&quot;,
146                                 &quot;java.base/sun.security.util&quot;,
147                                 &quot;java.logging&quot;,
148                                 &quot;java.management&quot;,
149                                 &quot;java.sql&quot;,
150                                 &quot;java.xml/jdk.xml.internal&quot;,
151                                 &quot;jdk.unsupported&quot;
152                             }
153             },
154 
155             { HI_CLASS,     new String[] {
156                                 &quot;java.base&quot;
157                             }
158             },
159 
160             { FOO_CLASS,    new String[] {
161                                 &quot;java.base&quot;,
162                                 &quot;java.logging&quot;,
163                                 &quot;java.management&quot;,
164                                 &quot;java.sql&quot;,
165                                 &quot;java.xml&quot;
166                             }
167             },
168 
169             { BAR_CLASS,    new String[] {
170                                 &quot;java.base/sun.security.util&quot;,
171                                 &quot;java.xml/jdk.xml.internal&quot;,
172                             }
173             },
174 
175             { UNSAFE_CLASS, new String[] {
176                                 &quot;java.base/jdk.internal.misc&quot;,
177                                 &quot;jdk.unsupported&quot;
178                             }
179             },
180         };
181     }
182 
183     @DataProvider(name = &quot;reduceddeps&quot;)
184     public Object[][] reduceddeps() {
185         Path barClass = CLASSES_DIR.resolve(&quot;z&quot;).resolve(&quot;Bar.class&quot;);
186 
187         return new Object[][] {
188             { CLASSES_DIR,  new String[] {
189                                 &quot;java.base/jdk.internal.misc&quot;,
190                                 &quot;java.base/sun.security.util&quot;,
191                                 &quot;java.management&quot;,
192                                 &quot;java.sql&quot;,
193                                 &quot;java.xml/jdk.xml.internal&quot;,
194                                 &quot;jdk.unsupported&quot;
195                             }
196             },
197 
198             { HI_CLASS,     new String[] {
199                                 &quot;java.base&quot;
200                             }
201             },
202 
203             { FOO_CLASS,    new String[] {
204                                 &quot;java.base&quot;,
205                                 &quot;java.management&quot;,
206                                 &quot;java.sql&quot;
207                             }
208             },
209 
210             { BAR_CLASS,    new String[] {
211                                 &quot;java.base/sun.security.util&quot;,
212                                 &quot;java.xml/jdk.xml.internal&quot;,
213                             }
214             },
215 
216             { UNSAFE_CLASS, new String[] {
217                                 &quot;java.base/jdk.internal.misc&quot;,
218                                 &quot;jdk.unsupported&quot;
219                             }
220             },
221         };
222     }
223 
224     @Test(dataProvider = &quot;moduledeps&quot;)
225     public void testPrintModuleDeps(Path classes, String expected) {
226         JdepsRunner jdeps = JdepsRunner.run(
227             &quot;--class-path&quot;, LIB_DIR.toString() + File.pathSeparator + LIB2_DIR.toString(),
228             &quot;--print-module-deps&quot;, classes.toString()
229         );
230         String output = Arrays.stream(jdeps.output())
231             .map(s -&gt; s.trim())
232             .collect(Collectors.joining(&quot;,&quot;));
233         assertEquals(output, expected);
234     }
235 
236 
237     @DataProvider(name = &quot;moduledeps&quot;)
238     public Object[][] moduledeps() {
239         Path barClass = CLASSES_DIR.resolve(&quot;z&quot;).resolve(&quot;Bar.class&quot;);
240 
241         return new Object[][] {
242             // java.xml is an implied reads edge from java.sql
243             { CLASSES_DIR,  &quot;java.base,java.management,java.sql,jdk.unsupported&quot;},
244             { HI_CLASS,     &quot;java.base&quot;},
245             { FOO_CLASS,    &quot;java.base,java.management,java.sql&quot;},
246             { BAR_CLASS,    &quot;java.base,java.xml&quot;},
247             { UNSAFE_CLASS, &quot;java.base,jdk.unsupported&quot;},
248         };
249     }
250 
251     @Test(dataProvider = &quot;noRecursiveModuledeps&quot;)
252     public void testNoRecursiveModuleDeps(Path classes, String expected) {
253         JdepsRunner jdeps = JdepsRunner.run(
254             &quot;--class-path&quot;, LIB_DIR.toString() + File.pathSeparator + LIB2_DIR.toString(),
255             &quot;--print-module-deps&quot;, &quot;--no-recursive&quot;, classes.toString()
256         );
257         String output = Arrays.stream(jdeps.output())
258             .map(s -&gt; s.trim())
259             .collect(Collectors.joining(&quot;,&quot;));
260         assertEquals(output, expected);
261     }
262 
263     @DataProvider(name = &quot;noRecursiveModuledeps&quot;)
264     public Object[][] noRecursiveModuledeps() {
265         Path barClass = CLASSES_DIR.resolve(&quot;z&quot;).resolve(&quot;Bar.class&quot;);
266 
267         return new Object[][] {
268             // java.xml is an implied reads edge from java.sql
269             { CLASSES_DIR,  &quot;java.base,java.sql,jdk.unsupported&quot;},
270             { HI_CLASS,     &quot;java.base&quot;},
271             { FOO_CLASS,    &quot;java.base,java.sql&quot;},
272             { BAR_CLASS,    &quot;java.base,java.xml&quot;},
273             { UNSAFE_CLASS, &quot;java.base,jdk.unsupported&quot;},
274         };
275     }
276 
277     @DataProvider(name = &quot;recursiveDeps&quot;)
278     public Object[][] recursiveDeps() {
279         return new Object[][] {
280             {   // lib2 is classpath but not analyzed because lib.Lib is not present
281                 // but it is the only class depending on lib2.Lib2
282                 List.of(&quot;--list-deps&quot;, &quot;--class-path&quot;, LIB2_DIR.toString(),
283                         &quot;--ignore-missing-deps&quot;, CLASSES_DIR.toString()),
284                 new String[] {
285                     &quot;java.base/jdk.internal.misc&quot;,
286                     &quot;java.base/sun.security.util&quot;,
287                     &quot;java.logging&quot;,
288                     &quot;java.sql&quot;,
289                     &quot;java.xml/jdk.xml.internal&quot;,
290                     &quot;jdk.unsupported&quot;
291                 }
292             },
293             {   // lib2 is classpath but not analyzed because lib.Lib is not present
294                 // but it is the only class depending on lib2.Lib2
295                 List.of(&quot;--print-module-deps&quot;, &quot;--class-path&quot;, LIB2_DIR.toString(),
296                         &quot;--ignore-missing-deps&quot;, CLASSES_DIR.toString()),
297                 new String[] {
298                     &quot;java.base,java.sql,jdk.unsupported&quot;
299                 }
300             },
301             {   // Foo depends on lib.Lib which depends on lib2.Libs
302                 List.of(&quot;--print-module-deps&quot;,
303                         &quot;--ignore-missing-deps&quot;, FOO_CLASS.toString()),
304                 new String[] {
305                     &quot;java.base,java.sql&quot;
306                 }
307             },
308         };
309     }
310 
311     @Test(dataProvider = &quot;recursiveDeps&quot;)
312     public void testRecursiveDeps(List&lt;String&gt; options, String[] expected) {
313         JdepsRunner jdeps = JdepsRunner.run(options.toArray(new String[0]));
314         String[] output = Arrays.stream(jdeps.output())
315                                 .map(s -&gt; s.trim())
316                                 .toArray(String[]::new);
317         assertEquals(output, expected);
318     }
319 }
<a name="3" id="anc3"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="3" type="hidden" />
</body>
</html>