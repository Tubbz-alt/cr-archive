<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New test/langtools/jdk/javadoc/doclet/testBimodalTaglets/TestBimodalTaglets.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2018, 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @bug      8202947
 27  * @summary  Test bimodal (inline and block) taglets
 28  * @library  /tools/lib ../../lib
 29  * @modules jdk.javadoc/jdk.javadoc.internal.tool
 30  * @build    toolbox.ToolBox javadoc.tester.*
 31  * @run main TestBimodalTaglets
 32  */
 33 
 34 import java.nio.file.Path;
 35 import java.util.Arrays;
 36 import java.util.EnumSet;
 37 import java.util.List;
 38 import java.util.Set;
 39 import java.util.stream.Collectors;
 40 
 41 import javax.lang.model.element.Element;
 42 
 43 import com.sun.source.doctree.DocTree;
 44 import com.sun.source.doctree.UnknownBlockTagTree;
 45 import com.sun.source.doctree.UnknownInlineTagTree;
 46 import javadoc.tester.JavadocTester;
 47 import jdk.javadoc.doclet.Taglet;
 48 import toolbox.ToolBox;
 49 
 50 public class TestBimodalTaglets extends JavadocTester implements Taglet {
 51     public static void main(String... args) throws Exception {
 52         new TestBimodalTaglets().runTests(m -&gt; new Object[] { Path.of(m.getName()) });
 53     }
 54 
 55     ToolBox tb = new ToolBox();
 56 
 57     @Test
 58     public void testBimodalTaglet(Path base) throws Exception {
 59         Path src = base.resolve(&quot;src&quot;);
 60         tb.writeJavaFiles(src,
 61                 &quot;package p;\n&quot;
 62                 + comment(&quot;This is a comment.&quot;,
 63                         &quot;Here is an inline {@test abc} test tag {@test def}.&quot;,
 64                         &quot;@see Object&quot;,
 65                         &quot;@test 123&quot;,
 66                         &quot;@see String&quot;,
 67                         &quot;@test 456&quot;)
 68                 + &quot;public class C { }\n&quot;);
 69 
 70         javadoc(&quot;-d&quot;, base.resolve(&quot;out&quot;).toString(),
 71                 &quot;--source-path&quot;, src.toString(),
 72                 &quot;-tagletpath&quot;, System.getProperty(&quot;test.class.path&quot;),
 73                 &quot;-taglet&quot;, &quot;TestBimodalTaglets&quot;,
 74                 &quot;p&quot;);
 75 
 76         checkOutput(&quot;p/C.html&quot;, true,
 77                 &quot;Here is an inline INLINE[abc] test tag INLINE[def].&quot;,
 78                 &quot;&lt;dt&gt;BLOCK:&lt;dd&gt;123&lt;dd&gt;456&quot;);
 79     }
 80 
 81     String comment(String... lines) {
 82         return Arrays.stream(lines)
 83                 .collect(Collectors.joining(&quot;\n * &quot;, &quot;/**\n * &quot;, &quot;\n */&quot;));
 84     }
 85 
 86     // the taglet ....
 87 
 88     @Override
 89     public Set&lt;Location&gt; getAllowedLocations() {
 90         return EnumSet.allOf(Location.class);
 91     }
 92 
 93     @Override
 94     public boolean isInlineTag() {
 95         return true;
 96     }
 97 
 98     @Override
 99     public boolean isBlockTag() {
100         return true;
101     }
102 
103     @Override
104     public String getName() {
105         return &quot;test&quot;;
106     }
107 
108     @Override
109     public String toString(List&lt;? extends DocTree&gt; tags, Element element) {
110         if (tags.size() == 1 &amp;&amp; tags.get(0) instanceof UnknownInlineTagTree) {
111             return inlineTagToString((UnknownInlineTagTree) tags.get(0));
112         } else {
113             return blockTagsToString(tags);
114         }
115     }
116 
117     /**
118      * Converts an inline tag to a string composed of its contents wrapped in &quot;INLINE[&quot; ... &quot;]&quot;
119      *
120      * @param tag the tag
121      * @return the string
122      */
123     private String inlineTagToString(UnknownInlineTagTree tag) {
124         return &quot;INLINE[&quot; +
125                 toString(tag.getContent())
126                 + &quot;]&quot;;
127     }
128 
129     /**
130      * Converts a series of block tags to a string composed of a {@code&gt; &lt;dt&gt;} header,
131      * followed by the contents of each tag preceded by {@code &lt;dd&gt;}.
132      * Note that the doclet provides the enclosing {@code &lt;dl&gt;...&lt;/dl&gt;} around all the
133      * block tags.
134      *
135      * @param tags the tags
136      * @return the string
137      */
138     private String blockTagsToString(List&lt;? extends DocTree&gt; tags) {
139         return &quot;&lt;dt&gt;BLOCK:&quot;
140                 + tags.stream()
141                     .map (t -&gt; (UnknownBlockTagTree) t)
142                     .map(t -&gt; &quot;&lt;dd&gt;&quot; + toString(t.getContent()))
143                     .collect(Collectors.joining());
144     }
145 
146     private String toString(List&lt;? extends DocTree&gt; trees) {
147         return trees.stream()
148                 .map(Object::toString)
149                 .collect(Collectors.joining());
150     }
151 }
152 
    </pre>
  </body>
</html>