<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/langtools/jdk/javadoc/doclet/testMetadata/TestMetadata.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
<a name="1" id="anc1"></a><span class="line-modified"> 26  * @bug 8218998 8219946</span>
 27  * @summary Add metadata to generated API documentation files
 28  * @library /tools/lib ../../lib
 29  * @modules jdk.javadoc/jdk.javadoc.internal.tool
 30  * @modules jdk.compiler/com.sun.tools.javac.api
 31  *          jdk.compiler/com.sun.tools.javac.main
 32  *          jdk.javadoc/jdk.javadoc.internal.api
 33  *          jdk.javadoc/jdk.javadoc.internal.tool
 34  * @build toolbox.ToolBox toolbox.JavacTask javadoc.tester.*
 35  * @run main TestMetadata
 36  */
 37 
 38 import java.io.IOException;
 39 import java.nio.file.Path;
 40 import java.util.ArrayList;
 41 import java.util.HashSet;
 42 import java.util.List;
 43 import java.util.Set;
 44 import java.util.TreeSet;
 45 import java.util.regex.Matcher;
 46 import java.util.regex.Pattern;
 47 import java.util.stream.Collectors;
 48 
 49 import toolbox.ModuleBuilder;
 50 import toolbox.ToolBox;
 51 
 52 import javadoc.tester.JavadocTester;
 53 
 54 public class TestMetadata extends JavadocTester {
 55     public static void main(String... args) throws Exception {
 56         TestMetadata tester = new TestMetadata();
 57         tester.runTests();
 58     }
 59 
<a name="2" id="anc2"></a><span class="line-removed"> 60     enum Frames { NO_FRAMES, FRAMES };</span>
 61     enum Index  { SINGLE, SPLIT };
 62     enum Source { PACKAGES, MODULES };
 63 
 64     final ToolBox tb = new ToolBox();
 65     final Set&lt;String&gt; allBodyClassesFound = new HashSet&lt;&gt;();
 66     final Set&lt;String&gt; allGeneratorsFound = new HashSet&lt;&gt;();
 67 
 68     public void runTests() throws Exception {
 69         for (Source s : Source.values()) {
 70             Path src = genSource(s);
<a name="3" id="anc3"></a><span class="line-removed"> 71             for (Frames f : Frames.values()) {</span>
 72                  for (Index i : Index.values()) {
 73                      List&lt;String&gt; args = new ArrayList&lt;&gt;();
 74                      args.add(&quot;-d&quot;);
<a name="4" id="anc4"></a><span class="line-modified"> 75                      args.add(String.format(&quot;out-%s-%s-%s&quot;, s, f, i));</span>
 76                      args.add(&quot;-use&quot;);
<a name="5" id="anc5"></a><span class="line-modified"> 77                      if (s != Source.MODULES) {</span>
<span class="line-removed"> 78                          args.add(&quot;-linksource&quot;); // broken, with modules: JDK-8219060</span>
<span class="line-removed"> 79                      }</span>
<span class="line-removed"> 80                      args.add(f == Frames.NO_FRAMES ? &quot;--no-frames&quot; : &quot;--frames&quot;);</span>
 81                      if (i == Index.SPLIT) {
 82                          args.add(&quot;-splitIndex&quot;);
 83                      }
 84                      if (s == Source.PACKAGES) {
 85                          args.add(&quot;-sourcepath&quot;);
 86                          args.add(src.toString());
 87                          args.add(&quot;pA&quot;);
 88                          args.add(&quot;pB&quot;);
 89                      } else {
 90                          args.add(&quot;--module-source-path&quot;);
 91                          args.add(src.toString());
 92                          args.add(&quot;--module&quot;);
 93                          args.add(&quot;mA,mB&quot;);
 94                      }
 95                      javadoc(args.toArray(new String[args.size()]));
 96                      checkExit(Exit.OK);
 97                      checkBodyClasses();
 98                      checkMetadata();
 99 
100                      // spot check the descriptions for declarations
101                      switch (s) {
102                          case PACKAGES:
103                              checkOutput(&quot;pA/package-summary.html&quot;, true,
104                                      &quot;&lt;meta name=\&quot;description\&quot; content=\&quot;declaration: package: pA\&quot;&gt;&quot;);
105                              checkOutput(&quot;pA/CA.html&quot;, true,
106                                      &quot;&lt;meta name=\&quot;description\&quot; content=\&quot;declaration: package: pA, class: CA\&quot;&gt;&quot;);
107                              break;
108 
109                          case MODULES:
110                              checkOutput(&quot;mA/module-summary.html&quot;, true,
111                                      &quot;&lt;meta name=\&quot;description\&quot; content=\&quot;declaration: module: mA\&quot;&gt;&quot;);
112                              checkOutput(&quot;mA/pA/package-summary.html&quot;, true,
113                                      &quot;&lt;meta name=\&quot;description\&quot; content=\&quot;declaration: module: mA, package: pA\&quot;&gt;&quot;);
114                              checkOutput(&quot;mA/pA/CA.html&quot;, true,
115                                      &quot;&lt;meta name=\&quot;description\&quot; content=\&quot;declaration: module: mA, package: pA, class: CA\&quot;&gt;&quot;);
116                              break;
117                      }
118                  }
<a name="6" id="anc6"></a><span class="line-removed">119             }</span>
120         }
121 
122         checking (&quot;all generators&quot;);
123         if (allGeneratorsFound.equals(allGenerators)) {
124             passed(&quot;all generators found&quot;);
125         } else {
126             Set&lt;String&gt; notFound = new TreeSet&lt;&gt;(allGenerators);
127             notFound.removeAll(allGeneratorsFound);
128             failed(&quot;not found: &quot; + notFound);
129         }
130 
131         checking (&quot;all body classes&quot;);
132         if (allBodyClassesFound.equals(allBodyClasses)) {
<a name="7" id="anc7"></a><span class="line-modified">133             passed(&quot;all gbody classes found&quot;);</span>
134         } else {
135             Set&lt;String&gt; notFound = new TreeSet&lt;&gt;(allBodyClasses);
136             notFound.removeAll(allBodyClassesFound);
137             failed(&quot;not found: &quot; + notFound);
138         }
139 
140         printSummary();
141     }
142 
143     final Pattern nl = Pattern.compile(&quot;[\\r\\n]+&quot;);
144     final Pattern bodyPattern = Pattern.compile(&quot;&lt;body [^&gt;]*class=\&quot;([^\&quot;]+)\&quot;&quot;);
145     final Set&lt;String&gt; allBodyClasses = Set.of(
<a name="8" id="anc8"></a><span class="line-removed">146         &quot;all-classes-frame&quot;,</span>
147         &quot;all-classes-index&quot;,
148         &quot;all-packages-index&quot;,
149         &quot;class-declaration&quot;,
150         &quot;class-use&quot;,
151         &quot;constants-summary&quot;,
152         &quot;deprecated-list&quot;,
153         &quot;doc-file&quot;,
<a name="9" id="anc9"></a><span class="line-removed">154         &quot;frames&quot;,</span>
155         &quot;help&quot;,
156         &quot;index-redirect&quot;,
157         &quot;module-declaration&quot;,
<a name="10" id="anc10"></a><span class="line-removed">158         &quot;module-frame&quot;,</span>
159         &quot;module-index&quot;,
<a name="11" id="anc11"></a><span class="line-removed">160         &quot;module-index-frame&quot;,</span>
<span class="line-removed">161         &quot;module-package-index-frame&quot;,</span>
162         &quot;package-declaration&quot;,
<a name="12" id="anc12"></a><span class="line-removed">163         &quot;package-frame&quot;,</span>
164         &quot;package-index&quot;,
<a name="13" id="anc13"></a><span class="line-removed">165         &quot;package-index-frame&quot;,</span>
166         &quot;package-tree&quot;,
167         &quot;package-use&quot;,
168         &quot;serialized-form&quot;,
169         &quot;single-index&quot;,
170         &quot;source&quot;,
171         &quot;split-index&quot;,
<a name="14" id="anc14"></a>
172         &quot;tree&quot;
173     );
174 
175     void checkBodyClasses() throws IOException {
176         Path outputDirPath = outputDir.toPath();
177         for (Path p : tb.findFiles(&quot;.html&quot;, outputDirPath)) {
178             checkBodyClass(outputDirPath.relativize(p));
179         }
180     }
181 
182     void checkBodyClass(Path p) {
183         checking(&quot;Check body: &quot; + p);
184 
185         List&lt;String&gt; bodyLines = nl.splitAsStream(readOutputFile(p.toString()))
186                 .filter(s -&gt; s.contains(&quot;&lt;body class=&quot;))
187                 .collect(Collectors.toList());
188 
189         String bodyLine;
190         switch (bodyLines.size()) {
191             case 0:
192                  failed(&quot;Not found: &lt;body class=&quot;);
193                  return;
194             case 1:
195                  bodyLine = bodyLines.get(0);
196                  break;
197             default:
198                  failed(&quot;Multiple found: &lt;body class=&quot;);
199                  return;
200         }
201 
202         Matcher m = bodyPattern.matcher(bodyLine);
203         if (m.find()) {
204             String bodyClass = m.group(1);
205             if (allBodyClasses.contains(bodyClass)) {
206                 passed(&quot;found: &quot; + bodyClass);
207                 allBodyClassesFound.add(bodyClass);
208             } else {
209                 failed(&quot;Unrecognized body class: &quot; + bodyClass);
210             }
211         } else {
212             failed(&quot;Unrecognized line:\n&quot; + bodyLine);
213         }
214     }
215 
216     final Pattern contentPattern = Pattern.compile(&quot;content=\&quot;([^\&quot;]+)\&quot;&gt;&quot;);
217     final Pattern generatorPattern = Pattern.compile(&quot;content=\&quot;javadoc/([^\&quot;]+)\&quot;&gt;&quot;);
218     final Set&lt;String&gt; allGenerators = Set.of(
<a name="15" id="anc15"></a><span class="line-removed">219             &quot;AllClassesFrameWriter&quot;,</span>
220             &quot;AllClassesIndexWriter&quot;,
221             &quot;AllPackagesIndexWriter&quot;,
222             &quot;AnnotationTypeWriterImpl&quot;,
223             &quot;ClassUseWriter&quot;,
224             &quot;ClassWriterImpl&quot;,
225             &quot;ConstantsSummaryWriterImpl&quot;,
226             &quot;DeprecatedListWriter&quot;,
227             &quot;DocFileWriter&quot;,
<a name="16" id="anc16"></a><span class="line-removed">228             &quot;FrameOutputWriter&quot;,</span>
229             &quot;HelpWriter&quot;,
230             &quot;IndexRedirectWriter&quot;,
<a name="17" id="anc17"></a><span class="line-removed">231             &quot;ModuleFrameWriter&quot;,</span>
<span class="line-removed">232             &quot;ModuleIndexFrameWriter&quot;,</span>
233             &quot;ModuleIndexWriter&quot;,
<a name="18" id="anc18"></a><span class="line-removed">234             &quot;ModulePackageIndexFrameWriter&quot;,</span>
235             &quot;ModuleWriterImpl&quot;,
<a name="19" id="anc19"></a><span class="line-removed">236             &quot;PackageFrameWriter&quot;,</span>
<span class="line-removed">237             &quot;PackageIndexFrameWriter&quot;,</span>
238             &quot;PackageIndexWriter&quot;,
239             &quot;PackageTreeWriter&quot;,
240             &quot;PackageUseWriter&quot;,
241             &quot;PackageWriterImpl&quot;,
242             &quot;SerializedFormWriterImpl&quot;,
243             &quot;SingleIndexWriter&quot;,
244             &quot;SourceToHTMLConverter&quot;,
245             &quot;SplitIndexWriter&quot;,
<a name="20" id="anc20"></a>
246             &quot;TreeWriter&quot;
247             );
248 
249     void checkMetadata() throws IOException {
250         Path outputDirPath = outputDir.toPath();
251         for (Path p : tb.findFiles(&quot;.html&quot;, outputDirPath)) {
252             checkMetadata(outputDirPath.relativize(p));
253         }
254     }
255 
256     void checkMetadata(Path p) {
257         checking(&quot;Check generator: &quot; + p);
258 
259         List&lt;String&gt; generators = nl.splitAsStream(readOutputFile(p.toString()))
260                 .filter(s -&gt; s.contains(&quot;&lt;meta name=\&quot;generator\&quot;&quot;))
261                 .collect(Collectors.toList());
262 
263         String generator;
264         switch (generators.size()) {
265             case 0:
266                  failed(&quot;Not found: &lt;meta name=\&quot;generator\&quot;&quot;);
267                  return;
268             case 1:
269                  generator = generators.get(0);
270                  break;
271             default:
272                  failed(&quot;Multiple found: &lt;meta name=\&quot;generator\&quot;&quot;);
273                  return;
274         }
275 
276         Matcher m = generatorPattern.matcher(generator);
277         if (m.find()) {
278             String content = m.group(1);
279             if (allGenerators.contains(content)) {
280                 passed(&quot;found: &quot; + content);
281                 allGeneratorsFound.add(content);
282                 checkDescription(p, content);
283             } else {
284                 failed(&quot;Unrecognized content: &quot; + content);
285             }
286         } else {
287             failed(&quot;Unrecognized line:\n&quot; + generator);
288         }
289 
290     }
291 
292     void checkDescription(Path p, String generator) {
293         checking(&quot;Check description: &quot; + p);
294 
295         List&lt;String&gt; descriptions = nl.splitAsStream(readOutputFile(p.toString()))
296                 .filter(s -&gt; s.contains(&quot;&lt;meta name=\&quot;description\&quot;&quot;))
297                 .collect(Collectors.toList());
298 
299         String description;
300         switch (descriptions.size()) {
301             case 0:
302                 if (generator.equals(&quot;DocFileWriter&quot;)) {
303                     passed(&quot;Not found, as expected&quot;);
304                 } else {
305                     failed(&quot;Not found: &lt;meta name=\&quot;description\&quot;&quot;);
306                 }
307                 return;
308             case 1:
309                 description = descriptions.get(0);
310                 break;
311             default:
312                 failed(&quot;Multiple found: &lt;meta name=\&quot;description\&quot;&quot;);
313                 return;
314         }
315 
316         String content;
317         Matcher m = contentPattern.matcher(description);
318         if (m.find()) {
319             content = m.group(1);
320         } else {
321             failed(&quot;Unrecognized line:\n&quot; + description);
322             return;
323         }
324 
325         switch (generator) {
<a name="21" id="anc21"></a><span class="line-removed">326             case &quot;AllClassesFrameWriter&quot;:</span>
<span class="line-removed">327             case &quot;FrameOutputWriter&quot;:</span>
<span class="line-removed">328             case &quot;ModuleFrameWriter&quot;:</span>
<span class="line-removed">329             case &quot;ModuleIndexFrameWriter&quot;:</span>
<span class="line-removed">330             case &quot;ModulePackageIndexFrameWriter&quot;:</span>
<span class="line-removed">331             case &quot;PackageFrameWriter&quot;:</span>
<span class="line-removed">332             case &quot;PackageIndexFrameWriter&quot;:</span>
<span class="line-removed">333                 check(generator, content, content.contains(&quot;frame&quot;));</span>
<span class="line-removed">334                 break;</span>
<span class="line-removed">335 </span>
336             case &quot;AllClassesIndexWriter&quot;:
337             case &quot;AllPackagesIndexWriter&quot;:
338             case &quot;ModuleIndexWriter&quot;:
339             case &quot;PackageIndexWriter&quot;:
340                 check(generator, content, content.contains(&quot;index&quot;));
341                 break;
342 
343 
344             case &quot;AnnotationTypeWriterImpl&quot;:
345             case &quot;ClassWriterImpl&quot;:
346             case &quot;ModuleWriterImpl&quot;:
347             case &quot;PackageWriterImpl&quot;:
348                 check(generator, content, content.startsWith(&quot;declaration: &quot;));
349                 break;
350 
351             case &quot;ClassUseWriter&quot;:
352             case &quot;PackageUseWriter&quot;:
353                 check(generator, content, content.startsWith(&quot;use: &quot;));
354                 break;
355 
356             case &quot;ConstantsSummaryWriterImpl&quot;:
357                 check(generator, content, content.contains(&quot;constants&quot;));
358                 break;
359 
360             case &quot;DeprecatedListWriter&quot;:
361                 check(generator, content, content.contains(&quot;deprecated&quot;));
362                 break;
363 
364             case &quot;DocFileWriter&quot;:
365                 passed(&quot;no constraint for user-provided doc-files&quot;);
366                 break;
367 
368             case &quot;HelpWriter&quot;:
369                 check(generator, content, content.contains(&quot;help&quot;));
370                 break;
371 
372             case &quot;IndexRedirectWriter&quot;:
373                 check(generator, content, content.contains(&quot;redirect&quot;));
374                 break;
375 
376             case &quot;PackageTreeWriter&quot;:
377             case &quot;TreeWriter&quot;:
378                 check(generator, content, content.contains(&quot;tree&quot;));
379                 break;
380 
381             case &quot;SerializedFormWriterImpl&quot;:
382                 check(generator, content, content.contains(&quot;serialized&quot;));
383                 break;
384 
385             case &quot;SingleIndexWriter&quot;:
386             case &quot;SplitIndexWriter&quot;:
387                 check(generator, content, content.startsWith(&quot;index&quot;));
388                 break;
389 
390             case &quot;SourceToHTMLConverter&quot;:
391                 check(generator, content, content.startsWith(&quot;source:&quot;));
392                 break;
393 
<a name="22" id="anc22"></a>



394             default:
395                 failed(&quot;unexpected generator: &quot; + generator);
396                 break;
397         }
398     }
399 
400     void check(String generator, String content, boolean ok) {
401         if (ok) {
402             passed(&quot;OK: &quot; + generator + &quot; &quot; + content);
403         } else {
404             failed(&quot;unexpected value for &quot; + generator + &quot;: &quot; + content);
405         }
406     }
407 
408     Path genSource(Source s) throws IOException {
409         Path src = Path.of(&quot;src-&quot; + s);
410         switch (s) {
411             case PACKAGES:
412                 tb.writeJavaFiles(src,
413                     &quot;/** Package pA. */ package pA;&quot;,
414                     &quot;/** Class pA.CA. */ package pA; public class CA { }&quot;,
415                     &quot;/** Anno pA.Anno, */ package pA; public @interface Anno { }&quot;,
416                     &quot;/** Serializable pA.Ser, */ package pA; public class Ser implements java.io.Serializable { }&quot;,
417                     &quot;/** Package pB. */ package pB;&quot;,
418                     &quot;/** Class pB.CB. */ package pB; public class CB { }&quot;);
419                 tb.writeFile(src.resolve(&quot;pA&quot;).resolve(&quot;doc-files&quot;).resolve(&quot;extra.html&quot;),
420                         &quot;&lt;!doctype html&gt;\n&lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;Extra&lt;/body&gt;&lt;/html&gt;&quot;);
421                 break;
422 
423             case MODULES:
424                 new ModuleBuilder(tb, &quot;mA&quot;)
425                         .exports(&quot;pA&quot;)
426                         .classes(&quot;/** Package mA/pA. */ package pA;&quot;)
427                         .classes(&quot;/** Class mA/pA.CA. */ package pA; public class CA { }&quot;)
428                         .write(src);
429                 new ModuleBuilder(tb, &quot;mB&quot;)
430                         .exports(&quot;pB&quot;)
431                         .classes(&quot;/** Package mB/pB. */ package pB;&quot;)
432                         .classes(&quot;/** Class mB/pB.CB. */ package pB; public class CB { }&quot;)
433                         .write(src);
434                 break;
435         }
436 
437         return src;
438     }
439 }
440 
<a name="23" id="anc23"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="23" type="hidden" />
</body>
</html>