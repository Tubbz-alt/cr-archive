<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/langtools/jdk/javadoc/tool/TestScriptInComment.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
    <script type="text/javascript" src="../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2016, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /**
 25  * @test
<a name="2" id="anc2"></a><span class="line-modified"> 26  * @bug 8138725 8226765</span>
 27  * @summary test --allow-script-in-comments
 28  * @modules jdk.javadoc/jdk.javadoc.internal.tool
 29  */
 30 
 31 import java.io.File;
 32 import java.io.FileWriter;
 33 import java.io.IOException;
 34 import java.io.PrintStream;
 35 import java.io.PrintWriter;
 36 import java.io.StringWriter;
 37 import java.util.ArrayList;
 38 import java.util.Arrays;
 39 import java.util.Collections;
 40 import java.util.List;
 41 import java.util.regex.Matcher;
 42 import java.util.regex.Pattern;
 43 
 44 /**
 45  * Combo-style test, exercising combinations of different HTML fragments that may contain
 46  * JavaScript, different places to place those fragments, and whether or not to allow the use
 47  * of JavaScript.
 48  */
 49 public class TestScriptInComment {
 50     public static void main(String... args) throws Exception {
 51         new TestScriptInComment().run();
 52     }
 53 
 54     /**
 55      * Representative samples of different fragments of HTML that may contain JavaScript.
 56      * To facilitate checking the output manually in a browser, the text &quot;#ALERT&quot; will be
 57      * replaced by a JavaScript call of &quot;alert(msg)&quot;, using a message string that is specific
 58      * to the test case.
 59      */
 60     enum Comment {
 61         LC(&quot;&lt;script&gt;#ALERT&lt;/script&gt;&quot;, true), // script tag in Lower Case
 62         UC(&quot;&lt;SCRIPT&gt;#ALERT&lt;/script&gt;&quot;, true), // script tag in Upper Case
 63         WS(&quot;&lt; script &gt;#ALERT&lt;/script&gt;&quot;, false, &quot;-Xdoclint:none&quot;), // script tag with invalid white space
 64         SP(&quot;&lt;script src=\&quot;file\&quot;&gt; #ALERT &lt;/script&gt;&quot;, true), // script tag with an attribute
 65         ON(&quot;&lt;a onclick=&#39;#ALERT&#39;&gt;x&lt;/a&gt;&quot;, true), // event handler attribute
<a name="3" id="anc3"></a><span class="line-added"> 66         OME(&quot;&lt;img alt=&#39;1&#39; onmouseenter=&#39;#ALERT&#39;&gt;&quot;, true), // onmouseenter event handler attribute</span>
<span class="line-added"> 67         OML(&quot;&lt;img alt=&#39;1&#39; onmouseleave=&#39;#ALERT&#39;&gt;&quot;, true), // onmouseleave event handler attribute</span>
<span class="line-added"> 68         OFI(&quot;&lt;a href=&#39;#&#39; onfocusin=&#39;#ALERT&#39;&gt;x&lt;/a&gt;&quot;, true), // onfocusin event handler attribute</span>
<span class="line-added"> 69         OBE(&quot;&lt;a onbogusevent=&#39;#ALERT&#39;&gt;x&lt;/a&gt;&quot;, true), // bogus/future event handler attribute</span>
 70         URI(&quot;&lt;a href=&#39;javascript:#ALERT&#39;&gt;x&lt;/a&gt;&quot;, true); // javascript URI
 71 
 72         /**
 73          * Creates an HTML fragment to be injected into a template.
 74          * @param text the HTML fragment to put into a doc comment or option.
 75          * @param hasScript whether or not this fragment does contain legal JavaScript
 76          * @param opts any additional options to be specified when javadoc is run
 77          */
 78         Comment(String text, boolean hasScript, String... opts) {
 79             this.text = text;
 80             this.hasScript = hasScript;
 81             this.opts = Arrays.asList(opts);
 82         }
 83 
 84         final String text;
 85         final boolean hasScript;
 86         final List&lt;String&gt; opts;
 87     };
 88 
 89     /**
 90      * Representative samples of positions in which javadoc may find JavaScript.
 91      * Each template contains a series of strings, which are written to files or inferred as options.
 92      * The first source file implies a corresponding output file which should not be written
 93      * if the comment contains JavaScript and JavaScript is not allowed.
 94      */
 95     enum Template {
 96         OVR(&quot;&lt;html&gt;&lt;body&gt; overview #COMMENT &lt;/body&gt;&lt;/html&gt;&quot;, &quot;package p; public class C { }&quot;),
 97         PKGINFO(&quot;#COMMENT package p;&quot;, &quot;package p; public class C { }&quot;),
 98         PKGHTML(&quot;&lt;html&gt;&lt;body&gt;#COMMENT package p;&lt;/body&gt;&lt;/html&gt;&quot;, &quot;package p; public class C { }&quot;),
 99         CLS(&quot;package p; #COMMENT public class C { }&quot;),
100         CON(&quot;package p; public class C { #COMMENT public C() { } }&quot;),
101         FLD(&quot;package p; public class C { #COMMENT public int f; }&quot;),
102         MTH(&quot;package p; public class C { #COMMENT public void m() { } }&quot;),
103         TOP(&quot;-top&quot;, &quot;lorem #COMMENT ipsum&quot;, &quot;package p; public class C { }&quot;),
104         HDR(&quot;-header&quot;, &quot;lorem #COMMENT ipsum&quot;, &quot;package p; public class C { }&quot;),
105         FTR(&quot;-footer&quot;, &quot;lorem #COMMENT ipsum&quot;, &quot;package p; public class C { }&quot;),
106         BTM(&quot;-bottom&quot;, &quot;lorem #COMMENT ipsum&quot;, &quot;package p; public class C { }&quot;),
107         DTTL(&quot;-doctitle&quot;, &quot;lorem #COMMENT ipsum&quot;, &quot;package p; public class C { }&quot;),
108         PHDR(&quot;-packagesheader&quot;, &quot;lorem #COMMENT ipsum&quot;, &quot;package p; public class C { }&quot;);
109 
110         Template(String... args) {
111             opts = new ArrayList&lt;String&gt;();
112             sources = new ArrayList&lt;String&gt;();
113             int i = 0;
114             while (args[i].startsWith(&quot;-&quot;)) {
115                 // all options being tested have a single argument that follow the option
116                 opts.add(args[i++]);
117                 opts.add(args[i++]);
118             }
119             while(i &lt; args.length) {
120                 sources.add(args[i++]);
121             }
122         }
123 
124         // groups: 1 &lt;html&gt; or not;  2: package name;  3: class name
125         private final Pattern pat =
126                 Pattern.compile(&quot;(?i)(&lt;html&gt;)?.*?(?:package ([a-z]+);.*?(?:class ([a-z]+).*)?)?&quot;);
127 
128         /**
129          * Infer the file in which to write the given source.
130          * @param dir the base source directory
131          * @param src the source text
132          * @return the file in which the source should be written
133          */
134         File getSrcFile(File srcDir, String src) {
135             String f;
136             Matcher m = pat.matcher(src);
137             if (!m.matches())
138                 throw new Error(&quot;match failed&quot;);
139             if (m.group(3) != null) {
140                 f = m.group(2) + &quot;/&quot; + m.group(3) + &quot;.java&quot;;
141             } else if (m.group(2) != null) {
142                 f = m.group(2) + &quot;/&quot; + (m.group(1) == null ? &quot;package-info.java&quot; : &quot;package.html&quot;);
143             } else {
144                 f = &quot;overview.html&quot;;
145             }
146             return new File(srcDir, f);
147         }
148 
149         /**
150          * Get the options to give to javadoc.
151          * @param srcDir the srcDir to use -overview is needed
152          * @return
153          */
154         List&lt;String&gt; getOpts(File srcDir) {
155             if (!opts.isEmpty()) {
156                 return opts;
157             } else if (sources.get(0).contains(&quot;overview&quot;)) {
158                 return Arrays.asList(&quot;-overview&quot;, getSrcFile(srcDir, sources.get(0)).getPath());
159             } else {
160                 return Collections.emptyList();
161             }
162         }
163 
164         /**
165          * Gets the output file corresponding to the first source file.
166          * This file should not be written if the comment contains JavaScript and JavaScripot is
167          * not allowed.
168          * @param dir the base output directory
169          * @return the output file
170          */
171         File getOutFile(File outDir) {
172             String f;
173             Matcher m = pat.matcher(sources.get(0));
174             if (!m.matches())
175                 throw new Error(&quot;match failed&quot;);
176             if (m.group(3) != null) {
177                 f = m.group(2) + &quot;/&quot; + m.group(3) + &quot;.html&quot;;
178             } else if (m.group(2) != null) {
179                 f = m.group(2) + &quot;/package-summary.html&quot;;
180             } else {
181                 f = &quot;overview-summary.html&quot;;
182             }
183             return new File(outDir, f);
184         }
185 
186         final List&lt;String&gt; opts;
187         final List&lt;String&gt; sources;
188     };
189 
190     enum Option {
191         OFF(null),
192         ON(&quot;--allow-script-in-comments&quot;);
193 
194         Option(String text) {
195             this.text = text;
196         }
197 
198         final String text;
199     };
200 
201     private PrintStream out = System.err;
202 
203     public void run() throws Exception {
204         int count = 0;
205         for (Template template: Template.values()) {
206             for (Comment comment: Comment.values()) {
207                 for (Option option: Option.values()) {
208                     if (test(template, comment, option)) {
209                         count++;
210                     }
211                 }
212             }
213         }
214 
215         out.println(count + &quot; test cases run&quot;);
216         if (errors &gt; 0) {
217             throw new Exception(errors + &quot; errors occurred&quot;);
218         }
219     }
220 
221     boolean test(Template template, Comment comment, Option option) throws IOException {
222         if (option == Option.ON &amp;&amp; !comment.hasScript) {
223             // skip --allowScriptInComments if comment does not contain JavaScript
224             return false;
225         }
226 
227         String test = template + &quot;-&quot; + comment + &quot;-&quot; + option;
228         out.println(&quot;Test: &quot; + test);
229 
230         File dir = new File(test);
231         dir.mkdirs();
232         File srcDir = new File(dir, &quot;src&quot;);
233         File outDir = new File(dir, &quot;out&quot;);
234 
235         String alert = &quot;alert(\&quot;&quot; + test + &quot;\&quot;);&quot;;
236         for (String src: template.sources) {
237             writeFile(template.getSrcFile(srcDir, src),
238                 src.replace(&quot;#COMMENT&quot;,
239                         &quot;/** &quot; + comment.text.replace(&quot;#ALERT&quot;, alert) + &quot; **/&quot;));
240         }
241 
242         List&lt;String&gt; opts = new ArrayList&lt;String&gt;();
243         opts.add(&quot;-sourcepath&quot;);
244         opts.add(srcDir.getPath());
245         opts.add(&quot;-d&quot;);
246         opts.add(outDir.getPath());
<a name="4" id="anc4"></a>
247         if (option.text != null)
248             opts.add(option.text);
249         for (String opt: template.getOpts(srcDir)) {
250             opts.add(opt.replace(&quot;#COMMENT&quot;, comment.text.replace(&quot;#ALERT&quot;, alert)));
251         }
252         opts.addAll(comment.opts);
253         opts.add(&quot;-noindex&quot;);   // index not required; save time/space writing files
254         opts.add(&quot;p&quot;);
255 
256         StringWriter sw = new StringWriter();
257         PrintWriter pw = new PrintWriter(sw);
258         int rc = javadoc(opts, pw);
259         pw.close();
260         String log = sw.toString();
261         writeFile(new File(dir, &quot;log.txt&quot;), log);
262 
263         out.println(&quot;opts: &quot; + opts);
264         out.println(&quot;  rc: &quot; + rc);
265         out.println(&quot; log:&quot;);
266         out.println(log);
267 
268         String ERROR = &quot;Use --allow-script-in-comment&quot;;
269         File outFile = template.getOutFile(outDir);
270 
271         boolean expectErrors = comment.hasScript &amp;&amp; (option == Option.OFF);
272 
273         if (expectErrors) {
274             check(rc != 0, &quot;unexpected exit code: &quot; + rc);
275             check(log.contains(ERROR), &quot;expected error message not found&quot;);
276             check(!outFile.exists(), &quot;output file found unexpectedly&quot;);
277         } else {
278             check(rc == 0, &quot;unexpected exit code: &quot; + rc);
279             check(!log.contains(ERROR), &quot;error message found&quot;);
280             check(outFile.exists(), &quot;output file not found&quot;);
281         }
282 
283         out.println();
284         return true;
285     }
286 
287     int javadoc(List&lt;String&gt; opts, PrintWriter pw) {
288         return jdk.javadoc.internal.tool.Main.execute(opts.toArray(new String[opts.size()]), pw);
289     }
290 
291     File writeFile(File f, String text) throws IOException {
292         f.getParentFile().mkdirs();
293         FileWriter fw = new FileWriter(f);
294         try {
295             fw.write(text);
296         } finally {
297             fw.close();
298         }
299         return f;
300     }
301 
302     void check(boolean cond, String errMessage) {
303         if (!cond) {
304             error(errMessage);
305         }
306     }
307 
308     void error(String message) {
309         out.println(&quot;Error: &quot; + message);
310         errors++;
311     }
312 
313     int errors = 0;
314 }
315 
<a name="5" id="anc5"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="5" type="hidden" />
</body>
</html>