<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old test/langtools/jdk/jshell/ToolTabSnippetTest.java</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2017, 2018, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /**
 25  * @test
 26  * @bug 8177076 8185426 8189595 8188072
 27  * @modules
 28  *     jdk.compiler/com.sun.tools.javac.api
 29  *     jdk.compiler/com.sun.tools.javac.main
 30  *     jdk.jshell/jdk.internal.jshell.tool
 31  *     jdk.jshell/jdk.internal.jshell.tool.resources:open
 32  *     jdk.jshell/jdk.jshell:open
 33  * @library /tools/lib
 34  * @build toolbox.ToolBox toolbox.JarTask toolbox.JavacTask
 35  * @build Compiler UITesting
 36  * @build ToolTabSnippetTest
 37  * @run testng/timeout=300 ToolTabSnippetTest
 38  */
 39 
 40 import java.io.IOException;
 41 import java.lang.reflect.Field;
 42 import java.nio.file.Files;
 43 import java.nio.file.Path;
 44 import java.nio.file.Paths;
 45 import java.util.Arrays;
 46 import java.util.concurrent.CountDownLatch;
 47 import java.util.jar.JarEntry;
 48 import java.util.jar.JarOutputStream;
 49 
 50 import jdk.internal.jshell.tool.ConsoleIOContextTestSupport;
 51 import org.testng.annotations.Test;
 52 
 53 @Test
 54 public class ToolTabSnippetTest extends UITesting {
 55 
 56     public ToolTabSnippetTest() {
 57         super(true);
 58     }
 59 
 60     public void testExpression() throws Exception {
 61         Path classes = prepareZip();
 62         doRunTest((inputSink, out) -&gt; {
 63             inputSink.write(&quot;/env -class-path &quot; + classes.toString() + &quot;\n&quot;);
 64             waitOutput(out, resource(&quot;jshell.msg.set.restore&quot;) + &quot;\n\\u001B\\[\\?2004h&quot; + PROMPT);
 65             inputSink.write(&quot;import jshelltest.*;\n&quot;);
 66             waitOutput(out, &quot;\n\\u001B\\[\\?2004l\\u001B\\[\\?2004h&quot; + PROMPT);
 67 
 68             //-&gt; &lt;tab&gt;
 69             inputSink.write(TAB);
 70             waitOutput(out, getMessage(&quot;jshell.console.completion.all.completions.number&quot;, &quot;[0-9]+&quot;));
 71             inputSink.write(TAB);
 72             waitOutput(out, &quot;.*String.*StringBuilder.*&quot; +
 73                             REDRAW_PROMPT + &quot;&quot;);
 74 
 75             //new JShellTes&lt;tab&gt;
 76             inputSink.write(&quot;new JShellTes&quot; + TAB);
 77             waitOutput(out, &quot;\nJShellTest\\(      JShellTestAux\\(   &quot; +
 78                             REDRAW_PROMPT + &quot;new JShellTest&quot;);
 79 
 80             //new JShellTest&lt;tab&gt;
 81             inputSink.write(TAB);
 82             waitOutput(out, &quot;JShellTest\\(      JShellTestAux\\(   \n&quot; +
 83                             &quot;\n&quot; +
 84                             resource(&quot;jshell.console.completion.current.signatures&quot;) + &quot;\n&quot; +
 85                             &quot;jshelltest.JShellTest\n&quot; +
 86                             &quot;\n&quot; +
 87                             resource(&quot;jshell.console.see.documentation&quot;) +
 88                             REDRAW_PROMPT + &quot;new JShellTest&quot;);
 89             inputSink.write(TAB);
 90             waitOutput(out, &quot;\\u001B\\[1mjshelltest.JShellTest\\u001B\\[0m\n&quot; +
 91                             &quot;JShellTest 0&quot; +
 92                             REDRAW_PROMPT + &quot;new JShellTest&quot;);
 93             inputSink.write(TAB);
 94             waitOutput(out, &quot;JShellTest\\(      JShellTestAux\\(   \n&quot; +
 95                             &quot;\n&quot; +
 96                             resource(&quot;jshell.console.completion.current.signatures&quot;) + &quot;\n&quot; +
 97                             &quot;jshelltest.JShellTest\n&quot; +
 98                             &quot;\n&quot; +
 99                             resource(&quot;jshell.console.see.documentation&quot;) +
100                             REDRAW_PROMPT + &quot;new JShellTest&quot;);
101 
102             //new JShellTest(&lt;tab&gt;
103             inputSink.write(&quot;(&quot; + TAB);
104             waitOutput(out, &quot;\\(\n&quot; +
105                             resource(&quot;jshell.console.completion.current.signatures&quot;) + &quot;\n&quot; +
106                             &quot;JShellTest\\(String str\\)\n&quot; +
107                             &quot;JShellTest\\(String str, int i\\)\n&quot; +
108                             &quot;\n&quot; +
109                             resource(&quot;jshell.console.see.documentation&quot;) +
110                             REDRAW_PROMPT + &quot;new JShellTest\\(&quot;);
111             inputSink.write(TAB);
112             waitOutput(out, &quot;\\u001B\\[1mJShellTest\\(String str\\)\\u001B\\[0m\n&quot; +
113                             &quot;JShellTest 1\n&quot; +
114                             &quot;1\n1\n1\n1\n1\n1\n1\n1\n1\n1\n1\n1\n1\n1\n1\n1\n1\n1\n&quot; +
115                             &quot;\n&quot; +
116                             resource(&quot;jshell.console.see.next.page&quot;) +
117                             REDRAW_PROMPT + &quot;new JShellTest\\(&quot;);
118             inputSink.write(TAB);
119             waitOutput(out, &quot;1\n1\n1\n1\n1\n1\n1\n1\n1\n1\n1\n1\n&quot; +
120                             &quot;\n&quot; +
121                             resource(&quot;jshell.console.see.next.javadoc&quot;) +
122                             REDRAW_PROMPT + &quot;new JShellTest\\(&quot;);
123             inputSink.write(TAB);
124             waitOutput(out, &quot;\\u001B\\[1mJShellTest\\(String str, int i\\)\\u001B\\[0m\n&quot; +
125                             &quot;JShellTest 2\n&quot; +
126                             &quot;\n&quot; +
127                             getMessage(&quot;jshell.console.completion.all.completions.number&quot;, &quot;[0-9]+&quot;) +
128                             REDRAW_PROMPT + &quot;new JShellTest\\(&quot;);
129             inputSink.write(TAB);
130             waitOutput(out, &quot;.*String.*StringBuilder.*&quot; +
131                             REDRAW_PROMPT + &quot;new JShellTest\\(&quot;);
132 
133             inputSink.write(INTERRUPT + &quot;String str = \&quot;\&quot;;\nnew JShellTest(&quot;);
134             waitOutput(out, PROMPT + &quot;new JShellTest\\(&quot;);
135 
136             inputSink.write(TAB);
137             waitOutput(out, &quot;\n&quot; +
138                             &quot;str   \n&quot; +
139                             &quot;\n&quot; +
140                             resource(&quot;jshell.console.completion.current.signatures&quot;) + &quot;\n&quot; +
141                             &quot;JShellTest\\(String str\\)\n&quot; +
142                             &quot;JShellTest\\(String str, int i\\)\n&quot; +
143                             &quot;\n&quot; +
144                             resource(&quot;jshell.console.see.documentation&quot;) +
145                             REDRAW_PROMPT + &quot;new JShellTest\\(&quot;);
146             inputSink.write(TAB);
147             waitOutput(out, &quot;\\u001B\\[1mJShellTest\\(String str\\)\\u001B\\[0m\n&quot; +
148                             &quot;JShellTest 1\n&quot; +
149                             &quot;1\n1\n1\n1\n1\n1\n1\n1\n1\n1\n1\n1\n1\n1\n1\n1\n1\n1\n&quot; +
150                             &quot;\n&quot; +
151                             resource(&quot;jshell.console.see.next.page&quot;) +
152                             REDRAW_PROMPT + &quot;new JShellTest\\(&quot;);
153             inputSink.write(TAB);
154             waitOutput(out, &quot;1\n1\n1\n1\n1\n1\n1\n1\n1\n1\n1\n1\n&quot; +
155                             &quot;\n&quot; +
156                             resource(&quot;jshell.console.see.next.javadoc&quot;) +
157                             REDRAW_PROMPT + &quot;new JShellTest\\(&quot;);
158             inputSink.write(TAB);
159             waitOutput(out, &quot;\\u001B\\[1mJShellTest\\(String str, int i\\)\\u001B\\[0m\n&quot; +
160                             &quot;JShellTest 2\n&quot; +
161                             &quot;\n&quot; +
162                             getMessage(&quot;jshell.console.completion.all.completions.number&quot;, &quot;[0-9]+&quot;) +
163                             REDRAW_PROMPT + &quot;new JShellTest\\(&quot;);
164             inputSink.write(TAB);
165             waitOutput(out, &quot;.*String.*StringBuilder.*&quot; +
166                             REDRAW_PROMPT + &quot;new JShellTest\\(&quot;);
167 
168             inputSink.write(INTERRUPT + &quot;JShellTest t = new JShellTest&quot; + TAB);
169             waitOutput(out, PROMPT + &quot;JShellTest t = new JShellTest\n&quot; +
170                             &quot;JShellTest\\(   \n&quot; +
171                             &quot;\n&quot; +
172                             resource(&quot;jshell.console.completion.current.signatures&quot;) + &quot;\n&quot; +
173                             &quot;jshelltest.JShellTest\n&quot; +
174                             &quot;\n&quot; +
175                             resource(&quot;jshell.console.completion.all.completions&quot;) +
176                             REDRAW_PROMPT + &quot;JShellTest t = new JShellTest&quot;);
177             inputSink.write(TAB);
178             waitOutput(out, &quot;JShellTest\\(      JShellTestAux\\(   \n&quot; +
179                             &quot;\n&quot; +
180                             resource(&quot;jshell.console.see.documentation&quot;) +
181                             REDRAW_PROMPT + &quot;JShellTest t = new JShellTest&quot;);
182 
183             inputSink.write(INTERRUPT + &quot;JShellTest t = new &quot; + TAB);
184             waitOutput(out, PROMPT + &quot;JShellTest t = new \n&quot; +
185                             &quot;JShellTest\\(   \n&quot; +
186                             &quot;\n&quot; +
187                             getMessage(&quot;jshell.console.completion.all.completions.number&quot;, &quot;[0-9]+&quot;) +
188                             REDRAW_PROMPT + &quot;JShellTest t = new &quot;);
189             inputSink.write(TAB);
190             waitOutput(out, &quot;.*String.*StringBuilder.*&quot; +
191                             REDRAW_PROMPT + &quot;JShellTest t = new &quot;);
192 
193             inputSink.write(INTERRUPT + &quot;class JShelX{}\n&quot;);
194             inputSink.write(&quot;new JShel&quot; + TAB);
195             waitOutput(out, PROMPT + &quot;new JShel\n&quot; +
196                             &quot;JShelX\\(\\)         JShellTest\\(      JShellTestAux\\(   &quot; +
197                             REDRAW_PROMPT + &quot;new JShel&quot;);
198 
199             //no crash:
200             inputSink.write(INTERRUPT + &quot;new Stringbuil&quot; + TAB);
201             waitOutput(out, PROMPT + &quot;new Stringbuil&quot; + BELL);
202 
203             //no crash: 8188072
204             inputSink.write(INTERRUPT + &quot;for (int:&quot; + TAB);
205             waitOutput(out, PROMPT + &quot;for \\(int:\n&quot; +
206                             getMessage(&quot;jshell.console.completion.all.completions.number&quot;, &quot;[0-9]+&quot;) +
207                             REDRAW_PROMPT + &quot;for \\(int:&quot;);
208         });
209     }
210 
211     public void testCleaningCompletionTODO() throws Exception {
212         doRunTest((inputSink, out) -&gt; {
213             CountDownLatch testCompleteComputationStarted = new CountDownLatch(1);
214             CountDownLatch testCompleteComputationContinue = new CountDownLatch(1);
215             ConsoleIOContextTestSupport.IMPL = new ConsoleIOContextTestSupport() {
216                 @Override
217                 protected void willComputeCompletionCallback() {
218                     if (testCompleteComputationStarted != null) {
219                         testCompleteComputationStarted.countDown();
220                     }
221                     if (testCompleteComputationContinue != null) {
222                         try {
223                             testCompleteComputationContinue.await();
224                         } catch (InterruptedException ex) {
225                             throw new IllegalStateException(ex);
226                         }
227                     }
228                 }
229             };
230             //-&gt; &lt;tab&gt;
231             inputSink.write(TAB);
232             testCompleteComputationStarted.await();
233             //-&gt; &lt;tab&gt;&lt;tab&gt;
234             inputSink.write(TAB + TAB);
235             testCompleteComputationContinue.countDown();
236             waitOutput(out, PROMPT);
237             //-&gt; &lt;tab&gt;
238             inputSink.write(TAB);
239             waitOutput(out, PROMPT);
240             ConsoleIOContextTestSupport.IMPL = null;
241         });
242     }
243 
244     public void testNoRepeat() throws Exception {
245         doRunTest((inputSink, out) -&gt; {
246             inputSink.write(&quot;String xyzAA;\n&quot;);
247             waitOutput(out, PROMPT);
248 
249             //xyz&lt;tab&gt;
250             inputSink.write(&quot;String s = xyz&quot; + TAB);
251             waitOutput(out, &quot;^String s = xyzAA&quot;);
252             inputSink.write(&quot;.&quot;);
253             waitOutput(out, &quot;^\\.&quot;);
254 
255             inputSink.write(INTERRUPT);
256             waitOutput(out, PROMPT);
257 
258             inputSink.write(&quot;double xyzAB;\n&quot;);
259             waitOutput(out, PROMPT);
260 
261             //xyz&lt;tab&gt;
262             inputSink.write(&quot;String s = xyz&quot; + TAB);
263             String allCompletions =
264                     resource(&quot;jshell.console.completion.all.completions&quot;);
265             waitOutput(out, &quot;.*xyzAA.*&quot; + allCompletions + &quot;.*\u0005String s = xyzA&quot;);
266         });
267     }
268 
269     private Path prepareZip() {
270         String clazz1 =
271                 &quot;package jshelltest;\n&quot; +
272                 &quot;/**JShellTest 0&quot; +
273                 &quot; */\n&quot; +
274                 &quot;public class JShellTest {\n&quot; +
275                 &quot;    /**JShellTest 1\n&quot; +
276                 &quot;     * &lt;p&gt;1 &lt;p&gt;1 &lt;p&gt;1 &lt;p&gt;1 &lt;p&gt;1 &lt;p&gt;1 &lt;p&gt;1 &lt;p&gt;1 &lt;p&gt;1 &lt;p&gt;1\n&quot; +
277                 &quot;     * &lt;p&gt;1 &lt;p&gt;1 &lt;p&gt;1 &lt;p&gt;1 &lt;p&gt;1 &lt;p&gt;1 &lt;p&gt;1 &lt;p&gt;1 &lt;p&gt;1 &lt;p&gt;1\n&quot; +
278                 &quot;     * &lt;p&gt;1 &lt;p&gt;1 &lt;p&gt;1 &lt;p&gt;1 &lt;p&gt;1 &lt;p&gt;1 &lt;p&gt;1 &lt;p&gt;1 &lt;p&gt;1 &lt;p&gt;1\n&quot; +
279                 &quot;     */\n&quot; +
280                 &quot;    public JShellTest(String str) {}\n&quot; +
281                 &quot;    /**JShellTest 2&quot; +
282                 &quot;     */\n&quot; +
283                 &quot;    public JShellTest(String str, int i) {}\n&quot; +
284                 &quot;}\n&quot;;
285 
286         String clazz2 =
287                 &quot;package jshelltest;\n&quot; +
288                 &quot;/**JShellTestAux 0&quot; +
289                 &quot; */\n&quot; +
290                 &quot;public class JShellTestAux {\n&quot; +
291                 &quot;    /**JShellTest 1&quot; +
292                 &quot;     */\n&quot; +
293                 &quot;    public JShellTestAux(String str) { }\n&quot; +
294                 &quot;    /**JShellTest 2&quot; +
295                 &quot;     */\n&quot; +
296                 &quot;    public JShellTestAux(String str, int i) { }\n&quot; +
297                 &quot;}\n&quot;;
298 
299         Path srcZip = Paths.get(&quot;src.zip&quot;);
300 
301         try (JarOutputStream out = new JarOutputStream(Files.newOutputStream(srcZip))) {
302             out.putNextEntry(new JarEntry(&quot;jshelltest/JShellTest.java&quot;));
303             out.write(clazz1.getBytes());
304             out.putNextEntry(new JarEntry(&quot;jshelltest/JShellTestAux.java&quot;));
305             out.write(clazz2.getBytes());
306         } catch (IOException ex) {
307             throw new IllegalStateException(ex);
308         }
309 
310         compiler.compile(clazz1, clazz2);
311 
312         try {
313             Field availableSources = Class.forName(&quot;jdk.jshell.SourceCodeAnalysisImpl&quot;).getDeclaredField(&quot;availableSourcesOverride&quot;);
314             availableSources.setAccessible(true);
315             availableSources.set(null, Arrays.asList(srcZip));
316         } catch (NoSuchFieldException | IllegalArgumentException | IllegalAccessException | ClassNotFoundException ex) {
317             throw new IllegalStateException(ex);
318         }
319 
320         return compiler.getClassDir();
321     }
322     //where:
323         private final Compiler compiler = new Compiler();
324 
325 }
    </pre>
  </body>
</html>