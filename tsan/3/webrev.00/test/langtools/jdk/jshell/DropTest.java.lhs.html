<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/langtools/jdk/jshell/DropTest.java</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 2015, 2016, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
<a name="1" id="anc1"></a><span class="line-modified"> 26  * @bug 8081431 8080069 8167128</span>
 27  * @summary Test of JShell#drop().
 28  * @build KullaTesting TestingInputStream
 29  * @run testng DropTest
 30  */
 31 
 32 import jdk.jshell.DeclarationSnippet;
 33 import jdk.jshell.Snippet;
<a name="2" id="anc2"></a>
 34 import jdk.jshell.VarSnippet;
 35 import org.testng.annotations.Test;
 36 
 37 import static jdk.jshell.Snippet.Status.*;
 38 
 39 @Test
 40 public class DropTest extends KullaTesting {
 41 
 42     public void testDrop() {
 43         Snippet var = varKey(assertEval(&quot;int x;&quot;));
 44         Snippet method = methodKey(assertEval(&quot;int mu() { return x * 4; }&quot;));
 45         Snippet clazz = classKey(assertEval(&quot;class C { String v() { return \&quot;#\&quot; + mu(); } }&quot;));
 46         assertDrop(var,
 47                 ste(var, VALID, DROPPED, true, null),
 48                 ste(method, VALID, RECOVERABLE_DEFINED, false, var));
 49         assertDrop(method,
 50                 ste(method, RECOVERABLE_DEFINED, DROPPED, true, null),
 51                 ste(clazz, VALID, RECOVERABLE_DEFINED, false, method));
 52         VarSnippet cc = varKey(assertEval(&quot;C c;&quot;));
 53         assertEvalUnresolvedException(&quot;new C();&quot;, &quot;C&quot;, 1, 0);
 54         assertVariables();
 55         assertMethods();
 56         assertClasses();
 57         assertActiveKeys();
 58 
 59         method = methodKey(assertEval(&quot;int mu() { return x * 4; }&quot;,
 60                 added(RECOVERABLE_DEFINED),
 61                 ste(clazz, RECOVERABLE_DEFINED, VALID, false, MAIN_SNIPPET)));
 62         assertEval(&quot;int x = 10;&quot;, &quot;10&quot;,
 63                 added(VALID),
 64                 ste(method, RECOVERABLE_DEFINED, VALID, false, MAIN_SNIPPET));
 65         Snippet c0 = varKey(assertEval(&quot;C c0 = new C();&quot;));
 66         assertEval(&quot;c0.v();&quot;, &quot;\&quot;#40\&quot;&quot;);
 67         assertEval(&quot;C c = new C();&quot;,
 68                 ste(MAIN_SNIPPET, VALID, VALID, false, null),
 69                 ste(cc, VALID, OVERWRITTEN, false, MAIN_SNIPPET));
 70         assertEval(&quot;c.v();&quot;, &quot;\&quot;#40\&quot;&quot;);
 71         assertEval(&quot;int mu() { return x * 3; }&quot;,
 72                 ste(MAIN_SNIPPET, VALID, VALID, false, null),
 73                 ste(method, VALID, OVERWRITTEN, false, MAIN_SNIPPET));
 74         assertEval(&quot;c.v();&quot;, &quot;\&quot;#30\&quot;&quot;);
 75         assertEval(&quot;class C { String v() { return \&quot;@\&quot; + mu(); } }&quot;,
 76                 ste(MAIN_SNIPPET, VALID, VALID, false, null),
 77                 ste(clazz, VALID, OVERWRITTEN, false, MAIN_SNIPPET));
 78         assertEval(&quot;c0.v();&quot;, &quot;\&quot;@30\&quot;&quot;);
 79         assertDrop(c0,
 80                 ste(c0, VALID, DROPPED, true, null));
 81         assertEval(&quot;c = new C();&quot;);
 82         assertEval(&quot;c.v();&quot;, &quot;\&quot;@30\&quot;&quot;);
 83 
 84         assertVariables();
 85         assertMethods();
 86         assertClasses();
 87         assertActiveKeys();
 88     }
 89 
 90     public void testDropImport() {
 91         Snippet imp = importKey(assertEval(&quot;import java.util.*;&quot;));
 92         Snippet decl = varKey(
 93                 assertEval(&quot;List&lt;Integer&gt; list = Arrays.asList(1, 2, 3);&quot;, &quot;[1, 2, 3]&quot;));
 94         assertEval(&quot;list;&quot;, &quot;[1, 2, 3]&quot;);
 95         assertDrop(imp,
 96                 DiagCheck.DIAG_OK,
 97                 DiagCheck.DIAG_ERROR,
 98                 ste(imp, VALID, DROPPED, true, null),
 99                 ste(decl, VALID, RECOVERABLE_NOT_DEFINED, true, imp));
100         assertDeclareFail(&quot;list;&quot;, &quot;compiler.err.cant.resolve.location&quot;);
101     }
102 
103     public void testDropStatement() {
104         Snippet x = key(assertEval(&quot;if (true);&quot;));
105         assertDrop(x, ste(x, VALID, DROPPED, true, null));
106     }
107 
108     public void testDropVarToMethod() {
109         Snippet x = varKey(assertEval(&quot;int x;&quot;));
110         DeclarationSnippet method = methodKey(assertEval(&quot;double mu() { return x * 4; }&quot;));
111         assertEval(&quot;x == 0;&quot;, &quot;true&quot;);
112         assertEval(&quot;mu() == 0.0;&quot;, &quot;true&quot;);
113 
114         assertDrop(x,
115                 ste(x, VALID, DROPPED, true, null),
116                 ste(method, VALID, RECOVERABLE_DEFINED, false, x));
117         assertUnresolvedDependencies1(method, RECOVERABLE_DEFINED, &quot;variable x&quot;);
118         assertEvalUnresolvedException(&quot;mu();&quot;, &quot;mu&quot;, 1, 0);
119 
120         assertVariables();
121         assertMethods();
122         assertActiveKeys();
123     }
124 
125     public void testDropMethodToMethod() {
126         Snippet a = methodKey(assertEval(&quot;double a() { return 2; }&quot;));
127         DeclarationSnippet b = methodKey(assertEval(&quot;double b() { return a() * 10; }&quot;));
128         assertEval(&quot;double c() { return b() * 3; }&quot;);
129         DeclarationSnippet d = methodKey(assertEval(&quot;double d() { return c() + 1000; }&quot;));
130         assertEval(&quot;d();&quot;, &quot;1060.0&quot;);
131         assertDrop(a,
132                 ste(a, VALID, DROPPED, true, null),
133                 ste(b, VALID, RECOVERABLE_DEFINED, false, a));
134         assertUnresolvedDependencies1(b, RECOVERABLE_DEFINED, &quot;method a()&quot;);
135         assertUnresolvedDependencies(d, 0);
136         assertEvalUnresolvedException(&quot;d();&quot;, &quot;b&quot;, 1, 0);
137         assertMethods();
138         assertActiveKeys();
139     }
140 
141     public void testDropClassToMethod() {
142         Snippet c = classKey(assertEval(&quot;class C { int f() { return 7; } }&quot;));
143         DeclarationSnippet m = methodKey(assertEval(&quot;int m() { return new C().f(); }&quot;));
144         assertDrop(c,
145                 ste(c, VALID, DROPPED, true, null),
146                 ste(m, VALID, RECOVERABLE_DEFINED, false, c));
147         assertUnresolvedDependencies1(m, RECOVERABLE_DEFINED, &quot;class C&quot;);
148         assertEvalUnresolvedException(&quot;m();&quot;, &quot;m&quot;, 1, 0);
149         assertActiveKeys();
150     }
151 
152     public void testDropVarToClass() {
153         Snippet x = varKey(assertEval(&quot;int x;&quot;));
154         DeclarationSnippet a = classKey(assertEval(&quot;class A { double a = 4 * x; }&quot;));
155         assertDrop(x,
156                 DiagCheck.DIAG_OK,
157                 DiagCheck.DIAG_ERROR,
158                 ste(x, VALID, DROPPED, true, null),
159                 ste(a, VALID, RECOVERABLE_DEFINED, false, x));
160         assertEval(&quot;A foo() { return null; }&quot;);
161         assertUnresolvedDependencies1(a, RECOVERABLE_DEFINED, &quot;variable x&quot;);
162         assertEvalUnresolvedException(&quot;new A();&quot;, &quot;A&quot;, 1, 0);
163         assertVariables();
164         assertActiveKeys();
165     }
166 
167     public void testDropMethodToClass() {
168         Snippet x = methodKey(assertEval(&quot;int x() { return 0; }&quot;));
169         DeclarationSnippet a = classKey(assertEval(&quot;class A { double a = 4 * x(); }&quot;));
170         assertDrop(x,
171                 DiagCheck.DIAG_OK,
172                 DiagCheck.DIAG_ERROR,
173                 ste(x, VALID, DROPPED, true, null),
174                 ste(a, VALID, RECOVERABLE_DEFINED, false, x));
175         assertUnresolvedDependencies1(a, RECOVERABLE_DEFINED, &quot;method x()&quot;);
176         assertEvalUnresolvedException(&quot;new A();&quot;, &quot;A&quot;, 1, 0);
177         assertMethods();
178         assertActiveKeys();
179     }
180 
181     public void testDropClassToClass() {
182         Snippet a = classKey(assertEval(&quot;class A {}&quot;));
183         Snippet b = classKey(assertEval(&quot;class B extends A {}&quot;));
184         Snippet c = classKey(assertEval(&quot;class C extends B {}&quot;));
185         Snippet d = classKey(assertEval(&quot;class D extends C {}&quot;));
186         assertDrop(a,
187                 DiagCheck.DIAG_OK,
188                 DiagCheck.DIAG_ERROR,
189                 ste(a, VALID, DROPPED, true, null),
190                 ste(b, VALID, RECOVERABLE_NOT_DEFINED, true, a),
191                 ste(c, VALID, RECOVERABLE_NOT_DEFINED, true, b),
192                 ste(d, VALID, RECOVERABLE_NOT_DEFINED, true, c));
193         assertUnresolvedDependencies1((DeclarationSnippet) b, RECOVERABLE_NOT_DEFINED, &quot;class A&quot;);
194         assertDrop(c,
195                 DiagCheck.DIAG_OK,
196                 DiagCheck.DIAG_ERROR,
197                 ste(c, RECOVERABLE_NOT_DEFINED, DROPPED, false, null));
198         assertEval(&quot;interface A {}&quot;, null, null,
199                 DiagCheck.DIAG_OK,
200                 DiagCheck.DIAG_ERROR,
201                 added(VALID));
202         assertClasses();
203         assertActiveKeys();
204     }
205 
206     public void testDropNoUpdate() {
207         String as1 = &quot;class A {}&quot;;
208         String as2 = &quot;class A extends java.util.ArrayList&lt;Boolean&gt; {}&quot;;
209         Snippet a = classKey(assertEval(as1, added(VALID)));
210         Snippet b = classKey(assertEval(&quot;class B extends A {}&quot;, added(VALID)));
211         Snippet ax = classKey(assertEval(as2,
212                 ste(MAIN_SNIPPET, VALID, VALID, true, null),
213                 ste(a, VALID, OVERWRITTEN, false, MAIN_SNIPPET),
214                 ste(b, VALID, VALID, true, MAIN_SNIPPET)));
215         ax = classKey(assertEval(as1,
216                 ste(MAIN_SNIPPET, VALID, VALID, true, null),
217                 ste(ax, VALID, OVERWRITTEN, false, MAIN_SNIPPET),
218                 ste(b, VALID, VALID, true, MAIN_SNIPPET)));
219         assertDrop(b,
220                 ste(b, VALID, DROPPED, true, null));
221         ax = classKey(assertEval(as2,
222                 ste(MAIN_SNIPPET, VALID, VALID, true, null),
223                 ste(ax, VALID, OVERWRITTEN, false, MAIN_SNIPPET)));
224         assertEval(as1,
225                 ste(MAIN_SNIPPET, VALID, VALID, true, null),
226                 ste(ax, VALID, OVERWRITTEN, false, MAIN_SNIPPET));
227     }
<a name="3" id="anc3"></a>












228 }
<a name="4" id="anc4"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="4" type="hidden" />
</body>
</html>