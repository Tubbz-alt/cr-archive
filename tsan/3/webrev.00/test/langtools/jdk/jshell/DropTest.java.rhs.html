<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/langtools/jdk/jshell/DropTest.java</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 2015, 2016, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
<a name="1" id="anc1"></a><span class="line-modified"> 26  * @bug 8081431 8080069 8167128 8199623</span>
 27  * @summary Test of JShell#drop().
 28  * @build KullaTesting TestingInputStream
 29  * @run testng DropTest
 30  */
 31 
 32 import jdk.jshell.DeclarationSnippet;
 33 import jdk.jshell.Snippet;
<a name="2" id="anc2"></a><span class="line-added"> 34 import jdk.jshell.MethodSnippet;</span>
 35 import jdk.jshell.VarSnippet;
 36 import org.testng.annotations.Test;
 37 
 38 import static jdk.jshell.Snippet.Status.*;
 39 
 40 @Test
 41 public class DropTest extends KullaTesting {
 42 
 43     public void testDrop() {
 44         Snippet var = varKey(assertEval(&quot;int x;&quot;));
 45         Snippet method = methodKey(assertEval(&quot;int mu() { return x * 4; }&quot;));
 46         Snippet clazz = classKey(assertEval(&quot;class C { String v() { return \&quot;#\&quot; + mu(); } }&quot;));
 47         assertDrop(var,
 48                 ste(var, VALID, DROPPED, true, null),
 49                 ste(method, VALID, RECOVERABLE_DEFINED, false, var));
 50         assertDrop(method,
 51                 ste(method, RECOVERABLE_DEFINED, DROPPED, true, null),
 52                 ste(clazz, VALID, RECOVERABLE_DEFINED, false, method));
 53         VarSnippet cc = varKey(assertEval(&quot;C c;&quot;));
 54         assertEvalUnresolvedException(&quot;new C();&quot;, &quot;C&quot;, 1, 0);
 55         assertVariables();
 56         assertMethods();
 57         assertClasses();
 58         assertActiveKeys();
 59 
 60         method = methodKey(assertEval(&quot;int mu() { return x * 4; }&quot;,
 61                 added(RECOVERABLE_DEFINED),
 62                 ste(clazz, RECOVERABLE_DEFINED, VALID, false, MAIN_SNIPPET)));
 63         assertEval(&quot;int x = 10;&quot;, &quot;10&quot;,
 64                 added(VALID),
 65                 ste(method, RECOVERABLE_DEFINED, VALID, false, MAIN_SNIPPET));
 66         Snippet c0 = varKey(assertEval(&quot;C c0 = new C();&quot;));
 67         assertEval(&quot;c0.v();&quot;, &quot;\&quot;#40\&quot;&quot;);
 68         assertEval(&quot;C c = new C();&quot;,
 69                 ste(MAIN_SNIPPET, VALID, VALID, false, null),
 70                 ste(cc, VALID, OVERWRITTEN, false, MAIN_SNIPPET));
 71         assertEval(&quot;c.v();&quot;, &quot;\&quot;#40\&quot;&quot;);
 72         assertEval(&quot;int mu() { return x * 3; }&quot;,
 73                 ste(MAIN_SNIPPET, VALID, VALID, false, null),
 74                 ste(method, VALID, OVERWRITTEN, false, MAIN_SNIPPET));
 75         assertEval(&quot;c.v();&quot;, &quot;\&quot;#30\&quot;&quot;);
 76         assertEval(&quot;class C { String v() { return \&quot;@\&quot; + mu(); } }&quot;,
 77                 ste(MAIN_SNIPPET, VALID, VALID, false, null),
 78                 ste(clazz, VALID, OVERWRITTEN, false, MAIN_SNIPPET));
 79         assertEval(&quot;c0.v();&quot;, &quot;\&quot;@30\&quot;&quot;);
 80         assertDrop(c0,
 81                 ste(c0, VALID, DROPPED, true, null));
 82         assertEval(&quot;c = new C();&quot;);
 83         assertEval(&quot;c.v();&quot;, &quot;\&quot;@30\&quot;&quot;);
 84 
 85         assertVariables();
 86         assertMethods();
 87         assertClasses();
 88         assertActiveKeys();
 89     }
 90 
 91     public void testDropImport() {
 92         Snippet imp = importKey(assertEval(&quot;import java.util.*;&quot;));
 93         Snippet decl = varKey(
 94                 assertEval(&quot;List&lt;Integer&gt; list = Arrays.asList(1, 2, 3);&quot;, &quot;[1, 2, 3]&quot;));
 95         assertEval(&quot;list;&quot;, &quot;[1, 2, 3]&quot;);
 96         assertDrop(imp,
 97                 DiagCheck.DIAG_OK,
 98                 DiagCheck.DIAG_ERROR,
 99                 ste(imp, VALID, DROPPED, true, null),
100                 ste(decl, VALID, RECOVERABLE_NOT_DEFINED, true, imp));
101         assertDeclareFail(&quot;list;&quot;, &quot;compiler.err.cant.resolve.location&quot;);
102     }
103 
104     public void testDropStatement() {
105         Snippet x = key(assertEval(&quot;if (true);&quot;));
106         assertDrop(x, ste(x, VALID, DROPPED, true, null));
107     }
108 
109     public void testDropVarToMethod() {
110         Snippet x = varKey(assertEval(&quot;int x;&quot;));
111         DeclarationSnippet method = methodKey(assertEval(&quot;double mu() { return x * 4; }&quot;));
112         assertEval(&quot;x == 0;&quot;, &quot;true&quot;);
113         assertEval(&quot;mu() == 0.0;&quot;, &quot;true&quot;);
114 
115         assertDrop(x,
116                 ste(x, VALID, DROPPED, true, null),
117                 ste(method, VALID, RECOVERABLE_DEFINED, false, x));
118         assertUnresolvedDependencies1(method, RECOVERABLE_DEFINED, &quot;variable x&quot;);
119         assertEvalUnresolvedException(&quot;mu();&quot;, &quot;mu&quot;, 1, 0);
120 
121         assertVariables();
122         assertMethods();
123         assertActiveKeys();
124     }
125 
126     public void testDropMethodToMethod() {
127         Snippet a = methodKey(assertEval(&quot;double a() { return 2; }&quot;));
128         DeclarationSnippet b = methodKey(assertEval(&quot;double b() { return a() * 10; }&quot;));
129         assertEval(&quot;double c() { return b() * 3; }&quot;);
130         DeclarationSnippet d = methodKey(assertEval(&quot;double d() { return c() + 1000; }&quot;));
131         assertEval(&quot;d();&quot;, &quot;1060.0&quot;);
132         assertDrop(a,
133                 ste(a, VALID, DROPPED, true, null),
134                 ste(b, VALID, RECOVERABLE_DEFINED, false, a));
135         assertUnresolvedDependencies1(b, RECOVERABLE_DEFINED, &quot;method a()&quot;);
136         assertUnresolvedDependencies(d, 0);
137         assertEvalUnresolvedException(&quot;d();&quot;, &quot;b&quot;, 1, 0);
138         assertMethods();
139         assertActiveKeys();
140     }
141 
142     public void testDropClassToMethod() {
143         Snippet c = classKey(assertEval(&quot;class C { int f() { return 7; } }&quot;));
144         DeclarationSnippet m = methodKey(assertEval(&quot;int m() { return new C().f(); }&quot;));
145         assertDrop(c,
146                 ste(c, VALID, DROPPED, true, null),
147                 ste(m, VALID, RECOVERABLE_DEFINED, false, c));
148         assertUnresolvedDependencies1(m, RECOVERABLE_DEFINED, &quot;class C&quot;);
149         assertEvalUnresolvedException(&quot;m();&quot;, &quot;m&quot;, 1, 0);
150         assertActiveKeys();
151     }
152 
153     public void testDropVarToClass() {
154         Snippet x = varKey(assertEval(&quot;int x;&quot;));
155         DeclarationSnippet a = classKey(assertEval(&quot;class A { double a = 4 * x; }&quot;));
156         assertDrop(x,
157                 DiagCheck.DIAG_OK,
158                 DiagCheck.DIAG_ERROR,
159                 ste(x, VALID, DROPPED, true, null),
160                 ste(a, VALID, RECOVERABLE_DEFINED, false, x));
161         assertEval(&quot;A foo() { return null; }&quot;);
162         assertUnresolvedDependencies1(a, RECOVERABLE_DEFINED, &quot;variable x&quot;);
163         assertEvalUnresolvedException(&quot;new A();&quot;, &quot;A&quot;, 1, 0);
164         assertVariables();
165         assertActiveKeys();
166     }
167 
168     public void testDropMethodToClass() {
169         Snippet x = methodKey(assertEval(&quot;int x() { return 0; }&quot;));
170         DeclarationSnippet a = classKey(assertEval(&quot;class A { double a = 4 * x(); }&quot;));
171         assertDrop(x,
172                 DiagCheck.DIAG_OK,
173                 DiagCheck.DIAG_ERROR,
174                 ste(x, VALID, DROPPED, true, null),
175                 ste(a, VALID, RECOVERABLE_DEFINED, false, x));
176         assertUnresolvedDependencies1(a, RECOVERABLE_DEFINED, &quot;method x()&quot;);
177         assertEvalUnresolvedException(&quot;new A();&quot;, &quot;A&quot;, 1, 0);
178         assertMethods();
179         assertActiveKeys();
180     }
181 
182     public void testDropClassToClass() {
183         Snippet a = classKey(assertEval(&quot;class A {}&quot;));
184         Snippet b = classKey(assertEval(&quot;class B extends A {}&quot;));
185         Snippet c = classKey(assertEval(&quot;class C extends B {}&quot;));
186         Snippet d = classKey(assertEval(&quot;class D extends C {}&quot;));
187         assertDrop(a,
188                 DiagCheck.DIAG_OK,
189                 DiagCheck.DIAG_ERROR,
190                 ste(a, VALID, DROPPED, true, null),
191                 ste(b, VALID, RECOVERABLE_NOT_DEFINED, true, a),
192                 ste(c, VALID, RECOVERABLE_NOT_DEFINED, true, b),
193                 ste(d, VALID, RECOVERABLE_NOT_DEFINED, true, c));
194         assertUnresolvedDependencies1((DeclarationSnippet) b, RECOVERABLE_NOT_DEFINED, &quot;class A&quot;);
195         assertDrop(c,
196                 DiagCheck.DIAG_OK,
197                 DiagCheck.DIAG_ERROR,
198                 ste(c, RECOVERABLE_NOT_DEFINED, DROPPED, false, null));
199         assertEval(&quot;interface A {}&quot;, null, null,
200                 DiagCheck.DIAG_OK,
201                 DiagCheck.DIAG_ERROR,
202                 added(VALID));
203         assertClasses();
204         assertActiveKeys();
205     }
206 
207     public void testDropNoUpdate() {
208         String as1 = &quot;class A {}&quot;;
209         String as2 = &quot;class A extends java.util.ArrayList&lt;Boolean&gt; {}&quot;;
210         Snippet a = classKey(assertEval(as1, added(VALID)));
211         Snippet b = classKey(assertEval(&quot;class B extends A {}&quot;, added(VALID)));
212         Snippet ax = classKey(assertEval(as2,
213                 ste(MAIN_SNIPPET, VALID, VALID, true, null),
214                 ste(a, VALID, OVERWRITTEN, false, MAIN_SNIPPET),
215                 ste(b, VALID, VALID, true, MAIN_SNIPPET)));
216         ax = classKey(assertEval(as1,
217                 ste(MAIN_SNIPPET, VALID, VALID, true, null),
218                 ste(ax, VALID, OVERWRITTEN, false, MAIN_SNIPPET),
219                 ste(b, VALID, VALID, true, MAIN_SNIPPET)));
220         assertDrop(b,
221                 ste(b, VALID, DROPPED, true, null));
222         ax = classKey(assertEval(as2,
223                 ste(MAIN_SNIPPET, VALID, VALID, true, null),
224                 ste(ax, VALID, OVERWRITTEN, false, MAIN_SNIPPET)));
225         assertEval(as1,
226                 ste(MAIN_SNIPPET, VALID, VALID, true, null),
227                 ste(ax, VALID, OVERWRITTEN, false, MAIN_SNIPPET));
228     }
<a name="3" id="anc3"></a><span class="line-added">229 </span>
<span class="line-added">230     // 8199623</span>
<span class="line-added">231     public void testTwoForkedDrop() {</span>
<span class="line-added">232         MethodSnippet p = methodKey(assertEval(&quot;void p() throws Exception { ((String) null).toString(); }&quot;));</span>
<span class="line-added">233         MethodSnippet n = methodKey(assertEval(&quot;void n() throws Exception { try { p(); } catch (Exception ex) { throw new RuntimeException(\&quot;bar\&quot;, ex); }}&quot;));</span>
<span class="line-added">234         MethodSnippet m = methodKey(assertEval(&quot;void m() { try { n(); } catch (Exception ex) { throw new RuntimeException(\&quot;foo\&quot;, ex); }}&quot;));</span>
<span class="line-added">235         MethodSnippet c = methodKey(assertEval(&quot;void c() throws Throwable { p(); }&quot;));</span>
<span class="line-added">236         assertDrop(p,</span>
<span class="line-added">237                 ste(p, VALID, DROPPED, true, null),</span>
<span class="line-added">238                 ste(n, VALID, RECOVERABLE_DEFINED, false, p),</span>
<span class="line-added">239                 ste(c, VALID, RECOVERABLE_DEFINED, false, p));</span>
<span class="line-added">240         assertActiveKeys();</span>
<span class="line-added">241     }</span>
242 }
<a name="4" id="anc4"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="4" type="hidden" />
</body>
</html>