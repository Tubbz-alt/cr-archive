<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old test/langtools/jdk/jshell/MethodsTest.java</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2015, 2017, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @bug 8080357 8167643 8187359 8199762
 27  * @summary Tests for EvaluationState.methods
 28  * @build KullaTesting TestingInputStream ExpectedDiagnostic
 29  * @run testng MethodsTest
 30  */
 31 
 32 import javax.tools.Diagnostic;
 33 
 34 import jdk.jshell.Snippet;
 35 import jdk.jshell.MethodSnippet;
 36 import jdk.jshell.Snippet.Status;
 37 import org.testng.annotations.Test;
 38 
 39 import static jdk.jshell.Snippet.Status.*;
 40 
 41 @Test
 42 public class MethodsTest extends KullaTesting {
 43 
 44     public void noMethods() {
 45         assertNumberOfActiveMethods(0);
 46     }
 47 
 48     public void testSignature1() {
 49         MethodSnippet m1 = methodKey(assertEval(&quot;void f() { g(); }&quot;, added(RECOVERABLE_DEFINED)));
 50         assertMethodDeclSnippet(m1, &quot;f&quot;, &quot;()void&quot;, RECOVERABLE_DEFINED, 1, 0);
 51         MethodSnippet m2 = methodKey(assertEval(&quot;void g() { }&quot;,
 52                 added(VALID),
 53                 ste(m1, RECOVERABLE_DEFINED, VALID, false, null)));
 54         assertMethodDeclSnippet(m2, &quot;g&quot;, &quot;()void&quot;, VALID, 0, 0);
 55     }
 56 
 57     public void testSignature2() {
 58         MethodSnippet m1 = (MethodSnippet) assertDeclareFail(&quot;void f() { return g(); }&quot;, &quot;compiler.err.prob.found.req&quot;);
 59         assertMethodDeclSnippet(m1, &quot;f&quot;, &quot;()void&quot;, REJECTED, 0, 2);
 60         MethodSnippet m2 = methodKey(assertEval(&quot;int f() { return g(); }&quot;,
 61                 added(RECOVERABLE_DEFINED)));
 62         assertMethodDeclSnippet(m1, &quot;f&quot;, &quot;()void&quot;, REJECTED, 0, 2);
 63         assertMethodDeclSnippet(m2, &quot;f&quot;, &quot;()int&quot;, RECOVERABLE_DEFINED, 1, 0);
 64     }
 65 
 66     @Test(enabled = false) // TODO 8081690
 67     public void testSignature3() {
 68         MethodSnippet m1 = methodKey(assertEval(&quot;void f(Bar b) { }&quot;, added(RECOVERABLE_NOT_DEFINED)));
 69         assertMethodDeclSnippet(m1, &quot;f&quot;, &quot;(Bar)void&quot;, RECOVERABLE_NOT_DEFINED, 1, 0);
 70         MethodSnippet m2 = methodKey(assertEval(&quot;void f(A.Bar b) { }&quot;, added(RECOVERABLE_NOT_DEFINED)));
 71         assertMethodDeclSnippet(m1, &quot;f&quot;, &quot;(Bar)void&quot;, RECOVERABLE_NOT_DEFINED, 1, 0);
 72         assertMethodDeclSnippet(m2, &quot;f&quot;, &quot;(A.Bar)void&quot;, RECOVERABLE_NOT_DEFINED, 1, 0);
 73         assertDrop(m1, ste(m1, RECOVERABLE_NOT_DEFINED, DROPPED, false, null));
 74         assertMethodDeclSnippet(m1, &quot;f&quot;, &quot;(Bar)void&quot;, DROPPED, 1, 0);
 75     }
 76 
 77     // 8080357
 78     public void testNonReplUnresolved() {
 79         // internal case
 80         assertEval(&quot;class CCC {}&quot;, added(VALID));
 81         assertEval(&quot;void f1() { CCC.xxxx(); }&quot;, added(RECOVERABLE_DEFINED));
 82         // external case, not recoverable
 83         assertDeclareFail(&quot;void f2() { System.xxxx(); }&quot;, &quot;compiler.err.cant.resolve.location.args&quot;);
 84     }
 85 
 86     public void methods() {
 87         assertEval(&quot;int x() { return 10; }&quot;);
 88         assertEval(&quot;String y() { return null; }&quot;);
 89         assertEval(&quot;long z() { return 0; }&quot;);
 90         assertMethods(method(&quot;()int&quot;, &quot;x&quot;), method(&quot;()String&quot;, &quot;y&quot;), method(&quot;()long&quot;, &quot;z&quot;));
 91         assertActiveKeys();
 92     }
 93 
 94     public void methodOverload() {
 95         assertEval(&quot;int m() { return 1; }&quot;);
 96         assertEval(&quot;int m(int x) { return 2; }&quot;);
 97         assertEval(&quot;int m(String s) { return 3; }&quot;);
 98         assertEval(&quot;int m(int x, int y) { return 4; }&quot;);
 99         assertEval(&quot;int m(int x, String z) { return 5; }&quot;);
100         assertEval(&quot;int m(int x, String z, long g) { return 6; }&quot;);
101         assertMethods(
102                 method(&quot;()int&quot;, &quot;m&quot;),
103                 method(&quot;(int)int&quot;, &quot;m&quot;),
104                 method(&quot;(String)int&quot;, &quot;m&quot;),
105                 method(&quot;(int,int)int&quot;, &quot;m&quot;),
106                 method(&quot;(int,String)int&quot;, &quot;m&quot;),
107                 method(&quot;(int,String,long)int&quot;, &quot;m&quot;)
108         );
109         assertEval(&quot;m();&quot;, &quot;1&quot;);
110         assertEval(&quot;m(3);&quot;, &quot;2&quot;);
111         assertEval(&quot;m(\&quot;hi\&quot;);&quot;, &quot;3&quot;);
112         assertEval(&quot;m(7, 8);&quot;, &quot;4&quot;);
113         assertEval(&quot;m(7, \&quot;eight\&quot;);&quot;, &quot;5&quot;);
114         assertEval(&quot;m(7, \&quot;eight\&quot;, 9L);&quot;, &quot;6&quot;);
115         assertActiveKeys();
116     }
117 
118     /***
119     public void methodOverloadDependent() {
120         assertEval(&quot;String m(String s) { return s + s; }&quot;);
121         assertEval(&quot;String m(double d) { return m(\&quot;#\&quot; + d); }&quot;);
122         assertEval(&quot;String m(int x) { return m(2.25 * x); }&quot;);
123         assertEval(&quot;String m() { return m(3); }&quot;);
124         assertMethods(
125                 method(&quot;(String)String&quot;, &quot;m&quot;),
126                 method(&quot;(double)String&quot;, &quot;m&quot;),
127                 method(&quot;(int)String&quot;, &quot;m&quot;),
128                 method(&quot;()String&quot;, &quot;m&quot;)
129         );
130         assertEval(&quot;m();&quot;, &quot;\&quot;#6.75#6.75\&quot;&quot;);
131         assertEval(&quot;m(2);&quot;, &quot;\&quot;#4.5#4.5\&quot;&quot;);
132         assertEval(&quot;m(3.14);&quot;, &quot;\&quot;#3.14#3.14\&quot;&quot;);
133         assertEval(&quot;m(\&quot;hi\&quot;);&quot;, &quot;\&quot;hihi\&quot;&quot;);
134         assertActiveKeys();
135     }
136     ***/
137 
138     public void methodsRedeclaration1() {
139         Snippet x = methodKey(assertEval(&quot;int x() { return 10; }&quot;));
140         Snippet y = methodKey(assertEval(&quot;String y() { return \&quot;\&quot;; }&quot;));
141         assertMethods(method(&quot;()int&quot;, &quot;x&quot;), method(&quot;()String&quot;, &quot;y&quot;));
142         assertActiveKeys();
143 
144         assertEval(&quot;long x() { return 0; }&quot;,
145                 ste(MAIN_SNIPPET, VALID, VALID, true, null),
146                 ste(x, VALID, OVERWRITTEN, false, MAIN_SNIPPET));
147         assertMethods(method(&quot;()long&quot;, &quot;x&quot;), method(&quot;()String&quot;, &quot;y&quot;));
148         assertActiveKeys();
149 
150         assertEval(&quot;String y() { return null; }&quot;,
151                 ste(MAIN_SNIPPET, VALID, VALID, false, null),
152                 ste(y, VALID, OVERWRITTEN, false, MAIN_SNIPPET));
153         assertMethods(method(&quot;()long&quot;, &quot;x&quot;), method(&quot;()String&quot;, &quot;y&quot;));
154         assertActiveKeys();
155     }
156 
157     public void methodsRedeclaration2() {
158         assertEval(&quot;int a() { return 1; }&quot;);
159         assertMethods(method(&quot;()int&quot;, &quot;a&quot;));
160         assertActiveKeys();
161 
162         Snippet b = methodKey(assertEval(&quot;Integer b() { return a(); }&quot;));
163         assertMethods(method(&quot;()int&quot;, &quot;a&quot;), method(&quot;()Integer&quot;, &quot;b&quot;));
164         assertActiveKeys();
165 
166         Snippet c = methodKey(assertEval(&quot;double c() { return b(); }&quot;));
167         assertMethods(method(&quot;()int&quot;, &quot;a&quot;), method(&quot;()Integer&quot;, &quot;b&quot;), method(&quot;()double&quot;, &quot;c&quot;));
168         assertActiveKeys();
169 
170         assertEval(&quot;double b() { return 3.14159; }&quot;,
171                 ste(MAIN_SNIPPET, VALID, VALID, true, null),
172                 ste(b, VALID, OVERWRITTEN, false, MAIN_SNIPPET));
173         assertMethods(method(&quot;()int&quot;, &quot;a&quot;), method(&quot;()double&quot;, &quot;b&quot;), method(&quot;()double&quot;, &quot;c&quot;));
174         assertEval(&quot;c();&quot;, &quot;3.14159&quot;);
175         assertActiveKeys();
176     }
177 
178     public void methodsRedeclaration3() {
179         Snippet x = methodKey(assertEval(&quot;int x(Object...a) { return 10; }&quot;));
180         assertMethods(method(&quot;(Object...)int&quot;, &quot;x&quot;));
181         assertActiveKeys();
182 
183         assertEval(&quot;int x(Object[]a) { return 10; }&quot;,
184                 ste(MAIN_SNIPPET, VALID, VALID, true, null),
185                 ste(x, VALID, OVERWRITTEN, false, MAIN_SNIPPET));
186         assertMethods(method(&quot;(Object[])int&quot;, &quot;x&quot;));
187         assertActiveKeys();
188     }
189 
190 
191     public void methodsRedeclaration4() {
192         Snippet a = methodKey(assertEval(&quot;int foo(int a) { return a; }&quot;));
193         assertEval(&quot;int x = foo(10);&quot;);
194         assertActiveKeys();
195         assertMethods(method(&quot;(int)int&quot;, &quot;foo&quot;));
196         assertEval(&quot;int foo(int a) { return a * a; }&quot;,
197                 ste(MAIN_SNIPPET, VALID, VALID, false, null),
198                 ste(a, VALID, OVERWRITTEN, false, MAIN_SNIPPET));
199         assertActiveKeys();
200     }
201 
202     // 8199762
203     public void methodsRedeclaration5() {
204         Snippet m1 = methodKey(assertEval(&quot;int m(Object o) { return 10; }&quot;));
205         assertMethods(method(&quot;(Object)int&quot;, &quot;m&quot;));
206 
207         Snippet m2 = methodKey(assertEval(&quot;int m(Object o) { return 30; }&quot;,
208                 ste(MAIN_SNIPPET, VALID, VALID, false, null),
209                 ste(m1, VALID, OVERWRITTEN, false, MAIN_SNIPPET)));
210 
211         assertEval(&quot;&lt;T&gt; int m(T o) { return 30; }&quot;,
212                 ste(MAIN_SNIPPET, VALID, VALID, true, null),
213                 ste(m2, VALID, OVERWRITTEN, false, MAIN_SNIPPET));
214         assertMethods(method(&quot;(T)int&quot;, &quot;m&quot;));
215         assertEval(&quot;m(null)&quot;, &quot;30&quot;);
216         assertActiveKeys();
217     }
218 
219     public void methodsErrors() {
220         assertDeclareFail(&quot;String f();&quot;,
221                 new ExpectedDiagnostic(&quot;compiler.err.missing.meth.body.or.decl.abstract&quot;, 0, 11, 7, -1, -1, Diagnostic.Kind.ERROR));
222         assertNumberOfActiveMethods(0);
223         assertActiveKeys();
224 
225         assertDeclareFail(&quot;abstract String f();&quot;,
226                 new ExpectedDiagnostic(&quot;jdk.eval.error.illegal.modifiers&quot;, 0, 8, 0, -1, -1, Diagnostic.Kind.ERROR));
227         assertNumberOfActiveMethods(0);
228         assertActiveKeys();
229 
230         assertDeclareFail(&quot;native String f();&quot;,
231                 new ExpectedDiagnostic(&quot;jdk.eval.error.illegal.modifiers&quot;, 0, 6, 0, -1, -1, Diagnostic.Kind.ERROR));
232         assertNumberOfActiveMethods(0);
233         assertActiveKeys();
234 
235         assertDeclareFail(&quot;synchronized String f() {return null;}&quot;,
236                 new ExpectedDiagnostic(&quot;jdk.eval.error.illegal.modifiers&quot;, 0, 12, 0, -1, -1, Diagnostic.Kind.ERROR));
237         assertNumberOfActiveMethods(0);
238         assertActiveKeys();
239 
240         assertDeclareFail(&quot;int f() {}&quot;, &quot;compiler.err.missing.ret.stmt&quot;,
241                 added(REJECTED));
242         assertNumberOfActiveMethods(0);
243         assertActiveKeys();
244 
245         assertEval(&quot;String x() { return \&quot;\&quot;; };&quot;);
246         assertMethods(method(&quot;()String&quot;, &quot;x&quot;));
247         assertActiveKeys();
248     }
249 
250     public void objectMethodNamedMethodsErrors() {
251         assertDeclareFail(&quot;boolean equals(double d1, double d2) {  return d1 == d2; }&quot;,
252                 new ExpectedDiagnostic(&quot;jdk.eval.error.object.method&quot;, 8, 14, 8, -1, -1, Diagnostic.Kind.ERROR));
253         assertNumberOfActiveMethods(0);
254         assertActiveKeys();
255 
256         assertDeclareFail(&quot;void          wait() { }&quot;,
257                 new ExpectedDiagnostic(&quot;jdk.eval.error.object.method&quot;, 14, 18, 14, -1, -1, Diagnostic.Kind.ERROR));
258         assertNumberOfActiveMethods(0);
259         assertActiveKeys();
260 
261         assertDeclareFail(&quot;  String   toString() throws NullPointerException{ }&quot;,
262                 new ExpectedDiagnostic(&quot;jdk.eval.error.object.method&quot;, 11, 19, 11, -1, -1, Diagnostic.Kind.ERROR));
263         assertNumberOfActiveMethods(0);
264         assertActiveKeys();
265 
266     }
267 
268 
269     public void methodsAccessModifierIgnored() {
270         Snippet f = methodKey(assertEval(&quot;public String f() {return null;}&quot;,
271                 added(VALID)));
272         assertNumberOfActiveMethods(1);
273         assertActiveKeys();
274 
275         f = methodKey(assertEval(&quot;protected String f() {return null;}&quot;,
276                 ste(MAIN_SNIPPET, VALID, VALID, false, null),
277                 ste(f, VALID, OVERWRITTEN, false, MAIN_SNIPPET)));
278         assertNumberOfActiveMethods(1);
279         assertActiveKeys();
280 
281         assertEval(&quot;private String f() {return null;}&quot;,
282                 ste(MAIN_SNIPPET, VALID, VALID, false, null),
283                 ste(f, VALID, OVERWRITTEN, false, MAIN_SNIPPET));
284         assertNumberOfActiveMethods(1);
285         assertActiveKeys();
286     }
287 
288     public void methodsWarn() {
289         Snippet f = assertDeclareWarn1(&quot;static String f() {return null;}&quot;,
290                 new ExpectedDiagnostic(&quot;jdk.eval.warn.illegal.modifiers&quot;, 0, 6, 0, -1, -1, Diagnostic.Kind.WARNING),
291                 added(VALID));
292         assertNumberOfActiveMethods(1);
293         assertActiveKeys();
294 
295         assertDeclareWarn1(&quot;final String f() {return null;}&quot;,
296                 new ExpectedDiagnostic(&quot;jdk.eval.warn.illegal.modifiers&quot;, 0, 5, 0, -1, -1, Diagnostic.Kind.WARNING),
297                 ste(MAIN_SNIPPET, VALID, VALID, false, null),
298                 ste(f, VALID, OVERWRITTEN, false, MAIN_SNIPPET));
299         assertNumberOfActiveMethods(1);
300         assertActiveKeys();
301     }
302 
303     public void methodSignatureUnresolved() {
304         MethodSnippet key = (MethodSnippet) methodKey(assertEval(&quot;und m() { return new und(); }&quot;, added(RECOVERABLE_NOT_DEFINED)));
305         assertMethodDeclSnippet(key, &quot;m&quot;, &quot;()und&quot;, RECOVERABLE_NOT_DEFINED, 1, 0);
306         assertUnresolvedDependencies1(key, Status.RECOVERABLE_NOT_DEFINED, &quot;class und&quot;);
307         assertEval(&quot;class und {}&quot;,
308                 added(VALID),
309                 ste(key, RECOVERABLE_NOT_DEFINED, VALID, true, null));
310         assertMethodDeclSnippet(key, &quot;m&quot;, &quot;()und&quot;, Status.VALID, 0, 0);
311         assertNumberOfActiveMethods(1);
312         assertActiveKeys();
313     }
314 
315     @Test(enabled = false) // TODO 8081689
316     public void classMethodsAreNotVisible() {
317         assertEval(
318             &quot;class A {&quot; +
319                 &quot;int foo() {&quot; +
320                     &quot;int x = 10;&quot; +
321                     &quot;int y = 2 * x;&quot; +
322                     &quot;return x * y;&quot; +
323                 &quot;}&quot; +
324             &quot;}&quot;);
325         assertNumberOfActiveMethods(0);
326         assertEval(&quot;int x = 10;&quot;, &quot;10&quot;);
327         assertEval(&quot;int foo() {&quot; +
328                         &quot;int y = 2 * x;&quot; +
329                         &quot;return x * y;&quot; +
330                         &quot;}&quot;);
331         assertMethods(method(&quot;()int&quot;, &quot;foo&quot;));
332         assertEval(&quot;foo();&quot;, &quot;200&quot;);
333         assertActiveKeys();
334     }
335 
336     public void lambdas() {
337         assertEval(&quot;class Inner1 implements Runnable {&quot; +
338                 &quot;public Runnable lambda1 = () -&gt; {};&quot; +
339                 &quot;public void function() {}&quot; +
340                 &quot;public void run() {}&quot; +
341                 &quot;}&quot;);
342 
343         assertEval(&quot;class Inner2 {&quot; +
344                 &quot;private Runnable lambda1 = () -&gt; {};&quot; +
345                 &quot;private static void staticFunction() {}&quot; +
346                 &quot;}&quot;);
347 
348         // the following method references and lambda functions
349         // generate synthetic methods
350         assertEval(&quot;Runnable run = () -&gt; {};&quot;);
351         assertEval(&quot;Inner1 inner = new Inner1();&quot;);
352         assertEval(&quot;Runnable l1 = inner::function;&quot;);
353         assertEval(&quot;Runnable l2 = Inner1::new;&quot;);
354         assertEval(&quot;inner.lambda1 = inner::function;&quot;);
355         assertEval(&quot;java.util.stream.IntStream.of(2).mapToObj(int[]::new);&quot;);
356         assertNumberOfActiveMethods(0);
357         assertActiveKeys();
358     }
359 }
    </pre>
  </body>
</html>