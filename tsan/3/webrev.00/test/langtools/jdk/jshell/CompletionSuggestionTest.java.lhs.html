<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/langtools/jdk/jshell/CompletionSuggestionTest.java</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 2015, 2016, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
<a name="1" id="anc1"></a><span class="line-modified"> 26  * @bug 8131025 8141092 8153761 8145263 8131019 8175886 8176184 8176241 8176110 8177466 8197439</span>
 27  * @summary Test Completion and Documentation
 28  * @library /tools/lib
 29  * @modules jdk.compiler/com.sun.tools.javac.api
 30  *          jdk.compiler/com.sun.tools.javac.main
 31  *          jdk.jdeps/com.sun.tools.javap
 32  *          jdk.jshell/jdk.jshell:open
 33  * @build toolbox.ToolBox toolbox.JarTask toolbox.JavacTask
 34  * @build KullaTesting TestingInputStream Compiler
 35  * @run testng CompletionSuggestionTest
 36  */
 37 
 38 import java.io.IOException;
 39 import java.lang.reflect.Field;
 40 import java.nio.file.Files;
 41 import java.nio.file.Path;
 42 import java.nio.file.Paths;
 43 import java.util.Arrays;
 44 import java.util.Collections;
 45 import java.util.Set;
 46 import java.util.HashSet;
 47 import java.util.function.BiFunction;
 48 import java.util.function.Function;
 49 import java.util.jar.JarEntry;
 50 import java.util.jar.JarOutputStream;
 51 
 52 import jdk.jshell.Snippet;
 53 import org.testng.annotations.BeforeMethod;
 54 import org.testng.annotations.Test;
 55 
 56 import static jdk.jshell.Snippet.Status.VALID;
 57 import static jdk.jshell.Snippet.Status.OVERWRITTEN;
 58 
 59 @Test
 60 public class CompletionSuggestionTest extends KullaTesting {
 61 
 62     private final Compiler compiler = new Compiler();
 63     private final Path outDir = Paths.get(&quot;completion_suggestion_test&quot;);
 64 
 65     public void testMemberExpr() {
 66         assertEval(&quot;class Test { static void test() { } }&quot;);
 67         assertCompletion(&quot;Test.t|&quot;, &quot;test()&quot;);
 68         assertEval(&quot;Test ccTestInstance = new Test();&quot;);
 69         assertCompletion(&quot;ccTestInstance.t|&quot;, &quot;toString()&quot;);
 70         assertCompletion(&quot; ccTe|&quot;, &quot;ccTestInstance&quot;);
 71         assertCompletion(&quot;String value = ccTestInstance.to|&quot;, &quot;toString()&quot;);
 72         assertCompletion(&quot;java.util.Coll|&quot;, &quot;Collection&quot;, &quot;Collections&quot;);
 73         assertCompletion(&quot;String.cla|&quot;, &quot;class&quot;);
 74         assertCompletion(&quot;boolean.cla|&quot;, &quot;class&quot;);
 75         assertCompletion(&quot;byte.cla|&quot;, &quot;class&quot;);
 76         assertCompletion(&quot;short.cla|&quot;, &quot;class&quot;);
 77         assertCompletion(&quot;char.cla|&quot;, &quot;class&quot;);
 78         assertCompletion(&quot;int.cla|&quot;, &quot;class&quot;);
 79         assertCompletion(&quot;float.cla|&quot;, &quot;class&quot;);
 80         assertCompletion(&quot;long.cla|&quot;, &quot;class&quot;);
 81         assertCompletion(&quot;double.cla|&quot;, &quot;class&quot;);
 82         assertCompletion(&quot;void.cla|&quot;, &quot;class&quot;);
 83         assertCompletion(&quot;Object[].|&quot;, &quot;class&quot;);
 84         assertCompletion(&quot;int[].|&quot;, &quot;class&quot;);
 85         assertEval(&quot;Object[] ao = null;&quot;);
 86         assertCompletion(&quot;int i = ao.|&quot;, &quot;length&quot;);
 87         assertEval(&quot;int[] ai = null;&quot;);
 88         assertCompletion(&quot;int i = ai.|&quot;, &quot;length&quot;);
 89         assertCompletionIncludesExcludes(&quot;\&quot;\&quot;.|&quot;,
 90                 new HashSet&lt;&gt;(Collections.emptyList()),
 91                 new HashSet&lt;&gt;(Arrays.asList(&quot;String(&quot;)));
 92         assertEval(&quot;double d = 0;&quot;);
 93         assertEval(&quot;void m() {}&quot;);
 94         assertCompletionIncludesExcludes(&quot;d.|&quot;,
 95                 new HashSet&lt;&gt;(Collections.emptyList()),
 96                 new HashSet&lt;&gt;(Arrays.asList(&quot;class&quot;)));
 97         assertCompletionIncludesExcludes(&quot;m().|&quot;,
 98                 new HashSet&lt;&gt;(Collections.emptyList()),
 99                 new HashSet&lt;&gt;(Arrays.asList(&quot;class&quot;)));
100         assertEval(&quot;class C {class D {} static class E {} enum F {} interface H {} void method() {} int number;}&quot;);
101         assertCompletionIncludesExcludes(&quot;C.|&quot;,
102                 new HashSet&lt;&gt;(Arrays.asList(&quot;D&quot;, &quot;E&quot;, &quot;F&quot;, &quot;H&quot;, &quot;class&quot;)),
103                 new HashSet&lt;&gt;(Arrays.asList(&quot;method()&quot;, &quot;number&quot;)));
104         assertCompletionIncludesExcludes(&quot;new C().|&quot;,
105                 new HashSet&lt;&gt;(Arrays.asList(&quot;method()&quot;, &quot;number&quot;)),
106                 new HashSet&lt;&gt;(Arrays.asList(&quot;D&quot;, &quot;E&quot;, &quot;F&quot;, &quot;H&quot;, &quot;class&quot;)));
107         assertCompletionIncludesExcludes(&quot;new C() {}.|&quot;,
108                 new HashSet&lt;&gt;(Arrays.asList(&quot;method()&quot;, &quot;number&quot;)),
109                 new HashSet&lt;&gt;(Arrays.asList(&quot;D&quot;, &quot;E&quot;, &quot;F&quot;, &quot;H&quot;, &quot;class&quot;)));
<a name="2" id="anc2"></a>

110     }
111 
112     public void testStartOfExpression() {
113         assertEval(&quot;int ccTest = 0;&quot;);
114         assertCompletion(&quot;System.err.println(cc|&quot;, &quot;ccTest&quot;);
115         assertCompletion(&quot;for (int i = cc|&quot;, &quot;ccTest&quot;);
116     }
117 
118     public void testParameter() {
119         assertCompletion(&quot;class C{void method(int num){num|&quot;, &quot;num&quot;);
120     }
121 
122     public void testPrimitive() {
123         Set&lt;String&gt; primitives = new HashSet&lt;&gt;(Arrays.asList(&quot;boolean&quot;, &quot;char&quot;, &quot;byte&quot;, &quot;short&quot;, &quot;int&quot;, &quot;long&quot;, &quot;float&quot;, &quot;double&quot;));
124         Set&lt;String&gt; onlyVoid = new HashSet&lt;&gt;(Collections.singletonList(&quot;void&quot;));
125         Set&lt;String&gt; primitivesOrVoid = new HashSet&lt;&gt;(primitives);
126         primitivesOrVoid.addAll(onlyVoid);
127 
128         assertCompletionIncludesExcludes(&quot;|&quot;,
129                 primitivesOrVoid,
130                 new HashSet&lt;&gt;(Collections.emptyList()));
131         assertCompletionIncludesExcludes(&quot;int num = |&quot;,
132                 primitivesOrVoid,
133                 new HashSet&lt;&gt;(Collections.emptyList()));
134         assertCompletionIncludesExcludes(&quot;num = |&quot;,
135                 primitivesOrVoid,
136                 new HashSet&lt;&gt;(Collections.emptyList()));
137         assertCompletionIncludesExcludes(&quot;class C{void m() {|&quot;,
138                 primitivesOrVoid,
139                 new HashSet&lt;&gt;(Collections.emptyList()));
140         assertCompletionIncludesExcludes(&quot;void method(|&quot;,
141                 primitives,
142                 onlyVoid);
143         assertCompletionIncludesExcludes(&quot;void method(int num, |&quot;,
144                 primitives,
145                 onlyVoid);
146         assertCompletion(&quot;new java.util.ArrayList&lt;doub|&quot;);
147         assertCompletion(&quot;class A extends doubl|&quot;);
148         assertCompletion(&quot;class A implements doubl|&quot;);
149         assertCompletion(&quot;interface A extends doubl|&quot;);
150         assertCompletion(&quot;enum A implements doubl|&quot;);
151         assertCompletion(&quot;class A&lt;T extends doubl|&quot;);
152     }
153 
154     public void testEmpty() {
155         assertCompletionIncludesExcludes(&quot;|&quot;,
156                 new HashSet&lt;&gt;(Arrays.asList(&quot;Object&quot;, &quot;Void&quot;)),
157                 new HashSet&lt;&gt;(Arrays.asList(&quot;$REPL00DOESNOTMATTER&quot;)));
158         assertCompletionIncludesExcludes(&quot;V|&quot;,
159                 new HashSet&lt;&gt;(Collections.singletonList(&quot;Void&quot;)),
160                 new HashSet&lt;&gt;(Collections.singletonList(&quot;Object&quot;)));
161         assertCompletionIncludesExcludes(&quot;{ |&quot;,
162                 new HashSet&lt;&gt;(Arrays.asList(&quot;Object&quot;, &quot;Void&quot;)),
163                 new HashSet&lt;&gt;(Arrays.asList(&quot;$REPL00DOESNOTMATTER&quot;)));
164     }
165 
166     public void testSmartCompletion() {
167         assertEval(&quot;int ccTest1 = 0;&quot;);
168         assertEval(&quot;int ccTest2 = 0;&quot;);
169         assertEval(&quot;String ccTest3 = null;&quot;);
170         assertEval(&quot;void method(int i, String str) { }&quot;);
171         assertEval(&quot;void method(String str, int i) { }&quot;);
172         assertEval(&quot;java.util.List&lt;String&gt; list = null;&quot;);
173         assertCompletion(&quot;int ccTest4 = |&quot;, true, &quot;ccTest1&quot;, &quot;ccTest2&quot;);
174         assertCompletion(&quot;ccTest2 = |&quot;, true, &quot;ccTest1&quot;, &quot;ccTest2&quot;);
175         assertCompletion(&quot;int ccTest4 = ccTe|&quot;, &quot;ccTest1&quot;, &quot;ccTest2&quot;, &quot;ccTest3&quot;);
176         assertCompletion(&quot;int ccTest4 = ccTest3.len|&quot;, true, &quot;length()&quot;);
177         assertCompletion(&quot;method(|&quot;, true, &quot;ccTest1&quot;, &quot;ccTest2&quot;, &quot;ccTest3&quot;);
178         assertCompletion(&quot;method(0, |&quot;, true, &quot;ccTest3&quot;);
179         assertCompletion(&quot;list.add(|&quot;, true, &quot;ccTest1&quot;, &quot;ccTest2&quot;, &quot;ccTest3&quot;);
180         assertCompletion(&quot;list.add(0, |&quot;, true, &quot;ccTest3&quot;);
181         assertCompletion(&quot;new String(|&quot;, true, &quot;ccTest3&quot;);
182         assertCompletion(&quot;new String(new char[0], |&quot;, true, &quot;ccTest1&quot;, &quot;ccTest2&quot;);
183         assertCompletionIncludesExcludes(&quot;new jav|&quot;, new HashSet&lt;&gt;(Arrays.asList(&quot;java.&quot;, &quot;javax.&quot;)), Collections.emptySet());
184         assertCompletion(&quot;Class&lt;String&gt; clazz = String.c|&quot;, true, &quot;class&quot;);
185 
186         Snippet klass = classKey(assertEval(&quot;class Klass {void method(int n) {} private void method(String str) {}}&quot;));
187         assertCompletion(&quot;new Klass().method(|&quot;, true, &quot;ccTest1&quot;, &quot;ccTest2&quot;);
188         Snippet klass2 = classKey(assertEval(&quot;class Klass {static void method(int n) {} void method(String str) {}}&quot;,
189                 ste(MAIN_SNIPPET, VALID, VALID, true, null),
190                 ste(klass, VALID, OVERWRITTEN, false, MAIN_SNIPPET)));
191         assertCompletion(&quot;Klass.method(|&quot;, true, &quot;ccTest1&quot;, &quot;ccTest2&quot;);
192         assertEval(&quot;class Klass {Klass(int n) {} private Klass(String str) {}}&quot;,
193                 ste(MAIN_SNIPPET, VALID, VALID, true, null),
194                 ste(klass2, VALID, OVERWRITTEN, false, MAIN_SNIPPET));
195         assertCompletion(&quot;new Klass(|&quot;, true, &quot;ccTest1&quot;, &quot;ccTest2&quot;);
196     }
197 
198     public void testSmartCompletionInOverriddenMethodInvocation() {
199         assertEval(&quot;int ccTest1 = 0;&quot;);
200         assertEval(&quot;int ccTest2 = 0;&quot;);
201         assertEval(&quot;String ccTest3 = null;&quot;);
202         assertCompletion(&quot;\&quot;\&quot;.wait(|&quot;, true, &quot;ccTest1&quot;, &quot;ccTest2&quot;);
203         assertEval(&quot;class Base {void method(int n) {}}&quot;);
204         assertEval(&quot;class Extend extends Base {}&quot;);
205         assertCompletion(&quot;new Extend().method(|&quot;, true, &quot;ccTest1&quot;, &quot;ccTest2&quot;);
206     }
207 
208     public void testSmartCompletionForBoxedType() {
209         assertEval(&quot;int ccTest1 = 0;&quot;);
210         assertEval(&quot;Integer ccTest2 = 0;&quot;);
211         assertEval(&quot;Object ccTest3 = null;&quot;);
212         assertEval(&quot;int method1(int n) {return n;}&quot;);
213         assertEval(&quot;Integer method2(Integer n) {return n;}&quot;);
214         assertEval(&quot;Object method3(Object o) {return o;}&quot;);
215         assertCompletion(&quot;int ccTest4 = |&quot;, true, &quot;ccTest1&quot;, &quot;ccTest2&quot;, &quot;method1(&quot;, &quot;method2(&quot;);
216         assertCompletion(&quot;Integer ccTest4 = |&quot;, true, &quot;ccTest1&quot;, &quot;ccTest2&quot;, &quot;method1(&quot;, &quot;method2(&quot;);
217         assertCompletion(&quot;Object ccTest4 = |&quot;, true, &quot;ccTest1&quot;, &quot;ccTest2&quot;, &quot;ccTest3&quot;, &quot;method1(&quot;, &quot;method2(&quot;, &quot;method3(&quot;);
218         assertCompletion(&quot;method1(|&quot;, true, &quot;ccTest1&quot;, &quot;ccTest2&quot;, &quot;method1(&quot;, &quot;method2(&quot;);
219         assertCompletion(&quot;method2(|&quot;, true, &quot;ccTest1&quot;, &quot;ccTest2&quot;, &quot;method1(&quot;, &quot;method2(&quot;);
220         assertCompletion(&quot;method3(|&quot;, true, &quot;ccTest1&quot;, &quot;ccTest2&quot;, &quot;ccTest3&quot;, &quot;method1(&quot;, &quot;method2(&quot;, &quot;method3(&quot;);
221     }
222 
223     public void testNewClass() {
224         assertCompletion(&quot;String str = new Strin|&quot;, &quot;String(&quot;, &quot;StringBuffer(&quot;, &quot;StringBuilder(&quot;, &quot;StringIndexOutOfBoundsException(&quot;);
225         assertCompletion(&quot;String str = new java.lang.Strin|&quot;, &quot;String(&quot;, &quot;StringBuffer(&quot;, &quot;StringBuilder(&quot;, &quot;StringIndexOutOfBoundsException(&quot;);
226         assertCompletion(&quot;String str = new |&quot;, true, &quot;String(&quot;);
227         assertCompletion(&quot;String str = new java.lang.|&quot;, true, &quot;String(&quot;);
228         assertCompletion(&quot;throw new Strin|&quot;, true, &quot;StringIndexOutOfBoundsException(&quot;);
229 
230         assertEval(&quot;class A{class B{} class C {C(int n) {}} static class D {} interface I {}}&quot;);
231         assertEval(&quot;A a;&quot;);
232         assertCompletion(&quot;new A().new |&quot;, &quot;B()&quot;, &quot;C(&quot;);
233         assertCompletion(&quot;a.new |&quot;, &quot;B()&quot;, &quot;C(&quot;);
234         assertCompletion(&quot;new A.|&quot;, &quot;D()&quot;);
235 
236         assertEval(&quot;enum E{; class A {}}&quot;);
237         assertEval(&quot;interface I{; class A {}}&quot;);
238         assertCompletion(&quot;new E.|&quot;, &quot;A()&quot;);
239         assertCompletion(&quot;new I.|&quot;, &quot;A()&quot;);
240         assertCompletion(&quot;new String(I.A|&quot;, &quot;A&quot;);
241     }
242 
243     public void testFullyQualified() {
244         assertCompletion(&quot;Optional&lt;String&gt; opt = java.u|&quot;, &quot;util.&quot;);
245         assertCompletionIncludesExcludes(&quot;Optional&lt;Strings&gt; opt = java.util.O|&quot;, new HashSet&lt;&gt;(Collections.singletonList(&quot;Optional&quot;)), Collections.emptySet());
246 
247         assertEval(&quot;void method(java.util.Optional&lt;String&gt; opt) {}&quot;);
248         assertCompletion(&quot;method(java.u|&quot;, &quot;util.&quot;);
249 
250         assertCompletion(&quot;Object.notElement.|&quot;);
251         assertCompletion(&quot;Object o = com.su|&quot;, &quot;sun.&quot;);
252 
253         Path p1 = outDir.resolve(&quot;dir1&quot;);
254         compiler.compile(p1,
255                 &quot;package p1.p2;\n&quot; +
256                 &quot;public class Test {\n&quot; +
257                 &quot;}&quot;,
258                 &quot;package p1.p3;\n&quot; +
259                 &quot;public class Test {\n&quot; +
260                 &quot;}&quot;);
261         String jarName = &quot;test.jar&quot;;
262         compiler.jar(p1, jarName, &quot;p1/p2/Test.class&quot;, &quot;p1/p3/Test.class&quot;);
263         addToClasspath(compiler.getPath(p1.resolve(jarName)));
264 
265         assertCompletionIncludesExcludes(&quot;|&quot;, new HashSet&lt;&gt;(Collections.singletonList(&quot;p1.&quot;)), Collections.emptySet());
266         assertCompletion(&quot;p1.|&quot;, &quot;p2.&quot;, &quot;p3.&quot;);
267         assertCompletion(&quot;p1.p2.|&quot;, &quot;Test&quot;);
268         assertCompletion(&quot;p1.p3.|&quot;, &quot;Test&quot;);
269     }
270 
271     public void testCheckAccessibility() {
272         assertCompletion(&quot;java.util.regex.Pattern.co|&quot;, &quot;compile(&quot;);
273     }
274 
275     public void testCompletePackages() {
276         assertCompletion(&quot;java.u|&quot;, &quot;util.&quot;);
277         assertCompletionIncludesExcludes(&quot;jav|&quot;, new HashSet&lt;&gt;(Arrays.asList(&quot;java.&quot;, &quot;javax.&quot;)), Collections.emptySet());
278     }
279 
280     public void testImports() {
281         assertCompletion(&quot;import java.u|&quot;, &quot;util.&quot;);
282         assertCompletionIncludesExcludes(&quot;import jav|&quot;, new HashSet&lt;&gt;(Arrays.asList(&quot;java.&quot;, &quot;javax.&quot;)), Collections.emptySet());
283         assertCompletion(&quot;import static java.u|&quot;, &quot;util.&quot;);
284         assertCompletionIncludesExcludes(&quot;import static jav|&quot;, new HashSet&lt;&gt;(Arrays.asList(&quot;java.&quot;, &quot;javax.&quot;)), Collections.emptySet());
285         assertCompletion(&quot;import static java.lang.Boolean.g|&quot;, &quot;getBoolean&quot;);
286         assertCompletion(&quot;import java.util.*|&quot;);
287         assertCompletionIncludesExcludes(&quot;import java.lang.String.|&quot;,
288                 Collections.emptySet(),
289                 new HashSet&lt;&gt;(Arrays.asList(&quot;CASE_INSENSITIVE_ORDER&quot;, &quot;copyValueOf&quot;, &quot;format&quot;, &quot;join&quot;, &quot;valueOf&quot;, &quot;class&quot;, &quot;length&quot;)));
290         assertCompletionIncludesExcludes(&quot;import static java.lang.String.|&quot;,
291                 new HashSet&lt;&gt;(Arrays.asList(&quot;CASE_INSENSITIVE_ORDER&quot;, &quot;copyValueOf&quot;, &quot;format&quot;, &quot;join&quot;, &quot;valueOf&quot;)),
292                 new HashSet&lt;&gt;(Arrays.asList(&quot;class&quot;, &quot;length&quot;)));
293         assertCompletionIncludesExcludes(&quot;import java.util.Map.|&quot;,
294                 new HashSet&lt;&gt;(Arrays.asList(&quot;Entry&quot;)),
295                 new HashSet&lt;&gt;(Arrays.asList(&quot;class&quot;)));
296     }
297 
298     public void testImportStart() {
299         assertCompletionIncludesExcludes(&quot;import c|&quot;, Set.of(&quot;com.&quot;), Set.of());
300     }
301 
302     public void testBrokenClassFile() throws Exception {
303         Compiler compiler = new Compiler();
304         Path testOutDir = Paths.get(&quot;CompletionTestBrokenClassFile&quot;);
305         String input = &quot;package test.inner; public class Test {}&quot;;
306         compiler.compile(testOutDir, input);
307         addToClasspath(compiler.getPath(testOutDir).resolve(&quot;test&quot;));
308         assertCompletion(&quot;import inner.|&quot;);
309     }
310 
311     public void testDocumentation() throws Exception {
312         dontReadParameterNamesFromClassFile();
313         assertSignature(&quot;System.getProperty(|&quot;,
314                 &quot;String System.getProperty(String key)&quot;,
315                 &quot;String System.getProperty(String key, String def)&quot;);
316         assertEval(&quot;char[] chars = null;&quot;);
317         assertSignature(&quot;new String(chars, |&quot;,
318                 &quot;String(char[], int, int)&quot;);
319         assertSignature(&quot;String.format(|&quot;,
320                 &quot;String String.format(String, Object...)&quot;,
321                 &quot;String String.format(java.util.Locale, String, Object...)&quot;);
322         assertSignature(&quot;\&quot;\&quot;.getBytes(\&quot;\&quot;|&quot;, &quot;void String.getBytes(int, int, byte[], int)&quot;,
323                                                     &quot;byte[] String.getBytes(String) throws java.io.UnsupportedEncodingException&quot;,
324                                                     &quot;byte[] String.getBytes(java.nio.charset.Charset)&quot;);
325         assertSignature(&quot;\&quot;\&quot;.getBytes(\&quot;\&quot; |&quot;, &quot;void String.getBytes(int, int, byte[], int)&quot;,
326                                                      &quot;byte[] String.getBytes(String) throws java.io.UnsupportedEncodingException&quot;,
327                                                      &quot;byte[] String.getBytes(java.nio.charset.Charset)&quot;);
<a name="3" id="anc3"></a>







328     }
329 
330     public void testMethodsWithNoArguments() throws Exception {
331         dontReadParameterNamesFromClassFile();
332         assertSignature(&quot;System.out.println(|&quot;,
333                 &quot;void java.io.PrintStream.println()&quot;,
334                 &quot;void java.io.PrintStream.println(boolean)&quot;,
335                 &quot;void java.io.PrintStream.println(char)&quot;,
336                 &quot;void java.io.PrintStream.println(int)&quot;,
337                 &quot;void java.io.PrintStream.println(long)&quot;,
338                 &quot;void java.io.PrintStream.println(float)&quot;,
339                 &quot;void java.io.PrintStream.println(double)&quot;,
340                 &quot;void java.io.PrintStream.println(char[])&quot;,
341                 &quot;void java.io.PrintStream.println(String)&quot;,
342                 &quot;void java.io.PrintStream.println(Object)&quot;);
343     }
344 
345     public void testErroneous() {
346         assertCompletion(&quot;Undefined.|&quot;);
347         assertSignature(&quot;does.not.exist|&quot;);
348     }
349 
350     public void testClinit() {
351         assertEval(&quot;enum E{;}&quot;);
352         assertEval(&quot;class C{static{}}&quot;);
353         assertCompletionIncludesExcludes(&quot;E.|&quot;, Collections.emptySet(), new HashSet&lt;&gt;(Collections.singletonList(&quot;&lt;clinit&gt;&quot;)));
354         assertCompletionIncludesExcludes(&quot;C.|&quot;, Collections.emptySet(), new HashSet&lt;&gt;(Collections.singletonList(&quot;&lt;clinit&gt;&quot;)));
355     }
356 
357     public void testMethodHeaderContext() {
358         assertCompletion(&quot;private void f(Runn|&quot;, &quot;Runnable&quot;);
359         assertCompletion(&quot;void f(Runn|&quot;, &quot;Runnable&quot;);
360         assertCompletion(&quot;void f(Object o1, Runn|&quot;, &quot;Runnable&quot;);
361         assertCompletion(&quot;void f(Object o1) throws Num|&quot;, true, &quot;NumberFormatException&quot;);
362         assertCompletion(&quot;void f(Object o1) throws java.lang.Num|&quot;, true, &quot;NumberFormatException&quot;);
363         assertEval(&quot;class HogeHoge {static class HogeHogeException extends Exception {}}&quot;);
364         assertCompletion(&quot;void f(Object o1) throws Hoge|&quot;, &quot;HogeHoge&quot;);
365         assertCompletion(&quot;void f(Object o1) throws HogeHoge.|&quot;, true, &quot;HogeHogeException&quot;);
366     }
367 
368     public void testTypeVariables() {
369         assertCompletion(&quot;class A&lt;TYPE&gt; { public void test() { TY|&quot;, &quot;TYPE&quot;);
370         assertCompletion(&quot;class A&lt;TYPE&gt; { public static void test() { TY|&quot;);
371         assertCompletion(&quot;class A&lt;TYPE&gt; { public &lt;TYPE&gt; void test() { TY|&quot;, &quot;TYPE&quot;);
372         assertCompletion(&quot;class A&lt;TYPE&gt; { public static &lt;TYPE&gt; void test() { TY|&quot;, &quot;TYPE&quot;);
373     }
374 
375     public void testGeneric() {
376         assertEval(&quot;import java.util.concurrent.*;&quot;);
377         assertCompletion(&quot;java.util.List&lt;Integ|&quot;, &quot;Integer&quot;);
378         assertCompletion(&quot;class A&lt;TYPE extends Call|&quot;, &quot;Callable&quot;);
379         assertCompletion(&quot;class A&lt;TYPE extends Callable&lt;TY|&quot;, &quot;TYPE&quot;);
380         assertCompletion(&quot;&lt;TYPE&gt; void f(TY|&quot;, &quot;TYPE&quot;);
381         assertCompletion(&quot;class A&lt;TYPE extends Callable&lt;? sup|&quot;, &quot;super&quot;);
382         assertCompletion(&quot;class A&lt;TYPE extends Callable&lt;? super TY|&quot;, &quot;TYPE&quot;);
383     }
384 
385     public void testFields() {
386         assertEval(&quot;interface Interface { int field = 0; }&quot;);
387         Snippet clazz = classKey(assertEval(&quot;class Clazz {&quot; +
388                 &quot;static int staticField = 0;&quot; +
389                 &quot;int field = 0;&quot; +
390                 &quot; }&quot;));
391         assertCompletion(&quot;Interface.fiel|&quot;, &quot;field&quot;);
392         assertCompletion(&quot;Clazz.staticFiel|&quot;, &quot;staticField&quot;);
393         assertCompletion(&quot;new Interface() {}.fiel|&quot;);
394         assertCompletion(&quot;new Clazz().staticFiel|&quot;);
395         assertCompletion(&quot;new Clazz().fiel|&quot;, &quot;field&quot;);
396         assertCompletion(&quot;new Clazz() {}.fiel|&quot;, &quot;field&quot;);
397         assertEval(&quot;class Clazz implements Interface {}&quot;,
398                 ste(MAIN_SNIPPET, VALID, VALID, true, null),
399                 ste(clazz, VALID, OVERWRITTEN, false, MAIN_SNIPPET));
400         assertCompletion(&quot;Clazz.fiel|&quot;, &quot;field&quot;);
401         assertCompletion(&quot;new Clazz().fiel|&quot;);
402         assertCompletion(&quot;new Clazz() {}.fiel|&quot;);
403     }
404 
405     public void testMethods() {
406         assertEval(&quot;interface Interface {&quot; +
407                 &quot;default int defaultMethod() { return 0; }&quot; +
408                 &quot;static int staticMethod() { return 0; }&quot; +
409                 &quot;}&quot;);
410         Snippet clazz = classKey(assertEval(&quot;class Clazz {&quot; +
411                 &quot;static int staticMethod() { return 0; }&quot; +
412                 &quot;int method() { return 0; }&quot; +
413                 &quot;}&quot;));
414         assertCompletion(&quot;Interface.staticMeth|&quot;, &quot;staticMethod()&quot;);
415         assertCompletion(&quot;Clazz.staticMeth|&quot;, &quot;staticMethod()&quot;);
416         assertCompletion(&quot;new Interface() {}.defaultMe||&quot;, &quot;defaultMethod()&quot;);
417         assertCompletion(&quot;new Clazz().staticMeth|&quot;);
418         assertCompletion(&quot;new Clazz().meth|&quot;, &quot;method()&quot;);
419         assertEval(&quot;class Clazz implements Interface {}&quot;,
420                 ste(MAIN_SNIPPET, VALID, VALID, true, null),
421                 ste(clazz, VALID, OVERWRITTEN, false, MAIN_SNIPPET));
422         assertCompletion(&quot;Clazz.staticMeth|&quot;);
423         assertCompletion(&quot;new Clazz() {}.defaultM|&quot;, &quot;defaultMethod()&quot;);
424     }
425 
426     @Test
427     public void testUncompletedDeclaration() {
428         assertCompletion(&quot;class Clazz { Claz|&quot;, &quot;Clazz&quot;);
429         assertCompletion(&quot;class Clazz { class A extends Claz|&quot;, &quot;Clazz&quot;);
430         assertCompletion(&quot;class Clazz { Clazz clazz; Object o = claz|&quot;, &quot;clazz&quot;);
431         assertCompletion(&quot;class Clazz { static Clazz clazz; Object o = claz|&quot;, &quot;clazz&quot;);
432         assertCompletion(&quot;class Clazz { Clazz clazz; static Object o = claz|&quot;, true);
433         assertCompletion(&quot;class Clazz { void method(Claz|&quot;, &quot;Clazz&quot;);
434         assertCompletion(&quot;class A { int method() { return 0; } int a = meth|&quot;, &quot;method()&quot;);
435         assertCompletion(&quot;class A { int field = 0; int method() { return fiel|&quot;, &quot;field&quot;);
436         assertCompletion(&quot;class A { static int method() { return 0; } int a = meth|&quot;, &quot;method()&quot;);
437         assertCompletion(&quot;class A { static int field = 0; int method() { return fiel|&quot;, &quot;field&quot;);
438         assertCompletion(&quot;class A { int method() { return 0; } static int a = meth|&quot;, true);
439         assertCompletion(&quot;class A { int field = 0; static int method() { return fiel|&quot;, true);
440     }
441 
442     @Test
443     public void testClassDeclaration() {
444         assertEval(&quot;void ClazzM() {}&quot;);
445         assertEval(&quot;void InterfaceM() {}&quot;);
446         assertEval(&quot;interface Interface {}&quot;);
447         assertCompletion(&quot;interface A extends Interf|&quot;, &quot;Interface&quot;);
448         assertCompletion(&quot;class A implements Interf|&quot;, &quot;Interface&quot;);
449         assertEval(&quot;class Clazz {}&quot;);
450         assertCompletion(&quot;class A extends Claz|&quot;, &quot;Clazz&quot;);
451         assertCompletion(&quot;class A extends Clazz implements Interf|&quot;, &quot;Interface&quot;);
452         assertEval(&quot;interface Interface1 {}&quot;);
453         assertCompletion(&quot;class A extends Clazz implements Interface, Interf|&quot;, &quot;Interface&quot;, &quot;Interface1&quot;);
454         assertCompletion(&quot;interface A implements Claz|&quot;);
455         assertCompletion(&quot;interface A implements Inter|&quot;);
456         assertCompletion(&quot;class A implements Claz|&quot;, true);
457         assertCompletion(&quot;class A extends Clazz implements Interface, Interf|&quot;, true, &quot;Interface1&quot;);
458         assertCompletion(&quot;class A extends Clazz implements Interface, Interf|&quot;, true, &quot;Interface1&quot;);
459         assertEval(&quot;class InterfaceClazz {}&quot;);
460         assertCompletion(&quot;class A &lt;T extends Claz|&quot;, &quot;Clazz&quot;);
461         assertCompletion(&quot;class A &lt;T extends Interf|&quot;, &quot;Interface&quot;, &quot;Interface1&quot;, &quot;InterfaceClazz&quot;);
462         assertCompletion(&quot;class A &lt;T extends Interface &amp; Interf|&quot;, &quot;Interface&quot;, &quot;Interface1&quot;, &quot;InterfaceClazz&quot;);
463         assertCompletion(&quot;class A &lt;T extends Clazz &amp; Interf|&quot;, &quot;Interface&quot;, &quot;Interface1&quot;, &quot;InterfaceClazz&quot;);
464         assertCompletion(&quot;class A &lt;T extends Claz|&quot;, true, &quot;Clazz&quot;);
465         assertCompletion(&quot;class A &lt;T extends Interf|&quot;, true, &quot;Interface&quot;, &quot;Interface1&quot;, &quot;InterfaceClazz&quot;);
466         assertCompletion(&quot;class A &lt;T extends Interface &amp; Interf|&quot;, true, &quot;Interface1&quot;);
467         assertCompletion(&quot;class A &lt;T extends Clazz &amp; Interf|&quot;, true, &quot;Interface&quot;, &quot;Interface1&quot;);
468     }
469 
470     public void testMethodDeclaration() {
471         assertEval(&quot;void ClazzM() {}&quot;);
472         assertEval(&quot;void InterfaceM() {}&quot;);
473         assertEval(&quot;interface Interface {}&quot;);
474         assertCompletion(&quot;void m(Interf|&quot;, &quot;Interface&quot;);
475         assertCompletion(&quot;void m(Interface i1, Interf|&quot;, &quot;Interface&quot;);
476         assertEval(&quot;class InterfaceException extends Exception {}&quot;);
477         assertCompletion(&quot;void m(Interface i1) throws Interf|&quot;, &quot;Interface&quot;, &quot;InterfaceException&quot;);
478         assertCompletion(&quot;void m(Interface i1) throws Interf|&quot;, true, &quot;InterfaceException&quot;);
479     }
480 
481     public void testDocumentationOfUserDefinedMethods() {
482         assertEval(&quot;void f() {}&quot;);
483         assertSignature(&quot;f(|&quot;, &quot;void f()&quot;);
484         assertEval(&quot;void f(int i) {}&quot;);
485         assertSignature(&quot;f(|&quot;, &quot;void f()&quot;, &quot;void f(int i)&quot;);
486         assertEval(&quot;&lt;T&gt; void f(T... ts) {}&quot;, DiagCheck.DIAG_WARNING, DiagCheck.DIAG_OK);
487         assertSignature(&quot;f(|&quot;, &quot;void f()&quot;, &quot;void f(int i)&quot;, &quot;void &lt;T&gt;f(T... ts)&quot;);
488         assertEval(&quot;class A {}&quot;);
489         assertEval(&quot;void f(A a) {}&quot;);
490         assertSignature(&quot;f(|&quot;, &quot;void f()&quot;, &quot;void f(int i)&quot;, &quot;void &lt;T&gt;f(T... ts)&quot;, &quot;void f(A a)&quot;);
491     }
492 
493     public void testClass() {
494         assertSignature(&quot;String|&quot;, &quot;java.lang.String&quot;);
495     }
496 
497     public void testDocumentationOfUserDefinedConstructors() {
498         Snippet a = classKey(assertEval(&quot;class A {}&quot;));
499         assertSignature(&quot;new A(|&quot;, &quot;A()&quot;);
500         Snippet a2 = classKey(assertEval(&quot;class A { A() {} A(int i) {}}&quot;,
501                 ste(MAIN_SNIPPET, VALID, VALID, true, null),
502                 ste(a, VALID, OVERWRITTEN, false, MAIN_SNIPPET)));
503         assertSignature(&quot;new A(|&quot;, &quot;A()&quot;, &quot;A(int i)&quot;);
504         assertEval(&quot;class A&lt;T&gt; { A(T a) {} A(int i) {} &lt;U&gt; A(T t, U u) {}}&quot;,
505                 ste(MAIN_SNIPPET, VALID, VALID, true, null),
506                 ste(a2, VALID, OVERWRITTEN, false, MAIN_SNIPPET));
507         assertSignature(&quot;new A(|&quot;, &quot;A&lt;T&gt;(T a)&quot;, &quot;A&lt;T&gt;(int i)&quot;, &quot;&lt;U&gt; A&lt;T&gt;(T t, U u)&quot;);
508     }
509 
510     public void testDocumentationOfOverriddenMethods() throws Exception {
511         dontReadParameterNamesFromClassFile();
512         assertSignature(&quot;\&quot;\&quot;.wait(|&quot;,
513             &quot;void Object.wait(long) throws InterruptedException&quot;,
514             &quot;void Object.wait(long, int) throws InterruptedException&quot;,
515             &quot;void Object.wait() throws InterruptedException&quot;);
516         assertEval(&quot;class Base {void method() {}}&quot;);
517         Snippet e = classKey(assertEval(&quot;class Extend extends Base {}&quot;));
518         assertSignature(&quot;new Extend().method(|&quot;, &quot;void Base.method()&quot;);
519         assertEval(&quot;class Extend extends Base {void method() {}}&quot;,
520                 ste(MAIN_SNIPPET, VALID, VALID, true, null),
521                 ste(e, VALID, OVERWRITTEN, false, MAIN_SNIPPET));
522         assertSignature(&quot;new Extend().method(|&quot;, &quot;void Extend.method()&quot;);
523     }
524 
525     public void testDocumentationOfInvisibleMethods() {
526         assertSignature(&quot;Object.wait(|&quot;);
527         assertSignature(&quot;\&quot;\&quot;.indexOfSupplementary(|&quot;);
528         Snippet a = classKey(assertEval(&quot;class A {void method() {}}&quot;));
529         assertSignature(&quot;A.method(|&quot;);
530         assertEval(&quot;class A {private void method() {}}&quot;,
531                 ste(MAIN_SNIPPET, VALID, VALID, true, null),
532                 ste(a, VALID, OVERWRITTEN, false, MAIN_SNIPPET));
533         assertSignature(&quot;new A().method(|&quot;);
534     }
535 
536     public void testDocumentationOfInvisibleConstructors() {
537         assertSignature(&quot;new Compiler(|&quot;);
538         assertEval(&quot;class A { private A() {} }&quot;);
539         assertSignature(&quot;new A(|&quot;);
540     }
541 
542     public void testDocumentationWithBoxing() {
543         assertEval(&quot;int primitive = 0;&quot;);
544         assertEval(&quot;Integer boxed = 0;&quot;);
545         assertEval(&quot;Object object = null;&quot;);
546         assertEval(&quot;void method(int n, Object o) { }&quot;);
547         assertEval(&quot;void method(Object n, int o) { }&quot;);
548         assertSignature(&quot;method(primitive,|&quot;,
549                 &quot;void method(int n, Object o)&quot;,
550                 &quot;void method(Object n, int o)&quot;);
551         assertSignature(&quot;method(boxed,|&quot;,
552                 &quot;void method(int n, Object o)&quot;,
553                 &quot;void method(Object n, int o)&quot;);
554         assertSignature(&quot;method(object,|&quot;,
555                 &quot;void method(Object n, int o)&quot;);
556     }
557 
558     public void testDocumentationWithGenerics() {
559         class TestDocumentationWithGenerics {
560             private final Function&lt;Integer, String&gt; codeFacotry;
561             private final BiFunction&lt;String, Integer, String&gt; evalFormatter;
562             private final BiFunction&lt;String, Integer, String&gt; docFormatter;
563             int count;
564 
565             TestDocumentationWithGenerics(
566                     Function&lt;Integer, String&gt; codeFactory,
567                     BiFunction&lt;String, Integer, String&gt; evalFormatter,
568                     BiFunction&lt;String, Integer, String&gt; documentationFormatter) {
569                 this.codeFacotry = codeFactory;
570                 this.evalFormatter = evalFormatter;
571                 this.docFormatter = documentationFormatter;
572             }
573 
574             void assertDoc(String generics) {
575                 assertDoc(generics, generics);
576             }
577 
578             void assertDoc(String generics, String expectedGenerics) {
579                 assertEval(evalFormatter.apply(generics, count));
580                 assertSignature(codeFacotry.apply(count), docFormatter.apply(expectedGenerics, count));
581                 count++;
582             }
583         }
584 
585         TestDocumentationWithGenerics[] tests = {
586             new TestDocumentationWithGenerics(
587                     i -&gt; &quot;f&quot; + i + &quot;(|&quot;,
588                     (g, i) -&gt; &quot;&lt;&quot; + g + &quot;&gt; void f&quot; + i + &quot;() {}&quot;,
589                     (g, i) -&gt; &quot;void &lt;&quot; + g + &quot;&gt;f&quot; + i + &quot;()&quot;
590             ),
591             new TestDocumentationWithGenerics(
592                     i -&gt; &quot;new C&quot; + i + &quot;().f(|&quot;,
593                     (g, i) -&gt; &quot;class C&quot; + i + &quot;&lt;&quot; + g + &quot;&gt; { void f() {} }&quot;,
594                     (g, i) -&gt; &quot;void C&quot; + i + &quot;&lt;&quot; + g + &quot;&gt;.f()&quot;
595             )
596         };
597 
598         Arrays.stream(tests).forEach(t -&gt; {
599                 t.assertDoc(&quot;T&quot;);
600                 t.assertDoc(&quot;T extends Object&quot;,
601                         &quot;T&quot;);
602                 t.assertDoc(&quot;T extends String&quot;);
603                 t.assertDoc(&quot;T extends java.lang.String&quot;,
604                         &quot;T extends String&quot;);
605                 t.assertDoc(&quot;T extends Number &amp; Comparable&lt;T&gt;&quot;);
606                 t.assertDoc(&quot;T extends java.io.Serializable &amp; CharSequence&quot;);
607                 t.assertDoc(&quot;K, D, M extends java.util.Map&lt;K, D&gt;&quot;,
608                         &quot;K, D, M extends java.util.Map&lt;K,D&gt;&quot;);
609         });
610     }
611 
612     public void testVarArgs() {
613         assertEval(&quot;int i = 0;&quot;);
614         assertEval(&quot;class Foo1 { static void m(int... i) { } } &quot;);
615         assertCompletion(&quot;Foo1.m(|&quot;, true, &quot;i&quot;);
616         assertCompletion(&quot;Foo1.m(i, |&quot;, true, &quot;i&quot;);
617         assertCompletion(&quot;Foo1.m(i, i, |&quot;, true, &quot;i&quot;);
618         assertEval(&quot;class Foo2 { static void m(String s, int... i) { } } &quot;);
619         assertCompletion(&quot;Foo2.m(|&quot;, true);
620         assertCompletion(&quot;Foo2.m(i, |&quot;, true);
621         assertCompletion(&quot;Foo2.m(\&quot;\&quot;, |&quot;, true, &quot;i&quot;);
622         assertCompletion(&quot;Foo2.m(\&quot;\&quot;, i, |&quot;, true, &quot;i&quot;);
623         assertCompletion(&quot;Foo2.m(\&quot;\&quot;, i, i, |&quot;, true, &quot;i&quot;);
624         assertEval(&quot;class Foo3 { Foo3(String s, int... i) { } } &quot;);
625         assertCompletion(&quot;new Foo3(|&quot;, true);
626         assertCompletion(&quot;new Foo3(i, |&quot;, true);
627         assertCompletion(&quot;new Foo3(\&quot;\&quot;, |&quot;, true, &quot;i&quot;);
628         assertCompletion(&quot;new Foo3(\&quot;\&quot;, i, |&quot;, true, &quot;i&quot;);
629         assertCompletion(&quot;new Foo3(\&quot;\&quot;, i, i, |&quot;, true, &quot;i&quot;);
630         assertEval(&quot;int[] ia = null;&quot;);
631         assertCompletion(&quot;Foo1.m(ia, |&quot;, true);
632         assertEval(&quot;class Foo4 { static void m(int... i) { } static void m(int[] ia, String str) { } } &quot;);
633         assertEval(&quot;String str = null;&quot;);
634         assertCompletion(&quot;Foo4.m(ia, |&quot;, true, &quot;str&quot;);
635     }
636 
637     public void testConstructorAsMemberOf() {
638         assertEval(&quot;class Baz&lt;X&gt; { Baz(X x) { } } &quot;);
639         assertEval(&quot;String str = null;&quot;);
640         assertEval(&quot;Integer i = null;&quot;);
641         assertCompletion(&quot;new Baz(|&quot;, true, &quot;i&quot;, &quot;str&quot;);
642         assertCompletion(&quot;new Baz&lt;String&gt;(|&quot;, true, &quot;str&quot;);
643         assertCompletion(&quot;Baz&lt;String&gt; bz = new Baz&lt;&gt;(|&quot;, true, &quot;str&quot;);
644         assertEval(&quot;class Foo { static void m(String str) {} static void m(Baz&lt;String&gt; baz) {} }&quot;);
645         assertCompletion(&quot;Foo.m(new Baz&lt;&gt;(|&quot;, true, &quot;str&quot;);
646     }
647 
648     public void testIntersection() {
649         assertEval(&quot;&lt;Z extends Runnable &amp; CharSequence&gt; Z get() { return null; }&quot;);
650         assertEval(&quot;var v = get();&quot;);
651         assertCompletionIncludesExcludes(&quot;v.|&quot;, true, Set.of(&quot;run()&quot;, &quot;length()&quot;), Set.of());
652         assertCompletion(&quot;Runnable r = |&quot;, true, &quot;get()&quot;, &quot;v&quot;);
653         assertCompletion(&quot;CharSequence r = |&quot;, true, &quot;get()&quot;, &quot;v&quot;);
654         assertCompletion(&quot;Number r = |&quot;, true);
655     }
656 
657     public void testAnonymous() {
658         assertEval(&quot;var v = new Runnable() { public void run() { } public int length() { return 0; } };&quot;);
659         assertCompletionIncludesExcludes(&quot;v.|&quot;, true, Set.of(&quot;run()&quot;, &quot;length()&quot;), Set.of());
660         assertCompletion(&quot;Runnable r = |&quot;, true, &quot;v&quot;);
661         assertCompletion(&quot;CharSequence r = |&quot;, true);
662     }
663 
664     public void testCompletionInAnonymous() {
665         assertCompletionIncludesExcludes(&quot;new Undefined() { int i = \&quot;\&quot;.l|&quot;, Set.of(&quot;length()&quot;), Set.of());
666     }
667 
668     @BeforeMethod
669     public void setUp() {
670         super.setUp();
671 
672         Path srcZip = Paths.get(&quot;src.zip&quot;);
673 
674         try (JarOutputStream out = new JarOutputStream(Files.newOutputStream(srcZip))) {
675             out.putNextEntry(new JarEntry(&quot;java/lang/System.java&quot;));
676             out.write((&quot;package java.lang;\n&quot; +
677                        &quot;public class System {\n&quot; +
678                        &quot;    public String getProperty(String key) { return null; }\n&quot; +
679                        &quot;    public String getProperty(String key, String def) { return def; }\n&quot; +
680                        &quot;}\n&quot;).getBytes());
681         } catch (IOException ex) {
682             throw new IllegalStateException(ex);
683         }
684 
685         try {
686             Field availableSources = getAnalysis().getClass().getDeclaredField(&quot;availableSources&quot;);
687             availableSources.setAccessible(true);
688             availableSources.set(getAnalysis(), Arrays.asList(srcZip));
689         } catch (NoSuchFieldException | IllegalArgumentException | IllegalAccessException ex) {
690             throw new IllegalStateException(ex);
691         }
692     }
693 
694     private void dontReadParameterNamesFromClassFile() throws Exception {
695         Field keepParameterNames = getAnalysis().getClass().getDeclaredField(&quot;keepParameterNames&quot;);
696         keepParameterNames.setAccessible(true);
697         keepParameterNames.set(getAnalysis(), new String[0]);
698     }
699 
700     @Test(enabled = false) //TODO 8171829
701     public void testBrokenClassFile2() throws IOException {
702         Path broken = outDir.resolve(&quot;broken&quot;);
703         compiler.compile(broken,
704                 &quot;package p;\n&quot; +
705                 &quot;public class BrokenA {\n&quot; +
706                 &quot;}&quot;,
707                 &quot;package p.q;\n&quot; +
708                 &quot;public class BrokenB {\n&quot; +
709                 &quot;}&quot;,
710                 &quot;package p;\n&quot; +
711                 &quot;public class BrokenC {\n&quot; +
712                 &quot;}&quot;);
713         Path cp = compiler.getPath(broken);
714         Path target = cp.resolve(&quot;p&quot;).resolve(&quot;BrokenB.class&quot;);
715         Files.deleteIfExists(target);
716         Files.move(cp.resolve(&quot;p&quot;).resolve(&quot;q&quot;).resolve(&quot;BrokenB.class&quot;), target);
717         addToClasspath(cp);
718 
719         assertEval(&quot;import p.*;&quot;);
720         assertCompletion(&quot;Broke|&quot;, &quot;BrokenA&quot;, &quot;BrokenC&quot;);
721     }
722 }
<a name="4" id="anc4"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="4" type="hidden" />
</body>
</html>