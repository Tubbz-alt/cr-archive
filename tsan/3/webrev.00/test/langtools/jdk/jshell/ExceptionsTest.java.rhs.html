<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/langtools/jdk/jshell/ExceptionsTest.java</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2015, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @summary Tests for exceptions
<a name="2" id="anc2"></a><span class="line-modified"> 27  * @bug 8198801 8212167 8210527</span>
<span class="line-modified"> 28  * @modules jdk.compiler/com.sun.tools.javac.api</span>
<span class="line-added"> 29  *          jdk.compiler/com.sun.tools.javac.main</span>
<span class="line-added"> 30  *          jdk.jdeps/com.sun.tools.javap</span>
<span class="line-added"> 31  * @library /tools/lib</span>
<span class="line-added"> 32  * @build toolbox.ToolBox toolbox.JarTask toolbox.JavacTask</span>
<span class="line-added"> 33  * @build KullaTesting TestingInputStream Compiler</span>
 34  * @run testng ExceptionsTest
 35  */
 36 
 37 import java.io.IOException;
 38 import java.io.PrintWriter;
 39 import java.io.StringWriter;
 40 import jdk.jshell.EvalException;
 41 import jdk.jshell.JShellException;
 42 import jdk.jshell.Snippet;
 43 import jdk.jshell.SnippetEvent;
 44 import jdk.jshell.UnresolvedReferenceException;
 45 
<a name="3" id="anc3"></a><span class="line-added"> 46 import java.nio.file.Path;</span>
<span class="line-added"> 47 import java.nio.file.Paths;</span>
<span class="line-added"> 48 </span>
 49 import org.testng.annotations.Test;
 50 
 51 import static org.testng.Assert.*;
 52 
 53 @Test
 54 public class ExceptionsTest extends KullaTesting {
 55 
<a name="4" id="anc4"></a><span class="line-added"> 56     private final Compiler compiler = new Compiler();</span>
<span class="line-added"> 57     private final Path outDir = Paths.get(&quot;test_class_path&quot;);</span>
<span class="line-added"> 58 </span>
 59     public void throwUncheckedException() {
 60         String message = &quot;error_message&quot;;
 61         SnippetEvent cr = assertEvalException(&quot;throw new RuntimeException(\&quot;&quot; + message + &quot;\&quot;);&quot;);
 62         assertExceptionMatch(cr,
 63                 new ExceptionInfo(RuntimeException.class, message,
 64                         newStackTraceElement(&quot;&quot;, &quot;&quot;, cr.snippet(), 1)));
 65     }
 66 
 67     public void throwCheckedException() {
 68         String message = &quot;error_message&quot;;
 69         SnippetEvent cr = assertEvalException(&quot;throw new Exception(\&quot;&quot; + message + &quot;\&quot;);&quot;);
 70         assertExceptionMatch(cr,
 71                 new ExceptionInfo(Exception.class, message,
 72                         newStackTraceElement(&quot;&quot;, &quot;&quot;, cr.snippet(), 1)));
 73     }
 74 
 75     public void throwFromStaticMethodOfClass() {
 76         String message = &quot;error_message&quot;;
 77         Snippet s1 = methodKey(assertEval(&quot;void f() { throw new RuntimeException(\&quot;&quot; + message + &quot;\&quot;); }&quot;));
 78         Snippet s2 = classKey(assertEval(&quot;class A { static void g() { f(); } }&quot;));
 79         SnippetEvent cr3 = assertEvalException(&quot;A.g();&quot;);
 80         assertExceptionMatch(cr3,
 81                 new ExceptionInfo(RuntimeException.class, message,
 82                         newStackTraceElement(&quot;&quot;, &quot;f&quot;, s1, 1),
 83                         newStackTraceElement(&quot;A&quot;, &quot;g&quot;, s2, 1),
 84                         newStackTraceElement(&quot;&quot;, &quot;&quot;, cr3.snippet(), 1)));
 85     }
 86 
 87     public void throwFromStaticMethodOfInterface() {
 88         String message = &quot;error_message&quot;;
 89         Snippet s1 = methodKey(assertEval(&quot;void f() { throw new RuntimeException(\&quot;&quot; + message + &quot;\&quot;); }&quot;));
 90         Snippet s2 = classKey(assertEval(&quot;interface A { static void g() { f(); } }&quot;));
 91         SnippetEvent cr3 = assertEvalException(&quot;A.g();&quot;);
 92         assertExceptionMatch(cr3,
 93                 new ExceptionInfo(RuntimeException.class, message,
 94                         newStackTraceElement(&quot;&quot;, &quot;f&quot;, s1, 1),
 95                         newStackTraceElement(&quot;A&quot;, &quot;g&quot;, s2, 1),
 96                         newStackTraceElement(&quot;&quot;, &quot;&quot;, cr3.snippet(), 1)));
 97     }
 98 
 99     public void throwChained() {
100         String message1 = &quot;error_message1&quot;;
101         String message2 = &quot;error_message2&quot;;
102         Snippet s1 = methodKey(assertEval(&quot;void p() throws Exception { ((String) null).toString(); }&quot;));
103         Snippet s2 = methodKey(assertEval(&quot;void n() throws Exception { try { p(); } catch (Exception ex) { throw new java.io.IOException(\&quot;&quot; + message2 + &quot;\&quot;, ex); }}&quot;));
104         Snippet s3 = methodKey(assertEval(&quot;void m() {\n&quot;
105                 + &quot;try { n(); }\n&quot;
106                 + &quot;catch (Exception ex) {\n&quot;
107                 + &quot;    throw new RuntimeException(\&quot;&quot; + message1 + &quot;\&quot;, ex);\n&quot;
108                 + &quot;}}&quot;));
109         SnippetEvent cr4 = assertEvalException(&quot;m();&quot;);
110         assertExceptionMatch(cr4,
111                 new ExceptionInfo(RuntimeException.class, message1,
112                         new ExceptionInfo(IOException.class, message2,
113                                 new ExceptionInfo(NullPointerException.class, null,
114                                         newStackTraceElement(&quot;&quot;, &quot;p&quot;, s1, 1),
115                                         newStackTraceElement(&quot;&quot;, &quot;n&quot;, s2, 1),
116                                         newStackTraceElement(&quot;&quot;, &quot;m&quot;, s3, 2),
117                                         newStackTraceElement(&quot;&quot;, &quot;&quot;, cr4.snippet(), 1)),
118                                 newStackTraceElement(&quot;&quot;, &quot;n&quot;, s2, 1),
119                                 newStackTraceElement(&quot;&quot;, &quot;m&quot;, s3, 2),
120                                 newStackTraceElement(&quot;&quot;, &quot;&quot;, cr4.snippet(), 1)),
121                         newStackTraceElement(&quot;&quot;, &quot;m&quot;, s3, 4),
122                         newStackTraceElement(&quot;&quot;, &quot;&quot;, cr4.snippet(), 1)));
123     }
124 
125     public void throwChainedUnresolved() {
126         String message1 = &quot;error_message1&quot;;
127         String message2 = &quot;error_message2&quot;;
128         Snippet s1 = methodKey(assertEval(&quot;void p() throws Exception { ((String) null).toString(); }&quot;));
129         Snippet s2 = methodKey(assertEval(&quot;void n() throws Exception { try { p(); } catch (Exception ex) { throw new java.io.IOException(\&quot;&quot; + message2 + &quot;\&quot;, ex); }}&quot;));
130         Snippet s3 = methodKey(assertEval(&quot;void m() {\n&quot;
131                 + &quot;try { n(); }\n&quot;
132                 + &quot;catch (Exception ex) {\n&quot;
133                 + &quot;    throw new RuntimeException(\&quot;&quot; + message1 + &quot;\&quot;, ex);\n&quot;
134                 + &quot;}}&quot;));
135         getState().drop(s1);
136         SnippetEvent cr4 = assertEvalException(&quot;m();&quot;);
137         assertExceptionMatch(cr4,
138                 new ExceptionInfo(RuntimeException.class, message1,
139                         new UnresolvedExceptionInfo(s2,
140                                 newStackTraceElement(&quot;&quot;, &quot;n&quot;, s2, 1),
141                                 newStackTraceElement(&quot;&quot;, &quot;m&quot;, s3, 2),
142                                 newStackTraceElement(&quot;&quot;, &quot;&quot;, cr4.snippet(), 1)),
143                         newStackTraceElement(&quot;&quot;, &quot;m&quot;, s3, 4),
144                         newStackTraceElement(&quot;&quot;, &quot;&quot;, cr4.snippet(), 1)));
145     }
146 
147     public void throwFromConstructor() {
148         String message = &quot;error_message&quot;;
149         Snippet s1 = methodKey(assertEval(&quot;void f() { throw new RuntimeException(\&quot;&quot; + message + &quot;\&quot;); }&quot;));
150         Snippet s2 = classKey(assertEval(&quot;class A { A() { f(); } }&quot;));
151         SnippetEvent cr3 = assertEvalException(&quot;new A();&quot;);
152         assertExceptionMatch(cr3,
153                 new ExceptionInfo(RuntimeException.class, message,
154                         newStackTraceElement(&quot;&quot;, &quot;f&quot;, s1, 1),
155                         newStackTraceElement(&quot;A&quot;, &quot;&lt;init&gt;&quot;, s2, 1),
156                         newStackTraceElement(&quot;&quot;, &quot;&quot;, cr3.snippet(), 1)));
157     }
158 
159     public void throwFromDefaultMethodOfInterface() {
160         String message = &quot;error_message&quot;;
161         Snippet s1 = methodKey(assertEval(&quot;void f() { throw new RuntimeException(\&quot;&quot; + message + &quot;\&quot;); }&quot;));
162         Snippet s2 = classKey(assertEval(&quot;interface A { default void g() { f(); } }&quot;));
163         SnippetEvent cr3 = assertEvalException(&quot;new A() { }.g();&quot;);
164         assertExceptionMatch(cr3,
165                 new ExceptionInfo(RuntimeException.class, message,
166                         newStackTraceElement(&quot;&quot;, &quot;f&quot;, s1, 1),
167                         newStackTraceElement(&quot;A&quot;, &quot;g&quot;, s2, 1),
168                         newStackTraceElement(&quot;&quot;, &quot;&quot;, cr3.snippet(), 1)));
169     }
170 
171     public void throwFromLambda() {
172         String message = &quot;lambda&quot;;
173         Snippet s1 = varKey(assertEval(
174                 &quot;Runnable run = () -&gt; {\n&quot; +
175                 &quot;   throw new RuntimeException(\&quot;&quot; + message + &quot;\&quot;);\n&quot; +
176                 &quot;};&quot;
177         ));
178         SnippetEvent cr2 = assertEvalException(&quot;run.run();&quot;);
179         assertExceptionMatch(cr2,
180                 new ExceptionInfo(RuntimeException.class, message,
181                         newStackTraceElement(&quot;&quot;, &quot;lambda$&quot;, s1, 2),
182                         newStackTraceElement(&quot;&quot;, &quot;&quot;, cr2.snippet(), 1)));
183     }
184 
185     public void throwFromAnonymousClass() {
186         String message = &quot;anonymous&quot;;
187         Snippet s1 = varKey(assertEval(
188                 &quot;Runnable run = new Runnable() {\n&quot; +
189                 &quot;   public void run() {\n&quot;+
190                 &quot;       throw new RuntimeException(\&quot;&quot; + message + &quot;\&quot;);\n&quot; +
191                 &quot;   }\n&quot; +
192                 &quot;};&quot;
193         ));
194         SnippetEvent cr2 = assertEvalException(&quot;run.run();&quot;);
195         assertExceptionMatch(cr2,
196                 new ExceptionInfo(RuntimeException.class, message,
197                         newStackTraceElement(&quot;1&quot;, &quot;run&quot;, s1, 3),
198                         newStackTraceElement(&quot;&quot;, &quot;&quot;, cr2.snippet(), 1)));
199     }
200 
201     public void throwFromLocalClass() {
202         String message = &quot;local&quot;;
203         Snippet s1 = methodKey(assertEval(
204                 &quot;void f() {\n&quot; +
205                 &quot;   class A {\n&quot; +
206                 &quot;       void f() {\n&quot;+
207                 &quot;           throw new RuntimeException(\&quot;&quot; + message + &quot;\&quot;);\n&quot; +
208                 &quot;       }\n&quot; +
209                 &quot;   }\n&quot; +
210                 &quot;   new A().f();\n&quot; +
211                 &quot;}&quot;
212         ));
213         SnippetEvent cr2 = assertEvalException(&quot;f();&quot;);
214         assertExceptionMatch(cr2,
215                 new ExceptionInfo(RuntimeException.class, message,
216                         newStackTraceElement(&quot;1A&quot;, &quot;f&quot;, s1, 4),
217                         newStackTraceElement(&quot;&quot;, &quot;f&quot;, s1, 7),
218                         newStackTraceElement(&quot;&quot;, &quot;&quot;, cr2.snippet(), 1)));
219     }
220 
<a name="5" id="anc5"></a><span class="line-added">221     // test 8210527</span>
<span class="line-added">222     public void throwFromWithoutSource() {</span>
<span class="line-added">223         String message = &quot;show this&quot;;</span>
<span class="line-added">224         SnippetEvent se = assertEvalException(&quot;java.lang.reflect.Proxy.newProxyInstance(&quot; +</span>
<span class="line-added">225                 &quot;Thread.currentThread().getContextClassLoader(), new Class[] {},&quot; +</span>
<span class="line-added">226                 &quot;(p, m, a) -&gt; { throw new IllegalStateException(\&quot;&quot; + message + &quot;\&quot;); }).hashCode()&quot;);</span>
<span class="line-added">227         assertExceptionMatch(se,</span>
<span class="line-added">228                 new ExceptionInfo(IllegalStateException.class, message,</span>
<span class="line-added">229                         newStackTraceElement(&quot;&quot;, &quot;lambda$do_it$$0&quot;, se.snippet(), 1),</span>
<span class="line-added">230                         new StackTraceElement(&quot;com.sun.proxy.$Proxy0&quot;, &quot;hashCode&quot;, null, -1),</span>
<span class="line-added">231                         newStackTraceElement(&quot;&quot;, &quot;&quot;, se.snippet(), 1)));</span>
<span class="line-added">232     }</span>
<span class="line-added">233 </span>
<span class="line-added">234     // test 8210527</span>
<span class="line-added">235     public void throwFromNoSource() {</span>
<span class="line-added">236         Path path = outDir.resolve(&quot;fail&quot;);</span>
<span class="line-added">237         compiler.compile(path,</span>
<span class="line-added">238                 &quot;package fail;\n&quot; +</span>
<span class="line-added">239                         &quot;public class Fail {\n&quot; +</span>
<span class="line-added">240                         &quot;  static { int x = 1 / 0; }\n&quot; +</span>
<span class="line-added">241                         &quot;}\n&quot;);</span>
<span class="line-added">242         addToClasspath(compiler.getPath(path));</span>
<span class="line-added">243         SnippetEvent se = assertEvalException(&quot;Class.forName(\&quot;fail.Fail\&quot;)&quot;);</span>
<span class="line-added">244         assertExceptionMatch(se,</span>
<span class="line-added">245                 new ExceptionInfo(ExceptionInInitializerError.class, null,</span>
<span class="line-added">246                         new StackTraceElement(&quot;java.lang.Class&quot;, &quot;forName0&quot;,  &quot;Class.java&quot;, -2),</span>
<span class="line-added">247                         new StackTraceElement(&quot;java.lang.Class&quot;, &quot;forName&quot;, &quot;Class.java&quot;, -2),</span>
<span class="line-added">248                         newStackTraceElement(&quot;&quot;, &quot;&quot;, se.snippet(), 1)));</span>
<span class="line-added">249     }</span>
<span class="line-added">250 </span>
<span class="line-added">251     // test 8212167</span>
<span class="line-added">252     public void throwLineFormat1() {</span>
<span class="line-added">253         SnippetEvent se = assertEvalException(</span>
<span class="line-added">254                 &quot;if (true) { \n&quot; +</span>
<span class="line-added">255                         &quot;   int x = 10; \n&quot; +</span>
<span class="line-added">256                         &quot;   int y = 10 / 0;}&quot;</span>
<span class="line-added">257         );</span>
<span class="line-added">258         assertExceptionMatch(se,</span>
<span class="line-added">259                 new ExceptionInfo(ArithmeticException.class, &quot;/ by zero&quot;,</span>
<span class="line-added">260                         newStackTraceElement(&quot;&quot;, &quot;&quot;, se.snippet(), 3)));</span>
<span class="line-added">261     }</span>
<span class="line-added">262 </span>
<span class="line-added">263     public void throwLineFormat3() {</span>
<span class="line-added">264         Snippet sp = methodKey(assertEval(</span>
<span class="line-added">265                 &quot;int p() \n&quot; +</span>
<span class="line-added">266                         &quot;  { return 4/0; }&quot;));</span>
<span class="line-added">267         Snippet sm = methodKey(assertEval(</span>
<span class="line-added">268                 &quot;int m(int x)\n&quot; +</span>
<span class="line-added">269                         &quot;       \n&quot; +</span>
<span class="line-added">270                         &quot;       {\n&quot; +</span>
<span class="line-added">271                         &quot;          return p() + x; \n&quot; +</span>
<span class="line-added">272                         &quot;       }&quot;));</span>
<span class="line-added">273         Snippet sn = methodKey(assertEval(</span>
<span class="line-added">274                 &quot;int n(int x) {\n&quot; +</span>
<span class="line-added">275                         &quot;         try {\n&quot; +</span>
<span class="line-added">276                         &quot;           return m(x);\n&quot; +</span>
<span class="line-added">277                         &quot;         }\n&quot; +</span>
<span class="line-added">278                         &quot;         catch (Throwable ex) {\n&quot; +</span>
<span class="line-added">279                         &quot;           throw new IllegalArgumentException( \&quot;GOT:\&quot;, ex);\n&quot; +</span>
<span class="line-added">280                         &quot;         }\n&quot; +</span>
<span class="line-added">281                         &quot;       }&quot;));</span>
<span class="line-added">282         SnippetEvent se = assertEvalException(&quot;n(33);&quot;);</span>
<span class="line-added">283         assertExceptionMatch(se,</span>
<span class="line-added">284                 new ExceptionInfo(IllegalArgumentException.class, null,</span>
<span class="line-added">285                         new ExceptionInfo(ArithmeticException.class, &quot;/ by zero&quot;,</span>
<span class="line-added">286                                 newStackTraceElement(&quot;&quot;, &quot;p&quot;, sp, 2),</span>
<span class="line-added">287                                 newStackTraceElement(&quot;&quot;, &quot;m&quot;, sm, 4),</span>
<span class="line-added">288                                 newStackTraceElement(&quot;&quot;, &quot;n&quot;, sn, 3),</span>
<span class="line-added">289                                 newStackTraceElement(&quot;&quot;, &quot;&quot;, se.snippet(), 1)),</span>
<span class="line-added">290                         newStackTraceElement(&quot;&quot;, &quot;n&quot;, sn, 6),</span>
<span class="line-added">291                         newStackTraceElement(&quot;&quot;, &quot;&quot;, se.snippet(), 1)));</span>
<span class="line-added">292     }</span>
<span class="line-added">293 </span>
294     @Test(enabled = false) // TODO 8129427
295     public void outOfMemory() {
296         assertEval(&quot;import java.util.*;&quot;);
297         assertEval(&quot;List&lt;byte[]&gt; list = new ArrayList&lt;&gt;();&quot;);
298         assertExecuteException(&quot;while (true) { list.add(new byte[10000]); }&quot;, OutOfMemoryError.class);
299     }
300 
301     public void stackOverflow() {
302         assertEval(&quot;void f() { f(); }&quot;);
303         assertExecuteException(&quot;f();&quot;, StackOverflowError.class);
304     }
305 
306     private StackTraceElement newStackTraceElement(String className, String methodName, Snippet key, int lineNumber) {
307         return new StackTraceElement(className, methodName, &quot;#&quot; + key.id(), lineNumber);
308     }
309 
310     private static class AnyExceptionInfo {
311 
312         public final StackTraceElement[] stackTraceElements;
313 
314         public AnyExceptionInfo(StackTraceElement... stackTraceElements) {
315             this.stackTraceElements = stackTraceElements.length == 0 ? null : stackTraceElements;
316         }
317     }
318 
319     private static class UnresolvedExceptionInfo extends AnyExceptionInfo {
320 
321         public final Snippet sn;
322 
323         public UnresolvedExceptionInfo(Snippet sn, StackTraceElement... stackTraceElements) {
324             super(stackTraceElements);
325             this.sn = sn;
326         }
327     }
328 
329     private static class ExceptionInfo extends AnyExceptionInfo {
330 
331         public final Class&lt;? extends Throwable&gt; exception;
332         public final String message;
333         public final AnyExceptionInfo cause;
334 
335         public ExceptionInfo(Class&lt;? extends Throwable&gt; exception, String message,
336                 StackTraceElement... stackTraceElements) {
337             this(exception, message, null, stackTraceElements);
338         }
339 
340         public ExceptionInfo(Class&lt;? extends Throwable&gt; exception, String message,
341                 AnyExceptionInfo cause, StackTraceElement... stackTraceElements) {
342             super(stackTraceElements);
343             this.exception = exception;
344             this.message = message;
345             this.cause = cause;
346         }
347     }
348 
349     private void assertExecuteException(String input, Class&lt;? extends Throwable&gt; exception) {
350         assertExceptionMatch(assertEvalException(input), new ExceptionInfo(exception, null));
351     }
352 
353     private void assertExceptionMatch(SnippetEvent cr, ExceptionInfo exceptionInfo) {
354         assertExceptionMatch(cr.exception(), cr.snippet().source(), exceptionInfo);
355     }
356 
357     private void assertExceptionMatch(Throwable exception, String source, ExceptionInfo exceptionInfo) {
358         assertNotNull(exception, &quot;Expected exception was not thrown: &quot; + exceptionInfo.exception);
359         if (exception instanceof EvalException) {
360             EvalException ex = (EvalException) exception;
361             String actualException = ex.getExceptionClassName();
362             String expectedException = exceptionInfo.exception.getCanonicalName();
363             assertEquals(actualException, expectedException,
364                     String.format(&quot;Given \&quot;%s\&quot; expected exception: %s, got: %s%nStack trace:%n%s&quot;,
365                             source, expectedException, actualException, getStackTrace(ex)));
366             if (exceptionInfo.message != null) {
367                 assertEquals(ex.getMessage(), exceptionInfo.message,
368                         String.format(&quot;Given \&quot;%s\&quot; expected message: %s, got: %s&quot;,
369                                 source, exceptionInfo.message, ex.getMessage()));
370             }
371             assertStackMatch(ex, source, exceptionInfo);
372             if (exceptionInfo.cause != null) {
373                 assertAnyExceptionMatch(exception.getCause(), exceptionInfo.cause);
374             }
375         } else {
376             fail(&quot;Unexpected exception: &quot; + exception + &quot; or exceptionInfo: &quot; + exceptionInfo);
377         }
378     }
379 
380     private void assertStackMatch(JShellException exception, String source, AnyExceptionInfo exceptionInfo) {
381         if (exceptionInfo.stackTraceElements != null) {
382             assertStackTrace(exception.getStackTrace(), exceptionInfo.stackTraceElements,
383                     String.format(&quot;Given \&quot;%s\&quot;%nStack trace:%n%s%n&quot;,
384                             source, getStackTrace(exception)));
385         }
386     }
387 
388     private void assertAnyExceptionMatch(Throwable exception, AnyExceptionInfo exceptionInfo) {
389         if (exceptionInfo instanceof ExceptionInfo) {
390             assertExceptionMatch(exception, &quot;&quot;, (ExceptionInfo) exceptionInfo);
391         } else {
392             assertTrue(exceptionInfo instanceof UnresolvedExceptionInfo, &quot;Bad exceptionInfo: &quot; + exceptionInfo);
393             assertTrue(exception instanceof UnresolvedReferenceException,
394                     &quot;Expected UnresolvedReferenceException: &quot; + exception);
395             UnresolvedExceptionInfo uei = (UnresolvedExceptionInfo) exceptionInfo;
396             UnresolvedReferenceException ure = (UnresolvedReferenceException) exception;
397             assertEquals(ure.getSnippet(), uei.sn);
398             assertStackMatch(ure, &quot;&quot;, exceptionInfo);
399         }
400     }
401 
402     private void assertStackTrace(StackTraceElement[] actual, StackTraceElement[] expected, String message) {
403         if (actual != expected) {
404             if (actual == null || expected == null) {
405                 fail(message);
406             } else {
407                 assertEquals(actual.length, expected.length, message + &quot; : arrays do not have the same size&quot;);
408                 for (int i = 0; i &lt; actual.length; ++i) {
409                     StackTraceElement actualElement = actual[i];
410                     StackTraceElement expectedElement = expected[i];
<a name="6" id="anc6"></a><span class="line-modified">411                     assertEquals(actualElement.getClassName(), expectedElement.getClassName(), message + &quot; : class names [&quot; + i + &quot;]&quot;);</span>
412                     String expectedMethodName = expectedElement.getMethodName();
413                     if (expectedMethodName.startsWith(&quot;lambda$&quot;)) {
414                         assertTrue(actualElement.getMethodName().startsWith(&quot;lambda$&quot;), message + &quot; : method names&quot;);
415                     } else {
<a name="7" id="anc7"></a><span class="line-modified">416                         assertEquals(actualElement.getMethodName(), expectedElement.getMethodName(), message + &quot; : method names [&quot; + i + &quot;]&quot;);</span>
<span class="line-added">417                     }</span>
<span class="line-added">418                     assertEquals(actualElement.getFileName(), expectedElement.getFileName(), message + &quot; : file names [&quot; + i + &quot;]&quot;);</span>
<span class="line-added">419                     if (expectedElement.getLineNumber() &gt;= 0) {</span>
<span class="line-added">420                         assertEquals(actualElement.getLineNumber(), expectedElement.getLineNumber(), message + &quot; : line numbers [&quot; + i + &quot;]&quot;</span>
<span class="line-added">421                                 + &quot; -- actual: &quot; + actualElement.getLineNumber() + &quot;, expected: &quot; + expectedElement.getLineNumber() +</span>
<span class="line-added">422                                 &quot; -- in: &quot; + actualElement.getClassName());</span>
423                     }
<a name="8" id="anc8"></a>

424                 }
425             }
426         }
427     }
428 
429     private String getStackTrace(Throwable ex) {
430         StringWriter st = new StringWriter();
431         ex.printStackTrace(new PrintWriter(st));
432         return st.toString();
433     }
434 }
<a name="9" id="anc9"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="9" type="hidden" />
</body>
</html>