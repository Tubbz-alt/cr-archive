<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff test/langtools/jdk/jshell/ExceptionsTest.java</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="DropTest.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="KullaTesting.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>test/langtools/jdk/jshell/ExceptionsTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2015, 2018, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2015, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 22,12 ***</span>
   */
  
  /*
   * @test
   * @summary Tests for exceptions
<span class="line-modified">!  * @bug 8198801</span>
<span class="line-modified">!  * @build KullaTesting TestingInputStream</span>
   * @run testng ExceptionsTest
   */
  
  import java.io.IOException;
  import java.io.PrintWriter;
<span class="line-new-header">--- 22,17 ---</span>
   */
  
  /*
   * @test
   * @summary Tests for exceptions
<span class="line-modified">!  * @bug 8198801 8212167 8210527</span>
<span class="line-modified">!  * @modules jdk.compiler/com.sun.tools.javac.api</span>
<span class="line-added">+  *          jdk.compiler/com.sun.tools.javac.main</span>
<span class="line-added">+  *          jdk.jdeps/com.sun.tools.javap</span>
<span class="line-added">+  * @library /tools/lib</span>
<span class="line-added">+  * @build toolbox.ToolBox toolbox.JarTask toolbox.JavacTask</span>
<span class="line-added">+  * @build KullaTesting TestingInputStream Compiler</span>
   * @run testng ExceptionsTest
   */
  
  import java.io.IOException;
  import java.io.PrintWriter;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 36,17 ***</span>
<span class="line-new-header">--- 41,23 ---</span>
  import jdk.jshell.JShellException;
  import jdk.jshell.Snippet;
  import jdk.jshell.SnippetEvent;
  import jdk.jshell.UnresolvedReferenceException;
  
<span class="line-added">+ import java.nio.file.Path;</span>
<span class="line-added">+ import java.nio.file.Paths;</span>
<span class="line-added">+ </span>
  import org.testng.annotations.Test;
  
  import static org.testng.Assert.*;
  
  @Test
  public class ExceptionsTest extends KullaTesting {
  
<span class="line-added">+     private final Compiler compiler = new Compiler();</span>
<span class="line-added">+     private final Path outDir = Paths.get(&quot;test_class_path&quot;);</span>
<span class="line-added">+ </span>
      public void throwUncheckedException() {
          String message = &quot;error_message&quot;;
          SnippetEvent cr = assertEvalException(&quot;throw new RuntimeException(\&quot;&quot; + message + &quot;\&quot;);&quot;);
          assertExceptionMatch(cr,
                  new ExceptionInfo(RuntimeException.class, message,
</pre>
<hr />
<pre>
<span class="line-old-header">*** 205,10 ***</span>
<span class="line-new-header">--- 216,83 ---</span>
                          newStackTraceElement(&quot;1A&quot;, &quot;f&quot;, s1, 4),
                          newStackTraceElement(&quot;&quot;, &quot;f&quot;, s1, 7),
                          newStackTraceElement(&quot;&quot;, &quot;&quot;, cr2.snippet(), 1)));
      }
  
<span class="line-added">+     // test 8210527</span>
<span class="line-added">+     public void throwFromWithoutSource() {</span>
<span class="line-added">+         String message = &quot;show this&quot;;</span>
<span class="line-added">+         SnippetEvent se = assertEvalException(&quot;java.lang.reflect.Proxy.newProxyInstance(&quot; +</span>
<span class="line-added">+                 &quot;Thread.currentThread().getContextClassLoader(), new Class[] {},&quot; +</span>
<span class="line-added">+                 &quot;(p, m, a) -&gt; { throw new IllegalStateException(\&quot;&quot; + message + &quot;\&quot;); }).hashCode()&quot;);</span>
<span class="line-added">+         assertExceptionMatch(se,</span>
<span class="line-added">+                 new ExceptionInfo(IllegalStateException.class, message,</span>
<span class="line-added">+                         newStackTraceElement(&quot;&quot;, &quot;lambda$do_it$$0&quot;, se.snippet(), 1),</span>
<span class="line-added">+                         new StackTraceElement(&quot;com.sun.proxy.$Proxy0&quot;, &quot;hashCode&quot;, null, -1),</span>
<span class="line-added">+                         newStackTraceElement(&quot;&quot;, &quot;&quot;, se.snippet(), 1)));</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     // test 8210527</span>
<span class="line-added">+     public void throwFromNoSource() {</span>
<span class="line-added">+         Path path = outDir.resolve(&quot;fail&quot;);</span>
<span class="line-added">+         compiler.compile(path,</span>
<span class="line-added">+                 &quot;package fail;\n&quot; +</span>
<span class="line-added">+                         &quot;public class Fail {\n&quot; +</span>
<span class="line-added">+                         &quot;  static { int x = 1 / 0; }\n&quot; +</span>
<span class="line-added">+                         &quot;}\n&quot;);</span>
<span class="line-added">+         addToClasspath(compiler.getPath(path));</span>
<span class="line-added">+         SnippetEvent se = assertEvalException(&quot;Class.forName(\&quot;fail.Fail\&quot;)&quot;);</span>
<span class="line-added">+         assertExceptionMatch(se,</span>
<span class="line-added">+                 new ExceptionInfo(ExceptionInInitializerError.class, null,</span>
<span class="line-added">+                         new StackTraceElement(&quot;java.lang.Class&quot;, &quot;forName0&quot;,  &quot;Class.java&quot;, -2),</span>
<span class="line-added">+                         new StackTraceElement(&quot;java.lang.Class&quot;, &quot;forName&quot;, &quot;Class.java&quot;, -2),</span>
<span class="line-added">+                         newStackTraceElement(&quot;&quot;, &quot;&quot;, se.snippet(), 1)));</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     // test 8212167</span>
<span class="line-added">+     public void throwLineFormat1() {</span>
<span class="line-added">+         SnippetEvent se = assertEvalException(</span>
<span class="line-added">+                 &quot;if (true) { \n&quot; +</span>
<span class="line-added">+                         &quot;   int x = 10; \n&quot; +</span>
<span class="line-added">+                         &quot;   int y = 10 / 0;}&quot;</span>
<span class="line-added">+         );</span>
<span class="line-added">+         assertExceptionMatch(se,</span>
<span class="line-added">+                 new ExceptionInfo(ArithmeticException.class, &quot;/ by zero&quot;,</span>
<span class="line-added">+                         newStackTraceElement(&quot;&quot;, &quot;&quot;, se.snippet(), 3)));</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     public void throwLineFormat3() {</span>
<span class="line-added">+         Snippet sp = methodKey(assertEval(</span>
<span class="line-added">+                 &quot;int p() \n&quot; +</span>
<span class="line-added">+                         &quot;  { return 4/0; }&quot;));</span>
<span class="line-added">+         Snippet sm = methodKey(assertEval(</span>
<span class="line-added">+                 &quot;int m(int x)\n&quot; +</span>
<span class="line-added">+                         &quot;       \n&quot; +</span>
<span class="line-added">+                         &quot;       {\n&quot; +</span>
<span class="line-added">+                         &quot;          return p() + x; \n&quot; +</span>
<span class="line-added">+                         &quot;       }&quot;));</span>
<span class="line-added">+         Snippet sn = methodKey(assertEval(</span>
<span class="line-added">+                 &quot;int n(int x) {\n&quot; +</span>
<span class="line-added">+                         &quot;         try {\n&quot; +</span>
<span class="line-added">+                         &quot;           return m(x);\n&quot; +</span>
<span class="line-added">+                         &quot;         }\n&quot; +</span>
<span class="line-added">+                         &quot;         catch (Throwable ex) {\n&quot; +</span>
<span class="line-added">+                         &quot;           throw new IllegalArgumentException( \&quot;GOT:\&quot;, ex);\n&quot; +</span>
<span class="line-added">+                         &quot;         }\n&quot; +</span>
<span class="line-added">+                         &quot;       }&quot;));</span>
<span class="line-added">+         SnippetEvent se = assertEvalException(&quot;n(33);&quot;);</span>
<span class="line-added">+         assertExceptionMatch(se,</span>
<span class="line-added">+                 new ExceptionInfo(IllegalArgumentException.class, null,</span>
<span class="line-added">+                         new ExceptionInfo(ArithmeticException.class, &quot;/ by zero&quot;,</span>
<span class="line-added">+                                 newStackTraceElement(&quot;&quot;, &quot;p&quot;, sp, 2),</span>
<span class="line-added">+                                 newStackTraceElement(&quot;&quot;, &quot;m&quot;, sm, 4),</span>
<span class="line-added">+                                 newStackTraceElement(&quot;&quot;, &quot;n&quot;, sn, 3),</span>
<span class="line-added">+                                 newStackTraceElement(&quot;&quot;, &quot;&quot;, se.snippet(), 1)),</span>
<span class="line-added">+                         newStackTraceElement(&quot;&quot;, &quot;n&quot;, sn, 6),</span>
<span class="line-added">+                         newStackTraceElement(&quot;&quot;, &quot;&quot;, se.snippet(), 1)));</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
      @Test(enabled = false) // TODO 8129427
      public void outOfMemory() {
          assertEval(&quot;import java.util.*;&quot;);
          assertEval(&quot;List&lt;byte[]&gt; list = new ArrayList&lt;&gt;();&quot;);
          assertExecuteException(&quot;while (true) { list.add(new byte[10000]); }&quot;, OutOfMemoryError.class);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 322,19 ***</span>
              } else {
                  assertEquals(actual.length, expected.length, message + &quot; : arrays do not have the same size&quot;);
                  for (int i = 0; i &lt; actual.length; ++i) {
                      StackTraceElement actualElement = actual[i];
                      StackTraceElement expectedElement = expected[i];
<span class="line-modified">!                     assertEquals(actualElement.getClassName(), expectedElement.getClassName(), message + &quot; : class names&quot;);</span>
                      String expectedMethodName = expectedElement.getMethodName();
                      if (expectedMethodName.startsWith(&quot;lambda$&quot;)) {
                          assertTrue(actualElement.getMethodName().startsWith(&quot;lambda$&quot;), message + &quot; : method names&quot;);
                      } else {
<span class="line-modified">!                         assertEquals(actualElement.getMethodName(), expectedElement.getMethodName(), message + &quot; : method names&quot;);</span>
                      }
<span class="line-removed">-                     assertEquals(actualElement.getFileName(), expectedElement.getFileName(), message + &quot; : file names&quot;);</span>
<span class="line-removed">-                     assertEquals(actualElement.getLineNumber(), expectedElement.getLineNumber(), message + &quot; : line numbers&quot;);</span>
                  }
              }
          }
      }
  
<span class="line-new-header">--- 406,23 ---</span>
              } else {
                  assertEquals(actual.length, expected.length, message + &quot; : arrays do not have the same size&quot;);
                  for (int i = 0; i &lt; actual.length; ++i) {
                      StackTraceElement actualElement = actual[i];
                      StackTraceElement expectedElement = expected[i];
<span class="line-modified">!                     assertEquals(actualElement.getClassName(), expectedElement.getClassName(), message + &quot; : class names [&quot; + i + &quot;]&quot;);</span>
                      String expectedMethodName = expectedElement.getMethodName();
                      if (expectedMethodName.startsWith(&quot;lambda$&quot;)) {
                          assertTrue(actualElement.getMethodName().startsWith(&quot;lambda$&quot;), message + &quot; : method names&quot;);
                      } else {
<span class="line-modified">!                         assertEquals(actualElement.getMethodName(), expectedElement.getMethodName(), message + &quot; : method names [&quot; + i + &quot;]&quot;);</span>
<span class="line-added">+                     }</span>
<span class="line-added">+                     assertEquals(actualElement.getFileName(), expectedElement.getFileName(), message + &quot; : file names [&quot; + i + &quot;]&quot;);</span>
<span class="line-added">+                     if (expectedElement.getLineNumber() &gt;= 0) {</span>
<span class="line-added">+                         assertEquals(actualElement.getLineNumber(), expectedElement.getLineNumber(), message + &quot; : line numbers [&quot; + i + &quot;]&quot;</span>
<span class="line-added">+                                 + &quot; -- actual: &quot; + actualElement.getLineNumber() + &quot;, expected: &quot; + expectedElement.getLineNumber() +</span>
<span class="line-added">+                                 &quot; -- in: &quot; + actualElement.getClassName());</span>
                      }
                  }
              }
          }
      }
  
</pre>
<center><a href="DropTest.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="KullaTesting.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>