<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/langtools/jdk/jshell/ExceptionsTest.java</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="DropTest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="KullaTesting.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/langtools/jdk/jshell/ExceptionsTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2015, 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @summary Tests for exceptions
<span class="line-modified"> 27  * @bug 8198801</span>
<span class="line-modified"> 28  * @build KullaTesting TestingInputStream</span>





 29  * @run testng ExceptionsTest
 30  */
 31 
 32 import java.io.IOException;
 33 import java.io.PrintWriter;
 34 import java.io.StringWriter;
 35 import jdk.jshell.EvalException;
 36 import jdk.jshell.JShellException;
 37 import jdk.jshell.Snippet;
 38 import jdk.jshell.SnippetEvent;
 39 import jdk.jshell.UnresolvedReferenceException;
 40 



 41 import org.testng.annotations.Test;
 42 
 43 import static org.testng.Assert.*;
 44 
 45 @Test
 46 public class ExceptionsTest extends KullaTesting {
 47 



 48     public void throwUncheckedException() {
 49         String message = &quot;error_message&quot;;
 50         SnippetEvent cr = assertEvalException(&quot;throw new RuntimeException(\&quot;&quot; + message + &quot;\&quot;);&quot;);
 51         assertExceptionMatch(cr,
 52                 new ExceptionInfo(RuntimeException.class, message,
 53                         newStackTraceElement(&quot;&quot;, &quot;&quot;, cr.snippet(), 1)));
 54     }
 55 
 56     public void throwCheckedException() {
 57         String message = &quot;error_message&quot;;
 58         SnippetEvent cr = assertEvalException(&quot;throw new Exception(\&quot;&quot; + message + &quot;\&quot;);&quot;);
 59         assertExceptionMatch(cr,
 60                 new ExceptionInfo(Exception.class, message,
 61                         newStackTraceElement(&quot;&quot;, &quot;&quot;, cr.snippet(), 1)));
 62     }
 63 
 64     public void throwFromStaticMethodOfClass() {
 65         String message = &quot;error_message&quot;;
 66         Snippet s1 = methodKey(assertEval(&quot;void f() { throw new RuntimeException(\&quot;&quot; + message + &quot;\&quot;); }&quot;));
 67         Snippet s2 = classKey(assertEval(&quot;class A { static void g() { f(); } }&quot;));
</pre>
<hr />
<pre>
190     public void throwFromLocalClass() {
191         String message = &quot;local&quot;;
192         Snippet s1 = methodKey(assertEval(
193                 &quot;void f() {\n&quot; +
194                 &quot;   class A {\n&quot; +
195                 &quot;       void f() {\n&quot;+
196                 &quot;           throw new RuntimeException(\&quot;&quot; + message + &quot;\&quot;);\n&quot; +
197                 &quot;       }\n&quot; +
198                 &quot;   }\n&quot; +
199                 &quot;   new A().f();\n&quot; +
200                 &quot;}&quot;
201         ));
202         SnippetEvent cr2 = assertEvalException(&quot;f();&quot;);
203         assertExceptionMatch(cr2,
204                 new ExceptionInfo(RuntimeException.class, message,
205                         newStackTraceElement(&quot;1A&quot;, &quot;f&quot;, s1, 4),
206                         newStackTraceElement(&quot;&quot;, &quot;f&quot;, s1, 7),
207                         newStackTraceElement(&quot;&quot;, &quot;&quot;, cr2.snippet(), 1)));
208     }
209 









































































210     @Test(enabled = false) // TODO 8129427
211     public void outOfMemory() {
212         assertEval(&quot;import java.util.*;&quot;);
213         assertEval(&quot;List&lt;byte[]&gt; list = new ArrayList&lt;&gt;();&quot;);
214         assertExecuteException(&quot;while (true) { list.add(new byte[10000]); }&quot;, OutOfMemoryError.class);
215     }
216 
217     public void stackOverflow() {
218         assertEval(&quot;void f() { f(); }&quot;);
219         assertExecuteException(&quot;f();&quot;, StackOverflowError.class);
220     }
221 
222     private StackTraceElement newStackTraceElement(String className, String methodName, Snippet key, int lineNumber) {
223         return new StackTraceElement(className, methodName, &quot;#&quot; + key.id(), lineNumber);
224     }
225 
226     private static class AnyExceptionInfo {
227 
228         public final StackTraceElement[] stackTraceElements;
229 
</pre>
<hr />
<pre>
307         } else {
308             assertTrue(exceptionInfo instanceof UnresolvedExceptionInfo, &quot;Bad exceptionInfo: &quot; + exceptionInfo);
309             assertTrue(exception instanceof UnresolvedReferenceException,
310                     &quot;Expected UnresolvedReferenceException: &quot; + exception);
311             UnresolvedExceptionInfo uei = (UnresolvedExceptionInfo) exceptionInfo;
312             UnresolvedReferenceException ure = (UnresolvedReferenceException) exception;
313             assertEquals(ure.getSnippet(), uei.sn);
314             assertStackMatch(ure, &quot;&quot;, exceptionInfo);
315         }
316     }
317 
318     private void assertStackTrace(StackTraceElement[] actual, StackTraceElement[] expected, String message) {
319         if (actual != expected) {
320             if (actual == null || expected == null) {
321                 fail(message);
322             } else {
323                 assertEquals(actual.length, expected.length, message + &quot; : arrays do not have the same size&quot;);
324                 for (int i = 0; i &lt; actual.length; ++i) {
325                     StackTraceElement actualElement = actual[i];
326                     StackTraceElement expectedElement = expected[i];
<span class="line-modified">327                     assertEquals(actualElement.getClassName(), expectedElement.getClassName(), message + &quot; : class names&quot;);</span>
328                     String expectedMethodName = expectedElement.getMethodName();
329                     if (expectedMethodName.startsWith(&quot;lambda$&quot;)) {
330                         assertTrue(actualElement.getMethodName().startsWith(&quot;lambda$&quot;), message + &quot; : method names&quot;);
331                     } else {
<span class="line-modified">332                         assertEquals(actualElement.getMethodName(), expectedElement.getMethodName(), message + &quot; : method names&quot;);</span>






333                     }
<span class="line-removed">334                     assertEquals(actualElement.getFileName(), expectedElement.getFileName(), message + &quot; : file names&quot;);</span>
<span class="line-removed">335                     assertEquals(actualElement.getLineNumber(), expectedElement.getLineNumber(), message + &quot; : line numbers&quot;);</span>
336                 }
337             }
338         }
339     }
340 
341     private String getStackTrace(Throwable ex) {
342         StringWriter st = new StringWriter();
343         ex.printStackTrace(new PrintWriter(st));
344         return st.toString();
345     }
346 }
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2015, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @summary Tests for exceptions
<span class="line-modified"> 27  * @bug 8198801 8212167 8210527</span>
<span class="line-modified"> 28  * @modules jdk.compiler/com.sun.tools.javac.api</span>
<span class="line-added"> 29  *          jdk.compiler/com.sun.tools.javac.main</span>
<span class="line-added"> 30  *          jdk.jdeps/com.sun.tools.javap</span>
<span class="line-added"> 31  * @library /tools/lib</span>
<span class="line-added"> 32  * @build toolbox.ToolBox toolbox.JarTask toolbox.JavacTask</span>
<span class="line-added"> 33  * @build KullaTesting TestingInputStream Compiler</span>
 34  * @run testng ExceptionsTest
 35  */
 36 
 37 import java.io.IOException;
 38 import java.io.PrintWriter;
 39 import java.io.StringWriter;
 40 import jdk.jshell.EvalException;
 41 import jdk.jshell.JShellException;
 42 import jdk.jshell.Snippet;
 43 import jdk.jshell.SnippetEvent;
 44 import jdk.jshell.UnresolvedReferenceException;
 45 
<span class="line-added"> 46 import java.nio.file.Path;</span>
<span class="line-added"> 47 import java.nio.file.Paths;</span>
<span class="line-added"> 48 </span>
 49 import org.testng.annotations.Test;
 50 
 51 import static org.testng.Assert.*;
 52 
 53 @Test
 54 public class ExceptionsTest extends KullaTesting {
 55 
<span class="line-added"> 56     private final Compiler compiler = new Compiler();</span>
<span class="line-added"> 57     private final Path outDir = Paths.get(&quot;test_class_path&quot;);</span>
<span class="line-added"> 58 </span>
 59     public void throwUncheckedException() {
 60         String message = &quot;error_message&quot;;
 61         SnippetEvent cr = assertEvalException(&quot;throw new RuntimeException(\&quot;&quot; + message + &quot;\&quot;);&quot;);
 62         assertExceptionMatch(cr,
 63                 new ExceptionInfo(RuntimeException.class, message,
 64                         newStackTraceElement(&quot;&quot;, &quot;&quot;, cr.snippet(), 1)));
 65     }
 66 
 67     public void throwCheckedException() {
 68         String message = &quot;error_message&quot;;
 69         SnippetEvent cr = assertEvalException(&quot;throw new Exception(\&quot;&quot; + message + &quot;\&quot;);&quot;);
 70         assertExceptionMatch(cr,
 71                 new ExceptionInfo(Exception.class, message,
 72                         newStackTraceElement(&quot;&quot;, &quot;&quot;, cr.snippet(), 1)));
 73     }
 74 
 75     public void throwFromStaticMethodOfClass() {
 76         String message = &quot;error_message&quot;;
 77         Snippet s1 = methodKey(assertEval(&quot;void f() { throw new RuntimeException(\&quot;&quot; + message + &quot;\&quot;); }&quot;));
 78         Snippet s2 = classKey(assertEval(&quot;class A { static void g() { f(); } }&quot;));
</pre>
<hr />
<pre>
201     public void throwFromLocalClass() {
202         String message = &quot;local&quot;;
203         Snippet s1 = methodKey(assertEval(
204                 &quot;void f() {\n&quot; +
205                 &quot;   class A {\n&quot; +
206                 &quot;       void f() {\n&quot;+
207                 &quot;           throw new RuntimeException(\&quot;&quot; + message + &quot;\&quot;);\n&quot; +
208                 &quot;       }\n&quot; +
209                 &quot;   }\n&quot; +
210                 &quot;   new A().f();\n&quot; +
211                 &quot;}&quot;
212         ));
213         SnippetEvent cr2 = assertEvalException(&quot;f();&quot;);
214         assertExceptionMatch(cr2,
215                 new ExceptionInfo(RuntimeException.class, message,
216                         newStackTraceElement(&quot;1A&quot;, &quot;f&quot;, s1, 4),
217                         newStackTraceElement(&quot;&quot;, &quot;f&quot;, s1, 7),
218                         newStackTraceElement(&quot;&quot;, &quot;&quot;, cr2.snippet(), 1)));
219     }
220 
<span class="line-added">221     // test 8210527</span>
<span class="line-added">222     public void throwFromWithoutSource() {</span>
<span class="line-added">223         String message = &quot;show this&quot;;</span>
<span class="line-added">224         SnippetEvent se = assertEvalException(&quot;java.lang.reflect.Proxy.newProxyInstance(&quot; +</span>
<span class="line-added">225                 &quot;Thread.currentThread().getContextClassLoader(), new Class[] {},&quot; +</span>
<span class="line-added">226                 &quot;(p, m, a) -&gt; { throw new IllegalStateException(\&quot;&quot; + message + &quot;\&quot;); }).hashCode()&quot;);</span>
<span class="line-added">227         assertExceptionMatch(se,</span>
<span class="line-added">228                 new ExceptionInfo(IllegalStateException.class, message,</span>
<span class="line-added">229                         newStackTraceElement(&quot;&quot;, &quot;lambda$do_it$$0&quot;, se.snippet(), 1),</span>
<span class="line-added">230                         new StackTraceElement(&quot;com.sun.proxy.$Proxy0&quot;, &quot;hashCode&quot;, null, -1),</span>
<span class="line-added">231                         newStackTraceElement(&quot;&quot;, &quot;&quot;, se.snippet(), 1)));</span>
<span class="line-added">232     }</span>
<span class="line-added">233 </span>
<span class="line-added">234     // test 8210527</span>
<span class="line-added">235     public void throwFromNoSource() {</span>
<span class="line-added">236         Path path = outDir.resolve(&quot;fail&quot;);</span>
<span class="line-added">237         compiler.compile(path,</span>
<span class="line-added">238                 &quot;package fail;\n&quot; +</span>
<span class="line-added">239                         &quot;public class Fail {\n&quot; +</span>
<span class="line-added">240                         &quot;  static { int x = 1 / 0; }\n&quot; +</span>
<span class="line-added">241                         &quot;}\n&quot;);</span>
<span class="line-added">242         addToClasspath(compiler.getPath(path));</span>
<span class="line-added">243         SnippetEvent se = assertEvalException(&quot;Class.forName(\&quot;fail.Fail\&quot;)&quot;);</span>
<span class="line-added">244         assertExceptionMatch(se,</span>
<span class="line-added">245                 new ExceptionInfo(ExceptionInInitializerError.class, null,</span>
<span class="line-added">246                         new StackTraceElement(&quot;java.lang.Class&quot;, &quot;forName0&quot;,  &quot;Class.java&quot;, -2),</span>
<span class="line-added">247                         new StackTraceElement(&quot;java.lang.Class&quot;, &quot;forName&quot;, &quot;Class.java&quot;, -2),</span>
<span class="line-added">248                         newStackTraceElement(&quot;&quot;, &quot;&quot;, se.snippet(), 1)));</span>
<span class="line-added">249     }</span>
<span class="line-added">250 </span>
<span class="line-added">251     // test 8212167</span>
<span class="line-added">252     public void throwLineFormat1() {</span>
<span class="line-added">253         SnippetEvent se = assertEvalException(</span>
<span class="line-added">254                 &quot;if (true) { \n&quot; +</span>
<span class="line-added">255                         &quot;   int x = 10; \n&quot; +</span>
<span class="line-added">256                         &quot;   int y = 10 / 0;}&quot;</span>
<span class="line-added">257         );</span>
<span class="line-added">258         assertExceptionMatch(se,</span>
<span class="line-added">259                 new ExceptionInfo(ArithmeticException.class, &quot;/ by zero&quot;,</span>
<span class="line-added">260                         newStackTraceElement(&quot;&quot;, &quot;&quot;, se.snippet(), 3)));</span>
<span class="line-added">261     }</span>
<span class="line-added">262 </span>
<span class="line-added">263     public void throwLineFormat3() {</span>
<span class="line-added">264         Snippet sp = methodKey(assertEval(</span>
<span class="line-added">265                 &quot;int p() \n&quot; +</span>
<span class="line-added">266                         &quot;  { return 4/0; }&quot;));</span>
<span class="line-added">267         Snippet sm = methodKey(assertEval(</span>
<span class="line-added">268                 &quot;int m(int x)\n&quot; +</span>
<span class="line-added">269                         &quot;       \n&quot; +</span>
<span class="line-added">270                         &quot;       {\n&quot; +</span>
<span class="line-added">271                         &quot;          return p() + x; \n&quot; +</span>
<span class="line-added">272                         &quot;       }&quot;));</span>
<span class="line-added">273         Snippet sn = methodKey(assertEval(</span>
<span class="line-added">274                 &quot;int n(int x) {\n&quot; +</span>
<span class="line-added">275                         &quot;         try {\n&quot; +</span>
<span class="line-added">276                         &quot;           return m(x);\n&quot; +</span>
<span class="line-added">277                         &quot;         }\n&quot; +</span>
<span class="line-added">278                         &quot;         catch (Throwable ex) {\n&quot; +</span>
<span class="line-added">279                         &quot;           throw new IllegalArgumentException( \&quot;GOT:\&quot;, ex);\n&quot; +</span>
<span class="line-added">280                         &quot;         }\n&quot; +</span>
<span class="line-added">281                         &quot;       }&quot;));</span>
<span class="line-added">282         SnippetEvent se = assertEvalException(&quot;n(33);&quot;);</span>
<span class="line-added">283         assertExceptionMatch(se,</span>
<span class="line-added">284                 new ExceptionInfo(IllegalArgumentException.class, null,</span>
<span class="line-added">285                         new ExceptionInfo(ArithmeticException.class, &quot;/ by zero&quot;,</span>
<span class="line-added">286                                 newStackTraceElement(&quot;&quot;, &quot;p&quot;, sp, 2),</span>
<span class="line-added">287                                 newStackTraceElement(&quot;&quot;, &quot;m&quot;, sm, 4),</span>
<span class="line-added">288                                 newStackTraceElement(&quot;&quot;, &quot;n&quot;, sn, 3),</span>
<span class="line-added">289                                 newStackTraceElement(&quot;&quot;, &quot;&quot;, se.snippet(), 1)),</span>
<span class="line-added">290                         newStackTraceElement(&quot;&quot;, &quot;n&quot;, sn, 6),</span>
<span class="line-added">291                         newStackTraceElement(&quot;&quot;, &quot;&quot;, se.snippet(), 1)));</span>
<span class="line-added">292     }</span>
<span class="line-added">293 </span>
294     @Test(enabled = false) // TODO 8129427
295     public void outOfMemory() {
296         assertEval(&quot;import java.util.*;&quot;);
297         assertEval(&quot;List&lt;byte[]&gt; list = new ArrayList&lt;&gt;();&quot;);
298         assertExecuteException(&quot;while (true) { list.add(new byte[10000]); }&quot;, OutOfMemoryError.class);
299     }
300 
301     public void stackOverflow() {
302         assertEval(&quot;void f() { f(); }&quot;);
303         assertExecuteException(&quot;f();&quot;, StackOverflowError.class);
304     }
305 
306     private StackTraceElement newStackTraceElement(String className, String methodName, Snippet key, int lineNumber) {
307         return new StackTraceElement(className, methodName, &quot;#&quot; + key.id(), lineNumber);
308     }
309 
310     private static class AnyExceptionInfo {
311 
312         public final StackTraceElement[] stackTraceElements;
313 
</pre>
<hr />
<pre>
391         } else {
392             assertTrue(exceptionInfo instanceof UnresolvedExceptionInfo, &quot;Bad exceptionInfo: &quot; + exceptionInfo);
393             assertTrue(exception instanceof UnresolvedReferenceException,
394                     &quot;Expected UnresolvedReferenceException: &quot; + exception);
395             UnresolvedExceptionInfo uei = (UnresolvedExceptionInfo) exceptionInfo;
396             UnresolvedReferenceException ure = (UnresolvedReferenceException) exception;
397             assertEquals(ure.getSnippet(), uei.sn);
398             assertStackMatch(ure, &quot;&quot;, exceptionInfo);
399         }
400     }
401 
402     private void assertStackTrace(StackTraceElement[] actual, StackTraceElement[] expected, String message) {
403         if (actual != expected) {
404             if (actual == null || expected == null) {
405                 fail(message);
406             } else {
407                 assertEquals(actual.length, expected.length, message + &quot; : arrays do not have the same size&quot;);
408                 for (int i = 0; i &lt; actual.length; ++i) {
409                     StackTraceElement actualElement = actual[i];
410                     StackTraceElement expectedElement = expected[i];
<span class="line-modified">411                     assertEquals(actualElement.getClassName(), expectedElement.getClassName(), message + &quot; : class names [&quot; + i + &quot;]&quot;);</span>
412                     String expectedMethodName = expectedElement.getMethodName();
413                     if (expectedMethodName.startsWith(&quot;lambda$&quot;)) {
414                         assertTrue(actualElement.getMethodName().startsWith(&quot;lambda$&quot;), message + &quot; : method names&quot;);
415                     } else {
<span class="line-modified">416                         assertEquals(actualElement.getMethodName(), expectedElement.getMethodName(), message + &quot; : method names [&quot; + i + &quot;]&quot;);</span>
<span class="line-added">417                     }</span>
<span class="line-added">418                     assertEquals(actualElement.getFileName(), expectedElement.getFileName(), message + &quot; : file names [&quot; + i + &quot;]&quot;);</span>
<span class="line-added">419                     if (expectedElement.getLineNumber() &gt;= 0) {</span>
<span class="line-added">420                         assertEquals(actualElement.getLineNumber(), expectedElement.getLineNumber(), message + &quot; : line numbers [&quot; + i + &quot;]&quot;</span>
<span class="line-added">421                                 + &quot; -- actual: &quot; + actualElement.getLineNumber() + &quot;, expected: &quot; + expectedElement.getLineNumber() +</span>
<span class="line-added">422                                 &quot; -- in: &quot; + actualElement.getClassName());</span>
423                     }


424                 }
425             }
426         }
427     }
428 
429     private String getStackTrace(Throwable ex) {
430         StringWriter st = new StringWriter();
431         ex.printStackTrace(new PrintWriter(st));
432         return st.toString();
433     }
434 }
</pre>
</td>
</tr>
</table>
<center><a href="DropTest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="KullaTesting.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>