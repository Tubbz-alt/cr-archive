<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/langtools/jdk/jshell/WrapperTest.java</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="ToolTabSnippetTest.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="../../lib/annotations/annotations/classfile/ClassfileInspector.java.udiff.html" target="_top">next &gt;</a></center>    <h2>test/langtools/jdk/jshell/WrapperTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2016, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2016, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -21,11 +21,11 @@</span>
   * questions.
   */
  
  /*
   * @test
<span class="udiff-line-modified-removed">-  * @bug 8159111</span>
<span class="udiff-line-modified-added">+  * @bug 8159111 8159740</span>
   * @summary test wrappers and dependencies
   * @modules jdk.jshell/jdk.jshell
   * @build KullaTesting
   * @run testng WrapperTest
   */
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -60,19 +60,130 @@</span>
          assertPosition(swg, src, 0, 4);
          assertPosition(swg, src, 5, 4);
          assertPosition(swg, src, 15, 6);
      }
  
<span class="udiff-line-modified-removed">-     @Test(enabled = false) // TODO 8159740</span>
<span class="udiff-line-modified-added">+     // test 8159740</span>
      public void testMethodCorralled() {
          String src = &quot;void glib() { f(); }&quot;;
<span class="udiff-line-added">+         //            _123456789_123456789</span>
          Snippet g = methodKey(assertEval(src, added(RECOVERABLE_DEFINED)));
          SnippetWrapper swg = getState().sourceCodeAnalysis().wrapper(g);
<span class="udiff-line-modified-removed">-         assertWrapperHas(swg, src, Kind.METHOD, &quot;void&quot;, &quot;glib&quot;);</span>
<span class="udiff-line-modified-added">+         assertWrapperHas(swg, src, Kind.METHOD, &quot;SPIResolutionException&quot;,</span>
<span class="udiff-line-added">+                 &quot;void&quot;, &quot;glib&quot;);</span>
<span class="udiff-line-added">+         assertPosition(swg, src, 0, 4);</span>
          assertPosition(swg, src, 5, 4);
      }
  
<span class="udiff-line-added">+     // test 8159740</span>
<span class="udiff-line-added">+     public void testClassCorralled0() {</span>
<span class="udiff-line-added">+         String src = &quot;class AAA { float mmm(double d1234) { return (float) (f0 * d1234); } }&quot;;</span>
<span class="udiff-line-added">+         //            _123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789</span>
<span class="udiff-line-added">+         Snippet a = classKey(assertEval(src, added(RECOVERABLE_DEFINED)));</span>
<span class="udiff-line-added">+         SnippetWrapper swa = getState().sourceCodeAnalysis().wrapper(a);</span>
<span class="udiff-line-added">+         assertWrapperHas(swa, src, Kind.TYPE_DECL, &quot;SPIResolutionException&quot;,</span>
<span class="udiff-line-added">+                 &quot;class&quot;, &quot;AAA&quot;, &quot;float&quot;, &quot;mmm&quot;, &quot;double&quot;, &quot;d1234&quot;);</span>
<span class="udiff-line-added">+         assertPosition(swa, src, 0, 5);</span>
<span class="udiff-line-added">+         assertPosition(swa, src, 6, 3);</span>
<span class="udiff-line-added">+         assertPosition(swa, src, 12, 5);</span>
<span class="udiff-line-added">+         assertPosition(swa, src, 18, 3);</span>
<span class="udiff-line-added">+         assertPosition(swa, src, 22, 6);</span>
<span class="udiff-line-added">+         assertPosition(swa, src, 29, 5);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     // test 8159740</span>
<span class="udiff-line-added">+     public void testClassCorralled() {</span>
<span class="udiff-line-added">+         String src = &quot;class AAA { int xxx = x0 + 4; float mmm(float ffff) { return f0 * ffff; } }&quot;;</span>
<span class="udiff-line-added">+         //            _123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789</span>
<span class="udiff-line-added">+         Snippet a = classKey(assertEval(src, added(RECOVERABLE_DEFINED)));</span>
<span class="udiff-line-added">+         SnippetWrapper swa = getState().sourceCodeAnalysis().wrapper(a);</span>
<span class="udiff-line-added">+         assertWrapperHas(swa, src, Kind.TYPE_DECL, &quot;SPIResolutionException&quot;,</span>
<span class="udiff-line-added">+                 &quot;class&quot;, &quot;AAA&quot;, &quot;int&quot;, &quot;xxx&quot;, &quot;float&quot;, &quot;mmm&quot;, &quot;ffff&quot;);</span>
<span class="udiff-line-added">+         assertPosition(swa, src, 0, 5);</span>
<span class="udiff-line-added">+         assertPosition(swa, src, 6, 3);</span>
<span class="udiff-line-added">+         assertPosition(swa, src, 12, 3);</span>
<span class="udiff-line-added">+         assertPosition(swa, src, 16, 3);</span>
<span class="udiff-line-added">+         assertPosition(swa, src, 30, 5);</span>
<span class="udiff-line-added">+         assertPosition(swa, src, 36, 3);</span>
<span class="udiff-line-added">+         assertPosition(swa, src, 40, 5);</span>
<span class="udiff-line-added">+         assertPosition(swa, src, 46, 4);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     // test 8159740</span>
<span class="udiff-line-added">+     public void testClassWithConstructorCorralled() {</span>
<span class="udiff-line-added">+         String src = &quot;public class AAA { AAA(String b) {} int xxx = x0 + 4; float mmm(float ffff) { return f0 * ffff; } }&quot;;</span>
<span class="udiff-line-added">+         //            _123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789</span>
<span class="udiff-line-added">+         Snippet a = classKey(assertEval(src, added(RECOVERABLE_DEFINED)));</span>
<span class="udiff-line-added">+         SnippetWrapper swa = getState().sourceCodeAnalysis().wrapper(a);</span>
<span class="udiff-line-added">+         assertWrapperHas(swa, src, Kind.TYPE_DECL, &quot;SPIResolutionException&quot;,</span>
<span class="udiff-line-added">+                 &quot;class&quot;, &quot;AAA&quot;, &quot;String&quot;, &quot;int&quot;, &quot;xxx&quot;, &quot;float&quot;, &quot;mmm&quot;, &quot;ffff&quot;);</span>
<span class="udiff-line-added">+         assertPosition(swa, src, 7, 5);</span>
<span class="udiff-line-added">+         assertPosition(swa, src, 13, 3);</span>
<span class="udiff-line-added">+         assertPosition(swa, src, 19, 3);</span>
<span class="udiff-line-added">+         assertPosition(swa, src, 23, 5);</span>
<span class="udiff-line-added">+         assertPosition(swa, src, 30, 1);</span>
<span class="udiff-line-added">+         assertPosition(swa, src, 36, 3);</span>
<span class="udiff-line-added">+         assertPosition(swa, src, 40, 3);</span>
<span class="udiff-line-added">+         assertPosition(swa, src, 54, 5);</span>
<span class="udiff-line-added">+         assertPosition(swa, src, 60, 3);</span>
<span class="udiff-line-added">+         assertPosition(swa, src, 64, 5);</span>
<span class="udiff-line-added">+         assertPosition(swa, src, 70, 4);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     // test 8159740</span>
<span class="udiff-line-added">+     public void testInterfaceCorralled() {</span>
<span class="udiff-line-added">+         String src = &quot;interface AAA { default float mmm(double d1234) { return (float) (f0 * d1234); } }&quot;;</span>
<span class="udiff-line-added">+         //            _123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789</span>
<span class="udiff-line-added">+         Snippet a = classKey(assertEval(src, added(RECOVERABLE_DEFINED)));</span>
<span class="udiff-line-added">+         SnippetWrapper swa = getState().sourceCodeAnalysis().wrapper(a);</span>
<span class="udiff-line-added">+         assertWrapperHas(swa, src, Kind.TYPE_DECL, &quot;SPIResolutionException&quot;,</span>
<span class="udiff-line-added">+                 &quot;interface&quot;, &quot;AAA&quot;, &quot;float&quot;, &quot;mmm&quot;, &quot;double&quot;, &quot;d1234&quot;);</span>
<span class="udiff-line-added">+         assertPosition(swa, src, 0, 9);</span>
<span class="udiff-line-added">+         assertPosition(swa, src, 10, 3);</span>
<span class="udiff-line-added">+         assertPosition(swa, src, 16, 7);</span>
<span class="udiff-line-added">+         assertPosition(swa, src, 24, 5);</span>
<span class="udiff-line-added">+         assertPosition(swa, src, 30, 3);</span>
<span class="udiff-line-added">+         assertPosition(swa, src, 34, 6);</span>
<span class="udiff-line-added">+         assertPosition(swa, src, 41, 5);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     // test 8159740</span>
<span class="udiff-line-added">+     public void testEnumCorralled() {</span>
<span class="udiff-line-added">+         String src =</span>
<span class="udiff-line-added">+                 &quot;public enum Planet {\n&quot; +</span>
<span class="udiff-line-added">+                 &quot;    MERCURY (3.303e+23, 2.4397e6),\n&quot; +</span>
<span class="udiff-line-added">+                 &quot;    VENUS   (4.869e+24, 6.0518e6),\n&quot; +</span>
<span class="udiff-line-added">+                 &quot;    EARTH   (5.976e+24, 6.37814e6),\n&quot; +</span>
<span class="udiff-line-added">+                 &quot;    MARS    (6.421e+23, 3.3972e6),\n&quot; +</span>
<span class="udiff-line-added">+                 &quot;    JUPITER (1.9e+27,   7.1492e7),\n&quot; +</span>
<span class="udiff-line-added">+                 &quot;    SATURN  (5.688e+26, 6.0268e7),\n&quot; +</span>
<span class="udiff-line-added">+                 &quot;    URANUS  (8.686e+25, 2.5559e7),\n&quot; +</span>
<span class="udiff-line-added">+                 &quot;    NEPTUNE (1.024e+26, 2.4746e7);\n&quot; +</span>
<span class="udiff-line-added">+                 &quot;\n&quot; +</span>
<span class="udiff-line-added">+                 &quot;    private final double mass;   // in kilograms\n&quot; +</span>
<span class="udiff-line-added">+                 &quot;    private final double radius; // in meters\n&quot; +</span>
<span class="udiff-line-added">+                 &quot;    Planet(double mass, double radius) {\n&quot; +</span>
<span class="udiff-line-added">+                 &quot;        this.mass = mass;\n&quot; +</span>
<span class="udiff-line-added">+                 &quot;        this.radius = radius;\n&quot; +</span>
<span class="udiff-line-added">+                 &quot;    }\n&quot; +</span>
<span class="udiff-line-added">+                 &quot;    private double mass() { return mass; }\n&quot; +</span>
<span class="udiff-line-added">+                 &quot;    private double radius() { return radius; }\n&quot; +</span>
<span class="udiff-line-added">+                 &quot;\n&quot; +</span>
<span class="udiff-line-added">+                 &quot;    double surfaceGravity() {\n&quot; +</span>
<span class="udiff-line-added">+                 &quot;        return GRAVITATIONAL_CONSTANT * mass / (radius * radius);\n&quot; +</span>
<span class="udiff-line-added">+                 &quot;    }\n&quot; +</span>
<span class="udiff-line-added">+                 &quot;    double surfaceWeight(double otherMass) {\n&quot; +</span>
<span class="udiff-line-added">+                 &quot;        return otherMass * surfaceGravity();\n&quot; +</span>
<span class="udiff-line-added">+                 &quot;    }\n&quot; +</span>
<span class="udiff-line-added">+                 &quot;}\n&quot;;</span>
<span class="udiff-line-added">+         Snippet a = classKey(assertEval(src, added(RECOVERABLE_DEFINED)));</span>
<span class="udiff-line-added">+         SnippetWrapper swa = getState().sourceCodeAnalysis().wrapper(a);</span>
<span class="udiff-line-added">+         assertWrapperHas(swa, src, Kind.TYPE_DECL, &quot;SPIResolutionException&quot;,</span>
<span class="udiff-line-added">+                 &quot;enum&quot;, &quot;Planet&quot;, &quot;double&quot;, &quot;mass&quot;, &quot;EARTH&quot;, &quot;NEPTUNE&quot;, &quot;MERCURY&quot;,</span>
<span class="udiff-line-added">+                 &quot;radius&quot;, &quot;surfaceGravity&quot;, &quot;surfaceWeight&quot;);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      public void testMethodBad() {
          String src = &quot;void flob() { ?????; }&quot;;
          List&lt;SnippetWrapper&gt; swl = getState().sourceCodeAnalysis().wrappers(src);
          assertEquals(swl.size(), 1, &quot;unexpected list length&quot;);
          assertWrapperHas(swl.get(0), src, Kind.METHOD, &quot;void&quot;, &quot;flob&quot;, &quot;?????&quot;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -180,26 +291,39 @@</span>
      }
  
      private void assertWrapperHas(SnippetWrapper sw, String source, Kind kind, String... has) {
          assertEquals(sw.source(), source);
          assertEquals(sw.kind(), kind);
<span class="udiff-line-added">+         String s = sw.wrapped();</span>
          if (kind == Kind.IMPORT) {
<span class="udiff-line-modified-removed">-             assertTrue(sw.wrapped().contains(&quot;import&quot;));</span>
<span class="udiff-line-modified-added">+             assertHas(s, &quot;import&quot;);</span>
          } else {
              String cn = sw.fullClassName();
              int idx = cn.lastIndexOf(&quot;.&quot;);
<span class="udiff-line-modified-removed">-             assertTrue(sw.wrapped().contains(cn.substring(idx+1)));</span>
<span class="udiff-line-modified-removed">-             assertTrue(sw.wrapped().contains(&quot;class&quot;));</span>
<span class="udiff-line-modified-added">+             assertHas(s, cn.substring(idx+1));</span>
<span class="udiff-line-modified-added">+             assertHas(s, &quot;class&quot;);</span>
          }
<span class="udiff-line-modified-removed">-         for (String s : has) {</span>
<span class="udiff-line-modified-removed">-             assertTrue(sw.wrapped().contains(s));</span>
<span class="udiff-line-modified-added">+         for (String hx : has) {</span>
<span class="udiff-line-modified-added">+             assertHas(s, hx);</span>
          }
      }
  
<span class="udiff-line-added">+     private void assertHas(String s, String has) {</span>
<span class="udiff-line-added">+         assertTrue(s.contains(has), &quot;Expected to find &#39;&quot; + has + &quot;&#39; in: &#39;&quot; + s + &quot;&#39;&quot;);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      private void assertPosition(SnippetWrapper sw, String source, int start, int length) {
<span class="udiff-line-added">+         //System.err.printf(&quot;\n#assertPosition:\n#  debug-source: %s\n#  SnippetWrapper --\n#    source: %s\n#    wrapped: %s\n&quot;,</span>
<span class="udiff-line-added">+         //        source, sw.source(), sw.wrapped());</span>
<span class="udiff-line-added">+         //System.err.printf(&quot;#  start: %d    length: %d\n&quot;, start, length);</span>
          int wpg = sw.sourceToWrappedPosition(start);
<span class="udiff-line-modified-removed">-         assertEquals(sw.wrapped().substring(wpg, wpg+length),</span>
<span class="udiff-line-modified-removed">-                 source.substring(start, start+length),</span>
<span class="udiff-line-modified-added">+         //System.err.printf(&quot;#  wrappedPos: %d\n&quot;, wpg);</span>
<span class="udiff-line-modified-added">+         String wrappedPart = sw.wrapped().substring(wpg, wpg+length);</span>
<span class="udiff-line-added">+         String sourcePart = source.substring(start, start+length);</span>
<span class="udiff-line-added">+         //System.err.printf(&quot;#  wrapped @ wrappedPos: %s\n&quot;, wrappedPart);</span>
<span class="udiff-line-added">+         //System.err.printf(&quot;#  source @ start: %s\n&quot;, sourcePart);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         assertEquals(wrappedPart, sourcePart,</span>
                  &quot;position &quot; + wpg + &quot; in &quot; + sw.wrapped());
          assertEquals(sw.wrappedToSourcePosition(wpg), start);
      }
  }
</pre>
<center><a href="ToolTabSnippetTest.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="../../lib/annotations/annotations/classfile/ClassfileInspector.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>