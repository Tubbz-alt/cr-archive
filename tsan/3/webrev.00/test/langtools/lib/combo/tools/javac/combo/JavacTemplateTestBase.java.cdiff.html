<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff test/langtools/lib/combo/tools/javac/combo/JavacTemplateTestBase.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="Diagnostics.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="Template.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>test/langtools/lib/combo/tools/javac/combo/JavacTemplateTestBase.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2013, 2014, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2013, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 75,16 ***</span>
      private static final File root = new File(&quot;gen&quot;);
      private static final File nullDir = new File(&quot;empty&quot;);
  
      protected final Map&lt;String, Template&gt; templates = new HashMap&lt;&gt;();
      protected final Diagnostics diags = new Diagnostics();
<span class="line-modified">!     protected final List&lt;Pair&lt;String, Template&gt;&gt; sourceFiles = new ArrayList&lt;&gt;();</span>
      protected final List&lt;String&gt; compileOptions = new ArrayList&lt;&gt;();
      protected final List&lt;File&gt; classpaths = new ArrayList&lt;&gt;();
<span class="line-removed">-     protected final Template.Resolver defaultResolver = new MapResolver(templates);</span>
<span class="line-removed">- </span>
<span class="line-removed">-     private Template.Resolver currentResolver = defaultResolver;</span>
  
      /** Add a template with a specified name */
      protected void addTemplate(String name, Template t) {
          templates.put(name, t);
      }
<span class="line-new-header">--- 75,13 ---</span>
      private static final File root = new File(&quot;gen&quot;);
      private static final File nullDir = new File(&quot;empty&quot;);
  
      protected final Map&lt;String, Template&gt; templates = new HashMap&lt;&gt;();
      protected final Diagnostics diags = new Diagnostics();
<span class="line-modified">!     protected final List&lt;Pair&lt;String, String&gt;&gt; sourceFiles = new ArrayList&lt;&gt;();</span>
      protected final List&lt;String&gt; compileOptions = new ArrayList&lt;&gt;();
      protected final List&lt;File&gt; classpaths = new ArrayList&lt;&gt;();
  
      /** Add a template with a specified name */
      protected void addTemplate(String name, Template t) {
          templates.put(name, t);
      }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 93,12 ***</span>
      protected void addTemplate(String name, String s) {
          templates.put(name, new StringTemplate(s));
      }
  
      /** Add a source file */
<span class="line-modified">!     protected void addSourceFile(String name, Template t) {</span>
<span class="line-modified">!         sourceFiles.add(new Pair&lt;&gt;(name, t));</span>
      }
  
      /** Add a File to the class path to be used when loading classes; File values
       * will generally be the result of a previous call to {@link #compile()}.
       * This enables testing of separate compilation scenarios if the class path
<span class="line-new-header">--- 90,12 ---</span>
      protected void addTemplate(String name, String s) {
          templates.put(name, new StringTemplate(s));
      }
  
      /** Add a source file */
<span class="line-modified">!     protected void addSourceFile(String name, String template) {</span>
<span class="line-modified">!         sourceFiles.add(new Pair&lt;&gt;(name, template));</span>
      }
  
      /** Add a File to the class path to be used when loading classes; File values
       * will generally be the result of a previous call to {@link #compile()}.
       * This enables testing of separate compilation scenarios if the class path
</pre>
<hr />
<pre>
<span class="line-old-header">*** 147,11 ***</span>
              suiteErrors.addAll(diags.errorKeys());
  
              List&lt;Object&gt; list = new ArrayList&lt;&gt;();
              Collections.addAll(list, result.getParameters());
              list.add(&quot;Test case: &quot; + getTestCaseDescription());
<span class="line-modified">!             for (Pair&lt;String, Template&gt; e : sourceFiles)</span>
                  list.add(&quot;Source file &quot; + e.fst + &quot;: &quot; + e.snd);
              if (diags.errorsFound())
                  list.add(&quot;Compile diagnostics: &quot; + diags.toString());
              result.setParameters(list.toArray(new Object[list.size()]));
          }
<span class="line-new-header">--- 144,11 ---</span>
              suiteErrors.addAll(diags.errorKeys());
  
              List&lt;Object&gt; list = new ArrayList&lt;&gt;();
              Collections.addAll(list, result.getParameters());
              list.add(&quot;Test case: &quot; + getTestCaseDescription());
<span class="line-modified">!             for (Pair&lt;String, String&gt; e : sourceFiles)</span>
                  list.add(&quot;Source file &quot; + e.fst + &quot;: &quot; + e.snd);
              if (diags.errorsFound())
                  list.add(&quot;Compile diagnostics: &quot; + diags.toString());
              result.setParameters(list.toArray(new Object[list.size()]));
          }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 206,11 ***</span>
      /** Assert that a previous call to compile() failed with a specific error key */
      protected void assertCompileFailed(String key) {
          if (!diags.errorsFound())
              fail(&quot;Expected failed compilation: &quot; + key);
          if (!diags.containsErrorKey(key))
<span class="line-modified">!             fail(&quot;Expected compilation error &quot; + key);</span>
      }
  
      /** Assert that a previous call to compile() failed with a specific error key */
      protected void assertCompileFailedOneOf(String... keys) {
          if (!diags.errorsFound())
<span class="line-new-header">--- 203,11 ---</span>
      /** Assert that a previous call to compile() failed with a specific error key */
      protected void assertCompileFailed(String key) {
          if (!diags.errorsFound())
              fail(&quot;Expected failed compilation: &quot; + key);
          if (!diags.containsErrorKey(key))
<span class="line-modified">!             fail(String.format(&quot;Expected compilation error with %s, found %s&quot;, key, diags.keys()));</span>
      }
  
      /** Assert that a previous call to compile() failed with a specific error key */
      protected void assertCompileFailedOneOf(String... keys) {
          if (!diags.errorsFound())
</pre>
<hr />
<pre>
<span class="line-old-header">*** 229,41 ***</span>
          for (String k : keys)
              if (!diags.containsErrorKey(k))
                  fail(&quot;Expected compilation error &quot; + k);
      }
  
<span class="line-removed">-     /** Convert an object, which may be a Template or a String, into a Template */</span>
<span class="line-removed">-     protected Template asTemplate(Object o) {</span>
<span class="line-removed">-         if (o instanceof Template)</span>
<span class="line-removed">-             return (Template) o;</span>
<span class="line-removed">-         else if (o instanceof String)</span>
<span class="line-removed">-             return new StringTemplate((String) o);</span>
<span class="line-removed">-         else</span>
<span class="line-removed">-             return new StringTemplate(o.toString());</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
      /** Compile all registered source files */
      protected void compile() throws IOException {
          compile(false);
      }
  
      /** Compile all registered source files, optionally generating class files
       * and returning a File describing the directory to which they were written */
      protected File compile(boolean generate) throws IOException {
          List&lt;JavaFileObject&gt; files = new ArrayList&lt;&gt;();
<span class="line-modified">!         for (Pair&lt;String, Template&gt; e : sourceFiles)</span>
<span class="line-modified">!             files.add(new FileAdapter(e.fst, asTemplate(e.snd)));</span>
          return compile(classpaths, files, generate);
      }
  
      /** Compile all registered source files, using the provided list of class paths
       * for finding required classfiles, optionally generating class files
       * and returning a File describing the directory to which they were written */
      protected File compile(List&lt;File&gt; classpaths, boolean generate) throws IOException {
          List&lt;JavaFileObject&gt; files = new ArrayList&lt;&gt;();
<span class="line-modified">!         for (Pair&lt;String, Template&gt; e : sourceFiles)</span>
<span class="line-modified">!             files.add(new FileAdapter(e.fst, asTemplate(e.snd)));</span>
          return compile(classpaths, files, generate);
      }
  
      private File compile(List&lt;File&gt; classpaths, List&lt;JavaFileObject&gt; files, boolean generate) throws IOException {
          JavaCompiler systemJavaCompiler = ToolProvider.getSystemJavaCompiler();
<span class="line-new-header">--- 226,31 ---</span>
          for (String k : keys)
              if (!diags.containsErrorKey(k))
                  fail(&quot;Expected compilation error &quot; + k);
      }
  
      /** Compile all registered source files */
      protected void compile() throws IOException {
          compile(false);
      }
  
      /** Compile all registered source files, optionally generating class files
       * and returning a File describing the directory to which they were written */
      protected File compile(boolean generate) throws IOException {
          List&lt;JavaFileObject&gt; files = new ArrayList&lt;&gt;();
<span class="line-modified">!         for (Pair&lt;String, String&gt; e : sourceFiles)</span>
<span class="line-modified">!             files.add(new FileAdapter(e.fst, e.snd));</span>
          return compile(classpaths, files, generate);
      }
  
      /** Compile all registered source files, using the provided list of class paths
       * for finding required classfiles, optionally generating class files
       * and returning a File describing the directory to which they were written */
      protected File compile(List&lt;File&gt; classpaths, boolean generate) throws IOException {
          List&lt;JavaFileObject&gt; files = new ArrayList&lt;&gt;();
<span class="line-modified">!         for (Pair&lt;String, String&gt; e : sourceFiles)</span>
<span class="line-modified">!             files.add(new FileAdapter(e.fst, e.snd));</span>
          return compile(classpaths, files, generate);
      }
  
      private File compile(List&lt;File&gt; classpaths, List&lt;JavaFileObject&gt; files, boolean generate) throws IOException {
          JavaCompiler systemJavaCompiler = ToolProvider.getSystemJavaCompiler();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 304,82 ***</span>
  
          public StringTemplate(String template) {
              this.template = template;
          }
  
<span class="line-modified">!         public String expand(String selector) {</span>
<span class="line-modified">!             return Behavior.expandTemplate(template, currentResolver);</span>
          }
  
          public String toString() {
              return expand(&quot;&quot;);
          }
<span class="line-removed">- </span>
<span class="line-removed">-         public StringTemplate with(final String key, final String value) {</span>
<span class="line-removed">-             return new StringTemplateWithResolver(template, new KeyResolver(key, value));</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     /** An implementation of Template which is backed by a String and which</span>
<span class="line-removed">-      * encapsulates a Resolver for resolving embedded tags. */</span>
<span class="line-removed">-     protected class StringTemplateWithResolver extends StringTemplate {</span>
<span class="line-removed">-         private final Resolver localResolver;</span>
<span class="line-removed">- </span>
<span class="line-removed">-         public StringTemplateWithResolver(String template, Resolver localResolver) {</span>
<span class="line-removed">-             super(template);</span>
<span class="line-removed">-             this.localResolver = localResolver;</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         @Override</span>
<span class="line-removed">-         public String expand(String selector) {</span>
<span class="line-removed">-             Resolver saved = currentResolver;</span>
<span class="line-removed">-             currentResolver = new ChainedResolver(currentResolver, localResolver);</span>
<span class="line-removed">-             try {</span>
<span class="line-removed">-                 return super.expand(selector);</span>
<span class="line-removed">-             }</span>
<span class="line-removed">-             finally {</span>
<span class="line-removed">-                 currentResolver = saved;</span>
<span class="line-removed">-             }</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         @Override</span>
<span class="line-removed">-         public StringTemplate with(String key, String value) {</span>
<span class="line-removed">-             return new StringTemplateWithResolver(template, new ChainedResolver(localResolver, new KeyResolver(key, value)));</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     /** A Resolver which uses a Map to resolve tags */</span>
<span class="line-removed">-     private class KeyResolver implements Template.Resolver {</span>
<span class="line-removed">-         private final String key;</span>
<span class="line-removed">-         private final String value;</span>
<span class="line-removed">- </span>
<span class="line-removed">-         public KeyResolver(String key, String value) {</span>
<span class="line-removed">-             this.key = key;</span>
<span class="line-removed">-             this.value = value;</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         @Override</span>
<span class="line-removed">-         public Template lookup(String k) {</span>
<span class="line-removed">-             return key.equals(k) ? new StringTemplate(value) : null;</span>
<span class="line-removed">-         }</span>
      }
  
      private class FileAdapter extends SimpleJavaFileObject {
<span class="line-modified">!         private final String filename;</span>
<span class="line-removed">-         private final Template template;</span>
  
<span class="line-modified">!         public FileAdapter(String filename, Template template) {</span>
              super(URI.create(&quot;myfo:/&quot; + filename), Kind.SOURCE);
<span class="line-modified">!             this.template = template;</span>
<span class="line-removed">-             this.filename = filename;</span>
          }
  
          public CharSequence getCharContent(boolean ignoreEncodingErrors) {
              return toString();
          }
  
          public String toString() {
<span class="line-modified">!             return Template.Behavior.expandTemplate(template.expand(filename), defaultResolver);</span>
          }
      }
  }
<span class="line-new-header">--- 291,31 ---</span>
  
          public StringTemplate(String template) {
              this.template = template;
          }
  
<span class="line-modified">!         public String expand(String selectorIgnored) {</span>
<span class="line-modified">!             return Template.expandTemplate(template, templates);</span>
          }
  
          public String toString() {
              return expand(&quot;&quot;);
          }
      }
  
      private class FileAdapter extends SimpleJavaFileObject {
<span class="line-modified">!         private final String templateString;</span>
  
<span class="line-modified">!         FileAdapter(String filename, String templateString) {</span>
              super(URI.create(&quot;myfo:/&quot; + filename), Kind.SOURCE);
<span class="line-modified">!             this.templateString = templateString;</span>
          }
  
          public CharSequence getCharContent(boolean ignoreEncodingErrors) {
              return toString();
          }
  
          public String toString() {
<span class="line-modified">!             return Template.expandTemplate(templateString, templates);</span>
          }
      }
  }
</pre>
<center><a href="Diagnostics.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="Template.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>