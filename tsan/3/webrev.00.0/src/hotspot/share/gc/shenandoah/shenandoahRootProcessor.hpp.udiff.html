<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/hotspot/share/gc/shenandoah/shenandoahRootProcessor.hpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="shenandoahRootProcessor.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../../include/jvm.h.udiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/gc/shenandoah/shenandoahRootProcessor.hpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,8 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2015, 2019, Red Hat, Inc. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2015, 2020, Red Hat, Inc. All rights reserved.</span>
<span class="udiff-line-added">+  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.</span>
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
   *
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -27,108 +28,320 @@</span>
  #include &quot;code/codeCache.hpp&quot;
  #include &quot;gc/shared/oopStorageParState.hpp&quot;
  #include &quot;gc/shenandoah/shenandoahCodeRoots.hpp&quot;
  #include &quot;gc/shenandoah/shenandoahHeap.hpp&quot;
  #include &quot;gc/shenandoah/shenandoahPhaseTimings.hpp&quot;
<span class="udiff-line-modified-removed">- #include &quot;gc/shared/strongRootsScope.hpp&quot;</span>
<span class="udiff-line-removed">- #include &quot;gc/shared/weakProcessor.hpp&quot;</span>
<span class="udiff-line-removed">- #include &quot;gc/shared/weakProcessorPhaseTimes.hpp&quot;</span>
<span class="udiff-line-removed">- #include &quot;gc/shared/workgroup.hpp&quot;</span>
<span class="udiff-line-removed">- #include &quot;memory/allocation.hpp&quot;</span>
<span class="udiff-line-modified-added">+ #include &quot;gc/shenandoah/shenandoahSharedVariables.hpp&quot;</span>
  #include &quot;memory/iterator.hpp&quot;
  
<span class="udiff-line-modified-removed">- class ParallelCLDRootIterator {</span>
<span class="udiff-line-modified-added">+ class ShenandoahSerialRoot {</span>
  public:
<span class="udiff-line-modified-removed">-   ParallelCLDRootIterator();</span>
<span class="udiff-line-modified-removed">-   void root_cld_do(CLDClosure* strong, CLDClosure* weak);</span>
<span class="udiff-line-modified-added">+   typedef void (*OopsDo)(OopClosure*);</span>
<span class="udiff-line-modified-added">+ private:</span>
<span class="udiff-line-added">+   ShenandoahSharedFlag                      _claimed;</span>
<span class="udiff-line-added">+   const OopsDo                              _oops_do;</span>
<span class="udiff-line-added">+   const ShenandoahPhaseTimings::GCParPhases _phase;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ public:</span>
<span class="udiff-line-added">+   ShenandoahSerialRoot(OopsDo oops_do, ShenandoahPhaseTimings::GCParPhases);</span>
<span class="udiff-line-added">+   void oops_do(OopClosure* cl, uint worker_id);</span>
<span class="udiff-line-added">+ };</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ class ShenandoahSerialRoots {</span>
<span class="udiff-line-added">+ private:</span>
<span class="udiff-line-added">+   ShenandoahSerialRoot  _universe_root;</span>
<span class="udiff-line-added">+   ShenandoahSerialRoot  _object_synchronizer_root;</span>
<span class="udiff-line-added">+   ShenandoahSerialRoot  _management_root;</span>
<span class="udiff-line-added">+   ShenandoahSerialRoot  _system_dictionary_root;</span>
<span class="udiff-line-added">+   ShenandoahSerialRoot  _jvmti_root;</span>
<span class="udiff-line-added">+ public:</span>
<span class="udiff-line-added">+   ShenandoahSerialRoots();</span>
<span class="udiff-line-added">+   void oops_do(OopClosure* cl, uint worker_id);</span>
<span class="udiff-line-added">+ };</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ class ShenandoahWeakSerialRoot {</span>
<span class="udiff-line-added">+   typedef void (*WeakOopsDo)(BoolObjectClosure*, OopClosure*);</span>
<span class="udiff-line-added">+ private:</span>
<span class="udiff-line-added">+   ShenandoahSharedFlag                      _claimed;</span>
<span class="udiff-line-added">+   const WeakOopsDo                          _weak_oops_do;</span>
<span class="udiff-line-added">+   const ShenandoahPhaseTimings::GCParPhases _phase;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ public:</span>
<span class="udiff-line-added">+   ShenandoahWeakSerialRoot(WeakOopsDo oops_do, ShenandoahPhaseTimings::GCParPhases);</span>
<span class="udiff-line-added">+   void weak_oops_do(BoolObjectClosure* is_alive, OopClosure* keep_alive, uint worker_id);</span>
<span class="udiff-line-added">+ };</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ #if INCLUDE_JVMTI</span>
<span class="udiff-line-added">+ class ShenandoahJVMTIWeakRoot : public ShenandoahWeakSerialRoot {</span>
<span class="udiff-line-added">+ public:</span>
<span class="udiff-line-added">+   ShenandoahJVMTIWeakRoot();</span>
<span class="udiff-line-added">+ };</span>
<span class="udiff-line-added">+ #endif // INCLUDE_JVMTI</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ #if INCLUDE_JFR</span>
<span class="udiff-line-added">+ class ShenandoahJFRWeakRoot : public ShenandoahWeakSerialRoot {</span>
<span class="udiff-line-added">+ public:</span>
<span class="udiff-line-added">+   ShenandoahJFRWeakRoot();</span>
<span class="udiff-line-added">+ };</span>
<span class="udiff-line-added">+ #endif // INCLUDE_JFR</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ #if INCLUDE_TSAN</span>
<span class="udiff-line-added">+ class ShenandoahTSANWeakRoot : public ShenandoahWeakSerialRoot {</span>
<span class="udiff-line-added">+ public:</span>
<span class="udiff-line-added">+   ShenandoahTSANWeakRoot();</span>
<span class="udiff-line-added">+ };</span>
<span class="udiff-line-added">+ #endif // INCLUDE_TSAN</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ class ShenandoahSerialWeakRoots {</span>
<span class="udiff-line-added">+ private:</span>
<span class="udiff-line-added">+   JVMTI_ONLY(ShenandoahJVMTIWeakRoot _jvmti_weak_roots;)</span>
<span class="udiff-line-added">+   JFR_ONLY(ShenandoahJFRWeakRoot     _jfr_weak_roots;)</span>
<span class="udiff-line-added">+   TSAN_ONLY(ShenandoahTSANWeakRoot   _tsan_weak_roots;)</span>
<span class="udiff-line-added">+ public:</span>
<span class="udiff-line-added">+   void weak_oops_do(BoolObjectClosure* is_alive, OopClosure* keep_alive, uint worker_id);</span>
<span class="udiff-line-added">+   void weak_oops_do(OopClosure* cl, uint worker_id);</span>
<span class="udiff-line-added">+ };</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ template &lt;bool CONCURRENT&gt;</span>
<span class="udiff-line-added">+ class ShenandoahVMRoot {</span>
<span class="udiff-line-added">+ private:</span>
<span class="udiff-line-added">+   OopStorage::ParState&lt;CONCURRENT, false /* is_const */&gt; _itr;</span>
<span class="udiff-line-added">+   const ShenandoahPhaseTimings::GCParPhases _phase;</span>
<span class="udiff-line-added">+ public:</span>
<span class="udiff-line-added">+   ShenandoahVMRoot(OopStorage* storage, ShenandoahPhaseTimings::GCParPhases phase);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   template &lt;typename Closure&gt;</span>
<span class="udiff-line-added">+   void oops_do(Closure* cl, uint worker_id);</span>
<span class="udiff-line-added">+ };</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ template &lt;bool CONCURRENT&gt;</span>
<span class="udiff-line-added">+ class ShenandoahWeakRoot : public ShenandoahVMRoot&lt;CONCURRENT&gt; {</span>
<span class="udiff-line-added">+ public:</span>
<span class="udiff-line-added">+   ShenandoahWeakRoot(OopStorage* storage, ShenandoahPhaseTimings::GCParPhases phase);</span>
<span class="udiff-line-added">+ };</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ template &lt;&gt;</span>
<span class="udiff-line-added">+ class ShenandoahWeakRoot&lt;false /*concurrent*/&gt; {</span>
<span class="udiff-line-added">+ private:</span>
<span class="udiff-line-added">+   OopStorage::ParState&lt;false /*concurrent*/, false /*is_const*/&gt; _itr;</span>
<span class="udiff-line-added">+   const ShenandoahPhaseTimings::GCParPhases _phase;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ public:</span>
<span class="udiff-line-added">+   ShenandoahWeakRoot(OopStorage* storage, ShenandoahPhaseTimings::GCParPhases phase);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   template &lt;typename IsAliveClosure, typename KeepAliveClosure&gt;</span>
<span class="udiff-line-added">+   void weak_oops_do(IsAliveClosure* is_alive, KeepAliveClosure* keep_alive, uint worker_id);</span>
<span class="udiff-line-added">+ };</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ template &lt;bool CONCURRENT&gt;</span>
<span class="udiff-line-added">+ class ShenandoahWeakRoots {</span>
<span class="udiff-line-added">+ private:</span>
<span class="udiff-line-added">+   ShenandoahWeakRoot&lt;CONCURRENT&gt;  _jni_roots;</span>
<span class="udiff-line-added">+   ShenandoahWeakRoot&lt;CONCURRENT&gt;  _string_table_roots;</span>
<span class="udiff-line-added">+   ShenandoahWeakRoot&lt;CONCURRENT&gt;  _resolved_method_table_roots;</span>
<span class="udiff-line-added">+   ShenandoahWeakRoot&lt;CONCURRENT&gt;  _vm_roots;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ public:</span>
<span class="udiff-line-added">+   ShenandoahWeakRoots();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   template &lt;typename Closure&gt;</span>
<span class="udiff-line-added">+   void oops_do(Closure* cl, uint worker_id = 0);</span>
<span class="udiff-line-added">+ };</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ template &lt;&gt;</span>
<span class="udiff-line-added">+ class ShenandoahWeakRoots&lt;false /*concurrent */&gt; {</span>
<span class="udiff-line-added">+ private:</span>
<span class="udiff-line-added">+   ShenandoahWeakRoot&lt;false /*concurrent*/&gt;  _jni_roots;</span>
<span class="udiff-line-added">+   ShenandoahWeakRoot&lt;false /*concurrent*/&gt;  _string_table_roots;</span>
<span class="udiff-line-added">+   ShenandoahWeakRoot&lt;false /*concurrent*/&gt;  _resolved_method_table_roots;</span>
<span class="udiff-line-added">+   ShenandoahWeakRoot&lt;false /*concurrent*/&gt;  _vm_roots;</span>
<span class="udiff-line-added">+ public:</span>
<span class="udiff-line-added">+   ShenandoahWeakRoots();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   template &lt;typename Closure&gt;</span>
<span class="udiff-line-added">+   void oops_do(Closure* cl, uint worker_id = 0);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   template &lt;typename IsAliveClosure, typename KeepAliveClosure&gt;</span>
<span class="udiff-line-added">+   void weak_oops_do(IsAliveClosure* is_alive, KeepAliveClosure* keep_alive, uint worker_id);</span>
<span class="udiff-line-added">+ };</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ template &lt;bool CONCURRENT&gt;</span>
<span class="udiff-line-added">+ class ShenandoahVMRoots {</span>
<span class="udiff-line-added">+ private:</span>
<span class="udiff-line-added">+   ShenandoahVMRoot&lt;CONCURRENT&gt;    _jni_handle_roots;</span>
<span class="udiff-line-added">+   ShenandoahVMRoot&lt;CONCURRENT&gt;    _vm_global_roots;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ public:</span>
<span class="udiff-line-added">+   ShenandoahVMRoots();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   template &lt;typename T&gt;</span>
<span class="udiff-line-added">+   void oops_do(T* cl, uint worker_id = 0);</span>
<span class="udiff-line-added">+ };</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ class ShenandoahThreadRoots {</span>
<span class="udiff-line-added">+ private:</span>
<span class="udiff-line-added">+   const bool _is_par;</span>
<span class="udiff-line-added">+ public:</span>
<span class="udiff-line-added">+   ShenandoahThreadRoots(bool is_par);</span>
<span class="udiff-line-added">+   ~ShenandoahThreadRoots();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   void oops_do(OopClosure* oops_cl, CodeBlobClosure* code_cl, uint worker_id);</span>
<span class="udiff-line-added">+   void threads_do(ThreadClosure* tc, uint worker_id);</span>
<span class="udiff-line-added">+ };</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ class ShenandoahStringDedupRoots {</span>
<span class="udiff-line-added">+ public:</span>
<span class="udiff-line-added">+   ShenandoahStringDedupRoots();</span>
<span class="udiff-line-added">+   ~ShenandoahStringDedupRoots();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   void oops_do(BoolObjectClosure* is_alive, OopClosure* keep_alive, uint worker_id);</span>
<span class="udiff-line-added">+ };</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ class ShenandoahConcurrentStringDedupRoots {</span>
<span class="udiff-line-added">+ public:</span>
<span class="udiff-line-added">+   ShenandoahConcurrentStringDedupRoots();</span>
<span class="udiff-line-added">+   ~ShenandoahConcurrentStringDedupRoots();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   void oops_do(BoolObjectClosure* is_alive, OopClosure* keep_alive, uint worker_id);</span>
<span class="udiff-line-added">+ };</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ template &lt;typename ITR&gt;</span>
<span class="udiff-line-added">+ class ShenandoahCodeCacheRoots {</span>
<span class="udiff-line-added">+ private:</span>
<span class="udiff-line-added">+   ITR _coderoots_iterator;</span>
<span class="udiff-line-added">+ public:</span>
<span class="udiff-line-added">+   ShenandoahCodeCacheRoots();</span>
<span class="udiff-line-added">+   ~ShenandoahCodeCacheRoots();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   void code_blobs_do(CodeBlobClosure* blob_cl, uint worker_id);</span>
  };
  
<span class="udiff-line-modified-removed">- enum Shenandoah_process_roots_tasks {</span>
<span class="udiff-line-modified-removed">-   SHENANDOAH_RP_PS_Universe_oops_do,</span>
<span class="udiff-line-modified-removed">-   SHENANDOAH_RP_PS_JNIHandles_oops_do,</span>
<span class="udiff-line-modified-removed">-   SHENANDOAH_RP_PS_ObjectSynchronizer_oops_do,</span>
<span class="udiff-line-modified-removed">-   SHENANDOAH_RP_PS_Management_oops_do,</span>
<span class="udiff-line-modified-removed">-   SHENANDOAH_RP_PS_SystemDictionary_oops_do,</span>
<span class="udiff-line-modified-removed">-   SHENANDOAH_RP_PS_jvmti_oops_do,</span>
<span class="udiff-line-modified-removed">-   // Leave this one last.</span>
<span class="udiff-line-removed">-   SHENANDOAH_RP_PS_NumElements</span>
<span class="udiff-line-modified-added">+ template &lt;bool CONCURRENT, bool SINGLE_THREADED&gt;</span>
<span class="udiff-line-modified-added">+ class ShenandoahClassLoaderDataRoots {</span>
<span class="udiff-line-modified-added">+ public:</span>
<span class="udiff-line-modified-added">+   ShenandoahClassLoaderDataRoots();</span>
<span class="udiff-line-modified-added">+   ~ShenandoahClassLoaderDataRoots();</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+   void always_strong_cld_do(CLDClosure* clds, uint worker_id = 0);</span>
<span class="udiff-line-modified-added">+   void cld_do(CLDClosure* clds, uint worker_id = 0);</span>
  };
  
  class ShenandoahRootProcessor : public StackObj {
<span class="udiff-line-modified-removed">-   SubTasksDone* _process_strong_tasks;</span>
<span class="udiff-line-modified-removed">-   StrongRootsScope _srs;</span>
<span class="udiff-line-modified-removed">-   OopStorage::ParState&lt;false, false&gt; _par_state_string;</span>
<span class="udiff-line-modified-removed">-   ShenandoahPhaseTimings::Phase _phase;</span>
<span class="udiff-line-modified-removed">-   ParallelCLDRootIterator   _cld_iterator;</span>
<span class="udiff-line-removed">-   ShenandoahAllCodeRootsIterator _coderoots_all_iterator;</span>
<span class="udiff-line-removed">-   CodeBlobClosure* _threads_nmethods_cl;</span>
<span class="udiff-line-removed">-   WeakProcessorPhaseTimes _weak_processor_timings;</span>
<span class="udiff-line-removed">-   WeakProcessor::Task     _weak_processor_task;</span>
<span class="udiff-line-removed">-   bool                    _processed_weak_roots;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   void process_java_roots(OopClosure* scan_non_heap_roots,</span>
<span class="udiff-line-removed">-                           CLDClosure* scan_strong_clds,</span>
<span class="udiff-line-removed">-                           CLDClosure* scan_weak_clds,</span>
<span class="udiff-line-removed">-                           CodeBlobClosure* scan_strong_code,</span>
<span class="udiff-line-removed">-                           ThreadClosure* thread_cl,</span>
<span class="udiff-line-removed">-                           uint worker_i);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   void process_vm_roots(OopClosure* scan_non_heap_roots,</span>
<span class="udiff-line-removed">-                         OopClosure* scan_non_heap_weak_roots,</span>
<span class="udiff-line-removed">-                         OopClosure* weak_jni_roots,</span>
<span class="udiff-line-removed">-                         uint worker_i);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   void weak_processor_timing_to_shenandoah_timing(const WeakProcessorPhases::Phase wpp,</span>
<span class="udiff-line-removed">-                                                   const ShenandoahPhaseTimings::GCParPhases spp,</span>
<span class="udiff-line-removed">-                                                   ShenandoahWorkerTimings* worker_times) const;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- public:</span>
<span class="udiff-line-removed">-   ShenandoahRootProcessor(ShenandoahHeap* heap, uint n_workers,</span>
<span class="udiff-line-removed">-                           ShenandoahPhaseTimings::Phase phase);</span>
<span class="udiff-line-modified-added">+ private:</span>
<span class="udiff-line-modified-added">+   ShenandoahHeap* const               _heap;</span>
<span class="udiff-line-modified-added">+   const ShenandoahPhaseTimings::Phase _phase;</span>
<span class="udiff-line-modified-added">+ public:</span>
<span class="udiff-line-modified-added">+   ShenandoahRootProcessor(ShenandoahPhaseTimings::Phase phase);</span>
    ~ShenandoahRootProcessor();
  
<span class="udiff-line-modified-removed">-   // Apply oops, clds and blobs to all strongly reachable roots in the system</span>
<span class="udiff-line-modified-removed">-   void process_strong_roots(OopClosure* oops, OopClosure* weak_oops,</span>
<span class="udiff-line-removed">-                             CLDClosure* clds,</span>
<span class="udiff-line-removed">-                             CLDClosure* weak_clds,</span>
<span class="udiff-line-removed">-                             CodeBlobClosure* blobs,</span>
<span class="udiff-line-removed">-                             ThreadClosure* thread_cl,</span>
<span class="udiff-line-removed">-                             uint worker_id);</span>
<span class="udiff-line-modified-added">+   ShenandoahHeap* heap() const { return _heap; }</span>
<span class="udiff-line-modified-added">+ };</span>
  
<span class="udiff-line-modified-removed">-   // Apply oops, clds and blobs to strongly and weakly reachable roots in the system</span>
<span class="udiff-line-modified-removed">-   void process_all_roots(OopClosure* oops, OopClosure* weak_oops,</span>
<span class="udiff-line-modified-removed">-                          CLDClosure* clds,</span>
<span class="udiff-line-modified-removed">-                          CodeBlobClosure* blobs,</span>
<span class="udiff-line-modified-removed">-                          ThreadClosure* thread_cl,</span>
<span class="udiff-line-modified-removed">-                          uint worker_id);</span>
<span class="udiff-line-modified-added">+ template &lt;typename ITR&gt;</span>
<span class="udiff-line-modified-added">+ class ShenandoahRootScanner : public ShenandoahRootProcessor {</span>
<span class="udiff-line-modified-added">+ private:</span>
<span class="udiff-line-modified-added">+   ShenandoahSerialRoots                                     _serial_roots;</span>
<span class="udiff-line-modified-added">+   ShenandoahThreadRoots                                     _thread_roots;</span>
<span class="udiff-line-modified-added">+   ShenandoahCodeCacheRoots&lt;ITR&gt;                             _code_roots;</span>
<span class="udiff-line-added">+   ShenandoahVMRoots&lt;false /*concurrent*/ &gt;                  _vm_roots;</span>
<span class="udiff-line-added">+   ShenandoahStringDedupRoots                                _dedup_roots;</span>
<span class="udiff-line-added">+   ShenandoahClassLoaderDataRoots&lt;false /*concurrent*/, false /*single threaded*/&gt;</span>
<span class="udiff-line-added">+                                                             _cld_roots;</span>
<span class="udiff-line-added">+ public:</span>
<span class="udiff-line-added">+   ShenandoahRootScanner(uint n_workers, ShenandoahPhaseTimings::Phase phase);</span>
  
<span class="udiff-line-modified-removed">-   // For slow debug/verification code</span>
<span class="udiff-line-modified-removed">-   void process_all_roots_slow(OopClosure* oops);</span>
<span class="udiff-line-modified-added">+   // Apply oops, clds and blobs to all strongly reachable roots in the system,</span>
<span class="udiff-line-modified-added">+   // during class unloading cycle</span>
<span class="udiff-line-added">+   void strong_roots_do(uint worker_id, OopClosure* cl);</span>
<span class="udiff-line-added">+   void strong_roots_do(uint worker_id, OopClosure* oops, CLDClosure* clds, CodeBlobClosure* code, ThreadClosure* tc = NULL);</span>
  
<span class="udiff-line-modified-removed">-   // Number of worker threads used by the root processor.</span>
<span class="udiff-line-modified-removed">-   uint n_workers() const;</span>
<span class="udiff-line-modified-added">+   // Apply oops, clds and blobs to all strongly reachable roots and weakly reachable</span>
<span class="udiff-line-modified-added">+   // roots when class unloading is disabled during this cycle</span>
<span class="udiff-line-added">+   void roots_do(uint worker_id, OopClosure* cl);</span>
<span class="udiff-line-added">+   void roots_do(uint worker_id, OopClosure* oops, CLDClosure* clds, CodeBlobClosure* code, ThreadClosure* tc = NULL);</span>
  };
  
<span class="udiff-line-modified-removed">- class ShenandoahRootEvacuator : public StackObj {</span>
<span class="udiff-line-modified-removed">-   SubTasksDone* _evacuation_tasks;</span>
<span class="udiff-line-modified-removed">-   StrongRootsScope _srs;</span>
<span class="udiff-line-modified-removed">-   ShenandoahPhaseTimings::Phase _phase;</span>
<span class="udiff-line-modified-removed">-   ShenandoahCsetCodeRootsIterator _coderoots_cset_iterator;</span>
<span class="udiff-line-modified-added">+ typedef ShenandoahRootScanner&lt;ShenandoahAllCodeRootsIterator&gt; ShenandoahAllRootScanner;</span>
<span class="udiff-line-modified-added">+ typedef ShenandoahRootScanner&lt;ShenandoahCsetCodeRootsIterator&gt; ShenandoahCSetRootScanner;</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+ // This scanner is only for SH::object_iteration() and only supports single-threaded</span>
<span class="udiff-line-modified-added">+ // root scanning</span>
<span class="udiff-line-added">+ class ShenandoahHeapIterationRootScanner : public ShenandoahRootProcessor {</span>
<span class="udiff-line-added">+ private:</span>
<span class="udiff-line-added">+   ShenandoahSerialRoots                                    _serial_roots;</span>
<span class="udiff-line-added">+   ShenandoahThreadRoots                                    _thread_roots;</span>
<span class="udiff-line-added">+   ShenandoahVMRoots&lt;false /*concurrent*/&gt;                  _vm_roots;</span>
<span class="udiff-line-added">+   ShenandoahClassLoaderDataRoots&lt;false /*concurrent*/, true /*single threaded*/&gt;</span>
<span class="udiff-line-added">+                                                            _cld_roots;</span>
<span class="udiff-line-added">+   ShenandoahSerialWeakRoots                                _serial_weak_roots;</span>
<span class="udiff-line-added">+   ShenandoahWeakRoots&lt;false /*concurrent*/&gt;                _weak_roots;</span>
<span class="udiff-line-added">+   ShenandoahConcurrentStringDedupRoots                     _dedup_roots;</span>
<span class="udiff-line-added">+   ShenandoahCodeCacheRoots&lt;ShenandoahAllCodeRootsIterator&gt; _code_roots;</span>
  
<span class="udiff-line-modified-removed">-   enum Shenandoah_evacuate_roots_tasks {</span>
<span class="udiff-line-removed">-       SHENANDOAH_EVAC_jvmti_oops_do,</span>
<span class="udiff-line-removed">-       // Leave this one last.</span>
<span class="udiff-line-removed">-       SHENANDOAH_EVAC_NumElements</span>
<span class="udiff-line-removed">-   };</span>
<span class="udiff-line-removed">- public:</span>
<span class="udiff-line-removed">-   ShenandoahRootEvacuator(ShenandoahHeap* heap, uint n_workers,</span>
<span class="udiff-line-removed">-                           ShenandoahPhaseTimings::Phase phase);</span>
<span class="udiff-line-modified-added">+ public:</span>
    ShenandoahHeapIterationRootScanner();
  
<span class="udiff-line-modified-removed">-   void process_evacuate_roots(OopClosure* oops,</span>
<span class="udiff-line-modified-removed">-                               CodeBlobClosure* blobs,</span>
<span class="udiff-line-modified-removed">-                               uint worker_id);</span>
<span class="udiff-line-modified-added">+   void roots_do(OopClosure* cl);</span>
<span class="udiff-line-modified-added">+   void strong_roots_do(OopClosure* cl);</span>
<span class="udiff-line-modified-added">+ };</span>
  
<span class="udiff-line-modified-removed">-   // Number of worker threads used by the root processor.</span>
<span class="udiff-line-modified-removed">-   uint n_workers() const;</span>
<span class="udiff-line-modified-added">+ // Evacuate all roots at a safepoint</span>
<span class="udiff-line-modified-added">+ class ShenandoahRootEvacuator : public ShenandoahRootProcessor {</span>
<span class="udiff-line-added">+ private:</span>
<span class="udiff-line-added">+   ShenandoahSerialRoots                                     _serial_roots;</span>
<span class="udiff-line-added">+   ShenandoahVMRoots&lt;false /*concurrent*/&gt;                   _vm_roots;</span>
<span class="udiff-line-added">+   ShenandoahClassLoaderDataRoots&lt;false /*concurrent*/, false /*single threaded*/&gt;</span>
<span class="udiff-line-added">+                                                             _cld_roots;</span>
<span class="udiff-line-added">+   ShenandoahThreadRoots                                     _thread_roots;</span>
<span class="udiff-line-added">+   ShenandoahSerialWeakRoots                                 _serial_weak_roots;</span>
<span class="udiff-line-added">+   ShenandoahWeakRoots&lt;false /*concurrent*/&gt;                 _weak_roots;</span>
<span class="udiff-line-added">+   ShenandoahStringDedupRoots                                _dedup_roots;</span>
<span class="udiff-line-added">+   ShenandoahCodeCacheRoots&lt;ShenandoahAllCodeRootsIterator&gt;  _code_roots;</span>
<span class="udiff-line-added">+   bool                                                      _include_concurrent_roots;</span>
<span class="udiff-line-added">+   bool                                                      _include_concurrent_code_roots;</span>
<span class="udiff-line-added">+ public:</span>
<span class="udiff-line-added">+   ShenandoahRootEvacuator(uint n_workers, ShenandoahPhaseTimings::Phase phase,</span>
<span class="udiff-line-added">+                           bool include_concurrent_roots, bool _include_concurrent_code_roots);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   void roots_do(uint worker_id, OopClosure* oops);</span>
  };
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ // Update all roots at a safepoint</span>
<span class="udiff-line-added">+ class ShenandoahRootUpdater : public ShenandoahRootProcessor {</span>
<span class="udiff-line-added">+ private:</span>
<span class="udiff-line-added">+   ShenandoahSerialRoots                                     _serial_roots;</span>
<span class="udiff-line-added">+   ShenandoahVMRoots&lt;false /*concurrent*/&gt;                   _vm_roots;</span>
<span class="udiff-line-added">+   ShenandoahClassLoaderDataRoots&lt;false /*concurrent*/, false /*single threaded*/&gt;</span>
<span class="udiff-line-added">+                                                             _cld_roots;</span>
<span class="udiff-line-added">+   ShenandoahThreadRoots                                     _thread_roots;</span>
<span class="udiff-line-added">+   ShenandoahSerialWeakRoots                                 _serial_weak_roots;</span>
<span class="udiff-line-added">+   ShenandoahWeakRoots&lt;false /*concurrent*/&gt;                 _weak_roots;</span>
<span class="udiff-line-added">+   ShenandoahStringDedupRoots                                _dedup_roots;</span>
<span class="udiff-line-added">+   ShenandoahCodeCacheRoots&lt;ShenandoahAllCodeRootsIterator&gt;  _code_roots;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ public:</span>
<span class="udiff-line-added">+   ShenandoahRootUpdater(uint n_workers, ShenandoahPhaseTimings::Phase phase);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   template&lt;typename IsAlive, typename KeepAlive&gt;</span>
<span class="udiff-line-added">+   void roots_do(uint worker_id, IsAlive* is_alive, KeepAlive* keep_alive);</span>
<span class="udiff-line-added">+ };</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ // Adjuster all roots at a safepoint during full gc</span>
<span class="udiff-line-added">+ class ShenandoahRootAdjuster : public ShenandoahRootProcessor {</span>
<span class="udiff-line-added">+ private:</span>
<span class="udiff-line-added">+   ShenandoahSerialRoots                                     _serial_roots;</span>
<span class="udiff-line-added">+   ShenandoahVMRoots&lt;false /*concurrent*/&gt;                   _vm_roots;</span>
<span class="udiff-line-added">+   ShenandoahClassLoaderDataRoots&lt;false /*concurrent*/, false /*single threaded*/&gt;</span>
<span class="udiff-line-added">+                                                             _cld_roots;</span>
<span class="udiff-line-added">+   ShenandoahThreadRoots                                     _thread_roots;</span>
<span class="udiff-line-added">+   ShenandoahSerialWeakRoots                                 _serial_weak_roots;</span>
<span class="udiff-line-added">+   ShenandoahWeakRoots&lt;false /*concurrent*/&gt;                 _weak_roots;</span>
<span class="udiff-line-added">+   ShenandoahStringDedupRoots                                _dedup_roots;</span>
<span class="udiff-line-added">+   ShenandoahCodeCacheRoots&lt;ShenandoahAllCodeRootsIterator&gt;  _code_roots;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ public:</span>
<span class="udiff-line-added">+   ShenandoahRootAdjuster(uint n_workers, ShenandoahPhaseTimings::Phase phase);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   void roots_do(uint worker_id, OopClosure* oops);</span>
<span class="udiff-line-added">+ };</span>
<span class="udiff-line-added">+ </span>
  #endif // SHARE_GC_SHENANDOAH_SHENANDOAHROOTPROCESSOR_HPP
</pre>
<center><a href="shenandoahRootProcessor.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../../include/jvm.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>