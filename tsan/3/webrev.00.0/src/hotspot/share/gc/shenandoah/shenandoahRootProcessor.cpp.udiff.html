<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/hotspot/share/gc/shenandoah/shenandoahRootProcessor.cpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="shenandoahPhaseTimings.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="shenandoahRootProcessor.hpp.udiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/gc/shenandoah/shenandoahRootProcessor.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,8 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2015, 2019, Red Hat, Inc. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2015, 2020, Red Hat, Inc. All rights reserved.</span>
<span class="udiff-line-added">+  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.</span>
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
   *
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -25,290 +26,280 @@</span>
  
  #include &quot;classfile/classLoaderDataGraph.hpp&quot;
  #include &quot;classfile/stringTable.hpp&quot;
  #include &quot;classfile/systemDictionary.hpp&quot;
  #include &quot;code/codeCache.hpp&quot;
<span class="udiff-line-modified-removed">- #include &quot;gc/shenandoah/shenandoahRootProcessor.hpp&quot;</span>
<span class="udiff-line-modified-added">+ #include &quot;gc/shenandoah/shenandoahClosures.inline.hpp&quot;</span>
<span class="udiff-line-added">+ #include &quot;gc/shenandoah/shenandoahConcurrentRoots.hpp&quot;</span>
<span class="udiff-line-added">+ #include &quot;gc/shenandoah/shenandoahRootProcessor.inline.hpp&quot;</span>
  #include &quot;gc/shenandoah/shenandoahHeap.hpp&quot;
  #include &quot;gc/shenandoah/shenandoahPhaseTimings.hpp&quot;
  #include &quot;gc/shenandoah/shenandoahStringDedup.hpp&quot;
  #include &quot;gc/shenandoah/shenandoahTimingTracker.hpp&quot;
<span class="udiff-line-modified-removed">- #include &quot;gc/shenandoah/shenandoahUtils.hpp&quot;</span>
<span class="udiff-line-removed">- #include &quot;gc/shenandoah/shenandoahVMOperations.hpp&quot;</span>
<span class="udiff-line-removed">- #include &quot;gc/shared/weakProcessor.inline.hpp&quot;</span>
<span class="udiff-line-modified-added">+ #include &quot;gc/shenandoah/shenandoahVMOperations.hpp&quot;</span>
  #include &quot;jfr/jfr.hpp&quot;
  #include &quot;memory/iterator.hpp&quot;
  #include &quot;memory/resourceArea.hpp&quot;
<span class="udiff-line-added">+ #include &quot;memory/universe.hpp&quot;</span>
  #include &quot;runtime/thread.hpp&quot;
  #include &quot;services/management.hpp&quot;
<span class="udiff-line-added">+ #include &quot;tsan/tsanOopMap.hpp&quot;</span>
  
<span class="udiff-line-modified-removed">- struct PhaseMap {</span>
<span class="udiff-line-modified-removed">-   WeakProcessorPhases::Phase            _weak_processor_phase;</span>
<span class="udiff-line-modified-removed">-   ShenandoahPhaseTimings::GCParPhases   _shenandoah_phase;</span>
<span class="udiff-line-removed">- };</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- static const struct PhaseMap phase_mapping[] = {</span>
<span class="udiff-line-removed">- #if INCLUDE_JVMTI</span>
<span class="udiff-line-removed">-   {WeakProcessorPhases::jvmti,       ShenandoahPhaseTimings::JVMTIWeakRoots},</span>
<span class="udiff-line-removed">- #endif</span>
<span class="udiff-line-removed">- #if INCLUDE_JFR</span>
<span class="udiff-line-removed">-   {WeakProcessorPhases::jfr,         ShenandoahPhaseTimings::JFRWeakRoots},</span>
<span class="udiff-line-removed">- #endif</span>
<span class="udiff-line-removed">- #if INCLUDE_TSAN</span>
<span class="udiff-line-removed">-   {WeakProcessorPhases::tsan,        ShenandoahPhaseTimings::TSANWeakRoots},</span>
<span class="udiff-line-removed">- #endif</span>
<span class="udiff-line-removed">-   {WeakProcessorPhases::jni,         ShenandoahPhaseTimings::JNIWeakRoots},</span>
<span class="udiff-line-removed">-   {WeakProcessorPhases::stringtable, ShenandoahPhaseTimings::StringTableRoots},</span>
<span class="udiff-line-removed">-   {WeakProcessorPhases::vm,          ShenandoahPhaseTimings::VMWeakRoots}</span>
<span class="udiff-line-removed">- };</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- STATIC_ASSERT(sizeof(phase_mapping) / sizeof(PhaseMap) == WeakProcessorPhases::phase_count);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- ShenandoahRootProcessor::ShenandoahRootProcessor(ShenandoahHeap* heap, uint n_workers,</span>
<span class="udiff-line-removed">-                                                  ShenandoahPhaseTimings::Phase phase) :</span>
<span class="udiff-line-removed">-   _process_strong_tasks(new SubTasksDone(SHENANDOAH_RP_PS_NumElements)),</span>
<span class="udiff-line-removed">-   _srs(n_workers),</span>
<span class="udiff-line-removed">-   _par_state_string(StringTable::weak_storage()),</span>
<span class="udiff-line-removed">-   _phase(phase),</span>
<span class="udiff-line-removed">-   _coderoots_all_iterator(ShenandoahCodeRoots::iterator()),</span>
<span class="udiff-line-removed">-   _weak_processor_timings(n_workers),</span>
<span class="udiff-line-removed">-   _weak_processor_task(&amp;_weak_processor_timings, n_workers),</span>
<span class="udiff-line-removed">-   _processed_weak_roots(false) {</span>
<span class="udiff-line-removed">-   heap-&gt;phase_timings()-&gt;record_workers_start(_phase);</span>
<span class="udiff-line-modified-added">+ ShenandoahSerialRoot::ShenandoahSerialRoot(ShenandoahSerialRoot::OopsDo oops_do, ShenandoahPhaseTimings::GCParPhases phase) :</span>
<span class="udiff-line-modified-added">+   _oops_do(oops_do), _phase(phase) {</span>
<span class="udiff-line-modified-added">+ }</span>
  
<span class="udiff-line-modified-removed">-   if (ShenandoahStringDedup::is_enabled()) {</span>
<span class="udiff-line-modified-removed">-     StringDedup::gc_prologue(false);</span>
<span class="udiff-line-modified-added">+ void ShenandoahSerialRoot::oops_do(OopClosure* cl, uint worker_id) {</span>
<span class="udiff-line-modified-added">+   if (_claimed.try_set()) {</span>
<span class="udiff-line-added">+     ShenandoahWorkerTimings* worker_times = ShenandoahHeap::heap()-&gt;phase_timings()-&gt;worker_times();</span>
<span class="udiff-line-added">+     ShenandoahWorkerTimingsTracker timer(worker_times, _phase, worker_id);</span>
<span class="udiff-line-added">+     _oops_do(cl);</span>
    }
  }
  
<span class="udiff-line-modified-removed">- ShenandoahRootProcessor::~ShenandoahRootProcessor() {</span>
<span class="udiff-line-modified-removed">-   delete _process_strong_tasks;</span>
<span class="udiff-line-modified-removed">-   if (ShenandoahStringDedup::is_enabled()) {</span>
<span class="udiff-line-modified-removed">-     StringDedup::gc_epilogue();</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-modified-added">+ // Overwrite the second argument for SD::oops_do, don&#39;t include vm global oop storage.</span>
<span class="udiff-line-modified-added">+ static void system_dictionary_oops_do(OopClosure* cl) {</span>
<span class="udiff-line-modified-added">+   SystemDictionary::oops_do(cl, false);</span>
<span class="udiff-line-modified-added">+ }</span>
  
<span class="udiff-line-modified-removed">-   ShenandoahWorkerTimings* worker_times = ShenandoahHeap::heap()-&gt;phase_timings()-&gt;worker_times();</span>
<span class="udiff-line-modified-added">+ ShenandoahSerialRoots::ShenandoahSerialRoots() :</span>
<span class="udiff-line-added">+   _universe_root(&amp;Universe::oops_do, ShenandoahPhaseTimings::UniverseRoots),</span>
<span class="udiff-line-added">+   _object_synchronizer_root(&amp;ObjectSynchronizer::oops_do, ShenandoahPhaseTimings::ObjectSynchronizerRoots),</span>
<span class="udiff-line-added">+   _management_root(&amp;Management::oops_do, ShenandoahPhaseTimings::ManagementRoots),</span>
<span class="udiff-line-added">+   _system_dictionary_root(&amp;system_dictionary_oops_do, ShenandoahPhaseTimings::SystemDictionaryRoots),</span>
<span class="udiff-line-added">+   _jvmti_root(&amp;JvmtiExport::oops_do, ShenandoahPhaseTimings::JVMTIRoots) {</span>
<span class="udiff-line-added">+ }</span>
  
<span class="udiff-line-modified-removed">-   if (_processed_weak_roots) {</span>
<span class="udiff-line-modified-removed">-     assert(_weak_processor_timings.max_threads() == n_workers(), &quot;Must match&quot;);</span>
<span class="udiff-line-modified-removed">-     for (uint index = 0; index &lt; WeakProcessorPhases::phase_count; index ++) {</span>
<span class="udiff-line-modified-removed">-       weak_processor_timing_to_shenandoah_timing(phase_mapping[index]._weak_processor_phase,</span>
<span class="udiff-line-modified-removed">-                                                  phase_mapping[index]._shenandoah_phase,</span>
<span class="udiff-line-modified-removed">-                                                  worker_times);</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-modified-added">+ void ShenandoahSerialRoots::oops_do(OopClosure* cl, uint worker_id) {</span>
<span class="udiff-line-modified-added">+   _universe_root.oops_do(cl, worker_id);</span>
<span class="udiff-line-modified-added">+   _object_synchronizer_root.oops_do(cl, worker_id);</span>
<span class="udiff-line-modified-added">+   _management_root.oops_do(cl, worker_id);</span>
<span class="udiff-line-modified-added">+   _system_dictionary_root.oops_do(cl, worker_id);</span>
<span class="udiff-line-modified-added">+   _jvmti_root.oops_do(cl, worker_id);</span>
<span class="udiff-line-modified-added">+ }</span>
  
<span class="udiff-line-modified-removed">-   ShenandoahHeap::heap()-&gt;phase_timings()-&gt;record_workers_end(_phase);</span>
<span class="udiff-line-modified-added">+ ShenandoahWeakSerialRoot::ShenandoahWeakSerialRoot(ShenandoahWeakSerialRoot::WeakOopsDo weak_oops_do, ShenandoahPhaseTimings::GCParPhases phase) :</span>
<span class="udiff-line-added">+   _weak_oops_do(weak_oops_do), _phase(phase) {</span>
  }
  
<span class="udiff-line-modified-removed">- void ShenandoahRootProcessor::weak_processor_timing_to_shenandoah_timing(const WeakProcessorPhases::Phase wpp,</span>
<span class="udiff-line-modified-removed">-                                                                          const ShenandoahPhaseTimings::GCParPhases spp,</span>
<span class="udiff-line-modified-removed">-                                                                          ShenandoahWorkerTimings* worker_times) const {</span>
<span class="udiff-line-modified-removed">-   if (WeakProcessorPhases::is_serial(wpp)) {</span>
<span class="udiff-line-modified-removed">-     worker_times-&gt;record_time_secs(spp, 0, _weak_processor_timings.phase_time_sec(wpp));</span>
<span class="udiff-line-removed">-   } else {</span>
<span class="udiff-line-removed">-     for (uint index = 0; index &lt; _weak_processor_timings.max_threads(); index ++) {</span>
<span class="udiff-line-removed">-       worker_times-&gt;record_time_secs(spp, index, _weak_processor_timings.worker_time_sec(index, wpp));</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-modified-added">+ void ShenandoahWeakSerialRoot::weak_oops_do(BoolObjectClosure* is_alive, OopClosure* keep_alive, uint worker_id) {</span>
<span class="udiff-line-modified-added">+   if (_claimed.try_set()) {</span>
<span class="udiff-line-modified-added">+     ShenandoahWorkerTimings* worker_times = ShenandoahHeap::heap()-&gt;phase_timings()-&gt;worker_times();</span>
<span class="udiff-line-modified-added">+     ShenandoahWorkerTimingsTracker timer(worker_times, _phase, worker_id);</span>
<span class="udiff-line-modified-added">+     _weak_oops_do(is_alive, keep_alive);</span>
    }
  }
  
<span class="udiff-line-modified-removed">- void ShenandoahRootProcessor::process_all_roots_slow(OopClosure* oops) {</span>
<span class="udiff-line-modified-removed">-   CLDToOopClosure clds(oops, ClassLoaderData::_claim_strong);</span>
<span class="udiff-line-modified-removed">-   CodeBlobToOopClosure blobs(oops, !CodeBlobToOopClosure::FixRelocations);</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-   CodeCache::blobs_do(&amp;blobs);</span>
<span class="udiff-line-removed">-   ClassLoaderDataGraph::cld_do(&amp;clds);</span>
<span class="udiff-line-removed">-   Universe::oops_do(oops);</span>
<span class="udiff-line-removed">-   Management::oops_do(oops);</span>
<span class="udiff-line-removed">-   JvmtiExport::oops_do(oops);</span>
<span class="udiff-line-removed">-   JNIHandles::oops_do(oops);</span>
<span class="udiff-line-removed">-   WeakProcessor::oops_do(oops);</span>
<span class="udiff-line-removed">-   ObjectSynchronizer::oops_do(oops);</span>
<span class="udiff-line-removed">-   SystemDictionary::oops_do(oops);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   if (ShenandoahStringDedup::is_enabled()) {</span>
<span class="udiff-line-removed">-     ShenandoahStringDedup::oops_do_slow(oops);</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-modified-added">+ #if INCLUDE_JVMTI</span>
<span class="udiff-line-modified-added">+ ShenandoahJVMTIWeakRoot::ShenandoahJVMTIWeakRoot() :</span>
<span class="udiff-line-modified-added">+   ShenandoahWeakSerialRoot(&amp;JvmtiExport::weak_oops_do, ShenandoahPhaseTimings::JVMTIWeakRoots) {</span>
<span class="udiff-line-modified-added">+ }</span>
<span class="udiff-line-modified-added">+ #endif // INCLUDE_JVMTI</span>
  
<span class="udiff-line-modified-removed">-   // Do thread roots the last. This allows verification code to find</span>
<span class="udiff-line-modified-removed">-   // any broken objects from those special roots first, not the accidental</span>
<span class="udiff-line-modified-removed">-   // dangling reference from the thread root.</span>
<span class="udiff-line-removed">-   Threads::possibly_parallel_oops_do(false, oops, &amp;blobs);</span>
<span class="udiff-line-modified-added">+ #if INCLUDE_JFR</span>
<span class="udiff-line-modified-added">+ ShenandoahJFRWeakRoot::ShenandoahJFRWeakRoot() :</span>
<span class="udiff-line-modified-added">+   ShenandoahWeakSerialRoot(&amp;Jfr::weak_oops_do, ShenandoahPhaseTimings::JFRWeakRoots) {</span>
  }
<span class="udiff-line-added">+ #endif // INCLUDE_JFR</span>
  
<span class="udiff-line-modified-removed">- void ShenandoahRootProcessor::process_strong_roots(OopClosure* oops,</span>
<span class="udiff-line-modified-removed">-                                                    OopClosure* weak_oops,</span>
<span class="udiff-line-modified-removed">-                                                    CLDClosure* clds,</span>
<span class="udiff-line-modified-removed">-                                                    CLDClosure* weak_clds,</span>
<span class="udiff-line-modified-removed">-                                                    CodeBlobClosure* blobs,</span>
<span class="udiff-line-removed">-                                                    ThreadClosure* thread_cl,</span>
<span class="udiff-line-removed">-                                                    uint worker_id) {</span>
<span class="udiff-line-modified-added">+ #if INCLUDE_TSAN</span>
<span class="udiff-line-modified-added">+ ShenandoahTSANWeakRoot::ShenandoahTSANWeakRoot() :</span>
<span class="udiff-line-modified-added">+   ShenandoahWeakSerialRoot(&amp;TsanOopMap::weak_oops_do, ShenandoahPhaseTimings::TSANWeakRoots) {</span>
<span class="udiff-line-modified-added">+ }</span>
<span class="udiff-line-modified-added">+ #endif // INCLUDE_TSAN</span>
  
<span class="udiff-line-modified-removed">-   process_java_roots(oops, clds, weak_clds, blobs, thread_cl, worker_id);</span>
<span class="udiff-line-modified-removed">-   process_vm_roots(oops, NULL, weak_oops, worker_id);</span>
<span class="udiff-line-modified-added">+ void ShenandoahSerialWeakRoots::weak_oops_do(BoolObjectClosure* is_alive, OopClosure* keep_alive, uint worker_id) {</span>
<span class="udiff-line-modified-added">+   JVMTI_ONLY(_jvmti_weak_roots.weak_oops_do(is_alive, keep_alive, worker_id);)</span>
<span class="udiff-line-added">+   JFR_ONLY(_jfr_weak_roots.weak_oops_do(is_alive, keep_alive, worker_id);)</span>
<span class="udiff-line-added">+   TSAN_ONLY(_tsan_weak_roots.weak_oops_do(is_alive, keep_alive, worker_id);)</span>
<span class="udiff-line-added">+ }</span>
  
<span class="udiff-line-modified-removed">-   _process_strong_tasks-&gt;all_tasks_completed(n_workers());</span>
<span class="udiff-line-modified-added">+ void ShenandoahSerialWeakRoots::weak_oops_do(OopClosure* cl, uint worker_id) {</span>
<span class="udiff-line-added">+   AlwaysTrueClosure always_true;</span>
<span class="udiff-line-added">+   weak_oops_do(&amp;always_true, cl, worker_id);</span>
  }
  
<span class="udiff-line-modified-removed">- void ShenandoahRootProcessor::process_all_roots(OopClosure* oops,</span>
<span class="udiff-line-modified-removed">-                                                 OopClosure* weak_oops,</span>
<span class="udiff-line-modified-removed">-                                                 CLDClosure* clds,</span>
<span class="udiff-line-removed">-                                                 CodeBlobClosure* blobs,</span>
<span class="udiff-line-removed">-                                                 ThreadClosure* thread_cl,</span>
<span class="udiff-line-removed">-                                                 uint worker_id) {</span>
<span class="udiff-line-modified-added">+ ShenandoahThreadRoots::ShenandoahThreadRoots(bool is_par) : _is_par(is_par) {</span>
<span class="udiff-line-modified-added">+   Threads::change_thread_claim_token();</span>
<span class="udiff-line-modified-added">+ }</span>
  
<span class="udiff-line-added">+ void ShenandoahThreadRoots::oops_do(OopClosure* oops_cl, CodeBlobClosure* code_cl, uint worker_id) {</span>
    ShenandoahWorkerTimings* worker_times = ShenandoahHeap::heap()-&gt;phase_timings()-&gt;worker_times();
<span class="udiff-line-modified-removed">-   process_java_roots(oops, clds, clds, blobs, thread_cl, worker_id);</span>
<span class="udiff-line-modified-removed">-   process_vm_roots(oops, oops, weak_oops, worker_id);</span>
<span class="udiff-line-modified-added">+   ShenandoahWorkerTimingsTracker timer(worker_times, ShenandoahPhaseTimings::ThreadRoots, worker_id);</span>
<span class="udiff-line-modified-added">+   ResourceMark rm;</span>
<span class="udiff-line-added">+   Threads::possibly_parallel_oops_do(_is_par, oops_cl, code_cl);</span>
<span class="udiff-line-added">+ }</span>
  
<span class="udiff-line-modified-removed">-   if (blobs != NULL) {</span>
<span class="udiff-line-modified-removed">-     ShenandoahWorkerTimingsTracker timer(worker_times, ShenandoahPhaseTimings::CodeCacheRoots, worker_id);</span>
<span class="udiff-line-modified-removed">-     _coderoots_all_iterator.possibly_parallel_blobs_do(blobs);</span>
<span class="udiff-line-modified-removed">-   }</span>
<span class="udiff-line-modified-added">+ void ShenandoahThreadRoots::threads_do(ThreadClosure* tc, uint worker_id) {</span>
<span class="udiff-line-modified-added">+   ShenandoahWorkerTimings* worker_times = ShenandoahHeap::heap()-&gt;phase_timings()-&gt;worker_times();</span>
<span class="udiff-line-modified-added">+   ShenandoahWorkerTimingsTracker timer(worker_times, ShenandoahPhaseTimings::ThreadRoots, worker_id);</span>
<span class="udiff-line-modified-added">+   ResourceMark rm;</span>
<span class="udiff-line-added">+   Threads::possibly_parallel_threads_do(_is_par, tc);</span>
<span class="udiff-line-added">+ }</span>
  
<span class="udiff-line-modified-removed">-   _process_strong_tasks-&gt;all_tasks_completed(n_workers());</span>
<span class="udiff-line-modified-added">+ ShenandoahThreadRoots::~ShenandoahThreadRoots() {</span>
<span class="udiff-line-added">+   Threads::assert_all_threads_claimed();</span>
  }
  
<span class="udiff-line-modified-removed">- class ShenandoahParallelOopsDoThreadClosure : public ThreadClosure {</span>
<span class="udiff-line-modified-removed">- private:</span>
<span class="udiff-line-modified-removed">-   OopClosure* _f;</span>
<span class="udiff-line-removed">-   CodeBlobClosure* _cf;</span>
<span class="udiff-line-removed">-   ThreadClosure* _thread_cl;</span>
<span class="udiff-line-removed">- public:</span>
<span class="udiff-line-removed">-   ShenandoahParallelOopsDoThreadClosure(OopClosure* f, CodeBlobClosure* cf, ThreadClosure* thread_cl) :</span>
<span class="udiff-line-removed">-     _f(f), _cf(cf), _thread_cl(thread_cl) {}</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   void do_thread(Thread* t) {</span>
<span class="udiff-line-removed">-     if (_thread_cl != NULL) {</span>
<span class="udiff-line-removed">-       _thread_cl-&gt;do_thread(t);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-     t-&gt;oops_do(_f, _cf);</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">- };</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- void ShenandoahRootProcessor::process_java_roots(OopClosure* strong_roots,</span>
<span class="udiff-line-removed">-                                                  CLDClosure* strong_clds,</span>
<span class="udiff-line-removed">-                                                  CLDClosure* weak_clds,</span>
<span class="udiff-line-removed">-                                                  CodeBlobClosure* strong_code,</span>
<span class="udiff-line-removed">-                                                  ThreadClosure* thread_cl,</span>
<span class="udiff-line-removed">-                                                  uint worker_id)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-   ShenandoahWorkerTimings* worker_times = ShenandoahHeap::heap()-&gt;phase_timings()-&gt;worker_times();</span>
<span class="udiff-line-removed">-   // Iterating over the CLDG and the Threads are done early to allow us to</span>
<span class="udiff-line-removed">-   // first process the strong CLDs and nmethods and then, after a barrier,</span>
<span class="udiff-line-removed">-   // let the thread process the weak CLDs and nmethods.</span>
<span class="udiff-line-removed">-   {</span>
<span class="udiff-line-removed">-     ShenandoahWorkerTimingsTracker timer(worker_times, ShenandoahPhaseTimings::CLDGRoots, worker_id);</span>
<span class="udiff-line-removed">-     _cld_iterator.root_cld_do(strong_clds, weak_clds);</span>
<span class="udiff-line-modified-added">+ ShenandoahStringDedupRoots::ShenandoahStringDedupRoots() {</span>
<span class="udiff-line-modified-added">+   if (ShenandoahStringDedup::is_enabled()) {</span>
<span class="udiff-line-modified-added">+     StringDedup::gc_prologue(false);</span>
    }
<span class="udiff-line-added">+ }</span>
  
<span class="udiff-line-modified-removed">-   {</span>
<span class="udiff-line-modified-removed">-     ShenandoahWorkerTimingsTracker timer(worker_times, ShenandoahPhaseTimings::ThreadRoots, worker_id);</span>
<span class="udiff-line-modified-removed">-     bool is_par = n_workers() &gt; 1;</span>
<span class="udiff-line-removed">-     ResourceMark rm;</span>
<span class="udiff-line-removed">-     ShenandoahParallelOopsDoThreadClosure cl(strong_roots, strong_code, thread_cl);</span>
<span class="udiff-line-removed">-     Threads::possibly_parallel_threads_do(is_par, &amp;cl);</span>
<span class="udiff-line-modified-added">+ ShenandoahStringDedupRoots::~ShenandoahStringDedupRoots() {</span>
<span class="udiff-line-modified-added">+   if (ShenandoahStringDedup::is_enabled()) {</span>
<span class="udiff-line-modified-added">+     StringDedup::gc_epilogue();</span>
    }
  }
  
<span class="udiff-line-modified-removed">- void ShenandoahRootProcessor::process_vm_roots(OopClosure* strong_roots,</span>
<span class="udiff-line-modified-removed">-                                                OopClosure* weak_roots,</span>
<span class="udiff-line-modified-removed">-                                                OopClosure* jni_weak_roots,</span>
<span class="udiff-line-removed">-                                                uint worker_id)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-   ShenandoahWorkerTimings* worker_times = ShenandoahHeap::heap()-&gt;phase_timings()-&gt;worker_times();</span>
<span class="udiff-line-removed">-   if (_process_strong_tasks-&gt;try_claim_task(SHENANDOAH_RP_PS_Universe_oops_do)) {</span>
<span class="udiff-line-removed">-     ShenandoahWorkerTimingsTracker timer(worker_times, ShenandoahPhaseTimings::UniverseRoots, worker_id);</span>
<span class="udiff-line-removed">-     Universe::oops_do(strong_roots);</span>
<span class="udiff-line-modified-added">+ void ShenandoahStringDedupRoots::oops_do(BoolObjectClosure* is_alive, OopClosure* keep_alive, uint worker_id) {</span>
<span class="udiff-line-modified-added">+   if (ShenandoahStringDedup::is_enabled()) {</span>
<span class="udiff-line-modified-added">+     ShenandoahStringDedup::parallel_oops_do(is_alive, keep_alive, worker_id);</span>
    }
<span class="udiff-line-added">+ }</span>
  
<span class="udiff-line-modified-removed">-   if (_process_strong_tasks-&gt;try_claim_task(SHENANDOAH_RP_PS_JNIHandles_oops_do)) {</span>
<span class="udiff-line-modified-removed">-     ShenandoahWorkerTimingsTracker timer(worker_times, ShenandoahPhaseTimings::JNIRoots, worker_id);</span>
<span class="udiff-line-modified-removed">-     JNIHandles::oops_do(strong_roots);</span>
<span class="udiff-line-modified-removed">-   }</span>
<span class="udiff-line-modified-removed">-   if (_process_strong_tasks-&gt;try_claim_task(SHENANDOAH_RP_PS_Management_oops_do)) {</span>
<span class="udiff-line-removed">-     ShenandoahWorkerTimingsTracker timer(worker_times, ShenandoahPhaseTimings::ManagementRoots, worker_id);</span>
<span class="udiff-line-removed">-     Management::oops_do(strong_roots);</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">-   if (_process_strong_tasks-&gt;try_claim_task(SHENANDOAH_RP_PS_jvmti_oops_do)) {</span>
<span class="udiff-line-removed">-     ShenandoahWorkerTimingsTracker timer(worker_times, ShenandoahPhaseTimings::JVMTIRoots, worker_id);</span>
<span class="udiff-line-removed">-     JvmtiExport::oops_do(strong_roots);</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">-   if (_process_strong_tasks-&gt;try_claim_task(SHENANDOAH_RP_PS_SystemDictionary_oops_do)) {</span>
<span class="udiff-line-removed">-     ShenandoahWorkerTimingsTracker timer(worker_times, ShenandoahPhaseTimings::SystemDictionaryRoots, worker_id);</span>
<span class="udiff-line-removed">-     SystemDictionary::oops_do(strong_roots);</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">-   if (jni_weak_roots != NULL) {</span>
<span class="udiff-line-removed">-     AlwaysTrueClosure always_true;</span>
<span class="udiff-line-removed">-     _weak_processor_task.work&lt;AlwaysTrueClosure, OopClosure&gt;(worker_id, &amp;always_true, jni_weak_roots);</span>
<span class="udiff-line-removed">-     _processed_weak_roots = true;</span>
<span class="udiff-line-modified-added">+ ShenandoahConcurrentStringDedupRoots::ShenandoahConcurrentStringDedupRoots() {</span>
<span class="udiff-line-modified-added">+   if (ShenandoahStringDedup::is_enabled()) {</span>
<span class="udiff-line-modified-added">+     StringDedupTable_lock-&gt;lock_without_safepoint_check();</span>
<span class="udiff-line-modified-added">+     StringDedupQueue_lock-&gt;lock_without_safepoint_check();</span>
<span class="udiff-line-modified-added">+     StringDedup::gc_prologue(true);</span>
    }
<span class="udiff-line-added">+ }</span>
  
<span class="udiff-line-modified-removed">-   if (ShenandoahStringDedup::is_enabled() &amp;&amp; weak_roots != NULL) {</span>
<span class="udiff-line-modified-removed">-     ShenandoahStringDedup::parallel_oops_do(weak_roots, worker_id);</span>
<span class="udiff-line-modified-added">+ ShenandoahConcurrentStringDedupRoots::~ShenandoahConcurrentStringDedupRoots() {</span>
<span class="udiff-line-modified-added">+   if (ShenandoahStringDedup::is_enabled()) {</span>
<span class="udiff-line-added">+     StringDedup::gc_epilogue();</span>
<span class="udiff-line-added">+     StringDedupQueue_lock-&gt;unlock();</span>
<span class="udiff-line-added">+     StringDedupTable_lock-&gt;unlock();</span>
    }
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void ShenandoahConcurrentStringDedupRoots::oops_do(BoolObjectClosure* is_alive, OopClosure* keep_alive, uint worker_id) {</span>
<span class="udiff-line-added">+   if (ShenandoahStringDedup::is_enabled()) {</span>
<span class="udiff-line-added">+     assert_locked_or_safepoint_weak(StringDedupQueue_lock);</span>
<span class="udiff-line-added">+     assert_locked_or_safepoint_weak(StringDedupTable_lock);</span>
  
<span class="udiff-line-modified-removed">-   {</span>
<span class="udiff-line-modified-removed">-     ShenandoahWorkerTimingsTracker timer(worker_times, ShenandoahPhaseTimings::ObjectSynchronizerRoots, worker_id);</span>
<span class="udiff-line-modified-removed">-     if (_process_strong_tasks-&gt;try_claim_task(SHENANDOAH_RP_PS_ObjectSynchronizer_oops_do)) {</span>
<span class="udiff-line-removed">-       ObjectSynchronizer::oops_do(strong_roots);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-modified-added">+     StringDedupUnlinkOrOopsDoClosure sd_cl(is_alive, keep_alive);</span>
<span class="udiff-line-modified-added">+     StringDedupQueue::unlink_or_oops_do(&amp;sd_cl);</span>
<span class="udiff-line-modified-added">+     StringDedupTable::unlink_or_oops_do(&amp;sd_cl, worker_id);</span>
    }
  }
  
<span class="udiff-line-modified-removed">- uint ShenandoahRootProcessor::n_workers() const {</span>
<span class="udiff-line-modified-removed">-   return _srs.n_threads();</span>
<span class="udiff-line-modified-added">+ ShenandoahRootProcessor::ShenandoahRootProcessor(ShenandoahPhaseTimings::Phase phase) :</span>
<span class="udiff-line-modified-added">+   _heap(ShenandoahHeap::heap()),</span>
<span class="udiff-line-added">+   _phase(phase) {</span>
<span class="udiff-line-added">+   assert(SafepointSynchronize::is_at_safepoint(), &quot;Must at safepoint&quot;);</span>
<span class="udiff-line-added">+   _heap-&gt;phase_timings()-&gt;record_workers_start(_phase);</span>
  }
  
<span class="udiff-line-modified-removed">- ShenandoahRootEvacuator::ShenandoahRootEvacuator(ShenandoahHeap* heap, uint n_workers, ShenandoahPhaseTimings::Phase phase) :</span>
<span class="udiff-line-modified-removed">-   _evacuation_tasks(new SubTasksDone(SHENANDOAH_EVAC_NumElements)),</span>
<span class="udiff-line-modified-removed">-   _srs(n_workers),</span>
<span class="udiff-line-removed">-   _phase(phase),</span>
<span class="udiff-line-removed">-   _coderoots_cset_iterator(ShenandoahCodeRoots::cset_iterator())</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-   heap-&gt;phase_timings()-&gt;record_workers_start(_phase);</span>
<span class="udiff-line-modified-added">+ ShenandoahRootProcessor::~ShenandoahRootProcessor() {</span>
<span class="udiff-line-modified-added">+   assert(SafepointSynchronize::is_at_safepoint(), &quot;Must at safepoint&quot;);</span>
<span class="udiff-line-modified-added">+   _heap-&gt;phase_timings()-&gt;record_workers_end(_phase);</span>
  }
  
<span class="udiff-line-modified-removed">- ShenandoahRootEvacuator::~ShenandoahRootEvacuator() {</span>
<span class="udiff-line-modified-removed">-   delete _evacuation_tasks;</span>
<span class="udiff-line-modified-removed">-   ShenandoahHeap::heap()-&gt;phase_timings()-&gt;record_workers_end(_phase);</span>
<span class="udiff-line-modified-added">+ ShenandoahRootEvacuator::ShenandoahRootEvacuator(uint n_workers,</span>
<span class="udiff-line-modified-added">+                                                  ShenandoahPhaseTimings::Phase phase,</span>
<span class="udiff-line-modified-added">+                                                  bool include_concurrent_roots,</span>
<span class="udiff-line-added">+                                                  bool include_concurrent_code_roots) :</span>
<span class="udiff-line-added">+   ShenandoahRootProcessor(phase),</span>
<span class="udiff-line-added">+   _thread_roots(n_workers &gt; 1),</span>
<span class="udiff-line-added">+   _include_concurrent_roots(include_concurrent_roots),</span>
<span class="udiff-line-added">+   _include_concurrent_code_roots(include_concurrent_code_roots) {</span>
  }
  
<span class="udiff-line-modified-removed">- void ShenandoahRootEvacuator::process_evacuate_roots(OopClosure* oops,</span>
<span class="udiff-line-modified-removed">-                                                      CodeBlobClosure* blobs,</span>
<span class="udiff-line-modified-removed">-                                                      uint worker_id) {</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-   ShenandoahWorkerTimings* worker_times = ShenandoahHeap::heap()-&gt;phase_timings()-&gt;worker_times();</span>
<span class="udiff-line-modified-removed">-   {</span>
<span class="udiff-line-modified-removed">-     bool is_par = n_workers() &gt; 1;</span>
<span class="udiff-line-modified-removed">-     ResourceMark rm;</span>
<span class="udiff-line-modified-removed">-     ShenandoahWorkerTimingsTracker timer(worker_times, ShenandoahPhaseTimings::ThreadRoots, worker_id);</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-     Threads::possibly_parallel_oops_do(is_par, oops, NULL);</span>
<span class="udiff-line-modified-removed">-   }</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-   if (blobs != NULL) {</span>
<span class="udiff-line-modified-removed">-     ShenandoahWorkerTimingsTracker timer(worker_times, ShenandoahPhaseTimings::CodeCacheRoots, worker_id);</span>
<span class="udiff-line-modified-removed">-     _coderoots_cset_iterator.possibly_parallel_blobs_do(blobs);</span>
<span class="udiff-line-modified-added">+ void ShenandoahRootEvacuator::roots_do(uint worker_id, OopClosure* oops) {</span>
<span class="udiff-line-modified-added">+   MarkingCodeBlobClosure blobsCl(oops, CodeBlobToOopClosure::FixRelocations);</span>
<span class="udiff-line-modified-added">+   ShenandoahCodeBlobAndDisarmClosure blobs_and_disarm_Cl(oops);</span>
<span class="udiff-line-modified-added">+   CodeBlobToOopClosure* codes_cl = ShenandoahConcurrentRoots::can_do_concurrent_class_unloading() ?</span>
<span class="udiff-line-modified-added">+                                    static_cast&lt;CodeBlobToOopClosure*&gt;(&amp;blobs_and_disarm_Cl) :</span>
<span class="udiff-line-modified-added">+                                    static_cast&lt;CodeBlobToOopClosure*&gt;(&amp;blobsCl);</span>
<span class="udiff-line-modified-added">+   AlwaysTrueClosure always_true;</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+   _serial_roots.oops_do(oops, worker_id);</span>
<span class="udiff-line-modified-added">+   _serial_weak_roots.weak_oops_do(oops, worker_id);</span>
<span class="udiff-line-modified-added">+   if (_include_concurrent_roots) {</span>
<span class="udiff-line-modified-added">+     CLDToOopClosure clds(oops, ClassLoaderData::_claim_strong);</span>
<span class="udiff-line-modified-added">+     _vm_roots.oops_do&lt;OopClosure&gt;(oops, worker_id);</span>
<span class="udiff-line-modified-added">+     _cld_roots.cld_do(&amp;clds, worker_id);</span>
<span class="udiff-line-modified-added">+     _weak_roots.oops_do&lt;OopClosure&gt;(oops, worker_id);</span>
<span class="udiff-line-modified-added">+     _dedup_roots.oops_do(&amp;always_true, oops, worker_id);</span>
    }
  
<span class="udiff-line-modified-removed">-   if (_evacuation_tasks-&gt;try_claim_task(SHENANDOAH_EVAC_jvmti_oops_do)) {</span>
<span class="udiff-line-modified-removed">-     ShenandoahForwardedIsAliveClosure is_alive;</span>
<span class="udiff-line-modified-removed">-     ShenandoahWorkerTimingsTracker timer(worker_times, ShenandoahPhaseTimings::JVMTIRoots, worker_id);</span>
<span class="udiff-line-modified-removed">-     JvmtiExport::weak_oops_do(&amp;is_alive, oops);</span>
<span class="udiff-line-modified-added">+   if (_include_concurrent_code_roots) {</span>
<span class="udiff-line-modified-added">+     _code_roots.code_blobs_do(codes_cl, worker_id);</span>
<span class="udiff-line-modified-added">+     _thread_roots.oops_do(oops, NULL, worker_id);</span>
<span class="udiff-line-modified-added">+   } else {</span>
<span class="udiff-line-added">+     _thread_roots.oops_do(oops, codes_cl, worker_id);</span>
    }
  }
  
<span class="udiff-line-modified-removed">- uint ShenandoahRootEvacuator::n_workers() const {</span>
<span class="udiff-line-modified-removed">-   return _srs.n_threads();</span>
<span class="udiff-line-modified-added">+ ShenandoahRootUpdater::ShenandoahRootUpdater(uint n_workers, ShenandoahPhaseTimings::Phase phase) :</span>
<span class="udiff-line-modified-added">+   ShenandoahRootProcessor(phase),</span>
<span class="udiff-line-added">+   _thread_roots(n_workers &gt; 1) {</span>
  }
  
<span class="udiff-line-modified-removed">- // Implemenation of ParallelCLDRootIterator</span>
<span class="udiff-line-modified-removed">- ParallelCLDRootIterator::ParallelCLDRootIterator() {</span>
<span class="udiff-line-modified-removed">-   assert(SafepointSynchronize::is_at_safepoint(), &quot;Must at safepoint&quot;);</span>
<span class="udiff-line-modified-removed">-   ClassLoaderDataGraph::clear_claimed_marks();</span>
<span class="udiff-line-modified-added">+ ShenandoahRootAdjuster::ShenandoahRootAdjuster(uint n_workers, ShenandoahPhaseTimings::Phase phase) :</span>
<span class="udiff-line-modified-added">+   ShenandoahRootProcessor(phase),</span>
<span class="udiff-line-modified-added">+   _thread_roots(n_workers &gt; 1) {</span>
<span class="udiff-line-modified-added">+   assert(ShenandoahHeap::heap()-&gt;is_full_gc_in_progress(), &quot;Full GC only&quot;);</span>
  }
  
<span class="udiff-line-modified-removed">- void ParallelCLDRootIterator::root_cld_do(CLDClosure* strong, CLDClosure* weak) {</span>
<span class="udiff-line-modified-removed">-     ClassLoaderDataGraph::roots_cld_do(strong, weak);</span>
<span class="udiff-line-modified-added">+ void ShenandoahRootAdjuster::roots_do(uint worker_id, OopClosure* oops) {</span>
<span class="udiff-line-modified-added">+   CodeBlobToOopClosure code_blob_cl(oops, CodeBlobToOopClosure::FixRelocations);</span>
<span class="udiff-line-added">+   ShenandoahCodeBlobAndDisarmClosure blobs_and_disarm_Cl(oops);</span>
<span class="udiff-line-added">+   CodeBlobToOopClosure* adjust_code_closure = ShenandoahConcurrentRoots::can_do_concurrent_class_unloading() ?</span>
<span class="udiff-line-added">+                                               static_cast&lt;CodeBlobToOopClosure*&gt;(&amp;blobs_and_disarm_Cl) :</span>
<span class="udiff-line-added">+                                               static_cast&lt;CodeBlobToOopClosure*&gt;(&amp;code_blob_cl);</span>
<span class="udiff-line-added">+   CLDToOopClosure adjust_cld_closure(oops, ClassLoaderData::_claim_strong);</span>
<span class="udiff-line-added">+   AlwaysTrueClosure always_true;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   _serial_roots.oops_do(oops, worker_id);</span>
<span class="udiff-line-added">+   _vm_roots.oops_do(oops, worker_id);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   _thread_roots.oops_do(oops, NULL, worker_id);</span>
<span class="udiff-line-added">+   _cld_roots.cld_do(&amp;adjust_cld_closure, worker_id);</span>
<span class="udiff-line-added">+   _code_roots.code_blobs_do(adjust_code_closure, worker_id);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   _serial_weak_roots.weak_oops_do(oops, worker_id);</span>
<span class="udiff-line-added">+   _weak_roots.oops_do&lt;OopClosure&gt;(oops, worker_id);</span>
<span class="udiff-line-added">+   _dedup_roots.oops_do(&amp;always_true, oops, worker_id);</span>
  }
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+  ShenandoahHeapIterationRootScanner::ShenandoahHeapIterationRootScanner() :</span>
<span class="udiff-line-added">+    ShenandoahRootProcessor(ShenandoahPhaseTimings::_num_phases),</span>
<span class="udiff-line-added">+    _thread_roots(false /*is par*/) {</span>
<span class="udiff-line-added">+  }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+  void ShenandoahHeapIterationRootScanner::roots_do(OopClosure* oops) {</span>
<span class="udiff-line-added">+    assert(Thread::current()-&gt;is_VM_thread(), &quot;Only by VM thread&quot;);</span>
<span class="udiff-line-added">+    // Must use _claim_none to avoid interfering with concurrent CLDG iteration</span>
<span class="udiff-line-added">+    CLDToOopClosure clds(oops, ClassLoaderData::_claim_none);</span>
<span class="udiff-line-added">+    MarkingCodeBlobClosure code(oops, !CodeBlobToOopClosure::FixRelocations);</span>
<span class="udiff-line-added">+    ShenandoahParallelOopsDoThreadClosure tc_cl(oops, &amp;code, NULL);</span>
<span class="udiff-line-added">+    AlwaysTrueClosure always_true;</span>
<span class="udiff-line-added">+    ResourceMark rm;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+    _serial_roots.oops_do(oops, 0);</span>
<span class="udiff-line-added">+    _vm_roots.oops_do(oops, 0);</span>
<span class="udiff-line-added">+    _cld_roots.cld_do(&amp;clds, 0);</span>
<span class="udiff-line-added">+    _thread_roots.threads_do(&amp;tc_cl, 0);</span>
<span class="udiff-line-added">+    _code_roots.code_blobs_do(&amp;code, 0);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+    _serial_weak_roots.weak_oops_do(oops, 0);</span>
<span class="udiff-line-added">+    _weak_roots.oops_do&lt;OopClosure&gt;(oops, 0);</span>
<span class="udiff-line-added">+    _dedup_roots.oops_do(&amp;always_true, oops, 0);</span>
<span class="udiff-line-added">+  }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+  void ShenandoahHeapIterationRootScanner::strong_roots_do(OopClosure* oops) {</span>
<span class="udiff-line-added">+    assert(Thread::current()-&gt;is_VM_thread(), &quot;Only by VM thread&quot;);</span>
<span class="udiff-line-added">+    // Must use _claim_none to avoid interfering with concurrent CLDG iteration</span>
<span class="udiff-line-added">+    CLDToOopClosure clds(oops, ClassLoaderData::_claim_none);</span>
<span class="udiff-line-added">+    MarkingCodeBlobClosure code(oops, !CodeBlobToOopClosure::FixRelocations);</span>
<span class="udiff-line-added">+    ShenandoahParallelOopsDoThreadClosure tc_cl(oops, &amp;code, NULL);</span>
<span class="udiff-line-added">+    ResourceMark rm;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+    _serial_roots.oops_do(oops, 0);</span>
<span class="udiff-line-added">+    _vm_roots.oops_do(oops, 0);</span>
<span class="udiff-line-added">+    _cld_roots.always_strong_cld_do(&amp;clds, 0);</span>
<span class="udiff-line-added">+    _thread_roots.threads_do(&amp;tc_cl, 0);</span>
<span class="udiff-line-added">+  }</span>
</pre>
<center><a href="shenandoahPhaseTimings.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="shenandoahRootProcessor.hpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>