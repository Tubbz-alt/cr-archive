<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/share/interpreter/interpreterRuntime.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="../include/jvm.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="../oops/cpCache.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/interpreter/interpreterRuntime.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
   1 /*
<span class="line-modified">   2  * Copyright (c) 1997, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;classfile/javaClasses.inline.hpp&quot;

  27 #include &quot;classfile/systemDictionary.hpp&quot;
  28 #include &quot;classfile/vmSymbols.hpp&quot;
  29 #include &quot;code/codeCache.hpp&quot;

  30 #include &quot;compiler/compileBroker.hpp&quot;
  31 #include &quot;compiler/disassembler.hpp&quot;
  32 #include &quot;gc/shared/barrierSetNMethod.hpp&quot;
  33 #include &quot;gc/shared/collectedHeap.hpp&quot;
  34 #include &quot;interpreter/interpreter.hpp&quot;
  35 #include &quot;interpreter/interpreterRuntime.hpp&quot;
  36 #include &quot;interpreter/linkResolver.hpp&quot;
  37 #include &quot;interpreter/templateTable.hpp&quot;
  38 #include &quot;logging/log.hpp&quot;
  39 #include &quot;memory/oopFactory.hpp&quot;
  40 #include &quot;memory/resourceArea.hpp&quot;
  41 #include &quot;memory/universe.hpp&quot;
  42 #include &quot;oops/constantPool.hpp&quot;
  43 #include &quot;oops/cpCache.inline.hpp&quot;
  44 #include &quot;oops/instanceKlass.hpp&quot;
  45 #include &quot;oops/methodData.hpp&quot;
  46 #include &quot;oops/objArrayKlass.hpp&quot;
  47 #include &quot;oops/objArrayOop.inline.hpp&quot;
  48 #include &quot;oops/oop.inline.hpp&quot;
  49 #include &quot;oops/symbol.hpp&quot;
  50 #include &quot;prims/jvmtiExport.hpp&quot;
  51 #include &quot;prims/nativeLookup.hpp&quot;
  52 #include &quot;runtime/atomic.hpp&quot;
  53 #include &quot;runtime/biasedLocking.hpp&quot;
<span class="line-removed">  54 #include &quot;runtime/compilationPolicy.hpp&quot;</span>
  55 #include &quot;runtime/deoptimization.hpp&quot;
  56 #include &quot;runtime/fieldDescriptor.inline.hpp&quot;
  57 #include &quot;runtime/frame.inline.hpp&quot;
  58 #include &quot;runtime/handles.inline.hpp&quot;
  59 #include &quot;runtime/icache.hpp&quot;
  60 #include &quot;runtime/interfaceSupport.inline.hpp&quot;
  61 #include &quot;runtime/java.hpp&quot;
  62 #include &quot;runtime/javaCalls.hpp&quot;
  63 #include &quot;runtime/jfieldIDWorkaround.hpp&quot;
  64 #include &quot;runtime/osThread.hpp&quot;
  65 #include &quot;runtime/sharedRuntime.hpp&quot;
  66 #include &quot;runtime/stubRoutines.hpp&quot;
  67 #include &quot;runtime/synchronizer.hpp&quot;
  68 #include &quot;runtime/threadCritical.hpp&quot;
  69 #include &quot;utilities/align.hpp&quot;
  70 #include &quot;utilities/copy.hpp&quot;
  71 #include &quot;utilities/events.hpp&quot;
  72 #ifdef COMPILER2
  73 #include &quot;opto/runtime.hpp&quot;
  74 #endif
</pre>
<hr />
<pre>
 139 // State accessors
 140 
 141 void InterpreterRuntime::set_bcp_and_mdp(address bcp, JavaThread *thread) {
 142   LastFrameAccessor last_frame(thread);
 143   last_frame.set_bcp(bcp);
 144   if (ProfileInterpreter) {
 145     // ProfileTraps uses MDOs independently of ProfileInterpreter.
 146     // That is why we must check both ProfileInterpreter and mdo != NULL.
 147     MethodData* mdo = last_frame.method()-&gt;method_data();
 148     if (mdo != NULL) {
 149       NEEDS_CLEANUP;
 150       last_frame.set_mdp(mdo-&gt;bci_to_dp(last_frame.bci()));
 151     }
 152   }
 153 }
 154 
 155 //------------------------------------------------------------------------------------------------------------------------
 156 // Constants
 157 
 158 
<span class="line-modified"> 159 IRT_ENTRY(void, InterpreterRuntime::ldc(JavaThread* thread, bool wide))</span>
 160   // access constant pool
 161   LastFrameAccessor last_frame(thread);
 162   ConstantPool* pool = last_frame.method()-&gt;constants();
 163   int index = wide ? last_frame.get_index_u2(Bytecodes::_ldc_w) : last_frame.get_index_u1(Bytecodes::_ldc);
 164   constantTag tag = pool-&gt;tag_at(index);
 165 
 166   assert (tag.is_unresolved_klass() || tag.is_klass(), &quot;wrong ldc call&quot;);
 167   Klass* klass = pool-&gt;klass_at(index, CHECK);
 168     oop java_class = klass-&gt;java_mirror();
 169     thread-&gt;set_vm_result(java_class);
<span class="line-modified"> 170 IRT_END</span>
 171 
<span class="line-modified"> 172 IRT_ENTRY(void, InterpreterRuntime::resolve_ldc(JavaThread* thread, Bytecodes::Code bytecode)) {</span>
 173   assert(bytecode == Bytecodes::_ldc ||
 174          bytecode == Bytecodes::_ldc_w ||
 175          bytecode == Bytecodes::_ldc2_w ||
 176          bytecode == Bytecodes::_fast_aldc ||
 177          bytecode == Bytecodes::_fast_aldc_w, &quot;wrong bc&quot;);
 178   ResourceMark rm(thread);
 179   const bool is_fast_aldc = (bytecode == Bytecodes::_fast_aldc ||
 180                              bytecode == Bytecodes::_fast_aldc_w);
 181   LastFrameAccessor last_frame(thread);
 182   methodHandle m (thread, last_frame.method());
 183   Bytecode_loadconstant ldc(m, last_frame.bci());
 184 
 185   // Double-check the size.  (Condy can have any type.)
 186   BasicType type = ldc.result_type();
 187   switch (type2size[type]) {
 188   case 2: guarantee(bytecode == Bytecodes::_ldc2_w, &quot;&quot;); break;
 189   case 1: guarantee(bytecode != Bytecodes::_ldc2_w, &quot;&quot;); break;
 190   default: ShouldNotReachHere();
 191   }
 192 
 193   // Resolve the constant.  This does not do unboxing.
 194   // But it does replace Universe::the_null_sentinel by null.
 195   oop result = ldc.resolve_constant(CHECK);
 196   assert(result != NULL || is_fast_aldc, &quot;null result only valid for fast_aldc&quot;);
 197 
 198 #ifdef ASSERT
 199   {
 200     // The bytecode wrappers aren&#39;t GC-safe so construct a new one
 201     Bytecode_loadconstant ldc2(m, last_frame.bci());
 202     int rindex = ldc2.cache_index();
 203     if (rindex &lt; 0)
 204       rindex = m-&gt;constants()-&gt;cp_to_object_index(ldc2.pool_index());
 205     if (rindex &gt;= 0) {
 206       oop coop = m-&gt;constants()-&gt;resolved_references()-&gt;obj_at(rindex);
 207       oop roop = (result == NULL ? Universe::the_null_sentinel() : result);
<span class="line-modified"> 208       assert(oopDesc::equals(roop, coop), &quot;expected result for assembly code&quot;);</span>
 209     }
 210   }
 211 #endif
 212   thread-&gt;set_vm_result(result);
 213   if (!is_fast_aldc) {
 214     // Tell the interpreter how to unbox the primitive.
 215     guarantee(java_lang_boxing_object::is_instance(result, type), &quot;&quot;);
 216     int offset = java_lang_boxing_object::value_offset_in_bytes(type);
 217     intptr_t flags = ((as_TosState(type) &lt;&lt; ConstantPoolCacheEntry::tos_state_shift)
 218                       | (offset &amp; ConstantPoolCacheEntry::field_index_mask));
 219     thread-&gt;set_vm_result_2((Metadata*)flags);
 220   }
 221 }
<span class="line-modified"> 222 IRT_END</span>
 223 
 224 
 225 //------------------------------------------------------------------------------------------------------------------------
 226 // Allocation
 227 
<span class="line-modified"> 228 IRT_ENTRY(void, InterpreterRuntime::_new(JavaThread* thread, ConstantPool* pool, int index))</span>
 229   Klass* k = pool-&gt;klass_at(index, CHECK);
 230   InstanceKlass* klass = InstanceKlass::cast(k);
 231 
 232   // Make sure we are not instantiating an abstract klass
 233   klass-&gt;check_valid_for_instantiation(true, CHECK);
 234 
 235   // Make sure klass is initialized
 236   klass-&gt;initialize(CHECK);
 237 
 238   // At this point the class may not be fully initialized
 239   // because of recursive initialization. If it is fully
 240   // initialized &amp; has_finalized is not set, we rewrite
 241   // it into its fast version (Note: no locking is needed
 242   // here since this is an atomic byte write and can be
 243   // done more than once).
 244   //
 245   // Note: In case of classes with has_finalized we don&#39;t
 246   //       rewrite since that saves us an extra check in
 247   //       the fast version which then would call the
 248   //       slow version anyway (and do a call back into
 249   //       Java).
 250   //       If we have a breakpoint, then we don&#39;t rewrite
 251   //       because the _breakpoint bytecode would be lost.
 252   oop obj = klass-&gt;allocate_instance(CHECK);
 253   thread-&gt;set_vm_result(obj);
<span class="line-modified"> 254 IRT_END</span>
 255 
 256 
<span class="line-modified"> 257 IRT_ENTRY(void, InterpreterRuntime::newarray(JavaThread* thread, BasicType type, jint size))</span>
 258   oop obj = oopFactory::new_typeArray(type, size, CHECK);
 259   thread-&gt;set_vm_result(obj);
<span class="line-modified"> 260 IRT_END</span>
 261 
 262 
<span class="line-modified"> 263 IRT_ENTRY(void, InterpreterRuntime::anewarray(JavaThread* thread, ConstantPool* pool, int index, jint size))</span>
 264   Klass*    klass = pool-&gt;klass_at(index, CHECK);
 265   objArrayOop obj = oopFactory::new_objArray(klass, size, CHECK);
 266   thread-&gt;set_vm_result(obj);
<span class="line-modified"> 267 IRT_END</span>
 268 
 269 
<span class="line-modified"> 270 IRT_ENTRY(void, InterpreterRuntime::multianewarray(JavaThread* thread, jint* first_size_address))</span>
 271   // We may want to pass in more arguments - could make this slightly faster
 272   LastFrameAccessor last_frame(thread);
 273   ConstantPool* constants = last_frame.method()-&gt;constants();
 274   int          i = last_frame.get_index_u2(Bytecodes::_multianewarray);
 275   Klass* klass   = constants-&gt;klass_at(i, CHECK);
 276   int   nof_dims = last_frame.number_of_dimensions();
 277   assert(klass-&gt;is_klass(), &quot;not a class&quot;);
 278   assert(nof_dims &gt;= 1, &quot;multianewarray rank must be nonzero&quot;);
 279 
 280   // We must create an array of jints to pass to multi_allocate.
 281   ResourceMark rm(thread);
 282   const int small_dims = 10;
 283   jint dim_array[small_dims];
 284   jint *dims = &amp;dim_array[0];
 285   if (nof_dims &gt; small_dims) {
 286     dims = (jint*) NEW_RESOURCE_ARRAY(jint, nof_dims);
 287   }
 288   for (int index = 0; index &lt; nof_dims; index++) {
 289     // offset from first_size_address is addressed as local[index]
 290     int n = Interpreter::local_offset_in_bytes(index)/jintSize;
 291     dims[index] = first_size_address[n];
 292   }
 293   oop obj = ArrayKlass::cast(klass)-&gt;multi_allocate(nof_dims, dims, CHECK);
 294   thread-&gt;set_vm_result(obj);
<span class="line-modified"> 295 IRT_END</span>
 296 
 297 
<span class="line-modified"> 298 IRT_ENTRY(void, InterpreterRuntime::register_finalizer(JavaThread* thread, oopDesc* obj))</span>
 299   assert(oopDesc::is_oop(obj), &quot;must be a valid oop&quot;);
 300   assert(obj-&gt;klass()-&gt;has_finalizer(), &quot;shouldn&#39;t be here otherwise&quot;);
 301   InstanceKlass::register_finalizer(instanceOop(obj), CHECK);
<span class="line-modified"> 302 IRT_END</span>
 303 
 304 
 305 // Quicken instance-of and check-cast bytecodes
<span class="line-modified"> 306 IRT_ENTRY(void, InterpreterRuntime::quicken_io_cc(JavaThread* thread))</span>
 307   // Force resolving; quicken the bytecode
 308   LastFrameAccessor last_frame(thread);
 309   int which = last_frame.get_index_u2(Bytecodes::_checkcast);
 310   ConstantPool* cpool = last_frame.method()-&gt;constants();
 311   // We&#39;d expect to assert that we&#39;re only here to quicken bytecodes, but in a multithreaded
 312   // program we might have seen an unquick&#39;d bytecode in the interpreter but have another
 313   // thread quicken the bytecode before we get here.
 314   // assert( cpool-&gt;tag_at(which).is_unresolved_klass(), &quot;should only come here to quicken bytecodes&quot; );
 315   Klass* klass = cpool-&gt;klass_at(which, CHECK);
 316   thread-&gt;set_vm_result_2(klass);
<span class="line-modified"> 317 IRT_END</span>
 318 
 319 
 320 //------------------------------------------------------------------------------------------------------------------------
 321 // Exceptions
 322 
 323 void InterpreterRuntime::note_trap_inner(JavaThread* thread, int reason,
 324                                          const methodHandle&amp; trap_method, int trap_bci, TRAPS) {
 325   if (trap_method.not_null()) {
 326     MethodData* trap_mdo = trap_method-&gt;method_data();
 327     if (trap_mdo == NULL) {
 328       Method::build_interpreter_method_data(trap_method, THREAD);
 329       if (HAS_PENDING_EXCEPTION) {
 330         assert((PENDING_EXCEPTION-&gt;is_a(SystemDictionary::OutOfMemoryError_klass())),
 331                &quot;we expect only an OOM error here&quot;);
 332         CLEAR_PENDING_EXCEPTION;
 333       }
 334       trap_mdo = trap_method-&gt;method_data();
 335       // and fall through...
 336     }
 337     if (trap_mdo != NULL) {
 338       // Update per-method count of trap events.  The interpreter
 339       // is updating the MDO to simulate the effect of compiler traps.
 340       Deoptimization::update_method_data_from_interpreter(trap_mdo, trap_bci, reason);
 341     }
 342   }
 343 }
 344 
 345 // Assume the compiler is (or will be) interested in this event.
 346 // If necessary, create an MDO to hold the information, and record it.
 347 void InterpreterRuntime::note_trap(JavaThread* thread, int reason, TRAPS) {
 348   assert(ProfileTraps, &quot;call me only if profiling&quot;);
 349   LastFrameAccessor last_frame(thread);
 350   methodHandle trap_method(thread, last_frame.method());
 351   int trap_bci = trap_method-&gt;bci_from(last_frame.bcp());
 352   note_trap_inner(thread, reason, trap_method, trap_bci, THREAD);
 353 }
 354 
 355 #ifdef CC_INTERP
 356 // As legacy note_trap, but we have more arguments.
<span class="line-modified"> 357 IRT_ENTRY(void, InterpreterRuntime::note_trap(JavaThread* thread, int reason, Method *method, int trap_bci))</span>
<span class="line-modified"> 358   methodHandle trap_method(method);</span>
 359   note_trap_inner(thread, reason, trap_method, trap_bci, THREAD);
<span class="line-modified"> 360 IRT_END</span>
 361 
 362 // Class Deoptimization is not visible in BytecodeInterpreter, so we need a wrapper
 363 // for each exception.
 364 void InterpreterRuntime::note_nullCheck_trap(JavaThread* thread, Method *method, int trap_bci)
 365   { if (ProfileTraps) note_trap(thread, Deoptimization::Reason_null_check, method, trap_bci); }
 366 void InterpreterRuntime::note_div0Check_trap(JavaThread* thread, Method *method, int trap_bci)
 367   { if (ProfileTraps) note_trap(thread, Deoptimization::Reason_div0_check, method, trap_bci); }
 368 void InterpreterRuntime::note_rangeCheck_trap(JavaThread* thread, Method *method, int trap_bci)
 369   { if (ProfileTraps) note_trap(thread, Deoptimization::Reason_range_check, method, trap_bci); }
 370 void InterpreterRuntime::note_classCheck_trap(JavaThread* thread, Method *method, int trap_bci)
 371   { if (ProfileTraps) note_trap(thread, Deoptimization::Reason_class_check, method, trap_bci); }
 372 void InterpreterRuntime::note_arrayCheck_trap(JavaThread* thread, Method *method, int trap_bci)
 373   { if (ProfileTraps) note_trap(thread, Deoptimization::Reason_array_check, method, trap_bci); }
 374 #endif // CC_INTERP
 375 
 376 
 377 static Handle get_preinitialized_exception(Klass* k, TRAPS) {
 378   // get klass
 379   InstanceKlass* klass = InstanceKlass::cast(k);
 380   assert(klass-&gt;is_initialized(),
 381          &quot;this klass should have been initialized during VM initialization&quot;);
 382   // create instance - do not call constructor since we may have no
 383   // (java) stack space left (should assert constructor is empty)
 384   Handle exception;
 385   oop exception_oop = klass-&gt;allocate_instance(CHECK_(exception));
 386   exception = Handle(THREAD, exception_oop);
 387   if (StackTraceInThrowable) {
 388     java_lang_Throwable::fill_in_stack_trace(exception);
 389   }
 390   return exception;
 391 }
 392 
 393 // Special handling for stack overflow: since we don&#39;t have any (java) stack
 394 // space left we use the pre-allocated &amp; pre-initialized StackOverflowError
 395 // klass to create an stack overflow error instance.  We do not call its
 396 // constructor for the same reason (it is empty, anyway).
<span class="line-modified"> 397 IRT_ENTRY(void, InterpreterRuntime::throw_StackOverflowError(JavaThread* thread))</span>
 398   Handle exception = get_preinitialized_exception(
 399                                  SystemDictionary::StackOverflowError_klass(),
 400                                  CHECK);
 401   // Increment counter for hs_err file reporting
 402   Atomic::inc(&amp;Exceptions::_stack_overflow_errors);
 403   THROW_HANDLE(exception);
<span class="line-modified"> 404 IRT_END</span>
 405 
<span class="line-modified"> 406 IRT_ENTRY(void, InterpreterRuntime::throw_delayed_StackOverflowError(JavaThread* thread))</span>
 407   Handle exception = get_preinitialized_exception(
 408                                  SystemDictionary::StackOverflowError_klass(),
 409                                  CHECK);
 410   java_lang_Throwable::set_message(exception(),
 411           Universe::delayed_stack_overflow_error_message());
 412   // Increment counter for hs_err file reporting
 413   Atomic::inc(&amp;Exceptions::_stack_overflow_errors);
 414   THROW_HANDLE(exception);
<span class="line-modified"> 415 IRT_END</span>
 416 
<span class="line-modified"> 417 IRT_ENTRY(void, InterpreterRuntime::create_exception(JavaThread* thread, char* name, char* message))</span>
 418   // lookup exception klass
<span class="line-modified"> 419   TempNewSymbol s = SymbolTable::new_symbol(name, CHECK);</span>
 420   if (ProfileTraps) {
 421     if (s == vmSymbols::java_lang_ArithmeticException()) {
 422       note_trap(thread, Deoptimization::Reason_div0_check, CHECK);
 423     } else if (s == vmSymbols::java_lang_NullPointerException()) {
 424       note_trap(thread, Deoptimization::Reason_null_check, CHECK);
 425     }
 426   }
 427   // create exception
 428   Handle exception = Exceptions::new_exception(thread, s, message);
 429   thread-&gt;set_vm_result(exception());
<span class="line-modified"> 430 IRT_END</span>
 431 
 432 
<span class="line-modified"> 433 IRT_ENTRY(void, InterpreterRuntime::create_klass_exception(JavaThread* thread, char* name, oopDesc* obj))</span>
 434   // Produce the error message first because note_trap can safepoint
 435   ResourceMark rm(thread);
 436   const char* klass_name = obj-&gt;klass()-&gt;external_name();
 437   // lookup exception klass
<span class="line-modified"> 438   TempNewSymbol s = SymbolTable::new_symbol(name, CHECK);</span>
 439   if (ProfileTraps) {
 440     note_trap(thread, Deoptimization::Reason_class_check, CHECK);
 441   }
 442   // create exception, with klass name as detail message
 443   Handle exception = Exceptions::new_exception(thread, s, klass_name);
 444   thread-&gt;set_vm_result(exception());
<span class="line-modified"> 445 IRT_END</span>
 446 
<span class="line-modified"> 447 IRT_ENTRY(void, InterpreterRuntime::throw_ArrayIndexOutOfBoundsException(JavaThread* thread, arrayOopDesc* a, jint index))</span>
 448   // Produce the error message first because note_trap can safepoint
 449   ResourceMark rm(thread);
 450   stringStream ss;
 451   ss.print(&quot;Index %d out of bounds for length %d&quot;, index, a-&gt;length());
 452 
 453   if (ProfileTraps) {
 454     note_trap(thread, Deoptimization::Reason_range_check, CHECK);
 455   }
 456 
 457   THROW_MSG(vmSymbols::java_lang_ArrayIndexOutOfBoundsException(), ss.as_string());
<span class="line-modified"> 458 IRT_END</span>
 459 
<span class="line-modified"> 460 IRT_ENTRY(void, InterpreterRuntime::throw_ClassCastException(</span>
 461   JavaThread* thread, oopDesc* obj))
 462 
 463   // Produce the error message first because note_trap can safepoint
 464   ResourceMark rm(thread);
 465   char* message = SharedRuntime::generate_class_cast_message(
 466     thread, obj-&gt;klass());
 467 
 468   if (ProfileTraps) {
 469     note_trap(thread, Deoptimization::Reason_class_check, CHECK);
 470   }
 471 
 472   // create exception
 473   THROW_MSG(vmSymbols::java_lang_ClassCastException(), message);
<span class="line-modified"> 474 IRT_END</span>
 475 
 476 // exception_handler_for_exception(...) returns the continuation address,
 477 // the exception oop (via TLS) and sets the bci/bcp for the continuation.
 478 // The exception oop is returned to make sure it is preserved over GC (it
 479 // is only on the stack if the exception was thrown explicitly via athrow).
 480 // During this operation, the expression stack contains the values for the
 481 // bci where the exception happened. If the exception was propagated back
 482 // from a call, the expression stack contains the values for the bci at the
 483 // invoke w/o arguments (i.e., as if one were inside the call).
<span class="line-modified"> 484 IRT_ENTRY(address, InterpreterRuntime::exception_handler_for_exception(JavaThread* thread, oopDesc* exception))</span>
 485 
 486   LastFrameAccessor last_frame(thread);
 487   Handle             h_exception(thread, exception);
 488   methodHandle       h_method   (thread, last_frame.method());
 489   constantPoolHandle h_constants(thread, h_method-&gt;constants());
 490   bool               should_repeat;
 491   int                handler_bci;
 492   int                current_bci = last_frame.bci();
 493 
 494   if (thread-&gt;frames_to_pop_failed_realloc() &gt; 0) {
 495     // Allocation of scalar replaced object used in this frame
 496     // failed. Unconditionally pop the frame.
 497     thread-&gt;dec_frames_to_pop_failed_realloc();
 498     thread-&gt;set_vm_result(h_exception());
 499     // If the method is synchronized we already unlocked the monitor
 500     // during deoptimization so the interpreter needs to skip it when
 501     // the frame is popped.
 502     thread-&gt;set_do_not_unlock_if_synchronized(true);
 503 #ifdef CC_INTERP
 504     return (address) -1;
</pre>
<hr />
<pre>
 525   do {
 526     should_repeat = false;
 527 
 528     // assertions
 529 #ifdef ASSERT
 530     assert(h_exception.not_null(), &quot;NULL exceptions should be handled by athrow&quot;);
 531     // Check that exception is a subclass of Throwable, otherwise we have a VerifyError
 532     if (!(h_exception-&gt;is_a(SystemDictionary::Throwable_klass()))) {
 533       if (ExitVMOnVerifyError) vm_exit(-1);
 534       ShouldNotReachHere();
 535     }
 536 #endif
 537 
 538     // tracing
 539     if (log_is_enabled(Info, exceptions)) {
 540       ResourceMark rm(thread);
 541       stringStream tempst;
 542       tempst.print(&quot;interpreter method &lt;%s&gt;\n&quot;
 543                    &quot; at bci %d for thread &quot; INTPTR_FORMAT &quot; (%s)&quot;,
 544                    h_method-&gt;print_value_string(), current_bci, p2i(thread), thread-&gt;name());
<span class="line-modified"> 545       Exceptions::log_exception(h_exception, tempst);</span>
 546     }
 547 // Don&#39;t go paging in something which won&#39;t be used.
 548 //     else if (extable-&gt;length() == 0) {
 549 //       // disabled for now - interpreter is not using shortcut yet
 550 //       // (shortcut is not to call runtime if we have no exception handlers)
 551 //       // warning(&quot;performance bug: should not call runtime if method has no exception handlers&quot;);
 552 //     }
 553     // for AbortVMOnException flag
 554     Exceptions::debug_check_abort(h_exception);
 555 
 556     // exception handler lookup
 557     Klass* klass = h_exception-&gt;klass();
 558     handler_bci = Method::fast_exception_handler_bci_for(h_method, klass, current_bci, THREAD);
 559     if (HAS_PENDING_EXCEPTION) {
 560       // We threw an exception while trying to find the exception handler.
 561       // Transfer the new exception to the exception handle which will
 562       // be set into thread local storage, and do another lookup for an
 563       // exception handler for this exception, this time starting at the
 564       // BCI of the exception handler which caused the exception to be
 565       // thrown (bug 4307310).
</pre>
<hr />
<pre>
 605 #if COMPILER2_OR_JVMCI
 606     // Count this for compilation purposes
 607     h_method-&gt;interpreter_throwout_increment(THREAD);
 608 #endif
 609   } else {
 610     // handler in this method =&gt; change bci/bcp to handler bci/bcp and continue there
 611     handler_pc = h_method-&gt;code_base() + handler_bci;
 612 #ifndef CC_INTERP
 613     set_bcp_and_mdp(handler_pc, thread);
 614     continuation = Interpreter::dispatch_table(vtos)[*handler_pc];
 615 #endif
 616   }
 617   // notify debugger of an exception catch
 618   // (this is good for exceptions caught in native methods as well)
 619   if (JvmtiExport::can_post_on_exceptions()) {
 620     JvmtiExport::notice_unwind_due_to_exception(thread, h_method(), handler_pc, h_exception(), (handler_pc != NULL));
 621   }
 622 
 623   thread-&gt;set_vm_result(h_exception());
 624   return continuation;
<span class="line-modified"> 625 IRT_END</span>
 626 
 627 
<span class="line-modified"> 628 IRT_ENTRY(void, InterpreterRuntime::throw_pending_exception(JavaThread* thread))</span>
 629   assert(thread-&gt;has_pending_exception(), &quot;must only ne called if there&#39;s an exception pending&quot;);
 630   // nothing to do - eventually we should remove this code entirely (see comments @ call sites)
<span class="line-modified"> 631 IRT_END</span>
 632 
 633 
<span class="line-modified"> 634 IRT_ENTRY(void, InterpreterRuntime::throw_AbstractMethodError(JavaThread* thread))</span>
 635   THROW(vmSymbols::java_lang_AbstractMethodError());
<span class="line-modified"> 636 IRT_END</span>
 637 
 638 // This method is called from the &quot;abstract_entry&quot; of the interpreter.
 639 // At that point, the arguments have already been removed from the stack
 640 // and therefore we don&#39;t have the receiver object at our fingertips. (Though,
 641 // on some platforms the receiver still resides in a register...). Thus,
 642 // we have no choice but print an error message not containing the receiver
 643 // type.
<span class="line-modified"> 644 IRT_ENTRY(void, InterpreterRuntime::throw_AbstractMethodErrorWithMethod(JavaThread* thread,</span>
 645                                                                         Method* missingMethod))
 646   ResourceMark rm(thread);
 647   assert(missingMethod != NULL, &quot;sanity&quot;);
 648   methodHandle m(thread, missingMethod);
 649   LinkResolver::throw_abstract_method_error(m, THREAD);
<span class="line-modified"> 650 IRT_END</span>
 651 
<span class="line-modified"> 652 IRT_ENTRY(void, InterpreterRuntime::throw_AbstractMethodErrorVerbose(JavaThread* thread,</span>
 653                                                                      Klass* recvKlass,
 654                                                                      Method* missingMethod))
 655   ResourceMark rm(thread);
 656   methodHandle mh = methodHandle(thread, missingMethod);
 657   LinkResolver::throw_abstract_method_error(mh, recvKlass, THREAD);
<span class="line-modified"> 658 IRT_END</span>
 659 
 660 
<span class="line-modified"> 661 IRT_ENTRY(void, InterpreterRuntime::throw_IncompatibleClassChangeError(JavaThread* thread))</span>
 662   THROW(vmSymbols::java_lang_IncompatibleClassChangeError());
<span class="line-modified"> 663 IRT_END</span>
 664 
<span class="line-modified"> 665 IRT_ENTRY(void, InterpreterRuntime::throw_IncompatibleClassChangeErrorVerbose(JavaThread* thread,</span>
 666                                                                               Klass* recvKlass,
 667                                                                               Klass* interfaceKlass))
 668   ResourceMark rm(thread);
 669   char buf[1000];
 670   buf[0] = &#39;\0&#39;;
 671   jio_snprintf(buf, sizeof(buf),
 672                &quot;Class %s does not implement the requested interface %s&quot;,
 673                recvKlass ? recvKlass-&gt;external_name() : &quot;NULL&quot;,
 674                interfaceKlass ? interfaceKlass-&gt;external_name() : &quot;NULL&quot;);
 675   THROW_MSG(vmSymbols::java_lang_IncompatibleClassChangeError(), buf);
<span class="line-modified"> 676 IRT_END</span>
 677 
 678 //------------------------------------------------------------------------------------------------------------------------
 679 // Fields
 680 //
 681 
 682 void InterpreterRuntime::resolve_get_put(JavaThread* thread, Bytecodes::Code bytecode) {
 683   Thread* THREAD = thread;
 684   // resolve field
 685   fieldDescriptor info;
 686   LastFrameAccessor last_frame(thread);
 687   constantPoolHandle pool(thread, last_frame.method()-&gt;constants());
 688   methodHandle m(thread, last_frame.method());
 689   bool is_put    = (bytecode == Bytecodes::_putfield  || bytecode == Bytecodes::_nofast_putfield ||
 690                     bytecode == Bytecodes::_putstatic);
 691   bool is_static = (bytecode == Bytecodes::_getstatic || bytecode == Bytecodes::_putstatic);
 692 
 693   {
 694     JvmtiHideSingleStepping jhss(thread);
 695     LinkResolver::resolve_field_access(info, pool, last_frame.get_index_u2_cpcache(bytecode),
 696                                        m, bytecode, CHECK);
</pre>
<hr />
<pre>
 749     info.field_holder(),
 750     info.index(),
 751     info.offset(),
 752     state,
 753     info.access_flags().is_final(),
 754     info.access_flags().is_volatile(),
 755     is_tsan_ignore,
 756     pool-&gt;pool_holder()
 757   );
 758 }
 759 
 760 
 761 //------------------------------------------------------------------------------------------------------------------------
 762 // Synchronization
 763 //
 764 // The interpreter&#39;s synchronization code is factored out so that it can
 765 // be shared by method invocation and synchronized blocks.
 766 //%note synchronization_3
 767 
 768 //%note monitor_1
<span class="line-modified"> 769 IRT_ENTRY_NO_ASYNC(void, InterpreterRuntime::monitorenter(JavaThread* thread, BasicObjectLock* elem))</span>
 770 #ifdef ASSERT
 771   thread-&gt;last_frame().interpreter_frame_verify_monitor(elem);
 772 #endif
 773   if (PrintBiasedLockingStatistics) {
 774     Atomic::inc(BiasedLocking::slow_path_entry_count_addr());
 775   }
 776   Handle h_obj(thread, elem-&gt;obj());
<span class="line-modified"> 777   assert(Universe::heap()-&gt;is_in_reserved_or_null(h_obj()),</span>
 778          &quot;must be NULL or an object&quot;);
<span class="line-modified"> 779   if (UseBiasedLocking) {</span>
<span class="line-modified"> 780     // Retry fast entry if bias is revoked to avoid unnecessary inflation</span>
<span class="line-removed"> 781     ObjectSynchronizer::fast_enter(h_obj, elem-&gt;lock(), true, CHECK);</span>
<span class="line-removed"> 782   } else {</span>
<span class="line-removed"> 783     ObjectSynchronizer::slow_enter(h_obj, elem-&gt;lock(), CHECK);</span>
<span class="line-removed"> 784   }</span>
<span class="line-removed"> 785   assert(Universe::heap()-&gt;is_in_reserved_or_null(elem-&gt;obj()),</span>
 786          &quot;must be NULL or an object&quot;);
 787 #ifdef ASSERT
 788   thread-&gt;last_frame().interpreter_frame_verify_monitor(elem);
 789 #endif
<span class="line-modified"> 790 IRT_END</span>
 791 
 792 
 793 //%note monitor_1
<span class="line-modified"> 794 IRT_ENTRY_NO_ASYNC(void, InterpreterRuntime::monitorexit(JavaThread* thread, BasicObjectLock* elem))</span>
 795 #ifdef ASSERT
 796   thread-&gt;last_frame().interpreter_frame_verify_monitor(elem);
 797 #endif
 798   Handle h_obj(thread, elem-&gt;obj());
<span class="line-modified"> 799   assert(Universe::heap()-&gt;is_in_reserved_or_null(h_obj()),</span>
 800          &quot;must be NULL or an object&quot;);
 801   if (elem == NULL || h_obj()-&gt;is_unlocked()) {
 802     THROW(vmSymbols::java_lang_IllegalMonitorStateException());
 803   }
<span class="line-modified"> 804   ObjectSynchronizer::slow_exit(h_obj(), elem-&gt;lock(), thread);</span>
 805   // Free entry. This must be done here, since a pending exception might be installed on
 806   // exit. If it is not cleared, the exception handling code will try to unlock the monitor again.
 807   elem-&gt;set_obj(NULL);
 808 #ifdef ASSERT
 809   thread-&gt;last_frame().interpreter_frame_verify_monitor(elem);
 810 #endif
<span class="line-modified"> 811 IRT_END</span>
 812 
 813 
<span class="line-modified"> 814 IRT_ENTRY(void, InterpreterRuntime::throw_illegal_monitor_state_exception(JavaThread* thread))</span>
 815   THROW(vmSymbols::java_lang_IllegalMonitorStateException());
<span class="line-modified"> 816 IRT_END</span>
 817 
 818 
<span class="line-modified"> 819 IRT_ENTRY(void, InterpreterRuntime::new_illegal_monitor_state_exception(JavaThread* thread))</span>
 820   // Returns an illegal exception to install into the current thread. The
 821   // pending_exception flag is cleared so normal exception handling does not
 822   // trigger. Any current installed exception will be overwritten. This
 823   // method will be called during an exception unwind.
 824 
 825   assert(!HAS_PENDING_EXCEPTION, &quot;no pending exception&quot;);
 826   Handle exception(thread, thread-&gt;vm_result());
 827   assert(exception() != NULL, &quot;vm result should be set&quot;);
 828   thread-&gt;set_vm_result(NULL); // clear vm result before continuing (may cause memory leaks and assert failures)
 829   if (!exception-&gt;is_a(SystemDictionary::ThreadDeath_klass())) {
 830     exception = get_preinitialized_exception(
 831                        SystemDictionary::IllegalMonitorStateException_klass(),
 832                        CATCH);
 833   }
 834   thread-&gt;set_vm_result(exception());
<span class="line-modified"> 835 IRT_END</span>
 836 
 837 
 838 //------------------------------------------------------------------------------------------------------------------------
 839 // Invokes
 840 
<span class="line-modified"> 841 IRT_ENTRY(Bytecodes::Code, InterpreterRuntime::get_original_bytecode_at(JavaThread* thread, Method* method, address bcp))</span>
 842   return method-&gt;orig_bytecode_at(method-&gt;bci_from(bcp));
<span class="line-modified"> 843 IRT_END</span>
 844 
<span class="line-modified"> 845 IRT_ENTRY(void, InterpreterRuntime::set_original_bytecode_at(JavaThread* thread, Method* method, address bcp, Bytecodes::Code new_code))</span>
 846   method-&gt;set_orig_bytecode_at(method-&gt;bci_from(bcp), new_code);
<span class="line-modified"> 847 IRT_END</span>
 848 
<span class="line-modified"> 849 IRT_ENTRY(void, InterpreterRuntime::_breakpoint(JavaThread* thread, Method* method, address bcp))</span>
 850   JvmtiExport::post_raw_breakpoint(thread, method, bcp);
<span class="line-modified"> 851 IRT_END</span>
 852 
 853 void InterpreterRuntime::resolve_invoke(JavaThread* thread, Bytecodes::Code bytecode) {
 854   Thread* THREAD = thread;
 855   LastFrameAccessor last_frame(thread);
 856   // extract receiver from the outgoing argument list if necessary
 857   Handle receiver(thread, NULL);
 858   if (bytecode == Bytecodes::_invokevirtual || bytecode == Bytecodes::_invokeinterface ||
 859       bytecode == Bytecodes::_invokespecial) {
 860     ResourceMark rm(thread);
 861     methodHandle m (thread, last_frame.method());
 862     Bytecode_invoke call(m, last_frame.bci());
 863     Symbol* signature = call.signature();
 864     receiver = Handle(thread, last_frame.callee_receiver(signature));
 865 
<span class="line-modified"> 866     assert(Universe::heap()-&gt;is_in_reserved_or_null(receiver()),</span>
 867            &quot;sanity check&quot;);
 868     assert(receiver.is_null() ||
<span class="line-modified"> 869            !Universe::heap()-&gt;is_in_reserved(receiver-&gt;klass()),</span>
 870            &quot;sanity check&quot;);
 871   }
 872 
 873   // resolve method
 874   CallInfo info;
 875   constantPoolHandle pool(thread, last_frame.method()-&gt;constants());
 876 
 877   {
 878     JvmtiHideSingleStepping jhss(thread);
 879     LinkResolver::resolve_invoke(info, receiver, pool,
 880                                  last_frame.get_index_u2_cpcache(bytecode), bytecode,
 881                                  CHECK);
 882     if (JvmtiExport::can_hotswap_or_post_breakpoint()) {
 883       int retry_count = 0;
 884       while (info.resolved_method()-&gt;is_old()) {
 885         // It is very unlikely that method is redefined more than 100 times
 886         // in the middle of resolve. If it is looping here more than 100 times
 887         // means then there could be a bug here.
 888         guarantee((retry_count++ &lt; 100),
 889                   &quot;Could not resolve to latest version of redefined method&quot;);
 890         // method is redefined in the middle of resolve so re-try.
 891         LinkResolver::resolve_invoke(info, receiver, pool,
 892                                      last_frame.get_index_u2_cpcache(bytecode), bytecode,
 893                                      CHECK);
 894       }
 895     }
 896   } // end JvmtiHideSingleStepping
 897 
 898   // check if link resolution caused cpCache to be updated
 899   ConstantPoolCacheEntry* cp_cache_entry = last_frame.cache_entry();
 900   if (cp_cache_entry-&gt;is_resolved(bytecode)) return;
 901 
 902 #ifdef ASSERT
 903   if (bytecode == Bytecodes::_invokeinterface) {
 904     if (info.resolved_method()-&gt;method_holder() ==
 905                                             SystemDictionary::Object_klass()) {
 906       // NOTE: THIS IS A FIX FOR A CORNER CASE in the JVM spec
 907       // (see also CallInfo::set_interface for details)
 908       assert(info.call_kind() == CallInfo::vtable_call ||
 909              info.call_kind() == CallInfo::direct_call, &quot;&quot;);
<span class="line-modified"> 910       methodHandle rm = info.resolved_method();</span>
 911       assert(rm-&gt;is_final() || info.has_vtable_index(),
 912              &quot;should have been set already&quot;);
 913     } else if (!info.resolved_method()-&gt;has_itable_index()) {
 914       // Resolved something like CharSequence.toString.  Use vtable not itable.
 915       assert(info.call_kind() != CallInfo::itable_call, &quot;&quot;);
 916     } else {
 917       // Setup itable entry
 918       assert(info.call_kind() == CallInfo::itable_call, &quot;&quot;);
 919       int index = info.resolved_method()-&gt;itable_index();
 920       assert(info.itable_index() == index, &quot;&quot;);
 921     }
 922   } else if (bytecode == Bytecodes::_invokespecial) {
 923     assert(info.call_kind() == CallInfo::direct_call, &quot;must be direct call&quot;);
 924   } else {
 925     assert(info.call_kind() == CallInfo::direct_call ||
 926            info.call_kind() == CallInfo::vtable_call, &quot;&quot;);
 927   }
 928 #endif






 929 
 930   switch (info.call_kind()) {
<span class="line-modified"> 931   case CallInfo::direct_call: {</span>
<span class="line-removed"> 932     // Get sender or sender&#39;s unsafe_anonymous_host, and only set cpCache entry to resolved if</span>
<span class="line-removed"> 933     // it is not an interface.  The receiver for invokespecial calls within interface</span>
<span class="line-removed"> 934     // methods must be checked for every call.</span>
<span class="line-removed"> 935     InstanceKlass* pool_holder = pool-&gt;pool_holder();</span>
<span class="line-removed"> 936     InstanceKlass* sender = pool_holder-&gt;is_unsafe_anonymous() ?</span>
<span class="line-removed"> 937                               pool_holder-&gt;unsafe_anonymous_host() : pool_holder;</span>
<span class="line-removed"> 938 </span>
 939     cp_cache_entry-&gt;set_direct_call(
 940       bytecode,
<span class="line-modified"> 941       info.resolved_method(),</span>
<span class="line-modified"> 942       sender-&gt;is_interface(),</span>
<span class="line-removed"> 943       pool_holder);</span>
 944     break;
<span class="line-removed"> 945   }</span>
 946   case CallInfo::vtable_call:
 947     cp_cache_entry-&gt;set_vtable_call(
 948       bytecode,
<span class="line-modified"> 949       info.resolved_method(),</span>
 950       info.vtable_index());
 951     break;
 952   case CallInfo::itable_call:
 953     cp_cache_entry-&gt;set_itable_call(
 954       bytecode,
 955       info.resolved_klass(),
<span class="line-modified"> 956       info.resolved_method(),</span>
 957       info.itable_index());
 958     break;
 959   default:  ShouldNotReachHere();
 960   }
 961 }
 962 
 963 
 964 // First time execution:  Resolve symbols, create a permanent MethodType object.
 965 void InterpreterRuntime::resolve_invokehandle(JavaThread* thread) {
 966   Thread* THREAD = thread;
 967   const Bytecodes::Code bytecode = Bytecodes::_invokehandle;
 968   LastFrameAccessor last_frame(thread);
 969 
 970   // resolve method
 971   CallInfo info;
 972   constantPoolHandle pool(thread, last_frame.method()-&gt;constants());
 973   {
 974     JvmtiHideSingleStepping jhss(thread);
 975     LinkResolver::resolve_invoke(info, Handle(), pool,
 976                                  last_frame.get_index_u2_cpcache(bytecode), bytecode,
</pre>
<hr />
<pre>
 987   LastFrameAccessor last_frame(thread);
 988   const Bytecodes::Code bytecode = Bytecodes::_invokedynamic;
 989 
 990   // resolve method
 991   CallInfo info;
 992   constantPoolHandle pool(thread, last_frame.method()-&gt;constants());
 993   int index = last_frame.get_index_u4(bytecode);
 994   {
 995     JvmtiHideSingleStepping jhss(thread);
 996     LinkResolver::resolve_invoke(info, Handle(), pool,
 997                                  index, bytecode, CHECK);
 998   } // end JvmtiHideSingleStepping
 999 
1000   ConstantPoolCacheEntry* cp_cache_entry = pool-&gt;invokedynamic_cp_cache_entry_at(index);
1001   cp_cache_entry-&gt;set_dynamic_call(pool, info);
1002 }
1003 
1004 // This function is the interface to the assembly code. It returns the resolved
1005 // cpCache entry.  This doesn&#39;t safepoint, but the helper routines safepoint.
1006 // This function will check for redefinition!
<span class="line-modified">1007 IRT_ENTRY(void, InterpreterRuntime::resolve_from_cache(JavaThread* thread, Bytecodes::Code bytecode)) {</span>
1008   switch (bytecode) {
1009   case Bytecodes::_getstatic:
1010   case Bytecodes::_putstatic:
1011   case Bytecodes::_getfield:
1012   case Bytecodes::_putfield:
1013     resolve_get_put(thread, bytecode);
1014     break;
1015   case Bytecodes::_invokevirtual:
1016   case Bytecodes::_invokespecial:
1017   case Bytecodes::_invokestatic:
1018   case Bytecodes::_invokeinterface:
1019     resolve_invoke(thread, bytecode);
1020     break;
1021   case Bytecodes::_invokehandle:
1022     resolve_invokehandle(thread);
1023     break;
1024   case Bytecodes::_invokedynamic:
1025     resolve_invokedynamic(thread);
1026     break;
1027   default:
1028     fatal(&quot;unexpected bytecode: %s&quot;, Bytecodes::name(bytecode));
1029     break;
1030   }
1031 }
<span class="line-modified">1032 IRT_END</span>
1033 
1034 //------------------------------------------------------------------------------------------------------------------------
1035 // Miscellaneous
1036 
1037 
1038 nmethod* InterpreterRuntime::frequency_counter_overflow(JavaThread* thread, address branch_bcp) {
1039   nmethod* nm = frequency_counter_overflow_inner(thread, branch_bcp);
1040   assert(branch_bcp != NULL || nm == NULL, &quot;always returns null for non OSR requests&quot;);
1041   if (branch_bcp != NULL &amp;&amp; nm != NULL) {
1042     // This was a successful request for an OSR nmethod.  Because
1043     // frequency_counter_overflow_inner ends with a safepoint check,
1044     // nm could have been unloaded so look it up again.  It&#39;s unsafe
1045     // to examine nm directly since it might have been freed and used
1046     // for something else.
1047     LastFrameAccessor last_frame(thread);
1048     Method* method =  last_frame.method();
1049     int bci = method-&gt;bci_from(last_frame.bcp());
1050     nm = method-&gt;lookup_osr_nmethod_for(bci, CompLevel_none, false);
1051     BarrierSetNMethod* bs_nm = BarrierSet::barrier_set()-&gt;barrier_set_nmethod();
1052     if (nm != NULL &amp;&amp; bs_nm != NULL) {
</pre>
<hr />
<pre>
1058   }
1059   if (nm != NULL &amp;&amp; thread-&gt;is_interp_only_mode()) {
1060     // Normally we never get an nm if is_interp_only_mode() is true, because
1061     // policy()-&gt;event has a check for this and won&#39;t compile the method when
1062     // true. However, it&#39;s possible for is_interp_only_mode() to become true
1063     // during the compilation. We don&#39;t want to return the nm in that case
1064     // because we want to continue to execute interpreted.
1065     nm = NULL;
1066   }
1067 #ifndef PRODUCT
1068   if (TraceOnStackReplacement) {
1069     if (nm != NULL) {
1070       tty-&gt;print(&quot;OSR entry @ pc: &quot; INTPTR_FORMAT &quot;: &quot;, p2i(nm-&gt;osr_entry()));
1071       nm-&gt;print();
1072     }
1073   }
1074 #endif
1075   return nm;
1076 }
1077 
<span class="line-modified">1078 IRT_ENTRY(nmethod*,</span>
1079           InterpreterRuntime::frequency_counter_overflow_inner(JavaThread* thread, address branch_bcp))
1080   // use UnlockFlagSaver to clear and restore the _do_not_unlock_if_synchronized
1081   // flag, in case this method triggers classloading which will call into Java.
1082   UnlockFlagSaver fs(thread);
1083 
1084   LastFrameAccessor last_frame(thread);
1085   assert(last_frame.is_interpreted_frame(), &quot;must come from interpreter&quot;);
1086   methodHandle method(thread, last_frame.method());
1087   const int branch_bci = branch_bcp != NULL ? method-&gt;bci_from(branch_bcp) : InvocationEntryBci;
1088   const int bci = branch_bcp != NULL ? method-&gt;bci_from(last_frame.bcp()) : InvocationEntryBci;
1089 
1090   assert(!HAS_PENDING_EXCEPTION, &quot;Should not have any exceptions pending&quot;);
1091   nmethod* osr_nm = CompilationPolicy::policy()-&gt;event(method, method, branch_bci, bci, CompLevel_none, NULL, thread);
1092   assert(!HAS_PENDING_EXCEPTION, &quot;Event handler should not throw any exceptions&quot;);
1093 
1094   BarrierSetNMethod* bs_nm = BarrierSet::barrier_set()-&gt;barrier_set_nmethod();
1095   if (osr_nm != NULL &amp;&amp; bs_nm != NULL) {
1096     if (!bs_nm-&gt;nmethod_osr_entry_barrier(osr_nm)) {
1097       osr_nm = NULL;
1098     }
1099   }
1100 
1101   if (osr_nm != NULL) {
1102     // We may need to do on-stack replacement which requires that no
1103     // monitors in the activation are biased because their
1104     // BasicObjectLocks will need to migrate during OSR. Force
1105     // unbiasing of all monitors in the activation now (even though
1106     // the OSR nmethod might be invalidated) because we don&#39;t have a
1107     // safepoint opportunity later once the migration begins.
1108     if (UseBiasedLocking) {
1109       ResourceMark rm;
1110       GrowableArray&lt;Handle&gt;* objects_to_revoke = new GrowableArray&lt;Handle&gt;();
1111       for( BasicObjectLock *kptr = last_frame.monitor_end();
1112            kptr &lt; last_frame.monitor_begin();
1113            kptr = last_frame.next_monitor(kptr) ) {
1114         if( kptr-&gt;obj() != NULL ) {
1115           objects_to_revoke-&gt;append(Handle(THREAD, kptr-&gt;obj()));
1116         }
1117       }
<span class="line-modified">1118       BiasedLocking::revoke(objects_to_revoke);</span>
1119     }
1120   }
1121   return osr_nm;
<span class="line-modified">1122 IRT_END</span>
1123 
<span class="line-modified">1124 IRT_LEAF(jint, InterpreterRuntime::bcp_to_di(Method* method, address cur_bcp))</span>
1125   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1126   int bci = method-&gt;bci_from(cur_bcp);
1127   MethodData* mdo = method-&gt;method_data();
1128   if (mdo == NULL)  return 0;
1129   return mdo-&gt;bci_to_di(bci);
<span class="line-modified">1130 IRT_END</span>
1131 
<span class="line-modified">1132 IRT_ENTRY(void, InterpreterRuntime::profile_method(JavaThread* thread))</span>
1133   // use UnlockFlagSaver to clear and restore the _do_not_unlock_if_synchronized
1134   // flag, in case this method triggers classloading which will call into Java.
1135   UnlockFlagSaver fs(thread);
1136 
1137   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1138   LastFrameAccessor last_frame(thread);
1139   assert(last_frame.is_interpreted_frame(), &quot;must come from interpreter&quot;);
1140   methodHandle method(thread, last_frame.method());
1141   Method::build_interpreter_method_data(method, THREAD);
1142   if (HAS_PENDING_EXCEPTION) {
1143     assert((PENDING_EXCEPTION-&gt;is_a(SystemDictionary::OutOfMemoryError_klass())), &quot;we expect only an OOM error here&quot;);
1144     CLEAR_PENDING_EXCEPTION;
1145     // and fall through...
1146   }
<span class="line-modified">1147 IRT_END</span>
1148 
1149 
1150 #ifdef ASSERT
<span class="line-modified">1151 IRT_LEAF(void, InterpreterRuntime::verify_mdp(Method* method, address bcp, address mdp))</span>
1152   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1153 
1154   MethodData* mdo = method-&gt;method_data();
1155   assert(mdo != NULL, &quot;must not be null&quot;);
1156 
1157   int bci = method-&gt;bci_from(bcp);
1158 
1159   address mdp2 = mdo-&gt;bci_to_dp(bci);
1160   if (mdp != mdp2) {
1161     ResourceMark rm;
1162     ResetNoHandleMark rnm; // In a LEAF entry.
1163     HandleMark hm;
1164     tty-&gt;print_cr(&quot;FAILED verify : actual mdp %p   expected mdp %p @ bci %d&quot;, mdp, mdp2, bci);
1165     int current_di = mdo-&gt;dp_to_di(mdp);
1166     int expected_di  = mdo-&gt;dp_to_di(mdp2);
1167     tty-&gt;print_cr(&quot;  actual di %d   expected di %d&quot;, current_di, expected_di);
1168     int expected_approx_bci = mdo-&gt;data_at(expected_di)-&gt;bci();
1169     int approx_bci = -1;
1170     if (current_di &gt;= 0) {
1171       approx_bci = mdo-&gt;data_at(current_di)-&gt;bci();
1172     }
1173     tty-&gt;print_cr(&quot;  actual bci is %d  expected bci %d&quot;, approx_bci, expected_approx_bci);
1174     mdo-&gt;print_on(tty);
1175     method-&gt;print_codes();
1176   }
1177   assert(mdp == mdp2, &quot;wrong mdp&quot;);
<span class="line-modified">1178 IRT_END</span>
1179 #endif // ASSERT
1180 
<span class="line-modified">1181 IRT_ENTRY(void, InterpreterRuntime::update_mdp_for_ret(JavaThread* thread, int return_bci))</span>
1182   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1183   ResourceMark rm(thread);
1184   HandleMark hm(thread);
1185   LastFrameAccessor last_frame(thread);
1186   assert(last_frame.is_interpreted_frame(), &quot;must come from interpreter&quot;);
1187   MethodData* h_mdo = last_frame.method()-&gt;method_data();
1188 
1189   // Grab a lock to ensure atomic access to setting the return bci and
1190   // the displacement.  This can block and GC, invalidating all naked oops.
1191   MutexLocker ml(RetData_lock);
1192 
1193   // ProfileData is essentially a wrapper around a derived oop, so we
1194   // need to take the lock before making any ProfileData structures.
1195   ProfileData* data = h_mdo-&gt;data_at(h_mdo-&gt;dp_to_di(last_frame.mdp()));
1196   guarantee(data != NULL, &quot;profile data must be valid&quot;);
1197   RetData* rdata = data-&gt;as_RetData();
1198   address new_mdp = rdata-&gt;fixup_ret(return_bci, h_mdo);
1199   last_frame.set_mdp(new_mdp);
<span class="line-modified">1200 IRT_END</span>
1201 
<span class="line-modified">1202 IRT_ENTRY(MethodCounters*, InterpreterRuntime::build_method_counters(JavaThread* thread, Method* m))</span>
1203   MethodCounters* mcs = Method::build_method_counters(m, thread);
1204   if (HAS_PENDING_EXCEPTION) {
1205     assert((PENDING_EXCEPTION-&gt;is_a(SystemDictionary::OutOfMemoryError_klass())), &quot;we expect only an OOM error here&quot;);
1206     CLEAR_PENDING_EXCEPTION;
1207   }
1208   return mcs;
<span class="line-modified">1209 IRT_END</span>
1210 
1211 
<span class="line-modified">1212 IRT_ENTRY(void, InterpreterRuntime::at_safepoint(JavaThread* thread))</span>
1213   // We used to need an explict preserve_arguments here for invoke bytecodes. However,
1214   // stack traversal automatically takes care of preserving arguments for invoke, so
1215   // this is no longer needed.
1216 
<span class="line-modified">1217   // IRT_END does an implicit safepoint check, hence we are guaranteed to block</span>
1218   // if this is called during a safepoint
1219 
1220   if (JvmtiExport::should_post_single_step()) {
1221     // We are called during regular safepoints and when the VM is
1222     // single stepping. If any thread is marked for single stepping,
1223     // then we may have JVMTI work to do.
1224     LastFrameAccessor last_frame(thread);
1225     JvmtiExport::at_single_stepping_point(thread, last_frame.method(), last_frame.bcp());
1226   }
<span class="line-modified">1227 IRT_END</span>
1228 
<span class="line-modified">1229 IRT_ENTRY(void, InterpreterRuntime::post_field_access(JavaThread *thread, oopDesc* obj,</span>
1230 ConstantPoolCacheEntry *cp_entry))
1231 
1232   // check the access_flags for the field in the klass
1233 
1234   InstanceKlass* ik = InstanceKlass::cast(cp_entry-&gt;f1_as_klass());
1235   int index = cp_entry-&gt;field_index();
1236   if ((ik-&gt;field_access_flags(index) &amp; JVM_ACC_FIELD_ACCESS_WATCHED) == 0) return;
1237 
1238   bool is_static = (obj == NULL);
1239   HandleMark hm(thread);
1240 
1241   Handle h_obj;
1242   if (!is_static) {
1243     // non-static field accessors have an object, but we need a handle
1244     h_obj = Handle(thread, obj);
1245   }
1246   InstanceKlass* cp_entry_f1 = InstanceKlass::cast(cp_entry-&gt;f1_as_klass());
1247   jfieldID fid = jfieldIDWorkaround::to_jfieldID(cp_entry_f1, cp_entry-&gt;f2_as_index(), is_static);
1248   LastFrameAccessor last_frame(thread);
1249   JvmtiExport::post_field_access(thread, last_frame.method(), last_frame.bcp(), cp_entry_f1, h_obj, fid);
<span class="line-modified">1250 IRT_END</span>
1251 
<span class="line-modified">1252 IRT_ENTRY(void, InterpreterRuntime::post_field_modification(JavaThread *thread,</span>
1253   oopDesc* obj, ConstantPoolCacheEntry *cp_entry, jvalue *value))
1254 
1255   Klass* k = cp_entry-&gt;f1_as_klass();
1256 
1257   // check the access_flags for the field in the klass
1258   InstanceKlass* ik = InstanceKlass::cast(k);
1259   int index = cp_entry-&gt;field_index();
1260   // bail out if field modifications are not watched
1261   if ((ik-&gt;field_access_flags(index) &amp; JVM_ACC_FIELD_MODIFICATION_WATCHED) == 0) return;
1262 
1263   char sig_type = &#39;\0&#39;;
1264 
1265   switch(cp_entry-&gt;flag_state()) {
<span class="line-modified">1266     case btos: sig_type = &#39;B&#39;; break;</span>
<span class="line-modified">1267     case ztos: sig_type = &#39;Z&#39;; break;</span>
<span class="line-modified">1268     case ctos: sig_type = &#39;C&#39;; break;</span>
<span class="line-modified">1269     case stos: sig_type = &#39;S&#39;; break;</span>
<span class="line-modified">1270     case itos: sig_type = &#39;I&#39;; break;</span>
<span class="line-modified">1271     case ftos: sig_type = &#39;F&#39;; break;</span>
<span class="line-modified">1272     case atos: sig_type = &#39;L&#39;; break;</span>
<span class="line-modified">1273     case ltos: sig_type = &#39;J&#39;; break;</span>
<span class="line-modified">1274     case dtos: sig_type = &#39;D&#39;; break;</span>
1275     default:  ShouldNotReachHere(); return;
1276   }
1277   bool is_static = (obj == NULL);
1278 
1279   HandleMark hm(thread);
1280   jfieldID fid = jfieldIDWorkaround::to_jfieldID(ik, cp_entry-&gt;f2_as_index(), is_static);
1281   jvalue fvalue;
1282 #ifdef _LP64
1283   fvalue = *value;
1284 #else
1285   // Long/double values are stored unaligned and also noncontiguously with
1286   // tagged stacks.  We can&#39;t just do a simple assignment even in the non-
1287   // J/D cases because a C++ compiler is allowed to assume that a jvalue is
1288   // 8-byte aligned, and interpreter stack slots are only 4-byte aligned.
1289   // We assume that the two halves of longs/doubles are stored in interpreter
1290   // stack slots in platform-endian order.
1291   jlong_accessor u;
1292   jint* newval = (jint*)value;
1293   u.words[0] = newval[0];
1294   u.words[1] = newval[Interpreter::stackElementWords]; // skip if tag
1295   fvalue.j = u.long_value;
1296 #endif // _LP64
1297 
1298   Handle h_obj;
1299   if (!is_static) {
1300     // non-static field accessors have an object, but we need a handle
1301     h_obj = Handle(thread, obj);
1302   }
1303 
1304   LastFrameAccessor last_frame(thread);
1305   JvmtiExport::post_raw_field_modification(thread, last_frame.method(), last_frame.bcp(), ik, h_obj,
1306                                            fid, sig_type, &amp;fvalue);
<span class="line-modified">1307 IRT_END</span>
1308 
<span class="line-modified">1309 IRT_ENTRY(void, InterpreterRuntime::post_method_entry(JavaThread *thread))</span>
1310   LastFrameAccessor last_frame(thread);
1311   JvmtiExport::post_method_entry(thread, last_frame.method(), last_frame.get_frame());
<span class="line-modified">1312 IRT_END</span>
1313 
1314 
<span class="line-modified">1315 IRT_ENTRY(void, InterpreterRuntime::post_method_exit(JavaThread *thread))</span>
1316   LastFrameAccessor last_frame(thread);
1317   JvmtiExport::post_method_exit(thread, last_frame.method(), last_frame.get_frame());
<span class="line-modified">1318 IRT_END</span>
1319 
<span class="line-modified">1320 IRT_LEAF(int, InterpreterRuntime::interpreter_contains(address pc))</span>
1321 {
1322   return (Interpreter::contains(pc) ? 1 : 0);
1323 }
<span class="line-modified">1324 IRT_END</span>
1325 
1326 
1327 // Implementation of SignatureHandlerLibrary
1328 
1329 #ifndef SHARING_FAST_NATIVE_FINGERPRINTS
1330 // Dummy definition (else normalization method is defined in CPU
1331 // dependant code)
1332 uint64_t InterpreterRuntime::normalize_fast_native_fingerprint(uint64_t fingerprint) {
1333   return fingerprint;
1334 }
1335 #endif
1336 
1337 address SignatureHandlerLibrary::set_handler_blob() {
1338   BufferBlob* handler_blob = BufferBlob::create(&quot;native signature handlers&quot;, blob_size);
1339   if (handler_blob == NULL) {
1340     return NULL;
1341   }
1342   address handler = handler_blob-&gt;code_begin();
1343   _handler_blob = handler_blob;
1344   _handler = handler;
</pre>
<hr />
<pre>
1365   address handler   = _handler;
1366   int     insts_size = buffer-&gt;pure_insts_size();
1367   if (handler + insts_size &gt; _handler_blob-&gt;code_end()) {
1368     // get a new handler blob
1369     handler = set_handler_blob();
1370   }
1371   if (handler != NULL) {
1372     memcpy(handler, buffer-&gt;insts_begin(), insts_size);
1373     pd_set_handler(handler);
1374     ICache::invalidate_range(handler, insts_size);
1375     _handler = handler + insts_size;
1376   }
1377   return handler;
1378 }
1379 
1380 void SignatureHandlerLibrary::add(const methodHandle&amp; method) {
1381   if (method-&gt;signature_handler() == NULL) {
1382     // use slow signature handler if we can&#39;t do better
1383     int handler_index = -1;
1384     // check if we can use customized (fast) signature handler
<span class="line-modified">1385     if (UseFastSignatureHandlers &amp;&amp; method-&gt;size_of_parameters() &lt;= Fingerprinter::max_size_of_parameters) {</span>
1386       // use customized signature handler
1387       MutexLocker mu(SignatureHandlerLibrary_lock);
1388       // make sure data structure is initialized
1389       initialize();
1390       // lookup method signature&#39;s fingerprint
1391       uint64_t fingerprint = Fingerprinter(method).fingerprint();
1392       // allow CPU dependant code to optimize the fingerprints for the fast handler
1393       fingerprint = InterpreterRuntime::normalize_fast_native_fingerprint(fingerprint);
1394       handler_index = _fingerprints-&gt;find(fingerprint);
1395       // create handler if necessary
1396       if (handler_index &lt; 0) {
1397         ResourceMark rm;
1398         ptrdiff_t align_offset = align_up(_buffer, CodeEntryAlignment) - (address)_buffer;
1399         CodeBuffer buffer((address)(_buffer + align_offset),
1400                           SignatureHandlerLibrary::buffer_size - align_offset);
1401         InterpreterRuntime::SignatureHandlerGenerator(method, &amp;buffer).generate(fingerprint);
1402         // copy into code heap
1403         address handler = set_handler(&amp;buffer);
1404         if (handler == NULL) {
1405           // use slow signature handler (without memorizing it in the fingerprints)
</pre>
<hr />
<pre>
1432             }
1433 #endif
1434           }
1435           // add handler to library
1436           _fingerprints-&gt;append(fingerprint);
1437           _handlers-&gt;append(handler);
1438           // set handler index
1439           assert(_fingerprints-&gt;length() == _handlers-&gt;length(), &quot;sanity check&quot;);
1440           handler_index = _fingerprints-&gt;length() - 1;
1441         }
1442       }
1443       // Set handler under SignatureHandlerLibrary_lock
1444       if (handler_index &lt; 0) {
1445         // use generic signature handler
1446         method-&gt;set_signature_handler(Interpreter::slow_signature_handler());
1447       } else {
1448         // set handler
1449         method-&gt;set_signature_handler(_handlers-&gt;at(handler_index));
1450       }
1451     } else {
<span class="line-modified">1452       CHECK_UNHANDLED_OOPS_ONLY(Thread::current()-&gt;clear_unhandled_oops());</span>
1453       // use generic signature handler
1454       method-&gt;set_signature_handler(Interpreter::slow_signature_handler());
1455     }
1456   }
1457 #ifdef ASSERT
1458   int handler_index = -1;
1459   int fingerprint_index = -2;
1460   {
1461     // &#39;_handlers&#39; and &#39;_fingerprints&#39; are &#39;GrowableArray&#39;s and are NOT synchronized
1462     // in any way if accessed from multiple threads. To avoid races with another
1463     // thread which may change the arrays in the above, mutex protected block, we
1464     // have to protect this read access here with the same mutex as well!
1465     MutexLocker mu(SignatureHandlerLibrary_lock);
1466     if (_handlers != NULL) {
1467       handler_index = _handlers-&gt;find(method-&gt;signature_handler());
1468       uint64_t fingerprint = Fingerprinter(method).fingerprint();
1469       fingerprint = InterpreterRuntime::normalize_fast_native_fingerprint(fingerprint);
1470       fingerprint_index = _fingerprints-&gt;find(fingerprint);
1471     }
1472   }
</pre>
<hr />
<pre>
1497   } else {
1498     if (PrintSignatureHandlers) {
1499       tty-&gt;cr();
1500       tty-&gt;print_cr(&quot;duplicate argument handler #%d for fingerprint &quot; UINT64_FORMAT &quot;(old: &quot; PTR_FORMAT &quot;, new : &quot; PTR_FORMAT &quot;)&quot;,
1501                     _handlers-&gt;length(),
1502                     fingerprint,
1503                     p2i(_handlers-&gt;at(handler_index)),
1504                     p2i(handler));
1505     }
1506   }
1507 }
1508 
1509 
1510 BufferBlob*              SignatureHandlerLibrary::_handler_blob = NULL;
1511 address                  SignatureHandlerLibrary::_handler      = NULL;
1512 GrowableArray&lt;uint64_t&gt;* SignatureHandlerLibrary::_fingerprints = NULL;
1513 GrowableArray&lt;address&gt;*  SignatureHandlerLibrary::_handlers     = NULL;
1514 address                  SignatureHandlerLibrary::_buffer       = NULL;
1515 
1516 
<span class="line-modified">1517 IRT_ENTRY(void, InterpreterRuntime::prepare_native_call(JavaThread* thread, Method* method))</span>
1518   methodHandle m(thread, method);
1519   assert(m-&gt;is_native(), &quot;sanity check&quot;);
1520   // lookup native function entry point if it doesn&#39;t exist
1521   bool in_base_library;
1522   if (!m-&gt;has_native_function()) {
1523     NativeLookup::lookup(m, in_base_library, CHECK);
1524   }
1525   // make sure signature handler is installed
1526   SignatureHandlerLibrary::add(m);
1527   // The interpreter entry point checks the signature handler first,
1528   // before trying to fetch the native entry point and klass mirror.
1529   // We must set the signature handler last, so that multiple processors
1530   // preparing the same method will be sure to see non-null entry &amp; mirror.
<span class="line-modified">1531 IRT_END</span>
1532 
1533 #if defined(IA32) || defined(AMD64) || defined(ARM)
<span class="line-modified">1534 IRT_LEAF(void, InterpreterRuntime::popframe_move_outgoing_args(JavaThread* thread, void* src_address, void* dest_address))</span>
1535   if (src_address == dest_address) {
1536     return;
1537   }
1538   ResetNoHandleMark rnm; // In a LEAF entry.
1539   HandleMark hm;
1540   ResourceMark rm;
1541   LastFrameAccessor last_frame(thread);
1542   assert(last_frame.is_interpreted_frame(), &quot;&quot;);
1543   jint bci = last_frame.bci();
1544   methodHandle mh(thread, last_frame.method());
1545   Bytecode_invoke invoke(mh, bci);
1546   ArgumentSizeComputer asc(invoke.signature());
1547   int size_of_arguments = (asc.size() + (invoke.has_receiver() ? 1 : 0)); // receiver
1548   Copy::conjoint_jbytes(src_address, dest_address,
1549                        size_of_arguments * Interpreter::stackElementSize);
<span class="line-modified">1550 IRT_END</span>
1551 #endif
1552 
1553 #if INCLUDE_JVMTI
1554 // This is a support of the JVMTI PopFrame interface.
1555 // Make sure it is an invokestatic of a polymorphic intrinsic that has a member_name argument
1556 // and return it as a vm_result so that it can be reloaded in the list of invokestatic parameters.
1557 // The member_name argument is a saved reference (in local#0) to the member_name.
1558 // For backward compatibility with some JDK versions (7, 8) it can also be a direct method handle.
1559 // FIXME: remove DMH case after j.l.i.InvokerBytecodeGenerator code shape is updated.
<span class="line-modified">1560 IRT_ENTRY(void, InterpreterRuntime::member_name_arg_or_null(JavaThread* thread, address member_name,</span>
1561                                                             Method* method, address bcp))
1562   Bytecodes::Code code = Bytecodes::code_at(method, bcp);
1563   if (code != Bytecodes::_invokestatic) {
1564     return;
1565   }
1566   ConstantPool* cpool = method-&gt;constants();
1567   int cp_index = Bytes::get_native_u2(bcp + 1) + ConstantPool::CPCACHE_INDEX_TAG;
1568   Symbol* cname = cpool-&gt;klass_name_at(cpool-&gt;klass_ref_index_at(cp_index));
1569   Symbol* mname = cpool-&gt;name_ref_at(cp_index);
1570 
1571   if (MethodHandles::has_member_arg(cname, mname)) {
1572     oop member_name_oop = (oop) member_name;
1573     if (java_lang_invoke_DirectMethodHandle::is_instance(member_name_oop)) {
1574       // FIXME: remove after j.l.i.InvokerBytecodeGenerator code shape is updated.
1575       member_name_oop = java_lang_invoke_DirectMethodHandle::member(member_name_oop);
1576     }
1577     thread-&gt;set_vm_result(member_name_oop);
1578   } else {
1579     thread-&gt;set_vm_result(NULL);
1580   }
<span class="line-modified">1581 IRT_END</span>
1582 #endif // INCLUDE_JVMTI
1583 
1584 #ifndef PRODUCT
<span class="line-modified">1585 // This must be a IRT_LEAF function because the interpreter must save registers on x86 to</span>
1586 // call this, which changes rsp and makes the interpreter&#39;s expression stack not walkable.
1587 // The generated code still uses call_VM because that will set up the frame pointer for
1588 // bcp and method.
<span class="line-modified">1589 IRT_LEAF(intptr_t, InterpreterRuntime::trace_bytecode(JavaThread* thread, intptr_t preserve_this_value, intptr_t tos, intptr_t tos2))</span>
1590   LastFrameAccessor last_frame(thread);
1591   assert(last_frame.is_interpreted_frame(), &quot;must be an interpreted frame&quot;);
1592   methodHandle mh(thread, last_frame.method());
1593   BytecodeTracer::trace(mh, last_frame.bcp(), tos, tos2);
1594   return preserve_this_value;
<span class="line-modified">1595 IRT_END</span>
1596 #endif // !PRODUCT
</pre>
</td>
<td>
<hr />
<pre>
   1 /*
<span class="line-modified">   2  * Copyright (c) 1997, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;classfile/javaClasses.inline.hpp&quot;
<span class="line-added">  27 #include &quot;classfile/symbolTable.hpp&quot;</span>
  28 #include &quot;classfile/systemDictionary.hpp&quot;
  29 #include &quot;classfile/vmSymbols.hpp&quot;
  30 #include &quot;code/codeCache.hpp&quot;
<span class="line-added">  31 #include &quot;compiler/compilationPolicy.hpp&quot;</span>
  32 #include &quot;compiler/compileBroker.hpp&quot;
  33 #include &quot;compiler/disassembler.hpp&quot;
  34 #include &quot;gc/shared/barrierSetNMethod.hpp&quot;
  35 #include &quot;gc/shared/collectedHeap.hpp&quot;
  36 #include &quot;interpreter/interpreter.hpp&quot;
  37 #include &quot;interpreter/interpreterRuntime.hpp&quot;
  38 #include &quot;interpreter/linkResolver.hpp&quot;
  39 #include &quot;interpreter/templateTable.hpp&quot;
  40 #include &quot;logging/log.hpp&quot;
  41 #include &quot;memory/oopFactory.hpp&quot;
  42 #include &quot;memory/resourceArea.hpp&quot;
  43 #include &quot;memory/universe.hpp&quot;
  44 #include &quot;oops/constantPool.hpp&quot;
  45 #include &quot;oops/cpCache.inline.hpp&quot;
  46 #include &quot;oops/instanceKlass.hpp&quot;
  47 #include &quot;oops/methodData.hpp&quot;
  48 #include &quot;oops/objArrayKlass.hpp&quot;
  49 #include &quot;oops/objArrayOop.inline.hpp&quot;
  50 #include &quot;oops/oop.inline.hpp&quot;
  51 #include &quot;oops/symbol.hpp&quot;
  52 #include &quot;prims/jvmtiExport.hpp&quot;
  53 #include &quot;prims/nativeLookup.hpp&quot;
  54 #include &quot;runtime/atomic.hpp&quot;
  55 #include &quot;runtime/biasedLocking.hpp&quot;

  56 #include &quot;runtime/deoptimization.hpp&quot;
  57 #include &quot;runtime/fieldDescriptor.inline.hpp&quot;
  58 #include &quot;runtime/frame.inline.hpp&quot;
  59 #include &quot;runtime/handles.inline.hpp&quot;
  60 #include &quot;runtime/icache.hpp&quot;
  61 #include &quot;runtime/interfaceSupport.inline.hpp&quot;
  62 #include &quot;runtime/java.hpp&quot;
  63 #include &quot;runtime/javaCalls.hpp&quot;
  64 #include &quot;runtime/jfieldIDWorkaround.hpp&quot;
  65 #include &quot;runtime/osThread.hpp&quot;
  66 #include &quot;runtime/sharedRuntime.hpp&quot;
  67 #include &quot;runtime/stubRoutines.hpp&quot;
  68 #include &quot;runtime/synchronizer.hpp&quot;
  69 #include &quot;runtime/threadCritical.hpp&quot;
  70 #include &quot;utilities/align.hpp&quot;
  71 #include &quot;utilities/copy.hpp&quot;
  72 #include &quot;utilities/events.hpp&quot;
  73 #ifdef COMPILER2
  74 #include &quot;opto/runtime.hpp&quot;
  75 #endif
</pre>
<hr />
<pre>
 140 // State accessors
 141 
 142 void InterpreterRuntime::set_bcp_and_mdp(address bcp, JavaThread *thread) {
 143   LastFrameAccessor last_frame(thread);
 144   last_frame.set_bcp(bcp);
 145   if (ProfileInterpreter) {
 146     // ProfileTraps uses MDOs independently of ProfileInterpreter.
 147     // That is why we must check both ProfileInterpreter and mdo != NULL.
 148     MethodData* mdo = last_frame.method()-&gt;method_data();
 149     if (mdo != NULL) {
 150       NEEDS_CLEANUP;
 151       last_frame.set_mdp(mdo-&gt;bci_to_dp(last_frame.bci()));
 152     }
 153   }
 154 }
 155 
 156 //------------------------------------------------------------------------------------------------------------------------
 157 // Constants
 158 
 159 
<span class="line-modified"> 160 JRT_ENTRY(void, InterpreterRuntime::ldc(JavaThread* thread, bool wide))</span>
 161   // access constant pool
 162   LastFrameAccessor last_frame(thread);
 163   ConstantPool* pool = last_frame.method()-&gt;constants();
 164   int index = wide ? last_frame.get_index_u2(Bytecodes::_ldc_w) : last_frame.get_index_u1(Bytecodes::_ldc);
 165   constantTag tag = pool-&gt;tag_at(index);
 166 
 167   assert (tag.is_unresolved_klass() || tag.is_klass(), &quot;wrong ldc call&quot;);
 168   Klass* klass = pool-&gt;klass_at(index, CHECK);
 169     oop java_class = klass-&gt;java_mirror();
 170     thread-&gt;set_vm_result(java_class);
<span class="line-modified"> 171 JRT_END</span>
 172 
<span class="line-modified"> 173 JRT_ENTRY(void, InterpreterRuntime::resolve_ldc(JavaThread* thread, Bytecodes::Code bytecode)) {</span>
 174   assert(bytecode == Bytecodes::_ldc ||
 175          bytecode == Bytecodes::_ldc_w ||
 176          bytecode == Bytecodes::_ldc2_w ||
 177          bytecode == Bytecodes::_fast_aldc ||
 178          bytecode == Bytecodes::_fast_aldc_w, &quot;wrong bc&quot;);
 179   ResourceMark rm(thread);
 180   const bool is_fast_aldc = (bytecode == Bytecodes::_fast_aldc ||
 181                              bytecode == Bytecodes::_fast_aldc_w);
 182   LastFrameAccessor last_frame(thread);
 183   methodHandle m (thread, last_frame.method());
 184   Bytecode_loadconstant ldc(m, last_frame.bci());
 185 
 186   // Double-check the size.  (Condy can have any type.)
 187   BasicType type = ldc.result_type();
 188   switch (type2size[type]) {
 189   case 2: guarantee(bytecode == Bytecodes::_ldc2_w, &quot;&quot;); break;
 190   case 1: guarantee(bytecode != Bytecodes::_ldc2_w, &quot;&quot;); break;
 191   default: ShouldNotReachHere();
 192   }
 193 
 194   // Resolve the constant.  This does not do unboxing.
 195   // But it does replace Universe::the_null_sentinel by null.
 196   oop result = ldc.resolve_constant(CHECK);
 197   assert(result != NULL || is_fast_aldc, &quot;null result only valid for fast_aldc&quot;);
 198 
 199 #ifdef ASSERT
 200   {
 201     // The bytecode wrappers aren&#39;t GC-safe so construct a new one
 202     Bytecode_loadconstant ldc2(m, last_frame.bci());
 203     int rindex = ldc2.cache_index();
 204     if (rindex &lt; 0)
 205       rindex = m-&gt;constants()-&gt;cp_to_object_index(ldc2.pool_index());
 206     if (rindex &gt;= 0) {
 207       oop coop = m-&gt;constants()-&gt;resolved_references()-&gt;obj_at(rindex);
 208       oop roop = (result == NULL ? Universe::the_null_sentinel() : result);
<span class="line-modified"> 209       assert(roop == coop, &quot;expected result for assembly code&quot;);</span>
 210     }
 211   }
 212 #endif
 213   thread-&gt;set_vm_result(result);
 214   if (!is_fast_aldc) {
 215     // Tell the interpreter how to unbox the primitive.
 216     guarantee(java_lang_boxing_object::is_instance(result, type), &quot;&quot;);
 217     int offset = java_lang_boxing_object::value_offset_in_bytes(type);
 218     intptr_t flags = ((as_TosState(type) &lt;&lt; ConstantPoolCacheEntry::tos_state_shift)
 219                       | (offset &amp; ConstantPoolCacheEntry::field_index_mask));
 220     thread-&gt;set_vm_result_2((Metadata*)flags);
 221   }
 222 }
<span class="line-modified"> 223 JRT_END</span>
 224 
 225 
 226 //------------------------------------------------------------------------------------------------------------------------
 227 // Allocation
 228 
<span class="line-modified"> 229 JRT_ENTRY(void, InterpreterRuntime::_new(JavaThread* thread, ConstantPool* pool, int index))</span>
 230   Klass* k = pool-&gt;klass_at(index, CHECK);
 231   InstanceKlass* klass = InstanceKlass::cast(k);
 232 
 233   // Make sure we are not instantiating an abstract klass
 234   klass-&gt;check_valid_for_instantiation(true, CHECK);
 235 
 236   // Make sure klass is initialized
 237   klass-&gt;initialize(CHECK);
 238 
 239   // At this point the class may not be fully initialized
 240   // because of recursive initialization. If it is fully
 241   // initialized &amp; has_finalized is not set, we rewrite
 242   // it into its fast version (Note: no locking is needed
 243   // here since this is an atomic byte write and can be
 244   // done more than once).
 245   //
 246   // Note: In case of classes with has_finalized we don&#39;t
 247   //       rewrite since that saves us an extra check in
 248   //       the fast version which then would call the
 249   //       slow version anyway (and do a call back into
 250   //       Java).
 251   //       If we have a breakpoint, then we don&#39;t rewrite
 252   //       because the _breakpoint bytecode would be lost.
 253   oop obj = klass-&gt;allocate_instance(CHECK);
 254   thread-&gt;set_vm_result(obj);
<span class="line-modified"> 255 JRT_END</span>
 256 
 257 
<span class="line-modified"> 258 JRT_ENTRY(void, InterpreterRuntime::newarray(JavaThread* thread, BasicType type, jint size))</span>
 259   oop obj = oopFactory::new_typeArray(type, size, CHECK);
 260   thread-&gt;set_vm_result(obj);
<span class="line-modified"> 261 JRT_END</span>
 262 
 263 
<span class="line-modified"> 264 JRT_ENTRY(void, InterpreterRuntime::anewarray(JavaThread* thread, ConstantPool* pool, int index, jint size))</span>
 265   Klass*    klass = pool-&gt;klass_at(index, CHECK);
 266   objArrayOop obj = oopFactory::new_objArray(klass, size, CHECK);
 267   thread-&gt;set_vm_result(obj);
<span class="line-modified"> 268 JRT_END</span>
 269 
 270 
<span class="line-modified"> 271 JRT_ENTRY(void, InterpreterRuntime::multianewarray(JavaThread* thread, jint* first_size_address))</span>
 272   // We may want to pass in more arguments - could make this slightly faster
 273   LastFrameAccessor last_frame(thread);
 274   ConstantPool* constants = last_frame.method()-&gt;constants();
 275   int          i = last_frame.get_index_u2(Bytecodes::_multianewarray);
 276   Klass* klass   = constants-&gt;klass_at(i, CHECK);
 277   int   nof_dims = last_frame.number_of_dimensions();
 278   assert(klass-&gt;is_klass(), &quot;not a class&quot;);
 279   assert(nof_dims &gt;= 1, &quot;multianewarray rank must be nonzero&quot;);
 280 
 281   // We must create an array of jints to pass to multi_allocate.
 282   ResourceMark rm(thread);
 283   const int small_dims = 10;
 284   jint dim_array[small_dims];
 285   jint *dims = &amp;dim_array[0];
 286   if (nof_dims &gt; small_dims) {
 287     dims = (jint*) NEW_RESOURCE_ARRAY(jint, nof_dims);
 288   }
 289   for (int index = 0; index &lt; nof_dims; index++) {
 290     // offset from first_size_address is addressed as local[index]
 291     int n = Interpreter::local_offset_in_bytes(index)/jintSize;
 292     dims[index] = first_size_address[n];
 293   }
 294   oop obj = ArrayKlass::cast(klass)-&gt;multi_allocate(nof_dims, dims, CHECK);
 295   thread-&gt;set_vm_result(obj);
<span class="line-modified"> 296 JRT_END</span>
 297 
 298 
<span class="line-modified"> 299 JRT_ENTRY(void, InterpreterRuntime::register_finalizer(JavaThread* thread, oopDesc* obj))</span>
 300   assert(oopDesc::is_oop(obj), &quot;must be a valid oop&quot;);
 301   assert(obj-&gt;klass()-&gt;has_finalizer(), &quot;shouldn&#39;t be here otherwise&quot;);
 302   InstanceKlass::register_finalizer(instanceOop(obj), CHECK);
<span class="line-modified"> 303 JRT_END</span>
 304 
 305 
 306 // Quicken instance-of and check-cast bytecodes
<span class="line-modified"> 307 JRT_ENTRY(void, InterpreterRuntime::quicken_io_cc(JavaThread* thread))</span>
 308   // Force resolving; quicken the bytecode
 309   LastFrameAccessor last_frame(thread);
 310   int which = last_frame.get_index_u2(Bytecodes::_checkcast);
 311   ConstantPool* cpool = last_frame.method()-&gt;constants();
 312   // We&#39;d expect to assert that we&#39;re only here to quicken bytecodes, but in a multithreaded
 313   // program we might have seen an unquick&#39;d bytecode in the interpreter but have another
 314   // thread quicken the bytecode before we get here.
 315   // assert( cpool-&gt;tag_at(which).is_unresolved_klass(), &quot;should only come here to quicken bytecodes&quot; );
 316   Klass* klass = cpool-&gt;klass_at(which, CHECK);
 317   thread-&gt;set_vm_result_2(klass);
<span class="line-modified"> 318 JRT_END</span>
 319 
 320 
 321 //------------------------------------------------------------------------------------------------------------------------
 322 // Exceptions
 323 
 324 void InterpreterRuntime::note_trap_inner(JavaThread* thread, int reason,
 325                                          const methodHandle&amp; trap_method, int trap_bci, TRAPS) {
 326   if (trap_method.not_null()) {
 327     MethodData* trap_mdo = trap_method-&gt;method_data();
 328     if (trap_mdo == NULL) {
 329       Method::build_interpreter_method_data(trap_method, THREAD);
 330       if (HAS_PENDING_EXCEPTION) {
 331         assert((PENDING_EXCEPTION-&gt;is_a(SystemDictionary::OutOfMemoryError_klass())),
 332                &quot;we expect only an OOM error here&quot;);
 333         CLEAR_PENDING_EXCEPTION;
 334       }
 335       trap_mdo = trap_method-&gt;method_data();
 336       // and fall through...
 337     }
 338     if (trap_mdo != NULL) {
 339       // Update per-method count of trap events.  The interpreter
 340       // is updating the MDO to simulate the effect of compiler traps.
 341       Deoptimization::update_method_data_from_interpreter(trap_mdo, trap_bci, reason);
 342     }
 343   }
 344 }
 345 
 346 // Assume the compiler is (or will be) interested in this event.
 347 // If necessary, create an MDO to hold the information, and record it.
 348 void InterpreterRuntime::note_trap(JavaThread* thread, int reason, TRAPS) {
 349   assert(ProfileTraps, &quot;call me only if profiling&quot;);
 350   LastFrameAccessor last_frame(thread);
 351   methodHandle trap_method(thread, last_frame.method());
 352   int trap_bci = trap_method-&gt;bci_from(last_frame.bcp());
 353   note_trap_inner(thread, reason, trap_method, trap_bci, THREAD);
 354 }
 355 
 356 #ifdef CC_INTERP
 357 // As legacy note_trap, but we have more arguments.
<span class="line-modified"> 358 JRT_ENTRY(void, InterpreterRuntime::note_trap(JavaThread* thread, int reason, Method *method, int trap_bci))</span>
<span class="line-modified"> 359   methodHandle trap_method(thread, method);</span>
 360   note_trap_inner(thread, reason, trap_method, trap_bci, THREAD);
<span class="line-modified"> 361 JRT_END</span>
 362 
 363 // Class Deoptimization is not visible in BytecodeInterpreter, so we need a wrapper
 364 // for each exception.
 365 void InterpreterRuntime::note_nullCheck_trap(JavaThread* thread, Method *method, int trap_bci)
 366   { if (ProfileTraps) note_trap(thread, Deoptimization::Reason_null_check, method, trap_bci); }
 367 void InterpreterRuntime::note_div0Check_trap(JavaThread* thread, Method *method, int trap_bci)
 368   { if (ProfileTraps) note_trap(thread, Deoptimization::Reason_div0_check, method, trap_bci); }
 369 void InterpreterRuntime::note_rangeCheck_trap(JavaThread* thread, Method *method, int trap_bci)
 370   { if (ProfileTraps) note_trap(thread, Deoptimization::Reason_range_check, method, trap_bci); }
 371 void InterpreterRuntime::note_classCheck_trap(JavaThread* thread, Method *method, int trap_bci)
 372   { if (ProfileTraps) note_trap(thread, Deoptimization::Reason_class_check, method, trap_bci); }
 373 void InterpreterRuntime::note_arrayCheck_trap(JavaThread* thread, Method *method, int trap_bci)
 374   { if (ProfileTraps) note_trap(thread, Deoptimization::Reason_array_check, method, trap_bci); }
 375 #endif // CC_INTERP
 376 
 377 
 378 static Handle get_preinitialized_exception(Klass* k, TRAPS) {
 379   // get klass
 380   InstanceKlass* klass = InstanceKlass::cast(k);
 381   assert(klass-&gt;is_initialized(),
 382          &quot;this klass should have been initialized during VM initialization&quot;);
 383   // create instance - do not call constructor since we may have no
 384   // (java) stack space left (should assert constructor is empty)
 385   Handle exception;
 386   oop exception_oop = klass-&gt;allocate_instance(CHECK_(exception));
 387   exception = Handle(THREAD, exception_oop);
 388   if (StackTraceInThrowable) {
 389     java_lang_Throwable::fill_in_stack_trace(exception);
 390   }
 391   return exception;
 392 }
 393 
 394 // Special handling for stack overflow: since we don&#39;t have any (java) stack
 395 // space left we use the pre-allocated &amp; pre-initialized StackOverflowError
 396 // klass to create an stack overflow error instance.  We do not call its
 397 // constructor for the same reason (it is empty, anyway).
<span class="line-modified"> 398 JRT_ENTRY(void, InterpreterRuntime::throw_StackOverflowError(JavaThread* thread))</span>
 399   Handle exception = get_preinitialized_exception(
 400                                  SystemDictionary::StackOverflowError_klass(),
 401                                  CHECK);
 402   // Increment counter for hs_err file reporting
 403   Atomic::inc(&amp;Exceptions::_stack_overflow_errors);
 404   THROW_HANDLE(exception);
<span class="line-modified"> 405 JRT_END</span>
 406 
<span class="line-modified"> 407 JRT_ENTRY(void, InterpreterRuntime::throw_delayed_StackOverflowError(JavaThread* thread))</span>
 408   Handle exception = get_preinitialized_exception(
 409                                  SystemDictionary::StackOverflowError_klass(),
 410                                  CHECK);
 411   java_lang_Throwable::set_message(exception(),
 412           Universe::delayed_stack_overflow_error_message());
 413   // Increment counter for hs_err file reporting
 414   Atomic::inc(&amp;Exceptions::_stack_overflow_errors);
 415   THROW_HANDLE(exception);
<span class="line-modified"> 416 JRT_END</span>
 417 
<span class="line-modified"> 418 JRT_ENTRY(void, InterpreterRuntime::create_exception(JavaThread* thread, char* name, char* message))</span>
 419   // lookup exception klass
<span class="line-modified"> 420   TempNewSymbol s = SymbolTable::new_symbol(name);</span>
 421   if (ProfileTraps) {
 422     if (s == vmSymbols::java_lang_ArithmeticException()) {
 423       note_trap(thread, Deoptimization::Reason_div0_check, CHECK);
 424     } else if (s == vmSymbols::java_lang_NullPointerException()) {
 425       note_trap(thread, Deoptimization::Reason_null_check, CHECK);
 426     }
 427   }
 428   // create exception
 429   Handle exception = Exceptions::new_exception(thread, s, message);
 430   thread-&gt;set_vm_result(exception());
<span class="line-modified"> 431 JRT_END</span>
 432 
 433 
<span class="line-modified"> 434 JRT_ENTRY(void, InterpreterRuntime::create_klass_exception(JavaThread* thread, char* name, oopDesc* obj))</span>
 435   // Produce the error message first because note_trap can safepoint
 436   ResourceMark rm(thread);
 437   const char* klass_name = obj-&gt;klass()-&gt;external_name();
 438   // lookup exception klass
<span class="line-modified"> 439   TempNewSymbol s = SymbolTable::new_symbol(name);</span>
 440   if (ProfileTraps) {
 441     note_trap(thread, Deoptimization::Reason_class_check, CHECK);
 442   }
 443   // create exception, with klass name as detail message
 444   Handle exception = Exceptions::new_exception(thread, s, klass_name);
 445   thread-&gt;set_vm_result(exception());
<span class="line-modified"> 446 JRT_END</span>
 447 
<span class="line-modified"> 448 JRT_ENTRY(void, InterpreterRuntime::throw_ArrayIndexOutOfBoundsException(JavaThread* thread, arrayOopDesc* a, jint index))</span>
 449   // Produce the error message first because note_trap can safepoint
 450   ResourceMark rm(thread);
 451   stringStream ss;
 452   ss.print(&quot;Index %d out of bounds for length %d&quot;, index, a-&gt;length());
 453 
 454   if (ProfileTraps) {
 455     note_trap(thread, Deoptimization::Reason_range_check, CHECK);
 456   }
 457 
 458   THROW_MSG(vmSymbols::java_lang_ArrayIndexOutOfBoundsException(), ss.as_string());
<span class="line-modified"> 459 JRT_END</span>
 460 
<span class="line-modified"> 461 JRT_ENTRY(void, InterpreterRuntime::throw_ClassCastException(</span>
 462   JavaThread* thread, oopDesc* obj))
 463 
 464   // Produce the error message first because note_trap can safepoint
 465   ResourceMark rm(thread);
 466   char* message = SharedRuntime::generate_class_cast_message(
 467     thread, obj-&gt;klass());
 468 
 469   if (ProfileTraps) {
 470     note_trap(thread, Deoptimization::Reason_class_check, CHECK);
 471   }
 472 
 473   // create exception
 474   THROW_MSG(vmSymbols::java_lang_ClassCastException(), message);
<span class="line-modified"> 475 JRT_END</span>
 476 
 477 // exception_handler_for_exception(...) returns the continuation address,
 478 // the exception oop (via TLS) and sets the bci/bcp for the continuation.
 479 // The exception oop is returned to make sure it is preserved over GC (it
 480 // is only on the stack if the exception was thrown explicitly via athrow).
 481 // During this operation, the expression stack contains the values for the
 482 // bci where the exception happened. If the exception was propagated back
 483 // from a call, the expression stack contains the values for the bci at the
 484 // invoke w/o arguments (i.e., as if one were inside the call).
<span class="line-modified"> 485 JRT_ENTRY(address, InterpreterRuntime::exception_handler_for_exception(JavaThread* thread, oopDesc* exception))</span>
 486 
 487   LastFrameAccessor last_frame(thread);
 488   Handle             h_exception(thread, exception);
 489   methodHandle       h_method   (thread, last_frame.method());
 490   constantPoolHandle h_constants(thread, h_method-&gt;constants());
 491   bool               should_repeat;
 492   int                handler_bci;
 493   int                current_bci = last_frame.bci();
 494 
 495   if (thread-&gt;frames_to_pop_failed_realloc() &gt; 0) {
 496     // Allocation of scalar replaced object used in this frame
 497     // failed. Unconditionally pop the frame.
 498     thread-&gt;dec_frames_to_pop_failed_realloc();
 499     thread-&gt;set_vm_result(h_exception());
 500     // If the method is synchronized we already unlocked the monitor
 501     // during deoptimization so the interpreter needs to skip it when
 502     // the frame is popped.
 503     thread-&gt;set_do_not_unlock_if_synchronized(true);
 504 #ifdef CC_INTERP
 505     return (address) -1;
</pre>
<hr />
<pre>
 526   do {
 527     should_repeat = false;
 528 
 529     // assertions
 530 #ifdef ASSERT
 531     assert(h_exception.not_null(), &quot;NULL exceptions should be handled by athrow&quot;);
 532     // Check that exception is a subclass of Throwable, otherwise we have a VerifyError
 533     if (!(h_exception-&gt;is_a(SystemDictionary::Throwable_klass()))) {
 534       if (ExitVMOnVerifyError) vm_exit(-1);
 535       ShouldNotReachHere();
 536     }
 537 #endif
 538 
 539     // tracing
 540     if (log_is_enabled(Info, exceptions)) {
 541       ResourceMark rm(thread);
 542       stringStream tempst;
 543       tempst.print(&quot;interpreter method &lt;%s&gt;\n&quot;
 544                    &quot; at bci %d for thread &quot; INTPTR_FORMAT &quot; (%s)&quot;,
 545                    h_method-&gt;print_value_string(), current_bci, p2i(thread), thread-&gt;name());
<span class="line-modified"> 546       Exceptions::log_exception(h_exception, tempst.as_string());</span>
 547     }
 548 // Don&#39;t go paging in something which won&#39;t be used.
 549 //     else if (extable-&gt;length() == 0) {
 550 //       // disabled for now - interpreter is not using shortcut yet
 551 //       // (shortcut is not to call runtime if we have no exception handlers)
 552 //       // warning(&quot;performance bug: should not call runtime if method has no exception handlers&quot;);
 553 //     }
 554     // for AbortVMOnException flag
 555     Exceptions::debug_check_abort(h_exception);
 556 
 557     // exception handler lookup
 558     Klass* klass = h_exception-&gt;klass();
 559     handler_bci = Method::fast_exception_handler_bci_for(h_method, klass, current_bci, THREAD);
 560     if (HAS_PENDING_EXCEPTION) {
 561       // We threw an exception while trying to find the exception handler.
 562       // Transfer the new exception to the exception handle which will
 563       // be set into thread local storage, and do another lookup for an
 564       // exception handler for this exception, this time starting at the
 565       // BCI of the exception handler which caused the exception to be
 566       // thrown (bug 4307310).
</pre>
<hr />
<pre>
 606 #if COMPILER2_OR_JVMCI
 607     // Count this for compilation purposes
 608     h_method-&gt;interpreter_throwout_increment(THREAD);
 609 #endif
 610   } else {
 611     // handler in this method =&gt; change bci/bcp to handler bci/bcp and continue there
 612     handler_pc = h_method-&gt;code_base() + handler_bci;
 613 #ifndef CC_INTERP
 614     set_bcp_and_mdp(handler_pc, thread);
 615     continuation = Interpreter::dispatch_table(vtos)[*handler_pc];
 616 #endif
 617   }
 618   // notify debugger of an exception catch
 619   // (this is good for exceptions caught in native methods as well)
 620   if (JvmtiExport::can_post_on_exceptions()) {
 621     JvmtiExport::notice_unwind_due_to_exception(thread, h_method(), handler_pc, h_exception(), (handler_pc != NULL));
 622   }
 623 
 624   thread-&gt;set_vm_result(h_exception());
 625   return continuation;
<span class="line-modified"> 626 JRT_END</span>
 627 
 628 
<span class="line-modified"> 629 JRT_ENTRY(void, InterpreterRuntime::throw_pending_exception(JavaThread* thread))</span>
 630   assert(thread-&gt;has_pending_exception(), &quot;must only ne called if there&#39;s an exception pending&quot;);
 631   // nothing to do - eventually we should remove this code entirely (see comments @ call sites)
<span class="line-modified"> 632 JRT_END</span>
 633 
 634 
<span class="line-modified"> 635 JRT_ENTRY(void, InterpreterRuntime::throw_AbstractMethodError(JavaThread* thread))</span>
 636   THROW(vmSymbols::java_lang_AbstractMethodError());
<span class="line-modified"> 637 JRT_END</span>
 638 
 639 // This method is called from the &quot;abstract_entry&quot; of the interpreter.
 640 // At that point, the arguments have already been removed from the stack
 641 // and therefore we don&#39;t have the receiver object at our fingertips. (Though,
 642 // on some platforms the receiver still resides in a register...). Thus,
 643 // we have no choice but print an error message not containing the receiver
 644 // type.
<span class="line-modified"> 645 JRT_ENTRY(void, InterpreterRuntime::throw_AbstractMethodErrorWithMethod(JavaThread* thread,</span>
 646                                                                         Method* missingMethod))
 647   ResourceMark rm(thread);
 648   assert(missingMethod != NULL, &quot;sanity&quot;);
 649   methodHandle m(thread, missingMethod);
 650   LinkResolver::throw_abstract_method_error(m, THREAD);
<span class="line-modified"> 651 JRT_END</span>
 652 
<span class="line-modified"> 653 JRT_ENTRY(void, InterpreterRuntime::throw_AbstractMethodErrorVerbose(JavaThread* thread,</span>
 654                                                                      Klass* recvKlass,
 655                                                                      Method* missingMethod))
 656   ResourceMark rm(thread);
 657   methodHandle mh = methodHandle(thread, missingMethod);
 658   LinkResolver::throw_abstract_method_error(mh, recvKlass, THREAD);
<span class="line-modified"> 659 JRT_END</span>
 660 
 661 
<span class="line-modified"> 662 JRT_ENTRY(void, InterpreterRuntime::throw_IncompatibleClassChangeError(JavaThread* thread))</span>
 663   THROW(vmSymbols::java_lang_IncompatibleClassChangeError());
<span class="line-modified"> 664 JRT_END</span>
 665 
<span class="line-modified"> 666 JRT_ENTRY(void, InterpreterRuntime::throw_IncompatibleClassChangeErrorVerbose(JavaThread* thread,</span>
 667                                                                               Klass* recvKlass,
 668                                                                               Klass* interfaceKlass))
 669   ResourceMark rm(thread);
 670   char buf[1000];
 671   buf[0] = &#39;\0&#39;;
 672   jio_snprintf(buf, sizeof(buf),
 673                &quot;Class %s does not implement the requested interface %s&quot;,
 674                recvKlass ? recvKlass-&gt;external_name() : &quot;NULL&quot;,
 675                interfaceKlass ? interfaceKlass-&gt;external_name() : &quot;NULL&quot;);
 676   THROW_MSG(vmSymbols::java_lang_IncompatibleClassChangeError(), buf);
<span class="line-modified"> 677 JRT_END</span>
 678 
 679 //------------------------------------------------------------------------------------------------------------------------
 680 // Fields
 681 //
 682 
 683 void InterpreterRuntime::resolve_get_put(JavaThread* thread, Bytecodes::Code bytecode) {
 684   Thread* THREAD = thread;
 685   // resolve field
 686   fieldDescriptor info;
 687   LastFrameAccessor last_frame(thread);
 688   constantPoolHandle pool(thread, last_frame.method()-&gt;constants());
 689   methodHandle m(thread, last_frame.method());
 690   bool is_put    = (bytecode == Bytecodes::_putfield  || bytecode == Bytecodes::_nofast_putfield ||
 691                     bytecode == Bytecodes::_putstatic);
 692   bool is_static = (bytecode == Bytecodes::_getstatic || bytecode == Bytecodes::_putstatic);
 693 
 694   {
 695     JvmtiHideSingleStepping jhss(thread);
 696     LinkResolver::resolve_field_access(info, pool, last_frame.get_index_u2_cpcache(bytecode),
 697                                        m, bytecode, CHECK);
</pre>
<hr />
<pre>
 750     info.field_holder(),
 751     info.index(),
 752     info.offset(),
 753     state,
 754     info.access_flags().is_final(),
 755     info.access_flags().is_volatile(),
 756     is_tsan_ignore,
 757     pool-&gt;pool_holder()
 758   );
 759 }
 760 
 761 
 762 //------------------------------------------------------------------------------------------------------------------------
 763 // Synchronization
 764 //
 765 // The interpreter&#39;s synchronization code is factored out so that it can
 766 // be shared by method invocation and synchronized blocks.
 767 //%note synchronization_3
 768 
 769 //%note monitor_1
<span class="line-modified"> 770 JRT_ENTRY_NO_ASYNC(void, InterpreterRuntime::monitorenter(JavaThread* thread, BasicObjectLock* elem))</span>
 771 #ifdef ASSERT
 772   thread-&gt;last_frame().interpreter_frame_verify_monitor(elem);
 773 #endif
 774   if (PrintBiasedLockingStatistics) {
 775     Atomic::inc(BiasedLocking::slow_path_entry_count_addr());
 776   }
 777   Handle h_obj(thread, elem-&gt;obj());
<span class="line-modified"> 778   assert(Universe::heap()-&gt;is_in_or_null(h_obj()),</span>
 779          &quot;must be NULL or an object&quot;);
<span class="line-modified"> 780   ObjectSynchronizer::enter(h_obj, elem-&gt;lock(), CHECK);</span>
<span class="line-modified"> 781   assert(Universe::heap()-&gt;is_in_or_null(elem-&gt;obj()),</span>





 782          &quot;must be NULL or an object&quot;);
 783 #ifdef ASSERT
 784   thread-&gt;last_frame().interpreter_frame_verify_monitor(elem);
 785 #endif
<span class="line-modified"> 786 JRT_END</span>
 787 
 788 
 789 //%note monitor_1
<span class="line-modified"> 790 JRT_ENTRY_NO_ASYNC(void, InterpreterRuntime::monitorexit(JavaThread* thread, BasicObjectLock* elem))</span>
 791 #ifdef ASSERT
 792   thread-&gt;last_frame().interpreter_frame_verify_monitor(elem);
 793 #endif
 794   Handle h_obj(thread, elem-&gt;obj());
<span class="line-modified"> 795   assert(Universe::heap()-&gt;is_in_or_null(h_obj()),</span>
 796          &quot;must be NULL or an object&quot;);
 797   if (elem == NULL || h_obj()-&gt;is_unlocked()) {
 798     THROW(vmSymbols::java_lang_IllegalMonitorStateException());
 799   }
<span class="line-modified"> 800   ObjectSynchronizer::exit(h_obj(), elem-&gt;lock(), thread);</span>
 801   // Free entry. This must be done here, since a pending exception might be installed on
 802   // exit. If it is not cleared, the exception handling code will try to unlock the monitor again.
 803   elem-&gt;set_obj(NULL);
 804 #ifdef ASSERT
 805   thread-&gt;last_frame().interpreter_frame_verify_monitor(elem);
 806 #endif
<span class="line-modified"> 807 JRT_END</span>
 808 
 809 
<span class="line-modified"> 810 JRT_ENTRY(void, InterpreterRuntime::throw_illegal_monitor_state_exception(JavaThread* thread))</span>
 811   THROW(vmSymbols::java_lang_IllegalMonitorStateException());
<span class="line-modified"> 812 JRT_END</span>
 813 
 814 
<span class="line-modified"> 815 JRT_ENTRY(void, InterpreterRuntime::new_illegal_monitor_state_exception(JavaThread* thread))</span>
 816   // Returns an illegal exception to install into the current thread. The
 817   // pending_exception flag is cleared so normal exception handling does not
 818   // trigger. Any current installed exception will be overwritten. This
 819   // method will be called during an exception unwind.
 820 
 821   assert(!HAS_PENDING_EXCEPTION, &quot;no pending exception&quot;);
 822   Handle exception(thread, thread-&gt;vm_result());
 823   assert(exception() != NULL, &quot;vm result should be set&quot;);
 824   thread-&gt;set_vm_result(NULL); // clear vm result before continuing (may cause memory leaks and assert failures)
 825   if (!exception-&gt;is_a(SystemDictionary::ThreadDeath_klass())) {
 826     exception = get_preinitialized_exception(
 827                        SystemDictionary::IllegalMonitorStateException_klass(),
 828                        CATCH);
 829   }
 830   thread-&gt;set_vm_result(exception());
<span class="line-modified"> 831 JRT_END</span>
 832 
 833 
 834 //------------------------------------------------------------------------------------------------------------------------
 835 // Invokes
 836 
<span class="line-modified"> 837 JRT_ENTRY(Bytecodes::Code, InterpreterRuntime::get_original_bytecode_at(JavaThread* thread, Method* method, address bcp))</span>
 838   return method-&gt;orig_bytecode_at(method-&gt;bci_from(bcp));
<span class="line-modified"> 839 JRT_END</span>
 840 
<span class="line-modified"> 841 JRT_ENTRY(void, InterpreterRuntime::set_original_bytecode_at(JavaThread* thread, Method* method, address bcp, Bytecodes::Code new_code))</span>
 842   method-&gt;set_orig_bytecode_at(method-&gt;bci_from(bcp), new_code);
<span class="line-modified"> 843 JRT_END</span>
 844 
<span class="line-modified"> 845 JRT_ENTRY(void, InterpreterRuntime::_breakpoint(JavaThread* thread, Method* method, address bcp))</span>
 846   JvmtiExport::post_raw_breakpoint(thread, method, bcp);
<span class="line-modified"> 847 JRT_END</span>
 848 
 849 void InterpreterRuntime::resolve_invoke(JavaThread* thread, Bytecodes::Code bytecode) {
 850   Thread* THREAD = thread;
 851   LastFrameAccessor last_frame(thread);
 852   // extract receiver from the outgoing argument list if necessary
 853   Handle receiver(thread, NULL);
 854   if (bytecode == Bytecodes::_invokevirtual || bytecode == Bytecodes::_invokeinterface ||
 855       bytecode == Bytecodes::_invokespecial) {
 856     ResourceMark rm(thread);
 857     methodHandle m (thread, last_frame.method());
 858     Bytecode_invoke call(m, last_frame.bci());
 859     Symbol* signature = call.signature();
 860     receiver = Handle(thread, last_frame.callee_receiver(signature));
 861 
<span class="line-modified"> 862     assert(Universe::heap()-&gt;is_in_or_null(receiver()),</span>
 863            &quot;sanity check&quot;);
 864     assert(receiver.is_null() ||
<span class="line-modified"> 865            !Universe::heap()-&gt;is_in(receiver-&gt;klass()),</span>
 866            &quot;sanity check&quot;);
 867   }
 868 
 869   // resolve method
 870   CallInfo info;
 871   constantPoolHandle pool(thread, last_frame.method()-&gt;constants());
 872 
 873   {
 874     JvmtiHideSingleStepping jhss(thread);
 875     LinkResolver::resolve_invoke(info, receiver, pool,
 876                                  last_frame.get_index_u2_cpcache(bytecode), bytecode,
 877                                  CHECK);
 878     if (JvmtiExport::can_hotswap_or_post_breakpoint()) {
 879       int retry_count = 0;
 880       while (info.resolved_method()-&gt;is_old()) {
 881         // It is very unlikely that method is redefined more than 100 times
 882         // in the middle of resolve. If it is looping here more than 100 times
 883         // means then there could be a bug here.
 884         guarantee((retry_count++ &lt; 100),
 885                   &quot;Could not resolve to latest version of redefined method&quot;);
 886         // method is redefined in the middle of resolve so re-try.
 887         LinkResolver::resolve_invoke(info, receiver, pool,
 888                                      last_frame.get_index_u2_cpcache(bytecode), bytecode,
 889                                      CHECK);
 890       }
 891     }
 892   } // end JvmtiHideSingleStepping
 893 
 894   // check if link resolution caused cpCache to be updated
 895   ConstantPoolCacheEntry* cp_cache_entry = last_frame.cache_entry();
 896   if (cp_cache_entry-&gt;is_resolved(bytecode)) return;
 897 
 898 #ifdef ASSERT
 899   if (bytecode == Bytecodes::_invokeinterface) {
 900     if (info.resolved_method()-&gt;method_holder() ==
 901                                             SystemDictionary::Object_klass()) {
 902       // NOTE: THIS IS A FIX FOR A CORNER CASE in the JVM spec
 903       // (see also CallInfo::set_interface for details)
 904       assert(info.call_kind() == CallInfo::vtable_call ||
 905              info.call_kind() == CallInfo::direct_call, &quot;&quot;);
<span class="line-modified"> 906       Method* rm = info.resolved_method();</span>
 907       assert(rm-&gt;is_final() || info.has_vtable_index(),
 908              &quot;should have been set already&quot;);
 909     } else if (!info.resolved_method()-&gt;has_itable_index()) {
 910       // Resolved something like CharSequence.toString.  Use vtable not itable.
 911       assert(info.call_kind() != CallInfo::itable_call, &quot;&quot;);
 912     } else {
 913       // Setup itable entry
 914       assert(info.call_kind() == CallInfo::itable_call, &quot;&quot;);
 915       int index = info.resolved_method()-&gt;itable_index();
 916       assert(info.itable_index() == index, &quot;&quot;);
 917     }
 918   } else if (bytecode == Bytecodes::_invokespecial) {
 919     assert(info.call_kind() == CallInfo::direct_call, &quot;must be direct call&quot;);
 920   } else {
 921     assert(info.call_kind() == CallInfo::direct_call ||
 922            info.call_kind() == CallInfo::vtable_call, &quot;&quot;);
 923   }
 924 #endif
<span class="line-added"> 925   // Get sender or sender&#39;s unsafe_anonymous_host, and only set cpCache entry to resolved if</span>
<span class="line-added"> 926   // it is not an interface.  The receiver for invokespecial calls within interface</span>
<span class="line-added"> 927   // methods must be checked for every call.</span>
<span class="line-added"> 928   InstanceKlass* sender = pool-&gt;pool_holder();</span>
<span class="line-added"> 929   sender = sender-&gt;is_unsafe_anonymous() ? sender-&gt;unsafe_anonymous_host() : sender;</span>
<span class="line-added"> 930   methodHandle resolved_method(THREAD, info.resolved_method());</span>
 931 
 932   switch (info.call_kind()) {
<span class="line-modified"> 933   case CallInfo::direct_call:</span>







 934     cp_cache_entry-&gt;set_direct_call(
 935       bytecode,
<span class="line-modified"> 936       resolved_method,</span>
<span class="line-modified"> 937       sender-&gt;is_interface());</span>

 938     break;

 939   case CallInfo::vtable_call:
 940     cp_cache_entry-&gt;set_vtable_call(
 941       bytecode,
<span class="line-modified"> 942       resolved_method,</span>
 943       info.vtable_index());
 944     break;
 945   case CallInfo::itable_call:
 946     cp_cache_entry-&gt;set_itable_call(
 947       bytecode,
 948       info.resolved_klass(),
<span class="line-modified"> 949       resolved_method,</span>
 950       info.itable_index());
 951     break;
 952   default:  ShouldNotReachHere();
 953   }
 954 }
 955 
 956 
 957 // First time execution:  Resolve symbols, create a permanent MethodType object.
 958 void InterpreterRuntime::resolve_invokehandle(JavaThread* thread) {
 959   Thread* THREAD = thread;
 960   const Bytecodes::Code bytecode = Bytecodes::_invokehandle;
 961   LastFrameAccessor last_frame(thread);
 962 
 963   // resolve method
 964   CallInfo info;
 965   constantPoolHandle pool(thread, last_frame.method()-&gt;constants());
 966   {
 967     JvmtiHideSingleStepping jhss(thread);
 968     LinkResolver::resolve_invoke(info, Handle(), pool,
 969                                  last_frame.get_index_u2_cpcache(bytecode), bytecode,
</pre>
<hr />
<pre>
 980   LastFrameAccessor last_frame(thread);
 981   const Bytecodes::Code bytecode = Bytecodes::_invokedynamic;
 982 
 983   // resolve method
 984   CallInfo info;
 985   constantPoolHandle pool(thread, last_frame.method()-&gt;constants());
 986   int index = last_frame.get_index_u4(bytecode);
 987   {
 988     JvmtiHideSingleStepping jhss(thread);
 989     LinkResolver::resolve_invoke(info, Handle(), pool,
 990                                  index, bytecode, CHECK);
 991   } // end JvmtiHideSingleStepping
 992 
 993   ConstantPoolCacheEntry* cp_cache_entry = pool-&gt;invokedynamic_cp_cache_entry_at(index);
 994   cp_cache_entry-&gt;set_dynamic_call(pool, info);
 995 }
 996 
 997 // This function is the interface to the assembly code. It returns the resolved
 998 // cpCache entry.  This doesn&#39;t safepoint, but the helper routines safepoint.
 999 // This function will check for redefinition!
<span class="line-modified">1000 JRT_ENTRY(void, InterpreterRuntime::resolve_from_cache(JavaThread* thread, Bytecodes::Code bytecode)) {</span>
1001   switch (bytecode) {
1002   case Bytecodes::_getstatic:
1003   case Bytecodes::_putstatic:
1004   case Bytecodes::_getfield:
1005   case Bytecodes::_putfield:
1006     resolve_get_put(thread, bytecode);
1007     break;
1008   case Bytecodes::_invokevirtual:
1009   case Bytecodes::_invokespecial:
1010   case Bytecodes::_invokestatic:
1011   case Bytecodes::_invokeinterface:
1012     resolve_invoke(thread, bytecode);
1013     break;
1014   case Bytecodes::_invokehandle:
1015     resolve_invokehandle(thread);
1016     break;
1017   case Bytecodes::_invokedynamic:
1018     resolve_invokedynamic(thread);
1019     break;
1020   default:
1021     fatal(&quot;unexpected bytecode: %s&quot;, Bytecodes::name(bytecode));
1022     break;
1023   }
1024 }
<span class="line-modified">1025 JRT_END</span>
1026 
1027 //------------------------------------------------------------------------------------------------------------------------
1028 // Miscellaneous
1029 
1030 
1031 nmethod* InterpreterRuntime::frequency_counter_overflow(JavaThread* thread, address branch_bcp) {
1032   nmethod* nm = frequency_counter_overflow_inner(thread, branch_bcp);
1033   assert(branch_bcp != NULL || nm == NULL, &quot;always returns null for non OSR requests&quot;);
1034   if (branch_bcp != NULL &amp;&amp; nm != NULL) {
1035     // This was a successful request for an OSR nmethod.  Because
1036     // frequency_counter_overflow_inner ends with a safepoint check,
1037     // nm could have been unloaded so look it up again.  It&#39;s unsafe
1038     // to examine nm directly since it might have been freed and used
1039     // for something else.
1040     LastFrameAccessor last_frame(thread);
1041     Method* method =  last_frame.method();
1042     int bci = method-&gt;bci_from(last_frame.bcp());
1043     nm = method-&gt;lookup_osr_nmethod_for(bci, CompLevel_none, false);
1044     BarrierSetNMethod* bs_nm = BarrierSet::barrier_set()-&gt;barrier_set_nmethod();
1045     if (nm != NULL &amp;&amp; bs_nm != NULL) {
</pre>
<hr />
<pre>
1051   }
1052   if (nm != NULL &amp;&amp; thread-&gt;is_interp_only_mode()) {
1053     // Normally we never get an nm if is_interp_only_mode() is true, because
1054     // policy()-&gt;event has a check for this and won&#39;t compile the method when
1055     // true. However, it&#39;s possible for is_interp_only_mode() to become true
1056     // during the compilation. We don&#39;t want to return the nm in that case
1057     // because we want to continue to execute interpreted.
1058     nm = NULL;
1059   }
1060 #ifndef PRODUCT
1061   if (TraceOnStackReplacement) {
1062     if (nm != NULL) {
1063       tty-&gt;print(&quot;OSR entry @ pc: &quot; INTPTR_FORMAT &quot;: &quot;, p2i(nm-&gt;osr_entry()));
1064       nm-&gt;print();
1065     }
1066   }
1067 #endif
1068   return nm;
1069 }
1070 
<span class="line-modified">1071 JRT_ENTRY(nmethod*,</span>
1072           InterpreterRuntime::frequency_counter_overflow_inner(JavaThread* thread, address branch_bcp))
1073   // use UnlockFlagSaver to clear and restore the _do_not_unlock_if_synchronized
1074   // flag, in case this method triggers classloading which will call into Java.
1075   UnlockFlagSaver fs(thread);
1076 
1077   LastFrameAccessor last_frame(thread);
1078   assert(last_frame.is_interpreted_frame(), &quot;must come from interpreter&quot;);
1079   methodHandle method(thread, last_frame.method());
1080   const int branch_bci = branch_bcp != NULL ? method-&gt;bci_from(branch_bcp) : InvocationEntryBci;
1081   const int bci = branch_bcp != NULL ? method-&gt;bci_from(last_frame.bcp()) : InvocationEntryBci;
1082 
1083   assert(!HAS_PENDING_EXCEPTION, &quot;Should not have any exceptions pending&quot;);
1084   nmethod* osr_nm = CompilationPolicy::policy()-&gt;event(method, method, branch_bci, bci, CompLevel_none, NULL, thread);
1085   assert(!HAS_PENDING_EXCEPTION, &quot;Event handler should not throw any exceptions&quot;);
1086 
1087   BarrierSetNMethod* bs_nm = BarrierSet::barrier_set()-&gt;barrier_set_nmethod();
1088   if (osr_nm != NULL &amp;&amp; bs_nm != NULL) {
1089     if (!bs_nm-&gt;nmethod_osr_entry_barrier(osr_nm)) {
1090       osr_nm = NULL;
1091     }
1092   }
1093 
1094   if (osr_nm != NULL) {
1095     // We may need to do on-stack replacement which requires that no
1096     // monitors in the activation are biased because their
1097     // BasicObjectLocks will need to migrate during OSR. Force
1098     // unbiasing of all monitors in the activation now (even though
1099     // the OSR nmethod might be invalidated) because we don&#39;t have a
1100     // safepoint opportunity later once the migration begins.
1101     if (UseBiasedLocking) {
1102       ResourceMark rm;
1103       GrowableArray&lt;Handle&gt;* objects_to_revoke = new GrowableArray&lt;Handle&gt;();
1104       for( BasicObjectLock *kptr = last_frame.monitor_end();
1105            kptr &lt; last_frame.monitor_begin();
1106            kptr = last_frame.next_monitor(kptr) ) {
1107         if( kptr-&gt;obj() != NULL ) {
1108           objects_to_revoke-&gt;append(Handle(THREAD, kptr-&gt;obj()));
1109         }
1110       }
<span class="line-modified">1111       BiasedLocking::revoke(objects_to_revoke, thread);</span>
1112     }
1113   }
1114   return osr_nm;
<span class="line-modified">1115 JRT_END</span>
1116 
<span class="line-modified">1117 JRT_LEAF(jint, InterpreterRuntime::bcp_to_di(Method* method, address cur_bcp))</span>
1118   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1119   int bci = method-&gt;bci_from(cur_bcp);
1120   MethodData* mdo = method-&gt;method_data();
1121   if (mdo == NULL)  return 0;
1122   return mdo-&gt;bci_to_di(bci);
<span class="line-modified">1123 JRT_END</span>
1124 
<span class="line-modified">1125 JRT_ENTRY(void, InterpreterRuntime::profile_method(JavaThread* thread))</span>
1126   // use UnlockFlagSaver to clear and restore the _do_not_unlock_if_synchronized
1127   // flag, in case this method triggers classloading which will call into Java.
1128   UnlockFlagSaver fs(thread);
1129 
1130   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1131   LastFrameAccessor last_frame(thread);
1132   assert(last_frame.is_interpreted_frame(), &quot;must come from interpreter&quot;);
1133   methodHandle method(thread, last_frame.method());
1134   Method::build_interpreter_method_data(method, THREAD);
1135   if (HAS_PENDING_EXCEPTION) {
1136     assert((PENDING_EXCEPTION-&gt;is_a(SystemDictionary::OutOfMemoryError_klass())), &quot;we expect only an OOM error here&quot;);
1137     CLEAR_PENDING_EXCEPTION;
1138     // and fall through...
1139   }
<span class="line-modified">1140 JRT_END</span>
1141 
1142 
1143 #ifdef ASSERT
<span class="line-modified">1144 JRT_LEAF(void, InterpreterRuntime::verify_mdp(Method* method, address bcp, address mdp))</span>
1145   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1146 
1147   MethodData* mdo = method-&gt;method_data();
1148   assert(mdo != NULL, &quot;must not be null&quot;);
1149 
1150   int bci = method-&gt;bci_from(bcp);
1151 
1152   address mdp2 = mdo-&gt;bci_to_dp(bci);
1153   if (mdp != mdp2) {
1154     ResourceMark rm;
1155     ResetNoHandleMark rnm; // In a LEAF entry.
1156     HandleMark hm;
1157     tty-&gt;print_cr(&quot;FAILED verify : actual mdp %p   expected mdp %p @ bci %d&quot;, mdp, mdp2, bci);
1158     int current_di = mdo-&gt;dp_to_di(mdp);
1159     int expected_di  = mdo-&gt;dp_to_di(mdp2);
1160     tty-&gt;print_cr(&quot;  actual di %d   expected di %d&quot;, current_di, expected_di);
1161     int expected_approx_bci = mdo-&gt;data_at(expected_di)-&gt;bci();
1162     int approx_bci = -1;
1163     if (current_di &gt;= 0) {
1164       approx_bci = mdo-&gt;data_at(current_di)-&gt;bci();
1165     }
1166     tty-&gt;print_cr(&quot;  actual bci is %d  expected bci %d&quot;, approx_bci, expected_approx_bci);
1167     mdo-&gt;print_on(tty);
1168     method-&gt;print_codes();
1169   }
1170   assert(mdp == mdp2, &quot;wrong mdp&quot;);
<span class="line-modified">1171 JRT_END</span>
1172 #endif // ASSERT
1173 
<span class="line-modified">1174 JRT_ENTRY(void, InterpreterRuntime::update_mdp_for_ret(JavaThread* thread, int return_bci))</span>
1175   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1176   ResourceMark rm(thread);
1177   HandleMark hm(thread);
1178   LastFrameAccessor last_frame(thread);
1179   assert(last_frame.is_interpreted_frame(), &quot;must come from interpreter&quot;);
1180   MethodData* h_mdo = last_frame.method()-&gt;method_data();
1181 
1182   // Grab a lock to ensure atomic access to setting the return bci and
1183   // the displacement.  This can block and GC, invalidating all naked oops.
1184   MutexLocker ml(RetData_lock);
1185 
1186   // ProfileData is essentially a wrapper around a derived oop, so we
1187   // need to take the lock before making any ProfileData structures.
1188   ProfileData* data = h_mdo-&gt;data_at(h_mdo-&gt;dp_to_di(last_frame.mdp()));
1189   guarantee(data != NULL, &quot;profile data must be valid&quot;);
1190   RetData* rdata = data-&gt;as_RetData();
1191   address new_mdp = rdata-&gt;fixup_ret(return_bci, h_mdo);
1192   last_frame.set_mdp(new_mdp);
<span class="line-modified">1193 JRT_END</span>
1194 
<span class="line-modified">1195 JRT_ENTRY(MethodCounters*, InterpreterRuntime::build_method_counters(JavaThread* thread, Method* m))</span>
1196   MethodCounters* mcs = Method::build_method_counters(m, thread);
1197   if (HAS_PENDING_EXCEPTION) {
1198     assert((PENDING_EXCEPTION-&gt;is_a(SystemDictionary::OutOfMemoryError_klass())), &quot;we expect only an OOM error here&quot;);
1199     CLEAR_PENDING_EXCEPTION;
1200   }
1201   return mcs;
<span class="line-modified">1202 JRT_END</span>
1203 
1204 
<span class="line-modified">1205 JRT_ENTRY(void, InterpreterRuntime::at_safepoint(JavaThread* thread))</span>
1206   // We used to need an explict preserve_arguments here for invoke bytecodes. However,
1207   // stack traversal automatically takes care of preserving arguments for invoke, so
1208   // this is no longer needed.
1209 
<span class="line-modified">1210   // JRT_END does an implicit safepoint check, hence we are guaranteed to block</span>
1211   // if this is called during a safepoint
1212 
1213   if (JvmtiExport::should_post_single_step()) {
1214     // We are called during regular safepoints and when the VM is
1215     // single stepping. If any thread is marked for single stepping,
1216     // then we may have JVMTI work to do.
1217     LastFrameAccessor last_frame(thread);
1218     JvmtiExport::at_single_stepping_point(thread, last_frame.method(), last_frame.bcp());
1219   }
<span class="line-modified">1220 JRT_END</span>
1221 
<span class="line-modified">1222 JRT_ENTRY(void, InterpreterRuntime::post_field_access(JavaThread *thread, oopDesc* obj,</span>
1223 ConstantPoolCacheEntry *cp_entry))
1224 
1225   // check the access_flags for the field in the klass
1226 
1227   InstanceKlass* ik = InstanceKlass::cast(cp_entry-&gt;f1_as_klass());
1228   int index = cp_entry-&gt;field_index();
1229   if ((ik-&gt;field_access_flags(index) &amp; JVM_ACC_FIELD_ACCESS_WATCHED) == 0) return;
1230 
1231   bool is_static = (obj == NULL);
1232   HandleMark hm(thread);
1233 
1234   Handle h_obj;
1235   if (!is_static) {
1236     // non-static field accessors have an object, but we need a handle
1237     h_obj = Handle(thread, obj);
1238   }
1239   InstanceKlass* cp_entry_f1 = InstanceKlass::cast(cp_entry-&gt;f1_as_klass());
1240   jfieldID fid = jfieldIDWorkaround::to_jfieldID(cp_entry_f1, cp_entry-&gt;f2_as_index(), is_static);
1241   LastFrameAccessor last_frame(thread);
1242   JvmtiExport::post_field_access(thread, last_frame.method(), last_frame.bcp(), cp_entry_f1, h_obj, fid);
<span class="line-modified">1243 JRT_END</span>
1244 
<span class="line-modified">1245 JRT_ENTRY(void, InterpreterRuntime::post_field_modification(JavaThread *thread,</span>
1246   oopDesc* obj, ConstantPoolCacheEntry *cp_entry, jvalue *value))
1247 
1248   Klass* k = cp_entry-&gt;f1_as_klass();
1249 
1250   // check the access_flags for the field in the klass
1251   InstanceKlass* ik = InstanceKlass::cast(k);
1252   int index = cp_entry-&gt;field_index();
1253   // bail out if field modifications are not watched
1254   if ((ik-&gt;field_access_flags(index) &amp; JVM_ACC_FIELD_MODIFICATION_WATCHED) == 0) return;
1255 
1256   char sig_type = &#39;\0&#39;;
1257 
1258   switch(cp_entry-&gt;flag_state()) {
<span class="line-modified">1259     case btos: sig_type = JVM_SIGNATURE_BYTE;    break;</span>
<span class="line-modified">1260     case ztos: sig_type = JVM_SIGNATURE_BOOLEAN; break;</span>
<span class="line-modified">1261     case ctos: sig_type = JVM_SIGNATURE_CHAR;    break;</span>
<span class="line-modified">1262     case stos: sig_type = JVM_SIGNATURE_SHORT;   break;</span>
<span class="line-modified">1263     case itos: sig_type = JVM_SIGNATURE_INT;     break;</span>
<span class="line-modified">1264     case ftos: sig_type = JVM_SIGNATURE_FLOAT;   break;</span>
<span class="line-modified">1265     case atos: sig_type = JVM_SIGNATURE_CLASS;   break;</span>
<span class="line-modified">1266     case ltos: sig_type = JVM_SIGNATURE_LONG;    break;</span>
<span class="line-modified">1267     case dtos: sig_type = JVM_SIGNATURE_DOUBLE;  break;</span>
1268     default:  ShouldNotReachHere(); return;
1269   }
1270   bool is_static = (obj == NULL);
1271 
1272   HandleMark hm(thread);
1273   jfieldID fid = jfieldIDWorkaround::to_jfieldID(ik, cp_entry-&gt;f2_as_index(), is_static);
1274   jvalue fvalue;
1275 #ifdef _LP64
1276   fvalue = *value;
1277 #else
1278   // Long/double values are stored unaligned and also noncontiguously with
1279   // tagged stacks.  We can&#39;t just do a simple assignment even in the non-
1280   // J/D cases because a C++ compiler is allowed to assume that a jvalue is
1281   // 8-byte aligned, and interpreter stack slots are only 4-byte aligned.
1282   // We assume that the two halves of longs/doubles are stored in interpreter
1283   // stack slots in platform-endian order.
1284   jlong_accessor u;
1285   jint* newval = (jint*)value;
1286   u.words[0] = newval[0];
1287   u.words[1] = newval[Interpreter::stackElementWords]; // skip if tag
1288   fvalue.j = u.long_value;
1289 #endif // _LP64
1290 
1291   Handle h_obj;
1292   if (!is_static) {
1293     // non-static field accessors have an object, but we need a handle
1294     h_obj = Handle(thread, obj);
1295   }
1296 
1297   LastFrameAccessor last_frame(thread);
1298   JvmtiExport::post_raw_field_modification(thread, last_frame.method(), last_frame.bcp(), ik, h_obj,
1299                                            fid, sig_type, &amp;fvalue);
<span class="line-modified">1300 JRT_END</span>
1301 
<span class="line-modified">1302 JRT_ENTRY(void, InterpreterRuntime::post_method_entry(JavaThread *thread))</span>
1303   LastFrameAccessor last_frame(thread);
1304   JvmtiExport::post_method_entry(thread, last_frame.method(), last_frame.get_frame());
<span class="line-modified">1305 JRT_END</span>
1306 
1307 
<span class="line-modified">1308 JRT_ENTRY(void, InterpreterRuntime::post_method_exit(JavaThread *thread))</span>
1309   LastFrameAccessor last_frame(thread);
1310   JvmtiExport::post_method_exit(thread, last_frame.method(), last_frame.get_frame());
<span class="line-modified">1311 JRT_END</span>
1312 
<span class="line-modified">1313 JRT_LEAF(int, InterpreterRuntime::interpreter_contains(address pc))</span>
1314 {
1315   return (Interpreter::contains(pc) ? 1 : 0);
1316 }
<span class="line-modified">1317 JRT_END</span>
1318 
1319 
1320 // Implementation of SignatureHandlerLibrary
1321 
1322 #ifndef SHARING_FAST_NATIVE_FINGERPRINTS
1323 // Dummy definition (else normalization method is defined in CPU
1324 // dependant code)
1325 uint64_t InterpreterRuntime::normalize_fast_native_fingerprint(uint64_t fingerprint) {
1326   return fingerprint;
1327 }
1328 #endif
1329 
1330 address SignatureHandlerLibrary::set_handler_blob() {
1331   BufferBlob* handler_blob = BufferBlob::create(&quot;native signature handlers&quot;, blob_size);
1332   if (handler_blob == NULL) {
1333     return NULL;
1334   }
1335   address handler = handler_blob-&gt;code_begin();
1336   _handler_blob = handler_blob;
1337   _handler = handler;
</pre>
<hr />
<pre>
1358   address handler   = _handler;
1359   int     insts_size = buffer-&gt;pure_insts_size();
1360   if (handler + insts_size &gt; _handler_blob-&gt;code_end()) {
1361     // get a new handler blob
1362     handler = set_handler_blob();
1363   }
1364   if (handler != NULL) {
1365     memcpy(handler, buffer-&gt;insts_begin(), insts_size);
1366     pd_set_handler(handler);
1367     ICache::invalidate_range(handler, insts_size);
1368     _handler = handler + insts_size;
1369   }
1370   return handler;
1371 }
1372 
1373 void SignatureHandlerLibrary::add(const methodHandle&amp; method) {
1374   if (method-&gt;signature_handler() == NULL) {
1375     // use slow signature handler if we can&#39;t do better
1376     int handler_index = -1;
1377     // check if we can use customized (fast) signature handler
<span class="line-modified">1378     if (UseFastSignatureHandlers &amp;&amp; method-&gt;size_of_parameters() &lt;= Fingerprinter::fp_max_size_of_parameters) {</span>
1379       // use customized signature handler
1380       MutexLocker mu(SignatureHandlerLibrary_lock);
1381       // make sure data structure is initialized
1382       initialize();
1383       // lookup method signature&#39;s fingerprint
1384       uint64_t fingerprint = Fingerprinter(method).fingerprint();
1385       // allow CPU dependant code to optimize the fingerprints for the fast handler
1386       fingerprint = InterpreterRuntime::normalize_fast_native_fingerprint(fingerprint);
1387       handler_index = _fingerprints-&gt;find(fingerprint);
1388       // create handler if necessary
1389       if (handler_index &lt; 0) {
1390         ResourceMark rm;
1391         ptrdiff_t align_offset = align_up(_buffer, CodeEntryAlignment) - (address)_buffer;
1392         CodeBuffer buffer((address)(_buffer + align_offset),
1393                           SignatureHandlerLibrary::buffer_size - align_offset);
1394         InterpreterRuntime::SignatureHandlerGenerator(method, &amp;buffer).generate(fingerprint);
1395         // copy into code heap
1396         address handler = set_handler(&amp;buffer);
1397         if (handler == NULL) {
1398           // use slow signature handler (without memorizing it in the fingerprints)
</pre>
<hr />
<pre>
1425             }
1426 #endif
1427           }
1428           // add handler to library
1429           _fingerprints-&gt;append(fingerprint);
1430           _handlers-&gt;append(handler);
1431           // set handler index
1432           assert(_fingerprints-&gt;length() == _handlers-&gt;length(), &quot;sanity check&quot;);
1433           handler_index = _fingerprints-&gt;length() - 1;
1434         }
1435       }
1436       // Set handler under SignatureHandlerLibrary_lock
1437       if (handler_index &lt; 0) {
1438         // use generic signature handler
1439         method-&gt;set_signature_handler(Interpreter::slow_signature_handler());
1440       } else {
1441         // set handler
1442         method-&gt;set_signature_handler(_handlers-&gt;at(handler_index));
1443       }
1444     } else {
<span class="line-modified">1445       DEBUG_ONLY(Thread::current()-&gt;check_possible_safepoint());</span>
1446       // use generic signature handler
1447       method-&gt;set_signature_handler(Interpreter::slow_signature_handler());
1448     }
1449   }
1450 #ifdef ASSERT
1451   int handler_index = -1;
1452   int fingerprint_index = -2;
1453   {
1454     // &#39;_handlers&#39; and &#39;_fingerprints&#39; are &#39;GrowableArray&#39;s and are NOT synchronized
1455     // in any way if accessed from multiple threads. To avoid races with another
1456     // thread which may change the arrays in the above, mutex protected block, we
1457     // have to protect this read access here with the same mutex as well!
1458     MutexLocker mu(SignatureHandlerLibrary_lock);
1459     if (_handlers != NULL) {
1460       handler_index = _handlers-&gt;find(method-&gt;signature_handler());
1461       uint64_t fingerprint = Fingerprinter(method).fingerprint();
1462       fingerprint = InterpreterRuntime::normalize_fast_native_fingerprint(fingerprint);
1463       fingerprint_index = _fingerprints-&gt;find(fingerprint);
1464     }
1465   }
</pre>
<hr />
<pre>
1490   } else {
1491     if (PrintSignatureHandlers) {
1492       tty-&gt;cr();
1493       tty-&gt;print_cr(&quot;duplicate argument handler #%d for fingerprint &quot; UINT64_FORMAT &quot;(old: &quot; PTR_FORMAT &quot;, new : &quot; PTR_FORMAT &quot;)&quot;,
1494                     _handlers-&gt;length(),
1495                     fingerprint,
1496                     p2i(_handlers-&gt;at(handler_index)),
1497                     p2i(handler));
1498     }
1499   }
1500 }
1501 
1502 
1503 BufferBlob*              SignatureHandlerLibrary::_handler_blob = NULL;
1504 address                  SignatureHandlerLibrary::_handler      = NULL;
1505 GrowableArray&lt;uint64_t&gt;* SignatureHandlerLibrary::_fingerprints = NULL;
1506 GrowableArray&lt;address&gt;*  SignatureHandlerLibrary::_handlers     = NULL;
1507 address                  SignatureHandlerLibrary::_buffer       = NULL;
1508 
1509 
<span class="line-modified">1510 JRT_ENTRY(void, InterpreterRuntime::prepare_native_call(JavaThread* thread, Method* method))</span>
1511   methodHandle m(thread, method);
1512   assert(m-&gt;is_native(), &quot;sanity check&quot;);
1513   // lookup native function entry point if it doesn&#39;t exist
1514   bool in_base_library;
1515   if (!m-&gt;has_native_function()) {
1516     NativeLookup::lookup(m, in_base_library, CHECK);
1517   }
1518   // make sure signature handler is installed
1519   SignatureHandlerLibrary::add(m);
1520   // The interpreter entry point checks the signature handler first,
1521   // before trying to fetch the native entry point and klass mirror.
1522   // We must set the signature handler last, so that multiple processors
1523   // preparing the same method will be sure to see non-null entry &amp; mirror.
<span class="line-modified">1524 JRT_END</span>
1525 
1526 #if defined(IA32) || defined(AMD64) || defined(ARM)
<span class="line-modified">1527 JRT_LEAF(void, InterpreterRuntime::popframe_move_outgoing_args(JavaThread* thread, void* src_address, void* dest_address))</span>
1528   if (src_address == dest_address) {
1529     return;
1530   }
1531   ResetNoHandleMark rnm; // In a LEAF entry.
1532   HandleMark hm;
1533   ResourceMark rm;
1534   LastFrameAccessor last_frame(thread);
1535   assert(last_frame.is_interpreted_frame(), &quot;&quot;);
1536   jint bci = last_frame.bci();
1537   methodHandle mh(thread, last_frame.method());
1538   Bytecode_invoke invoke(mh, bci);
1539   ArgumentSizeComputer asc(invoke.signature());
1540   int size_of_arguments = (asc.size() + (invoke.has_receiver() ? 1 : 0)); // receiver
1541   Copy::conjoint_jbytes(src_address, dest_address,
1542                        size_of_arguments * Interpreter::stackElementSize);
<span class="line-modified">1543 JRT_END</span>
1544 #endif
1545 
1546 #if INCLUDE_JVMTI
1547 // This is a support of the JVMTI PopFrame interface.
1548 // Make sure it is an invokestatic of a polymorphic intrinsic that has a member_name argument
1549 // and return it as a vm_result so that it can be reloaded in the list of invokestatic parameters.
1550 // The member_name argument is a saved reference (in local#0) to the member_name.
1551 // For backward compatibility with some JDK versions (7, 8) it can also be a direct method handle.
1552 // FIXME: remove DMH case after j.l.i.InvokerBytecodeGenerator code shape is updated.
<span class="line-modified">1553 JRT_ENTRY(void, InterpreterRuntime::member_name_arg_or_null(JavaThread* thread, address member_name,</span>
1554                                                             Method* method, address bcp))
1555   Bytecodes::Code code = Bytecodes::code_at(method, bcp);
1556   if (code != Bytecodes::_invokestatic) {
1557     return;
1558   }
1559   ConstantPool* cpool = method-&gt;constants();
1560   int cp_index = Bytes::get_native_u2(bcp + 1) + ConstantPool::CPCACHE_INDEX_TAG;
1561   Symbol* cname = cpool-&gt;klass_name_at(cpool-&gt;klass_ref_index_at(cp_index));
1562   Symbol* mname = cpool-&gt;name_ref_at(cp_index);
1563 
1564   if (MethodHandles::has_member_arg(cname, mname)) {
1565     oop member_name_oop = (oop) member_name;
1566     if (java_lang_invoke_DirectMethodHandle::is_instance(member_name_oop)) {
1567       // FIXME: remove after j.l.i.InvokerBytecodeGenerator code shape is updated.
1568       member_name_oop = java_lang_invoke_DirectMethodHandle::member(member_name_oop);
1569     }
1570     thread-&gt;set_vm_result(member_name_oop);
1571   } else {
1572     thread-&gt;set_vm_result(NULL);
1573   }
<span class="line-modified">1574 JRT_END</span>
1575 #endif // INCLUDE_JVMTI
1576 
1577 #ifndef PRODUCT
<span class="line-modified">1578 // This must be a JRT_LEAF function because the interpreter must save registers on x86 to</span>
1579 // call this, which changes rsp and makes the interpreter&#39;s expression stack not walkable.
1580 // The generated code still uses call_VM because that will set up the frame pointer for
1581 // bcp and method.
<span class="line-modified">1582 JRT_LEAF(intptr_t, InterpreterRuntime::trace_bytecode(JavaThread* thread, intptr_t preserve_this_value, intptr_t tos, intptr_t tos2))</span>
1583   LastFrameAccessor last_frame(thread);
1584   assert(last_frame.is_interpreted_frame(), &quot;must be an interpreted frame&quot;);
1585   methodHandle mh(thread, last_frame.method());
1586   BytecodeTracer::trace(mh, last_frame.bcp(), tos, tos2);
1587   return preserve_this_value;
<span class="line-modified">1588 JRT_END</span>
1589 #endif // !PRODUCT
</pre>
</td>
</tr>
</table>
<center><a href="../include/jvm.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="../oops/cpCache.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>