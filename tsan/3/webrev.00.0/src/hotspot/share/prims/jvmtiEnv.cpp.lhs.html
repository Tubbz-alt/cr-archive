<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/share/prims/jvmtiEnv.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
<a name="1" id="anc1"></a><span class="line-modified">   2  * Copyright (c) 2003, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;classfile/classLoaderExt.hpp&quot;
  27 #include &quot;classfile/javaClasses.inline.hpp&quot;
  28 #include &quot;classfile/stringTable.hpp&quot;
  29 #include &quot;classfile/modules.hpp&quot;
  30 #include &quot;classfile/systemDictionary.hpp&quot;
  31 #include &quot;classfile/vmSymbols.hpp&quot;
  32 #include &quot;interpreter/bytecodeStream.hpp&quot;
  33 #include &quot;interpreter/interpreter.hpp&quot;
<a name="2" id="anc2"></a>
  34 #include &quot;jvmtifiles/jvmtiEnv.hpp&quot;
  35 #include &quot;logging/log.hpp&quot;
  36 #include &quot;logging/logConfiguration.hpp&quot;
  37 #include &quot;memory/resourceArea.hpp&quot;
  38 #include &quot;memory/universe.hpp&quot;
  39 #include &quot;oops/instanceKlass.hpp&quot;
  40 #include &quot;oops/objArrayOop.inline.hpp&quot;
  41 #include &quot;oops/oop.inline.hpp&quot;
  42 #include &quot;prims/jniCheck.hpp&quot;
  43 #include &quot;prims/jvm_misc.hpp&quot;
  44 #include &quot;prims/jvmtiAgentThread.hpp&quot;
  45 #include &quot;prims/jvmtiClassFileReconstituter.hpp&quot;
  46 #include &quot;prims/jvmtiCodeBlobEvents.hpp&quot;
  47 #include &quot;prims/jvmtiExtensions.hpp&quot;
  48 #include &quot;prims/jvmtiGetLoadedClasses.hpp&quot;
  49 #include &quot;prims/jvmtiImpl.hpp&quot;
  50 #include &quot;prims/jvmtiManageCapabilities.hpp&quot;
  51 #include &quot;prims/jvmtiRawMonitor.hpp&quot;
  52 #include &quot;prims/jvmtiRedefineClasses.hpp&quot;
  53 #include &quot;prims/jvmtiTagMap.hpp&quot;
  54 #include &quot;prims/jvmtiThreadState.inline.hpp&quot;
  55 #include &quot;prims/jvmtiUtil.hpp&quot;
  56 #include &quot;runtime/arguments.hpp&quot;
  57 #include &quot;runtime/deoptimization.hpp&quot;
  58 #include &quot;runtime/fieldDescriptor.inline.hpp&quot;
  59 #include &quot;runtime/handles.inline.hpp&quot;
  60 #include &quot;runtime/interfaceSupport.inline.hpp&quot;
  61 #include &quot;runtime/javaCalls.hpp&quot;
  62 #include &quot;runtime/jfieldIDWorkaround.hpp&quot;
  63 #include &quot;runtime/jniHandles.inline.hpp&quot;
  64 #include &quot;runtime/objectMonitor.inline.hpp&quot;
  65 #include &quot;runtime/osThread.hpp&quot;
  66 #include &quot;runtime/reflectionUtils.hpp&quot;
  67 #include &quot;runtime/signature.hpp&quot;
  68 #include &quot;runtime/thread.inline.hpp&quot;
  69 #include &quot;runtime/threadHeapSampler.hpp&quot;
  70 #include &quot;runtime/threadSMR.hpp&quot;
  71 #include &quot;runtime/timerTrace.hpp&quot;
  72 #include &quot;runtime/vframe.inline.hpp&quot;
  73 #include &quot;runtime/vmThread.hpp&quot;
  74 #include &quot;services/threadService.hpp&quot;
  75 #if INCLUDE_TSAN
  76 #include &quot;tsan/tsan.hpp&quot;
  77 #endif  // INCLUDE_TSAN
  78 #include &quot;utilities/exceptions.hpp&quot;
  79 #include &quot;utilities/preserveException.hpp&quot;
<a name="3" id="anc3"></a>
  80 
  81 
  82 #define FIXLATER 0 // REMOVE this when completed.
  83 
  84  // FIXLATER: hook into JvmtiTrace
  85 #define TraceJVMTICalls false
  86 
  87 JvmtiEnv::JvmtiEnv(jint version) : JvmtiEnvBase(version) {
  88 }
  89 
  90 JvmtiEnv::~JvmtiEnv() {
  91 }
  92 
  93 JvmtiEnv*
  94 JvmtiEnv::create_a_jvmti(jint version) {
  95   return new JvmtiEnv(version);
  96 }
  97 
  98 // VM operation class to copy jni function table at safepoint.
  99 // More than one java threads or jvmti agents may be reading/
 100 // modifying jni function tables. To reduce the risk of bad
 101 // interaction b/w these threads it is copied at safepoint.
 102 class VM_JNIFunctionTableCopier : public VM_Operation {
 103  private:
 104   const struct JNINativeInterface_ *_function_table;
 105  public:
 106   VM_JNIFunctionTableCopier(const struct JNINativeInterface_ *func_tbl) {
 107     _function_table = func_tbl;
 108   };
 109 
 110   VMOp_Type type() const { return VMOp_JNIFunctionTableCopier; }
 111   void doit() {
 112     copy_jni_function_table(_function_table);
 113   };
 114 };
 115 
 116 //
 117 // Do not change the &quot;prefix&quot; marker below, everything above it is copied
 118 // unchanged into the filled stub, everything below is controlled by the
 119 // stub filler (only method bodies are carried forward, and then only for
 120 // functionality still in the spec).
 121 //
 122 // end file prefix
 123 
 124   //
 125   // Memory Management functions
 126   //
 127 
 128 // mem_ptr - pre-checked for NULL
 129 jvmtiError
 130 JvmtiEnv::Allocate(jlong size, unsigned char** mem_ptr) {
 131   return allocate(size, mem_ptr);
 132 } /* end Allocate */
 133 
 134 
 135 // mem - NULL is a valid value, must be checked
 136 jvmtiError
 137 JvmtiEnv::Deallocate(unsigned char* mem) {
 138   return deallocate(mem);
 139 } /* end Deallocate */
 140 
 141 // Threads_lock NOT held, java_thread not protected by lock
 142 // java_thread - pre-checked
 143 // data - NULL is a valid value, must be checked
 144 jvmtiError
 145 JvmtiEnv::SetThreadLocalStorage(JavaThread* java_thread, const void* data) {
 146   JvmtiThreadState* state = java_thread-&gt;jvmti_thread_state();
 147   if (state == NULL) {
 148     if (data == NULL) {
 149       // leaving state unset same as data set to NULL
 150       return JVMTI_ERROR_NONE;
 151     }
 152     // otherwise, create the state
 153     state = JvmtiThreadState::state_for(java_thread);
 154     if (state == NULL) {
 155       return JVMTI_ERROR_THREAD_NOT_ALIVE;
 156     }
 157   }
 158   state-&gt;env_thread_state(this)-&gt;set_agent_thread_local_storage_data((void*)data);
 159   return JVMTI_ERROR_NONE;
 160 } /* end SetThreadLocalStorage */
 161 
 162 
 163 // Threads_lock NOT held
 164 // thread - NOT pre-checked
 165 // data_ptr - pre-checked for NULL
 166 jvmtiError
 167 JvmtiEnv::GetThreadLocalStorage(jthread thread, void** data_ptr) {
 168   JavaThread* current_thread = JavaThread::current();
 169   if (thread == NULL) {
 170     JvmtiThreadState* state = current_thread-&gt;jvmti_thread_state();
 171     *data_ptr = (state == NULL) ? NULL :
 172       state-&gt;env_thread_state(this)-&gt;get_agent_thread_local_storage_data();
 173   } else {
 174     // jvmti_GetThreadLocalStorage is &quot;in native&quot; and doesn&#39;t transition
 175     // the thread to _thread_in_vm. However, when the TLS for a thread
 176     // other than the current thread is required we need to transition
 177     // from native so as to resolve the jthread.
 178 
 179     ThreadInVMfromNative __tiv(current_thread);
 180     VM_ENTRY_BASE(jvmtiError, JvmtiEnv::GetThreadLocalStorage , current_thread)
 181     debug_only(VMNativeEntryWrapper __vew;)
 182 
 183     JavaThread* java_thread = NULL;
 184     ThreadsListHandle tlh(current_thread);
 185     jvmtiError err = JvmtiExport::cv_external_thread_to_JavaThread(tlh.list(), thread, &amp;java_thread, NULL);
 186     if (err != JVMTI_ERROR_NONE) {
 187       return err;
 188     }
 189 
 190     JvmtiThreadState* state = java_thread-&gt;jvmti_thread_state();
 191     *data_ptr = (state == NULL) ? NULL :
 192       state-&gt;env_thread_state(this)-&gt;get_agent_thread_local_storage_data();
 193   }
 194   return JVMTI_ERROR_NONE;
 195 } /* end GetThreadLocalStorage */
 196 
 197   //
 198   // Module functions
 199   //
 200 
 201 // module_count_ptr - pre-checked for NULL
 202 // modules_ptr - pre-checked for NULL
 203 jvmtiError
 204 JvmtiEnv::GetAllModules(jint* module_count_ptr, jobject** modules_ptr) {
 205     JvmtiModuleClosure jmc;
 206 
 207     return jmc.get_all_modules(this, module_count_ptr, modules_ptr);
 208 } /* end GetAllModules */
 209 
 210 
 211 // class_loader - NULL is a valid value, must be pre-checked
 212 // package_name - pre-checked for NULL
 213 // module_ptr - pre-checked for NULL
 214 jvmtiError
 215 JvmtiEnv::GetNamedModule(jobject class_loader, const char* package_name, jobject* module_ptr) {
 216   JavaThread* THREAD = JavaThread::current(); // pass to macros
 217   ResourceMark rm(THREAD);
 218 
 219   Handle h_loader (THREAD, JNIHandles::resolve(class_loader));
 220   // Check that loader is a subclass of java.lang.ClassLoader.
 221   if (h_loader.not_null() &amp;&amp; !java_lang_ClassLoader::is_subclass(h_loader-&gt;klass())) {
 222     return JVMTI_ERROR_ILLEGAL_ARGUMENT;
 223   }
 224   jobject module = Modules::get_named_module(h_loader, package_name, THREAD);
 225   if (HAS_PENDING_EXCEPTION) {
 226     CLEAR_PENDING_EXCEPTION;
 227     return JVMTI_ERROR_INTERNAL; // unexpected exception
 228   }
 229   *module_ptr = module;
 230   return JVMTI_ERROR_NONE;
 231 } /* end GetNamedModule */
 232 
 233 
 234 // module - pre-checked for NULL
 235 // to_module - pre-checked for NULL
 236 jvmtiError
 237 JvmtiEnv::AddModuleReads(jobject module, jobject to_module) {
 238   JavaThread* THREAD = JavaThread::current();
 239 
 240   // check module
 241   Handle h_module(THREAD, JNIHandles::resolve(module));
 242   if (!java_lang_Module::is_instance(h_module())) {
 243     return JVMTI_ERROR_INVALID_MODULE;
 244   }
 245   // check to_module
 246   Handle h_to_module(THREAD, JNIHandles::resolve(to_module));
 247   if (!java_lang_Module::is_instance(h_to_module())) {
 248     return JVMTI_ERROR_INVALID_MODULE;
 249   }
 250   return JvmtiExport::add_module_reads(h_module, h_to_module, THREAD);
 251 } /* end AddModuleReads */
 252 
 253 
 254 // module - pre-checked for NULL
 255 // pkg_name - pre-checked for NULL
 256 // to_module - pre-checked for NULL
 257 jvmtiError
 258 JvmtiEnv::AddModuleExports(jobject module, const char* pkg_name, jobject to_module) {
 259   JavaThread* THREAD = JavaThread::current();
 260   Handle h_pkg = java_lang_String::create_from_str(pkg_name, THREAD);
 261 
 262   // check module
 263   Handle h_module(THREAD, JNIHandles::resolve(module));
 264   if (!java_lang_Module::is_instance(h_module())) {
 265     return JVMTI_ERROR_INVALID_MODULE;
 266   }
 267   // check to_module
 268   Handle h_to_module(THREAD, JNIHandles::resolve(to_module));
 269   if (!java_lang_Module::is_instance(h_to_module())) {
 270     return JVMTI_ERROR_INVALID_MODULE;
 271   }
 272   return JvmtiExport::add_module_exports(h_module, h_pkg, h_to_module, THREAD);
 273 } /* end AddModuleExports */
 274 
 275 
 276 // module - pre-checked for NULL
 277 // pkg_name - pre-checked for NULL
 278 // to_module - pre-checked for NULL
 279 jvmtiError
 280 JvmtiEnv::AddModuleOpens(jobject module, const char* pkg_name, jobject to_module) {
 281   JavaThread* THREAD = JavaThread::current();
 282   Handle h_pkg = java_lang_String::create_from_str(pkg_name, THREAD);
 283 
 284   // check module
 285   Handle h_module(THREAD, JNIHandles::resolve(module));
 286   if (!java_lang_Module::is_instance(h_module())) {
 287     return JVMTI_ERROR_INVALID_MODULE;
 288   }
 289   // check to_module
 290   Handle h_to_module(THREAD, JNIHandles::resolve(to_module));
 291   if (!java_lang_Module::is_instance(h_to_module())) {
 292     return JVMTI_ERROR_INVALID_MODULE;
 293   }
 294   return JvmtiExport::add_module_opens(h_module, h_pkg, h_to_module, THREAD);
 295 } /* end AddModuleOpens */
 296 
 297 
 298 // module - pre-checked for NULL
 299 // service - pre-checked for NULL
 300 jvmtiError
 301 JvmtiEnv::AddModuleUses(jobject module, jclass service) {
 302   JavaThread* THREAD = JavaThread::current();
 303 
 304   // check module
 305   Handle h_module(THREAD, JNIHandles::resolve(module));
 306   if (!java_lang_Module::is_instance(h_module())) {
 307     return JVMTI_ERROR_INVALID_MODULE;
 308   }
 309   // check service
 310   Handle h_service(THREAD, JNIHandles::resolve_external_guard(service));
 311   if (!java_lang_Class::is_instance(h_service()) ||
 312       java_lang_Class::is_primitive(h_service())) {
 313     return JVMTI_ERROR_INVALID_CLASS;
 314   }
 315   return JvmtiExport::add_module_uses(h_module, h_service, THREAD);
 316 } /* end AddModuleUses */
 317 
 318 
 319 // module - pre-checked for NULL
 320 // service - pre-checked for NULL
 321 // impl_class - pre-checked for NULL
 322 jvmtiError
 323 JvmtiEnv::AddModuleProvides(jobject module, jclass service, jclass impl_class) {
 324   JavaThread* THREAD = JavaThread::current();
 325 
 326   // check module
 327   Handle h_module(THREAD, JNIHandles::resolve(module));
 328   if (!java_lang_Module::is_instance(h_module())) {
 329     return JVMTI_ERROR_INVALID_MODULE;
 330   }
 331   // check service
 332   Handle h_service(THREAD, JNIHandles::resolve_external_guard(service));
 333   if (!java_lang_Class::is_instance(h_service()) ||
 334       java_lang_Class::is_primitive(h_service())) {
 335     return JVMTI_ERROR_INVALID_CLASS;
 336   }
 337   // check impl_class
 338   Handle h_impl_class(THREAD, JNIHandles::resolve_external_guard(impl_class));
 339   if (!java_lang_Class::is_instance(h_impl_class()) ||
 340       java_lang_Class::is_primitive(h_impl_class())) {
 341     return JVMTI_ERROR_INVALID_CLASS;
 342   }
 343   return JvmtiExport::add_module_provides(h_module, h_service, h_impl_class, THREAD);
 344 } /* end AddModuleProvides */
 345 
 346 // module - pre-checked for NULL
 347 // is_modifiable_class_ptr - pre-checked for NULL
 348 jvmtiError
 349 JvmtiEnv::IsModifiableModule(jobject module, jboolean* is_modifiable_module_ptr) {
 350   JavaThread* THREAD = JavaThread::current();
 351 
 352   // check module
 353   Handle h_module(THREAD, JNIHandles::resolve(module));
 354   if (!java_lang_Module::is_instance(h_module())) {
 355     return JVMTI_ERROR_INVALID_MODULE;
 356   }
 357 
 358   *is_modifiable_module_ptr = JNI_TRUE;
 359   return JVMTI_ERROR_NONE;
 360 } /* end IsModifiableModule */
 361 
 362 
 363   //
 364   // Class functions
 365   //
 366 
 367 // class_count_ptr - pre-checked for NULL
 368 // classes_ptr - pre-checked for NULL
 369 jvmtiError
 370 JvmtiEnv::GetLoadedClasses(jint* class_count_ptr, jclass** classes_ptr) {
 371   return JvmtiGetLoadedClasses::getLoadedClasses(this, class_count_ptr, classes_ptr);
 372 } /* end GetLoadedClasses */
 373 
 374 
 375 // initiating_loader - NULL is a valid value, must be checked
 376 // class_count_ptr - pre-checked for NULL
 377 // classes_ptr - pre-checked for NULL
 378 jvmtiError
 379 JvmtiEnv::GetClassLoaderClasses(jobject initiating_loader, jint* class_count_ptr, jclass** classes_ptr) {
 380   return JvmtiGetLoadedClasses::getClassLoaderClasses(this, initiating_loader,
 381                                                   class_count_ptr, classes_ptr);
 382 } /* end GetClassLoaderClasses */
 383 
 384 // k_mirror - may be primitive, this must be checked
 385 // is_modifiable_class_ptr - pre-checked for NULL
 386 jvmtiError
 387 JvmtiEnv::IsModifiableClass(oop k_mirror, jboolean* is_modifiable_class_ptr) {
 388   *is_modifiable_class_ptr = VM_RedefineClasses::is_modifiable_class(k_mirror)?
 389                                                        JNI_TRUE : JNI_FALSE;
 390   return JVMTI_ERROR_NONE;
 391 } /* end IsModifiableClass */
 392 
 393 // class_count - pre-checked to be greater than or equal to 0
 394 // classes - pre-checked for NULL
 395 jvmtiError
 396 JvmtiEnv::RetransformClasses(jint class_count, const jclass* classes) {
 397 //TODO: add locking
 398 
 399   int index;
 400   JavaThread* current_thread = JavaThread::current();
 401   ResourceMark rm(current_thread);
 402 
 403   jvmtiClassDefinition* class_definitions =
 404                             NEW_RESOURCE_ARRAY(jvmtiClassDefinition, class_count);
 405   NULL_CHECK(class_definitions, JVMTI_ERROR_OUT_OF_MEMORY);
 406 
 407   for (index = 0; index &lt; class_count; index++) {
 408     HandleMark hm(current_thread);
 409 
 410     jclass jcls = classes[index];
 411     oop k_mirror = JNIHandles::resolve_external_guard(jcls);
 412     if (k_mirror == NULL) {
 413       return JVMTI_ERROR_INVALID_CLASS;
 414     }
 415     if (!k_mirror-&gt;is_a(SystemDictionary::Class_klass())) {
 416       return JVMTI_ERROR_INVALID_CLASS;
 417     }
 418 
 419     if (!VM_RedefineClasses::is_modifiable_class(k_mirror)) {
 420       return JVMTI_ERROR_UNMODIFIABLE_CLASS;
 421     }
 422 
 423     Klass* klass = java_lang_Class::as_Klass(k_mirror);
 424 
 425     jint status = klass-&gt;jvmti_class_status();
 426     if (status &amp; (JVMTI_CLASS_STATUS_ERROR)) {
 427       return JVMTI_ERROR_INVALID_CLASS;
 428     }
 429 
 430     InstanceKlass* ik = InstanceKlass::cast(klass);
 431     if (ik-&gt;get_cached_class_file_bytes() == NULL) {
 432       // Not cached, we need to reconstitute the class file from the
 433       // VM representation. We don&#39;t attach the reconstituted class
 434       // bytes to the InstanceKlass here because they have not been
 435       // validated and we&#39;re not at a safepoint.
 436       JvmtiClassFileReconstituter reconstituter(ik);
 437       if (reconstituter.get_error() != JVMTI_ERROR_NONE) {
 438         return reconstituter.get_error();
 439       }
 440 
 441       class_definitions[index].class_byte_count = (jint)reconstituter.class_file_size();
 442       class_definitions[index].class_bytes      = (unsigned char*)
 443                                                        reconstituter.class_file_bytes();
 444     } else {
 445       // it is cached, get it from the cache
 446       class_definitions[index].class_byte_count = ik-&gt;get_cached_class_file_len();
 447       class_definitions[index].class_bytes      = ik-&gt;get_cached_class_file_bytes();
 448     }
 449     class_definitions[index].klass              = jcls;
 450   }
<a name="4" id="anc4"></a>
 451   VM_RedefineClasses op(class_count, class_definitions, jvmti_class_load_kind_retransform);
 452   VMThread::execute(&amp;op);
<a name="5" id="anc5"></a><span class="line-modified"> 453   return (op.check_error());</span>






 454 } /* end RetransformClasses */
 455 
 456 
 457 // class_count - pre-checked to be greater than or equal to 0
 458 // class_definitions - pre-checked for NULL
 459 jvmtiError
 460 JvmtiEnv::RedefineClasses(jint class_count, const jvmtiClassDefinition* class_definitions) {
 461 //TODO: add locking
<a name="6" id="anc6"></a>
 462   VM_RedefineClasses op(class_count, class_definitions, jvmti_class_load_kind_redefine);
 463   VMThread::execute(&amp;op);
<a name="7" id="anc7"></a><span class="line-modified"> 464   return (op.check_error());</span>






 465 } /* end RedefineClasses */
 466 
 467 
 468   //
 469   // Object functions
 470   //
 471 
 472 // size_ptr - pre-checked for NULL
 473 jvmtiError
 474 JvmtiEnv::GetObjectSize(jobject object, jlong* size_ptr) {
 475   oop mirror = JNIHandles::resolve_external_guard(object);
 476   NULL_CHECK(mirror, JVMTI_ERROR_INVALID_OBJECT);
 477   *size_ptr = (jlong)Universe::heap()-&gt;obj_size(mirror) * wordSize;
 478   return JVMTI_ERROR_NONE;
 479 } /* end GetObjectSize */
 480 
 481   //
 482   // Method functions
 483   //
 484 
 485 // prefix - NULL is a valid value, must be checked
 486 jvmtiError
 487 JvmtiEnv::SetNativeMethodPrefix(const char* prefix) {
 488   return prefix == NULL?
 489               SetNativeMethodPrefixes(0, NULL) :
 490               SetNativeMethodPrefixes(1, (char**)&amp;prefix);
 491 } /* end SetNativeMethodPrefix */
 492 
 493 
 494 // prefix_count - pre-checked to be greater than or equal to 0
 495 // prefixes - pre-checked for NULL
 496 jvmtiError
 497 JvmtiEnv::SetNativeMethodPrefixes(jint prefix_count, char** prefixes) {
 498   // Have to grab JVMTI thread state lock to be sure that some thread
 499   // isn&#39;t accessing the prefixes at the same time we are setting them.
 500   // No locks during VM bring-up.
 501   if (Threads::number_of_threads() == 0) {
 502     return set_native_method_prefixes(prefix_count, prefixes);
 503   } else {
 504     MutexLocker mu(JvmtiThreadState_lock);
 505     return set_native_method_prefixes(prefix_count, prefixes);
 506   }
 507 } /* end SetNativeMethodPrefixes */
 508 
 509   //
 510   // Event Management functions
 511   //
 512 
 513 // callbacks - NULL is a valid value, must be checked
 514 // size_of_callbacks - pre-checked to be greater than or equal to 0
 515 jvmtiError
 516 JvmtiEnv::SetEventCallbacks(const jvmtiEventCallbacks* callbacks, jint size_of_callbacks) {
 517   JvmtiEventController::set_event_callbacks(this, callbacks, size_of_callbacks);
 518   return JVMTI_ERROR_NONE;
 519 } /* end SetEventCallbacks */
 520 
 521 
 522 // event_thread - NULL is a valid value, must be checked
 523 jvmtiError
 524 JvmtiEnv::SetEventNotificationMode(jvmtiEventMode mode, jvmtiEvent event_type, jthread event_thread,   ...) {
 525   if (event_thread == NULL) {
 526     // Can be called at Agent_OnLoad() time with event_thread == NULL
 527     // when Thread::current() does not work yet so we cannot create a
 528     // ThreadsListHandle that is common to both thread-specific and
 529     // global code paths.
 530 
 531     // event_type must be valid
 532     if (!JvmtiEventController::is_valid_event_type(event_type)) {
 533       return JVMTI_ERROR_INVALID_EVENT_TYPE;
 534     }
 535 
 536     bool enabled = (mode == JVMTI_ENABLE);
 537 
 538     // assure that needed capabilities are present
 539     if (enabled &amp;&amp; !JvmtiUtil::has_event_capability(event_type, get_capabilities())) {
 540       return JVMTI_ERROR_MUST_POSSESS_CAPABILITY;
 541     }
 542 
 543     if (event_type == JVMTI_EVENT_CLASS_FILE_LOAD_HOOK &amp;&amp; enabled) {
 544       record_class_file_load_hook_enabled();
 545     }
 546 
 547     JvmtiEventController::set_user_enabled(this, (JavaThread*) NULL, event_type, enabled);
 548   } else {
 549     // We have a specified event_thread.
 550     JavaThread* java_thread = NULL;
 551     ThreadsListHandle tlh;
 552     jvmtiError err = JvmtiExport::cv_external_thread_to_JavaThread(tlh.list(), event_thread, &amp;java_thread, NULL);
 553     if (err != JVMTI_ERROR_NONE) {
 554       return err;
 555     }
 556 
 557     // event_type must be valid
 558     if (!JvmtiEventController::is_valid_event_type(event_type)) {
 559       return JVMTI_ERROR_INVALID_EVENT_TYPE;
 560     }
 561 
 562     // global events cannot be controlled at thread level.
 563     if (JvmtiEventController::is_global_event(event_type)) {
 564       return JVMTI_ERROR_ILLEGAL_ARGUMENT;
 565     }
 566 
 567     bool enabled = (mode == JVMTI_ENABLE);
 568 
 569     // assure that needed capabilities are present
 570     if (enabled &amp;&amp; !JvmtiUtil::has_event_capability(event_type, get_capabilities())) {
 571       return JVMTI_ERROR_MUST_POSSESS_CAPABILITY;
 572     }
 573 
 574     if (event_type == JVMTI_EVENT_CLASS_FILE_LOAD_HOOK &amp;&amp; enabled) {
 575       record_class_file_load_hook_enabled();
 576     }
 577     JvmtiEventController::set_user_enabled(this, java_thread, event_type, enabled);
 578   }
 579 
 580   return JVMTI_ERROR_NONE;
 581 } /* end SetEventNotificationMode */
 582 
 583   //
 584   // Capability functions
 585   //
 586 
 587 // capabilities_ptr - pre-checked for NULL
 588 jvmtiError
 589 JvmtiEnv::GetPotentialCapabilities(jvmtiCapabilities* capabilities_ptr) {
 590   JvmtiManageCapabilities::get_potential_capabilities(get_capabilities(),
 591                                                       get_prohibited_capabilities(),
 592                                                       capabilities_ptr);
 593   return JVMTI_ERROR_NONE;
 594 } /* end GetPotentialCapabilities */
 595 
 596 
 597 // capabilities_ptr - pre-checked for NULL
 598 jvmtiError
 599 JvmtiEnv::AddCapabilities(const jvmtiCapabilities* capabilities_ptr) {
 600   return JvmtiManageCapabilities::add_capabilities(get_capabilities(),
 601                                                    get_prohibited_capabilities(),
 602                                                    capabilities_ptr,
 603                                                    get_capabilities());
 604 } /* end AddCapabilities */
 605 
 606 
 607 // capabilities_ptr - pre-checked for NULL
 608 jvmtiError
 609 JvmtiEnv::RelinquishCapabilities(const jvmtiCapabilities* capabilities_ptr) {
 610   JvmtiManageCapabilities::relinquish_capabilities(get_capabilities(), capabilities_ptr, get_capabilities());
 611   return JVMTI_ERROR_NONE;
 612 } /* end RelinquishCapabilities */
 613 
 614 
 615 // capabilities_ptr - pre-checked for NULL
 616 jvmtiError
 617 JvmtiEnv::GetCapabilities(jvmtiCapabilities* capabilities_ptr) {
 618   JvmtiManageCapabilities::copy_capabilities(get_capabilities(), capabilities_ptr);
 619   return JVMTI_ERROR_NONE;
 620 } /* end GetCapabilities */
 621 
 622   //
 623   // Class Loader Search functions
 624   //
 625 
 626 // segment - pre-checked for NULL
 627 jvmtiError
 628 JvmtiEnv::AddToBootstrapClassLoaderSearch(const char* segment) {
 629   jvmtiPhase phase = get_phase();
 630   if (phase == JVMTI_PHASE_ONLOAD) {
 631     Arguments::append_sysclasspath(segment);
 632     return JVMTI_ERROR_NONE;
 633   } else if (use_version_1_0_semantics()) {
 634     // This JvmtiEnv requested version 1.0 semantics and this function
 635     // is only allowed in the ONLOAD phase in version 1.0 so we need to
 636     // return an error here.
 637     return JVMTI_ERROR_WRONG_PHASE;
 638   } else if (phase == JVMTI_PHASE_LIVE) {
 639     // The phase is checked by the wrapper that called this function,
 640     // but this thread could be racing with the thread that is
 641     // terminating the VM so we check one more time.
 642 
 643     // create the zip entry
 644     ClassPathZipEntry* zip_entry = ClassLoader::create_class_path_zip_entry(segment, true);
 645     if (zip_entry == NULL) {
 646       return JVMTI_ERROR_ILLEGAL_ARGUMENT;
 647     }
 648 
 649     // lock the loader
 650     Thread* thread = Thread::current();
 651     HandleMark hm;
 652     Handle loader_lock = Handle(thread, SystemDictionary::system_loader_lock());
 653 
 654     ObjectLocker ol(loader_lock, thread);
 655 
 656     // add the jar file to the bootclasspath
 657     log_info(class, load)(&quot;opened: %s&quot;, zip_entry-&gt;name());
 658 #if INCLUDE_CDS
 659     ClassLoaderExt::append_boot_classpath(zip_entry);
 660 #else
 661     ClassLoader::add_to_boot_append_entries(zip_entry);
 662 #endif
 663     return JVMTI_ERROR_NONE;
 664   } else {
 665     return JVMTI_ERROR_WRONG_PHASE;
 666   }
 667 
 668 } /* end AddToBootstrapClassLoaderSearch */
 669 
 670 
 671 // segment - pre-checked for NULL
 672 jvmtiError
 673 JvmtiEnv::AddToSystemClassLoaderSearch(const char* segment) {
 674   jvmtiPhase phase = get_phase();
 675 
 676   if (phase == JVMTI_PHASE_ONLOAD) {
 677     for (SystemProperty* p = Arguments::system_properties(); p != NULL; p = p-&gt;next()) {
 678       if (strcmp(&quot;java.class.path&quot;, p-&gt;key()) == 0) {
 679         p-&gt;append_value(segment);
 680         break;
 681       }
 682     }
 683     return JVMTI_ERROR_NONE;
 684   } else if (phase == JVMTI_PHASE_LIVE) {
 685     // The phase is checked by the wrapper that called this function,
 686     // but this thread could be racing with the thread that is
 687     // terminating the VM so we check one more time.
 688     HandleMark hm;
 689 
 690     // create the zip entry (which will open the zip file and hence
 691     // check that the segment is indeed a zip file).
 692     ClassPathZipEntry* zip_entry = ClassLoader::create_class_path_zip_entry(segment, false);
 693     if (zip_entry == NULL) {
 694       return JVMTI_ERROR_ILLEGAL_ARGUMENT;
 695     }
 696     delete zip_entry;   // no longer needed
 697 
 698     // lock the loader
 699     Thread* THREAD = Thread::current();
 700     Handle loader = Handle(THREAD, SystemDictionary::java_system_loader());
 701 
 702     ObjectLocker ol(loader, THREAD);
 703 
 704     // need the path as java.lang.String
 705     Handle path = java_lang_String::create_from_platform_dependent_str(segment, THREAD);
 706     if (HAS_PENDING_EXCEPTION) {
 707       CLEAR_PENDING_EXCEPTION;
 708       return JVMTI_ERROR_INTERNAL;
 709     }
 710 
 711     // Invoke the appendToClassPathForInstrumentation method - if the method
 712     // is not found it means the loader doesn&#39;t support adding to the class path
 713     // in the live phase.
 714     {
 715       JavaValue res(T_VOID);
 716       JavaCalls::call_special(&amp;res,
 717                               loader,
 718                               loader-&gt;klass(),
 719                               vmSymbols::appendToClassPathForInstrumentation_name(),
 720                               vmSymbols::appendToClassPathForInstrumentation_signature(),
 721                               path,
 722                               THREAD);
 723       if (HAS_PENDING_EXCEPTION) {
 724         Symbol* ex_name = PENDING_EXCEPTION-&gt;klass()-&gt;name();
 725         CLEAR_PENDING_EXCEPTION;
 726 
 727         if (ex_name == vmSymbols::java_lang_NoSuchMethodError()) {
 728           return JVMTI_ERROR_CLASS_LOADER_UNSUPPORTED;
 729         } else {
 730           return JVMTI_ERROR_INTERNAL;
 731         }
 732       }
 733     }
 734 
 735     return JVMTI_ERROR_NONE;
 736   } else {
 737     return JVMTI_ERROR_WRONG_PHASE;
 738   }
 739 } /* end AddToSystemClassLoaderSearch */
 740 
 741   //
 742   // General functions
 743   //
 744 
 745 // phase_ptr - pre-checked for NULL
 746 jvmtiError
 747 JvmtiEnv::GetPhase(jvmtiPhase* phase_ptr) {
 748   *phase_ptr = phase();
 749   return JVMTI_ERROR_NONE;
 750 } /* end GetPhase */
 751 
 752 
 753 jvmtiError
 754 JvmtiEnv::DisposeEnvironment() {
 755   dispose();
 756   return JVMTI_ERROR_NONE;
 757 } /* end DisposeEnvironment */
 758 
 759 
 760 // data - NULL is a valid value, must be checked
 761 jvmtiError
 762 JvmtiEnv::SetEnvironmentLocalStorage(const void* data) {
 763   set_env_local_storage(data);
 764   return JVMTI_ERROR_NONE;
 765 } /* end SetEnvironmentLocalStorage */
 766 
 767 
 768 // data_ptr - pre-checked for NULL
 769 jvmtiError
 770 JvmtiEnv::GetEnvironmentLocalStorage(void** data_ptr) {
 771   *data_ptr = (void*)get_env_local_storage();
 772   return JVMTI_ERROR_NONE;
 773 } /* end GetEnvironmentLocalStorage */
 774 
 775 // version_ptr - pre-checked for NULL
 776 jvmtiError
 777 JvmtiEnv::GetVersionNumber(jint* version_ptr) {
 778   *version_ptr = JVMTI_VERSION;
 779   return JVMTI_ERROR_NONE;
 780 } /* end GetVersionNumber */
 781 
 782 
 783 // name_ptr - pre-checked for NULL
 784 jvmtiError
 785 JvmtiEnv::GetErrorName(jvmtiError error, char** name_ptr) {
 786   if (error &lt; JVMTI_ERROR_NONE || error &gt; JVMTI_ERROR_MAX) {
 787     return JVMTI_ERROR_ILLEGAL_ARGUMENT;
 788   }
 789   const char *name = JvmtiUtil::error_name(error);
 790   if (name == NULL) {
 791     return JVMTI_ERROR_ILLEGAL_ARGUMENT;
 792   }
 793   size_t len = strlen(name) + 1;
 794   jvmtiError err = allocate(len, (unsigned char**)name_ptr);
 795   if (err == JVMTI_ERROR_NONE) {
 796     memcpy(*name_ptr, name, len);
 797   }
 798   return err;
 799 } /* end GetErrorName */
 800 
 801 
 802 jvmtiError
 803 JvmtiEnv::SetVerboseFlag(jvmtiVerboseFlag flag, jboolean value) {
 804   LogLevelType level = value == 0 ? LogLevel::Off : LogLevel::Info;
 805   switch (flag) {
 806   case JVMTI_VERBOSE_OTHER:
 807     // ignore
 808     break;
 809   case JVMTI_VERBOSE_CLASS:
 810     LogConfiguration::configure_stdout(level, false, LOG_TAGS(class, unload));
 811     LogConfiguration::configure_stdout(level, false, LOG_TAGS(class, load));
 812     break;
 813   case JVMTI_VERBOSE_GC:
<a name="8" id="anc8"></a><span class="line-modified"> 814     if (value == 0) {</span>
<span class="line-removed"> 815       LogConfiguration::configure_stdout(LogLevel::Off, true, LOG_TAGS(gc));</span>
<span class="line-removed"> 816     } else {</span>
<span class="line-removed"> 817       LogConfiguration::configure_stdout(LogLevel::Info, true, LOG_TAGS(gc));</span>
<span class="line-removed"> 818     }</span>
 819     break;
 820   case JVMTI_VERBOSE_JNI:
<a name="9" id="anc9"></a><span class="line-modified"> 821     PrintJNIResolving = value != 0;</span>

 822     break;
 823   default:
 824     return JVMTI_ERROR_ILLEGAL_ARGUMENT;
 825   };
 826   return JVMTI_ERROR_NONE;
 827 } /* end SetVerboseFlag */
 828 
 829 
 830 // format_ptr - pre-checked for NULL
 831 jvmtiError
 832 JvmtiEnv::GetJLocationFormat(jvmtiJlocationFormat* format_ptr) {
 833   *format_ptr = JVMTI_JLOCATION_JVMBCI;
 834   return JVMTI_ERROR_NONE;
 835 } /* end GetJLocationFormat */
 836 
 837   //
 838   // Thread functions
 839   //
 840 
 841 // Threads_lock NOT held
 842 // thread - NOT pre-checked
 843 // thread_state_ptr - pre-checked for NULL
 844 jvmtiError
 845 JvmtiEnv::GetThreadState(jthread thread, jint* thread_state_ptr) {
 846   JavaThread* current_thread = JavaThread::current();
 847   JavaThread* java_thread = NULL;
 848   oop thread_oop = NULL;
 849   ThreadsListHandle tlh(current_thread);
 850 
 851   if (thread == NULL) {
 852     java_thread = current_thread;
 853     thread_oop = java_thread-&gt;threadObj();
 854 
 855     if (thread_oop == NULL || !thread_oop-&gt;is_a(SystemDictionary::Thread_klass())) {
 856       return JVMTI_ERROR_INVALID_THREAD;
 857     }
 858   } else {
 859     jvmtiError err = JvmtiExport::cv_external_thread_to_JavaThread(tlh.list(), thread, &amp;java_thread, &amp;thread_oop);
 860     if (err != JVMTI_ERROR_NONE) {
 861       // We got an error code so we don&#39;t have a JavaThread *, but
 862       // only return an error from here if we didn&#39;t get a valid
 863       // thread_oop.
 864       if (thread_oop == NULL) {
 865         return err;
 866       }
 867       // We have a valid thread_oop so we can return some thread state.
 868     }
 869   }
 870 
 871   // get most state bits
 872   jint state = (jint)java_lang_Thread::get_thread_status(thread_oop);
 873 
 874   if (java_thread != NULL) {
 875     // We have a JavaThread* so add more state bits.
 876     JavaThreadState jts = java_thread-&gt;thread_state();
 877 
 878     if (java_thread-&gt;is_being_ext_suspended()) {
 879       state |= JVMTI_THREAD_STATE_SUSPENDED;
 880     }
 881     if (jts == _thread_in_native) {
 882       state |= JVMTI_THREAD_STATE_IN_NATIVE;
 883     }
<a name="10" id="anc10"></a><span class="line-modified"> 884     OSThread* osThread = java_thread-&gt;osthread();</span>
<span class="line-removed"> 885     if (osThread != NULL &amp;&amp; osThread-&gt;interrupted()) {</span>
 886       state |= JVMTI_THREAD_STATE_INTERRUPTED;
 887     }
 888   }
 889 
 890   *thread_state_ptr = state;
 891   return JVMTI_ERROR_NONE;
 892 } /* end GetThreadState */
 893 
 894 
 895 // thread_ptr - pre-checked for NULL
 896 jvmtiError
 897 JvmtiEnv::GetCurrentThread(jthread* thread_ptr) {
 898   JavaThread* current_thread  = JavaThread::current();
 899   *thread_ptr = (jthread)JNIHandles::make_local(current_thread, current_thread-&gt;threadObj());
 900   return JVMTI_ERROR_NONE;
 901 } /* end GetCurrentThread */
 902 
 903 
 904 // threads_count_ptr - pre-checked for NULL
 905 // threads_ptr - pre-checked for NULL
 906 jvmtiError
 907 JvmtiEnv::GetAllThreads(jint* threads_count_ptr, jthread** threads_ptr) {
 908   int nthreads        = 0;
 909   Handle *thread_objs = NULL;
 910   ResourceMark rm;
 911   HandleMark hm;
 912 
 913   // enumerate threads (including agent threads)
 914   ThreadsListEnumerator tle(Thread::current(), true);
 915   nthreads = tle.num_threads();
 916   *threads_count_ptr = nthreads;
 917 
 918   if (nthreads == 0) {
 919     *threads_ptr = NULL;
 920     return JVMTI_ERROR_NONE;
 921   }
 922 
 923   thread_objs = NEW_RESOURCE_ARRAY(Handle, nthreads);
 924   NULL_CHECK(thread_objs, JVMTI_ERROR_OUT_OF_MEMORY);
 925 
 926   for (int i = 0; i &lt; nthreads; i++) {
 927     thread_objs[i] = Handle(tle.get_threadObj(i));
 928   }
 929 
 930   jthread *jthreads  = new_jthreadArray(nthreads, thread_objs);
 931   NULL_CHECK(jthreads, JVMTI_ERROR_OUT_OF_MEMORY);
 932 
 933   *threads_ptr = jthreads;
 934   return JVMTI_ERROR_NONE;
 935 } /* end GetAllThreads */
 936 
 937 
 938 // Threads_lock NOT held, java_thread not protected by lock
 939 // java_thread - pre-checked
 940 jvmtiError
 941 JvmtiEnv::SuspendThread(JavaThread* java_thread) {
 942   // don&#39;t allow hidden thread suspend request.
 943   if (java_thread-&gt;is_hidden_from_external_view()) {
 944     return (JVMTI_ERROR_NONE);
 945   }
 946 
 947   {
<a name="11" id="anc11"></a><span class="line-modified"> 948     MutexLockerEx ml(java_thread-&gt;SR_lock(), Mutex::_no_safepoint_check_flag);</span>
 949     if (java_thread-&gt;is_external_suspend()) {
 950       // don&#39;t allow nested external suspend requests.
 951       return (JVMTI_ERROR_THREAD_SUSPENDED);
 952     }
 953     if (java_thread-&gt;is_exiting()) { // thread is in the process of exiting
 954       return (JVMTI_ERROR_THREAD_NOT_ALIVE);
 955     }
 956     java_thread-&gt;set_external_suspend();
 957   }
 958 
 959   if (!JvmtiSuspendControl::suspend(java_thread)) {
 960     // the thread was in the process of exiting
 961     return (JVMTI_ERROR_THREAD_NOT_ALIVE);
 962   }
 963   return JVMTI_ERROR_NONE;
 964 } /* end SuspendThread */
 965 
 966 
 967 // request_count - pre-checked to be greater than or equal to 0
 968 // request_list - pre-checked for NULL
 969 // results - pre-checked for NULL
 970 jvmtiError
 971 JvmtiEnv::SuspendThreadList(jint request_count, const jthread* request_list, jvmtiError* results) {
 972   int needSafepoint = 0;  // &gt; 0 if we need a safepoint
 973   ThreadsListHandle tlh;
 974   for (int i = 0; i &lt; request_count; i++) {
 975     JavaThread *java_thread = NULL;
 976     jvmtiError err = JvmtiExport::cv_external_thread_to_JavaThread(tlh.list(), request_list[i], &amp;java_thread, NULL);
 977     if (err != JVMTI_ERROR_NONE) {
 978       results[i] = err;
 979       continue;
 980     }
 981     // don&#39;t allow hidden thread suspend request.
 982     if (java_thread-&gt;is_hidden_from_external_view()) {
 983       results[i] = JVMTI_ERROR_NONE;  // indicate successful suspend
 984       continue;
 985     }
 986 
 987     {
<a name="12" id="anc12"></a><span class="line-modified"> 988       MutexLockerEx ml(java_thread-&gt;SR_lock(), Mutex::_no_safepoint_check_flag);</span>
 989       if (java_thread-&gt;is_external_suspend()) {
 990         // don&#39;t allow nested external suspend requests.
 991         results[i] = JVMTI_ERROR_THREAD_SUSPENDED;
 992         continue;
 993       }
 994       if (java_thread-&gt;is_exiting()) { // thread is in the process of exiting
 995         results[i] = JVMTI_ERROR_THREAD_NOT_ALIVE;
 996         continue;
 997       }
 998       java_thread-&gt;set_external_suspend();
 999     }
1000     if (java_thread-&gt;thread_state() == _thread_in_native) {
1001       // We need to try and suspend native threads here. Threads in
1002       // other states will self-suspend on their next transition.
1003       if (!JvmtiSuspendControl::suspend(java_thread)) {
1004         // The thread was in the process of exiting. Force another
1005         // safepoint to make sure that this thread transitions.
1006         needSafepoint++;
1007         results[i] = JVMTI_ERROR_THREAD_NOT_ALIVE;
1008         continue;
1009       }
1010     } else {
1011       needSafepoint++;
1012     }
1013     results[i] = JVMTI_ERROR_NONE;  // indicate successful suspend
1014   }
1015   if (needSafepoint &gt; 0) {
1016     VM_ThreadsSuspendJVMTI tsj;
1017     VMThread::execute(&amp;tsj);
1018   }
1019   // per-thread suspend results returned via results parameter
1020   return JVMTI_ERROR_NONE;
1021 } /* end SuspendThreadList */
1022 
1023 
1024 // Threads_lock NOT held, java_thread not protected by lock
1025 // java_thread - pre-checked
1026 jvmtiError
1027 JvmtiEnv::ResumeThread(JavaThread* java_thread) {
1028   // don&#39;t allow hidden thread resume request.
1029   if (java_thread-&gt;is_hidden_from_external_view()) {
1030     return JVMTI_ERROR_NONE;
1031   }
1032 
1033   if (!java_thread-&gt;is_being_ext_suspended()) {
1034     return JVMTI_ERROR_THREAD_NOT_SUSPENDED;
1035   }
1036 
1037   if (!JvmtiSuspendControl::resume(java_thread)) {
1038     return JVMTI_ERROR_INTERNAL;
1039   }
1040   return JVMTI_ERROR_NONE;
1041 } /* end ResumeThread */
1042 
1043 
1044 // request_count - pre-checked to be greater than or equal to 0
1045 // request_list - pre-checked for NULL
1046 // results - pre-checked for NULL
1047 jvmtiError
1048 JvmtiEnv::ResumeThreadList(jint request_count, const jthread* request_list, jvmtiError* results) {
1049   ThreadsListHandle tlh;
1050   for (int i = 0; i &lt; request_count; i++) {
1051     JavaThread* java_thread = NULL;
1052     jvmtiError err = JvmtiExport::cv_external_thread_to_JavaThread(tlh.list(), request_list[i], &amp;java_thread, NULL);
1053     if (err != JVMTI_ERROR_NONE) {
1054       results[i] = err;
1055       continue;
1056     }
1057     // don&#39;t allow hidden thread resume request.
1058     if (java_thread-&gt;is_hidden_from_external_view()) {
1059       results[i] = JVMTI_ERROR_NONE;  // indicate successful resume
1060       continue;
1061     }
1062     if (!java_thread-&gt;is_being_ext_suspended()) {
1063       results[i] = JVMTI_ERROR_THREAD_NOT_SUSPENDED;
1064       continue;
1065     }
1066 
1067     if (!JvmtiSuspendControl::resume(java_thread)) {
1068       results[i] = JVMTI_ERROR_INTERNAL;
1069       continue;
1070     }
1071 
1072     results[i] = JVMTI_ERROR_NONE;  // indicate successful resume
1073   }
1074   // per-thread resume results returned via results parameter
1075   return JVMTI_ERROR_NONE;
1076 } /* end ResumeThreadList */
1077 
1078 
1079 // Threads_lock NOT held, java_thread not protected by lock
1080 // java_thread - pre-checked
1081 jvmtiError
1082 JvmtiEnv::StopThread(JavaThread* java_thread, jobject exception) {
1083   oop e = JNIHandles::resolve_external_guard(exception);
1084   NULL_CHECK(e, JVMTI_ERROR_NULL_POINTER);
1085 
1086   JavaThread::send_async_exception(java_thread-&gt;threadObj(), e);
1087 
1088   return JVMTI_ERROR_NONE;
1089 
1090 } /* end StopThread */
1091 
1092 
1093 // Threads_lock NOT held
1094 // thread - NOT pre-checked
1095 jvmtiError
1096 JvmtiEnv::InterruptThread(jthread thread) {
<a name="13" id="anc13"></a><span class="line-removed">1097   // TODO: this is very similar to JVM_Interrupt(); share code in future</span>
1098   JavaThread* current_thread  = JavaThread::current();
1099   JavaThread* java_thread = NULL;
1100   ThreadsListHandle tlh(current_thread);
1101   jvmtiError err = JvmtiExport::cv_external_thread_to_JavaThread(tlh.list(), thread, &amp;java_thread, NULL);
1102   if (err != JVMTI_ERROR_NONE) {
1103     return err;
1104   }
<a name="14" id="anc14"></a><span class="line-modified">1105 </span>
<span class="line-modified">1106   Thread::interrupt(java_thread);</span>




1107 
1108   return JVMTI_ERROR_NONE;
1109 } /* end InterruptThread */
1110 
1111 
1112 // Threads_lock NOT held
1113 // thread - NOT pre-checked
1114 // info_ptr - pre-checked for NULL
1115 jvmtiError
1116 JvmtiEnv::GetThreadInfo(jthread thread, jvmtiThreadInfo* info_ptr) {
1117   ResourceMark rm;
1118   HandleMark hm;
1119 
1120   JavaThread* current_thread = JavaThread::current();
1121   ThreadsListHandle tlh(current_thread);
1122 
1123   // if thread is NULL the current thread is used
1124   oop thread_oop = NULL;
1125   if (thread == NULL) {
1126     thread_oop = current_thread-&gt;threadObj();
1127     if (thread_oop == NULL || !thread_oop-&gt;is_a(SystemDictionary::Thread_klass())) {
1128       return JVMTI_ERROR_INVALID_THREAD;
1129     }
1130   } else {
1131     JavaThread* java_thread = NULL;
1132     jvmtiError err = JvmtiExport::cv_external_thread_to_JavaThread(tlh.list(), thread, &amp;java_thread, &amp;thread_oop);
1133     if (err != JVMTI_ERROR_NONE) {
1134       // We got an error code so we don&#39;t have a JavaThread *, but
1135       // only return an error from here if we didn&#39;t get a valid
1136       // thread_oop.
1137       if (thread_oop == NULL) {
1138         return err;
1139       }
1140       // We have a valid thread_oop so we can return some thread info.
1141     }
1142   }
1143 
1144   Handle thread_obj(current_thread, thread_oop);
1145   Handle name;
1146   ThreadPriority priority;
1147   Handle     thread_group;
1148   Handle context_class_loader;
1149   bool          is_daemon;
1150 
1151   name = Handle(current_thread, java_lang_Thread::name(thread_obj()));
1152   priority = java_lang_Thread::priority(thread_obj());
1153   thread_group = Handle(current_thread, java_lang_Thread::threadGroup(thread_obj()));
1154   is_daemon = java_lang_Thread::is_daemon(thread_obj());
1155 
1156   oop loader = java_lang_Thread::context_class_loader(thread_obj());
1157   context_class_loader = Handle(current_thread, loader);
1158 
1159   { const char *n;
1160 
1161     if (name() != NULL) {
1162       n = java_lang_String::as_utf8_string(name());
1163     } else {
1164       int utf8_length = 0;
1165       n = UNICODE::as_utf8((jchar*) NULL, utf8_length);
1166     }
1167 
1168     info_ptr-&gt;name = (char *) jvmtiMalloc(strlen(n)+1);
1169     if (info_ptr-&gt;name == NULL)
1170       return JVMTI_ERROR_OUT_OF_MEMORY;
1171 
1172     strcpy(info_ptr-&gt;name, n);
1173   }
1174   info_ptr-&gt;is_daemon = is_daemon;
1175   info_ptr-&gt;priority  = priority;
1176 
1177   info_ptr-&gt;context_class_loader = (context_class_loader.is_null()) ? NULL :
1178                                      jni_reference(context_class_loader);
1179   info_ptr-&gt;thread_group = jni_reference(thread_group);
1180 
1181   return JVMTI_ERROR_NONE;
1182 } /* end GetThreadInfo */
1183 
1184 
1185 // Threads_lock NOT held, java_thread not protected by lock
1186 // java_thread - pre-checked
1187 // owned_monitor_count_ptr - pre-checked for NULL
1188 // owned_monitors_ptr - pre-checked for NULL
1189 jvmtiError
1190 JvmtiEnv::GetOwnedMonitorInfo(JavaThread* java_thread, jint* owned_monitor_count_ptr, jobject** owned_monitors_ptr) {
1191   jvmtiError err = JVMTI_ERROR_NONE;
1192   JavaThread* calling_thread = JavaThread::current();
1193 
1194   // growable array of jvmti monitors info on the C-heap
1195   GrowableArray&lt;jvmtiMonitorStackDepthInfo*&gt; *owned_monitors_list =
1196       new (ResourceObj::C_HEAP, mtInternal) GrowableArray&lt;jvmtiMonitorStackDepthInfo*&gt;(1, true);
1197 
1198   // It is only safe to perform the direct operation on the current
1199   // thread. All other usage needs to use a vm-safepoint-op for safety.
1200   if (java_thread == calling_thread) {
1201     err = get_owned_monitors(calling_thread, java_thread, owned_monitors_list);
1202   } else {
1203     // JVMTI get monitors info at safepoint. Do not require target thread to
1204     // be suspended.
1205     VM_GetOwnedMonitorInfo op(this, calling_thread, java_thread, owned_monitors_list);
1206     VMThread::execute(&amp;op);
1207     err = op.result();
1208   }
1209   jint owned_monitor_count = owned_monitors_list-&gt;length();
1210   if (err == JVMTI_ERROR_NONE) {
1211     if ((err = allocate(owned_monitor_count * sizeof(jobject *),
1212                       (unsigned char**)owned_monitors_ptr)) == JVMTI_ERROR_NONE) {
1213       // copy into the returned array
1214       for (int i = 0; i &lt; owned_monitor_count; i++) {
1215         (*owned_monitors_ptr)[i] =
1216           ((jvmtiMonitorStackDepthInfo*)owned_monitors_list-&gt;at(i))-&gt;monitor;
1217       }
1218       *owned_monitor_count_ptr = owned_monitor_count;
1219     }
1220   }
1221   // clean up.
1222   for (int i = 0; i &lt; owned_monitor_count; i++) {
1223     deallocate((unsigned char*)owned_monitors_list-&gt;at(i));
1224   }
1225   delete owned_monitors_list;
1226 
1227   return err;
1228 } /* end GetOwnedMonitorInfo */
1229 
1230 
1231 // Threads_lock NOT held, java_thread not protected by lock
1232 // java_thread - pre-checked
1233 // monitor_info_count_ptr - pre-checked for NULL
1234 // monitor_info_ptr - pre-checked for NULL
1235 jvmtiError
1236 JvmtiEnv::GetOwnedMonitorStackDepthInfo(JavaThread* java_thread, jint* monitor_info_count_ptr, jvmtiMonitorStackDepthInfo** monitor_info_ptr) {
1237   jvmtiError err = JVMTI_ERROR_NONE;
1238   JavaThread* calling_thread  = JavaThread::current();
1239 
1240   // growable array of jvmti monitors info on the C-heap
1241   GrowableArray&lt;jvmtiMonitorStackDepthInfo*&gt; *owned_monitors_list =
1242          new (ResourceObj::C_HEAP, mtInternal) GrowableArray&lt;jvmtiMonitorStackDepthInfo*&gt;(1, true);
1243 
1244   // It is only safe to perform the direct operation on the current
1245   // thread. All other usage needs to use a vm-safepoint-op for safety.
1246   if (java_thread == calling_thread) {
1247     err = get_owned_monitors(calling_thread, java_thread, owned_monitors_list);
1248   } else {
1249     // JVMTI get owned monitors info at safepoint. Do not require target thread to
1250     // be suspended.
1251     VM_GetOwnedMonitorInfo op(this, calling_thread, java_thread, owned_monitors_list);
1252     VMThread::execute(&amp;op);
1253     err = op.result();
1254   }
1255 
1256   jint owned_monitor_count = owned_monitors_list-&gt;length();
1257   if (err == JVMTI_ERROR_NONE) {
1258     if ((err = allocate(owned_monitor_count * sizeof(jvmtiMonitorStackDepthInfo),
1259                       (unsigned char**)monitor_info_ptr)) == JVMTI_ERROR_NONE) {
1260       // copy to output array.
1261       for (int i = 0; i &lt; owned_monitor_count; i++) {
1262         (*monitor_info_ptr)[i].monitor =
1263           ((jvmtiMonitorStackDepthInfo*)owned_monitors_list-&gt;at(i))-&gt;monitor;
1264         (*monitor_info_ptr)[i].stack_depth =
1265           ((jvmtiMonitorStackDepthInfo*)owned_monitors_list-&gt;at(i))-&gt;stack_depth;
1266       }
1267     }
1268     *monitor_info_count_ptr = owned_monitor_count;
1269   }
1270 
1271   // clean up.
1272   for (int i = 0; i &lt; owned_monitor_count; i++) {
1273     deallocate((unsigned char*)owned_monitors_list-&gt;at(i));
1274   }
1275   delete owned_monitors_list;
1276 
1277   return err;
1278 } /* end GetOwnedMonitorStackDepthInfo */
1279 
1280 
1281 // Threads_lock NOT held, java_thread not protected by lock
1282 // java_thread - pre-checked
1283 // monitor_ptr - pre-checked for NULL
1284 jvmtiError
1285 JvmtiEnv::GetCurrentContendedMonitor(JavaThread* java_thread, jobject* monitor_ptr) {
1286   jvmtiError err = JVMTI_ERROR_NONE;
1287   JavaThread* calling_thread  = JavaThread::current();
1288 
1289   // It is only safe to perform the direct operation on the current
1290   // thread. All other usage needs to use a vm-safepoint-op for safety.
1291   if (java_thread == calling_thread) {
1292     err = get_current_contended_monitor(calling_thread, java_thread, monitor_ptr);
1293   } else {
1294     // get contended monitor information at safepoint.
1295     VM_GetCurrentContendedMonitor op(this, calling_thread, java_thread, monitor_ptr);
1296     VMThread::execute(&amp;op);
1297     err = op.result();
1298   }
1299   return err;
1300 } /* end GetCurrentContendedMonitor */
1301 
1302 
1303 // Threads_lock NOT held
1304 // thread - NOT pre-checked
1305 // proc - pre-checked for NULL
1306 // arg - NULL is a valid value, must be checked
1307 jvmtiError
1308 JvmtiEnv::RunAgentThread(jthread thread, jvmtiStartFunction proc, const void* arg, jint priority) {
1309   JavaThread* current_thread = JavaThread::current();
1310 
1311   JavaThread* java_thread = NULL;
1312   oop thread_oop = NULL;
1313   ThreadsListHandle tlh(current_thread);
1314   jvmtiError err = JvmtiExport::cv_external_thread_to_JavaThread(tlh.list(), thread, &amp;java_thread, &amp;thread_oop);
1315   if (err != JVMTI_ERROR_NONE) {
1316     // We got an error code so we don&#39;t have a JavaThread *, but
1317     // only return an error from here if we didn&#39;t get a valid
1318     // thread_oop.
1319     if (thread_oop == NULL) {
1320       return err;
1321     }
1322     // We have a valid thread_oop.
1323   }
1324 
1325   if (java_thread != NULL) {
1326     // &#39;thread&#39; refers to an existing JavaThread.
1327     return JVMTI_ERROR_INVALID_THREAD;
1328   }
1329 
1330   if (priority &lt; JVMTI_THREAD_MIN_PRIORITY || priority &gt; JVMTI_THREAD_MAX_PRIORITY) {
1331     return JVMTI_ERROR_INVALID_PRIORITY;
1332   }
1333 
1334   Handle thread_hndl(current_thread, thread_oop);
1335   {
<a name="15" id="anc15"></a><span class="line-modified">1336     MutexLocker mu(Threads_lock); // grab Threads_lock</span>
1337 
1338     JvmtiAgentThread *new_thread = new JvmtiAgentThread(this, proc, arg);
1339 
1340     // At this point it may be possible that no osthread was created for the
1341     // JavaThread due to lack of memory.
1342     if (new_thread == NULL || new_thread-&gt;osthread() == NULL) {
1343       if (new_thread != NULL) {
1344         new_thread-&gt;smr_delete();
1345       }
1346       return JVMTI_ERROR_OUT_OF_MEMORY;
1347     }
1348 
1349     java_lang_Thread::set_thread(thread_hndl(), new_thread);
1350     java_lang_Thread::set_priority(thread_hndl(), (ThreadPriority)priority);
1351     java_lang_Thread::set_daemon(thread_hndl());
1352 
1353     new_thread-&gt;set_threadObj(thread_hndl());
1354     Threads::add(new_thread);
1355     Thread::start(new_thread);
1356   } // unlock Threads_lock
1357 
1358   return JVMTI_ERROR_NONE;
1359 } /* end RunAgentThread */
1360 
1361   //
1362   // Thread Group functions
1363   //
1364 
1365 // group_count_ptr - pre-checked for NULL
1366 // groups_ptr - pre-checked for NULL
1367 jvmtiError
1368 JvmtiEnv::GetTopThreadGroups(jint* group_count_ptr, jthreadGroup** groups_ptr) {
1369   JavaThread* current_thread = JavaThread::current();
1370 
1371   // Only one top level thread group now.
1372   *group_count_ptr = 1;
1373 
1374   // Allocate memory to store global-refs to the thread groups.
1375   // Assume this area is freed by caller.
1376   *groups_ptr = (jthreadGroup *) jvmtiMalloc((sizeof(jthreadGroup)) * (*group_count_ptr));
1377 
1378   NULL_CHECK(*groups_ptr, JVMTI_ERROR_OUT_OF_MEMORY);
1379 
1380   // Convert oop to Handle, then convert Handle to global-ref.
1381   {
1382     HandleMark hm(current_thread);
1383     Handle system_thread_group(current_thread, Universe::system_thread_group());
1384     *groups_ptr[0] = jni_reference(system_thread_group);
1385   }
1386 
1387   return JVMTI_ERROR_NONE;
1388 } /* end GetTopThreadGroups */
1389 
1390 
1391 // info_ptr - pre-checked for NULL
1392 jvmtiError
1393 JvmtiEnv::GetThreadGroupInfo(jthreadGroup group, jvmtiThreadGroupInfo* info_ptr) {
1394   ResourceMark rm;
1395   HandleMark hm;
1396 
1397   JavaThread* current_thread = JavaThread::current();
1398 
1399   Handle group_obj (current_thread, JNIHandles::resolve_external_guard(group));
1400   NULL_CHECK(group_obj(), JVMTI_ERROR_INVALID_THREAD_GROUP);
1401 
1402   const char* name;
1403   Handle parent_group;
1404   bool is_daemon;
1405   ThreadPriority max_priority;
1406 
1407   name         = java_lang_ThreadGroup::name(group_obj());
1408   parent_group = Handle(current_thread, java_lang_ThreadGroup::parent(group_obj()));
1409   is_daemon    = java_lang_ThreadGroup::is_daemon(group_obj());
1410   max_priority = java_lang_ThreadGroup::maxPriority(group_obj());
1411 
1412   info_ptr-&gt;is_daemon    = is_daemon;
1413   info_ptr-&gt;max_priority = max_priority;
1414   info_ptr-&gt;parent       = jni_reference(parent_group);
1415 
1416   if (name != NULL) {
1417     info_ptr-&gt;name = (char*)jvmtiMalloc(strlen(name)+1);
1418     NULL_CHECK(info_ptr-&gt;name, JVMTI_ERROR_OUT_OF_MEMORY);
1419     strcpy(info_ptr-&gt;name, name);
1420   } else {
1421     info_ptr-&gt;name = NULL;
1422   }
1423 
1424   return JVMTI_ERROR_NONE;
1425 } /* end GetThreadGroupInfo */
1426 
1427 
1428 // thread_count_ptr - pre-checked for NULL
1429 // threads_ptr - pre-checked for NULL
1430 // group_count_ptr - pre-checked for NULL
1431 // groups_ptr - pre-checked for NULL
1432 jvmtiError
1433 JvmtiEnv::GetThreadGroupChildren(jthreadGroup group, jint* thread_count_ptr, jthread** threads_ptr, jint* group_count_ptr, jthreadGroup** groups_ptr) {
1434   JavaThread* current_thread = JavaThread::current();
1435   oop group_obj = (oop) JNIHandles::resolve_external_guard(group);
1436   NULL_CHECK(group_obj, JVMTI_ERROR_INVALID_THREAD_GROUP);
1437 
1438   Handle *thread_objs = NULL;
1439   Handle *group_objs  = NULL;
1440   int nthreads = 0;
1441   int ngroups = 0;
1442   int hidden_threads = 0;
1443 
1444   ResourceMark rm(current_thread);
1445   HandleMark hm(current_thread);
1446 
1447   Handle group_hdl(current_thread, group_obj);
1448 
1449   { // Cannot allow thread or group counts to change.
1450     ObjectLocker ol(group_hdl, current_thread);
1451 
1452     nthreads = java_lang_ThreadGroup::nthreads(group_hdl());
1453     ngroups  = java_lang_ThreadGroup::ngroups(group_hdl());
1454 
1455     if (nthreads &gt; 0) {
1456       ThreadsListHandle tlh(current_thread);
1457       objArrayOop threads = java_lang_ThreadGroup::threads(group_hdl());
1458       assert(nthreads &lt;= threads-&gt;length(), &quot;too many threads&quot;);
1459       thread_objs = NEW_RESOURCE_ARRAY(Handle,nthreads);
1460       for (int i = 0, j = 0; i &lt; nthreads; i++) {
1461         oop thread_obj = threads-&gt;obj_at(i);
1462         assert(thread_obj != NULL, &quot;thread_obj is NULL&quot;);
1463         JavaThread *java_thread = NULL;
1464         jvmtiError err = JvmtiExport::cv_oop_to_JavaThread(tlh.list(), thread_obj, &amp;java_thread);
1465         if (err == JVMTI_ERROR_NONE) {
1466           // Have a valid JavaThread*.
1467           if (java_thread-&gt;is_hidden_from_external_view()) {
1468             // Filter out hidden java threads.
1469             hidden_threads++;
1470             continue;
1471           }
1472         } else {
1473           // We couldn&#39;t convert thread_obj into a JavaThread*.
1474           if (err == JVMTI_ERROR_INVALID_THREAD) {
1475             // The thread_obj does not refer to a java.lang.Thread object
1476             // so skip it.
1477             hidden_threads++;
1478             continue;
1479           }
1480           // We have a valid thread_obj, but no JavaThread*; the caller
1481           // can still have limited use for the thread_obj.
1482         }
1483         thread_objs[j++] = Handle(current_thread, thread_obj);
1484       }
1485       nthreads -= hidden_threads;
1486     } // ThreadsListHandle is destroyed here.
1487 
1488     if (ngroups &gt; 0) {
1489       objArrayOop groups = java_lang_ThreadGroup::groups(group_hdl());
1490       assert(ngroups &lt;= groups-&gt;length(), &quot;too many groups&quot;);
1491       group_objs = NEW_RESOURCE_ARRAY(Handle,ngroups);
1492       for (int i = 0; i &lt; ngroups; i++) {
1493         oop group_obj = groups-&gt;obj_at(i);
1494         assert(group_obj != NULL, &quot;group_obj != NULL&quot;);
1495         group_objs[i] = Handle(current_thread, group_obj);
1496       }
1497     }
1498   } // ThreadGroup unlocked here
1499 
1500   *group_count_ptr  = ngroups;
1501   *thread_count_ptr = nthreads;
1502   *threads_ptr     = new_jthreadArray(nthreads, thread_objs);
1503   *groups_ptr      = new_jthreadGroupArray(ngroups, group_objs);
1504   if ((nthreads &gt; 0) &amp;&amp; (*threads_ptr == NULL)) {
1505     return JVMTI_ERROR_OUT_OF_MEMORY;
1506   }
1507   if ((ngroups &gt; 0) &amp;&amp; (*groups_ptr == NULL)) {
1508     return JVMTI_ERROR_OUT_OF_MEMORY;
1509   }
1510 
1511   return JVMTI_ERROR_NONE;
1512 } /* end GetThreadGroupChildren */
1513 
1514 
1515   //
1516   // Stack Frame functions
1517   //
1518 
1519 // Threads_lock NOT held, java_thread not protected by lock
1520 // java_thread - pre-checked
1521 // max_frame_count - pre-checked to be greater than or equal to 0
1522 // frame_buffer - pre-checked for NULL
1523 // count_ptr - pre-checked for NULL
1524 jvmtiError
1525 JvmtiEnv::GetStackTrace(JavaThread* java_thread, jint start_depth, jint max_frame_count, jvmtiFrameInfo* frame_buffer, jint* count_ptr) {
1526   jvmtiError err = JVMTI_ERROR_NONE;
1527 
1528   // It is only safe to perform the direct operation on the current
1529   // thread. All other usage needs to use a vm-safepoint-op for safety.
1530   if (java_thread == JavaThread::current()) {
1531     err = get_stack_trace(java_thread, start_depth, max_frame_count, frame_buffer, count_ptr);
1532   } else {
1533     // JVMTI get stack trace at safepoint. Do not require target thread to
1534     // be suspended.
1535     VM_GetStackTrace op(this, java_thread, start_depth, max_frame_count, frame_buffer, count_ptr);
1536     VMThread::execute(&amp;op);
1537     err = op.result();
1538   }
1539 
1540   return err;
1541 } /* end GetStackTrace */
1542 
1543 
1544 // max_frame_count - pre-checked to be greater than or equal to 0
1545 // stack_info_ptr - pre-checked for NULL
1546 // thread_count_ptr - pre-checked for NULL
1547 jvmtiError
1548 JvmtiEnv::GetAllStackTraces(jint max_frame_count, jvmtiStackInfo** stack_info_ptr, jint* thread_count_ptr) {
1549   jvmtiError err = JVMTI_ERROR_NONE;
1550   JavaThread* calling_thread = JavaThread::current();
1551 
1552   // JVMTI get stack traces at safepoint.
1553   VM_GetAllStackTraces op(this, calling_thread, max_frame_count);
1554   VMThread::execute(&amp;op);
1555   *thread_count_ptr = op.final_thread_count();
1556   *stack_info_ptr = op.stack_info();
1557   err = op.result();
1558   return err;
1559 } /* end GetAllStackTraces */
1560 
1561 
1562 // thread_count - pre-checked to be greater than or equal to 0
1563 // thread_list - pre-checked for NULL
1564 // max_frame_count - pre-checked to be greater than or equal to 0
1565 // stack_info_ptr - pre-checked for NULL
1566 jvmtiError
1567 JvmtiEnv::GetThreadListStackTraces(jint thread_count, const jthread* thread_list, jint max_frame_count, jvmtiStackInfo** stack_info_ptr) {
1568   jvmtiError err = JVMTI_ERROR_NONE;
1569   // JVMTI get stack traces at safepoint.
1570   VM_GetThreadListStackTraces op(this, thread_count, thread_list, max_frame_count);
1571   VMThread::execute(&amp;op);
1572   err = op.result();
1573   if (err == JVMTI_ERROR_NONE) {
1574     *stack_info_ptr = op.stack_info();
1575   }
1576   return err;
1577 } /* end GetThreadListStackTraces */
1578 
1579 
1580 // Threads_lock NOT held, java_thread not protected by lock
1581 // java_thread - pre-checked
1582 // count_ptr - pre-checked for NULL
1583 jvmtiError
1584 JvmtiEnv::GetFrameCount(JavaThread* java_thread, jint* count_ptr) {
1585   jvmtiError err = JVMTI_ERROR_NONE;
1586 
1587   // retrieve or create JvmtiThreadState.
1588   JvmtiThreadState* state = JvmtiThreadState::state_for(java_thread);
1589   if (state == NULL) {
1590     return JVMTI_ERROR_THREAD_NOT_ALIVE;
1591   }
1592 
1593   // It is only safe to perform the direct operation on the current
1594   // thread. All other usage needs to use a vm-safepoint-op for safety.
1595   if (java_thread == JavaThread::current()) {
1596     err = get_frame_count(state, count_ptr);
1597   } else {
1598     // get java stack frame count at safepoint.
1599     VM_GetFrameCount op(this, state, count_ptr);
1600     VMThread::execute(&amp;op);
1601     err = op.result();
1602   }
1603   return err;
1604 } /* end GetFrameCount */
1605 
1606 
1607 // Threads_lock NOT held, java_thread not protected by lock
1608 // java_thread - pre-checked
1609 jvmtiError
1610 JvmtiEnv::PopFrame(JavaThread* java_thread) {
1611   JavaThread* current_thread  = JavaThread::current();
1612   HandleMark hm(current_thread);
1613   uint32_t debug_bits = 0;
1614 
1615   // retrieve or create the state
1616   JvmtiThreadState* state = JvmtiThreadState::state_for(java_thread);
1617   if (state == NULL) {
1618     return JVMTI_ERROR_THREAD_NOT_ALIVE;
1619   }
1620 
1621   // Check if java_thread is fully suspended
1622   if (!java_thread-&gt;is_thread_fully_suspended(true /* wait for suspend completion */, &amp;debug_bits)) {
1623     return JVMTI_ERROR_THREAD_NOT_SUSPENDED;
1624   }
1625   // Check to see if a PopFrame was already in progress
1626   if (java_thread-&gt;popframe_condition() != JavaThread::popframe_inactive) {
1627     // Probably possible for JVMTI clients to trigger this, but the
1628     // JPDA backend shouldn&#39;t allow this to happen
1629     return JVMTI_ERROR_INTERNAL;
1630   }
1631 
1632   {
1633     // Was workaround bug
1634     //    4812902: popFrame hangs if the method is waiting at a synchronize
1635     // Catch this condition and return an error to avoid hanging.
1636     // Now JVMTI spec allows an implementation to bail out with an opaque frame error.
1637     OSThread* osThread = java_thread-&gt;osthread();
1638     if (osThread-&gt;get_state() == MONITOR_WAIT) {
1639       return JVMTI_ERROR_OPAQUE_FRAME;
1640     }
1641   }
1642 
1643   {
1644     ResourceMark rm(current_thread);
1645     // Check if there are more than one Java frame in this thread, that the top two frames
1646     // are Java (not native) frames, and that there is no intervening VM frame
1647     int frame_count = 0;
1648     bool is_interpreted[2];
1649     intptr_t *frame_sp[2];
1650     // The 2-nd arg of constructor is needed to stop iterating at java entry frame.
1651     for (vframeStream vfs(java_thread, true); !vfs.at_end(); vfs.next()) {
1652       methodHandle mh(current_thread, vfs.method());
1653       if (mh-&gt;is_native()) return(JVMTI_ERROR_OPAQUE_FRAME);
1654       is_interpreted[frame_count] = vfs.is_interpreted_frame();
1655       frame_sp[frame_count] = vfs.frame_id();
1656       if (++frame_count &gt; 1) break;
1657     }
1658     if (frame_count &lt; 2)  {
1659       // We haven&#39;t found two adjacent non-native Java frames on the top.
1660       // There can be two situations here:
1661       //  1. There are no more java frames
1662       //  2. Two top java frames are separated by non-java native frames
1663       if(vframeFor(java_thread, 1) == NULL) {
1664         return JVMTI_ERROR_NO_MORE_FRAMES;
1665       } else {
1666         // Intervening non-java native or VM frames separate java frames.
1667         // Current implementation does not support this. See bug #5031735.
1668         // In theory it is possible to pop frames in such cases.
1669         return JVMTI_ERROR_OPAQUE_FRAME;
1670       }
1671     }
1672 
1673     // If any of the top 2 frames is a compiled one, need to deoptimize it
1674     for (int i = 0; i &lt; 2; i++) {
1675       if (!is_interpreted[i]) {
1676         Deoptimization::deoptimize_frame(java_thread, frame_sp[i]);
1677       }
1678     }
1679 
1680     // Update the thread state to reflect that the top frame is popped
1681     // so that cur_stack_depth is maintained properly and all frameIDs
1682     // are invalidated.
1683     // The current frame will be popped later when the suspended thread
1684     // is resumed and right before returning from VM to Java.
1685     // (see call_VM_base() in assembler_&lt;cpu&gt;.cpp).
1686 
1687     // It&#39;s fine to update the thread state here because no JVMTI events
1688     // shall be posted for this PopFrame.
1689 
1690     // It is only safe to perform the direct operation on the current
1691     // thread. All other usage needs to use a vm-safepoint-op for safety.
1692     if (java_thread == JavaThread::current()) {
1693       state-&gt;update_for_pop_top_frame();
1694     } else {
1695       VM_UpdateForPopTopFrame op(state);
1696       VMThread::execute(&amp;op);
1697       jvmtiError err = op.result();
1698       if (err != JVMTI_ERROR_NONE) {
1699         return err;
1700       }
1701     }
1702 
1703     java_thread-&gt;set_popframe_condition(JavaThread::popframe_pending_bit);
1704     // Set pending step flag for this popframe and it is cleared when next
1705     // step event is posted.
1706     state-&gt;set_pending_step_for_popframe();
1707   }
1708 
1709   return JVMTI_ERROR_NONE;
1710 } /* end PopFrame */
1711 
1712 
1713 // Threads_lock NOT held, java_thread not protected by lock
1714 // java_thread - pre-checked
1715 // java_thread - unchecked
1716 // depth - pre-checked as non-negative
1717 // method_ptr - pre-checked for NULL
1718 // location_ptr - pre-checked for NULL
1719 jvmtiError
1720 JvmtiEnv::GetFrameLocation(JavaThread* java_thread, jint depth, jmethodID* method_ptr, jlocation* location_ptr) {
1721   jvmtiError err = JVMTI_ERROR_NONE;
1722 
1723   // It is only safe to perform the direct operation on the current
1724   // thread. All other usage needs to use a vm-safepoint-op for safety.
1725   if (java_thread == JavaThread::current()) {
1726     err = get_frame_location(java_thread, depth, method_ptr, location_ptr);
1727   } else {
1728     // JVMTI get java stack frame location at safepoint.
1729     VM_GetFrameLocation op(this, java_thread, depth, method_ptr, location_ptr);
1730     VMThread::execute(&amp;op);
1731     err = op.result();
1732   }
1733   return err;
1734 } /* end GetFrameLocation */
1735 
1736 
1737 // Threads_lock NOT held, java_thread not protected by lock
1738 // java_thread - pre-checked
1739 // java_thread - unchecked
1740 // depth - pre-checked as non-negative
1741 jvmtiError
1742 JvmtiEnv::NotifyFramePop(JavaThread* java_thread, jint depth) {
1743   jvmtiError err = JVMTI_ERROR_NONE;
1744   ResourceMark rm;
1745   uint32_t debug_bits = 0;
1746 
1747   JvmtiThreadState *state = JvmtiThreadState::state_for(java_thread);
1748   if (state == NULL) {
1749     return JVMTI_ERROR_THREAD_NOT_ALIVE;
1750   }
1751 
1752   if (!java_thread-&gt;is_thread_fully_suspended(true, &amp;debug_bits)) {
1753     return JVMTI_ERROR_THREAD_NOT_SUSPENDED;
1754   }
1755 
1756   if (TraceJVMTICalls) {
1757     JvmtiSuspendControl::print();
1758   }
1759 
1760   vframe *vf = vframeFor(java_thread, depth);
1761   if (vf == NULL) {
1762     return JVMTI_ERROR_NO_MORE_FRAMES;
1763   }
1764 
1765   if (!vf-&gt;is_java_frame() || ((javaVFrame*) vf)-&gt;method()-&gt;is_native()) {
1766     return JVMTI_ERROR_OPAQUE_FRAME;
1767   }
1768 
1769   assert(vf-&gt;frame_pointer() != NULL, &quot;frame pointer mustn&#39;t be NULL&quot;);
1770 
1771   // It is only safe to perform the direct operation on the current
1772   // thread. All other usage needs to use a vm-safepoint-op for safety.
1773   if (java_thread == JavaThread::current()) {
1774     int frame_number = state-&gt;count_frames() - depth;
1775     state-&gt;env_thread_state(this)-&gt;set_frame_pop(frame_number);
1776   } else {
1777     VM_SetFramePop op(this, state, depth);
1778     VMThread::execute(&amp;op);
1779     err = op.result();
1780   }
1781   return err;
1782 } /* end NotifyFramePop */
1783 
1784 
1785   //
1786   // Force Early Return functions
1787   //
1788 
1789 // Threads_lock NOT held, java_thread not protected by lock
1790 // java_thread - pre-checked
1791 jvmtiError
1792 JvmtiEnv::ForceEarlyReturnObject(JavaThread* java_thread, jobject value) {
1793   jvalue val;
1794   val.l = value;
1795   return force_early_return(java_thread, val, atos);
1796 } /* end ForceEarlyReturnObject */
1797 
1798 
1799 // Threads_lock NOT held, java_thread not protected by lock
1800 // java_thread - pre-checked
1801 jvmtiError
1802 JvmtiEnv::ForceEarlyReturnInt(JavaThread* java_thread, jint value) {
1803   jvalue val;
1804   val.i = value;
1805   return force_early_return(java_thread, val, itos);
1806 } /* end ForceEarlyReturnInt */
1807 
1808 
1809 // Threads_lock NOT held, java_thread not protected by lock
1810 // java_thread - pre-checked
1811 jvmtiError
1812 JvmtiEnv::ForceEarlyReturnLong(JavaThread* java_thread, jlong value) {
1813   jvalue val;
1814   val.j = value;
1815   return force_early_return(java_thread, val, ltos);
1816 } /* end ForceEarlyReturnLong */
1817 
1818 
1819 // Threads_lock NOT held, java_thread not protected by lock
1820 // java_thread - pre-checked
1821 jvmtiError
1822 JvmtiEnv::ForceEarlyReturnFloat(JavaThread* java_thread, jfloat value) {
1823   jvalue val;
1824   val.f = value;
1825   return force_early_return(java_thread, val, ftos);
1826 } /* end ForceEarlyReturnFloat */
1827 
1828 
1829 // Threads_lock NOT held, java_thread not protected by lock
1830 // java_thread - pre-checked
1831 jvmtiError
1832 JvmtiEnv::ForceEarlyReturnDouble(JavaThread* java_thread, jdouble value) {
1833   jvalue val;
1834   val.d = value;
1835   return force_early_return(java_thread, val, dtos);
1836 } /* end ForceEarlyReturnDouble */
1837 
1838 
1839 // Threads_lock NOT held, java_thread not protected by lock
1840 // java_thread - pre-checked
1841 jvmtiError
1842 JvmtiEnv::ForceEarlyReturnVoid(JavaThread* java_thread) {
1843   jvalue val;
1844   val.j = 0L;
1845   return force_early_return(java_thread, val, vtos);
1846 } /* end ForceEarlyReturnVoid */
1847 
1848 
1849   //
1850   // Heap functions
1851   //
1852 
1853 // klass - NULL is a valid value, must be checked
1854 // initial_object - NULL is a valid value, must be checked
1855 // callbacks - pre-checked for NULL
1856 // user_data - NULL is a valid value, must be checked
1857 jvmtiError
1858 JvmtiEnv::FollowReferences(jint heap_filter, jclass klass, jobject initial_object, const jvmtiHeapCallbacks* callbacks, const void* user_data) {
1859   // check klass if provided
1860   Klass* k = NULL;
1861   if (klass != NULL) {
1862     oop k_mirror = JNIHandles::resolve_external_guard(klass);
1863     if (k_mirror == NULL) {
1864       return JVMTI_ERROR_INVALID_CLASS;
1865     }
1866     if (java_lang_Class::is_primitive(k_mirror)) {
1867       return JVMTI_ERROR_NONE;
1868     }
1869     k = java_lang_Class::as_Klass(k_mirror);
1870     if (klass == NULL) {
1871       return JVMTI_ERROR_INVALID_CLASS;
1872     }
1873   }
1874 
1875   if (initial_object != NULL) {
1876     oop init_obj = JNIHandles::resolve_external_guard(initial_object);
1877     if (init_obj == NULL) {
1878       return JVMTI_ERROR_INVALID_OBJECT;
1879     }
1880   }
1881 
1882   Thread *thread = Thread::current();
1883   HandleMark hm(thread);
1884 
1885   TraceTime t(&quot;FollowReferences&quot;, TRACETIME_LOG(Debug, jvmti, objecttagging));
1886   JvmtiTagMap::tag_map_for(this)-&gt;follow_references(heap_filter, k, initial_object, callbacks, user_data);
1887   return JVMTI_ERROR_NONE;
1888 } /* end FollowReferences */
1889 
1890 
1891 // klass - NULL is a valid value, must be checked
1892 // callbacks - pre-checked for NULL
1893 // user_data - NULL is a valid value, must be checked
1894 jvmtiError
1895 JvmtiEnv::IterateThroughHeap(jint heap_filter, jclass klass, const jvmtiHeapCallbacks* callbacks, const void* user_data) {
1896   // check klass if provided
1897   Klass* k = NULL;
1898   if (klass != NULL) {
1899     oop k_mirror = JNIHandles::resolve_external_guard(klass);
1900     if (k_mirror == NULL) {
1901       return JVMTI_ERROR_INVALID_CLASS;
1902     }
1903     if (java_lang_Class::is_primitive(k_mirror)) {
1904       return JVMTI_ERROR_NONE;
1905     }
1906     k = java_lang_Class::as_Klass(k_mirror);
1907     if (k == NULL) {
1908       return JVMTI_ERROR_INVALID_CLASS;
1909     }
1910   }
1911 
1912   TraceTime t(&quot;IterateThroughHeap&quot;, TRACETIME_LOG(Debug, jvmti, objecttagging));
1913   JvmtiTagMap::tag_map_for(this)-&gt;iterate_through_heap(heap_filter, k, callbacks, user_data);
1914   return JVMTI_ERROR_NONE;
1915 } /* end IterateThroughHeap */
1916 
1917 
1918 // tag_ptr - pre-checked for NULL
1919 jvmtiError
1920 JvmtiEnv::GetTag(jobject object, jlong* tag_ptr) {
1921   oop o = JNIHandles::resolve_external_guard(object);
1922   NULL_CHECK(o, JVMTI_ERROR_INVALID_OBJECT);
1923   *tag_ptr = JvmtiTagMap::tag_map_for(this)-&gt;get_tag(object);
1924   return JVMTI_ERROR_NONE;
1925 } /* end GetTag */
1926 
1927 
1928 jvmtiError
1929 JvmtiEnv::SetTag(jobject object, jlong tag) {
1930   oop o = JNIHandles::resolve_external_guard(object);
1931   NULL_CHECK(o, JVMTI_ERROR_INVALID_OBJECT);
1932   JvmtiTagMap::tag_map_for(this)-&gt;set_tag(object, tag);
1933   return JVMTI_ERROR_NONE;
1934 } /* end SetTag */
1935 
1936 
1937 // tag_count - pre-checked to be greater than or equal to 0
1938 // tags - pre-checked for NULL
1939 // count_ptr - pre-checked for NULL
1940 // object_result_ptr - NULL is a valid value, must be checked
1941 // tag_result_ptr - NULL is a valid value, must be checked
1942 jvmtiError
1943 JvmtiEnv::GetObjectsWithTags(jint tag_count, const jlong* tags, jint* count_ptr, jobject** object_result_ptr, jlong** tag_result_ptr) {
1944   TraceTime t(&quot;GetObjectsWithTags&quot;, TRACETIME_LOG(Debug, jvmti, objecttagging));
1945   return JvmtiTagMap::tag_map_for(this)-&gt;get_objects_with_tags((jlong*)tags, tag_count, count_ptr, object_result_ptr, tag_result_ptr);
1946 } /* end GetObjectsWithTags */
1947 
1948 
1949 jvmtiError
1950 JvmtiEnv::ForceGarbageCollection() {
1951   Universe::heap()-&gt;collect(GCCause::_jvmti_force_gc);
1952   return JVMTI_ERROR_NONE;
1953 } /* end ForceGarbageCollection */
1954 
1955 
1956   //
1957   // Heap (1.0) functions
1958   //
1959 
1960 // object_reference_callback - pre-checked for NULL
1961 // user_data - NULL is a valid value, must be checked
1962 jvmtiError
1963 JvmtiEnv::IterateOverObjectsReachableFromObject(jobject object, jvmtiObjectReferenceCallback object_reference_callback, const void* user_data) {
1964   oop o = JNIHandles::resolve_external_guard(object);
1965   NULL_CHECK(o, JVMTI_ERROR_INVALID_OBJECT);
1966   JvmtiTagMap::tag_map_for(this)-&gt;iterate_over_objects_reachable_from_object(object, object_reference_callback, user_data);
1967   return JVMTI_ERROR_NONE;
1968 } /* end IterateOverObjectsReachableFromObject */
1969 
1970 
1971 // heap_root_callback - NULL is a valid value, must be checked
1972 // stack_ref_callback - NULL is a valid value, must be checked
1973 // object_ref_callback - NULL is a valid value, must be checked
1974 // user_data - NULL is a valid value, must be checked
1975 jvmtiError
1976 JvmtiEnv::IterateOverReachableObjects(jvmtiHeapRootCallback heap_root_callback, jvmtiStackReferenceCallback stack_ref_callback, jvmtiObjectReferenceCallback object_ref_callback, const void* user_data) {
1977   TraceTime t(&quot;IterateOverReachableObjects&quot;, TRACETIME_LOG(Debug, jvmti, objecttagging));
1978   JvmtiTagMap::tag_map_for(this)-&gt;iterate_over_reachable_objects(heap_root_callback, stack_ref_callback, object_ref_callback, user_data);
1979   return JVMTI_ERROR_NONE;
1980 } /* end IterateOverReachableObjects */
1981 
1982 
1983 // heap_object_callback - pre-checked for NULL
1984 // user_data - NULL is a valid value, must be checked
1985 jvmtiError
1986 JvmtiEnv::IterateOverHeap(jvmtiHeapObjectFilter object_filter, jvmtiHeapObjectCallback heap_object_callback, const void* user_data) {
1987   TraceTime t(&quot;IterateOverHeap&quot;, TRACETIME_LOG(Debug, jvmti, objecttagging));
1988   Thread *thread = Thread::current();
1989   HandleMark hm(thread);
1990   JvmtiTagMap::tag_map_for(this)-&gt;iterate_over_heap(object_filter, NULL, heap_object_callback, user_data);
1991   return JVMTI_ERROR_NONE;
1992 } /* end IterateOverHeap */
1993 
1994 
1995 // k_mirror - may be primitive, this must be checked
1996 // heap_object_callback - pre-checked for NULL
1997 // user_data - NULL is a valid value, must be checked
1998 jvmtiError
1999 JvmtiEnv::IterateOverInstancesOfClass(oop k_mirror, jvmtiHeapObjectFilter object_filter, jvmtiHeapObjectCallback heap_object_callback, const void* user_data) {
2000   if (java_lang_Class::is_primitive(k_mirror)) {
2001     // DO PRIMITIVE CLASS PROCESSING
2002     return JVMTI_ERROR_NONE;
2003   }
2004   Klass* klass = java_lang_Class::as_Klass(k_mirror);
2005   if (klass == NULL) {
2006     return JVMTI_ERROR_INVALID_CLASS;
2007   }
2008   TraceTime t(&quot;IterateOverInstancesOfClass&quot;, TRACETIME_LOG(Debug, jvmti, objecttagging));
2009   JvmtiTagMap::tag_map_for(this)-&gt;iterate_over_heap(object_filter, klass, heap_object_callback, user_data);
2010   return JVMTI_ERROR_NONE;
2011 } /* end IterateOverInstancesOfClass */
2012 
2013 
2014   //
2015   // Local Variable functions
2016   //
2017 
2018 // Threads_lock NOT held, java_thread not protected by lock
2019 // java_thread - pre-checked
2020 // java_thread - unchecked
2021 // depth - pre-checked as non-negative
2022 // value_ptr - pre-checked for NULL
2023 jvmtiError
2024 JvmtiEnv::GetLocalObject(JavaThread* java_thread, jint depth, jint slot, jobject* value_ptr) {
2025   JavaThread* current_thread = JavaThread::current();
2026   // rm object is created to clean up the javaVFrame created in
2027   // doit_prologue(), but after doit() is finished with it.
2028   ResourceMark rm(current_thread);
2029 
2030   VM_GetOrSetLocal op(java_thread, current_thread, depth, slot);
2031   VMThread::execute(&amp;op);
2032   jvmtiError err = op.result();
2033   if (err != JVMTI_ERROR_NONE) {
2034     return err;
2035   } else {
2036     *value_ptr = op.value().l;
2037     return JVMTI_ERROR_NONE;
2038   }
2039 } /* end GetLocalObject */
2040 
2041 // Threads_lock NOT held, java_thread not protected by lock
2042 // java_thread - pre-checked
2043 // java_thread - unchecked
2044 // depth - pre-checked as non-negative
2045 // value - pre-checked for NULL
2046 jvmtiError
2047 JvmtiEnv::GetLocalInstance(JavaThread* java_thread, jint depth, jobject* value_ptr){
2048   JavaThread* current_thread = JavaThread::current();
2049   // rm object is created to clean up the javaVFrame created in
2050   // doit_prologue(), but after doit() is finished with it.
2051   ResourceMark rm(current_thread);
2052 
2053   VM_GetReceiver op(java_thread, current_thread, depth);
2054   VMThread::execute(&amp;op);
2055   jvmtiError err = op.result();
2056   if (err != JVMTI_ERROR_NONE) {
2057     return err;
2058   } else {
2059     *value_ptr = op.value().l;
2060     return JVMTI_ERROR_NONE;
2061   }
2062 } /* end GetLocalInstance */
2063 
2064 
2065 // Threads_lock NOT held, java_thread not protected by lock
2066 // java_thread - pre-checked
2067 // java_thread - unchecked
2068 // depth - pre-checked as non-negative
2069 // value_ptr - pre-checked for NULL
2070 jvmtiError
2071 JvmtiEnv::GetLocalInt(JavaThread* java_thread, jint depth, jint slot, jint* value_ptr) {
2072   // rm object is created to clean up the javaVFrame created in
2073   // doit_prologue(), but after doit() is finished with it.
2074   ResourceMark rm;
2075 
2076   VM_GetOrSetLocal op(java_thread, depth, slot, T_INT);
2077   VMThread::execute(&amp;op);
2078   *value_ptr = op.value().i;
2079   return op.result();
2080 } /* end GetLocalInt */
2081 
2082 
2083 // Threads_lock NOT held, java_thread not protected by lock
2084 // java_thread - pre-checked
2085 // java_thread - unchecked
2086 // depth - pre-checked as non-negative
2087 // value_ptr - pre-checked for NULL
2088 jvmtiError
2089 JvmtiEnv::GetLocalLong(JavaThread* java_thread, jint depth, jint slot, jlong* value_ptr) {
2090   // rm object is created to clean up the javaVFrame created in
2091   // doit_prologue(), but after doit() is finished with it.
2092   ResourceMark rm;
2093 
2094   VM_GetOrSetLocal op(java_thread, depth, slot, T_LONG);
2095   VMThread::execute(&amp;op);
2096   *value_ptr = op.value().j;
2097   return op.result();
2098 } /* end GetLocalLong */
2099 
2100 
2101 // Threads_lock NOT held, java_thread not protected by lock
2102 // java_thread - pre-checked
2103 // java_thread - unchecked
2104 // depth - pre-checked as non-negative
2105 // value_ptr - pre-checked for NULL
2106 jvmtiError
2107 JvmtiEnv::GetLocalFloat(JavaThread* java_thread, jint depth, jint slot, jfloat* value_ptr) {
2108   // rm object is created to clean up the javaVFrame created in
2109   // doit_prologue(), but after doit() is finished with it.
2110   ResourceMark rm;
2111 
2112   VM_GetOrSetLocal op(java_thread, depth, slot, T_FLOAT);
2113   VMThread::execute(&amp;op);
2114   *value_ptr = op.value().f;
2115   return op.result();
2116 } /* end GetLocalFloat */
2117 
2118 
2119 // Threads_lock NOT held, java_thread not protected by lock
2120 // java_thread - pre-checked
2121 // java_thread - unchecked
2122 // depth - pre-checked as non-negative
2123 // value_ptr - pre-checked for NULL
2124 jvmtiError
2125 JvmtiEnv::GetLocalDouble(JavaThread* java_thread, jint depth, jint slot, jdouble* value_ptr) {
2126   // rm object is created to clean up the javaVFrame created in
2127   // doit_prologue(), but after doit() is finished with it.
2128   ResourceMark rm;
2129 
2130   VM_GetOrSetLocal op(java_thread, depth, slot, T_DOUBLE);
2131   VMThread::execute(&amp;op);
2132   *value_ptr = op.value().d;
2133   return op.result();
2134 } /* end GetLocalDouble */
2135 
2136 
2137 // Threads_lock NOT held, java_thread not protected by lock
2138 // java_thread - pre-checked
2139 // java_thread - unchecked
2140 // depth - pre-checked as non-negative
2141 jvmtiError
2142 JvmtiEnv::SetLocalObject(JavaThread* java_thread, jint depth, jint slot, jobject value) {
2143   // rm object is created to clean up the javaVFrame created in
2144   // doit_prologue(), but after doit() is finished with it.
2145   ResourceMark rm;
2146   jvalue val;
2147   val.l = value;
2148   VM_GetOrSetLocal op(java_thread, depth, slot, T_OBJECT, val);
2149   VMThread::execute(&amp;op);
2150   return op.result();
2151 } /* end SetLocalObject */
2152 
2153 
2154 // Threads_lock NOT held, java_thread not protected by lock
2155 // java_thread - pre-checked
2156 // java_thread - unchecked
2157 // depth - pre-checked as non-negative
2158 jvmtiError
2159 JvmtiEnv::SetLocalInt(JavaThread* java_thread, jint depth, jint slot, jint value) {
2160   // rm object is created to clean up the javaVFrame created in
2161   // doit_prologue(), but after doit() is finished with it.
2162   ResourceMark rm;
2163   jvalue val;
2164   val.i = value;
2165   VM_GetOrSetLocal op(java_thread, depth, slot, T_INT, val);
2166   VMThread::execute(&amp;op);
2167   return op.result();
2168 } /* end SetLocalInt */
2169 
2170 
2171 // Threads_lock NOT held, java_thread not protected by lock
2172 // java_thread - pre-checked
2173 // java_thread - unchecked
2174 // depth - pre-checked as non-negative
2175 jvmtiError
2176 JvmtiEnv::SetLocalLong(JavaThread* java_thread, jint depth, jint slot, jlong value) {
2177   // rm object is created to clean up the javaVFrame created in
2178   // doit_prologue(), but after doit() is finished with it.
2179   ResourceMark rm;
2180   jvalue val;
2181   val.j = value;
2182   VM_GetOrSetLocal op(java_thread, depth, slot, T_LONG, val);
2183   VMThread::execute(&amp;op);
2184   return op.result();
2185 } /* end SetLocalLong */
2186 
2187 
2188 // Threads_lock NOT held, java_thread not protected by lock
2189 // java_thread - pre-checked
2190 // java_thread - unchecked
2191 // depth - pre-checked as non-negative
2192 jvmtiError
2193 JvmtiEnv::SetLocalFloat(JavaThread* java_thread, jint depth, jint slot, jfloat value) {
2194   // rm object is created to clean up the javaVFrame created in
2195   // doit_prologue(), but after doit() is finished with it.
2196   ResourceMark rm;
2197   jvalue val;
2198   val.f = value;
2199   VM_GetOrSetLocal op(java_thread, depth, slot, T_FLOAT, val);
2200   VMThread::execute(&amp;op);
2201   return op.result();
2202 } /* end SetLocalFloat */
2203 
2204 
2205 // Threads_lock NOT held, java_thread not protected by lock
2206 // java_thread - pre-checked
2207 // java_thread - unchecked
2208 // depth - pre-checked as non-negative
2209 jvmtiError
2210 JvmtiEnv::SetLocalDouble(JavaThread* java_thread, jint depth, jint slot, jdouble value) {
2211   // rm object is created to clean up the javaVFrame created in
2212   // doit_prologue(), but after doit() is finished with it.
2213   ResourceMark rm;
2214   jvalue val;
2215   val.d = value;
2216   VM_GetOrSetLocal op(java_thread, depth, slot, T_DOUBLE, val);
2217   VMThread::execute(&amp;op);
2218   return op.result();
2219 } /* end SetLocalDouble */
2220 
2221 
2222   //
2223   // Breakpoint functions
2224   //
2225 
2226 // method_oop - pre-checked for validity, but may be NULL meaning obsolete method
2227 jvmtiError
2228 JvmtiEnv::SetBreakpoint(Method* method_oop, jlocation location) {
2229   NULL_CHECK(method_oop, JVMTI_ERROR_INVALID_METHODID);
2230   if (location &lt; 0) {   // simple invalid location check first
2231     return JVMTI_ERROR_INVALID_LOCATION;
2232   }
2233   // verify that the breakpoint is not past the end of the method
2234   if (location &gt;= (jlocation) method_oop-&gt;code_size()) {
2235     return JVMTI_ERROR_INVALID_LOCATION;
2236   }
2237 
2238   ResourceMark rm;
2239   JvmtiBreakpoint bp(method_oop, location);
2240   JvmtiBreakpoints&amp; jvmti_breakpoints = JvmtiCurrentBreakpoints::get_jvmti_breakpoints();
2241   if (jvmti_breakpoints.set(bp) == JVMTI_ERROR_DUPLICATE)
2242     return JVMTI_ERROR_DUPLICATE;
2243 
2244   if (TraceJVMTICalls) {
2245     jvmti_breakpoints.print();
2246   }
2247 
2248   return JVMTI_ERROR_NONE;
2249 } /* end SetBreakpoint */
2250 
2251 
2252 // method_oop - pre-checked for validity, but may be NULL meaning obsolete method
2253 jvmtiError
2254 JvmtiEnv::ClearBreakpoint(Method* method_oop, jlocation location) {
2255   NULL_CHECK(method_oop, JVMTI_ERROR_INVALID_METHODID);
2256 
2257   if (location &lt; 0) {   // simple invalid location check first
2258     return JVMTI_ERROR_INVALID_LOCATION;
2259   }
2260 
2261   // verify that the breakpoint is not past the end of the method
2262   if (location &gt;= (jlocation) method_oop-&gt;code_size()) {
2263     return JVMTI_ERROR_INVALID_LOCATION;
2264   }
2265 
2266   JvmtiBreakpoint bp(method_oop, location);
2267 
2268   JvmtiBreakpoints&amp; jvmti_breakpoints = JvmtiCurrentBreakpoints::get_jvmti_breakpoints();
2269   if (jvmti_breakpoints.clear(bp) == JVMTI_ERROR_NOT_FOUND)
2270     return JVMTI_ERROR_NOT_FOUND;
2271 
2272   if (TraceJVMTICalls) {
2273     jvmti_breakpoints.print();
2274   }
2275 
2276   return JVMTI_ERROR_NONE;
2277 } /* end ClearBreakpoint */
2278 
2279 
2280   //
2281   // Watched Field functions
2282   //
2283 
2284 jvmtiError
2285 JvmtiEnv::SetFieldAccessWatch(fieldDescriptor* fdesc_ptr) {
2286   // make sure we haven&#39;t set this watch before
2287   if (fdesc_ptr-&gt;is_field_access_watched()) return JVMTI_ERROR_DUPLICATE;
2288   fdesc_ptr-&gt;set_is_field_access_watched(true);
2289 
2290   JvmtiEventController::change_field_watch(JVMTI_EVENT_FIELD_ACCESS, true);
2291 
2292   return JVMTI_ERROR_NONE;
2293 } /* end SetFieldAccessWatch */
2294 
2295 
2296 jvmtiError
2297 JvmtiEnv::ClearFieldAccessWatch(fieldDescriptor* fdesc_ptr) {
2298   // make sure we have a watch to clear
2299   if (!fdesc_ptr-&gt;is_field_access_watched()) return JVMTI_ERROR_NOT_FOUND;
2300   fdesc_ptr-&gt;set_is_field_access_watched(false);
2301 
2302   JvmtiEventController::change_field_watch(JVMTI_EVENT_FIELD_ACCESS, false);
2303 
2304   return JVMTI_ERROR_NONE;
2305 } /* end ClearFieldAccessWatch */
2306 
2307 
2308 jvmtiError
2309 JvmtiEnv::SetFieldModificationWatch(fieldDescriptor* fdesc_ptr) {
2310   // make sure we haven&#39;t set this watch before
2311   if (fdesc_ptr-&gt;is_field_modification_watched()) return JVMTI_ERROR_DUPLICATE;
2312   fdesc_ptr-&gt;set_is_field_modification_watched(true);
2313 
2314   JvmtiEventController::change_field_watch(JVMTI_EVENT_FIELD_MODIFICATION, true);
2315 
2316   return JVMTI_ERROR_NONE;
2317 } /* end SetFieldModificationWatch */
2318 
2319 
2320 jvmtiError
2321 JvmtiEnv::ClearFieldModificationWatch(fieldDescriptor* fdesc_ptr) {
2322    // make sure we have a watch to clear
2323   if (!fdesc_ptr-&gt;is_field_modification_watched()) return JVMTI_ERROR_NOT_FOUND;
2324   fdesc_ptr-&gt;set_is_field_modification_watched(false);
2325 
2326   JvmtiEventController::change_field_watch(JVMTI_EVENT_FIELD_MODIFICATION, false);
2327 
2328   return JVMTI_ERROR_NONE;
2329 } /* end ClearFieldModificationWatch */
2330 
2331   //
2332   // Class functions
2333   //
2334 
2335 
2336 // k_mirror - may be primitive, this must be checked
2337 // signature_ptr - NULL is a valid value, must be checked
2338 // generic_ptr - NULL is a valid value, must be checked
2339 jvmtiError
2340 JvmtiEnv::GetClassSignature(oop k_mirror, char** signature_ptr, char** generic_ptr) {
2341   ResourceMark rm;
2342   bool isPrimitive = java_lang_Class::is_primitive(k_mirror);
2343   Klass* k = NULL;
2344   if (!isPrimitive) {
2345     k = java_lang_Class::as_Klass(k_mirror);
2346     NULL_CHECK(k, JVMTI_ERROR_INVALID_CLASS);
2347   }
2348   if (signature_ptr != NULL) {
2349     char* result = NULL;
2350     if (isPrimitive) {
2351       char tchar = type2char(java_lang_Class::primitive_type(k_mirror));
2352       result = (char*) jvmtiMalloc(2);
2353       result[0] = tchar;
2354       result[1] = &#39;\0&#39;;
2355     } else {
2356       const char* class_sig = k-&gt;signature_name();
2357       result = (char *) jvmtiMalloc(strlen(class_sig)+1);
2358       strcpy(result, class_sig);
2359     }
2360     *signature_ptr = result;
2361   }
2362   if (generic_ptr != NULL) {
2363     *generic_ptr = NULL;
2364     if (!isPrimitive &amp;&amp; k-&gt;is_instance_klass()) {
2365       Symbol* soo = InstanceKlass::cast(k)-&gt;generic_signature();
2366       if (soo != NULL) {
2367         const char *gen_sig = soo-&gt;as_C_string();
2368         if (gen_sig != NULL) {
2369           char* gen_result;
2370           jvmtiError err = allocate(strlen(gen_sig) + 1,
2371                                     (unsigned char **)&amp;gen_result);
2372           if (err != JVMTI_ERROR_NONE) {
2373             return err;
2374           }
2375           strcpy(gen_result, gen_sig);
2376           *generic_ptr = gen_result;
2377         }
2378       }
2379     }
2380   }
2381   return JVMTI_ERROR_NONE;
2382 } /* end GetClassSignature */
2383 
2384 
2385 // k_mirror - may be primitive, this must be checked
2386 // status_ptr - pre-checked for NULL
2387 jvmtiError
2388 JvmtiEnv::GetClassStatus(oop k_mirror, jint* status_ptr) {
2389   jint result = 0;
2390   if (java_lang_Class::is_primitive(k_mirror)) {
2391     result |= JVMTI_CLASS_STATUS_PRIMITIVE;
2392   } else {
2393     Klass* k = java_lang_Class::as_Klass(k_mirror);
2394     NULL_CHECK(k, JVMTI_ERROR_INVALID_CLASS);
2395     result = k-&gt;jvmti_class_status();
2396   }
2397   *status_ptr = result;
2398 
2399   return JVMTI_ERROR_NONE;
2400 } /* end GetClassStatus */
2401 
2402 
2403 // k_mirror - may be primitive, this must be checked
2404 // source_name_ptr - pre-checked for NULL
2405 jvmtiError
2406 JvmtiEnv::GetSourceFileName(oop k_mirror, char** source_name_ptr) {
2407   if (java_lang_Class::is_primitive(k_mirror)) {
2408      return JVMTI_ERROR_ABSENT_INFORMATION;
2409   }
2410   Klass* k_klass = java_lang_Class::as_Klass(k_mirror);
2411   NULL_CHECK(k_klass, JVMTI_ERROR_INVALID_CLASS);
2412 
2413   if (!k_klass-&gt;is_instance_klass()) {
2414     return JVMTI_ERROR_ABSENT_INFORMATION;
2415   }
2416 
2417   Symbol* sfnOop = InstanceKlass::cast(k_klass)-&gt;source_file_name();
2418   NULL_CHECK(sfnOop, JVMTI_ERROR_ABSENT_INFORMATION);
2419   {
2420     JavaThread* current_thread  = JavaThread::current();
2421     ResourceMark rm(current_thread);
2422     const char* sfncp = (const char*) sfnOop-&gt;as_C_string();
2423     *source_name_ptr = (char *) jvmtiMalloc(strlen(sfncp)+1);
2424     strcpy(*source_name_ptr, sfncp);
2425   }
2426 
2427   return JVMTI_ERROR_NONE;
2428 } /* end GetSourceFileName */
2429 
2430 
2431 // k_mirror - may be primitive, this must be checked
2432 // modifiers_ptr - pre-checked for NULL
2433 jvmtiError
2434 JvmtiEnv::GetClassModifiers(oop k_mirror, jint* modifiers_ptr) {
2435   JavaThread* current_thread  = JavaThread::current();
2436   jint result = 0;
2437   if (!java_lang_Class::is_primitive(k_mirror)) {
2438     Klass* k = java_lang_Class::as_Klass(k_mirror);
2439     NULL_CHECK(k, JVMTI_ERROR_INVALID_CLASS);
2440     result = k-&gt;compute_modifier_flags(current_thread);
2441     JavaThread* THREAD = current_thread; // pass to macros
2442     if (HAS_PENDING_EXCEPTION) {
2443       CLEAR_PENDING_EXCEPTION;
2444       return JVMTI_ERROR_INTERNAL;
2445     };
2446 
2447     // Reset the deleted  ACC_SUPER bit ( deleted in compute_modifier_flags()).
2448     if(k-&gt;is_super()) {
2449       result |= JVM_ACC_SUPER;
2450     }
2451   } else {
2452     result = (JVM_ACC_ABSTRACT | JVM_ACC_FINAL | JVM_ACC_PUBLIC);
2453   }
2454   *modifiers_ptr = result;
2455 
2456   return JVMTI_ERROR_NONE;
2457 } /* end GetClassModifiers */
2458 
2459 
2460 // k_mirror - may be primitive, this must be checked
2461 // method_count_ptr - pre-checked for NULL
2462 // methods_ptr - pre-checked for NULL
2463 jvmtiError
2464 JvmtiEnv::GetClassMethods(oop k_mirror, jint* method_count_ptr, jmethodID** methods_ptr) {
2465   JavaThread* current_thread  = JavaThread::current();
2466   HandleMark hm(current_thread);
2467 
2468   if (java_lang_Class::is_primitive(k_mirror)) {
2469     *method_count_ptr = 0;
2470     *methods_ptr = (jmethodID*) jvmtiMalloc(0 * sizeof(jmethodID));
2471     return JVMTI_ERROR_NONE;
2472   }
2473   Klass* k = java_lang_Class::as_Klass(k_mirror);
2474   NULL_CHECK(k, JVMTI_ERROR_INVALID_CLASS);
2475 
2476   // Return CLASS_NOT_PREPARED error as per JVMTI spec.
2477   if (!(k-&gt;jvmti_class_status() &amp; (JVMTI_CLASS_STATUS_PREPARED|JVMTI_CLASS_STATUS_ARRAY) )) {
2478     return JVMTI_ERROR_CLASS_NOT_PREPARED;
2479   }
2480 
2481   if (!k-&gt;is_instance_klass()) {
2482     *method_count_ptr = 0;
2483     *methods_ptr = (jmethodID*) jvmtiMalloc(0 * sizeof(jmethodID));
2484     return JVMTI_ERROR_NONE;
2485   }
2486   InstanceKlass* ik = InstanceKlass::cast(k);
2487   // Allocate the result and fill it in
2488   int result_length = ik-&gt;methods()-&gt;length();
2489   jmethodID* result_list = (jmethodID*)jvmtiMalloc(result_length * sizeof(jmethodID));
2490   int index;
2491   bool jmethodids_found = true;
2492 
2493   if (JvmtiExport::can_maintain_original_method_order()) {
2494     // Use the original method ordering indices stored in the class, so we can emit
2495     // jmethodIDs in the order they appeared in the class file
2496     for (index = 0; index &lt; result_length; index++) {
2497       Method* m = ik-&gt;methods()-&gt;at(index);
2498       int original_index = ik-&gt;method_ordering()-&gt;at(index);
2499       assert(original_index &gt;= 0 &amp;&amp; original_index &lt; result_length, &quot;invalid original method index&quot;);
2500       jmethodID id;
2501       if (jmethodids_found) {
2502         id = m-&gt;find_jmethod_id_or_null();
2503         if (id == NULL) {
2504           // If we find an uninitialized value, make sure there is
2505           // enough space for all the uninitialized values we might
2506           // find.
2507           ik-&gt;ensure_space_for_methodids(index);
2508           jmethodids_found = false;
2509           id = m-&gt;jmethod_id();
2510         }
2511       } else {
2512         id = m-&gt;jmethod_id();
2513       }
2514       result_list[original_index] = id;
2515     }
2516   } else {
2517     // otherwise just copy in any order
2518     for (index = 0; index &lt; result_length; index++) {
2519       Method* m = ik-&gt;methods()-&gt;at(index);
2520       jmethodID id;
2521       if (jmethodids_found) {
2522         id = m-&gt;find_jmethod_id_or_null();
2523         if (id == NULL) {
2524           // If we find an uninitialized value, make sure there is
2525           // enough space for all the uninitialized values we might
2526           // find.
2527           ik-&gt;ensure_space_for_methodids(index);
2528           jmethodids_found = false;
2529           id = m-&gt;jmethod_id();
2530         }
2531       } else {
2532         id = m-&gt;jmethod_id();
2533       }
2534       result_list[index] = id;
2535     }
2536   }
2537   // Fill in return value.
2538   *method_count_ptr = result_length;
2539   *methods_ptr = result_list;
2540 
2541   return JVMTI_ERROR_NONE;
2542 } /* end GetClassMethods */
2543 
2544 
2545 // k_mirror - may be primitive, this must be checked
2546 // field_count_ptr - pre-checked for NULL
2547 // fields_ptr - pre-checked for NULL
2548 jvmtiError
2549 JvmtiEnv::GetClassFields(oop k_mirror, jint* field_count_ptr, jfieldID** fields_ptr) {
2550   if (java_lang_Class::is_primitive(k_mirror)) {
2551     *field_count_ptr = 0;
2552     *fields_ptr = (jfieldID*) jvmtiMalloc(0 * sizeof(jfieldID));
2553     return JVMTI_ERROR_NONE;
2554   }
2555   JavaThread* current_thread = JavaThread::current();
2556   HandleMark hm(current_thread);
2557   Klass* k = java_lang_Class::as_Klass(k_mirror);
2558   NULL_CHECK(k, JVMTI_ERROR_INVALID_CLASS);
2559 
2560   // Return CLASS_NOT_PREPARED error as per JVMTI spec.
2561   if (!(k-&gt;jvmti_class_status() &amp; (JVMTI_CLASS_STATUS_PREPARED|JVMTI_CLASS_STATUS_ARRAY) )) {
2562     return JVMTI_ERROR_CLASS_NOT_PREPARED;
2563   }
2564 
2565   if (!k-&gt;is_instance_klass()) {
2566     *field_count_ptr = 0;
2567     *fields_ptr = (jfieldID*) jvmtiMalloc(0 * sizeof(jfieldID));
2568     return JVMTI_ERROR_NONE;
2569   }
2570 
2571 
2572   InstanceKlass* ik = InstanceKlass::cast(k);
2573 
2574   int result_count = 0;
2575   // First, count the fields.
2576   FilteredFieldStream flds(ik, true, true);
2577   result_count = flds.field_count();
2578 
2579   // Allocate the result and fill it in
2580   jfieldID* result_list = (jfieldID*) jvmtiMalloc(result_count * sizeof(jfieldID));
2581   // The JVMTI spec requires fields in the order they occur in the class file,
2582   // this is the reverse order of what FieldStream hands out.
2583   int id_index = (result_count - 1);
2584 
2585   for (FilteredFieldStream src_st(ik, true, true); !src_st.eos(); src_st.next()) {
2586     result_list[id_index--] = jfieldIDWorkaround::to_jfieldID(
2587                                             ik, src_st.offset(),
2588                                             src_st.access_flags().is_static());
2589   }
2590   assert(id_index == -1, &quot;just checking&quot;);
2591   // Fill in the results
2592   *field_count_ptr = result_count;
2593   *fields_ptr = result_list;
2594 
2595   return JVMTI_ERROR_NONE;
2596 } /* end GetClassFields */
2597 
2598 
2599 // k_mirror - may be primitive, this must be checked
2600 // interface_count_ptr - pre-checked for NULL
2601 // interfaces_ptr - pre-checked for NULL
2602 jvmtiError
2603 JvmtiEnv::GetImplementedInterfaces(oop k_mirror, jint* interface_count_ptr, jclass** interfaces_ptr) {
2604   {
2605     if (java_lang_Class::is_primitive(k_mirror)) {
2606       *interface_count_ptr = 0;
2607       *interfaces_ptr = (jclass*) jvmtiMalloc(0 * sizeof(jclass));
2608       return JVMTI_ERROR_NONE;
2609     }
2610     JavaThread* current_thread = JavaThread::current();
2611     HandleMark hm(current_thread);
2612     Klass* k = java_lang_Class::as_Klass(k_mirror);
2613     NULL_CHECK(k, JVMTI_ERROR_INVALID_CLASS);
2614 
2615     // Return CLASS_NOT_PREPARED error as per JVMTI spec.
2616     if (!(k-&gt;jvmti_class_status() &amp; (JVMTI_CLASS_STATUS_PREPARED|JVMTI_CLASS_STATUS_ARRAY) ))
2617       return JVMTI_ERROR_CLASS_NOT_PREPARED;
2618 
2619     if (!k-&gt;is_instance_klass()) {
2620       *interface_count_ptr = 0;
2621       *interfaces_ptr = (jclass*) jvmtiMalloc(0 * sizeof(jclass));
2622       return JVMTI_ERROR_NONE;
2623     }
2624 
2625     Array&lt;InstanceKlass*&gt;* interface_list = InstanceKlass::cast(k)-&gt;local_interfaces();
2626     const int result_length = (interface_list == NULL ? 0 : interface_list-&gt;length());
2627     jclass* result_list = (jclass*) jvmtiMalloc(result_length * sizeof(jclass));
2628     for (int i_index = 0; i_index &lt; result_length; i_index += 1) {
2629       InstanceKlass* klass_at = interface_list-&gt;at(i_index);
2630       assert(klass_at-&gt;is_klass(), &quot;interfaces must be Klass*s&quot;);
2631       assert(klass_at-&gt;is_interface(), &quot;interfaces must be interfaces&quot;);
2632       oop mirror_at = klass_at-&gt;java_mirror();
2633       Handle handle_at = Handle(current_thread, mirror_at);
2634       result_list[i_index] = (jclass) jni_reference(handle_at);
2635     }
2636     *interface_count_ptr = result_length;
2637     *interfaces_ptr = result_list;
2638   }
2639 
2640   return JVMTI_ERROR_NONE;
2641 } /* end GetImplementedInterfaces */
2642 
2643 
2644 // k_mirror - may be primitive, this must be checked
2645 // minor_version_ptr - pre-checked for NULL
2646 // major_version_ptr - pre-checked for NULL
2647 jvmtiError
2648 JvmtiEnv::GetClassVersionNumbers(oop k_mirror, jint* minor_version_ptr, jint* major_version_ptr) {
2649   if (java_lang_Class::is_primitive(k_mirror)) {
2650     return JVMTI_ERROR_ABSENT_INFORMATION;
2651   }
2652   Klass* klass = java_lang_Class::as_Klass(k_mirror);
2653 
2654   jint status = klass-&gt;jvmti_class_status();
2655   if (status &amp; (JVMTI_CLASS_STATUS_ERROR)) {
2656     return JVMTI_ERROR_INVALID_CLASS;
2657   }
2658   if (status &amp; (JVMTI_CLASS_STATUS_ARRAY)) {
2659     return JVMTI_ERROR_ABSENT_INFORMATION;
2660   }
2661 
2662   InstanceKlass* ik = InstanceKlass::cast(klass);
2663   *minor_version_ptr = ik-&gt;minor_version();
2664   *major_version_ptr = ik-&gt;major_version();
2665 
2666   return JVMTI_ERROR_NONE;
2667 } /* end GetClassVersionNumbers */
2668 
2669 
2670 // k_mirror - may be primitive, this must be checked
2671 // constant_pool_count_ptr - pre-checked for NULL
2672 // constant_pool_byte_count_ptr - pre-checked for NULL
2673 // constant_pool_bytes_ptr - pre-checked for NULL
2674 jvmtiError
2675 JvmtiEnv::GetConstantPool(oop k_mirror, jint* constant_pool_count_ptr, jint* constant_pool_byte_count_ptr, unsigned char** constant_pool_bytes_ptr) {
2676   if (java_lang_Class::is_primitive(k_mirror)) {
2677     return JVMTI_ERROR_ABSENT_INFORMATION;
2678   }
2679 
2680   Klass* klass = java_lang_Class::as_Klass(k_mirror);
2681   Thread *thread = Thread::current();
2682   ResourceMark rm(thread);
2683 
2684   jint status = klass-&gt;jvmti_class_status();
2685   if (status &amp; (JVMTI_CLASS_STATUS_ERROR)) {
2686     return JVMTI_ERROR_INVALID_CLASS;
2687   }
2688   if (status &amp; (JVMTI_CLASS_STATUS_ARRAY)) {
2689     return JVMTI_ERROR_ABSENT_INFORMATION;
2690   }
2691 
2692   InstanceKlass* ik = InstanceKlass::cast(klass);
2693   JvmtiConstantPoolReconstituter reconstituter(ik);
2694   if (reconstituter.get_error() != JVMTI_ERROR_NONE) {
2695     return reconstituter.get_error();
2696   }
2697 
2698   unsigned char *cpool_bytes;
2699   int cpool_size = reconstituter.cpool_size();
2700   if (reconstituter.get_error() != JVMTI_ERROR_NONE) {
2701     return reconstituter.get_error();
2702   }
2703   jvmtiError res = allocate(cpool_size, &amp;cpool_bytes);
2704   if (res != JVMTI_ERROR_NONE) {
2705     return res;
2706   }
2707   reconstituter.copy_cpool_bytes(cpool_bytes);
2708   if (reconstituter.get_error() != JVMTI_ERROR_NONE) {
2709     return reconstituter.get_error();
2710   }
2711 
2712   constantPoolHandle  constants(thread, ik-&gt;constants());
2713   *constant_pool_count_ptr      = constants-&gt;length();
2714   *constant_pool_byte_count_ptr = cpool_size;
2715   *constant_pool_bytes_ptr      = cpool_bytes;
2716 
2717   return JVMTI_ERROR_NONE;
2718 } /* end GetConstantPool */
2719 
2720 
2721 // k_mirror - may be primitive, this must be checked
2722 // is_interface_ptr - pre-checked for NULL
2723 jvmtiError
2724 JvmtiEnv::IsInterface(oop k_mirror, jboolean* is_interface_ptr) {
2725   {
2726     bool result = false;
2727     if (!java_lang_Class::is_primitive(k_mirror)) {
2728       Klass* k = java_lang_Class::as_Klass(k_mirror);
2729       if (k != NULL &amp;&amp; k-&gt;is_interface()) {
2730         result = true;
2731       }
2732     }
2733     *is_interface_ptr = result;
2734   }
2735 
2736   return JVMTI_ERROR_NONE;
2737 } /* end IsInterface */
2738 
2739 
2740 // k_mirror - may be primitive, this must be checked
2741 // is_array_class_ptr - pre-checked for NULL
2742 jvmtiError
2743 JvmtiEnv::IsArrayClass(oop k_mirror, jboolean* is_array_class_ptr) {
2744   {
2745     bool result = false;
2746     if (!java_lang_Class::is_primitive(k_mirror)) {
2747       Klass* k = java_lang_Class::as_Klass(k_mirror);
2748       if (k != NULL &amp;&amp; k-&gt;is_array_klass()) {
2749         result = true;
2750       }
2751     }
2752     *is_array_class_ptr = result;
2753   }
2754 
2755   return JVMTI_ERROR_NONE;
2756 } /* end IsArrayClass */
2757 
2758 
2759 // k_mirror - may be primitive, this must be checked
2760 // classloader_ptr - pre-checked for NULL
2761 jvmtiError
2762 JvmtiEnv::GetClassLoader(oop k_mirror, jobject* classloader_ptr) {
2763   {
2764     if (java_lang_Class::is_primitive(k_mirror)) {
2765       *classloader_ptr = (jclass) jni_reference(Handle());
2766       return JVMTI_ERROR_NONE;
2767     }
2768     JavaThread* current_thread = JavaThread::current();
2769     HandleMark hm(current_thread);
2770     Klass* k = java_lang_Class::as_Klass(k_mirror);
2771     NULL_CHECK(k, JVMTI_ERROR_INVALID_CLASS);
2772 
2773     oop result_oop = k-&gt;class_loader();
2774     if (result_oop == NULL) {
2775       *classloader_ptr = (jclass) jni_reference(Handle());
2776       return JVMTI_ERROR_NONE;
2777     }
2778     Handle result_handle = Handle(current_thread, result_oop);
2779     jclass result_jnihandle = (jclass) jni_reference(result_handle);
2780     *classloader_ptr = result_jnihandle;
2781   }
2782   return JVMTI_ERROR_NONE;
2783 } /* end GetClassLoader */
2784 
2785 
2786 // k_mirror - may be primitive, this must be checked
2787 // source_debug_extension_ptr - pre-checked for NULL
2788 jvmtiError
2789 JvmtiEnv::GetSourceDebugExtension(oop k_mirror, char** source_debug_extension_ptr) {
2790   {
2791     if (java_lang_Class::is_primitive(k_mirror)) {
2792       return JVMTI_ERROR_ABSENT_INFORMATION;
2793     }
2794     Klass* k = java_lang_Class::as_Klass(k_mirror);
2795     NULL_CHECK(k, JVMTI_ERROR_INVALID_CLASS);
2796     if (!k-&gt;is_instance_klass()) {
2797       return JVMTI_ERROR_ABSENT_INFORMATION;
2798     }
2799     const char* sde = InstanceKlass::cast(k)-&gt;source_debug_extension();
2800     NULL_CHECK(sde, JVMTI_ERROR_ABSENT_INFORMATION);
2801 
2802     {
2803       *source_debug_extension_ptr = (char *) jvmtiMalloc(strlen(sde)+1);
2804       strcpy(*source_debug_extension_ptr, sde);
2805     }
2806   }
2807 
2808   return JVMTI_ERROR_NONE;
2809 } /* end GetSourceDebugExtension */
2810 
2811   //
2812   // Object functions
2813   //
2814 
2815 // hash_code_ptr - pre-checked for NULL
2816 jvmtiError
2817 JvmtiEnv::GetObjectHashCode(jobject object, jint* hash_code_ptr) {
2818   oop mirror = JNIHandles::resolve_external_guard(object);
2819   NULL_CHECK(mirror, JVMTI_ERROR_INVALID_OBJECT);
2820   NULL_CHECK(hash_code_ptr, JVMTI_ERROR_NULL_POINTER);
2821 
2822   {
2823     jint result = (jint) mirror-&gt;identity_hash();
2824     *hash_code_ptr = result;
2825   }
2826   return JVMTI_ERROR_NONE;
2827 } /* end GetObjectHashCode */
2828 
2829 
2830 // info_ptr - pre-checked for NULL
2831 jvmtiError
2832 JvmtiEnv::GetObjectMonitorUsage(jobject object, jvmtiMonitorUsage* info_ptr) {
2833   JavaThread* calling_thread = JavaThread::current();
2834   jvmtiError err = get_object_monitor_usage(calling_thread, object, info_ptr);
2835   if (err == JVMTI_ERROR_THREAD_NOT_SUSPENDED) {
2836     // Some of the critical threads were not suspended. go to a safepoint and try again
2837     VM_GetObjectMonitorUsage op(this, calling_thread, object, info_ptr);
2838     VMThread::execute(&amp;op);
2839     err = op.result();
2840   }
2841   return err;
2842 } /* end GetObjectMonitorUsage */
2843 
2844 
2845   //
2846   // Field functions
2847   //
2848 
2849 // name_ptr - NULL is a valid value, must be checked
2850 // signature_ptr - NULL is a valid value, must be checked
2851 // generic_ptr - NULL is a valid value, must be checked
2852 jvmtiError
2853 JvmtiEnv::GetFieldName(fieldDescriptor* fdesc_ptr, char** name_ptr, char** signature_ptr, char** generic_ptr) {
2854   JavaThread* current_thread  = JavaThread::current();
2855   ResourceMark rm(current_thread);
2856   if (name_ptr == NULL) {
2857     // just don&#39;t return the name
2858   } else {
2859     const char* fieldName = fdesc_ptr-&gt;name()-&gt;as_C_string();
2860     *name_ptr =  (char*) jvmtiMalloc(strlen(fieldName) + 1);
2861     if (*name_ptr == NULL)
2862       return JVMTI_ERROR_OUT_OF_MEMORY;
2863     strcpy(*name_ptr, fieldName);
2864   }
2865   if (signature_ptr== NULL) {
2866     // just don&#39;t return the signature
2867   } else {
2868     const char* fieldSignature = fdesc_ptr-&gt;signature()-&gt;as_C_string();
2869     *signature_ptr = (char*) jvmtiMalloc(strlen(fieldSignature) + 1);
2870     if (*signature_ptr == NULL)
2871       return JVMTI_ERROR_OUT_OF_MEMORY;
2872     strcpy(*signature_ptr, fieldSignature);
2873   }
2874   if (generic_ptr != NULL) {
2875     *generic_ptr = NULL;
2876     Symbol* soop = fdesc_ptr-&gt;generic_signature();
2877     if (soop != NULL) {
2878       const char* gen_sig = soop-&gt;as_C_string();
2879       if (gen_sig != NULL) {
2880         jvmtiError err = allocate(strlen(gen_sig) + 1, (unsigned char **)generic_ptr);
2881         if (err != JVMTI_ERROR_NONE) {
2882           return err;
2883         }
2884         strcpy(*generic_ptr, gen_sig);
2885       }
2886     }
2887   }
2888   return JVMTI_ERROR_NONE;
2889 } /* end GetFieldName */
2890 
2891 
2892 // declaring_class_ptr - pre-checked for NULL
2893 jvmtiError
2894 JvmtiEnv::GetFieldDeclaringClass(fieldDescriptor* fdesc_ptr, jclass* declaring_class_ptr) {
2895 
2896   *declaring_class_ptr = get_jni_class_non_null(fdesc_ptr-&gt;field_holder());
2897   return JVMTI_ERROR_NONE;
2898 } /* end GetFieldDeclaringClass */
2899 
2900 
2901 // modifiers_ptr - pre-checked for NULL
2902 jvmtiError
2903 JvmtiEnv::GetFieldModifiers(fieldDescriptor* fdesc_ptr, jint* modifiers_ptr) {
2904 
2905   AccessFlags resultFlags = fdesc_ptr-&gt;access_flags();
2906   jint result = resultFlags.as_int();
2907   *modifiers_ptr = result;
2908 
2909   return JVMTI_ERROR_NONE;
2910 } /* end GetFieldModifiers */
2911 
2912 
2913 // is_synthetic_ptr - pre-checked for NULL
2914 jvmtiError
2915 JvmtiEnv::IsFieldSynthetic(fieldDescriptor* fdesc_ptr, jboolean* is_synthetic_ptr) {
2916   *is_synthetic_ptr = fdesc_ptr-&gt;is_synthetic();
2917   return JVMTI_ERROR_NONE;
2918 } /* end IsFieldSynthetic */
2919 
2920 
2921   //
2922   // Method functions
2923   //
2924 
2925 // method_oop - pre-checked for validity, but may be NULL meaning obsolete method
2926 // name_ptr - NULL is a valid value, must be checked
2927 // signature_ptr - NULL is a valid value, must be checked
2928 // generic_ptr - NULL is a valid value, must be checked
2929 jvmtiError
2930 JvmtiEnv::GetMethodName(Method* method_oop, char** name_ptr, char** signature_ptr, char** generic_ptr) {
2931   NULL_CHECK(method_oop, JVMTI_ERROR_INVALID_METHODID);
2932   JavaThread* current_thread  = JavaThread::current();
2933 
2934   ResourceMark rm(current_thread); // get the utf8 name and signature
2935   if (name_ptr == NULL) {
2936     // just don&#39;t return the name
2937   } else {
2938     const char* utf8_name = (const char *) method_oop-&gt;name()-&gt;as_utf8();
2939     *name_ptr = (char *) jvmtiMalloc(strlen(utf8_name)+1);
2940     strcpy(*name_ptr, utf8_name);
2941   }
2942   if (signature_ptr == NULL) {
2943     // just don&#39;t return the signature
2944   } else {
2945     const char* utf8_signature = (const char *) method_oop-&gt;signature()-&gt;as_utf8();
2946     *signature_ptr = (char *) jvmtiMalloc(strlen(utf8_signature) + 1);
2947     strcpy(*signature_ptr, utf8_signature);
2948   }
2949 
2950   if (generic_ptr != NULL) {
2951     *generic_ptr = NULL;
2952     Symbol* soop = method_oop-&gt;generic_signature();
2953     if (soop != NULL) {
2954       const char* gen_sig = soop-&gt;as_C_string();
2955       if (gen_sig != NULL) {
2956         jvmtiError err = allocate(strlen(gen_sig) + 1, (unsigned char **)generic_ptr);
2957         if (err != JVMTI_ERROR_NONE) {
2958           return err;
2959         }
2960         strcpy(*generic_ptr, gen_sig);
2961       }
2962     }
2963   }
2964   return JVMTI_ERROR_NONE;
2965 } /* end GetMethodName */
2966 
2967 
2968 // method_oop - pre-checked for validity, but may be NULL meaning obsolete method
2969 // declaring_class_ptr - pre-checked for NULL
2970 jvmtiError
2971 JvmtiEnv::GetMethodDeclaringClass(Method* method_oop, jclass* declaring_class_ptr) {
2972   NULL_CHECK(method_oop, JVMTI_ERROR_INVALID_METHODID);
2973   (*declaring_class_ptr) = get_jni_class_non_null(method_oop-&gt;method_holder());
2974   return JVMTI_ERROR_NONE;
2975 } /* end GetMethodDeclaringClass */
2976 
2977 
2978 // method_oop - pre-checked for validity, but may be NULL meaning obsolete method
2979 // modifiers_ptr - pre-checked for NULL
2980 jvmtiError
2981 JvmtiEnv::GetMethodModifiers(Method* method_oop, jint* modifiers_ptr) {
2982   NULL_CHECK(method_oop, JVMTI_ERROR_INVALID_METHODID);
2983   (*modifiers_ptr) = method_oop-&gt;access_flags().as_int() &amp; JVM_RECOGNIZED_METHOD_MODIFIERS;
2984   return JVMTI_ERROR_NONE;
2985 } /* end GetMethodModifiers */
2986 
2987 
2988 // method_oop - pre-checked for validity, but may be NULL meaning obsolete method
2989 // max_ptr - pre-checked for NULL
2990 jvmtiError
2991 JvmtiEnv::GetMaxLocals(Method* method_oop, jint* max_ptr) {
2992   NULL_CHECK(method_oop, JVMTI_ERROR_INVALID_METHODID);
2993   // get max stack
2994   (*max_ptr) = method_oop-&gt;max_locals();
2995   return JVMTI_ERROR_NONE;
2996 } /* end GetMaxLocals */
2997 
2998 
2999 // method_oop - pre-checked for validity, but may be NULL meaning obsolete method
3000 // size_ptr - pre-checked for NULL
3001 jvmtiError
3002 JvmtiEnv::GetArgumentsSize(Method* method_oop, jint* size_ptr) {
3003   NULL_CHECK(method_oop, JVMTI_ERROR_INVALID_METHODID);
3004   // get size of arguments
3005 
3006   (*size_ptr) = method_oop-&gt;size_of_parameters();
3007   return JVMTI_ERROR_NONE;
3008 } /* end GetArgumentsSize */
3009 
3010 
3011 // method_oop - pre-checked for validity, but may be NULL meaning obsolete method
3012 // entry_count_ptr - pre-checked for NULL
3013 // table_ptr - pre-checked for NULL
3014 jvmtiError
3015 JvmtiEnv::GetLineNumberTable(Method* method_oop, jint* entry_count_ptr, jvmtiLineNumberEntry** table_ptr) {
3016   NULL_CHECK(method_oop, JVMTI_ERROR_INVALID_METHODID);
3017   if (!method_oop-&gt;has_linenumber_table()) {
3018     return (JVMTI_ERROR_ABSENT_INFORMATION);
3019   }
3020 
3021   // The line number table is compressed so we don&#39;t know how big it is until decompressed.
3022   // Decompression is really fast so we just do it twice.
3023 
3024   // Compute size of table
3025   jint num_entries = 0;
3026   CompressedLineNumberReadStream stream(method_oop-&gt;compressed_linenumber_table());
3027   while (stream.read_pair()) {
3028     num_entries++;
3029   }
3030   jvmtiLineNumberEntry *jvmti_table =
3031             (jvmtiLineNumberEntry *)jvmtiMalloc(num_entries * (sizeof(jvmtiLineNumberEntry)));
3032 
3033   // Fill jvmti table
3034   if (num_entries &gt; 0) {
3035     int index = 0;
3036     CompressedLineNumberReadStream stream(method_oop-&gt;compressed_linenumber_table());
3037     while (stream.read_pair()) {
3038       jvmti_table[index].start_location = (jlocation) stream.bci();
3039       jvmti_table[index].line_number = (jint) stream.line();
3040       index++;
3041     }
3042     assert(index == num_entries, &quot;sanity check&quot;);
3043   }
3044 
3045   // Set up results
3046   (*entry_count_ptr) = num_entries;
3047   (*table_ptr) = jvmti_table;
3048 
3049   return JVMTI_ERROR_NONE;
3050 } /* end GetLineNumberTable */
3051 
3052 
3053 // method_oop - pre-checked for validity, but may be NULL meaning obsolete method
3054 // start_location_ptr - pre-checked for NULL
3055 // end_location_ptr - pre-checked for NULL
3056 jvmtiError
3057 JvmtiEnv::GetMethodLocation(Method* method_oop, jlocation* start_location_ptr, jlocation* end_location_ptr) {
3058 
3059   NULL_CHECK(method_oop, JVMTI_ERROR_INVALID_METHODID);
3060   // get start and end location
3061   (*end_location_ptr) = (jlocation) (method_oop-&gt;code_size() - 1);
3062   if (method_oop-&gt;code_size() == 0) {
3063     // there is no code so there is no start location
3064     (*start_location_ptr) = (jlocation)(-1);
3065   } else {
3066     (*start_location_ptr) = (jlocation)(0);
3067   }
3068 
3069   return JVMTI_ERROR_NONE;
3070 } /* end GetMethodLocation */
3071 
3072 
3073 // method_oop - pre-checked for validity, but may be NULL meaning obsolete method
3074 // entry_count_ptr - pre-checked for NULL
3075 // table_ptr - pre-checked for NULL
3076 jvmtiError
3077 JvmtiEnv::GetLocalVariableTable(Method* method_oop, jint* entry_count_ptr, jvmtiLocalVariableEntry** table_ptr) {
3078 
3079   NULL_CHECK(method_oop, JVMTI_ERROR_INVALID_METHODID);
3080   JavaThread* current_thread  = JavaThread::current();
3081 
3082   // does the klass have any local variable information?
3083   InstanceKlass* ik = method_oop-&gt;method_holder();
3084   if (!ik-&gt;access_flags().has_localvariable_table()) {
3085     return (JVMTI_ERROR_ABSENT_INFORMATION);
3086   }
3087 
3088   ConstantPool* constants = method_oop-&gt;constants();
3089   NULL_CHECK(constants, JVMTI_ERROR_ABSENT_INFORMATION);
3090 
3091   // in the vm localvariable table representation, 6 consecutive elements in the table
3092   // represent a 6-tuple of shorts
3093   // [start_pc, length, name_index, descriptor_index, signature_index, index]
3094   jint num_entries = method_oop-&gt;localvariable_table_length();
3095   jvmtiLocalVariableEntry *jvmti_table = (jvmtiLocalVariableEntry *)
3096                 jvmtiMalloc(num_entries * (sizeof(jvmtiLocalVariableEntry)));
3097 
3098   if (num_entries &gt; 0) {
3099     LocalVariableTableElement* table = method_oop-&gt;localvariable_table_start();
3100     for (int i = 0; i &lt; num_entries; i++) {
3101       // get the 5 tuple information from the vm table
3102       jlocation start_location = (jlocation) table[i].start_bci;
3103       jint length = (jint) table[i].length;
3104       int name_index = (int) table[i].name_cp_index;
3105       int signature_index = (int) table[i].descriptor_cp_index;
3106       int generic_signature_index = (int) table[i].signature_cp_index;
3107       jint slot = (jint) table[i].slot;
3108 
3109       // get utf8 name and signature
3110       char *name_buf = NULL;
3111       char *sig_buf = NULL;
3112       char *gen_sig_buf = NULL;
3113       {
3114         ResourceMark rm(current_thread);
3115 
3116         const char *utf8_name = (const char *) constants-&gt;symbol_at(name_index)-&gt;as_utf8();
3117         name_buf = (char *) jvmtiMalloc(strlen(utf8_name)+1);
3118         strcpy(name_buf, utf8_name);
3119 
3120         const char *utf8_signature = (const char *) constants-&gt;symbol_at(signature_index)-&gt;as_utf8();
3121         sig_buf = (char *) jvmtiMalloc(strlen(utf8_signature)+1);
3122         strcpy(sig_buf, utf8_signature);
3123 
3124         if (generic_signature_index &gt; 0) {
3125           const char *utf8_gen_sign = (const char *)
3126                                        constants-&gt;symbol_at(generic_signature_index)-&gt;as_utf8();
3127           gen_sig_buf = (char *) jvmtiMalloc(strlen(utf8_gen_sign)+1);
3128           strcpy(gen_sig_buf, utf8_gen_sign);
3129         }
3130       }
3131 
3132       // fill in the jvmti local variable table
3133       jvmti_table[i].start_location = start_location;
3134       jvmti_table[i].length = length;
3135       jvmti_table[i].name = name_buf;
3136       jvmti_table[i].signature = sig_buf;
3137       jvmti_table[i].generic_signature = gen_sig_buf;
3138       jvmti_table[i].slot = slot;
3139     }
3140   }
3141 
3142   // set results
3143   (*entry_count_ptr) = num_entries;
3144   (*table_ptr) = jvmti_table;
3145 
3146   return JVMTI_ERROR_NONE;
3147 } /* end GetLocalVariableTable */
3148 
3149 
3150 // method_oop - pre-checked for validity, but may be NULL meaning obsolete method
3151 // bytecode_count_ptr - pre-checked for NULL
3152 // bytecodes_ptr - pre-checked for NULL
3153 jvmtiError
3154 JvmtiEnv::GetBytecodes(Method* method_oop, jint* bytecode_count_ptr, unsigned char** bytecodes_ptr) {
3155   NULL_CHECK(method_oop, JVMTI_ERROR_INVALID_METHODID);
3156 
3157   HandleMark hm;
<a name="16" id="anc16"></a><span class="line-modified">3158   methodHandle method(method_oop);</span>
3159   jint size = (jint)method-&gt;code_size();
3160   jvmtiError err = allocate(size, bytecodes_ptr);
3161   if (err != JVMTI_ERROR_NONE) {
3162     return err;
3163   }
3164 
3165   (*bytecode_count_ptr) = size;
3166   // get byte codes
3167   JvmtiClassFileReconstituter::copy_bytecodes(method, *bytecodes_ptr);
3168 
3169   return JVMTI_ERROR_NONE;
3170 } /* end GetBytecodes */
3171 
3172 
3173 // method_oop - pre-checked for validity, but may be NULL meaning obsolete method
3174 // is_native_ptr - pre-checked for NULL
3175 jvmtiError
3176 JvmtiEnv::IsMethodNative(Method* method_oop, jboolean* is_native_ptr) {
3177   NULL_CHECK(method_oop, JVMTI_ERROR_INVALID_METHODID);
3178   (*is_native_ptr) = method_oop-&gt;is_native();
3179   return JVMTI_ERROR_NONE;
3180 } /* end IsMethodNative */
3181 
3182 
3183 // method_oop - pre-checked for validity, but may be NULL meaning obsolete method
3184 // is_synthetic_ptr - pre-checked for NULL
3185 jvmtiError
3186 JvmtiEnv::IsMethodSynthetic(Method* method_oop, jboolean* is_synthetic_ptr) {
3187   NULL_CHECK(method_oop, JVMTI_ERROR_INVALID_METHODID);
3188   (*is_synthetic_ptr) = method_oop-&gt;is_synthetic();
3189   return JVMTI_ERROR_NONE;
3190 } /* end IsMethodSynthetic */
3191 
3192 
3193 // method_oop - pre-checked for validity, but may be NULL meaning obsolete method
3194 // is_obsolete_ptr - pre-checked for NULL
3195 jvmtiError
3196 JvmtiEnv::IsMethodObsolete(Method* method_oop, jboolean* is_obsolete_ptr) {
3197   if (use_version_1_0_semantics() &amp;&amp;
3198       get_capabilities()-&gt;can_redefine_classes == 0) {
3199     // This JvmtiEnv requested version 1.0 semantics and this function
3200     // requires the can_redefine_classes capability in version 1.0 so
3201     // we need to return an error here.
3202     return JVMTI_ERROR_MUST_POSSESS_CAPABILITY;
3203   }
3204 
3205   if (method_oop == NULL || method_oop-&gt;is_obsolete()) {
3206     *is_obsolete_ptr = true;
3207   } else {
3208     *is_obsolete_ptr = false;
3209   }
3210   return JVMTI_ERROR_NONE;
3211 } /* end IsMethodObsolete */
3212 
3213   //
3214   // Raw Monitor functions
3215   //
3216 
3217 // Tsan note: The JVMTI raw monitors are instrumented at JvmtiRawMonitor call
3218 // sites instead of inside the JvmtiRawMonitor implementation. This seems
3219 // cleaner, and mirrors instrumentation of JVM_RawMonitor* functions.
3220 
3221 // name - pre-checked for NULL
3222 // monitor_ptr - pre-checked for NULL
3223 jvmtiError
3224 JvmtiEnv::CreateRawMonitor(const char* name, jrawMonitorID* monitor_ptr) {
3225   JvmtiRawMonitor* rmonitor = new JvmtiRawMonitor(name);
3226   NULL_CHECK(rmonitor, JVMTI_ERROR_OUT_OF_MEMORY);
3227 
3228   *monitor_ptr = (jrawMonitorID)rmonitor;
3229 
3230   TSAN_RUNTIME_ONLY(TSAN_RAW_LOCK_CREATE(rmonitor));
3231 
3232   return JVMTI_ERROR_NONE;
3233 } /* end CreateRawMonitor */
3234 
3235 
3236 // rmonitor - pre-checked for validity
3237 jvmtiError
3238 JvmtiEnv::DestroyRawMonitor(JvmtiRawMonitor * rmonitor) {
3239   if (Threads::number_of_threads() == 0) {
<a name="17" id="anc17"></a><span class="line-modified">3240     // Remove this  monitor from pending raw monitors list</span>
3241     // if it has entered in onload or start phase.
3242     JvmtiPendingMonitors::destroy(rmonitor);
3243   } else {
3244     Thread* thread  = Thread::current();
<a name="18" id="anc18"></a><span class="line-modified">3245     if (rmonitor-&gt;is_entered(thread)) {</span>
3246       // The caller owns this monitor which we are about to destroy.
3247       // We exit the underlying synchronization object so that the
3248       // &quot;delete monitor&quot; call below can work without an assertion
3249       // failure on systems that don&#39;t like destroying synchronization
3250       // objects that are locked.
3251       int r;
<a name="19" id="anc19"></a><span class="line-modified">3252       intptr_t recursion = rmonitor-&gt;recursions();</span>
<span class="line-modified">3253       for (intptr_t i = 0; i &lt;= recursion; i++) {</span>
3254         TSAN_RUNTIME_ONLY(TSAN_RAW_LOCK_RELEASED(rmonitor));
3255         r = rmonitor-&gt;raw_exit(thread);
<a name="20" id="anc20"></a><span class="line-modified">3256         assert(r == ObjectMonitor::OM_OK, &quot;raw_exit should have worked&quot;);</span>
<span class="line-modified">3257         if (r != ObjectMonitor::OM_OK) {  // robustness</span>
3258           return JVMTI_ERROR_INTERNAL;
3259         }
3260       }
3261     }
3262     if (rmonitor-&gt;owner() != NULL) {
3263       // The caller is trying to destroy a monitor that is locked by
3264       // someone else. While this is not forbidden by the JVMTI
3265       // spec, it will cause an assertion failure on systems that don&#39;t
3266       // like destroying synchronization objects that are locked.
3267       // We indicate a problem with the error return (and leak the
3268       // monitor&#39;s memory).
3269       return JVMTI_ERROR_NOT_MONITOR_OWNER;
3270     }
3271   }
3272 
3273   TSAN_RUNTIME_ONLY(TSAN_RAW_LOCK_DESTROY(rmonitor));
3274   delete rmonitor;
3275 
3276   return JVMTI_ERROR_NONE;
3277 } /* end DestroyRawMonitor */
3278 
3279 
3280 // rmonitor - pre-checked for validity
3281 jvmtiError
3282 JvmtiEnv::RawMonitorEnter(JvmtiRawMonitor * rmonitor) {
3283   if (Threads::number_of_threads() == 0) {
<a name="21" id="anc21"></a><span class="line-modified">3284     // No JavaThreads exist so ObjectMonitor enter cannot be</span>
3285     // used, add this raw monitor to the pending list.
3286     // The pending monitors will be actually entered when
3287     // the VM is setup.
3288     // See transition_pending_raw_monitors in create_vm()
3289     // in thread.cpp.
3290     JvmtiPendingMonitors::enter(rmonitor);
3291   } else {
<a name="22" id="anc22"></a><span class="line-removed">3292     int r = 0;</span>
<span class="line-removed">3293     Thread* thread = Thread::current();</span>
3294 
3295     if (thread-&gt;is_Java_thread()) {
3296       JavaThread* current_thread = (JavaThread*)thread;
3297 
<a name="23" id="anc23"></a><span class="line-removed">3298 #ifdef PROPER_TRANSITIONS</span>
<span class="line-removed">3299       // Not really unknown but ThreadInVMfromNative does more than we want</span>
<span class="line-removed">3300       ThreadInVMfromUnknown __tiv;</span>
<span class="line-removed">3301       {</span>
<span class="line-removed">3302         ThreadBlockInVM __tbivm(current_thread);</span>
<span class="line-removed">3303         r = rmonitor-&gt;raw_enter(current_thread);</span>
<span class="line-removed">3304       }</span>
<span class="line-removed">3305 #else</span>
3306       /* Transition to thread_blocked without entering vm state          */
3307       /* This is really evil. Normally you can&#39;t undo _thread_blocked    */
3308       /* transitions like this because it would cause us to miss a       */
3309       /* safepoint but since the thread was already in _thread_in_native */
3310       /* the thread is not leaving a safepoint safe state and it will    */
3311       /* block when it tries to return from native. We can&#39;t safepoint   */
3312       /* block in here because we could deadlock the vmthread. Blech.    */
3313 
3314       JavaThreadState state = current_thread-&gt;thread_state();
3315       assert(state == _thread_in_native, &quot;Must be _thread_in_native&quot;);
3316       // frame should already be walkable since we are in native
3317       assert(!current_thread-&gt;has_last_Java_frame() ||
3318              current_thread-&gt;frame_anchor()-&gt;walkable(), &quot;Must be walkable&quot;);
3319       current_thread-&gt;set_thread_state(_thread_blocked);
3320 
<a name="24" id="anc24"></a><span class="line-modified">3321       r = rmonitor-&gt;raw_enter(current_thread);</span>
3322       // restore state, still at a safepoint safe state
3323       current_thread-&gt;set_thread_state(state);
<a name="25" id="anc25"></a><span class="line-modified">3324 </span>
<span class="line-removed">3325 #endif /* PROPER_TRANSITIONS */</span>
<span class="line-removed">3326       assert(r == ObjectMonitor::OM_OK, &quot;raw_enter should have worked&quot;);</span>
<span class="line-removed">3327     } else {</span>
<span class="line-removed">3328       if (thread-&gt;is_Named_thread()) {</span>
<span class="line-removed">3329         r = rmonitor-&gt;raw_enter(thread);</span>
<span class="line-removed">3330       } else {</span>
<span class="line-removed">3331         ShouldNotReachHere();</span>
<span class="line-removed">3332       }</span>
<span class="line-removed">3333     }</span>
<span class="line-removed">3334 </span>
<span class="line-removed">3335     if (r != ObjectMonitor::OM_OK) {  // robustness</span>
3336       return JVMTI_ERROR_INTERNAL;
3337     }
3338     TSAN_RUNTIME_ONLY(TSAN_RAW_LOCK_ACQUIRED(rmonitor));
3339   }
3340   return JVMTI_ERROR_NONE;
3341 } /* end RawMonitorEnter */
3342 
3343 
3344 // rmonitor - pre-checked for validity
3345 jvmtiError
3346 JvmtiEnv::RawMonitorExit(JvmtiRawMonitor * rmonitor) {
3347   jvmtiError err = JVMTI_ERROR_NONE;
3348 
3349   if (Threads::number_of_threads() == 0) {
3350     // No JavaThreads exist so just remove this monitor from the pending list.
3351     // Bool value from exit is false if rmonitor is not in the list.
3352     if (!JvmtiPendingMonitors::exit(rmonitor)) {
3353       err = JVMTI_ERROR_NOT_MONITOR_OWNER;
3354     }
3355   } else {
<a name="26" id="anc26"></a><span class="line-removed">3356     int r = 0;</span>
<span class="line-removed">3357     Thread* thread = Thread::current();</span>
3358 
<a name="27" id="anc27"></a><span class="line-modified">3359     TSAN_RUNTIME_ONLY(TSAN_RAW_LOCK_RELEASED(rmonitor));</span>
<span class="line-modified">3360 </span>
<span class="line-removed">3361     if (thread-&gt;is_Java_thread()) {</span>
<span class="line-removed">3362       JavaThread* current_thread = (JavaThread*)thread;</span>
<span class="line-removed">3363 #ifdef PROPER_TRANSITIONS</span>
<span class="line-removed">3364       // Not really unknown but ThreadInVMfromNative does more than we want</span>
<span class="line-removed">3365       ThreadInVMfromUnknown __tiv;</span>
<span class="line-removed">3366 #endif /* PROPER_TRANSITIONS */</span>
<span class="line-removed">3367       r = rmonitor-&gt;raw_exit(current_thread);</span>
<span class="line-removed">3368     } else {</span>
<span class="line-removed">3369       if (thread-&gt;is_Named_thread()) {</span>
<span class="line-removed">3370         r = rmonitor-&gt;raw_exit(thread);</span>
<span class="line-removed">3371       } else {</span>
<span class="line-removed">3372         ShouldNotReachHere();</span>
<span class="line-removed">3373       }</span>
<span class="line-removed">3374     }</span>
<span class="line-removed">3375 </span>
3376     if (r == ObjectMonitor::OM_ILLEGAL_MONITOR_STATE) {
3377       err = JVMTI_ERROR_NOT_MONITOR_OWNER;
<a name="28" id="anc28"></a><span class="line-removed">3378     } else {</span>
<span class="line-removed">3379       assert(r == ObjectMonitor::OM_OK, &quot;raw_exit should have worked&quot;);</span>
<span class="line-removed">3380       if (r != ObjectMonitor::OM_OK) {  // robustness</span>
<span class="line-removed">3381         err = JVMTI_ERROR_INTERNAL;</span>
<span class="line-removed">3382       }</span>
3383     }
3384   }
3385   return err;
3386 } /* end RawMonitorExit */
3387 
3388 
3389 // rmonitor - pre-checked for validity
3390 jvmtiError
3391 JvmtiEnv::RawMonitorWait(JvmtiRawMonitor * rmonitor, jlong millis) {
<a name="29" id="anc29"></a><span class="line-removed">3392   int r = 0;</span>
3393   Thread* thread = Thread::current();
3394 
3395   // A wait is modeled in Tsan as a simple release-acquire pair.
3396   // The matching release annotation is below.
<a name="30" id="anc30"></a><span class="line-modified">3397   TSAN_RUNTIME_ONLY(TSAN_RAW_LOCK_RELEASED(rmonitor));</span>
<span class="line-removed">3398 </span>
<span class="line-removed">3399   if (thread-&gt;is_Java_thread()) {</span>
<span class="line-removed">3400     JavaThread* current_thread = (JavaThread*)thread;</span>
<span class="line-removed">3401 #ifdef PROPER_TRANSITIONS</span>
<span class="line-removed">3402     // Not really unknown but ThreadInVMfromNative does more than we want</span>
<span class="line-removed">3403     ThreadInVMfromUnknown __tiv;</span>
<span class="line-removed">3404     {</span>
<span class="line-removed">3405       ThreadBlockInVM __tbivm(current_thread);</span>
<span class="line-removed">3406       r = rmonitor-&gt;raw_wait(millis, true, current_thread);</span>
<span class="line-removed">3407     }</span>
<span class="line-removed">3408 #else</span>
<span class="line-removed">3409     /* Transition to thread_blocked without entering vm state          */</span>
<span class="line-removed">3410     /* This is really evil. Normally you can&#39;t undo _thread_blocked    */</span>
<span class="line-removed">3411     /* transitions like this because it would cause us to miss a       */</span>
<span class="line-removed">3412     /* safepoint but since the thread was already in _thread_in_native */</span>
<span class="line-removed">3413     /* the thread is not leaving a safepoint safe state and it will    */</span>
<span class="line-removed">3414     /* block when it tries to return from native. We can&#39;t safepoint   */</span>
<span class="line-removed">3415     /* block in here because we could deadlock the vmthread. Blech.    */</span>
<span class="line-removed">3416 </span>
<span class="line-removed">3417     JavaThreadState state = current_thread-&gt;thread_state();</span>
<span class="line-removed">3418     assert(state == _thread_in_native, &quot;Must be _thread_in_native&quot;);</span>
<span class="line-removed">3419     // frame should already be walkable since we are in native</span>
<span class="line-removed">3420     assert(!current_thread-&gt;has_last_Java_frame() ||</span>
<span class="line-removed">3421            current_thread-&gt;frame_anchor()-&gt;walkable(), &quot;Must be walkable&quot;);</span>
<span class="line-removed">3422     current_thread-&gt;set_thread_state(_thread_blocked);</span>
<span class="line-removed">3423 </span>
<span class="line-removed">3424     r = rmonitor-&gt;raw_wait(millis, true, current_thread);</span>
<span class="line-removed">3425     // restore state, still at a safepoint safe state</span>
<span class="line-removed">3426     current_thread-&gt;set_thread_state(state);</span>
<span class="line-removed">3427 </span>
<span class="line-removed">3428 #endif /* PROPER_TRANSITIONS */</span>
<span class="line-removed">3429   } else {</span>
<span class="line-removed">3430     if (thread-&gt;is_Named_thread()) {</span>
<span class="line-removed">3431       r = rmonitor-&gt;raw_wait(millis, true, thread);</span>
<span class="line-removed">3432     } else {</span>
<span class="line-removed">3433       ShouldNotReachHere();</span>
<span class="line-removed">3434     }</span>
<span class="line-removed">3435   }</span>
<span class="line-removed">3436 </span>
3437   // A wait is modeled in Tsan as a simple release-acquire pair.
3438   // The matching acquire annotation is above.
3439   TSAN_RUNTIME_ONLY(TSAN_RAW_LOCK_ACQUIRED(rmonitor));
3440 
3441   switch (r) {
<a name="31" id="anc31"></a><span class="line-modified">3442   case ObjectMonitor::OM_INTERRUPTED:</span>
3443     return JVMTI_ERROR_INTERRUPT;
<a name="32" id="anc32"></a><span class="line-modified">3444   case ObjectMonitor::OM_ILLEGAL_MONITOR_STATE:</span>
3445     return JVMTI_ERROR_NOT_MONITOR_OWNER;
<a name="33" id="anc33"></a>

3446   }
<a name="34" id="anc34"></a><span class="line-removed">3447   assert(r == ObjectMonitor::OM_OK, &quot;raw_wait should have worked&quot;);</span>
<span class="line-removed">3448   if (r != ObjectMonitor::OM_OK) {  // robustness</span>
<span class="line-removed">3449     return JVMTI_ERROR_INTERNAL;</span>
<span class="line-removed">3450   }</span>
<span class="line-removed">3451 </span>
<span class="line-removed">3452   return JVMTI_ERROR_NONE;</span>
3453 } /* end RawMonitorWait */
3454 
3455 
3456 // rmonitor - pre-checked for validity
3457 jvmtiError
3458 JvmtiEnv::RawMonitorNotify(JvmtiRawMonitor * rmonitor) {
<a name="35" id="anc35"></a><span class="line-modified">3459   int r = 0;</span>
3460   Thread* thread = Thread::current();
3461 
<a name="36" id="anc36"></a><span class="line-modified">3462   if (thread-&gt;is_Java_thread()) {</span>
<span class="line-removed">3463     JavaThread* current_thread = (JavaThread*)thread;</span>
<span class="line-removed">3464     // Not really unknown but ThreadInVMfromNative does more than we want</span>
<span class="line-removed">3465     ThreadInVMfromUnknown __tiv;</span>
<span class="line-removed">3466     r = rmonitor-&gt;raw_notify(current_thread);</span>
<span class="line-removed">3467   } else {</span>
<span class="line-removed">3468     if (thread-&gt;is_Named_thread()) {</span>
<span class="line-removed">3469       r = rmonitor-&gt;raw_notify(thread);</span>
<span class="line-removed">3470     } else {</span>
<span class="line-removed">3471       ShouldNotReachHere();</span>
<span class="line-removed">3472     }</span>
<span class="line-removed">3473   }</span>
<span class="line-removed">3474 </span>
<span class="line-removed">3475   if (r == ObjectMonitor::OM_ILLEGAL_MONITOR_STATE) {</span>
3476     return JVMTI_ERROR_NOT_MONITOR_OWNER;
3477   }
<a name="37" id="anc37"></a><span class="line-removed">3478   assert(r == ObjectMonitor::OM_OK, &quot;raw_notify should have worked&quot;);</span>
<span class="line-removed">3479   if (r != ObjectMonitor::OM_OK) {  // robustness</span>
<span class="line-removed">3480     return JVMTI_ERROR_INTERNAL;</span>
<span class="line-removed">3481   }</span>
<span class="line-removed">3482 </span>
3483   return JVMTI_ERROR_NONE;
3484 } /* end RawMonitorNotify */
3485 
3486 
3487 // rmonitor - pre-checked for validity
3488 jvmtiError
3489 JvmtiEnv::RawMonitorNotifyAll(JvmtiRawMonitor * rmonitor) {
<a name="38" id="anc38"></a><span class="line-modified">3490   int r = 0;</span>
3491   Thread* thread = Thread::current();
3492 
<a name="39" id="anc39"></a><span class="line-modified">3493   if (thread-&gt;is_Java_thread()) {</span>
<span class="line-removed">3494     JavaThread* current_thread = (JavaThread*)thread;</span>
<span class="line-removed">3495     ThreadInVMfromUnknown __tiv;</span>
<span class="line-removed">3496     r = rmonitor-&gt;raw_notifyAll(current_thread);</span>
<span class="line-removed">3497   } else {</span>
<span class="line-removed">3498     if (thread-&gt;is_Named_thread()) {</span>
<span class="line-removed">3499       r = rmonitor-&gt;raw_notifyAll(thread);</span>
<span class="line-removed">3500     } else {</span>
<span class="line-removed">3501       ShouldNotReachHere();</span>
<span class="line-removed">3502     }</span>
<span class="line-removed">3503   }</span>
<span class="line-removed">3504 </span>
<span class="line-removed">3505   if (r == ObjectMonitor::OM_ILLEGAL_MONITOR_STATE) {</span>
3506     return JVMTI_ERROR_NOT_MONITOR_OWNER;
3507   }
<a name="40" id="anc40"></a><span class="line-removed">3508   assert(r == ObjectMonitor::OM_OK, &quot;raw_notifyAll should have worked&quot;);</span>
<span class="line-removed">3509   if (r != ObjectMonitor::OM_OK) {  // robustness</span>
<span class="line-removed">3510     return JVMTI_ERROR_INTERNAL;</span>
<span class="line-removed">3511   }</span>
<span class="line-removed">3512 </span>
3513   return JVMTI_ERROR_NONE;
3514 } /* end RawMonitorNotifyAll */
3515 
3516 
3517   //
3518   // JNI Function Interception functions
3519   //
3520 
3521 
3522 // function_table - pre-checked for NULL
3523 jvmtiError
3524 JvmtiEnv::SetJNIFunctionTable(const jniNativeInterface* function_table) {
3525   // Copy jni function table at safepoint.
3526   VM_JNIFunctionTableCopier copier(function_table);
3527   VMThread::execute(&amp;copier);
3528 
3529   return JVMTI_ERROR_NONE;
3530 } /* end SetJNIFunctionTable */
3531 
3532 
3533 // function_table - pre-checked for NULL
3534 jvmtiError
3535 JvmtiEnv::GetJNIFunctionTable(jniNativeInterface** function_table) {
3536   *function_table=(jniNativeInterface*)jvmtiMalloc(sizeof(jniNativeInterface));
3537   if (*function_table == NULL)
3538     return JVMTI_ERROR_OUT_OF_MEMORY;
3539   memcpy(*function_table,(JavaThread::current())-&gt;get_jni_functions(),sizeof(jniNativeInterface));
3540   return JVMTI_ERROR_NONE;
3541 } /* end GetJNIFunctionTable */
3542 
3543 
3544   //
3545   // Event Management functions
3546   //
3547 
3548 jvmtiError
3549 JvmtiEnv::GenerateEvents(jvmtiEvent event_type) {
3550   // can only generate two event types
3551   if (event_type != JVMTI_EVENT_COMPILED_METHOD_LOAD &amp;&amp;
3552       event_type != JVMTI_EVENT_DYNAMIC_CODE_GENERATED) {
3553     return JVMTI_ERROR_ILLEGAL_ARGUMENT;
3554   }
3555 
3556   // for compiled_method_load events we must check that the environment
3557   // has the can_generate_compiled_method_load_events capability.
3558   if (event_type == JVMTI_EVENT_COMPILED_METHOD_LOAD) {
3559     if (get_capabilities()-&gt;can_generate_compiled_method_load_events == 0) {
3560       return JVMTI_ERROR_MUST_POSSESS_CAPABILITY;
3561     }
3562     return JvmtiCodeBlobEvents::generate_compiled_method_load_events(this);
3563   } else {
3564     return JvmtiCodeBlobEvents::generate_dynamic_code_events(this);
3565   }
3566 
3567 } /* end GenerateEvents */
3568 
3569 
3570   //
3571   // Extension Mechanism functions
3572   //
3573 
3574 // extension_count_ptr - pre-checked for NULL
3575 // extensions - pre-checked for NULL
3576 jvmtiError
3577 JvmtiEnv::GetExtensionFunctions(jint* extension_count_ptr, jvmtiExtensionFunctionInfo** extensions) {
3578   return JvmtiExtensions::get_functions(this, extension_count_ptr, extensions);
3579 } /* end GetExtensionFunctions */
3580 
3581 
3582 // extension_count_ptr - pre-checked for NULL
3583 // extensions - pre-checked for NULL
3584 jvmtiError
3585 JvmtiEnv::GetExtensionEvents(jint* extension_count_ptr, jvmtiExtensionEventInfo** extensions) {
3586   return JvmtiExtensions::get_events(this, extension_count_ptr, extensions);
3587 } /* end GetExtensionEvents */
3588 
3589 
3590 // callback - NULL is a valid value, must be checked
3591 jvmtiError
3592 JvmtiEnv::SetExtensionEventCallback(jint extension_event_index, jvmtiExtensionEvent callback) {
3593   return JvmtiExtensions::set_event_callback(this, extension_event_index, callback);
3594 } /* end SetExtensionEventCallback */
3595 
3596   //
3597   // Timers functions
3598   //
3599 
3600 // info_ptr - pre-checked for NULL
3601 jvmtiError
3602 JvmtiEnv::GetCurrentThreadCpuTimerInfo(jvmtiTimerInfo* info_ptr) {
3603   os::current_thread_cpu_time_info(info_ptr);
3604   return JVMTI_ERROR_NONE;
3605 } /* end GetCurrentThreadCpuTimerInfo */
3606 
3607 
3608 // nanos_ptr - pre-checked for NULL
3609 jvmtiError
3610 JvmtiEnv::GetCurrentThreadCpuTime(jlong* nanos_ptr) {
3611   *nanos_ptr = os::current_thread_cpu_time();
3612   return JVMTI_ERROR_NONE;
3613 } /* end GetCurrentThreadCpuTime */
3614 
3615 
3616 // info_ptr - pre-checked for NULL
3617 jvmtiError
3618 JvmtiEnv::GetThreadCpuTimerInfo(jvmtiTimerInfo* info_ptr) {
3619   os::thread_cpu_time_info(info_ptr);
3620   return JVMTI_ERROR_NONE;
3621 } /* end GetThreadCpuTimerInfo */
3622 
3623 
3624 // Threads_lock NOT held, java_thread not protected by lock
3625 // java_thread - pre-checked
3626 // nanos_ptr - pre-checked for NULL
3627 jvmtiError
3628 JvmtiEnv::GetThreadCpuTime(JavaThread* java_thread, jlong* nanos_ptr) {
3629   *nanos_ptr = os::thread_cpu_time(java_thread);
3630   return JVMTI_ERROR_NONE;
3631 } /* end GetThreadCpuTime */
3632 
3633 
3634 // info_ptr - pre-checked for NULL
3635 jvmtiError
3636 JvmtiEnv::GetTimerInfo(jvmtiTimerInfo* info_ptr) {
3637   os::javaTimeNanos_info(info_ptr);
3638   return JVMTI_ERROR_NONE;
3639 } /* end GetTimerInfo */
3640 
3641 
3642 // nanos_ptr - pre-checked for NULL
3643 jvmtiError
3644 JvmtiEnv::GetTime(jlong* nanos_ptr) {
3645   *nanos_ptr = os::javaTimeNanos();
3646   return JVMTI_ERROR_NONE;
3647 } /* end GetTime */
3648 
3649 
3650 // processor_count_ptr - pre-checked for NULL
3651 jvmtiError
3652 JvmtiEnv::GetAvailableProcessors(jint* processor_count_ptr) {
3653   *processor_count_ptr = os::active_processor_count();
3654   return JVMTI_ERROR_NONE;
3655 } /* end GetAvailableProcessors */
3656 
3657 jvmtiError
3658 JvmtiEnv::SetHeapSamplingInterval(jint sampling_interval) {
3659   if (sampling_interval &lt; 0) {
3660     return JVMTI_ERROR_ILLEGAL_ARGUMENT;
3661   }
3662   ThreadHeapSampler::set_sampling_interval(sampling_interval);
3663   return JVMTI_ERROR_NONE;
3664 } /* end SetHeapSamplingInterval */
3665 
3666   //
3667   // System Properties functions
3668   //
3669 
3670 // count_ptr - pre-checked for NULL
3671 // property_ptr - pre-checked for NULL
3672 jvmtiError
3673 JvmtiEnv::GetSystemProperties(jint* count_ptr, char*** property_ptr) {
3674   jvmtiError err = JVMTI_ERROR_NONE;
3675 
3676   // Get the number of readable properties.
3677   *count_ptr = Arguments::PropertyList_readable_count(Arguments::system_properties());
3678 
3679   // Allocate memory to hold the exact number of readable properties.
3680   err = allocate(*count_ptr * sizeof(char *), (unsigned char **)property_ptr);
3681   if (err != JVMTI_ERROR_NONE) {
3682     return err;
3683   }
3684   int readable_count = 0;
3685   // Loop through the system properties until all the readable properties are found.
3686   for (SystemProperty* p = Arguments::system_properties(); p != NULL &amp;&amp; readable_count &lt; *count_ptr; p = p-&gt;next()) {
3687     if (p-&gt;is_readable()) {
3688       const char *key = p-&gt;key();
3689       char **tmp_value = *property_ptr+readable_count;
3690       readable_count++;
3691       err = allocate((strlen(key)+1) * sizeof(char), (unsigned char**)tmp_value);
3692       if (err == JVMTI_ERROR_NONE) {
3693         strcpy(*tmp_value, key);
3694       } else {
3695         // clean up previously allocated memory.
3696         for (int j = 0; j &lt; readable_count; j++) {
3697           Deallocate((unsigned char*)*property_ptr+j);
3698         }
3699         Deallocate((unsigned char*)property_ptr);
3700         break;
3701       }
3702     }
3703   }
3704   assert(err != JVMTI_ERROR_NONE || readable_count == *count_ptr, &quot;Bad readable property count&quot;);
3705   return err;
3706 } /* end GetSystemProperties */
3707 
3708 
3709 // property - pre-checked for NULL
3710 // value_ptr - pre-checked for NULL
3711 jvmtiError
3712 JvmtiEnv::GetSystemProperty(const char* property, char** value_ptr) {
3713   jvmtiError err = JVMTI_ERROR_NONE;
3714   const char *value;
3715 
3716   // Return JVMTI_ERROR_NOT_AVAILABLE if property is not readable or doesn&#39;t exist.
3717   value = Arguments::PropertyList_get_readable_value(Arguments::system_properties(), property);
3718   if (value == NULL) {
3719     err =  JVMTI_ERROR_NOT_AVAILABLE;
3720   } else {
3721     err = allocate((strlen(value)+1) * sizeof(char), (unsigned char **)value_ptr);
3722     if (err == JVMTI_ERROR_NONE) {
3723       strcpy(*value_ptr, value);
3724     }
3725   }
3726   return err;
3727 } /* end GetSystemProperty */
3728 
3729 
3730 // property - pre-checked for NULL
3731 // value - NULL is a valid value, must be checked
3732 jvmtiError
3733 JvmtiEnv::SetSystemProperty(const char* property, const char* value_ptr) {
3734   jvmtiError err =JVMTI_ERROR_NOT_AVAILABLE;
3735 
3736   for (SystemProperty* p = Arguments::system_properties(); p != NULL; p = p-&gt;next()) {
3737     if (strcmp(property, p-&gt;key()) == 0) {
3738       if (p-&gt;set_writeable_value(value_ptr)) {
3739         err =  JVMTI_ERROR_NONE;
3740       }
3741     }
3742   }
3743   return err;
3744 } /* end SetSystemProperty */
<a name="41" id="anc41"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="41" type="hidden" />
</body>
</html>