<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old src/hotspot/share/classfile/classFileParser.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 1997, 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 #include &quot;precompiled.hpp&quot;
  25 #include &quot;jvm.h&quot;
  26 #include &quot;aot/aotLoader.hpp&quot;
  27 #include &quot;classfile/classFileParser.hpp&quot;
  28 #include &quot;classfile/classFileStream.hpp&quot;
  29 #include &quot;classfile/classLoader.hpp&quot;
  30 #include &quot;classfile/classLoaderData.inline.hpp&quot;
  31 #include &quot;classfile/defaultMethods.hpp&quot;
  32 #include &quot;classfile/dictionary.hpp&quot;
  33 #include &quot;classfile/javaClasses.inline.hpp&quot;
  34 #include &quot;classfile/moduleEntry.hpp&quot;
  35 #include &quot;classfile/symbolTable.hpp&quot;
  36 #include &quot;classfile/systemDictionary.hpp&quot;
  37 #if INCLUDE_TSAN
  38 #include &quot;classfile/tsanIgnoreList.hpp&quot;
  39 #endif // INCLUDE_TSAN
  40 #include &quot;classfile/verificationType.hpp&quot;
  41 #include &quot;classfile/verifier.hpp&quot;
  42 #include &quot;classfile/vmSymbols.hpp&quot;
  43 #include &quot;logging/log.hpp&quot;
  44 #include &quot;logging/logStream.hpp&quot;
  45 #include &quot;memory/allocation.hpp&quot;
  46 #include &quot;memory/metadataFactory.hpp&quot;
  47 #include &quot;memory/oopFactory.hpp&quot;
  48 #include &quot;memory/resourceArea.hpp&quot;
  49 #include &quot;memory/universe.hpp&quot;
  50 #include &quot;oops/annotations.hpp&quot;
  51 #include &quot;oops/constantPool.inline.hpp&quot;
  52 #include &quot;oops/fieldStreams.hpp&quot;
  53 #include &quot;oops/instanceKlass.hpp&quot;
  54 #include &quot;oops/instanceMirrorKlass.hpp&quot;
  55 #include &quot;oops/klass.inline.hpp&quot;
  56 #include &quot;oops/klassVtable.hpp&quot;
  57 #include &quot;oops/metadata.hpp&quot;
  58 #include &quot;oops/method.inline.hpp&quot;
  59 #include &quot;oops/oop.inline.hpp&quot;
  60 #include &quot;oops/symbol.hpp&quot;
  61 #include &quot;prims/jvmtiExport.hpp&quot;
  62 #include &quot;prims/jvmtiThreadState.hpp&quot;
  63 #include &quot;runtime/arguments.hpp&quot;
  64 #include &quot;runtime/handles.inline.hpp&quot;
  65 #include &quot;runtime/javaCalls.hpp&quot;
  66 #include &quot;runtime/os.hpp&quot;
  67 #include &quot;runtime/perfData.hpp&quot;
  68 #include &quot;runtime/reflection.hpp&quot;
  69 #include &quot;runtime/safepointVerifiers.hpp&quot;
  70 #include &quot;runtime/signature.hpp&quot;
  71 #include &quot;runtime/timer.hpp&quot;
  72 #include &quot;services/classLoadingService.hpp&quot;
  73 #include &quot;services/threadService.hpp&quot;
  74 #include &quot;utilities/align.hpp&quot;
  75 #include &quot;utilities/bitMap.inline.hpp&quot;
  76 #include &quot;utilities/copy.hpp&quot;
  77 #include &quot;utilities/exceptions.hpp&quot;
  78 #include &quot;utilities/globalDefinitions.hpp&quot;
  79 #include &quot;utilities/growableArray.hpp&quot;
  80 #include &quot;utilities/macros.hpp&quot;
  81 #include &quot;utilities/ostream.hpp&quot;
  82 #include &quot;utilities/resourceHash.hpp&quot;
  83 #if INCLUDE_CDS
  84 #include &quot;classfile/systemDictionaryShared.hpp&quot;
  85 #endif
  86 #if INCLUDE_JFR
  87 #include &quot;jfr/support/jfrTraceIdExtension.hpp&quot;
  88 #endif
  89 
  90 // We generally try to create the oops directly when parsing, rather than
  91 // allocating temporary data structures and copying the bytes twice. A
  92 // temporary area is only needed when parsing utf8 entries in the constant
  93 // pool and when parsing line number tables.
  94 
  95 // We add assert in debug mode when class format is not checked.
  96 
  97 #define JAVA_CLASSFILE_MAGIC              0xCAFEBABE
  98 #define JAVA_MIN_SUPPORTED_VERSION        45
  99 #define JAVA_PREVIEW_MINOR_VERSION        65535
 100 
 101 // Used for two backward compatibility reasons:
 102 // - to check for new additions to the class file format in JDK1.5
 103 // - to check for bug fixes in the format checker in JDK1.5
 104 #define JAVA_1_5_VERSION                  49
 105 
 106 // Used for backward compatibility reasons:
 107 // - to check for javac bug fixes that happened after 1.5
 108 // - also used as the max version when running in jdk6
 109 #define JAVA_6_VERSION                    50
 110 
 111 // Used for backward compatibility reasons:
 112 // - to disallow argument and require ACC_STATIC for &lt;clinit&gt; methods
 113 #define JAVA_7_VERSION                    51
 114 
 115 // Extension method support.
 116 #define JAVA_8_VERSION                    52
 117 
 118 #define JAVA_9_VERSION                    53
 119 
 120 #define JAVA_10_VERSION                   54
 121 
 122 #define JAVA_11_VERSION                   55
 123 
 124 #define JAVA_12_VERSION                   56
 125 
 126 #define JAVA_13_VERSION                   57
 127 
 128 void ClassFileParser::set_class_bad_constant_seen(short bad_constant) {
 129   assert((bad_constant == 19 || bad_constant == 20) &amp;&amp; _major_version &gt;= JAVA_9_VERSION,
 130          &quot;Unexpected bad constant pool entry&quot;);
 131   if (_bad_constant_seen == 0) _bad_constant_seen = bad_constant;
 132 }
 133 
 134 void ClassFileParser::parse_constant_pool_entries(const ClassFileStream* const stream,
 135                                                   ConstantPool* cp,
 136                                                   const int length,
 137                                                   TRAPS) {
 138   assert(stream != NULL, &quot;invariant&quot;);
 139   assert(cp != NULL, &quot;invariant&quot;);
 140 
 141   // Use a local copy of ClassFileStream. It helps the C++ compiler to optimize
 142   // this function (_current can be allocated in a register, with scalar
 143   // replacement of aggregates). The _current pointer is copied back to
 144   // stream() when this function returns. DON&#39;T call another method within
 145   // this method that uses stream().
 146   const ClassFileStream cfs1 = *stream;
 147   const ClassFileStream* const cfs = &amp;cfs1;
 148 
 149   assert(cfs-&gt;allocated_on_stack(), &quot;should be local&quot;);
 150   debug_only(const u1* const old_current = stream-&gt;current();)
 151 
 152   // Used for batching symbol allocations.
 153   const char* names[SymbolTable::symbol_alloc_batch_size];
 154   int lengths[SymbolTable::symbol_alloc_batch_size];
 155   int indices[SymbolTable::symbol_alloc_batch_size];
 156   unsigned int hashValues[SymbolTable::symbol_alloc_batch_size];
 157   int names_count = 0;
 158 
 159   // parsing  Index 0 is unused
 160   for (int index = 1; index &lt; length; index++) {
 161     // Each of the following case guarantees one more byte in the stream
 162     // for the following tag or the access_flags following constant pool,
 163     // so we don&#39;t need bounds-check for reading tag.
 164     const u1 tag = cfs-&gt;get_u1_fast();
 165     switch (tag) {
 166       case JVM_CONSTANT_Class : {
 167         cfs-&gt;guarantee_more(3, CHECK);  // name_index, tag/access_flags
 168         const u2 name_index = cfs-&gt;get_u2_fast();
 169         cp-&gt;klass_index_at_put(index, name_index);
 170         break;
 171       }
 172       case JVM_CONSTANT_Fieldref: {
 173         cfs-&gt;guarantee_more(5, CHECK);  // class_index, name_and_type_index, tag/access_flags
 174         const u2 class_index = cfs-&gt;get_u2_fast();
 175         const u2 name_and_type_index = cfs-&gt;get_u2_fast();
 176         cp-&gt;field_at_put(index, class_index, name_and_type_index);
 177         break;
 178       }
 179       case JVM_CONSTANT_Methodref: {
 180         cfs-&gt;guarantee_more(5, CHECK);  // class_index, name_and_type_index, tag/access_flags
 181         const u2 class_index = cfs-&gt;get_u2_fast();
 182         const u2 name_and_type_index = cfs-&gt;get_u2_fast();
 183         cp-&gt;method_at_put(index, class_index, name_and_type_index);
 184         break;
 185       }
 186       case JVM_CONSTANT_InterfaceMethodref: {
 187         cfs-&gt;guarantee_more(5, CHECK);  // class_index, name_and_type_index, tag/access_flags
 188         const u2 class_index = cfs-&gt;get_u2_fast();
 189         const u2 name_and_type_index = cfs-&gt;get_u2_fast();
 190         cp-&gt;interface_method_at_put(index, class_index, name_and_type_index);
 191         break;
 192       }
 193       case JVM_CONSTANT_String : {
 194         cfs-&gt;guarantee_more(3, CHECK);  // string_index, tag/access_flags
 195         const u2 string_index = cfs-&gt;get_u2_fast();
 196         cp-&gt;string_index_at_put(index, string_index);
 197         break;
 198       }
 199       case JVM_CONSTANT_MethodHandle :
 200       case JVM_CONSTANT_MethodType: {
 201         if (_major_version &lt; Verifier::INVOKEDYNAMIC_MAJOR_VERSION) {
 202           classfile_parse_error(
 203             &quot;Class file version does not support constant tag %u in class file %s&quot;,
 204             tag, CHECK);
 205         }
 206         if (tag == JVM_CONSTANT_MethodHandle) {
 207           cfs-&gt;guarantee_more(4, CHECK);  // ref_kind, method_index, tag/access_flags
 208           const u1 ref_kind = cfs-&gt;get_u1_fast();
 209           const u2 method_index = cfs-&gt;get_u2_fast();
 210           cp-&gt;method_handle_index_at_put(index, ref_kind, method_index);
 211         }
 212         else if (tag == JVM_CONSTANT_MethodType) {
 213           cfs-&gt;guarantee_more(3, CHECK);  // signature_index, tag/access_flags
 214           const u2 signature_index = cfs-&gt;get_u2_fast();
 215           cp-&gt;method_type_index_at_put(index, signature_index);
 216         }
 217         else {
 218           ShouldNotReachHere();
 219         }
 220         break;
 221       }
 222       case JVM_CONSTANT_Dynamic : {
 223         if (_major_version &lt; Verifier::DYNAMICCONSTANT_MAJOR_VERSION) {
 224           classfile_parse_error(
 225               &quot;Class file version does not support constant tag %u in class file %s&quot;,
 226               tag, CHECK);
 227         }
 228         cfs-&gt;guarantee_more(5, CHECK);  // bsm_index, nt, tag/access_flags
 229         const u2 bootstrap_specifier_index = cfs-&gt;get_u2_fast();
 230         const u2 name_and_type_index = cfs-&gt;get_u2_fast();
 231         if (_max_bootstrap_specifier_index &lt; (int) bootstrap_specifier_index) {
 232           _max_bootstrap_specifier_index = (int) bootstrap_specifier_index;  // collect for later
 233         }
 234         cp-&gt;dynamic_constant_at_put(index, bootstrap_specifier_index, name_and_type_index);
 235         break;
 236       }
 237       case JVM_CONSTANT_InvokeDynamic : {
 238         if (_major_version &lt; Verifier::INVOKEDYNAMIC_MAJOR_VERSION) {
 239           classfile_parse_error(
 240               &quot;Class file version does not support constant tag %u in class file %s&quot;,
 241               tag, CHECK);
 242         }
 243         cfs-&gt;guarantee_more(5, CHECK);  // bsm_index, nt, tag/access_flags
 244         const u2 bootstrap_specifier_index = cfs-&gt;get_u2_fast();
 245         const u2 name_and_type_index = cfs-&gt;get_u2_fast();
 246         if (_max_bootstrap_specifier_index &lt; (int) bootstrap_specifier_index) {
 247           _max_bootstrap_specifier_index = (int) bootstrap_specifier_index;  // collect for later
 248         }
 249         cp-&gt;invoke_dynamic_at_put(index, bootstrap_specifier_index, name_and_type_index);
 250         break;
 251       }
 252       case JVM_CONSTANT_Integer: {
 253         cfs-&gt;guarantee_more(5, CHECK);  // bytes, tag/access_flags
 254         const u4 bytes = cfs-&gt;get_u4_fast();
 255         cp-&gt;int_at_put(index, (jint)bytes);
 256         break;
 257       }
 258       case JVM_CONSTANT_Float: {
 259         cfs-&gt;guarantee_more(5, CHECK);  // bytes, tag/access_flags
 260         const u4 bytes = cfs-&gt;get_u4_fast();
 261         cp-&gt;float_at_put(index, *(jfloat*)&amp;bytes);
 262         break;
 263       }
 264       case JVM_CONSTANT_Long: {
 265         // A mangled type might cause you to overrun allocated memory
 266         guarantee_property(index + 1 &lt; length,
 267                            &quot;Invalid constant pool entry %u in class file %s&quot;,
 268                            index,
 269                            CHECK);
 270         cfs-&gt;guarantee_more(9, CHECK);  // bytes, tag/access_flags
 271         const u8 bytes = cfs-&gt;get_u8_fast();
 272         cp-&gt;long_at_put(index, bytes);
 273         index++;   // Skip entry following eigth-byte constant, see JVM book p. 98
 274         break;
 275       }
 276       case JVM_CONSTANT_Double: {
 277         // A mangled type might cause you to overrun allocated memory
 278         guarantee_property(index+1 &lt; length,
 279                            &quot;Invalid constant pool entry %u in class file %s&quot;,
 280                            index,
 281                            CHECK);
 282         cfs-&gt;guarantee_more(9, CHECK);  // bytes, tag/access_flags
 283         const u8 bytes = cfs-&gt;get_u8_fast();
 284         cp-&gt;double_at_put(index, *(jdouble*)&amp;bytes);
 285         index++;   // Skip entry following eigth-byte constant, see JVM book p. 98
 286         break;
 287       }
 288       case JVM_CONSTANT_NameAndType: {
 289         cfs-&gt;guarantee_more(5, CHECK);  // name_index, signature_index, tag/access_flags
 290         const u2 name_index = cfs-&gt;get_u2_fast();
 291         const u2 signature_index = cfs-&gt;get_u2_fast();
 292         cp-&gt;name_and_type_at_put(index, name_index, signature_index);
 293         break;
 294       }
 295       case JVM_CONSTANT_Utf8 : {
 296         cfs-&gt;guarantee_more(2, CHECK);  // utf8_length
 297         u2  utf8_length = cfs-&gt;get_u2_fast();
 298         const u1* utf8_buffer = cfs-&gt;current();
 299         assert(utf8_buffer != NULL, &quot;null utf8 buffer&quot;);
 300         // Got utf8 string, guarantee utf8_length+1 bytes, set stream position forward.
 301         cfs-&gt;guarantee_more(utf8_length+1, CHECK);  // utf8 string, tag/access_flags
 302         cfs-&gt;skip_u1_fast(utf8_length);
 303 
 304         // Before storing the symbol, make sure it&#39;s legal
 305         if (_need_verify) {
 306           verify_legal_utf8(utf8_buffer, utf8_length, CHECK);
 307         }
 308 
 309         if (has_cp_patch_at(index)) {
 310           Handle patch = clear_cp_patch_at(index);
 311           guarantee_property(java_lang_String::is_instance(patch()),
 312                              &quot;Illegal utf8 patch at %d in class file %s&quot;,
 313                              index,
 314                              CHECK);
 315           const char* const str = java_lang_String::as_utf8_string(patch());
 316           // (could use java_lang_String::as_symbol instead, but might as well batch them)
 317           utf8_buffer = (const u1*) str;
 318           utf8_length = (int) strlen(str);
 319         }
 320 
 321         unsigned int hash;
 322         Symbol* const result = SymbolTable::lookup_only((const char*)utf8_buffer,
 323                                                         utf8_length,
 324                                                         hash);
 325         if (result == NULL) {
 326           names[names_count] = (const char*)utf8_buffer;
 327           lengths[names_count] = utf8_length;
 328           indices[names_count] = index;
 329           hashValues[names_count++] = hash;
 330           if (names_count == SymbolTable::symbol_alloc_batch_size) {
 331             SymbolTable::new_symbols(_loader_data,
 332                                      cp,
 333                                      names_count,
 334                                      names,
 335                                      lengths,
 336                                      indices,
 337                                      hashValues,
 338                                      CHECK);
 339             names_count = 0;
 340           }
 341         } else {
 342           cp-&gt;symbol_at_put(index, result);
 343         }
 344         break;
 345       }
 346       case 19:
 347       case 20: {
 348         // Record that an error occurred in these two cases but keep parsing so
 349         // that ACC_Module can be checked for in the access_flags.  Need to
 350         // throw NoClassDefFoundError in that case.
 351         if (_major_version &gt;= JAVA_9_VERSION) {
 352           cfs-&gt;guarantee_more(3, CHECK);
 353           cfs-&gt;get_u2_fast();
 354           set_class_bad_constant_seen(tag);
 355           break;
 356         }
 357       }
 358       default: {
 359         classfile_parse_error(&quot;Unknown constant tag %u in class file %s&quot;,
 360                               tag,
 361                               CHECK);
 362         break;
 363       }
 364     } // end of switch(tag)
 365   } // end of for
 366 
 367   // Allocate the remaining symbols
 368   if (names_count &gt; 0) {
 369     SymbolTable::new_symbols(_loader_data,
 370                              cp,
 371                              names_count,
 372                              names,
 373                              lengths,
 374                              indices,
 375                              hashValues,
 376                              CHECK);
 377   }
 378 
 379   // Copy _current pointer of local copy back to stream.
 380   assert(stream-&gt;current() == old_current, &quot;non-exclusive use of stream&quot;);
 381   stream-&gt;set_current(cfs1.current());
 382 
 383 }
 384 
 385 static inline bool valid_cp_range(int index, int length) {
 386   return (index &gt; 0 &amp;&amp; index &lt; length);
 387 }
 388 
 389 static inline Symbol* check_symbol_at(const ConstantPool* cp, int index) {
 390   assert(cp != NULL, &quot;invariant&quot;);
 391   if (valid_cp_range(index, cp-&gt;length()) &amp;&amp; cp-&gt;tag_at(index).is_utf8()) {
 392     return cp-&gt;symbol_at(index);
 393   }
 394   return NULL;
 395 }
 396 
 397 #ifdef ASSERT
 398 PRAGMA_DIAG_PUSH
 399 PRAGMA_FORMAT_NONLITERAL_IGNORED
 400 void ClassFileParser::report_assert_property_failure(const char* msg, TRAPS) const {
 401   ResourceMark rm(THREAD);
 402   fatal(msg, _class_name-&gt;as_C_string());
 403 }
 404 
 405 void ClassFileParser::report_assert_property_failure(const char* msg,
 406                                                      int index,
 407                                                      TRAPS) const {
 408   ResourceMark rm(THREAD);
 409   fatal(msg, index, _class_name-&gt;as_C_string());
 410 }
 411 PRAGMA_DIAG_POP
 412 #endif
 413 
 414 void ClassFileParser::parse_constant_pool(const ClassFileStream* const stream,
 415                                          ConstantPool* const cp,
 416                                          const int length,
 417                                          TRAPS) {
 418   assert(cp != NULL, &quot;invariant&quot;);
 419   assert(stream != NULL, &quot;invariant&quot;);
 420 
 421   // parsing constant pool entries
 422   parse_constant_pool_entries(stream, cp, length, CHECK);
 423   if (class_bad_constant_seen() != 0) {
 424     // a bad CP entry has been detected previously so stop parsing and just return.
 425     return;
 426   }
 427 
 428   int index = 1;  // declared outside of loops for portability
 429   int num_klasses = 0;
 430 
 431   // first verification pass - validate cross references
 432   // and fixup class and string constants
 433   for (index = 1; index &lt; length; index++) {          // Index 0 is unused
 434     const jbyte tag = cp-&gt;tag_at(index).value();
 435     switch (tag) {
 436       case JVM_CONSTANT_Class: {
 437         ShouldNotReachHere();     // Only JVM_CONSTANT_ClassIndex should be present
 438         break;
 439       }
 440       case JVM_CONSTANT_Fieldref:
 441         // fall through
 442       case JVM_CONSTANT_Methodref:
 443         // fall through
 444       case JVM_CONSTANT_InterfaceMethodref: {
 445         if (!_need_verify) break;
 446         const int klass_ref_index = cp-&gt;klass_ref_index_at(index);
 447         const int name_and_type_ref_index = cp-&gt;name_and_type_ref_index_at(index);
 448         check_property(valid_klass_reference_at(klass_ref_index),
 449                        &quot;Invalid constant pool index %u in class file %s&quot;,
 450                        klass_ref_index, CHECK);
 451         check_property(valid_cp_range(name_and_type_ref_index, length) &amp;&amp;
 452           cp-&gt;tag_at(name_and_type_ref_index).is_name_and_type(),
 453           &quot;Invalid constant pool index %u in class file %s&quot;,
 454           name_and_type_ref_index, CHECK);
 455         break;
 456       }
 457       case JVM_CONSTANT_String: {
 458         ShouldNotReachHere();     // Only JVM_CONSTANT_StringIndex should be present
 459         break;
 460       }
 461       case JVM_CONSTANT_Integer:
 462         break;
 463       case JVM_CONSTANT_Float:
 464         break;
 465       case JVM_CONSTANT_Long:
 466       case JVM_CONSTANT_Double: {
 467         index++;
 468         check_property(
 469           (index &lt; length &amp;&amp; cp-&gt;tag_at(index).is_invalid()),
 470           &quot;Improper constant pool long/double index %u in class file %s&quot;,
 471           index, CHECK);
 472         break;
 473       }
 474       case JVM_CONSTANT_NameAndType: {
 475         if (!_need_verify) break;
 476         const int name_ref_index = cp-&gt;name_ref_index_at(index);
 477         const int signature_ref_index = cp-&gt;signature_ref_index_at(index);
 478         check_property(valid_symbol_at(name_ref_index),
 479           &quot;Invalid constant pool index %u in class file %s&quot;,
 480           name_ref_index, CHECK);
 481         check_property(valid_symbol_at(signature_ref_index),
 482           &quot;Invalid constant pool index %u in class file %s&quot;,
 483           signature_ref_index, CHECK);
 484         break;
 485       }
 486       case JVM_CONSTANT_Utf8:
 487         break;
 488       case JVM_CONSTANT_UnresolvedClass:         // fall-through
 489       case JVM_CONSTANT_UnresolvedClassInError: {
 490         ShouldNotReachHere();     // Only JVM_CONSTANT_ClassIndex should be present
 491         break;
 492       }
 493       case JVM_CONSTANT_ClassIndex: {
 494         const int class_index = cp-&gt;klass_index_at(index);
 495         check_property(valid_symbol_at(class_index),
 496           &quot;Invalid constant pool index %u in class file %s&quot;,
 497           class_index, CHECK);
 498         cp-&gt;unresolved_klass_at_put(index, class_index, num_klasses++);
 499         break;
 500       }
 501       case JVM_CONSTANT_StringIndex: {
 502         const int string_index = cp-&gt;string_index_at(index);
 503         check_property(valid_symbol_at(string_index),
 504           &quot;Invalid constant pool index %u in class file %s&quot;,
 505           string_index, CHECK);
 506         Symbol* const sym = cp-&gt;symbol_at(string_index);
 507         cp-&gt;unresolved_string_at_put(index, sym);
 508         break;
 509       }
 510       case JVM_CONSTANT_MethodHandle: {
 511         const int ref_index = cp-&gt;method_handle_index_at(index);
 512         check_property(valid_cp_range(ref_index, length),
 513           &quot;Invalid constant pool index %u in class file %s&quot;,
 514           ref_index, CHECK);
 515         const constantTag tag = cp-&gt;tag_at(ref_index);
 516         const int ref_kind = cp-&gt;method_handle_ref_kind_at(index);
 517 
 518         switch (ref_kind) {
 519           case JVM_REF_getField:
 520           case JVM_REF_getStatic:
 521           case JVM_REF_putField:
 522           case JVM_REF_putStatic: {
 523             check_property(
 524               tag.is_field(),
 525               &quot;Invalid constant pool index %u in class file %s (not a field)&quot;,
 526               ref_index, CHECK);
 527             break;
 528           }
 529           case JVM_REF_invokeVirtual:
 530           case JVM_REF_newInvokeSpecial: {
 531             check_property(
 532               tag.is_method(),
 533               &quot;Invalid constant pool index %u in class file %s (not a method)&quot;,
 534               ref_index, CHECK);
 535             break;
 536           }
 537           case JVM_REF_invokeStatic:
 538           case JVM_REF_invokeSpecial: {
 539             check_property(
 540               tag.is_method() ||
 541               ((_major_version &gt;= JAVA_8_VERSION) &amp;&amp; tag.is_interface_method()),
 542               &quot;Invalid constant pool index %u in class file %s (not a method)&quot;,
 543               ref_index, CHECK);
 544             break;
 545           }
 546           case JVM_REF_invokeInterface: {
 547             check_property(
 548               tag.is_interface_method(),
 549               &quot;Invalid constant pool index %u in class file %s (not an interface method)&quot;,
 550               ref_index, CHECK);
 551             break;
 552           }
 553           default: {
 554             classfile_parse_error(
 555               &quot;Bad method handle kind at constant pool index %u in class file %s&quot;,
 556               index, CHECK);
 557           }
 558         } // switch(refkind)
 559         // Keep the ref_index unchanged.  It will be indirected at link-time.
 560         break;
 561       } // case MethodHandle
 562       case JVM_CONSTANT_MethodType: {
 563         const int ref_index = cp-&gt;method_type_index_at(index);
 564         check_property(valid_symbol_at(ref_index),
 565           &quot;Invalid constant pool index %u in class file %s&quot;,
 566           ref_index, CHECK);
 567         break;
 568       }
 569       case JVM_CONSTANT_Dynamic: {
 570         const int name_and_type_ref_index =
 571           cp-&gt;bootstrap_name_and_type_ref_index_at(index);
 572 
 573         check_property(valid_cp_range(name_and_type_ref_index, length) &amp;&amp;
 574           cp-&gt;tag_at(name_and_type_ref_index).is_name_and_type(),
 575           &quot;Invalid constant pool index %u in class file %s&quot;,
 576           name_and_type_ref_index, CHECK);
 577         // bootstrap specifier index must be checked later,
 578         // when BootstrapMethods attr is available
 579 
 580         // Mark the constant pool as having a CONSTANT_Dynamic_info structure
 581         cp-&gt;set_has_dynamic_constant();
 582         break;
 583       }
 584       case JVM_CONSTANT_InvokeDynamic: {
 585         const int name_and_type_ref_index =
 586           cp-&gt;bootstrap_name_and_type_ref_index_at(index);
 587 
 588         check_property(valid_cp_range(name_and_type_ref_index, length) &amp;&amp;
 589           cp-&gt;tag_at(name_and_type_ref_index).is_name_and_type(),
 590           &quot;Invalid constant pool index %u in class file %s&quot;,
 591           name_and_type_ref_index, CHECK);
 592         // bootstrap specifier index must be checked later,
 593         // when BootstrapMethods attr is available
 594         break;
 595       }
 596       default: {
 597         fatal(&quot;bad constant pool tag value %u&quot;, cp-&gt;tag_at(index).value());
 598         ShouldNotReachHere();
 599         break;
 600       }
 601     } // switch(tag)
 602   } // end of for
 603 
 604   _first_patched_klass_resolved_index = num_klasses;
 605   cp-&gt;allocate_resolved_klasses(_loader_data, num_klasses + _max_num_patched_klasses, CHECK);
 606 
 607   if (_cp_patches != NULL) {
 608     // need to treat this_class specially...
 609 
 610     // Add dummy utf8 entries in the space reserved for names of patched classes. We&#39;ll use &quot;*&quot;
 611     // for now. These will be replaced with actual names of the patched classes in patch_class().
 612     Symbol* s = vmSymbols::star_name();
 613     for (int n=_orig_cp_size; n&lt;cp-&gt;length(); n++) {
 614       cp-&gt;symbol_at_put(n, s);
 615     }
 616 
 617     int this_class_index;
 618     {
 619       stream-&gt;guarantee_more(8, CHECK);  // flags, this_class, super_class, infs_len
 620       const u1* const mark = stream-&gt;current();
 621       stream-&gt;skip_u2_fast(1); // skip flags
 622       this_class_index = stream-&gt;get_u2_fast();
 623       stream-&gt;set_current(mark);  // revert to mark
 624     }
 625 
 626     for (index = 1; index &lt; length; index++) {          // Index 0 is unused
 627       if (has_cp_patch_at(index)) {
 628         guarantee_property(index != this_class_index,
 629           &quot;Illegal constant pool patch to self at %d in class file %s&quot;,
 630           index, CHECK);
 631         patch_constant_pool(cp, index, cp_patch_at(index), CHECK);
 632       }
 633     }
 634   }
 635 
 636   if (!_need_verify) {
 637     return;
 638   }
 639 
 640   // second verification pass - checks the strings are of the right format.
 641   // but not yet to the other entries
 642   for (index = 1; index &lt; length; index++) {
 643     const jbyte tag = cp-&gt;tag_at(index).value();
 644     switch (tag) {
 645       case JVM_CONSTANT_UnresolvedClass: {
 646         const Symbol* const class_name = cp-&gt;klass_name_at(index);
 647         // check the name, even if _cp_patches will overwrite it
 648         verify_legal_class_name(class_name, CHECK);
 649         break;
 650       }
 651       case JVM_CONSTANT_NameAndType: {
 652         if (_need_verify) {
 653           const int sig_index = cp-&gt;signature_ref_index_at(index);
 654           const int name_index = cp-&gt;name_ref_index_at(index);
 655           const Symbol* const name = cp-&gt;symbol_at(name_index);
 656           const Symbol* const sig = cp-&gt;symbol_at(sig_index);
 657           guarantee_property(sig-&gt;utf8_length() != 0,
 658             &quot;Illegal zero length constant pool entry at %d in class %s&quot;,
 659             sig_index, CHECK);
 660           guarantee_property(name-&gt;utf8_length() != 0,
 661             &quot;Illegal zero length constant pool entry at %d in class %s&quot;,
 662             name_index, CHECK);
 663 
 664           if (sig-&gt;char_at(0) == JVM_SIGNATURE_FUNC) {
 665             // Format check method name and signature
 666             verify_legal_method_name(name, CHECK);
 667             verify_legal_method_signature(name, sig, CHECK);
 668           } else {
 669             // Format check field name and signature
 670             verify_legal_field_name(name, CHECK);
 671             verify_legal_field_signature(name, sig, CHECK);
 672           }
 673         }
 674         break;
 675       }
 676       case JVM_CONSTANT_Dynamic: {
 677         const int name_and_type_ref_index =
 678           cp-&gt;name_and_type_ref_index_at(index);
 679         // already verified to be utf8
 680         const int name_ref_index =
 681           cp-&gt;name_ref_index_at(name_and_type_ref_index);
 682         // already verified to be utf8
 683         const int signature_ref_index =
 684           cp-&gt;signature_ref_index_at(name_and_type_ref_index);
 685         const Symbol* const name = cp-&gt;symbol_at(name_ref_index);
 686         const Symbol* const signature = cp-&gt;symbol_at(signature_ref_index);
 687         if (_need_verify) {
 688           // CONSTANT_Dynamic&#39;s name and signature are verified above, when iterating NameAndType_info.
 689           // Need only to be sure signature is non-zero length and the right type.
 690           if (signature-&gt;utf8_length() == 0 ||
 691               signature-&gt;char_at(0) == JVM_SIGNATURE_FUNC) {
 692             throwIllegalSignature(&quot;CONSTANT_Dynamic&quot;, name, signature, CHECK);
 693           }
 694         }
 695         break;
 696       }
 697       case JVM_CONSTANT_InvokeDynamic:
 698       case JVM_CONSTANT_Fieldref:
 699       case JVM_CONSTANT_Methodref:
 700       case JVM_CONSTANT_InterfaceMethodref: {
 701         const int name_and_type_ref_index =
 702           cp-&gt;name_and_type_ref_index_at(index);
 703         // already verified to be utf8
 704         const int name_ref_index =
 705           cp-&gt;name_ref_index_at(name_and_type_ref_index);
 706         // already verified to be utf8
 707         const int signature_ref_index =
 708           cp-&gt;signature_ref_index_at(name_and_type_ref_index);
 709         const Symbol* const name = cp-&gt;symbol_at(name_ref_index);
 710         const Symbol* const signature = cp-&gt;symbol_at(signature_ref_index);
 711         if (tag == JVM_CONSTANT_Fieldref) {
 712           if (_need_verify) {
 713             // Field name and signature are verified above, when iterating NameAndType_info.
 714             // Need only to be sure signature is non-zero length and the right type.
 715             if (signature-&gt;utf8_length() == 0 ||
 716                 signature-&gt;char_at(0) == JVM_SIGNATURE_FUNC) {
 717               throwIllegalSignature(&quot;Field&quot;, name, signature, CHECK);
 718             }
 719           }
 720         } else {
 721           if (_need_verify) {
 722             // Method name and signature are verified above, when iterating NameAndType_info.
 723             // Need only to be sure signature is non-zero length and the right type.
 724             if (signature-&gt;utf8_length() == 0 ||
 725                 signature-&gt;char_at(0) != JVM_SIGNATURE_FUNC) {
 726               throwIllegalSignature(&quot;Method&quot;, name, signature, CHECK);
 727             }
 728           }
 729           // 4509014: If a class method name begins with &#39;&lt;&#39;, it must be &quot;&lt;init&gt;&quot;
 730           const unsigned int name_len = name-&gt;utf8_length();
 731           if (tag == JVM_CONSTANT_Methodref &amp;&amp;
 732               name_len != 0 &amp;&amp;
 733               name-&gt;char_at(0) == &#39;&lt;&#39; &amp;&amp;
 734               name != vmSymbols::object_initializer_name()) {
 735             classfile_parse_error(
 736               &quot;Bad method name at constant pool index %u in class file %s&quot;,
 737               name_ref_index, CHECK);
 738           }
 739         }
 740         break;
 741       }
 742       case JVM_CONSTANT_MethodHandle: {
 743         const int ref_index = cp-&gt;method_handle_index_at(index);
 744         const int ref_kind = cp-&gt;method_handle_ref_kind_at(index);
 745         switch (ref_kind) {
 746           case JVM_REF_invokeVirtual:
 747           case JVM_REF_invokeStatic:
 748           case JVM_REF_invokeSpecial:
 749           case JVM_REF_newInvokeSpecial: {
 750             const int name_and_type_ref_index =
 751               cp-&gt;name_and_type_ref_index_at(ref_index);
 752             const int name_ref_index =
 753               cp-&gt;name_ref_index_at(name_and_type_ref_index);
 754             const Symbol* const name = cp-&gt;symbol_at(name_ref_index);
 755             if (ref_kind == JVM_REF_newInvokeSpecial) {
 756               if (name != vmSymbols::object_initializer_name()) {
 757                 classfile_parse_error(
 758                   &quot;Bad constructor name at constant pool index %u in class file %s&quot;,
 759                     name_ref_index, CHECK);
 760               }
 761             } else {
 762               if (name == vmSymbols::object_initializer_name()) {
 763                 classfile_parse_error(
 764                   &quot;Bad method name at constant pool index %u in class file %s&quot;,
 765                   name_ref_index, CHECK);
 766               }
 767             }
 768             break;
 769           }
 770           // Other ref_kinds are already fully checked in previous pass.
 771         } // switch(ref_kind)
 772         break;
 773       }
 774       case JVM_CONSTANT_MethodType: {
 775         const Symbol* const no_name = vmSymbols::type_name(); // place holder
 776         const Symbol* const signature = cp-&gt;method_type_signature_at(index);
 777         verify_legal_method_signature(no_name, signature, CHECK);
 778         break;
 779       }
 780       case JVM_CONSTANT_Utf8: {
 781         assert(cp-&gt;symbol_at(index)-&gt;refcount() != 0, &quot;count corrupted&quot;);
 782       }
 783     }  // switch(tag)
 784   }  // end of for
 785 }
 786 
 787 Handle ClassFileParser::clear_cp_patch_at(int index) {
 788   Handle patch = cp_patch_at(index);
 789   _cp_patches-&gt;at_put(index, Handle());
 790   assert(!has_cp_patch_at(index), &quot;&quot;);
 791   return patch;
 792 }
 793 
 794 void ClassFileParser::patch_class(ConstantPool* cp, int class_index, Klass* k, Symbol* name) {
 795   int name_index = _orig_cp_size + _num_patched_klasses;
 796   int resolved_klass_index = _first_patched_klass_resolved_index + _num_patched_klasses;
 797 
 798   cp-&gt;klass_at_put(class_index, name_index, resolved_klass_index, k, name);
 799   _num_patched_klasses ++;
 800 }
 801 
 802 void ClassFileParser::patch_constant_pool(ConstantPool* cp,
 803                                           int index,
 804                                           Handle patch,
 805                                           TRAPS) {
 806   assert(cp != NULL, &quot;invariant&quot;);
 807 
 808   BasicType patch_type = T_VOID;
 809 
 810   switch (cp-&gt;tag_at(index).value()) {
 811 
 812     case JVM_CONSTANT_UnresolvedClass: {
 813       // Patching a class means pre-resolving it.
 814       // The name in the constant pool is ignored.
 815       if (java_lang_Class::is_instance(patch())) {
 816         guarantee_property(!java_lang_Class::is_primitive(patch()),
 817                            &quot;Illegal class patch at %d in class file %s&quot;,
 818                            index, CHECK);
 819         Klass* k = java_lang_Class::as_Klass(patch());
 820         patch_class(cp, index, k, k-&gt;name());
 821       } else {
 822         guarantee_property(java_lang_String::is_instance(patch()),
 823                            &quot;Illegal class patch at %d in class file %s&quot;,
 824                            index, CHECK);
 825         Symbol* const name = java_lang_String::as_symbol(patch(), CHECK);
 826         patch_class(cp, index, NULL, name);
 827       }
 828       break;
 829     }
 830 
 831     case JVM_CONSTANT_String: {
 832       // skip this patch and don&#39;t clear it.  Needs the oop array for resolved
 833       // references to be created first.
 834       return;
 835     }
 836     case JVM_CONSTANT_Integer: patch_type = T_INT;    goto patch_prim;
 837     case JVM_CONSTANT_Float:   patch_type = T_FLOAT;  goto patch_prim;
 838     case JVM_CONSTANT_Long:    patch_type = T_LONG;   goto patch_prim;
 839     case JVM_CONSTANT_Double:  patch_type = T_DOUBLE; goto patch_prim;
 840     patch_prim:
 841     {
 842       jvalue value;
 843       BasicType value_type = java_lang_boxing_object::get_value(patch(), &amp;value);
 844       guarantee_property(value_type == patch_type,
 845                          &quot;Illegal primitive patch at %d in class file %s&quot;,
 846                          index, CHECK);
 847       switch (value_type) {
 848         case T_INT:    cp-&gt;int_at_put(index,   value.i); break;
 849         case T_FLOAT:  cp-&gt;float_at_put(index, value.f); break;
 850         case T_LONG:   cp-&gt;long_at_put(index,  value.j); break;
 851         case T_DOUBLE: cp-&gt;double_at_put(index, value.d); break;
 852         default:       assert(false, &quot;&quot;);
 853       }
 854     } // end patch_prim label
 855     break;
 856 
 857     default: {
 858       // %%% TODO: put method handles into CONSTANT_InterfaceMethodref, etc.
 859       guarantee_property(!has_cp_patch_at(index),
 860                          &quot;Illegal unexpected patch at %d in class file %s&quot;,
 861                          index, CHECK);
 862       return;
 863     }
 864   } // end of switch(tag)
 865 
 866   // On fall-through, mark the patch as used.
 867   clear_cp_patch_at(index);
 868 }
 869 class NameSigHash: public ResourceObj {
 870  public:
 871   const Symbol*       _name;       // name
 872   const Symbol*       _sig;        // signature
 873   NameSigHash*  _next;             // Next entry in hash table
 874 };
 875 
 876 static const int HASH_ROW_SIZE = 256;
 877 
 878 static unsigned int hash(const Symbol* name, const Symbol* sig) {
 879   unsigned int raw_hash = 0;
 880   raw_hash += ((unsigned int)(uintptr_t)name) &gt;&gt; (LogHeapWordSize + 2);
 881   raw_hash += ((unsigned int)(uintptr_t)sig) &gt;&gt; LogHeapWordSize;
 882 
 883   return (raw_hash + (unsigned int)(uintptr_t)name) % HASH_ROW_SIZE;
 884 }
 885 
 886 
 887 static void initialize_hashtable(NameSigHash** table) {
 888   memset((void*)table, 0, sizeof(NameSigHash*) * HASH_ROW_SIZE);
 889 }
 890 // Return false if the name/sig combination is found in table.
 891 // Return true if no duplicate is found. And name/sig is added as a new entry in table.
 892 // The old format checker uses heap sort to find duplicates.
 893 // NOTE: caller should guarantee that GC doesn&#39;t happen during the life cycle
 894 // of table since we don&#39;t expect Symbol*&#39;s to move.
 895 static bool put_after_lookup(const Symbol* name, const Symbol* sig, NameSigHash** table) {
 896   assert(name != NULL, &quot;name in constant pool is NULL&quot;);
 897 
 898   // First lookup for duplicates
 899   int index = hash(name, sig);
 900   NameSigHash* entry = table[index];
 901   while (entry != NULL) {
 902     if (entry-&gt;_name == name &amp;&amp; entry-&gt;_sig == sig) {
 903       return false;
 904     }
 905     entry = entry-&gt;_next;
 906   }
 907 
 908   // No duplicate is found, allocate a new entry and fill it.
 909   entry = new NameSigHash();
 910   entry-&gt;_name = name;
 911   entry-&gt;_sig = sig;
 912 
 913   // Insert into hash table
 914   entry-&gt;_next = table[index];
 915   table[index] = entry;
 916 
 917   return true;
 918 }
 919 
 920 // Side-effects: populates the _local_interfaces field
 921 void ClassFileParser::parse_interfaces(const ClassFileStream* const stream,
 922                                        const int itfs_len,
 923                                        ConstantPool* const cp,
 924                                        bool* const has_nonstatic_concrete_methods,
 925                                        TRAPS) {
 926   assert(stream != NULL, &quot;invariant&quot;);
 927   assert(cp != NULL, &quot;invariant&quot;);
 928   assert(has_nonstatic_concrete_methods != NULL, &quot;invariant&quot;);
 929 
 930   if (itfs_len == 0) {
 931     _local_interfaces = Universe::the_empty_instance_klass_array();
 932   } else {
 933     assert(itfs_len &gt; 0, &quot;only called for len&gt;0&quot;);
 934     _local_interfaces = MetadataFactory::new_array&lt;InstanceKlass*&gt;(_loader_data, itfs_len, NULL, CHECK);
 935 
 936     int index;
 937     for (index = 0; index &lt; itfs_len; index++) {
 938       const u2 interface_index = stream-&gt;get_u2(CHECK);
 939       Klass* interf;
 940       check_property(
 941         valid_klass_reference_at(interface_index),
 942         &quot;Interface name has bad constant pool index %u in class file %s&quot;,
 943         interface_index, CHECK);
 944       if (cp-&gt;tag_at(interface_index).is_klass()) {
 945         interf = cp-&gt;resolved_klass_at(interface_index);
 946       } else {
 947         Symbol* const unresolved_klass  = cp-&gt;klass_name_at(interface_index);
 948 
 949         // Don&#39;t need to check legal name because it&#39;s checked when parsing constant pool.
 950         // But need to make sure it&#39;s not an array type.
 951         guarantee_property(unresolved_klass-&gt;char_at(0) != JVM_SIGNATURE_ARRAY,
 952                            &quot;Bad interface name in class file %s&quot;, CHECK);
 953 
 954         // Call resolve_super so classcircularity is checked
 955         interf = SystemDictionary::resolve_super_or_fail(
 956                                                   _class_name,
 957                                                   unresolved_klass,
 958                                                   Handle(THREAD, _loader_data-&gt;class_loader()),
 959                                                   _protection_domain,
 960                                                   false,
 961                                                   CHECK);
 962       }
 963 
 964       if (!interf-&gt;is_interface()) {
 965         THROW_MSG(vmSymbols::java_lang_IncompatibleClassChangeError(),
 966                   err_msg(&quot;class %s can not implement %s, because it is not an interface (%s)&quot;,
 967                           _class_name-&gt;as_klass_external_name(),
 968                           interf-&gt;external_name(),
 969                           interf-&gt;class_in_module_of_loader()));
 970       }
 971 
 972       if (InstanceKlass::cast(interf)-&gt;has_nonstatic_concrete_methods()) {
 973         *has_nonstatic_concrete_methods = true;
 974       }
 975       _local_interfaces-&gt;at_put(index, InstanceKlass::cast(interf));
 976     }
 977 
 978     if (!_need_verify || itfs_len &lt;= 1) {
 979       return;
 980     }
 981 
 982     // Check if there&#39;s any duplicates in interfaces
 983     ResourceMark rm(THREAD);
 984     NameSigHash** interface_names = NEW_RESOURCE_ARRAY_IN_THREAD(THREAD,
 985                                                                  NameSigHash*,
 986                                                                  HASH_ROW_SIZE);
 987     initialize_hashtable(interface_names);
 988     bool dup = false;
 989     const Symbol* name = NULL;
 990     {
 991       debug_only(NoSafepointVerifier nsv;)
 992       for (index = 0; index &lt; itfs_len; index++) {
 993         const InstanceKlass* const k = _local_interfaces-&gt;at(index);
 994         name = k-&gt;name();
 995         // If no duplicates, add (name, NULL) in hashtable interface_names.
 996         if (!put_after_lookup(name, NULL, interface_names)) {
 997           dup = true;
 998           break;
 999         }
1000       }
1001     }
1002     if (dup) {
1003       classfile_parse_error(&quot;Duplicate interface name \&quot;%s\&quot; in class file %s&quot;,
1004                              name-&gt;as_C_string(), CHECK);
1005     }
1006   }
1007 }
1008 
1009 void ClassFileParser::verify_constantvalue(const ConstantPool* const cp,
1010                                            int constantvalue_index,
1011                                            int signature_index,
1012                                            TRAPS) const {
1013   // Make sure the constant pool entry is of a type appropriate to this field
1014   guarantee_property(
1015     (constantvalue_index &gt; 0 &amp;&amp;
1016       constantvalue_index &lt; cp-&gt;length()),
1017     &quot;Bad initial value index %u in ConstantValue attribute in class file %s&quot;,
1018     constantvalue_index, CHECK);
1019 
1020   const constantTag value_type = cp-&gt;tag_at(constantvalue_index);
1021   switch(cp-&gt;basic_type_for_signature_at(signature_index)) {
1022     case T_LONG: {
1023       guarantee_property(value_type.is_long(),
1024                          &quot;Inconsistent constant value type in class file %s&quot;,
1025                          CHECK);
1026       break;
1027     }
1028     case T_FLOAT: {
1029       guarantee_property(value_type.is_float(),
1030                          &quot;Inconsistent constant value type in class file %s&quot;,
1031                          CHECK);
1032       break;
1033     }
1034     case T_DOUBLE: {
1035       guarantee_property(value_type.is_double(),
1036                          &quot;Inconsistent constant value type in class file %s&quot;,
1037                          CHECK);
1038       break;
1039     }
1040     case T_BYTE:
1041     case T_CHAR:
1042     case T_SHORT:
1043     case T_BOOLEAN:
1044     case T_INT: {
1045       guarantee_property(value_type.is_int(),
1046                          &quot;Inconsistent constant value type in class file %s&quot;,
1047                          CHECK);
1048       break;
1049     }
1050     case T_OBJECT: {
1051       guarantee_property((cp-&gt;symbol_at(signature_index)-&gt;equals(&quot;Ljava/lang/String;&quot;)
1052                          &amp;&amp; value_type.is_string()),
1053                          &quot;Bad string initial value in class file %s&quot;,
1054                          CHECK);
1055       break;
1056     }
1057     default: {
1058       classfile_parse_error(&quot;Unable to set initial value %u in class file %s&quot;,
1059                              constantvalue_index,
1060                              CHECK);
1061     }
1062   }
1063 }
1064 
1065 class AnnotationCollector : public ResourceObj{
1066 public:
1067   enum Location { _in_field, _in_method, _in_class };
1068   enum ID {
1069     _unknown = 0,
1070     _method_CallerSensitive,
1071     _method_ForceInline,
1072     _method_DontInline,
1073     _method_InjectedProfile,
1074     _method_LambdaForm_Compiled,
1075     _method_Hidden,
1076     _method_HotSpotIntrinsicCandidate,
1077     _jdk_internal_vm_annotation_Contended,
1078     _field_Stable,
1079     _field_TsanIgnore,
1080     _jdk_internal_vm_annotation_ReservedStackAccess,
1081     _annotation_LIMIT
1082   };
1083   const Location _location;
1084   int _annotations_present;
1085   u2 _contended_group;
1086 
1087   AnnotationCollector(Location location)
1088     : _location(location), _annotations_present(0)
1089   {
1090     assert((int)_annotation_LIMIT &lt;= (int)sizeof(_annotations_present) * BitsPerByte, &quot;&quot;);
1091   }
1092   // If this annotation name has an ID, report it (or _none).
1093   ID annotation_index(const ClassLoaderData* loader_data, const Symbol* name);
1094   // Set the annotation name:
1095   void set_annotation(ID id) {
1096     assert((int)id &gt;= 0 &amp;&amp; (int)id &lt; (int)_annotation_LIMIT, &quot;oob&quot;);
1097     _annotations_present |= nth_bit((int)id);
1098   }
1099 
1100   void remove_annotation(ID id) {
1101     assert((int)id &gt;= 0 &amp;&amp; (int)id &lt; (int)_annotation_LIMIT, &quot;oob&quot;);
1102     _annotations_present &amp;= ~nth_bit((int)id);
1103   }
1104 
1105   // Report if the annotation is present.
1106   bool has_any_annotations() const { return _annotations_present != 0; }
1107   bool has_annotation(ID id) const { return (nth_bit((int)id) &amp; _annotations_present) != 0; }
1108 
1109   void set_contended_group(u2 group) { _contended_group = group; }
1110   u2 contended_group() const { return _contended_group; }
1111 
1112   bool is_contended() const { return has_annotation(_jdk_internal_vm_annotation_Contended); }
1113 
1114   void set_stable(bool stable) { set_annotation(_field_Stable); }
1115   bool is_stable() const { return has_annotation(_field_Stable); }
1116 
1117 #if INCLUDE_TSAN
1118   void set_tsan_ignore(bool tsan_ignore) { set_annotation(_field_TsanIgnore); }
1119   bool is_tsan_ignore() const { return has_annotation(_field_TsanIgnore); }
1120 #endif  // INCLUDE_TSAN
1121 };
1122 
1123 // This class also doubles as a holder for metadata cleanup.
1124 class ClassFileParser::FieldAnnotationCollector : public AnnotationCollector {
1125 private:
1126   ClassLoaderData* _loader_data;
1127   AnnotationArray* _field_annotations;
1128   AnnotationArray* _field_type_annotations;
1129 public:
1130   FieldAnnotationCollector(ClassLoaderData* loader_data) :
1131     AnnotationCollector(_in_field),
1132     _loader_data(loader_data),
1133     _field_annotations(NULL),
1134     _field_type_annotations(NULL) {}
1135   ~FieldAnnotationCollector();
1136   void apply_to(FieldInfo* f);
1137   AnnotationArray* field_annotations()      { return _field_annotations; }
1138   AnnotationArray* field_type_annotations() { return _field_type_annotations; }
1139 
1140   void set_field_annotations(AnnotationArray* a)      { _field_annotations = a; }
1141   void set_field_type_annotations(AnnotationArray* a) { _field_type_annotations = a; }
1142 };
1143 
1144 class MethodAnnotationCollector : public AnnotationCollector{
1145 public:
1146   MethodAnnotationCollector() : AnnotationCollector(_in_method) { }
1147   void apply_to(const methodHandle&amp; m);
1148 };
1149 
1150 class ClassFileParser::ClassAnnotationCollector : public AnnotationCollector{
1151 public:
1152   ClassAnnotationCollector() : AnnotationCollector(_in_class) { }
1153   void apply_to(InstanceKlass* ik);
1154 };
1155 
1156 
1157 static int skip_annotation_value(const u1*, int, int); // fwd decl
1158 
1159 // Safely increment index by val if does not pass limit
1160 #define SAFE_ADD(index, limit, val) \
1161 if (index &gt;= limit - val) return limit; \
1162 index += val;
1163 
1164 // Skip an annotation.  Return &gt;=limit if there is any problem.
1165 static int skip_annotation(const u1* buffer, int limit, int index) {
1166   assert(buffer != NULL, &quot;invariant&quot;);
1167   // annotation := atype:u2 do(nmem:u2) {member:u2 value}
1168   // value := switch (tag:u1) { ... }
1169   SAFE_ADD(index, limit, 4); // skip atype and read nmem
1170   int nmem = Bytes::get_Java_u2((address)buffer + index - 2);
1171   while (--nmem &gt;= 0 &amp;&amp; index &lt; limit) {
1172     SAFE_ADD(index, limit, 2); // skip member
1173     index = skip_annotation_value(buffer, limit, index);
1174   }
1175   return index;
1176 }
1177 
1178 // Skip an annotation value.  Return &gt;=limit if there is any problem.
1179 static int skip_annotation_value(const u1* buffer, int limit, int index) {
1180   assert(buffer != NULL, &quot;invariant&quot;);
1181 
1182   // value := switch (tag:u1) {
1183   //   case B, C, I, S, Z, D, F, J, c: con:u2;
1184   //   case e: e_class:u2 e_name:u2;
1185   //   case s: s_con:u2;
1186   //   case [: do(nval:u2) {value};
1187   //   case @: annotation;
1188   //   case s: s_con:u2;
1189   // }
1190   SAFE_ADD(index, limit, 1); // read tag
1191   const u1 tag = buffer[index - 1];
1192   switch (tag) {
1193     case &#39;B&#39;:
1194     case &#39;C&#39;:
1195     case &#39;I&#39;:
1196     case &#39;S&#39;:
1197     case &#39;Z&#39;:
1198     case &#39;D&#39;:
1199     case &#39;F&#39;:
1200     case &#39;J&#39;:
1201     case &#39;c&#39;:
1202     case &#39;s&#39;:
1203       SAFE_ADD(index, limit, 2);  // skip con or s_con
1204       break;
1205     case &#39;e&#39;:
1206       SAFE_ADD(index, limit, 4);  // skip e_class, e_name
1207       break;
1208     case &#39;[&#39;:
1209     {
1210       SAFE_ADD(index, limit, 2); // read nval
1211       int nval = Bytes::get_Java_u2((address)buffer + index - 2);
1212       while (--nval &gt;= 0 &amp;&amp; index &lt; limit) {
1213         index = skip_annotation_value(buffer, limit, index);
1214       }
1215     }
1216     break;
1217     case &#39;@&#39;:
1218       index = skip_annotation(buffer, limit, index);
1219       break;
1220     default:
1221       return limit;  //  bad tag byte
1222   }
1223   return index;
1224 }
1225 
1226 // Sift through annotations, looking for those significant to the VM:
1227 static void parse_annotations(const ConstantPool* const cp,
1228                               const u1* buffer, int limit,
1229                               AnnotationCollector* coll,
1230                               ClassLoaderData* loader_data,
1231                               TRAPS) {
1232 
1233   assert(cp != NULL, &quot;invariant&quot;);
1234   assert(buffer != NULL, &quot;invariant&quot;);
1235   assert(coll != NULL, &quot;invariant&quot;);
1236   assert(loader_data != NULL, &quot;invariant&quot;);
1237 
1238   // annotations := do(nann:u2) {annotation}
1239   int index = 2; // read nann
1240   if (index &gt;= limit)  return;
1241   int nann = Bytes::get_Java_u2((address)buffer + index - 2);
1242   enum {  // initial annotation layout
1243     atype_off = 0,      // utf8 such as &#39;Ljava/lang/annotation/Retention;&#39;
1244     count_off = 2,      // u2   such as 1 (one value)
1245     member_off = 4,     // utf8 such as &#39;value&#39;
1246     tag_off = 6,        // u1   such as &#39;c&#39; (type) or &#39;e&#39; (enum)
1247     e_tag_val = &#39;e&#39;,
1248     e_type_off = 7,   // utf8 such as &#39;Ljava/lang/annotation/RetentionPolicy;&#39;
1249     e_con_off = 9,    // utf8 payload, such as &#39;SOURCE&#39;, &#39;CLASS&#39;, &#39;RUNTIME&#39;
1250     e_size = 11,     // end of &#39;e&#39; annotation
1251     c_tag_val = &#39;c&#39;,    // payload is type
1252     c_con_off = 7,    // utf8 payload, such as &#39;I&#39;
1253     c_size = 9,       // end of &#39;c&#39; annotation
1254     s_tag_val = &#39;s&#39;,    // payload is String
1255     s_con_off = 7,    // utf8 payload, such as &#39;Ljava/lang/String;&#39;
1256     s_size = 9,
1257     min_size = 6        // smallest possible size (zero members)
1258   };
1259   // Cannot add min_size to index in case of overflow MAX_INT
1260   while ((--nann) &gt;= 0 &amp;&amp; (index - 2 &lt;= limit - min_size)) {
1261     int index0 = index;
1262     index = skip_annotation(buffer, limit, index);
1263     const u1* const abase = buffer + index0;
1264     const int atype = Bytes::get_Java_u2((address)abase + atype_off);
1265     const int count = Bytes::get_Java_u2((address)abase + count_off);
1266     const Symbol* const aname = check_symbol_at(cp, atype);
1267     if (aname == NULL)  break;  // invalid annotation name
1268     const Symbol* member = NULL;
1269     if (count &gt;= 1) {
1270       const int member_index = Bytes::get_Java_u2((address)abase + member_off);
1271       member = check_symbol_at(cp, member_index);
1272       if (member == NULL)  break;  // invalid member name
1273     }
1274 
1275     // Here is where parsing particular annotations will take place.
1276     AnnotationCollector::ID id = coll-&gt;annotation_index(loader_data, aname);
1277     if (AnnotationCollector::_unknown == id)  continue;
1278     coll-&gt;set_annotation(id);
1279 
1280     if (AnnotationCollector::_jdk_internal_vm_annotation_Contended == id) {
1281       // @Contended can optionally specify the contention group.
1282       //
1283       // Contended group defines the equivalence class over the fields:
1284       // the fields within the same contended group are not treated distinct.
1285       // The only exception is default group, which does not incur the
1286       // equivalence. Naturally, contention group for classes is meaningless.
1287       //
1288       // While the contention group is specified as String, annotation
1289       // values are already interned, and we might as well use the constant
1290       // pool index as the group tag.
1291       //
1292       u2 group_index = 0; // default contended group
1293       if (count == 1
1294         &amp;&amp; s_size == (index - index0)  // match size
1295         &amp;&amp; s_tag_val == *(abase + tag_off)
1296         &amp;&amp; member == vmSymbols::value_name()) {
1297         group_index = Bytes::get_Java_u2((address)abase + s_con_off);
1298         if (cp-&gt;symbol_at(group_index)-&gt;utf8_length() == 0) {
1299           group_index = 0; // default contended group
1300         }
1301       }
1302       coll-&gt;set_contended_group(group_index);
1303     }
1304   }
1305 }
1306 
1307 
1308 // Parse attributes for a field.
1309 void ClassFileParser::parse_field_attributes(const ClassFileStream* const cfs,
1310                                              u2 attributes_count,
1311                                              bool is_static, u2 signature_index,
1312                                              u2* const constantvalue_index_addr,
1313                                              bool* const is_synthetic_addr,
1314                                              u2* const generic_signature_index_addr,
1315                                              ClassFileParser::FieldAnnotationCollector* parsed_annotations,
1316                                              TRAPS) {
1317   assert(cfs != NULL, &quot;invariant&quot;);
1318   assert(constantvalue_index_addr != NULL, &quot;invariant&quot;);
1319   assert(is_synthetic_addr != NULL, &quot;invariant&quot;);
1320   assert(generic_signature_index_addr != NULL, &quot;invariant&quot;);
1321   assert(parsed_annotations != NULL, &quot;invariant&quot;);
1322   assert(attributes_count &gt; 0, &quot;attributes_count should be greater than 0&quot;);
1323 
1324   u2 constantvalue_index = 0;
1325   u2 generic_signature_index = 0;
1326   bool is_synthetic = false;
1327   const u1* runtime_visible_annotations = NULL;
1328   int runtime_visible_annotations_length = 0;
1329   const u1* runtime_invisible_annotations = NULL;
1330   int runtime_invisible_annotations_length = 0;
1331   const u1* runtime_visible_type_annotations = NULL;
1332   int runtime_visible_type_annotations_length = 0;
1333   const u1* runtime_invisible_type_annotations = NULL;
1334   int runtime_invisible_type_annotations_length = 0;
1335   bool runtime_invisible_annotations_exists = false;
1336   bool runtime_invisible_type_annotations_exists = false;
1337   const ConstantPool* const cp = _cp;
1338 
1339   while (attributes_count--) {
1340     cfs-&gt;guarantee_more(6, CHECK);  // attribute_name_index, attribute_length
1341     const u2 attribute_name_index = cfs-&gt;get_u2_fast();
1342     const u4 attribute_length = cfs-&gt;get_u4_fast();
1343     check_property(valid_symbol_at(attribute_name_index),
1344                    &quot;Invalid field attribute index %u in class file %s&quot;,
1345                    attribute_name_index,
1346                    CHECK);
1347 
1348     const Symbol* const attribute_name = cp-&gt;symbol_at(attribute_name_index);
1349     if (is_static &amp;&amp; attribute_name == vmSymbols::tag_constant_value()) {
1350       // ignore if non-static
1351       if (constantvalue_index != 0) {
1352         classfile_parse_error(&quot;Duplicate ConstantValue attribute in class file %s&quot;, CHECK);
1353       }
1354       check_property(
1355         attribute_length == 2,
1356         &quot;Invalid ConstantValue field attribute length %u in class file %s&quot;,
1357         attribute_length, CHECK);
1358 
1359       constantvalue_index = cfs-&gt;get_u2(CHECK);
1360       if (_need_verify) {
1361         verify_constantvalue(cp, constantvalue_index, signature_index, CHECK);
1362       }
1363     } else if (attribute_name == vmSymbols::tag_synthetic()) {
1364       if (attribute_length != 0) {
1365         classfile_parse_error(
1366           &quot;Invalid Synthetic field attribute length %u in class file %s&quot;,
1367           attribute_length, CHECK);
1368       }
1369       is_synthetic = true;
1370     } else if (attribute_name == vmSymbols::tag_deprecated()) { // 4276120
1371       if (attribute_length != 0) {
1372         classfile_parse_error(
1373           &quot;Invalid Deprecated field attribute length %u in class file %s&quot;,
1374           attribute_length, CHECK);
1375       }
1376     } else if (_major_version &gt;= JAVA_1_5_VERSION) {
1377       if (attribute_name == vmSymbols::tag_signature()) {
1378         if (generic_signature_index != 0) {
1379           classfile_parse_error(
1380             &quot;Multiple Signature attributes for field in class file %s&quot;, CHECK);
1381         }
1382         if (attribute_length != 2) {
1383           classfile_parse_error(
1384             &quot;Wrong size %u for field&#39;s Signature attribute in class file %s&quot;,
1385             attribute_length, CHECK);
1386         }
1387         generic_signature_index = parse_generic_signature_attribute(cfs, CHECK);
1388       } else if (attribute_name == vmSymbols::tag_runtime_visible_annotations()) {
1389         if (runtime_visible_annotations != NULL) {
1390           classfile_parse_error(
1391             &quot;Multiple RuntimeVisibleAnnotations attributes for field in class file %s&quot;, CHECK);
1392         }
1393         runtime_visible_annotations_length = attribute_length;
1394         runtime_visible_annotations = cfs-&gt;current();
1395         assert(runtime_visible_annotations != NULL, &quot;null visible annotations&quot;);
1396         cfs-&gt;guarantee_more(runtime_visible_annotations_length, CHECK);
1397         parse_annotations(cp,
1398                           runtime_visible_annotations,
1399                           runtime_visible_annotations_length,
1400                           parsed_annotations,
1401                           _loader_data,
1402                           CHECK);
1403         cfs-&gt;skip_u1_fast(runtime_visible_annotations_length);
1404       } else if (attribute_name == vmSymbols::tag_runtime_invisible_annotations()) {
1405         if (runtime_invisible_annotations_exists) {
1406           classfile_parse_error(
1407             &quot;Multiple RuntimeInvisibleAnnotations attributes for field in class file %s&quot;, CHECK);
1408         }
1409         runtime_invisible_annotations_exists = true;
1410         if (PreserveAllAnnotations) {
1411           runtime_invisible_annotations_length = attribute_length;
1412           runtime_invisible_annotations = cfs-&gt;current();
1413           assert(runtime_invisible_annotations != NULL, &quot;null invisible annotations&quot;);
1414         }
1415         cfs-&gt;skip_u1(attribute_length, CHECK);
1416       } else if (attribute_name == vmSymbols::tag_runtime_visible_type_annotations()) {
1417         if (runtime_visible_type_annotations != NULL) {
1418           classfile_parse_error(
1419             &quot;Multiple RuntimeVisibleTypeAnnotations attributes for field in class file %s&quot;, CHECK);
1420         }
1421         runtime_visible_type_annotations_length = attribute_length;
1422         runtime_visible_type_annotations = cfs-&gt;current();
1423         assert(runtime_visible_type_annotations != NULL, &quot;null visible type annotations&quot;);
1424         cfs-&gt;skip_u1(runtime_visible_type_annotations_length, CHECK);
1425       } else if (attribute_name == vmSymbols::tag_runtime_invisible_type_annotations()) {
1426         if (runtime_invisible_type_annotations_exists) {
1427           classfile_parse_error(
1428             &quot;Multiple RuntimeInvisibleTypeAnnotations attributes for field in class file %s&quot;, CHECK);
1429         } else {
1430           runtime_invisible_type_annotations_exists = true;
1431         }
1432         if (PreserveAllAnnotations) {
1433           runtime_invisible_type_annotations_length = attribute_length;
1434           runtime_invisible_type_annotations = cfs-&gt;current();
1435           assert(runtime_invisible_type_annotations != NULL, &quot;null invisible type annotations&quot;);
1436         }
1437         cfs-&gt;skip_u1(attribute_length, CHECK);
1438       } else {
1439         cfs-&gt;skip_u1(attribute_length, CHECK);  // Skip unknown attributes
1440       }
1441     } else {
1442       cfs-&gt;skip_u1(attribute_length, CHECK);  // Skip unknown attributes
1443     }
1444   }
1445 
1446   *constantvalue_index_addr = constantvalue_index;
1447   *is_synthetic_addr = is_synthetic;
1448   *generic_signature_index_addr = generic_signature_index;
1449   AnnotationArray* a = assemble_annotations(runtime_visible_annotations,
1450                                             runtime_visible_annotations_length,
1451                                             runtime_invisible_annotations,
1452                                             runtime_invisible_annotations_length,
1453                                             CHECK);
1454   parsed_annotations-&gt;set_field_annotations(a);
1455   a = assemble_annotations(runtime_visible_type_annotations,
1456                            runtime_visible_type_annotations_length,
1457                            runtime_invisible_type_annotations,
1458                            runtime_invisible_type_annotations_length,
1459                            CHECK);
1460   parsed_annotations-&gt;set_field_type_annotations(a);
1461   return;
1462 }
1463 
1464 
1465 // Field allocation types. Used for computing field offsets.
1466 
1467 enum FieldAllocationType {
1468   STATIC_OOP,           // Oops
1469   STATIC_BYTE,          // Boolean, Byte, char
1470   STATIC_SHORT,         // shorts
1471   STATIC_WORD,          // ints
1472   STATIC_DOUBLE,        // aligned long or double
1473   NONSTATIC_OOP,
1474   NONSTATIC_BYTE,
1475   NONSTATIC_SHORT,
1476   NONSTATIC_WORD,
1477   NONSTATIC_DOUBLE,
1478   MAX_FIELD_ALLOCATION_TYPE,
1479   BAD_ALLOCATION_TYPE = -1
1480 };
1481 
1482 static FieldAllocationType _basic_type_to_atype[2 * (T_CONFLICT + 1)] = {
1483   BAD_ALLOCATION_TYPE, // 0
1484   BAD_ALLOCATION_TYPE, // 1
1485   BAD_ALLOCATION_TYPE, // 2
1486   BAD_ALLOCATION_TYPE, // 3
1487   NONSTATIC_BYTE ,     // T_BOOLEAN     =  4,
1488   NONSTATIC_SHORT,     // T_CHAR        =  5,
1489   NONSTATIC_WORD,      // T_FLOAT       =  6,
1490   NONSTATIC_DOUBLE,    // T_DOUBLE      =  7,
1491   NONSTATIC_BYTE,      // T_BYTE        =  8,
1492   NONSTATIC_SHORT,     // T_SHORT       =  9,
1493   NONSTATIC_WORD,      // T_INT         = 10,
1494   NONSTATIC_DOUBLE,    // T_LONG        = 11,
1495   NONSTATIC_OOP,       // T_OBJECT      = 12,
1496   NONSTATIC_OOP,       // T_ARRAY       = 13,
1497   BAD_ALLOCATION_TYPE, // T_VOID        = 14,
1498   BAD_ALLOCATION_TYPE, // T_ADDRESS     = 15,
1499   BAD_ALLOCATION_TYPE, // T_NARROWOOP   = 16,
1500   BAD_ALLOCATION_TYPE, // T_METADATA    = 17,
1501   BAD_ALLOCATION_TYPE, // T_NARROWKLASS = 18,
1502   BAD_ALLOCATION_TYPE, // T_CONFLICT    = 19,
1503   BAD_ALLOCATION_TYPE, // 0
1504   BAD_ALLOCATION_TYPE, // 1
1505   BAD_ALLOCATION_TYPE, // 2
1506   BAD_ALLOCATION_TYPE, // 3
1507   STATIC_BYTE ,        // T_BOOLEAN     =  4,
1508   STATIC_SHORT,        // T_CHAR        =  5,
1509   STATIC_WORD,         // T_FLOAT       =  6,
1510   STATIC_DOUBLE,       // T_DOUBLE      =  7,
1511   STATIC_BYTE,         // T_BYTE        =  8,
1512   STATIC_SHORT,        // T_SHORT       =  9,
1513   STATIC_WORD,         // T_INT         = 10,
1514   STATIC_DOUBLE,       // T_LONG        = 11,
1515   STATIC_OOP,          // T_OBJECT      = 12,
1516   STATIC_OOP,          // T_ARRAY       = 13,
1517   BAD_ALLOCATION_TYPE, // T_VOID        = 14,
1518   BAD_ALLOCATION_TYPE, // T_ADDRESS     = 15,
1519   BAD_ALLOCATION_TYPE, // T_NARROWOOP   = 16,
1520   BAD_ALLOCATION_TYPE, // T_METADATA    = 17,
1521   BAD_ALLOCATION_TYPE, // T_NARROWKLASS = 18,
1522   BAD_ALLOCATION_TYPE, // T_CONFLICT    = 19,
1523 };
1524 
1525 static FieldAllocationType basic_type_to_atype(bool is_static, BasicType type) {
1526   assert(type &gt;= T_BOOLEAN &amp;&amp; type &lt; T_VOID, &quot;only allowable values&quot;);
1527   FieldAllocationType result = _basic_type_to_atype[type + (is_static ? (T_CONFLICT + 1) : 0)];
1528   assert(result != BAD_ALLOCATION_TYPE, &quot;bad type&quot;);
1529   return result;
1530 }
1531 
1532 class ClassFileParser::FieldAllocationCount : public ResourceObj {
1533  public:
1534   u2 count[MAX_FIELD_ALLOCATION_TYPE];
1535 
1536   FieldAllocationCount() {
1537     for (int i = 0; i &lt; MAX_FIELD_ALLOCATION_TYPE; i++) {
1538       count[i] = 0;
1539     }
1540   }
1541 
1542   FieldAllocationType update(bool is_static, BasicType type) {
1543     FieldAllocationType atype = basic_type_to_atype(is_static, type);
1544     if (atype != BAD_ALLOCATION_TYPE) {
1545       // Make sure there is no overflow with injected fields.
1546       assert(count[atype] &lt; 0xFFFF, &quot;More than 65535 fields&quot;);
1547       count[atype]++;
1548     }
1549     return atype;
1550   }
1551 };
1552 
1553 // Side-effects: populates the _fields, _fields_annotations,
1554 // _fields_type_annotations fields
1555 void ClassFileParser::parse_fields(const ClassFileStream* const cfs,
1556                                    bool is_interface,
1557                                    FieldAllocationCount* const fac,
1558                                    ConstantPool* cp,
1559                                    const int cp_size,
1560                                    u2* const java_fields_count_ptr,
1561                                    TRAPS) {
1562 
1563   assert(cfs != NULL, &quot;invariant&quot;);
1564   assert(fac != NULL, &quot;invariant&quot;);
1565   assert(cp != NULL, &quot;invariant&quot;);
1566   assert(java_fields_count_ptr != NULL, &quot;invariant&quot;);
1567 
1568   assert(NULL == _fields, &quot;invariant&quot;);
1569   assert(NULL == _fields_annotations, &quot;invariant&quot;);
1570   assert(NULL == _fields_type_annotations, &quot;invariant&quot;);
1571 
1572   cfs-&gt;guarantee_more(2, CHECK);  // length
1573   const u2 length = cfs-&gt;get_u2_fast();
1574   *java_fields_count_ptr = length;
1575 
1576   int num_injected = 0;
1577   const InjectedField* const injected = JavaClasses::get_injected(_class_name,
1578                                                                   &amp;num_injected);
1579   const int total_fields = length + num_injected;
1580 
1581   // The field array starts with tuples of shorts
1582   // [access, name index, sig index, initial value index, byte offset].
1583   // A generic signature slot only exists for field with generic
1584   // signature attribute. And the access flag is set with
1585   // JVM_ACC_FIELD_HAS_GENERIC_SIGNATURE for that field. The generic
1586   // signature slots are at the end of the field array and after all
1587   // other fields data.
1588   //
1589   //   f1: [access, name index, sig index, initial value index, low_offset, high_offset]
1590   //   f2: [access, name index, sig index, initial value index, low_offset, high_offset]
1591   //       ...
1592   //   fn: [access, name index, sig index, initial value index, low_offset, high_offset]
1593   //       [generic signature index]
1594   //       [generic signature index]
1595   //       ...
1596   //
1597   // Allocate a temporary resource array for field data. For each field,
1598   // a slot is reserved in the temporary array for the generic signature
1599   // index. After parsing all fields, the data are copied to a permanent
1600   // array and any unused slots will be discarded.
1601   ResourceMark rm(THREAD);
1602   u2* const fa = NEW_RESOURCE_ARRAY_IN_THREAD(THREAD,
1603                                               u2,
1604                                               total_fields * (FieldInfo::field_slots + 1));
1605 
1606   // The generic signature slots start after all other fields&#39; data.
1607   int generic_signature_slot = total_fields * FieldInfo::field_slots;
1608   int num_generic_signature = 0;
1609   for (int n = 0; n &lt; length; n++) {
1610     // access_flags, name_index, descriptor_index, attributes_count
1611     cfs-&gt;guarantee_more(8, CHECK);
1612 
1613     AccessFlags access_flags;
1614     const jint flags = cfs-&gt;get_u2_fast() &amp; JVM_RECOGNIZED_FIELD_MODIFIERS;
1615     verify_legal_field_modifiers(flags, is_interface, CHECK);
1616     access_flags.set_flags(flags);
1617 
1618     const u2 name_index = cfs-&gt;get_u2_fast();
1619     check_property(valid_symbol_at(name_index),
1620       &quot;Invalid constant pool index %u for field name in class file %s&quot;,
1621       name_index, CHECK);
1622     const Symbol* const name = cp-&gt;symbol_at(name_index);
1623     verify_legal_field_name(name, CHECK);
1624 
1625     const u2 signature_index = cfs-&gt;get_u2_fast();
1626     check_property(valid_symbol_at(signature_index),
1627       &quot;Invalid constant pool index %u for field signature in class file %s&quot;,
1628       signature_index, CHECK);
1629     const Symbol* const sig = cp-&gt;symbol_at(signature_index);
1630     verify_legal_field_signature(name, sig, CHECK);
1631 
1632     u2 constantvalue_index = 0;
1633     bool is_synthetic = false;
1634     u2 generic_signature_index = 0;
1635     const bool is_static = access_flags.is_static();
1636     FieldAnnotationCollector parsed_annotations(_loader_data);
1637 
1638     const u2 attributes_count = cfs-&gt;get_u2_fast();
1639     if (attributes_count &gt; 0) {
1640       parse_field_attributes(cfs,
1641                              attributes_count,
1642                              is_static,
1643                              signature_index,
1644                              &amp;constantvalue_index,
1645                              &amp;is_synthetic,
1646                              &amp;generic_signature_index,
1647                              &amp;parsed_annotations,
1648                              CHECK);
1649 
1650       if (parsed_annotations.field_annotations() != NULL) {
1651         if (_fields_annotations == NULL) {
1652           _fields_annotations = MetadataFactory::new_array&lt;AnnotationArray*&gt;(
1653                                              _loader_data, length, NULL,
1654                                              CHECK);
1655         }
1656         _fields_annotations-&gt;at_put(n, parsed_annotations.field_annotations());
1657         parsed_annotations.set_field_annotations(NULL);
1658       }
1659       if (parsed_annotations.field_type_annotations() != NULL) {
1660         if (_fields_type_annotations == NULL) {
1661           _fields_type_annotations =
1662             MetadataFactory::new_array&lt;AnnotationArray*&gt;(_loader_data,
1663                                                          length,
1664                                                          NULL,
1665                                                          CHECK);
1666         }
1667         _fields_type_annotations-&gt;at_put(n, parsed_annotations.field_type_annotations());
1668         parsed_annotations.set_field_type_annotations(NULL);
1669       }
1670 
1671       if (is_synthetic) {
1672         access_flags.set_is_synthetic();
1673       }
1674       if (generic_signature_index != 0) {
1675         access_flags.set_field_has_generic_signature();
1676         fa[generic_signature_slot] = generic_signature_index;
1677         generic_signature_slot ++;
1678         num_generic_signature ++;
1679       }
1680     }
1681 
1682     FieldInfo* const field = FieldInfo::from_field_array(fa, n);
1683     field-&gt;initialize(access_flags.as_short(),
1684                       name_index,
1685                       signature_index,
1686                       constantvalue_index);
1687     const BasicType type = cp-&gt;basic_type_for_signature_at(signature_index);
1688 
1689     // Remember how many oops we encountered and compute allocation type
1690     const FieldAllocationType atype = fac-&gt;update(is_static, type);
1691     field-&gt;set_allocation_type(atype);
1692 
1693     TSAN_RUNTIME_ONLY(
1694       if (ThreadSanitizerIgnoreFile != NULL &amp;&amp;
1695           TsanIgnoreList::match(_class_name, name, type)) {
1696         parsed_annotations.set_tsan_ignore(true);
1697       }
1698     );
1699 
1700     // After field is initialized with type, we can augment it with aux info
1701     if (parsed_annotations.has_any_annotations())
1702       parsed_annotations.apply_to(field);
1703   }
1704 
1705   int index = length;
1706   if (num_injected != 0) {
1707     for (int n = 0; n &lt; num_injected; n++) {
1708       // Check for duplicates
1709       if (injected[n].may_be_java) {
1710         const Symbol* const name      = injected[n].name();
1711         const Symbol* const signature = injected[n].signature();
1712         bool duplicate = false;
1713         for (int i = 0; i &lt; length; i++) {
1714           const FieldInfo* const f = FieldInfo::from_field_array(fa, i);
1715           if (name      == cp-&gt;symbol_at(f-&gt;name_index()) &amp;&amp;
1716               signature == cp-&gt;symbol_at(f-&gt;signature_index())) {
1717             // Symbol is desclared in Java so skip this one
1718             duplicate = true;
1719             break;
1720           }
1721         }
1722         if (duplicate) {
1723           // These will be removed from the field array at the end
1724           continue;
1725         }
1726       }
1727 
1728       // Injected field
1729       FieldInfo* const field = FieldInfo::from_field_array(fa, index);
1730       field-&gt;initialize(JVM_ACC_FIELD_INTERNAL,
1731                         injected[n].name_index,
1732                         injected[n].signature_index,
1733                         0);
1734 
1735       const BasicType type = FieldType::basic_type(injected[n].signature());
1736 
1737       // Remember how many oops we encountered and compute allocation type
1738       const FieldAllocationType atype = fac-&gt;update(false, type);
1739       field-&gt;set_allocation_type(atype);
1740       index++;
1741     }
1742   }
1743 
1744   assert(NULL == _fields, &quot;invariant&quot;);
1745 
1746   _fields =
1747     MetadataFactory::new_array&lt;u2&gt;(_loader_data,
1748                                    index * FieldInfo::field_slots + num_generic_signature,
1749                                    CHECK);
1750   // Sometimes injected fields already exist in the Java source so
1751   // the fields array could be too long.  In that case the
1752   // fields array is trimed. Also unused slots that were reserved
1753   // for generic signature indexes are discarded.
1754   {
1755     int i = 0;
1756     for (; i &lt; index * FieldInfo::field_slots; i++) {
1757       _fields-&gt;at_put(i, fa[i]);
1758     }
1759     for (int j = total_fields * FieldInfo::field_slots;
1760          j &lt; generic_signature_slot; j++) {
1761       _fields-&gt;at_put(i++, fa[j]);
1762     }
1763     assert(_fields-&gt;length() == i, &quot;&quot;);
1764   }
1765 
1766   if (_need_verify &amp;&amp; length &gt; 1) {
1767     // Check duplicated fields
1768     ResourceMark rm(THREAD);
1769     NameSigHash** names_and_sigs = NEW_RESOURCE_ARRAY_IN_THREAD(
1770       THREAD, NameSigHash*, HASH_ROW_SIZE);
1771     initialize_hashtable(names_and_sigs);
1772     bool dup = false;
1773     const Symbol* name = NULL;
1774     const Symbol* sig = NULL;
1775     {
1776       debug_only(NoSafepointVerifier nsv;)
1777       for (AllFieldStream fs(_fields, cp); !fs.done(); fs.next()) {
1778         name = fs.name();
1779         sig = fs.signature();
1780         // If no duplicates, add name/signature in hashtable names_and_sigs.
1781         if (!put_after_lookup(name, sig, names_and_sigs)) {
1782           dup = true;
1783           break;
1784         }
1785       }
1786     }
1787     if (dup) {
1788       classfile_parse_error(&quot;Duplicate field name \&quot;%s\&quot; with signature \&quot;%s\&quot; in class file %s&quot;,
1789                              name-&gt;as_C_string(), sig-&gt;as_klass_external_name(), CHECK);
1790     }
1791   }
1792 }
1793 
1794 
1795 const ClassFileParser::unsafe_u2* ClassFileParser::parse_exception_table(const ClassFileStream* const cfs,
1796                                                                          u4 code_length,
1797                                                                          u4 exception_table_length,
1798                                                                          TRAPS) {
1799   assert(cfs != NULL, &quot;invariant&quot;);
1800 
1801   const unsafe_u2* const exception_table_start = cfs-&gt;current();
1802   assert(exception_table_start != NULL, &quot;null exception table&quot;);
1803 
1804   cfs-&gt;guarantee_more(8 * exception_table_length, CHECK_NULL); // start_pc,
1805                                                                // end_pc,
1806                                                                // handler_pc,
1807                                                                // catch_type_index
1808 
1809   // Will check legal target after parsing code array in verifier.
1810   if (_need_verify) {
1811     for (unsigned int i = 0; i &lt; exception_table_length; i++) {
1812       const u2 start_pc = cfs-&gt;get_u2_fast();
1813       const u2 end_pc = cfs-&gt;get_u2_fast();
1814       const u2 handler_pc = cfs-&gt;get_u2_fast();
1815       const u2 catch_type_index = cfs-&gt;get_u2_fast();
1816       guarantee_property((start_pc &lt; end_pc) &amp;&amp; (end_pc &lt;= code_length),
1817                          &quot;Illegal exception table range in class file %s&quot;,
1818                          CHECK_NULL);
1819       guarantee_property(handler_pc &lt; code_length,
1820                          &quot;Illegal exception table handler in class file %s&quot;,
1821                          CHECK_NULL);
1822       if (catch_type_index != 0) {
1823         guarantee_property(valid_klass_reference_at(catch_type_index),
1824                            &quot;Catch type in exception table has bad constant type in class file %s&quot;, CHECK_NULL);
1825       }
1826     }
1827   } else {
1828     cfs-&gt;skip_u2_fast(exception_table_length * 4);
1829   }
1830   return exception_table_start;
1831 }
1832 
1833 void ClassFileParser::parse_linenumber_table(u4 code_attribute_length,
1834                                              u4 code_length,
1835                                              CompressedLineNumberWriteStream**const write_stream,
1836                                              TRAPS) {
1837 
1838   const ClassFileStream* const cfs = _stream;
1839   unsigned int num_entries = cfs-&gt;get_u2(CHECK);
1840 
1841   // Each entry is a u2 start_pc, and a u2 line_number
1842   const unsigned int length_in_bytes = num_entries * (sizeof(u2) * 2);
1843 
1844   // Verify line number attribute and table length
1845   check_property(
1846     code_attribute_length == sizeof(u2) + length_in_bytes,
1847     &quot;LineNumberTable attribute has wrong length in class file %s&quot;, CHECK);
1848 
1849   cfs-&gt;guarantee_more(length_in_bytes, CHECK);
1850 
1851   if ((*write_stream) == NULL) {
1852     if (length_in_bytes &gt; fixed_buffer_size) {
1853       (*write_stream) = new CompressedLineNumberWriteStream(length_in_bytes);
1854     } else {
1855       (*write_stream) = new CompressedLineNumberWriteStream(
1856         _linenumbertable_buffer, fixed_buffer_size);
1857     }
1858   }
1859 
1860   while (num_entries-- &gt; 0) {
1861     const u2 bci  = cfs-&gt;get_u2_fast(); // start_pc
1862     const u2 line = cfs-&gt;get_u2_fast(); // line_number
1863     guarantee_property(bci &lt; code_length,
1864         &quot;Invalid pc in LineNumberTable in class file %s&quot;, CHECK);
1865     (*write_stream)-&gt;write_pair(bci, line);
1866   }
1867 }
1868 
1869 
1870 class LVT_Hash : public AllStatic {
1871  public:
1872 
1873   static bool equals(LocalVariableTableElement const&amp; e0, LocalVariableTableElement const&amp; e1) {
1874   /*
1875    * 3-tuple start_bci/length/slot has to be unique key,
1876    * so the following comparison seems to be redundant:
1877    *       &amp;&amp; elem-&gt;name_cp_index == entry-&gt;_elem-&gt;name_cp_index
1878    */
1879     return (e0.start_bci     == e1.start_bci &amp;&amp;
1880             e0.length        == e1.length &amp;&amp;
1881             e0.name_cp_index == e1.name_cp_index &amp;&amp;
1882             e0.slot          == e1.slot);
1883   }
1884 
1885   static unsigned int hash(LocalVariableTableElement const&amp; e0) {
1886     unsigned int raw_hash = e0.start_bci;
1887 
1888     raw_hash = e0.length        + raw_hash * 37;
1889     raw_hash = e0.name_cp_index + raw_hash * 37;
1890     raw_hash = e0.slot          + raw_hash * 37;
1891 
1892     return raw_hash;
1893   }
1894 };
1895 
1896 
1897 // Class file LocalVariableTable elements.
1898 class Classfile_LVT_Element {
1899  public:
1900   u2 start_bci;
1901   u2 length;
1902   u2 name_cp_index;
1903   u2 descriptor_cp_index;
1904   u2 slot;
1905 };
1906 
1907 static void copy_lvt_element(const Classfile_LVT_Element* const src,
1908                              LocalVariableTableElement* const lvt) {
1909   lvt-&gt;start_bci           = Bytes::get_Java_u2((u1*) &amp;src-&gt;start_bci);
1910   lvt-&gt;length              = Bytes::get_Java_u2((u1*) &amp;src-&gt;length);
1911   lvt-&gt;name_cp_index       = Bytes::get_Java_u2((u1*) &amp;src-&gt;name_cp_index);
1912   lvt-&gt;descriptor_cp_index = Bytes::get_Java_u2((u1*) &amp;src-&gt;descriptor_cp_index);
1913   lvt-&gt;signature_cp_index  = 0;
1914   lvt-&gt;slot                = Bytes::get_Java_u2((u1*) &amp;src-&gt;slot);
1915 }
1916 
1917 // Function is used to parse both attributes:
1918 // LocalVariableTable (LVT) and LocalVariableTypeTable (LVTT)
1919 const ClassFileParser::unsafe_u2* ClassFileParser::parse_localvariable_table(const ClassFileStream* cfs,
1920                                                                              u4 code_length,
1921                                                                              u2 max_locals,
1922                                                                              u4 code_attribute_length,
1923                                                                              u2* const localvariable_table_length,
1924                                                                              bool isLVTT,
1925                                                                              TRAPS) {
1926   const char* const tbl_name = (isLVTT) ? &quot;LocalVariableTypeTable&quot; : &quot;LocalVariableTable&quot;;
1927   *localvariable_table_length = cfs-&gt;get_u2(CHECK_NULL);
1928   const unsigned int size =
1929     (*localvariable_table_length) * sizeof(Classfile_LVT_Element) / sizeof(u2);
1930 
1931   const ConstantPool* const cp = _cp;
1932 
1933   // Verify local variable table attribute has right length
1934   if (_need_verify) {
1935     guarantee_property(code_attribute_length == (sizeof(*localvariable_table_length) + size * sizeof(u2)),
1936                        &quot;%s has wrong length in class file %s&quot;, tbl_name, CHECK_NULL);
1937   }
1938 
1939   const unsafe_u2* const localvariable_table_start = cfs-&gt;current();
1940   assert(localvariable_table_start != NULL, &quot;null local variable table&quot;);
1941   if (!_need_verify) {
1942     cfs-&gt;skip_u2_fast(size);
1943   } else {
1944     cfs-&gt;guarantee_more(size * 2, CHECK_NULL);
1945     for(int i = 0; i &lt; (*localvariable_table_length); i++) {
1946       const u2 start_pc = cfs-&gt;get_u2_fast();
1947       const u2 length = cfs-&gt;get_u2_fast();
1948       const u2 name_index = cfs-&gt;get_u2_fast();
1949       const u2 descriptor_index = cfs-&gt;get_u2_fast();
1950       const u2 index = cfs-&gt;get_u2_fast();
1951       // Assign to a u4 to avoid overflow
1952       const u4 end_pc = (u4)start_pc + (u4)length;
1953 
1954       if (start_pc &gt;= code_length) {
1955         classfile_parse_error(
1956           &quot;Invalid start_pc %u in %s in class file %s&quot;,
1957           start_pc, tbl_name, CHECK_NULL);
1958       }
1959       if (end_pc &gt; code_length) {
1960         classfile_parse_error(
1961           &quot;Invalid length %u in %s in class file %s&quot;,
1962           length, tbl_name, CHECK_NULL);
1963       }
1964       const int cp_size = cp-&gt;length();
1965       guarantee_property(valid_symbol_at(name_index),
1966         &quot;Name index %u in %s has bad constant type in class file %s&quot;,
1967         name_index, tbl_name, CHECK_NULL);
1968       guarantee_property(valid_symbol_at(descriptor_index),
1969         &quot;Signature index %u in %s has bad constant type in class file %s&quot;,
1970         descriptor_index, tbl_name, CHECK_NULL);
1971 
1972       const Symbol* const name = cp-&gt;symbol_at(name_index);
1973       const Symbol* const sig = cp-&gt;symbol_at(descriptor_index);
1974       verify_legal_field_name(name, CHECK_NULL);
1975       u2 extra_slot = 0;
1976       if (!isLVTT) {
1977         verify_legal_field_signature(name, sig, CHECK_NULL);
1978 
1979         // 4894874: check special cases for double and long local variables
1980         if (sig == vmSymbols::type_signature(T_DOUBLE) ||
1981             sig == vmSymbols::type_signature(T_LONG)) {
1982           extra_slot = 1;
1983         }
1984       }
1985       guarantee_property((index + extra_slot) &lt; max_locals,
1986                           &quot;Invalid index %u in %s in class file %s&quot;,
1987                           index, tbl_name, CHECK_NULL);
1988     }
1989   }
1990   return localvariable_table_start;
1991 }
1992 
1993 static const u1* parse_stackmap_table(const ClassFileStream* const cfs,
1994                                       u4 code_attribute_length,
1995                                       bool need_verify,
1996                                       TRAPS) {
1997   assert(cfs != NULL, &quot;invariant&quot;);
1998 
1999   if (0 == code_attribute_length) {
2000     return NULL;
2001   }
2002 
2003   const u1* const stackmap_table_start = cfs-&gt;current();
2004   assert(stackmap_table_start != NULL, &quot;null stackmap table&quot;);
2005 
2006   // check code_attribute_length first
2007   cfs-&gt;skip_u1(code_attribute_length, CHECK_NULL);
2008 
2009   if (!need_verify &amp;&amp; !DumpSharedSpaces) {
2010     return NULL;
2011   }
2012   return stackmap_table_start;
2013 }
2014 
2015 const ClassFileParser::unsafe_u2* ClassFileParser::parse_checked_exceptions(const ClassFileStream* const cfs,
2016                                                                             u2* const checked_exceptions_length,
2017                                                                             u4 method_attribute_length,
2018                                                                             TRAPS) {
2019   assert(cfs != NULL, &quot;invariant&quot;);
2020   assert(checked_exceptions_length != NULL, &quot;invariant&quot;);
2021 
2022   cfs-&gt;guarantee_more(2, CHECK_NULL);  // checked_exceptions_length
2023   *checked_exceptions_length = cfs-&gt;get_u2_fast();
2024   const unsigned int size =
2025     (*checked_exceptions_length) * sizeof(CheckedExceptionElement) / sizeof(u2);
2026   const unsafe_u2* const checked_exceptions_start = cfs-&gt;current();
2027   assert(checked_exceptions_start != NULL, &quot;null checked exceptions&quot;);
2028   if (!_need_verify) {
2029     cfs-&gt;skip_u2_fast(size);
2030   } else {
2031     // Verify each value in the checked exception table
2032     u2 checked_exception;
2033     const u2 len = *checked_exceptions_length;
2034     cfs-&gt;guarantee_more(2 * len, CHECK_NULL);
2035     for (int i = 0; i &lt; len; i++) {
2036       checked_exception = cfs-&gt;get_u2_fast();
2037       check_property(
2038         valid_klass_reference_at(checked_exception),
2039         &quot;Exception name has bad type at constant pool %u in class file %s&quot;,
2040         checked_exception, CHECK_NULL);
2041     }
2042   }
2043   // check exceptions attribute length
2044   if (_need_verify) {
2045     guarantee_property(method_attribute_length == (sizeof(*checked_exceptions_length) +
2046                                                    sizeof(u2) * size),
2047                       &quot;Exceptions attribute has wrong length in class file %s&quot;, CHECK_NULL);
2048   }
2049   return checked_exceptions_start;
2050 }
2051 
2052 void ClassFileParser::throwIllegalSignature(const char* type,
2053                                             const Symbol* name,
2054                                             const Symbol* sig,
2055                                             TRAPS) const {
2056   assert(name != NULL, &quot;invariant&quot;);
2057   assert(sig != NULL, &quot;invariant&quot;);
2058 
2059   ResourceMark rm(THREAD);
2060   Exceptions::fthrow(THREAD_AND_LOCATION,
2061       vmSymbols::java_lang_ClassFormatError(),
2062       &quot;%s \&quot;%s\&quot; in class %s has illegal signature \&quot;%s\&quot;&quot;, type,
2063       name-&gt;as_C_string(), _class_name-&gt;as_C_string(), sig-&gt;as_C_string());
2064 }
2065 
2066 AnnotationCollector::ID
2067 AnnotationCollector::annotation_index(const ClassLoaderData* loader_data,
2068                                       const Symbol* name) {
2069   const vmSymbols::SID sid = vmSymbols::find_sid(name);
2070   // Privileged code can use all annotations.  Other code silently drops some.
2071   const bool privileged = loader_data-&gt;is_the_null_class_loader_data() ||
2072                           loader_data-&gt;is_platform_class_loader_data() ||
2073                           loader_data-&gt;is_unsafe_anonymous();
2074   switch (sid) {
2075     case vmSymbols::VM_SYMBOL_ENUM_NAME(reflect_CallerSensitive_signature): {
2076       if (_location != _in_method)  break;  // only allow for methods
2077       if (!privileged)              break;  // only allow in privileged code
2078       return _method_CallerSensitive;
2079     }
2080     case vmSymbols::VM_SYMBOL_ENUM_NAME(jdk_internal_vm_annotation_ForceInline_signature): {
2081       if (_location != _in_method)  break;  // only allow for methods
2082       if (!privileged)              break;  // only allow in privileged code
2083       return _method_ForceInline;
2084     }
2085     case vmSymbols::VM_SYMBOL_ENUM_NAME(jdk_internal_vm_annotation_DontInline_signature): {
2086       if (_location != _in_method)  break;  // only allow for methods
2087       if (!privileged)              break;  // only allow in privileged code
2088       return _method_DontInline;
2089     }
2090     case vmSymbols::VM_SYMBOL_ENUM_NAME(java_lang_invoke_InjectedProfile_signature): {
2091       if (_location != _in_method)  break;  // only allow for methods
2092       if (!privileged)              break;  // only allow in privileged code
2093       return _method_InjectedProfile;
2094     }
2095     case vmSymbols::VM_SYMBOL_ENUM_NAME(java_lang_invoke_LambdaForm_Compiled_signature): {
2096       if (_location != _in_method)  break;  // only allow for methods
2097       if (!privileged)              break;  // only allow in privileged code
2098       return _method_LambdaForm_Compiled;
2099     }
2100     case vmSymbols::VM_SYMBOL_ENUM_NAME(jdk_internal_vm_annotation_Hidden_signature): {
2101       if (_location != _in_method)  break;  // only allow for methods
2102       if (!privileged)              break;  // only allow in privileged code
2103       return _method_Hidden;
2104     }
2105     case vmSymbols::VM_SYMBOL_ENUM_NAME(jdk_internal_HotSpotIntrinsicCandidate_signature): {
2106       if (_location != _in_method)  break;  // only allow for methods
2107       if (!privileged)              break;  // only allow in privileged code
2108       return _method_HotSpotIntrinsicCandidate;
2109     }
2110     case vmSymbols::VM_SYMBOL_ENUM_NAME(jdk_internal_vm_annotation_Stable_signature): {
2111       if (_location != _in_field)   break;  // only allow for fields
2112       if (!privileged)              break;  // only allow in privileged code
2113       return _field_Stable;
2114     }
2115     case vmSymbols::VM_SYMBOL_ENUM_NAME(jdk_internal_vm_annotation_Contended_signature): {
2116       if (_location != _in_field &amp;&amp; _location != _in_class) {
2117         break;  // only allow for fields and classes
2118       }
2119       if (!EnableContended || (RestrictContended &amp;&amp; !privileged)) {
2120         break;  // honor privileges
2121       }
2122       return _jdk_internal_vm_annotation_Contended;
2123     }
2124     case vmSymbols::VM_SYMBOL_ENUM_NAME(jdk_internal_vm_annotation_ReservedStackAccess_signature): {
2125       if (_location != _in_method)  break;  // only allow for methods
2126       if (RestrictReservedStack &amp;&amp; !privileged) break; // honor privileges
2127       return _jdk_internal_vm_annotation_ReservedStackAccess;
2128     }
2129 #if INCLUDE_TSAN
2130     case vmSymbols::VM_SYMBOL_ENUM_NAME(java_util_concurrent_annotation_LazyInit): {
2131       if (_location != _in_field) {
2132         break;  // only allow for fields
2133       }
2134       return _field_TsanIgnore;
2135     }
2136 #endif  // INCLUDE_TSAN
2137     default: {
2138       break;
2139     }
2140   }
2141   return AnnotationCollector::_unknown;
2142 }
2143 
2144 void ClassFileParser::FieldAnnotationCollector::apply_to(FieldInfo* f) {
2145   if (is_contended())
2146     f-&gt;set_contended_group(contended_group());
2147   if (is_stable())
2148     f-&gt;set_stable(true);
2149   TSAN_RUNTIME_ONLY(
2150     if (is_tsan_ignore())
2151       f-&gt;set_tsan_ignore(true);
2152   );
2153 
2154 }
2155 
2156 ClassFileParser::FieldAnnotationCollector::~FieldAnnotationCollector() {
2157   // If there&#39;s an error deallocate metadata for field annotations
2158   MetadataFactory::free_array&lt;u1&gt;(_loader_data, _field_annotations);
2159   MetadataFactory::free_array&lt;u1&gt;(_loader_data, _field_type_annotations);
2160 }
2161 
2162 void MethodAnnotationCollector::apply_to(const methodHandle&amp; m) {
2163   if (has_annotation(_method_CallerSensitive))
2164     m-&gt;set_caller_sensitive(true);
2165   if (has_annotation(_method_ForceInline))
2166     m-&gt;set_force_inline(true);
2167   if (has_annotation(_method_DontInline))
2168     m-&gt;set_dont_inline(true);
2169   if (has_annotation(_method_InjectedProfile))
2170     m-&gt;set_has_injected_profile(true);
2171   if (has_annotation(_method_LambdaForm_Compiled) &amp;&amp; m-&gt;intrinsic_id() == vmIntrinsics::_none)
2172     m-&gt;set_intrinsic_id(vmIntrinsics::_compiledLambdaForm);
2173   if (has_annotation(_method_Hidden))
2174     m-&gt;set_hidden(true);
2175   if (has_annotation(_method_HotSpotIntrinsicCandidate) &amp;&amp; !m-&gt;is_synthetic())
2176     m-&gt;set_intrinsic_candidate(true);
2177   if (has_annotation(_jdk_internal_vm_annotation_ReservedStackAccess))
2178     m-&gt;set_has_reserved_stack_access(true);
2179 }
2180 
2181 void ClassFileParser::ClassAnnotationCollector::apply_to(InstanceKlass* ik) {
2182   assert(ik != NULL, &quot;invariant&quot;);
2183   ik-&gt;set_is_contended(is_contended());
2184 }
2185 
2186 #define MAX_ARGS_SIZE 255
2187 #define MAX_CODE_SIZE 65535
2188 #define INITIAL_MAX_LVT_NUMBER 256
2189 
2190 /* Copy class file LVT&#39;s/LVTT&#39;s into the HotSpot internal LVT.
2191  *
2192  * Rules for LVT&#39;s and LVTT&#39;s are:
2193  *   - There can be any number of LVT&#39;s and LVTT&#39;s.
2194  *   - If there are n LVT&#39;s, it is the same as if there was just
2195  *     one LVT containing all the entries from the n LVT&#39;s.
2196  *   - There may be no more than one LVT entry per local variable.
2197  *     Two LVT entries are &#39;equal&#39; if these fields are the same:
2198  *        start_pc, length, name, slot
2199  *   - There may be no more than one LVTT entry per each LVT entry.
2200  *     Each LVTT entry has to match some LVT entry.
2201  *   - HotSpot internal LVT keeps natural ordering of class file LVT entries.
2202  */
2203 void ClassFileParser::copy_localvariable_table(const ConstMethod* cm,
2204                                                int lvt_cnt,
2205                                                u2* const localvariable_table_length,
2206                                                const unsafe_u2** const localvariable_table_start,
2207                                                int lvtt_cnt,
2208                                                u2* const localvariable_type_table_length,
2209                                                const unsafe_u2** const localvariable_type_table_start,
2210                                                TRAPS) {
2211 
2212   ResourceMark rm(THREAD);
2213 
2214   typedef ResourceHashtable&lt;LocalVariableTableElement, LocalVariableTableElement*,
2215                             &amp;LVT_Hash::hash, &amp;LVT_Hash::equals&gt; LVT_HashTable;
2216 
2217   LVT_HashTable* const table = new LVT_HashTable();
2218 
2219   // To fill LocalVariableTable in
2220   const Classfile_LVT_Element* cf_lvt;
2221   LocalVariableTableElement* lvt = cm-&gt;localvariable_table_start();
2222 
2223   for (int tbl_no = 0; tbl_no &lt; lvt_cnt; tbl_no++) {
2224     cf_lvt = (Classfile_LVT_Element *) localvariable_table_start[tbl_no];
2225     for (int idx = 0; idx &lt; localvariable_table_length[tbl_no]; idx++, lvt++) {
2226       copy_lvt_element(&amp;cf_lvt[idx], lvt);
2227       // If no duplicates, add LVT elem in hashtable.
2228       if (table-&gt;put(*lvt, lvt) == false
2229           &amp;&amp; _need_verify
2230           &amp;&amp; _major_version &gt;= JAVA_1_5_VERSION) {
2231         classfile_parse_error(&quot;Duplicated LocalVariableTable attribute &quot;
2232                               &quot;entry for &#39;%s&#39; in class file %s&quot;,
2233                                _cp-&gt;symbol_at(lvt-&gt;name_cp_index)-&gt;as_utf8(),
2234                                CHECK);
2235       }
2236     }
2237   }
2238 
2239   // To merge LocalVariableTable and LocalVariableTypeTable
2240   const Classfile_LVT_Element* cf_lvtt;
2241   LocalVariableTableElement lvtt_elem;
2242 
2243   for (int tbl_no = 0; tbl_no &lt; lvtt_cnt; tbl_no++) {
2244     cf_lvtt = (Classfile_LVT_Element *) localvariable_type_table_start[tbl_no];
2245     for (int idx = 0; idx &lt; localvariable_type_table_length[tbl_no]; idx++) {
2246       copy_lvt_element(&amp;cf_lvtt[idx], &amp;lvtt_elem);
2247       LocalVariableTableElement** entry = table-&gt;get(lvtt_elem);
2248       if (entry == NULL) {
2249         if (_need_verify) {
2250           classfile_parse_error(&quot;LVTT entry for &#39;%s&#39; in class file %s &quot;
2251                                 &quot;does not match any LVT entry&quot;,
2252                                  _cp-&gt;symbol_at(lvtt_elem.name_cp_index)-&gt;as_utf8(),
2253                                  CHECK);
2254         }
2255       } else if ((*entry)-&gt;signature_cp_index != 0 &amp;&amp; _need_verify) {
2256         classfile_parse_error(&quot;Duplicated LocalVariableTypeTable attribute &quot;
2257                               &quot;entry for &#39;%s&#39; in class file %s&quot;,
2258                                _cp-&gt;symbol_at(lvtt_elem.name_cp_index)-&gt;as_utf8(),
2259                                CHECK);
2260       } else {
2261         // to add generic signatures into LocalVariableTable
2262         (*entry)-&gt;signature_cp_index = lvtt_elem.descriptor_cp_index;
2263       }
2264     }
2265   }
2266 }
2267 
2268 
2269 void ClassFileParser::copy_method_annotations(ConstMethod* cm,
2270                                        const u1* runtime_visible_annotations,
2271                                        int runtime_visible_annotations_length,
2272                                        const u1* runtime_invisible_annotations,
2273                                        int runtime_invisible_annotations_length,
2274                                        const u1* runtime_visible_parameter_annotations,
2275                                        int runtime_visible_parameter_annotations_length,
2276                                        const u1* runtime_invisible_parameter_annotations,
2277                                        int runtime_invisible_parameter_annotations_length,
2278                                        const u1* runtime_visible_type_annotations,
2279                                        int runtime_visible_type_annotations_length,
2280                                        const u1* runtime_invisible_type_annotations,
2281                                        int runtime_invisible_type_annotations_length,
2282                                        const u1* annotation_default,
2283                                        int annotation_default_length,
2284                                        TRAPS) {
2285 
2286   AnnotationArray* a;
2287 
2288   if (runtime_visible_annotations_length +
2289       runtime_invisible_annotations_length &gt; 0) {
2290      a = assemble_annotations(runtime_visible_annotations,
2291                               runtime_visible_annotations_length,
2292                               runtime_invisible_annotations,
2293                               runtime_invisible_annotations_length,
2294                               CHECK);
2295      cm-&gt;set_method_annotations(a);
2296   }
2297 
2298   if (runtime_visible_parameter_annotations_length +
2299       runtime_invisible_parameter_annotations_length &gt; 0) {
2300     a = assemble_annotations(runtime_visible_parameter_annotations,
2301                              runtime_visible_parameter_annotations_length,
2302                              runtime_invisible_parameter_annotations,
2303                              runtime_invisible_parameter_annotations_length,
2304                              CHECK);
2305     cm-&gt;set_parameter_annotations(a);
2306   }
2307 
2308   if (annotation_default_length &gt; 0) {
2309     a = assemble_annotations(annotation_default,
2310                              annotation_default_length,
2311                              NULL,
2312                              0,
2313                              CHECK);
2314     cm-&gt;set_default_annotations(a);
2315   }
2316 
2317   if (runtime_visible_type_annotations_length +
2318       runtime_invisible_type_annotations_length &gt; 0) {
2319     a = assemble_annotations(runtime_visible_type_annotations,
2320                              runtime_visible_type_annotations_length,
2321                              runtime_invisible_type_annotations,
2322                              runtime_invisible_type_annotations_length,
2323                              CHECK);
2324     cm-&gt;set_type_annotations(a);
2325   }
2326 }
2327 
2328 
2329 // Note: the parse_method below is big and clunky because all parsing of the code and exceptions
2330 // attribute is inlined. This is cumbersome to avoid since we inline most of the parts in the
2331 // Method* to save footprint, so we only know the size of the resulting Method* when the
2332 // entire method attribute is parsed.
2333 //
2334 // The promoted_flags parameter is used to pass relevant access_flags
2335 // from the method back up to the containing klass. These flag values
2336 // are added to klass&#39;s access_flags.
2337 
2338 Method* ClassFileParser::parse_method(const ClassFileStream* const cfs,
2339                                       bool is_interface,
2340                                       const ConstantPool* cp,
2341                                       AccessFlags* const promoted_flags,
2342                                       TRAPS) {
2343   assert(cfs != NULL, &quot;invariant&quot;);
2344   assert(cp != NULL, &quot;invariant&quot;);
2345   assert(promoted_flags != NULL, &quot;invariant&quot;);
2346 
2347   ResourceMark rm(THREAD);
2348   // Parse fixed parts:
2349   // access_flags, name_index, descriptor_index, attributes_count
2350   cfs-&gt;guarantee_more(8, CHECK_NULL);
2351 
2352   int flags = cfs-&gt;get_u2_fast();
2353   const u2 name_index = cfs-&gt;get_u2_fast();
2354   const int cp_size = cp-&gt;length();
2355   check_property(
2356     valid_symbol_at(name_index),
2357     &quot;Illegal constant pool index %u for method name in class file %s&quot;,
2358     name_index, CHECK_NULL);
2359   const Symbol* const name = cp-&gt;symbol_at(name_index);
2360   verify_legal_method_name(name, CHECK_NULL);
2361 
2362   const u2 signature_index = cfs-&gt;get_u2_fast();
2363   guarantee_property(
2364     valid_symbol_at(signature_index),
2365     &quot;Illegal constant pool index %u for method signature in class file %s&quot;,
2366     signature_index, CHECK_NULL);
2367   const Symbol* const signature = cp-&gt;symbol_at(signature_index);
2368 
2369   if (name == vmSymbols::class_initializer_name()) {
2370     // We ignore the other access flags for a valid class initializer.
2371     // (JVM Spec 2nd ed., chapter 4.6)
2372     if (_major_version &lt; 51) { // backward compatibility
2373       flags = JVM_ACC_STATIC;
2374     } else if ((flags &amp; JVM_ACC_STATIC) == JVM_ACC_STATIC) {
2375       flags &amp;= JVM_ACC_STATIC | JVM_ACC_STRICT;
2376     } else {
2377       classfile_parse_error(&quot;Method &lt;clinit&gt; is not static in class file %s&quot;, CHECK_NULL);
2378     }
2379   } else {
2380     verify_legal_method_modifiers(flags, is_interface, name, CHECK_NULL);
2381   }
2382 
2383   if (name == vmSymbols::object_initializer_name() &amp;&amp; is_interface) {
2384     classfile_parse_error(&quot;Interface cannot have a method named &lt;init&gt;, class file %s&quot;, CHECK_NULL);
2385   }
2386 
2387   int args_size = -1;  // only used when _need_verify is true
2388   if (_need_verify) {
2389     args_size = ((flags &amp; JVM_ACC_STATIC) ? 0 : 1) +
2390                  verify_legal_method_signature(name, signature, CHECK_NULL);
2391     if (args_size &gt; MAX_ARGS_SIZE) {
2392       classfile_parse_error(&quot;Too many arguments in method signature in class file %s&quot;, CHECK_NULL);
2393     }
2394   }
2395 
2396   AccessFlags access_flags(flags &amp; JVM_RECOGNIZED_METHOD_MODIFIERS);
2397 
2398   // Default values for code and exceptions attribute elements
2399   u2 max_stack = 0;
2400   u2 max_locals = 0;
2401   u4 code_length = 0;
2402   const u1* code_start = 0;
2403   u2 exception_table_length = 0;
2404   const unsafe_u2* exception_table_start = NULL; // (potentially unaligned) pointer to array of u2 elements
2405   Array&lt;int&gt;* exception_handlers = Universe::the_empty_int_array();
2406   u2 checked_exceptions_length = 0;
2407   const unsafe_u2* checked_exceptions_start = NULL; // (potentially unaligned) pointer to array of u2 elements
2408   CompressedLineNumberWriteStream* linenumber_table = NULL;
2409   int linenumber_table_length = 0;
2410   int total_lvt_length = 0;
2411   u2 lvt_cnt = 0;
2412   u2 lvtt_cnt = 0;
2413   bool lvt_allocated = false;
2414   u2 max_lvt_cnt = INITIAL_MAX_LVT_NUMBER;
2415   u2 max_lvtt_cnt = INITIAL_MAX_LVT_NUMBER;
2416   u2* localvariable_table_length = NULL;
2417   const unsafe_u2** localvariable_table_start = NULL; // (potentially unaligned) pointer to array of LVT attributes
2418   u2* localvariable_type_table_length = NULL;
2419   const unsafe_u2** localvariable_type_table_start = NULL; // (potentially unaligned) pointer to LVTT attributes
2420   int method_parameters_length = -1;
2421   const u1* method_parameters_data = NULL;
2422   bool method_parameters_seen = false;
2423   bool parsed_code_attribute = false;
2424   bool parsed_checked_exceptions_attribute = false;
2425   bool parsed_stackmap_attribute = false;
2426   // stackmap attribute - JDK1.5
2427   const u1* stackmap_data = NULL;
2428   int stackmap_data_length = 0;
2429   u2 generic_signature_index = 0;
2430   MethodAnnotationCollector parsed_annotations;
2431   const u1* runtime_visible_annotations = NULL;
2432   int runtime_visible_annotations_length = 0;
2433   const u1* runtime_invisible_annotations = NULL;
2434   int runtime_invisible_annotations_length = 0;
2435   const u1* runtime_visible_parameter_annotations = NULL;
2436   int runtime_visible_parameter_annotations_length = 0;
2437   const u1* runtime_invisible_parameter_annotations = NULL;
2438   int runtime_invisible_parameter_annotations_length = 0;
2439   const u1* runtime_visible_type_annotations = NULL;
2440   int runtime_visible_type_annotations_length = 0;
2441   const u1* runtime_invisible_type_annotations = NULL;
2442   int runtime_invisible_type_annotations_length = 0;
2443   bool runtime_invisible_annotations_exists = false;
2444   bool runtime_invisible_type_annotations_exists = false;
2445   bool runtime_invisible_parameter_annotations_exists = false;
2446   const u1* annotation_default = NULL;
2447   int annotation_default_length = 0;
2448 
2449   // Parse code and exceptions attribute
2450   u2 method_attributes_count = cfs-&gt;get_u2_fast();
2451   while (method_attributes_count--) {
2452     cfs-&gt;guarantee_more(6, CHECK_NULL);  // method_attribute_name_index, method_attribute_length
2453     const u2 method_attribute_name_index = cfs-&gt;get_u2_fast();
2454     const u4 method_attribute_length = cfs-&gt;get_u4_fast();
2455     check_property(
2456       valid_symbol_at(method_attribute_name_index),
2457       &quot;Invalid method attribute name index %u in class file %s&quot;,
2458       method_attribute_name_index, CHECK_NULL);
2459 
2460     const Symbol* const method_attribute_name = cp-&gt;symbol_at(method_attribute_name_index);
2461     if (method_attribute_name == vmSymbols::tag_code()) {
2462       // Parse Code attribute
2463       if (_need_verify) {
2464         guarantee_property(
2465             !access_flags.is_native() &amp;&amp; !access_flags.is_abstract(),
2466                         &quot;Code attribute in native or abstract methods in class file %s&quot;,
2467                          CHECK_NULL);
2468       }
2469       if (parsed_code_attribute) {
2470         classfile_parse_error(&quot;Multiple Code attributes in class file %s&quot;,
2471                               CHECK_NULL);
2472       }
2473       parsed_code_attribute = true;
2474 
2475       // Stack size, locals size, and code size
2476       if (_major_version == 45 &amp;&amp; _minor_version &lt;= 2) {
2477         cfs-&gt;guarantee_more(4, CHECK_NULL);
2478         max_stack = cfs-&gt;get_u1_fast();
2479         max_locals = cfs-&gt;get_u1_fast();
2480         code_length = cfs-&gt;get_u2_fast();
2481       } else {
2482         cfs-&gt;guarantee_more(8, CHECK_NULL);
2483         max_stack = cfs-&gt;get_u2_fast();
2484         max_locals = cfs-&gt;get_u2_fast();
2485         code_length = cfs-&gt;get_u4_fast();
2486       }
2487       if (_need_verify) {
2488         guarantee_property(args_size &lt;= max_locals,
2489                            &quot;Arguments can&#39;t fit into locals in class file %s&quot;,
2490                            CHECK_NULL);
2491         guarantee_property(code_length &gt; 0 &amp;&amp; code_length &lt;= MAX_CODE_SIZE,
2492                            &quot;Invalid method Code length %u in class file %s&quot;,
2493                            code_length, CHECK_NULL);
2494       }
2495       // Code pointer
2496       code_start = cfs-&gt;current();
2497       assert(code_start != NULL, &quot;null code start&quot;);
2498       cfs-&gt;guarantee_more(code_length, CHECK_NULL);
2499       cfs-&gt;skip_u1_fast(code_length);
2500 
2501       // Exception handler table
2502       cfs-&gt;guarantee_more(2, CHECK_NULL);  // exception_table_length
2503       exception_table_length = cfs-&gt;get_u2_fast();
2504       if (exception_table_length &gt; 0) {
2505         exception_table_start = parse_exception_table(cfs,
2506                                                       code_length,
2507                                                       exception_table_length,
2508                                                       CHECK_NULL);
2509       }
2510 
2511       // Parse additional attributes in code attribute
2512       cfs-&gt;guarantee_more(2, CHECK_NULL);  // code_attributes_count
2513       u2 code_attributes_count = cfs-&gt;get_u2_fast();
2514 
2515       unsigned int calculated_attribute_length = 0;
2516 
2517       if (_major_version &gt; 45 || (_major_version == 45 &amp;&amp; _minor_version &gt; 2)) {
2518         calculated_attribute_length =
2519             sizeof(max_stack) + sizeof(max_locals) + sizeof(code_length);
2520       } else {
2521         // max_stack, locals and length are smaller in pre-version 45.2 classes
2522         calculated_attribute_length = sizeof(u1) + sizeof(u1) + sizeof(u2);
2523       }
2524       calculated_attribute_length +=
2525         code_length +
2526         sizeof(exception_table_length) +
2527         sizeof(code_attributes_count) +
2528         exception_table_length *
2529             ( sizeof(u2) +   // start_pc
2530               sizeof(u2) +   // end_pc
2531               sizeof(u2) +   // handler_pc
2532               sizeof(u2) );  // catch_type_index
2533 
2534       while (code_attributes_count--) {
2535         cfs-&gt;guarantee_more(6, CHECK_NULL);  // code_attribute_name_index, code_attribute_length
2536         const u2 code_attribute_name_index = cfs-&gt;get_u2_fast();
2537         const u4 code_attribute_length = cfs-&gt;get_u4_fast();
2538         calculated_attribute_length += code_attribute_length +
2539                                        sizeof(code_attribute_name_index) +
2540                                        sizeof(code_attribute_length);
2541         check_property(valid_symbol_at(code_attribute_name_index),
2542                        &quot;Invalid code attribute name index %u in class file %s&quot;,
2543                        code_attribute_name_index,
2544                        CHECK_NULL);
2545         if (LoadLineNumberTables &amp;&amp;
2546             cp-&gt;symbol_at(code_attribute_name_index) == vmSymbols::tag_line_number_table()) {
2547           // Parse and compress line number table
2548           parse_linenumber_table(code_attribute_length,
2549                                  code_length,
2550                                  &amp;linenumber_table,
2551                                  CHECK_NULL);
2552 
2553         } else if (LoadLocalVariableTables &amp;&amp;
2554                    cp-&gt;symbol_at(code_attribute_name_index) == vmSymbols::tag_local_variable_table()) {
2555           // Parse local variable table
2556           if (!lvt_allocated) {
2557             localvariable_table_length = NEW_RESOURCE_ARRAY_IN_THREAD(
2558               THREAD, u2,  INITIAL_MAX_LVT_NUMBER);
2559             localvariable_table_start = NEW_RESOURCE_ARRAY_IN_THREAD(
2560               THREAD, const unsafe_u2*, INITIAL_MAX_LVT_NUMBER);
2561             localvariable_type_table_length = NEW_RESOURCE_ARRAY_IN_THREAD(
2562               THREAD, u2,  INITIAL_MAX_LVT_NUMBER);
2563             localvariable_type_table_start = NEW_RESOURCE_ARRAY_IN_THREAD(
2564               THREAD, const unsafe_u2*, INITIAL_MAX_LVT_NUMBER);
2565             lvt_allocated = true;
2566           }
2567           if (lvt_cnt == max_lvt_cnt) {
2568             max_lvt_cnt &lt;&lt;= 1;
2569             localvariable_table_length = REALLOC_RESOURCE_ARRAY(u2, localvariable_table_length, lvt_cnt, max_lvt_cnt);
2570             localvariable_table_start  = REALLOC_RESOURCE_ARRAY(const unsafe_u2*, localvariable_table_start, lvt_cnt, max_lvt_cnt);
2571           }
2572           localvariable_table_start[lvt_cnt] =
2573             parse_localvariable_table(cfs,
2574                                       code_length,
2575                                       max_locals,
2576                                       code_attribute_length,
2577                                       &amp;localvariable_table_length[lvt_cnt],
2578                                       false,    // is not LVTT
2579                                       CHECK_NULL);
2580           total_lvt_length += localvariable_table_length[lvt_cnt];
2581           lvt_cnt++;
2582         } else if (LoadLocalVariableTypeTables &amp;&amp;
2583                    _major_version &gt;= JAVA_1_5_VERSION &amp;&amp;
2584                    cp-&gt;symbol_at(code_attribute_name_index) == vmSymbols::tag_local_variable_type_table()) {
2585           if (!lvt_allocated) {
2586             localvariable_table_length = NEW_RESOURCE_ARRAY_IN_THREAD(
2587               THREAD, u2,  INITIAL_MAX_LVT_NUMBER);
2588             localvariable_table_start = NEW_RESOURCE_ARRAY_IN_THREAD(
2589               THREAD, const unsafe_u2*, INITIAL_MAX_LVT_NUMBER);
2590             localvariable_type_table_length = NEW_RESOURCE_ARRAY_IN_THREAD(
2591               THREAD, u2,  INITIAL_MAX_LVT_NUMBER);
2592             localvariable_type_table_start = NEW_RESOURCE_ARRAY_IN_THREAD(
2593               THREAD, const unsafe_u2*, INITIAL_MAX_LVT_NUMBER);
2594             lvt_allocated = true;
2595           }
2596           // Parse local variable type table
2597           if (lvtt_cnt == max_lvtt_cnt) {
2598             max_lvtt_cnt &lt;&lt;= 1;
2599             localvariable_type_table_length = REALLOC_RESOURCE_ARRAY(u2, localvariable_type_table_length, lvtt_cnt, max_lvtt_cnt);
2600             localvariable_type_table_start  = REALLOC_RESOURCE_ARRAY(const unsafe_u2*, localvariable_type_table_start, lvtt_cnt, max_lvtt_cnt);
2601           }
2602           localvariable_type_table_start[lvtt_cnt] =
2603             parse_localvariable_table(cfs,
2604                                       code_length,
2605                                       max_locals,
2606                                       code_attribute_length,
2607                                       &amp;localvariable_type_table_length[lvtt_cnt],
2608                                       true,     // is LVTT
2609                                       CHECK_NULL);
2610           lvtt_cnt++;
2611         } else if (_major_version &gt;= Verifier::STACKMAP_ATTRIBUTE_MAJOR_VERSION &amp;&amp;
2612                    cp-&gt;symbol_at(code_attribute_name_index) == vmSymbols::tag_stack_map_table()) {
2613           // Stack map is only needed by the new verifier in JDK1.5.
2614           if (parsed_stackmap_attribute) {
2615             classfile_parse_error(&quot;Multiple StackMapTable attributes in class file %s&quot;, CHECK_NULL);
2616           }
2617           stackmap_data = parse_stackmap_table(cfs, code_attribute_length, _need_verify, CHECK_NULL);
2618           stackmap_data_length = code_attribute_length;
2619           parsed_stackmap_attribute = true;
2620         } else {
2621           // Skip unknown attributes
2622           cfs-&gt;skip_u1(code_attribute_length, CHECK_NULL);
2623         }
2624       }
2625       // check method attribute length
2626       if (_need_verify) {
2627         guarantee_property(method_attribute_length == calculated_attribute_length,
2628                            &quot;Code segment has wrong length in class file %s&quot;,
2629                            CHECK_NULL);
2630       }
2631     } else if (method_attribute_name == vmSymbols::tag_exceptions()) {
2632       // Parse Exceptions attribute
2633       if (parsed_checked_exceptions_attribute) {
2634         classfile_parse_error(&quot;Multiple Exceptions attributes in class file %s&quot;,
2635                               CHECK_NULL);
2636       }
2637       parsed_checked_exceptions_attribute = true;
2638       checked_exceptions_start =
2639             parse_checked_exceptions(cfs,
2640                                      &amp;checked_exceptions_length,
2641                                      method_attribute_length,
2642                                      CHECK_NULL);
2643     } else if (method_attribute_name == vmSymbols::tag_method_parameters()) {
2644       // reject multiple method parameters
2645       if (method_parameters_seen) {
2646         classfile_parse_error(&quot;Multiple MethodParameters attributes in class file %s&quot;,
2647                               CHECK_NULL);
2648       }
2649       method_parameters_seen = true;
2650       method_parameters_length = cfs-&gt;get_u1_fast();
2651       const u2 real_length = (method_parameters_length * 4u) + 1u;
2652       if (method_attribute_length != real_length) {
2653         classfile_parse_error(
2654           &quot;Invalid MethodParameters method attribute length %u in class file&quot;,
2655           method_attribute_length, CHECK_NULL);
2656       }
2657       method_parameters_data = cfs-&gt;current();
2658       cfs-&gt;skip_u2_fast(method_parameters_length);
2659       cfs-&gt;skip_u2_fast(method_parameters_length);
2660       // ignore this attribute if it cannot be reflected
2661       if (!SystemDictionary::Parameter_klass_loaded())
2662         method_parameters_length = -1;
2663     } else if (method_attribute_name == vmSymbols::tag_synthetic()) {
2664       if (method_attribute_length != 0) {
2665         classfile_parse_error(
2666           &quot;Invalid Synthetic method attribute length %u in class file %s&quot;,
2667           method_attribute_length, CHECK_NULL);
2668       }
2669       // Should we check that there hasn&#39;t already been a synthetic attribute?
2670       access_flags.set_is_synthetic();
2671     } else if (method_attribute_name == vmSymbols::tag_deprecated()) { // 4276120
2672       if (method_attribute_length != 0) {
2673         classfile_parse_error(
2674           &quot;Invalid Deprecated method attribute length %u in class file %s&quot;,
2675           method_attribute_length, CHECK_NULL);
2676       }
2677     } else if (_major_version &gt;= JAVA_1_5_VERSION) {
2678       if (method_attribute_name == vmSymbols::tag_signature()) {
2679         if (generic_signature_index != 0) {
2680           classfile_parse_error(
2681             &quot;Multiple Signature attributes for method in class file %s&quot;,
2682             CHECK_NULL);
2683         }
2684         if (method_attribute_length != 2) {
2685           classfile_parse_error(
2686             &quot;Invalid Signature attribute length %u in class file %s&quot;,
2687             method_attribute_length, CHECK_NULL);
2688         }
2689         generic_signature_index = parse_generic_signature_attribute(cfs, CHECK_NULL);
2690       } else if (method_attribute_name == vmSymbols::tag_runtime_visible_annotations()) {
2691         if (runtime_visible_annotations != NULL) {
2692           classfile_parse_error(
2693             &quot;Multiple RuntimeVisibleAnnotations attributes for method in class file %s&quot;,
2694             CHECK_NULL);
2695         }
2696         runtime_visible_annotations_length = method_attribute_length;
2697         runtime_visible_annotations = cfs-&gt;current();
2698         assert(runtime_visible_annotations != NULL, &quot;null visible annotations&quot;);
2699         cfs-&gt;guarantee_more(runtime_visible_annotations_length, CHECK_NULL);
2700         parse_annotations(cp,
2701                           runtime_visible_annotations,
2702                           runtime_visible_annotations_length,
2703                           &amp;parsed_annotations,
2704                           _loader_data,
2705                           CHECK_NULL);
2706         cfs-&gt;skip_u1_fast(runtime_visible_annotations_length);
2707       } else if (method_attribute_name == vmSymbols::tag_runtime_invisible_annotations()) {
2708         if (runtime_invisible_annotations_exists) {
2709           classfile_parse_error(
2710             &quot;Multiple RuntimeInvisibleAnnotations attributes for method in class file %s&quot;,
2711             CHECK_NULL);
2712         }
2713         runtime_invisible_annotations_exists = true;
2714         if (PreserveAllAnnotations) {
2715           runtime_invisible_annotations_length = method_attribute_length;
2716           runtime_invisible_annotations = cfs-&gt;current();
2717           assert(runtime_invisible_annotations != NULL, &quot;null invisible annotations&quot;);
2718         }
2719         cfs-&gt;skip_u1(method_attribute_length, CHECK_NULL);
2720       } else if (method_attribute_name == vmSymbols::tag_runtime_visible_parameter_annotations()) {
2721         if (runtime_visible_parameter_annotations != NULL) {
2722           classfile_parse_error(
2723             &quot;Multiple RuntimeVisibleParameterAnnotations attributes for method in class file %s&quot;,
2724             CHECK_NULL);
2725         }
2726         runtime_visible_parameter_annotations_length = method_attribute_length;
2727         runtime_visible_parameter_annotations = cfs-&gt;current();
2728         assert(runtime_visible_parameter_annotations != NULL, &quot;null visible parameter annotations&quot;);
2729         cfs-&gt;skip_u1(runtime_visible_parameter_annotations_length, CHECK_NULL);
2730       } else if (method_attribute_name == vmSymbols::tag_runtime_invisible_parameter_annotations()) {
2731         if (runtime_invisible_parameter_annotations_exists) {
2732           classfile_parse_error(
2733             &quot;Multiple RuntimeInvisibleParameterAnnotations attributes for method in class file %s&quot;,
2734             CHECK_NULL);
2735         }
2736         runtime_invisible_parameter_annotations_exists = true;
2737         if (PreserveAllAnnotations) {
2738           runtime_invisible_parameter_annotations_length = method_attribute_length;
2739           runtime_invisible_parameter_annotations = cfs-&gt;current();
2740           assert(runtime_invisible_parameter_annotations != NULL,
2741             &quot;null invisible parameter annotations&quot;);
2742         }
2743         cfs-&gt;skip_u1(method_attribute_length, CHECK_NULL);
2744       } else if (method_attribute_name == vmSymbols::tag_annotation_default()) {
2745         if (annotation_default != NULL) {
2746           classfile_parse_error(
2747             &quot;Multiple AnnotationDefault attributes for method in class file %s&quot;,
2748             CHECK_NULL);
2749         }
2750         annotation_default_length = method_attribute_length;
2751         annotation_default = cfs-&gt;current();
2752         assert(annotation_default != NULL, &quot;null annotation default&quot;);
2753         cfs-&gt;skip_u1(annotation_default_length, CHECK_NULL);
2754       } else if (method_attribute_name == vmSymbols::tag_runtime_visible_type_annotations()) {
2755         if (runtime_visible_type_annotations != NULL) {
2756           classfile_parse_error(
2757             &quot;Multiple RuntimeVisibleTypeAnnotations attributes for method in class file %s&quot;,
2758             CHECK_NULL);
2759         }
2760         runtime_visible_type_annotations_length = method_attribute_length;
2761         runtime_visible_type_annotations = cfs-&gt;current();
2762         assert(runtime_visible_type_annotations != NULL, &quot;null visible type annotations&quot;);
2763         // No need for the VM to parse Type annotations
2764         cfs-&gt;skip_u1(runtime_visible_type_annotations_length, CHECK_NULL);
2765       } else if (method_attribute_name == vmSymbols::tag_runtime_invisible_type_annotations()) {
2766         if (runtime_invisible_type_annotations_exists) {
2767           classfile_parse_error(
2768             &quot;Multiple RuntimeInvisibleTypeAnnotations attributes for method in class file %s&quot;,
2769             CHECK_NULL);
2770         } else {
2771           runtime_invisible_type_annotations_exists = true;
2772         }
2773         if (PreserveAllAnnotations) {
2774           runtime_invisible_type_annotations_length = method_attribute_length;
2775           runtime_invisible_type_annotations = cfs-&gt;current();
2776           assert(runtime_invisible_type_annotations != NULL, &quot;null invisible type annotations&quot;);
2777         }
2778         cfs-&gt;skip_u1(method_attribute_length, CHECK_NULL);
2779       } else {
2780         // Skip unknown attributes
2781         cfs-&gt;skip_u1(method_attribute_length, CHECK_NULL);
2782       }
2783     } else {
2784       // Skip unknown attributes
2785       cfs-&gt;skip_u1(method_attribute_length, CHECK_NULL);
2786     }
2787   }
2788 
2789   if (linenumber_table != NULL) {
2790     linenumber_table-&gt;write_terminator();
2791     linenumber_table_length = linenumber_table-&gt;position();
2792   }
2793 
2794   // Make sure there&#39;s at least one Code attribute in non-native/non-abstract method
2795   if (_need_verify) {
2796     guarantee_property(access_flags.is_native() ||
2797                        access_flags.is_abstract() ||
2798                        parsed_code_attribute,
2799                        &quot;Absent Code attribute in method that is not native or abstract in class file %s&quot;,
2800                        CHECK_NULL);
2801   }
2802 
2803   // All sizing information for a Method* is finally available, now create it
2804   InlineTableSizes sizes(
2805       total_lvt_length,
2806       linenumber_table_length,
2807       exception_table_length,
2808       checked_exceptions_length,
2809       method_parameters_length,
2810       generic_signature_index,
2811       runtime_visible_annotations_length +
2812            runtime_invisible_annotations_length,
2813       runtime_visible_parameter_annotations_length +
2814            runtime_invisible_parameter_annotations_length,
2815       runtime_visible_type_annotations_length +
2816            runtime_invisible_type_annotations_length,
2817       annotation_default_length,
2818       0);
2819 
2820   Method* const m = Method::allocate(_loader_data,
2821                                      code_length,
2822                                      access_flags,
2823                                      &amp;sizes,
2824                                      ConstMethod::NORMAL,
2825                                      CHECK_NULL);
2826 
2827   ClassLoadingService::add_class_method_size(m-&gt;size()*wordSize);
2828 
2829   // Fill in information from fixed part (access_flags already set)
2830   m-&gt;set_constants(_cp);
2831   m-&gt;set_name_index(name_index);
2832   m-&gt;set_signature_index(signature_index);
2833 
2834   ResultTypeFinder rtf(cp-&gt;symbol_at(signature_index));
2835   m-&gt;constMethod()-&gt;set_result_type(rtf.type());
2836 
2837   if (args_size &gt;= 0) {
2838     m-&gt;set_size_of_parameters(args_size);
2839   } else {
2840     m-&gt;compute_size_of_parameters(THREAD);
2841   }
2842 #ifdef ASSERT
2843   if (args_size &gt;= 0) {
2844     m-&gt;compute_size_of_parameters(THREAD);
2845     assert(args_size == m-&gt;size_of_parameters(), &quot;&quot;);
2846   }
2847 #endif
2848 
2849   // Fill in code attribute information
2850   m-&gt;set_max_stack(max_stack);
2851   m-&gt;set_max_locals(max_locals);
2852   if (stackmap_data != NULL) {
2853     m-&gt;constMethod()-&gt;copy_stackmap_data(_loader_data,
2854                                          (u1*)stackmap_data,
2855                                          stackmap_data_length,
2856                                          CHECK_NULL);
2857   }
2858 
2859   // Copy byte codes
2860   m-&gt;set_code((u1*)code_start);
2861 
2862   // Copy line number table
2863   if (linenumber_table != NULL) {
2864     memcpy(m-&gt;compressed_linenumber_table(),
2865            linenumber_table-&gt;buffer(),
2866            linenumber_table_length);
2867   }
2868 
2869   // Copy exception table
2870   if (exception_table_length &gt; 0) {
2871     Copy::conjoint_swap_if_needed&lt;Endian::JAVA&gt;(exception_table_start,
2872                                                 m-&gt;exception_table_start(),
2873                                                 exception_table_length * sizeof(ExceptionTableElement),
2874                                                 sizeof(u2));
2875   }
2876 
2877   // Copy method parameters
2878   if (method_parameters_length &gt; 0) {
2879     MethodParametersElement* elem = m-&gt;constMethod()-&gt;method_parameters_start();
2880     for (int i = 0; i &lt; method_parameters_length; i++) {
2881       elem[i].name_cp_index = Bytes::get_Java_u2((address)method_parameters_data);
2882       method_parameters_data += 2;
2883       elem[i].flags = Bytes::get_Java_u2((address)method_parameters_data);
2884       method_parameters_data += 2;
2885     }
2886   }
2887 
2888   // Copy checked exceptions
2889   if (checked_exceptions_length &gt; 0) {
2890     Copy::conjoint_swap_if_needed&lt;Endian::JAVA&gt;(checked_exceptions_start,
2891                                                 m-&gt;checked_exceptions_start(),
2892                                                 checked_exceptions_length * sizeof(CheckedExceptionElement),
2893                                                 sizeof(u2));
2894   }
2895 
2896   // Copy class file LVT&#39;s/LVTT&#39;s into the HotSpot internal LVT.
2897   if (total_lvt_length &gt; 0) {
2898     promoted_flags-&gt;set_has_localvariable_table();
2899     copy_localvariable_table(m-&gt;constMethod(),
2900                              lvt_cnt,
2901                              localvariable_table_length,
2902                              localvariable_table_start,
2903                              lvtt_cnt,
2904                              localvariable_type_table_length,
2905                              localvariable_type_table_start,
2906                              CHECK_NULL);
2907   }
2908 
2909   if (parsed_annotations.has_any_annotations())
2910     parsed_annotations.apply_to(m);
2911 
2912   // Copy annotations
2913   copy_method_annotations(m-&gt;constMethod(),
2914                           runtime_visible_annotations,
2915                           runtime_visible_annotations_length,
2916                           runtime_invisible_annotations,
2917                           runtime_invisible_annotations_length,
2918                           runtime_visible_parameter_annotations,
2919                           runtime_visible_parameter_annotations_length,
2920                           runtime_invisible_parameter_annotations,
2921                           runtime_invisible_parameter_annotations_length,
2922                           runtime_visible_type_annotations,
2923                           runtime_visible_type_annotations_length,
2924                           runtime_invisible_type_annotations,
2925                           runtime_invisible_type_annotations_length,
2926                           annotation_default,
2927                           annotation_default_length,
2928                           CHECK_NULL);
2929 
2930   if (name == vmSymbols::finalize_method_name() &amp;&amp;
2931       signature == vmSymbols::void_method_signature()) {
2932     if (m-&gt;is_empty_method()) {
2933       _has_empty_finalizer = true;
2934     } else {
2935       _has_finalizer = true;
2936     }
2937   }
2938   if (name == vmSymbols::object_initializer_name() &amp;&amp;
2939       signature == vmSymbols::void_method_signature() &amp;&amp;
2940       m-&gt;is_vanilla_constructor()) {
2941     _has_vanilla_constructor = true;
2942   }
2943 
2944   NOT_PRODUCT(m-&gt;verify());
2945   return m;
2946 }
2947 
2948 
2949 // The promoted_flags parameter is used to pass relevant access_flags
2950 // from the methods back up to the containing klass. These flag values
2951 // are added to klass&#39;s access_flags.
2952 // Side-effects: populates the _methods field in the parser
2953 void ClassFileParser::parse_methods(const ClassFileStream* const cfs,
2954                                     bool is_interface,
2955                                     AccessFlags* promoted_flags,
2956                                     bool* has_final_method,
2957                                     bool* declares_nonstatic_concrete_methods,
2958                                     TRAPS) {
2959   assert(cfs != NULL, &quot;invariant&quot;);
2960   assert(promoted_flags != NULL, &quot;invariant&quot;);
2961   assert(has_final_method != NULL, &quot;invariant&quot;);
2962   assert(declares_nonstatic_concrete_methods != NULL, &quot;invariant&quot;);
2963 
2964   assert(NULL == _methods, &quot;invariant&quot;);
2965 
2966   cfs-&gt;guarantee_more(2, CHECK);  // length
2967   const u2 length = cfs-&gt;get_u2_fast();
2968   if (length == 0) {
2969     _methods = Universe::the_empty_method_array();
2970   } else {
2971     _methods = MetadataFactory::new_array&lt;Method*&gt;(_loader_data,
2972                                                    length,
2973                                                    NULL,
2974                                                    CHECK);
2975 
2976     for (int index = 0; index &lt; length; index++) {
2977       Method* method = parse_method(cfs,
2978                                     is_interface,
2979                                     _cp,
2980                                     promoted_flags,
2981                                     CHECK);
2982 
2983       if (method-&gt;is_final()) {
2984         *has_final_method = true;
2985       }
2986       // declares_nonstatic_concrete_methods: declares concrete instance methods, any access flags
2987       // used for interface initialization, and default method inheritance analysis
2988       if (is_interface &amp;&amp; !(*declares_nonstatic_concrete_methods)
2989         &amp;&amp; !method-&gt;is_abstract() &amp;&amp; !method-&gt;is_static()) {
2990         *declares_nonstatic_concrete_methods = true;
2991       }
2992       _methods-&gt;at_put(index, method);
2993     }
2994 
2995     if (_need_verify &amp;&amp; length &gt; 1) {
2996       // Check duplicated methods
2997       ResourceMark rm(THREAD);
2998       NameSigHash** names_and_sigs = NEW_RESOURCE_ARRAY_IN_THREAD(
2999         THREAD, NameSigHash*, HASH_ROW_SIZE);
3000       initialize_hashtable(names_and_sigs);
3001       bool dup = false;
3002       const Symbol* name = NULL;
3003       const Symbol* sig = NULL;
3004       {
3005         debug_only(NoSafepointVerifier nsv;)
3006         for (int i = 0; i &lt; length; i++) {
3007           const Method* const m = _methods-&gt;at(i);
3008           name = m-&gt;name();
3009           sig = m-&gt;signature();
3010           // If no duplicates, add name/signature in hashtable names_and_sigs.
3011           if (!put_after_lookup(name, sig, names_and_sigs)) {
3012             dup = true;
3013             break;
3014           }
3015         }
3016       }
3017       if (dup) {
3018         classfile_parse_error(&quot;Duplicate method name \&quot;%s\&quot; with signature \&quot;%s\&quot; in class file %s&quot;,
3019                                name-&gt;as_C_string(), sig-&gt;as_klass_external_name(), CHECK);
3020       }
3021     }
3022   }
3023 }
3024 
3025 static const intArray* sort_methods(Array&lt;Method*&gt;* methods) {
3026   const int length = methods-&gt;length();
3027   // If JVMTI original method ordering or sharing is enabled we have to
3028   // remember the original class file ordering.
3029   // We temporarily use the vtable_index field in the Method* to store the
3030   // class file index, so we can read in after calling qsort.
3031   // Put the method ordering in the shared archive.
3032   if (JvmtiExport::can_maintain_original_method_order() || DumpSharedSpaces) {
3033     for (int index = 0; index &lt; length; index++) {
3034       Method* const m = methods-&gt;at(index);
3035       assert(!m-&gt;valid_vtable_index(), &quot;vtable index should not be set&quot;);
3036       m-&gt;set_vtable_index(index);
3037     }
3038   }
3039   // Sort method array by ascending method name (for faster lookups &amp; vtable construction)
3040   // Note that the ordering is not alphabetical, see Symbol::fast_compare
3041   Method::sort_methods(methods);
3042 
3043   intArray* method_ordering = NULL;
3044   // If JVMTI original method ordering or sharing is enabled construct int
3045   // array remembering the original ordering
3046   if (JvmtiExport::can_maintain_original_method_order() || DumpSharedSpaces) {
3047     method_ordering = new intArray(length, length, -1);
3048     for (int index = 0; index &lt; length; index++) {
3049       Method* const m = methods-&gt;at(index);
3050       const int old_index = m-&gt;vtable_index();
3051       assert(old_index &gt;= 0 &amp;&amp; old_index &lt; length, &quot;invalid method index&quot;);
3052       method_ordering-&gt;at_put(index, old_index);
3053       m-&gt;set_vtable_index(Method::invalid_vtable_index);
3054     }
3055   }
3056   return method_ordering;
3057 }
3058 
3059 // Parse generic_signature attribute for methods and fields
3060 u2 ClassFileParser::parse_generic_signature_attribute(const ClassFileStream* const cfs,
3061                                                       TRAPS) {
3062   assert(cfs != NULL, &quot;invariant&quot;);
3063 
3064   cfs-&gt;guarantee_more(2, CHECK_0);  // generic_signature_index
3065   const u2 generic_signature_index = cfs-&gt;get_u2_fast();
3066   check_property(
3067     valid_symbol_at(generic_signature_index),
3068     &quot;Invalid Signature attribute at constant pool index %u in class file %s&quot;,
3069     generic_signature_index, CHECK_0);
3070   return generic_signature_index;
3071 }
3072 
3073 void ClassFileParser::parse_classfile_sourcefile_attribute(const ClassFileStream* const cfs,
3074                                                            TRAPS) {
3075 
3076   assert(cfs != NULL, &quot;invariant&quot;);
3077 
3078   cfs-&gt;guarantee_more(2, CHECK);  // sourcefile_index
3079   const u2 sourcefile_index = cfs-&gt;get_u2_fast();
3080   check_property(
3081     valid_symbol_at(sourcefile_index),
3082     &quot;Invalid SourceFile attribute at constant pool index %u in class file %s&quot;,
3083     sourcefile_index, CHECK);
3084   set_class_sourcefile_index(sourcefile_index);
3085 }
3086 
3087 void ClassFileParser::parse_classfile_source_debug_extension_attribute(const ClassFileStream* const cfs,
3088                                                                        int length,
3089                                                                        TRAPS) {
3090   assert(cfs != NULL, &quot;invariant&quot;);
3091 
3092   const u1* const sde_buffer = cfs-&gt;current();
3093   assert(sde_buffer != NULL, &quot;null sde buffer&quot;);
3094 
3095   // Don&#39;t bother storing it if there is no way to retrieve it
3096   if (JvmtiExport::can_get_source_debug_extension()) {
3097     assert((length+1) &gt; length, &quot;Overflow checking&quot;);
3098     u1* const sde = NEW_RESOURCE_ARRAY_IN_THREAD(THREAD, u1, length+1);
3099     for (int i = 0; i &lt; length; i++) {
3100       sde[i] = sde_buffer[i];
3101     }
3102     sde[length] = &#39;\0&#39;;
3103     set_class_sde_buffer((const char*)sde, length);
3104   }
3105   // Got utf8 string, set stream position forward
3106   cfs-&gt;skip_u1(length, CHECK);
3107 }
3108 
3109 
3110 // Inner classes can be static, private or protected (classic VM does this)
3111 #define RECOGNIZED_INNER_CLASS_MODIFIERS ( JVM_RECOGNIZED_CLASS_MODIFIERS | \
3112                                            JVM_ACC_PRIVATE |                \
3113                                            JVM_ACC_PROTECTED |              \
3114                                            JVM_ACC_STATIC                   \
3115                                          )
3116 
3117 // Return number of classes in the inner classes attribute table
3118 u2 ClassFileParser::parse_classfile_inner_classes_attribute(const ClassFileStream* const cfs,
3119                                                             const u1* const inner_classes_attribute_start,
3120                                                             bool parsed_enclosingmethod_attribute,
3121                                                             u2 enclosing_method_class_index,
3122                                                             u2 enclosing_method_method_index,
3123                                                             TRAPS) {
3124   const u1* const current_mark = cfs-&gt;current();
3125   u2 length = 0;
3126   if (inner_classes_attribute_start != NULL) {
3127     cfs-&gt;set_current(inner_classes_attribute_start);
3128     cfs-&gt;guarantee_more(2, CHECK_0);  // length
3129     length = cfs-&gt;get_u2_fast();
3130   }
3131 
3132   // 4-tuples of shorts of inner classes data and 2 shorts of enclosing
3133   // method data:
3134   //   [inner_class_info_index,
3135   //    outer_class_info_index,
3136   //    inner_name_index,
3137   //    inner_class_access_flags,
3138   //    ...
3139   //    enclosing_method_class_index,
3140   //    enclosing_method_method_index]
3141   const int size = length * 4 + (parsed_enclosingmethod_attribute ? 2 : 0);
3142   Array&lt;u2&gt;* const inner_classes = MetadataFactory::new_array&lt;u2&gt;(_loader_data, size, CHECK_0);
3143   _inner_classes = inner_classes;
3144 
3145   int index = 0;
3146   cfs-&gt;guarantee_more(8 * length, CHECK_0);  // 4-tuples of u2
3147   for (int n = 0; n &lt; length; n++) {
3148     // Inner class index
3149     const u2 inner_class_info_index = cfs-&gt;get_u2_fast();
3150     check_property(
3151       valid_klass_reference_at(inner_class_info_index),
3152       &quot;inner_class_info_index %u has bad constant type in class file %s&quot;,
3153       inner_class_info_index, CHECK_0);
3154     // Outer class index
3155     const u2 outer_class_info_index = cfs-&gt;get_u2_fast();
3156     check_property(
3157       outer_class_info_index == 0 ||
3158         valid_klass_reference_at(outer_class_info_index),
3159       &quot;outer_class_info_index %u has bad constant type in class file %s&quot;,
3160       outer_class_info_index, CHECK_0);
3161     // Inner class name
3162     const u2 inner_name_index = cfs-&gt;get_u2_fast();
3163     check_property(
3164       inner_name_index == 0 || valid_symbol_at(inner_name_index),
3165       &quot;inner_name_index %u has bad constant type in class file %s&quot;,
3166       inner_name_index, CHECK_0);
3167     if (_need_verify) {
3168       guarantee_property(inner_class_info_index != outer_class_info_index,
3169                          &quot;Class is both outer and inner class in class file %s&quot;, CHECK_0);
3170     }
3171     // Access flags
3172     jint flags;
3173     // JVM_ACC_MODULE is defined in JDK-9 and later.
3174     if (_major_version &gt;= JAVA_9_VERSION) {
3175       flags = cfs-&gt;get_u2_fast() &amp; (RECOGNIZED_INNER_CLASS_MODIFIERS | JVM_ACC_MODULE);
3176     } else {
3177       flags = cfs-&gt;get_u2_fast() &amp; RECOGNIZED_INNER_CLASS_MODIFIERS;
3178     }
3179     if ((flags &amp; JVM_ACC_INTERFACE) &amp;&amp; _major_version &lt; JAVA_6_VERSION) {
3180       // Set abstract bit for old class files for backward compatibility
3181       flags |= JVM_ACC_ABSTRACT;
3182     }
3183     verify_legal_class_modifiers(flags, CHECK_0);
3184     AccessFlags inner_access_flags(flags);
3185 
3186     inner_classes-&gt;at_put(index++, inner_class_info_index);
3187     inner_classes-&gt;at_put(index++, outer_class_info_index);
3188     inner_classes-&gt;at_put(index++, inner_name_index);
3189     inner_classes-&gt;at_put(index++, inner_access_flags.as_short());
3190   }
3191 
3192   // 4347400: make sure there&#39;s no duplicate entry in the classes array
3193   if (_need_verify &amp;&amp; _major_version &gt;= JAVA_1_5_VERSION) {
3194     for(int i = 0; i &lt; length * 4; i += 4) {
3195       for(int j = i + 4; j &lt; length * 4; j += 4) {
3196         guarantee_property((inner_classes-&gt;at(i)   != inner_classes-&gt;at(j) ||
3197                             inner_classes-&gt;at(i+1) != inner_classes-&gt;at(j+1) ||
3198                             inner_classes-&gt;at(i+2) != inner_classes-&gt;at(j+2) ||
3199                             inner_classes-&gt;at(i+3) != inner_classes-&gt;at(j+3)),
3200                             &quot;Duplicate entry in InnerClasses in class file %s&quot;,
3201                             CHECK_0);
3202       }
3203     }
3204   }
3205 
3206   // Set EnclosingMethod class and method indexes.
3207   if (parsed_enclosingmethod_attribute) {
3208     inner_classes-&gt;at_put(index++, enclosing_method_class_index);
3209     inner_classes-&gt;at_put(index++, enclosing_method_method_index);
3210   }
3211   assert(index == size, &quot;wrong size&quot;);
3212 
3213   // Restore buffer&#39;s current position.
3214   cfs-&gt;set_current(current_mark);
3215 
3216   return length;
3217 }
3218 
3219 u2 ClassFileParser::parse_classfile_nest_members_attribute(const ClassFileStream* const cfs,
3220                                                            const u1* const nest_members_attribute_start,
3221                                                            TRAPS) {
3222   const u1* const current_mark = cfs-&gt;current();
3223   u2 length = 0;
3224   if (nest_members_attribute_start != NULL) {
3225     cfs-&gt;set_current(nest_members_attribute_start);
3226     cfs-&gt;guarantee_more(2, CHECK_0);  // length
3227     length = cfs-&gt;get_u2_fast();
3228   }
3229   const int size = length;
3230   Array&lt;u2&gt;* const nest_members = MetadataFactory::new_array&lt;u2&gt;(_loader_data, size, CHECK_0);
3231   _nest_members = nest_members;
3232 
3233   int index = 0;
3234   cfs-&gt;guarantee_more(2 * length, CHECK_0);
3235   for (int n = 0; n &lt; length; n++) {
3236     const u2 class_info_index = cfs-&gt;get_u2_fast();
3237     check_property(
3238       valid_klass_reference_at(class_info_index),
3239       &quot;Nest member class_info_index %u has bad constant type in class file %s&quot;,
3240       class_info_index, CHECK_0);
3241     nest_members-&gt;at_put(index++, class_info_index);
3242   }
3243   assert(index == size, &quot;wrong size&quot;);
3244 
3245   // Restore buffer&#39;s current position.
3246   cfs-&gt;set_current(current_mark);
3247 
3248   return length;
3249 }
3250 
3251 void ClassFileParser::parse_classfile_synthetic_attribute(TRAPS) {
3252   set_class_synthetic_flag(true);
3253 }
3254 
3255 void ClassFileParser::parse_classfile_signature_attribute(const ClassFileStream* const cfs, TRAPS) {
3256   assert(cfs != NULL, &quot;invariant&quot;);
3257 
3258   const u2 signature_index = cfs-&gt;get_u2(CHECK);
3259   check_property(
3260     valid_symbol_at(signature_index),
3261     &quot;Invalid constant pool index %u in Signature attribute in class file %s&quot;,
3262     signature_index, CHECK);
3263   set_class_generic_signature_index(signature_index);
3264 }
3265 
3266 void ClassFileParser::parse_classfile_bootstrap_methods_attribute(const ClassFileStream* const cfs,
3267                                                                   ConstantPool* cp,
3268                                                                   u4 attribute_byte_length,
3269                                                                   TRAPS) {
3270   assert(cfs != NULL, &quot;invariant&quot;);
3271   assert(cp != NULL, &quot;invariant&quot;);
3272 
3273   const u1* const current_start = cfs-&gt;current();
3274 
3275   guarantee_property(attribute_byte_length &gt;= sizeof(u2),
3276                      &quot;Invalid BootstrapMethods attribute length %u in class file %s&quot;,
3277                      attribute_byte_length,
3278                      CHECK);
3279 
3280   cfs-&gt;guarantee_more(attribute_byte_length, CHECK);
3281 
3282   const int attribute_array_length = cfs-&gt;get_u2_fast();
3283 
3284   guarantee_property(_max_bootstrap_specifier_index &lt; attribute_array_length,
3285                      &quot;Short length on BootstrapMethods in class file %s&quot;,
3286                      CHECK);
3287 
3288 
3289   // The attribute contains a counted array of counted tuples of shorts,
3290   // represending bootstrap specifiers:
3291   //    length*{bootstrap_method_index, argument_count*{argument_index}}
3292   const int operand_count = (attribute_byte_length - sizeof(u2)) / sizeof(u2);
3293   // operand_count = number of shorts in attr, except for leading length
3294 
3295   // The attribute is copied into a short[] array.
3296   // The array begins with a series of short[2] pairs, one for each tuple.
3297   const int index_size = (attribute_array_length * 2);
3298 
3299   Array&lt;u2&gt;* const operands =
3300     MetadataFactory::new_array&lt;u2&gt;(_loader_data, index_size + operand_count, CHECK);
3301 
3302   // Eagerly assign operands so they will be deallocated with the constant
3303   // pool if there is an error.
3304   cp-&gt;set_operands(operands);
3305 
3306   int operand_fill_index = index_size;
3307   const int cp_size = cp-&gt;length();
3308 
3309   for (int n = 0; n &lt; attribute_array_length; n++) {
3310     // Store a 32-bit offset into the header of the operand array.
3311     ConstantPool::operand_offset_at_put(operands, n, operand_fill_index);
3312 
3313     // Read a bootstrap specifier.
3314     cfs-&gt;guarantee_more(sizeof(u2) * 2, CHECK);  // bsm, argc
3315     const u2 bootstrap_method_index = cfs-&gt;get_u2_fast();
3316     const u2 argument_count = cfs-&gt;get_u2_fast();
3317     check_property(
3318       valid_cp_range(bootstrap_method_index, cp_size) &amp;&amp;
3319       cp-&gt;tag_at(bootstrap_method_index).is_method_handle(),
3320       &quot;bootstrap_method_index %u has bad constant type in class file %s&quot;,
3321       bootstrap_method_index,
3322       CHECK);
3323 
3324     guarantee_property((operand_fill_index + 1 + argument_count) &lt; operands-&gt;length(),
3325       &quot;Invalid BootstrapMethods num_bootstrap_methods or num_bootstrap_arguments value in class file %s&quot;,
3326       CHECK);
3327 
3328     operands-&gt;at_put(operand_fill_index++, bootstrap_method_index);
3329     operands-&gt;at_put(operand_fill_index++, argument_count);
3330 
3331     cfs-&gt;guarantee_more(sizeof(u2) * argument_count, CHECK);  // argv[argc]
3332     for (int j = 0; j &lt; argument_count; j++) {
3333       const u2 argument_index = cfs-&gt;get_u2_fast();
3334       check_property(
3335         valid_cp_range(argument_index, cp_size) &amp;&amp;
3336         cp-&gt;tag_at(argument_index).is_loadable_constant(),
3337         &quot;argument_index %u has bad constant type in class file %s&quot;,
3338         argument_index,
3339         CHECK);
3340       operands-&gt;at_put(operand_fill_index++, argument_index);
3341     }
3342   }
3343   guarantee_property(current_start + attribute_byte_length == cfs-&gt;current(),
3344                      &quot;Bad length on BootstrapMethods in class file %s&quot;,
3345                      CHECK);
3346 }
3347 
3348 void ClassFileParser::parse_classfile_attributes(const ClassFileStream* const cfs,
3349                                                  ConstantPool* cp,
3350                  ClassFileParser::ClassAnnotationCollector* parsed_annotations,
3351                                                  TRAPS) {
3352   assert(cfs != NULL, &quot;invariant&quot;);
3353   assert(cp != NULL, &quot;invariant&quot;);
3354   assert(parsed_annotations != NULL, &quot;invariant&quot;);
3355 
3356   // Set inner classes attribute to default sentinel
3357   _inner_classes = Universe::the_empty_short_array();
3358   // Set nest members attribute to default sentinel
3359   _nest_members = Universe::the_empty_short_array();
3360   cfs-&gt;guarantee_more(2, CHECK);  // attributes_count
3361   u2 attributes_count = cfs-&gt;get_u2_fast();
3362   bool parsed_sourcefile_attribute = false;
3363   bool parsed_innerclasses_attribute = false;
3364   bool parsed_nest_members_attribute = false;
3365   bool parsed_nest_host_attribute = false;
3366   bool parsed_enclosingmethod_attribute = false;
3367   bool parsed_bootstrap_methods_attribute = false;
3368   const u1* runtime_visible_annotations = NULL;
3369   int runtime_visible_annotations_length = 0;
3370   const u1* runtime_invisible_annotations = NULL;
3371   int runtime_invisible_annotations_length = 0;
3372   const u1* runtime_visible_type_annotations = NULL;
3373   int runtime_visible_type_annotations_length = 0;
3374   const u1* runtime_invisible_type_annotations = NULL;
3375   int runtime_invisible_type_annotations_length = 0;
3376   bool runtime_invisible_type_annotations_exists = false;
3377   bool runtime_invisible_annotations_exists = false;
3378   bool parsed_source_debug_ext_annotations_exist = false;
3379   const u1* inner_classes_attribute_start = NULL;
3380   u4  inner_classes_attribute_length = 0;
3381   u2  enclosing_method_class_index = 0;
3382   u2  enclosing_method_method_index = 0;
3383   const u1* nest_members_attribute_start = NULL;
3384   u4  nest_members_attribute_length = 0;
3385 
3386   // Iterate over attributes
3387   while (attributes_count--) {
3388     cfs-&gt;guarantee_more(6, CHECK);  // attribute_name_index, attribute_length
3389     const u2 attribute_name_index = cfs-&gt;get_u2_fast();
3390     const u4 attribute_length = cfs-&gt;get_u4_fast();
3391     check_property(
3392       valid_symbol_at(attribute_name_index),
3393       &quot;Attribute name has bad constant pool index %u in class file %s&quot;,
3394       attribute_name_index, CHECK);
3395     const Symbol* const tag = cp-&gt;symbol_at(attribute_name_index);
3396     if (tag == vmSymbols::tag_source_file()) {
3397       // Check for SourceFile tag
3398       if (_need_verify) {
3399         guarantee_property(attribute_length == 2, &quot;Wrong SourceFile attribute length in class file %s&quot;, CHECK);
3400       }
3401       if (parsed_sourcefile_attribute) {
3402         classfile_parse_error(&quot;Multiple SourceFile attributes in class file %s&quot;, CHECK);
3403       } else {
3404         parsed_sourcefile_attribute = true;
3405       }
3406       parse_classfile_sourcefile_attribute(cfs, CHECK);
3407     } else if (tag == vmSymbols::tag_source_debug_extension()) {
3408       // Check for SourceDebugExtension tag
3409       if (parsed_source_debug_ext_annotations_exist) {
3410           classfile_parse_error(
3411             &quot;Multiple SourceDebugExtension attributes in class file %s&quot;, CHECK);
3412       }
3413       parsed_source_debug_ext_annotations_exist = true;
3414       parse_classfile_source_debug_extension_attribute(cfs, (int)attribute_length, CHECK);
3415     } else if (tag == vmSymbols::tag_inner_classes()) {
3416       // Check for InnerClasses tag
3417       if (parsed_innerclasses_attribute) {
3418         classfile_parse_error(&quot;Multiple InnerClasses attributes in class file %s&quot;, CHECK);
3419       } else {
3420         parsed_innerclasses_attribute = true;
3421       }
3422       inner_classes_attribute_start = cfs-&gt;current();
3423       inner_classes_attribute_length = attribute_length;
3424       cfs-&gt;skip_u1(inner_classes_attribute_length, CHECK);
3425     } else if (tag == vmSymbols::tag_synthetic()) {
3426       // Check for Synthetic tag
3427       // Shouldn&#39;t we check that the synthetic flags wasn&#39;t already set? - not required in spec
3428       if (attribute_length != 0) {
3429         classfile_parse_error(
3430           &quot;Invalid Synthetic classfile attribute length %u in class file %s&quot;,
3431           attribute_length, CHECK);
3432       }
3433       parse_classfile_synthetic_attribute(CHECK);
3434     } else if (tag == vmSymbols::tag_deprecated()) {
3435       // Check for Deprecatd tag - 4276120
3436       if (attribute_length != 0) {
3437         classfile_parse_error(
3438           &quot;Invalid Deprecated classfile attribute length %u in class file %s&quot;,
3439           attribute_length, CHECK);
3440       }
3441     } else if (_major_version &gt;= JAVA_1_5_VERSION) {
3442       if (tag == vmSymbols::tag_signature()) {
3443         if (_generic_signature_index != 0) {
3444           classfile_parse_error(
3445             &quot;Multiple Signature attributes in class file %s&quot;, CHECK);
3446         }
3447         if (attribute_length != 2) {
3448           classfile_parse_error(
3449             &quot;Wrong Signature attribute length %u in class file %s&quot;,
3450             attribute_length, CHECK);
3451         }
3452         parse_classfile_signature_attribute(cfs, CHECK);
3453       } else if (tag == vmSymbols::tag_runtime_visible_annotations()) {
3454         if (runtime_visible_annotations != NULL) {
3455           classfile_parse_error(
3456             &quot;Multiple RuntimeVisibleAnnotations attributes in class file %s&quot;, CHECK);
3457         }
3458         runtime_visible_annotations_length = attribute_length;
3459         runtime_visible_annotations = cfs-&gt;current();
3460         assert(runtime_visible_annotations != NULL, &quot;null visible annotations&quot;);
3461         cfs-&gt;guarantee_more(runtime_visible_annotations_length, CHECK);
3462         parse_annotations(cp,
3463                           runtime_visible_annotations,
3464                           runtime_visible_annotations_length,
3465                           parsed_annotations,
3466                           _loader_data,
3467                           CHECK);
3468         cfs-&gt;skip_u1_fast(runtime_visible_annotations_length);
3469       } else if (tag == vmSymbols::tag_runtime_invisible_annotations()) {
3470         if (runtime_invisible_annotations_exists) {
3471           classfile_parse_error(
3472             &quot;Multiple RuntimeInvisibleAnnotations attributes in class file %s&quot;, CHECK);
3473         }
3474         runtime_invisible_annotations_exists = true;
3475         if (PreserveAllAnnotations) {
3476           runtime_invisible_annotations_length = attribute_length;
3477           runtime_invisible_annotations = cfs-&gt;current();
3478           assert(runtime_invisible_annotations != NULL, &quot;null invisible annotations&quot;);
3479         }
3480         cfs-&gt;skip_u1(attribute_length, CHECK);
3481       } else if (tag == vmSymbols::tag_enclosing_method()) {
3482         if (parsed_enclosingmethod_attribute) {
3483           classfile_parse_error(&quot;Multiple EnclosingMethod attributes in class file %s&quot;, CHECK);
3484         } else {
3485           parsed_enclosingmethod_attribute = true;
3486         }
3487         guarantee_property(attribute_length == 4,
3488           &quot;Wrong EnclosingMethod attribute length %u in class file %s&quot;,
3489           attribute_length, CHECK);
3490         cfs-&gt;guarantee_more(4, CHECK);  // class_index, method_index
3491         enclosing_method_class_index  = cfs-&gt;get_u2_fast();
3492         enclosing_method_method_index = cfs-&gt;get_u2_fast();
3493         if (enclosing_method_class_index == 0) {
3494           classfile_parse_error(&quot;Invalid class index in EnclosingMethod attribute in class file %s&quot;, CHECK);
3495         }
3496         // Validate the constant pool indices and types
3497         check_property(valid_klass_reference_at(enclosing_method_class_index),
3498           &quot;Invalid or out-of-bounds class index in EnclosingMethod attribute in class file %s&quot;, CHECK);
3499         if (enclosing_method_method_index != 0 &amp;&amp;
3500             (!cp-&gt;is_within_bounds(enclosing_method_method_index) ||
3501              !cp-&gt;tag_at(enclosing_method_method_index).is_name_and_type())) {
3502           classfile_parse_error(&quot;Invalid or out-of-bounds method index in EnclosingMethod attribute in class file %s&quot;, CHECK);
3503         }
3504       } else if (tag == vmSymbols::tag_bootstrap_methods() &amp;&amp;
3505                  _major_version &gt;= Verifier::INVOKEDYNAMIC_MAJOR_VERSION) {
3506         if (parsed_bootstrap_methods_attribute) {
3507           classfile_parse_error(&quot;Multiple BootstrapMethods attributes in class file %s&quot;, CHECK);
3508         }
3509         parsed_bootstrap_methods_attribute = true;
3510         parse_classfile_bootstrap_methods_attribute(cfs, cp, attribute_length, CHECK);
3511       } else if (tag == vmSymbols::tag_runtime_visible_type_annotations()) {
3512         if (runtime_visible_type_annotations != NULL) {
3513           classfile_parse_error(
3514             &quot;Multiple RuntimeVisibleTypeAnnotations attributes in class file %s&quot;, CHECK);
3515         }
3516         runtime_visible_type_annotations_length = attribute_length;
3517         runtime_visible_type_annotations = cfs-&gt;current();
3518         assert(runtime_visible_type_annotations != NULL, &quot;null visible type annotations&quot;);
3519         // No need for the VM to parse Type annotations
3520         cfs-&gt;skip_u1(runtime_visible_type_annotations_length, CHECK);
3521       } else if (tag == vmSymbols::tag_runtime_invisible_type_annotations()) {
3522         if (runtime_invisible_type_annotations_exists) {
3523           classfile_parse_error(
3524             &quot;Multiple RuntimeInvisibleTypeAnnotations attributes in class file %s&quot;, CHECK);
3525         } else {
3526           runtime_invisible_type_annotations_exists = true;
3527         }
3528         if (PreserveAllAnnotations) {
3529           runtime_invisible_type_annotations_length = attribute_length;
3530           runtime_invisible_type_annotations = cfs-&gt;current();
3531           assert(runtime_invisible_type_annotations != NULL, &quot;null invisible type annotations&quot;);
3532         }
3533         cfs-&gt;skip_u1(attribute_length, CHECK);
3534       } else if (_major_version &gt;= JAVA_11_VERSION) {
3535         if (tag == vmSymbols::tag_nest_members()) {
3536           // Check for NestMembers tag
3537           if (parsed_nest_members_attribute) {
3538             classfile_parse_error(&quot;Multiple NestMembers attributes in class file %s&quot;, CHECK);
3539           } else {
3540             parsed_nest_members_attribute = true;
3541           }
3542           if (parsed_nest_host_attribute) {
3543             classfile_parse_error(&quot;Conflicting NestHost and NestMembers attributes in class file %s&quot;, CHECK);
3544           }
3545           nest_members_attribute_start = cfs-&gt;current();
3546           nest_members_attribute_length = attribute_length;
3547           cfs-&gt;skip_u1(nest_members_attribute_length, CHECK);
3548         } else if (tag == vmSymbols::tag_nest_host()) {
3549           if (parsed_nest_host_attribute) {
3550             classfile_parse_error(&quot;Multiple NestHost attributes in class file %s&quot;, CHECK);
3551           } else {
3552             parsed_nest_host_attribute = true;
3553           }
3554           if (parsed_nest_members_attribute) {
3555             classfile_parse_error(&quot;Conflicting NestMembers and NestHost attributes in class file %s&quot;, CHECK);
3556           }
3557           if (_need_verify) {
3558             guarantee_property(attribute_length == 2, &quot;Wrong NestHost attribute length in class file %s&quot;, CHECK);
3559           }
3560           cfs-&gt;guarantee_more(2, CHECK);
3561           u2 class_info_index = cfs-&gt;get_u2_fast();
3562           check_property(
3563                          valid_klass_reference_at(class_info_index),
3564                          &quot;Nest-host class_info_index %u has bad constant type in class file %s&quot;,
3565                          class_info_index, CHECK);
3566           _nest_host = class_info_index;
3567         } else {
3568           // Unknown attribute
3569           cfs-&gt;skip_u1(attribute_length, CHECK);
3570         }
3571       } else {
3572         // Unknown attribute
3573         cfs-&gt;skip_u1(attribute_length, CHECK);
3574       }
3575     } else {
3576       // Unknown attribute
3577       cfs-&gt;skip_u1(attribute_length, CHECK);
3578     }
3579   }
3580   _annotations = assemble_annotations(runtime_visible_annotations,
3581                                       runtime_visible_annotations_length,
3582                                       runtime_invisible_annotations,
3583                                       runtime_invisible_annotations_length,
3584                                       CHECK);
3585   _type_annotations = assemble_annotations(runtime_visible_type_annotations,
3586                                            runtime_visible_type_annotations_length,
3587                                            runtime_invisible_type_annotations,
3588                                            runtime_invisible_type_annotations_length,
3589                                            CHECK);
3590 
3591   if (parsed_innerclasses_attribute || parsed_enclosingmethod_attribute) {
3592     const u2 num_of_classes = parse_classfile_inner_classes_attribute(
3593                             cfs,
3594                             inner_classes_attribute_start,
3595                             parsed_innerclasses_attribute,
3596                             enclosing_method_class_index,
3597                             enclosing_method_method_index,
3598                             CHECK);
3599     if (parsed_innerclasses_attribute &amp;&amp; _need_verify &amp;&amp; _major_version &gt;= JAVA_1_5_VERSION) {
3600       guarantee_property(
3601         inner_classes_attribute_length == sizeof(num_of_classes) + 4 * sizeof(u2) * num_of_classes,
3602         &quot;Wrong InnerClasses attribute length in class file %s&quot;, CHECK);
3603     }
3604   }
3605 
3606   if (parsed_nest_members_attribute) {
3607     const u2 num_of_classes = parse_classfile_nest_members_attribute(
3608                             cfs,
3609                             nest_members_attribute_start,
3610                             CHECK);
3611     if (_need_verify) {
3612       guarantee_property(
3613         nest_members_attribute_length == sizeof(num_of_classes) + sizeof(u2) * num_of_classes,
3614         &quot;Wrong NestMembers attribute length in class file %s&quot;, CHECK);
3615     }
3616   }
3617 
3618   if (_max_bootstrap_specifier_index &gt;= 0) {
3619     guarantee_property(parsed_bootstrap_methods_attribute,
3620                        &quot;Missing BootstrapMethods attribute in class file %s&quot;, CHECK);
3621   }
3622 }
3623 
3624 void ClassFileParser::apply_parsed_class_attributes(InstanceKlass* k) {
3625   assert(k != NULL, &quot;invariant&quot;);
3626 
3627   if (_synthetic_flag)
3628     k-&gt;set_is_synthetic();
3629   if (_sourcefile_index != 0) {
3630     k-&gt;set_source_file_name_index(_sourcefile_index);
3631   }
3632   if (_generic_signature_index != 0) {
3633     k-&gt;set_generic_signature_index(_generic_signature_index);
3634   }
3635   if (_sde_buffer != NULL) {
3636     k-&gt;set_source_debug_extension(_sde_buffer, _sde_length);
3637   }
3638 }
3639 
3640 // Create the Annotations object that will
3641 // hold the annotations array for the Klass.
3642 void ClassFileParser::create_combined_annotations(TRAPS) {
3643     if (_annotations == NULL &amp;&amp;
3644         _type_annotations == NULL &amp;&amp;
3645         _fields_annotations == NULL &amp;&amp;
3646         _fields_type_annotations == NULL) {
3647       // Don&#39;t create the Annotations object unnecessarily.
3648       return;
3649     }
3650 
3651     Annotations* const annotations = Annotations::allocate(_loader_data, CHECK);
3652     annotations-&gt;set_class_annotations(_annotations);
3653     annotations-&gt;set_class_type_annotations(_type_annotations);
3654     annotations-&gt;set_fields_annotations(_fields_annotations);
3655     annotations-&gt;set_fields_type_annotations(_fields_type_annotations);
3656 
3657     // This is the Annotations object that will be
3658     // assigned to InstanceKlass being constructed.
3659     _combined_annotations = annotations;
3660 
3661     // The annotations arrays below has been transfered the
3662     // _combined_annotations so these fields can now be cleared.
3663     _annotations             = NULL;
3664     _type_annotations        = NULL;
3665     _fields_annotations      = NULL;
3666     _fields_type_annotations = NULL;
3667 }
3668 
3669 // Transfer ownership of metadata allocated to the InstanceKlass.
3670 void ClassFileParser::apply_parsed_class_metadata(
3671                                             InstanceKlass* this_klass,
3672                                             int java_fields_count, TRAPS) {
3673   assert(this_klass != NULL, &quot;invariant&quot;);
3674 
3675   _cp-&gt;set_pool_holder(this_klass);
3676   this_klass-&gt;set_constants(_cp);
3677   this_klass-&gt;set_fields(_fields, java_fields_count);
3678   this_klass-&gt;set_methods(_methods);
3679   this_klass-&gt;set_inner_classes(_inner_classes);
3680   this_klass-&gt;set_nest_members(_nest_members);
3681   this_klass-&gt;set_nest_host_index(_nest_host);
3682   this_klass-&gt;set_local_interfaces(_local_interfaces);
3683   this_klass-&gt;set_annotations(_combined_annotations);
3684   // Delay the setting of _transitive_interfaces until after initialize_supers() in
3685   // fill_instance_klass(). It is because the _transitive_interfaces may be shared with
3686   // its _super. If an OOM occurs while loading the current klass, its _super field
3687   // may not have been set. When GC tries to free the klass, the _transitive_interfaces
3688   // may be deallocated mistakenly in InstanceKlass::deallocate_interfaces(). Subsequent
3689   // dereferences to the deallocated _transitive_interfaces will result in a crash.
3690 
3691   // Clear out these fields so they don&#39;t get deallocated by the destructor
3692   clear_class_metadata();
3693 }
3694 
3695 AnnotationArray* ClassFileParser::assemble_annotations(const u1* const runtime_visible_annotations,
3696                                                        int runtime_visible_annotations_length,
3697                                                        const u1* const runtime_invisible_annotations,
3698                                                        int runtime_invisible_annotations_length,
3699                                                        TRAPS) {
3700   AnnotationArray* annotations = NULL;
3701   if (runtime_visible_annotations != NULL ||
3702       runtime_invisible_annotations != NULL) {
3703     annotations = MetadataFactory::new_array&lt;u1&gt;(_loader_data,
3704                                           runtime_visible_annotations_length +
3705                                           runtime_invisible_annotations_length,
3706                                           CHECK_(annotations));
3707     if (runtime_visible_annotations != NULL) {
3708       for (int i = 0; i &lt; runtime_visible_annotations_length; i++) {
3709         annotations-&gt;at_put(i, runtime_visible_annotations[i]);
3710       }
3711     }
3712     if (runtime_invisible_annotations != NULL) {
3713       for (int i = 0; i &lt; runtime_invisible_annotations_length; i++) {
3714         int append = runtime_visible_annotations_length+i;
3715         annotations-&gt;at_put(append, runtime_invisible_annotations[i]);
3716       }
3717     }
3718   }
3719   return annotations;
3720 }
3721 
3722 const InstanceKlass* ClassFileParser::parse_super_class(ConstantPool* const cp,
3723                                                         const int super_class_index,
3724                                                         const bool need_verify,
3725                                                         TRAPS) {
3726   assert(cp != NULL, &quot;invariant&quot;);
3727   const InstanceKlass* super_klass = NULL;
3728 
3729   if (super_class_index == 0) {
3730     check_property(_class_name == vmSymbols::java_lang_Object(),
3731                    &quot;Invalid superclass index %u in class file %s&quot;,
3732                    super_class_index,
3733                    CHECK_NULL);
3734   } else {
3735     check_property(valid_klass_reference_at(super_class_index),
3736                    &quot;Invalid superclass index %u in class file %s&quot;,
3737                    super_class_index,
3738                    CHECK_NULL);
3739     // The class name should be legal because it is checked when parsing constant pool.
3740     // However, make sure it is not an array type.
3741     bool is_array = false;
3742     if (cp-&gt;tag_at(super_class_index).is_klass()) {
3743       super_klass = InstanceKlass::cast(cp-&gt;resolved_klass_at(super_class_index));
3744       if (need_verify)
3745         is_array = super_klass-&gt;is_array_klass();
3746     } else if (need_verify) {
3747       is_array = (cp-&gt;klass_name_at(super_class_index)-&gt;char_at(0) == JVM_SIGNATURE_ARRAY);
3748     }
3749     if (need_verify) {
3750       guarantee_property(!is_array,
3751                         &quot;Bad superclass name in class file %s&quot;, CHECK_NULL);
3752     }
3753   }
3754   return super_klass;
3755 }
3756 
3757 static unsigned int compute_oop_map_count(const InstanceKlass* super,
3758                                           unsigned int nonstatic_oop_map_count,
3759                                           int first_nonstatic_oop_offset) {
3760 
3761   unsigned int map_count =
3762     NULL == super ? 0 : super-&gt;nonstatic_oop_map_count();
3763   if (nonstatic_oop_map_count &gt; 0) {
3764     // We have oops to add to map
3765     if (map_count == 0) {
3766       map_count = nonstatic_oop_map_count;
3767     }
3768     else {
3769       // Check whether we should add a new map block or whether the last one can
3770       // be extended
3771       const OopMapBlock* const first_map = super-&gt;start_of_nonstatic_oop_maps();
3772       const OopMapBlock* const last_map = first_map + map_count - 1;
3773 
3774       const int next_offset = last_map-&gt;offset() + last_map-&gt;count() * heapOopSize;
3775       if (next_offset == first_nonstatic_oop_offset) {
3776         // There is no gap bettwen superklass&#39;s last oop field and first
3777         // local oop field, merge maps.
3778         nonstatic_oop_map_count -= 1;
3779       }
3780       else {
3781         // Superklass didn&#39;t end with a oop field, add extra maps
3782         assert(next_offset &lt; first_nonstatic_oop_offset, &quot;just checking&quot;);
3783       }
3784       map_count += nonstatic_oop_map_count;
3785     }
3786   }
3787   return map_count;
3788 }
3789 
3790 #ifndef PRODUCT
3791 static void print_field_layout(const Symbol* name,
3792                                Array&lt;u2&gt;* fields,
3793                                const constantPoolHandle&amp; cp,
3794                                int instance_size,
3795                                int instance_fields_start,
3796                                int instance_fields_end,
3797                                int static_fields_end) {
3798 
3799   assert(name != NULL, &quot;invariant&quot;);
3800 
3801   tty-&gt;print(&quot;%s: field layout\n&quot;, name-&gt;as_klass_external_name());
3802   tty-&gt;print(&quot;  @%3d %s\n&quot;, instance_fields_start, &quot;--- instance fields start ---&quot;);
3803   for (AllFieldStream fs(fields, cp); !fs.done(); fs.next()) {
3804     if (!fs.access_flags().is_static()) {
3805       tty-&gt;print(&quot;  @%3d \&quot;%s\&quot; %s\n&quot;,
3806         fs.offset(),
3807         fs.name()-&gt;as_klass_external_name(),
3808         fs.signature()-&gt;as_klass_external_name());
3809     }
3810   }
3811   tty-&gt;print(&quot;  @%3d %s\n&quot;, instance_fields_end, &quot;--- instance fields end ---&quot;);
3812   tty-&gt;print(&quot;  @%3d %s\n&quot;, instance_size * wordSize, &quot;--- instance ends ---&quot;);
3813   tty-&gt;print(&quot;  @%3d %s\n&quot;, InstanceMirrorKlass::offset_of_static_fields(), &quot;--- static fields start ---&quot;);
3814   for (AllFieldStream fs(fields, cp); !fs.done(); fs.next()) {
3815     if (fs.access_flags().is_static()) {
3816       tty-&gt;print(&quot;  @%3d \&quot;%s\&quot; %s\n&quot;,
3817         fs.offset(),
3818         fs.name()-&gt;as_klass_external_name(),
3819         fs.signature()-&gt;as_klass_external_name());
3820     }
3821   }
3822   tty-&gt;print(&quot;  @%3d %s\n&quot;, static_fields_end, &quot;--- static fields end ---&quot;);
3823   tty-&gt;print(&quot;\n&quot;);
3824 }
3825 #endif
3826 
3827 // Values needed for oopmap and InstanceKlass creation
3828 class ClassFileParser::FieldLayoutInfo : public ResourceObj {
3829  public:
3830   int*          nonstatic_oop_offsets;
3831   unsigned int* nonstatic_oop_counts;
3832   unsigned int  nonstatic_oop_map_count;
3833   unsigned int  total_oop_map_count;
3834   int           instance_size;
3835   int           nonstatic_field_size;
3836   int           static_field_size;
3837   bool          has_nonstatic_fields;
3838 };
3839 
3840 // Layout fields and fill in FieldLayoutInfo.  Could use more refactoring!
3841 void ClassFileParser::layout_fields(ConstantPool* cp,
3842                                     const FieldAllocationCount* fac,
3843                                     const ClassAnnotationCollector* parsed_annotations,
3844                                     FieldLayoutInfo* info,
3845                                     TRAPS) {
3846 
3847   assert(cp != NULL, &quot;invariant&quot;);
3848 
3849   // Field size and offset computation
3850   int nonstatic_field_size = _super_klass == NULL ? 0 :
3851                                _super_klass-&gt;nonstatic_field_size();
3852 
3853   // Count the contended fields by type.
3854   //
3855   // We ignore static fields, because @Contended is not supported for them.
3856   // The layout code below will also ignore the static fields.
3857   int nonstatic_contended_count = 0;
3858   FieldAllocationCount fac_contended;
3859   for (AllFieldStream fs(_fields, cp); !fs.done(); fs.next()) {
3860     FieldAllocationType atype = (FieldAllocationType) fs.allocation_type();
3861     if (fs.is_contended()) {
3862       fac_contended.count[atype]++;
3863       if (!fs.access_flags().is_static()) {
3864         nonstatic_contended_count++;
3865       }
3866     }
3867   }
3868 
3869 
3870   // Calculate the starting byte offsets
3871   int next_static_oop_offset    = InstanceMirrorKlass::offset_of_static_fields();
3872   int next_static_double_offset = next_static_oop_offset +
3873                                       ((fac-&gt;count[STATIC_OOP]) * heapOopSize);
3874   if (fac-&gt;count[STATIC_DOUBLE]) {
3875     next_static_double_offset = align_up(next_static_double_offset, BytesPerLong);
3876   }
3877 
3878   int next_static_word_offset   = next_static_double_offset +
3879                                     ((fac-&gt;count[STATIC_DOUBLE]) * BytesPerLong);
3880   int next_static_short_offset  = next_static_word_offset +
3881                                     ((fac-&gt;count[STATIC_WORD]) * BytesPerInt);
3882   int next_static_byte_offset   = next_static_short_offset +
3883                                   ((fac-&gt;count[STATIC_SHORT]) * BytesPerShort);
3884 
3885   int nonstatic_fields_start  = instanceOopDesc::base_offset_in_bytes() +
3886                                 nonstatic_field_size * heapOopSize;
3887 
3888   int next_nonstatic_field_offset = nonstatic_fields_start;
3889 
3890   const bool is_contended_class     = parsed_annotations-&gt;is_contended();
3891 
3892   // Class is contended, pad before all the fields
3893   if (is_contended_class) {
3894     next_nonstatic_field_offset += ContendedPaddingWidth;
3895   }
3896 
3897   // Compute the non-contended fields count.
3898   // The packing code below relies on these counts to determine if some field
3899   // can be squeezed into the alignment gap. Contended fields are obviously
3900   // exempt from that.
3901   unsigned int nonstatic_double_count = fac-&gt;count[NONSTATIC_DOUBLE] - fac_contended.count[NONSTATIC_DOUBLE];
3902   unsigned int nonstatic_word_count   = fac-&gt;count[NONSTATIC_WORD]   - fac_contended.count[NONSTATIC_WORD];
3903   unsigned int nonstatic_short_count  = fac-&gt;count[NONSTATIC_SHORT]  - fac_contended.count[NONSTATIC_SHORT];
3904   unsigned int nonstatic_byte_count   = fac-&gt;count[NONSTATIC_BYTE]   - fac_contended.count[NONSTATIC_BYTE];
3905   unsigned int nonstatic_oop_count    = fac-&gt;count[NONSTATIC_OOP]    - fac_contended.count[NONSTATIC_OOP];
3906 
3907   // Total non-static fields count, including every contended field
3908   unsigned int nonstatic_fields_count = fac-&gt;count[NONSTATIC_DOUBLE] + fac-&gt;count[NONSTATIC_WORD] +
3909                                         fac-&gt;count[NONSTATIC_SHORT] + fac-&gt;count[NONSTATIC_BYTE] +
3910                                         fac-&gt;count[NONSTATIC_OOP];
3911 
3912   const bool super_has_nonstatic_fields =
3913           (_super_klass != NULL &amp;&amp; _super_klass-&gt;has_nonstatic_fields());
3914   const bool has_nonstatic_fields =
3915     super_has_nonstatic_fields || (nonstatic_fields_count != 0);
3916 
3917 
3918   // Prepare list of oops for oop map generation.
3919   //
3920   // &quot;offset&quot; and &quot;count&quot; lists are describing the set of contiguous oop
3921   // regions. offset[i] is the start of the i-th region, which then has
3922   // count[i] oops following. Before we know how many regions are required,
3923   // we pessimistically allocate the maps to fit all the oops into the
3924   // distinct regions.
3925   //
3926   // TODO: We add +1 to always allocate non-zero resource arrays; we need
3927   // to figure out if we still need to do this.
3928   unsigned int nonstatic_oop_map_count = 0;
3929   unsigned int max_nonstatic_oop_maps  = fac-&gt;count[NONSTATIC_OOP] + 1;
3930 
3931   int* nonstatic_oop_offsets = NEW_RESOURCE_ARRAY_IN_THREAD(
3932             THREAD, int, max_nonstatic_oop_maps);
3933   unsigned int* const nonstatic_oop_counts  = NEW_RESOURCE_ARRAY_IN_THREAD(
3934             THREAD, unsigned int, max_nonstatic_oop_maps);
3935 
3936   int first_nonstatic_oop_offset = 0; // will be set for first oop field
3937 
3938   bool compact_fields   = CompactFields;
3939   int allocation_style = FieldsAllocationStyle;
3940   if( allocation_style &lt; 0 || allocation_style &gt; 2 ) { // Out of range?
3941     assert(false, &quot;0 &lt;= FieldsAllocationStyle &lt;= 2&quot;);
3942     allocation_style = 1; // Optimistic
3943   }
3944 
3945   // The next classes have predefined hard-coded fields offsets
3946   // (see in JavaClasses::compute_hard_coded_offsets()).
3947   // Use default fields allocation order for them.
3948   if( (allocation_style != 0 || compact_fields ) &amp;&amp; _loader_data-&gt;class_loader() == NULL &amp;&amp;
3949       (_class_name == vmSymbols::java_lang_AssertionStatusDirectives() ||
3950        _class_name == vmSymbols::java_lang_Class() ||
3951        _class_name == vmSymbols::java_lang_ClassLoader() ||
3952        _class_name == vmSymbols::java_lang_ref_Reference() ||
3953        _class_name == vmSymbols::java_lang_ref_SoftReference() ||
3954        _class_name == vmSymbols::java_lang_StackTraceElement() ||
3955        _class_name == vmSymbols::java_lang_String() ||
3956        _class_name == vmSymbols::java_lang_Throwable() ||
3957        _class_name == vmSymbols::java_lang_Boolean() ||
3958        _class_name == vmSymbols::java_lang_Character() ||
3959        _class_name == vmSymbols::java_lang_Float() ||
3960        _class_name == vmSymbols::java_lang_Double() ||
3961        _class_name == vmSymbols::java_lang_Byte() ||
3962        _class_name == vmSymbols::java_lang_Short() ||
3963        _class_name == vmSymbols::java_lang_Integer() ||
3964        _class_name == vmSymbols::java_lang_Long())) {
3965     allocation_style = 0;     // Allocate oops first
3966     compact_fields   = false; // Don&#39;t compact fields
3967   }
3968 
3969   int next_nonstatic_oop_offset = 0;
3970   int next_nonstatic_double_offset = 0;
3971 
3972   // Rearrange fields for a given allocation style
3973   if( allocation_style == 0 ) {
3974     // Fields order: oops, longs/doubles, ints, shorts/chars, bytes, padded fields
3975     next_nonstatic_oop_offset    = next_nonstatic_field_offset;
3976     next_nonstatic_double_offset = next_nonstatic_oop_offset +
3977                                     (nonstatic_oop_count * heapOopSize);
3978   } else if( allocation_style == 1 ) {
3979     // Fields order: longs/doubles, ints, shorts/chars, bytes, oops, padded fields
3980     next_nonstatic_double_offset = next_nonstatic_field_offset;
3981   } else if( allocation_style == 2 ) {
3982     // Fields allocation: oops fields in super and sub classes are together.
3983     if( nonstatic_field_size &gt; 0 &amp;&amp; _super_klass != NULL &amp;&amp;
3984         _super_klass-&gt;nonstatic_oop_map_size() &gt; 0 ) {
3985       const unsigned int map_count = _super_klass-&gt;nonstatic_oop_map_count();
3986       const OopMapBlock* const first_map = _super_klass-&gt;start_of_nonstatic_oop_maps();
3987       const OopMapBlock* const last_map = first_map + map_count - 1;
3988       const int next_offset = last_map-&gt;offset() + (last_map-&gt;count() * heapOopSize);
3989       if (next_offset == next_nonstatic_field_offset) {
3990         allocation_style = 0;   // allocate oops first
3991         next_nonstatic_oop_offset    = next_nonstatic_field_offset;
3992         next_nonstatic_double_offset = next_nonstatic_oop_offset +
3993                                        (nonstatic_oop_count * heapOopSize);
3994       }
3995     }
3996     if( allocation_style == 2 ) {
3997       allocation_style = 1;     // allocate oops last
3998       next_nonstatic_double_offset = next_nonstatic_field_offset;
3999     }
4000   } else {
4001     ShouldNotReachHere();
4002   }
4003 
4004   int nonstatic_oop_space_count   = 0;
4005   int nonstatic_word_space_count  = 0;
4006   int nonstatic_short_space_count = 0;
4007   int nonstatic_byte_space_count  = 0;
4008   int nonstatic_oop_space_offset = 0;
4009   int nonstatic_word_space_offset = 0;
4010   int nonstatic_short_space_offset = 0;
4011   int nonstatic_byte_space_offset = 0;
4012 
4013   // Try to squeeze some of the fields into the gaps due to
4014   // long/double alignment.
4015   if (nonstatic_double_count &gt; 0) {
4016     int offset = next_nonstatic_double_offset;
4017     next_nonstatic_double_offset = align_up(offset, BytesPerLong);
4018     if (compact_fields &amp;&amp; offset != next_nonstatic_double_offset) {
4019       // Allocate available fields into the gap before double field.
4020       int length = next_nonstatic_double_offset - offset;
4021       assert(length == BytesPerInt, &quot;&quot;);
4022       nonstatic_word_space_offset = offset;
4023       if (nonstatic_word_count &gt; 0) {
4024         nonstatic_word_count      -= 1;
4025         nonstatic_word_space_count = 1; // Only one will fit
4026         length -= BytesPerInt;
4027         offset += BytesPerInt;
4028       }
4029       nonstatic_short_space_offset = offset;
4030       while (length &gt;= BytesPerShort &amp;&amp; nonstatic_short_count &gt; 0) {
4031         nonstatic_short_count       -= 1;
4032         nonstatic_short_space_count += 1;
4033         length -= BytesPerShort;
4034         offset += BytesPerShort;
4035       }
4036       nonstatic_byte_space_offset = offset;
4037       while (length &gt; 0 &amp;&amp; nonstatic_byte_count &gt; 0) {
4038         nonstatic_byte_count       -= 1;
4039         nonstatic_byte_space_count += 1;
4040         length -= 1;
4041       }
4042       // Allocate oop field in the gap if there are no other fields for that.
4043       nonstatic_oop_space_offset = offset;
4044       if (length &gt;= heapOopSize &amp;&amp; nonstatic_oop_count &gt; 0 &amp;&amp;
4045           allocation_style != 0) { // when oop fields not first
4046         nonstatic_oop_count      -= 1;
4047         nonstatic_oop_space_count = 1; // Only one will fit
4048         length -= heapOopSize;
4049         offset += heapOopSize;
4050       }
4051     }
4052   }
4053 
4054   int next_nonstatic_word_offset = next_nonstatic_double_offset +
4055                                      (nonstatic_double_count * BytesPerLong);
4056   int next_nonstatic_short_offset = next_nonstatic_word_offset +
4057                                       (nonstatic_word_count * BytesPerInt);
4058   int next_nonstatic_byte_offset = next_nonstatic_short_offset +
4059                                      (nonstatic_short_count * BytesPerShort);
4060   int next_nonstatic_padded_offset = next_nonstatic_byte_offset +
4061                                        nonstatic_byte_count;
4062 
4063   // let oops jump before padding with this allocation style
4064   if( allocation_style == 1 ) {
4065     next_nonstatic_oop_offset = next_nonstatic_padded_offset;
4066     if( nonstatic_oop_count &gt; 0 ) {
4067       next_nonstatic_oop_offset = align_up(next_nonstatic_oop_offset, heapOopSize);
4068     }
4069     next_nonstatic_padded_offset = next_nonstatic_oop_offset + (nonstatic_oop_count * heapOopSize);
4070   }
4071 
4072   // Iterate over fields again and compute correct offsets.
4073   // The field allocation type was temporarily stored in the offset slot.
4074   // oop fields are located before non-oop fields (static and non-static).
4075   for (AllFieldStream fs(_fields, cp); !fs.done(); fs.next()) {
4076 
4077     // skip already laid out fields
4078     if (fs.is_offset_set()) continue;
4079 
4080     // contended instance fields are handled below
4081     if (fs.is_contended() &amp;&amp; !fs.access_flags().is_static()) continue;
4082 
4083     int real_offset = 0;
4084     const FieldAllocationType atype = (const FieldAllocationType) fs.allocation_type();
4085 
4086     // pack the rest of the fields
4087     switch (atype) {
4088       case STATIC_OOP:
4089         real_offset = next_static_oop_offset;
4090         next_static_oop_offset += heapOopSize;
4091         break;
4092       case STATIC_BYTE:
4093         real_offset = next_static_byte_offset;
4094         next_static_byte_offset += 1;
4095         break;
4096       case STATIC_SHORT:
4097         real_offset = next_static_short_offset;
4098         next_static_short_offset += BytesPerShort;
4099         break;
4100       case STATIC_WORD:
4101         real_offset = next_static_word_offset;
4102         next_static_word_offset += BytesPerInt;
4103         break;
4104       case STATIC_DOUBLE:
4105         real_offset = next_static_double_offset;
4106         next_static_double_offset += BytesPerLong;
4107         break;
4108       case NONSTATIC_OOP:
4109         if( nonstatic_oop_space_count &gt; 0 ) {
4110           real_offset = nonstatic_oop_space_offset;
4111           nonstatic_oop_space_offset += heapOopSize;
4112           nonstatic_oop_space_count  -= 1;
4113         } else {
4114           real_offset = next_nonstatic_oop_offset;
4115           next_nonstatic_oop_offset += heapOopSize;
4116         }
4117 
4118         // Record this oop in the oop maps
4119         if( nonstatic_oop_map_count &gt; 0 &amp;&amp;
4120             nonstatic_oop_offsets[nonstatic_oop_map_count - 1] ==
4121             real_offset -
4122             int(nonstatic_oop_counts[nonstatic_oop_map_count - 1]) *
4123             heapOopSize ) {
4124           // This oop is adjacent to the previous one, add to current oop map
4125           assert(nonstatic_oop_map_count - 1 &lt; max_nonstatic_oop_maps, &quot;range check&quot;);
4126           nonstatic_oop_counts[nonstatic_oop_map_count - 1] += 1;
4127         } else {
4128           // This oop is not adjacent to the previous one, create new oop map
4129           assert(nonstatic_oop_map_count &lt; max_nonstatic_oop_maps, &quot;range check&quot;);
4130           nonstatic_oop_offsets[nonstatic_oop_map_count] = real_offset;
4131           nonstatic_oop_counts [nonstatic_oop_map_count] = 1;
4132           nonstatic_oop_map_count += 1;
4133           if( first_nonstatic_oop_offset == 0 ) { // Undefined
4134             first_nonstatic_oop_offset = real_offset;
4135           }
4136         }
4137         break;
4138       case NONSTATIC_BYTE:
4139         if( nonstatic_byte_space_count &gt; 0 ) {
4140           real_offset = nonstatic_byte_space_offset;
4141           nonstatic_byte_space_offset += 1;
4142           nonstatic_byte_space_count  -= 1;
4143         } else {
4144           real_offset = next_nonstatic_byte_offset;
4145           next_nonstatic_byte_offset += 1;
4146         }
4147         break;
4148       case NONSTATIC_SHORT:
4149         if( nonstatic_short_space_count &gt; 0 ) {
4150           real_offset = nonstatic_short_space_offset;
4151           nonstatic_short_space_offset += BytesPerShort;
4152           nonstatic_short_space_count  -= 1;
4153         } else {
4154           real_offset = next_nonstatic_short_offset;
4155           next_nonstatic_short_offset += BytesPerShort;
4156         }
4157         break;
4158       case NONSTATIC_WORD:
4159         if( nonstatic_word_space_count &gt; 0 ) {
4160           real_offset = nonstatic_word_space_offset;
4161           nonstatic_word_space_offset += BytesPerInt;
4162           nonstatic_word_space_count  -= 1;
4163         } else {
4164           real_offset = next_nonstatic_word_offset;
4165           next_nonstatic_word_offset += BytesPerInt;
4166         }
4167         break;
4168       case NONSTATIC_DOUBLE:
4169         real_offset = next_nonstatic_double_offset;
4170         next_nonstatic_double_offset += BytesPerLong;
4171         break;
4172       default:
4173         ShouldNotReachHere();
4174     }
4175     fs.set_offset(real_offset);
4176   }
4177 
4178 
4179   // Handle the contended cases.
4180   //
4181   // Each contended field should not intersect the cache line with another contended field.
4182   // In the absence of alignment information, we end up with pessimistically separating
4183   // the fields with full-width padding.
4184   //
4185   // Additionally, this should not break alignment for the fields, so we round the alignment up
4186   // for each field.
4187   if (nonstatic_contended_count &gt; 0) {
4188 
4189     // if there is at least one contended field, we need to have pre-padding for them
4190     next_nonstatic_padded_offset += ContendedPaddingWidth;
4191 
4192     // collect all contended groups
4193     ResourceBitMap bm(cp-&gt;size());
4194     for (AllFieldStream fs(_fields, cp); !fs.done(); fs.next()) {
4195       // skip already laid out fields
4196       if (fs.is_offset_set()) continue;
4197 
4198       if (fs.is_contended()) {
4199         bm.set_bit(fs.contended_group());
4200       }
4201     }
4202 
4203     int current_group = -1;
4204     while ((current_group = (int)bm.get_next_one_offset(current_group + 1)) != (int)bm.size()) {
4205 
4206       for (AllFieldStream fs(_fields, cp); !fs.done(); fs.next()) {
4207 
4208         // skip already laid out fields
4209         if (fs.is_offset_set()) continue;
4210 
4211         // skip non-contended fields and fields from different group
4212         if (!fs.is_contended() || (fs.contended_group() != current_group)) continue;
4213 
4214         // handle statics below
4215         if (fs.access_flags().is_static()) continue;
4216 
4217         int real_offset = 0;
4218         FieldAllocationType atype = (FieldAllocationType) fs.allocation_type();
4219 
4220         switch (atype) {
4221           case NONSTATIC_BYTE:
4222             next_nonstatic_padded_offset = align_up(next_nonstatic_padded_offset, 1);
4223             real_offset = next_nonstatic_padded_offset;
4224             next_nonstatic_padded_offset += 1;
4225             break;
4226 
4227           case NONSTATIC_SHORT:
4228             next_nonstatic_padded_offset = align_up(next_nonstatic_padded_offset, BytesPerShort);
4229             real_offset = next_nonstatic_padded_offset;
4230             next_nonstatic_padded_offset += BytesPerShort;
4231             break;
4232 
4233           case NONSTATIC_WORD:
4234             next_nonstatic_padded_offset = align_up(next_nonstatic_padded_offset, BytesPerInt);
4235             real_offset = next_nonstatic_padded_offset;
4236             next_nonstatic_padded_offset += BytesPerInt;
4237             break;
4238 
4239           case NONSTATIC_DOUBLE:
4240             next_nonstatic_padded_offset = align_up(next_nonstatic_padded_offset, BytesPerLong);
4241             real_offset = next_nonstatic_padded_offset;
4242             next_nonstatic_padded_offset += BytesPerLong;
4243             break;
4244 
4245           case NONSTATIC_OOP:
4246             next_nonstatic_padded_offset = align_up(next_nonstatic_padded_offset, heapOopSize);
4247             real_offset = next_nonstatic_padded_offset;
4248             next_nonstatic_padded_offset += heapOopSize;
4249 
4250             // Record this oop in the oop maps
4251             if( nonstatic_oop_map_count &gt; 0 &amp;&amp;
4252                 nonstatic_oop_offsets[nonstatic_oop_map_count - 1] ==
4253                 real_offset -
4254                 int(nonstatic_oop_counts[nonstatic_oop_map_count - 1]) *
4255                 heapOopSize ) {
4256               // This oop is adjacent to the previous one, add to current oop map
4257               assert(nonstatic_oop_map_count - 1 &lt; max_nonstatic_oop_maps, &quot;range check&quot;);
4258               nonstatic_oop_counts[nonstatic_oop_map_count - 1] += 1;
4259             } else {
4260               // This oop is not adjacent to the previous one, create new oop map
4261               assert(nonstatic_oop_map_count &lt; max_nonstatic_oop_maps, &quot;range check&quot;);
4262               nonstatic_oop_offsets[nonstatic_oop_map_count] = real_offset;
4263               nonstatic_oop_counts [nonstatic_oop_map_count] = 1;
4264               nonstatic_oop_map_count += 1;
4265               if( first_nonstatic_oop_offset == 0 ) { // Undefined
4266                 first_nonstatic_oop_offset = real_offset;
4267               }
4268             }
4269             break;
4270 
4271           default:
4272             ShouldNotReachHere();
4273         }
4274 
4275         if (fs.contended_group() == 0) {
4276           // Contended group defines the equivalence class over the fields:
4277           // the fields within the same contended group are not inter-padded.
4278           // The only exception is default group, which does not incur the
4279           // equivalence, and so requires intra-padding.
4280           next_nonstatic_padded_offset += ContendedPaddingWidth;
4281         }
4282 
4283         fs.set_offset(real_offset);
4284       } // for
4285 
4286       // Start laying out the next group.
4287       // Note that this will effectively pad the last group in the back;
4288       // this is expected to alleviate memory contention effects for
4289       // subclass fields and/or adjacent object.
4290       // If this was the default group, the padding is already in place.
4291       if (current_group != 0) {
4292         next_nonstatic_padded_offset += ContendedPaddingWidth;
4293       }
4294     }
4295 
4296     // handle static fields
4297   }
4298 
4299   // Entire class is contended, pad in the back.
4300   // This helps to alleviate memory contention effects for subclass fields
4301   // and/or adjacent object.
4302   if (is_contended_class) {
4303     next_nonstatic_padded_offset += ContendedPaddingWidth;
4304   }
4305 
4306   int notaligned_nonstatic_fields_end = next_nonstatic_padded_offset;
4307 
4308   int nonstatic_fields_end      = align_up(notaligned_nonstatic_fields_end, heapOopSize);
4309   int instance_end              = align_up(notaligned_nonstatic_fields_end, wordSize);
4310   int static_fields_end         = align_up(next_static_byte_offset, wordSize);
4311 
4312   int static_field_size         = (static_fields_end -
4313                                    InstanceMirrorKlass::offset_of_static_fields()) / wordSize;
4314   nonstatic_field_size          = nonstatic_field_size +
4315                                   (nonstatic_fields_end - nonstatic_fields_start) / heapOopSize;
4316 
4317   int instance_size             = align_object_size(instance_end / wordSize);
4318 
4319   assert(instance_size == align_object_size(align_up(
4320          (instanceOopDesc::base_offset_in_bytes() + nonstatic_field_size*heapOopSize),
4321           wordSize) / wordSize), &quot;consistent layout helper value&quot;);
4322 
4323   // Invariant: nonstatic_field end/start should only change if there are
4324   // nonstatic fields in the class, or if the class is contended. We compare
4325   // against the non-aligned value, so that end alignment will not fail the
4326   // assert without actually having the fields.
4327   assert((notaligned_nonstatic_fields_end == nonstatic_fields_start) ||
4328          is_contended_class ||
4329          (nonstatic_fields_count &gt; 0), &quot;double-check nonstatic start/end&quot;);
4330 
4331   // Number of non-static oop map blocks allocated at end of klass.
4332   const unsigned int total_oop_map_count =
4333     compute_oop_map_count(_super_klass, nonstatic_oop_map_count,
4334                           first_nonstatic_oop_offset);
4335 
4336 #ifndef PRODUCT
4337   if (PrintFieldLayout) {
4338     print_field_layout(_class_name,
4339           _fields,
4340           cp,
4341           instance_size,
4342           nonstatic_fields_start,
4343           nonstatic_fields_end,
4344           static_fields_end);
4345   }
4346 
4347 #endif
4348   // Pass back information needed for InstanceKlass creation
4349   info-&gt;nonstatic_oop_offsets = nonstatic_oop_offsets;
4350   info-&gt;nonstatic_oop_counts = nonstatic_oop_counts;
4351   info-&gt;nonstatic_oop_map_count = nonstatic_oop_map_count;
4352   info-&gt;total_oop_map_count = total_oop_map_count;
4353   info-&gt;instance_size = instance_size;
4354   info-&gt;static_field_size = static_field_size;
4355   info-&gt;nonstatic_field_size = nonstatic_field_size;
4356   info-&gt;has_nonstatic_fields = has_nonstatic_fields;
4357 }
4358 
4359 static void fill_oop_maps(const InstanceKlass* k,
4360                           unsigned int nonstatic_oop_map_count,
4361                           const int* nonstatic_oop_offsets,
4362                           const unsigned int* nonstatic_oop_counts) {
4363 
4364   assert(k != NULL, &quot;invariant&quot;);
4365 
4366   OopMapBlock* this_oop_map = k-&gt;start_of_nonstatic_oop_maps();
4367   const InstanceKlass* const super = k-&gt;superklass();
4368   const unsigned int super_count = super ? super-&gt;nonstatic_oop_map_count() : 0;
4369   if (super_count &gt; 0) {
4370     // Copy maps from superklass
4371     OopMapBlock* super_oop_map = super-&gt;start_of_nonstatic_oop_maps();
4372     for (unsigned int i = 0; i &lt; super_count; ++i) {
4373       *this_oop_map++ = *super_oop_map++;
4374     }
4375   }
4376 
4377   if (nonstatic_oop_map_count &gt; 0) {
4378     if (super_count + nonstatic_oop_map_count &gt; k-&gt;nonstatic_oop_map_count()) {
4379       // The counts differ because there is no gap between superklass&#39;s last oop
4380       // field and the first local oop field.  Extend the last oop map copied
4381       // from the superklass instead of creating new one.
4382       nonstatic_oop_map_count--;
4383       nonstatic_oop_offsets++;
4384       this_oop_map--;
4385       this_oop_map-&gt;set_count(this_oop_map-&gt;count() + *nonstatic_oop_counts++);
4386       this_oop_map++;
4387     }
4388 
4389     // Add new map blocks, fill them
4390     while (nonstatic_oop_map_count-- &gt; 0) {
4391       this_oop_map-&gt;set_offset(*nonstatic_oop_offsets++);
4392       this_oop_map-&gt;set_count(*nonstatic_oop_counts++);
4393       this_oop_map++;
4394     }
4395     assert(k-&gt;start_of_nonstatic_oop_maps() + k-&gt;nonstatic_oop_map_count() ==
4396            this_oop_map, &quot;sanity&quot;);
4397   }
4398 }
4399 
4400 
4401 void ClassFileParser::set_precomputed_flags(InstanceKlass* ik) {
4402   assert(ik != NULL, &quot;invariant&quot;);
4403 
4404   const Klass* const super = ik-&gt;super();
4405 
4406   // Check if this klass has an empty finalize method (i.e. one with return bytecode only),
4407   // in which case we don&#39;t have to register objects as finalizable
4408   if (!_has_empty_finalizer) {
4409     if (_has_finalizer ||
4410         (super != NULL &amp;&amp; super-&gt;has_finalizer())) {
4411       ik-&gt;set_has_finalizer();
4412     }
4413   }
4414 
4415 #ifdef ASSERT
4416   bool f = false;
4417   const Method* const m = ik-&gt;lookup_method(vmSymbols::finalize_method_name(),
4418                                            vmSymbols::void_method_signature());
4419   if (m != NULL &amp;&amp; !m-&gt;is_empty_method()) {
4420       f = true;
4421   }
4422 
4423   // Spec doesn&#39;t prevent agent from redefinition of empty finalizer.
4424   // Despite the fact that it&#39;s generally bad idea and redefined finalizer
4425   // will not work as expected we shouldn&#39;t abort vm in this case
4426   if (!ik-&gt;has_redefined_this_or_super()) {
4427     assert(ik-&gt;has_finalizer() == f, &quot;inconsistent has_finalizer&quot;);
4428   }
4429 #endif
4430 
4431   // Check if this klass supports the java.lang.Cloneable interface
4432   if (SystemDictionary::Cloneable_klass_loaded()) {
4433     if (ik-&gt;is_subtype_of(SystemDictionary::Cloneable_klass())) {
4434       ik-&gt;set_is_cloneable();
4435     }
4436   }
4437 
4438   // Check if this klass has a vanilla default constructor
4439   if (super == NULL) {
4440     // java.lang.Object has empty default constructor
4441     ik-&gt;set_has_vanilla_constructor();
4442   } else {
4443     if (super-&gt;has_vanilla_constructor() &amp;&amp;
4444         _has_vanilla_constructor) {
4445       ik-&gt;set_has_vanilla_constructor();
4446     }
4447 #ifdef ASSERT
4448     bool v = false;
4449     if (super-&gt;has_vanilla_constructor()) {
4450       const Method* const constructor =
4451         ik-&gt;find_method(vmSymbols::object_initializer_name(),
4452                        vmSymbols::void_method_signature());
4453       if (constructor != NULL &amp;&amp; constructor-&gt;is_vanilla_constructor()) {
4454         v = true;
4455       }
4456     }
4457     assert(v == ik-&gt;has_vanilla_constructor(), &quot;inconsistent has_vanilla_constructor&quot;);
4458 #endif
4459   }
4460 
4461   // If it cannot be fast-path allocated, set a bit in the layout helper.
4462   // See documentation of InstanceKlass::can_be_fastpath_allocated().
4463   assert(ik-&gt;size_helper() &gt; 0, &quot;layout_helper is initialized&quot;);
4464   if ((!RegisterFinalizersAtInit &amp;&amp; ik-&gt;has_finalizer())
4465       || ik-&gt;is_abstract() || ik-&gt;is_interface()
4466       || (ik-&gt;name() == vmSymbols::java_lang_Class() &amp;&amp; ik-&gt;class_loader() == NULL)
4467       || ik-&gt;size_helper() &gt;= FastAllocateSizeLimit) {
4468     // Forbid fast-path allocation.
4469     const jint lh = Klass::instance_layout_helper(ik-&gt;size_helper(), true);
4470     ik-&gt;set_layout_helper(lh);
4471   }
4472 }
4473 
4474 // utility methods for appending an array with check for duplicates
4475 
4476 static void append_interfaces(GrowableArray&lt;InstanceKlass*&gt;* result,
4477                               const Array&lt;InstanceKlass*&gt;* const ifs) {
4478   // iterate over new interfaces
4479   for (int i = 0; i &lt; ifs-&gt;length(); i++) {
4480     InstanceKlass* const e = ifs-&gt;at(i);
4481     assert(e-&gt;is_klass() &amp;&amp; e-&gt;is_interface(), &quot;just checking&quot;);
4482     // add new interface
4483     result-&gt;append_if_missing(e);
4484   }
4485 }
4486 
4487 static Array&lt;InstanceKlass*&gt;* compute_transitive_interfaces(const InstanceKlass* super,
4488                                                             Array&lt;InstanceKlass*&gt;* local_ifs,
4489                                                             ClassLoaderData* loader_data,
4490                                                             TRAPS) {
4491   assert(local_ifs != NULL, &quot;invariant&quot;);
4492   assert(loader_data != NULL, &quot;invariant&quot;);
4493 
4494   // Compute maximum size for transitive interfaces
4495   int max_transitive_size = 0;
4496   int super_size = 0;
4497   // Add superclass transitive interfaces size
4498   if (super != NULL) {
4499     super_size = super-&gt;transitive_interfaces()-&gt;length();
4500     max_transitive_size += super_size;
4501   }
4502   // Add local interfaces&#39; super interfaces
4503   const int local_size = local_ifs-&gt;length();
4504   for (int i = 0; i &lt; local_size; i++) {
4505     InstanceKlass* const l = local_ifs-&gt;at(i);
4506     max_transitive_size += l-&gt;transitive_interfaces()-&gt;length();
4507   }
4508   // Finally add local interfaces
4509   max_transitive_size += local_size;
4510   // Construct array
4511   if (max_transitive_size == 0) {
4512     // no interfaces, use canonicalized array
4513     return Universe::the_empty_instance_klass_array();
4514   } else if (max_transitive_size == super_size) {
4515     // no new local interfaces added, share superklass&#39; transitive interface array
4516     return super-&gt;transitive_interfaces();
4517   } else if (max_transitive_size == local_size) {
4518     // only local interfaces added, share local interface array
4519     return local_ifs;
4520   } else {
4521     ResourceMark rm;
4522     GrowableArray&lt;InstanceKlass*&gt;* const result = new GrowableArray&lt;InstanceKlass*&gt;(max_transitive_size);
4523 
4524     // Copy down from superclass
4525     if (super != NULL) {
4526       append_interfaces(result, super-&gt;transitive_interfaces());
4527     }
4528 
4529     // Copy down from local interfaces&#39; superinterfaces
4530     for (int i = 0; i &lt; local_size; i++) {
4531       InstanceKlass* const l = local_ifs-&gt;at(i);
4532       append_interfaces(result, l-&gt;transitive_interfaces());
4533     }
4534     // Finally add local interfaces
4535     append_interfaces(result, local_ifs);
4536 
4537     // length will be less than the max_transitive_size if duplicates were removed
4538     const int length = result-&gt;length();
4539     assert(length &lt;= max_transitive_size, &quot;just checking&quot;);
4540     Array&lt;InstanceKlass*&gt;* const new_result =
4541       MetadataFactory::new_array&lt;InstanceKlass*&gt;(loader_data, length, CHECK_NULL);
4542     for (int i = 0; i &lt; length; i++) {
4543       InstanceKlass* const e = result-&gt;at(i);
4544       assert(e != NULL, &quot;just checking&quot;);
4545       new_result-&gt;at_put(i, e);
4546     }
4547     return new_result;
4548   }
4549 }
4550 
4551 static void check_super_class_access(const InstanceKlass* this_klass, TRAPS) {
4552   assert(this_klass != NULL, &quot;invariant&quot;);
4553   const Klass* const super = this_klass-&gt;super();
4554   if (super != NULL) {
4555 
4556     // If the loader is not the boot loader then throw an exception if its
4557     // superclass is in package jdk.internal.reflect and its loader is not a
4558     // special reflection class loader
4559     if (!this_klass-&gt;class_loader_data()-&gt;is_the_null_class_loader_data()) {
4560       assert(super-&gt;is_instance_klass(), &quot;super is not instance klass&quot;);
4561       PackageEntry* super_package = super-&gt;package();
4562       if (super_package != NULL &amp;&amp;
4563           super_package-&gt;name()-&gt;fast_compare(vmSymbols::jdk_internal_reflect()) == 0 &amp;&amp;
4564           !java_lang_ClassLoader::is_reflection_class_loader(this_klass-&gt;class_loader())) {
4565         ResourceMark rm(THREAD);
4566         Exceptions::fthrow(
4567           THREAD_AND_LOCATION,
4568           vmSymbols::java_lang_IllegalAccessError(),
4569           &quot;class %s loaded by %s cannot access jdk/internal/reflect superclass %s&quot;,
4570           this_klass-&gt;external_name(),
4571           this_klass-&gt;class_loader_data()-&gt;loader_name_and_id(),
4572           super-&gt;external_name());
4573         return;
4574       }
4575     }
4576 
4577     Reflection::VerifyClassAccessResults vca_result =
4578       Reflection::verify_class_access(this_klass, InstanceKlass::cast(super), false);
4579     if (vca_result != Reflection::ACCESS_OK) {
4580       ResourceMark rm(THREAD);
4581       char* msg = Reflection::verify_class_access_msg(this_klass,
4582                                                       InstanceKlass::cast(super),
4583                                                       vca_result);
4584       if (msg == NULL) {
4585         bool same_module = (this_klass-&gt;module() == super-&gt;module());
4586         Exceptions::fthrow(
4587           THREAD_AND_LOCATION,
4588           vmSymbols::java_lang_IllegalAccessError(),
4589           &quot;class %s cannot access its %ssuperclass %s (%s%s%s)&quot;,
4590           this_klass-&gt;external_name(),
4591           super-&gt;is_abstract() ? &quot;abstract &quot; : &quot;&quot;,
4592           super-&gt;external_name(),
4593           (same_module) ? this_klass-&gt;joint_in_module_of_loader(super) : this_klass-&gt;class_in_module_of_loader(),
4594           (same_module) ? &quot;&quot; : &quot;; &quot;,
4595           (same_module) ? &quot;&quot; : super-&gt;class_in_module_of_loader());
4596       } else {
4597         // Add additional message content.
4598         Exceptions::fthrow(
4599           THREAD_AND_LOCATION,
4600           vmSymbols::java_lang_IllegalAccessError(),
4601           &quot;superclass access check failed: %s&quot;,
4602           msg);
4603       }
4604     }
4605   }
4606 }
4607 
4608 
4609 static void check_super_interface_access(const InstanceKlass* this_klass, TRAPS) {
4610   assert(this_klass != NULL, &quot;invariant&quot;);
4611   const Array&lt;InstanceKlass*&gt;* const local_interfaces = this_klass-&gt;local_interfaces();
4612   const int lng = local_interfaces-&gt;length();
4613   for (int i = lng - 1; i &gt;= 0; i--) {
4614     InstanceKlass* const k = local_interfaces-&gt;at(i);
4615     assert (k != NULL &amp;&amp; k-&gt;is_interface(), &quot;invalid interface&quot;);
4616     Reflection::VerifyClassAccessResults vca_result =
4617       Reflection::verify_class_access(this_klass, k, false);
4618     if (vca_result != Reflection::ACCESS_OK) {
4619       ResourceMark rm(THREAD);
4620       char* msg = Reflection::verify_class_access_msg(this_klass,
4621                                                       k,
4622                                                       vca_result);
4623       if (msg == NULL) {
4624         bool same_module = (this_klass-&gt;module() == k-&gt;module());
4625         Exceptions::fthrow(
4626           THREAD_AND_LOCATION,
4627           vmSymbols::java_lang_IllegalAccessError(),
4628           &quot;class %s cannot access its superinterface %s (%s%s%s)&quot;,
4629           this_klass-&gt;external_name(),
4630           k-&gt;external_name(),
4631           (same_module) ? this_klass-&gt;joint_in_module_of_loader(k) : this_klass-&gt;class_in_module_of_loader(),
4632           (same_module) ? &quot;&quot; : &quot;; &quot;,
4633           (same_module) ? &quot;&quot; : k-&gt;class_in_module_of_loader());
4634       } else {
4635         // Add additional message content.
4636         Exceptions::fthrow(
4637           THREAD_AND_LOCATION,
4638           vmSymbols::java_lang_IllegalAccessError(),
4639           &quot;superinterface check failed: %s&quot;,
4640           msg);
4641       }
4642     }
4643   }
4644 }
4645 
4646 
4647 static void check_final_method_override(const InstanceKlass* this_klass, TRAPS) {
4648   assert(this_klass != NULL, &quot;invariant&quot;);
4649   const Array&lt;Method*&gt;* const methods = this_klass-&gt;methods();
4650   const int num_methods = methods-&gt;length();
4651 
4652   // go thru each method and check if it overrides a final method
4653   for (int index = 0; index &lt; num_methods; index++) {
4654     const Method* const m = methods-&gt;at(index);
4655 
4656     // skip private, static, and &lt;init&gt; methods
4657     if ((!m-&gt;is_private() &amp;&amp; !m-&gt;is_static()) &amp;&amp;
4658         (m-&gt;name() != vmSymbols::object_initializer_name())) {
4659 
4660       const Symbol* const name = m-&gt;name();
4661       const Symbol* const signature = m-&gt;signature();
4662       const Klass* k = this_klass-&gt;super();
4663       const Method* super_m = NULL;
4664       while (k != NULL) {
4665         // skip supers that don&#39;t have final methods.
4666         if (k-&gt;has_final_method()) {
4667           // lookup a matching method in the super class hierarchy
4668           super_m = InstanceKlass::cast(k)-&gt;lookup_method(name, signature);
4669           if (super_m == NULL) {
4670             break; // didn&#39;t find any match; get out
4671           }
4672 
4673           if (super_m-&gt;is_final() &amp;&amp; !super_m-&gt;is_static() &amp;&amp;
4674               !super_m-&gt;access_flags().is_private()) {
4675             // matching method in super is final, and not static or private
4676             bool can_access = Reflection::verify_member_access(this_klass,
4677                                                                super_m-&gt;method_holder(),
4678                                                                super_m-&gt;method_holder(),
4679                                                                super_m-&gt;access_flags(),
4680                                                               false, false, CHECK);
4681             if (can_access) {
4682               // this class can access super final method and therefore override
4683               ResourceMark rm(THREAD);
4684               Exceptions::fthrow(THREAD_AND_LOCATION,
4685                                  vmSymbols::java_lang_VerifyError(),
4686                                  &quot;class %s overrides final method %s.%s%s&quot;,
4687                                  this_klass-&gt;external_name(),
4688                                  super_m-&gt;method_holder()-&gt;external_name(),
4689                                  name-&gt;as_C_string(),
4690                                  signature-&gt;as_C_string()
4691                                  );
4692               return;
4693             }
4694           }
4695 
4696           // continue to look from super_m&#39;s holder&#39;s super.
4697           k = super_m-&gt;method_holder()-&gt;super();
4698           continue;
4699         }
4700 
4701         k = k-&gt;super();
4702       }
4703     }
4704   }
4705 }
4706 
4707 
4708 // assumes that this_klass is an interface
4709 static void check_illegal_static_method(const InstanceKlass* this_klass, TRAPS) {
4710   assert(this_klass != NULL, &quot;invariant&quot;);
4711   assert(this_klass-&gt;is_interface(), &quot;not an interface&quot;);
4712   const Array&lt;Method*&gt;* methods = this_klass-&gt;methods();
4713   const int num_methods = methods-&gt;length();
4714 
4715   for (int index = 0; index &lt; num_methods; index++) {
4716     const Method* const m = methods-&gt;at(index);
4717     // if m is static and not the init method, throw a verify error
4718     if ((m-&gt;is_static()) &amp;&amp; (m-&gt;name() != vmSymbols::class_initializer_name())) {
4719       ResourceMark rm(THREAD);
4720       Exceptions::fthrow(
4721         THREAD_AND_LOCATION,
4722         vmSymbols::java_lang_VerifyError(),
4723         &quot;Illegal static method %s in interface %s&quot;,
4724         m-&gt;name()-&gt;as_C_string(),
4725         this_klass-&gt;external_name()
4726       );
4727       return;
4728     }
4729   }
4730 }
4731 
4732 // utility methods for format checking
4733 
4734 void ClassFileParser::verify_legal_class_modifiers(jint flags, TRAPS) const {
4735   const bool is_module = (flags &amp; JVM_ACC_MODULE) != 0;
4736   assert(_major_version &gt;= JAVA_9_VERSION || !is_module, &quot;JVM_ACC_MODULE should not be set&quot;);
4737   if (is_module) {
4738     ResourceMark rm(THREAD);
4739     Exceptions::fthrow(
4740       THREAD_AND_LOCATION,
4741       vmSymbols::java_lang_NoClassDefFoundError(),
4742       &quot;%s is not a class because access_flag ACC_MODULE is set&quot;,
4743       _class_name-&gt;as_C_string());
4744     return;
4745   }
4746 
4747   if (!_need_verify) { return; }
4748 
4749   const bool is_interface  = (flags &amp; JVM_ACC_INTERFACE)  != 0;
4750   const bool is_abstract   = (flags &amp; JVM_ACC_ABSTRACT)   != 0;
4751   const bool is_final      = (flags &amp; JVM_ACC_FINAL)      != 0;
4752   const bool is_super      = (flags &amp; JVM_ACC_SUPER)      != 0;
4753   const bool is_enum       = (flags &amp; JVM_ACC_ENUM)       != 0;
4754   const bool is_annotation = (flags &amp; JVM_ACC_ANNOTATION) != 0;
4755   const bool major_gte_15  = _major_version &gt;= JAVA_1_5_VERSION;
4756 
4757   if ((is_abstract &amp;&amp; is_final) ||
4758       (is_interface &amp;&amp; !is_abstract) ||
4759       (is_interface &amp;&amp; major_gte_15 &amp;&amp; (is_super || is_enum)) ||
4760       (!is_interface &amp;&amp; major_gte_15 &amp;&amp; is_annotation)) {
4761     ResourceMark rm(THREAD);
4762     Exceptions::fthrow(
4763       THREAD_AND_LOCATION,
4764       vmSymbols::java_lang_ClassFormatError(),
4765       &quot;Illegal class modifiers in class %s: 0x%X&quot;,
4766       _class_name-&gt;as_C_string(), flags
4767     );
4768     return;
4769   }
4770 }
4771 
4772 static bool has_illegal_visibility(jint flags) {
4773   const bool is_public    = (flags &amp; JVM_ACC_PUBLIC)    != 0;
4774   const bool is_protected = (flags &amp; JVM_ACC_PROTECTED) != 0;
4775   const bool is_private   = (flags &amp; JVM_ACC_PRIVATE)   != 0;
4776 
4777   return ((is_public &amp;&amp; is_protected) ||
4778           (is_public &amp;&amp; is_private) ||
4779           (is_protected &amp;&amp; is_private));
4780 }
4781 
4782 // A legal major_version.minor_version must be one of the following:
4783 //
4784 //   Major_version = 45, any minor_version.
4785 //   Major_version &gt;= 46 and major_version &lt;= current_major_version and minor_version = 0.
4786 //   Major_version = current_major_version and minor_version = 65535 and --enable-preview is present.
4787 //
4788 static void verify_class_version(u2 major, u2 minor, Symbol* class_name, TRAPS){
4789   const u2 max_version = JVM_CLASSFILE_MAJOR_VERSION;
4790   if (major != JAVA_MIN_SUPPORTED_VERSION) { // All 45.* are ok including 45.65535
4791     if (minor == JAVA_PREVIEW_MINOR_VERSION) {
4792       if (major != max_version) {
4793         ResourceMark rm(THREAD);
4794         Exceptions::fthrow(
4795           THREAD_AND_LOCATION,
4796           vmSymbols::java_lang_UnsupportedClassVersionError(),
4797           &quot;%s (class file version %u.%u) was compiled with preview features that are unsupported. &quot;
4798           &quot;This version of the Java Runtime only recognizes preview features for class file version %u.%u&quot;,
4799           class_name-&gt;as_C_string(), major, minor, JVM_CLASSFILE_MAJOR_VERSION, JAVA_PREVIEW_MINOR_VERSION);
4800         return;
4801       }
4802 
4803       if (!Arguments::enable_preview()) {
4804         ResourceMark rm(THREAD);
4805         Exceptions::fthrow(
4806           THREAD_AND_LOCATION,
4807           vmSymbols::java_lang_UnsupportedClassVersionError(),
4808           &quot;Preview features are not enabled for %s (class file version %u.%u). Try running with &#39;--enable-preview&#39;&quot;,
4809           class_name-&gt;as_C_string(), major, minor);
4810         return;
4811       }
4812 
4813     } else { // minor != JAVA_PREVIEW_MINOR_VERSION
4814       if (major &gt; max_version) {
4815         ResourceMark rm(THREAD);
4816         Exceptions::fthrow(
4817           THREAD_AND_LOCATION,
4818           vmSymbols::java_lang_UnsupportedClassVersionError(),
4819           &quot;%s has been compiled by a more recent version of the Java Runtime (class file version %u.%u), &quot;
4820           &quot;this version of the Java Runtime only recognizes class file versions up to %u.0&quot;,
4821           class_name-&gt;as_C_string(), major, minor, JVM_CLASSFILE_MAJOR_VERSION);
4822       } else if (major &lt; JAVA_MIN_SUPPORTED_VERSION) {
4823         ResourceMark rm(THREAD);
4824         Exceptions::fthrow(
4825           THREAD_AND_LOCATION,
4826           vmSymbols::java_lang_UnsupportedClassVersionError(),
4827           &quot;%s (class file version %u.%u) was compiled with an invalid major version&quot;,
4828           class_name-&gt;as_C_string(), major, minor);
4829       } else if (minor != 0) {
4830         ResourceMark rm(THREAD);
4831         Exceptions::fthrow(
4832           THREAD_AND_LOCATION,
4833           vmSymbols::java_lang_UnsupportedClassVersionError(),
4834           &quot;%s (class file version %u.%u) was compiled with an invalid non-zero minor version&quot;,
4835           class_name-&gt;as_C_string(), major, minor);
4836       }
4837     }
4838   }
4839 }
4840 
4841 void ClassFileParser::verify_legal_field_modifiers(jint flags,
4842                                                    bool is_interface,
4843                                                    TRAPS) const {
4844   if (!_need_verify) { return; }
4845 
4846   const bool is_public    = (flags &amp; JVM_ACC_PUBLIC)    != 0;
4847   const bool is_protected = (flags &amp; JVM_ACC_PROTECTED) != 0;
4848   const bool is_private   = (flags &amp; JVM_ACC_PRIVATE)   != 0;
4849   const bool is_static    = (flags &amp; JVM_ACC_STATIC)    != 0;
4850   const bool is_final     = (flags &amp; JVM_ACC_FINAL)     != 0;
4851   const bool is_volatile  = (flags &amp; JVM_ACC_VOLATILE)  != 0;
4852   const bool is_transient = (flags &amp; JVM_ACC_TRANSIENT) != 0;
4853   const bool is_enum      = (flags &amp; JVM_ACC_ENUM)      != 0;
4854   const bool major_gte_15 = _major_version &gt;= JAVA_1_5_VERSION;
4855 
4856   bool is_illegal = false;
4857 
4858   if (is_interface) {
4859     if (!is_public || !is_static || !is_final || is_private ||
4860         is_protected || is_volatile || is_transient ||
4861         (major_gte_15 &amp;&amp; is_enum)) {
4862       is_illegal = true;
4863     }
4864   } else { // not interface
4865     if (has_illegal_visibility(flags) || (is_final &amp;&amp; is_volatile)) {
4866       is_illegal = true;
4867     }
4868   }
4869 
4870   if (is_illegal) {
4871     ResourceMark rm(THREAD);
4872     Exceptions::fthrow(
4873       THREAD_AND_LOCATION,
4874       vmSymbols::java_lang_ClassFormatError(),
4875       &quot;Illegal field modifiers in class %s: 0x%X&quot;,
4876       _class_name-&gt;as_C_string(), flags);
4877     return;
4878   }
4879 }
4880 
4881 void ClassFileParser::verify_legal_method_modifiers(jint flags,
4882                                                     bool is_interface,
4883                                                     const Symbol* name,
4884                                                     TRAPS) const {
4885   if (!_need_verify) { return; }
4886 
4887   const bool is_public       = (flags &amp; JVM_ACC_PUBLIC)       != 0;
4888   const bool is_private      = (flags &amp; JVM_ACC_PRIVATE)      != 0;
4889   const bool is_static       = (flags &amp; JVM_ACC_STATIC)       != 0;
4890   const bool is_final        = (flags &amp; JVM_ACC_FINAL)        != 0;
4891   const bool is_native       = (flags &amp; JVM_ACC_NATIVE)       != 0;
4892   const bool is_abstract     = (flags &amp; JVM_ACC_ABSTRACT)     != 0;
4893   const bool is_bridge       = (flags &amp; JVM_ACC_BRIDGE)       != 0;
4894   const bool is_strict       = (flags &amp; JVM_ACC_STRICT)       != 0;
4895   const bool is_synchronized = (flags &amp; JVM_ACC_SYNCHRONIZED) != 0;
4896   const bool is_protected    = (flags &amp; JVM_ACC_PROTECTED)    != 0;
4897   const bool major_gte_15    = _major_version &gt;= JAVA_1_5_VERSION;
4898   const bool major_gte_8     = _major_version &gt;= JAVA_8_VERSION;
4899   const bool is_initializer  = (name == vmSymbols::object_initializer_name());
4900 
4901   bool is_illegal = false;
4902 
4903   if (is_interface) {
4904     if (major_gte_8) {
4905       // Class file version is JAVA_8_VERSION or later Methods of
4906       // interfaces may set any of the flags except ACC_PROTECTED,
4907       // ACC_FINAL, ACC_NATIVE, and ACC_SYNCHRONIZED; they must
4908       // have exactly one of the ACC_PUBLIC or ACC_PRIVATE flags set.
4909       if ((is_public == is_private) || /* Only one of private and public should be true - XNOR */
4910           (is_native || is_protected || is_final || is_synchronized) ||
4911           // If a specific method of a class or interface has its
4912           // ACC_ABSTRACT flag set, it must not have any of its
4913           // ACC_FINAL, ACC_NATIVE, ACC_PRIVATE, ACC_STATIC,
4914           // ACC_STRICT, or ACC_SYNCHRONIZED flags set.  No need to
4915           // check for ACC_FINAL, ACC_NATIVE or ACC_SYNCHRONIZED as
4916           // those flags are illegal irrespective of ACC_ABSTRACT being set or not.
4917           (is_abstract &amp;&amp; (is_private || is_static || is_strict))) {
4918         is_illegal = true;
4919       }
4920     } else if (major_gte_15) {
4921       // Class file version in the interval [JAVA_1_5_VERSION, JAVA_8_VERSION)
4922       if (!is_public || is_private || is_protected || is_static || is_final ||
4923           is_synchronized || is_native || !is_abstract || is_strict) {
4924         is_illegal = true;
4925       }
4926     } else {
4927       // Class file version is pre-JAVA_1_5_VERSION
4928       if (!is_public || is_static || is_final || is_native || !is_abstract) {
4929         is_illegal = true;
4930       }
4931     }
4932   } else { // not interface
4933     if (has_illegal_visibility(flags)) {
4934       is_illegal = true;
4935     } else {
4936       if (is_initializer) {
4937         if (is_static || is_final || is_synchronized || is_native ||
4938             is_abstract || (major_gte_15 &amp;&amp; is_bridge)) {
4939           is_illegal = true;
4940         }
4941       } else { // not initializer
4942         if (is_abstract) {
4943           if ((is_final || is_native || is_private || is_static ||
4944               (major_gte_15 &amp;&amp; (is_synchronized || is_strict)))) {
4945             is_illegal = true;
4946           }
4947         }
4948       }
4949     }
4950   }
4951 
4952   if (is_illegal) {
4953     ResourceMark rm(THREAD);
4954     Exceptions::fthrow(
4955       THREAD_AND_LOCATION,
4956       vmSymbols::java_lang_ClassFormatError(),
4957       &quot;Method %s in class %s has illegal modifiers: 0x%X&quot;,
4958       name-&gt;as_C_string(), _class_name-&gt;as_C_string(), flags);
4959     return;
4960   }
4961 }
4962 
4963 void ClassFileParser::verify_legal_utf8(const unsigned char* buffer,
4964                                         int length,
4965                                         TRAPS) const {
4966   assert(_need_verify, &quot;only called when _need_verify is true&quot;);
4967   if (!UTF8::is_legal_utf8(buffer, length, _major_version &lt;= 47)) {
4968     classfile_parse_error(&quot;Illegal UTF8 string in constant pool in class file %s&quot;, CHECK);
4969   }
4970 }
4971 
4972 // Unqualified names may not contain the characters &#39;.&#39;, &#39;;&#39;, &#39;[&#39;, or &#39;/&#39;.
4973 // In class names, &#39;/&#39; separates unqualified names.  This is verified in this function also.
4974 // Method names also may not contain the characters &#39;&lt;&#39; or &#39;&gt;&#39;, unless &lt;init&gt;
4975 // or &lt;clinit&gt;.  Note that method names may not be &lt;init&gt; or &lt;clinit&gt; in this
4976 // method.  Because these names have been checked as special cases before
4977 // calling this method in verify_legal_method_name.
4978 //
4979 // This method is also called from the modular system APIs in modules.cpp
4980 // to verify the validity of module and package names.
4981 bool ClassFileParser::verify_unqualified_name(const char* name,
4982                                               unsigned int length,
4983                                               int type) {
4984   for (const char* p = name; p != name + length; p++) {
4985     switch(*p) {
4986       case &#39;.&#39;:
4987       case &#39;;&#39;:
4988       case &#39;[&#39;:
4989         // do not permit &#39;.&#39;, &#39;;&#39;, or &#39;[&#39;
4990         return false;
4991       case &#39;/&#39;:
4992         // check for &#39;//&#39; or leading or trailing &#39;/&#39; which are not legal
4993         // unqualified name must not be empty
4994         if (type == ClassFileParser::LegalClass) {
4995           if (p == name || p+1 &gt;= name+length || *(p+1) == &#39;/&#39;) {
4996             return false;
4997           }
4998         } else {
4999           return false;   // do not permit &#39;/&#39; unless it&#39;s class name
5000         }
5001         break;
5002       case &#39;&lt;&#39;:
5003       case &#39;&gt;&#39;:
5004         // do not permit &#39;&lt;&#39; or &#39;&gt;&#39; in method names
5005         if (type == ClassFileParser::LegalMethod) {
5006           return false;
5007         }
5008     }
5009   }
5010   return true;
5011 }
5012 
5013 // Take pointer to a UTF8 byte string (not NUL-terminated).
5014 // Skip over the longest part of the string that could
5015 // be taken as a fieldname. Allow &#39;/&#39; if slash_ok is true.
5016 // Return a pointer to just past the fieldname.
5017 // Return NULL if no fieldname at all was found, or in the case of slash_ok
5018 // being true, we saw consecutive slashes (meaning we were looking for a
5019 // qualified path but found something that was badly-formed).
5020 static const char* skip_over_field_name(const char* const name,
5021                                         bool slash_ok,
5022                                         unsigned int length) {
5023   const char* p;
5024   jboolean last_is_slash = false;
5025   jboolean not_first_ch = false;
5026 
5027   for (p = name; p != name + length; not_first_ch = true) {
5028     const char* old_p = p;
5029     jchar ch = *p;
5030     if (ch &lt; 128) {
5031       p++;
5032       // quick check for ascii
5033       if ((ch &gt;= &#39;a&#39; &amp;&amp; ch &lt;= &#39;z&#39;) ||
5034         (ch &gt;= &#39;A&#39; &amp;&amp; ch &lt;= &#39;Z&#39;) ||
5035         (ch == &#39;_&#39; || ch == &#39;$&#39;) ||
5036         (not_first_ch &amp;&amp; ch &gt;= &#39;0&#39; &amp;&amp; ch &lt;= &#39;9&#39;)) {
5037         last_is_slash = false;
5038         continue;
5039       }
5040       if (slash_ok &amp;&amp; ch == &#39;/&#39;) {
5041         if (last_is_slash) {
5042           return NULL;  // Don&#39;t permit consecutive slashes
5043         }
5044         last_is_slash = true;
5045         continue;
5046       }
5047     }
5048     else {
5049       jint unicode_ch;
5050       char* tmp_p = UTF8::next_character(p, &amp;unicode_ch);
5051       p = tmp_p;
5052       last_is_slash = false;
5053       // Check if ch is Java identifier start or is Java identifier part
5054       // 4672820: call java.lang.Character methods directly without generating separate tables.
5055       EXCEPTION_MARK;
5056       // return value
5057       JavaValue result(T_BOOLEAN);
5058       // Set up the arguments to isJavaIdentifierStart or isJavaIdentifierPart
5059       JavaCallArguments args;
5060       args.push_int(unicode_ch);
5061 
5062       if (not_first_ch) {
5063         // public static boolean isJavaIdentifierPart(char ch);
5064         JavaCalls::call_static(&amp;result,
5065           SystemDictionary::Character_klass(),
5066           vmSymbols::isJavaIdentifierPart_name(),
5067           vmSymbols::int_bool_signature(),
5068           &amp;args,
5069           THREAD);
5070       } else {
5071         // public static boolean isJavaIdentifierStart(char ch);
5072         JavaCalls::call_static(&amp;result,
5073           SystemDictionary::Character_klass(),
5074           vmSymbols::isJavaIdentifierStart_name(),
5075           vmSymbols::int_bool_signature(),
5076           &amp;args,
5077           THREAD);
5078       }
5079       if (HAS_PENDING_EXCEPTION) {
5080         CLEAR_PENDING_EXCEPTION;
5081         return NULL;
5082       }
5083       if(result.get_jboolean()) {
5084         continue;
5085       }
5086     }
5087     return (not_first_ch) ? old_p : NULL;
5088   }
5089   return (not_first_ch) ? p : NULL;
5090 }
5091 
5092 // Take pointer to a UTF8 byte string (not NUL-terminated).
5093 // Skip over the longest part of the string that could
5094 // be taken as a field signature. Allow &quot;void&quot; if void_ok.
5095 // Return a pointer to just past the signature.
5096 // Return NULL if no legal signature is found.
5097 const char* ClassFileParser::skip_over_field_signature(const char* signature,
5098                                                        bool void_ok,
5099                                                        unsigned int length,
5100                                                        TRAPS) const {
5101   unsigned int array_dim = 0;
5102   while (length &gt; 0) {
5103     switch (signature[0]) {
5104     case JVM_SIGNATURE_VOID: if (!void_ok) { return NULL; }
5105     case JVM_SIGNATURE_BOOLEAN:
5106     case JVM_SIGNATURE_BYTE:
5107     case JVM_SIGNATURE_CHAR:
5108     case JVM_SIGNATURE_SHORT:
5109     case JVM_SIGNATURE_INT:
5110     case JVM_SIGNATURE_FLOAT:
5111     case JVM_SIGNATURE_LONG:
5112     case JVM_SIGNATURE_DOUBLE:
5113       return signature + 1;
5114     case JVM_SIGNATURE_CLASS: {
5115       if (_major_version &lt; JAVA_1_5_VERSION) {
5116         // Skip over the class name if one is there
5117         const char* const p = skip_over_field_name(signature + 1, true, --length);
5118 
5119         // The next character better be a semicolon
5120         if (p &amp;&amp; (p - signature) &gt; 1 &amp;&amp; p[0] == &#39;;&#39;) {
5121           return p + 1;
5122         }
5123       }
5124       else {
5125         // Skip leading &#39;L&#39; and ignore first appearance of &#39;;&#39;
5126         signature++;
5127         const char* c = (const char*) memchr(signature, &#39;;&#39;, length - 1);
5128         // Format check signature
5129         if (c != NULL) {
5130           int newlen = c - (char*) signature;
5131           bool legal = verify_unqualified_name(signature, newlen, LegalClass);
5132           if (!legal) {
5133             classfile_parse_error(&quot;Class name contains illegal character &quot;
5134                                   &quot;in descriptor in class file %s&quot;,
5135                                   CHECK_0);
5136             return NULL;
5137           }
5138           return signature + newlen + 1;
5139         }
5140       }
5141       return NULL;
5142     }
5143     case JVM_SIGNATURE_ARRAY:
5144       array_dim++;
5145       if (array_dim &gt; 255) {
5146         // 4277370: array descriptor is valid only if it represents 255 or fewer dimensions.
5147         classfile_parse_error(&quot;Array type descriptor has more than 255 dimensions in class file %s&quot;, CHECK_0);
5148       }
5149       // The rest of what&#39;s there better be a legal signature
5150       signature++;
5151       length--;
5152       void_ok = false;
5153       break;
5154     default:
5155       return NULL;
5156     }
5157   }
5158   return NULL;
5159 }
5160 
5161 // Checks if name is a legal class name.
5162 void ClassFileParser::verify_legal_class_name(const Symbol* name, TRAPS) const {
5163   if (!_need_verify || _relax_verify) { return; }
5164 
5165   assert(name-&gt;refcount() &gt; 0, &quot;symbol must be kept alive&quot;);
5166   char* bytes = (char*)name-&gt;bytes();
5167   unsigned int length = name-&gt;utf8_length();
5168   bool legal = false;
5169 
5170   if (length &gt; 0) {
5171     const char* p;
5172     if (bytes[0] == JVM_SIGNATURE_ARRAY) {
5173       p = skip_over_field_signature(bytes, false, length, CHECK);
5174       legal = (p != NULL) &amp;&amp; ((p - bytes) == (int)length);
5175     } else if (_major_version &lt; JAVA_1_5_VERSION) {
5176       if (bytes[0] != &#39;&lt;&#39;) {
5177         p = skip_over_field_name(bytes, true, length);
5178         legal = (p != NULL) &amp;&amp; ((p - bytes) == (int)length);
5179       }
5180     } else {
5181       // 4900761: relax the constraints based on JSR202 spec
5182       // Class names may be drawn from the entire Unicode character set.
5183       // Identifiers between &#39;/&#39; must be unqualified names.
5184       // The utf8 string has been verified when parsing cpool entries.
5185       legal = verify_unqualified_name(bytes, length, LegalClass);
5186     }
5187   }
5188   if (!legal) {
5189     ResourceMark rm(THREAD);
5190     assert(_class_name != NULL, &quot;invariant&quot;);
5191     Exceptions::fthrow(
5192       THREAD_AND_LOCATION,
5193       vmSymbols::java_lang_ClassFormatError(),
5194       &quot;Illegal class name \&quot;%.*s\&quot; in class file %s&quot;, length, bytes,
5195       _class_name-&gt;as_C_string()
5196     );
5197     return;
5198   }
5199 }
5200 
5201 // Checks if name is a legal field name.
5202 void ClassFileParser::verify_legal_field_name(const Symbol* name, TRAPS) const {
5203   if (!_need_verify || _relax_verify) { return; }
5204 
5205   char* bytes = (char*)name-&gt;bytes();
5206   unsigned int length = name-&gt;utf8_length();
5207   bool legal = false;
5208 
5209   if (length &gt; 0) {
5210     if (_major_version &lt; JAVA_1_5_VERSION) {
5211       if (bytes[0] != &#39;&lt;&#39;) {
5212         const char* p = skip_over_field_name(bytes, false, length);
5213         legal = (p != NULL) &amp;&amp; ((p - bytes) == (int)length);
5214       }
5215     } else {
5216       // 4881221: relax the constraints based on JSR202 spec
5217       legal = verify_unqualified_name(bytes, length, LegalField);
5218     }
5219   }
5220 
5221   if (!legal) {
5222     ResourceMark rm(THREAD);
5223     assert(_class_name != NULL, &quot;invariant&quot;);
5224     Exceptions::fthrow(
5225       THREAD_AND_LOCATION,
5226       vmSymbols::java_lang_ClassFormatError(),
5227       &quot;Illegal field name \&quot;%.*s\&quot; in class %s&quot;, length, bytes,
5228       _class_name-&gt;as_C_string()
5229     );
5230     return;
5231   }
5232 }
5233 
5234 // Checks if name is a legal method name.
5235 void ClassFileParser::verify_legal_method_name(const Symbol* name, TRAPS) const {
5236   if (!_need_verify || _relax_verify) { return; }
5237 
5238   assert(name != NULL, &quot;method name is null&quot;);
5239   char* bytes = (char*)name-&gt;bytes();
5240   unsigned int length = name-&gt;utf8_length();
5241   bool legal = false;
5242 
5243   if (length &gt; 0) {
5244     if (bytes[0] == &#39;&lt;&#39;) {
5245       if (name == vmSymbols::object_initializer_name() || name == vmSymbols::class_initializer_name()) {
5246         legal = true;
5247       }
5248     } else if (_major_version &lt; JAVA_1_5_VERSION) {
5249       const char* p;
5250       p = skip_over_field_name(bytes, false, length);
5251       legal = (p != NULL) &amp;&amp; ((p - bytes) == (int)length);
5252     } else {
5253       // 4881221: relax the constraints based on JSR202 spec
5254       legal = verify_unqualified_name(bytes, length, LegalMethod);
5255     }
5256   }
5257 
5258   if (!legal) {
5259     ResourceMark rm(THREAD);
5260     assert(_class_name != NULL, &quot;invariant&quot;);
5261     Exceptions::fthrow(
5262       THREAD_AND_LOCATION,
5263       vmSymbols::java_lang_ClassFormatError(),
5264       &quot;Illegal method name \&quot;%.*s\&quot; in class %s&quot;, length, bytes,
5265       _class_name-&gt;as_C_string()
5266     );
5267     return;
5268   }
5269 }
5270 
5271 
5272 // Checks if signature is a legal field signature.
5273 void ClassFileParser::verify_legal_field_signature(const Symbol* name,
5274                                                    const Symbol* signature,
5275                                                    TRAPS) const {
5276   if (!_need_verify) { return; }
5277 
5278   const char* const bytes = (const char* const)signature-&gt;bytes();
5279   const unsigned int length = signature-&gt;utf8_length();
5280   const char* const p = skip_over_field_signature(bytes, false, length, CHECK);
5281 
5282   if (p == NULL || (p - bytes) != (int)length) {
5283     throwIllegalSignature(&quot;Field&quot;, name, signature, CHECK);
5284   }
5285 }
5286 
5287 // Checks if signature is a legal method signature.
5288 // Returns number of parameters
5289 int ClassFileParser::verify_legal_method_signature(const Symbol* name,
5290                                                    const Symbol* signature,
5291                                                    TRAPS) const {
5292   if (!_need_verify) {
5293     // make sure caller&#39;s args_size will be less than 0 even for non-static
5294     // method so it will be recomputed in compute_size_of_parameters().
5295     return -2;
5296   }
5297 
5298   // Class initializers cannot have args for class format version &gt;= 51.
5299   if (name == vmSymbols::class_initializer_name() &amp;&amp;
5300       signature != vmSymbols::void_method_signature() &amp;&amp;
5301       _major_version &gt;= JAVA_7_VERSION) {
5302     throwIllegalSignature(&quot;Method&quot;, name, signature, CHECK_0);
5303     return 0;
5304   }
5305 
5306   unsigned int args_size = 0;
5307   const char* p = (const char*)signature-&gt;bytes();
5308   unsigned int length = signature-&gt;utf8_length();
5309   const char* nextp;
5310 
5311   // The first character must be a &#39;(&#39;
5312   if ((length &gt; 0) &amp;&amp; (*p++ == JVM_SIGNATURE_FUNC)) {
5313     length--;
5314     // Skip over legal field signatures
5315     nextp = skip_over_field_signature(p, false, length, CHECK_0);
5316     while ((length &gt; 0) &amp;&amp; (nextp != NULL)) {
5317       args_size++;
5318       if (p[0] == &#39;J&#39; || p[0] == &#39;D&#39;) {
5319         args_size++;
5320       }
5321       length -= nextp - p;
5322       p = nextp;
5323       nextp = skip_over_field_signature(p, false, length, CHECK_0);
5324     }
5325     // The first non-signature thing better be a &#39;)&#39;
5326     if ((length &gt; 0) &amp;&amp; (*p++ == JVM_SIGNATURE_ENDFUNC)) {
5327       length--;
5328       if (name-&gt;utf8_length() &gt; 0 &amp;&amp; name-&gt;char_at(0) == &#39;&lt;&#39;) {
5329         // All internal methods must return void
5330         if ((length == 1) &amp;&amp; (p[0] == JVM_SIGNATURE_VOID)) {
5331           return args_size;
5332         }
5333       } else {
5334         // Now we better just have a return value
5335         nextp = skip_over_field_signature(p, true, length, CHECK_0);
5336         if (nextp &amp;&amp; ((int)length == (nextp - p))) {
5337           return args_size;
5338         }
5339       }
5340     }
5341   }
5342   // Report error
5343   throwIllegalSignature(&quot;Method&quot;, name, signature, CHECK_0);
5344   return 0;
5345 }
5346 
5347 int ClassFileParser::static_field_size() const {
5348   assert(_field_info != NULL, &quot;invariant&quot;);
5349   return _field_info-&gt;static_field_size;
5350 }
5351 
5352 int ClassFileParser::total_oop_map_count() const {
5353   assert(_field_info != NULL, &quot;invariant&quot;);
5354   return _field_info-&gt;total_oop_map_count;
5355 }
5356 
5357 jint ClassFileParser::layout_size() const {
5358   assert(_field_info != NULL, &quot;invariant&quot;);
5359   return _field_info-&gt;instance_size;
5360 }
5361 
5362 static void check_methods_for_intrinsics(const InstanceKlass* ik,
5363                                          const Array&lt;Method*&gt;* methods) {
5364   assert(ik != NULL, &quot;invariant&quot;);
5365   assert(methods != NULL, &quot;invariant&quot;);
5366 
5367   // Set up Method*::intrinsic_id as soon as we know the names of methods.
5368   // (We used to do this lazily, but now we query it in Rewriter,
5369   // which is eagerly done for every method, so we might as well do it now,
5370   // when everything is fresh in memory.)
5371   const vmSymbols::SID klass_id = Method::klass_id_for_intrinsics(ik);
5372 
5373   if (klass_id != vmSymbols::NO_SID) {
5374     for (int j = 0; j &lt; methods-&gt;length(); ++j) {
5375       Method* method = methods-&gt;at(j);
5376       method-&gt;init_intrinsic_id();
5377 
5378       if (CheckIntrinsics) {
5379         // Check if an intrinsic is defined for method &#39;method&#39;,
5380         // but the method is not annotated with @HotSpotIntrinsicCandidate.
5381         if (method-&gt;intrinsic_id() != vmIntrinsics::_none &amp;&amp;
5382             !method-&gt;intrinsic_candidate()) {
5383               tty-&gt;print(&quot;Compiler intrinsic is defined for method [%s], &quot;
5384               &quot;but the method is not annotated with @HotSpotIntrinsicCandidate.%s&quot;,
5385               method-&gt;name_and_sig_as_C_string(),
5386               NOT_DEBUG(&quot; Method will not be inlined.&quot;) DEBUG_ONLY(&quot; Exiting.&quot;)
5387             );
5388           tty-&gt;cr();
5389           DEBUG_ONLY(vm_exit(1));
5390         }
5391         // Check is the method &#39;method&#39; is annotated with @HotSpotIntrinsicCandidate,
5392         // but there is no intrinsic available for it.
5393         if (method-&gt;intrinsic_candidate() &amp;&amp;
5394           method-&gt;intrinsic_id() == vmIntrinsics::_none) {
5395             tty-&gt;print(&quot;Method [%s] is annotated with @HotSpotIntrinsicCandidate, &quot;
5396               &quot;but no compiler intrinsic is defined for the method.%s&quot;,
5397               method-&gt;name_and_sig_as_C_string(),
5398               NOT_DEBUG(&quot;&quot;) DEBUG_ONLY(&quot; Exiting.&quot;)
5399             );
5400           tty-&gt;cr();
5401           DEBUG_ONLY(vm_exit(1));
5402         }
5403       }
5404     } // end for
5405 
5406 #ifdef ASSERT
5407     if (CheckIntrinsics) {
5408       // Check for orphan methods in the current class. A method m
5409       // of a class C is orphan if an intrinsic is defined for method m,
5410       // but class C does not declare m.
5411       // The check is potentially expensive, therefore it is available
5412       // only in debug builds.
5413 
5414       for (int id = vmIntrinsics::FIRST_ID; id &lt; (int)vmIntrinsics::ID_LIMIT; ++id) {
5415         if (vmIntrinsics::_compiledLambdaForm == id) {
5416           // The _compiledLamdbdaForm intrinsic is a special marker for bytecode
5417           // generated for the JVM from a LambdaForm and therefore no method
5418           // is defined for it.
5419           continue;
5420         }
5421 
5422         if (vmIntrinsics::class_for(vmIntrinsics::ID_from(id)) == klass_id) {
5423           // Check if the current class contains a method with the same
5424           // name, flags, signature.
5425           bool match = false;
5426           for (int j = 0; j &lt; methods-&gt;length(); ++j) {
5427             const Method* method = methods-&gt;at(j);
5428             if (method-&gt;intrinsic_id() == id) {
5429               match = true;
5430               break;
5431             }
5432           }
5433 
5434           if (!match) {
5435             char buf[1000];
5436             tty-&gt;print(&quot;Compiler intrinsic is defined for method [%s], &quot;
5437                        &quot;but the method is not available in class [%s].%s&quot;,
5438                         vmIntrinsics::short_name_as_C_string(vmIntrinsics::ID_from(id),
5439                                                              buf, sizeof(buf)),
5440                         ik-&gt;name()-&gt;as_C_string(),
5441                         NOT_DEBUG(&quot;&quot;) DEBUG_ONLY(&quot; Exiting.&quot;)
5442             );
5443             tty-&gt;cr();
5444             DEBUG_ONLY(vm_exit(1));
5445           }
5446         }
5447       } // end for
5448     } // CheckIntrinsics
5449 #endif // ASSERT
5450   }
5451 }
5452 
5453 InstanceKlass* ClassFileParser::create_instance_klass(bool changed_by_loadhook, TRAPS) {
5454   if (_klass != NULL) {
5455     return _klass;
5456   }
5457 
5458   InstanceKlass* const ik =
5459     InstanceKlass::allocate_instance_klass(*this, CHECK_NULL);
5460 
5461   fill_instance_klass(ik, changed_by_loadhook, CHECK_NULL);
5462 
5463   assert(_klass == ik, &quot;invariant&quot;);
5464 
5465 
5466   if (ik-&gt;should_store_fingerprint()) {
5467     ik-&gt;store_fingerprint(_stream-&gt;compute_fingerprint());
5468   }
5469 
5470   ik-&gt;set_has_passed_fingerprint_check(false);
5471   if (UseAOT &amp;&amp; ik-&gt;supers_have_passed_fingerprint_checks()) {
5472     uint64_t aot_fp = AOTLoader::get_saved_fingerprint(ik);
5473     uint64_t fp = ik-&gt;has_stored_fingerprint() ? ik-&gt;get_stored_fingerprint() : _stream-&gt;compute_fingerprint();
5474     if (aot_fp != 0 &amp;&amp; aot_fp == fp) {
5475       // This class matches with a class saved in an AOT library
5476       ik-&gt;set_has_passed_fingerprint_check(true);
5477     } else {
5478       ResourceMark rm;
5479       log_info(class, fingerprint)(&quot;%s :  expected = &quot; PTR64_FORMAT &quot; actual = &quot; PTR64_FORMAT,
5480                                  ik-&gt;external_name(), aot_fp, _stream-&gt;compute_fingerprint());
5481     }
5482   }
5483 
5484   return ik;
5485 }
5486 
5487 void ClassFileParser::fill_instance_klass(InstanceKlass* ik, bool changed_by_loadhook, TRAPS) {
5488   assert(ik != NULL, &quot;invariant&quot;);
5489 
5490   // Set name and CLD before adding to CLD
5491   ik-&gt;set_class_loader_data(_loader_data);
5492   ik-&gt;set_name(_class_name);
5493 
5494   // Add all classes to our internal class loader list here,
5495   // including classes in the bootstrap (NULL) class loader.
5496   const bool publicize = !is_internal();
5497 
5498   _loader_data-&gt;add_class(ik, publicize);
5499 
5500   set_klass_to_deallocate(ik);
5501 
5502   assert(_field_info != NULL, &quot;invariant&quot;);
5503   assert(ik-&gt;static_field_size() == _field_info-&gt;static_field_size, &quot;sanity&quot;);
5504   assert(ik-&gt;nonstatic_oop_map_count() == _field_info-&gt;total_oop_map_count,
5505     &quot;sanity&quot;);
5506 
5507   assert(ik-&gt;is_instance_klass(), &quot;sanity&quot;);
5508   assert(ik-&gt;size_helper() == _field_info-&gt;instance_size, &quot;sanity&quot;);
5509 
5510   // Fill in information already parsed
5511   ik-&gt;set_should_verify_class(_need_verify);
5512 
5513   // Not yet: supers are done below to support the new subtype-checking fields
5514   ik-&gt;set_nonstatic_field_size(_field_info-&gt;nonstatic_field_size);
5515   ik-&gt;set_has_nonstatic_fields(_field_info-&gt;has_nonstatic_fields);
5516   assert(_fac != NULL, &quot;invariant&quot;);
5517   ik-&gt;set_static_oop_field_count(_fac-&gt;count[STATIC_OOP]);
5518 
5519   // this transfers ownership of a lot of arrays from
5520   // the parser onto the InstanceKlass*
5521   apply_parsed_class_metadata(ik, _java_fields_count, CHECK);
5522 
5523   // note that is not safe to use the fields in the parser from this point on
5524   assert(NULL == _cp, &quot;invariant&quot;);
5525   assert(NULL == _fields, &quot;invariant&quot;);
5526   assert(NULL == _methods, &quot;invariant&quot;);
5527   assert(NULL == _inner_classes, &quot;invariant&quot;);
5528   assert(NULL == _nest_members, &quot;invariant&quot;);
5529   assert(NULL == _local_interfaces, &quot;invariant&quot;);
5530   assert(NULL == _combined_annotations, &quot;invariant&quot;);
5531 
5532   if (_has_final_method) {
5533     ik-&gt;set_has_final_method();
5534   }
5535 
5536   ik-&gt;copy_method_ordering(_method_ordering, CHECK);
5537   // The InstanceKlass::_methods_jmethod_ids cache
5538   // is managed on the assumption that the initial cache
5539   // size is equal to the number of methods in the class. If
5540   // that changes, then InstanceKlass::idnum_can_increment()
5541   // has to be changed accordingly.
5542   ik-&gt;set_initial_method_idnum(ik-&gt;methods()-&gt;length());
5543 
5544   ik-&gt;set_this_class_index(_this_class_index);
5545 
5546   if (is_unsafe_anonymous()) {
5547     // _this_class_index is a CONSTANT_Class entry that refers to this
5548     // anonymous class itself. If this class needs to refer to its own methods or
5549     // fields, it would use a CONSTANT_MethodRef, etc, which would reference
5550     // _this_class_index. However, because this class is anonymous (it&#39;s
5551     // not stored in SystemDictionary), _this_class_index cannot be resolved
5552     // with ConstantPool::klass_at_impl, which does a SystemDictionary lookup.
5553     // Therefore, we must eagerly resolve _this_class_index now.
5554     ik-&gt;constants()-&gt;klass_at_put(_this_class_index, ik);
5555   }
5556 
5557   ik-&gt;set_minor_version(_minor_version);
5558   ik-&gt;set_major_version(_major_version);
5559   ik-&gt;set_has_nonstatic_concrete_methods(_has_nonstatic_concrete_methods);
5560   ik-&gt;set_declares_nonstatic_concrete_methods(_declares_nonstatic_concrete_methods);
5561 
5562   if (_unsafe_anonymous_host != NULL) {
5563     assert (ik-&gt;is_unsafe_anonymous(), &quot;should be the same&quot;);
5564     ik-&gt;set_unsafe_anonymous_host(_unsafe_anonymous_host);
5565   }
5566 
5567   // Set PackageEntry for this_klass
5568   oop cl = ik-&gt;class_loader();
5569   Handle clh = Handle(THREAD, java_lang_ClassLoader::non_reflection_class_loader(cl));
5570   ClassLoaderData* cld = ClassLoaderData::class_loader_data_or_null(clh());
5571   ik-&gt;set_package(cld, CHECK);
5572 
5573   const Array&lt;Method*&gt;* const methods = ik-&gt;methods();
5574   assert(methods != NULL, &quot;invariant&quot;);
5575   const int methods_len = methods-&gt;length();
5576 
5577   check_methods_for_intrinsics(ik, methods);
5578 
5579   // Fill in field values obtained by parse_classfile_attributes
5580   if (_parsed_annotations-&gt;has_any_annotations()) {
5581     _parsed_annotations-&gt;apply_to(ik);
5582   }
5583 
5584   apply_parsed_class_attributes(ik);
5585 
5586   // Miranda methods
5587   if ((_num_miranda_methods &gt; 0) ||
5588       // if this class introduced new miranda methods or
5589       (_super_klass != NULL &amp;&amp; _super_klass-&gt;has_miranda_methods())
5590         // super class exists and this class inherited miranda methods
5591      ) {
5592        ik-&gt;set_has_miranda_methods(); // then set a flag
5593   }
5594 
5595   // Fill in information needed to compute superclasses.
5596   ik-&gt;initialize_supers(const_cast&lt;InstanceKlass*&gt;(_super_klass), _transitive_interfaces, CHECK);
5597   ik-&gt;set_transitive_interfaces(_transitive_interfaces);
5598   _transitive_interfaces = NULL;
5599 
5600   // Initialize itable offset tables
5601   klassItable::setup_itable_offset_table(ik);
5602 
5603   // Compute transitive closure of interfaces this class implements
5604   // Do final class setup
5605   fill_oop_maps(ik,
5606                 _field_info-&gt;nonstatic_oop_map_count,
5607                 _field_info-&gt;nonstatic_oop_offsets,
5608                 _field_info-&gt;nonstatic_oop_counts);
5609 
5610   // Fill in has_finalizer, has_vanilla_constructor, and layout_helper
5611   set_precomputed_flags(ik);
5612 
5613   // check if this class can access its super class
5614   check_super_class_access(ik, CHECK);
5615 
5616   // check if this class can access its superinterfaces
5617   check_super_interface_access(ik, CHECK);
5618 
5619   // check if this class overrides any final method
5620   check_final_method_override(ik, CHECK);
5621 
5622   // reject static interface methods prior to Java 8
5623   if (ik-&gt;is_interface() &amp;&amp; _major_version &lt; JAVA_8_VERSION) {
5624     check_illegal_static_method(ik, CHECK);
5625   }
5626 
5627   // Obtain this_klass&#39; module entry
5628   ModuleEntry* module_entry = ik-&gt;module();
5629   assert(module_entry != NULL, &quot;module_entry should always be set&quot;);
5630 
5631   // Obtain java.lang.Module
5632   Handle module_handle(THREAD, module_entry-&gt;module());
5633 
5634   // Allocate mirror and initialize static fields
5635   // The create_mirror() call will also call compute_modifiers()
5636   java_lang_Class::create_mirror(ik,
5637                                  Handle(THREAD, _loader_data-&gt;class_loader()),
5638                                  module_handle,
5639                                  _protection_domain,
5640                                  CHECK);
5641 
5642   assert(_all_mirandas != NULL, &quot;invariant&quot;);
5643 
5644   // Generate any default methods - default methods are public interface methods
5645   // that have a default implementation.  This is new with Java 8.
5646   if (_has_nonstatic_concrete_methods) {
5647     DefaultMethods::generate_default_methods(ik,
5648                                              _all_mirandas,
5649                                              CHECK);
5650   }
5651 
5652   // Add read edges to the unnamed modules of the bootstrap and app class loaders.
5653   if (changed_by_loadhook &amp;&amp; !module_handle.is_null() &amp;&amp; module_entry-&gt;is_named() &amp;&amp;
5654       !module_entry-&gt;has_default_read_edges()) {
5655     if (!module_entry-&gt;set_has_default_read_edges()) {
5656       // We won a potential race
5657       JvmtiExport::add_default_read_edges(module_handle, THREAD);
5658     }
5659   }
5660 
5661   ClassLoadingService::notify_class_loaded(ik, false /* not shared class */);
5662 
5663 #if INCLUDE_TSAN
5664   if (ThreadSanitizer &amp;&amp; !ik-&gt;is_interface()) {
5665     ik-&gt;ensure_space_for_methodids(0);
5666     int num_methods = ik-&gt;methods()-&gt;length();
5667     for (int index = 0; index &lt; num_methods; index++) {
5668       // Make sure each method has a jmethodID.
5669       // This allows us to avoid allocating jmethodIDs during program execution.
5670       jmethodID id = ik-&gt;methods()-&gt;at(index)-&gt;jmethod_id();
5671 #ifdef ASSERT
5672       u8 id_u8 = reinterpret_cast&lt;u8&gt;(id);
5673       assert((id_u8 &amp; right_n_bits(3)) == 0, &quot;jmethodID is not aligned&quot;);
5674       assert((id_u8 &amp; left_n_bits(17)) == 0, &quot;jmethodID is not aligned&quot;);
5675 #endif
5676     }
5677   }
5678 #endif // INCLUDE_TSAN
5679 
5680   if (!is_internal()) {
5681     if (log_is_enabled(Info, class, load)) {
5682       ResourceMark rm;
5683       const char* module_name = (module_entry-&gt;name() == NULL) ? UNNAMED_MODULE : module_entry-&gt;name()-&gt;as_C_string();
5684       ik-&gt;print_class_load_logging(_loader_data, module_name, _stream);
5685     }
5686 
5687     if (ik-&gt;minor_version() == JAVA_PREVIEW_MINOR_VERSION &amp;&amp;
5688         ik-&gt;major_version() != JAVA_MIN_SUPPORTED_VERSION &amp;&amp;
5689         log_is_enabled(Info, class, preview)) {
5690       ResourceMark rm;
5691       log_info(class, preview)(&quot;Loading class %s that depends on preview features (class file version %d.65535)&quot;,
5692                                ik-&gt;external_name(), ik-&gt;major_version());
5693     }
5694 
5695     if (log_is_enabled(Debug, class, resolve))  {
5696       ResourceMark rm;
5697       // print out the superclass.
5698       const char * from = ik-&gt;external_name();
5699       if (ik-&gt;java_super() != NULL) {
5700         log_debug(class, resolve)(&quot;%s %s (super)&quot;,
5701                    from,
5702                    ik-&gt;java_super()-&gt;external_name());
5703       }
5704       // print out each of the interface classes referred to by this class.
5705       const Array&lt;InstanceKlass*&gt;* const local_interfaces = ik-&gt;local_interfaces();
5706       if (local_interfaces != NULL) {
5707         const int length = local_interfaces-&gt;length();
5708         for (int i = 0; i &lt; length; i++) {
5709           const InstanceKlass* const k = local_interfaces-&gt;at(i);
5710           const char * to = k-&gt;external_name();
5711           log_debug(class, resolve)(&quot;%s %s (interface)&quot;, from, to);
5712         }
5713       }
5714     }
5715   }
5716 
5717   JFR_ONLY(INIT_ID(ik);)
5718 
5719   // If we reach here, all is well.
5720   // Now remove the InstanceKlass* from the _klass_to_deallocate field
5721   // in order for it to not be destroyed in the ClassFileParser destructor.
5722   set_klass_to_deallocate(NULL);
5723 
5724   // it&#39;s official
5725   set_klass(ik);
5726 
5727   debug_only(ik-&gt;verify();)
5728 }
5729 
5730 void ClassFileParser::update_class_name(Symbol* new_class_name) {
5731   // Decrement the refcount in the old name, since we&#39;re clobbering it.
5732   _class_name-&gt;decrement_refcount();
5733 
5734   _class_name = new_class_name;
5735   // Increment the refcount of the new name.
5736   // Now the ClassFileParser owns this name and will decrement in
5737   // the destructor.
5738   _class_name-&gt;increment_refcount();
5739 }
5740 
5741 
5742 // For an unsafe anonymous class that is in the unnamed package, move it to its host class&#39;s
5743 // package by prepending its host class&#39;s package name to its class name and setting
5744 // its _class_name field.
5745 void ClassFileParser::prepend_host_package_name(const InstanceKlass* unsafe_anonymous_host, TRAPS) {
5746   ResourceMark rm(THREAD);
5747   assert(strrchr(_class_name-&gt;as_C_string(), &#39;/&#39;) == NULL,
5748          &quot;Unsafe anonymous class should not be in a package&quot;);
5749   const char* host_pkg_name =
5750     ClassLoader::package_from_name(unsafe_anonymous_host-&gt;name()-&gt;as_C_string(), NULL);
5751 
5752   if (host_pkg_name != NULL) {
5753     int host_pkg_len = (int)strlen(host_pkg_name);
5754     int class_name_len = _class_name-&gt;utf8_length();
5755     int symbol_len = host_pkg_len + 1 + class_name_len;
5756     char* new_anon_name = NEW_RESOURCE_ARRAY(char, symbol_len + 1);
5757     int n = os::snprintf(new_anon_name, symbol_len + 1, &quot;%s/%.*s&quot;,
5758                          host_pkg_name, class_name_len, _class_name-&gt;base());
5759     assert(n == symbol_len, &quot;Unexpected number of characters in string&quot;);
5760 
5761     // Decrement old _class_name to avoid leaking.
5762     _class_name-&gt;decrement_refcount();
5763 
5764     // Create a symbol and update the anonymous class name.
5765     // The new class name is created with a refcount of one. When installed into the InstanceKlass,
5766     // it&#39;ll be two and when the ClassFileParser destructor runs, it&#39;ll go back to one and get deleted
5767     // when the class is unloaded.
5768     _class_name = SymbolTable::new_symbol(new_anon_name, symbol_len, CHECK);
5769   }
5770 }
5771 
5772 // If the host class and the anonymous class are in the same package then do
5773 // nothing.  If the anonymous class is in the unnamed package then move it to its
5774 // host&#39;s package.  If the classes are in different packages then throw an IAE
5775 // exception.
5776 void ClassFileParser::fix_unsafe_anonymous_class_name(TRAPS) {
5777   assert(_unsafe_anonymous_host != NULL, &quot;Expected an unsafe anonymous class&quot;);
5778 
5779   const jbyte* anon_last_slash = UTF8::strrchr((const jbyte*)_class_name-&gt;base(),
5780                                                _class_name-&gt;utf8_length(), &#39;/&#39;);
5781   if (anon_last_slash == NULL) {  // Unnamed package
5782     prepend_host_package_name(_unsafe_anonymous_host, CHECK);
5783   } else {
5784     if (!_unsafe_anonymous_host-&gt;is_same_class_package(_unsafe_anonymous_host-&gt;class_loader(), _class_name)) {
5785       ResourceMark rm(THREAD);
5786       THROW_MSG(vmSymbols::java_lang_IllegalArgumentException(),
5787         err_msg(&quot;Host class %s and anonymous class %s are in different packages&quot;,
5788         _unsafe_anonymous_host-&gt;name()-&gt;as_C_string(), _class_name-&gt;as_C_string()));
5789     }
5790   }
5791 }
5792 
5793 static bool relax_format_check_for(ClassLoaderData* loader_data) {
5794   bool trusted = (loader_data-&gt;is_the_null_class_loader_data() ||
5795                   SystemDictionary::is_platform_class_loader(loader_data-&gt;class_loader()));
5796   bool need_verify =
5797     // verifyAll
5798     (BytecodeVerificationLocal &amp;&amp; BytecodeVerificationRemote) ||
5799     // verifyRemote
5800     (!BytecodeVerificationLocal &amp;&amp; BytecodeVerificationRemote &amp;&amp; !trusted);
5801   return !need_verify;
5802 }
5803 
5804 ClassFileParser::ClassFileParser(ClassFileStream* stream,
5805                                  Symbol* name,
5806                                  ClassLoaderData* loader_data,
5807                                  Handle protection_domain,
5808                                  const InstanceKlass* unsafe_anonymous_host,
5809                                  GrowableArray&lt;Handle&gt;* cp_patches,
5810                                  Publicity pub_level,
5811                                  TRAPS) :
5812   _stream(stream),
5813   _requested_name(name),
5814   _class_name(NULL),
5815   _loader_data(loader_data),
5816   _unsafe_anonymous_host(unsafe_anonymous_host),
5817   _cp_patches(cp_patches),
5818   _num_patched_klasses(0),
5819   _max_num_patched_klasses(0),
5820   _orig_cp_size(0),
5821   _first_patched_klass_resolved_index(0),
5822   _super_klass(),
5823   _cp(NULL),
5824   _fields(NULL),
5825   _methods(NULL),
5826   _inner_classes(NULL),
5827   _nest_members(NULL),
5828   _nest_host(0),
5829   _local_interfaces(NULL),
5830   _transitive_interfaces(NULL),
5831   _combined_annotations(NULL),
5832   _annotations(NULL),
5833   _type_annotations(NULL),
5834   _fields_annotations(NULL),
5835   _fields_type_annotations(NULL),
5836   _klass(NULL),
5837   _klass_to_deallocate(NULL),
5838   _parsed_annotations(NULL),
5839   _fac(NULL),
5840   _field_info(NULL),
5841   _method_ordering(NULL),
5842   _all_mirandas(NULL),
5843   _vtable_size(0),
5844   _itable_size(0),
5845   _num_miranda_methods(0),
5846   _rt(REF_NONE),
5847   _protection_domain(protection_domain),
5848   _access_flags(),
5849   _pub_level(pub_level),
5850   _bad_constant_seen(0),
5851   _synthetic_flag(false),
5852   _sde_length(false),
5853   _sde_buffer(NULL),
5854   _sourcefile_index(0),
5855   _generic_signature_index(0),
5856   _major_version(0),
5857   _minor_version(0),
5858   _this_class_index(0),
5859   _super_class_index(0),
5860   _itfs_len(0),
5861   _java_fields_count(0),
5862   _need_verify(false),
5863   _relax_verify(false),
5864   _has_nonstatic_concrete_methods(false),
5865   _declares_nonstatic_concrete_methods(false),
5866   _has_final_method(false),
5867   _has_finalizer(false),
5868   _has_empty_finalizer(false),
5869   _has_vanilla_constructor(false),
5870   _max_bootstrap_specifier_index(-1) {
5871 
5872   _class_name = name != NULL ? name : vmSymbols::unknown_class_name();
5873   _class_name-&gt;increment_refcount();
5874 
5875   assert(THREAD-&gt;is_Java_thread(), &quot;invariant&quot;);
5876   assert(_loader_data != NULL, &quot;invariant&quot;);
5877   assert(stream != NULL, &quot;invariant&quot;);
5878   assert(_stream != NULL, &quot;invariant&quot;);
5879   assert(_stream-&gt;buffer() == _stream-&gt;current(), &quot;invariant&quot;);
5880   assert(_class_name != NULL, &quot;invariant&quot;);
5881   assert(0 == _access_flags.as_int(), &quot;invariant&quot;);
5882 
5883   // Figure out whether we can skip format checking (matching classic VM behavior)
5884   if (DumpSharedSpaces) {
5885     // verify == true means it&#39;s a &#39;remote&#39; class (i.e., non-boot class)
5886     // Verification decision is based on BytecodeVerificationRemote flag
5887     // for those classes.
5888     _need_verify = (stream-&gt;need_verify()) ? BytecodeVerificationRemote :
5889                                               BytecodeVerificationLocal;
5890   }
5891   else {
5892     _need_verify = Verifier::should_verify_for(_loader_data-&gt;class_loader(),
5893                                                stream-&gt;need_verify());
5894   }
5895   if (_cp_patches != NULL) {
5896     int len = _cp_patches-&gt;length();
5897     for (int i=0; i&lt;len; i++) {
5898       if (has_cp_patch_at(i)) {
5899         Handle patch = cp_patch_at(i);
5900         if (java_lang_String::is_instance(patch()) || java_lang_Class::is_instance(patch())) {
5901           // We need to append the names of the patched classes to the end of the constant pool,
5902           // because a patched class may have a Utf8 name that&#39;s not already included in the
5903           // original constant pool. These class names are used when patch_constant_pool()
5904           // calls patch_class().
5905           //
5906           // Note that a String in cp_patch_at(i) may be used to patch a Utf8, a String, or a Class.
5907           // At this point, we don&#39;t know the tag for index i yet, because we haven&#39;t parsed the
5908           // constant pool. So we can only assume the worst -- every String is used to patch a Class.
5909           _max_num_patched_klasses++;
5910         }
5911       }
5912     }
5913   }
5914 
5915   // synch back verification state to stream
5916   stream-&gt;set_verify(_need_verify);
5917 
5918   // Check if verification needs to be relaxed for this class file
5919   // Do not restrict it to jdk1.0 or jdk1.1 to maintain backward compatibility (4982376)
5920   _relax_verify = relax_format_check_for(_loader_data);
5921 
5922   parse_stream(stream, CHECK);
5923 
5924   post_process_parsed_stream(stream, _cp, CHECK);
5925 }
5926 
5927 void ClassFileParser::clear_class_metadata() {
5928   // metadata created before the instance klass is created.  Must be
5929   // deallocated if classfile parsing returns an error.
5930   _cp = NULL;
5931   _fields = NULL;
5932   _methods = NULL;
5933   _inner_classes = NULL;
5934   _nest_members = NULL;
5935   _local_interfaces = NULL;
5936   _combined_annotations = NULL;
5937   _annotations = _type_annotations = NULL;
5938   _fields_annotations = _fields_type_annotations = NULL;
5939 }
5940 
5941 // Destructor to clean up
5942 ClassFileParser::~ClassFileParser() {
5943   _class_name-&gt;decrement_refcount();
5944 
5945   if (_cp != NULL) {
5946     MetadataFactory::free_metadata(_loader_data, _cp);
5947   }
5948   if (_fields != NULL) {
5949     MetadataFactory::free_array&lt;u2&gt;(_loader_data, _fields);
5950   }
5951 
5952   if (_methods != NULL) {
5953     // Free methods
5954     InstanceKlass::deallocate_methods(_loader_data, _methods);
5955   }
5956 
5957   // beware of the Universe::empty_blah_array!!
5958   if (_inner_classes != NULL &amp;&amp; _inner_classes != Universe::the_empty_short_array()) {
5959     MetadataFactory::free_array&lt;u2&gt;(_loader_data, _inner_classes);
5960   }
5961 
5962   if (_nest_members != NULL &amp;&amp; _nest_members != Universe::the_empty_short_array()) {
5963     MetadataFactory::free_array&lt;u2&gt;(_loader_data, _nest_members);
5964   }
5965 
5966   // Free interfaces
5967   InstanceKlass::deallocate_interfaces(_loader_data, _super_klass,
5968                                        _local_interfaces, _transitive_interfaces);
5969 
5970   if (_combined_annotations != NULL) {
5971     // After all annotations arrays have been created, they are installed into the
5972     // Annotations object that will be assigned to the InstanceKlass being created.
5973 
5974     // Deallocate the Annotations object and the installed annotations arrays.
5975     _combined_annotations-&gt;deallocate_contents(_loader_data);
5976 
5977     // If the _combined_annotations pointer is non-NULL,
5978     // then the other annotations fields should have been cleared.
5979     assert(_annotations             == NULL, &quot;Should have been cleared&quot;);
5980     assert(_type_annotations        == NULL, &quot;Should have been cleared&quot;);
5981     assert(_fields_annotations      == NULL, &quot;Should have been cleared&quot;);
5982     assert(_fields_type_annotations == NULL, &quot;Should have been cleared&quot;);
5983   } else {
5984     // If the annotations arrays were not installed into the Annotations object,
5985     // then they have to be deallocated explicitly.
5986     MetadataFactory::free_array&lt;u1&gt;(_loader_data, _annotations);
5987     MetadataFactory::free_array&lt;u1&gt;(_loader_data, _type_annotations);
5988     Annotations::free_contents(_loader_data, _fields_annotations);
5989     Annotations::free_contents(_loader_data, _fields_type_annotations);
5990   }
5991 
5992   clear_class_metadata();
5993   _transitive_interfaces = NULL;
5994 
5995   // deallocate the klass if already created.  Don&#39;t directly deallocate, but add
5996   // to the deallocate list so that the klass is removed from the CLD::_klasses list
5997   // at a safepoint.
5998   if (_klass_to_deallocate != NULL) {
5999     _loader_data-&gt;add_to_deallocate_list(_klass_to_deallocate);
6000   }
6001 }
6002 
6003 void ClassFileParser::parse_stream(const ClassFileStream* const stream,
6004                                    TRAPS) {
6005 
6006   assert(stream != NULL, &quot;invariant&quot;);
6007   assert(_class_name != NULL, &quot;invariant&quot;);
6008 
6009   // BEGIN STREAM PARSING
6010   stream-&gt;guarantee_more(8, CHECK);  // magic, major, minor
6011   // Magic value
6012   const u4 magic = stream-&gt;get_u4_fast();
6013   guarantee_property(magic == JAVA_CLASSFILE_MAGIC,
6014                      &quot;Incompatible magic value %u in class file %s&quot;,
6015                      magic, CHECK);
6016 
6017   // Version numbers
6018   _minor_version = stream-&gt;get_u2_fast();
6019   _major_version = stream-&gt;get_u2_fast();
6020 
6021   if (DumpSharedSpaces &amp;&amp; _major_version &lt; JAVA_1_5_VERSION) {
6022     ResourceMark rm;
6023     warning(&quot;Pre JDK 1.5 class not supported by CDS: %u.%u %s&quot;,
6024             _major_version,  _minor_version, _class_name-&gt;as_C_string());
6025     Exceptions::fthrow(
6026       THREAD_AND_LOCATION,
6027       vmSymbols::java_lang_UnsupportedClassVersionError(),
6028       &quot;Unsupported major.minor version for dump time %u.%u&quot;,
6029       _major_version,
6030       _minor_version);
6031   }
6032 
6033   // Check version numbers - we check this even with verifier off
6034   verify_class_version(_major_version, _minor_version, _class_name, CHECK);
6035 
6036   stream-&gt;guarantee_more(3, CHECK); // length, first cp tag
6037   u2 cp_size = stream-&gt;get_u2_fast();
6038 
6039   guarantee_property(
6040     cp_size &gt;= 1, &quot;Illegal constant pool size %u in class file %s&quot;,
6041     cp_size, CHECK);
6042 
6043   _orig_cp_size = cp_size;
6044   if (int(cp_size) + _max_num_patched_klasses &gt; 0xffff) {
6045     THROW_MSG(vmSymbols::java_lang_InternalError(), &quot;not enough space for patched classes&quot;);
6046   }
6047   cp_size += _max_num_patched_klasses;
6048 
6049   _cp = ConstantPool::allocate(_loader_data,
6050                                cp_size,
6051                                CHECK);
6052 
6053   ConstantPool* const cp = _cp;
6054 
6055   parse_constant_pool(stream, cp, _orig_cp_size, CHECK);
6056 
6057   assert(cp_size == (const u2)cp-&gt;length(), &quot;invariant&quot;);
6058 
6059   // ACCESS FLAGS
6060   stream-&gt;guarantee_more(8, CHECK);  // flags, this_class, super_class, infs_len
6061 
6062   // Access flags
6063   jint flags;
6064   // JVM_ACC_MODULE is defined in JDK-9 and later.
6065   if (_major_version &gt;= JAVA_9_VERSION) {
6066     flags = stream-&gt;get_u2_fast() &amp; (JVM_RECOGNIZED_CLASS_MODIFIERS | JVM_ACC_MODULE);
6067   } else {
6068     flags = stream-&gt;get_u2_fast() &amp; JVM_RECOGNIZED_CLASS_MODIFIERS;
6069   }
6070 
6071   if ((flags &amp; JVM_ACC_INTERFACE) &amp;&amp; _major_version &lt; JAVA_6_VERSION) {
6072     // Set abstract bit for old class files for backward compatibility
6073     flags |= JVM_ACC_ABSTRACT;
6074   }
6075 
6076   verify_legal_class_modifiers(flags, CHECK);
6077 
6078   short bad_constant = class_bad_constant_seen();
6079   if (bad_constant != 0) {
6080     // Do not throw CFE until after the access_flags are checked because if
6081     // ACC_MODULE is set in the access flags, then NCDFE must be thrown, not CFE.
6082     classfile_parse_error(&quot;Unknown constant tag %u in class file %s&quot;, bad_constant, CHECK);
6083   }
6084 
6085   _access_flags.set_flags(flags);
6086 
6087   // This class and superclass
6088   _this_class_index = stream-&gt;get_u2_fast();
6089   check_property(
6090     valid_cp_range(_this_class_index, cp_size) &amp;&amp;
6091       cp-&gt;tag_at(_this_class_index).is_unresolved_klass(),
6092     &quot;Invalid this class index %u in constant pool in class file %s&quot;,
6093     _this_class_index, CHECK);
6094 
6095   Symbol* const class_name_in_cp = cp-&gt;klass_name_at(_this_class_index);
6096   assert(class_name_in_cp != NULL, &quot;class_name can&#39;t be null&quot;);
6097 
6098   // Update _class_name to reflect the name in the constant pool
6099   update_class_name(class_name_in_cp);
6100 
6101   // Don&#39;t need to check whether this class name is legal or not.
6102   // It has been checked when constant pool is parsed.
6103   // However, make sure it is not an array type.
6104   if (_need_verify) {
6105     guarantee_property(_class_name-&gt;char_at(0) != JVM_SIGNATURE_ARRAY,
6106                        &quot;Bad class name in class file %s&quot;,
6107                        CHECK);
6108   }
6109 
6110   // Checks if name in class file matches requested name
6111   if (_requested_name != NULL &amp;&amp; _requested_name != _class_name) {
6112     ResourceMark rm(THREAD);
6113     Exceptions::fthrow(
6114       THREAD_AND_LOCATION,
6115       vmSymbols::java_lang_NoClassDefFoundError(),
6116       &quot;%s (wrong name: %s)&quot;,
6117       _class_name-&gt;as_C_string(),
6118       _requested_name != NULL ? _requested_name-&gt;as_C_string() : &quot;NoName&quot;
6119     );
6120     return;
6121   }
6122 
6123   // if this is an anonymous class fix up its name if it&#39;s in the unnamed
6124   // package.  Otherwise, throw IAE if it is in a different package than
6125   // its host class.
6126   if (_unsafe_anonymous_host != NULL) {
6127     fix_unsafe_anonymous_class_name(CHECK);
6128   }
6129 
6130   // Verification prevents us from creating names with dots in them, this
6131   // asserts that that&#39;s the case.
6132   assert(is_internal_format(_class_name), &quot;external class name format used internally&quot;);
6133 
6134   if (!is_internal()) {
6135     LogTarget(Debug, class, preorder) lt;
6136     if (lt.is_enabled()){
6137       ResourceMark rm(THREAD);
6138       LogStream ls(lt);
6139       ls.print(&quot;%s&quot;, _class_name-&gt;as_klass_external_name());
6140       if (stream-&gt;source() != NULL) {
6141         ls.print(&quot; source: %s&quot;, stream-&gt;source());
6142       }
6143       ls.cr();
6144     }
6145 
6146 #if INCLUDE_CDS
6147     if (DumpLoadedClassList != NULL &amp;&amp; stream-&gt;source() != NULL &amp;&amp; classlist_file-&gt;is_open()) {
6148       if (!ClassLoader::has_jrt_entry()) {
6149         warning(&quot;DumpLoadedClassList and CDS are not supported in exploded build&quot;);
6150         DumpLoadedClassList = NULL;
6151       } else if (SystemDictionaryShared::is_sharing_possible(_loader_data) &amp;&amp;
6152                  _unsafe_anonymous_host == NULL) {
6153         // Only dump the classes that can be stored into CDS archive.
6154         // Unsafe anonymous classes such as generated LambdaForm classes are also not included.
6155         oop class_loader = _loader_data-&gt;class_loader();
6156         ResourceMark rm(THREAD);
6157         bool skip = false;
6158         if (class_loader == NULL || SystemDictionary::is_platform_class_loader(class_loader)) {
6159           // For the boot and platform class loaders, skip classes that are not found in the
6160           // java runtime image, such as those found in the --patch-module entries.
6161           // These classes can&#39;t be loaded from the archive during runtime.
6162           if (!ClassLoader::is_modules_image(stream-&gt;source()) &amp;&amp; strncmp(stream-&gt;source(), &quot;jrt:&quot;, 4) != 0) {
6163             skip = true;
6164           }
6165 
6166           if (class_loader == NULL &amp;&amp; ClassLoader::contains_append_entry(stream-&gt;source())) {
6167             // .. but don&#39;t skip the boot classes that are loaded from -Xbootclasspath/a
6168             // as they can be loaded from the archive during runtime.
6169             skip = false;
6170           }
6171         }
6172         if (skip) {
6173           tty-&gt;print_cr(&quot;skip writing class %s from source %s to classlist file&quot;,
6174             _class_name-&gt;as_C_string(), stream-&gt;source());
6175         } else {
6176           classlist_file-&gt;print_cr(&quot;%s&quot;, _class_name-&gt;as_C_string());
6177           classlist_file-&gt;flush();
6178         }
6179       }
6180     }
6181 #endif
6182   }
6183 
6184   // SUPERKLASS
6185   _super_class_index = stream-&gt;get_u2_fast();
6186   _super_klass = parse_super_class(cp,
6187                                    _super_class_index,
6188                                    _need_verify,
6189                                    CHECK);
6190 
6191   // Interfaces
6192   _itfs_len = stream-&gt;get_u2_fast();
6193   parse_interfaces(stream,
6194                    _itfs_len,
6195                    cp,
6196                    &amp;_has_nonstatic_concrete_methods,
6197                    CHECK);
6198 
6199   assert(_local_interfaces != NULL, &quot;invariant&quot;);
6200 
6201   // Fields (offsets are filled in later)
6202   _fac = new FieldAllocationCount();
6203   parse_fields(stream,
6204                _access_flags.is_interface(),
6205                _fac,
6206                cp,
6207                cp_size,
6208                &amp;_java_fields_count,
6209                CHECK);
6210 
6211   assert(_fields != NULL, &quot;invariant&quot;);
6212 
6213   // Methods
6214   AccessFlags promoted_flags;
6215   parse_methods(stream,
6216                 _access_flags.is_interface(),
6217                 &amp;promoted_flags,
6218                 &amp;_has_final_method,
6219                 &amp;_declares_nonstatic_concrete_methods,
6220                 CHECK);
6221 
6222   assert(_methods != NULL, &quot;invariant&quot;);
6223 
6224   // promote flags from parse_methods() to the klass&#39; flags
6225   _access_flags.add_promoted_flags(promoted_flags.as_int());
6226 
6227   if (_declares_nonstatic_concrete_methods) {
6228     _has_nonstatic_concrete_methods = true;
6229   }
6230 
6231   // Additional attributes/annotations
6232   _parsed_annotations = new ClassAnnotationCollector();
6233   parse_classfile_attributes(stream, cp, _parsed_annotations, CHECK);
6234 
6235   assert(_inner_classes != NULL, &quot;invariant&quot;);
6236 
6237   // Finalize the Annotations metadata object,
6238   // now that all annotation arrays have been created.
6239   create_combined_annotations(CHECK);
6240 
6241   // Make sure this is the end of class file stream
6242   guarantee_property(stream-&gt;at_eos(),
6243                      &quot;Extra bytes at the end of class file %s&quot;,
6244                      CHECK);
6245 
6246   // all bytes in stream read and parsed
6247 }
6248 
6249 void ClassFileParser::post_process_parsed_stream(const ClassFileStream* const stream,
6250                                                  ConstantPool* cp,
6251                                                  TRAPS) {
6252   assert(stream != NULL, &quot;invariant&quot;);
6253   assert(stream-&gt;at_eos(), &quot;invariant&quot;);
6254   assert(cp != NULL, &quot;invariant&quot;);
6255   assert(_loader_data != NULL, &quot;invariant&quot;);
6256 
6257   if (_class_name == vmSymbols::java_lang_Object()) {
6258     check_property(_local_interfaces == Universe::the_empty_instance_klass_array(),
6259                    &quot;java.lang.Object cannot implement an interface in class file %s&quot;,
6260                    CHECK);
6261   }
6262   // We check super class after class file is parsed and format is checked
6263   if (_super_class_index &gt; 0 &amp;&amp; NULL ==_super_klass) {
6264     Symbol* const super_class_name = cp-&gt;klass_name_at(_super_class_index);
6265     if (_access_flags.is_interface()) {
6266       // Before attempting to resolve the superclass, check for class format
6267       // errors not checked yet.
6268       guarantee_property(super_class_name == vmSymbols::java_lang_Object(),
6269         &quot;Interfaces must have java.lang.Object as superclass in class file %s&quot;,
6270         CHECK);
6271     }
6272     Handle loader(THREAD, _loader_data-&gt;class_loader());
6273     _super_klass = (const InstanceKlass*)
6274                        SystemDictionary::resolve_super_or_fail(_class_name,
6275                                                                super_class_name,
6276                                                                loader,
6277                                                                _protection_domain,
6278                                                                true,
6279                                                                CHECK);
6280   }
6281 
6282   if (_super_klass != NULL) {
6283     if (_super_klass-&gt;has_nonstatic_concrete_methods()) {
6284       _has_nonstatic_concrete_methods = true;
6285     }
6286 
6287     if (_super_klass-&gt;is_interface()) {
6288       ResourceMark rm(THREAD);
6289       Exceptions::fthrow(
6290         THREAD_AND_LOCATION,
6291         vmSymbols::java_lang_IncompatibleClassChangeError(),
6292         &quot;class %s has interface %s as super class&quot;,
6293         _class_name-&gt;as_klass_external_name(),
6294         _super_klass-&gt;external_name()
6295       );
6296       return;
6297     }
6298     // Make sure super class is not final
6299     if (_super_klass-&gt;is_final()) {
6300       THROW_MSG(vmSymbols::java_lang_VerifyError(), &quot;Cannot inherit from final class&quot;);
6301     }
6302   }
6303 
6304   // Compute the transitive list of all unique interfaces implemented by this class
6305   _transitive_interfaces =
6306     compute_transitive_interfaces(_super_klass,
6307                                   _local_interfaces,
6308                                   _loader_data,
6309                                   CHECK);
6310 
6311   assert(_transitive_interfaces != NULL, &quot;invariant&quot;);
6312 
6313   // sort methods
6314   _method_ordering = sort_methods(_methods);
6315 
6316   _all_mirandas = new GrowableArray&lt;Method*&gt;(20);
6317 
6318   Handle loader(THREAD, _loader_data-&gt;class_loader());
6319   klassVtable::compute_vtable_size_and_num_mirandas(&amp;_vtable_size,
6320                                                     &amp;_num_miranda_methods,
6321                                                     _all_mirandas,
6322                                                     _super_klass,
6323                                                     _methods,
6324                                                     _access_flags,
6325                                                     _major_version,
6326                                                     loader,
6327                                                     _class_name,
6328                                                     _local_interfaces,
6329                                                     CHECK);
6330 
6331   // Size of Java itable (in words)
6332   _itable_size = _access_flags.is_interface() ? 0 :
6333     klassItable::compute_itable_size(_transitive_interfaces);
6334 
6335   assert(_fac != NULL, &quot;invariant&quot;);
6336   assert(_parsed_annotations != NULL, &quot;invariant&quot;);
6337 
6338   _field_info = new FieldLayoutInfo();
6339   layout_fields(cp, _fac, _parsed_annotations, _field_info, CHECK);
6340 
6341   // Compute reference typ
6342   _rt = (NULL ==_super_klass) ? REF_NONE : _super_klass-&gt;reference_type();
6343 
6344 }
6345 
6346 void ClassFileParser::set_klass(InstanceKlass* klass) {
6347 
6348 #ifdef ASSERT
6349   if (klass != NULL) {
6350     assert(NULL == _klass, &quot;leaking?&quot;);
6351   }
6352 #endif
6353 
6354   _klass = klass;
6355 }
6356 
6357 void ClassFileParser::set_klass_to_deallocate(InstanceKlass* klass) {
6358 
6359 #ifdef ASSERT
6360   if (klass != NULL) {
6361     assert(NULL == _klass_to_deallocate, &quot;leaking?&quot;);
6362   }
6363 #endif
6364 
6365   _klass_to_deallocate = klass;
6366 }
6367 
6368 // Caller responsible for ResourceMark
6369 // clone stream with rewound position
6370 const ClassFileStream* ClassFileParser::clone_stream() const {
6371   assert(_stream != NULL, &quot;invariant&quot;);
6372 
6373   return _stream-&gt;clone();
6374 }
6375 // ----------------------------------------------------------------------------
6376 // debugging
6377 
6378 #ifdef ASSERT
6379 
6380 // return true if class_name contains no &#39;.&#39; (internal format is &#39;/&#39;)
6381 bool ClassFileParser::is_internal_format(Symbol* class_name) {
6382   if (class_name != NULL) {
6383     ResourceMark rm;
6384     char* name = class_name-&gt;as_C_string();
6385     return strchr(name, &#39;.&#39;) == NULL;
6386   } else {
6387     return true;
6388   }
6389 }
6390 
6391 #endif
    </pre>
  </body>
</html>