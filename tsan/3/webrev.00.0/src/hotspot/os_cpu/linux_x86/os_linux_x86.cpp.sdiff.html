<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/os_cpu/linux_x86/os_linux_x86.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="../../cpu/x86/templateTable_x86.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="../../share/classfile/classFileParser.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/os_cpu/linux_x86/os_linux_x86.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 1999, 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
</pre>
<hr />
<pre>
286 
287   // Note: it&#39;s not uncommon that JNI code uses signal/sigset to install
288   // then restore certain signal handler (e.g. to temporarily block SIGPIPE,
289   // or have a SIGILL handler when detecting CPU type). When that happens,
290   // JVM_handle_linux_signal() might be invoked with junk info/ucVoid. To
291   // avoid unnecessary crash when libjsig is not preloaded, try handle signals
292   // that do not require siginfo/ucontext first.
293 
294   if (sig == SIGPIPE || sig == SIGXFSZ) {
295     // allow chained handler to go first
296     if (os::Linux::chained_handler(sig, info, ucVoid)) {
297       return true;
298     } else {
299       // Ignoring SIGPIPE/SIGXFSZ - see bugs 4229104 or 6499219
300       return true;
301     }
302   }
303 
304 #ifdef CAN_SHOW_REGISTERS_ON_ASSERT
305   if ((sig == SIGSEGV || sig == SIGBUS) &amp;&amp; info != NULL &amp;&amp; info-&gt;si_addr == g_assert_poison) {
<span class="line-modified">306     handle_assert_poison_fault(ucVoid, info-&gt;si_addr);</span>
<span class="line-modified">307     return 1;</span>

308   }
309 #endif
310 
311   JavaThread* thread = NULL;
312   VMThread* vmthread = NULL;
313   if (os::Linux::signal_handlers_are_installed) {
314     if (t != NULL ){
315       if(t-&gt;is_Java_thread()) {
316         thread = (JavaThread*)t;
317       }
318       else if(t-&gt;is_VM_thread()){
319         vmthread = (VMThread *)t;
320       }
321     }
322   }
323 /*
324   NOTE: does not seem to work on linux.
325   if (info == NULL || info-&gt;si_code &lt;= 0 || info-&gt;si_code == SI_NOINFO) {
326     // can&#39;t decode this kind of signal
327     info = NULL;
</pre>
<hr />
<pre>
418       }
419     }
420 
421     if ((sig == SIGSEGV) &amp;&amp; VM_Version::is_cpuinfo_segv_addr(pc)) {
422       // Verify that OS save/restore AVX registers.
423       stub = VM_Version::cpuinfo_cont_addr();
424     }
425 
426     if (thread-&gt;thread_state() == _thread_in_Java) {
427       // Java thread running in Java code =&gt; find exception handler if any
428       // a fault inside compiled code, the interpreter, or a stub
429 
430       if (sig == SIGSEGV &amp;&amp; os::is_poll_address((address)info-&gt;si_addr)) {
431         stub = SharedRuntime::get_poll_stub(pc);
432       } else if (sig == SIGBUS /* &amp;&amp; info-&gt;si_code == BUS_OBJERR */) {
433         // BugId 4454115: A read from a MappedByteBuffer can fault
434         // here if the underlying file has been truncated.
435         // Do not crash the VM in such a case.
436         CodeBlob* cb = CodeCache::find_blob_unsafe(pc);
437         CompiledMethod* nm = (cb != NULL) ? cb-&gt;as_compiled_method_or_null() : NULL;
<span class="line-modified">438         if (nm != NULL &amp;&amp; nm-&gt;has_unsafe_access()) {</span>

439           address next_pc = Assembler::locate_next_instruction(pc);



440           stub = SharedRuntime::handle_unsafe_access(thread, next_pc);
441         }
442       }
443       else
444 
445 #ifdef AMD64
446       if (sig == SIGFPE  &amp;&amp;
447           (info-&gt;si_code == FPE_INTDIV || info-&gt;si_code == FPE_FLTDIV)) {
448         stub =
449           SharedRuntime::
450           continuation_for_implicit_exception(thread,
451                                               pc,
452                                               SharedRuntime::
453                                               IMPLICIT_DIVIDE_BY_ZERO);
454 #else
455       if (sig == SIGFPE /* &amp;&amp; info-&gt;si_code == FPE_INTDIV */) {
456         // HACK: si_code does not work on linux 2.2.12-20!!!
457         int op = pc[0];
458         if (op == 0xDB) {
459           // FIST
</pre>
<hr />
<pre>
466           // NOTE: that we take the exception at the NEXT floating point instruction.
467           assert(pc[0] == 0xDB, &quot;not a FIST opcode&quot;);
468           assert(pc[1] == 0x14, &quot;not a FIST opcode&quot;);
469           assert(pc[2] == 0x24, &quot;not a FIST opcode&quot;);
470           return true;
471         } else if (op == 0xF7) {
472           // IDIV
473           stub = SharedRuntime::continuation_for_implicit_exception(thread, pc, SharedRuntime::IMPLICIT_DIVIDE_BY_ZERO);
474         } else {
475           // TODO: handle more cases if we are using other x86 instructions
476           //   that can generate SIGFPE signal on linux.
477           tty-&gt;print_cr(&quot;unknown opcode 0x%X with SIGFPE.&quot;, op);
478           fatal(&quot;please update this code.&quot;);
479         }
480 #endif // AMD64
481       } else if (sig == SIGSEGV &amp;&amp;
482                  MacroAssembler::uses_implicit_null_check(info-&gt;si_addr)) {
483           // Determination of interpreter/vtable stub/compiled code null exception
484           stub = SharedRuntime::continuation_for_implicit_exception(thread, pc, SharedRuntime::IMPLICIT_NULL);
485       }
<span class="line-modified">486     } else if (thread-&gt;thread_state() == _thread_in_vm &amp;&amp;</span>
<span class="line-modified">487                sig == SIGBUS &amp;&amp; /* info-&gt;si_code == BUS_OBJERR &amp;&amp; */</span>
<span class="line-modified">488                thread-&gt;doing_unsafe_access()) {</span>

489         address next_pc = Assembler::locate_next_instruction(pc);



490         stub = SharedRuntime::handle_unsafe_access(thread, next_pc);
491     }
492 
493     // jni_fast_Get&lt;Primitive&gt;Field can trap at certain pc&#39;s if a GC kicks in
494     // and the heap gets shrunk before the field access.
495     if ((sig == SIGSEGV) || (sig == SIGBUS)) {
496       address addr = JNI_FastGetField::find_slowcase_pc(pc);
497       if (addr != (address)-1) {
498         stub = addr;
499       }
500     }
501   }
502 
503 #ifndef AMD64
504   // Execution protection violation
505   //
506   // This should be kept as the last step in the triage.  We don&#39;t
507   // have a dedicated trap number for a no-execute fault, so be
508   // conservative and allow other handlers the first shot.
509   //
</pre>
<hr />
<pre>
811                       : &quot;r&quot; (fpu_cntrl) : &quot;memory&quot;);
812 #endif // !AMD64
813 }
814 
815 #ifndef PRODUCT
816 void os::verify_stack_alignment() {
817 #ifdef AMD64
818   // TODO: TSAN requires being built with Clang, but stack alignment assertion fails with Clang.
819   // assert(((intptr_t)os::current_stack_pointer() &amp; (StackAlignmentInBytes-1)) == 0, &quot;incorrect stack alignment&quot;);
820 #endif
821 }
822 #endif
823 
824 
825 /*
826  * IA32 only: execute code at a high address in case buggy NX emulation is present. I.e. avoid CS limit
827  * updates (JDK-8023956).
828  */
829 void os::workaround_expand_exec_shield_cs_limit() {
830 #if defined(IA32)

831   size_t page_size = os::vm_page_size();
832 
833   /*
834    * JDK-8197429
835    *
836    * Expand the stack mapping to the end of the initial stack before
837    * attempting to install the codebuf.  This is needed because newer
838    * Linux kernels impose a distance of a megabyte between stack
839    * memory and other memory regions.  If we try to install the
840    * codebuf before expanding the stack the installation will appear
841    * to succeed but we&#39;ll get a segfault later if we expand the stack
842    * in Java code.
843    *
844    */
845   if (os::is_primordial_thread()) {
846     address limit = Linux::initial_thread_stack_bottom();
847     if (! DisablePrimordialThreadGuardPages) {
848       limit += JavaThread::stack_red_zone_size() +
849         JavaThread::stack_yellow_zone_size();
850     }
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 1999, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
</pre>
<hr />
<pre>
286 
287   // Note: it&#39;s not uncommon that JNI code uses signal/sigset to install
288   // then restore certain signal handler (e.g. to temporarily block SIGPIPE,
289   // or have a SIGILL handler when detecting CPU type). When that happens,
290   // JVM_handle_linux_signal() might be invoked with junk info/ucVoid. To
291   // avoid unnecessary crash when libjsig is not preloaded, try handle signals
292   // that do not require siginfo/ucontext first.
293 
294   if (sig == SIGPIPE || sig == SIGXFSZ) {
295     // allow chained handler to go first
296     if (os::Linux::chained_handler(sig, info, ucVoid)) {
297       return true;
298     } else {
299       // Ignoring SIGPIPE/SIGXFSZ - see bugs 4229104 or 6499219
300       return true;
301     }
302   }
303 
304 #ifdef CAN_SHOW_REGISTERS_ON_ASSERT
305   if ((sig == SIGSEGV || sig == SIGBUS) &amp;&amp; info != NULL &amp;&amp; info-&gt;si_addr == g_assert_poison) {
<span class="line-modified">306     if (handle_assert_poison_fault(ucVoid, info-&gt;si_addr)) {</span>
<span class="line-modified">307       return 1;</span>
<span class="line-added">308     }</span>
309   }
310 #endif
311 
312   JavaThread* thread = NULL;
313   VMThread* vmthread = NULL;
314   if (os::Linux::signal_handlers_are_installed) {
315     if (t != NULL ){
316       if(t-&gt;is_Java_thread()) {
317         thread = (JavaThread*)t;
318       }
319       else if(t-&gt;is_VM_thread()){
320         vmthread = (VMThread *)t;
321       }
322     }
323   }
324 /*
325   NOTE: does not seem to work on linux.
326   if (info == NULL || info-&gt;si_code &lt;= 0 || info-&gt;si_code == SI_NOINFO) {
327     // can&#39;t decode this kind of signal
328     info = NULL;
</pre>
<hr />
<pre>
419       }
420     }
421 
422     if ((sig == SIGSEGV) &amp;&amp; VM_Version::is_cpuinfo_segv_addr(pc)) {
423       // Verify that OS save/restore AVX registers.
424       stub = VM_Version::cpuinfo_cont_addr();
425     }
426 
427     if (thread-&gt;thread_state() == _thread_in_Java) {
428       // Java thread running in Java code =&gt; find exception handler if any
429       // a fault inside compiled code, the interpreter, or a stub
430 
431       if (sig == SIGSEGV &amp;&amp; os::is_poll_address((address)info-&gt;si_addr)) {
432         stub = SharedRuntime::get_poll_stub(pc);
433       } else if (sig == SIGBUS /* &amp;&amp; info-&gt;si_code == BUS_OBJERR */) {
434         // BugId 4454115: A read from a MappedByteBuffer can fault
435         // here if the underlying file has been truncated.
436         // Do not crash the VM in such a case.
437         CodeBlob* cb = CodeCache::find_blob_unsafe(pc);
438         CompiledMethod* nm = (cb != NULL) ? cb-&gt;as_compiled_method_or_null() : NULL;
<span class="line-modified">439         bool is_unsafe_arraycopy = thread-&gt;doing_unsafe_access() &amp;&amp; UnsafeCopyMemory::contains_pc(pc);</span>
<span class="line-added">440         if ((nm != NULL &amp;&amp; nm-&gt;has_unsafe_access()) || is_unsafe_arraycopy) {</span>
441           address next_pc = Assembler::locate_next_instruction(pc);
<span class="line-added">442           if (is_unsafe_arraycopy) {</span>
<span class="line-added">443             next_pc = UnsafeCopyMemory::page_error_continue_pc(pc);</span>
<span class="line-added">444           }</span>
445           stub = SharedRuntime::handle_unsafe_access(thread, next_pc);
446         }
447       }
448       else
449 
450 #ifdef AMD64
451       if (sig == SIGFPE  &amp;&amp;
452           (info-&gt;si_code == FPE_INTDIV || info-&gt;si_code == FPE_FLTDIV)) {
453         stub =
454           SharedRuntime::
455           continuation_for_implicit_exception(thread,
456                                               pc,
457                                               SharedRuntime::
458                                               IMPLICIT_DIVIDE_BY_ZERO);
459 #else
460       if (sig == SIGFPE /* &amp;&amp; info-&gt;si_code == FPE_INTDIV */) {
461         // HACK: si_code does not work on linux 2.2.12-20!!!
462         int op = pc[0];
463         if (op == 0xDB) {
464           // FIST
</pre>
<hr />
<pre>
471           // NOTE: that we take the exception at the NEXT floating point instruction.
472           assert(pc[0] == 0xDB, &quot;not a FIST opcode&quot;);
473           assert(pc[1] == 0x14, &quot;not a FIST opcode&quot;);
474           assert(pc[2] == 0x24, &quot;not a FIST opcode&quot;);
475           return true;
476         } else if (op == 0xF7) {
477           // IDIV
478           stub = SharedRuntime::continuation_for_implicit_exception(thread, pc, SharedRuntime::IMPLICIT_DIVIDE_BY_ZERO);
479         } else {
480           // TODO: handle more cases if we are using other x86 instructions
481           //   that can generate SIGFPE signal on linux.
482           tty-&gt;print_cr(&quot;unknown opcode 0x%X with SIGFPE.&quot;, op);
483           fatal(&quot;please update this code.&quot;);
484         }
485 #endif // AMD64
486       } else if (sig == SIGSEGV &amp;&amp;
487                  MacroAssembler::uses_implicit_null_check(info-&gt;si_addr)) {
488           // Determination of interpreter/vtable stub/compiled code null exception
489           stub = SharedRuntime::continuation_for_implicit_exception(thread, pc, SharedRuntime::IMPLICIT_NULL);
490       }
<span class="line-modified">491     } else if ((thread-&gt;thread_state() == _thread_in_vm ||</span>
<span class="line-modified">492                 thread-&gt;thread_state() == _thread_in_native) &amp;&amp;</span>
<span class="line-modified">493                (sig == SIGBUS &amp;&amp; /* info-&gt;si_code == BUS_OBJERR &amp;&amp; */</span>
<span class="line-added">494                thread-&gt;doing_unsafe_access())) {</span>
495         address next_pc = Assembler::locate_next_instruction(pc);
<span class="line-added">496         if (UnsafeCopyMemory::contains_pc(pc)) {</span>
<span class="line-added">497           next_pc = UnsafeCopyMemory::page_error_continue_pc(pc);</span>
<span class="line-added">498         }</span>
499         stub = SharedRuntime::handle_unsafe_access(thread, next_pc);
500     }
501 
502     // jni_fast_Get&lt;Primitive&gt;Field can trap at certain pc&#39;s if a GC kicks in
503     // and the heap gets shrunk before the field access.
504     if ((sig == SIGSEGV) || (sig == SIGBUS)) {
505       address addr = JNI_FastGetField::find_slowcase_pc(pc);
506       if (addr != (address)-1) {
507         stub = addr;
508       }
509     }
510   }
511 
512 #ifndef AMD64
513   // Execution protection violation
514   //
515   // This should be kept as the last step in the triage.  We don&#39;t
516   // have a dedicated trap number for a no-execute fault, so be
517   // conservative and allow other handlers the first shot.
518   //
</pre>
<hr />
<pre>
820                       : &quot;r&quot; (fpu_cntrl) : &quot;memory&quot;);
821 #endif // !AMD64
822 }
823 
824 #ifndef PRODUCT
825 void os::verify_stack_alignment() {
826 #ifdef AMD64
827   // TODO: TSAN requires being built with Clang, but stack alignment assertion fails with Clang.
828   // assert(((intptr_t)os::current_stack_pointer() &amp; (StackAlignmentInBytes-1)) == 0, &quot;incorrect stack alignment&quot;);
829 #endif
830 }
831 #endif
832 
833 
834 /*
835  * IA32 only: execute code at a high address in case buggy NX emulation is present. I.e. avoid CS limit
836  * updates (JDK-8023956).
837  */
838 void os::workaround_expand_exec_shield_cs_limit() {
839 #if defined(IA32)
<span class="line-added">840   assert(Linux::initial_thread_stack_bottom() != NULL, &quot;sanity&quot;);</span>
841   size_t page_size = os::vm_page_size();
842 
843   /*
844    * JDK-8197429
845    *
846    * Expand the stack mapping to the end of the initial stack before
847    * attempting to install the codebuf.  This is needed because newer
848    * Linux kernels impose a distance of a megabyte between stack
849    * memory and other memory regions.  If we try to install the
850    * codebuf before expanding the stack the installation will appear
851    * to succeed but we&#39;ll get a segfault later if we expand the stack
852    * in Java code.
853    *
854    */
855   if (os::is_primordial_thread()) {
856     address limit = Linux::initial_thread_stack_bottom();
857     if (! DisablePrimordialThreadGuardPages) {
858       limit += JavaThread::stack_red_zone_size() +
859         JavaThread::stack_yellow_zone_size();
860     }
</pre>
</td>
</tr>
</table>
<center><a href="../../cpu/x86/templateTable_x86.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="../../share/classfile/classFileParser.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>