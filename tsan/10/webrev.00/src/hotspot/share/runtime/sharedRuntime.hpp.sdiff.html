<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/share/runtime/sharedRuntime.hpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>src/hotspot/share/runtime/sharedRuntime.hpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 1997, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
</pre>
<hr />
<pre>
288   // than TSAN&#39;s own symbolizer. See __sanitizer::kExternalPCBit and
289   // __tsan::__tsan_symbolize_external_ex() in TSAN for more details.
290   // The lower 60 bits may contain either a packed bytecode location, or an
291   // instruction address inside the code generated by JIT compiler.
292   // A packed code location has the method ID in bits 59:16 and the bytecode
293   //offset within method in bits 15:0. 44 bits (59:16) are enough to encode any
294   // 47-bit 8-byte-aligned address, which is the maximum address space TSAN
295   // allows. The next 16 bits are used for storing the bci.
296   // | Tsan: 3 | TsanJava: 1 | jmethodID: 44 | BCI: 16 |
297   static const int tsan_method_id_alignment_bits = 3;
298   static const int tsan_bci_bits = 16;
299   static const u8 tsan_bci_mask = right_n_bits(tsan_bci_bits);
300   static const int tsan_method_id_shift = tsan_bci_bits -
301       tsan_method_id_alignment_bits;
302   static const u8 tsan_fake_pc_bit = 1L &lt;&lt; 60;
303   static void * tsan_code_location(jmethodID jmethod_id_ptr, u2 bci) {
304     return (void *)(tsan_fake_pc_bit |
305       (((u8)(jmethod_id_ptr)) &lt;&lt; tsan_method_id_shift) | bci);
306   }
307   static jmethodID tsan_method_id_from_code_location(u8 loc) {
<span class="line-modified">308     return (jmethodID)(</span>
<span class="line-modified">309         (loc &amp; ~(tsan_fake_pc_bit | tsan_bci_mask)) &gt;&gt; tsan_method_id_shift);</span>














310   }
311   static u2 tsan_bci_from_code_location(u8 loc) {
312     return (u2)(loc &amp; tsan_bci_mask);
313   }
314 
315   // These functions are wrappers around TSAN callbacks,
316   // which are listed in tsanExternalDecls.hpp. The VM uses only these
317   // functions to push events to ThreadSanitizer.
318 
319   // Verify that an oop is valid and that the index is within the object size.
320   static void verify_oop_index(oopDesc* obj, int index);
321 
322   // Java method entry/exit from code run by template interpreter
323   static void tsan_interp_method_entry(JavaThread *thread);
324   static void tsan_interp_method_exit();
325 
326   // Monitor acquire/release in VM code
327   // (e.g., generated native method wrapper, JNI heavyweight locks)
328   static void tsan_oop_lock(Thread* thread, oop obj);
329   static void tsan_oop_unlock(Thread* thread, oop obj);
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 1997, 2020, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
</pre>
<hr />
<pre>
288   // than TSAN&#39;s own symbolizer. See __sanitizer::kExternalPCBit and
289   // __tsan::__tsan_symbolize_external_ex() in TSAN for more details.
290   // The lower 60 bits may contain either a packed bytecode location, or an
291   // instruction address inside the code generated by JIT compiler.
292   // A packed code location has the method ID in bits 59:16 and the bytecode
293   //offset within method in bits 15:0. 44 bits (59:16) are enough to encode any
294   // 47-bit 8-byte-aligned address, which is the maximum address space TSAN
295   // allows. The next 16 bits are used for storing the bci.
296   // | Tsan: 3 | TsanJava: 1 | jmethodID: 44 | BCI: 16 |
297   static const int tsan_method_id_alignment_bits = 3;
298   static const int tsan_bci_bits = 16;
299   static const u8 tsan_bci_mask = right_n_bits(tsan_bci_bits);
300   static const int tsan_method_id_shift = tsan_bci_bits -
301       tsan_method_id_alignment_bits;
302   static const u8 tsan_fake_pc_bit = 1L &lt;&lt; 60;
303   static void * tsan_code_location(jmethodID jmethod_id_ptr, u2 bci) {
304     return (void *)(tsan_fake_pc_bit |
305       (((u8)(jmethod_id_ptr)) &lt;&lt; tsan_method_id_shift) | bci);
306   }
307   static jmethodID tsan_method_id_from_code_location(u8 loc) {
<span class="line-modified">308     u8 id =</span>
<span class="line-modified">309         (loc &amp; ~(tsan_fake_pc_bit | tsan_bci_mask)) &gt;&gt; tsan_method_id_shift;</span>
<span class="line-added">310 </span>
<span class="line-added">311     // Typical method ID in aarch64 is like 0xffff_xxxx_xxxx_xxxx, which couldn&#39;t be represented by 47-bits.</span>
<span class="line-added">312     // But there are only 3 application memory regions in tsan for 48bits aarch64, the highest 4 bits</span>
<span class="line-added">313     // of addresses are 0x0, 0xa and 0xf respectively. The encoding function tsan_code_location() will</span>
<span class="line-added">314     // overwrite bit 47 for internal purpose, Therefore, we restore bit 47 here according to</span>
<span class="line-added">315     // the value of bits 46:44. if it is 0x2 or 0x7, restore bit 47 to 1.</span>
<span class="line-added">316 #ifdef AARCH64</span>
<span class="line-added">317     u8 highest4bits = id &gt;&gt; 44;</span>
<span class="line-added">318     if (highest4bits == 0x7ULL || highest4bits == 0x2ULL) {</span>
<span class="line-added">319       id |= (0x1ULL &lt;&lt; 47);</span>
<span class="line-added">320     }</span>
<span class="line-added">321 #endif</span>
<span class="line-added">322 </span>
<span class="line-added">323     return (jmethodID)id;</span>
324   }
325   static u2 tsan_bci_from_code_location(u8 loc) {
326     return (u2)(loc &amp; tsan_bci_mask);
327   }
328 
329   // These functions are wrappers around TSAN callbacks,
330   // which are listed in tsanExternalDecls.hpp. The VM uses only these
331   // functions to push events to ThreadSanitizer.
332 
333   // Verify that an oop is valid and that the index is within the object size.
334   static void verify_oop_index(oopDesc* obj, int index);
335 
336   // Java method entry/exit from code run by template interpreter
337   static void tsan_interp_method_entry(JavaThread *thread);
338   static void tsan_interp_method_exit();
339 
340   // Monitor acquire/release in VM code
341   // (e.g., generated native method wrapper, JNI heavyweight locks)
342   static void tsan_oop_lock(Thread* thread, oop obj);
343   static void tsan_oop_unlock(Thread* thread, oop obj);
</pre>
</td>
</tr>
</table>
<center>&lt; prev <a href="../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>