<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/jdk/sun/security/tools/keytool/KeyToolTest.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 2005, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 
  24 /*
  25  * @test
  26  * @bug 6251120 8231950 8242151
  27  * @summary Testing keytool
  28  *
  29  * Run through autotest.sh and manualtest.sh
  30  *
  31  * Testing non-PKCS11 keystores:
  32  *       echo | java -Dfile KeyToolTest
  33  *
  34  * Testing NSS PKCS11 keystores:
  35  *       # testing NSS
  36  *       # make sure the NSS db files are in current directory and writable
  37  *       echo | java -Dnss -Dnss.lib=/path/to/libsoftokn3.so KeyToolTest
  38  *
<a name="1" id="anc1"></a>



  39  * ATTENTION:
  40  * Exception in thread &quot;main&quot; java.security.ProviderException:
  41  *   sun.security.pkcs11.wrapper.PKCS11Exception: CKR_KEY_SIZE_RANGE
  42  *       at sun.security.pkcs11.P11Signature.engineSign(P11Signature.java:420)
  43  *       ...
  44  * Caused by: sun.security.pkcs11.wrapper.PKCS11Exception: CKR_KEY_SIZE_RANGE
  45  *       at sun.security.pkcs11.wrapper.PKCS11.C_SignFinal(Native Method)
  46  *       at sun.security.pkcs11.P11Signature.engineSign(P11Signature.java:391)
  47  *       ...
  48  * been observed. Possibly a Solaris bug
  49  *
  50  * ATTENTION:
  51  * NSS PKCS11 config file are changed, DSA not supported now.
  52  *
  53  * @library /test/lib
  54  * @modules java.base/sun.security.tools.keytool
  55  *          java.base/sun.security.util
  56  *          java.base/sun.security.x509
  57  * @run main/othervm/timeout=600 -Dfile KeyToolTest
  58  */
  59 
  60 import java.nio.file.Files;
  61 import java.nio.file.Paths;
  62 import java.security.KeyStore;
  63 import sun.security.x509.*;
  64 import java.io.*;
  65 import java.security.KeyPairGenerator;
  66 import java.security.NoSuchAlgorithmException;
  67 import java.util.*;
  68 import java.security.cert.X509Certificate;
  69 import jdk.test.lib.util.FileUtils;
  70 import sun.security.util.ObjectIdentifier;
  71 
  72 
  73 public class KeyToolTest {
  74 
  75     // The stdout and stderr outputs after a keytool run
  76     String out;
  77     String err;
  78 
  79     // the output of println() in KeyTool.run
  80     String ex;
  81 
  82     String lastInput = &quot;&quot;, lastCommand = &quot;&quot;;
  83     private static final boolean debug =
  84         System.getProperty(&quot;debug&quot;) != null;
  85 
  86     static final String NSS_P11_ARG =
  87             &quot;-keystore NONE -storetype PKCS11 -providerName SunPKCS11-nss &quot; +
  88             &quot;-addprovider SunPKCS11 &quot; +
  89             &quot;-providerArg p11-nss.txt &quot;;
  90     // Use -providerClass here, to confirm it still works for SunPKCS11.
  91     static final String NSS_SRC_P11_ARG =
  92             &quot;-srckeystore NONE -srcstoretype PKCS11 &quot; +
  93             &quot;-srcproviderName SunPKCS11-nss &quot; +
  94             &quot;-providerClass sun.security.pkcs11.SunPKCS11 &quot; +
  95             &quot;-providerArg p11-nss.txt &quot;;
  96     static final String NZZ_P11_ARG =
  97             &quot;-keystore NONE -storetype PKCS11 -providerName SunPKCS11-nzz &quot; +
  98             &quot;-addprovider SunPKCS11 &quot; +
  99             &quot;-providerArg p11-nzz.txt &quot;;
 100     static final String NZZ_SRC_P11_ARG =
 101             &quot;-srckeystore NONE -srcstoretype PKCS11 &quot; +
 102             &quot;-srcproviderName SunPKCS11-nzz &quot; +
 103             &quot;-addprovider SunPKCS11 &quot; +
 104             &quot;-providerArg p11-nzz.txt &quot;;
<a name="2" id="anc2"></a>


 105 
 106     String p11Arg, srcP11Arg;
 107 
 108     /** Creates a new instance of KeyToolTest */
 109     KeyToolTest() {
 110         // so that there is &quot;Warning&quot; and not translated into other language
 111         Locale.setDefault(Locale.US);
 112     }
 113 
 114     /**
 115      * Helper, removes a file
 116      */
 117     void remove(String filename) {
 118         if (debug) {
 119             System.err.println(&quot;Removing &quot; + filename);
 120         }
 121         try{
 122             FileUtils.deleteFileIfExistsWithRetry(Paths.get(filename));
 123         }catch(IOException e) {
 124             throw new RuntimeException(&quot;Error deleting &quot; + filename, e);
 125         }
 126     }
 127 
 128     /**
 129      * Run a set of keytool command with given terminal input.
 130      * @param input the terminal inputs, the characters typed by human
 131      *        if &lt;code&gt;cmd&lt;/code&gt; is running on a terminal
 132      * @param cmd the argument of a keytool command line
 133      * @throws if keytool goes wrong in some place
 134      */
 135     void test(String input, String cmd) throws Exception {
 136         lastInput = input;
 137         lastCommand = cmd;
 138 
 139         // &quot;X&quot; is appended so that we can precisely test how input is consumed
 140         HumanInputStream in = new HumanInputStream(input+&quot;X&quot;);
 141         test(in, cmd);
 142         // make sure the input string is no more no less
 143         if(in.read() != &#39;X&#39; || in.read() != -1)
 144             throw new Exception(&quot;Input not consumed exactly&quot;);
 145     }
 146 
 147     void test(InputStream in, String cmd) throws Exception {
 148 
 149         // save the original 3 streams
 150         if (debug) {
 151             System.err.println(cmd);
 152         } else {
 153             System.err.print(&quot;.&quot;);
 154         }
 155         PrintStream p1 = System.out;
 156         PrintStream p2 = System.err;
 157         InputStream i1 = System.in;
 158 
 159         ByteArrayOutputStream b1 = new ByteArrayOutputStream();
 160         ByteArrayOutputStream b2 = new ByteArrayOutputStream();
 161 
 162         try {
 163             System.setIn(in);
 164             System.setOut(new PrintStream(b1));
 165             System.setErr(new PrintStream(b2));
 166 
 167             // since System.in is overrided, the
 168             // sun.security.tools.keytool.Main.main() method will
 169             // never block at user input
 170 
 171             // use -debug so that main() will throw an Exception
 172             // instead of calling System.exit()
 173             sun.security.tools.keytool.Main.main((&quot;-debug &quot;+cmd).split(&quot;\\s+&quot;));
 174         } finally {
 175             out = b1.toString();
 176             err = b2.toString();
 177             ex = out;   // now it goes to System.out
 178             System.setIn(i1);
 179             System.setOut(p1);
 180             System.setErr(p2);
 181         }
 182     }
 183 
 184     /**
 185      * Call this method if you expect test(input, cmd) should go OK
 186      */
 187     void testOK(String input, String cmd) throws Exception {
 188         try {
 189             // Workaround for &quot;8057810: Make SHA256withDSA the default
 190             // jarsigner and keytool algorithm for DSA keys&quot;. Unfortunately
 191             // SunPKCS11-NSS does not support SHA256withDSA yet.
 192             if (cmd.contains(&quot;p11-nss.txt&quot;) &amp;&amp; cmd.contains(&quot;-genkey&quot;)
 193                     &amp;&amp; cmd.contains(&quot;DSA&quot;)) {
 194                 cmd += &quot; -sigalg SHA1withDSA -keysize 1024&quot;;
 195             }
 196             test(input, cmd);
 197         } catch(Exception e) {
 198             afterFail(input, cmd, &quot;OK&quot;);
 199             throw e;
 200         }
 201     }
 202 
 203     /**
 204      * Call this method if you expect test(input, cmd) should fail and throw
 205      * an exception
 206      */
 207     void testFail(String input, String cmd) throws Exception {
 208         boolean ok;
 209         try {
 210             test(input, cmd);
 211             ok = true;
 212         } catch(Exception e) {
 213             if (e instanceof MissingResourceException) {
 214                 ok = true;
 215             } else {
 216                 ok = false;
 217             }
 218         }
 219         if(ok) {
 220             afterFail(input, cmd, &quot;FAIL&quot;);
 221             throw new RuntimeException();
 222         }
 223     }
 224 
 225     /**
 226      * Call this method if you expect test(input, cmd) should go OK
 227      */
 228     void testOK(InputStream is, String cmd) throws Exception {
 229         try {
 230             test(is, cmd);
 231         } catch(Exception e) {
 232             afterFail(&quot;&quot;, cmd, &quot;OK&quot;);
 233             throw e;
 234         }
 235     }
 236 
 237     /**
 238      * Call this method if you expect test(input, cmd) should fail and throw
 239      * an exception
 240      */
 241     void testFail(InputStream is, String cmd) throws Exception {
 242         boolean ok;
 243         try {
 244             test(is, cmd);
 245             ok = true;
 246         } catch(Exception e) {
 247             ok = false;
 248         }
 249         if(ok) {
 250             afterFail(&quot;&quot;, cmd, &quot;FAIL&quot;);
 251             throw new RuntimeException();
 252         }
 253     }
 254 
 255     /**
 256      * Call this method if you just want to run the command and does
 257      * not care if it succeeds or fails.
 258      */
 259     void testAnyway(String input, String cmd) {
 260         try {
 261             test(input, cmd);
 262         } catch(Exception e) {
 263             ;
 264         }
 265     }
 266 
 267     /**
 268      * Helper method, print some output after a test does not do as expected
 269      */
 270     void afterFail(String input, String cmd, String should) {
 271         if (cmd.contains(&quot;p11-nss.txt&quot;)) {
 272             cmd = &quot;-J-Dnss.lib=&quot; + System.getProperty(&quot;nss.lib&quot;) + &quot; &quot; + cmd;
 273         }
 274         System.err.println(&quot;\nTest fails for the command ---\n&quot; +
 275                 &quot;keytool &quot; + cmd + &quot;\nOr its debug version ---\n&quot; +
 276                 &quot;keytool -debug &quot; + cmd);
 277 
 278         System.err.println(&quot;The command result should be &quot; + should +
 279                 &quot;, but it&#39;s not. Try run the command manually and type&quot; +
 280                 &quot; these input into it: &quot;);
 281         char[] inputChars = input.toCharArray();
 282 
 283         for (int i=0; i&lt;inputChars.length; i++) {
 284             char ch = inputChars[i];
 285             if (ch == &#39;\n&#39;) System.err.print(&quot;ENTER &quot;);
 286             else if (ch == &#39; &#39;) System.err.print(&quot;SPACE &quot;);
 287             else System.err.print(ch + &quot; &quot;);
 288         }
 289         System.err.println(&quot;&quot;);
 290 
 291         System.err.println(&quot;ERR is:\n&quot;+err);
 292         System.err.println(&quot;OUT is:\n&quot;+out);
 293     }
 294 
 295     void assertTrue(boolean bool, String msg) {
 296         if (debug) {
 297             System.err.println(&quot;If not &quot; + bool + &quot;, &quot; + msg);
 298         } else {
 299             System.err.print(&quot;v&quot;);
 300         }
 301         if(!bool) {
 302             afterFail(lastInput, lastCommand, &quot;TRUE&quot;);
 303                 System.err.println(msg);
 304             throw new RuntimeException(msg);
 305         }
 306     }
 307 
 308     void assertTrue(boolean bool) {
 309         assertTrue(bool, &quot;well...&quot;);
 310     }
 311     /**
 312      * Helper method, load a keystore
 313      * @param file file for keystore, null or &quot;NONE&quot; for PKCS11
 314      * @pass password for the keystore
 315      * @type keystore type
 316      * @returns the KeyStore object
 317      * @exception Exception if anything goes wrong
 318      */
 319     KeyStore loadStore(String file, String pass, String type) throws Exception {
 320         KeyStore ks = KeyStore.getInstance(type);
 321         FileInputStream is = null;
 322         if (file != null &amp;&amp; !file.equals(&quot;NONE&quot;)) {
 323             is = new FileInputStream(file);
 324         }
 325         ks.load(is, pass.toCharArray());
 326         is.close();
 327         return ks;
 328     }
 329 
 330     /**
 331      * The test suite.
 332      * Maybe it&#39;s better to put this outside the KeyToolTest class
 333      */
 334     void testAll() throws Exception {
 335         KeyStore ks;
 336 
 337         remove(&quot;x.jks&quot;);
 338         remove(&quot;x.jceks&quot;);
 339         remove(&quot;x.p12&quot;);
 340         remove(&quot;x2.jceks&quot;);
 341         remove(&quot;x2.jks&quot;);
 342         remove(&quot;x.jks.p1.cert&quot;);
 343 
 344         // name changes: genkeypair, importcert, exportcert
 345         remove(&quot;x.jks&quot;);
 346         remove(&quot;x.jks.p1.cert&quot;);
 347         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 348                 &quot;-keypass changeit -genkeypair -keyalg DSA -alias p1 -dname CN=olala&quot;);
 349         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 350                 &quot;-exportcert -alias p1 -file x.jks.p1.cert&quot;);
 351         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 352         assertTrue(ks.getKey(&quot;p1&quot;, &quot;changeit&quot;.toCharArray()) != null,
 353             &quot;key not DSA&quot;);
 354         assertTrue(new File(&quot;x.jks.p1.cert&quot;).exists(), &quot;p1 export err&quot;);
 355         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 356                 &quot;-delete -alias p1&quot;);
 357         // importcert, prompt for Yes/No
 358         testOK(&quot;y\n&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 359                 &quot;-importcert -alias c1 -file x.jks.p1.cert&quot;);
 360         // importcert, -noprompt
 361         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 362                 &quot;-importcert -alias c2 -file x.jks.p1.cert -noprompt&quot;);
 363         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 364         assertTrue(ks.getCertificate(&quot;c1&quot;) != null, &quot;import c1 err&quot;);
 365 
 366         // v3
 367         byte[] encoded = ks.getCertificate(&quot;c1&quot;).getEncoded();
 368         X509CertImpl certImpl = new X509CertImpl(encoded);
 369         assertTrue(certImpl.getVersion() == 3, &quot;Version is not 3&quot;);
 370 
 371         // changealias and keyclone
 372         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 373                 &quot;-keypass changeit -genkeypair -keyalg DSA -alias p1 -dname CN=olala&quot;);
 374         testOK(&quot;changeit\n&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 375                 &quot;-changealias -alias p1 -destalias p11&quot;);
 376         testOK(&quot;changeit\n&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 377                 &quot;-changealias -alias c1 -destalias c11&quot;);
 378         // press ENTER when prompt for p111&#39;s keypass
 379         testOK(&quot;changeit\n\n&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 380                 &quot;-keyclone -alias p11 -destalias p111&quot;);
 381         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 382         assertTrue(!ks.containsAlias(&quot;p1&quot;), &quot;there is no p1&quot;);
 383         assertTrue(!ks.containsAlias(&quot;c1&quot;), &quot;there is no c1&quot;);
 384         assertTrue(ks.containsAlias(&quot;p11&quot;), &quot;there is p11&quot;);
 385         assertTrue(ks.containsAlias(&quot;c11&quot;), &quot;there is c11&quot;);
 386         assertTrue(ks.containsAlias(&quot;p111&quot;), &quot;there is p111&quot;);
 387 
 388         // genSecKey
 389         remove(&quot;x.jceks&quot;);
 390         // DES, no need keysize
 391         testOK(&quot;changeit\nchangeit\n\n&quot;, &quot;-keystore x.jceks -storetype JCEKS &quot; +
 392                 &quot;-genseckey -keyalg DES -alias s1&quot;);
 393         // DES, keysize cannot be 128
 394         testFail(&quot;changeit\n\n&quot;, &quot;-keystore x.jceks -storetype JCEKS &quot; +
 395                 &quot;-genseckey -keyalg DES -alias s11 -keysize 128&quot;);
 396         // DESede. no need keysize
 397         testOK(&quot;changeit\n\n&quot;, &quot;-keystore x.jceks -storetype JCEKS &quot; +
 398                 &quot;-genseckey -keyalg DESede -alias s2&quot;);
 399         // AES, need keysize
 400         testFail(&quot;changeit\n\n&quot;, &quot;-keystore x.jceks -storetype AES &quot; +
 401                 &quot;-genseckey -keyalg Rijndael -alias s3&quot;);
 402         testOK(&quot;changeit\n\n&quot;, &quot;-keystore x.jceks -storetype JCEKS &quot; +
 403                 &quot;-genseckey -keyalg AES -alias s3 -keysize 128&quot;);
 404         // about keypass
 405         // can accept storepass
 406         testOK(&quot;\n&quot;, &quot;-keystore x.jceks -storetype JCEKS -storepass changeit &quot; +
 407                 &quot;-genseckey -keyalg DES -alias s4&quot;);
 408         // or a new one
 409         testOK(&quot;keypass\nkeypass\n&quot;, &quot;-keystore x.jceks -storetype JCEKS &quot; +
 410                 &quot;-storepass changeit -genseckey -keyalg DES -alias s5&quot;);
 411         // keypass must be valid (prompt 3 times)
 412         testOK(&quot;bad\n\bad\nkeypass\nkeypass\n&quot;, &quot;-keystore x.jceks &quot; +
 413                 &quot;-storetype JCEKS -storepass changeit -genseckey &quot; +
 414                 &quot;-keyalg DES -alias s6&quot;);
 415         // keypass must be valid (prompt 3 times)
 416         testFail(&quot;bad\n\bad\nbad\n&quot;, &quot;-keystore x.jceks -storetype JCEKS &quot; +
 417                 &quot;-storepass changeit -genseckey -keyalg DES -alias s7&quot;);
 418         // keypass must be valid (prompt 3 times)
 419         testFail(&quot;bad\n\bad\nbad\nkeypass\n&quot;, &quot;-keystore x.jceks &quot; +
 420                 &quot;-storetype JCEKS -storepass changeit -genseckey -keyalg DES -alias s7&quot;);
 421         ks = loadStore(&quot;x.jceks&quot;, &quot;changeit&quot;, &quot;JCEKS&quot;);
 422         assertTrue(ks.getKey(&quot;s1&quot;, &quot;changeit&quot;.toCharArray())
 423                 .getAlgorithm().equalsIgnoreCase(&quot;DES&quot;), &quot;s1 is DES&quot;);
 424         assertTrue(ks.getKey(&quot;s1&quot;, &quot;changeit&quot;.toCharArray())
 425                 .getEncoded().length == 8,  &quot;DES is 56&quot;);
 426         assertTrue(ks.getKey(&quot;s2&quot;, &quot;changeit&quot;.toCharArray())
 427                 .getEncoded().length == 24,  &quot;DESede is 168&quot;);
 428         assertTrue(ks.getKey(&quot;s2&quot;, &quot;changeit&quot;.toCharArray())
 429                 .getAlgorithm().equalsIgnoreCase(&quot;DESede&quot;), &quot;s2 is DESede&quot;);
 430         assertTrue(ks.getKey(&quot;s3&quot;, &quot;changeit&quot;.toCharArray())
 431                 .getAlgorithm().equalsIgnoreCase(&quot;AES&quot;), &quot;s3 is AES&quot;);
 432         assertTrue(ks.getKey(&quot;s4&quot;, &quot;changeit&quot;.toCharArray())
 433                 .getAlgorithm().equalsIgnoreCase(&quot;DES&quot;), &quot;s4 is DES&quot;);
 434         assertTrue(ks.getKey(&quot;s5&quot;, &quot;keypass&quot;.toCharArray())
 435                 .getAlgorithm().equalsIgnoreCase(&quot;DES&quot;), &quot;s5 is DES&quot;);
 436         assertTrue(ks.getKey(&quot;s6&quot;, &quot;keypass&quot;.toCharArray())
 437                 .getAlgorithm().equalsIgnoreCase(&quot;DES&quot;), &quot;s6 is DES&quot;);
 438         assertTrue(!ks.containsAlias(&quot;s7&quot;), &quot;s7 not created&quot;);
 439 
 440         // maybe we needn&#39;t test this, one day JKS will support SecretKey
 441         //testFail(&quot;changeit\nchangeit\n&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 442         //        &quot;-genseckey -keyalg AES -alias s3 -keysize 128&quot;);
 443 
 444         // importKeyStore
 445         remove(&quot;x.jks&quot;);
 446         remove(&quot;x.jceks&quot;);
 447         // create 2 entries...
 448         testOK(&quot;changeit\nchangeit\n\n&quot;, &quot;-keystore x.jceks -storetype JCEKS &quot; +
 449                 &quot;-genkeypair -keyalg DSA -alias p1 -dname CN=Olala&quot;);
 450         testOK(&quot;&quot;, &quot;-keystore x.jceks -storetype JCEKS -storepass changeit &quot; +
 451                 &quot;-importcert -alias c1 -file x.jks.p1.cert -noprompt&quot;);
 452         ks = loadStore(&quot;x.jceks&quot;, &quot;changeit&quot;, &quot;JCEKS&quot;);
 453         assertTrue(ks.size() == 2, &quot;2 entries in JCEKS&quot;);
 454         // import, shouldn&#39;t mention destalias/srckeypass/destkeypass
 455         // if srcalias is no given
 456         testFail(&quot;changeit\nchangeit\n&quot;, &quot;-importkeystore &quot; +
 457                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 458                 &quot;-destkeystore x.jks -deststoretype JKS -destalias pp&quot;);
 459         testFail(&quot;changeit\nchangeit\n&quot;, &quot;-importkeystore &quot; +
 460                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 461                 &quot;-destkeystore x.jks -deststoretype JKS -srckeypass changeit&quot;);
 462         testFail(&quot;changeit\nchangeit\n&quot;, &quot;-importkeystore &quot; +
 463                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 464                 &quot;-destkeystore x.jks -deststoretype JKS -destkeypass changeit&quot;);
 465         // normal import
 466         testOK(&quot;changeit\nchangeit\nchangeit\n&quot;, &quot;-importkeystore &quot; +
 467                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 468                 &quot;-destkeystore x.jks -deststoretype JKS&quot;);
 469         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 470         assertTrue(ks.size() == 2, &quot;2 entries in JKS&quot;);
 471         // import again, type yes to overwrite old entries
 472         testOK(&quot;changeit\nchangeit\ny\ny\n&quot;, &quot;-importkeystore &quot; +
 473                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 474                 &quot;-destkeystore x.jks -deststoretype JKS&quot;);
 475         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 476         // import again, specify -nopromt
 477         testOK(&quot;changeit\nchangeit\n&quot;, &quot;-importkeystore &quot; +
 478                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 479                 &quot;-destkeystore x.jks -deststoretype JKS -noprompt&quot;);
 480         assertTrue(err.indexOf(&quot;Warning&quot;) != -1, &quot;noprompt will warn&quot;);
 481         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 482         assertTrue(ks.size() == 2, &quot;2 entries in JKS&quot;);
 483         // import again, type into new aliases when prompted
 484         testOK(&quot;changeit\nchangeit\n\ns1\n\ns2\n&quot;, &quot;-importkeystore &quot; +
 485                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 486                 &quot;-destkeystore x.jks -deststoretype JKS&quot;);
 487         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 488         assertTrue(ks.size() == 4, &quot;4 entries in JKS&quot;);
 489 
 490         // importkeystore single
 491         // normal
 492         remove(&quot;x.jks&quot;);
 493         testOK(&quot;changeit\nchangeit\nchangeit\n&quot;, &quot;-importkeystore &quot; +
 494                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 495                 &quot;-destkeystore x.jks -deststoretype JKS -srcalias p1&quot;);
 496         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 497         assertTrue(ks.size() == 1, &quot;1 entries in JKS&quot;);
 498         // overwrite
 499         testOK(&quot;changeit\nchangeit\ny\n&quot;, &quot;-importkeystore &quot; +
 500                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 501                 &quot;-destkeystore x.jks -deststoretype JKS -srcalias p1&quot;);
 502         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 503         assertTrue(ks.size() == 1, &quot;1 entries in JKS&quot;);
 504         // noprompt
 505         testOK(&quot;changeit\nchangeit\n&quot;, &quot;-importkeystore &quot; +
 506                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 507                 &quot;-destkeystore x.jks -deststoretype JKS &quot; +
 508                 &quot;-srcalias p1 -noprompt&quot;);
 509         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 510         assertTrue(ks.size() == 1, &quot;1 entries in JKS&quot;);
 511         // rename
 512         testOK(&quot;changeit\nchangeit\n&quot;, &quot;-importkeystore &quot; +
 513                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 514                 &quot;-destkeystore x.jks -deststoretype JKS &quot; +
 515                 &quot;-srcalias p1 -destalias p2&quot;);
 516         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 517         assertTrue(ks.size() == 2, &quot;2 entries in JKS&quot;);
 518         // another rename
 519         testOK(&quot;changeit\nchangeit\n\nnewalias\n&quot;, &quot;-importkeystore &quot; +
 520                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 521                 &quot;-destkeystore x.jks -deststoretype JKS -srcalias p1&quot;);
 522         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 523         assertTrue(ks.size() == 3, &quot;3 entries in JKS&quot;);
 524 
 525         // importkeystore single, different keypass
 526         remove(&quot;x.jks&quot;);
 527         // generate entry with different keypass
 528         testOK(&quot;changeit\nkeypass\nkeypass\n&quot;, &quot;-keystore x.jceks &quot; +
 529                 &quot;-storetype JCEKS -genkeypair -keyalg DSA -alias p2 -dname CN=Olala&quot;);
 530         // prompt
 531         testOK(&quot;changeit\nchangeit\nchangeit\nkeypass\n&quot;, &quot;-importkeystore &quot; +
 532                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 533                 &quot;-destkeystore x.jks -deststoretype JKS -srcalias p2&quot;);
 534         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 535         assertTrue(ks.size() == 1, &quot;1 entries in JKS&quot;);
 536         // diff destkeypass
 537         testOK(&quot;changeit\nchangeit\nkeypass\n&quot;, &quot;-importkeystore &quot; +
 538                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 539                 &quot;-destkeystore x.jks -deststoretype JKS &quot; +
 540                 &quot;-srcalias p2 -destalias p3 -destkeypass keypass2&quot;);
 541         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 542         assertTrue(ks.size() == 2, &quot;2 entries in JKS&quot;);
 543         assertTrue(ks.getKey(&quot;p2&quot;, &quot;keypass&quot;.toCharArray()) != null,
 544                 &quot;p2 has old password&quot;);
 545         assertTrue(ks.getKey(&quot;p3&quot;, &quot;keypass2&quot;.toCharArray()) != null,
 546                 &quot;p3 has new password&quot;);
 547 
 548         // importkeystore single, cert
 549         remove(&quot;x.jks&quot;);
 550         // normal
 551         testOK(&quot;changeit\nchangeit\nchangeit\n&quot;, &quot;-importkeystore &quot; +
 552                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 553                 &quot;-destkeystore x.jks -deststoretype JKS -srcalias c1&quot;);
 554         // in fact srcstorepass can be ignored
 555         testOK(&quot;changeit\n\n&quot;, &quot;-importkeystore &quot; +
 556                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 557                 &quot;-destkeystore x.jks -deststoretype JKS &quot; +
 558                 &quot;-srcalias c1 -destalias c2&quot;);
 559         assertTrue(err.indexOf(&quot;WARNING&quot;) != -1, &quot;But will warn&quot;);
 560         // 2nd import, press y to overwrite ...
 561         testOK(&quot;changeit\n\ny\n&quot;, &quot;-importkeystore &quot; +
 562                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 563                 &quot;-destkeystore x.jks -deststoretype JKS &quot; +
 564                 &quot;-srcalias c1 -destalias c2&quot;);
 565         // ... or rename
 566         testOK(&quot;changeit\n\n\nc3\n&quot;, &quot;-importkeystore &quot; +
 567                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 568                 &quot;-destkeystore x.jks -deststoretype JKS &quot; +
 569                 &quot;-srcalias c1 -destalias c2&quot;);
 570         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 571         // c1, c2, c3
 572         assertTrue(ks.size() == 3, &quot;3 entries in JKS&quot;);
 573 
 574         // importkeystore, secretkey
 575         remove(&quot;x.jks&quot;);
 576         // create SecretKeyEntry
 577         testOK(&quot;changeit\n\n&quot;, &quot;-keystore x.jceks -storetype JCEKS &quot; +
 578                 &quot;-genseckey -keyalg DES -alias s1&quot;);
 579         // create SecretKeyEntry
 580         testOK(&quot;changeit\n\n&quot;, &quot;-keystore x.jceks -storetype JCEKS &quot; +
 581                 &quot;-genseckey -keyalg DES -alias s2&quot;);
 582         // remove the keypass!=storepass one
 583         testOK(&quot;changeit\n&quot;, &quot;-keystore x.jceks -storetype JCEKS &quot; +
 584                 &quot;-delete -alias p2&quot;);
 585         ks = loadStore(&quot;x.jceks&quot;, &quot;changeit&quot;, &quot;JCEKS&quot;);
 586         // p1, c1, s1, s2
 587         assertTrue(ks.size() == 4, &quot;4 entries in JCEKS&quot;);
 588         // normal
 589         testOK(&quot;changeit\nchangeit\nchangeit\n&quot;, &quot;-importkeystore &quot; +
 590                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 591                 &quot;-destkeystore x.jks -deststoretype JKS -srcalias s1&quot;);
 592         assertTrue(err.indexOf(&quot;not imported&quot;) != -1, &quot;Not imported&quot;);
 593         assertTrue(err.indexOf(&quot;Cannot store non-PrivateKeys&quot;) != -1,
 594                 &quot;Not imported&quot;);
 595 
 596         // Importing a JCEKS keystore to a JKS one. Will warn
 597         // for the 2 SecretKey entries
 598 
 599         remove(&quot;x.jks&quot;);
 600         // Two &quot;no&quot; answers to bypass warnings
 601         // normal
 602         testOK(&quot;\n\n&quot;, &quot;-srcstorepass changeit -deststorepass changeit &quot; +
 603                 &quot;-importkeystore -srckeystore x.jceks -srcstoretype JCEKS &quot; +
 604                 &quot;-destkeystore x.jks -deststoretype JKS&quot;);
 605         assertTrue(err.indexOf(&quot;s1 not&quot;) != -1, &quot;s1 not&quot;);
 606         assertTrue(err.indexOf(&quot;s2 not&quot;) != -1, &quot;s2 not&quot;);
 607         assertTrue(err.indexOf(&quot;c1 success&quot;) != -1, &quot;c1 success&quot;);
 608         assertTrue(err.indexOf(&quot;p1 success&quot;) != -1, &quot;p1 success&quot;);
 609         remove(&quot;x.jks&quot;);
 610         // One &quot;yes&quot; to stop
 611         // normal
 612         testOK(&quot;yes\n&quot;, &quot;-srcstorepass changeit -deststorepass changeit &quot; +
 613                 &quot;-importkeystore -srckeystore x.jceks -srcstoretype JCEKS &quot; +
 614                 &quot;-destkeystore x.jks -deststoretype JKS&quot;);
 615         // maybe c1 or p1 has been imported before s1 or s2 is touched,
 616         // anyway we know yesNo is only asked once.
 617 
 618         // pkcs12
 619         remove(&quot;x.jks&quot;);
 620         // JKS prompt for keypass
 621         testFail(&quot;changeit\nchangeit\n&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 622                 &quot;-genkeypair -alias p1 -dname CN=olala&quot;);
 623         remove(&quot;x.jks&quot;);
 624         // just type ENTER means keypass=storepass
 625         testOK(&quot;changeit\nchangeit\n\n&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 626                 &quot;-genkeypair -keyalg DSA -alias p1 -dname CN=olala&quot;);
 627         remove(&quot;x.p12&quot;);
 628         // PKCS12 only need storepass
 629         testOK(&quot;&quot;, &quot;-keystore x.p12 -storetype PKCS12 -storepass changeit &quot; +
 630                 &quot;-genkeypair -keyalg DSA -alias p0 -dname CN=olala&quot;);
 631         testOK(&quot;changeit\n&quot;, &quot;-keystore x.p12 -storetype PKCS12 &quot; +
 632                 &quot;-genkeypair -keyalg DSA -alias p1 -dname CN=olala&quot;);
 633         // when specify keypass, make sure keypass==storepass...
 634         testOK(&quot;changeit\n&quot;, &quot;-keystore x.p12 -keypass changeit &quot; +
 635                 &quot;-storetype PKCS12 -genkeypair -keyalg DSA -alias p3 -dname CN=olala&quot;);
 636         assertTrue(err.indexOf(&quot;Warning&quot;) == -1,
 637                 &quot;PKCS12 silent when keypass == storepass&quot;);
 638         // otherwise, print a warning
 639         testOK(&quot;changeit\n&quot;, &quot;-keystore x.p12 -keypass another&quot; +
 640                 &quot; -storetype PKCS12 -genkeypair -keyalg DSA -alias p2 -dname CN=olala&quot;);
 641         assertTrue(err.indexOf(&quot;Warning&quot;) != -1,
 642                 &quot;PKCS12 warning when keypass != storepass&quot;);
 643         // no -keypasswd for PKCS12
 644         testFail(&quot;&quot;, &quot;-keystore x.p12 -storepass changeit -storetype PKCS12&quot; +
 645                 &quot; -keypasswd -new changeit -alias p3&quot;);
 646         testOK(&quot;&quot;, &quot;-keystore x.p12 -storepass changeit -storetype PKCS12 &quot; +
 647                 &quot;-changealias -alias p3 -destalias p33&quot;);
 648         testOK(&quot;&quot;, &quot;-keystore x.p12 -storepass changeit -storetype PKCS12 &quot; +
 649                 &quot;-keyclone -alias p33 -destalias p3&quot;);
 650 
 651         // pkcs12
 652         remove(&quot;x.p12&quot;);
 653         // PKCS12 only need storepass
 654         testOK(&quot;&quot;, &quot;-keystore x.p12 -storetype PKCS12 -storepass changeit &quot; +
 655                 &quot;-genkeypair -keyalg DSA -alias p0 -dname CN=olala&quot;);
 656         testOK(&quot;&quot;, &quot;-storepass changeit -keystore x.p12 -storetype PKCS12 &quot; +
 657                 &quot;-genkeypair -keyalg DSA -alias p1 -dname CN=olala&quot;);
 658         // when specify keypass, make sure keypass==storepass...
 659         testOK(&quot;&quot;, &quot;-storepass changeit -keystore x.p12 -keypass changeit &quot; +
 660                 &quot;-storetype PKCS12 -genkeypair -keyalg DSA -alias p3 -dname CN=olala&quot;);
 661         assertTrue(err.indexOf(&quot;Warning&quot;) == -1,
 662                 &quot;PKCS12 silent when keypass == storepass&quot;);
 663         // otherwise, print a warning
 664         testOK(&quot;&quot;, &quot;-storepass changeit -keystore x.p12 -keypass another &quot; +
 665                 &quot;-storetype PKCS12 -genkeypair -keyalg DSA -alias p2 -dname CN=olala&quot;);
 666         assertTrue(err.indexOf(&quot;Warning&quot;) != -1,
 667                 &quot;PKCS12 warning when keypass != storepass&quot;);
 668 
 669         remove(&quot;x.jks&quot;);
 670         remove(&quot;x.jceks&quot;);
 671         remove(&quot;x.p12&quot;);
 672         remove(&quot;x2.jceks&quot;);
 673         remove(&quot;x2.jks&quot;);
 674         remove(&quot;x.jks.p1.cert&quot;);
 675     }
 676 
 677     void testPKCS11() throws Exception {
 678         KeyStore ks;
 679         // pkcs11, the password maybe different and maybe PKCS11 not supported
 680 
 681         // in case last test is not executed successfully
 682         testAnyway(&quot;&quot;, p11Arg + &quot;-storepass test12 -delete -alias p1&quot;);
 683         testAnyway(&quot;&quot;, p11Arg + &quot;-storepass test12 -delete -alias p2&quot;);
 684         testAnyway(&quot;&quot;, p11Arg + &quot;-storepass test12 -delete -alias p3&quot;);
 685         testAnyway(&quot;&quot;, p11Arg + &quot;-storepass test12 -delete -alias nss&quot;);
 686 
 687         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -list&quot;);
 688         assertTrue(out.indexOf(&quot;Your keystore contains 0 entries&quot;) != -1,
 689                 &quot;*** MAKE SURE YOU HAVE NO ENTRIES IN YOUR PKCS11 KEYSTORE &quot; +
 690                         &quot;BEFORE THIS TEST ***&quot;);
 691 
 692         testOK(&quot;&quot;, p11Arg +
 693                 &quot;-storepass test12 -genkeypair -keyalg DSA -alias p1 -dname CN=olala&quot;);
 694         testOK(&quot;test12\n&quot;, p11Arg + &quot;-genkeypair -keyalg DSA -alias p2 -dname CN=olala2&quot;);
 695         // cannot provide keypass for PKCS11
 696         testFail(&quot;test12\n&quot;, p11Arg +
 697                 &quot;-keypass test12 -genkeypair -keyalg DSA -alias p3 -dname CN=olala3&quot;);
 698         // cannot provide keypass for PKCS11
 699         testFail(&quot;test12\n&quot;, p11Arg +
 700                 &quot;-keypass nonsense -genkeypair -keyalg DSA -alias p3 -dname CN=olala3&quot;);
 701 
 702         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -list&quot;);
 703         assertTrue(out.indexOf(&quot;Your keystore contains 2 entries&quot;) != -1,
 704                 &quot;2 entries in p11&quot;);
 705 
 706         testOK(&quot;test12\n&quot;, p11Arg + &quot;-alias p1 -changealias -destalias p3&quot;);
 707         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -list -alias p3&quot;);
 708         testFail(&quot;&quot;, p11Arg + &quot;-storepass test12 -list -alias p1&quot;);
 709 
 710         testOK(&quot;test12\n&quot;, p11Arg + &quot;-alias p3 -keyclone -destalias p1&quot;);
 711         // in PKCS11, keyclone will delete old
 712         testFail(&quot;&quot;, p11Arg + &quot;-storepass test12 -list -alias p3&quot;);
 713         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -list -alias p1&quot;);
 714 
 715         // cannot change password for PKCS11
 716         testFail(&quot;test12\n&quot;, p11Arg + &quot;-alias p1 -keypasswd -new another&quot;);
 717 
 718         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -list&quot;);
 719         assertTrue(out.indexOf(&quot;Your keystore contains 2 entries&quot;) != -1,
 720                 &quot;2 entries in p11&quot;);
 721 
 722         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -delete -alias p1&quot;);
 723         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -delete -alias p2&quot;);
 724 
 725         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -list&quot;);
 726         assertTrue(out.indexOf(&quot;Your keystore contains 0 entries&quot;) != -1,
 727                 &quot;*** MAKE SURE YOU HAVE NO ENTRIES IN YOUR PKCS11 KEYSTORE&quot; +
 728                         &quot; BEFORE THIS TEST ***&quot;);
 729     }
 730 
 731     void testPKCS11ImportKeyStore() throws Exception {
 732 
 733         KeyStore ks;
 734         testOK(&quot;&quot;, p11Arg +
 735                 &quot;-storepass test12 -genkeypair -keyalg DSA -alias p1 -dname CN=olala&quot;);
 736         testOK(&quot;test12\n&quot;, p11Arg + &quot;-genkeypair -keyalg DSA -alias p2 -dname CN=olala2&quot;);
 737         // test importkeystore for pkcs11
 738 
 739         remove(&quot;x.jks&quot;);
 740         // pkcs11 -&gt; jks
 741         testOK(&quot;changeit\nchangeit\ntest12\n&quot;, srcP11Arg +
 742                 (&quot;-importkeystore -destkeystore x.jks -deststoretype JKS &quot; +
 743                 &quot;-srcalias p1&quot;));
 744         assertTrue(err.indexOf(&quot;not imported&quot;) != -1,
 745                 &quot;cannot import key without destkeypass&quot;);
 746         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 747         assertTrue(!ks.containsAlias(&quot;p1&quot;), &quot;p1 is not imported&quot;);
 748 
 749         testOK(&quot;changeit\ntest12\n&quot;, srcP11Arg +
 750                 (&quot;-importkeystore -destkeystore x.jks -deststoretype JKS &quot; +
 751                 &quot;-srcalias p1 -destkeypass changeit&quot;));
 752         testOK(&quot;changeit\ntest12\n&quot;, srcP11Arg +
 753                 (&quot;-importkeystore -destkeystore x.jks -deststoretype JKS &quot; +
 754                 &quot;-srcalias p2 -destkeypass changeit&quot;));
 755         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 756         assertTrue(ks.containsAlias(&quot;p1&quot;), &quot;p1 is imported&quot;);
 757         assertTrue(ks.containsAlias(&quot;p2&quot;), &quot;p2 is imported&quot;);
 758         // jks -&gt; pkcs11
 759         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -delete -alias p1&quot;);
 760         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -delete -alias p2&quot;);
 761         testOK(&quot;test12\nchangeit\n&quot;, p11Arg +
 762                 &quot;-importkeystore -srckeystore x.jks -srcstoretype JKS&quot;);
 763         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -list -alias p1&quot;);
 764         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -list -alias p2&quot;);
 765         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -list&quot;);
 766         assertTrue(out.indexOf(&quot;Your keystore contains 2 entries&quot;) != -1,
 767                 &quot;2 entries in p11&quot;);
 768         // clean up
 769         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -delete -alias p1&quot;);
 770         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -delete -alias p2&quot;);
 771         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -list&quot;);
 772         assertTrue(out.indexOf(&quot;Your keystore contains 0 entries&quot;) != -1,
 773                 &quot;empty p11&quot;);
 774 
 775         remove(&quot;x.jks&quot;);
 776     }
 777 
 778     // Selected sqeTest
 779     void sqeTest() throws Exception {
 780         FileOutputStream fos = new FileOutputStream(&quot;badkeystore&quot;);
 781         for (int i=0; i&lt;100; i++) {
 782             fos.write(i);
 783         }
 784         fos.close();
 785 
 786         sqeCsrTest();
 787         sqePrintcertTest();
 788         sqeDeleteTest();
 789         sqeExportTest();
 790         sqeGenkeyTest();
 791         sqeImportTest();
 792         sqeKeyclonetest();
 793         sqeKeypasswdTest();
 794         sqeListTest();
 795         sqeSelfCertTest();
 796         sqeStorepassTest();
 797 
 798         remove(&quot;badkeystore&quot;);
 799     }
 800 
 801     // Import: cacert, prompt, trusted, non-trusted, bad chain, not match
 802     void sqeImportTest() throws Exception {
 803         KeyStore ks;
 804         remove(&quot;x.jks&quot;);
 805         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 806                 &quot;-keypass changeit -genkeypair -keyalg DSA -dname CN=olala&quot;);
 807         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 808                 &quot;-exportcert -file x.jks.p1.cert&quot;);
 809         /* deleted */ testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 810                 &quot;-storepass changeit -delete -alias mykey&quot;);
 811         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 812                 &quot;-importcert -file x.jks.p1.cert -noprompt&quot;);
 813         /* deleted */ testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 814                 &quot;-storepass changeit -delete -alias mykey&quot;);
 815         testOK(&quot;yes\n&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 816                 &quot;-importcert -file x.jks.p1.cert&quot;);
 817         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 818         assertTrue(ks.containsAlias(&quot;mykey&quot;), &quot;imported&quot;);
 819         /* deleted */ testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 820                 &quot;-storepass changeit -delete -alias mykey&quot;);
 821         testOK(&quot;\n&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 822                 &quot;-importcert -file x.jks.p1.cert&quot;);
 823         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 824         assertTrue(!ks.containsAlias(&quot;mykey&quot;), &quot;imported&quot;);
 825         testOK(&quot;no\n&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 826                 &quot;-importcert -file x.jks.p1.cert&quot;);
 827         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 828         assertTrue(!ks.containsAlias(&quot;mykey&quot;), &quot;imported&quot;);
 829         testFail(&quot;no\n&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 830                 &quot;-importcert -file nonexist&quot;);
 831         testFail(&quot;no\n&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 832                 &quot;-importcert -file x.jks&quot;);
 833         remove(&quot;x.jks&quot;);
 834     }
 835     // keyclone: exist. nonexist err, cert err, dest exist, misc
 836     void sqeKeyclonetest() throws Exception {
 837         remove(&quot;x.jks&quot;);
 838         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 839                 &quot;-keypass changeit -genkeypair -keyalg DSA -dname CN=olala&quot;);
 840         // new pass
 841         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 842                 &quot;-keypass changeit -new newpass -keyclone -dest p0&quot;);
 843         // new pass
 844         testOK(&quot;\n&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 845                 &quot;-keypass changeit -keyclone -dest p1&quot;);
 846         testOK(&quot;\n&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 847                 &quot;-keyclone -dest p2&quot;);
 848         testFail(&quot;\n&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 849                 &quot;-keyclone -dest p2&quot;);
 850         testFail(&quot;\n&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 851                 &quot;-keyclone -dest p3 -alias noexist&quot;);
 852         // no cert
 853         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 854                 &quot;-exportcert -file x.jks.p1.cert&quot;);
 855         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 856                 &quot;-delete -alias mykey&quot;);
 857         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 858                 &quot;-importcert -file x.jks.p1.cert -noprompt&quot;);
 859         // new pass
 860         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 861                 &quot;-keypass changeit -new newpass -keyclone -dest p0&quot;);
 862         remove(&quot;x.jks&quot;);
 863     }
 864     // keypasswd: exist, short, nonexist err, cert err, misc
 865     void sqeKeypasswdTest() throws Exception {
 866         remove(&quot;x.jks&quot;);
 867         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 868                 &quot;-keypass changeit -genkeypair -keyalg DSA -dname CN=olala&quot;);
 869         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 870                 &quot;-keypass changeit -keypasswd -new newpass&quot;);
 871         /*change back*/ testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 872                 &quot;-storepass changeit -keypass newpass -keypasswd -new changeit&quot;);
 873         testOK(&quot;newpass\nnewpass\n&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 874                 &quot;-storepass changeit -keypass changeit -keypasswd&quot;);
 875         /*change back*/ testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 876                 &quot;-storepass changeit -keypass newpass -keypasswd -new changeit&quot;);
 877         testOK(&quot;new\nnew\nnewpass\nnewpass\n&quot;, &quot;-keystore x.jks &quot; +
 878                 &quot;-storetype JKS -storepass changeit -keypass changeit -keypasswd&quot;);
 879         /*change back*/ testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 880                 &quot;-storepass changeit -keypass newpass -keypasswd -new changeit&quot;);
 881         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 882                 &quot;-keypasswd -new newpass&quot;);
 883         /*change back*/ testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 884                 &quot;-storepass changeit -keypass newpass -keypasswd -new changeit&quot;);
 885         testOK(&quot;changeit\n&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 886                 &quot;-keypasswd -new newpass&quot;);
 887         /*change back*/ testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 888                 &quot;-storepass changeit -keypass newpass -keypasswd -new changeit&quot;);
 889         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass badpass &quot; +
 890                 &quot;-keypass changeit -keypasswd -new newpass&quot;);
 891         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 892                 &quot;-keypass bad -keypasswd -new newpass&quot;);
 893         // no cert
 894         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 895                 &quot;-exportcert -file x.jks.p1.cert&quot;);
 896         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 897                 &quot;-delete -alias mykey&quot;);
 898         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 899                 &quot;-importcert -file x.jks.p1.cert -noprompt&quot;);
 900         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 901                 &quot;-keypass changeit -keypasswd -new newpass&quot;);
 902         // diff pass
 903         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 904                 &quot;-delete -alias mykey&quot;);
 905         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 906                 &quot;-keypass keypass -genkeypair -keyalg DSA -dname CN=olala&quot;);
 907         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 908                 &quot;-keypasswd -new newpass&quot;);
 909         testOK(&quot;keypass\n&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 910                 &quot;-storepass changeit -keypasswd -new newpass&quot;);
 911         // i hate those misc test
 912         remove(&quot;x.jks&quot;);
 913     }
 914     // list: -f -alias, exist, nonexist err;
 915     // otherwise, check all shows, -rfc shows more, and misc
 916     void sqeListTest() throws Exception {
 917         remove(&quot;x.jks&quot;);
 918         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 919                 &quot;-keypass changeit -genkeypair -keyalg DSA -dname CN=olala&quot;);
 920         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit -list&quot;);
 921         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 922                 &quot;-list -alias mykey&quot;);
 923         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 924                 &quot;-list -alias notexist&quot;);
 925         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass badpass &quot; +
 926                 &quot;-list -alias mykey&quot;);
 927         // keypass ignore
 928         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 929                 &quot;-keypass badpass -list -alias mykey&quot;);
 930         testOK(&quot;\n&quot;, &quot;-keystore x.jks -storetype JKS -list&quot;);
 931         assertTrue(err.indexOf(&quot;WARNING&quot;) != -1, &quot;no storepass&quot;);
 932         testOK(&quot;changeit\n&quot;, &quot;-keystore x.jks -storetype JKS -list&quot;);
 933         assertTrue(err.indexOf(&quot;WARNING&quot;) == -1, &quot;has storepass&quot;);
 934         testFail(&quot;badpass\n&quot;, &quot;-keystore x.jks -storetype JKS -list&quot;);
 935         // misc
 936         testFail(&quot;&quot;, &quot;-keystore aa\\bb//cc -storepass changeit -list&quot;);
 937         testFail(&quot;&quot;, &quot;-keystore nonexisting -storepass changeit -list&quot;);
 938         testFail(&quot;&quot;, &quot;-keystore badkeystore -storepass changeit -list&quot;);
 939         remove(&quot;x.jks&quot;);
 940     }
 941     // selfcert: exist, non-exist err, cert err, sig, dname, wrong keypass, misc
 942     void sqeSelfCertTest() throws Exception {
 943         remove(&quot;x.jks&quot;);
 944         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 945                 &quot;-keypass changeit -genkeypair -keyalg DSA -dname CN=olala&quot;);
 946         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit -selfcert&quot;);
 947         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 948                 &quot;-keypass changeit -selfcert&quot;);
 949         // not exist
 950         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 951                 &quot;-keypass changeit -selfcert -alias nonexisting&quot;);
 952         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 953                 &quot;-keypass changeit -selfcert -dname CN=NewName&quot;);
 954         // sig not compatible
 955         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 956                 &quot;-keypass changeit -selfcert -sigalg MD5withRSA&quot;);
 957         // bad pass
 958         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass wrong &quot; +
 959                 &quot;-keypass changeit -selfcert&quot;);
 960         // bad pass
 961         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 962                 &quot;-keypass wrong -selfcert&quot;);
 963         //misc
 964         testFail(&quot;&quot;, &quot;-keystore nonexist -storepass changeit &quot; +
 965                 &quot;-keypass changeit -selfcert&quot;);
 966         testFail(&quot;&quot;, &quot;-keystore aa//dd\\gg -storepass changeit &quot; +
 967                 &quot;-keypass changeit -selfcert&quot;);
 968         // diff pass
 969         remove(&quot;x.jks&quot;);
 970         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 971                 &quot;-keypass keypass -genkeypair -keyalg DSA -dname CN=olala&quot;);
 972         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 973                 &quot;-storepass changeit -selfcert&quot;);
 974         testOK(&quot;keypass\n&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 975                 &quot;-storepass changeit -selfcert&quot;);
 976 
 977         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 978                 &quot;-exportcert -file x.jks.p1.cert&quot;);
 979         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 980                 &quot;-delete -alias mykey&quot;);
 981         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 982                 &quot;-importcert -file x.jks.p1.cert -noprompt&quot;);
 983         // certentry cannot do selfcert
 984         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 985                 &quot;-selfcert&quot;);
 986         remove(&quot;x.jks&quot;);
 987     }
 988     // storepass: bad old, short new, misc
 989     void sqeStorepassTest() throws Exception {
 990         remove(&quot;x.jks&quot;);
 991         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 992                 &quot;-keypass changeit -genkeypair -keyalg DSA -dname CN=olala&quot;);
 993         // all in arg
 994         testOK(&quot;&quot;, &quot;-storepasswd -keystore x.jks -storetype JKS &quot; +
 995                 &quot;-storepass changeit -new newstore&quot;);
 996         /* Change back */ testOK(&quot;&quot;, &quot;-storepasswd -keystore x.jks&quot; +
 997                 &quot; -storetype JKS -storepass newstore -new changeit&quot;);
 998         // all not in arg, new twice
 999         testOK(&quot;changeit\nnewstore\nnewstore\n&quot;, &quot;-storepasswd &quot; +
1000                 &quot;-keystore x.jks -storetype JKS&quot;);
1001         /* Change back */ testOK(&quot;&quot;, &quot;-storepasswd -keystore x.jks &quot; +
1002                 &quot;-storetype JKS -storepass newstore -new changeit&quot;);
1003         // new in arg
1004         testOK(&quot;changeit\n&quot;, &quot;-storepasswd -keystore x.jks &quot; +
1005                 &quot;-storetype JKS -new newstore&quot;);
1006         /* Change back */ testOK(&quot;&quot;, &quot;-storepasswd -keystore x.jks &quot; +
1007                 &quot;-storetype JKS -storepass newstore -new changeit&quot;);
1008         // old in arg
1009         testOK(&quot;newstore\nnewstore\n&quot;, &quot;-storepasswd -keystore x.jks &quot; +
1010                 &quot;-storetype JKS -storepass changeit&quot;);
1011         /* Change back */ testOK(&quot;&quot;, &quot;-storepasswd -keystore x.jks &quot; +
1012                 &quot;-storetype JKS -storepass newstore -new changeit&quot;);
1013         // old in arg
1014         testOK(&quot;new\nnew\nnewstore\nnewstore\n&quot;, &quot;-storepasswd &quot; +
1015                 &quot;-keystore x.jks -storetype JKS -storepass changeit&quot;);
1016         /* Change back */ testOK(&quot;&quot;, &quot;-storepasswd -keystore x.jks &quot; +
1017                 &quot;-storetype JKS -storepass newstore -new changeit&quot;);
1018         // bad old
1019         testFail(&quot;&quot;, &quot;-storepasswd -keystore x.jks -storetype JKS &quot; +
1020                 &quot;-storepass badold -new newstore&quot;);
1021         // short new
1022         testFail(&quot;&quot;, &quot;-storepasswd -keystore x.jks -storetype JKS &quot; +
1023                 &quot;-storepass changeit -new new&quot;);
1024         // misc
1025         // non exist
1026         testFail(&quot;&quot;, &quot;-storepasswd -keystore nonexist &quot; +
1027                 &quot;-storepass changeit -new newstore&quot;);
1028         // bad file
1029         testFail(&quot;&quot;, &quot;-storepasswd -keystore badkeystore &quot; +
1030                 &quot;-storepass changeit -new newstore&quot;);
1031         // bad file
1032         testFail(&quot;&quot;, &quot;-storepasswd -keystore aa\\bb//cc//dd &quot; +
1033                 &quot;-storepass changeit -new newstore&quot;);
1034         remove(&quot;x.jks&quot;);
1035     }
1036 
1037     void sqeGenkeyTest() throws Exception {
1038 
1039         remove(&quot;x.jks&quot;);
1040         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1041                 &quot;-keypass changeit -genkeypair -keyalg DSA -dname CN=olala&quot;);
1042         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1043                 &quot;-keypass changeit -genkeypair -keyalg DSA -dname CN=olala&quot;);
1044         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1045                 &quot;-keypass changeit -genkeypair -keyalg DSA -dname CN=olala -alias newentry&quot;);
1046         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1047                 &quot;-keypass changeit -genkeypair -keyalg DSA -dname CN=olala -alias newentry&quot;);
1048         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1049                 &quot;-keypass changeit -genkeypair -dname CN=olala -keyalg DSA &quot; +
1050                 &quot;-alias n1&quot;);
1051         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1052                 &quot;-keypass changeit -genkeypair -dname CN=olala -keyalg RSA &quot; +
1053                 &quot;-alias n2&quot;);
1054         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1055                 &quot;-keypass changeit -genkeypair -dname CN=olala &quot; +
1056                 &quot;-keyalg NoSuchAlg -alias n3&quot;);
1057         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1058                 &quot;-keypass changeit -genkeypair -keyalg DSA -dname CN=olala -keysize 56 &quot; +
1059                 &quot;-alias n4&quot;);
1060         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1061                 &quot;-keypass changeit -genkeypair -keyalg DSA -dname CN=olala -keysize 999 &quot; +
1062                 &quot;-alias n5&quot;);
1063         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1064                 &quot;-keypass changeit -genkeypair -keyalg DSA -dname CN=olala -keysize 512 &quot; +
1065                 &quot;-alias n6&quot;);
1066         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1067                 &quot;-keypass changeit -genkeypair -keyalg DSA -dname CN=olala -keysize 1024 &quot; +
1068                 &quot;-alias n7&quot;);
1069         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1070                 &quot;-keypass changeit -genkeypair -keyalg DSA -dname CN=olala &quot; +
1071                 &quot;-sigalg NoSuchAlg -alias n8&quot;);
1072         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1073                 &quot;-keypass changeit -genkeypair -dname CN=olala -keyalg RSA &quot; +
1074                 &quot;-sigalg MD2withRSA -alias n9&quot;);
1075         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1076                 &quot;-keypass changeit -genkeypair -dname CN=olala -keyalg RSA &quot; +
1077                 &quot;-sigalg MD5withRSA -alias n10&quot;);
1078         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1079                 &quot;-keypass changeit -genkeypair -dname CN=olala -keyalg RSA &quot; +
1080                 &quot;-sigalg SHA1withRSA -alias n11&quot;);
1081         testFail(&quot;&quot;, &quot;-keystore aa\\bb//cc\\dd -storepass changeit &quot; +
1082                 &quot;-keypass changeit -genkeypair -dname CN=olala -keyalg RSA &quot; +
1083                 &quot;-sigalg NoSuchAlg -alias n12&quot;);
1084         testFail(&quot;&quot;, &quot;-keystore badkeystore -storepass changeit &quot; +
1085                 &quot;-keypass changeit -genkeypair -keyalg DSA -dname CN=olala &quot; +
1086                 &quot;-alias n14&quot;);
1087         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass badpass &quot; +
1088                 &quot;-keypass changeit -genkeypair -keyalg DSA -dname CN=olala -alias n16&quot;);
1089         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1090                 &quot;-keypass changeit -genkeypair -keyalg DSA -dname CNN=olala -alias n17&quot;);
1091         remove(&quot;x.jks&quot;);
1092     }
1093 
1094     void sqeExportTest() throws Exception {
1095         remove(&quot;x.jks&quot;);
1096         // nonexist
1097         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1098                 &quot;-export -file mykey.cert -alias mykey&quot;);
1099         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1100                 &quot;-keypass changeit -genkeypair -keyalg DSA -dname CN=olala&quot;);
1101         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1102                 &quot;-export -file mykey.cert -alias mykey&quot;);
1103         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1104                 &quot;-delete -alias mykey&quot;);
1105         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1106                 &quot;-import -file mykey.cert -noprompt -alias c1&quot;);
1107         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1108                 &quot;-export -file mykey.cert2 -alias c1&quot;);
1109         testFail(&quot;&quot;, &quot;-keystore aa\\bb//cc\\dd -storepass changeit &quot; +
1110                 &quot;-export -file mykey.cert2 -alias c1&quot;);
1111         testFail(&quot;&quot;, &quot;-keystore nonexistkeystore -storepass changeit &quot; +
1112                 &quot;-export -file mykey.cert2 -alias c1&quot;);
1113         testFail(&quot;&quot;, &quot;-keystore badkeystore -storepass changeit &quot; +
1114                 &quot;-export -file mykey.cert2 -alias c1&quot;);
1115         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass badpass &quot; +
1116                 &quot;-export -file mykey.cert2 -alias c1&quot;);
1117         remove(&quot;mykey.cert&quot;);
1118         remove(&quot;mykey.cert2&quot;);
1119         remove(&quot;x.jks&quot;);
1120     }
1121 
1122     void sqeDeleteTest() throws Exception {
1123         remove(&quot;x.jks&quot;);
1124         // nonexist
1125         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1126                 &quot;-delete -alias mykey&quot;);
1127         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1128                 &quot;-keypass changeit -genkeypair -keyalg DSA -dname CN=olala&quot;);
1129         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1130                 &quot;-delete -alias mykey&quot;);
1131         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1132                 &quot;-keypass changeit -genkeypair -keyalg DSA -dname CN=olala&quot;);
1133         // keystore name illegal
1134         testFail(&quot;&quot;, &quot;-keystore aa\\bb//cc\\dd -storepass changeit &quot; +
1135                 &quot;-delete -alias mykey&quot;);
1136         // keystore not exist
1137         testFail(&quot;&quot;, &quot;-keystore nonexistkeystore -storepass changeit &quot; +
1138                 &quot;-delete -alias mykey&quot;);
1139         // keystore invalid
1140         testFail(&quot;&quot;, &quot;-keystore badkeystore -storepass changeit &quot; +
1141                 &quot;-delete -alias mykey&quot;);
1142         // wrong pass
1143         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass xxxxxxxx &quot; +
1144                 &quot;-delete -alias mykey&quot;);
1145         remove(&quot;x.jks&quot;);
1146     }
1147 
1148     void sqeCsrTest() throws Exception {
1149         remove(&quot;x.jks&quot;);
1150         remove(&quot;x.jks.p1.cert&quot;);
1151         remove(&quot;csr1&quot;);
1152         // PrivateKeyEntry can do certreq
1153         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1154                 &quot;-keypass changeit -genkeypair -keyalg DSA -dname CN=olala -keysize 1024&quot;);
1155         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1156                 &quot;-certreq -file csr1 -alias mykey&quot;);
1157         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1158                 &quot;-certreq -file csr1&quot;);
1159         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1160                 &quot;-certreq -file csr1 -sigalg SHA1withDSA&quot;);
1161         // unmatched sigalg
1162         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1163                 &quot;-certreq -file csr1 -sigalg MD5withRSA&quot;);
1164         // misc test
1165         // bad storepass
1166         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass badstorepass &quot; +
1167                 &quot;-certreq -file csr1&quot;);
1168         // storepass from terminal
1169         testOK(&quot;changeit\n&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
1170                 &quot;-certreq -file csr1&quot;);
1171         // must provide storepass
1172         testFail(&quot;\n&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
1173                 &quot;-certreq -file csr1&quot;);
1174         // bad keypass
1175         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1176                 &quot;-keypass badkeypass -certreq -file csr1&quot;);
1177         // bad filepath
1178         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1179                 &quot;-certreq -file aa\\bb//cc\\dd&quot;);
1180         // non-existing keystore
1181         testFail(&quot;&quot;, &quot;-keystore noexistks -storepass changeit &quot; +
1182                 &quot;-certreq -file csr1&quot;);
1183         // Try the RSA private key
1184         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1185                 &quot;-delete -alias mykey&quot;);
1186         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1187                 &quot;-keypass changeit -genkeypair -dname CN=olala -keyalg RSA&quot;);
1188         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1189                 &quot;-certreq -file csr1 -alias mykey&quot;);
1190         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1191                 &quot;-certreq -file csr1&quot;);
1192         // unmatched sigalg
1193         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1194                 &quot;-certreq -file csr1 -sigalg SHA1withDSA&quot;);
1195         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1196                 &quot;-certreq -file csr1 -sigalg MD5withRSA&quot;);
1197         // TrustedCertificateEntry cannot do certreq
1198         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1199                 &quot;-exportcert -file x.jks.p1.cert&quot;);
1200         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1201                 &quot;-delete -alias mykey&quot;);
1202         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1203                 &quot;-importcert -file x.jks.p1.cert -noprompt&quot;);
1204         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1205                 &quot;-certreq -file csr1 -alias mykey&quot;);
1206         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1207                 &quot;-certreq -file csr1&quot;);
1208         remove(&quot;x.jks&quot;);
1209         remove(&quot;x.jks.p1.cert&quot;);
1210         remove(&quot;csr1&quot;);
1211     }
1212 
1213     void sqePrintcertTest() throws Exception {
1214         remove(&quot;x.jks&quot;);
1215         remove(&quot;mykey.cert&quot;);
1216         remove(&quot;myweakkey.cert&quot;);
1217         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1218                 &quot;-keypass changeit -genkeypair -keyalg DSA -dname CN=olala&quot;);
1219         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1220                 &quot;-export -file mykey.cert -alias mykey&quot;);
1221         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1222                 &quot;-keypass changeit -genkeypair -dname CN=weak -keyalg rsa &quot; +
1223                 &quot;-keysize 512 -sigalg MD5withRSA -alias myweakkey&quot;);
1224         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1225                 &quot;-export -file myweakkey.cert -alias myweakkey&quot;);
1226         testFail(&quot;&quot;, &quot;-printcert -file badkeystore&quot;);
1227         testFail(&quot;&quot;, &quot;-printcert -file a/b/c/d&quot;);
1228         testOK(&quot;&quot;, &quot;-printcert -file mykey.cert&quot;);
1229         testOK(&quot;&quot;, &quot;-printcert -file myweakkey.cert&quot;);
1230         FileInputStream fin = new FileInputStream(&quot;mykey.cert&quot;);
1231         testOK(fin, &quot;-printcert&quot;);
1232         fin.close();
1233         remove(&quot;x.jks&quot;);
1234         remove(&quot;mykey.cert&quot;);
1235         remove(&quot;myweakkey.cert&quot;);
1236     }
1237 
1238     // 8074935: jdk8 keytool doesn&#39;t validate pem files for RFC 1421 correctness
1239     static void checkPem(String file) throws Exception {
1240         boolean maybeLast = false;
1241         for (String s: Files.readAllLines(Paths.get(file))) {
1242             if (s.isEmpty()) continue;
1243             if (s.startsWith(&quot;---&quot;)) continue;
1244             if (maybeLast) {
1245                 throw new Exception(&quot;Last line already seen&quot;);
1246             }
1247             if (s.length() &gt; 64) {
1248                 throw new Exception(s);
1249             }
1250             if (s.length() &lt; 64) {
1251                 maybeLast = true;
1252             }
1253         }
1254     }
1255 
1256     void v3extTest(String keyAlg) throws Exception {
1257         KeyStore ks;
1258         remove(&quot;x.jks&quot;);
1259         String simple = &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1260                 &quot;-keypass changeit -noprompt -keyalg &quot; + keyAlg + &quot; &quot;;
1261         String pre = simple + &quot;-genkeypair -keyalg DSA -dname CN=Olala -alias &quot;;
1262 
1263         // Version and SKID
1264         testOK(&quot;&quot;, pre + &quot;o1&quot;);
1265 
1266         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
1267         assertTrue(((X509Certificate)ks.getCertificate(&quot;o1&quot;)).getVersion() == 3);
1268         assertTrue(((X509CertImpl)ks.getCertificate(&quot;o1&quot;))
1269                 .getSubjectKeyIdentifierExtension() != null);
1270 
1271         // BC
1272         testOK(&quot;&quot;, pre + &quot;b1 -ext BC:critical&quot;);
1273         testOK(&quot;&quot;, pre + &quot;b2 -ext BC&quot;);
1274         testOK(&quot;&quot;, pre + &quot;b3 -ext bc&quot;);
1275         testOK(&quot;&quot;, pre + &quot;b4 -ext BasicConstraints&quot;);
1276         testOK(&quot;&quot;, pre + &quot;b5 -ext basicconstraints&quot;);
1277         testOK(&quot;&quot;, pre + &quot;b6 -ext BC=ca:true,pathlen:12&quot;);
1278         testOK(&quot;&quot;, pre + &quot;b7 -ext BC=ca:false&quot;);
1279         testOK(&quot;&quot;, pre + &quot;b8 -ext BC:critical=ca:false&quot;);
1280         testOK(&quot;&quot;, pre + &quot;b9 -ext BC=12&quot;);
1281 
1282         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
1283         assertTrue(((X509CertImpl)ks.getCertificate(&quot;b1&quot;))
1284                 .getBasicConstraintsExtension().isCritical());
1285         assertTrue(!((X509CertImpl)ks.getCertificate(&quot;b2&quot;))
1286                 .getBasicConstraintsExtension().isCritical());
1287         assertTrue(((X509CertImpl)ks.getCertificate(&quot;b8&quot;))
1288                 .getBasicConstraintsExtension().isCritical());
1289         assertTrue(((X509Certificate)ks.getCertificate(&quot;b1&quot;))
1290                 .getBasicConstraints() == Integer.MAX_VALUE);
1291         assertTrue(((X509Certificate)ks.getCertificate(&quot;b2&quot;))
1292                 .getBasicConstraints() == Integer.MAX_VALUE);
1293         assertTrue(((X509Certificate)ks.getCertificate(&quot;b3&quot;))
1294                 .getBasicConstraints() == Integer.MAX_VALUE);
1295         assertTrue(((X509Certificate)ks.getCertificate(&quot;b4&quot;))
1296                 .getBasicConstraints() == Integer.MAX_VALUE);
1297         assertTrue(((X509Certificate)ks.getCertificate(&quot;b5&quot;))
1298                 .getBasicConstraints() == Integer.MAX_VALUE);
1299         assertTrue(((X509Certificate)ks.getCertificate(&quot;b6&quot;))
1300                 .getBasicConstraints() == 12);
1301         assertTrue(((X509Certificate)ks.getCertificate(&quot;b7&quot;))
1302                 .getBasicConstraints() == -1);
1303         assertTrue(((X509Certificate)ks.getCertificate(&quot;b9&quot;))
1304                 .getBasicConstraints() == 12);
1305 
1306         // KU
1307         testOK(&quot;&quot;, pre + &quot;ku1 -ext KeyUsage:critical=digitalsignature&quot;);
1308         testOK(&quot;&quot;, pre + &quot;ku2 -ext KU=digitalSignature&quot;);
1309         testOK(&quot;&quot;, pre + &quot;ku3 -ext KU=ds&quot;);
1310         testOK(&quot;&quot;, pre + &quot;ku4 -ext KU=dig&quot;);
1311         // ambigous value
1312         testFail(&quot;&quot;, pre + &quot;ku5 -ext KU=d&quot;);
1313         // cRLSign cannot be cs
1314         testFail(&quot;&quot;, pre + &quot;ku6 -ext KU=cs&quot;);
1315         testOK(&quot;&quot;, pre + &quot;ku11 -ext KU=nr&quot;);
1316         // ke means keyAgreement and keyCertSign...
1317         testFail(&quot;&quot;, pre + &quot;ku12 -ext KU=ke&quot;);
1318         testOK(&quot;&quot;, pre + &quot;ku12 -ext KU=keyE&quot;);
1319         testOK(&quot;&quot;, pre + &quot;ku12a -ext KU=kE&quot;); // kE is only keyEncipherment
1320         // de also means decipherOnly
1321         testOK(&quot;&quot;, pre + &quot;ku13a -ext KU=de&quot;); // de is decipherOnly
1322         testOK(&quot;&quot;, pre + &quot;ku13b -ext KU=dE&quot;); // dE is dataEncipherment
1323         testOK(&quot;&quot;, pre + &quot;ku13 -ext KU=dataE&quot;);
1324         testOK(&quot;&quot;, pre + &quot;ku14 -ext KU=ka&quot;);
1325         testOK(&quot;&quot;, pre + &quot;ku15 -ext KU=kcs&quot;);
1326         testOK(&quot;&quot;, pre + &quot;ku16 -ext KU=crls&quot;);
1327         testOK(&quot;&quot;, pre + &quot;ku17 -ext KU=eo&quot;);
1328         testOK(&quot;&quot;, pre + &quot;ku18 -ext KU=do&quot;);
1329         testOK(&quot;&quot;, pre + &quot;ku19 -ext KU=cc&quot;);
1330 
1331         testOK(&quot;&quot;, pre + &quot;ku017 -ext KU=ds,cc,eo&quot;);
1332         testOK(&quot;&quot;, pre + &quot;ku135 -ext KU=nr,dataEncipherment,keyCertSign&quot;);
1333         testOK(&quot;&quot;, pre + &quot;ku246 -ext KU=keyEnc,cRL,keyA&quot;);
1334         testOK(&quot;&quot;, pre + &quot;ku1234 -ext KU=ka,da,keyE,nonR&quot;);
1335 
1336         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
1337         class CheckKU {
1338             void check(KeyStore ks, String alias, int... pos) throws Exception {
1339                 System.err.print(&quot;x&quot;);
1340                 boolean[] bs = ((X509Certificate)ks.getCertificate(alias))
1341                         .getKeyUsage();
1342                 bs = Arrays.copyOf(bs, 9);
1343                 for (int i=0; i&lt;bs.length; i++) {
1344                     boolean found = false;
1345                     for (int p: pos) {
1346                         if (p == i) found = true;
1347                     }
1348                     if (!found ^ bs[i]) {
1349                         // OK
1350                     } else {
1351                         throw new RuntimeException(&quot;KU not match at &quot; + i +
1352                                 &quot;: &quot; + found + &quot; vs &quot; + bs[i]);
1353                     }
1354                 }
1355             }
1356         }
1357         CheckKU c = new CheckKU();
1358         assertTrue(((X509CertImpl)ks.getCertificate(&quot;ku1&quot;))
1359                 .getExtension(PKIXExtensions.KeyUsage_Id).isCritical());
1360         assertTrue(!((X509CertImpl)ks.getCertificate(&quot;ku2&quot;))
1361                 .getExtension(PKIXExtensions.KeyUsage_Id).isCritical());
1362         c.check(ks, &quot;ku1&quot;, 0);
1363         c.check(ks, &quot;ku2&quot;, 0);
1364         c.check(ks, &quot;ku3&quot;, 0);
1365         c.check(ks, &quot;ku4&quot;, 0);
1366         c.check(ks, &quot;ku11&quot;, 1);
1367         c.check(ks, &quot;ku12&quot;, 2);
1368         c.check(ks, &quot;ku13&quot;, 3);
1369         c.check(ks, &quot;ku14&quot;, 4);
1370         c.check(ks, &quot;ku15&quot;, 5);
1371         c.check(ks, &quot;ku16&quot;, 6);
1372         c.check(ks, &quot;ku17&quot;, 7);
1373         c.check(ks, &quot;ku18&quot;, 8);
1374         c.check(ks, &quot;ku19&quot;, 1);
1375         c.check(ks, &quot;ku11&quot;, 1);
1376         c.check(ks, &quot;ku11&quot;, 1);
1377         c.check(ks, &quot;ku11&quot;, 1);
1378         c.check(ks, &quot;ku017&quot;, 0, 1, 7);
1379         c.check(ks, &quot;ku135&quot;, 1, 3, 5);
1380         c.check(ks, &quot;ku246&quot;, 6, 2, 4);
1381         c.check(ks, &quot;ku1234&quot;, 1, 2, 3, 4);
1382 
1383         // EKU
1384         testOK(&quot;&quot;, pre + &quot;eku1 -ext EKU:critical=sa&quot;);
1385         testOK(&quot;&quot;, pre + &quot;eku2 -ext ExtendedKeyUsage=ca&quot;);
1386         testOK(&quot;&quot;, pre + &quot;eku3 -ext EKU=cs&quot;);
1387         testOK(&quot;&quot;, pre + &quot;eku4 -ext EKU=ep&quot;);
1388         testOK(&quot;&quot;, pre + &quot;eku8 -ext EKU=ts&quot;);
1389         testFail(&quot;&quot;, pre + &quot;eku9 -ext EKU=os&quot;);
1390         testOK(&quot;&quot;, pre + &quot;eku9 -ext EKU=ocsps&quot;);
1391         testOK(&quot;&quot;, pre + &quot;eku10 -ext EKU=any&quot;);
1392         testOK(&quot;&quot;, pre + &quot;eku11 -ext EKU=1.2.3.4,1.3.5.7,ep&quot;);
1393         testFail(&quot;&quot;, pre + &quot;eku12 -ext EKU=c&quot;);
1394         testFail(&quot;&quot;, pre + &quot;eku12 -ext EKU=nothing&quot;);
1395 
1396         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
1397         class CheckEKU {
1398             void check(KeyStore ks, String alias, String... pos) throws Exception {
1399                 System.err.print(&quot;x&quot;);
1400                 List&lt;String&gt; bs = ((X509Certificate)ks.getCertificate(alias))
1401                         .getExtendedKeyUsage();
1402                 int found = 0;
1403                 for (String p: pos) {
1404                     if (bs.contains(p)) {
1405                         found++;
1406                     } else {
1407                         throw new RuntimeException(&quot;EKU: not included &quot; + p);
1408                     }
1409                 }
1410                 if (found != bs.size()) {
1411                     throw new RuntimeException(&quot;EKU: more items than expected&quot;);
1412                 }
1413             }
1414         }
1415         CheckEKU cx = new CheckEKU();
1416         assertTrue(((X509CertImpl)ks.getCertificate(&quot;eku1&quot;))
1417                 .getExtension(PKIXExtensions.ExtendedKeyUsage_Id).isCritical());
1418         assertTrue(!((X509CertImpl)ks.getCertificate(&quot;eku2&quot;))
1419                 .getExtension(PKIXExtensions.ExtendedKeyUsage_Id).isCritical());
1420         cx.check(ks, &quot;eku1&quot;, &quot;1.3.6.1.5.5.7.3.1&quot;);
1421         cx.check(ks, &quot;eku2&quot;, &quot;1.3.6.1.5.5.7.3.2&quot;);
1422         cx.check(ks, &quot;eku3&quot;, &quot;1.3.6.1.5.5.7.3.3&quot;);
1423         cx.check(ks, &quot;eku4&quot;, &quot;1.3.6.1.5.5.7.3.4&quot;);
1424         cx.check(ks, &quot;eku8&quot;, &quot;1.3.6.1.5.5.7.3.8&quot;);
1425         cx.check(ks, &quot;eku9&quot;, &quot;1.3.6.1.5.5.7.3.9&quot;);
1426         cx.check(ks, &quot;eku10&quot;, &quot;2.5.29.37.0&quot;);
1427         cx.check(ks, &quot;eku11&quot;, &quot;1.3.6.1.5.5.7.3.4&quot;, &quot;1.2.3.4&quot;, &quot;1.3.5.7&quot;);
1428 
1429         // SAN
1430         testOK(&quot;&quot;, pre+&quot;san1 -ext san:critical=email:me@me.org&quot;);
1431         testOK(&quot;&quot;, pre+&quot;san2 -ext san=uri:http://me.org&quot;);
1432         testOK(&quot;&quot;, pre+&quot;san3 -ext san=dns:me.org&quot;);
1433         testOK(&quot;&quot;, pre+&quot;san4 -ext san=ip:192.168.0.1&quot;);
1434         testOK(&quot;&quot;, pre+&quot;san5 -ext san=oid:1.2.3.4&quot;);
1435         testOK(&quot;&quot;, pre+&quot;san6 -ext san=dns:1abc.com&quot;); //begin with digit
1436         testOK(&quot;&quot;, pre+&quot;san235 -ext san=uri:http://me.org,dns:me.org,oid:1.2.3.4&quot;);
1437 
1438         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
1439         class CheckSAN {
1440             // Please sort items with name type
1441             void check(KeyStore ks, String alias, int type, Object... items)
1442                     throws Exception {
1443                 int pos = 0;
1444                 System.err.print(&quot;x&quot;);
1445                 Object[] names = null;
1446                 if (type == 0) names = ((X509Certificate)ks.getCertificate(alias))
1447                         .getSubjectAlternativeNames().toArray();
1448                 else names = ((X509Certificate)ks.getCertificate(alias))
1449                         .getIssuerAlternativeNames().toArray();
1450                 Arrays.sort(names, new Comparator() {
1451                     public int compare(Object o1, Object o2) {
1452                         int i1 = (Integer)((List)o1).get(0);
1453                         int i2 = (Integer)((List)o2).get(0);
1454                         return i1 - i2;
1455                     }
1456                 });
1457                 for (Object o: names) {
1458                     List l = (List)o;
1459                     for (Object o2: l) {
1460                         if (!items[pos++].equals(o2)) {
1461                             throw new RuntimeException(&quot;Not equals at &quot; + pos
1462                                     + &quot;: &quot; + items[pos-1] + &quot; vs &quot; + o2);
1463                         }
1464                     }
1465                 }
1466                 if (pos != items.length) {
1467                     throw new RuntimeException(&quot;Extra items, pos is &quot; + pos);
1468                 }
1469             }
1470         }
1471         CheckSAN csan = new CheckSAN();
1472         assertTrue(((X509CertImpl)ks.getCertificate(&quot;san1&quot;))
1473                 .getSubjectAlternativeNameExtension().isCritical());
1474         assertTrue(!((X509CertImpl)ks.getCertificate(&quot;san2&quot;))
1475                 .getSubjectAlternativeNameExtension().isCritical());
1476         csan.check(ks, &quot;san1&quot;, 0, 1, &quot;me@me.org&quot;);
1477         csan.check(ks, &quot;san2&quot;, 0, 6, &quot;http://me.org&quot;);
1478         csan.check(ks, &quot;san3&quot;, 0, 2, &quot;me.org&quot;);
1479         csan.check(ks, &quot;san4&quot;, 0, 7, &quot;192.168.0.1&quot;);
1480         csan.check(ks, &quot;san5&quot;, 0, 8, &quot;1.2.3.4&quot;);
1481         csan.check(ks, &quot;san235&quot;, 0, 2, &quot;me.org&quot;, 6, &quot;http://me.org&quot;, 8, &quot;1.2.3.4&quot;);
1482 
1483         // IAN
1484         testOK(&quot;&quot;, pre+&quot;ian1 -ext ian:critical=email:me@me.org&quot;);
1485         testOK(&quot;&quot;, pre+&quot;ian2 -ext ian=uri:http://me.org&quot;);
1486         testOK(&quot;&quot;, pre+&quot;ian3 -ext ian=dns:me.org&quot;);
1487         testOK(&quot;&quot;, pre+&quot;ian4 -ext ian=ip:192.168.0.1&quot;);
1488         testOK(&quot;&quot;, pre+&quot;ian5 -ext ian=oid:1.2.3.4&quot;);
1489         testOK(&quot;&quot;, pre+&quot;ian235 -ext ian=uri:http://me.org,dns:me.org,oid:1.2.3.4&quot;);
1490 
1491         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
1492         assertTrue(((X509CertImpl)ks.getCertificate(&quot;ian1&quot;))
1493                 .getIssuerAlternativeNameExtension().isCritical());
1494         assertTrue(!((X509CertImpl)ks.getCertificate(&quot;ian2&quot;))
1495                 .getIssuerAlternativeNameExtension().isCritical());
1496         csan.check(ks, &quot;ian1&quot;, 1, 1, &quot;me@me.org&quot;);
1497         csan.check(ks, &quot;ian2&quot;, 1, 6, &quot;http://me.org&quot;);
1498         csan.check(ks, &quot;ian3&quot;, 1, 2, &quot;me.org&quot;);
1499         csan.check(ks, &quot;ian4&quot;, 1, 7, &quot;192.168.0.1&quot;);
1500         csan.check(ks, &quot;ian5&quot;, 1, 8, &quot;1.2.3.4&quot;);
1501         csan.check(ks, &quot;ian235&quot;, 1, 2, &quot;me.org&quot;, 6, &quot;http://me.org&quot;, 8, &quot;1.2.3.4&quot;);
1502 
1503         // SIA
1504         testOK(&quot;&quot;, pre+&quot;sia1 -ext sia=care:uri:ldap://ca.com/cn=CA&quot;);
1505         testOK(&quot;&quot;, pre+&quot;sia2 -ext sia=ts:email:ts@ca.com&quot;);
1506         testFail(&quot;SIA never critical&quot;, pre +
1507                 &quot;sia3 -ext sia:critical=ts:email:ts@ca.com&quot;);
1508 
1509         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
1510         class CheckSia {
1511             void check(KeyStore ks, String alias, int type, Object... items)
1512                     throws Exception {
1513                 int pos = 0;
1514                 System.err.print(&quot;x&quot;);
1515                 AccessDescription[] ads = null;
1516                 if (type == 0) {
1517                     SubjectInfoAccessExtension siae = (SubjectInfoAccessExtension)
1518                             ((X509CertImpl)ks.getCertificate(alias))
1519                             .getExtension(PKIXExtensions.SubjectInfoAccess_Id);
1520                     ads = siae.getAccessDescriptions()
1521                             .toArray(new AccessDescription[0]);
1522                 } else {
1523                     AuthorityInfoAccessExtension aiae =
1524                             (AuthorityInfoAccessExtension)
1525                             ((X509CertImpl)ks.getCertificate(alias))
1526                             .getExtension(PKIXExtensions.AuthInfoAccess_Id);
1527                     ads = aiae.getAccessDescriptions()
1528                             .toArray(new AccessDescription[0]);
1529                 }
1530                 Arrays.sort(ads, new Comparator&lt;AccessDescription&gt;() {
1531                     @Override
1532                     public int compare(AccessDescription o1,
1533                                        AccessDescription o2) {
1534                         return o1.getAccessMethod().toString()
1535                                 .compareTo(o2.getAccessMethod().toString());
1536                     }
1537                 });
1538                 for (AccessDescription ad: ads) {
1539                     if (!ad.getAccessMethod().equals(items[pos++]) ||
1540                             !new Integer(ad.getAccessLocation().getType())
1541                                     .equals(items[pos++])) {
1542                         throw new RuntimeException(&quot;Not same type at &quot; + pos);
1543                     }
1544                     String name = null;
1545                     switch (ad.getAccessLocation().getType()) {
1546                         case 1:
1547                             name = ((RFC822Name)ad.getAccessLocation()
1548                                     .getName()).getName();
1549                             break;
1550                         case 6:
1551                             name = ((URIName)ad.getAccessLocation()
1552                                     .getName()).getURI().toString();
1553                             break;
1554                         default:
1555                             throw new RuntimeException(&quot;Not implemented: &quot; + ad);
1556                     }
1557                     if (!name.equals(items[pos++])) {
1558                         throw new Exception(&quot;Name not same for &quot; + ad +
1559                                 &quot; at pos &quot; + pos);
1560                     }
1561                 }
1562             }
1563         }
1564         CheckSia csia = new CheckSia();
1565         assertTrue(!((X509CertImpl)ks.getCertificate(&quot;sia1&quot;))
1566                 .getExtension(PKIXExtensions.SubjectInfoAccess_Id).isCritical());
1567         csia.check(ks, &quot;sia1&quot;, 0,
1568                 AccessDescription.Ad_CAREPOSITORY_Id, 6, &quot;ldap://ca.com/cn=CA&quot;);
1569         csia.check(ks, &quot;sia2&quot;,
1570                 0, AccessDescription.Ad_TIMESTAMPING_Id, 1, &quot;ts@ca.com&quot;);
1571 
1572         // AIA
1573         testOK(&quot;&quot;, pre+&quot;aia1 -ext aia=cai:uri:ldap://ca.com/cn=CA&quot;);
1574         testOK(&quot;&quot;, pre+&quot;aia2 -ext aia=ocsp:email:ocsp@ca.com&quot;);
1575         testFail(&quot;AIA never critical&quot;, pre +
1576                 &quot;aia3 -ext aia:critical=ts:email:ts@ca.com&quot;);
1577 
1578         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
1579         assertTrue(!((X509CertImpl)ks.getCertificate(&quot;aia1&quot;))
1580                 .getExtension(PKIXExtensions.AuthInfoAccess_Id).isCritical());
1581         csia.check(ks, &quot;aia1&quot;, 1,
1582                 AccessDescription.Ad_CAISSUERS_Id, 6, &quot;ldap://ca.com/cn=CA&quot;);
1583         csia.check(ks, &quot;aia2&quot;, 1,
1584                 AccessDescription.Ad_OCSP_Id, 1, &quot;ocsp@ca.com&quot;);
1585 
1586         // OID
1587         testOK(&quot;&quot;, pre+&quot;oid1 -ext 1.2.3:critical=0102&quot;);
1588         testOK(&quot;&quot;, pre+&quot;oid2 -ext 1.2.3&quot;);
1589         testOK(&quot;&quot;, pre+&quot;oid12 -ext 1.2.3 -ext 1.2.4=01:02:03&quot;);
1590 
1591         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
1592         class CheckOid {
1593             void check(KeyStore ks, String alias, String oid, byte[] value)
1594                     throws Exception {
1595                 int pos = 0;
1596                 System.err.print(&quot;x&quot;);
1597                 Extension ex = ((X509CertImpl)ks.getCertificate(alias))
1598                         .getExtension(ObjectIdentifier.of(oid));
1599                 if (!Arrays.equals(value, ex.getValue())) {
1600                     throw new RuntimeException(&quot;Not same content in &quot; +
1601                             alias + &quot; for &quot; + oid);
1602                 }
1603             }
1604         }
1605         CheckOid coid = new CheckOid();
1606         assertTrue(((X509CertImpl)ks.getCertificate(&quot;oid1&quot;))
1607                 .getExtension(ObjectIdentifier.of(&quot;1.2.3&quot;)).isCritical());
1608         assertTrue(!((X509CertImpl)ks.getCertificate(&quot;oid2&quot;))
1609                 .getExtension(ObjectIdentifier.of(&quot;1.2.3&quot;)).isCritical());
1610         coid.check(ks, &quot;oid1&quot;, &quot;1.2.3&quot;, new byte[]{1,2});
1611         coid.check(ks, &quot;oid2&quot;, &quot;1.2.3&quot;, new byte[]{});
1612         coid.check(ks, &quot;oid12&quot;, &quot;1.2.3&quot;, new byte[]{});
1613         coid.check(ks, &quot;oid12&quot;, &quot;1.2.4&quot;, new byte[]{1,2,3});
1614 
1615         // honored
1616         testOK(&quot;&quot;, pre+&quot;ca&quot;);
1617         testOK(&quot;&quot;, pre+&quot;a&quot;);
1618         // request: BC,KU,1.2.3,1.2.4,1.2.5
1619         testOK(&quot;&quot;, simple+&quot;-alias a -certreq &quot; +
1620                 &quot;-ext BC=1 -ext KU=crl &quot; +
1621                 &quot;-ext 1.2.3=01 -ext 1.2.4:critical=0102 -ext 1.2.5=010203 &quot; +
1622                 &quot;-rfc -file test.req&quot;);
1623         // printcertreq
1624         testOK(&quot;&quot;, &quot;-printcertreq -file test.req&quot;);
1625         checkPem(&quot;test.req&quot;);
1626         // issue: deny KU, change criticality of 1.2.3 and 1.2.4,
1627         // change content of BC, add 2.3.4
1628         testOK(&quot;&quot;, simple+&quot;-gencert -alias ca -infile test.req -ext &quot; +
1629                 &quot;honored=all,-KU,1.2.3:critical,1.2.4:non-critical &quot; +
1630                 &quot;-ext BC=2 -ext 2.3.4=01020304 &quot; +
1631                 &quot;-debug -rfc -outfile test.cert&quot;);
1632         checkPem(&quot;test.cert&quot;);
1633         testOK(&quot;&quot;, simple+&quot;-importcert -file test.cert -alias a&quot;);
1634         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
1635         X509CertImpl a = (X509CertImpl)ks.getCertificate(&quot;a&quot;);
1636         assertTrue(a.getAuthorityKeyIdentifierExtension() != null);
1637         assertTrue(a.getSubjectKeyIdentifierExtension() != null);
1638         assertTrue(a.getKeyUsage() == null);
1639         assertTrue(a.getExtension(ObjectIdentifier.of(&quot;1.2.3&quot;)).isCritical());
1640         assertTrue(!a.getExtension(ObjectIdentifier.of(&quot;1.2.4&quot;)).isCritical());
1641         assertTrue(!a.getExtension(ObjectIdentifier.of(&quot;1.2.5&quot;)).isCritical());
1642         assertTrue(a.getExtensionValue(&quot;1.2.3&quot;).length == 3);
1643         assertTrue(a.getExtensionValue(&quot;1.2.4&quot;).length == 4);
1644         assertTrue(a.getExtensionValue(&quot;1.2.5&quot;).length == 5);
1645         assertTrue(a.getBasicConstraints() == 2);
1646         assertTrue(!a.getExtension(ObjectIdentifier.of(&quot;2.3.4&quot;)).isCritical());
1647         assertTrue(a.getExtensionValue(&quot;2.3.4&quot;).length == 6);
1648 
1649         // 8073181: keytool -ext honored not working correctly
1650         testOK(&quot;&quot;, simple+&quot;-gencert -alias ca -infile test.req -ext &quot; +
1651                 &quot;honored=1.2.3,KU,1.2.4:critical &quot; +
1652                 &quot;-debug -rfc -outfile test2.cert&quot;);
1653         testOK(&quot;&quot;, simple+&quot;-importcert -file test2.cert -alias b&quot;);
1654         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
1655         X509CertImpl b = (X509CertImpl)ks.getCertificate(&quot;b&quot;);
1656         assertTrue(!b.getExtension(ObjectIdentifier.of(&quot;1.2.3&quot;)).isCritical());
1657         assertTrue(b.getExtension(ObjectIdentifier.of(&quot;1.2.4&quot;)).isCritical());
1658 
1659         // 8073182: keytool may generate duplicate extensions
1660         testOK(&quot;&quot;, pre+&quot;dup -ext bc=2 -ext 2.5.29.19=30030101FF -ext bc=3&quot;);
1661         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
1662         X509CertImpl dup = (X509CertImpl)ks.getCertificate(&quot;dup&quot;);
1663         assertTrue(dup.getBasicConstraints() == 3);
1664 
1665         remove(&quot;x.jks&quot;);
1666         remove(&quot;test.req&quot;);
1667         remove(&quot;test.cert&quot;);
1668     }
1669 
1670     void i18nTest() throws Exception {
1671         //   1.  keytool -help
1672         remove(&quot;x.jks&quot;);
1673         testOK(&quot;&quot;, &quot;-help&quot;);
1674 
1675         //   2. keytool -genkey -keyalg DSA -v -keysize 512 Enter &quot;a&quot; for the keystore
1676         // password. Check error (password too short). Enter &quot;password&quot; for
1677         // the keystore password. Hit &#39;return&#39; for &quot;first and last name&quot;,
1678         // &quot;organizational unit&quot;, &quot;City&quot;, &quot;State&quot;, and &quot;Country Code&quot;.
1679         // Type &quot;yes&quot; when they ask you if everything is correct.
1680         // Type &#39;return&#39; for new key password.
1681         testOK(&quot;a\npassword\npassword\nMe\nHere\nNow\nPlace\nPlace\nUS\nyes\n\n&quot;,
1682                 &quot;-genkey -keyalg DSA -v -keysize 512 -keystore x.jks -storetype JKS&quot;);
1683         //   3. keytool -list -v -storepass password
1684         testOK(&quot;&quot;, &quot;-list -v -storepass password -keystore x.jks -storetype JKS&quot;);
1685         //   4. keytool -list -v Type &quot;a&quot; for the keystore password.
1686         // Check error (wrong keystore password).
1687         testFail(&quot;a\n&quot;, &quot;-list -v -keystore x.jks -storetype JKS&quot;);
1688         assertTrue(ex.indexOf(&quot;password was incorrect&quot;) != -1);
1689         //   5. keytool - -keyalg DSA -v -keysize 512 Enter &quot;password&quot; as the password.
1690         // Check error (alias &#39;mykey&#39; already exists).
1691         testFail(&quot;password\n&quot;, &quot;-genkey -keyalg DSA -v -keysize 512&quot; +
1692                 &quot; -keystore x.jks -storetype JKS&quot;);
1693         assertTrue(ex.indexOf(&quot;alias &lt;mykey&gt; already exists&quot;) != -1);
1694         //   6. keytool -genkey -keyalg DSA -v -keysize 512 -alias mykey2 -storepass password
1695         // Hit &#39;return&#39; for &quot;first and last name&quot;, &quot;organizational unit&quot;, &quot;City&quot;,
1696         // &quot;State&quot;, and &quot;Country Code&quot;. Type &quot;yes&quot; when they ask you if
1697         // everything is correct. Type &#39;return&#39; for new key password.
1698         testOK(&quot;\n\n\n\n\n\nyes\n\n&quot;, &quot;-genkey -keyalg DSA -v -keysize 512 -alias mykey2&quot; +
1699                 &quot; -storepass password -keystore x.jks -storetype JKS&quot;);
1700         //   7. keytool -list -v Type &#39;password&#39; for the store password.
1701         testOK(&quot;password\n&quot;, &quot;-list -v -keystore x.jks -storetype JKS&quot;);
1702         //   8. keytool -keypasswd -v -alias mykey2 -storepass password
1703         // Type &quot;a&quot; for the new key password. Type &quot;aaaaaa&quot; for the new key
1704         // password. Type &quot;bbbbbb&quot; when re-entering the new key password.
1705         // Type &quot;a&quot; for the new key password. Check Error (too many failures).
1706         testFail(&quot;a\naaaaaa\nbbbbbb\na\n&quot;, &quot;-keypasswd -v -alias mykey2&quot; +
1707                 &quot; -storepass password -keystore x.jks -storetype JKS&quot;);
1708         assertTrue(ex.indexOf(&quot;Too many failures - try later&quot;) != -1);
1709         //   9. keytool -keypasswd -v -alias mykey2 -storepass password
1710         // Type &quot;aaaaaa&quot; for the new key password. Type &quot;aaaaaa&quot;
1711         // when re-entering the new key password.
1712         testOK(&quot;aaaaaa\naaaaaa\n&quot;, &quot;-keypasswd -v -alias mykey2 &quot; +
1713                 &quot;-storepass password -keystore x.jks -storetype JKS&quot;);
1714         //  10. keytool -selfcert -v -alias mykey -storepass password
1715         testOK(&quot;&quot;, &quot;-selfcert -v -alias mykey -storepass password &quot; +
1716                 &quot;-keystore x.jks -storetype JKS&quot;);
1717         //  11. keytool -list -v -storepass password
1718         testOK(&quot;&quot;, &quot;-list -v -storepass password -keystore x.jks -storetype JKS&quot;);
1719         //  12. keytool -export -v -alias mykey -file cert -storepass password
1720         remove(&quot;cert&quot;);
1721         testOK(&quot;&quot;, &quot;-export -v -alias mykey -file cert -storepass password &quot; +
1722                 &quot;-keystore x.jks -storetype JKS&quot;);
1723         //  13. keytool -import -v -file cert -storepass password
1724         // Check error (Certificate reply and cert are the same)
1725         testFail(&quot;&quot;, &quot;-import -v -file cert -storepass password&quot; +
1726                 &quot; -keystore x.jks -storetype JKS&quot;);
1727         assertTrue(ex.indexOf(&quot;Certificate reply and certificate&quot; +
1728                 &quot; in keystore are identical&quot;) != -1);
1729         //  14. keytool -printcert -file cert
1730         testOK(&quot;&quot;, &quot;-printcert -file cert -keystore x.jks -storetype JKS&quot;);
1731         remove(&quot;cert&quot;);
1732         //  15. keytool -list -storepass password -addprovider SUN
1733         testOK(&quot;&quot;, &quot;-list -storepass password&quot; +
1734                 &quot; -addprovider SUN&quot; +
1735                 &quot; -keystore x.jks -storetype JKS&quot;);
1736 
1737         //Error tests
1738 
1739         //   1. keytool -storepasswd -storepass password -new abc
1740         // Check error (password too short)
1741         testFail(&quot;&quot;, &quot;-storepasswd -storepass password -new abc&quot;);
1742         assertTrue(ex.indexOf(&quot;New password must be at least 6 characters&quot;) != -1);
1743         // Changed, no NONE needed now
1744         //   2. keytool -list -storetype PKCS11 Check error (-keystore must be NONE)
1745         //testFail(&quot;&quot;, &quot;-list -storetype PKCS11&quot;);
1746         //assertTrue(err.indexOf(&quot;keystore must be NONE&quot;) != -1);
1747         //   3. keytool -storepasswd -storetype PKCS11 -keystore NONE
1748         // Check error (unsupported operation)
1749         testFail(&quot;&quot;, &quot;-storepasswd -storetype PKCS11 -keystore NONE&quot;);
1750         assertTrue(ex.indexOf(&quot;UnsupportedOperationException&quot;) != -1);
1751         //   4. keytool -keypasswd -storetype PKCS11 -keystore NONE
1752         // Check error (unsupported operation)
1753         testFail(&quot;&quot;, &quot;-keypasswd -storetype PKCS11 -keystore NONE&quot;);
1754         assertTrue(ex.indexOf(&quot;UnsupportedOperationException&quot;) != -1);
1755         //   5. keytool -list -protected -storepass password
1756         // Check error (password can not be specified with -protected)
1757         testFail(&quot;&quot;, &quot;-list -protected -storepass password &quot; +
1758                 &quot;-keystore x.jks -storetype JKS&quot;);
1759         assertTrue(ex.indexOf(&quot;if -protected is specified, then&quot;) != -1);
1760         //   6. keytool -keypasswd -protected -keypass password
1761         // Check error (password can not be specified with -protected)
1762         testFail(&quot;&quot;, &quot;-keypasswd -protected -keypass password &quot; +
1763                 &quot;-keystore x.jks -storetype JKS&quot;);
1764         assertTrue(ex.indexOf(&quot;if -protected is specified, then&quot;) != -1);
1765         //   7. keytool -keypasswd -protected -new password
1766         // Check error (password can not be specified with -protected)
1767         testFail(&quot;&quot;, &quot;-keypasswd -protected -new password &quot; +
1768                 &quot;-keystore x.jks -storetype JKS&quot;);
1769         assertTrue(ex.indexOf(&quot;if -protected is specified, then&quot;) != -1);
1770         remove(&quot;x.jks&quot;);
1771     }
1772 
1773     void i18nPKCS11Test() throws Exception {
1774         //PKCS#11 tests
1775 
1776         //   1. sccs edit cert8.db key3.db
1777         //Runtime.getRuntime().exec(&quot;/usr/bin/sccs edit cert8.db key3.db&quot;);
1778         testOK(&quot;&quot;, p11Arg + (&quot;-storepass test12 -genkey -alias genkey&quot; +
1779                 &quot; -dname cn=genkey -keysize 512 -keyalg rsa&quot;));
1780         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -list&quot;);
1781         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -list -alias genkey&quot;);
1782         testOK(&quot;&quot;, p11Arg +
1783                 &quot;-storepass test12 -certreq -alias genkey -file genkey.certreq&quot;);
1784         testOK(&quot;&quot;, p11Arg +
1785                 &quot;-storepass test12 -export -alias genkey -file genkey.cert&quot;);
1786         testOK(&quot;&quot;, &quot;-printcert -file genkey.cert&quot;);
1787         testOK(&quot;&quot;, p11Arg +
1788                 &quot;-storepass test12 -selfcert -alias genkey -dname cn=selfCert&quot;);
1789         testOK(&quot;&quot;, p11Arg +
1790                 &quot;-storepass test12 -list -alias genkey -v&quot;);
1791         assertTrue(out.indexOf(&quot;Owner: CN=selfCert&quot;) != -1);
1792         //(check that cert subject DN is [cn=selfCert])
1793         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -delete -alias genkey&quot;);
1794         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -list&quot;);
1795         assertTrue(out.indexOf(&quot;Your keystore contains 0 entries&quot;) != -1);
1796         //(check for empty database listing)
1797         //Runtime.getRuntime().exec(&quot;/usr/bin/sccs unedit cert8.db key3.db&quot;);
1798         remove(&quot;genkey.cert&quot;);
1799         remove(&quot;genkey.certreq&quot;);
1800         //  12. sccs unedit cert8.db key3.db
1801     }
1802 
1803     // tesing new option -srcProviderName
1804     void sszzTest() throws Exception {
1805         testAnyway(&quot;&quot;, NSS_P11_ARG+&quot;-delete -alias nss -storepass test12&quot;);
1806         testAnyway(&quot;&quot;, NZZ_P11_ARG+&quot;-delete -alias nss -storepass test12&quot;);
1807         testOK(&quot;&quot;, NSS_P11_ARG+&quot;-genkeypair -keyalg DSA -dname CN=NSS &quot; +
1808                 &quot;-alias nss -storepass test12&quot;);
1809         testOK(&quot;&quot;, NSS_SRC_P11_ARG + NZZ_P11_ARG +
1810                 &quot;-importkeystore -srcstorepass test12 -deststorepass test12&quot;);
1811         testAnyway(&quot;&quot;, NSS_P11_ARG+&quot;-delete -alias nss -storepass test12&quot;);
1812         testAnyway(&quot;&quot;, NZZ_P11_ARG+&quot;-delete -alias nss -storepass test12&quot;);
1813     }
1814 
1815     public static void main(String[] args) throws Exception {
1816         Locale reservedLocale = Locale.getDefault();
1817         try {
1818             // first test if HumanInputStream really acts like a human being
1819             HumanInputStream.test();
1820             KeyToolTest t = new KeyToolTest();
1821 
1822             if (System.getProperty(&quot;file&quot;) != null) {
1823                 t.sqeTest();
1824                 t.testAll();
1825                 t.i18nTest();
1826                 t.v3extTest(&quot;RSA&quot;);
1827                 t.v3extTest(&quot;DSA&quot;);
1828                 boolean testEC = true;
1829                 try {
1830                     KeyPairGenerator.getInstance(&quot;EC&quot;);
1831                 } catch (NoSuchAlgorithmException nae) {
1832                     testEC = false;
1833                 }
1834                 if (testEC) t.v3extTest(&quot;EC&quot;);
1835             }
1836 
1837             if (System.getProperty(&quot;nss&quot;) != null) {
1838                 t.srcP11Arg = NSS_SRC_P11_ARG;
1839                 t.p11Arg = NSS_P11_ARG;
1840 
1841                 t.testPKCS11();
1842 
1843                 // FAIL:
1844                 // 1. we still don&#39;t have srcprovidername yet
1845                 // 2. cannot store privatekey into NSS keystore
1846                 //    java.security.KeyStoreException: sun.security.pkcs11
1847                 //      .wrapper.PKCS11Exception: CKR_TEMPLATE_INCOMPLETE.
1848                 //t.testPKCS11ImportKeyStore();
1849 
1850                 t.i18nPKCS11Test();
1851                 //FAIL: currently PKCS11-NSS does not support
1852                 // 2 NSS KeyStores to be loaded at the same time
1853                 //t.sszzTest();
1854             }
1855 
<a name="3" id="anc3"></a>








1856             System.out.println(&quot;Test pass!!!&quot;);
1857         } finally {
1858             // restore the reserved locale
1859             Locale.setDefault(reservedLocale);
1860         }
1861     }
1862 }
1863 
1864 class TestException extends Exception {
1865     public TestException(String e) {
1866         super(e);
1867     }
1868 }
1869 
1870 /**
1871  * HumanInputStream tries to act like a human sitting in front of a computer
1872  * terminal typing on the keyboard while the keytool program is running.
1873  *
1874  * keytool has called InputStream.read() and BufferedReader.readLine() in
1875  * various places. a call to B.readLine() will try to buffer as much input as
1876  * possible. Thus, a trivial InputStream will find it impossible to feed
1877  * anything to I.read() after a B.readLine() call.
1878  *
1879  * This is why i create HumanInputStream, which will only send a single line
1880  * to B.readLine(), no more, no less, and the next I.read() can have a chance
1881  * to read the exact character right after &quot;\n&quot;.
1882  *
1883  * I don&#39;t know why HumanInputStream works.
1884  */
1885 class HumanInputStream extends InputStream {
1886     byte[] src;
1887     int pos;
1888     int length;
1889     boolean inLine;
1890     int stopIt;
1891 
1892     public HumanInputStream(String input) {
1893         src = input.getBytes();
1894         pos = 0;
1895         length = src.length;
1896         stopIt = 0;
1897         inLine = false;
1898     }
1899 
1900     // the trick: when called through read(byte[], int, int),
1901     // return -1 twice after &quot;\n&quot;
1902 
1903     @Override public int read() throws IOException {
1904         int re;
1905         if(pos &lt; length) {
1906             re = src[pos];
1907             if(inLine) {
1908                 if(stopIt &gt; 0) {
1909                     stopIt--;
1910                     re = -1;
1911                 } else {
1912                     if(re == &#39;\n&#39;) {
1913                         stopIt = 2;
1914                     }
1915                     pos++;
1916                 }
1917             } else {
1918                 pos++;
1919             }
1920         } else {
1921             re = -1;//throw new IOException(&quot;NO MORE TO READ&quot;);
1922         }
1923         //if (re &lt; 32) System.err.printf(&quot;[%02d]&quot;, re);
1924         //else System.err.printf(&quot;[%c]&quot;, (char)re);
1925         return re;
1926     }
1927     @Override public int read(byte[] buffer, int offset, int len) {
1928         inLine = true;
1929         try {
1930             int re = super.read(buffer, offset, len);
1931             return re;
1932         } catch(Exception e) {
1933             throw new RuntimeException(&quot;HumanInputStream error&quot;);
1934         } finally {
1935             inLine = false;
1936         }
1937     }
1938     @Override public int available() {
1939         if(pos &lt; length) return 1;
1940         return 0;
1941     }
1942 
1943     // test part
1944     static void assertTrue(boolean bool) {
1945         if(!bool)
1946             throw new RuntimeException();
1947     }
1948 
1949     public static void test() throws Exception {
1950 
1951         class Tester {
1952             HumanInputStream is;
1953             BufferedReader reader;
1954             Tester(String s) {
1955                 is = new HumanInputStream(s);
1956                 reader = new BufferedReader(new InputStreamReader(is));
1957             }
1958 
1959             // three kinds of test method
1960             // 1. read byte by byte from InputStream
1961             void testStreamReadOnce(int expection) throws Exception {
1962                 assertTrue(is.read() == expection);
1963             }
1964             void testStreamReadMany(String expection) throws Exception {
1965                 char[] keys = expection.toCharArray();
1966                 for(int i=0; i&lt;keys.length; i++) {
1967                     assertTrue(is.read() == keys[i]);
1968                 }
1969             }
1970             // 2. read a line with a newly created Reader
1971             void testReaderReadline(String expection) throws Exception {
1972                 String s = new BufferedReader(new InputStreamReader(is)).readLine();
1973                 if(s == null) assertTrue(expection == null);
1974                 else assertTrue(s.equals(expection));
1975             }
1976             // 3. read a line with the old Reader
1977             void testReaderReadline2(String expection) throws Exception  {
1978                 String s = reader.readLine();
1979                 if(s == null) assertTrue(expection == null);
1980                 else assertTrue(s.equals(expection));
1981             }
1982         }
1983 
1984         Tester test;
1985 
1986         test = new Tester(&quot;111\n222\n\n444\n\n&quot;);
1987         test.testReaderReadline(&quot;111&quot;);
1988         test.testReaderReadline(&quot;222&quot;);
1989         test.testReaderReadline(&quot;&quot;);
1990         test.testReaderReadline(&quot;444&quot;);
1991         test.testReaderReadline(&quot;&quot;);
1992         test.testReaderReadline(null);
1993 
1994         test = new Tester(&quot;111\n222\n\n444\n\n&quot;);
1995         test.testReaderReadline2(&quot;111&quot;);
1996         test.testReaderReadline2(&quot;222&quot;);
1997         test.testReaderReadline2(&quot;&quot;);
1998         test.testReaderReadline2(&quot;444&quot;);
1999         test.testReaderReadline2(&quot;&quot;);
2000         test.testReaderReadline2(null);
2001 
2002         test = new Tester(&quot;111\n222\n\n444\n\n&quot;);
2003         test.testReaderReadline2(&quot;111&quot;);
2004         test.testReaderReadline(&quot;222&quot;);
2005         test.testReaderReadline2(&quot;&quot;);
2006         test.testReaderReadline2(&quot;444&quot;);
2007         test.testReaderReadline(&quot;&quot;);
2008         test.testReaderReadline2(null);
2009 
2010         test = new Tester(&quot;1\n2&quot;);
2011         test.testStreamReadMany(&quot;1\n2&quot;);
2012         test.testStreamReadOnce(-1);
2013 
2014         test = new Tester(&quot;12\n234&quot;);
2015         test.testStreamReadOnce(&#39;1&#39;);
2016         test.testReaderReadline(&quot;2&quot;);
2017         test.testStreamReadOnce(&#39;2&#39;);
2018         test.testReaderReadline2(&quot;34&quot;);
2019         test.testReaderReadline2(null);
2020 
2021         test = new Tester(&quot;changeit\n&quot;);
2022         test.testStreamReadMany(&quot;changeit\n&quot;);
2023         test.testReaderReadline(null);
2024 
2025         test = new Tester(&quot;changeit\nName\nCountry\nYes\n&quot;);
2026         test.testStreamReadMany(&quot;changeit\n&quot;);
2027         test.testReaderReadline(&quot;Name&quot;);
2028         test.testReaderReadline(&quot;Country&quot;);
2029         test.testReaderReadline(&quot;Yes&quot;);
2030         test.testReaderReadline(null);
2031 
2032         test = new Tester(&quot;Me\nHere\n&quot;);
2033         test.testReaderReadline2(&quot;Me&quot;);
2034         test.testReaderReadline2(&quot;Here&quot;);
2035     }
2036 }
<a name="4" id="anc4"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="4" type="hidden" />
</body>
</html>