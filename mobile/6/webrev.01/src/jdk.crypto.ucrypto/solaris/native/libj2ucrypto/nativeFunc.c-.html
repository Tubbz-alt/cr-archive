<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old src/jdk.crypto.ucrypto/solaris/native/libj2ucrypto/nativeFunc.c</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2014, 2016, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 #include &lt;jni.h&gt;
 27 #include &lt;stdio.h&gt;
 28 #include &lt;stdlib.h&gt;
 29 #include &lt;dlfcn.h&gt;
 30 #include &lt;link.h&gt;
 31 #include &quot;nativeFunc.h&quot;
 32 
 33 /* standard md5/md/softcrypto method names (ordering is from mapfile) */
 34 static const char MD5_INIT[]                     = &quot;MD5Init&quot;;
 35 static const char MD5_UPDATE[]                   = &quot;MD5Update&quot;;
 36 static const char MD5_FINAL[]                    = &quot;MD5Final&quot;;
 37 static const char SHA1_INIT[]                    = &quot;SHA1Init&quot;;
 38 static const char SHA1_UPDATE[]                  = &quot;SHA1Update&quot;;
 39 static const char SHA1_FINAL[]                   = &quot;SHA1Final&quot;;
 40 static const char SHA2_INIT[]                    = &quot;SHA2Init&quot;;
 41 static const char SHA2_UPDATE[]                  = &quot;SHA2Update&quot;;
 42 static const char SHA2_FINAL[]                   = &quot;SHA2Final&quot;;
 43 static const char UCRYPTO_VERSION[]              = &quot;ucrypto_version&quot;;
 44 static const char UCRYPTO_GET_MECHLIST[]         = &quot;ucrypto_get_mechlist&quot;;
 45 
 46 static const char UCRYPTO_ENCRYPT_INIT[]         = &quot;ucrypto_encrypt_init&quot;;
 47 static const char UCRYPTO_ENCRYPT_UPDATE[]       = &quot;ucrypto_encrypt_update&quot;;
 48 static const char UCRYPTO_ENCRYPT_FINAL[]        = &quot;ucrypto_encrypt_final&quot;;
 49 static const char UCRYPTO_ENCRYPT[]              = &quot;ucrypto_encrypt&quot;;
 50 
 51 static const char UCRYPTO_DECRYPT_INIT[]         = &quot;ucrypto_decrypt_init&quot;;
 52 static const char UCRYPTO_DECRYPT_UPDATE[]       = &quot;ucrypto_decrypt_update&quot;;
 53 static const char UCRYPTO_DECRYPT_FINAL[]        = &quot;ucrypto_decrypt_final&quot;;
 54 static const char UCRYPTO_DECRYPT[]              = &quot;ucrypto_decrypt&quot;;
 55 
 56 static const char UCRYPTO_SIGN_INIT[]            = &quot;ucrypto_sign_init&quot;;
 57 static const char UCRYPTO_SIGN_UPDATE[]          = &quot;ucrypto_sign_update&quot;;
 58 static const char UCRYPTO_SIGN_FINAL[]           = &quot;ucrypto_sign_final&quot;;
 59 
 60 static const char UCRYPTO_VERIFY_INIT[]          = &quot;ucrypto_verify_init&quot;;
 61 static const char UCRYPTO_VERIFY_UPDATE[]        = &quot;ucrypto_verify_update&quot;;
 62 static const char UCRYPTO_VERIFY_FINAL[]         = &quot;ucrypto_verify_final&quot;;
 63 
 64 static const char UCRYPTO_DIGEST_INIT[]          = &quot;ucrypto_digest_init&quot;;
 65 static const char UCRYPTO_DIGEST_UPDATE[]        = &quot;ucrypto_digest_update&quot;;
 66 static const char UCRYPTO_DIGEST_FINAL[]         = &quot;ucrypto_digest_final&quot;;
 67 
 68 static const char UCRYPTO_FREE_CONTEXT[]         = &quot;ucrypto_free_context&quot;;
 69 
 70 static const char UCRYPTO_STRERROR[]             = &quot;ucrypto_strerror&quot;;
 71 
 72 /**
 73  * Initialize native T4 crypto function pointers
 74  */
 75 jboolean* loadNative() {
 76 
 77   jboolean* buf;
 78   void *lib;
 79 
 80   buf = malloc(2 * sizeof(jboolean));
 81   buf[0] = buf[1] = JNI_FALSE;
 82   ftab = (T4CRYPTO_FUNCTION_TABLE_PTR) calloc(1, sizeof(T4CRYPTO_FUNCTION_TABLE));
 83   if (ftab == NULL) {
 84     free(buf);
 85     return NULL;
 86   }
 87 
 88   lib = dlopen(&quot;libsoftcrypto.so&quot;, RTLD_NOW);
 89   if (lib != NULL) {
 90     // These APIs aren&#39;t available for v0 lib on Solaris 10
 91     ftab-&gt;ucryptoVersion = (UCRYPTO_VERSION_FN_PTR)
 92       dlsym(lib, UCRYPTO_VERSION);
 93     ftab-&gt;ucryptoGetMechList = (UCRYPTO_GET_MECHLIST_FN_PTR)
 94       dlsym(lib, UCRYPTO_GET_MECHLIST);
 95     ftab-&gt;ucryptoSignInit = (UCRYPTO_SIGN_INIT_FN_PTR)
 96       dlsym(lib, UCRYPTO_SIGN_INIT);
 97     ftab-&gt;ucryptoSignUpdate = (UCRYPTO_SIGN_UPDATE_FN_PTR)
 98       dlsym(lib, UCRYPTO_SIGN_UPDATE);
 99     ftab-&gt;ucryptoSignFinal = (UCRYPTO_SIGN_FINAL_FN_PTR)
100       dlsym(lib, UCRYPTO_SIGN_FINAL);
101     ftab-&gt;ucryptoVerifyInit = (UCRYPTO_VERIFY_INIT_FN_PTR)
102       dlsym(lib, UCRYPTO_VERIFY_INIT);
103     ftab-&gt;ucryptoVerifyUpdate = (UCRYPTO_VERIFY_UPDATE_FN_PTR)
104       dlsym(lib, UCRYPTO_VERIFY_UPDATE);
105     ftab-&gt;ucryptoVerifyFinal = (UCRYPTO_VERIFY_FINAL_FN_PTR)
106       dlsym(lib, UCRYPTO_VERIFY_FINAL);
107 
108     // These APS are added starting S12
109     ftab-&gt;ucryptoDigestInit = (UCRYPTO_DIGEST_INIT_FN_PTR)
110       dlsym(lib, UCRYPTO_DIGEST_INIT);
111     ftab-&gt;ucryptoDigestUpdate = (UCRYPTO_DIGEST_UPDATE_FN_PTR)
112       dlsym(lib, UCRYPTO_DIGEST_UPDATE);
113     ftab-&gt;ucryptoDigestFinal = (UCRYPTO_DIGEST_FINAL_FN_PTR)
114       dlsym(lib, UCRYPTO_DIGEST_FINAL);
115 
116     ftab-&gt;ucryptoFreeContext = (UCRYPTO_FREE_CONTEXT_FN_PTR)
117       dlsym(lib, UCRYPTO_FREE_CONTEXT);
118 
119     ftab-&gt;ucryptoStrerror = (UCRYPTO_STRERROR_FN_PTR)
120       dlsym(lib, UCRYPTO_STRERROR);
121 
122 
123     // These should be avilable for all libsoftcrypto libs
124     ftab-&gt;ucryptoEncryptInit = (UCRYPTO_ENCRYPT_INIT_FN_PTR)
125       dlsym(lib, UCRYPTO_ENCRYPT_INIT);
126     ftab-&gt;ucryptoEncryptUpdate = (UCRYPTO_ENCRYPT_UPDATE_FN_PTR)
127       dlsym(lib, UCRYPTO_ENCRYPT_UPDATE);
128     ftab-&gt;ucryptoEncryptFinal = (UCRYPTO_ENCRYPT_FINAL_FN_PTR)
129       dlsym(lib, UCRYPTO_ENCRYPT_FINAL);
130     ftab-&gt;ucryptoEncrypt = (UCRYPTO_ENCRYPT_FN_PTR)
131       dlsym(lib, UCRYPTO_ENCRYPT);
132 
133     ftab-&gt;ucryptoDecryptInit = (UCRYPTO_DECRYPT_INIT_FN_PTR)
134       dlsym(lib, UCRYPTO_DECRYPT_INIT);
135     ftab-&gt;ucryptoDecryptUpdate = (UCRYPTO_DECRYPT_UPDATE_FN_PTR)
136       dlsym(lib, UCRYPTO_DECRYPT_UPDATE);
137     ftab-&gt;ucryptoDecryptFinal = (UCRYPTO_DECRYPT_FINAL_FN_PTR)
138       dlsym(lib, UCRYPTO_DECRYPT_FINAL);
139     ftab-&gt;ucryptoDecrypt = (UCRYPTO_DECRYPT_FN_PTR)
140       dlsym(lib, UCRYPTO_DECRYPT);
141 
142     if (ftab-&gt;ucryptoEncryptInit != NULL &amp;&amp;
143         ftab-&gt;ucryptoEncryptUpdate != NULL &amp;&amp;
144         ftab-&gt;ucryptoEncryptFinal != NULL &amp;&amp;
145         ftab-&gt;ucryptoEncrypt != NULL &amp;&amp;
146         ftab-&gt;ucryptoDecryptInit != NULL &amp;&amp;
147         ftab-&gt;ucryptoDecryptUpdate != NULL &amp;&amp;
148         ftab-&gt;ucryptoDecryptFinal != NULL &amp;&amp;
149         ftab-&gt;ucryptoDecrypt != NULL) {
150       buf[1] = JNI_TRUE;
151     } else {
152       dlclose(lib);
153     }
154 
155     // proceed with libmd when libucrypto does not support digest operations
156     if (ftab-&gt;ucryptoDigestInit == NULL ||
157         ftab-&gt;ucryptoDigestUpdate == NULL ||
158         ftab-&gt;ucryptoDigestFinal == NULL) {
159 
160       lib = dlopen(&quot;libmd.so&quot;, RTLD_NOW);
161       if (lib != NULL) {
162         ftab-&gt;md5Init = (MD5INIT_FN_PTR) dlsym(lib, MD5_INIT);
163         ftab-&gt;md5Update = (MD5UPDATE_FN_PTR) dlsym(lib, MD5_UPDATE);
164         ftab-&gt;md5Final = (MD5FINAL_FN_PTR) dlsym(lib, MD5_FINAL);
165         ftab-&gt;sha1Init = (SHA1INIT_FN_PTR) dlsym(lib, SHA1_INIT);
166         ftab-&gt;sha1Update = (SHA1UPDATE_FN_PTR) dlsym(lib, SHA1_UPDATE);
167         ftab-&gt;sha1Final = (SHA1FINAL_FN_PTR) dlsym(lib, SHA1_FINAL);
168         ftab-&gt;sha2Init = (SHA2INIT_FN_PTR) dlsym(lib, SHA2_INIT);
169         ftab-&gt;sha2Update = (SHA2UPDATE_FN_PTR) dlsym(lib, SHA2_UPDATE);
170         ftab-&gt;sha2Final = (SHA2FINAL_FN_PTR) dlsym(lib, SHA2_FINAL);
171         if (ftab-&gt;md5Init != NULL &amp;&amp; ftab-&gt;md5Update != NULL &amp;&amp;
172             ftab-&gt;md5Final != NULL &amp;&amp; ftab-&gt;sha1Init != NULL &amp;&amp;
173             ftab-&gt;sha1Update != NULL &amp;&amp; ftab-&gt;sha1Final != NULL &amp;&amp;
174             ftab-&gt;sha2Init != NULL &amp;&amp; ftab-&gt;sha2Update != NULL &amp;&amp;
175             ftab-&gt;sha2Final != NULL) {
176           buf[0] = JNI_TRUE;
177         } else {
178           dlclose(lib);
179         }
180       }
181     }
182   }
183 
184   return buf;
185 }
    </pre>
  </body>
</html>