<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/jdk.net/linux/native/libextnet/LinuxSocketOptions.c</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="../../classes/jdk/net/LinuxSocketOptions.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../../../share/classes/jdk/net/ExtendedSocketOptions.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.net/linux/native/libextnet/LinuxSocketOptions.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2017, 2018, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2017, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-old-header">*** 31,10 ***</span>
<span class="line-new-header">--- 31,43 ---</span>
  #include &lt;netinet/tcp.h&gt;
  #include &lt;netinet/in.h&gt;
  #include &quot;jni_util.h&quot;
  #include &quot;jdk_net_LinuxSocketOptions.h&quot;
  
<span class="line-added">+ #ifndef SO_INCOMING_NAPI_ID</span>
<span class="line-added">+ #define SO_INCOMING_NAPI_ID    56</span>
<span class="line-added">+ #endif</span>
<span class="line-added">+ </span>
<span class="line-added">+ static void handleError(JNIEnv *env, jint rv, const char *errmsg) {</span>
<span class="line-added">+     if (rv &lt; 0) {</span>
<span class="line-added">+         if (errno == ENOPROTOOPT) {</span>
<span class="line-added">+             JNU_ThrowByName(env, &quot;java/lang/UnsupportedOperationException&quot;,</span>
<span class="line-added">+                     &quot;unsupported socket option&quot;);</span>
<span class="line-added">+         } else {</span>
<span class="line-added">+             JNU_ThrowByNameWithLastError(env, &quot;java/net/SocketException&quot;, errmsg);</span>
<span class="line-added">+         }</span>
<span class="line-added">+     }</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ static jint socketOptionSupported(jint level, jint optname) {</span>
<span class="line-added">+     jint one = 1;</span>
<span class="line-added">+     jint rv, s;</span>
<span class="line-added">+     socklen_t sz = sizeof (one);</span>
<span class="line-added">+     s = socket(PF_INET, SOCK_STREAM, IPPROTO_TCP);</span>
<span class="line-added">+     if (s &lt; 0) {</span>
<span class="line-added">+         return 0;</span>
<span class="line-added">+     }</span>
<span class="line-added">+     rv = getsockopt(s, level, optname, (void *) &amp;one, &amp;sz);</span>
<span class="line-added">+     if (rv != 0 &amp;&amp; errno == ENOPROTOOPT) {</span>
<span class="line-added">+         rv = 0;</span>
<span class="line-added">+     } else {</span>
<span class="line-added">+         rv = 1;</span>
<span class="line-added">+     }</span>
<span class="line-added">+     close(s);</span>
<span class="line-added">+     return rv;</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
  /*
   * Declare library specific JNI_Onload entry if static build
   */
  DEF_STATIC_JNI_OnLoad
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 47,19 ***</span>
  (JNIEnv *env, jobject unused, jint fd, jboolean on) {
      int optval;
      int rv;
      optval = (on ? 1 : 0);
      rv = setsockopt(fd, SOL_SOCKET, TCP_QUICKACK, &amp;optval, sizeof (optval));
<span class="line-modified">!     if (rv &lt; 0) {</span>
<span class="line-removed">-         if (errno == ENOPROTOOPT) {</span>
<span class="line-removed">-             JNU_ThrowByName(env, &quot;java/lang/UnsupportedOperationException&quot;,</span>
<span class="line-removed">-                             &quot;unsupported socket option&quot;);</span>
<span class="line-removed">-         } else {</span>
<span class="line-removed">-             JNU_ThrowByNameWithLastError(env, &quot;java/net/SocketException&quot;,</span>
<span class="line-removed">-                                         &quot;set option TCP_QUICKACK failed&quot;);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-     }</span>
  }
  
  /*
   * Class:     jdk_net_LinuxSocketOptions
   * Method:    getQuickAck
<span class="line-new-header">--- 80,11 ---</span>
  (JNIEnv *env, jobject unused, jint fd, jboolean on) {
      int optval;
      int rv;
      optval = (on ? 1 : 0);
      rv = setsockopt(fd, SOL_SOCKET, TCP_QUICKACK, &amp;optval, sizeof (optval));
<span class="line-modified">!     handleError(env, rv, &quot;set option TCP_QUICKACK failed&quot;);</span>
  }
  
  /*
   * Class:     jdk_net_LinuxSocketOptions
   * Method:    getQuickAck
</pre>
<hr />
<pre>
<span class="line-old-header">*** 68,82 ***</span>
  JNIEXPORT jboolean JNICALL Java_jdk_net_LinuxSocketOptions_getQuickAck0
  (JNIEnv *env, jobject unused, jint fd) {
      int on;
      socklen_t sz = sizeof (on);
      int rv = getsockopt(fd, SOL_SOCKET, TCP_QUICKACK, &amp;on, &amp;sz);
<span class="line-modified">!     if (rv &lt; 0) {</span>
<span class="line-removed">-         if (errno == ENOPROTOOPT) {</span>
<span class="line-removed">-             JNU_ThrowByName(env, &quot;java/lang/UnsupportedOperationException&quot;,</span>
<span class="line-removed">-                             &quot;unsupported socket option&quot;);</span>
<span class="line-removed">-         } else {</span>
<span class="line-removed">-             JNU_ThrowByNameWithLastError(env, &quot;java/net/SocketException&quot;,</span>
<span class="line-removed">-                                         &quot;get option TCP_QUICKACK failed&quot;);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-     }</span>
      return on != 0;
  }
  
  /*
   * Class:     jdk_net_LinuxSocketOptions
   * Method:    quickAckSupported
   * Signature: ()Z
   */
  JNIEXPORT jboolean JNICALL Java_jdk_net_LinuxSocketOptions_quickAckSupported0
  (JNIEnv *env, jobject unused) {
<span class="line-modified">!     int one = 1;</span>
<span class="line-removed">-     int rv, s;</span>
<span class="line-removed">-     s = socket(PF_INET, SOCK_STREAM, 0);</span>
<span class="line-removed">-     if (s &lt; 0) {</span>
<span class="line-removed">-         return JNI_FALSE;</span>
<span class="line-removed">-     }</span>
<span class="line-removed">-     rv = setsockopt(s, SOL_SOCKET, TCP_QUICKACK, (void *) &amp;one, sizeof (one));</span>
<span class="line-removed">-     if (rv != 0 &amp;&amp; errno == ENOPROTOOPT) {</span>
<span class="line-removed">-         rv = JNI_FALSE;</span>
<span class="line-removed">-     } else {</span>
<span class="line-removed">-         rv = JNI_TRUE;</span>
<span class="line-removed">-     }</span>
<span class="line-removed">-     close(s);</span>
<span class="line-removed">-     return rv;</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
<span class="line-removed">- static jint socketOptionSupported(jint sockopt) {</span>
<span class="line-removed">-     jint one = 1;</span>
<span class="line-removed">-     jint rv, s;</span>
<span class="line-removed">-     s = socket(PF_INET, SOCK_STREAM, IPPROTO_TCP);</span>
<span class="line-removed">-     if (s &lt; 0) {</span>
<span class="line-removed">-         return 0;</span>
<span class="line-removed">-     }</span>
<span class="line-removed">-     rv = setsockopt(s, SOL_TCP, sockopt, (void *) &amp;one, sizeof (one));</span>
<span class="line-removed">-     if (rv != 0 &amp;&amp; errno == ENOPROTOOPT) {</span>
<span class="line-removed">-         rv = 0;</span>
<span class="line-removed">-     } else {</span>
<span class="line-removed">-         rv = 1;</span>
<span class="line-removed">-     }</span>
<span class="line-removed">-     close(s);</span>
<span class="line-removed">-     return rv;</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
<span class="line-removed">- static void handleError(JNIEnv *env, jint rv, const char *errmsg) {</span>
<span class="line-removed">-     if (rv &lt; 0) {</span>
<span class="line-removed">-         if (errno == ENOPROTOOPT) {</span>
<span class="line-removed">-             JNU_ThrowByName(env, &quot;java/lang/UnsupportedOperationException&quot;,</span>
<span class="line-removed">-                     &quot;unsupported socket option&quot;);</span>
<span class="line-removed">-         } else {</span>
<span class="line-removed">-             JNU_ThrowByNameWithLastError(env, &quot;java/net/SocketException&quot;, errmsg);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-     }</span>
  }
  
  /*
   * Class:     jdk_net_LinuxSocketOptions
   * Method:    keepAliveOptionsSupported0
   * Signature: ()Z
   */
  JNIEXPORT jboolean JNICALL Java_jdk_net_LinuxSocketOptions_keepAliveOptionsSupported0
  (JNIEnv *env, jobject unused) {
<span class="line-modified">!     return socketOptionSupported(TCP_KEEPIDLE) &amp;&amp; socketOptionSupported(TCP_KEEPCNT)</span>
<span class="line-modified">!             &amp;&amp; socketOptionSupported(TCP_KEEPINTVL);</span>
  }
  
  /*
   * Class:     jdk_net_LinuxSocketOptions
   * Method:    setTcpkeepAliveProbes0
<span class="line-new-header">--- 93,33 ---</span>
  JNIEXPORT jboolean JNICALL Java_jdk_net_LinuxSocketOptions_getQuickAck0
  (JNIEnv *env, jobject unused, jint fd) {
      int on;
      socklen_t sz = sizeof (on);
      int rv = getsockopt(fd, SOL_SOCKET, TCP_QUICKACK, &amp;on, &amp;sz);
<span class="line-modified">!     handleError(env, rv, &quot;get option TCP_QUICKACK failed&quot;);</span>
      return on != 0;
  }
  
  /*
   * Class:     jdk_net_LinuxSocketOptions
   * Method:    quickAckSupported
   * Signature: ()Z
   */
  JNIEXPORT jboolean JNICALL Java_jdk_net_LinuxSocketOptions_quickAckSupported0
  (JNIEnv *env, jobject unused) {
<span class="line-modified">!     return socketOptionSupported(SOL_SOCKET, TCP_QUICKACK);</span>
  }
  
  /*
   * Class:     jdk_net_LinuxSocketOptions
   * Method:    keepAliveOptionsSupported0
   * Signature: ()Z
   */
  JNIEXPORT jboolean JNICALL Java_jdk_net_LinuxSocketOptions_keepAliveOptionsSupported0
  (JNIEnv *env, jobject unused) {
<span class="line-modified">!     return socketOptionSupported(SOL_TCP, TCP_KEEPIDLE) &amp;&amp; socketOptionSupported(SOL_TCP, TCP_KEEPCNT)</span>
<span class="line-modified">!             &amp;&amp; socketOptionSupported(SOL_TCP, TCP_KEEPINTVL);</span>
  }
  
  /*
   * Class:     jdk_net_LinuxSocketOptions
   * Method:    setTcpkeepAliveProbes0
</pre>
<hr />
<pre>
<span class="line-old-header">*** 216,5 ***</span>
<span class="line-new-header">--- 192,29 ---</span>
      socklen_t sz = sizeof (optval);
      rv = getsockopt(fd, SOL_TCP, TCP_KEEPINTVL, &amp;optval, &amp;sz);
      handleError(env, rv, &quot;get option TCP_KEEPINTVL failed&quot;);
      return optval;
  }
<span class="line-added">+ </span>
<span class="line-added">+ /*</span>
<span class="line-added">+  * Class:     jdk_net_LinuxSocketOptions</span>
<span class="line-added">+  * Method:    incomingNapiIdSupported0</span>
<span class="line-added">+  * Signature: ()Z;</span>
<span class="line-added">+  */</span>
<span class="line-added">+ JNIEXPORT jboolean JNICALL Java_jdk_net_LinuxSocketOptions_incomingNapiIdSupported0</span>
<span class="line-added">+ (JNIEnv *env, jobject unused) {</span>
<span class="line-added">+     return socketOptionSupported(SOL_SOCKET, SO_INCOMING_NAPI_ID);</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ /*</span>
<span class="line-added">+  * Class:     jdk_net_LinuxSocketOptions</span>
<span class="line-added">+  * Method:    getIncomingNapiId0</span>
<span class="line-added">+  * Signature: (I)I;</span>
<span class="line-added">+  */</span>
<span class="line-added">+ JNIEXPORT jint JNICALL Java_jdk_net_LinuxSocketOptions_getIncomingNapiId0</span>
<span class="line-added">+ (JNIEnv *env, jobject unused, jint fd) {</span>
<span class="line-added">+     jint optval, rv;</span>
<span class="line-added">+     socklen_t sz = sizeof (optval);</span>
<span class="line-added">+     rv = getsockopt(fd, SOL_SOCKET, SO_INCOMING_NAPI_ID, &amp;optval, &amp;sz);</span>
<span class="line-added">+     handleError(env, rv, &quot;get option SO_INCOMING_NAPI_ID failed&quot;);</span>
<span class="line-added">+     return optval;</span>
<span class="line-added">+ }</span>
</pre>
<center><a href="../../classes/jdk/net/LinuxSocketOptions.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../../../share/classes/jdk/net/ExtendedSocketOptions.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>