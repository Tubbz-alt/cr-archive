<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.desktop/unix/native/common/awt/fontpath.c</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="X11Color.c.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../java2d/opengl/GLXGraphicsConfig.c.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/unix/native/common/awt/fontpath.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
   1 /*
<span class="line-modified">   2  * Copyright (c) 1998, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.  Oracle designates this
   8  * particular file as subject to the &quot;Classpath&quot; exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
  23  * questions.
  24  */
  25 
  26 #if defined(__linux__)
  27 #include &lt;string.h&gt;
  28 #endif /* __linux__ */
  29 #include &lt;stdio.h&gt;
  30 #include &lt;stdlib.h&gt;
  31 #include &lt;strings.h&gt;
  32 #include &lt;sys/types.h&gt;
  33 #include &lt;sys/stat.h&gt;
  34 #include &lt;sys/mman.h&gt;
  35 #include &lt;fcntl.h&gt;
  36 #include &lt;unistd.h&gt;
<span class="line-removed">  37 #ifdef __solaris__</span>
<span class="line-removed">  38 #include &lt;sys/systeminfo.h&gt;</span>
<span class="line-removed">  39 #endif</span>
  40 
  41 #include &lt;jni.h&gt;
  42 #include &lt;jni_util.h&gt;
  43 #include &lt;jvm_md.h&gt;
  44 #include &lt;sizecalc.h&gt;
  45 #ifndef HEADLESS
  46 #include &lt;X11/Xlib.h&gt;
  47 #include &lt;awt.h&gt;
  48 #else
  49 /* locks ought to be included from awt.h */
  50 #define AWT_LOCK()
  51 #define AWT_UNLOCK()
  52 #endif /* !HEADLESS */
  53 
  54 #if defined(__linux__) &amp;&amp; !defined(MAP_FAILED)
  55 #define MAP_FAILED ((caddr_t)-1)
  56 #endif
  57 
  58 #ifndef HEADLESS
  59 extern Display *awt_display;
  60 #endif /* !HEADLESS */
  61 
  62 #define FONTCONFIG_DLL_VERSIONED VERSIONED_JNI_LIB_NAME(&quot;fontconfig&quot;, &quot;1&quot;)
  63 #define FONTCONFIG_DLL JNI_LIB_NAME(&quot;fontconfig&quot;)
  64 
  65 #define MAXFDIRS 512    /* Max number of directories that contain fonts */
  66 
<span class="line-modified">  67 #if defined(__solaris__)</span>
<span class="line-removed">  68 /*</span>
<span class="line-removed">  69  * This can be set in the makefile to &quot;/usr/X11&quot; if so desired.</span>
<span class="line-removed">  70  */</span>
<span class="line-removed">  71 #ifndef OPENWINHOMELIB</span>
<span class="line-removed">  72 #define OPENWINHOMELIB &quot;/usr/openwin/lib/&quot;</span>
<span class="line-removed">  73 #endif</span>
<span class="line-removed">  74 </span>
<span class="line-removed">  75 /* This is all known Solaris X11 directories on Solaris 8, 9 and 10.</span>
<span class="line-removed">  76  * It is ordered to give precedence to TrueType directories.</span>
<span class="line-removed">  77  * It is needed if fontconfig is not installed or configured properly.</span>
<span class="line-removed">  78  */</span>
<span class="line-removed">  79 static char *fullSolarisFontPath[] = {</span>
<span class="line-removed">  80     OPENWINHOMELIB &quot;X11/fonts/TrueType&quot;,</span>
<span class="line-removed">  81     OPENWINHOMELIB &quot;locale/euro_fonts/X11/fonts/TrueType&quot;,</span>
<span class="line-removed">  82     OPENWINHOMELIB &quot;locale/iso_8859_2/X11/fonts/TrueType&quot;,</span>
<span class="line-removed">  83     OPENWINHOMELIB &quot;locale/iso_8859_5/X11/fonts/TrueType&quot;,</span>
<span class="line-removed">  84     OPENWINHOMELIB &quot;locale/iso_8859_7/X11/fonts/TrueType&quot;,</span>
<span class="line-removed">  85     OPENWINHOMELIB &quot;locale/iso_8859_8/X11/fonts/TrueType&quot;,</span>
<span class="line-removed">  86     OPENWINHOMELIB &quot;locale/iso_8859_9/X11/fonts/TrueType&quot;,</span>
<span class="line-removed">  87     OPENWINHOMELIB &quot;locale/iso_8859_13/X11/fonts/TrueType&quot;,</span>
<span class="line-removed">  88     OPENWINHOMELIB &quot;locale/iso_8859_15/X11/fonts/TrueType&quot;,</span>
<span class="line-removed">  89     OPENWINHOMELIB &quot;locale/ar/X11/fonts/TrueType&quot;,</span>
<span class="line-removed">  90     OPENWINHOMELIB &quot;locale/hi_IN.UTF-8/X11/fonts/TrueType&quot;,</span>
<span class="line-removed">  91     OPENWINHOMELIB &quot;locale/ja/X11/fonts/TT&quot;,</span>
<span class="line-removed">  92     OPENWINHOMELIB &quot;locale/ko/X11/fonts/TrueType&quot;,</span>
<span class="line-removed">  93     OPENWINHOMELIB &quot;locale/ko.UTF-8/X11/fonts/TrueType&quot;,</span>
<span class="line-removed">  94     OPENWINHOMELIB &quot;locale/KOI8-R/X11/fonts/TrueType&quot;,</span>
<span class="line-removed">  95     OPENWINHOMELIB &quot;locale/ru.ansi-1251/X11/fonts/TrueType&quot;,</span>
<span class="line-removed">  96     OPENWINHOMELIB &quot;locale/th_TH/X11/fonts/TrueType&quot;,</span>
<span class="line-removed">  97     OPENWINHOMELIB &quot;locale/zh_TW/X11/fonts/TrueType&quot;,</span>
<span class="line-removed">  98     OPENWINHOMELIB &quot;locale/zh_TW.BIG5/X11/fonts/TT&quot;,</span>
<span class="line-removed">  99     OPENWINHOMELIB &quot;locale/zh_HK.BIG5HK/X11/fonts/TT&quot;,</span>
<span class="line-removed"> 100     OPENWINHOMELIB &quot;locale/zh_CN.GB18030/X11/fonts/TrueType&quot;,</span>
<span class="line-removed"> 101     OPENWINHOMELIB &quot;locale/zh/X11/fonts/TrueType&quot;,</span>
<span class="line-removed"> 102     OPENWINHOMELIB &quot;locale/zh.GBK/X11/fonts/TrueType&quot;,</span>
<span class="line-removed"> 103     OPENWINHOMELIB &quot;X11/fonts/Type1&quot;,</span>
<span class="line-removed"> 104     OPENWINHOMELIB &quot;X11/fonts/Type1/sun&quot;,</span>
<span class="line-removed"> 105     OPENWINHOMELIB &quot;X11/fonts/Type1/sun/outline&quot;,</span>
<span class="line-removed"> 106     OPENWINHOMELIB &quot;locale/iso_8859_2/X11/fonts/Type1&quot;,</span>
<span class="line-removed"> 107     OPENWINHOMELIB &quot;locale/iso_8859_4/X11/fonts/Type1&quot;,</span>
<span class="line-removed"> 108     OPENWINHOMELIB &quot;locale/iso_8859_5/X11/fonts/Type1&quot;,</span>
<span class="line-removed"> 109     OPENWINHOMELIB &quot;locale/iso_8859_7/X11/fonts/Type1&quot;,</span>
<span class="line-removed"> 110     OPENWINHOMELIB &quot;locale/iso_8859_8/X11/fonts/Type1&quot;,</span>
<span class="line-removed"> 111     OPENWINHOMELIB &quot;locale/iso_8859_9/X11/fonts/Type1&quot;,</span>
<span class="line-removed"> 112     OPENWINHOMELIB &quot;locale/iso_8859_13/X11/fonts/Type1&quot;,</span>
<span class="line-removed"> 113     OPENWINHOMELIB &quot;locale/ar/X11/fonts/Type1&quot;,</span>
<span class="line-removed"> 114     NULL, /* terminates the list */</span>
<span class="line-removed"> 115 };</span>
<span class="line-removed"> 116 </span>
<span class="line-removed"> 117 #elif defined( __linux__)</span>
 118 /* All the known interesting locations we have discovered on
 119  * various flavors of Linux
 120  */
 121 static char *fullLinuxFontPath[] = {
 122     &quot;/usr/X11R6/lib/X11/fonts/TrueType&quot;,  /* RH 7.1+ */
 123     &quot;/usr/X11R6/lib/X11/fonts/truetype&quot;,  /* SuSE */
 124     &quot;/usr/X11R6/lib/X11/fonts/tt&quot;,
 125     &quot;/usr/X11R6/lib/X11/fonts/TTF&quot;,
 126     &quot;/usr/X11R6/lib/X11/fonts/OTF&quot;,       /* RH 9.0 (but empty!) */
 127     &quot;/usr/share/fonts/ja/TrueType&quot;,       /* RH 7.2+ */
 128     &quot;/usr/share/fonts/truetype&quot;,
 129     &quot;/usr/share/fonts/ko/TrueType&quot;,       /* RH 9.0 */
 130     &quot;/usr/share/fonts/zh_CN/TrueType&quot;,    /* RH 9.0 */
 131     &quot;/usr/share/fonts/zh_TW/TrueType&quot;,    /* RH 9.0 */
 132     &quot;/var/lib/defoma/x-ttcidfont-conf.d/dirs/TrueType&quot;, /* Debian */
 133     &quot;/usr/X11R6/lib/X11/fonts/Type1&quot;,
 134     &quot;/usr/share/fonts/default/Type1&quot;,     /* RH 9.0 */
 135     NULL, /* terminates the list */
 136 };
 137 #elif defined(_AIX)
</pre>
<hr />
<pre>
 347     pos = 0;
 348     for (i=0; i &lt; nPaths; i++) {
 349         if (x11Path[i][0] != &#39;/&#39;) {
 350             continue;
 351         }
 352         if (strstr(x11Path[i], &quot;/75dpi&quot;) != NULL) {
 353             continue;
 354         }
 355         if (strstr(x11Path[i], &quot;/100dpi&quot;) != NULL) {
 356             continue;
 357         }
 358         if (strstr(x11Path[i], &quot;/misc&quot;) != NULL) {
 359             continue;
 360         }
 361         if (strstr(x11Path[i], &quot;/Speedo&quot;) != NULL) {
 362             continue;
 363         }
 364         if (strstr(x11Path[i], &quot;.gnome&quot;) != NULL) {
 365             continue;
 366         }
<span class="line-removed"> 367 #ifdef __solaris__</span>
<span class="line-removed"> 368         if (strstr(x11Path[i], &quot;/F3/&quot;) != NULL) {</span>
<span class="line-removed"> 369             continue;</span>
<span class="line-removed"> 370         }</span>
<span class="line-removed"> 371         if (strstr(x11Path[i], &quot;bitmap&quot;) != NULL) {</span>
<span class="line-removed"> 372             continue;</span>
<span class="line-removed"> 373         }</span>
<span class="line-removed"> 374 #endif</span>
 375         fontdirs[pos] = strdup(x11Path[i]);
 376         slen = strlen(fontdirs[pos]);
 377         if (slen &gt; 0 &amp;&amp; fontdirs[pos][slen-1] == &#39;/&#39;) {
 378             fontdirs[pos][slen-1] = &#39;\0&#39;; /* null out trailing &quot;/&quot;  */
 379         }
 380         pos++;
 381     }
 382 
 383     XFreeFontPath(x11Path);
 384     if (pos == 0) {
 385         free(fontdirs);
 386         fontdirs = NULL;
 387     }
 388     return fontdirs;
 389 }
 390 
 391 
 392 #endif /* !HEADLESS */
 393 
 394 #if defined(__linux__)
</pre>
<hr />
<pre>
 504  * need to be added ito the host&#39;s font configuration database, typically
 505  * /etc/fonts/local.conf, and to ensure that directory contains a fonts.dir
 506  * NB: Fontconfig also depends heavily for performance on the host O/S
 507  * maintaining up to date caches.
 508  * This is consistent with the requirements of the desktop environments
 509  * on these OSes.
 510  * This also frees us from X11 APIs as JRE is required to function in
 511  * a &quot;headless&quot; mode where there is no Xserver.
 512  */
 513 static char *getPlatformFontPathChars(JNIEnv *env, jboolean noType1, jboolean isX11) {
 514 
 515     char **fcdirs = NULL, **x11dirs = NULL, **knowndirs = NULL, *path = NULL;
 516 
 517     /* As of 1.5 we try to use fontconfig on both Solaris and Linux.
 518      * If its not available NULL is returned.
 519      */
 520     fcdirs = getFontConfigLocations();
 521 
 522 #if defined(__linux__)
 523     knowndirs = fullLinuxFontPath;
<span class="line-removed"> 524 #elif defined(__solaris__)</span>
<span class="line-removed"> 525     knowndirs = fullSolarisFontPath;</span>
 526 #elif defined(_AIX)
 527     knowndirs = fullAixFontPath;
 528 #endif
 529     /* REMIND: this code requires to be executed when the GraphicsEnvironment
 530      * is already initialised. That is always true, but if it were not so,
 531      * this code could throw an exception and the fontpath would fail to
 532      * be initialised.
 533      */
 534 #ifndef HEADLESS
 535     if (isX11) { // The following only works in an x11 environment.
 536 #if defined(__linux__)
 537     /* There&#39;s no headless build on linux ... */
 538     if (!AWTIsHeadless()) { /* .. so need to call a function to check */
 539 #endif
 540       /* Using the X11 font path to locate font files is now a fallback
 541        * useful only if fontconfig failed, or is incomplete. So we could
 542        * remove this code completely and the consequences should be rare
 543        * and non-fatal. If this happens, then the calling Java code can
 544        * be modified to no longer require that the AWT lock (the X11GE)
 545        * be initialised prior to calling this code.
</pre>
<hr />
<pre>
 575     jstring ret;
 576     static char *ptr = NULL; /* retain result across calls */
 577 
 578     if (ptr == NULL) {
 579         ptr = getPlatformFontPathChars(env, noType1, isX11);
 580     }
 581     ret = (*env)-&gt;NewStringUTF(env, ptr);
 582     return ret;
 583 }
 584 
 585 #include &lt;dlfcn.h&gt;
 586 
 587 #include &lt;fontconfig/fontconfig.h&gt;
 588 
 589 
 590 static void* openFontConfig() {
 591 
 592     char *homeEnv;
 593     static char *homeEnvStr = &quot;HOME=&quot;; /* must be static */
 594     void* libfontconfig = NULL;
<span class="line-removed"> 595 #ifdef __solaris__</span>
<span class="line-removed"> 596 #define SYSINFOBUFSZ 8</span>
<span class="line-removed"> 597     char sysinfobuf[SYSINFOBUFSZ];</span>
<span class="line-removed"> 598 #endif</span>
 599 
 600     /* Private workaround to not use fontconfig library.
 601      * May be useful during testing/debugging
 602      */
 603     char *useFC = getenv(&quot;USE_J2D_FONTCONFIG&quot;);
 604     if (useFC != NULL &amp;&amp; !strcmp(useFC, &quot;no&quot;)) {
 605         return NULL;
 606     }
 607 
<span class="line-removed"> 608 #ifdef __solaris__</span>
<span class="line-removed"> 609     /* fontconfig is likely not properly configured on S8/S9 - skip it,</span>
<span class="line-removed"> 610      * although allow user to override this behaviour with an env. variable</span>
<span class="line-removed"> 611      * ie if USE_J2D_FONTCONFIG=yes then we skip this test.</span>
<span class="line-removed"> 612      * NB &quot;4&quot; is the length of a string which matches our patterns.</span>
<span class="line-removed"> 613      */</span>
<span class="line-removed"> 614     if (useFC == NULL || strcmp(useFC, &quot;yes&quot;)) {</span>
<span class="line-removed"> 615         if (sysinfo(SI_RELEASE, sysinfobuf, SYSINFOBUFSZ) == 4) {</span>
<span class="line-removed"> 616             if ((!strcmp(sysinfobuf, &quot;5.8&quot;) || !strcmp(sysinfobuf, &quot;5.9&quot;))) {</span>
<span class="line-removed"> 617                 return NULL;</span>
<span class="line-removed"> 618             }</span>
<span class="line-removed"> 619         }</span>
<span class="line-removed"> 620     }</span>
<span class="line-removed"> 621 #endif</span>
<span class="line-removed"> 622 </span>
 623 #if defined(_AIX)
 624     /* On AIX, fontconfig is not a standard package supported by IBM.
 625      * instead it has to be installed from the &quot;AIX Toolbox for Linux Applications&quot;
 626      * site http://www-03.ibm.com/systems/power/software/aix/linux/toolbox/alpha.html
 627      * and will be installed under /opt/freeware/lib/libfontconfig.a.
 628      * Notice that the archive contains the real 32- and 64-bit shared libraries.
 629      * We first try to load &#39;libfontconfig.so&#39; from the default library path in the
 630      * case the user has installed a private version of the library and if that
 631      * doesn&#39;t succeed, we try the version from /opt/freeware/lib/libfontconfig.a
 632      */
 633     libfontconfig = dlopen(&quot;libfontconfig.so&quot;, RTLD_LOCAL|RTLD_LAZY);
 634     if (libfontconfig == NULL) {
 635         libfontconfig = dlopen(&quot;/opt/freeware/lib/libfontconfig.a(libfontconfig.so.1)&quot;, RTLD_MEMBER|RTLD_LOCAL|RTLD_LAZY);
 636         if (libfontconfig == NULL) {
 637             return NULL;
 638         }
 639     }
 640 #else
 641     /* 64 bit sparc should pick up the right version from the lib path.
 642      * New features may be added to libfontconfig, this is expected to
</pre>
</td>
<td>
<hr />
<pre>
   1 /*
<span class="line-modified">   2  * Copyright (c) 1998, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.  Oracle designates this
   8  * particular file as subject to the &quot;Classpath&quot; exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
  23  * questions.
  24  */
  25 
  26 #if defined(__linux__)
  27 #include &lt;string.h&gt;
  28 #endif /* __linux__ */
  29 #include &lt;stdio.h&gt;
  30 #include &lt;stdlib.h&gt;
  31 #include &lt;strings.h&gt;
  32 #include &lt;sys/types.h&gt;
  33 #include &lt;sys/stat.h&gt;
  34 #include &lt;sys/mman.h&gt;
  35 #include &lt;fcntl.h&gt;
  36 #include &lt;unistd.h&gt;



  37 
  38 #include &lt;jni.h&gt;
  39 #include &lt;jni_util.h&gt;
  40 #include &lt;jvm_md.h&gt;
  41 #include &lt;sizecalc.h&gt;
  42 #ifndef HEADLESS
  43 #include &lt;X11/Xlib.h&gt;
  44 #include &lt;awt.h&gt;
  45 #else
  46 /* locks ought to be included from awt.h */
  47 #define AWT_LOCK()
  48 #define AWT_UNLOCK()
  49 #endif /* !HEADLESS */
  50 
  51 #if defined(__linux__) &amp;&amp; !defined(MAP_FAILED)
  52 #define MAP_FAILED ((caddr_t)-1)
  53 #endif
  54 
  55 #ifndef HEADLESS
  56 extern Display *awt_display;
  57 #endif /* !HEADLESS */
  58 
  59 #define FONTCONFIG_DLL_VERSIONED VERSIONED_JNI_LIB_NAME(&quot;fontconfig&quot;, &quot;1&quot;)
  60 #define FONTCONFIG_DLL JNI_LIB_NAME(&quot;fontconfig&quot;)
  61 
  62 #define MAXFDIRS 512    /* Max number of directories that contain fonts */
  63 
<span class="line-modified">  64 #if defined( __linux__)</span>


















































  65 /* All the known interesting locations we have discovered on
  66  * various flavors of Linux
  67  */
  68 static char *fullLinuxFontPath[] = {
  69     &quot;/usr/X11R6/lib/X11/fonts/TrueType&quot;,  /* RH 7.1+ */
  70     &quot;/usr/X11R6/lib/X11/fonts/truetype&quot;,  /* SuSE */
  71     &quot;/usr/X11R6/lib/X11/fonts/tt&quot;,
  72     &quot;/usr/X11R6/lib/X11/fonts/TTF&quot;,
  73     &quot;/usr/X11R6/lib/X11/fonts/OTF&quot;,       /* RH 9.0 (but empty!) */
  74     &quot;/usr/share/fonts/ja/TrueType&quot;,       /* RH 7.2+ */
  75     &quot;/usr/share/fonts/truetype&quot;,
  76     &quot;/usr/share/fonts/ko/TrueType&quot;,       /* RH 9.0 */
  77     &quot;/usr/share/fonts/zh_CN/TrueType&quot;,    /* RH 9.0 */
  78     &quot;/usr/share/fonts/zh_TW/TrueType&quot;,    /* RH 9.0 */
  79     &quot;/var/lib/defoma/x-ttcidfont-conf.d/dirs/TrueType&quot;, /* Debian */
  80     &quot;/usr/X11R6/lib/X11/fonts/Type1&quot;,
  81     &quot;/usr/share/fonts/default/Type1&quot;,     /* RH 9.0 */
  82     NULL, /* terminates the list */
  83 };
  84 #elif defined(_AIX)
</pre>
<hr />
<pre>
 294     pos = 0;
 295     for (i=0; i &lt; nPaths; i++) {
 296         if (x11Path[i][0] != &#39;/&#39;) {
 297             continue;
 298         }
 299         if (strstr(x11Path[i], &quot;/75dpi&quot;) != NULL) {
 300             continue;
 301         }
 302         if (strstr(x11Path[i], &quot;/100dpi&quot;) != NULL) {
 303             continue;
 304         }
 305         if (strstr(x11Path[i], &quot;/misc&quot;) != NULL) {
 306             continue;
 307         }
 308         if (strstr(x11Path[i], &quot;/Speedo&quot;) != NULL) {
 309             continue;
 310         }
 311         if (strstr(x11Path[i], &quot;.gnome&quot;) != NULL) {
 312             continue;
 313         }








 314         fontdirs[pos] = strdup(x11Path[i]);
 315         slen = strlen(fontdirs[pos]);
 316         if (slen &gt; 0 &amp;&amp; fontdirs[pos][slen-1] == &#39;/&#39;) {
 317             fontdirs[pos][slen-1] = &#39;\0&#39;; /* null out trailing &quot;/&quot;  */
 318         }
 319         pos++;
 320     }
 321 
 322     XFreeFontPath(x11Path);
 323     if (pos == 0) {
 324         free(fontdirs);
 325         fontdirs = NULL;
 326     }
 327     return fontdirs;
 328 }
 329 
 330 
 331 #endif /* !HEADLESS */
 332 
 333 #if defined(__linux__)
</pre>
<hr />
<pre>
 443  * need to be added ito the host&#39;s font configuration database, typically
 444  * /etc/fonts/local.conf, and to ensure that directory contains a fonts.dir
 445  * NB: Fontconfig also depends heavily for performance on the host O/S
 446  * maintaining up to date caches.
 447  * This is consistent with the requirements of the desktop environments
 448  * on these OSes.
 449  * This also frees us from X11 APIs as JRE is required to function in
 450  * a &quot;headless&quot; mode where there is no Xserver.
 451  */
 452 static char *getPlatformFontPathChars(JNIEnv *env, jboolean noType1, jboolean isX11) {
 453 
 454     char **fcdirs = NULL, **x11dirs = NULL, **knowndirs = NULL, *path = NULL;
 455 
 456     /* As of 1.5 we try to use fontconfig on both Solaris and Linux.
 457      * If its not available NULL is returned.
 458      */
 459     fcdirs = getFontConfigLocations();
 460 
 461 #if defined(__linux__)
 462     knowndirs = fullLinuxFontPath;


 463 #elif defined(_AIX)
 464     knowndirs = fullAixFontPath;
 465 #endif
 466     /* REMIND: this code requires to be executed when the GraphicsEnvironment
 467      * is already initialised. That is always true, but if it were not so,
 468      * this code could throw an exception and the fontpath would fail to
 469      * be initialised.
 470      */
 471 #ifndef HEADLESS
 472     if (isX11) { // The following only works in an x11 environment.
 473 #if defined(__linux__)
 474     /* There&#39;s no headless build on linux ... */
 475     if (!AWTIsHeadless()) { /* .. so need to call a function to check */
 476 #endif
 477       /* Using the X11 font path to locate font files is now a fallback
 478        * useful only if fontconfig failed, or is incomplete. So we could
 479        * remove this code completely and the consequences should be rare
 480        * and non-fatal. If this happens, then the calling Java code can
 481        * be modified to no longer require that the AWT lock (the X11GE)
 482        * be initialised prior to calling this code.
</pre>
<hr />
<pre>
 512     jstring ret;
 513     static char *ptr = NULL; /* retain result across calls */
 514 
 515     if (ptr == NULL) {
 516         ptr = getPlatformFontPathChars(env, noType1, isX11);
 517     }
 518     ret = (*env)-&gt;NewStringUTF(env, ptr);
 519     return ret;
 520 }
 521 
 522 #include &lt;dlfcn.h&gt;
 523 
 524 #include &lt;fontconfig/fontconfig.h&gt;
 525 
 526 
 527 static void* openFontConfig() {
 528 
 529     char *homeEnv;
 530     static char *homeEnvStr = &quot;HOME=&quot;; /* must be static */
 531     void* libfontconfig = NULL;




 532 
 533     /* Private workaround to not use fontconfig library.
 534      * May be useful during testing/debugging
 535      */
 536     char *useFC = getenv(&quot;USE_J2D_FONTCONFIG&quot;);
 537     if (useFC != NULL &amp;&amp; !strcmp(useFC, &quot;no&quot;)) {
 538         return NULL;
 539     }
 540 















 541 #if defined(_AIX)
 542     /* On AIX, fontconfig is not a standard package supported by IBM.
 543      * instead it has to be installed from the &quot;AIX Toolbox for Linux Applications&quot;
 544      * site http://www-03.ibm.com/systems/power/software/aix/linux/toolbox/alpha.html
 545      * and will be installed under /opt/freeware/lib/libfontconfig.a.
 546      * Notice that the archive contains the real 32- and 64-bit shared libraries.
 547      * We first try to load &#39;libfontconfig.so&#39; from the default library path in the
 548      * case the user has installed a private version of the library and if that
 549      * doesn&#39;t succeed, we try the version from /opt/freeware/lib/libfontconfig.a
 550      */
 551     libfontconfig = dlopen(&quot;libfontconfig.so&quot;, RTLD_LOCAL|RTLD_LAZY);
 552     if (libfontconfig == NULL) {
 553         libfontconfig = dlopen(&quot;/opt/freeware/lib/libfontconfig.a(libfontconfig.so.1)&quot;, RTLD_MEMBER|RTLD_LOCAL|RTLD_LAZY);
 554         if (libfontconfig == NULL) {
 555             return NULL;
 556         }
 557     }
 558 #else
 559     /* 64 bit sparc should pick up the right version from the lib path.
 560      * New features may be added to libfontconfig, this is expected to
</pre>
</td>
</tr>
</table>
<center><a href="X11Color.c.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../java2d/opengl/GLXGraphicsConfig.c.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>