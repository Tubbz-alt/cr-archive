<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.desktop/unix/classes/sun/print/PrintServiceLookupProvider.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="../font/MFontConfiguration.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="UnixPrintJob.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/unix/classes/sun/print/PrintServiceLookupProvider.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
134          * take lots of time if thousands of printers are attached to a server.
135          */
136         if (isAIX()) {
137             String aixPrinterEnumerator = java.security.AccessController.doPrivileged(
138                 new sun.security.action.GetPropertyAction(&quot;sun.java2d.print.aix.lpstat&quot;));
139 
140             if (aixPrinterEnumerator != null) {
141                 if (aixPrinterEnumerator.equalsIgnoreCase(&quot;lpstat&quot;)) {
142                     aix_defaultPrinterEnumeration = aix_lpstat_p;
143                 } else if (aixPrinterEnumerator.equalsIgnoreCase(&quot;lsallq&quot;)) {
144                     aix_defaultPrinterEnumeration = aix_lsallq;
145                 }
146             }
147         }
148     }
149 
150     static boolean isMac() {
151         return osname.startsWith(&quot;Mac&quot;);
152     }
153 
<span class="line-removed">154     static boolean isSysV() {</span>
<span class="line-removed">155         return osname.equals(&quot;SunOS&quot;);</span>
<span class="line-removed">156     }</span>
<span class="line-removed">157 </span>
158     static boolean isLinux() {
159         return (osname.equals(&quot;Linux&quot;));
160     }
161 
162     static boolean isBSD() {
163         return (osname.equals(&quot;Linux&quot;) ||
164                 osname.contains(&quot;OS X&quot;));
165     }
166 
167     static boolean isAIX() {
168         return osname.equals(&quot;AIX&quot;);
169     }
170 
171     static final int UNINITIALIZED = -1;
172     static final int BSD_LPD = 0;
173     static final int BSD_LPD_NG = 1;
174 
175     static int cmdIndex = UNINITIALIZED;
176 
177     String[] lpcFirstCom = {
</pre>
<hr />
<pre>
284             try {
285                 printerURIs = CUPSPrinter.getAllPrinters();
286                 IPPPrintService.debug_println(&quot;CUPS URIs = &quot; + printerURIs);
287                 if (printerURIs != null) {
288                     for (int p = 0; p &lt; printerURIs.length; p++) {
289                        IPPPrintService.debug_println(&quot;URI=&quot;+printerURIs[p]);
290                     }
291                 }
292             } catch (Throwable t) {
293             IPPPrintService.debug_println(debugPrefix+
294               &quot;Exception getting all CUPS printers : &quot; + t);
295             }
296             if ((printerURIs != null) &amp;&amp; (printerURIs.length &gt; 0)) {
297                 printers = new String[printerURIs.length];
298                 for (int i=0; i&lt;printerURIs.length; i++) {
299                     int lastIndex = printerURIs[i].lastIndexOf(&quot;/&quot;);
300                     printers[i] = printerURIs[i].substring(lastIndex+1);
301                 }
302             }
303         } else {
<span class="line-modified">304             if (isMac() || isSysV()) {</span>
305                 printers = getAllPrinterNamesSysV();
306             } else if (isAIX()) {
307                 printers = getAllPrinterNamesAIX();
308             } else { //BSD
309                 printers = getAllPrinterNamesBSD();
310             }
311         }
312 
313         if (printers == null) {
314             if (defaultPrintService != null) {
315                 printServices = new PrintService[1];
316                 printServices[0] = defaultPrintService;
317             } else {
318                 printServices = null;
319             }
320             return;
321         }
322 
323         ArrayList&lt;PrintService&gt; printerList = new ArrayList&lt;&gt;();
324         int defaultIndex = -1;
</pre>
<hr />
<pre>
468                     return printService;
469                 }
470             }
471         }
472         /* take CUPS into account first */
473         if (CUPSPrinter.isCupsRunning()) {
474             try {
475                 return new IPPPrintService(name,
476                                            new URL(&quot;http://&quot;+
477                                                    CUPSPrinter.getServer()+&quot;:&quot;+
478                                                    CUPSPrinter.getPort()+&quot;/&quot;+
479                                                    name));
480             } catch (Exception e) {
481                 IPPPrintService.debug_println(debugPrefix+
482                                               &quot; getServiceByName Exception &quot;+
483                                               e);
484             }
485         }
486         /* fallback if nothing not having a printer at this point */
487         PrintService printer = null;
<span class="line-modified">488         if (isMac() || isSysV()) {</span>
489             printer = getNamedPrinterNameSysV(name);
490         } else if (isAIX()) {
491             printer = getNamedPrinterNameAIX(name);
492         } else {
493             printer = getNamedPrinterNameBSD(name);
494         }
495         return printer;
496     }
497 
498     private PrintService[]
499         getPrintServices(PrintServiceAttributeSet serviceSet) {
500 
501         if (serviceSet == null || serviceSet.isEmpty()) {
502             return getPrintServices();
503         }
504 
505         /* Typically expect that if a service attribute is specified that
506          * its a printer name and there ought to be only one match.
507          * Directly retrieve that service and confirm
508          * that it meets the other requirements.
</pre>
<hr />
<pre>
636 
637     public synchronized PrintService getDefaultPrintService() {
638         SecurityManager security = System.getSecurityManager();
639         if (security != null) {
640           security.checkPrintJobAccess();
641         }
642 
643         // clear defaultPrintService
644         defaultPrintService = null;
645         String psuri = null;
646 
647         IPPPrintService.debug_println(&quot;isRunning ? &quot;+
648                                       (CUPSPrinter.isCupsRunning()));
649         if (CUPSPrinter.isCupsRunning()) {
650             String[] printerInfo = CUPSPrinter.getDefaultPrinter();
651             if (printerInfo != null &amp;&amp; printerInfo.length &gt;= 2) {
652                 defaultPrinter = printerInfo[0];
653                 psuri = printerInfo[1];
654             }
655         } else {
<span class="line-modified">656             if (isMac() || isSysV()) {</span>
657                 defaultPrinter = getDefaultPrinterNameSysV();
658             } else if (isAIX()) {
659                 defaultPrinter = getDefaultPrinterNameAIX();
660             } else {
661                 defaultPrinter = getDefaultPrinterNameBSD();
662             }
663         }
664         if (defaultPrinter == null) {
665             return null;
666         }
667         defaultPrintService = null;
668         if (printServices != null) {
669             for (int j=0; j&lt;printServices.length; j++) {
670                 if (defaultPrinter.equals(getPrinterDestName(printServices[j]))) {
671                     defaultPrintService = printServices[j];
672                     break;
673                 }
674             }
675         }
676         if (defaultPrintService == null) {
</pre>
<hr />
<pre>
855     }
856 
857     private String[] getAllPrinterNamesAIX() {
858         // Determine all printers of the system.
859         String [] names = execCmd(lpNameComAix[aix_defaultPrinterEnumeration]);
860 
861         // Remove headers and bogus entries added by remote printers.
862         names = UnixPrintService.filterPrinterNamesAIX(names);
863 
864         ArrayList&lt;String&gt; printerNames = new ArrayList&lt;String&gt;();
865         for ( int i=0; i &lt; names.length; i++) {
866             printerNames.add(names[i]);
867         }
868         return printerNames.toArray(new String[printerNames.size()]);
869     }
870 
871     static String[] execCmd(final String command) {
872         ArrayList&lt;String&gt; results = null;
873         try {
874             final String[] cmd = new String[3];
<span class="line-modified">875             if (isSysV() || isAIX()) {</span>
876                 cmd[0] = &quot;/usr/bin/sh&quot;;
877                 cmd[1] = &quot;-c&quot;;
878                 cmd[2] = &quot;env LC_ALL=C &quot; + command;
879             } else {
880                 cmd[0] = &quot;/bin/sh&quot;;
881                 cmd[1] = &quot;-c&quot;;
882                 cmd[2] = &quot;LC_ALL=C &quot; + command;
883             }
884 
885             results = AccessController.doPrivileged(
886                 new PrivilegedExceptionAction&lt;ArrayList&lt;String&gt;&gt;() {
887                     public ArrayList&lt;String&gt; run() throws IOException {
888 
889                         Process proc;
890                         BufferedReader bufferedReader = null;
891                         File f = Files.createTempFile(&quot;prn&quot;,&quot;xc&quot;).toFile();
892                         cmd[2] = cmd[2]+&quot;&gt;&quot;+f.getAbsolutePath();
893 
894                         proc = Runtime.getRuntime().exec(cmd);
895                         try {
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2000, 2020, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
134          * take lots of time if thousands of printers are attached to a server.
135          */
136         if (isAIX()) {
137             String aixPrinterEnumerator = java.security.AccessController.doPrivileged(
138                 new sun.security.action.GetPropertyAction(&quot;sun.java2d.print.aix.lpstat&quot;));
139 
140             if (aixPrinterEnumerator != null) {
141                 if (aixPrinterEnumerator.equalsIgnoreCase(&quot;lpstat&quot;)) {
142                     aix_defaultPrinterEnumeration = aix_lpstat_p;
143                 } else if (aixPrinterEnumerator.equalsIgnoreCase(&quot;lsallq&quot;)) {
144                     aix_defaultPrinterEnumeration = aix_lsallq;
145                 }
146             }
147         }
148     }
149 
150     static boolean isMac() {
151         return osname.startsWith(&quot;Mac&quot;);
152     }
153 




154     static boolean isLinux() {
155         return (osname.equals(&quot;Linux&quot;));
156     }
157 
158     static boolean isBSD() {
159         return (osname.equals(&quot;Linux&quot;) ||
160                 osname.contains(&quot;OS X&quot;));
161     }
162 
163     static boolean isAIX() {
164         return osname.equals(&quot;AIX&quot;);
165     }
166 
167     static final int UNINITIALIZED = -1;
168     static final int BSD_LPD = 0;
169     static final int BSD_LPD_NG = 1;
170 
171     static int cmdIndex = UNINITIALIZED;
172 
173     String[] lpcFirstCom = {
</pre>
<hr />
<pre>
280             try {
281                 printerURIs = CUPSPrinter.getAllPrinters();
282                 IPPPrintService.debug_println(&quot;CUPS URIs = &quot; + printerURIs);
283                 if (printerURIs != null) {
284                     for (int p = 0; p &lt; printerURIs.length; p++) {
285                        IPPPrintService.debug_println(&quot;URI=&quot;+printerURIs[p]);
286                     }
287                 }
288             } catch (Throwable t) {
289             IPPPrintService.debug_println(debugPrefix+
290               &quot;Exception getting all CUPS printers : &quot; + t);
291             }
292             if ((printerURIs != null) &amp;&amp; (printerURIs.length &gt; 0)) {
293                 printers = new String[printerURIs.length];
294                 for (int i=0; i&lt;printerURIs.length; i++) {
295                     int lastIndex = printerURIs[i].lastIndexOf(&quot;/&quot;);
296                     printers[i] = printerURIs[i].substring(lastIndex+1);
297                 }
298             }
299         } else {
<span class="line-modified">300             if (isMac()) {</span>
301                 printers = getAllPrinterNamesSysV();
302             } else if (isAIX()) {
303                 printers = getAllPrinterNamesAIX();
304             } else { //BSD
305                 printers = getAllPrinterNamesBSD();
306             }
307         }
308 
309         if (printers == null) {
310             if (defaultPrintService != null) {
311                 printServices = new PrintService[1];
312                 printServices[0] = defaultPrintService;
313             } else {
314                 printServices = null;
315             }
316             return;
317         }
318 
319         ArrayList&lt;PrintService&gt; printerList = new ArrayList&lt;&gt;();
320         int defaultIndex = -1;
</pre>
<hr />
<pre>
464                     return printService;
465                 }
466             }
467         }
468         /* take CUPS into account first */
469         if (CUPSPrinter.isCupsRunning()) {
470             try {
471                 return new IPPPrintService(name,
472                                            new URL(&quot;http://&quot;+
473                                                    CUPSPrinter.getServer()+&quot;:&quot;+
474                                                    CUPSPrinter.getPort()+&quot;/&quot;+
475                                                    name));
476             } catch (Exception e) {
477                 IPPPrintService.debug_println(debugPrefix+
478                                               &quot; getServiceByName Exception &quot;+
479                                               e);
480             }
481         }
482         /* fallback if nothing not having a printer at this point */
483         PrintService printer = null;
<span class="line-modified">484         if (isMac()) {</span>
485             printer = getNamedPrinterNameSysV(name);
486         } else if (isAIX()) {
487             printer = getNamedPrinterNameAIX(name);
488         } else {
489             printer = getNamedPrinterNameBSD(name);
490         }
491         return printer;
492     }
493 
494     private PrintService[]
495         getPrintServices(PrintServiceAttributeSet serviceSet) {
496 
497         if (serviceSet == null || serviceSet.isEmpty()) {
498             return getPrintServices();
499         }
500 
501         /* Typically expect that if a service attribute is specified that
502          * its a printer name and there ought to be only one match.
503          * Directly retrieve that service and confirm
504          * that it meets the other requirements.
</pre>
<hr />
<pre>
632 
633     public synchronized PrintService getDefaultPrintService() {
634         SecurityManager security = System.getSecurityManager();
635         if (security != null) {
636           security.checkPrintJobAccess();
637         }
638 
639         // clear defaultPrintService
640         defaultPrintService = null;
641         String psuri = null;
642 
643         IPPPrintService.debug_println(&quot;isRunning ? &quot;+
644                                       (CUPSPrinter.isCupsRunning()));
645         if (CUPSPrinter.isCupsRunning()) {
646             String[] printerInfo = CUPSPrinter.getDefaultPrinter();
647             if (printerInfo != null &amp;&amp; printerInfo.length &gt;= 2) {
648                 defaultPrinter = printerInfo[0];
649                 psuri = printerInfo[1];
650             }
651         } else {
<span class="line-modified">652             if (isMac()) {</span>
653                 defaultPrinter = getDefaultPrinterNameSysV();
654             } else if (isAIX()) {
655                 defaultPrinter = getDefaultPrinterNameAIX();
656             } else {
657                 defaultPrinter = getDefaultPrinterNameBSD();
658             }
659         }
660         if (defaultPrinter == null) {
661             return null;
662         }
663         defaultPrintService = null;
664         if (printServices != null) {
665             for (int j=0; j&lt;printServices.length; j++) {
666                 if (defaultPrinter.equals(getPrinterDestName(printServices[j]))) {
667                     defaultPrintService = printServices[j];
668                     break;
669                 }
670             }
671         }
672         if (defaultPrintService == null) {
</pre>
<hr />
<pre>
851     }
852 
853     private String[] getAllPrinterNamesAIX() {
854         // Determine all printers of the system.
855         String [] names = execCmd(lpNameComAix[aix_defaultPrinterEnumeration]);
856 
857         // Remove headers and bogus entries added by remote printers.
858         names = UnixPrintService.filterPrinterNamesAIX(names);
859 
860         ArrayList&lt;String&gt; printerNames = new ArrayList&lt;String&gt;();
861         for ( int i=0; i &lt; names.length; i++) {
862             printerNames.add(names[i]);
863         }
864         return printerNames.toArray(new String[printerNames.size()]);
865     }
866 
867     static String[] execCmd(final String command) {
868         ArrayList&lt;String&gt; results = null;
869         try {
870             final String[] cmd = new String[3];
<span class="line-modified">871             if (isAIX()) {</span>
872                 cmd[0] = &quot;/usr/bin/sh&quot;;
873                 cmd[1] = &quot;-c&quot;;
874                 cmd[2] = &quot;env LC_ALL=C &quot; + command;
875             } else {
876                 cmd[0] = &quot;/bin/sh&quot;;
877                 cmd[1] = &quot;-c&quot;;
878                 cmd[2] = &quot;LC_ALL=C &quot; + command;
879             }
880 
881             results = AccessController.doPrivileged(
882                 new PrivilegedExceptionAction&lt;ArrayList&lt;String&gt;&gt;() {
883                     public ArrayList&lt;String&gt; run() throws IOException {
884 
885                         Process proc;
886                         BufferedReader bufferedReader = null;
887                         File f = Files.createTempFile(&quot;prn&quot;,&quot;xc&quot;).toFile();
888                         cmd[2] = cmd[2]+&quot;&gt;&quot;+f.getAbsolutePath();
889 
890                         proc = Runtime.getRuntime().exec(cmd);
891                         try {
</pre>
</td>
</tr>
</table>
<center><a href="../font/MFontConfiguration.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="UnixPrintJob.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>