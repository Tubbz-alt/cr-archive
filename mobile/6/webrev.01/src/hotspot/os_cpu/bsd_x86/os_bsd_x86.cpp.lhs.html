<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/os_cpu/bsd_x86/os_bsd_x86.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 1999, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 // no precompiled headers
  26 #include &quot;jvm.h&quot;
  27 #include &quot;asm/macroAssembler.hpp&quot;
  28 #include &quot;classfile/classLoader.hpp&quot;
  29 #include &quot;classfile/systemDictionary.hpp&quot;
  30 #include &quot;classfile/vmSymbols.hpp&quot;
  31 #include &quot;code/codeCache.hpp&quot;
  32 #include &quot;code/icBuffer.hpp&quot;
  33 #include &quot;code/vtableStubs.hpp&quot;
  34 #include &quot;interpreter/interpreter.hpp&quot;
  35 #include &quot;logging/log.hpp&quot;
  36 #include &quot;memory/allocation.inline.hpp&quot;
  37 #include &quot;os_share_bsd.hpp&quot;
  38 #include &quot;prims/jniFastGetField.hpp&quot;
  39 #include &quot;prims/jvm_misc.hpp&quot;
  40 #include &quot;runtime/arguments.hpp&quot;
  41 #include &quot;runtime/extendedPC.hpp&quot;
  42 #include &quot;runtime/frame.inline.hpp&quot;
  43 #include &quot;runtime/interfaceSupport.inline.hpp&quot;
  44 #include &quot;runtime/java.hpp&quot;
  45 #include &quot;runtime/javaCalls.hpp&quot;
  46 #include &quot;runtime/mutexLocker.hpp&quot;
  47 #include &quot;runtime/osThread.hpp&quot;
  48 #include &quot;runtime/safepointMechanism.hpp&quot;
  49 #include &quot;runtime/sharedRuntime.hpp&quot;
  50 #include &quot;runtime/stubRoutines.hpp&quot;
  51 #include &quot;runtime/thread.inline.hpp&quot;
  52 #include &quot;runtime/timer.hpp&quot;
  53 #include &quot;utilities/align.hpp&quot;
  54 #include &quot;utilities/events.hpp&quot;
  55 #include &quot;utilities/vmError.hpp&quot;
  56 
  57 // put OS-includes here
  58 # include &lt;sys/types.h&gt;
  59 # include &lt;sys/mman.h&gt;
  60 # include &lt;pthread.h&gt;
  61 # include &lt;signal.h&gt;
  62 # include &lt;errno.h&gt;
  63 # include &lt;dlfcn.h&gt;
  64 # include &lt;stdlib.h&gt;
  65 # include &lt;stdio.h&gt;
  66 # include &lt;unistd.h&gt;
  67 # include &lt;sys/resource.h&gt;
  68 # include &lt;pthread.h&gt;
  69 # include &lt;sys/stat.h&gt;
  70 # include &lt;sys/time.h&gt;
  71 # include &lt;sys/utsname.h&gt;
  72 # include &lt;sys/socket.h&gt;
  73 # include &lt;sys/wait.h&gt;
  74 # include &lt;pwd.h&gt;
  75 # include &lt;poll.h&gt;
  76 #ifndef __OpenBSD__
  77 # include &lt;ucontext.h&gt;
  78 #endif
  79 
  80 #if !defined(__APPLE__) &amp;&amp; !defined(__NetBSD__)
  81 # include &lt;pthread_np.h&gt;
  82 #endif
  83 
  84 // needed by current_stack_region() workaround for Mavericks
  85 #if defined(__APPLE__)
  86 # include &lt;errno.h&gt;
  87 # include &lt;sys/types.h&gt;
  88 # include &lt;sys/sysctl.h&gt;
  89 # define DEFAULT_MAIN_THREAD_STACK_PAGES 2048
  90 # define OS_X_10_9_0_KERNEL_MAJOR_VERSION 13
  91 #endif
  92 
  93 #ifdef AMD64
  94 #define SPELL_REG_SP &quot;rsp&quot;
  95 #define SPELL_REG_FP &quot;rbp&quot;
  96 #else
  97 #define SPELL_REG_SP &quot;esp&quot;
  98 #define SPELL_REG_FP &quot;ebp&quot;
  99 #endif // AMD64
 100 
 101 #ifdef __FreeBSD__
 102 # define context_trapno uc_mcontext.mc_trapno
 103 # ifdef AMD64
 104 #  define context_pc uc_mcontext.mc_rip
 105 #  define context_sp uc_mcontext.mc_rsp
 106 #  define context_fp uc_mcontext.mc_rbp
 107 #  define context_rip uc_mcontext.mc_rip
 108 #  define context_rsp uc_mcontext.mc_rsp
 109 #  define context_rbp uc_mcontext.mc_rbp
 110 #  define context_rax uc_mcontext.mc_rax
 111 #  define context_rbx uc_mcontext.mc_rbx
 112 #  define context_rcx uc_mcontext.mc_rcx
 113 #  define context_rdx uc_mcontext.mc_rdx
 114 #  define context_rsi uc_mcontext.mc_rsi
 115 #  define context_rdi uc_mcontext.mc_rdi
 116 #  define context_r8  uc_mcontext.mc_r8
 117 #  define context_r9  uc_mcontext.mc_r9
 118 #  define context_r10 uc_mcontext.mc_r10
 119 #  define context_r11 uc_mcontext.mc_r11
 120 #  define context_r12 uc_mcontext.mc_r12
 121 #  define context_r13 uc_mcontext.mc_r13
 122 #  define context_r14 uc_mcontext.mc_r14
 123 #  define context_r15 uc_mcontext.mc_r15
 124 #  define context_flags uc_mcontext.mc_flags
 125 #  define context_err uc_mcontext.mc_err
 126 # else
 127 #  define context_pc uc_mcontext.mc_eip
 128 #  define context_sp uc_mcontext.mc_esp
 129 #  define context_fp uc_mcontext.mc_ebp
 130 #  define context_eip uc_mcontext.mc_eip
 131 #  define context_esp uc_mcontext.mc_esp
 132 #  define context_eax uc_mcontext.mc_eax
 133 #  define context_ebx uc_mcontext.mc_ebx
 134 #  define context_ecx uc_mcontext.mc_ecx
 135 #  define context_edx uc_mcontext.mc_edx
 136 #  define context_ebp uc_mcontext.mc_ebp
 137 #  define context_esi uc_mcontext.mc_esi
 138 #  define context_edi uc_mcontext.mc_edi
 139 #  define context_eflags uc_mcontext.mc_eflags
 140 #  define context_trapno uc_mcontext.mc_trapno
 141 # endif
 142 #endif
 143 
 144 #ifdef __APPLE__
 145 # if __DARWIN_UNIX03 &amp;&amp; (MAC_OS_X_VERSION_MAX_ALLOWED &gt;= MAC_OS_X_VERSION_10_5)
 146   // 10.5 UNIX03 member name prefixes
 147   #define DU3_PREFIX(s, m) __ ## s.__ ## m
 148 # else
 149   #define DU3_PREFIX(s, m) s ## . ## m
 150 # endif
 151 
 152 # ifdef AMD64
 153 #  define context_pc context_rip
 154 #  define context_sp context_rsp
 155 #  define context_fp context_rbp
 156 #  define context_rip uc_mcontext-&gt;DU3_PREFIX(ss,rip)
 157 #  define context_rsp uc_mcontext-&gt;DU3_PREFIX(ss,rsp)
 158 #  define context_rax uc_mcontext-&gt;DU3_PREFIX(ss,rax)
 159 #  define context_rbx uc_mcontext-&gt;DU3_PREFIX(ss,rbx)
 160 #  define context_rcx uc_mcontext-&gt;DU3_PREFIX(ss,rcx)
 161 #  define context_rdx uc_mcontext-&gt;DU3_PREFIX(ss,rdx)
 162 #  define context_rbp uc_mcontext-&gt;DU3_PREFIX(ss,rbp)
 163 #  define context_rsi uc_mcontext-&gt;DU3_PREFIX(ss,rsi)
 164 #  define context_rdi uc_mcontext-&gt;DU3_PREFIX(ss,rdi)
 165 #  define context_r8  uc_mcontext-&gt;DU3_PREFIX(ss,r8)
 166 #  define context_r9  uc_mcontext-&gt;DU3_PREFIX(ss,r9)
 167 #  define context_r10 uc_mcontext-&gt;DU3_PREFIX(ss,r10)
 168 #  define context_r11 uc_mcontext-&gt;DU3_PREFIX(ss,r11)
 169 #  define context_r12 uc_mcontext-&gt;DU3_PREFIX(ss,r12)
 170 #  define context_r13 uc_mcontext-&gt;DU3_PREFIX(ss,r13)
 171 #  define context_r14 uc_mcontext-&gt;DU3_PREFIX(ss,r14)
 172 #  define context_r15 uc_mcontext-&gt;DU3_PREFIX(ss,r15)
 173 #  define context_flags uc_mcontext-&gt;DU3_PREFIX(ss,rflags)
 174 #  define context_trapno uc_mcontext-&gt;DU3_PREFIX(es,trapno)
 175 #  define context_err uc_mcontext-&gt;DU3_PREFIX(es,err)
 176 # else
 177 #  define context_pc context_eip
 178 #  define context_sp context_esp
 179 #  define context_fp context_ebp
 180 #  define context_eip uc_mcontext-&gt;DU3_PREFIX(ss,eip)
 181 #  define context_esp uc_mcontext-&gt;DU3_PREFIX(ss,esp)
 182 #  define context_eax uc_mcontext-&gt;DU3_PREFIX(ss,eax)
 183 #  define context_ebx uc_mcontext-&gt;DU3_PREFIX(ss,ebx)
 184 #  define context_ecx uc_mcontext-&gt;DU3_PREFIX(ss,ecx)
 185 #  define context_edx uc_mcontext-&gt;DU3_PREFIX(ss,edx)
 186 #  define context_ebp uc_mcontext-&gt;DU3_PREFIX(ss,ebp)
 187 #  define context_esi uc_mcontext-&gt;DU3_PREFIX(ss,esi)
 188 #  define context_edi uc_mcontext-&gt;DU3_PREFIX(ss,edi)
 189 #  define context_eflags uc_mcontext-&gt;DU3_PREFIX(ss,eflags)
 190 #  define context_trapno uc_mcontext-&gt;DU3_PREFIX(es,trapno)
 191 # endif
 192 #endif
 193 
 194 #ifdef __OpenBSD__
 195 # define context_trapno sc_trapno
 196 # ifdef AMD64
 197 #  define context_pc sc_rip
 198 #  define context_sp sc_rsp
 199 #  define context_fp sc_rbp
 200 #  define context_rip sc_rip
 201 #  define context_rsp sc_rsp
 202 #  define context_rbp sc_rbp
 203 #  define context_rax sc_rax
 204 #  define context_rbx sc_rbx
 205 #  define context_rcx sc_rcx
 206 #  define context_rdx sc_rdx
 207 #  define context_rsi sc_rsi
 208 #  define context_rdi sc_rdi
 209 #  define context_r8  sc_r8
 210 #  define context_r9  sc_r9
 211 #  define context_r10 sc_r10
 212 #  define context_r11 sc_r11
 213 #  define context_r12 sc_r12
 214 #  define context_r13 sc_r13
 215 #  define context_r14 sc_r14
 216 #  define context_r15 sc_r15
 217 #  define context_flags sc_rflags
 218 #  define context_err sc_err
 219 # else
 220 #  define context_pc sc_eip
 221 #  define context_sp sc_esp
 222 #  define context_fp sc_ebp
 223 #  define context_eip sc_eip
 224 #  define context_esp sc_esp
 225 #  define context_eax sc_eax
 226 #  define context_ebx sc_ebx
 227 #  define context_ecx sc_ecx
 228 #  define context_edx sc_edx
 229 #  define context_ebp sc_ebp
 230 #  define context_esi sc_esi
 231 #  define context_edi sc_edi
 232 #  define context_eflags sc_eflags
 233 #  define context_trapno sc_trapno
 234 # endif
 235 #endif
 236 
 237 #ifdef __NetBSD__
 238 # define context_trapno uc_mcontext.__gregs[_REG_TRAPNO]
 239 # ifdef AMD64
 240 #  define __register_t __greg_t
 241 #  define context_pc uc_mcontext.__gregs[_REG_RIP]
 242 #  define context_sp uc_mcontext.__gregs[_REG_URSP]
 243 #  define context_fp uc_mcontext.__gregs[_REG_RBP]
 244 #  define context_rip uc_mcontext.__gregs[_REG_RIP]
 245 #  define context_rsp uc_mcontext.__gregs[_REG_URSP]
 246 #  define context_rax uc_mcontext.__gregs[_REG_RAX]
 247 #  define context_rbx uc_mcontext.__gregs[_REG_RBX]
 248 #  define context_rcx uc_mcontext.__gregs[_REG_RCX]
 249 #  define context_rdx uc_mcontext.__gregs[_REG_RDX]
 250 #  define context_rbp uc_mcontext.__gregs[_REG_RBP]
 251 #  define context_rsi uc_mcontext.__gregs[_REG_RSI]
 252 #  define context_rdi uc_mcontext.__gregs[_REG_RDI]
 253 #  define context_r8  uc_mcontext.__gregs[_REG_R8]
 254 #  define context_r9  uc_mcontext.__gregs[_REG_R9]
 255 #  define context_r10 uc_mcontext.__gregs[_REG_R10]
 256 #  define context_r11 uc_mcontext.__gregs[_REG_R11]
 257 #  define context_r12 uc_mcontext.__gregs[_REG_R12]
 258 #  define context_r13 uc_mcontext.__gregs[_REG_R13]
 259 #  define context_r14 uc_mcontext.__gregs[_REG_R14]
 260 #  define context_r15 uc_mcontext.__gregs[_REG_R15]
 261 #  define context_flags uc_mcontext.__gregs[_REG_RFL]
 262 #  define context_err uc_mcontext.__gregs[_REG_ERR]
 263 # else
 264 #  define context_pc uc_mcontext.__gregs[_REG_EIP]
 265 #  define context_sp uc_mcontext.__gregs[_REG_UESP]
 266 #  define context_fp uc_mcontext.__gregs[_REG_EBP]
 267 #  define context_eip uc_mcontext.__gregs[_REG_EIP]
 268 #  define context_esp uc_mcontext.__gregs[_REG_UESP]
 269 #  define context_eax uc_mcontext.__gregs[_REG_EAX]
 270 #  define context_ebx uc_mcontext.__gregs[_REG_EBX]
 271 #  define context_ecx uc_mcontext.__gregs[_REG_ECX]
 272 #  define context_edx uc_mcontext.__gregs[_REG_EDX]
 273 #  define context_ebp uc_mcontext.__gregs[_REG_EBP]
 274 #  define context_esi uc_mcontext.__gregs[_REG_ESI]
 275 #  define context_edi uc_mcontext.__gregs[_REG_EDI]
 276 #  define context_eflags uc_mcontext.__gregs[_REG_EFL]
 277 #  define context_trapno uc_mcontext.__gregs[_REG_TRAPNO]
 278 # endif
 279 #endif
 280 
 281 address os::current_stack_pointer() {
 282 #if defined(__clang__) || defined(__llvm__)
 283   void *esp;
 284   __asm__(&quot;mov %%&quot; SPELL_REG_SP &quot;, %0&quot;:&quot;=r&quot;(esp));
 285   return (address) esp;
<a name="1" id="anc1"></a><span class="line-removed"> 286 #elif defined(SPARC_WORKS)</span>
<span class="line-removed"> 287   void *esp;</span>
<span class="line-removed"> 288   __asm__(&quot;mov %%&quot; SPELL_REG_SP &quot;, %0&quot;:&quot;=r&quot;(esp));</span>
<span class="line-removed"> 289   return (address) ((char*)esp + sizeof(long)*2);</span>
 290 #else
 291   register void *esp __asm__ (SPELL_REG_SP);
 292   return (address) esp;
 293 #endif
 294 }
 295 
 296 char* os::non_memory_address_word() {
 297   // Must never look like an address returned by reserve_memory,
 298   // even in its subfields (as defined by the CPU immediate fields,
 299   // if the CPU splits constants across multiple instructions).
 300 
 301   return (char*) -1;
 302 }
 303 
 304 address os::Bsd::ucontext_get_pc(const ucontext_t * uc) {
 305   return (address)uc-&gt;context_pc;
 306 }
 307 
 308 void os::Bsd::ucontext_set_pc(ucontext_t * uc, address pc) {
 309   uc-&gt;context_pc = (intptr_t)pc ;
 310 }
 311 
 312 intptr_t* os::Bsd::ucontext_get_sp(const ucontext_t * uc) {
 313   return (intptr_t*)uc-&gt;context_sp;
 314 }
 315 
 316 intptr_t* os::Bsd::ucontext_get_fp(const ucontext_t * uc) {
 317   return (intptr_t*)uc-&gt;context_fp;
 318 }
 319 
 320 // For Forte Analyzer AsyncGetCallTrace profiling support - thread
 321 // is currently interrupted by SIGPROF.
 322 // os::Solaris::fetch_frame_from_ucontext() tries to skip nested signal
 323 // frames. Currently we don&#39;t do that on Bsd, so it&#39;s the same as
 324 // os::fetch_frame_from_context().
 325 // This method is also used for stack overflow signal handling.
 326 ExtendedPC os::Bsd::fetch_frame_from_ucontext(Thread* thread,
 327   const ucontext_t* uc, intptr_t** ret_sp, intptr_t** ret_fp) {
 328 
 329   assert(thread != NULL, &quot;just checking&quot;);
 330   assert(ret_sp != NULL, &quot;just checking&quot;);
 331   assert(ret_fp != NULL, &quot;just checking&quot;);
 332 
 333   return os::fetch_frame_from_context(uc, ret_sp, ret_fp);
 334 }
 335 
 336 ExtendedPC os::fetch_frame_from_context(const void* ucVoid,
 337                     intptr_t** ret_sp, intptr_t** ret_fp) {
 338 
 339   ExtendedPC  epc;
 340   const ucontext_t* uc = (const ucontext_t*)ucVoid;
 341 
 342   if (uc != NULL) {
 343     epc = ExtendedPC(os::Bsd::ucontext_get_pc(uc));
 344     if (ret_sp) *ret_sp = os::Bsd::ucontext_get_sp(uc);
 345     if (ret_fp) *ret_fp = os::Bsd::ucontext_get_fp(uc);
 346   } else {
 347     // construct empty ExtendedPC for return value checking
 348     epc = ExtendedPC(NULL);
 349     if (ret_sp) *ret_sp = (intptr_t *)NULL;
 350     if (ret_fp) *ret_fp = (intptr_t *)NULL;
 351   }
 352 
 353   return epc;
 354 }
 355 
 356 frame os::fetch_frame_from_context(const void* ucVoid) {
 357   intptr_t* sp;
 358   intptr_t* fp;
 359   ExtendedPC epc = fetch_frame_from_context(ucVoid, &amp;sp, &amp;fp);
 360   return frame(sp, fp, epc.pc());
 361 }
 362 
 363 frame os::fetch_frame_from_ucontext(Thread* thread, void* ucVoid) {
 364   intptr_t* sp;
 365   intptr_t* fp;
 366   ExtendedPC epc = os::Bsd::fetch_frame_from_ucontext(thread, (ucontext_t*)ucVoid, &amp;sp, &amp;fp);
 367   return frame(sp, fp, epc.pc());
 368 }
 369 
 370 bool os::Bsd::get_frame_at_stack_banging_point(JavaThread* thread, ucontext_t* uc, frame* fr) {
 371   address pc = (address) os::Bsd::ucontext_get_pc(uc);
 372   if (Interpreter::contains(pc)) {
 373     // interpreter performs stack banging after the fixed frame header has
 374     // been generated while the compilers perform it before. To maintain
 375     // semantic consistency between interpreted and compiled frames, the
 376     // method returns the Java sender of the current frame.
 377     *fr = os::fetch_frame_from_ucontext(thread, uc);
 378     if (!fr-&gt;is_first_java_frame()) {
 379       // get_frame_at_stack_banging_point() is only called when we
 380       // have well defined stacks so java_sender() calls do not need
 381       // to assert safe_for_sender() first.
 382       *fr = fr-&gt;java_sender();
 383     }
 384   } else {
 385     // more complex code with compiled code
 386     assert(!Interpreter::contains(pc), &quot;Interpreted methods should have been handled above&quot;);
 387     CodeBlob* cb = CodeCache::find_blob(pc);
 388     if (cb == NULL || !cb-&gt;is_nmethod() || cb-&gt;is_frame_complete_at(pc)) {
 389       // Not sure where the pc points to, fallback to default
 390       // stack overflow handling
 391       return false;
 392     } else {
 393       *fr = os::fetch_frame_from_ucontext(thread, uc);
 394       // in compiled code, the stack banging is performed just after the return pc
 395       // has been pushed on the stack
 396       *fr = frame(fr-&gt;sp() + 1, fr-&gt;fp(), (address)*(fr-&gt;sp()));
 397       if (!fr-&gt;is_java_frame()) {
 398         // See java_sender() comment above.
 399         *fr = fr-&gt;java_sender();
 400       }
 401     }
 402   }
 403   assert(fr-&gt;is_java_frame(), &quot;Safety check&quot;);
 404   return true;
 405 }
 406 
 407 // By default, gcc always save frame pointer (%ebp/%rbp) on stack. It may get
 408 // turned off by -fomit-frame-pointer,
 409 frame os::get_sender_for_C_frame(frame* fr) {
 410   return frame(fr-&gt;sender_sp(), fr-&gt;link(), fr-&gt;sender_pc());
 411 }
 412 
 413 intptr_t* _get_previous_fp() {
<a name="2" id="anc2"></a><span class="line-modified"> 414 #if defined(SPARC_WORKS) || defined(__clang__) || defined(__llvm__)</span>
 415   intptr_t **ebp;
 416   __asm__(&quot;mov %%&quot; SPELL_REG_FP &quot;, %0&quot;:&quot;=r&quot;(ebp));
 417 #else
 418   register intptr_t **ebp __asm__ (SPELL_REG_FP);
 419 #endif
 420   // ebp is for this frame (_get_previous_fp). We want the ebp for the
 421   // caller of os::current_frame*(), so go up two frames. However, for
 422   // optimized builds, _get_previous_fp() will be inlined, so only go
 423   // up 1 frame in that case.
 424 #ifdef _NMT_NOINLINE_
 425   return **(intptr_t***)ebp;
 426 #else
 427   return *ebp;
 428 #endif
 429 }
 430 
 431 
 432 frame os::current_frame() {
 433   intptr_t* fp = _get_previous_fp();
 434   frame myframe((intptr_t*)os::current_stack_pointer(),
 435                 (intptr_t*)fp,
 436                 CAST_FROM_FN_PTR(address, os::current_frame));
 437   if (os::is_first_C_frame(&amp;myframe)) {
 438     // stack is not walkable
 439     return frame();
 440   } else {
 441     return os::get_sender_for_C_frame(&amp;myframe);
 442   }
 443 }
 444 
 445 // Utility functions
 446 
 447 // From IA32 System Programming Guide
 448 enum {
 449   trap_page_fault = 0xE
 450 };
 451 
 452 extern &quot;C&quot; JNIEXPORT int
 453 JVM_handle_bsd_signal(int sig,
 454                         siginfo_t* info,
 455                         void* ucVoid,
 456                         int abort_if_unrecognized) {
 457   ucontext_t* uc = (ucontext_t*) ucVoid;
 458 
 459   Thread* t = Thread::current_or_null_safe();
 460 
 461   // Must do this before SignalHandlerMark, if crash protection installed we will longjmp away
 462   // (no destructors can be run)
 463   os::ThreadCrashProtection::check_crash_protection(sig, t);
 464 
 465   SignalHandlerMark shm(t);
 466 
 467   // Note: it&#39;s not uncommon that JNI code uses signal/sigset to install
 468   // then restore certain signal handler (e.g. to temporarily block SIGPIPE,
 469   // or have a SIGILL handler when detecting CPU type). When that happens,
 470   // JVM_handle_bsd_signal() might be invoked with junk info/ucVoid. To
 471   // avoid unnecessary crash when libjsig is not preloaded, try handle signals
 472   // that do not require siginfo/ucontext first.
 473 
 474   if (sig == SIGPIPE || sig == SIGXFSZ) {
 475     // allow chained handler to go first
 476     if (os::Bsd::chained_handler(sig, info, ucVoid)) {
 477       return true;
 478     } else {
 479       // Ignoring SIGPIPE/SIGXFSZ - see bugs 4229104 or 6499219
 480       return true;
 481     }
 482   }
 483 
 484   JavaThread* thread = NULL;
 485   VMThread* vmthread = NULL;
 486   if (os::Bsd::signal_handlers_are_installed) {
 487     if (t != NULL ){
 488       if(t-&gt;is_Java_thread()) {
 489         thread = (JavaThread*)t;
 490       }
 491       else if(t-&gt;is_VM_thread()){
 492         vmthread = (VMThread *)t;
 493       }
 494     }
 495   }
 496 /*
 497   NOTE: does not seem to work on bsd.
 498   if (info == NULL || info-&gt;si_code &lt;= 0 || info-&gt;si_code == SI_NOINFO) {
 499     // can&#39;t decode this kind of signal
 500     info = NULL;
 501   } else {
 502     assert(sig == info-&gt;si_signo, &quot;bad siginfo&quot;);
 503   }
 504 */
 505   // decide if this trap can be handled by a stub
 506   address stub = NULL;
 507 
 508   address pc          = NULL;
 509 
 510   //%note os_trap_1
 511   if (info != NULL &amp;&amp; uc != NULL &amp;&amp; thread != NULL) {
 512     pc = (address) os::Bsd::ucontext_get_pc(uc);
 513 
 514     if (StubRoutines::is_safefetch_fault(pc)) {
 515       os::Bsd::ucontext_set_pc(uc, StubRoutines::continuation_for_safefetch_fault(pc));
 516       return 1;
 517     }
 518 
 519     // Handle ALL stack overflow variations here
 520     if (sig == SIGSEGV || sig == SIGBUS) {
 521       address addr = (address) info-&gt;si_addr;
 522 
 523       // check if fault address is within thread stack
 524       if (thread-&gt;is_in_full_stack(addr)) {
 525         // stack overflow
 526         if (thread-&gt;in_stack_yellow_reserved_zone(addr)) {
 527           if (thread-&gt;thread_state() == _thread_in_Java) {
 528             if (thread-&gt;in_stack_reserved_zone(addr)) {
 529               frame fr;
 530               if (os::Bsd::get_frame_at_stack_banging_point(thread, uc, &amp;fr)) {
 531                 assert(fr.is_java_frame(), &quot;Must be a Java frame&quot;);
 532                 frame activation = SharedRuntime::look_for_reserved_stack_annotated_method(thread, fr);
 533                 if (activation.sp() != NULL) {
 534                   thread-&gt;disable_stack_reserved_zone();
 535                   if (activation.is_interpreted_frame()) {
 536                     thread-&gt;set_reserved_stack_activation((address)(
 537                       activation.fp() + frame::interpreter_frame_initial_sp_offset));
 538                   } else {
 539                     thread-&gt;set_reserved_stack_activation((address)activation.unextended_sp());
 540                   }
 541                   return 1;
 542                 }
 543               }
 544             }
 545             // Throw a stack overflow exception.  Guard pages will be reenabled
 546             // while unwinding the stack.
 547             thread-&gt;disable_stack_yellow_reserved_zone();
 548             stub = SharedRuntime::continuation_for_implicit_exception(thread, pc, SharedRuntime::STACK_OVERFLOW);
 549           } else {
 550             // Thread was in the vm or native code.  Return and try to finish.
 551             thread-&gt;disable_stack_yellow_reserved_zone();
 552             return 1;
 553           }
 554         } else if (thread-&gt;in_stack_red_zone(addr)) {
 555           // Fatal red zone violation.  Disable the guard pages and fall through
 556           // to handle_unexpected_exception way down below.
 557           thread-&gt;disable_stack_red_zone();
 558           tty-&gt;print_raw_cr(&quot;An irrecoverable stack overflow has occurred.&quot;);
 559         }
 560       }
 561     }
 562 
 563     if ((sig == SIGSEGV || sig == SIGBUS) &amp;&amp; VM_Version::is_cpuinfo_segv_addr(pc)) {
 564       // Verify that OS save/restore AVX registers.
 565       stub = VM_Version::cpuinfo_cont_addr();
 566     }
 567 
 568     // We test if stub is already set (by the stack overflow code
 569     // above) so it is not overwritten by the code that follows. This
 570     // check is not required on other platforms, because on other
 571     // platforms we check for SIGSEGV only or SIGBUS only, where here
 572     // we have to check for both SIGSEGV and SIGBUS.
 573     if (thread-&gt;thread_state() == _thread_in_Java &amp;&amp; stub == NULL) {
 574       // Java thread running in Java code =&gt; find exception handler if any
 575       // a fault inside compiled code, the interpreter, or a stub
 576 
 577       if ((sig == SIGSEGV || sig == SIGBUS) &amp;&amp; SafepointMechanism::is_poll_address((address)info-&gt;si_addr)) {
 578         stub = SharedRuntime::get_poll_stub(pc);
 579 #if defined(__APPLE__)
 580       // 32-bit Darwin reports a SIGBUS for nearly all memory access exceptions.
 581       // 64-bit Darwin may also use a SIGBUS (seen with compressed oops).
 582       // Catching SIGBUS here prevents the implicit SIGBUS NULL check below from
 583       // being called, so only do so if the implicit NULL check is not necessary.
 584       } else if (sig == SIGBUS &amp;&amp; !MacroAssembler::uses_implicit_null_check(info-&gt;si_addr)) {
 585 #else
 586       } else if (sig == SIGBUS /* &amp;&amp; info-&gt;si_code == BUS_OBJERR */) {
 587 #endif
 588         // BugId 4454115: A read from a MappedByteBuffer can fault
 589         // here if the underlying file has been truncated.
 590         // Do not crash the VM in such a case.
 591         CodeBlob* cb = CodeCache::find_blob_unsafe(pc);
 592         CompiledMethod* nm = (cb != NULL) ? cb-&gt;as_compiled_method_or_null() : NULL;
 593         bool is_unsafe_arraycopy = thread-&gt;doing_unsafe_access() &amp;&amp; UnsafeCopyMemory::contains_pc(pc);
 594         if ((nm != NULL &amp;&amp; nm-&gt;has_unsafe_access()) || is_unsafe_arraycopy) {
 595           address next_pc = Assembler::locate_next_instruction(pc);
 596           if (is_unsafe_arraycopy) {
 597             next_pc = UnsafeCopyMemory::page_error_continue_pc(pc);
 598           }
 599           stub = SharedRuntime::handle_unsafe_access(thread, next_pc);
 600         }
 601       }
 602       else
 603 
 604 #ifdef AMD64
 605       if (sig == SIGFPE  &amp;&amp;
 606           (info-&gt;si_code == FPE_INTDIV || info-&gt;si_code == FPE_FLTDIV)) {
 607         stub =
 608           SharedRuntime::
 609           continuation_for_implicit_exception(thread,
 610                                               pc,
 611                                               SharedRuntime::
 612                                               IMPLICIT_DIVIDE_BY_ZERO);
 613 #ifdef __APPLE__
 614       } else if (sig == SIGFPE &amp;&amp; info-&gt;si_code == FPE_NOOP) {
 615         int op = pc[0];
 616 
 617         // Skip REX
 618         if ((pc[0] &amp; 0xf0) == 0x40) {
 619           op = pc[1];
 620         } else {
 621           op = pc[0];
 622         }
 623 
 624         // Check for IDIV
 625         if (op == 0xF7) {
 626           stub = SharedRuntime::continuation_for_implicit_exception(thread, pc, SharedRuntime:: IMPLICIT_DIVIDE_BY_ZERO);
 627         } else {
 628           // TODO: handle more cases if we are using other x86 instructions
 629           //   that can generate SIGFPE signal.
 630           tty-&gt;print_cr(&quot;unknown opcode 0x%X with SIGFPE.&quot;, op);
 631           fatal(&quot;please update this code.&quot;);
 632         }
 633 #endif /* __APPLE__ */
 634 
 635 #else
 636       if (sig == SIGFPE /* &amp;&amp; info-&gt;si_code == FPE_INTDIV */) {
 637         // HACK: si_code does not work on bsd 2.2.12-20!!!
 638         int op = pc[0];
 639         if (op == 0xDB) {
 640           // FIST
 641           // TODO: The encoding of D2I in i486.ad can cause an exception
 642           // prior to the fist instruction if there was an invalid operation
 643           // pending. We want to dismiss that exception. From the win_32
 644           // side it also seems that if it really was the fist causing
 645           // the exception that we do the d2i by hand with different
 646           // rounding. Seems kind of weird.
 647           // NOTE: that we take the exception at the NEXT floating point instruction.
 648           assert(pc[0] == 0xDB, &quot;not a FIST opcode&quot;);
 649           assert(pc[1] == 0x14, &quot;not a FIST opcode&quot;);
 650           assert(pc[2] == 0x24, &quot;not a FIST opcode&quot;);
 651           return true;
 652         } else if (op == 0xF7) {
 653           // IDIV
 654           stub = SharedRuntime::continuation_for_implicit_exception(thread, pc, SharedRuntime::IMPLICIT_DIVIDE_BY_ZERO);
 655         } else {
 656           // TODO: handle more cases if we are using other x86 instructions
 657           //   that can generate SIGFPE signal on bsd.
 658           tty-&gt;print_cr(&quot;unknown opcode 0x%X with SIGFPE.&quot;, op);
 659           fatal(&quot;please update this code.&quot;);
 660         }
 661 #endif // AMD64
 662       } else if ((sig == SIGSEGV || sig == SIGBUS) &amp;&amp;
 663                  MacroAssembler::uses_implicit_null_check(info-&gt;si_addr)) {
 664           // Determination of interpreter/vtable stub/compiled code null exception
 665           stub = SharedRuntime::continuation_for_implicit_exception(thread, pc, SharedRuntime::IMPLICIT_NULL);
 666       }
 667     } else if ((thread-&gt;thread_state() == _thread_in_vm ||
 668                 thread-&gt;thread_state() == _thread_in_native) &amp;&amp;
 669                sig == SIGBUS &amp;&amp; /* info-&gt;si_code == BUS_OBJERR &amp;&amp; */
 670                thread-&gt;doing_unsafe_access()) {
 671         address next_pc = Assembler::locate_next_instruction(pc);
 672         if (UnsafeCopyMemory::contains_pc(pc)) {
 673           next_pc = UnsafeCopyMemory::page_error_continue_pc(pc);
 674         }
 675         stub = SharedRuntime::handle_unsafe_access(thread, next_pc);
 676     }
 677 
 678     // jni_fast_Get&lt;Primitive&gt;Field can trap at certain pc&#39;s if a GC kicks in
 679     // and the heap gets shrunk before the field access.
 680     if ((sig == SIGSEGV) || (sig == SIGBUS)) {
 681       address addr = JNI_FastGetField::find_slowcase_pc(pc);
 682       if (addr != (address)-1) {
 683         stub = addr;
 684       }
 685     }
 686   }
 687 
 688 #ifndef AMD64
 689   // Execution protection violation
 690   //
 691   // This should be kept as the last step in the triage.  We don&#39;t
 692   // have a dedicated trap number for a no-execute fault, so be
 693   // conservative and allow other handlers the first shot.
 694   //
 695   // Note: We don&#39;t test that info-&gt;si_code == SEGV_ACCERR here.
 696   // this si_code is so generic that it is almost meaningless; and
 697   // the si_code for this condition may change in the future.
 698   // Furthermore, a false-positive should be harmless.
 699   if (UnguardOnExecutionViolation &gt; 0 &amp;&amp;
 700       (sig == SIGSEGV || sig == SIGBUS) &amp;&amp;
 701       uc-&gt;context_trapno == trap_page_fault) {
 702     int page_size = os::vm_page_size();
 703     address addr = (address) info-&gt;si_addr;
 704     address pc = os::Bsd::ucontext_get_pc(uc);
 705     // Make sure the pc and the faulting address are sane.
 706     //
 707     // If an instruction spans a page boundary, and the page containing
 708     // the beginning of the instruction is executable but the following
 709     // page is not, the pc and the faulting address might be slightly
 710     // different - we still want to unguard the 2nd page in this case.
 711     //
 712     // 15 bytes seems to be a (very) safe value for max instruction size.
 713     bool pc_is_near_addr =
 714       (pointer_delta((void*) addr, (void*) pc, sizeof(char)) &lt; 15);
 715     bool instr_spans_page_boundary =
 716       (align_down((intptr_t) pc ^ (intptr_t) addr,
 717                        (intptr_t) page_size) &gt; 0);
 718 
 719     if (pc == addr || (pc_is_near_addr &amp;&amp; instr_spans_page_boundary)) {
 720       static volatile address last_addr =
 721         (address) os::non_memory_address_word();
 722 
 723       // In conservative mode, don&#39;t unguard unless the address is in the VM
 724       if (addr != last_addr &amp;&amp;
 725           (UnguardOnExecutionViolation &gt; 1 || os::address_is_in_vm(addr))) {
 726 
 727         // Set memory to RWX and retry
 728         address page_start = align_down(addr, page_size);
 729         bool res = os::protect_memory((char*) page_start, page_size,
 730                                       os::MEM_PROT_RWX);
 731 
 732         log_debug(os)(&quot;Execution protection violation &quot;
 733                       &quot;at &quot; INTPTR_FORMAT
 734                       &quot;, unguarding &quot; INTPTR_FORMAT &quot;: %s, errno=%d&quot;, p2i(addr),
 735                       p2i(page_start), (res ? &quot;success&quot; : &quot;failed&quot;), errno);
 736         stub = pc;
 737 
 738         // Set last_addr so if we fault again at the same address, we don&#39;t end
 739         // up in an endless loop.
 740         //
 741         // There are two potential complications here.  Two threads trapping at
 742         // the same address at the same time could cause one of the threads to
 743         // think it already unguarded, and abort the VM.  Likely very rare.
 744         //
 745         // The other race involves two threads alternately trapping at
 746         // different addresses and failing to unguard the page, resulting in
 747         // an endless loop.  This condition is probably even more unlikely than
 748         // the first.
 749         //
 750         // Although both cases could be avoided by using locks or thread local
 751         // last_addr, these solutions are unnecessary complication: this
 752         // handler is a best-effort safety net, not a complete solution.  It is
 753         // disabled by default and should only be used as a workaround in case
 754         // we missed any no-execute-unsafe VM code.
 755 
 756         last_addr = addr;
 757       }
 758     }
 759   }
 760 #endif // !AMD64
 761 
 762   if (stub != NULL) {
 763     // save all thread context in case we need to restore it
 764     if (thread != NULL) thread-&gt;set_saved_exception_pc(pc);
 765 
 766     os::Bsd::ucontext_set_pc(uc, stub);
 767     return true;
 768   }
 769 
 770   // signal-chaining
 771   if (os::Bsd::chained_handler(sig, info, ucVoid)) {
 772      return true;
 773   }
 774 
 775   if (!abort_if_unrecognized) {
 776     // caller wants another chance, so give it to him
 777     return false;
 778   }
 779 
 780   if (pc == NULL &amp;&amp; uc != NULL) {
 781     pc = os::Bsd::ucontext_get_pc(uc);
 782   }
 783 
 784   // unmask current signal
 785   sigset_t newset;
 786   sigemptyset(&amp;newset);
 787   sigaddset(&amp;newset, sig);
 788   sigprocmask(SIG_UNBLOCK, &amp;newset, NULL);
 789 
 790   VMError::report_and_die(t, sig, pc, info, ucVoid);
 791 
 792   ShouldNotReachHere();
 793   return false;
 794 }
 795 
 796 // From solaris_i486.s ported to bsd_i486.s
 797 extern &quot;C&quot; void fixcw();
 798 
 799 void os::Bsd::init_thread_fpu_state(void) {
 800 #ifndef AMD64
 801   // Set fpu to 53 bit precision. This happens too early to use a stub.
 802   fixcw();
 803 #endif // !AMD64
 804 }
 805 
 806 
 807 // Check that the bsd kernel version is 2.4 or higher since earlier
 808 // versions do not support SSE without patches.
 809 bool os::supports_sse() {
 810   return true;
 811 }
 812 
 813 bool os::is_allocatable(size_t bytes) {
 814 #ifdef AMD64
 815   // unused on amd64?
 816   return true;
 817 #else
 818 
 819   if (bytes &lt; 2 * G) {
 820     return true;
 821   }
 822 
 823   char* addr = reserve_memory(bytes, NULL);
 824 
 825   if (addr != NULL) {
 826     release_memory(addr, bytes);
 827   }
 828 
 829   return addr != NULL;
 830 #endif // AMD64
 831 }
 832 
 833 ////////////////////////////////////////////////////////////////////////////////
 834 // thread stack
 835 
 836 // Minimum usable stack sizes required to get to user code. Space for
 837 // HotSpot guard pages is added later.
 838 size_t os::Posix::_compiler_thread_min_stack_allowed = 48 * K;
 839 size_t os::Posix::_java_thread_min_stack_allowed = 48 * K;
 840 #ifdef _LP64
 841 size_t os::Posix::_vm_internal_thread_min_stack_allowed = 64 * K;
 842 #else
 843 size_t os::Posix::_vm_internal_thread_min_stack_allowed = (48 DEBUG_ONLY(+ 4)) * K;
 844 #endif // _LP64
 845 
 846 #ifndef AMD64
 847 #ifdef __GNUC__
 848 #define GET_GS() ({int gs; __asm__ volatile(&quot;movw %%gs, %w0&quot;:&quot;=q&quot;(gs)); gs&amp;0xffff;})
 849 #endif
 850 #endif // AMD64
 851 
 852 // return default stack size for thr_type
 853 size_t os::Posix::default_stack_size(os::ThreadType thr_type) {
 854   // default stack size (compiler thread needs larger stack)
 855 #ifdef AMD64
 856   size_t s = (thr_type == os::compiler_thread ? 4 * M : 1 * M);
 857 #else
 858   size_t s = (thr_type == os::compiler_thread ? 2 * M : 512 * K);
 859 #endif // AMD64
 860   return s;
 861 }
 862 
 863 
 864 // Java thread:
 865 //
 866 //   Low memory addresses
 867 //    +------------------------+
 868 //    |                        |\  Java thread created by VM does not have glibc
 869 //    |    glibc guard page    | - guard, attached Java thread usually has
 870 //    |                        |/  1 glibc guard page.
 871 // P1 +------------------------+ Thread::stack_base() - Thread::stack_size()
 872 //    |                        |\
 873 //    |  HotSpot Guard Pages   | - red, yellow and reserved pages
 874 //    |                        |/
 875 //    +------------------------+ JavaThread::stack_reserved_zone_base()
 876 //    |                        |\
 877 //    |      Normal Stack      | -
 878 //    |                        |/
 879 // P2 +------------------------+ Thread::stack_base()
 880 //
 881 // Non-Java thread:
 882 //
 883 //   Low memory addresses
 884 //    +------------------------+
 885 //    |                        |\
 886 //    |  glibc guard page      | - usually 1 page
 887 //    |                        |/
 888 // P1 +------------------------+ Thread::stack_base() - Thread::stack_size()
 889 //    |                        |\
 890 //    |      Normal Stack      | -
 891 //    |                        |/
 892 // P2 +------------------------+ Thread::stack_base()
 893 //
 894 // ** P1 (aka bottom) and size ( P2 = P1 - size) are the address and stack size returned from
 895 //    pthread_attr_getstack()
 896 
 897 static void current_stack_region(address * bottom, size_t * size) {
 898 #ifdef __APPLE__
 899   pthread_t self = pthread_self();
 900   void *stacktop = pthread_get_stackaddr_np(self);
 901   *size = pthread_get_stacksize_np(self);
 902   // workaround for OS X 10.9.0 (Mavericks)
 903   // pthread_get_stacksize_np returns 128 pages even though the actual size is 2048 pages
 904   if (pthread_main_np() == 1) {
 905     // At least on Mac OS 10.12 we have observed stack sizes not aligned
 906     // to pages boundaries. This can be provoked by e.g. setrlimit() (ulimit -s xxxx in the
 907     // shell). Apparently Mac OS actually rounds upwards to next multiple of page size,
 908     // however, we round downwards here to be on the safe side.
 909     *size = align_down(*size, getpagesize());
 910 
 911     if ((*size) &lt; (DEFAULT_MAIN_THREAD_STACK_PAGES * (size_t)getpagesize())) {
 912       char kern_osrelease[256];
 913       size_t kern_osrelease_size = sizeof(kern_osrelease);
 914       int ret = sysctlbyname(&quot;kern.osrelease&quot;, kern_osrelease, &amp;kern_osrelease_size, NULL, 0);
 915       if (ret == 0) {
 916         // get the major number, atoi will ignore the minor amd micro portions of the version string
 917         if (atoi(kern_osrelease) &gt;= OS_X_10_9_0_KERNEL_MAJOR_VERSION) {
 918           *size = (DEFAULT_MAIN_THREAD_STACK_PAGES*getpagesize());
 919         }
 920       }
 921     }
 922   }
 923   *bottom = (address) stacktop - *size;
 924 #elif defined(__OpenBSD__)
 925   stack_t ss;
 926   int rslt = pthread_stackseg_np(pthread_self(), &amp;ss);
 927 
 928   if (rslt != 0)
 929     fatal(&quot;pthread_stackseg_np failed with error = %d&quot;, rslt);
 930 
 931   *bottom = (address)((char *)ss.ss_sp - ss.ss_size);
 932   *size   = ss.ss_size;
 933 #else
 934   pthread_attr_t attr;
 935 
 936   int rslt = pthread_attr_init(&amp;attr);
 937 
 938   // JVM needs to know exact stack location, abort if it fails
 939   if (rslt != 0)
 940     fatal(&quot;pthread_attr_init failed with error = %d&quot;, rslt);
 941 
 942   rslt = pthread_attr_get_np(pthread_self(), &amp;attr);
 943 
 944   if (rslt != 0)
 945     fatal(&quot;pthread_attr_get_np failed with error = %d&quot;, rslt);
 946 
 947   if (pthread_attr_getstackaddr(&amp;attr, (void **)bottom) != 0 ||
 948     pthread_attr_getstacksize(&amp;attr, size) != 0) {
 949     fatal(&quot;Can not locate current stack attributes!&quot;);
 950   }
 951 
 952   pthread_attr_destroy(&amp;attr);
 953 #endif
 954   assert(os::current_stack_pointer() &gt;= *bottom &amp;&amp;
 955          os::current_stack_pointer() &lt; *bottom + *size, &quot;just checking&quot;);
 956 }
 957 
 958 address os::current_stack_base() {
 959   address bottom;
 960   size_t size;
 961   current_stack_region(&amp;bottom, &amp;size);
 962   return (bottom + size);
 963 }
 964 
 965 size_t os::current_stack_size() {
 966   // stack size includes normal stack and HotSpot guard pages
 967   address bottom;
 968   size_t size;
 969   current_stack_region(&amp;bottom, &amp;size);
 970   return size;
 971 }
 972 
 973 /////////////////////////////////////////////////////////////////////////////
 974 // helper functions for fatal error handler
 975 
 976 void os::print_context(outputStream *st, const void *context) {
 977   if (context == NULL) return;
 978 
 979   const ucontext_t *uc = (const ucontext_t*)context;
 980   st-&gt;print_cr(&quot;Registers:&quot;);
 981 #ifdef AMD64
 982   st-&gt;print(  &quot;RAX=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_rax);
 983   st-&gt;print(&quot;, RBX=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_rbx);
 984   st-&gt;print(&quot;, RCX=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_rcx);
 985   st-&gt;print(&quot;, RDX=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_rdx);
 986   st-&gt;cr();
 987   st-&gt;print(  &quot;RSP=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_rsp);
 988   st-&gt;print(&quot;, RBP=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_rbp);
 989   st-&gt;print(&quot;, RSI=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_rsi);
 990   st-&gt;print(&quot;, RDI=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_rdi);
 991   st-&gt;cr();
 992   st-&gt;print(  &quot;R8 =&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_r8);
 993   st-&gt;print(&quot;, R9 =&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_r9);
 994   st-&gt;print(&quot;, R10=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_r10);
 995   st-&gt;print(&quot;, R11=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_r11);
 996   st-&gt;cr();
 997   st-&gt;print(  &quot;R12=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_r12);
 998   st-&gt;print(&quot;, R13=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_r13);
 999   st-&gt;print(&quot;, R14=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_r14);
1000   st-&gt;print(&quot;, R15=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_r15);
1001   st-&gt;cr();
1002   st-&gt;print(  &quot;RIP=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_rip);
1003   st-&gt;print(&quot;, EFLAGS=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_flags);
1004   st-&gt;print(&quot;, ERR=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_err);
1005   st-&gt;cr();
1006   st-&gt;print(&quot;  TRAPNO=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_trapno);
1007 #else
1008   st-&gt;print(  &quot;EAX=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_eax);
1009   st-&gt;print(&quot;, EBX=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_ebx);
1010   st-&gt;print(&quot;, ECX=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_ecx);
1011   st-&gt;print(&quot;, EDX=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_edx);
1012   st-&gt;cr();
1013   st-&gt;print(  &quot;ESP=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_esp);
1014   st-&gt;print(&quot;, EBP=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_ebp);
1015   st-&gt;print(&quot;, ESI=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_esi);
1016   st-&gt;print(&quot;, EDI=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_edi);
1017   st-&gt;cr();
1018   st-&gt;print(  &quot;EIP=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_eip);
1019   st-&gt;print(&quot;, EFLAGS=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_eflags);
1020 #endif // AMD64
1021   st-&gt;cr();
1022   st-&gt;cr();
1023 
1024   intptr_t *sp = (intptr_t *)os::Bsd::ucontext_get_sp(uc);
1025   st-&gt;print_cr(&quot;Top of Stack: (sp=&quot; INTPTR_FORMAT &quot;)&quot;, (intptr_t)sp);
1026   print_hex_dump(st, (address)sp, (address)(sp + 8*sizeof(intptr_t)), sizeof(intptr_t));
1027   st-&gt;cr();
1028 
1029   // Note: it may be unsafe to inspect memory near pc. For example, pc may
1030   // point to garbage if entry point in an nmethod is corrupted. Leave
1031   // this at the end, and hope for the best.
1032   address pc = os::Bsd::ucontext_get_pc(uc);
1033   print_instructions(st, pc, sizeof(char));
1034   st-&gt;cr();
1035 }
1036 
1037 void os::print_register_info(outputStream *st, const void *context) {
1038   if (context == NULL) return;
1039 
1040   const ucontext_t *uc = (const ucontext_t*)context;
1041 
1042   st-&gt;print_cr(&quot;Register to memory mapping:&quot;);
1043   st-&gt;cr();
1044 
1045   // this is horrendously verbose but the layout of the registers in the
1046   // context does not match how we defined our abstract Register set, so
1047   // we can&#39;t just iterate through the gregs area
1048 
1049   // this is only for the &quot;general purpose&quot; registers
1050 
1051 #ifdef AMD64
1052   st-&gt;print(&quot;RAX=&quot;); print_location(st, uc-&gt;context_rax);
1053   st-&gt;print(&quot;RBX=&quot;); print_location(st, uc-&gt;context_rbx);
1054   st-&gt;print(&quot;RCX=&quot;); print_location(st, uc-&gt;context_rcx);
1055   st-&gt;print(&quot;RDX=&quot;); print_location(st, uc-&gt;context_rdx);
1056   st-&gt;print(&quot;RSP=&quot;); print_location(st, uc-&gt;context_rsp);
1057   st-&gt;print(&quot;RBP=&quot;); print_location(st, uc-&gt;context_rbp);
1058   st-&gt;print(&quot;RSI=&quot;); print_location(st, uc-&gt;context_rsi);
1059   st-&gt;print(&quot;RDI=&quot;); print_location(st, uc-&gt;context_rdi);
1060   st-&gt;print(&quot;R8 =&quot;); print_location(st, uc-&gt;context_r8);
1061   st-&gt;print(&quot;R9 =&quot;); print_location(st, uc-&gt;context_r9);
1062   st-&gt;print(&quot;R10=&quot;); print_location(st, uc-&gt;context_r10);
1063   st-&gt;print(&quot;R11=&quot;); print_location(st, uc-&gt;context_r11);
1064   st-&gt;print(&quot;R12=&quot;); print_location(st, uc-&gt;context_r12);
1065   st-&gt;print(&quot;R13=&quot;); print_location(st, uc-&gt;context_r13);
1066   st-&gt;print(&quot;R14=&quot;); print_location(st, uc-&gt;context_r14);
1067   st-&gt;print(&quot;R15=&quot;); print_location(st, uc-&gt;context_r15);
1068 #else
1069   st-&gt;print(&quot;EAX=&quot;); print_location(st, uc-&gt;context_eax);
1070   st-&gt;print(&quot;EBX=&quot;); print_location(st, uc-&gt;context_ebx);
1071   st-&gt;print(&quot;ECX=&quot;); print_location(st, uc-&gt;context_ecx);
1072   st-&gt;print(&quot;EDX=&quot;); print_location(st, uc-&gt;context_edx);
1073   st-&gt;print(&quot;ESP=&quot;); print_location(st, uc-&gt;context_esp);
1074   st-&gt;print(&quot;EBP=&quot;); print_location(st, uc-&gt;context_ebp);
1075   st-&gt;print(&quot;ESI=&quot;); print_location(st, uc-&gt;context_esi);
1076   st-&gt;print(&quot;EDI=&quot;); print_location(st, uc-&gt;context_edi);
1077 #endif // AMD64
1078 
1079   st-&gt;cr();
1080 }
1081 
1082 void os::setup_fpu() {
1083 #ifndef AMD64
1084   address fpu_cntrl = StubRoutines::addr_fpu_cntrl_wrd_std();
1085   __asm__ volatile (  &quot;fldcw (%0)&quot; :
1086                       : &quot;r&quot; (fpu_cntrl) : &quot;memory&quot;);
1087 #endif // !AMD64
1088 }
1089 
1090 #ifndef PRODUCT
1091 void os::verify_stack_alignment() {
1092 }
1093 #endif
1094 
1095 int os::extra_bang_size_in_bytes() {
1096   // JDK-8050147 requires the full cache line bang for x86.
1097   return VM_Version::L1_line_size();
1098 }
<a name="3" id="anc3"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="3" type="hidden" />
</body>
</html>