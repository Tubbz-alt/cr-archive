<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/share/utilities/vmError.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 2003, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;jvm.h&quot;
  27 #include &quot;code/codeCache.hpp&quot;
  28 #include &quot;compiler/compileBroker.hpp&quot;
  29 #include &quot;compiler/disassembler.hpp&quot;
  30 #include &quot;gc/shared/gcConfig.hpp&quot;
  31 #include &quot;logging/logConfiguration.hpp&quot;
  32 #include &quot;memory/resourceArea.hpp&quot;
  33 #include &quot;memory/universe.hpp&quot;
  34 #include &quot;oops/compressedOops.hpp&quot;
  35 #include &quot;prims/whitebox.hpp&quot;
  36 #include &quot;runtime/arguments.hpp&quot;
  37 #include &quot;runtime/atomic.hpp&quot;
  38 #include &quot;runtime/frame.inline.hpp&quot;
  39 #include &quot;runtime/init.hpp&quot;
  40 #include &quot;runtime/os.hpp&quot;
  41 #include &quot;runtime/safepointMechanism.hpp&quot;
  42 #include &quot;runtime/thread.inline.hpp&quot;
  43 #include &quot;runtime/threadSMR.hpp&quot;
  44 #include &quot;runtime/vmThread.hpp&quot;
  45 #include &quot;runtime/vmOperations.hpp&quot;
  46 #include &quot;runtime/vm_version.hpp&quot;
  47 #include &quot;runtime/flags/jvmFlag.hpp&quot;
  48 #include &quot;services/memTracker.hpp&quot;
  49 #include &quot;utilities/debug.hpp&quot;
  50 #include &quot;utilities/decoder.hpp&quot;
  51 #include &quot;utilities/defaultStream.hpp&quot;
  52 #include &quot;utilities/events.hpp&quot;
  53 #include &quot;utilities/vmError.hpp&quot;
  54 #include &quot;utilities/macros.hpp&quot;
  55 #if INCLUDE_JFR
  56 #include &quot;jfr/jfr.hpp&quot;
  57 #endif
  58 
  59 #ifndef PRODUCT
  60 #include &lt;signal.h&gt;
  61 #endif // PRODUCT
  62 
  63 bool VMError::_error_reported = false;
  64 
  65 // call this when the VM is dying--it might loosen some asserts
  66 bool VMError::is_error_reported() { return _error_reported; }
  67 
  68 // returns an address which is guaranteed to generate a SIGSEGV on read,
  69 // for test purposes, which is not NULL and contains bits in every word
  70 void* VMError::get_segfault_address() {
  71   return (void*)
  72 #ifdef _LP64
  73     0xABC0000000000ABCULL;
  74 #else
  75     0x00000ABC;
  76 #endif
  77 }
  78 
  79 // List of environment variables that should be reported in error log file.
  80 const char *env_list[] = {
  81   // All platforms
  82   &quot;JAVA_HOME&quot;, &quot;JAVA_TOOL_OPTIONS&quot;, &quot;_JAVA_OPTIONS&quot;, &quot;CLASSPATH&quot;,
  83   &quot;PATH&quot;, &quot;USERNAME&quot;,
  84 
<a name="1" id="anc1"></a><span class="line-modified">  85   // Env variables that are defined on Linux/BSD</span>
  86   &quot;LD_LIBRARY_PATH&quot;, &quot;LD_PRELOAD&quot;, &quot;SHELL&quot;, &quot;DISPLAY&quot;,
  87   &quot;HOSTTYPE&quot;, &quot;OSTYPE&quot;, &quot;ARCH&quot;, &quot;MACHTYPE&quot;,
  88   &quot;LANG&quot;, &quot;LC_ALL&quot;, &quot;LC_CTYPE&quot;, &quot;TZ&quot;,
  89 
  90   // defined on AIX
  91   &quot;LIBPATH&quot;, &quot;LDR_PRELOAD&quot;, &quot;LDR_PRELOAD64&quot;,
  92 
  93   // defined on Linux/AIX/BSD
  94   &quot;_JAVA_SR_SIGNUM&quot;,
  95 
  96   // defined on Darwin
  97   &quot;DYLD_LIBRARY_PATH&quot;, &quot;DYLD_FALLBACK_LIBRARY_PATH&quot;,
  98   &quot;DYLD_FRAMEWORK_PATH&quot;, &quot;DYLD_FALLBACK_FRAMEWORK_PATH&quot;,
  99   &quot;DYLD_INSERT_LIBRARIES&quot;,
 100 
 101   // defined on Windows
 102   &quot;OS&quot;, &quot;PROCESSOR_IDENTIFIER&quot;, &quot;_ALT_JAVA_HOME_DIR&quot;,
 103 
 104   (const char *)0
 105 };
 106 
 107 // A simple parser for -XX:OnError, usage:
 108 //  ptr = OnError;
 109 //  while ((cmd = next_OnError_command(buffer, sizeof(buffer), &amp;ptr) != NULL)
 110 //     ... ...
 111 static char* next_OnError_command(char* buf, int buflen, const char** ptr) {
 112   if (ptr == NULL || *ptr == NULL) return NULL;
 113 
 114   const char* cmd = *ptr;
 115 
 116   // skip leading blanks or &#39;;&#39;
 117   while (*cmd == &#39; &#39; || *cmd == &#39;;&#39;) cmd++;
 118 
 119   if (*cmd == &#39;\0&#39;) return NULL;
 120 
 121   const char * cmdend = cmd;
 122   while (*cmdend != &#39;\0&#39; &amp;&amp; *cmdend != &#39;;&#39;) cmdend++;
 123 
 124   Arguments::copy_expand_pid(cmd, cmdend - cmd, buf, buflen);
 125 
 126   *ptr = (*cmdend == &#39;\0&#39; ? cmdend : cmdend + 1);
 127   return buf;
 128 }
 129 
 130 static void print_bug_submit_message(outputStream *out, Thread *thread) {
 131   if (out == NULL) return;
 132   const char *url = Arguments::java_vendor_url_bug();
 133   if (url == NULL || *url == &#39;\0&#39;)
 134     url = JDK_Version::runtime_vendor_vm_bug_url();
 135   if (url != NULL &amp;&amp; *url != &#39;\0&#39;) {
 136     out-&gt;print_raw_cr(&quot;# If you would like to submit a bug report, please visit:&quot;);
 137     out-&gt;print_raw   (&quot;#   &quot;);
 138     out-&gt;print_raw_cr(url);
 139   }
 140   // If the crash is in native code, encourage user to submit a bug to the
 141   // provider of that code.
 142   if (thread &amp;&amp; thread-&gt;is_Java_thread() &amp;&amp;
 143       !thread-&gt;is_hidden_from_external_view()) {
 144     JavaThread* jt = (JavaThread*)thread;
 145     if (jt-&gt;thread_state() == _thread_in_native) {
 146       out-&gt;print_cr(&quot;# The crash happened outside the Java Virtual Machine in native code.\n# See problematic frame for where to report the bug.&quot;);
 147     }
 148   }
 149   out-&gt;print_raw_cr(&quot;#&quot;);
 150 }
 151 
 152 bool VMError::coredump_status;
 153 char VMError::coredump_message[O_BUFLEN];
 154 
 155 void VMError::record_coredump_status(const char* message, bool status) {
 156   coredump_status = status;
 157   strncpy(coredump_message, message, sizeof(coredump_message));
 158   coredump_message[sizeof(coredump_message)-1] = 0;
 159 }
 160 
 161 // Return a string to describe the error
 162 char* VMError::error_string(char* buf, int buflen) {
 163   char signame_buf[64];
 164   const char *signame = os::exception_name(_id, signame_buf, sizeof(signame_buf));
 165 
 166   if (signame) {
 167     jio_snprintf(buf, buflen,
 168                  &quot;%s (0x%x) at pc=&quot; PTR_FORMAT &quot;, pid=%d, tid=&quot; UINTX_FORMAT,
 169                  signame, _id, _pc,
 170                  os::current_process_id(), os::current_thread_id());
 171   } else if (_filename != NULL &amp;&amp; _lineno &gt; 0) {
 172     // skip directory names
 173     char separator = os::file_separator()[0];
 174     const char *p = strrchr(_filename, separator);
 175     int n = jio_snprintf(buf, buflen,
 176                          &quot;Internal Error at %s:%d, pid=%d, tid=&quot; UINTX_FORMAT,
 177                          p ? p + 1 : _filename, _lineno,
 178                          os::current_process_id(), os::current_thread_id());
 179     if (n &gt;= 0 &amp;&amp; n &lt; buflen &amp;&amp; _message) {
 180       if (strlen(_detail_msg) &gt; 0) {
 181         jio_snprintf(buf + n, buflen - n, &quot;%s%s: %s&quot;,
 182         os::line_separator(), _message, _detail_msg);
 183       } else {
 184         jio_snprintf(buf + n, buflen - n, &quot;%sError: %s&quot;,
 185                      os::line_separator(), _message);
 186       }
 187     }
 188   } else {
 189     jio_snprintf(buf, buflen,
 190                  &quot;Internal Error (0x%x), pid=%d, tid=&quot; UINTX_FORMAT,
 191                  _id, os::current_process_id(), os::current_thread_id());
 192   }
 193 
 194   return buf;
 195 }
 196 
 197 void VMError::print_stack_trace(outputStream* st, JavaThread* jt,
 198                                 char* buf, int buflen, bool verbose) {
 199 #ifdef ZERO
 200   if (jt-&gt;zero_stack()-&gt;sp() &amp;&amp; jt-&gt;top_zero_frame()) {
 201     // StackFrameStream uses the frame anchor, which may not have
 202     // been set up.  This can be done at any time in Zero, however,
 203     // so if it hasn&#39;t been set up then we just set it up now and
 204     // clear it again when we&#39;re done.
 205     bool has_last_Java_frame = jt-&gt;has_last_Java_frame();
 206     if (!has_last_Java_frame)
 207       jt-&gt;set_last_Java_frame();
 208     st-&gt;print(&quot;Java frames:&quot;);
 209     st-&gt;cr();
 210 
 211     // Print the frames
 212     StackFrameStream sfs(jt);
 213     for(int i = 0; !sfs.is_done(); sfs.next(), i++) {
 214       sfs.current()-&gt;zero_print_on_error(i, st, buf, buflen);
 215       st-&gt;cr();
 216     }
 217 
 218     // Reset the frame anchor if necessary
 219     if (!has_last_Java_frame)
 220       jt-&gt;reset_last_Java_frame();
 221   }
 222 #else
 223   if (jt-&gt;has_last_Java_frame()) {
 224     st-&gt;print_cr(&quot;Java frames: (J=compiled Java code, j=interpreted, Vv=VM code)&quot;);
 225     for(StackFrameStream sfs(jt); !sfs.is_done(); sfs.next()) {
 226       sfs.current()-&gt;print_on_error(st, buf, buflen, verbose);
 227       st-&gt;cr();
 228     }
 229   }
 230 #endif // ZERO
 231 }
 232 
 233 void VMError::print_native_stack(outputStream* st, frame fr, Thread* t, char* buf, int buf_size) {
 234 
 235   // see if it&#39;s a valid frame
 236   if (fr.pc()) {
 237     st-&gt;print_cr(&quot;Native frames: (J=compiled Java code, A=aot compiled Java code, j=interpreted, Vv=VM code, C=native code)&quot;);
 238 
 239     int count = 0;
 240     while (count++ &lt; StackPrintLimit) {
 241       fr.print_on_error(st, buf, buf_size);
 242       if (fr.pc()) { // print source file and line, if available
 243         char buf[128];
 244         int line_no;
 245         if (Decoder::get_source_info(fr.pc(), buf, sizeof(buf), &amp;line_no)) {
 246           st-&gt;print(&quot;  (%s:%d)&quot;, buf, line_no);
 247         }
 248       }
 249       st-&gt;cr();
 250       // Compiled code may use EBP register on x86 so it looks like
 251       // non-walkable C frame. Use frame.sender() for java frames.
 252       if (t &amp;&amp; t-&gt;is_Java_thread()) {
 253         // Catch very first native frame by using stack address.
 254         // For JavaThread stack_base and stack_size should be set.
 255         if (!t-&gt;is_in_full_stack((address)(fr.real_fp() + 1))) {
 256           break;
 257         }
 258         if (fr.is_java_frame() || fr.is_native_frame() || fr.is_runtime_frame()) {
 259           RegisterMap map((JavaThread*)t, false); // No update
 260           fr = fr.sender(&amp;map);
 261         } else {
 262           // is_first_C_frame() does only simple checks for frame pointer,
 263           // it will pass if java compiled code has a pointer in EBP.
 264           if (os::is_first_C_frame(&amp;fr)) break;
 265           fr = os::get_sender_for_C_frame(&amp;fr);
 266         }
 267       } else {
 268         if (os::is_first_C_frame(&amp;fr)) break;
 269         fr = os::get_sender_for_C_frame(&amp;fr);
 270       }
 271     }
 272 
 273     if (count &gt; StackPrintLimit) {
 274       st-&gt;print_cr(&quot;...&lt;more frames&gt;...&quot;);
 275     }
 276 
 277     st-&gt;cr();
 278   }
 279 }
 280 
 281 static void print_oom_reasons(outputStream* st) {
 282   st-&gt;print_cr(&quot;# Possible reasons:&quot;);
 283   st-&gt;print_cr(&quot;#   The system is out of physical RAM or swap space&quot;);
 284   if (UseCompressedOops) {
 285     st-&gt;print_cr(&quot;#   The process is running with CompressedOops enabled, and the Java Heap may be blocking the growth of the native heap&quot;);
 286   }
 287   if (LogBytesPerWord == 2) {
 288     st-&gt;print_cr(&quot;#   In 32 bit mode, the process size limit was hit&quot;);
 289   }
 290   st-&gt;print_cr(&quot;# Possible solutions:&quot;);
 291   st-&gt;print_cr(&quot;#   Reduce memory load on the system&quot;);
 292   st-&gt;print_cr(&quot;#   Increase physical memory or swap space&quot;);
 293   st-&gt;print_cr(&quot;#   Check if swap backing store is full&quot;);
 294   if (LogBytesPerWord == 2) {
 295     st-&gt;print_cr(&quot;#   Use 64 bit Java on a 64 bit OS&quot;);
 296   }
 297   st-&gt;print_cr(&quot;#   Decrease Java heap size (-Xmx/-Xms)&quot;);
 298   st-&gt;print_cr(&quot;#   Decrease number of Java threads&quot;);
 299   st-&gt;print_cr(&quot;#   Decrease Java thread stack sizes (-Xss)&quot;);
 300   st-&gt;print_cr(&quot;#   Set larger code cache with -XX:ReservedCodeCacheSize=&quot;);
 301   if (UseCompressedOops) {
 302     switch (CompressedOops::mode()) {
 303       case CompressedOops::UnscaledNarrowOop:
 304         st-&gt;print_cr(&quot;#   JVM is running with Unscaled Compressed Oops mode in which the Java heap is&quot;);
 305         st-&gt;print_cr(&quot;#     placed in the first 4GB address space. The Java Heap base address is the&quot;);
 306         st-&gt;print_cr(&quot;#     maximum limit for the native heap growth. Please use -XX:HeapBaseMinAddress&quot;);
 307         st-&gt;print_cr(&quot;#     to set the Java Heap base and to place the Java Heap above 4GB virtual address.&quot;);
 308         break;
 309       case CompressedOops::ZeroBasedNarrowOop:
 310         st-&gt;print_cr(&quot;#   JVM is running with Zero Based Compressed Oops mode in which the Java heap is&quot;);
 311         st-&gt;print_cr(&quot;#     placed in the first 32GB address space. The Java Heap base address is the&quot;);
 312         st-&gt;print_cr(&quot;#     maximum limit for the native heap growth. Please use -XX:HeapBaseMinAddress&quot;);
 313         st-&gt;print_cr(&quot;#     to set the Java Heap base and to place the Java Heap above 32GB virtual address.&quot;);
 314         break;
 315       default:
 316         break;
 317     }
 318   }
 319   st-&gt;print_cr(&quot;# This output file may be truncated or incomplete.&quot;);
 320 }
 321 
 322 static void report_vm_version(outputStream* st, char* buf, int buflen) {
 323    // VM version
 324    st-&gt;print_cr(&quot;#&quot;);
 325    JDK_Version::current().to_string(buf, buflen);
 326    const char* runtime_name = JDK_Version::runtime_name() != NULL ?
 327                                 JDK_Version::runtime_name() : &quot;&quot;;
 328    const char* runtime_version = JDK_Version::runtime_version() != NULL ?
 329                                    JDK_Version::runtime_version() : &quot;&quot;;
 330    const char* vendor_version = JDK_Version::runtime_vendor_version() != NULL ?
 331                                   JDK_Version::runtime_vendor_version() : &quot;&quot;;
 332    const char* jdk_debug_level = VM_Version::printable_jdk_debug_level() != NULL ?
 333                                    VM_Version::printable_jdk_debug_level() : &quot;&quot;;
 334 
 335    st-&gt;print_cr(&quot;# JRE version: %s%s%s (%s) (%sbuild %s)&quot;, runtime_name,
 336                 (*vendor_version != &#39;\0&#39;) ? &quot; &quot; : &quot;&quot;, vendor_version,
 337                 buf, jdk_debug_level, runtime_version);
 338 
 339    // This is the long version with some default settings added
 340    st-&gt;print_cr(&quot;# Java VM: %s%s%s (%s%s, %s%s%s%s%s, %s, %s)&quot;,
 341                  VM_Version::vm_name(),
 342                 (*vendor_version != &#39;\0&#39;) ? &quot; &quot; : &quot;&quot;, vendor_version,
 343                  jdk_debug_level,
 344                  VM_Version::vm_release(),
 345                  VM_Version::vm_info_string(),
 346                  TieredCompilation ? &quot;, tiered&quot; : &quot;&quot;,
 347 #if INCLUDE_JVMCI
 348                  EnableJVMCI ? &quot;, jvmci&quot; : &quot;&quot;,
 349                  UseJVMCICompiler ? &quot;, jvmci compiler&quot; : &quot;&quot;,
 350 #else
 351                  &quot;&quot;, &quot;&quot;,
 352 #endif
 353                  UseCompressedOops ? &quot;, compressed oops&quot; : &quot;&quot;,
 354                  GCConfig::hs_err_name(),
 355                  VM_Version::vm_platform_string()
 356                );
 357 }
 358 
 359 // This is the main function to report a fatal error. Only one thread can
 360 // call this function, so we don&#39;t need to worry about MT-safety. But it&#39;s
 361 // possible that the error handler itself may crash or die on an internal
 362 // error, for example, when the stack/heap is badly damaged. We must be
 363 // able to handle recursive errors that happen inside error handler.
 364 //
 365 // Error reporting is done in several steps. If a crash or internal error
 366 // occurred when reporting an error, the nested signal/exception handler
 367 // can skip steps that are already (or partially) done. Error reporting will
 368 // continue from the next step. This allows us to retrieve and print
 369 // information that may be unsafe to get after a fatal error. If it happens,
 370 // you may find nested report_and_die() frames when you look at the stack
 371 // in a debugger.
 372 //
 373 // In general, a hang in error handler is much worse than a crash or internal
 374 // error, as it&#39;s harder to recover from a hang. Deadlock can happen if we
 375 // try to grab a lock that is already owned by current thread, or if the
 376 // owner is blocked forever (e.g. in os::infinite_sleep()). If possible, the
 377 // error handler and all the functions it called should avoid grabbing any
 378 // lock. An important thing to notice is that memory allocation needs a lock.
 379 //
 380 // We should avoid using large stack allocated buffers. Many errors happen
 381 // when stack space is already low. Making things even worse is that there
 382 // could be nested report_and_die() calls on stack (see above). Only one
 383 // thread can report error, so large buffers are statically allocated in data
 384 // segment.
 385 
 386 int          VMError::_current_step;
 387 const char*  VMError::_current_step_info;
 388 
 389 volatile jlong VMError::_reporting_start_time = -1;
 390 volatile bool VMError::_reporting_did_timeout = false;
 391 volatile jlong VMError::_step_start_time = -1;
 392 volatile bool VMError::_step_did_timeout = false;
 393 
 394 // Helper, return current timestamp for timeout handling.
 395 jlong VMError::get_current_timestamp() {
 396   return os::javaTimeNanos();
 397 }
 398 // Factor to translate the timestamp to seconds.
 399 #define TIMESTAMP_TO_SECONDS_FACTOR (1000 * 1000 * 1000)
 400 
 401 void VMError::record_reporting_start_time() {
 402   const jlong now = get_current_timestamp();
 403   Atomic::store(&amp;_reporting_start_time, now);
 404 }
 405 
 406 jlong VMError::get_reporting_start_time() {
 407   return Atomic::load(&amp;_reporting_start_time);
 408 }
 409 
 410 void VMError::record_step_start_time() {
 411   const jlong now = get_current_timestamp();
 412   Atomic::store(&amp;_step_start_time, now);
 413 }
 414 
 415 jlong VMError::get_step_start_time() {
 416   return Atomic::load(&amp;_step_start_time);
 417 }
 418 
 419 void VMError::clear_step_start_time() {
 420   return Atomic::store(&amp;_step_start_time, (jlong)0);
 421 }
 422 
 423 void VMError::report(outputStream* st, bool _verbose) {
 424 
 425 # define BEGIN if (_current_step == 0) { _current_step = __LINE__;
 426 # define STEP(s) } if (_current_step &lt; __LINE__) { _current_step = __LINE__; _current_step_info = s; \
 427   record_step_start_time(); _step_did_timeout = false;
 428 # define END clear_step_start_time(); }
 429 
 430   // don&#39;t allocate large buffer on stack
 431   static char buf[O_BUFLEN];
 432 
 433   BEGIN
 434 
 435   STEP(&quot;printing fatal error message&quot;)
 436 
 437     st-&gt;print_cr(&quot;#&quot;);
 438     if (should_report_bug(_id)) {
 439       st-&gt;print_cr(&quot;# A fatal error has been detected by the Java Runtime Environment:&quot;);
 440     } else {
 441       st-&gt;print_cr(&quot;# There is insufficient memory for the Java &quot;
 442                    &quot;Runtime Environment to continue.&quot;);
 443     }
 444 
 445 #ifndef PRODUCT
 446   // Error handler self tests
 447 
 448   // test secondary error handling. Test it twice, to test that resetting
 449   // error handler after a secondary crash works.
 450   STEP(&quot;test secondary crash 1&quot;)
 451     if (_verbose &amp;&amp; TestCrashInErrorHandler != 0) {
 452       st-&gt;print_cr(&quot;Will crash now (TestCrashInErrorHandler=&quot; UINTX_FORMAT &quot;)...&quot;,
 453         TestCrashInErrorHandler);
 454       controlled_crash(TestCrashInErrorHandler);
 455     }
 456 
 457   STEP(&quot;test secondary crash 2&quot;)
 458     if (_verbose &amp;&amp; TestCrashInErrorHandler != 0) {
 459       st-&gt;print_cr(&quot;Will crash now (TestCrashInErrorHandler=&quot; UINTX_FORMAT &quot;)...&quot;,
 460         TestCrashInErrorHandler);
 461       controlled_crash(TestCrashInErrorHandler);
 462     }
 463 
 464   // TestUnresponsiveErrorHandler: We want to test both step timeouts and global timeout.
 465   // Step to global timeout ratio is 4:1, so in order to be absolutely sure we hit the
 466   // global timeout, let&#39;s execute the timeout step five times.
 467   // See corresponding test in test/runtime/ErrorHandling/TimeoutInErrorHandlingTest.java
 468   STEP(&quot;setup for test unresponsive error reporting step&quot;)
 469     if (_verbose &amp;&amp; TestUnresponsiveErrorHandler) {
 470       // We record reporting_start_time for this test here because we
 471       // care about the time spent executing TIMEOUT_TEST_STEP and not
 472       // about the time it took us to get here.
 473       tty-&gt;print_cr(&quot;Recording reporting_start_time for TestUnresponsiveErrorHandler.&quot;);
 474       record_reporting_start_time();
 475     }
 476 
 477   #define TIMEOUT_TEST_STEP STEP(&quot;test unresponsive error reporting step&quot;) \
 478     if (_verbose &amp;&amp; TestUnresponsiveErrorHandler) { os::infinite_sleep(); }
 479   TIMEOUT_TEST_STEP
 480   TIMEOUT_TEST_STEP
 481   TIMEOUT_TEST_STEP
 482   TIMEOUT_TEST_STEP
 483   TIMEOUT_TEST_STEP
 484 
 485   STEP(&quot;test safefetch in error handler&quot;)
 486     // test whether it is safe to use SafeFetch32 in Crash Handler. Test twice
 487     // to test that resetting the signal handler works correctly.
 488     if (_verbose &amp;&amp; TestSafeFetchInErrorHandler) {
 489       st-&gt;print_cr(&quot;Will test SafeFetch...&quot;);
 490       if (CanUseSafeFetch32()) {
 491         int* const invalid_pointer = (int*) get_segfault_address();
 492         const int x = 0x76543210;
 493         int i1 = SafeFetch32(invalid_pointer, x);
 494         int i2 = SafeFetch32(invalid_pointer, x);
 495         if (i1 == x &amp;&amp; i2 == x) {
 496           st-&gt;print_cr(&quot;SafeFetch OK.&quot;); // Correctly deflected and returned default pattern
 497         } else {
 498           st-&gt;print_cr(&quot;??&quot;);
 499         }
 500       } else {
 501         st-&gt;print_cr(&quot;not possible; skipped.&quot;);
 502       }
 503     }
 504 #endif // PRODUCT
 505 
 506   STEP(&quot;printing type of error&quot;)
 507 
 508      switch(static_cast&lt;unsigned int&gt;(_id)) {
 509        case OOM_MALLOC_ERROR:
 510        case OOM_MMAP_ERROR:
 511          if (_size) {
 512            st-&gt;print(&quot;# Native memory allocation &quot;);
 513            st-&gt;print((_id == (int)OOM_MALLOC_ERROR) ? &quot;(malloc) failed to allocate &quot; :
 514                                                  &quot;(mmap) failed to map &quot;);
 515            jio_snprintf(buf, sizeof(buf), SIZE_FORMAT, _size);
 516            st-&gt;print(&quot;%s&quot;, buf);
 517            st-&gt;print(&quot; bytes&quot;);
 518            if (strlen(_detail_msg) &gt; 0) {
 519              st-&gt;print(&quot; for &quot;);
 520              st-&gt;print(&quot;%s&quot;, _detail_msg);
 521            }
 522            st-&gt;cr();
 523          } else {
 524            if (strlen(_detail_msg) &gt; 0) {
 525              st-&gt;print(&quot;# &quot;);
 526              st-&gt;print_cr(&quot;%s&quot;, _detail_msg);
 527            }
 528          }
 529          // In error file give some solutions
 530          if (_verbose) {
 531            print_oom_reasons(st);
 532          } else {
 533            return;  // that&#39;s enough for the screen
 534          }
 535          break;
 536        case INTERNAL_ERROR:
 537        default:
 538          break;
 539      }
 540 
 541   STEP(&quot;printing exception/signal name&quot;)
 542 
 543      st-&gt;print_cr(&quot;#&quot;);
 544      st-&gt;print(&quot;#  &quot;);
 545      // Is it an OS exception/signal?
 546      if (os::exception_name(_id, buf, sizeof(buf))) {
 547        st-&gt;print(&quot;%s&quot;, buf);
 548        st-&gt;print(&quot; (0x%x)&quot;, _id);                // signal number
 549        st-&gt;print(&quot; at pc=&quot; PTR_FORMAT, p2i(_pc));
 550        if (_siginfo != NULL &amp;&amp; os::signal_sent_by_kill(_siginfo)) {
 551          st-&gt;print(&quot; (sent by kill)&quot;);
 552        }
 553      } else {
 554        if (should_report_bug(_id)) {
 555          st-&gt;print(&quot;Internal Error&quot;);
 556        } else {
 557          st-&gt;print(&quot;Out of Memory Error&quot;);
 558        }
 559        if (_filename != NULL &amp;&amp; _lineno &gt; 0) {
 560 #ifdef PRODUCT
 561          // In product mode chop off pathname?
 562          char separator = os::file_separator()[0];
 563          const char *p = strrchr(_filename, separator);
 564          const char *file = p ? p+1 : _filename;
 565 #else
 566          const char *file = _filename;
 567 #endif
 568          st-&gt;print(&quot; (%s:%d)&quot;, file, _lineno);
 569        } else {
 570          st-&gt;print(&quot; (0x%x)&quot;, _id);
 571        }
 572      }
 573 
 574   STEP(&quot;printing current thread and pid&quot;)
 575 
 576      // process id, thread id
 577      st-&gt;print(&quot;, pid=%d&quot;, os::current_process_id());
 578      st-&gt;print(&quot;, tid=&quot; UINTX_FORMAT, os::current_thread_id());
 579      st-&gt;cr();
 580 
 581   STEP(&quot;printing error message&quot;)
 582 
 583      if (should_report_bug(_id)) {  // already printed the message.
 584        // error message
 585        if (strlen(_detail_msg) &gt; 0) {
 586          st-&gt;print_cr(&quot;#  %s: %s&quot;, _message ? _message : &quot;Error&quot;, _detail_msg);
 587        } else if (_message) {
 588          st-&gt;print_cr(&quot;#  Error: %s&quot;, _message);
 589        }
 590      }
 591 
 592   STEP(&quot;printing Java version string&quot;)
 593 
 594      report_vm_version(st, buf, sizeof(buf));
 595 
 596   STEP(&quot;printing problematic frame&quot;)
 597 
 598      // Print current frame if we have a context (i.e. it&#39;s a crash)
 599      if (_context) {
 600        st-&gt;print_cr(&quot;# Problematic frame:&quot;);
 601        st-&gt;print(&quot;# &quot;);
 602        frame fr = os::fetch_frame_from_context(_context);
 603        fr.print_on_error(st, buf, sizeof(buf));
 604        st-&gt;cr();
 605        st-&gt;print_cr(&quot;#&quot;);
 606      }
 607 
 608   STEP(&quot;printing core file information&quot;)
 609     st-&gt;print(&quot;# &quot;);
 610     if (CreateCoredumpOnCrash) {
 611       if (coredump_status) {
 612         st-&gt;print(&quot;Core dump will be written. Default location: %s&quot;, coredump_message);
 613       } else {
 614         st-&gt;print(&quot;No core dump will be written. %s&quot;, coredump_message);
 615       }
 616     } else {
 617       st-&gt;print(&quot;CreateCoredumpOnCrash turned off, no core file dumped&quot;);
 618     }
 619     st-&gt;cr();
 620     st-&gt;print_cr(&quot;#&quot;);
 621 
 622   JFR_ONLY(STEP(&quot;printing jfr information&quot;))
 623   JFR_ONLY(Jfr::on_vm_error_report(st);)
 624 
 625   STEP(&quot;printing bug submit message&quot;)
 626 
 627      if (should_report_bug(_id) &amp;&amp; _verbose) {
 628        print_bug_submit_message(st, _thread);
 629      }
 630 
 631   STEP(&quot;printing summary&quot;)
 632 
 633      if (_verbose) {
 634        st-&gt;cr();
 635        st-&gt;print_cr(&quot;---------------  S U M M A R Y ------------&quot;);
 636        st-&gt;cr();
 637      }
 638 
 639   STEP(&quot;printing VM option summary&quot;)
 640 
 641      if (_verbose) {
 642        // VM options
 643        Arguments::print_summary_on(st);
 644        st-&gt;cr();
 645      }
 646 
 647   STEP(&quot;printing summary machine and OS info&quot;)
 648 
 649      if (_verbose) {
 650        os::print_summary_info(st, buf, sizeof(buf));
 651      }
 652 
 653 
 654   STEP(&quot;printing date and time&quot;)
 655 
 656      if (_verbose) {
 657        os::print_date_and_time(st, buf, sizeof(buf));
 658      }
 659 
 660   STEP(&quot;printing thread&quot;)
 661 
 662      if (_verbose) {
 663        st-&gt;cr();
 664        st-&gt;print_cr(&quot;---------------  T H R E A D  ---------------&quot;);
 665        st-&gt;cr();
 666      }
 667 
 668   STEP(&quot;printing current thread&quot;)
 669 
 670      // current thread
 671      if (_verbose) {
 672        if (_thread) {
 673          st-&gt;print(&quot;Current thread (&quot; PTR_FORMAT &quot;):  &quot;, p2i(_thread));
 674          _thread-&gt;print_on_error(st, buf, sizeof(buf));
 675          st-&gt;cr();
 676        } else {
 677          st-&gt;print_cr(&quot;Current thread is native thread&quot;);
 678        }
 679        st-&gt;cr();
 680      }
 681 
 682   STEP(&quot;printing current compile task&quot;)
 683 
 684      if (_verbose &amp;&amp; _thread &amp;&amp; _thread-&gt;is_Compiler_thread()) {
 685         CompilerThread* t = (CompilerThread*)_thread;
 686         if (t-&gt;task()) {
 687            st-&gt;cr();
 688            st-&gt;print_cr(&quot;Current CompileTask:&quot;);
 689            t-&gt;task()-&gt;print_line_on_error(st, buf, sizeof(buf));
 690            st-&gt;cr();
 691         }
 692      }
 693 
 694 
 695   STEP(&quot;printing stack bounds&quot;)
 696 
 697      if (_verbose) {
 698        st-&gt;print(&quot;Stack: &quot;);
 699 
 700        address stack_top;
 701        size_t stack_size;
 702 
 703        if (_thread) {
 704           stack_top = _thread-&gt;stack_base();
 705           stack_size = _thread-&gt;stack_size();
 706        } else {
 707           stack_top = os::current_stack_base();
 708           stack_size = os::current_stack_size();
 709        }
 710 
 711        address stack_bottom = stack_top - stack_size;
 712        st-&gt;print(&quot;[&quot; PTR_FORMAT &quot;,&quot; PTR_FORMAT &quot;]&quot;, p2i(stack_bottom), p2i(stack_top));
 713 
 714        frame fr = _context ? os::fetch_frame_from_context(_context)
 715                            : os::current_frame();
 716 
 717        if (fr.sp()) {
 718          st-&gt;print(&quot;,  sp=&quot; PTR_FORMAT, p2i(fr.sp()));
 719          size_t free_stack_size = pointer_delta(fr.sp(), stack_bottom, 1024);
 720          st-&gt;print(&quot;,  free space=&quot; SIZE_FORMAT &quot;k&quot;, free_stack_size);
 721        }
 722 
 723        st-&gt;cr();
 724      }
 725 
 726   STEP(&quot;printing native stack&quot;)
 727 
 728    if (_verbose) {
 729      if (os::platform_print_native_stack(st, _context, buf, sizeof(buf))) {
 730        // We have printed the native stack in platform-specific code
 731        // Windows/x64 needs special handling.
 732      } else {
 733        frame fr = _context ? os::fetch_frame_from_context(_context)
 734                            : os::current_frame();
 735 
 736        print_native_stack(st, fr, _thread, buf, sizeof(buf));
 737      }
 738    }
 739 
 740   STEP(&quot;printing Java stack&quot;)
 741 
 742      if (_verbose &amp;&amp; _thread &amp;&amp; _thread-&gt;is_Java_thread()) {
 743        print_stack_trace(st, (JavaThread*)_thread, buf, sizeof(buf));
 744      }
 745 
 746   STEP(&quot;printing target Java thread stack&quot;)
 747 
 748      // printing Java thread stack trace if it is involved in GC crash
 749      if (_verbose &amp;&amp; _thread &amp;&amp; (_thread-&gt;is_Named_thread())) {
 750        JavaThread*  jt = ((NamedThread *)_thread)-&gt;processed_thread();
 751        if (jt != NULL) {
 752          st-&gt;print_cr(&quot;JavaThread &quot; PTR_FORMAT &quot; (nid = %d) was being processed&quot;, p2i(jt), jt-&gt;osthread()-&gt;thread_id());
 753          print_stack_trace(st, jt, buf, sizeof(buf), true);
 754        }
 755      }
 756 
 757   STEP(&quot;printing siginfo&quot;)
 758 
 759      // signal no, signal code, address that caused the fault
 760      if (_verbose &amp;&amp; _siginfo) {
 761        st-&gt;cr();
 762        os::print_siginfo(st, _siginfo);
 763        st-&gt;cr();
 764      }
 765 
 766   STEP(&quot;CDS archive access warning&quot;)
 767 
 768      // Print an explicit hint if we crashed on access to the CDS archive.
 769      if (_verbose &amp;&amp; _siginfo) {
 770        check_failing_cds_access(st, _siginfo);
 771        st-&gt;cr();
 772      }
 773 
 774   STEP(&quot;printing register info&quot;)
 775 
 776      // decode register contents if possible
 777      if (_verbose &amp;&amp; _context &amp;&amp; Universe::is_fully_initialized()) {
 778        os::print_register_info(st, _context);
 779        st-&gt;cr();
 780      }
 781 
 782   STEP(&quot;printing registers, top of stack, instructions near pc&quot;)
 783 
 784      // registers, top of stack, instructions near pc
 785      if (_verbose &amp;&amp; _context) {
 786        os::print_context(st, _context);
 787        st-&gt;cr();
 788      }
 789 
 790   STEP(&quot;inspecting top of stack&quot;)
 791 
 792      // decode stack contents if possible
 793      if (_verbose &amp;&amp; _context &amp;&amp; Universe::is_fully_initialized()) {
 794        frame fr = os::fetch_frame_from_context(_context);
 795        const int slots = 8;
 796        const intptr_t *start = fr.sp();
 797        const intptr_t *end = start + slots;
 798        if (is_aligned(start, sizeof(intptr_t)) &amp;&amp; os::is_readable_range(start, end)) {
 799          st-&gt;print_cr(&quot;Stack slot to memory mapping:&quot;);
 800          for (int i = 0; i &lt; slots; ++i) {
 801            st-&gt;print(&quot;stack at sp + %d slots: &quot;, i);
 802            os::print_location(st, *(start + i));
 803          }
 804        }
 805        st-&gt;cr();
 806      }
 807 
 808   STEP(&quot;printing code blob if possible&quot;)
 809 
 810      if (_verbose &amp;&amp; _context) {
 811        CodeBlob* cb = CodeCache::find_blob(_pc);
 812        if (cb != NULL) {
 813          if (Interpreter::contains(_pc)) {
 814            // The interpreter CodeBlob is very large so try to print the codelet instead.
 815            InterpreterCodelet* codelet = Interpreter::codelet_containing(_pc);
 816            if (codelet != NULL) {
 817              codelet-&gt;print_on(st);
 818              Disassembler::decode(codelet-&gt;code_begin(), codelet-&gt;code_end(), st);
 819            }
 820          } else {
 821            StubCodeDesc* desc = StubCodeDesc::desc_for(_pc);
 822            if (desc != NULL) {
 823              desc-&gt;print_on(st);
 824              Disassembler::decode(desc-&gt;begin(), desc-&gt;end(), st);
 825            } else if (_thread != NULL) {
 826              // Disassembling nmethod will incur resource memory allocation,
 827              // only do so when thread is valid.
 828              ResourceMark rm(_thread);
 829              Disassembler::decode(cb, st);
 830              st-&gt;cr();
 831            }
 832          }
 833        }
 834      }
 835 
 836   STEP(&quot;printing VM operation&quot;)
 837 
 838      if (_verbose &amp;&amp; _thread &amp;&amp; _thread-&gt;is_VM_thread()) {
 839         VMThread* t = (VMThread*)_thread;
 840         VM_Operation* op = t-&gt;vm_operation();
 841         if (op) {
 842           op-&gt;print_on_error(st);
 843           st-&gt;cr();
 844           st-&gt;cr();
 845         }
 846      }
 847 
 848   STEP(&quot;printing process&quot;)
 849 
 850      if (_verbose) {
 851        st-&gt;cr();
 852        st-&gt;print_cr(&quot;---------------  P R O C E S S  ---------------&quot;);
 853        st-&gt;cr();
 854      }
 855 
 856 #ifndef _WIN32
 857   STEP(&quot;printing user info&quot;)
 858 
 859      if (ExtensiveErrorReports &amp;&amp; _verbose) {
 860        os::Posix::print_user_info(st);
 861      }
 862 #endif
 863 
 864   STEP(&quot;printing all threads&quot;)
 865 
 866      // all threads
 867      if (_verbose &amp;&amp; _thread) {
 868        Threads::print_on_error(st, _thread, buf, sizeof(buf));
 869        st-&gt;cr();
 870      }
 871 
 872   STEP(&quot;printing VM state&quot;)
 873 
 874      if (_verbose) {
 875        // Safepoint state
 876        st-&gt;print(&quot;VM state:&quot;);
 877 
 878        if (SafepointSynchronize::is_synchronizing()) st-&gt;print(&quot;synchronizing&quot;);
 879        else if (SafepointSynchronize::is_at_safepoint()) st-&gt;print(&quot;at safepoint&quot;);
 880        else st-&gt;print(&quot;not at safepoint&quot;);
 881 
 882        // Also see if error occurred during initialization or shutdown
 883        if (!Universe::is_fully_initialized()) {
 884          st-&gt;print(&quot; (not fully initialized)&quot;);
 885        } else if (VM_Exit::vm_exited()) {
 886          st-&gt;print(&quot; (shutting down)&quot;);
 887        } else {
 888          st-&gt;print(&quot; (normal execution)&quot;);
 889        }
 890        st-&gt;cr();
 891        st-&gt;cr();
 892      }
 893 
 894   STEP(&quot;printing owned locks on error&quot;)
 895 
 896      // mutexes/monitors that currently have an owner
 897      if (_verbose) {
 898        print_owned_locks_on_error(st);
 899        st-&gt;cr();
 900      }
 901 
 902   STEP(&quot;printing number of OutOfMemoryError and StackOverflow exceptions&quot;)
 903 
 904      if (_verbose &amp;&amp; Exceptions::has_exception_counts()) {
 905        st-&gt;print_cr(&quot;OutOfMemory and StackOverflow Exception counts:&quot;);
 906        Exceptions::print_exception_counts_on_error(st);
 907        st-&gt;cr();
 908      }
 909 
 910   STEP(&quot;printing compressed oops mode&quot;)
 911 
 912      if (_verbose &amp;&amp; UseCompressedOops) {
 913        CompressedOops::print_mode(st);
 914        if (UseCompressedClassPointers) {
 915          Metaspace::print_compressed_class_space(st);
 916        }
 917        st-&gt;cr();
 918      }
 919 
 920   STEP(&quot;printing heap information&quot;)
 921 
 922      if (_verbose &amp;&amp; Universe::is_fully_initialized()) {
 923        Universe::heap()-&gt;print_on_error(st);
 924        st-&gt;cr();
 925        st-&gt;print_cr(&quot;Polling page: &quot; INTPTR_FORMAT, p2i(SafepointMechanism::get_polling_page()));
 926        st-&gt;cr();
 927      }
 928 
 929   STEP(&quot;printing metaspace information&quot;)
 930 
 931      if (_verbose &amp;&amp; Universe::is_fully_initialized()) {
 932        st-&gt;print_cr(&quot;Metaspace:&quot;);
 933        MetaspaceUtils::print_basic_report(st, 0);
 934      }
 935 
 936   STEP(&quot;printing code cache information&quot;)
 937 
 938      if (_verbose &amp;&amp; Universe::is_fully_initialized()) {
 939        // print code cache information before vm abort
 940        CodeCache::print_summary(st);
 941        st-&gt;cr();
 942      }
 943 
 944   STEP(&quot;printing ring buffers&quot;)
 945 
 946      if (_verbose) {
 947        Events::print_all(st);
 948        st-&gt;cr();
 949      }
 950 
 951   STEP(&quot;printing dynamic libraries&quot;)
 952 
 953      if (_verbose) {
 954        // dynamic libraries, or memory map
 955        os::print_dll_info(st);
 956        st-&gt;cr();
 957      }
 958 
 959   STEP(&quot;printing native decoder state&quot;)
 960 
 961      if (_verbose) {
 962        Decoder::print_state_on(st);
 963        st-&gt;cr();
 964      }
 965 
 966   STEP(&quot;printing VM options&quot;)
 967 
 968      if (_verbose) {
 969        // VM options
 970        Arguments::print_on(st);
 971        st-&gt;cr();
 972      }
 973 
 974   STEP(&quot;printing flags&quot;)
 975 
 976     if (_verbose) {
 977       JVMFlag::printFlags(
 978         st,
 979         true, // with comments
 980         false, // no ranges
 981         true); // skip defaults
 982       st-&gt;cr();
 983     }
 984 
 985   STEP(&quot;printing warning if internal testing API used&quot;)
 986 
 987      if (WhiteBox::used()) {
 988        st-&gt;print_cr(&quot;Unsupported internal testing APIs have been used.&quot;);
 989        st-&gt;cr();
 990      }
 991 
 992   STEP(&quot;printing log configuration&quot;)
 993     if (_verbose){
 994       st-&gt;print_cr(&quot;Logging:&quot;);
 995       LogConfiguration::describe_current_configuration(st);
 996       st-&gt;cr();
 997     }
 998 
 999   STEP(&quot;printing all environment variables&quot;)
1000 
1001      if (_verbose) {
1002        os::print_environment_variables(st, env_list);
1003        st-&gt;cr();
1004      }
1005 
1006   STEP(&quot;printing signal handlers&quot;)
1007 
1008      if (_verbose) {
1009        os::print_signal_handlers(st, buf, sizeof(buf));
1010        st-&gt;cr();
1011      }
1012 
1013   STEP(&quot;Native Memory Tracking&quot;)
1014      if (_verbose) {
1015        MemTracker::error_report(st);
1016      }
1017 
1018   STEP(&quot;printing system&quot;)
1019 
1020      if (_verbose) {
1021        st-&gt;cr();
1022        st-&gt;print_cr(&quot;---------------  S Y S T E M  ---------------&quot;);
1023        st-&gt;cr();
1024      }
1025 
1026   STEP(&quot;printing OS information&quot;)
1027 
1028      if (_verbose) {
1029        os::print_os_info(st);
1030        st-&gt;cr();
1031      }
1032 
1033   STEP(&quot;printing CPU info&quot;)
1034      if (_verbose) {
1035        os::print_cpu_info(st, buf, sizeof(buf));
1036        st-&gt;cr();
1037      }
1038 
1039   STEP(&quot;printing memory info&quot;)
1040 
1041      if (_verbose) {
1042        os::print_memory_info(st);
1043        st-&gt;cr();
1044      }
1045 
1046   STEP(&quot;printing internal vm info&quot;)
1047 
1048      if (_verbose) {
1049        st-&gt;print_cr(&quot;vm_info: %s&quot;, VM_Version::internal_vm_info_string());
1050        st-&gt;cr();
1051      }
1052 
1053   // print a defined marker to show that error handling finished correctly.
1054   STEP(&quot;printing end marker&quot;)
1055 
1056      if (_verbose) {
1057        st-&gt;print_cr(&quot;END.&quot;);
1058      }
1059 
1060   END
1061 
1062 # undef BEGIN
1063 # undef STEP
1064 # undef END
1065 }
1066 
1067 // Report for the vm_info_cmd. This prints out the information above omitting
1068 // crash and thread specific information.  If output is added above, it should be added
1069 // here also, if it is safe to call during a running process.
1070 void VMError::print_vm_info(outputStream* st) {
1071 
1072   char buf[O_BUFLEN];
1073   report_vm_version(st, buf, sizeof(buf));
1074 
1075   // STEP(&quot;printing summary&quot;)
1076 
1077   st-&gt;cr();
1078   st-&gt;print_cr(&quot;---------------  S U M M A R Y ------------&quot;);
1079   st-&gt;cr();
1080 
1081   // STEP(&quot;printing VM option summary&quot;)
1082 
1083   // VM options
1084   Arguments::print_summary_on(st);
1085   st-&gt;cr();
1086 
1087   // STEP(&quot;printing summary machine and OS info&quot;)
1088 
1089   os::print_summary_info(st, buf, sizeof(buf));
1090 
1091   // STEP(&quot;printing date and time&quot;)
1092 
1093   os::print_date_and_time(st, buf, sizeof(buf));
1094 
1095   // Skip: STEP(&quot;printing thread&quot;)
1096 
1097   // STEP(&quot;printing process&quot;)
1098 
1099   st-&gt;cr();
1100   st-&gt;print_cr(&quot;---------------  P R O C E S S  ---------------&quot;);
1101   st-&gt;cr();
1102 
1103   // STEP(&quot;printing number of OutOfMemoryError and StackOverflow exceptions&quot;)
1104 
1105   if (Exceptions::has_exception_counts()) {
1106     st-&gt;print_cr(&quot;OutOfMemory and StackOverflow Exception counts:&quot;);
1107     Exceptions::print_exception_counts_on_error(st);
1108     st-&gt;cr();
1109   }
1110 
1111   // STEP(&quot;printing compressed oops mode&quot;)
1112 
1113   if (UseCompressedOops) {
1114     CompressedOops::print_mode(st);
1115     if (UseCompressedClassPointers) {
1116       Metaspace::print_compressed_class_space(st);
1117     }
1118     st-&gt;cr();
1119   }
1120 
1121   // STEP(&quot;printing heap information&quot;)
1122 
1123   if (Universe::is_fully_initialized()) {
1124     MutexLocker hl(Heap_lock);
1125     Universe::heap()-&gt;print_on_error(st);
1126     st-&gt;cr();
1127     st-&gt;print_cr(&quot;Polling page: &quot; INTPTR_FORMAT, p2i(SafepointMechanism::get_polling_page()));
1128     st-&gt;cr();
1129   }
1130 
1131   // STEP(&quot;printing metaspace information&quot;)
1132 
1133   if (Universe::is_fully_initialized()) {
1134     st-&gt;print_cr(&quot;Metaspace:&quot;);
1135     MetaspaceUtils::print_basic_report(st, 0);
1136   }
1137 
1138   // STEP(&quot;printing code cache information&quot;)
1139 
1140   if (Universe::is_fully_initialized()) {
1141     // print code cache information before vm abort
1142     CodeCache::print_summary(st);
1143     st-&gt;cr();
1144   }
1145 
1146   // STEP(&quot;printing ring buffers&quot;)
1147 
1148   Events::print_all(st);
1149   st-&gt;cr();
1150 
1151   // STEP(&quot;printing dynamic libraries&quot;)
1152 
1153   // dynamic libraries, or memory map
1154   os::print_dll_info(st);
1155   st-&gt;cr();
1156 
1157   // STEP(&quot;printing VM options&quot;)
1158 
1159   // VM options
1160   Arguments::print_on(st);
1161   st-&gt;cr();
1162 
1163   // STEP(&quot;printing warning if internal testing API used&quot;)
1164 
1165   if (WhiteBox::used()) {
1166     st-&gt;print_cr(&quot;Unsupported internal testing APIs have been used.&quot;);
1167     st-&gt;cr();
1168   }
1169 
1170   // STEP(&quot;printing log configuration&quot;)
1171   st-&gt;print_cr(&quot;Logging:&quot;);
1172   LogConfiguration::describe(st);
1173   st-&gt;cr();
1174 
1175   // STEP(&quot;printing all environment variables&quot;)
1176 
1177   os::print_environment_variables(st, env_list);
1178   st-&gt;cr();
1179 
1180   // STEP(&quot;printing signal handlers&quot;)
1181 
1182   os::print_signal_handlers(st, buf, sizeof(buf));
1183   st-&gt;cr();
1184 
1185   // STEP(&quot;Native Memory Tracking&quot;)
1186 
1187   MemTracker::error_report(st);
1188 
1189   // STEP(&quot;printing system&quot;)
1190 
1191   st-&gt;cr();
1192   st-&gt;print_cr(&quot;---------------  S Y S T E M  ---------------&quot;);
1193   st-&gt;cr();
1194 
1195   // STEP(&quot;printing OS information&quot;)
1196 
1197   os::print_os_info(st);
1198   st-&gt;cr();
1199 
1200   // STEP(&quot;printing CPU info&quot;)
1201 
1202   os::print_cpu_info(st, buf, sizeof(buf));
1203   st-&gt;cr();
1204 
1205   // STEP(&quot;printing memory info&quot;)
1206 
1207   os::print_memory_info(st);
1208   st-&gt;cr();
1209 
1210   // STEP(&quot;printing internal vm info&quot;)
1211 
1212   st-&gt;print_cr(&quot;vm_info: %s&quot;, VM_Version::internal_vm_info_string());
1213   st-&gt;cr();
1214 
1215   // print a defined marker to show that error handling finished correctly.
1216   // STEP(&quot;printing end marker&quot;)
1217 
1218   st-&gt;print_cr(&quot;END.&quot;);
1219 }
1220 
1221 volatile intptr_t VMError::_first_error_tid = -1;
1222 
1223 /** Expand a pattern into a buffer starting at pos and open a file using constructed path */
1224 static int expand_and_open(const char* pattern, bool overwrite_existing, char* buf, size_t buflen, size_t pos) {
1225   int fd = -1;
1226   int mode = O_RDWR | O_CREAT;
1227   if (overwrite_existing) {
1228     mode |= O_TRUNC;
1229   } else {
1230     mode |= O_EXCL;
1231   }
1232   if (Arguments::copy_expand_pid(pattern, strlen(pattern), &amp;buf[pos], buflen - pos)) {
1233     fd = open(buf, mode, 0666);
1234   }
1235   return fd;
1236 }
1237 
1238 /**
1239  * Construct file name for a log file and return it&#39;s file descriptor.
1240  * Name and location depends on pattern, default_pattern params and access
1241  * permissions.
1242  */
1243 static int prepare_log_file(const char* pattern, const char* default_pattern, bool overwrite_existing, char* buf, size_t buflen) {
1244   int fd = -1;
1245 
1246   // If possible, use specified pattern to construct log file name
1247   if (pattern != NULL) {
1248     fd = expand_and_open(pattern, overwrite_existing, buf, buflen, 0);
1249   }
1250 
1251   // Either user didn&#39;t specify, or the user&#39;s location failed,
1252   // so use the default name in the current directory
1253   if (fd == -1) {
1254     const char* cwd = os::get_current_directory(buf, buflen);
1255     if (cwd != NULL) {
1256       size_t pos = strlen(cwd);
1257       int fsep_len = jio_snprintf(&amp;buf[pos], buflen-pos, &quot;%s&quot;, os::file_separator());
1258       pos += fsep_len;
1259       if (fsep_len &gt; 0) {
1260         fd = expand_and_open(default_pattern, overwrite_existing, buf, buflen, pos);
1261       }
1262     }
1263   }
1264 
1265    // try temp directory if it exists.
1266    if (fd == -1) {
1267      const char* tmpdir = os::get_temp_directory();
1268      if (tmpdir != NULL &amp;&amp; strlen(tmpdir) &gt; 0) {
1269        int pos = jio_snprintf(buf, buflen, &quot;%s%s&quot;, tmpdir, os::file_separator());
1270        if (pos &gt; 0) {
1271          fd = expand_and_open(default_pattern, overwrite_existing, buf, buflen, pos);
1272        }
1273      }
1274    }
1275 
1276   return fd;
1277 }
1278 
1279 int         VMError::_id;
1280 const char* VMError::_message;
1281 char        VMError::_detail_msg[1024];
1282 Thread*     VMError::_thread;
1283 address     VMError::_pc;
1284 void*       VMError::_siginfo;
1285 void*       VMError::_context;
1286 const char* VMError::_filename;
1287 int         VMError::_lineno;
1288 size_t      VMError::_size;
1289 
1290 void VMError::report_and_die(Thread* thread, unsigned int sig, address pc, void* siginfo,
1291                              void* context, const char* detail_fmt, ...)
1292 {
1293   va_list detail_args;
1294   va_start(detail_args, detail_fmt);
1295   report_and_die(sig, NULL, detail_fmt, detail_args, thread, pc, siginfo, context, NULL, 0, 0);
1296   va_end(detail_args);
1297 }
1298 
1299 void VMError::report_and_die(Thread* thread, unsigned int sig, address pc, void* siginfo, void* context)
1300 {
1301   report_and_die(thread, sig, pc, siginfo, context, &quot;%s&quot;, &quot;&quot;);
1302 }
1303 
1304 void VMError::report_and_die(const char* message, const char* detail_fmt, ...)
1305 {
1306   va_list detail_args;
1307   va_start(detail_args, detail_fmt);
1308   report_and_die(INTERNAL_ERROR, message, detail_fmt, detail_args, NULL, NULL, NULL, NULL, NULL, 0, 0);
1309   va_end(detail_args);
1310 }
1311 
1312 void VMError::report_and_die(const char* message)
1313 {
1314   report_and_die(message, &quot;%s&quot;, &quot;&quot;);
1315 }
1316 
1317 void VMError::report_and_die(Thread* thread, void* context, const char* filename, int lineno, const char* message,
1318                              const char* detail_fmt, va_list detail_args)
1319 {
1320   report_and_die(INTERNAL_ERROR, message, detail_fmt, detail_args, thread, NULL, NULL, context, filename, lineno, 0);
1321 }
1322 
1323 void VMError::report_and_die(Thread* thread, const char* filename, int lineno, size_t size,
1324                              VMErrorType vm_err_type, const char* detail_fmt, va_list detail_args) {
1325   report_and_die(vm_err_type, NULL, detail_fmt, detail_args, thread, NULL, NULL, NULL, filename, lineno, size);
1326 }
1327 
1328 void VMError::report_and_die(int id, const char* message, const char* detail_fmt, va_list detail_args,
1329                              Thread* thread, address pc, void* siginfo, void* context, const char* filename,
1330                              int lineno, size_t size)
1331 {
1332   // A single scratch buffer to be used from here on.
1333   // Do not rely on it being preserved across function calls.
1334   static char buffer[O_BUFLEN];
1335 
1336   // File descriptor to tty to print an error summary to.
1337   // Hard wired to stdout; see JDK-8215004 (compatibility concerns).
1338   static const int fd_out = 1; // stdout
1339 
1340   // File descriptor to the error log file.
1341   static int fd_log = -1;
1342 
1343 #ifdef CAN_SHOW_REGISTERS_ON_ASSERT
1344   // Disarm assertion poison page, since from this point on we do not need this mechanism anymore and it may
1345   // cause problems in error handling during native OOM, see JDK-8227275.
1346   disarm_assert_poison();
1347 #endif
1348 
1349   // Use local fdStream objects only. Do not use global instances whose initialization
1350   // relies on dynamic initialization (see JDK-8214975). Do not rely on these instances
1351   // to carry over into recursions or invocations from other threads.
1352   fdStream out(fd_out);
1353   out.set_scratch_buffer(buffer, sizeof(buffer));
1354 
1355   // Depending on the re-entrance depth at this point, fd_log may be -1 or point to an open hs-err file.
1356   fdStream log(fd_log);
1357   log.set_scratch_buffer(buffer, sizeof(buffer));
1358 
1359   // How many errors occurred in error handler when reporting first_error.
1360   static int recursive_error_count;
1361 
1362   // We will first print a brief message to standard out (verbose = false),
1363   // then save detailed information in log file (verbose = true).
1364   static bool out_done = false;         // done printing to standard out
1365   static bool log_done = false;         // done saving error log
1366 
1367   if (SuppressFatalErrorMessage) {
1368       os::abort(CreateCoredumpOnCrash);
1369   }
1370   intptr_t mytid = os::current_thread_id();
1371   if (_first_error_tid == -1 &amp;&amp;
1372       Atomic::cmpxchg(&amp;_first_error_tid, (intptr_t)-1, mytid) == -1) {
1373 
1374     // Initialize time stamps to use the same base.
1375     out.time_stamp().update_to(1);
1376     log.time_stamp().update_to(1);
1377 
1378     _id = id;
1379     _message = message;
1380     _thread = thread;
1381     _pc = pc;
1382     _siginfo = siginfo;
1383     _context = context;
1384     _filename = filename;
1385     _lineno = lineno;
1386     _size = size;
1387     jio_vsnprintf(_detail_msg, sizeof(_detail_msg), detail_fmt, detail_args);
1388 
1389     // first time
1390     _error_reported = true;
1391 
1392     reporting_started();
1393     if (!TestUnresponsiveErrorHandler) {
1394       // Record reporting_start_time unless we&#39;re running the
1395       // TestUnresponsiveErrorHandler test. For that test we record
1396       // reporting_start_time at the beginning of the test.
1397       record_reporting_start_time();
1398     } else {
1399       out.print_raw_cr(&quot;Delaying recording reporting_start_time for TestUnresponsiveErrorHandler.&quot;);
1400     }
1401 
1402     if (ShowMessageBoxOnError || PauseAtExit) {
1403       show_message_box(buffer, sizeof(buffer));
1404 
1405       // User has asked JVM to abort. Reset ShowMessageBoxOnError so the
1406       // WatcherThread can kill JVM if the error handler hangs.
1407       ShowMessageBoxOnError = false;
1408     }
1409 
1410     os::check_dump_limit(buffer, sizeof(buffer));
1411 
1412     // reset signal handlers or exception filter; make sure recursive crashes
1413     // are handled properly.
1414     reset_signal_handlers();
1415   } else {
1416     // If UseOsErrorReporting we call this for each level of the call stack
1417     // while searching for the exception handler.  Only the first level needs
1418     // to be reported.
1419     if (UseOSErrorReporting &amp;&amp; log_done) return;
1420 
1421     // This is not the first error, see if it happened in a different thread
1422     // or in the same thread during error reporting.
1423     if (_first_error_tid != mytid) {
1424       char msgbuf[64];
1425       jio_snprintf(msgbuf, sizeof(msgbuf),
1426                    &quot;[thread &quot; INTX_FORMAT &quot; also had an error]&quot;,
1427                    mytid);
1428       out.print_raw_cr(msgbuf);
1429 
1430       // error reporting is not MT-safe, block current thread
1431       os::infinite_sleep();
1432 
1433     } else {
1434       if (recursive_error_count++ &gt; 30) {
1435         out.print_raw_cr(&quot;[Too many errors, abort]&quot;);
1436         os::die();
1437       }
1438 
1439       outputStream* const st = log.is_open() ? &amp;log : &amp;out;
1440       st-&gt;cr();
1441 
1442       // Timeout handling.
1443       if (_step_did_timeout) {
1444         // The current step had a timeout. Lets continue reporting with the next step.
1445         st-&gt;print_raw(&quot;[timeout occurred during error reporting in step \&quot;&quot;);
1446         st-&gt;print_raw(_current_step_info);
1447         st-&gt;print_cr(&quot;\&quot;] after &quot; INT64_FORMAT &quot; s.&quot;,
1448                      (int64_t)
1449                      ((get_current_timestamp() - _step_start_time) / TIMESTAMP_TO_SECONDS_FACTOR));
1450       } else if (_reporting_did_timeout) {
1451         // We hit ErrorLogTimeout. Reporting will stop altogether. Let&#39;s wrap things
1452         // up, the process is about to be stopped by the WatcherThread.
1453         st-&gt;print_cr(&quot;------ Timeout during error reporting after &quot; INT64_FORMAT &quot; s. ------&quot;,
1454                      (int64_t)
1455                      ((get_current_timestamp() - _reporting_start_time) / TIMESTAMP_TO_SECONDS_FACTOR));
1456         st-&gt;flush();
1457         // Watcherthread is about to call os::die. Lets just wait.
1458         os::infinite_sleep();
1459       } else {
1460         // Crash or assert during error reporting. Lets continue reporting with the next step.
1461         stringStream ss(buffer, sizeof(buffer));
1462         // Note: this string does get parsed by a number of jtreg tests,
1463         // see hotspot/jtreg/runtime/ErrorHandling.
1464         ss.print(&quot;[error occurred during error reporting (%s), id 0x%x&quot;,
1465                    _current_step_info, id);
1466         char signal_name[64];
1467         if (os::exception_name(id, signal_name, sizeof(signal_name))) {
1468           ss.print(&quot;, %s (0x%x) at pc=&quot; PTR_FORMAT, signal_name, id, p2i(pc));
1469         } else {
1470           if (should_report_bug(id)) {
1471             ss.print(&quot;, Internal Error (%s:%d)&quot;,
1472               filename == NULL ? &quot;??&quot; : filename, lineno);
1473           } else {
1474             ss.print(&quot;, Out of Memory Error (%s:%d)&quot;,
1475               filename == NULL ? &quot;??&quot; : filename, lineno);
1476           }
1477         }
1478         ss.print(&quot;]&quot;);
1479         st-&gt;print_raw_cr(buffer);
1480         st-&gt;cr();
1481       }
1482     }
1483   }
1484 
1485   // Part 1: print an abbreviated version (the &#39;#&#39; section) to stdout.
1486   if (!out_done) {
1487     // Suppress this output if we plan to print Part 2 to stdout too.
1488     // No need to have the &quot;#&quot; section twice.
1489     if (!(ErrorFileToStdout &amp;&amp; out.fd() == 1)) {
1490       report(&amp;out, false);
1491     }
1492 
1493     out_done = true;
1494 
1495     _current_step = 0;
1496     _current_step_info = &quot;&quot;;
1497   }
1498 
1499   // Part 2: print a full error log file (optionally to stdout or stderr).
1500   // print to error log file
1501   if (!log_done) {
1502     // see if log file is already open
1503     if (!log.is_open()) {
1504       // open log file
1505       if (ErrorFileToStdout) {
1506         fd_log = 1;
1507       } else if (ErrorFileToStderr) {
1508         fd_log = 2;
1509       } else {
1510         fd_log = prepare_log_file(ErrorFile, &quot;hs_err_pid%p.log&quot;, true,
1511                  buffer, sizeof(buffer));
1512         if (fd_log != -1) {
1513           out.print_raw(&quot;# An error report file with more information is saved as:\n# &quot;);
1514           out.print_raw_cr(buffer);
1515         } else {
1516           out.print_raw_cr(&quot;# Can not save log file, dump to screen..&quot;);
1517           fd_log = 1;
1518         }
1519       }
1520       log.set_fd(fd_log);
1521     }
1522 
1523     report(&amp;log, true);
1524     log_done = true;
1525     _current_step = 0;
1526     _current_step_info = &quot;&quot;;
1527 
1528     if (fd_log &gt; 3) {
1529       close(fd_log);
1530       fd_log = -1;
1531     }
1532 
1533     log.set_fd(-1);
1534   }
1535 
1536   JFR_ONLY(Jfr::on_vm_shutdown(true);)
1537 
1538   if (PrintNMTStatistics) {
1539     fdStream fds(fd_out);
1540     MemTracker::final_report(&amp;fds);
1541   }
1542 
1543   static bool skip_replay = ReplayCompiles; // Do not overwrite file during replay
1544   if (DumpReplayDataOnError &amp;&amp; _thread &amp;&amp; _thread-&gt;is_Compiler_thread() &amp;&amp; !skip_replay) {
1545     skip_replay = true;
1546     ciEnv* env = ciEnv::current();
1547     if (env != NULL) {
1548       const bool overwrite = false; // We do not overwrite an existing replay file.
1549       int fd = prepare_log_file(ReplayDataFile, &quot;replay_pid%p.log&quot;, overwrite, buffer, sizeof(buffer));
1550       if (fd != -1) {
1551         FILE* replay_data_file = os::open(fd, &quot;w&quot;);
1552         if (replay_data_file != NULL) {
1553           fileStream replay_data_stream(replay_data_file, /*need_close=*/true);
1554           env-&gt;dump_replay_data_unsafe(&amp;replay_data_stream);
1555           out.print_raw(&quot;#\n# Compiler replay data is saved as:\n# &quot;);
1556           out.print_raw_cr(buffer);
1557         } else {
1558           int e = errno;
1559           out.print_raw(&quot;#\n# Can&#39;t open file to dump replay data. Error: &quot;);
1560           out.print_raw_cr(os::strerror(e));
1561         }
1562       }
1563     }
1564   }
1565 
1566   static bool skip_bug_url = !should_report_bug(_id);
1567   if (!skip_bug_url) {
1568     skip_bug_url = true;
1569 
1570     out.print_raw_cr(&quot;#&quot;);
1571     print_bug_submit_message(&amp;out, _thread);
1572   }
1573 
1574   static bool skip_OnError = false;
1575   if (!skip_OnError &amp;&amp; OnError &amp;&amp; OnError[0]) {
1576     skip_OnError = true;
1577 
1578     // Flush output and finish logs before running OnError commands.
1579     ostream_abort();
1580 
1581     out.print_raw_cr(&quot;#&quot;);
1582     out.print_raw   (&quot;# -XX:OnError=\&quot;&quot;);
1583     out.print_raw   (OnError);
1584     out.print_raw_cr(&quot;\&quot;&quot;);
1585 
1586     char* cmd;
1587     const char* ptr = OnError;
1588     while ((cmd = next_OnError_command(buffer, sizeof(buffer), &amp;ptr)) != NULL){
1589       out.print_raw   (&quot;#   Executing &quot;);
1590 #if defined(LINUX) || defined(_ALLBSD_SOURCE)
1591       out.print_raw   (&quot;/bin/sh -c &quot;);
<a name="2" id="anc2"></a>

1592 #elif defined(_WINDOWS)
1593       out.print_raw   (&quot;cmd /C &quot;);
1594 #endif
1595       out.print_raw   (&quot;\&quot;&quot;);
1596       out.print_raw   (cmd);
1597       out.print_raw_cr(&quot;\&quot; ...&quot;);
1598 
1599       if (os::fork_and_exec(cmd) &lt; 0) {
1600         out.print_cr(&quot;os::fork_and_exec failed: %s (%s=%d)&quot;,
1601                      os::strerror(errno), os::errno_name(errno), errno);
1602       }
1603     }
1604 
1605     // done with OnError
1606     OnError = NULL;
1607   }
1608 
1609   if (!UseOSErrorReporting) {
1610     // os::abort() will call abort hooks, try it first.
1611     static bool skip_os_abort = false;
1612     if (!skip_os_abort) {
1613       skip_os_abort = true;
1614       bool dump_core = should_report_bug(_id);
1615       os::abort(dump_core &amp;&amp; CreateCoredumpOnCrash, _siginfo, _context);
1616     }
1617 
1618     // if os::abort() doesn&#39;t abort, try os::die();
1619     os::die();
1620   }
1621 }
1622 
1623 /*
1624  * OnOutOfMemoryError scripts/commands executed while VM is a safepoint - this
1625  * ensures utilities such as jmap can observe the process is a consistent state.
1626  */
1627 class VM_ReportJavaOutOfMemory : public VM_Operation {
1628  private:
1629   const char* _message;
1630  public:
1631   VM_ReportJavaOutOfMemory(const char* message) { _message = message; }
1632   VMOp_Type type() const                        { return VMOp_ReportJavaOutOfMemory; }
1633   void doit();
1634 };
1635 
1636 void VM_ReportJavaOutOfMemory::doit() {
1637   // Don&#39;t allocate large buffer on stack
1638   static char buffer[O_BUFLEN];
1639 
1640   tty-&gt;print_cr(&quot;#&quot;);
1641   tty-&gt;print_cr(&quot;# java.lang.OutOfMemoryError: %s&quot;, _message);
1642   tty-&gt;print_cr(&quot;# -XX:OnOutOfMemoryError=\&quot;%s\&quot;&quot;, OnOutOfMemoryError);
1643 
1644   // make heap parsability
1645   Universe::heap()-&gt;ensure_parsability(false);  // no need to retire TLABs
1646 
1647   char* cmd;
1648   const char* ptr = OnOutOfMemoryError;
1649   while ((cmd = next_OnError_command(buffer, sizeof(buffer), &amp;ptr)) != NULL){
1650     tty-&gt;print(&quot;#   Executing &quot;);
1651 #if defined(LINUX)
1652     tty-&gt;print  (&quot;/bin/sh -c &quot;);
<a name="3" id="anc3"></a>

1653 #endif
1654     tty-&gt;print_cr(&quot;\&quot;%s\&quot;...&quot;, cmd);
1655 
1656     if (os::fork_and_exec(cmd, true) &lt; 0) {
1657       tty-&gt;print_cr(&quot;os::fork_and_exec failed: %s (%s=%d)&quot;,
1658                      os::strerror(errno), os::errno_name(errno), errno);
1659     }
1660   }
1661 }
1662 
1663 void VMError::report_java_out_of_memory(const char* message) {
1664   if (OnOutOfMemoryError &amp;&amp; OnOutOfMemoryError[0]) {
1665     MutexLocker ml(Heap_lock);
1666     VM_ReportJavaOutOfMemory op(message);
1667     VMThread::execute(&amp;op);
1668   }
1669 }
1670 
1671 void VMError::show_message_box(char *buf, int buflen) {
1672   bool yes;
1673   do {
1674     error_string(buf, buflen);
1675     yes = os::start_debugging(buf,buflen);
1676   } while (yes);
1677 }
1678 
1679 // Timeout handling: check if a timeout happened (either a single step did
1680 // timeout or the whole of error reporting hit ErrorLogTimeout). Interrupt
1681 // the reporting thread if that is the case.
1682 bool VMError::check_timeout() {
1683 
1684   if (ErrorLogTimeout == 0) {
1685     return false;
1686   }
1687 
1688   // Do not check for timeouts if we still have a message box to show to the
1689   // user or if there are OnError handlers to be run.
1690   if (ShowMessageBoxOnError
1691       || (OnError != NULL &amp;&amp; OnError[0] != &#39;\0&#39;)
1692       || Arguments::abort_hook() != NULL) {
1693     return false;
1694   }
1695 
1696   const jlong reporting_start_time_l = get_reporting_start_time();
1697   const jlong now = get_current_timestamp();
1698   // Timestamp is stored in nanos.
1699   if (reporting_start_time_l &gt; 0) {
1700     const jlong end = reporting_start_time_l + (jlong)ErrorLogTimeout * TIMESTAMP_TO_SECONDS_FACTOR;
1701     if (end &lt;= now &amp;&amp; !_reporting_did_timeout) {
1702       // We hit ErrorLogTimeout and we haven&#39;t interrupted the reporting
1703       // thread yet.
1704       _reporting_did_timeout = true;
1705       interrupt_reporting_thread();
1706       return true; // global timeout
1707     }
1708   }
1709 
1710   const jlong step_start_time_l = get_step_start_time();
1711   if (step_start_time_l &gt; 0) {
1712     // A step times out after a quarter of the total timeout. Steps are mostly fast unless they
1713     // hang for some reason, so this simple rule allows for three hanging step and still
1714     // hopefully leaves time enough for the rest of the steps to finish.
1715     const jlong end = step_start_time_l + (jlong)ErrorLogTimeout * TIMESTAMP_TO_SECONDS_FACTOR / 4;
1716     if (end &lt;= now &amp;&amp; !_step_did_timeout) {
1717       // The step timed out and we haven&#39;t interrupted the reporting
1718       // thread yet.
1719       _step_did_timeout = true;
1720       interrupt_reporting_thread();
1721       return false; // (Not a global timeout)
1722     }
1723   }
1724 
1725   return false;
1726 
1727 }
1728 
1729 #ifndef PRODUCT
<a name="4" id="anc4"></a>


1730 typedef void (*voidfun_t)();
1731 // Crash with an authentic sigfpe
1732 static void crash_with_sigfpe() {
1733   // generate a native synchronous SIGFPE where possible;
1734   // if that did not cause a signal (e.g. on ppc), just
1735   // raise the signal.
1736   volatile int x = 0;
1737   volatile int y = 1/x;
1738 #ifndef _WIN32
1739   // OSX implements raise(sig) incorrectly so we need to
1740   // explicitly target the current thread
1741   pthread_kill(pthread_self(), SIGFPE);
1742 #endif
1743 } // end: crash_with_sigfpe
1744 
1745 // crash with sigsegv at non-null address.
1746 static void crash_with_segfault() {
1747 
1748   char* const crash_addr = (char*) VMError::get_segfault_address();
1749   *crash_addr = &#39;X&#39;;
1750 
1751 } // end: crash_with_segfault
1752 
1753 void VMError::test_error_handler() {
1754   controlled_crash(ErrorHandlerTest);
1755 }
1756 
1757 // crash in a controlled way:
1758 // how can be one of:
1759 // 1,2 - asserts
1760 // 3,4 - guarantee
1761 // 5-7 - fatal
1762 // 8 - vm_exit_out_of_memory
1763 // 9 - ShouldNotCallThis
1764 // 10 - ShouldNotReachHere
1765 // 11 - Unimplemented
1766 // 12,13 - (not guaranteed) crashes
1767 // 14 - SIGSEGV
1768 // 15 - SIGFPE
1769 void VMError::controlled_crash(int how) {
1770   if (how == 0) return;
1771 
1772   // If asserts are disabled, use the corresponding guarantee instead.
1773   NOT_DEBUG(if (how &lt;= 2) how += 2);
1774 
1775   const char* const str = &quot;hello&quot;;
1776   const size_t      num = (size_t)os::vm_page_size();
1777 
1778   const char* const eol = os::line_separator();
1779   const char* const msg = &quot;this message should be truncated during formatting&quot;;
1780   char * const dataPtr = NULL;  // bad data pointer
1781   const void (*funcPtr)(void);  // bad function pointer
1782 
1783 #if defined(PPC64) &amp;&amp; !defined(ABI_ELFv2)
1784   struct FunctionDescriptor functionDescriptor;
1785 
1786   functionDescriptor.set_entry((address) 0xF);
1787   funcPtr = (const void(*)()) &amp;functionDescriptor;
1788 #else
1789   funcPtr = (const void(*)()) 0xF;
1790 #endif
1791 
1792   // Keep this in sync with test/hotspot/jtreg/runtime/ErrorHandling/ErrorHandler.java
1793   // which tests cases 1 thru 13.
1794   // Case 14 is tested by test/hotspot/jtreg/runtime/ErrorHandling/SafeFetchInErrorHandlingTest.java.
1795   // Case 15 is tested by test/hotspot/jtreg/runtime/ErrorHandling/SecondaryErrorTest.java.
1796   // Case 16 is tested by test/hotspot/jtreg/runtime/ErrorHandling/ThreadsListHandleInErrorHandlingTest.java.
1797   // Case 17 is tested by test/hotspot/jtreg/runtime/ErrorHandling/NestedThreadsListHandleInErrorHandlingTest.java.
1798 
1799   // We try to grab Threads_lock to keep ThreadsSMRSupport::print_info_on()
1800   // from racing with Threads::add() or Threads::remove() as we
1801   // generate the hs_err_pid file. This makes our ErrorHandling tests
1802   // more stable.
1803   if (!Threads_lock-&gt;owned_by_self()) {
1804     Threads_lock-&gt;try_lock();
1805     // The VM is going to die so no need to unlock Thread_lock.
1806   }
1807 
1808   switch (how) {
1809     case  1: vmassert(str == NULL, &quot;expected null&quot;); break;
1810     case  2: vmassert(num == 1023 &amp;&amp; *str == &#39;X&#39;,
1811                       &quot;num=&quot; SIZE_FORMAT &quot; str=\&quot;%s\&quot;&quot;, num, str); break;
1812     case  3: guarantee(str == NULL, &quot;expected null&quot;); break;
1813     case  4: guarantee(num == 1023 &amp;&amp; *str == &#39;X&#39;,
1814                        &quot;num=&quot; SIZE_FORMAT &quot; str=\&quot;%s\&quot;&quot;, num, str); break;
1815     case  5: fatal(&quot;expected null&quot;); break;
1816     case  6: fatal(&quot;num=&quot; SIZE_FORMAT &quot; str=\&quot;%s\&quot;&quot;, num, str); break;
1817     case  7: fatal(&quot;%s%s#    %s%s#    %s%s#    %s%s#    %s%s#    &quot;
1818                    &quot;%s%s#    %s%s#    %s%s#    %s%s#    %s%s#    &quot;
1819                    &quot;%s%s#    %s%s#    %s%s#    %s%s#    %s&quot;,
1820                    msg, eol, msg, eol, msg, eol, msg, eol, msg, eol,
1821                    msg, eol, msg, eol, msg, eol, msg, eol, msg, eol,
1822                    msg, eol, msg, eol, msg, eol, msg, eol, msg); break;
1823     case  8: vm_exit_out_of_memory(num, OOM_MALLOC_ERROR, &quot;ChunkPool::allocate&quot;); break;
1824     case  9: ShouldNotCallThis(); break;
1825     case 10: ShouldNotReachHere(); break;
1826     case 11: Unimplemented(); break;
1827     // There&#39;s no guarantee the bad data pointer will crash us
1828     // so &quot;break&quot; out to the ShouldNotReachHere().
1829     case 12: *dataPtr = &#39;\0&#39;; break;
1830     // There&#39;s no guarantee the bad function pointer will crash us
1831     // so &quot;break&quot; out to the ShouldNotReachHere().
1832     case 13: (*funcPtr)(); break;
1833     case 14: crash_with_segfault(); break;
1834     case 15: crash_with_sigfpe(); break;
1835     case 16: {
1836       ThreadsListHandle tlh;
1837       fatal(&quot;Force crash with an active ThreadsListHandle.&quot;);
1838     }
1839     case 17: {
1840       ThreadsListHandle tlh;
1841       {
1842         ThreadsListHandle tlh2;
1843         fatal(&quot;Force crash with a nested ThreadsListHandle.&quot;);
1844       }
1845     }
1846 
1847     default: tty-&gt;print_cr(&quot;ERROR: %d: unexpected test_num value.&quot;, how);
1848   }
1849   tty-&gt;print_cr(&quot;VMError::controlled_crash: survived intentional crash. Did you suppress the assert?&quot;);
1850   ShouldNotReachHere();
1851 }
1852 #endif // !PRODUCT
<a name="5" id="anc5"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="5" type="hidden" />
</body>
</html>