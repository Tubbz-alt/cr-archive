<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old src/hotspot/os/solaris/os_solaris.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 1997, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 // no precompiled headers
  26 #include &quot;jvm.h&quot;
  27 #include &quot;classfile/classLoader.hpp&quot;
  28 #include &quot;classfile/systemDictionary.hpp&quot;
  29 #include &quot;classfile/vmSymbols.hpp&quot;
  30 #include &quot;code/icBuffer.hpp&quot;
  31 #include &quot;code/vtableStubs.hpp&quot;
  32 #include &quot;compiler/compileBroker.hpp&quot;
  33 #include &quot;compiler/disassembler.hpp&quot;
  34 #include &quot;interpreter/interpreter.hpp&quot;
  35 #include &quot;logging/log.hpp&quot;
  36 #include &quot;logging/logStream.hpp&quot;
  37 #include &quot;memory/allocation.inline.hpp&quot;
  38 #include &quot;memory/filemap.hpp&quot;
  39 #include &quot;memory/universe.hpp&quot;
  40 #include &quot;oops/oop.inline.hpp&quot;
  41 #include &quot;os_share_solaris.hpp&quot;
  42 #include &quot;os_solaris.inline.hpp&quot;
  43 #include &quot;prims/jniFastGetField.hpp&quot;
  44 #include &quot;prims/jvm_misc.hpp&quot;
  45 #include &quot;runtime/arguments.hpp&quot;
  46 #include &quot;runtime/atomic.hpp&quot;
  47 #include &quot;runtime/extendedPC.hpp&quot;
  48 #include &quot;runtime/globals.hpp&quot;
  49 #include &quot;runtime/interfaceSupport.inline.hpp&quot;
  50 #include &quot;runtime/java.hpp&quot;
  51 #include &quot;runtime/javaCalls.hpp&quot;
  52 #include &quot;runtime/mutexLocker.hpp&quot;
  53 #include &quot;runtime/objectMonitor.hpp&quot;
  54 #include &quot;runtime/orderAccess.hpp&quot;
  55 #include &quot;runtime/osThread.hpp&quot;
  56 #include &quot;runtime/perfMemory.hpp&quot;
  57 #include &quot;runtime/sharedRuntime.hpp&quot;
  58 #include &quot;runtime/statSampler.hpp&quot;
  59 #include &quot;runtime/stubRoutines.hpp&quot;
  60 #include &quot;runtime/thread.inline.hpp&quot;
  61 #include &quot;runtime/threadCritical.hpp&quot;
  62 #include &quot;runtime/timer.hpp&quot;
  63 #include &quot;runtime/vm_version.hpp&quot;
  64 #include &quot;semaphore_posix.hpp&quot;
  65 #include &quot;services/attachListener.hpp&quot;
  66 #include &quot;services/memTracker.hpp&quot;
  67 #include &quot;services/runtimeService.hpp&quot;
  68 #include &quot;utilities/align.hpp&quot;
  69 #include &quot;utilities/decoder.hpp&quot;
  70 #include &quot;utilities/defaultStream.hpp&quot;
  71 #include &quot;utilities/events.hpp&quot;
  72 #include &quot;utilities/growableArray.hpp&quot;
  73 #include &quot;utilities/macros.hpp&quot;
  74 #include &quot;utilities/vmError.hpp&quot;
  75 
  76 // put OS-includes here
  77 # include &lt;dlfcn.h&gt;
  78 # include &lt;errno.h&gt;
  79 # include &lt;exception&gt;
  80 # include &lt;link.h&gt;
  81 # include &lt;poll.h&gt;
  82 # include &lt;pthread.h&gt;
  83 # include &lt;setjmp.h&gt;
  84 # include &lt;signal.h&gt;
  85 # include &lt;stdio.h&gt;
  86 # include &lt;alloca.h&gt;
  87 # include &lt;sys/filio.h&gt;
  88 # include &lt;sys/ipc.h&gt;
  89 # include &lt;sys/lwp.h&gt;
  90 # include &lt;sys/machelf.h&gt;     // for elf Sym structure used by dladdr1
  91 # include &lt;sys/mman.h&gt;
  92 # include &lt;sys/processor.h&gt;
  93 # include &lt;sys/procset.h&gt;
  94 # include &lt;sys/pset.h&gt;
  95 # include &lt;sys/resource.h&gt;
  96 # include &lt;sys/shm.h&gt;
  97 # include &lt;sys/socket.h&gt;
  98 # include &lt;sys/stat.h&gt;
  99 # include &lt;sys/systeminfo.h&gt;
 100 # include &lt;sys/time.h&gt;
 101 # include &lt;sys/times.h&gt;
 102 # include &lt;sys/types.h&gt;
 103 # include &lt;sys/wait.h&gt;
 104 # include &lt;sys/utsname.h&gt;
 105 # include &lt;thread.h&gt;
 106 # include &lt;unistd.h&gt;
 107 # include &lt;sys/priocntl.h&gt;
 108 # include &lt;sys/rtpriocntl.h&gt;
 109 # include &lt;sys/tspriocntl.h&gt;
 110 # include &lt;sys/iapriocntl.h&gt;
 111 # include &lt;sys/fxpriocntl.h&gt;
 112 # include &lt;sys/loadavg.h&gt;
 113 # include &lt;string.h&gt;
 114 # include &lt;stdio.h&gt;
 115 
 116 # define _STRUCTURED_PROC 1  //  this gets us the new structured proc interfaces of 5.6 &amp; later
 117 # include &lt;sys/procfs.h&gt;     //  see comment in &lt;sys/procfs.h&gt;
 118 
 119 #define MAX_PATH (2 * K)
 120 
 121 // for timer info max values which include all bits
 122 #define ALL_64_BITS CONST64(0xFFFFFFFFFFFFFFFF)
 123 
 124 
 125 // Here are some liblgrp types from sys/lgrp_user.h to be able to
 126 // compile on older systems without this header file.
 127 
 128 #ifndef MADV_ACCESS_LWP
 129   #define  MADV_ACCESS_LWP   7       /* next LWP to access heavily */
 130 #endif
 131 #ifndef MADV_ACCESS_MANY
 132   #define  MADV_ACCESS_MANY  8       /* many processes to access heavily */
 133 #endif
 134 
 135 #ifndef LGRP_RSRC_CPU
 136   #define LGRP_RSRC_CPU      0       /* CPU resources */
 137 #endif
 138 #ifndef LGRP_RSRC_MEM
 139   #define LGRP_RSRC_MEM      1       /* memory resources */
 140 #endif
 141 
 142 // Values for ThreadPriorityPolicy == 1
 143 int prio_policy1[CriticalPriority+1] = {
 144   -99999,  0, 16,  32,  48,  64,
 145           80, 96, 112, 124, 127, 127 };
 146 
 147 // System parameters used internally
 148 static clock_t clock_tics_per_sec = 100;
 149 
 150 // Track if we have called enable_extended_FILE_stdio (on Solaris 10u4+)
 151 static bool enabled_extended_FILE_stdio = false;
 152 
 153 // For diagnostics to print a message once. see run_periodic_checks
 154 static bool check_addr0_done = false;
 155 static sigset_t check_signal_done;
 156 static bool check_signals = true;
 157 
 158 address os::Solaris::handler_start;  // start pc of thr_sighndlrinfo
 159 address os::Solaris::handler_end;    // end pc of thr_sighndlrinfo
 160 
 161 address os::Solaris::_main_stack_base = NULL;  // 4352906 workaround
 162 
 163 os::Solaris::pthread_setname_np_func_t os::Solaris::_pthread_setname_np = NULL;
 164 
 165 // &quot;default&quot; initializers for missing libc APIs
 166 extern &quot;C&quot; {
 167   static int lwp_mutex_init(mutex_t *mx, int scope, void *arg) { memset(mx, 0, sizeof(mutex_t)); return 0; }
 168   static int lwp_mutex_destroy(mutex_t *mx)                 { return 0; }
 169 
 170   static int lwp_cond_init(cond_t *cv, int scope, void *arg){ memset(cv, 0, sizeof(cond_t)); return 0; }
 171   static int lwp_cond_destroy(cond_t *cv)                   { return 0; }
 172 }
 173 
 174 // &quot;default&quot; initializers for pthread-based synchronization
 175 extern &quot;C&quot; {
 176   static int pthread_mutex_default_init(mutex_t *mx, int scope, void *arg) { memset(mx, 0, sizeof(mutex_t)); return 0; }
 177   static int pthread_cond_default_init(cond_t *cv, int scope, void *arg){ memset(cv, 0, sizeof(cond_t)); return 0; }
 178 }
 179 
 180 static void unpackTime(timespec* absTime, bool isAbsolute, jlong time);
 181 
 182 static inline size_t adjust_stack_size(address base, size_t size) {
 183   if ((ssize_t)size &lt; 0) {
 184     // 4759953: Compensate for ridiculous stack size.
 185     size = max_intx;
 186   }
 187   if (size &gt; (size_t)base) {
 188     // 4812466: Make sure size doesn&#39;t allow the stack to wrap the address space.
 189     size = (size_t)base;
 190   }
 191   return size;
 192 }
 193 
 194 static inline stack_t get_stack_info() {
 195   stack_t st;
 196   int retval = thr_stksegment(&amp;st);
 197   st.ss_size = adjust_stack_size((address)st.ss_sp, st.ss_size);
 198   assert(retval == 0, &quot;incorrect return value from thr_stksegment&quot;);
 199   assert((address)&amp;st &lt; (address)st.ss_sp, &quot;Invalid stack base returned&quot;);
 200   assert((address)&amp;st &gt; (address)st.ss_sp-st.ss_size, &quot;Invalid stack size returned&quot;);
 201   return st;
 202 }
 203 
 204 static void _handle_uncaught_cxx_exception() {
 205   VMError::report_and_die(&quot;An uncaught C++ exception&quot;);
 206 }
 207 
 208 bool os::is_primordial_thread(void) {
 209   int r = thr_main();
 210   guarantee(r == 0 || r == 1, &quot;CR6501650 or CR6493689&quot;);
 211   return r == 1;
 212 }
 213 
 214 address os::current_stack_base() {
 215   bool _is_primordial_thread = is_primordial_thread();
 216 
 217   // Workaround 4352906, avoid calls to thr_stksegment by
 218   // thr_main after the first one (it looks like we trash
 219   // some data, causing the value for ss_sp to be incorrect).
 220   if (!_is_primordial_thread || os::Solaris::_main_stack_base == NULL) {
 221     stack_t st = get_stack_info();
 222     if (_is_primordial_thread) {
 223       // cache initial value of stack base
 224       os::Solaris::_main_stack_base = (address)st.ss_sp;
 225     }
 226     return (address)st.ss_sp;
 227   } else {
 228     guarantee(os::Solaris::_main_stack_base != NULL, &quot;Attempt to use null cached stack base&quot;);
 229     return os::Solaris::_main_stack_base;
 230   }
 231 }
 232 
 233 size_t os::current_stack_size() {
 234   size_t size;
 235 
 236   if (!is_primordial_thread()) {
 237     size = get_stack_info().ss_size;
 238   } else {
 239     struct rlimit limits;
 240     getrlimit(RLIMIT_STACK, &amp;limits);
 241     size = adjust_stack_size(os::Solaris::_main_stack_base, (size_t)limits.rlim_cur);
 242   }
 243   // base may not be page aligned
 244   address base = current_stack_base();
 245   address bottom = align_up(base - size, os::vm_page_size());;
 246   return (size_t)(base - bottom);
 247 }
 248 
 249 struct tm* os::localtime_pd(const time_t* clock, struct tm*  res) {
 250   return localtime_r(clock, res);
 251 }
 252 
 253 void os::Solaris::try_enable_extended_io() {
 254   typedef int (*enable_extended_FILE_stdio_t)(int, int);
 255 
 256   if (!UseExtendedFileIO) {
 257     return;
 258   }
 259 
 260   enable_extended_FILE_stdio_t enabler =
 261     (enable_extended_FILE_stdio_t) dlsym(RTLD_DEFAULT,
 262                                          &quot;enable_extended_FILE_stdio&quot;);
 263   if (enabler) {
 264     enabler(-1, -1);
 265   }
 266 }
 267 
 268 jint os::Solaris::_os_thread_limit = 0;
 269 volatile jint os::Solaris::_os_thread_count = 0;
 270 
 271 julong os::available_memory() {
 272   return Solaris::available_memory();
 273 }
 274 
 275 julong os::Solaris::available_memory() {
 276   return (julong)sysconf(_SC_AVPHYS_PAGES) * os::vm_page_size();
 277 }
 278 
 279 julong os::Solaris::_physical_memory = 0;
 280 
 281 julong os::physical_memory() {
 282   return Solaris::physical_memory();
 283 }
 284 
 285 static hrtime_t first_hrtime = 0;
 286 static const hrtime_t hrtime_hz = 1000*1000*1000;
 287 static volatile hrtime_t max_hrtime = 0;
 288 
 289 
 290 void os::Solaris::initialize_system_info() {
 291   set_processor_count(sysconf(_SC_NPROCESSORS_CONF));
 292   _physical_memory = (julong)sysconf(_SC_PHYS_PAGES) *
 293                                      (julong)sysconf(_SC_PAGESIZE);
 294 }
 295 
 296 uint os::processor_id() {
 297   const processorid_t id = ::getcpuid();
 298   assert(id &gt;= 0 &amp;&amp; id &lt; _processor_count, &quot;Invalid processor id&quot;);
 299   return (uint)id;
 300 }
 301 
 302 int os::active_processor_count() {
 303   // User has overridden the number of active processors
 304   if (ActiveProcessorCount &gt; 0) {
 305     log_trace(os)(&quot;active_processor_count: &quot;
 306                   &quot;active processor count set by user : %d&quot;,
 307                   ActiveProcessorCount);
 308     return ActiveProcessorCount;
 309   }
 310 
 311   int online_cpus = sysconf(_SC_NPROCESSORS_ONLN);
 312   pid_t pid = getpid();
 313   psetid_t pset = PS_NONE;
 314   // Are we running in a processor set or is there any processor set around?
 315   if (pset_bind(PS_QUERY, P_PID, pid, &amp;pset) == 0) {
 316     uint_t pset_cpus;
 317     // Query the number of cpus available to us.
 318     if (pset_info(pset, NULL, &amp;pset_cpus, NULL) == 0) {
 319       assert(pset_cpus &gt; 0 &amp;&amp; pset_cpus &lt;= online_cpus, &quot;sanity check&quot;);
 320       return pset_cpus;
 321     }
 322   }
 323   // Otherwise return number of online cpus
 324   return online_cpus;
 325 }
 326 
 327 void os::set_native_thread_name(const char *name) {
 328   if (Solaris::_pthread_setname_np != NULL) {
 329     // Only the first 31 bytes of &#39;name&#39; are processed by pthread_setname_np
 330     // but we explicitly copy into a size-limited buffer to avoid any
 331     // possible overflow.
 332     char buf[32];
 333     snprintf(buf, sizeof(buf), &quot;%s&quot;, name);
 334     buf[sizeof(buf) - 1] = &#39;\0&#39;;
 335     Solaris::_pthread_setname_np(pthread_self(), buf);
 336   }
 337 }
 338 
 339 bool os::bind_to_processor(uint processor_id) {
 340   // We assume that a processorid_t can be stored in a uint.
 341   assert(sizeof(uint) == sizeof(processorid_t),
 342          &quot;can&#39;t convert uint to processorid_t&quot;);
 343   int bind_result =
 344     processor_bind(P_LWPID,                       // bind LWP.
 345                    P_MYID,                        // bind current LWP.
 346                    (processorid_t) processor_id,  // id.
 347                    NULL);                         // don&#39;t return old binding.
 348   return (bind_result == 0);
 349 }
 350 
 351 // Return true if user is running as root.
 352 
 353 bool os::have_special_privileges() {
 354   static bool init = false;
 355   static bool privileges = false;
 356   if (!init) {
 357     privileges = (getuid() != geteuid()) || (getgid() != getegid());
 358     init = true;
 359   }
 360   return privileges;
 361 }
 362 
 363 
 364 void os::init_system_properties_values() {
 365   // The next steps are taken in the product version:
 366   //
 367   // Obtain the JAVA_HOME value from the location of libjvm.so.
 368   // This library should be located at:
 369   // &lt;JAVA_HOME&gt;/jre/lib/&lt;arch&gt;/{client|server}/libjvm.so.
 370   //
 371   // If &quot;/jre/lib/&quot; appears at the right place in the path, then we
 372   // assume libjvm.so is installed in a JDK and we use this path.
 373   //
 374   // Otherwise exit with message: &quot;Could not create the Java virtual machine.&quot;
 375   //
 376   // The following extra steps are taken in the debugging version:
 377   //
 378   // If &quot;/jre/lib/&quot; does NOT appear at the right place in the path
 379   // instead of exit check for $JAVA_HOME environment variable.
 380   //
 381   // If it is defined and we are able to locate $JAVA_HOME/jre/lib/&lt;arch&gt;,
 382   // then we append a fake suffix &quot;hotspot/libjvm.so&quot; to this path so
 383   // it looks like libjvm.so is installed there
 384   // &lt;JAVA_HOME&gt;/jre/lib/&lt;arch&gt;/hotspot/libjvm.so.
 385   //
 386   // Otherwise exit.
 387   //
 388   // Important note: if the location of libjvm.so changes this
 389   // code needs to be changed accordingly.
 390 
 391 // Base path of extensions installed on the system.
 392 #define SYS_EXT_DIR     &quot;/usr/jdk/packages&quot;
 393 #define EXTENSIONS_DIR  &quot;/lib/ext&quot;
 394 
 395   // Buffer that fits several sprintfs.
 396   // Note that the space for the colon and the trailing null are provided
 397   // by the nulls included by the sizeof operator.
 398   const size_t bufsize =
 399     MAX3((size_t)MAXPATHLEN,  // For dll_dir &amp; friends.
 400          sizeof(SYS_EXT_DIR) + sizeof(&quot;/lib/&quot;), // invariant ld_library_path
 401          (size_t)MAXPATHLEN + sizeof(EXTENSIONS_DIR) + sizeof(SYS_EXT_DIR) + sizeof(EXTENSIONS_DIR)); // extensions dir
 402   char *buf = NEW_C_HEAP_ARRAY(char, bufsize, mtInternal);
 403 
 404   // sysclasspath, java_home, dll_dir
 405   {
 406     char *pslash;
 407     os::jvm_path(buf, bufsize);
 408 
 409     // Found the full path to libjvm.so.
 410     // Now cut the path to &lt;java_home&gt;/jre if we can.
 411     *(strrchr(buf, &#39;/&#39;)) = &#39;\0&#39;; // Get rid of /libjvm.so.
 412     pslash = strrchr(buf, &#39;/&#39;);
 413     if (pslash != NULL) {
 414       *pslash = &#39;\0&#39;;            // Get rid of /{client|server|hotspot}.
 415     }
 416     Arguments::set_dll_dir(buf);
 417 
 418     if (pslash != NULL) {
 419       pslash = strrchr(buf, &#39;/&#39;);
 420       if (pslash != NULL) {
 421         *pslash = &#39;\0&#39;;        // Get rid of /lib.
 422       }
 423     }
 424     Arguments::set_java_home(buf);
 425     if (!set_boot_path(&#39;/&#39;, &#39;:&#39;)) {
 426       vm_exit_during_initialization(&quot;Failed setting boot class path.&quot;, NULL);
 427     }
 428   }
 429 
 430   // Where to look for native libraries.
 431   {
 432     // Use dlinfo() to determine the correct java.library.path.
 433     //
 434     // If we&#39;re launched by the Java launcher, and the user
 435     // does not set java.library.path explicitly on the commandline,
 436     // the Java launcher sets LD_LIBRARY_PATH for us and unsets
 437     // LD_LIBRARY_PATH_32 and LD_LIBRARY_PATH_64.  In this case
 438     // dlinfo returns LD_LIBRARY_PATH + crle settings (including
 439     // /usr/lib), which is exactly what we want.
 440     //
 441     // If the user does set java.library.path, it completely
 442     // overwrites this setting, and always has.
 443     //
 444     // If we&#39;re not launched by the Java launcher, we may
 445     // get here with any/all of the LD_LIBRARY_PATH[_32|64]
 446     // settings.  Again, dlinfo does exactly what we want.
 447 
 448     Dl_serinfo     info_sz, *info = &amp;info_sz;
 449     Dl_serpath     *path;
 450     char           *library_path;
 451     char           *common_path = buf;
 452 
 453     // Determine search path count and required buffer size.
 454     if (dlinfo(RTLD_SELF, RTLD_DI_SERINFOSIZE, (void *)info) == -1) {
 455       FREE_C_HEAP_ARRAY(char, buf);
 456       vm_exit_during_initialization(&quot;dlinfo SERINFOSIZE request&quot;, dlerror());
 457     }
 458 
 459     // Allocate new buffer and initialize.
 460     info = (Dl_serinfo*)NEW_C_HEAP_ARRAY(char, info_sz.dls_size, mtInternal);
 461     info-&gt;dls_size = info_sz.dls_size;
 462     info-&gt;dls_cnt = info_sz.dls_cnt;
 463 
 464     // Obtain search path information.
 465     if (dlinfo(RTLD_SELF, RTLD_DI_SERINFO, (void *)info) == -1) {
 466       FREE_C_HEAP_ARRAY(char, buf);
 467       FREE_C_HEAP_ARRAY(char, info);
 468       vm_exit_during_initialization(&quot;dlinfo SERINFO request&quot;, dlerror());
 469     }
 470 
 471     path = &amp;info-&gt;dls_serpath[0];
 472 
 473     // Note: Due to a legacy implementation, most of the library path
 474     // is set in the launcher. This was to accomodate linking restrictions
 475     // on legacy Solaris implementations (which are no longer supported).
 476     // Eventually, all the library path setting will be done here.
 477     //
 478     // However, to prevent the proliferation of improperly built native
 479     // libraries, the new path component /usr/jdk/packages is added here.
 480 
 481     // Construct the invariant part of ld_library_path.
 482     sprintf(common_path, SYS_EXT_DIR &quot;/lib&quot;);
 483 
 484     // Struct size is more than sufficient for the path components obtained
 485     // through the dlinfo() call, so only add additional space for the path
 486     // components explicitly added here.
 487     size_t library_path_size = info-&gt;dls_size + strlen(common_path);
 488     library_path = NEW_C_HEAP_ARRAY(char, library_path_size, mtInternal);
 489     library_path[0] = &#39;\0&#39;;
 490 
 491     // Construct the desired Java library path from the linker&#39;s library
 492     // search path.
 493     //
 494     // For compatibility, it is optimal that we insert the additional path
 495     // components specific to the Java VM after those components specified
 496     // in LD_LIBRARY_PATH (if any) but before those added by the ld.so
 497     // infrastructure.
 498     if (info-&gt;dls_cnt == 0) { // Not sure this can happen, but allow for it.
 499       strcpy(library_path, common_path);
 500     } else {
 501       int inserted = 0;
 502       int i;
 503       for (i = 0; i &lt; info-&gt;dls_cnt; i++, path++) {
 504         uint_t flags = path-&gt;dls_flags &amp; LA_SER_MASK;
 505         if (((flags &amp; LA_SER_LIBPATH) == 0) &amp;&amp; !inserted) {
 506           strcat(library_path, common_path);
 507           strcat(library_path, os::path_separator());
 508           inserted = 1;
 509         }
 510         strcat(library_path, path-&gt;dls_name);
 511         strcat(library_path, os::path_separator());
 512       }
 513       // Eliminate trailing path separator.
 514       library_path[strlen(library_path)-1] = &#39;\0&#39;;
 515     }
 516 
 517     // happens before argument parsing - can&#39;t use a trace flag
 518     // tty-&gt;print_raw(&quot;init_system_properties_values: native lib path: &quot;);
 519     // tty-&gt;print_raw_cr(library_path);
 520 
 521     // Callee copies into its own buffer.
 522     Arguments::set_library_path(library_path);
 523 
 524     FREE_C_HEAP_ARRAY(char, library_path);
 525     FREE_C_HEAP_ARRAY(char, info);
 526   }
 527 
 528   // Extensions directories.
 529   sprintf(buf, &quot;%s&quot; EXTENSIONS_DIR &quot;:&quot; SYS_EXT_DIR EXTENSIONS_DIR, Arguments::get_java_home());
 530   Arguments::set_ext_dirs(buf);
 531 
 532   FREE_C_HEAP_ARRAY(char, buf);
 533 
 534 #undef SYS_EXT_DIR
 535 #undef EXTENSIONS_DIR
 536 }
 537 
 538 void os::breakpoint() {
 539   BREAKPOINT;
 540 }
 541 
 542 extern &quot;C&quot; void breakpoint() {
 543   // use debugger to set breakpoint here
 544 }
 545 
 546 static thread_t main_thread;
 547 
 548 // Thread start routine for all newly created threads
 549 extern &quot;C&quot; void* thread_native_entry(void* thread_addr) {
 550 
 551   Thread* thread = (Thread*)thread_addr;
 552 
 553   thread-&gt;record_stack_base_and_size();
 554 
 555   // Try to randomize the cache line index of hot stack frames.
 556   // This helps when threads of the same stack traces evict each other&#39;s
 557   // cache lines. The threads can be either from the same JVM instance, or
 558   // from different JVM instances. The benefit is especially true for
 559   // processors with hyperthreading technology.
 560   static int counter = 0;
 561   int pid = os::current_process_id();
 562   alloca(((pid ^ counter++) &amp; 7) * 128);
 563 
 564   int prio;
 565 
 566   thread-&gt;initialize_thread_current();
 567 
 568   OSThread* osthr = thread-&gt;osthread();
 569 
 570   osthr-&gt;set_lwp_id(_lwp_self());  // Store lwp in case we are bound
 571 
 572   log_info(os, thread)(&quot;Thread is alive (tid: &quot; UINTX_FORMAT &quot;).&quot;,
 573     os::current_thread_id());
 574 
 575   if (UseNUMA) {
 576     int lgrp_id = os::numa_get_group_id();
 577     if (lgrp_id != -1) {
 578       thread-&gt;set_lgrp_id(lgrp_id);
 579     }
 580   }
 581 
 582   // Our priority was set when we were created, and stored in the
 583   // osthread, but couldn&#39;t be passed through to our LWP until now.
 584   // So read back the priority and set it again.
 585 
 586   if (osthr-&gt;thread_id() != -1) {
 587     if (UseThreadPriorities) {
 588       int prio = osthr-&gt;native_priority();
 589       if (ThreadPriorityVerbose) {
 590         tty-&gt;print_cr(&quot;Starting Thread &quot; INTPTR_FORMAT &quot;, LWP is &quot;
 591                       INTPTR_FORMAT &quot;, setting priority: %d\n&quot;,
 592                       osthr-&gt;thread_id(), osthr-&gt;lwp_id(), prio);
 593       }
 594       os::set_native_priority(thread, prio);
 595     }
 596   } else if (ThreadPriorityVerbose) {
 597     warning(&quot;Can&#39;t set priority in _start routine, thread id hasn&#39;t been set\n&quot;);
 598   }
 599 
 600   assert(osthr-&gt;get_state() == RUNNABLE, &quot;invalid os thread state&quot;);
 601 
 602   // initialize signal mask for this thread
 603   os::Solaris::hotspot_sigmask(thread);
 604 
 605   os::Solaris::init_thread_fpu_state();
 606   std::set_terminate(_handle_uncaught_cxx_exception);
 607 
 608   thread-&gt;call_run();
 609 
 610   // Note: at this point the thread object may already have deleted itself.
 611   // Do not dereference it from here on out.
 612 
 613   // One less thread is executing
 614   // When the VMThread gets here, the main thread may have already exited
 615   // which frees the CodeHeap containing the Atomic::dec code
 616   if (thread != VMThread::vm_thread() &amp;&amp; VMThread::vm_thread() != NULL) {
 617     Atomic::dec(&amp;os::Solaris::_os_thread_count);
 618   }
 619 
 620   log_info(os, thread)(&quot;Thread finished (tid: &quot; UINTX_FORMAT &quot;).&quot;, os::current_thread_id());
 621 
 622   if (UseDetachedThreads) {
 623     thr_exit(NULL);
 624     ShouldNotReachHere();
 625   }
 626   return NULL;
 627 }
 628 
 629 static OSThread* create_os_thread(Thread* thread, thread_t thread_id) {
 630   // Allocate the OSThread object
 631   OSThread* osthread = new OSThread(NULL, NULL);
 632   if (osthread == NULL) return NULL;
 633 
 634   // Store info on the Solaris thread into the OSThread
 635   osthread-&gt;set_thread_id(thread_id);
 636   osthread-&gt;set_lwp_id(_lwp_self());
 637 
 638   if (UseNUMA) {
 639     int lgrp_id = os::numa_get_group_id();
 640     if (lgrp_id != -1) {
 641       thread-&gt;set_lgrp_id(lgrp_id);
 642     }
 643   }
 644 
 645   if (ThreadPriorityVerbose) {
 646     tty-&gt;print_cr(&quot;In create_os_thread, Thread &quot; INTPTR_FORMAT &quot;, LWP is &quot; INTPTR_FORMAT &quot;\n&quot;,
 647                   osthread-&gt;thread_id(), osthread-&gt;lwp_id());
 648   }
 649 
 650   // Initial thread state is INITIALIZED, not SUSPENDED
 651   osthread-&gt;set_state(INITIALIZED);
 652 
 653   return osthread;
 654 }
 655 
 656 void os::Solaris::hotspot_sigmask(Thread* thread) {
 657   //Save caller&#39;s signal mask
 658   sigset_t sigmask;
 659   pthread_sigmask(SIG_SETMASK, NULL, &amp;sigmask);
 660   OSThread *osthread = thread-&gt;osthread();
 661   osthread-&gt;set_caller_sigmask(sigmask);
 662 
 663   pthread_sigmask(SIG_UNBLOCK, os::Solaris::unblocked_signals(), NULL);
 664   if (!ReduceSignalUsage) {
 665     if (thread-&gt;is_VM_thread()) {
 666       // Only the VM thread handles BREAK_SIGNAL ...
 667       pthread_sigmask(SIG_UNBLOCK, vm_signals(), NULL);
 668     } else {
 669       // ... all other threads block BREAK_SIGNAL
 670       assert(!sigismember(vm_signals(), SIGINT), &quot;SIGINT should not be blocked&quot;);
 671       pthread_sigmask(SIG_BLOCK, vm_signals(), NULL);
 672     }
 673   }
 674 }
 675 
 676 bool os::create_attached_thread(JavaThread* thread) {
 677 #ifdef ASSERT
 678   thread-&gt;verify_not_published();
 679 #endif
 680   OSThread* osthread = create_os_thread(thread, thr_self());
 681   if (osthread == NULL) {
 682     return false;
 683   }
 684 
 685   // Initial thread state is RUNNABLE
 686   osthread-&gt;set_state(RUNNABLE);
 687   thread-&gt;set_osthread(osthread);
 688 
 689   // initialize signal mask for this thread
 690   // and save the caller&#39;s signal mask
 691   os::Solaris::hotspot_sigmask(thread);
 692 
 693   log_info(os, thread)(&quot;Thread attached (tid: &quot; UINTX_FORMAT &quot;).&quot;,
 694     os::current_thread_id());
 695 
 696   return true;
 697 }
 698 
 699 bool os::create_main_thread(JavaThread* thread) {
 700 #ifdef ASSERT
 701   thread-&gt;verify_not_published();
 702 #endif
 703   if (_starting_thread == NULL) {
 704     _starting_thread = create_os_thread(thread, main_thread);
 705     if (_starting_thread == NULL) {
 706       return false;
 707     }
 708   }
 709 
 710   // The primodial thread is runnable from the start
 711   _starting_thread-&gt;set_state(RUNNABLE);
 712 
 713   thread-&gt;set_osthread(_starting_thread);
 714 
 715   // initialize signal mask for this thread
 716   // and save the caller&#39;s signal mask
 717   os::Solaris::hotspot_sigmask(thread);
 718 
 719   return true;
 720 }
 721 
 722 // Helper function to trace thread attributes, similar to os::Posix::describe_pthread_attr()
 723 static char* describe_thr_create_attributes(char* buf, size_t buflen,
 724                                             size_t stacksize, long flags) {
 725   stringStream ss(buf, buflen);
 726   ss.print(&quot;stacksize: &quot; SIZE_FORMAT &quot;k, &quot;, stacksize / 1024);
 727   ss.print(&quot;flags: &quot;);
 728   #define PRINT_FLAG(f) if (flags &amp; f) ss.print( #f &quot; &quot;);
 729   #define ALL(X) \
 730     X(THR_SUSPENDED) \
 731     X(THR_DETACHED) \
 732     X(THR_BOUND) \
 733     X(THR_NEW_LWP) \
 734     X(THR_DAEMON)
 735   ALL(PRINT_FLAG)
 736   #undef ALL
 737   #undef PRINT_FLAG
 738   return buf;
 739 }
 740 
 741 // return default stack size for thr_type
 742 size_t os::Posix::default_stack_size(os::ThreadType thr_type) {
 743   // default stack size when not specified by caller is 1M (2M for LP64)
 744   size_t s = (BytesPerWord &gt;&gt; 2) * K * K;
 745   return s;
 746 }
 747 
 748 bool os::create_thread(Thread* thread, ThreadType thr_type,
 749                        size_t req_stack_size) {
 750   // Allocate the OSThread object
 751   OSThread* osthread = new OSThread(NULL, NULL);
 752   if (osthread == NULL) {
 753     return false;
 754   }
 755 
 756   if (ThreadPriorityVerbose) {
 757     char *thrtyp;
 758     switch (thr_type) {
 759     case vm_thread:
 760       thrtyp = (char *)&quot;vm&quot;;
 761       break;
 762     case cgc_thread:
 763       thrtyp = (char *)&quot;cgc&quot;;
 764       break;
 765     case pgc_thread:
 766       thrtyp = (char *)&quot;pgc&quot;;
 767       break;
 768     case java_thread:
 769       thrtyp = (char *)&quot;java&quot;;
 770       break;
 771     case compiler_thread:
 772       thrtyp = (char *)&quot;compiler&quot;;
 773       break;
 774     case watcher_thread:
 775       thrtyp = (char *)&quot;watcher&quot;;
 776       break;
 777     default:
 778       thrtyp = (char *)&quot;unknown&quot;;
 779       break;
 780     }
 781     tty-&gt;print_cr(&quot;In create_thread, creating a %s thread\n&quot;, thrtyp);
 782   }
 783 
 784   // calculate stack size if it&#39;s not specified by caller
 785   size_t stack_size = os::Posix::get_initial_stack_size(thr_type, req_stack_size);
 786 
 787   // Initial state is ALLOCATED but not INITIALIZED
 788   osthread-&gt;set_state(ALLOCATED);
 789 
 790   if (os::Solaris::_os_thread_count &gt; os::Solaris::_os_thread_limit) {
 791     // We got lots of threads. Check if we still have some address space left.
 792     // Need to be at least 5Mb of unreserved address space. We do check by
 793     // trying to reserve some.
 794     const size_t VirtualMemoryBangSize = 20*K*K;
 795     char* mem = os::reserve_memory(VirtualMemoryBangSize);
 796     if (mem == NULL) {
 797       delete osthread;
 798       return false;
 799     } else {
 800       // Release the memory again
 801       os::release_memory(mem, VirtualMemoryBangSize);
 802     }
 803   }
 804 
 805   // Setup osthread because the child thread may need it.
 806   thread-&gt;set_osthread(osthread);
 807 
 808   // Create the Solaris thread
 809   thread_t tid = 0;
 810   long     flags = (UseDetachedThreads ? THR_DETACHED : 0) | THR_SUSPENDED;
 811   int      status;
 812 
 813   // Mark that we don&#39;t have an lwp or thread id yet.
 814   // In case we attempt to set the priority before the thread starts.
 815   osthread-&gt;set_lwp_id(-1);
 816   osthread-&gt;set_thread_id(-1);
 817 
 818   status = thr_create(NULL, stack_size, thread_native_entry, thread, flags, &amp;tid);
 819 
 820   char buf[64];
 821   if (status == 0) {
 822     log_info(os, thread)(&quot;Thread started (tid: &quot; UINTX_FORMAT &quot;, attributes: %s). &quot;,
 823       (uintx) tid, describe_thr_create_attributes(buf, sizeof(buf), stack_size, flags));
 824   } else {
 825     log_warning(os, thread)(&quot;Failed to start thread - thr_create failed (%s) for attributes: %s.&quot;,
 826       os::errno_name(status), describe_thr_create_attributes(buf, sizeof(buf), stack_size, flags));
 827     // Log some OS information which might explain why creating the thread failed.
 828     log_info(os, thread)(&quot;Number of threads approx. running in the VM: %d&quot;, Threads::number_of_threads());
 829     LogStream st(Log(os, thread)::info());
 830     os::Posix::print_rlimit_info(&amp;st);
 831     os::print_memory_info(&amp;st);
 832   }
 833 
 834   if (status != 0) {
 835     thread-&gt;set_osthread(NULL);
 836     // Need to clean up stuff we&#39;ve allocated so far
 837     delete osthread;
 838     return false;
 839   }
 840 
 841   Atomic::inc(&amp;os::Solaris::_os_thread_count);
 842 
 843   // Store info on the Solaris thread into the OSThread
 844   osthread-&gt;set_thread_id(tid);
 845 
 846   // Remember that we created this thread so we can set priority on it
 847   osthread-&gt;set_vm_created();
 848 
 849   // Most thread types will set an explicit priority before starting the thread,
 850   // but for those that don&#39;t we need a valid value to read back in thread_native_entry.
 851   osthread-&gt;set_native_priority(NormPriority);
 852 
 853   // Initial thread state is INITIALIZED, not SUSPENDED
 854   osthread-&gt;set_state(INITIALIZED);
 855 
 856   // The thread is returned suspended (in state INITIALIZED), and is started higher up in the call chain
 857   return true;
 858 }
 859 
 860 debug_only(static bool signal_sets_initialized = false);
 861 static sigset_t unblocked_sigs, vm_sigs;
 862 
 863 void os::Solaris::signal_sets_init() {
 864   // Should also have an assertion stating we are still single-threaded.
 865   assert(!signal_sets_initialized, &quot;Already initialized&quot;);
 866   // Fill in signals that are necessarily unblocked for all threads in
 867   // the VM. Currently, we unblock the following signals:
 868   // SHUTDOWN{1,2,3}_SIGNAL: for shutdown hooks support (unless over-ridden
 869   //                         by -Xrs (=ReduceSignalUsage));
 870   // BREAK_SIGNAL which is unblocked only by the VM thread and blocked by all
 871   // other threads. The &quot;ReduceSignalUsage&quot; boolean tells us not to alter
 872   // the dispositions or masks wrt these signals.
 873   // Programs embedding the VM that want to use the above signals for their
 874   // own purposes must, at this time, use the &quot;-Xrs&quot; option to prevent
 875   // interference with shutdown hooks and BREAK_SIGNAL thread dumping.
 876   // (See bug 4345157, and other related bugs).
 877   // In reality, though, unblocking these signals is really a nop, since
 878   // these signals are not blocked by default.
 879   sigemptyset(&amp;unblocked_sigs);
 880   sigaddset(&amp;unblocked_sigs, SIGILL);
 881   sigaddset(&amp;unblocked_sigs, SIGSEGV);
 882   sigaddset(&amp;unblocked_sigs, SIGBUS);
 883   sigaddset(&amp;unblocked_sigs, SIGFPE);
 884   sigaddset(&amp;unblocked_sigs, ASYNC_SIGNAL);
 885 
 886   if (!ReduceSignalUsage) {
 887     if (!os::Posix::is_sig_ignored(SHUTDOWN1_SIGNAL)) {
 888       sigaddset(&amp;unblocked_sigs, SHUTDOWN1_SIGNAL);
 889     }
 890     if (!os::Posix::is_sig_ignored(SHUTDOWN2_SIGNAL)) {
 891       sigaddset(&amp;unblocked_sigs, SHUTDOWN2_SIGNAL);
 892     }
 893     if (!os::Posix::is_sig_ignored(SHUTDOWN3_SIGNAL)) {
 894       sigaddset(&amp;unblocked_sigs, SHUTDOWN3_SIGNAL);
 895     }
 896   }
 897   // Fill in signals that are blocked by all but the VM thread.
 898   sigemptyset(&amp;vm_sigs);
 899   if (!ReduceSignalUsage) {
 900     sigaddset(&amp;vm_sigs, BREAK_SIGNAL);
 901   }
 902   debug_only(signal_sets_initialized = true);
 903 
 904   // For diagnostics only used in run_periodic_checks
 905   sigemptyset(&amp;check_signal_done);
 906 }
 907 
 908 // These are signals that are unblocked while a thread is running Java.
 909 // (For some reason, they get blocked by default.)
 910 sigset_t* os::Solaris::unblocked_signals() {
 911   assert(signal_sets_initialized, &quot;Not initialized&quot;);
 912   return &amp;unblocked_sigs;
 913 }
 914 
 915 // These are the signals that are blocked while a (non-VM) thread is
 916 // running Java. Only the VM thread handles these signals.
 917 sigset_t* os::Solaris::vm_signals() {
 918   assert(signal_sets_initialized, &quot;Not initialized&quot;);
 919   return &amp;vm_sigs;
 920 }
 921 
 922 // CR 7190089: on Solaris, primordial thread&#39;s stack needs adjusting.
 923 // Without the adjustment, stack size is incorrect if stack is set to unlimited (ulimit -s unlimited).
 924 void os::Solaris::correct_stack_boundaries_for_primordial_thread(Thread* thr) {
 925   assert(is_primordial_thread(), &quot;Call only for primordial thread&quot;);
 926 
 927   JavaThread* jt = (JavaThread *)thr;
 928   assert(jt != NULL, &quot;Sanity check&quot;);
 929   size_t stack_size;
 930   address base = jt-&gt;stack_base();
 931   if (Arguments::created_by_java_launcher()) {
 932     // Use 2MB to allow for Solaris 7 64 bit mode.
 933     stack_size = JavaThread::stack_size_at_create() == 0
 934       ? 2048*K : JavaThread::stack_size_at_create();
 935 
 936     // There are rare cases when we may have already used more than
 937     // the basic stack size allotment before this method is invoked.
 938     // Attempt to allow for a normally sized java_stack.
 939     size_t current_stack_offset = (size_t)(base - (address)&amp;stack_size);
 940     stack_size += ReservedSpace::page_align_size_down(current_stack_offset);
 941   } else {
 942     // 6269555: If we were not created by a Java launcher, i.e. if we are
 943     // running embedded in a native application, treat the primordial thread
 944     // as much like a native attached thread as possible.  This means using
 945     // the current stack size from thr_stksegment(), unless it is too large
 946     // to reliably setup guard pages.  A reasonable max size is 8MB.
 947     size_t current_size = os::current_stack_size();
 948     // This should never happen, but just in case....
 949     if (current_size == 0) current_size = 2 * K * K;
 950     stack_size = current_size &gt; (8 * K * K) ? (8 * K * K) : current_size;
 951   }
 952   address bottom = align_up(base - stack_size, os::vm_page_size());;
 953   stack_size = (size_t)(base - bottom);
 954 
 955   assert(stack_size &gt; 0, &quot;Stack size calculation problem&quot;);
 956 
 957   if (stack_size &gt; jt-&gt;stack_size()) {
 958 #ifndef PRODUCT
 959     struct rlimit limits;
 960     getrlimit(RLIMIT_STACK, &amp;limits);
 961     size_t size = adjust_stack_size(base, (size_t)limits.rlim_cur);
 962     assert(size &gt;= jt-&gt;stack_size(), &quot;Stack size problem in main thread&quot;);
 963 #endif
 964     tty-&gt;print_cr(&quot;Stack size of %d Kb exceeds current limit of %d Kb.\n&quot;
 965                   &quot;(Stack sizes are rounded up to a multiple of the system page size.)\n&quot;
 966                   &quot;See limit(1) to increase the stack size limit.&quot;,
 967                   stack_size / K, jt-&gt;stack_size() / K);
 968     vm_exit(1);
 969   }
 970   assert(jt-&gt;stack_size() &gt;= stack_size,
 971          &quot;Attempt to map more stack than was allocated&quot;);
 972   jt-&gt;set_stack_size(stack_size);
 973 
 974 }
 975 
 976 
 977 
 978 // Free Solaris resources related to the OSThread
 979 void os::free_thread(OSThread* osthread) {
 980   assert(osthread != NULL, &quot;os::free_thread but osthread not set&quot;);
 981 
 982   // We are told to free resources of the argument thread,
 983   // but we can only really operate on the current thread.
 984   assert(Thread::current()-&gt;osthread() == osthread,
 985          &quot;os::free_thread but not current thread&quot;);
 986 
 987   // Restore caller&#39;s signal mask
 988   sigset_t sigmask = osthread-&gt;caller_sigmask();
 989   pthread_sigmask(SIG_SETMASK, &amp;sigmask, NULL);
 990 
 991   delete osthread;
 992 }
 993 
 994 void os::pd_start_thread(Thread* thread) {
 995   int status = thr_continue(thread-&gt;osthread()-&gt;thread_id());
 996   assert_status(status == 0, status, &quot;thr_continue failed&quot;);
 997 }
 998 
 999 
1000 intx os::current_thread_id() {
1001   return (intx)thr_self();
1002 }
1003 
1004 static pid_t _initial_pid = 0;
1005 
1006 int os::current_process_id() {
1007   return (int)(_initial_pid ? _initial_pid : getpid());
1008 }
1009 
1010 // gethrtime() should be monotonic according to the documentation,
1011 // but some virtualized platforms are known to break this guarantee.
1012 // getTimeNanos() must be guaranteed not to move backwards, so we
1013 // are forced to add a check here.
1014 inline hrtime_t getTimeNanos() {
1015   const hrtime_t now = gethrtime();
1016   const hrtime_t prev = max_hrtime;
1017   if (now &lt;= prev) {
1018     return prev;   // same or retrograde time;
1019   }
1020   const hrtime_t obsv = Atomic::cmpxchg(&amp;max_hrtime, prev, now);
1021   assert(obsv &gt;= prev, &quot;invariant&quot;);   // Monotonicity
1022   // If the CAS succeeded then we&#39;re done and return &quot;now&quot;.
1023   // If the CAS failed and the observed value &quot;obsv&quot; is &gt;= now then
1024   // we should return &quot;obsv&quot;.  If the CAS failed and now &gt; obsv &gt; prv then
1025   // some other thread raced this thread and installed a new value, in which case
1026   // we could either (a) retry the entire operation, (b) retry trying to install now
1027   // or (c) just return obsv.  We use (c).   No loop is required although in some cases
1028   // we might discard a higher &quot;now&quot; value in deference to a slightly lower but freshly
1029   // installed obsv value.   That&#39;s entirely benign -- it admits no new orderings compared
1030   // to (a) or (b) -- and greatly reduces coherence traffic.
1031   // We might also condition (c) on the magnitude of the delta between obsv and now.
1032   // Avoiding excessive CAS operations to hot RW locations is critical.
1033   // See https://blogs.oracle.com/dave/entry/cas_and_cache_trivia_invalidate
1034   return (prev == obsv) ? now : obsv;
1035 }
1036 
1037 // Time since start-up in seconds to a fine granularity.
1038 // Used by VMSelfDestructTimer and the MemProfiler.
1039 double os::elapsedTime() {
1040   return (double)(getTimeNanos() - first_hrtime) / (double)hrtime_hz;
1041 }
1042 
1043 jlong os::elapsed_counter() {
1044   return (jlong)(getTimeNanos() - first_hrtime);
1045 }
1046 
1047 jlong os::elapsed_frequency() {
1048   return hrtime_hz;
1049 }
1050 
1051 // Return the real, user, and system times in seconds from an
1052 // arbitrary fixed point in the past.
1053 bool os::getTimesSecs(double* process_real_time,
1054                       double* process_user_time,
1055                       double* process_system_time) {
1056   struct tms ticks;
1057   clock_t real_ticks = times(&amp;ticks);
1058 
1059   if (real_ticks == (clock_t) (-1)) {
1060     return false;
1061   } else {
1062     double ticks_per_second = (double) clock_tics_per_sec;
1063     *process_user_time = ((double) ticks.tms_utime) / ticks_per_second;
1064     *process_system_time = ((double) ticks.tms_stime) / ticks_per_second;
1065     // For consistency return the real time from getTimeNanos()
1066     // converted to seconds.
1067     *process_real_time = ((double) getTimeNanos()) / ((double) NANOUNITS);
1068 
1069     return true;
1070   }
1071 }
1072 
1073 bool os::supports_vtime() { return true; }
1074 
1075 double os::elapsedVTime() {
1076   return (double)gethrvtime() / (double)hrtime_hz;
1077 }
1078 
1079 // Must return millis since Jan 1 1970 for JVM_CurrentTimeMillis
1080 jlong os::javaTimeMillis() {
1081   timeval t;
1082   if (gettimeofday(&amp;t, NULL) == -1) {
1083     fatal(&quot;os::javaTimeMillis: gettimeofday (%s)&quot;, os::strerror(errno));
1084   }
1085   return jlong(t.tv_sec) * 1000  +  jlong(t.tv_usec) / 1000;
1086 }
1087 
1088 // Must return seconds+nanos since Jan 1 1970. This must use the same
1089 // time source as javaTimeMillis and can&#39;t use get_nsec_fromepoch as
1090 // we need better than 1ms accuracy
1091 void os::javaTimeSystemUTC(jlong &amp;seconds, jlong &amp;nanos) {
1092   timeval t;
1093   if (gettimeofday(&amp;t, NULL) == -1) {
1094     fatal(&quot;os::javaTimeSystemUTC: gettimeofday (%s)&quot;, os::strerror(errno));
1095   }
1096   seconds = jlong(t.tv_sec);
1097   nanos = jlong(t.tv_usec) * 1000;
1098 }
1099 
1100 
1101 jlong os::javaTimeNanos() {
1102   return (jlong)getTimeNanos();
1103 }
1104 
1105 void os::javaTimeNanos_info(jvmtiTimerInfo *info_ptr) {
1106   info_ptr-&gt;max_value = ALL_64_BITS;      // gethrtime() uses all 64 bits
1107   info_ptr-&gt;may_skip_backward = false;    // not subject to resetting or drifting
1108   info_ptr-&gt;may_skip_forward = false;     // not subject to resetting or drifting
1109   info_ptr-&gt;kind = JVMTI_TIMER_ELAPSED;   // elapsed not CPU time
1110 }
1111 
1112 char * os::local_time_string(char *buf, size_t buflen) {
1113   struct tm t;
1114   time_t long_time;
1115   time(&amp;long_time);
1116   localtime_r(&amp;long_time, &amp;t);
1117   jio_snprintf(buf, buflen, &quot;%d-%02d-%02d %02d:%02d:%02d&quot;,
1118                t.tm_year + 1900, t.tm_mon + 1, t.tm_mday,
1119                t.tm_hour, t.tm_min, t.tm_sec);
1120   return buf;
1121 }
1122 
1123 // Note: os::shutdown() might be called very early during initialization, or
1124 // called from signal handler. Before adding something to os::shutdown(), make
1125 // sure it is async-safe and can handle partially initialized VM.
1126 void os::shutdown() {
1127 
1128   // allow PerfMemory to attempt cleanup of any persistent resources
1129   perfMemory_exit();
1130 
1131   // needs to remove object in file system
1132   AttachListener::abort();
1133 
1134   // flush buffered output, finish log files
1135   ostream_abort();
1136 
1137   // Check for abort hook
1138   abort_hook_t abort_hook = Arguments::abort_hook();
1139   if (abort_hook != NULL) {
1140     abort_hook();
1141   }
1142 }
1143 
1144 // Note: os::abort() might be called very early during initialization, or
1145 // called from signal handler. Before adding something to os::abort(), make
1146 // sure it is async-safe and can handle partially initialized VM.
1147 void os::abort(bool dump_core, void* siginfo, const void* context) {
1148   os::shutdown();
1149   if (dump_core) {
1150     ::abort(); // dump core (for debugging)
1151   }
1152 
1153   ::exit(1);
1154 }
1155 
1156 // Die immediately, no exit hook, no abort hook, no cleanup.
1157 // Dump a core file, if possible, for debugging.
1158 void os::die() {
1159   if (TestUnresponsiveErrorHandler &amp;&amp; !CreateCoredumpOnCrash) {
1160     // For TimeoutInErrorHandlingTest.java, we just kill the VM
1161     // and don&#39;t take the time to generate a core file.
1162     os::signal_raise(SIGKILL);
1163   } else {
1164     ::abort();
1165   }
1166 }
1167 
1168 // DLL functions
1169 
1170 const char* os::dll_file_extension() { return &quot;.so&quot;; }
1171 
1172 // This must be hard coded because it&#39;s the system&#39;s temporary
1173 // directory not the java application&#39;s temp directory, ala java.io.tmpdir.
1174 const char* os::get_temp_directory() { return &quot;/tmp&quot;; }
1175 
1176 // check if addr is inside libjvm.so
1177 bool os::address_is_in_vm(address addr) {
1178   static address libjvm_base_addr;
1179   Dl_info dlinfo;
1180 
1181   if (libjvm_base_addr == NULL) {
1182     if (dladdr(CAST_FROM_FN_PTR(void *, os::address_is_in_vm), &amp;dlinfo) != 0) {
1183       libjvm_base_addr = (address)dlinfo.dli_fbase;
1184     }
1185     assert(libjvm_base_addr !=NULL, &quot;Cannot obtain base address for libjvm&quot;);
1186   }
1187 
1188   if (dladdr((void *)addr, &amp;dlinfo) != 0) {
1189     if (libjvm_base_addr == (address)dlinfo.dli_fbase) return true;
1190   }
1191 
1192   return false;
1193 }
1194 
1195 typedef int (*dladdr1_func_type)(void *, Dl_info *, void **, int);
1196 static dladdr1_func_type dladdr1_func = NULL;
1197 
1198 bool os::dll_address_to_function_name(address addr, char *buf,
1199                                       int buflen, int * offset,
1200                                       bool demangle) {
1201   // buf is not optional, but offset is optional
1202   assert(buf != NULL, &quot;sanity check&quot;);
1203 
1204   Dl_info dlinfo;
1205 
1206   // dladdr1_func was initialized in os::init()
1207   if (dladdr1_func != NULL) {
1208     // yes, we have dladdr1
1209 
1210     // Support for dladdr1 is checked at runtime; it may be
1211     // available even if the vm is built on a machine that does
1212     // not have dladdr1 support.  Make sure there is a value for
1213     // RTLD_DL_SYMENT.
1214 #ifndef RTLD_DL_SYMENT
1215   #define RTLD_DL_SYMENT 1
1216 #endif
1217 #ifdef _LP64
1218     Elf64_Sym * info;
1219 #else
1220     Elf32_Sym * info;
1221 #endif
1222     if (dladdr1_func((void *)addr, &amp;dlinfo, (void **)&amp;info,
1223                      RTLD_DL_SYMENT) != 0) {
1224       // see if we have a matching symbol that covers our address
1225       if (dlinfo.dli_saddr != NULL &amp;&amp;
1226           (char *)dlinfo.dli_saddr + info-&gt;st_size &gt; (char *)addr) {
1227         if (dlinfo.dli_sname != NULL) {
1228           if (!(demangle &amp;&amp; Decoder::demangle(dlinfo.dli_sname, buf, buflen))) {
1229             jio_snprintf(buf, buflen, &quot;%s&quot;, dlinfo.dli_sname);
1230           }
1231           if (offset != NULL) *offset = addr - (address)dlinfo.dli_saddr;
1232           return true;
1233         }
1234       }
1235       // no matching symbol so try for just file info
1236       if (dlinfo.dli_fname != NULL &amp;&amp; dlinfo.dli_fbase != NULL) {
1237         if (Decoder::decode((address)(addr - (address)dlinfo.dli_fbase),
1238                             buf, buflen, offset, dlinfo.dli_fname, demangle)) {
1239           return true;
1240         }
1241       }
1242     }
1243     buf[0] = &#39;\0&#39;;
1244     if (offset != NULL) *offset  = -1;
1245     return false;
1246   }
1247 
1248   // no, only dladdr is available
1249   if (dladdr((void *)addr, &amp;dlinfo) != 0) {
1250     // see if we have a matching symbol
1251     if (dlinfo.dli_saddr != NULL &amp;&amp; dlinfo.dli_sname != NULL) {
1252       if (!(demangle &amp;&amp; Decoder::demangle(dlinfo.dli_sname, buf, buflen))) {
1253         jio_snprintf(buf, buflen, dlinfo.dli_sname);
1254       }
1255       if (offset != NULL) *offset = addr - (address)dlinfo.dli_saddr;
1256       return true;
1257     }
1258     // no matching symbol so try for just file info
1259     if (dlinfo.dli_fname != NULL &amp;&amp; dlinfo.dli_fbase != NULL) {
1260       if (Decoder::decode((address)(addr - (address)dlinfo.dli_fbase),
1261                           buf, buflen, offset, dlinfo.dli_fname, demangle)) {
1262         return true;
1263       }
1264     }
1265   }
1266   buf[0] = &#39;\0&#39;;
1267   if (offset != NULL) *offset  = -1;
1268   return false;
1269 }
1270 
1271 bool os::dll_address_to_library_name(address addr, char* buf,
1272                                      int buflen, int* offset) {
1273   // buf is not optional, but offset is optional
1274   assert(buf != NULL, &quot;sanity check&quot;);
1275 
1276   Dl_info dlinfo;
1277 
1278   if (dladdr((void*)addr, &amp;dlinfo) != 0) {
1279     if (dlinfo.dli_fname != NULL) {
1280       jio_snprintf(buf, buflen, &quot;%s&quot;, dlinfo.dli_fname);
1281     }
1282     if (dlinfo.dli_fbase != NULL &amp;&amp; offset != NULL) {
1283       *offset = addr - (address)dlinfo.dli_fbase;
1284     }
1285     return true;
1286   }
1287 
1288   buf[0] = &#39;\0&#39;;
1289   if (offset) *offset = -1;
1290   return false;
1291 }
1292 
1293 int os::get_loaded_modules_info(os::LoadedModulesCallbackFunc callback, void *param) {
1294   Dl_info dli;
1295   // Sanity check?
1296   if (dladdr(CAST_FROM_FN_PTR(void *, os::get_loaded_modules_info), &amp;dli) == 0 ||
1297       dli.dli_fname == NULL) {
1298     return 1;
1299   }
1300 
1301   void * handle = dlopen(dli.dli_fname, RTLD_LAZY);
1302   if (handle == NULL) {
1303     return 1;
1304   }
1305 
1306   Link_map *map;
1307   dlinfo(handle, RTLD_DI_LINKMAP, &amp;map);
1308   if (map == NULL) {
1309     dlclose(handle);
1310     return 1;
1311   }
1312 
1313   while (map-&gt;l_prev != NULL) {
1314     map = map-&gt;l_prev;
1315   }
1316 
1317   while (map != NULL) {
1318     // Iterate through all map entries and call callback with fields of interest
1319     if(callback(map-&gt;l_name, (address)map-&gt;l_addr, (address)0, param)) {
1320       dlclose(handle);
1321       return 1;
1322     }
1323     map = map-&gt;l_next;
1324   }
1325 
1326   dlclose(handle);
1327   return 0;
1328 }
1329 
1330 int _print_dll_info_cb(const char * name, address base_address, address top_address, void * param) {
1331   outputStream * out = (outputStream *) param;
1332   out-&gt;print_cr(PTR_FORMAT &quot; \t%s&quot;, base_address, name);
1333   return 0;
1334 }
1335 
1336 void os::print_dll_info(outputStream * st) {
1337   st-&gt;print_cr(&quot;Dynamic libraries:&quot;); st-&gt;flush();
1338   if (get_loaded_modules_info(_print_dll_info_cb, (void *)st)) {
1339     st-&gt;print_cr(&quot;Error: Cannot print dynamic libraries.&quot;);
1340   }
1341 }
1342 
1343 static void change_endianness(Elf32_Half&amp; val) {
1344   unsigned char *ptr = (unsigned char *)&amp;val;
1345   unsigned char swp = ptr[0];
1346   ptr[0] = ptr[1];
1347   ptr[1] = swp;
1348 }
1349 
1350 // Loads .dll/.so and
1351 // in case of error it checks if .dll/.so was built for the
1352 // same architecture as Hotspot is running on
1353 
1354 void * os::dll_load(const char *filename, char *ebuf, int ebuflen) {
1355   log_info(os)(&quot;attempting shared library load of %s&quot;, filename);
1356 
1357   void * result= ::dlopen(filename, RTLD_LAZY);
1358   if (result != NULL) {
1359     // Successful loading
1360     Events::log(NULL, &quot;Loaded shared library %s&quot;, filename);
1361     log_info(os)(&quot;shared library load of %s was successful&quot;, filename);
1362     return result;
1363   }
1364 
1365   Elf32_Ehdr elf_head;
1366   const char* error_report = ::dlerror();
1367   if (error_report == NULL) {
1368     error_report = &quot;dlerror returned no error description&quot;;
1369   }
1370   if (ebuf != NULL &amp;&amp; ebuflen &gt; 0) {
1371     ::strncpy(ebuf, error_report, ebuflen-1);
1372     ebuf[ebuflen-1]=&#39;\0&#39;;
1373   }
1374 
1375   Events::log(NULL, &quot;Loading shared library %s failed, %s&quot;, filename, error_report);
1376   log_info(os)(&quot;shared library load of %s failed, %s&quot;, filename, error_report);
1377 
1378   int diag_msg_max_length=ebuflen-strlen(ebuf);
1379   char* diag_msg_buf=ebuf+strlen(ebuf);
1380 
1381   if (diag_msg_max_length==0) {
1382     // No more space in ebuf for additional diagnostics message
1383     return NULL;
1384   }
1385 
1386 
1387   int file_descriptor= ::open(filename, O_RDONLY | O_NONBLOCK);
1388 
1389   if (file_descriptor &lt; 0) {
1390     // Can&#39;t open library, report dlerror() message
1391     return NULL;
1392   }
1393 
1394   bool failed_to_read_elf_head=
1395     (sizeof(elf_head)!=
1396      (::read(file_descriptor, &amp;elf_head,sizeof(elf_head))));
1397 
1398   ::close(file_descriptor);
1399   if (failed_to_read_elf_head) {
1400     // file i/o error - report dlerror() msg
1401     return NULL;
1402   }
1403 
1404   if (elf_head.e_ident[EI_DATA] != LITTLE_ENDIAN_ONLY(ELFDATA2LSB) BIG_ENDIAN_ONLY(ELFDATA2MSB)) {
1405     // handle invalid/out of range endianness values
1406     if (elf_head.e_ident[EI_DATA] == 0 || elf_head.e_ident[EI_DATA] &gt; 2) {
1407       return NULL;
1408     }
1409     change_endianness(elf_head.e_machine);
1410   }
1411 
1412   typedef struct {
1413     Elf32_Half    code;         // Actual value as defined in elf.h
1414     Elf32_Half    compat_class; // Compatibility of archs at VM&#39;s sense
1415     unsigned char elf_class;    // 32 or 64 bit
1416     unsigned char endianess;    // MSB or LSB
1417     char*         name;         // String representation
1418   } arch_t;
1419 
1420   static const arch_t arch_array[]={
1421     {EM_386,         EM_386,     ELFCLASS32, ELFDATA2LSB, (char*)&quot;IA 32&quot;},
1422     {EM_486,         EM_386,     ELFCLASS32, ELFDATA2LSB, (char*)&quot;IA 32&quot;},
1423     {EM_IA_64,       EM_IA_64,   ELFCLASS64, ELFDATA2LSB, (char*)&quot;IA 64&quot;},
1424     {EM_X86_64,      EM_X86_64,  ELFCLASS64, ELFDATA2LSB, (char*)&quot;AMD 64&quot;},
1425     {EM_SPARC,       EM_SPARC,   ELFCLASS32, ELFDATA2MSB, (char*)&quot;Sparc 32&quot;},
1426     {EM_SPARC32PLUS, EM_SPARC,   ELFCLASS32, ELFDATA2MSB, (char*)&quot;Sparc 32&quot;},
1427     {EM_SPARCV9,     EM_SPARCV9, ELFCLASS64, ELFDATA2MSB, (char*)&quot;Sparc v9 64&quot;},
1428     {EM_PPC,         EM_PPC,     ELFCLASS32, ELFDATA2MSB, (char*)&quot;Power PC 32&quot;},
1429     {EM_PPC64,       EM_PPC64,   ELFCLASS64, ELFDATA2MSB, (char*)&quot;Power PC 64&quot;},
1430     {EM_ARM,         EM_ARM,     ELFCLASS32, ELFDATA2LSB, (char*)&quot;ARM&quot;},
1431     // we only support 64 bit z architecture
1432     {EM_S390,        EM_S390,    ELFCLASS64, ELFDATA2MSB, (char*)&quot;IBM System/390&quot;},
1433     {EM_AARCH64,     EM_AARCH64, ELFCLASS64, ELFDATA2LSB, (char*)&quot;AARCH64&quot;}
1434   };
1435 
1436 #if  (defined IA32)
1437   static  Elf32_Half running_arch_code=EM_386;
1438 #elif   (defined AMD64)
1439   static  Elf32_Half running_arch_code=EM_X86_64;
1440 #elif  (defined IA64)
1441   static  Elf32_Half running_arch_code=EM_IA_64;
1442 #elif  (defined __sparc) &amp;&amp; (defined _LP64)
1443   static  Elf32_Half running_arch_code=EM_SPARCV9;
1444 #elif  (defined __sparc) &amp;&amp; (!defined _LP64)
1445   static  Elf32_Half running_arch_code=EM_SPARC;
1446 #elif  (defined __powerpc64__)
1447   static  Elf32_Half running_arch_code=EM_PPC64;
1448 #elif  (defined __powerpc__)
1449   static  Elf32_Half running_arch_code=EM_PPC;
1450 #elif (defined ARM)
1451   static  Elf32_Half running_arch_code=EM_ARM;
1452 #else
1453   #error Method os::dll_load requires that one of following is defined:\
1454        IA32, AMD64, IA64, __sparc, __powerpc__, ARM, ARM
1455 #endif
1456 
1457   // Identify compatibility class for VM&#39;s architecture and library&#39;s architecture
1458   // Obtain string descriptions for architectures
1459 
1460   arch_t lib_arch={elf_head.e_machine,0,elf_head.e_ident[EI_CLASS], elf_head.e_ident[EI_DATA], NULL};
1461   int running_arch_index=-1;
1462 
1463   for (unsigned int i=0; i &lt; ARRAY_SIZE(arch_array); i++) {
1464     if (running_arch_code == arch_array[i].code) {
1465       running_arch_index    = i;
1466     }
1467     if (lib_arch.code == arch_array[i].code) {
1468       lib_arch.compat_class = arch_array[i].compat_class;
1469       lib_arch.name         = arch_array[i].name;
1470     }
1471   }
1472 
1473   assert(running_arch_index != -1,
1474          &quot;Didn&#39;t find running architecture code (running_arch_code) in arch_array&quot;);
1475   if (running_arch_index == -1) {
1476     // Even though running architecture detection failed
1477     // we may still continue with reporting dlerror() message
1478     return NULL;
1479   }
1480 
1481   if (lib_arch.compat_class != arch_array[running_arch_index].compat_class) {
1482     if (lib_arch.name != NULL) {
1483       ::snprintf(diag_msg_buf, diag_msg_max_length-1,
1484                  &quot; (Possible cause: can&#39;t load %s .so on a %s platform)&quot;,
1485                  lib_arch.name, arch_array[running_arch_index].name);
1486     } else {
1487       ::snprintf(diag_msg_buf, diag_msg_max_length-1,
1488                  &quot; (Possible cause: can&#39;t load this .so (machine code=0x%x) on a %s platform)&quot;,
1489                  lib_arch.code, arch_array[running_arch_index].name);
1490     }
1491     return NULL;
1492   }
1493 
1494   if (lib_arch.endianess != arch_array[running_arch_index].endianess) {
1495     ::snprintf(diag_msg_buf, diag_msg_max_length-1,&quot; (Possible cause: endianness mismatch)&quot;);
1496     return NULL;
1497   }
1498 
1499   // ELF file class/capacity : 0 - invalid, 1 - 32bit, 2 - 64bit
1500   if (lib_arch.elf_class &gt; 2 || lib_arch.elf_class &lt; 1) {
1501     ::snprintf(diag_msg_buf, diag_msg_max_length-1, &quot; (Possible cause: invalid ELF file class)&quot;);
1502     return NULL;
1503   }
1504 
1505   if (lib_arch.elf_class != arch_array[running_arch_index].elf_class) {
1506     ::snprintf(diag_msg_buf, diag_msg_max_length-1,
1507                &quot; (Possible cause: architecture word width mismatch, can&#39;t load %d-bit .so on a %d-bit platform)&quot;,
1508                (int) lib_arch.elf_class * 32, arch_array[running_arch_index].elf_class * 32);
1509     return NULL;
1510   }
1511 
1512   return NULL;
1513 }
1514 
1515 void* os::dll_lookup(void* handle, const char* name) {
1516   return dlsym(handle, name);
1517 }
1518 
1519 void* os::get_default_process_handle() {
1520   return (void*)::dlopen(NULL, RTLD_LAZY);
1521 }
1522 
1523 static inline time_t get_mtime(const char* filename) {
1524   struct stat st;
1525   int ret = os::stat(filename, &amp;st);
1526   assert(ret == 0, &quot;failed to stat() file &#39;%s&#39;: %s&quot;, filename, os::strerror(errno));
1527   return st.st_mtime;
1528 }
1529 
1530 int os::compare_file_modified_times(const char* file1, const char* file2) {
1531   time_t t1 = get_mtime(file1);
1532   time_t t2 = get_mtime(file2);
1533   return t1 - t2;
1534 }
1535 
1536 static bool _print_ascii_file(const char* filename, outputStream* st) {
1537   int fd = ::open(filename, O_RDONLY);
1538   if (fd == -1) {
1539     return false;
1540   }
1541 
1542   char buf[32];
1543   int bytes;
1544   while ((bytes = ::read(fd, buf, sizeof(buf))) &gt; 0) {
1545     st-&gt;print_raw(buf, bytes);
1546   }
1547 
1548   ::close(fd);
1549 
1550   return true;
1551 }
1552 
1553 void os::print_os_info_brief(outputStream* st) {
1554   os::Solaris::print_distro_info(st);
1555 
1556   os::Posix::print_uname_info(st);
1557 
1558   os::Solaris::print_libversion_info(st);
1559 }
1560 
1561 void os::print_os_info(outputStream* st) {
1562   st-&gt;print(&quot;OS:&quot;);
1563 
1564   os::Solaris::print_distro_info(st);
1565 
1566   os::Posix::print_uname_info(st);
1567 
1568   os::Posix::print_uptime_info(st);
1569 
1570   os::Solaris::print_libversion_info(st);
1571 
1572   os::Posix::print_rlimit_info(st);
1573 
1574   os::Posix::print_load_average(st);
1575 }
1576 
1577 void os::Solaris::print_distro_info(outputStream* st) {
1578   if (!_print_ascii_file(&quot;/etc/release&quot;, st)) {
1579     st-&gt;print(&quot;Solaris&quot;);
1580   }
1581   st-&gt;cr();
1582 }
1583 
1584 void os::get_summary_os_info(char* buf, size_t buflen) {
1585   strncpy(buf, &quot;Solaris&quot;, buflen);  // default to plain solaris
1586   FILE* fp = fopen(&quot;/etc/release&quot;, &quot;r&quot;);
1587   if (fp != NULL) {
1588     char tmp[256];
1589     // Only get the first line and chop out everything but the os name.
1590     if (fgets(tmp, sizeof(tmp), fp)) {
1591       char* ptr = tmp;
1592       // skip past whitespace characters
1593       while (*ptr != &#39;\0&#39; &amp;&amp; (*ptr == &#39; &#39; || *ptr == &#39;\t&#39; || *ptr == &#39;\n&#39;)) ptr++;
1594       if (*ptr != &#39;\0&#39;) {
1595         char* nl = strchr(ptr, &#39;\n&#39;);
1596         if (nl != NULL) *nl = &#39;\0&#39;;
1597         strncpy(buf, ptr, buflen);
1598       }
1599     }
1600     fclose(fp);
1601   }
1602 }
1603 
1604 void os::Solaris::print_libversion_info(outputStream* st) {
1605   st-&gt;print(&quot;  (T2 libthread)&quot;);
1606   st-&gt;cr();
1607 }
1608 
1609 static bool check_addr0(outputStream* st) {
1610   jboolean status = false;
1611   const int read_chunk = 200;
1612   int ret = 0;
1613   int nmap = 0;
1614   int fd = ::open(&quot;/proc/self/map&quot;,O_RDONLY);
1615   if (fd &gt;= 0) {
1616     prmap_t *p = NULL;
1617     char *mbuff = (char *) calloc(read_chunk, sizeof(prmap_t));
1618     if (NULL == mbuff) {
1619       ::close(fd);
1620       return status;
1621     }
1622     while ((ret = ::read(fd, mbuff, read_chunk*sizeof(prmap_t))) &gt; 0) {
1623       //check if read() has not read partial data
1624       if( 0 != ret % sizeof(prmap_t)){
1625         break;
1626       }
1627       nmap = ret / sizeof(prmap_t);
1628       p = (prmap_t *)mbuff;
1629       for(int i = 0; i &lt; nmap; i++){
1630         if (p-&gt;pr_vaddr == 0x0) {
1631           st-&gt;print(&quot;Warning: Address: &quot; PTR_FORMAT &quot;, Size: &quot; SIZE_FORMAT &quot;K, &quot;,p-&gt;pr_vaddr, p-&gt;pr_size/1024);
1632           st-&gt;print(&quot;Mapped file: %s, &quot;, p-&gt;pr_mapname[0] == &#39;\0&#39; ? &quot;None&quot; : p-&gt;pr_mapname);
1633           st-&gt;print(&quot;Access: &quot;);
1634           st-&gt;print(&quot;%s&quot;,(p-&gt;pr_mflags &amp; MA_READ)  ? &quot;r&quot; : &quot;-&quot;);
1635           st-&gt;print(&quot;%s&quot;,(p-&gt;pr_mflags &amp; MA_WRITE) ? &quot;w&quot; : &quot;-&quot;);
1636           st-&gt;print(&quot;%s&quot;,(p-&gt;pr_mflags &amp; MA_EXEC)  ? &quot;x&quot; : &quot;-&quot;);
1637           st-&gt;cr();
1638           status = true;
1639         }
1640         p++;
1641       }
1642     }
1643     free(mbuff);
1644     ::close(fd);
1645   }
1646   return status;
1647 }
1648 
1649 void os::get_summary_cpu_info(char* buf, size_t buflen) {
1650   // Get MHz with system call. We don&#39;t seem to already have this.
1651   processor_info_t stats;
1652   processorid_t id = getcpuid();
1653   int clock = 0;
1654   if (processor_info(id, &amp;stats) != -1) {
1655     clock = stats.pi_clock;  // pi_processor_type isn&#39;t more informative than below
1656   }
1657 #ifdef AMD64
1658   snprintf(buf, buflen, &quot;x86 64 bit %d MHz&quot;, clock);
1659 #else
1660   // must be sparc
1661   snprintf(buf, buflen, &quot;Sparcv9 64 bit %d MHz&quot;, clock);
1662 #endif
1663 }
1664 
1665 void os::pd_print_cpu_info(outputStream* st, char* buf, size_t buflen) {
1666   // Nothing to do for now.
1667 }
1668 
1669 void os::print_memory_info(outputStream* st) {
1670   st-&gt;print(&quot;Memory:&quot;);
1671   st-&gt;print(&quot; %dk page&quot;, os::vm_page_size()&gt;&gt;10);
1672   st-&gt;print(&quot;, physical &quot; UINT64_FORMAT &quot;k&quot;, os::physical_memory()&gt;&gt;10);
1673   st-&gt;print(&quot;(&quot; UINT64_FORMAT &quot;k free)&quot;, os::available_memory() &gt;&gt; 10);
1674   st-&gt;cr();
1675   (void) check_addr0(st);
1676 }
1677 
1678 // Moved from whole group, because we need them here for diagnostic
1679 // prints.
1680 static int Maxsignum = 0;
1681 static int *ourSigFlags = NULL;
1682 
1683 int os::Solaris::get_our_sigflags(int sig) {
1684   assert(ourSigFlags!=NULL, &quot;signal data structure not initialized&quot;);
1685   assert(sig &gt; 0 &amp;&amp; sig &lt; Maxsignum, &quot;vm signal out of expected range&quot;);
1686   return ourSigFlags[sig];
1687 }
1688 
1689 void os::Solaris::set_our_sigflags(int sig, int flags) {
1690   assert(ourSigFlags!=NULL, &quot;signal data structure not initialized&quot;);
1691   assert(sig &gt; 0 &amp;&amp; sig &lt; Maxsignum, &quot;vm signal out of expected range&quot;);
1692   ourSigFlags[sig] = flags;
1693 }
1694 
1695 
1696 static const char* get_signal_handler_name(address handler,
1697                                            char* buf, int buflen) {
1698   int offset;
1699   bool found = os::dll_address_to_library_name(handler, buf, buflen, &amp;offset);
1700   if (found) {
1701     // skip directory names
1702     const char *p1, *p2;
1703     p1 = buf;
1704     size_t len = strlen(os::file_separator());
1705     while ((p2 = strstr(p1, os::file_separator())) != NULL) p1 = p2 + len;
1706     jio_snprintf(buf, buflen, &quot;%s+0x%x&quot;, p1, offset);
1707   } else {
1708     jio_snprintf(buf, buflen, PTR_FORMAT, handler);
1709   }
1710   return buf;
1711 }
1712 
1713 static void print_signal_handler(outputStream* st, int sig,
1714                                  char* buf, size_t buflen) {
1715   struct sigaction sa;
1716 
1717   sigaction(sig, NULL, &amp;sa);
1718 
1719   st-&gt;print(&quot;%s: &quot;, os::exception_name(sig, buf, buflen));
1720 
1721   address handler = (sa.sa_flags &amp; SA_SIGINFO)
1722                   ? CAST_FROM_FN_PTR(address, sa.sa_sigaction)
1723                   : CAST_FROM_FN_PTR(address, sa.sa_handler);
1724 
1725   if (handler == CAST_FROM_FN_PTR(address, SIG_DFL)) {
1726     st-&gt;print(&quot;SIG_DFL&quot;);
1727   } else if (handler == CAST_FROM_FN_PTR(address, SIG_IGN)) {
1728     st-&gt;print(&quot;SIG_IGN&quot;);
1729   } else {
1730     st-&gt;print(&quot;[%s]&quot;, get_signal_handler_name(handler, buf, buflen));
1731   }
1732 
1733   st-&gt;print(&quot;, sa_mask[0]=&quot;);
1734   os::Posix::print_signal_set_short(st, &amp;sa.sa_mask);
1735 
1736   address rh = VMError::get_resetted_sighandler(sig);
1737   // May be, handler was resetted by VMError?
1738   if (rh != NULL) {
1739     handler = rh;
1740     sa.sa_flags = VMError::get_resetted_sigflags(sig);
1741   }
1742 
1743   st-&gt;print(&quot;, sa_flags=&quot;);
1744   os::Posix::print_sa_flags(st, sa.sa_flags);
1745 
1746   // Check: is it our handler?
1747   if (handler == CAST_FROM_FN_PTR(address, signalHandler)) {
1748     // It is our signal handler
1749     // check for flags
1750     if (sa.sa_flags != os::Solaris::get_our_sigflags(sig)) {
1751       st-&gt;print(
1752                 &quot;, flags was changed from &quot; PTR32_FORMAT &quot;, consider using jsig library&quot;,
1753                 os::Solaris::get_our_sigflags(sig));
1754     }
1755   }
1756   st-&gt;cr();
1757 }
1758 
1759 void os::print_signal_handlers(outputStream* st, char* buf, size_t buflen) {
1760   st-&gt;print_cr(&quot;Signal Handlers:&quot;);
1761   print_signal_handler(st, SIGSEGV, buf, buflen);
1762   print_signal_handler(st, SIGBUS , buf, buflen);
1763   print_signal_handler(st, SIGFPE , buf, buflen);
1764   print_signal_handler(st, SIGPIPE, buf, buflen);
1765   print_signal_handler(st, SIGXFSZ, buf, buflen);
1766   print_signal_handler(st, SIGILL , buf, buflen);
1767   print_signal_handler(st, ASYNC_SIGNAL, buf, buflen);
1768   print_signal_handler(st, BREAK_SIGNAL, buf, buflen);
1769   print_signal_handler(st, SHUTDOWN1_SIGNAL , buf, buflen);
1770   print_signal_handler(st, SHUTDOWN2_SIGNAL , buf, buflen);
1771   print_signal_handler(st, SHUTDOWN3_SIGNAL, buf, buflen);
1772 }
1773 
1774 static char saved_jvm_path[MAXPATHLEN] = { 0 };
1775 
1776 // Find the full path to the current module, libjvm.so
1777 void os::jvm_path(char *buf, jint buflen) {
1778   // Error checking.
1779   if (buflen &lt; MAXPATHLEN) {
1780     assert(false, &quot;must use a large-enough buffer&quot;);
1781     buf[0] = &#39;\0&#39;;
1782     return;
1783   }
1784   // Lazy resolve the path to current module.
1785   if (saved_jvm_path[0] != 0) {
1786     strcpy(buf, saved_jvm_path);
1787     return;
1788   }
1789 
1790   Dl_info dlinfo;
1791   int ret = dladdr(CAST_FROM_FN_PTR(void *, os::jvm_path), &amp;dlinfo);
1792   assert(ret != 0, &quot;cannot locate libjvm&quot;);
1793   if (ret != 0 &amp;&amp; dlinfo.dli_fname != NULL) {
1794     if (os::Posix::realpath((char *)dlinfo.dli_fname, buf, buflen) == NULL) {
1795       return;
1796     }
1797   } else {
1798     buf[0] = &#39;\0&#39;;
1799     return;
1800   }
1801 
1802   if (Arguments::sun_java_launcher_is_altjvm()) {
1803     // Support for the java launcher&#39;s &#39;-XXaltjvm=&lt;path&gt;&#39; option. Typical
1804     // value for buf is &quot;&lt;JAVA_HOME&gt;/jre/lib/&lt;arch&gt;/&lt;vmtype&gt;/libjvm.so&quot;.
1805     // If &quot;/jre/lib/&quot; appears at the right place in the string, then
1806     // assume we are installed in a JDK and we&#39;re done.  Otherwise, check
1807     // for a JAVA_HOME environment variable and fix up the path so it
1808     // looks like libjvm.so is installed there (append a fake suffix
1809     // hotspot/libjvm.so).
1810     const char *p = buf + strlen(buf) - 1;
1811     for (int count = 0; p &gt; buf &amp;&amp; count &lt; 5; ++count) {
1812       for (--p; p &gt; buf &amp;&amp; *p != &#39;/&#39;; --p)
1813         /* empty */ ;
1814     }
1815 
1816     if (strncmp(p, &quot;/jre/lib/&quot;, 9) != 0) {
1817       // Look for JAVA_HOME in the environment.
1818       char* java_home_var = ::getenv(&quot;JAVA_HOME&quot;);
1819       if (java_home_var != NULL &amp;&amp; java_home_var[0] != 0) {
1820         char* jrelib_p;
1821         int   len;
1822 
1823         // Check the current module name &quot;libjvm.so&quot;.
1824         p = strrchr(buf, &#39;/&#39;);
1825         assert(strstr(p, &quot;/libjvm&quot;) == p, &quot;invalid library name&quot;);
1826 
1827         if (os::Posix::realpath(java_home_var, buf, buflen) == NULL) {
1828           return;
1829         }
1830         // determine if this is a legacy image or modules image
1831         // modules image doesn&#39;t have &quot;jre&quot; subdirectory
1832         len = strlen(buf);
1833         assert(len &lt; buflen, &quot;Ran out of buffer space&quot;);
1834         jrelib_p = buf + len;
1835         snprintf(jrelib_p, buflen-len, &quot;/jre/lib&quot;);
1836         if (0 != access(buf, F_OK)) {
1837           snprintf(jrelib_p, buflen-len, &quot;/lib&quot;);
1838         }
1839 
1840         if (0 == access(buf, F_OK)) {
1841           // Use current module name &quot;libjvm.so&quot;
1842           len = strlen(buf);
1843           snprintf(buf + len, buflen-len, &quot;/hotspot/libjvm.so&quot;);
1844         } else {
1845           // Go back to path of .so
1846           if (os::Posix::realpath((char *)dlinfo.dli_fname, buf, buflen) == NULL) {
1847             return;
1848           }
1849         }
1850       }
1851     }
1852   }
1853 
1854   strncpy(saved_jvm_path, buf, MAXPATHLEN);
1855   saved_jvm_path[MAXPATHLEN - 1] = &#39;\0&#39;;
1856 }
1857 
1858 
1859 void os::print_jni_name_prefix_on(outputStream* st, int args_size) {
1860   // no prefix required, not even &quot;_&quot;
1861 }
1862 
1863 
1864 void os::print_jni_name_suffix_on(outputStream* st, int args_size) {
1865   // no suffix required
1866 }
1867 
1868 // sun.misc.Signal
1869 
1870 extern &quot;C&quot; {
1871   static void UserHandler(int sig, void *siginfo, void *context) {
1872     // Ctrl-C is pressed during error reporting, likely because the error
1873     // handler fails to abort. Let VM die immediately.
1874     if (sig == SIGINT &amp;&amp; VMError::is_error_reported()) {
1875       os::die();
1876     }
1877 
1878     os::signal_notify(sig);
1879     // We do not need to reinstate the signal handler each time...
1880   }
1881 }
1882 
1883 void* os::user_handler() {
1884   return CAST_FROM_FN_PTR(void*, UserHandler);
1885 }
1886 
1887 extern &quot;C&quot; {
1888   typedef void (*sa_handler_t)(int);
1889   typedef void (*sa_sigaction_t)(int, siginfo_t *, void *);
1890 }
1891 
1892 void* os::signal(int signal_number, void* handler) {
1893   struct sigaction sigAct, oldSigAct;
1894   sigfillset(&amp;(sigAct.sa_mask));
1895   sigAct.sa_flags = SA_RESTART &amp; ~SA_RESETHAND;
1896   sigAct.sa_flags |= SA_SIGINFO;
1897   sigAct.sa_handler = CAST_TO_FN_PTR(sa_handler_t, handler);
1898 
1899   if (sigaction(signal_number, &amp;sigAct, &amp;oldSigAct)) {
1900     // -1 means registration failed
1901     return (void *)-1;
1902   }
1903 
1904   return CAST_FROM_FN_PTR(void*, oldSigAct.sa_handler);
1905 }
1906 
1907 void os::signal_raise(int signal_number) {
1908   raise(signal_number);
1909 }
1910 
1911 // The following code is moved from os.cpp for making this
1912 // code platform specific, which it is by its very nature.
1913 
1914 // a counter for each possible signal value
1915 static int Sigexit = 0;
1916 static jint *pending_signals = NULL;
1917 static int *preinstalled_sigs = NULL;
1918 static struct sigaction *chainedsigactions = NULL;
1919 static Semaphore* sig_sem = NULL;
1920 
1921 int os::sigexitnum_pd() {
1922   assert(Sigexit &gt; 0, &quot;signal memory not yet initialized&quot;);
1923   return Sigexit;
1924 }
1925 
1926 void os::Solaris::init_signal_mem() {
1927   // Initialize signal structures
1928   Maxsignum = SIGRTMAX;
1929   Sigexit = Maxsignum+1;
1930   assert(Maxsignum &gt;0, &quot;Unable to obtain max signal number&quot;);
1931 
1932   // Initialize signal structures
1933   // pending_signals has one int per signal
1934   // The additional signal is for SIGEXIT - exit signal to signal_thread
1935   pending_signals = (jint *)os::malloc(sizeof(jint) * (Sigexit+1), mtInternal);
1936   memset(pending_signals, 0, (sizeof(jint) * (Sigexit+1)));
1937 
1938   if (UseSignalChaining) {
1939     chainedsigactions = (struct sigaction *)malloc(sizeof(struct sigaction)
1940                                                    * (Maxsignum + 1), mtInternal);
1941     memset(chainedsigactions, 0, (sizeof(struct sigaction) * (Maxsignum + 1)));
1942     preinstalled_sigs = (int *)os::malloc(sizeof(int) * (Maxsignum + 1), mtInternal);
1943     memset(preinstalled_sigs, 0, (sizeof(int) * (Maxsignum + 1)));
1944   }
1945   ourSigFlags = (int*)malloc(sizeof(int) * (Maxsignum + 1), mtInternal);
1946   memset(ourSigFlags, 0, sizeof(int) * (Maxsignum + 1));
1947 }
1948 
1949 static void jdk_misc_signal_init() {
1950   // Initialize signal semaphore
1951   sig_sem = new Semaphore();
1952 }
1953 
1954 void os::signal_notify(int sig) {
1955   if (sig_sem != NULL) {
1956     Atomic::inc(&amp;pending_signals[sig]);
1957     sig_sem-&gt;signal();
1958   } else {
1959     // Signal thread is not created with ReduceSignalUsage and jdk_misc_signal_init
1960     // initialization isn&#39;t called.
1961     assert(ReduceSignalUsage, &quot;signal semaphore should be created&quot;);
1962   }
1963 }
1964 
1965 static int check_pending_signals() {
1966   int ret;
1967   while (true) {
1968     for (int i = 0; i &lt; Sigexit + 1; i++) {
1969       jint n = pending_signals[i];
1970       if (n &gt; 0 &amp;&amp; n == Atomic::cmpxchg(&amp;pending_signals[i], n, n - 1)) {
1971         return i;
1972       }
1973     }
1974     JavaThread *thread = JavaThread::current();
1975     ThreadBlockInVM tbivm(thread);
1976 
1977     bool threadIsSuspended;
1978     do {
1979       thread-&gt;set_suspend_equivalent();
1980       sig_sem-&gt;wait();
1981 
1982       // were we externally suspended while we were waiting?
1983       threadIsSuspended = thread-&gt;handle_special_suspend_equivalent_condition();
1984       if (threadIsSuspended) {
1985         // The semaphore has been incremented, but while we were waiting
1986         // another thread suspended us. We don&#39;t want to continue running
1987         // while suspended because that would surprise the thread that
1988         // suspended us.
1989         sig_sem-&gt;signal();
1990 
1991         thread-&gt;java_suspend_self();
1992       }
1993     } while (threadIsSuspended);
1994   }
1995 }
1996 
1997 int os::signal_wait() {
1998   return check_pending_signals();
1999 }
2000 
2001 ////////////////////////////////////////////////////////////////////////////////
2002 // Virtual Memory
2003 
2004 static int page_size = -1;
2005 
2006 int os::vm_page_size() {
2007   assert(page_size != -1, &quot;must call os::init&quot;);
2008   return page_size;
2009 }
2010 
2011 // Solaris allocates memory by pages.
2012 int os::vm_allocation_granularity() {
2013   assert(page_size != -1, &quot;must call os::init&quot;);
2014   return page_size;
2015 }
2016 
2017 static bool recoverable_mmap_error(int err) {
2018   // See if the error is one we can let the caller handle. This
2019   // list of errno values comes from the Solaris mmap(2) man page.
2020   switch (err) {
2021   case EBADF:
2022   case EINVAL:
2023   case ENOTSUP:
2024     // let the caller deal with these errors
2025     return true;
2026 
2027   default:
2028     // Any remaining errors on this OS can cause our reserved mapping
2029     // to be lost. That can cause confusion where different data
2030     // structures think they have the same memory mapped. The worst
2031     // scenario is if both the VM and a library think they have the
2032     // same memory mapped.
2033     return false;
2034   }
2035 }
2036 
2037 static void warn_fail_commit_memory(char* addr, size_t bytes, bool exec,
2038                                     int err) {
2039   warning(&quot;INFO: os::commit_memory(&quot; PTR_FORMAT &quot;, &quot; SIZE_FORMAT
2040           &quot;, %d) failed; error=&#39;%s&#39; (errno=%d)&quot;, addr, bytes, exec,
2041           os::strerror(err), err);
2042 }
2043 
2044 static void warn_fail_commit_memory(char* addr, size_t bytes,
2045                                     size_t alignment_hint, bool exec,
2046                                     int err) {
2047   warning(&quot;INFO: os::commit_memory(&quot; PTR_FORMAT &quot;, &quot; SIZE_FORMAT
2048           &quot;, &quot; SIZE_FORMAT &quot;, %d) failed; error=&#39;%s&#39; (errno=%d)&quot;, addr, bytes,
2049           alignment_hint, exec, os::strerror(err), err);
2050 }
2051 
2052 int os::Solaris::commit_memory_impl(char* addr, size_t bytes, bool exec) {
2053   int prot = exec ? PROT_READ|PROT_WRITE|PROT_EXEC : PROT_READ|PROT_WRITE;
2054   size_t size = bytes;
2055   char *res = Solaris::mmap_chunk(addr, size, MAP_PRIVATE|MAP_FIXED, prot);
2056   if (res != NULL) {
2057     if (UseNUMAInterleaving) {
2058         numa_make_global(addr, bytes);
2059     }
2060     return 0;
2061   }
2062 
2063   int err = errno;  // save errno from mmap() call in mmap_chunk()
2064 
2065   if (!recoverable_mmap_error(err)) {
2066     warn_fail_commit_memory(addr, bytes, exec, err);
2067     vm_exit_out_of_memory(bytes, OOM_MMAP_ERROR, &quot;committing reserved memory.&quot;);
2068   }
2069 
2070   return err;
2071 }
2072 
2073 bool os::pd_commit_memory(char* addr, size_t bytes, bool exec) {
2074   return Solaris::commit_memory_impl(addr, bytes, exec) == 0;
2075 }
2076 
2077 void os::pd_commit_memory_or_exit(char* addr, size_t bytes, bool exec,
2078                                   const char* mesg) {
2079   assert(mesg != NULL, &quot;mesg must be specified&quot;);
2080   int err = os::Solaris::commit_memory_impl(addr, bytes, exec);
2081   if (err != 0) {
2082     // the caller wants all commit errors to exit with the specified mesg:
2083     warn_fail_commit_memory(addr, bytes, exec, err);
2084     vm_exit_out_of_memory(bytes, OOM_MMAP_ERROR, &quot;%s&quot;, mesg);
2085   }
2086 }
2087 
2088 size_t os::Solaris::page_size_for_alignment(size_t alignment) {
2089   assert(is_aligned(alignment, (size_t) vm_page_size()),
2090          SIZE_FORMAT &quot; is not aligned to &quot; SIZE_FORMAT,
2091          alignment, (size_t) vm_page_size());
2092 
2093   for (int i = 0; _page_sizes[i] != 0; i++) {
2094     if (is_aligned(alignment, _page_sizes[i])) {
2095       return _page_sizes[i];
2096     }
2097   }
2098 
2099   return (size_t) vm_page_size();
2100 }
2101 
2102 int os::Solaris::commit_memory_impl(char* addr, size_t bytes,
2103                                     size_t alignment_hint, bool exec) {
2104   int err = Solaris::commit_memory_impl(addr, bytes, exec);
2105   if (err == 0 &amp;&amp; UseLargePages &amp;&amp; alignment_hint &gt; 0) {
2106     assert(is_aligned(bytes, alignment_hint),
2107            SIZE_FORMAT &quot; is not aligned to &quot; SIZE_FORMAT, bytes, alignment_hint);
2108 
2109     // The syscall memcntl requires an exact page size (see man memcntl for details).
2110     size_t page_size = page_size_for_alignment(alignment_hint);
2111     if (page_size &gt; (size_t) vm_page_size()) {
2112       (void)Solaris::setup_large_pages(addr, bytes, page_size);
2113     }
2114   }
2115   return err;
2116 }
2117 
2118 bool os::pd_commit_memory(char* addr, size_t bytes, size_t alignment_hint,
2119                           bool exec) {
2120   return Solaris::commit_memory_impl(addr, bytes, alignment_hint, exec) == 0;
2121 }
2122 
2123 void os::pd_commit_memory_or_exit(char* addr, size_t bytes,
2124                                   size_t alignment_hint, bool exec,
2125                                   const char* mesg) {
2126   assert(mesg != NULL, &quot;mesg must be specified&quot;);
2127   int err = os::Solaris::commit_memory_impl(addr, bytes, alignment_hint, exec);
2128   if (err != 0) {
2129     // the caller wants all commit errors to exit with the specified mesg:
2130     warn_fail_commit_memory(addr, bytes, alignment_hint, exec, err);
2131     vm_exit_out_of_memory(bytes, OOM_MMAP_ERROR, &quot;%s&quot;, mesg);
2132   }
2133 }
2134 
2135 // Uncommit the pages in a specified region.
2136 void os::pd_free_memory(char* addr, size_t bytes, size_t alignment_hint) {
2137   if (madvise(addr, bytes, MADV_FREE) &lt; 0) {
2138     debug_only(warning(&quot;MADV_FREE failed.&quot;));
2139     return;
2140   }
2141 }
2142 
2143 bool os::pd_create_stack_guard_pages(char* addr, size_t size) {
2144   return os::commit_memory(addr, size, !ExecMem);
2145 }
2146 
2147 bool os::remove_stack_guard_pages(char* addr, size_t size) {
2148   return os::uncommit_memory(addr, size);
2149 }
2150 
2151 // Change the page size in a given range.
2152 void os::pd_realign_memory(char *addr, size_t bytes, size_t alignment_hint) {
2153   assert((intptr_t)addr % alignment_hint == 0, &quot;Address should be aligned.&quot;);
2154   assert((intptr_t)(addr + bytes) % alignment_hint == 0, &quot;End should be aligned.&quot;);
2155   if (UseLargePages) {
2156     size_t page_size = Solaris::page_size_for_alignment(alignment_hint);
2157     if (page_size &gt; (size_t) vm_page_size()) {
2158       Solaris::setup_large_pages(addr, bytes, page_size);
2159     }
2160   }
2161 }
2162 
2163 // Tell the OS to make the range local to the first-touching LWP
2164 void os::numa_make_local(char *addr, size_t bytes, int lgrp_hint) {
2165   assert((intptr_t)addr % os::vm_page_size() == 0, &quot;Address should be page-aligned.&quot;);
2166   if (madvise(addr, bytes, MADV_ACCESS_LWP) &lt; 0) {
2167     debug_only(warning(&quot;MADV_ACCESS_LWP failed.&quot;));
2168   }
2169 }
2170 
2171 // Tell the OS that this range would be accessed from different LWPs.
2172 void os::numa_make_global(char *addr, size_t bytes) {
2173   assert((intptr_t)addr % os::vm_page_size() == 0, &quot;Address should be page-aligned.&quot;);
2174   if (madvise(addr, bytes, MADV_ACCESS_MANY) &lt; 0) {
2175     debug_only(warning(&quot;MADV_ACCESS_MANY failed.&quot;));
2176   }
2177 }
2178 
2179 // Get the number of the locality groups.
2180 size_t os::numa_get_groups_num() {
2181   size_t n = Solaris::lgrp_nlgrps(Solaris::lgrp_cookie());
2182   return n != -1 ? n : 1;
2183 }
2184 
2185 // Get a list of leaf locality groups. A leaf lgroup is group that
2186 // doesn&#39;t have any children. Typical leaf group is a CPU or a CPU/memory
2187 // board. An LWP is assigned to one of these groups upon creation.
2188 size_t os::numa_get_leaf_groups(int *ids, size_t size) {
2189   if ((ids[0] = Solaris::lgrp_root(Solaris::lgrp_cookie())) == -1) {
2190     ids[0] = 0;
2191     return 1;
2192   }
2193   int result_size = 0, top = 1, bottom = 0, cur = 0;
2194   for (int k = 0; k &lt; size; k++) {
2195     int r = Solaris::lgrp_children(Solaris::lgrp_cookie(), ids[cur],
2196                                    (Solaris::lgrp_id_t*)&amp;ids[top], size - top);
2197     if (r == -1) {
2198       ids[0] = 0;
2199       return 1;
2200     }
2201     if (!r) {
2202       // That&#39;s a leaf node.
2203       assert(bottom &lt;= cur, &quot;Sanity check&quot;);
2204       // Check if the node has memory
2205       if (Solaris::lgrp_resources(Solaris::lgrp_cookie(), ids[cur],
2206                                   NULL, 0, LGRP_RSRC_MEM) &gt; 0) {
2207         ids[bottom++] = ids[cur];
2208       }
2209     }
2210     top += r;
2211     cur++;
2212   }
2213   if (bottom == 0) {
2214     // Handle a situation, when the OS reports no memory available.
2215     // Assume UMA architecture.
2216     ids[0] = 0;
2217     return 1;
2218   }
2219   return bottom;
2220 }
2221 
2222 // Detect the topology change. Typically happens during CPU plugging-unplugging.
2223 bool os::numa_topology_changed() {
2224   int is_stale = Solaris::lgrp_cookie_stale(Solaris::lgrp_cookie());
2225   if (is_stale != -1 &amp;&amp; is_stale) {
2226     Solaris::lgrp_fini(Solaris::lgrp_cookie());
2227     Solaris::lgrp_cookie_t c = Solaris::lgrp_init(Solaris::LGRP_VIEW_CALLER);
2228     assert(c != 0, &quot;Failure to initialize LGRP API&quot;);
2229     Solaris::set_lgrp_cookie(c);
2230     return true;
2231   }
2232   return false;
2233 }
2234 
2235 // Get the group id of the current LWP.
2236 int os::numa_get_group_id() {
2237   int lgrp_id = Solaris::lgrp_home(P_LWPID, P_MYID);
2238   if (lgrp_id == -1) {
2239     return 0;
2240   }
2241   const int size = os::numa_get_groups_num();
2242   int *ids = (int*)alloca(size * sizeof(int));
2243 
2244   // Get the ids of all lgroups with memory; r is the count.
2245   int r = Solaris::lgrp_resources(Solaris::lgrp_cookie(), lgrp_id,
2246                                   (Solaris::lgrp_id_t*)ids, size, LGRP_RSRC_MEM);
2247   if (r &lt;= 0) {
2248     return 0;
2249   }
2250   return ids[os::random() % r];
2251 }
2252 
2253 int os::numa_get_group_id_for_address(const void* address) {
2254   return 0;
2255 }
2256 
2257 // Request information about the page.
2258 bool os::get_page_info(char *start, page_info* info) {
2259   const uint_t info_types[] = { MEMINFO_VLGRP, MEMINFO_VPAGESIZE };
2260   uint64_t addr = (uintptr_t)start;
2261   uint64_t outdata[2];
2262   uint_t validity = 0;
2263 
2264   if (meminfo(&amp;addr, 1, info_types, 2, outdata, &amp;validity) &lt; 0) {
2265     return false;
2266   }
2267 
2268   info-&gt;size = 0;
2269   info-&gt;lgrp_id = -1;
2270 
2271   if ((validity &amp; 1) != 0) {
2272     if ((validity &amp; 2) != 0) {
2273       info-&gt;lgrp_id = outdata[0];
2274     }
2275     if ((validity &amp; 4) != 0) {
2276       info-&gt;size = outdata[1];
2277     }
2278     return true;
2279   }
2280   return false;
2281 }
2282 
2283 // Scan the pages from start to end until a page different than
2284 // the one described in the info parameter is encountered.
2285 char *os::scan_pages(char *start, char* end, page_info* page_expected,
2286                      page_info* page_found) {
2287   const uint_t info_types[] = { MEMINFO_VLGRP, MEMINFO_VPAGESIZE };
2288   const size_t types = sizeof(info_types) / sizeof(info_types[0]);
2289   uint64_t addrs[MAX_MEMINFO_CNT], outdata[types * MAX_MEMINFO_CNT + 1];
2290   uint_t validity[MAX_MEMINFO_CNT];
2291 
2292   size_t page_size = MAX2((size_t)os::vm_page_size(), page_expected-&gt;size);
2293   uint64_t p = (uint64_t)start;
2294   while (p &lt; (uint64_t)end) {
2295     addrs[0] = p;
2296     size_t addrs_count = 1;
2297     while (addrs_count &lt; MAX_MEMINFO_CNT &amp;&amp; addrs[addrs_count - 1] + page_size &lt; (uint64_t)end) {
2298       addrs[addrs_count] = addrs[addrs_count - 1] + page_size;
2299       addrs_count++;
2300     }
2301 
2302     if (meminfo(addrs, addrs_count, info_types, types, outdata, validity) &lt; 0) {
2303       return NULL;
2304     }
2305 
2306     size_t i = 0;
2307     for (; i &lt; addrs_count; i++) {
2308       if ((validity[i] &amp; 1) != 0) {
2309         if ((validity[i] &amp; 4) != 0) {
2310           if (outdata[types * i + 1] != page_expected-&gt;size) {
2311             break;
2312           }
2313         } else if (page_expected-&gt;size != 0) {
2314           break;
2315         }
2316 
2317         if ((validity[i] &amp; 2) != 0 &amp;&amp; page_expected-&gt;lgrp_id &gt; 0) {
2318           if (outdata[types * i] != page_expected-&gt;lgrp_id) {
2319             break;
2320           }
2321         }
2322       } else {
2323         return NULL;
2324       }
2325     }
2326 
2327     if (i &lt; addrs_count) {
2328       if ((validity[i] &amp; 2) != 0) {
2329         page_found-&gt;lgrp_id = outdata[types * i];
2330       } else {
2331         page_found-&gt;lgrp_id = -1;
2332       }
2333       if ((validity[i] &amp; 4) != 0) {
2334         page_found-&gt;size = outdata[types * i + 1];
2335       } else {
2336         page_found-&gt;size = 0;
2337       }
2338       return (char*)addrs[i];
2339     }
2340 
2341     p = addrs[addrs_count - 1] + page_size;
2342   }
2343   return end;
2344 }
2345 
2346 bool os::pd_uncommit_memory(char* addr, size_t bytes) {
2347   size_t size = bytes;
2348   // Map uncommitted pages PROT_NONE so we fail early if we touch an
2349   // uncommitted page. Otherwise, the read/write might succeed if we
2350   // have enough swap space to back the physical page.
2351   return
2352     NULL != Solaris::mmap_chunk(addr, size,
2353                                 MAP_PRIVATE|MAP_FIXED|MAP_NORESERVE,
2354                                 PROT_NONE);
2355 }
2356 
2357 char* os::Solaris::mmap_chunk(char *addr, size_t size, int flags, int prot) {
2358   char *b = (char *)mmap(addr, size, prot, flags, os::Solaris::_dev_zero_fd, 0);
2359 
2360   if (b == MAP_FAILED) {
2361     return NULL;
2362   }
2363   return b;
2364 }
2365 
2366 char* os::Solaris::anon_mmap(char* requested_addr, size_t bytes,
2367                              size_t alignment_hint, bool fixed) {
2368   char* addr = requested_addr;
2369   int flags = MAP_PRIVATE | MAP_NORESERVE;
2370 
2371   assert(!(fixed &amp;&amp; (alignment_hint &gt; 0)),
2372          &quot;alignment hint meaningless with fixed mmap&quot;);
2373 
2374   if (fixed) {
2375     flags |= MAP_FIXED;
2376   } else if (alignment_hint &gt; (size_t) vm_page_size()) {
2377     flags |= MAP_ALIGN;
2378     addr = (char*) alignment_hint;
2379   }
2380 
2381   // Map uncommitted pages PROT_NONE so we fail early if we touch an
2382   // uncommitted page. Otherwise, the read/write might succeed if we
2383   // have enough swap space to back the physical page.
2384   return mmap_chunk(addr, bytes, flags, PROT_NONE);
2385 }
2386 
2387 char* os::pd_reserve_memory(size_t bytes, char* requested_addr,
2388                             size_t alignment_hint) {
2389   char* addr = Solaris::anon_mmap(requested_addr, bytes, alignment_hint,
2390                                   (requested_addr != NULL));
2391 
2392   guarantee(requested_addr == NULL || requested_addr == addr,
2393             &quot;OS failed to return requested mmap address.&quot;);
2394   return addr;
2395 }
2396 
2397 char* os::pd_attempt_reserve_memory_at(size_t bytes, char* requested_addr, int file_desc) {
2398   assert(file_desc &gt;= 0, &quot;file_desc is not valid&quot;);
2399   char* result = pd_attempt_reserve_memory_at(bytes, requested_addr);
2400   if (result != NULL) {
2401     if (replace_existing_mapping_with_file_mapping(result, bytes, file_desc) == NULL) {
2402       vm_exit_during_initialization(err_msg(&quot;Error in mapping Java heap at the given filesystem directory&quot;));
2403     }
2404   }
2405   return result;
2406 }
2407 
2408 // Reserve memory at an arbitrary address, only if that area is
2409 // available (and not reserved for something else).
2410 
2411 char* os::pd_attempt_reserve_memory_at(size_t bytes, char* requested_addr) {
2412   // Assert only that the size is a multiple of the page size, since
2413   // that&#39;s all that mmap requires, and since that&#39;s all we really know
2414   // about at this low abstraction level.  If we need higher alignment,
2415   // we can either pass an alignment to this method or verify alignment
2416   // in one of the methods further up the call chain.  See bug 5044738.
2417   assert(bytes % os::vm_page_size() == 0, &quot;reserving unexpected size block&quot;);
2418 
2419   // Since snv_84, Solaris attempts to honor the address hint - see 5003415.
2420   char* addr = Solaris::anon_mmap(requested_addr, bytes, 0, false);
2421 
2422   volatile int err = errno;
2423   if (addr == requested_addr) {
2424     return addr;
2425   }
2426 
2427   if (addr != NULL) {
2428     pd_unmap_memory(addr, bytes);
2429   }
2430 
2431   return NULL;
2432 }
2433 
2434 bool os::pd_release_memory(char* addr, size_t bytes) {
2435   size_t size = bytes;
2436   return munmap(addr, size) == 0;
2437 }
2438 
2439 static bool solaris_mprotect(char* addr, size_t bytes, int prot) {
2440   assert(addr == (char*)align_down((uintptr_t)addr, os::vm_page_size()),
2441          &quot;addr must be page aligned&quot;);
2442   Events::log(NULL, &quot;Protecting memory [&quot; INTPTR_FORMAT &quot;,&quot; INTPTR_FORMAT &quot;] with protection modes %x&quot;, p2i(addr), p2i(addr+bytes), prot);
2443   int retVal = mprotect(addr, bytes, prot);
2444   return retVal == 0;
2445 }
2446 
2447 // Protect memory (Used to pass readonly pages through
2448 // JNI GetArray&lt;type&gt;Elements with empty arrays.)
2449 // Also, used for serialization page and for compressed oops null pointer
2450 // checking.
2451 bool os::protect_memory(char* addr, size_t bytes, ProtType prot,
2452                         bool is_committed) {
2453   unsigned int p = 0;
2454   switch (prot) {
2455   case MEM_PROT_NONE: p = PROT_NONE; break;
2456   case MEM_PROT_READ: p = PROT_READ; break;
2457   case MEM_PROT_RW:   p = PROT_READ|PROT_WRITE; break;
2458   case MEM_PROT_RWX:  p = PROT_READ|PROT_WRITE|PROT_EXEC; break;
2459   default:
2460     ShouldNotReachHere();
2461   }
2462   // is_committed is unused.
2463   return solaris_mprotect(addr, bytes, p);
2464 }
2465 
2466 // guard_memory and unguard_memory only happens within stack guard pages.
2467 // Since ISM pertains only to the heap, guard and unguard memory should not
2468 /// happen with an ISM region.
2469 bool os::guard_memory(char* addr, size_t bytes) {
2470   return solaris_mprotect(addr, bytes, PROT_NONE);
2471 }
2472 
2473 bool os::unguard_memory(char* addr, size_t bytes) {
2474   return solaris_mprotect(addr, bytes, PROT_READ|PROT_WRITE);
2475 }
2476 
2477 // Large page support
2478 static size_t _large_page_size = 0;
2479 
2480 // Insertion sort for small arrays (descending order).
2481 static void insertion_sort_descending(size_t* array, int len) {
2482   for (int i = 0; i &lt; len; i++) {
2483     size_t val = array[i];
2484     for (size_t key = i; key &gt; 0 &amp;&amp; array[key - 1] &lt; val; --key) {
2485       size_t tmp = array[key];
2486       array[key] = array[key - 1];
2487       array[key - 1] = tmp;
2488     }
2489   }
2490 }
2491 
2492 bool os::Solaris::mpss_sanity_check(bool warn, size_t* page_size) {
2493   const unsigned int usable_count = VM_Version::page_size_count();
2494   if (usable_count == 1) {
2495     return false;
2496   }
2497 
2498   // Find the right getpagesizes interface.  When solaris 11 is the minimum
2499   // build platform, getpagesizes() (without the &#39;2&#39;) can be called directly.
2500   typedef int (*gps_t)(size_t[], int);
2501   gps_t gps_func = CAST_TO_FN_PTR(gps_t, dlsym(RTLD_DEFAULT, &quot;getpagesizes2&quot;));
2502   if (gps_func == NULL) {
2503     gps_func = CAST_TO_FN_PTR(gps_t, dlsym(RTLD_DEFAULT, &quot;getpagesizes&quot;));
2504     if (gps_func == NULL) {
2505       if (warn) {
2506         warning(&quot;MPSS is not supported by the operating system.&quot;);
2507       }
2508       return false;
2509     }
2510   }
2511 
2512   // Fill the array of page sizes.
2513   int n = (*gps_func)(_page_sizes, page_sizes_max);
2514   assert(n &gt; 0, &quot;Solaris bug?&quot;);
2515 
2516   if (n == page_sizes_max) {
2517     // Add a sentinel value (necessary only if the array was completely filled
2518     // since it is static (zeroed at initialization)).
2519     _page_sizes[--n] = 0;
2520     DEBUG_ONLY(warning(&quot;increase the size of the os::_page_sizes array.&quot;);)
2521   }
2522   assert(_page_sizes[n] == 0, &quot;missing sentinel&quot;);
2523   trace_page_sizes(&quot;available page sizes&quot;, _page_sizes, n);
2524 
2525   if (n == 1) return false;     // Only one page size available.
2526 
2527   // Skip sizes larger than 4M (or LargePageSizeInBytes if it was set) and
2528   // select up to usable_count elements.  First sort the array, find the first
2529   // acceptable value, then copy the usable sizes to the top of the array and
2530   // trim the rest.  Make sure to include the default page size :-).
2531   //
2532   // A better policy could get rid of the 4M limit by taking the sizes of the
2533   // important VM memory regions (java heap and possibly the code cache) into
2534   // account.
2535   insertion_sort_descending(_page_sizes, n);
2536   const size_t size_limit =
2537     FLAG_IS_DEFAULT(LargePageSizeInBytes) ? 4 * M : LargePageSizeInBytes;
2538   int beg;
2539   for (beg = 0; beg &lt; n &amp;&amp; _page_sizes[beg] &gt; size_limit; ++beg) /* empty */;
2540   const int end = MIN2((int)usable_count, n) - 1;
2541   for (int cur = 0; cur &lt; end; ++cur, ++beg) {
2542     _page_sizes[cur] = _page_sizes[beg];
2543   }
2544   _page_sizes[end] = vm_page_size();
2545   _page_sizes[end + 1] = 0;
2546 
2547   if (_page_sizes[end] &gt; _page_sizes[end - 1]) {
2548     // Default page size is not the smallest; sort again.
2549     insertion_sort_descending(_page_sizes, end + 1);
2550   }
2551   *page_size = _page_sizes[0];
2552 
2553   trace_page_sizes(&quot;usable page sizes&quot;, _page_sizes, end + 1);
2554   return true;
2555 }
2556 
2557 void os::large_page_init() {
2558   if (UseLargePages) {
2559     // print a warning if any large page related flag is specified on command line
2560     bool warn_on_failure = !FLAG_IS_DEFAULT(UseLargePages)        ||
2561                            !FLAG_IS_DEFAULT(LargePageSizeInBytes);
2562 
2563     UseLargePages = Solaris::mpss_sanity_check(warn_on_failure, &amp;_large_page_size);
2564   }
2565 }
2566 
2567 bool os::Solaris::is_valid_page_size(size_t bytes) {
2568   for (int i = 0; _page_sizes[i] != 0; i++) {
2569     if (_page_sizes[i] == bytes) {
2570       return true;
2571     }
2572   }
2573   return false;
2574 }
2575 
2576 bool os::Solaris::setup_large_pages(caddr_t start, size_t bytes, size_t align) {
2577   assert(is_valid_page_size(align), SIZE_FORMAT &quot; is not a valid page size&quot;, align);
2578   assert(is_aligned((void*) start, align),
2579          PTR_FORMAT &quot; is not aligned to &quot; SIZE_FORMAT, p2i((void*) start), align);
2580   assert(is_aligned(bytes, align),
2581          SIZE_FORMAT &quot; is not aligned to &quot; SIZE_FORMAT, bytes, align);
2582 
2583   // Signal to OS that we want large pages for addresses
2584   // from addr, addr + bytes
2585   struct memcntl_mha mpss_struct;
2586   mpss_struct.mha_cmd = MHA_MAPSIZE_VA;
2587   mpss_struct.mha_pagesize = align;
2588   mpss_struct.mha_flags = 0;
2589   // Upon successful completion, memcntl() returns 0
2590   if (memcntl(start, bytes, MC_HAT_ADVISE, (caddr_t) &amp;mpss_struct, 0, 0)) {
2591     debug_only(warning(&quot;Attempt to use MPSS failed.&quot;));
2592     return false;
2593   }
2594   return true;
2595 }
2596 
2597 char* os::pd_reserve_memory_special(size_t size, size_t alignment, char* addr, bool exec) {
2598   fatal(&quot;os::reserve_memory_special should not be called on Solaris.&quot;);
2599   return NULL;
2600 }
2601 
2602 bool os::pd_release_memory_special(char* base, size_t bytes) {
2603   fatal(&quot;os::release_memory_special should not be called on Solaris.&quot;);
2604   return false;
2605 }
2606 
2607 size_t os::large_page_size() {
2608   return _large_page_size;
2609 }
2610 
2611 // MPSS allows application to commit large page memory on demand; with ISM
2612 // the entire memory region must be allocated as shared memory.
2613 bool os::can_commit_large_page_memory() {
2614   return true;
2615 }
2616 
2617 bool os::can_execute_large_page_memory() {
2618   return true;
2619 }
2620 
2621 // Sleep forever; naked call to OS-specific sleep; use with CAUTION
2622 void os::infinite_sleep() {
2623   while (true) {    // sleep forever ...
2624     ::sleep(100);   // ... 100 seconds at a time
2625   }
2626 }
2627 
2628 // Used to convert frequent JVM_Yield() to nops
2629 bool os::dont_yield() {
2630   if (DontYieldALot) {
2631     static hrtime_t last_time = 0;
2632     hrtime_t diff = getTimeNanos() - last_time;
2633 
2634     if (diff &lt; DontYieldALotInterval * 1000000) {
2635       return true;
2636     }
2637 
2638     last_time += diff;
2639 
2640     return false;
2641   } else {
2642     return false;
2643   }
2644 }
2645 
2646 // Note that yield semantics are defined by the scheduling class to which
2647 // the thread currently belongs.  Typically, yield will _not yield to
2648 // other equal or higher priority threads that reside on the dispatch queues
2649 // of other CPUs.
2650 
2651 void os::naked_yield() {
2652   thr_yield();
2653 }
2654 
2655 // Interface for setting lwp priorities.  We are using T2 libthread,
2656 // which forces the use of bound threads, so all of our threads will
2657 // be assigned to real lwp&#39;s.  Using the thr_setprio function is
2658 // meaningless in this mode so we must adjust the real lwp&#39;s priority.
2659 // The routines below implement the getting and setting of lwp priorities.
2660 //
2661 // Note: There are three priority scales used on Solaris.  Java priotities
2662 //       which range from 1 to 10, libthread &quot;thr_setprio&quot; scale which range
2663 //       from 0 to 127, and the current scheduling class of the process we
2664 //       are running in.  This is typically from -60 to +60.
2665 //       The setting of the lwp priorities in done after a call to thr_setprio
2666 //       so Java priorities are mapped to libthread priorities and we map from
2667 //       the latter to lwp priorities.  We don&#39;t keep priorities stored in
2668 //       Java priorities since some of our worker threads want to set priorities
2669 //       higher than all Java threads.
2670 //
2671 // For related information:
2672 // (1)  man -s 2 priocntl
2673 // (2)  man -s 4 priocntl
2674 // (3)  man dispadmin
2675 // =    librt.so
2676 // =    libthread/common/rtsched.c - thrp_setlwpprio().
2677 // =    ps -cL &lt;pid&gt; ... to validate priority.
2678 // =    sched_get_priority_min and _max
2679 //              pthread_create
2680 //              sched_setparam
2681 //              pthread_setschedparam
2682 //
2683 // Assumptions:
2684 // +    We assume that all threads in the process belong to the same
2685 //              scheduling class.   IE. an homogenous process.
2686 // +    Must be root or in IA group to change change &quot;interactive&quot; attribute.
2687 //              Priocntl() will fail silently.  The only indication of failure is when
2688 //              we read-back the value and notice that it hasn&#39;t changed.
2689 // +    Interactive threads enter the runq at the head, non-interactive at the tail.
2690 // +    For RT, change timeslice as well.  Invariant:
2691 //              constant &quot;priority integral&quot;
2692 //              Konst == TimeSlice * (60-Priority)
2693 //              Given a priority, compute appropriate timeslice.
2694 // +    Higher numerical values have higher priority.
2695 
2696 // sched class attributes
2697 typedef struct {
2698   int   schedPolicy;              // classID
2699   int   maxPrio;
2700   int   minPrio;
2701 } SchedInfo;
2702 
2703 
2704 static SchedInfo tsLimits, iaLimits, rtLimits, fxLimits;
2705 
2706 #ifdef ASSERT
2707 static int  ReadBackValidate = 1;
2708 #endif
2709 static int  myClass     = 0;
2710 static int  myMin       = 0;
2711 static int  myMax       = 0;
2712 static int  myCur       = 0;
2713 static bool priocntl_enable = false;
2714 
2715 static const int criticalPrio = FXCriticalPriority;
2716 static int java_MaxPriority_to_os_priority = 0; // Saved mapping
2717 
2718 
2719 // lwp_priocntl_init
2720 //
2721 // Try to determine the priority scale for our process.
2722 //
2723 // Return errno or 0 if OK.
2724 //
2725 static int lwp_priocntl_init() {
2726   int rslt;
2727   pcinfo_t ClassInfo;
2728   pcparms_t ParmInfo;
2729   int i;
2730 
2731   if (!UseThreadPriorities) return 0;
2732 
2733   // If ThreadPriorityPolicy is 1, switch tables
2734   if (ThreadPriorityPolicy == 1) {
2735     for (i = 0; i &lt; CriticalPriority+1; i++)
2736       os::java_to_os_priority[i] = prio_policy1[i];
2737   }
2738   if (UseCriticalJavaThreadPriority) {
2739     // MaxPriority always maps to the FX scheduling class and criticalPrio.
2740     // See set_native_priority() and set_lwp_class_and_priority().
2741     // Save original MaxPriority mapping in case attempt to
2742     // use critical priority fails.
2743     java_MaxPriority_to_os_priority = os::java_to_os_priority[MaxPriority];
2744     // Set negative to distinguish from other priorities
2745     os::java_to_os_priority[MaxPriority] = -criticalPrio;
2746   }
2747 
2748   // Get IDs for a set of well-known scheduling classes.
2749   // TODO-FIXME: GETCLINFO returns the current # of classes in the
2750   // the system.  We should have a loop that iterates over the
2751   // classID values, which are known to be &quot;small&quot; integers.
2752 
2753   strcpy(ClassInfo.pc_clname, &quot;TS&quot;);
2754   ClassInfo.pc_cid = -1;
2755   rslt = priocntl(P_ALL, 0, PC_GETCID, (caddr_t)&amp;ClassInfo);
2756   if (rslt &lt; 0) return errno;
2757   assert(ClassInfo.pc_cid != -1, &quot;cid for TS class is -1&quot;);
2758   tsLimits.schedPolicy = ClassInfo.pc_cid;
2759   tsLimits.maxPrio = ((tsinfo_t*)ClassInfo.pc_clinfo)-&gt;ts_maxupri;
2760   tsLimits.minPrio = -tsLimits.maxPrio;
2761 
2762   strcpy(ClassInfo.pc_clname, &quot;IA&quot;);
2763   ClassInfo.pc_cid = -1;
2764   rslt = priocntl(P_ALL, 0, PC_GETCID, (caddr_t)&amp;ClassInfo);
2765   if (rslt &lt; 0) return errno;
2766   assert(ClassInfo.pc_cid != -1, &quot;cid for IA class is -1&quot;);
2767   iaLimits.schedPolicy = ClassInfo.pc_cid;
2768   iaLimits.maxPrio = ((iainfo_t*)ClassInfo.pc_clinfo)-&gt;ia_maxupri;
2769   iaLimits.minPrio = -iaLimits.maxPrio;
2770 
2771   strcpy(ClassInfo.pc_clname, &quot;RT&quot;);
2772   ClassInfo.pc_cid = -1;
2773   rslt = priocntl(P_ALL, 0, PC_GETCID, (caddr_t)&amp;ClassInfo);
2774   if (rslt &lt; 0) return errno;
2775   assert(ClassInfo.pc_cid != -1, &quot;cid for RT class is -1&quot;);
2776   rtLimits.schedPolicy = ClassInfo.pc_cid;
2777   rtLimits.maxPrio = ((rtinfo_t*)ClassInfo.pc_clinfo)-&gt;rt_maxpri;
2778   rtLimits.minPrio = 0;
2779 
2780   strcpy(ClassInfo.pc_clname, &quot;FX&quot;);
2781   ClassInfo.pc_cid = -1;
2782   rslt = priocntl(P_ALL, 0, PC_GETCID, (caddr_t)&amp;ClassInfo);
2783   if (rslt &lt; 0) return errno;
2784   assert(ClassInfo.pc_cid != -1, &quot;cid for FX class is -1&quot;);
2785   fxLimits.schedPolicy = ClassInfo.pc_cid;
2786   fxLimits.maxPrio = ((fxinfo_t*)ClassInfo.pc_clinfo)-&gt;fx_maxupri;
2787   fxLimits.minPrio = 0;
2788 
2789   // Query our &quot;current&quot; scheduling class.
2790   // This will normally be IA, TS or, rarely, FX or RT.
2791   memset(&amp;ParmInfo, 0, sizeof(ParmInfo));
2792   ParmInfo.pc_cid = PC_CLNULL;
2793   rslt = priocntl(P_PID, P_MYID, PC_GETPARMS, (caddr_t)&amp;ParmInfo);
2794   if (rslt &lt; 0) return errno;
2795   myClass = ParmInfo.pc_cid;
2796 
2797   // We now know our scheduling classId, get specific information
2798   // about the class.
2799   ClassInfo.pc_cid = myClass;
2800   ClassInfo.pc_clname[0] = 0;
2801   rslt = priocntl((idtype)0, 0, PC_GETCLINFO, (caddr_t)&amp;ClassInfo);
2802   if (rslt &lt; 0) return errno;
2803 
2804   if (ThreadPriorityVerbose) {
2805     tty-&gt;print_cr(&quot;lwp_priocntl_init: Class=%d(%s)...&quot;, myClass, ClassInfo.pc_clname);
2806   }
2807 
2808   memset(&amp;ParmInfo, 0, sizeof(pcparms_t));
2809   ParmInfo.pc_cid = PC_CLNULL;
2810   rslt = priocntl(P_PID, P_MYID, PC_GETPARMS, (caddr_t)&amp;ParmInfo);
2811   if (rslt &lt; 0) return errno;
2812 
2813   if (ParmInfo.pc_cid == rtLimits.schedPolicy) {
2814     myMin = rtLimits.minPrio;
2815     myMax = rtLimits.maxPrio;
2816   } else if (ParmInfo.pc_cid == iaLimits.schedPolicy) {
2817     iaparms_t *iaInfo  = (iaparms_t*)ParmInfo.pc_clparms;
2818     myMin = iaLimits.minPrio;
2819     myMax = iaLimits.maxPrio;
2820     myMax = MIN2(myMax, (int)iaInfo-&gt;ia_uprilim);       // clamp - restrict
2821   } else if (ParmInfo.pc_cid == tsLimits.schedPolicy) {
2822     tsparms_t *tsInfo  = (tsparms_t*)ParmInfo.pc_clparms;
2823     myMin = tsLimits.minPrio;
2824     myMax = tsLimits.maxPrio;
2825     myMax = MIN2(myMax, (int)tsInfo-&gt;ts_uprilim);       // clamp - restrict
2826   } else if (ParmInfo.pc_cid == fxLimits.schedPolicy) {
2827     fxparms_t *fxInfo = (fxparms_t*)ParmInfo.pc_clparms;
2828     myMin = fxLimits.minPrio;
2829     myMax = fxLimits.maxPrio;
2830     myMax = MIN2(myMax, (int)fxInfo-&gt;fx_uprilim);       // clamp - restrict
2831   } else {
2832     // No clue - punt
2833     if (ThreadPriorityVerbose) {
2834       tty-&gt;print_cr(&quot;Unknown scheduling class: %s ... \n&quot;,
2835                     ClassInfo.pc_clname);
2836     }
2837     return EINVAL;      // no clue, punt
2838   }
2839 
2840   if (ThreadPriorityVerbose) {
2841     tty-&gt;print_cr(&quot;Thread priority Range: [%d..%d]\n&quot;, myMin, myMax);
2842   }
2843 
2844   priocntl_enable = true;  // Enable changing priorities
2845   return 0;
2846 }
2847 
2848 #define IAPRI(x)        ((iaparms_t *)((x).pc_clparms))
2849 #define RTPRI(x)        ((rtparms_t *)((x).pc_clparms))
2850 #define TSPRI(x)        ((tsparms_t *)((x).pc_clparms))
2851 #define FXPRI(x)        ((fxparms_t *)((x).pc_clparms))
2852 
2853 
2854 // scale_to_lwp_priority
2855 //
2856 // Convert from the libthread &quot;thr_setprio&quot; scale to our current
2857 // lwp scheduling class scale.
2858 //
2859 static int scale_to_lwp_priority(int rMin, int rMax, int x) {
2860   int v;
2861 
2862   if (x == 127) return rMax;            // avoid round-down
2863   v = (((x*(rMax-rMin)))/128)+rMin;
2864   return v;
2865 }
2866 
2867 
2868 // set_lwp_class_and_priority
2869 int set_lwp_class_and_priority(int ThreadID, int lwpid,
2870                                int newPrio, int new_class, bool scale) {
2871   int rslt;
2872   int Actual, Expected, prv;
2873   pcparms_t ParmInfo;                   // for GET-SET
2874 #ifdef ASSERT
2875   pcparms_t ReadBack;                   // for readback
2876 #endif
2877 
2878   // Set priority via PC_GETPARMS, update, PC_SETPARMS
2879   // Query current values.
2880   // TODO: accelerate this by eliminating the PC_GETPARMS call.
2881   // Cache &quot;pcparms_t&quot; in global ParmCache.
2882   // TODO: elide set-to-same-value
2883 
2884   // If something went wrong on init, don&#39;t change priorities.
2885   if (!priocntl_enable) {
2886     if (ThreadPriorityVerbose) {
2887       tty-&gt;print_cr(&quot;Trying to set priority but init failed, ignoring&quot;);
2888     }
2889     return EINVAL;
2890   }
2891 
2892   // If lwp hasn&#39;t started yet, just return
2893   // the _start routine will call us again.
2894   if (lwpid &lt;= 0) {
2895     if (ThreadPriorityVerbose) {
2896       tty-&gt;print_cr(&quot;deferring the set_lwp_class_and_priority of thread &quot;
2897                     INTPTR_FORMAT &quot; to %d, lwpid not set&quot;,
2898                     ThreadID, newPrio);
2899     }
2900     return 0;
2901   }
2902 
2903   if (ThreadPriorityVerbose) {
2904     tty-&gt;print_cr (&quot;set_lwp_class_and_priority(&quot;
2905                    INTPTR_FORMAT &quot;@&quot; INTPTR_FORMAT &quot; %d) &quot;,
2906                    ThreadID, lwpid, newPrio);
2907   }
2908 
2909   memset(&amp;ParmInfo, 0, sizeof(pcparms_t));
2910   ParmInfo.pc_cid = PC_CLNULL;
2911   rslt = priocntl(P_LWPID, lwpid, PC_GETPARMS, (caddr_t)&amp;ParmInfo);
2912   if (rslt &lt; 0) return errno;
2913 
2914   int cur_class = ParmInfo.pc_cid;
2915   ParmInfo.pc_cid = (id_t)new_class;
2916 
2917   if (new_class == rtLimits.schedPolicy) {
2918     rtparms_t *rtInfo  = (rtparms_t*)ParmInfo.pc_clparms;
2919     rtInfo-&gt;rt_pri     = scale ? scale_to_lwp_priority(rtLimits.minPrio,
2920                                                        rtLimits.maxPrio, newPrio)
2921                                : newPrio;
2922     rtInfo-&gt;rt_tqsecs  = RT_NOCHANGE;
2923     rtInfo-&gt;rt_tqnsecs = RT_NOCHANGE;
2924     if (ThreadPriorityVerbose) {
2925       tty-&gt;print_cr(&quot;RT: %d-&gt;%d\n&quot;, newPrio, rtInfo-&gt;rt_pri);
2926     }
2927   } else if (new_class == iaLimits.schedPolicy) {
2928     iaparms_t* iaInfo  = (iaparms_t*)ParmInfo.pc_clparms;
2929     int maxClamped     = MIN2(iaLimits.maxPrio,
2930                               cur_class == new_class
2931                               ? (int)iaInfo-&gt;ia_uprilim : iaLimits.maxPrio);
2932     iaInfo-&gt;ia_upri    = scale ? scale_to_lwp_priority(iaLimits.minPrio,
2933                                                        maxClamped, newPrio)
2934                                : newPrio;
2935     iaInfo-&gt;ia_uprilim = cur_class == new_class
2936                            ? IA_NOCHANGE : (pri_t)iaLimits.maxPrio;
2937     iaInfo-&gt;ia_mode    = IA_NOCHANGE;
2938     if (ThreadPriorityVerbose) {
2939       tty-&gt;print_cr(&quot;IA: [%d...%d] %d-&gt;%d\n&quot;,
2940                     iaLimits.minPrio, maxClamped, newPrio, iaInfo-&gt;ia_upri);
2941     }
2942   } else if (new_class == tsLimits.schedPolicy) {
2943     tsparms_t* tsInfo  = (tsparms_t*)ParmInfo.pc_clparms;
2944     int maxClamped     = MIN2(tsLimits.maxPrio,
2945                               cur_class == new_class
2946                               ? (int)tsInfo-&gt;ts_uprilim : tsLimits.maxPrio);
2947     tsInfo-&gt;ts_upri    = scale ? scale_to_lwp_priority(tsLimits.minPrio,
2948                                                        maxClamped, newPrio)
2949                                : newPrio;
2950     tsInfo-&gt;ts_uprilim = cur_class == new_class
2951                            ? TS_NOCHANGE : (pri_t)tsLimits.maxPrio;
2952     if (ThreadPriorityVerbose) {
2953       tty-&gt;print_cr(&quot;TS: [%d...%d] %d-&gt;%d\n&quot;,
2954                     tsLimits.minPrio, maxClamped, newPrio, tsInfo-&gt;ts_upri);
2955     }
2956   } else if (new_class == fxLimits.schedPolicy) {
2957     fxparms_t* fxInfo  = (fxparms_t*)ParmInfo.pc_clparms;
2958     int maxClamped     = MIN2(fxLimits.maxPrio,
2959                               cur_class == new_class
2960                               ? (int)fxInfo-&gt;fx_uprilim : fxLimits.maxPrio);
2961     fxInfo-&gt;fx_upri    = scale ? scale_to_lwp_priority(fxLimits.minPrio,
2962                                                        maxClamped, newPrio)
2963                                : newPrio;
2964     fxInfo-&gt;fx_uprilim = cur_class == new_class
2965                            ? FX_NOCHANGE : (pri_t)fxLimits.maxPrio;
2966     fxInfo-&gt;fx_tqsecs  = FX_NOCHANGE;
2967     fxInfo-&gt;fx_tqnsecs = FX_NOCHANGE;
2968     if (ThreadPriorityVerbose) {
2969       tty-&gt;print_cr(&quot;FX: [%d...%d] %d-&gt;%d\n&quot;,
2970                     fxLimits.minPrio, maxClamped, newPrio, fxInfo-&gt;fx_upri);
2971     }
2972   } else {
2973     if (ThreadPriorityVerbose) {
2974       tty-&gt;print_cr(&quot;Unknown new scheduling class %d\n&quot;, new_class);
2975     }
2976     return EINVAL;    // no clue, punt
2977   }
2978 
2979   rslt = priocntl(P_LWPID, lwpid, PC_SETPARMS, (caddr_t)&amp;ParmInfo);
2980   if (ThreadPriorityVerbose &amp;&amp; rslt) {
2981     tty-&gt;print_cr (&quot;PC_SETPARMS -&gt;%d %d\n&quot;, rslt, errno);
2982   }
2983   if (rslt &lt; 0) return errno;
2984 
2985 #ifdef ASSERT
2986   // Sanity check: read back what we just attempted to set.
2987   // In theory it could have changed in the interim ...
2988   //
2989   // The priocntl system call is tricky.
2990   // Sometimes it&#39;ll validate the priority value argument and
2991   // return EINVAL if unhappy.  At other times it fails silently.
2992   // Readbacks are prudent.
2993 
2994   if (!ReadBackValidate) return 0;
2995 
2996   memset(&amp;ReadBack, 0, sizeof(pcparms_t));
2997   ReadBack.pc_cid = PC_CLNULL;
2998   rslt = priocntl(P_LWPID, lwpid, PC_GETPARMS, (caddr_t)&amp;ReadBack);
2999   assert(rslt &gt;= 0, &quot;priocntl failed&quot;);
3000   Actual = Expected = 0xBAD;
3001   assert(ParmInfo.pc_cid == ReadBack.pc_cid, &quot;cid&#39;s don&#39;t match&quot;);
3002   if (ParmInfo.pc_cid == rtLimits.schedPolicy) {
3003     Actual   = RTPRI(ReadBack)-&gt;rt_pri;
3004     Expected = RTPRI(ParmInfo)-&gt;rt_pri;
3005   } else if (ParmInfo.pc_cid == iaLimits.schedPolicy) {
3006     Actual   = IAPRI(ReadBack)-&gt;ia_upri;
3007     Expected = IAPRI(ParmInfo)-&gt;ia_upri;
3008   } else if (ParmInfo.pc_cid == tsLimits.schedPolicy) {
3009     Actual   = TSPRI(ReadBack)-&gt;ts_upri;
3010     Expected = TSPRI(ParmInfo)-&gt;ts_upri;
3011   } else if (ParmInfo.pc_cid == fxLimits.schedPolicy) {
3012     Actual   = FXPRI(ReadBack)-&gt;fx_upri;
3013     Expected = FXPRI(ParmInfo)-&gt;fx_upri;
3014   } else {
3015     if (ThreadPriorityVerbose) {
3016       tty-&gt;print_cr(&quot;set_lwp_class_and_priority: unexpected class in readback: %d\n&quot;,
3017                     ParmInfo.pc_cid);
3018     }
3019   }
3020 
3021   if (Actual != Expected) {
3022     if (ThreadPriorityVerbose) {
3023       tty-&gt;print_cr (&quot;set_lwp_class_and_priority(%d %d) Class=%d: actual=%d vs expected=%d\n&quot;,
3024                      lwpid, newPrio, ReadBack.pc_cid, Actual, Expected);
3025     }
3026   }
3027 #endif
3028 
3029   return 0;
3030 }
3031 
3032 // Solaris only gives access to 128 real priorities at a time,
3033 // so we expand Java&#39;s ten to fill this range.  This would be better
3034 // if we dynamically adjusted relative priorities.
3035 //
3036 // The ThreadPriorityPolicy option allows us to select 2 different
3037 // priority scales.
3038 //
3039 // ThreadPriorityPolicy=0
3040 // Since the Solaris&#39; default priority is MaximumPriority, we do not
3041 // set a priority lower than Max unless a priority lower than
3042 // NormPriority is requested.
3043 //
3044 // ThreadPriorityPolicy=1
3045 // This mode causes the priority table to get filled with
3046 // linear values.  NormPriority get&#39;s mapped to 50% of the
3047 // Maximum priority an so on.  This will cause VM threads
3048 // to get unfair treatment against other Solaris processes
3049 // which do not explicitly alter their thread priorities.
3050 
3051 int os::java_to_os_priority[CriticalPriority + 1] = {
3052   -99999,         // 0 Entry should never be used
3053 
3054   0,              // 1 MinPriority
3055   32,             // 2
3056   64,             // 3
3057 
3058   96,             // 4
3059   127,            // 5 NormPriority
3060   127,            // 6
3061 
3062   127,            // 7
3063   127,            // 8
3064   127,            // 9 NearMaxPriority
3065 
3066   127,            // 10 MaxPriority
3067 
3068   -criticalPrio   // 11 CriticalPriority
3069 };
3070 
3071 OSReturn os::set_native_priority(Thread* thread, int newpri) {
3072   OSThread* osthread = thread-&gt;osthread();
3073 
3074   // Save requested priority in case the thread hasn&#39;t been started
3075   osthread-&gt;set_native_priority(newpri);
3076 
3077   // Check for critical priority request
3078   bool fxcritical = false;
3079   if (newpri == -criticalPrio) {
3080     fxcritical = true;
3081     newpri = criticalPrio;
3082   }
3083 
3084   assert(newpri &gt;= MinimumPriority &amp;&amp; newpri &lt;= MaximumPriority, &quot;bad priority mapping&quot;);
3085   if (!UseThreadPriorities) return OS_OK;
3086 
3087   int status = 0;
3088 
3089   if (!fxcritical) {
3090     // Use thr_setprio only if we have a priority that thr_setprio understands
3091     status = thr_setprio(thread-&gt;osthread()-&gt;thread_id(), newpri);
3092   }
3093 
3094   int lwp_status =
3095           set_lwp_class_and_priority(osthread-&gt;thread_id(),
3096                                      osthread-&gt;lwp_id(),
3097                                      newpri,
3098                                      fxcritical ? fxLimits.schedPolicy : myClass,
3099                                      !fxcritical);
3100   if (lwp_status != 0 &amp;&amp; fxcritical) {
3101     // Try again, this time without changing the scheduling class
3102     newpri = java_MaxPriority_to_os_priority;
3103     lwp_status = set_lwp_class_and_priority(osthread-&gt;thread_id(),
3104                                             osthread-&gt;lwp_id(),
3105                                             newpri, myClass, false);
3106   }
3107   status |= lwp_status;
3108   return (status == 0) ? OS_OK : OS_ERR;
3109 }
3110 
3111 
3112 OSReturn os::get_native_priority(const Thread* const thread,
3113                                  int *priority_ptr) {
3114   int p;
3115   if (!UseThreadPriorities) {
3116     *priority_ptr = NormalPriority;
3117     return OS_OK;
3118   }
3119   int status = thr_getprio(thread-&gt;osthread()-&gt;thread_id(), &amp;p);
3120   if (status != 0) {
3121     return OS_ERR;
3122   }
3123   *priority_ptr = p;
3124   return OS_OK;
3125 }
3126 
3127 ////////////////////////////////////////////////////////////////////////////////
3128 // suspend/resume support
3129 
3130 //  The low-level signal-based suspend/resume support is a remnant from the
3131 //  old VM-suspension that used to be for java-suspension, safepoints etc,
3132 //  within hotspot. Currently used by JFR&#39;s OSThreadSampler
3133 //
3134 //  The remaining code is greatly simplified from the more general suspension
3135 //  code that used to be used.
3136 //
3137 //  The protocol is quite simple:
3138 //  - suspend:
3139 //      - sends a signal to the target thread
3140 //      - polls the suspend state of the osthread using a yield loop
3141 //      - target thread signal handler (SR_handler) sets suspend state
3142 //        and blocks in sigsuspend until continued
3143 //  - resume:
3144 //      - sets target osthread state to continue
3145 //      - sends signal to end the sigsuspend loop in the SR_handler
3146 //
3147 //  Note that the SR_lock plays no role in this suspend/resume protocol,
3148 //  but is checked for NULL in SR_handler as a thread termination indicator.
3149 //  The SR_lock is, however, used by JavaThread::java_suspend()/java_resume() APIs.
3150 //
3151 //  Note that resume_clear_context() and suspend_save_context() are needed
3152 //  by SR_handler(), so that fetch_frame_from_ucontext() works,
3153 //  which in part is used by:
3154 //    - Forte Analyzer: AsyncGetCallTrace()
3155 //    - StackBanging: get_frame_at_stack_banging_point()
3156 //    - JFR: get_topframe()--&gt;....--&gt;get_valid_uc_in_signal_handler()
3157 
3158 static void resume_clear_context(OSThread *osthread) {
3159   osthread-&gt;set_ucontext(NULL);
3160 }
3161 
3162 static void suspend_save_context(OSThread *osthread, ucontext_t* context) {
3163   osthread-&gt;set_ucontext(context);
3164 }
3165 
3166 static PosixSemaphore sr_semaphore;
3167 
3168 void os::Solaris::SR_handler(Thread* thread, ucontext_t* context) {
3169   // Save and restore errno to avoid confusing native code with EINTR
3170   // after sigsuspend.
3171   int old_errno = errno;
3172 
3173   OSThread* osthread = thread-&gt;osthread();
3174   assert(thread-&gt;is_VM_thread() || thread-&gt;is_Java_thread(), &quot;Must be VMThread or JavaThread&quot;);
3175 
3176   os::SuspendResume::State current = osthread-&gt;sr.state();
3177   if (current == os::SuspendResume::SR_SUSPEND_REQUEST) {
3178     suspend_save_context(osthread, context);
3179 
3180     // attempt to switch the state, we assume we had a SUSPEND_REQUEST
3181     os::SuspendResume::State state = osthread-&gt;sr.suspended();
3182     if (state == os::SuspendResume::SR_SUSPENDED) {
3183       sigset_t suspend_set;  // signals for sigsuspend()
3184 
3185       // get current set of blocked signals and unblock resume signal
3186       pthread_sigmask(SIG_BLOCK, NULL, &amp;suspend_set);
3187       sigdelset(&amp;suspend_set, ASYNC_SIGNAL);
3188 
3189       sr_semaphore.signal();
3190       // wait here until we are resumed
3191       while (1) {
3192         sigsuspend(&amp;suspend_set);
3193 
3194         os::SuspendResume::State result = osthread-&gt;sr.running();
3195         if (result == os::SuspendResume::SR_RUNNING) {
3196           sr_semaphore.signal();
3197           break;
3198         }
3199       }
3200 
3201     } else if (state == os::SuspendResume::SR_RUNNING) {
3202       // request was cancelled, continue
3203     } else {
3204       ShouldNotReachHere();
3205     }
3206 
3207     resume_clear_context(osthread);
3208   } else if (current == os::SuspendResume::SR_RUNNING) {
3209     // request was cancelled, continue
3210   } else if (current == os::SuspendResume::SR_WAKEUP_REQUEST) {
3211     // ignore
3212   } else {
3213     // ignore
3214   }
3215 
3216   errno = old_errno;
3217 }
3218 
3219 void os::print_statistics() {
3220 }
3221 
3222 bool os::message_box(const char* title, const char* message) {
3223   int i;
3224   fdStream err(defaultStream::error_fd());
3225   for (i = 0; i &lt; 78; i++) err.print_raw(&quot;=&quot;);
3226   err.cr();
3227   err.print_raw_cr(title);
3228   for (i = 0; i &lt; 78; i++) err.print_raw(&quot;-&quot;);
3229   err.cr();
3230   err.print_raw_cr(message);
3231   for (i = 0; i &lt; 78; i++) err.print_raw(&quot;=&quot;);
3232   err.cr();
3233 
3234   char buf[16];
3235   // Prevent process from exiting upon &quot;read error&quot; without consuming all CPU
3236   while (::read(0, buf, sizeof(buf)) &lt;= 0) { ::sleep(100); }
3237 
3238   return buf[0] == &#39;y&#39; || buf[0] == &#39;Y&#39;;
3239 }
3240 
3241 static int sr_notify(OSThread* osthread) {
3242   int status = thr_kill(osthread-&gt;thread_id(), ASYNC_SIGNAL);
3243   assert_status(status == 0, status, &quot;thr_kill&quot;);
3244   return status;
3245 }
3246 
3247 // &quot;Randomly&quot; selected value for how long we want to spin
3248 // before bailing out on suspending a thread, also how often
3249 // we send a signal to a thread we want to resume
3250 static const int RANDOMLY_LARGE_INTEGER = 1000000;
3251 static const int RANDOMLY_LARGE_INTEGER2 = 100;
3252 
3253 static bool do_suspend(OSThread* osthread) {
3254   assert(osthread-&gt;sr.is_running(), &quot;thread should be running&quot;);
3255   assert(!sr_semaphore.trywait(), &quot;semaphore has invalid state&quot;);
3256 
3257   // mark as suspended and send signal
3258   if (osthread-&gt;sr.request_suspend() != os::SuspendResume::SR_SUSPEND_REQUEST) {
3259     // failed to switch, state wasn&#39;t running?
3260     ShouldNotReachHere();
3261     return false;
3262   }
3263 
3264   if (sr_notify(osthread) != 0) {
3265     ShouldNotReachHere();
3266   }
3267 
3268   // managed to send the signal and switch to SUSPEND_REQUEST, now wait for SUSPENDED
3269   while (true) {
3270     if (sr_semaphore.timedwait(2000)) {
3271       break;
3272     } else {
3273       // timeout
3274       os::SuspendResume::State cancelled = osthread-&gt;sr.cancel_suspend();
3275       if (cancelled == os::SuspendResume::SR_RUNNING) {
3276         return false;
3277       } else if (cancelled == os::SuspendResume::SR_SUSPENDED) {
3278         // make sure that we consume the signal on the semaphore as well
3279         sr_semaphore.wait();
3280         break;
3281       } else {
3282         ShouldNotReachHere();
3283         return false;
3284       }
3285     }
3286   }
3287 
3288   guarantee(osthread-&gt;sr.is_suspended(), &quot;Must be suspended&quot;);
3289   return true;
3290 }
3291 
3292 static void do_resume(OSThread* osthread) {
3293   assert(osthread-&gt;sr.is_suspended(), &quot;thread should be suspended&quot;);
3294   assert(!sr_semaphore.trywait(), &quot;invalid semaphore state&quot;);
3295 
3296   if (osthread-&gt;sr.request_wakeup() != os::SuspendResume::SR_WAKEUP_REQUEST) {
3297     // failed to switch to WAKEUP_REQUEST
3298     ShouldNotReachHere();
3299     return;
3300   }
3301 
3302   while (true) {
3303     if (sr_notify(osthread) == 0) {
3304       if (sr_semaphore.timedwait(2)) {
3305         if (osthread-&gt;sr.is_running()) {
3306           return;
3307         }
3308       }
3309     } else {
3310       ShouldNotReachHere();
3311     }
3312   }
3313 
3314   guarantee(osthread-&gt;sr.is_running(), &quot;Must be running!&quot;);
3315 }
3316 
3317 void os::SuspendedThreadTask::internal_do_task() {
3318   if (do_suspend(_thread-&gt;osthread())) {
3319     SuspendedThreadTaskContext context(_thread, _thread-&gt;osthread()-&gt;ucontext());
3320     do_task(context);
3321     do_resume(_thread-&gt;osthread());
3322   }
3323 }
3324 
3325 // This does not do anything on Solaris. This is basically a hook for being
3326 // able to use structured exception handling (thread-local exception filters) on, e.g., Win32.
3327 void os::os_exception_wrapper(java_call_t f, JavaValue* value,
3328                               const methodHandle&amp; method, JavaCallArguments* args,
3329                               Thread* thread) {
3330   f(value, method, args, thread);
3331 }
3332 
3333 // This routine may be used by user applications as a &quot;hook&quot; to catch signals.
3334 // The user-defined signal handler must pass unrecognized signals to this
3335 // routine, and if it returns true (non-zero), then the signal handler must
3336 // return immediately.  If the flag &quot;abort_if_unrecognized&quot; is true, then this
3337 // routine will never retun false (zero), but instead will execute a VM panic
3338 // routine kill the process.
3339 //
3340 // If this routine returns false, it is OK to call it again.  This allows
3341 // the user-defined signal handler to perform checks either before or after
3342 // the VM performs its own checks.  Naturally, the user code would be making
3343 // a serious error if it tried to handle an exception (such as a null check
3344 // or breakpoint) that the VM was generating for its own correct operation.
3345 //
3346 // This routine may recognize any of the following kinds of signals:
3347 // SIGBUS, SIGSEGV, SIGILL, SIGFPE, BREAK_SIGNAL, SIGPIPE, SIGXFSZ,
3348 // ASYNC_SIGNAL.
3349 // It should be consulted by handlers for any of those signals.
3350 //
3351 // The caller of this routine must pass in the three arguments supplied
3352 // to the function referred to in the &quot;sa_sigaction&quot; (not the &quot;sa_handler&quot;)
3353 // field of the structure passed to sigaction().  This routine assumes that
3354 // the sa_flags field passed to sigaction() includes SA_SIGINFO and SA_RESTART.
3355 //
3356 // Note that the VM will print warnings if it detects conflicting signal
3357 // handlers, unless invoked with the option &quot;-XX:+AllowUserSignalHandlers&quot;.
3358 //
3359 extern &quot;C&quot; JNIEXPORT int JVM_handle_solaris_signal(int signo,
3360                                                    siginfo_t* siginfo,
3361                                                    void* ucontext,
3362                                                    int abort_if_unrecognized);
3363 
3364 
3365 void signalHandler(int sig, siginfo_t* info, void* ucVoid) {
3366   int orig_errno = errno;  // Preserve errno value over signal handler.
3367   JVM_handle_solaris_signal(sig, info, ucVoid, true);
3368   errno = orig_errno;
3369 }
3370 
3371 // This boolean allows users to forward their own non-matching signals
3372 // to JVM_handle_solaris_signal, harmlessly.
3373 bool os::Solaris::signal_handlers_are_installed = false;
3374 
3375 // For signal-chaining
3376 bool os::Solaris::libjsig_is_loaded = false;
3377 typedef struct sigaction *(*get_signal_t)(int);
3378 get_signal_t os::Solaris::get_signal_action = NULL;
3379 
3380 struct sigaction* os::Solaris::get_chained_signal_action(int sig) {
3381   struct sigaction *actp = NULL;
3382 
3383   if ((libjsig_is_loaded)  &amp;&amp; (sig &lt;= Maxsignum)) {
3384     // Retrieve the old signal handler from libjsig
3385     actp = (*get_signal_action)(sig);
3386   }
3387   if (actp == NULL) {
3388     // Retrieve the preinstalled signal handler from jvm
3389     actp = get_preinstalled_handler(sig);
3390   }
3391 
3392   return actp;
3393 }
3394 
3395 static bool call_chained_handler(struct sigaction *actp, int sig,
3396                                  siginfo_t *siginfo, void *context) {
3397   // Call the old signal handler
3398   if (actp-&gt;sa_handler == SIG_DFL) {
3399     // It&#39;s more reasonable to let jvm treat it as an unexpected exception
3400     // instead of taking the default action.
3401     return false;
3402   } else if (actp-&gt;sa_handler != SIG_IGN) {
3403     if ((actp-&gt;sa_flags &amp; SA_NODEFER) == 0) {
3404       // automaticlly block the signal
3405       sigaddset(&amp;(actp-&gt;sa_mask), sig);
3406     }
3407 
3408     sa_handler_t hand;
3409     sa_sigaction_t sa;
3410     bool siginfo_flag_set = (actp-&gt;sa_flags &amp; SA_SIGINFO) != 0;
3411     // retrieve the chained handler
3412     if (siginfo_flag_set) {
3413       sa = actp-&gt;sa_sigaction;
3414     } else {
3415       hand = actp-&gt;sa_handler;
3416     }
3417 
3418     if ((actp-&gt;sa_flags &amp; SA_RESETHAND) != 0) {
3419       actp-&gt;sa_handler = SIG_DFL;
3420     }
3421 
3422     // try to honor the signal mask
3423     sigset_t oset;
3424     pthread_sigmask(SIG_SETMASK, &amp;(actp-&gt;sa_mask), &amp;oset);
3425 
3426     // call into the chained handler
3427     if (siginfo_flag_set) {
3428       (*sa)(sig, siginfo, context);
3429     } else {
3430       (*hand)(sig);
3431     }
3432 
3433     // restore the signal mask
3434     pthread_sigmask(SIG_SETMASK, &amp;oset, 0);
3435   }
3436   // Tell jvm&#39;s signal handler the signal is taken care of.
3437   return true;
3438 }
3439 
3440 bool os::Solaris::chained_handler(int sig, siginfo_t* siginfo, void* context) {
3441   bool chained = false;
3442   // signal-chaining
3443   if (UseSignalChaining) {
3444     struct sigaction *actp = get_chained_signal_action(sig);
3445     if (actp != NULL) {
3446       chained = call_chained_handler(actp, sig, siginfo, context);
3447     }
3448   }
3449   return chained;
3450 }
3451 
3452 struct sigaction* os::Solaris::get_preinstalled_handler(int sig) {
3453   assert((chainedsigactions != (struct sigaction *)NULL) &amp;&amp;
3454          (preinstalled_sigs != (int *)NULL), &quot;signals not yet initialized&quot;);
3455   if (preinstalled_sigs[sig] != 0) {
3456     return &amp;chainedsigactions[sig];
3457   }
3458   return NULL;
3459 }
3460 
3461 void os::Solaris::save_preinstalled_handler(int sig,
3462                                             struct sigaction&amp; oldAct) {
3463   assert(sig &gt; 0 &amp;&amp; sig &lt;= Maxsignum, &quot;vm signal out of expected range&quot;);
3464   assert((chainedsigactions != (struct sigaction *)NULL) &amp;&amp;
3465          (preinstalled_sigs != (int *)NULL), &quot;signals not yet initialized&quot;);
3466   chainedsigactions[sig] = oldAct;
3467   preinstalled_sigs[sig] = 1;
3468 }
3469 
3470 void os::Solaris::set_signal_handler(int sig, bool set_installed,
3471                                      bool oktochain) {
3472   // Check for overwrite.
3473   struct sigaction oldAct;
3474   sigaction(sig, (struct sigaction*)NULL, &amp;oldAct);
3475   void* oldhand =
3476       oldAct.sa_sigaction ? CAST_FROM_FN_PTR(void*,  oldAct.sa_sigaction)
3477                           : CAST_FROM_FN_PTR(void*,  oldAct.sa_handler);
3478   if (oldhand != CAST_FROM_FN_PTR(void*, SIG_DFL) &amp;&amp;
3479       oldhand != CAST_FROM_FN_PTR(void*, SIG_IGN) &amp;&amp;
3480       oldhand != CAST_FROM_FN_PTR(void*, signalHandler)) {
3481     if (AllowUserSignalHandlers || !set_installed) {
3482       // Do not overwrite; user takes responsibility to forward to us.
3483       return;
3484     } else if (UseSignalChaining) {
3485       if (oktochain) {
3486         // save the old handler in jvm
3487         save_preinstalled_handler(sig, oldAct);
3488       } else {
3489         vm_exit_during_initialization(&quot;Signal chaining not allowed for VM interrupt signal.&quot;);
3490       }
3491       // libjsig also interposes the sigaction() call below and saves the
3492       // old sigaction on it own.
3493     } else {
3494       fatal(&quot;Encountered unexpected pre-existing sigaction handler &quot;
3495             &quot;%#lx for signal %d.&quot;, (long)oldhand, sig);
3496     }
3497   }
3498 
3499   struct sigaction sigAct;
3500   sigfillset(&amp;(sigAct.sa_mask));
3501   sigAct.sa_handler = SIG_DFL;
3502 
3503   sigAct.sa_sigaction = signalHandler;
3504   // Handle SIGSEGV on alternate signal stack if
3505   // not using stack banging
3506   if (!UseStackBanging &amp;&amp; sig == SIGSEGV) {
3507     sigAct.sa_flags = SA_SIGINFO | SA_RESTART | SA_ONSTACK;
3508   } else {
3509     sigAct.sa_flags = SA_SIGINFO | SA_RESTART;
3510   }
3511   os::Solaris::set_our_sigflags(sig, sigAct.sa_flags);
3512 
3513   sigaction(sig, &amp;sigAct, &amp;oldAct);
3514 
3515   void* oldhand2 = oldAct.sa_sigaction ? CAST_FROM_FN_PTR(void*, oldAct.sa_sigaction)
3516                                        : CAST_FROM_FN_PTR(void*, oldAct.sa_handler);
3517   assert(oldhand2 == oldhand, &quot;no concurrent signal handler installation&quot;);
3518 }
3519 
3520 
3521 #define DO_SIGNAL_CHECK(sig)                      \
3522   do {                                            \
3523     if (!sigismember(&amp;check_signal_done, sig)) {  \
3524       os::Solaris::check_signal_handler(sig);     \
3525     }                                             \
3526   } while (0)
3527 
3528 // This method is a periodic task to check for misbehaving JNI applications
3529 // under CheckJNI, we can add any periodic checks here
3530 
3531 void os::run_periodic_checks() {
3532   // A big source of grief is hijacking virt. addr 0x0 on Solaris,
3533   // thereby preventing a NULL checks.
3534   if (!check_addr0_done) check_addr0_done = check_addr0(tty);
3535 
3536   if (check_signals == false) return;
3537 
3538   // SEGV and BUS if overridden could potentially prevent
3539   // generation of hs*.log in the event of a crash, debugging
3540   // such a case can be very challenging, so we absolutely
3541   // check for the following for a good measure:
3542   DO_SIGNAL_CHECK(SIGSEGV);
3543   DO_SIGNAL_CHECK(SIGILL);
3544   DO_SIGNAL_CHECK(SIGFPE);
3545   DO_SIGNAL_CHECK(SIGBUS);
3546   DO_SIGNAL_CHECK(SIGPIPE);
3547   DO_SIGNAL_CHECK(SIGXFSZ);
3548   DO_SIGNAL_CHECK(ASYNC_SIGNAL);
3549 
3550   // ReduceSignalUsage allows the user to override these handlers
3551   // see comments at the very top and jvm_solaris.h
3552   if (!ReduceSignalUsage) {
3553     DO_SIGNAL_CHECK(SHUTDOWN1_SIGNAL);
3554     DO_SIGNAL_CHECK(SHUTDOWN2_SIGNAL);
3555     DO_SIGNAL_CHECK(SHUTDOWN3_SIGNAL);
3556     DO_SIGNAL_CHECK(BREAK_SIGNAL);
3557   }
3558 }
3559 
3560 typedef int (*os_sigaction_t)(int, const struct sigaction *, struct sigaction *);
3561 
3562 static os_sigaction_t os_sigaction = NULL;
3563 
3564 void os::Solaris::check_signal_handler(int sig) {
3565   char buf[O_BUFLEN];
3566   address jvmHandler = NULL;
3567 
3568   struct sigaction act;
3569   if (os_sigaction == NULL) {
3570     // only trust the default sigaction, in case it has been interposed
3571     os_sigaction = (os_sigaction_t)dlsym(RTLD_DEFAULT, &quot;sigaction&quot;);
3572     if (os_sigaction == NULL) return;
3573   }
3574 
3575   os_sigaction(sig, (struct sigaction*)NULL, &amp;act);
3576 
3577   address thisHandler = (act.sa_flags &amp; SA_SIGINFO)
3578     ? CAST_FROM_FN_PTR(address, act.sa_sigaction)
3579     : CAST_FROM_FN_PTR(address, act.sa_handler);
3580 
3581 
3582   switch (sig) {
3583   case SIGSEGV:
3584   case SIGBUS:
3585   case SIGFPE:
3586   case SIGPIPE:
3587   case SIGXFSZ:
3588   case SIGILL:
3589   case ASYNC_SIGNAL:
3590     jvmHandler = CAST_FROM_FN_PTR(address, signalHandler);
3591     break;
3592 
3593   case SHUTDOWN1_SIGNAL:
3594   case SHUTDOWN2_SIGNAL:
3595   case SHUTDOWN3_SIGNAL:
3596   case BREAK_SIGNAL:
3597     jvmHandler = (address)user_handler();
3598     break;
3599 
3600   default:
3601       return;
3602   }
3603 
3604   if (thisHandler != jvmHandler) {
3605     tty-&gt;print(&quot;Warning: %s handler &quot;, exception_name(sig, buf, O_BUFLEN));
3606     tty-&gt;print(&quot;expected:%s&quot;, get_signal_handler_name(jvmHandler, buf, O_BUFLEN));
3607     tty-&gt;print_cr(&quot;  found:%s&quot;, get_signal_handler_name(thisHandler, buf, O_BUFLEN));
3608     // No need to check this sig any longer
3609     sigaddset(&amp;check_signal_done, sig);
3610     // Running under non-interactive shell, SHUTDOWN2_SIGNAL will be reassigned SIG_IGN
3611     if (sig == SHUTDOWN2_SIGNAL &amp;&amp; !isatty(fileno(stdin))) {
3612       tty-&gt;print_cr(&quot;Running in non-interactive shell, %s handler is replaced by shell&quot;,
3613                     exception_name(sig, buf, O_BUFLEN));
3614     }
3615   } else if(os::Solaris::get_our_sigflags(sig) != 0 &amp;&amp; act.sa_flags != os::Solaris::get_our_sigflags(sig)) {
3616     tty-&gt;print(&quot;Warning: %s handler flags &quot;, exception_name(sig, buf, O_BUFLEN));
3617     tty-&gt;print(&quot;expected:&quot;);
3618     os::Posix::print_sa_flags(tty, os::Solaris::get_our_sigflags(sig));
3619     tty-&gt;cr();
3620     tty-&gt;print(&quot;  found:&quot;);
3621     os::Posix::print_sa_flags(tty, act.sa_flags);
3622     tty-&gt;cr();
3623     // No need to check this sig any longer
3624     sigaddset(&amp;check_signal_done, sig);
3625   }
3626 
3627   // Print all the signal handler state
3628   if (sigismember(&amp;check_signal_done, sig)) {
3629     print_signal_handlers(tty, buf, O_BUFLEN);
3630   }
3631 
3632 }
3633 
3634 void os::Solaris::install_signal_handlers() {
3635   signal_handlers_are_installed = true;
3636 
3637   // signal-chaining
3638   typedef void (*signal_setting_t)();
3639   signal_setting_t begin_signal_setting = NULL;
3640   signal_setting_t end_signal_setting = NULL;
3641   begin_signal_setting = CAST_TO_FN_PTR(signal_setting_t,
3642                                         dlsym(RTLD_DEFAULT, &quot;JVM_begin_signal_setting&quot;));
3643   if (begin_signal_setting != NULL) {
3644     end_signal_setting = CAST_TO_FN_PTR(signal_setting_t,
3645                                         dlsym(RTLD_DEFAULT, &quot;JVM_end_signal_setting&quot;));
3646     get_signal_action = CAST_TO_FN_PTR(get_signal_t,
3647                                        dlsym(RTLD_DEFAULT, &quot;JVM_get_signal_action&quot;));
3648     libjsig_is_loaded = true;
3649     assert(UseSignalChaining, &quot;should enable signal-chaining&quot;);
3650   }
3651   if (libjsig_is_loaded) {
3652     // Tell libjsig jvm is setting signal handlers
3653     (*begin_signal_setting)();
3654   }
3655 
3656   set_signal_handler(SIGSEGV, true, true);
3657   set_signal_handler(SIGPIPE, true, true);
3658   set_signal_handler(SIGXFSZ, true, true);
3659   set_signal_handler(SIGBUS, true, true);
3660   set_signal_handler(SIGILL, true, true);
3661   set_signal_handler(SIGFPE, true, true);
3662   set_signal_handler(ASYNC_SIGNAL, true, true);
3663 
3664   if (libjsig_is_loaded) {
3665     // Tell libjsig jvm finishes setting signal handlers
3666     (*end_signal_setting)();
3667   }
3668 
3669   // We don&#39;t activate signal checker if libjsig is in place, we trust ourselves
3670   // and if UserSignalHandler is installed all bets are off.
3671   // Log that signal checking is off only if -verbose:jni is specified.
3672   if (CheckJNICalls) {
3673     if (libjsig_is_loaded) {
3674       log_debug(jni, resolve)(&quot;Info: libjsig is activated, all active signal checking is disabled&quot;);
3675       check_signals = false;
3676     }
3677     if (AllowUserSignalHandlers) {
3678       log_debug(jni, resolve)(&quot;Info: AllowUserSignalHandlers is activated, all active signal checking is disabled&quot;);
3679       check_signals = false;
3680     }
3681   }
3682 }
3683 
3684 
3685 void report_error(const char* file_name, int line_no, const char* title,
3686                   const char* format, ...);
3687 
3688 // (Static) wrappers for the liblgrp API
3689 os::Solaris::lgrp_home_func_t os::Solaris::_lgrp_home;
3690 os::Solaris::lgrp_init_func_t os::Solaris::_lgrp_init;
3691 os::Solaris::lgrp_fini_func_t os::Solaris::_lgrp_fini;
3692 os::Solaris::lgrp_root_func_t os::Solaris::_lgrp_root;
3693 os::Solaris::lgrp_children_func_t os::Solaris::_lgrp_children;
3694 os::Solaris::lgrp_resources_func_t os::Solaris::_lgrp_resources;
3695 os::Solaris::lgrp_nlgrps_func_t os::Solaris::_lgrp_nlgrps;
3696 os::Solaris::lgrp_cookie_stale_func_t os::Solaris::_lgrp_cookie_stale;
3697 os::Solaris::lgrp_cookie_t os::Solaris::_lgrp_cookie = 0;
3698 
3699 static address resolve_symbol_lazy(const char* name) {
3700   address addr = (address) dlsym(RTLD_DEFAULT, name);
3701   if (addr == NULL) {
3702     // RTLD_DEFAULT was not defined on some early versions of 2.5.1
3703     addr = (address) dlsym(RTLD_NEXT, name);
3704   }
3705   return addr;
3706 }
3707 
3708 static address resolve_symbol(const char* name) {
3709   address addr = resolve_symbol_lazy(name);
3710   if (addr == NULL) {
3711     fatal(dlerror());
3712   }
3713   return addr;
3714 }
3715 
3716 void os::Solaris::libthread_init() {
3717   address func = (address)dlsym(RTLD_DEFAULT, &quot;_thr_suspend_allmutators&quot;);
3718 
3719   lwp_priocntl_init();
3720 
3721   // RTLD_DEFAULT was not defined on some early versions of 5.5.1
3722   if (func == NULL) {
3723     func = (address) dlsym(RTLD_NEXT, &quot;_thr_suspend_allmutators&quot;);
3724     // Guarantee that this VM is running on an new enough OS (5.6 or
3725     // later) that it will have a new enough libthread.so.
3726     guarantee(func != NULL, &quot;libthread.so is too old.&quot;);
3727   }
3728 
3729   int size;
3730   void (*handler_info_func)(address *, int *);
3731   handler_info_func = CAST_TO_FN_PTR(void (*)(address *, int *), resolve_symbol(&quot;thr_sighndlrinfo&quot;));
3732   handler_info_func(&amp;handler_start, &amp;size);
3733   handler_end = handler_start + size;
3734 }
3735 
3736 
3737 int_fnP_mutex_tP os::Solaris::_mutex_lock;
3738 int_fnP_mutex_tP os::Solaris::_mutex_trylock;
3739 int_fnP_mutex_tP os::Solaris::_mutex_unlock;
3740 int_fnP_mutex_tP_i_vP os::Solaris::_mutex_init;
3741 int_fnP_mutex_tP os::Solaris::_mutex_destroy;
3742 int os::Solaris::_mutex_scope = USYNC_THREAD;
3743 
3744 int_fnP_cond_tP_mutex_tP_timestruc_tP os::Solaris::_cond_timedwait;
3745 int_fnP_cond_tP_mutex_tP os::Solaris::_cond_wait;
3746 int_fnP_cond_tP os::Solaris::_cond_signal;
3747 int_fnP_cond_tP os::Solaris::_cond_broadcast;
3748 int_fnP_cond_tP_i_vP os::Solaris::_cond_init;
3749 int_fnP_cond_tP os::Solaris::_cond_destroy;
3750 int os::Solaris::_cond_scope = USYNC_THREAD;
3751 bool os::Solaris::_synchronization_initialized;
3752 
3753 void os::Solaris::synchronization_init() {
3754   if (UseLWPSynchronization) {
3755     os::Solaris::set_mutex_lock(CAST_TO_FN_PTR(int_fnP_mutex_tP, resolve_symbol(&quot;_lwp_mutex_lock&quot;)));
3756     os::Solaris::set_mutex_trylock(CAST_TO_FN_PTR(int_fnP_mutex_tP, resolve_symbol(&quot;_lwp_mutex_trylock&quot;)));
3757     os::Solaris::set_mutex_unlock(CAST_TO_FN_PTR(int_fnP_mutex_tP, resolve_symbol(&quot;_lwp_mutex_unlock&quot;)));
3758     os::Solaris::set_mutex_init(lwp_mutex_init);
3759     os::Solaris::set_mutex_destroy(lwp_mutex_destroy);
3760     os::Solaris::set_mutex_scope(USYNC_THREAD);
3761 
3762     os::Solaris::set_cond_timedwait(CAST_TO_FN_PTR(int_fnP_cond_tP_mutex_tP_timestruc_tP, resolve_symbol(&quot;_lwp_cond_timedwait&quot;)));
3763     os::Solaris::set_cond_wait(CAST_TO_FN_PTR(int_fnP_cond_tP_mutex_tP, resolve_symbol(&quot;_lwp_cond_wait&quot;)));
3764     os::Solaris::set_cond_signal(CAST_TO_FN_PTR(int_fnP_cond_tP, resolve_symbol(&quot;_lwp_cond_signal&quot;)));
3765     os::Solaris::set_cond_broadcast(CAST_TO_FN_PTR(int_fnP_cond_tP, resolve_symbol(&quot;_lwp_cond_broadcast&quot;)));
3766     os::Solaris::set_cond_init(lwp_cond_init);
3767     os::Solaris::set_cond_destroy(lwp_cond_destroy);
3768     os::Solaris::set_cond_scope(USYNC_THREAD);
3769   } else {
3770     os::Solaris::set_mutex_scope(USYNC_THREAD);
3771     os::Solaris::set_cond_scope(USYNC_THREAD);
3772 
3773     if (UsePthreads) {
3774       os::Solaris::set_mutex_lock(CAST_TO_FN_PTR(int_fnP_mutex_tP, resolve_symbol(&quot;pthread_mutex_lock&quot;)));
3775       os::Solaris::set_mutex_trylock(CAST_TO_FN_PTR(int_fnP_mutex_tP, resolve_symbol(&quot;pthread_mutex_trylock&quot;)));
3776       os::Solaris::set_mutex_unlock(CAST_TO_FN_PTR(int_fnP_mutex_tP, resolve_symbol(&quot;pthread_mutex_unlock&quot;)));
3777       os::Solaris::set_mutex_init(pthread_mutex_default_init);
3778       os::Solaris::set_mutex_destroy(CAST_TO_FN_PTR(int_fnP_mutex_tP, resolve_symbol(&quot;pthread_mutex_destroy&quot;)));
3779 
3780       os::Solaris::set_cond_timedwait(CAST_TO_FN_PTR(int_fnP_cond_tP_mutex_tP_timestruc_tP, resolve_symbol(&quot;pthread_cond_timedwait&quot;)));
3781       os::Solaris::set_cond_wait(CAST_TO_FN_PTR(int_fnP_cond_tP_mutex_tP, resolve_symbol(&quot;pthread_cond_wait&quot;)));
3782       os::Solaris::set_cond_signal(CAST_TO_FN_PTR(int_fnP_cond_tP, resolve_symbol(&quot;pthread_cond_signal&quot;)));
3783       os::Solaris::set_cond_broadcast(CAST_TO_FN_PTR(int_fnP_cond_tP, resolve_symbol(&quot;pthread_cond_broadcast&quot;)));
3784       os::Solaris::set_cond_init(pthread_cond_default_init);
3785       os::Solaris::set_cond_destroy(CAST_TO_FN_PTR(int_fnP_cond_tP, resolve_symbol(&quot;pthread_cond_destroy&quot;)));
3786     } else {
3787       os::Solaris::set_mutex_lock(CAST_TO_FN_PTR(int_fnP_mutex_tP, resolve_symbol(&quot;mutex_lock&quot;)));
3788       os::Solaris::set_mutex_trylock(CAST_TO_FN_PTR(int_fnP_mutex_tP, resolve_symbol(&quot;mutex_trylock&quot;)));
3789       os::Solaris::set_mutex_unlock(CAST_TO_FN_PTR(int_fnP_mutex_tP, resolve_symbol(&quot;mutex_unlock&quot;)));
3790       os::Solaris::set_mutex_init(::mutex_init);
3791       os::Solaris::set_mutex_destroy(::mutex_destroy);
3792 
3793       os::Solaris::set_cond_timedwait(CAST_TO_FN_PTR(int_fnP_cond_tP_mutex_tP_timestruc_tP, resolve_symbol(&quot;cond_timedwait&quot;)));
3794       os::Solaris::set_cond_wait(CAST_TO_FN_PTR(int_fnP_cond_tP_mutex_tP, resolve_symbol(&quot;cond_wait&quot;)));
3795       os::Solaris::set_cond_signal(CAST_TO_FN_PTR(int_fnP_cond_tP, resolve_symbol(&quot;cond_signal&quot;)));
3796       os::Solaris::set_cond_broadcast(CAST_TO_FN_PTR(int_fnP_cond_tP, resolve_symbol(&quot;cond_broadcast&quot;)));
3797       os::Solaris::set_cond_init(::cond_init);
3798       os::Solaris::set_cond_destroy(::cond_destroy);
3799     }
3800   }
3801   _synchronization_initialized = true;
3802 }
3803 
3804 bool os::Solaris::liblgrp_init() {
3805   void *handle = dlopen(&quot;liblgrp.so.1&quot;, RTLD_LAZY);
3806   if (handle != NULL) {
3807     os::Solaris::set_lgrp_home(CAST_TO_FN_PTR(lgrp_home_func_t, dlsym(handle, &quot;lgrp_home&quot;)));
3808     os::Solaris::set_lgrp_init(CAST_TO_FN_PTR(lgrp_init_func_t, dlsym(handle, &quot;lgrp_init&quot;)));
3809     os::Solaris::set_lgrp_fini(CAST_TO_FN_PTR(lgrp_fini_func_t, dlsym(handle, &quot;lgrp_fini&quot;)));
3810     os::Solaris::set_lgrp_root(CAST_TO_FN_PTR(lgrp_root_func_t, dlsym(handle, &quot;lgrp_root&quot;)));
3811     os::Solaris::set_lgrp_children(CAST_TO_FN_PTR(lgrp_children_func_t, dlsym(handle, &quot;lgrp_children&quot;)));
3812     os::Solaris::set_lgrp_resources(CAST_TO_FN_PTR(lgrp_resources_func_t, dlsym(handle, &quot;lgrp_resources&quot;)));
3813     os::Solaris::set_lgrp_nlgrps(CAST_TO_FN_PTR(lgrp_nlgrps_func_t, dlsym(handle, &quot;lgrp_nlgrps&quot;)));
3814     os::Solaris::set_lgrp_cookie_stale(CAST_TO_FN_PTR(lgrp_cookie_stale_func_t,
3815                                                       dlsym(handle, &quot;lgrp_cookie_stale&quot;)));
3816 
3817     lgrp_cookie_t c = lgrp_init(LGRP_VIEW_CALLER);
3818     set_lgrp_cookie(c);
3819     return true;
3820   }
3821   return false;
3822 }
3823 
3824 // int pset_getloadavg(psetid_t pset, double loadavg[], int nelem);
3825 typedef long (*pset_getloadavg_type)(psetid_t pset, double loadavg[], int nelem);
3826 static pset_getloadavg_type pset_getloadavg_ptr = NULL;
3827 
3828 void init_pset_getloadavg_ptr(void) {
3829   pset_getloadavg_ptr =
3830     (pset_getloadavg_type)dlsym(RTLD_DEFAULT, &quot;pset_getloadavg&quot;);
3831   if (pset_getloadavg_ptr == NULL) {
3832     log_warning(os)(&quot;pset_getloadavg function not found&quot;);
3833   }
3834 }
3835 
3836 int os::Solaris::_dev_zero_fd = -1;
3837 
3838 // this is called _before_ the global arguments have been parsed
3839 void os::init(void) {
3840   _initial_pid = getpid();
3841 
3842   max_hrtime = first_hrtime = gethrtime();
3843 
3844   init_random(1234567);
3845 
3846   page_size = sysconf(_SC_PAGESIZE);
3847   if (page_size == -1) {
3848     fatal(&quot;os_solaris.cpp: os::init: sysconf failed (%s)&quot;, os::strerror(errno));
3849   }
3850   init_page_sizes((size_t) page_size);
3851 
3852   Solaris::initialize_system_info();
3853 
3854   int fd = ::open(&quot;/dev/zero&quot;, O_RDWR);
3855   if (fd &lt; 0) {
3856     fatal(&quot;os::init: cannot open /dev/zero (%s)&quot;, os::strerror(errno));
3857   } else {
3858     Solaris::set_dev_zero_fd(fd);
3859 
3860     // Close on exec, child won&#39;t inherit.
3861     fcntl(fd, F_SETFD, FD_CLOEXEC);
3862   }
3863 
3864   clock_tics_per_sec = CLK_TCK;
3865 
3866   // check if dladdr1() exists; dladdr1 can provide more information than
3867   // dladdr for os::dll_address_to_function_name. It comes with SunOS 5.9
3868   // and is available on linker patches for 5.7 and 5.8.
3869   // libdl.so must have been loaded, this call is just an entry lookup
3870   void * hdl = dlopen(&quot;libdl.so&quot;, RTLD_NOW);
3871   if (hdl) {
3872     dladdr1_func = CAST_TO_FN_PTR(dladdr1_func_type, dlsym(hdl, &quot;dladdr1&quot;));
3873   }
3874 
3875   // main_thread points to the thread that created/loaded the JVM.
3876   main_thread = thr_self();
3877 
3878   // dynamic lookup of functions that may not be available in our lowest
3879   // supported Solaris release
3880   void * handle = dlopen(&quot;libc.so.1&quot;, RTLD_LAZY);
3881   if (handle != NULL) {
3882     Solaris::_pthread_setname_np =  // from 11.3
3883         (Solaris::pthread_setname_np_func_t)dlsym(handle, &quot;pthread_setname_np&quot;);
3884   }
3885 
3886   // Shared Posix initialization
3887   os::Posix::init();
3888 }
3889 
3890 // To install functions for atexit system call
3891 extern &quot;C&quot; {
3892   static void perfMemory_exit_helper() {
3893     perfMemory_exit();
3894   }
3895 }
3896 
3897 // this is called _after_ the global arguments have been parsed
3898 jint os::init_2(void) {
3899   // try to enable extended file IO ASAP, see 6431278
3900   os::Solaris::try_enable_extended_io();
3901 
3902   // Check and sets minimum stack sizes against command line options
3903   if (Posix::set_minimum_stack_sizes() == JNI_ERR) {
3904     return JNI_ERR;
3905   }
3906 
3907   Solaris::libthread_init();
3908 
3909   if (UseNUMA) {
3910     if (!Solaris::liblgrp_init()) {
3911       FLAG_SET_ERGO(UseNUMA, false);
3912     } else {
3913       size_t lgrp_limit = os::numa_get_groups_num();
3914       int *lgrp_ids = NEW_C_HEAP_ARRAY(int, lgrp_limit, mtInternal);
3915       size_t lgrp_num = os::numa_get_leaf_groups(lgrp_ids, lgrp_limit);
3916       FREE_C_HEAP_ARRAY(int, lgrp_ids);
3917       if (lgrp_num &lt; 2) {
3918         // There&#39;s only one locality group, disable NUMA unless
3919         // user explicilty forces NUMA optimizations on single-node/UMA systems
3920         UseNUMA = ForceNUMA;
3921       }
3922     }
3923   }
3924 
3925   // When NUMA requested, not-NUMA-aware allocations default to interleaving.
3926   if (UseNUMA &amp;&amp; !UseNUMAInterleaving) {
3927     FLAG_SET_ERGO_IF_DEFAULT(UseNUMAInterleaving, true);
3928   }
3929 
3930   Solaris::signal_sets_init();
3931   Solaris::init_signal_mem();
3932   Solaris::install_signal_handlers();
3933   // Initialize data for jdk.internal.misc.Signal
3934   if (!ReduceSignalUsage) {
3935     jdk_misc_signal_init();
3936   }
3937 
3938   // initialize synchronization primitives to use either thread or
3939   // lwp synchronization (controlled by UseLWPSynchronization)
3940   Solaris::synchronization_init();
3941   DEBUG_ONLY(os::set_mutex_init_done();)
3942 
3943   if (MaxFDLimit) {
3944     // set the number of file descriptors to max. print out error
3945     // if getrlimit/setrlimit fails but continue regardless.
3946     struct rlimit nbr_files;
3947     int status = getrlimit(RLIMIT_NOFILE, &amp;nbr_files);
3948     if (status != 0) {
3949       log_info(os)(&quot;os::init_2 getrlimit failed: %s&quot;, os::strerror(errno));
3950     } else {
3951       nbr_files.rlim_cur = nbr_files.rlim_max;
3952       status = setrlimit(RLIMIT_NOFILE, &amp;nbr_files);
3953       if (status != 0) {
3954         log_info(os)(&quot;os::init_2 setrlimit failed: %s&quot;, os::strerror(errno));
3955       }
3956     }
3957   }
3958 
3959   // Calculate theoretical max. size of Threads to guard gainst
3960   // artifical out-of-memory situations, where all available address-
3961   // space has been reserved by thread stacks. Default stack size is 1Mb.
3962   size_t pre_thread_stack_size = (JavaThread::stack_size_at_create()) ?
3963     JavaThread::stack_size_at_create() : (1*K*K);
3964   assert(pre_thread_stack_size != 0, &quot;Must have a stack&quot;);
3965   // Solaris has a maximum of 4Gb of user programs. Calculate the thread limit when
3966   // we should start doing Virtual Memory banging. Currently when the threads will
3967   // have used all but 200Mb of space.
3968   size_t max_address_space = ((unsigned int)4 * K * K * K) - (200 * K * K);
3969   Solaris::_os_thread_limit = max_address_space / pre_thread_stack_size;
3970 
3971   // at-exit methods are called in the reverse order of their registration.
3972   // In Solaris 7 and earlier, atexit functions are called on return from
3973   // main or as a result of a call to exit(3C). There can be only 32 of
3974   // these functions registered and atexit() does not set errno. In Solaris
3975   // 8 and later, there is no limit to the number of functions registered
3976   // and atexit() sets errno. In addition, in Solaris 8 and later, atexit
3977   // functions are called upon dlclose(3DL) in addition to return from main
3978   // and exit(3C).
3979 
3980   if (PerfAllowAtExitRegistration) {
3981     // only register atexit functions if PerfAllowAtExitRegistration is set.
3982     // atexit functions can be delayed until process exit time, which
3983     // can be problematic for embedded VM situations. Embedded VMs should
3984     // call DestroyJavaVM() to assure that VM resources are released.
3985 
3986     // note: perfMemory_exit_helper atexit function may be removed in
3987     // the future if the appropriate cleanup code can be added to the
3988     // VM_Exit VMOperation&#39;s doit method.
3989     if (atexit(perfMemory_exit_helper) != 0) {
3990       warning(&quot;os::init2 atexit(perfMemory_exit_helper) failed&quot;);
3991     }
3992   }
3993 
3994   // Init pset_loadavg function pointer
3995   init_pset_getloadavg_ptr();
3996 
3997   // Shared Posix initialization
3998   os::Posix::init_2();
3999 
4000   return JNI_OK;
4001 }
4002 
4003 // Is a (classpath) directory empty?
4004 bool os::dir_is_empty(const char* path) {
4005   DIR *dir = NULL;
4006   struct dirent *ptr;
4007 
4008   dir = opendir(path);
4009   if (dir == NULL) return true;
4010 
4011   // Scan the directory
4012   bool result = true;
4013   while (result &amp;&amp; (ptr = readdir(dir)) != NULL) {
4014     if (strcmp(ptr-&gt;d_name, &quot;.&quot;) != 0 &amp;&amp; strcmp(ptr-&gt;d_name, &quot;..&quot;) != 0) {
4015       result = false;
4016     }
4017   }
4018   closedir(dir);
4019   return result;
4020 }
4021 
4022 // This code originates from JDK&#39;s sysOpen and open64_w
4023 // from src/solaris/hpi/src/system_md.c
4024 
4025 int os::open(const char *path, int oflag, int mode) {
4026   if (strlen(path) &gt; MAX_PATH - 1) {
4027     errno = ENAMETOOLONG;
4028     return -1;
4029   }
4030   int fd;
4031 
4032   fd = ::open64(path, oflag, mode);
4033   if (fd == -1) return -1;
4034 
4035   // If the open succeeded, the file might still be a directory
4036   {
4037     struct stat64 buf64;
4038     int ret = ::fstat64(fd, &amp;buf64);
4039     int st_mode = buf64.st_mode;
4040 
4041     if (ret != -1) {
4042       if ((st_mode &amp; S_IFMT) == S_IFDIR) {
4043         errno = EISDIR;
4044         ::close(fd);
4045         return -1;
4046       }
4047     } else {
4048       ::close(fd);
4049       return -1;
4050     }
4051   }
4052 
4053   // 32-bit Solaris systems suffer from:
4054   //
4055   // - an historical default soft limit of 256 per-process file
4056   //   descriptors that is too low for many Java programs.
4057   //
4058   // - a design flaw where file descriptors created using stdio
4059   //   fopen must be less than 256, _even_ when the first limit above
4060   //   has been raised.  This can cause calls to fopen (but not calls to
4061   //   open, for example) to fail mysteriously, perhaps in 3rd party
4062   //   native code (although the JDK itself uses fopen).  One can hardly
4063   //   criticize them for using this most standard of all functions.
4064   //
4065   // We attempt to make everything work anyways by:
4066   //
4067   // - raising the soft limit on per-process file descriptors beyond
4068   //   256
4069   //
4070   // - As of Solaris 10u4, we can request that Solaris raise the 256
4071   //   stdio fopen limit by calling function enable_extended_FILE_stdio.
4072   //   This is done in init_2 and recorded in enabled_extended_FILE_stdio
4073   //
4074   // - If we are stuck on an old (pre 10u4) Solaris system, we can
4075   //   workaround the bug by remapping non-stdio file descriptors below
4076   //   256 to ones beyond 256, which is done below.
4077   //
4078   // See:
4079   // 1085341: 32-bit stdio routines should support file descriptors &gt;255
4080   // 6533291: Work around 32-bit Solaris stdio limit of 256 open files
4081   // 6431278: Netbeans crash on 32 bit Solaris: need to call
4082   //          enable_extended_FILE_stdio() in VM initialisation
4083   // Giri Mandalika&#39;s blog
4084   // http://technopark02.blogspot.com/2005_05_01_archive.html
4085   //
4086 #ifndef  _LP64
4087   if ((!enabled_extended_FILE_stdio) &amp;&amp; fd &lt; 256) {
4088     int newfd = ::fcntl(fd, F_DUPFD, 256);
4089     if (newfd != -1) {
4090       ::close(fd);
4091       fd = newfd;
4092     }
4093   }
4094 #endif // 32-bit Solaris
4095 
4096   // All file descriptors that are opened in the JVM and not
4097   // specifically destined for a subprocess should have the
4098   // close-on-exec flag set.  If we don&#39;t set it, then careless 3rd
4099   // party native code might fork and exec without closing all
4100   // appropriate file descriptors (e.g. as we do in closeDescriptors in
4101   // UNIXProcess.c), and this in turn might:
4102   //
4103   // - cause end-of-file to fail to be detected on some file
4104   //   descriptors, resulting in mysterious hangs, or
4105   //
4106   // - might cause an fopen in the subprocess to fail on a system
4107   //   suffering from bug 1085341.
4108   //
4109   // (Yes, the default setting of the close-on-exec flag is a Unix
4110   // design flaw)
4111   //
4112   // See:
4113   // 1085341: 32-bit stdio routines should support file descriptors &gt;255
4114   // 4843136: (process) pipe file descriptor from Runtime.exec not being closed
4115   // 6339493: (process) Runtime.exec does not close all file descriptors on Solaris 9
4116   //
4117 #ifdef FD_CLOEXEC
4118   {
4119     int flags = ::fcntl(fd, F_GETFD);
4120     if (flags != -1) {
4121       ::fcntl(fd, F_SETFD, flags | FD_CLOEXEC);
4122     }
4123   }
4124 #endif
4125 
4126   return fd;
4127 }
4128 
4129 // create binary file, rewriting existing file if required
4130 int os::create_binary_file(const char* path, bool rewrite_existing) {
4131   int oflags = O_WRONLY | O_CREAT;
4132   if (!rewrite_existing) {
4133     oflags |= O_EXCL;
4134   }
4135   return ::open64(path, oflags, S_IREAD | S_IWRITE);
4136 }
4137 
4138 // return current position of file pointer
4139 jlong os::current_file_offset(int fd) {
4140   return (jlong)::lseek64(fd, (off64_t)0, SEEK_CUR);
4141 }
4142 
4143 // move file pointer to the specified offset
4144 jlong os::seek_to_file_offset(int fd, jlong offset) {
4145   return (jlong)::lseek64(fd, (off64_t)offset, SEEK_SET);
4146 }
4147 
4148 jlong os::lseek(int fd, jlong offset, int whence) {
4149   return (jlong) ::lseek64(fd, offset, whence);
4150 }
4151 
4152 int os::ftruncate(int fd, jlong length) {
4153   return ::ftruncate64(fd, length);
4154 }
4155 
4156 int os::fsync(int fd)  {
4157   RESTARTABLE_RETURN_INT(::fsync(fd));
4158 }
4159 
4160 int os::available(int fd, jlong *bytes) {
4161   assert(((JavaThread*)Thread::current())-&gt;thread_state() == _thread_in_native,
4162          &quot;Assumed _thread_in_native&quot;);
4163   jlong cur, end;
4164   int mode;
4165   struct stat64 buf64;
4166 
4167   if (::fstat64(fd, &amp;buf64) &gt;= 0) {
4168     mode = buf64.st_mode;
4169     if (S_ISCHR(mode) || S_ISFIFO(mode) || S_ISSOCK(mode)) {
4170       int n,ioctl_return;
4171 
4172       RESTARTABLE(::ioctl(fd, FIONREAD, &amp;n), ioctl_return);
4173       if (ioctl_return&gt;= 0) {
4174         *bytes = n;
4175         return 1;
4176       }
4177     }
4178   }
4179   if ((cur = ::lseek64(fd, 0L, SEEK_CUR)) == -1) {
4180     return 0;
4181   } else if ((end = ::lseek64(fd, 0L, SEEK_END)) == -1) {
4182     return 0;
4183   } else if (::lseek64(fd, cur, SEEK_SET) == -1) {
4184     return 0;
4185   }
4186   *bytes = end - cur;
4187   return 1;
4188 }
4189 
4190 // Map a block of memory.
4191 char* os::pd_map_memory(int fd, const char* file_name, size_t file_offset,
4192                         char *addr, size_t bytes, bool read_only,
4193                         bool allow_exec) {
4194   int prot;
4195   int flags;
4196 
4197   if (read_only) {
4198     prot = PROT_READ;
4199     flags = MAP_SHARED;
4200   } else {
4201     prot = PROT_READ | PROT_WRITE;
4202     flags = MAP_PRIVATE;
4203   }
4204 
4205   if (allow_exec) {
4206     prot |= PROT_EXEC;
4207   }
4208 
4209   if (addr != NULL) {
4210     flags |= MAP_FIXED;
4211   }
4212 
4213   char* mapped_address = (char*)mmap(addr, (size_t)bytes, prot, flags,
4214                                      fd, file_offset);
4215   if (mapped_address == MAP_FAILED) {
4216     return NULL;
4217   }
4218   return mapped_address;
4219 }
4220 
4221 
4222 // Remap a block of memory.
4223 char* os::pd_remap_memory(int fd, const char* file_name, size_t file_offset,
4224                           char *addr, size_t bytes, bool read_only,
4225                           bool allow_exec) {
4226   // same as map_memory() on this OS
4227   return os::map_memory(fd, file_name, file_offset, addr, bytes, read_only,
4228                         allow_exec);
4229 }
4230 
4231 
4232 // Unmap a block of memory.
4233 bool os::pd_unmap_memory(char* addr, size_t bytes) {
4234   return munmap(addr, bytes) == 0;
4235 }
4236 
4237 void os::pause() {
4238   char filename[MAX_PATH];
4239   if (PauseAtStartupFile &amp;&amp; PauseAtStartupFile[0]) {
4240     jio_snprintf(filename, MAX_PATH, &quot;%s&quot;, PauseAtStartupFile);
4241   } else {
4242     jio_snprintf(filename, MAX_PATH, &quot;./vm.paused.%d&quot;, current_process_id());
4243   }
4244 
4245   int fd = ::open(filename, O_WRONLY | O_CREAT | O_TRUNC, 0666);
4246   if (fd != -1) {
4247     struct stat buf;
4248     ::close(fd);
4249     while (::stat(filename, &amp;buf) == 0) {
4250       (void)::poll(NULL, 0, 100);
4251     }
4252   } else {
4253     jio_fprintf(stderr,
4254                 &quot;Could not open pause file &#39;%s&#39;, continuing immediately.\n&quot;, filename);
4255   }
4256 }
4257 
4258 #ifndef PRODUCT
4259 #ifdef INTERPOSE_ON_SYSTEM_SYNCH_FUNCTIONS
4260 // Turn this on if you need to trace synch operations.
4261 // Set RECORD_SYNCH_LIMIT to a large-enough value,
4262 // and call record_synch_enable and record_synch_disable
4263 // around the computation of interest.
4264 
4265 void record_synch(char* name, bool returning);  // defined below
4266 
4267 class RecordSynch {
4268   char* _name;
4269  public:
4270   RecordSynch(char* name) :_name(name) { record_synch(_name, false); }
4271   ~RecordSynch()                       { record_synch(_name, true); }
4272 };
4273 
4274 #define CHECK_SYNCH_OP(ret, name, params, args, inner)          \
4275 extern &quot;C&quot; ret name params {                                    \
4276   typedef ret name##_t params;                                  \
4277   static name##_t* implem = NULL;                               \
4278   static int callcount = 0;                                     \
4279   if (implem == NULL) {                                         \
4280     implem = (name##_t*) dlsym(RTLD_NEXT, #name);               \
4281     if (implem == NULL)  fatal(dlerror());                      \
4282   }                                                             \
4283   ++callcount;                                                  \
4284   RecordSynch _rs(#name);                                       \
4285   inner;                                                        \
4286   return implem args;                                           \
4287 }
4288 // in dbx, examine callcounts this way:
4289 // for n in $(eval whereis callcount | awk &#39;{print $2}&#39;); do print $n; done
4290 
4291 #define CHECK_POINTER_OK(p) \
4292   (!Universe::is_fully_initialized() || !Universe::is_reserved_heap((oop)(p)))
4293 #define CHECK_MU \
4294   if (!CHECK_POINTER_OK(mu)) fatal(&quot;Mutex must be in C heap only.&quot;);
4295 #define CHECK_CV \
4296   if (!CHECK_POINTER_OK(cv)) fatal(&quot;Condvar must be in C heap only.&quot;);
4297 #define CHECK_P(p) \
4298   if (!CHECK_POINTER_OK(p))  fatal(false,  &quot;Pointer must be in C heap only.&quot;);
4299 
4300 #define CHECK_MUTEX(mutex_op) \
4301   CHECK_SYNCH_OP(int, mutex_op, (mutex_t *mu), (mu), CHECK_MU);
4302 
4303 CHECK_MUTEX(   mutex_lock)
4304 CHECK_MUTEX(  _mutex_lock)
4305 CHECK_MUTEX( mutex_unlock)
4306 CHECK_MUTEX(_mutex_unlock)
4307 CHECK_MUTEX( mutex_trylock)
4308 CHECK_MUTEX(_mutex_trylock)
4309 
4310 #define CHECK_COND(cond_op) \
4311   CHECK_SYNCH_OP(int, cond_op, (cond_t *cv, mutex_t *mu), (cv, mu), CHECK_MU; CHECK_CV);
4312 
4313 CHECK_COND( cond_wait);
4314 CHECK_COND(_cond_wait);
4315 CHECK_COND(_cond_wait_cancel);
4316 
4317 #define CHECK_COND2(cond_op) \
4318   CHECK_SYNCH_OP(int, cond_op, (cond_t *cv, mutex_t *mu, timestruc_t* ts), (cv, mu, ts), CHECK_MU; CHECK_CV);
4319 
4320 CHECK_COND2( cond_timedwait);
4321 CHECK_COND2(_cond_timedwait);
4322 CHECK_COND2(_cond_timedwait_cancel);
4323 
4324 // do the _lwp_* versions too
4325 #define mutex_t lwp_mutex_t
4326 #define cond_t  lwp_cond_t
4327 CHECK_MUTEX(  _lwp_mutex_lock)
4328 CHECK_MUTEX(  _lwp_mutex_unlock)
4329 CHECK_MUTEX(  _lwp_mutex_trylock)
4330 CHECK_MUTEX( __lwp_mutex_lock)
4331 CHECK_MUTEX( __lwp_mutex_unlock)
4332 CHECK_MUTEX( __lwp_mutex_trylock)
4333 CHECK_MUTEX(___lwp_mutex_lock)
4334 CHECK_MUTEX(___lwp_mutex_unlock)
4335 
4336 CHECK_COND(  _lwp_cond_wait);
4337 CHECK_COND( __lwp_cond_wait);
4338 CHECK_COND(___lwp_cond_wait);
4339 
4340 CHECK_COND2(  _lwp_cond_timedwait);
4341 CHECK_COND2( __lwp_cond_timedwait);
4342 #undef mutex_t
4343 #undef cond_t
4344 
4345 CHECK_SYNCH_OP(int, _lwp_suspend2,       (int lwp, int *n), (lwp, n), 0);
4346 CHECK_SYNCH_OP(int,__lwp_suspend2,       (int lwp, int *n), (lwp, n), 0);
4347 CHECK_SYNCH_OP(int, _lwp_kill,           (int lwp, int n),  (lwp, n), 0);
4348 CHECK_SYNCH_OP(int,__lwp_kill,           (int lwp, int n),  (lwp, n), 0);
4349 CHECK_SYNCH_OP(int, _lwp_sema_wait,      (lwp_sema_t* p),   (p),  CHECK_P(p));
4350 CHECK_SYNCH_OP(int,__lwp_sema_wait,      (lwp_sema_t* p),   (p),  CHECK_P(p));
4351 CHECK_SYNCH_OP(int, _lwp_cond_broadcast, (lwp_cond_t* cv),  (cv), CHECK_CV);
4352 CHECK_SYNCH_OP(int,__lwp_cond_broadcast, (lwp_cond_t* cv),  (cv), CHECK_CV);
4353 
4354 
4355 // recording machinery:
4356 
4357 enum { RECORD_SYNCH_LIMIT = 200 };
4358 char* record_synch_name[RECORD_SYNCH_LIMIT];
4359 void* record_synch_arg0ptr[RECORD_SYNCH_LIMIT];
4360 bool record_synch_returning[RECORD_SYNCH_LIMIT];
4361 thread_t record_synch_thread[RECORD_SYNCH_LIMIT];
4362 int record_synch_count = 0;
4363 bool record_synch_enabled = false;
4364 
4365 // in dbx, examine recorded data this way:
4366 // for n in name arg0ptr returning thread; do print record_synch_$n[0..record_synch_count-1]; done
4367 
4368 void record_synch(char* name, bool returning) {
4369   if (record_synch_enabled) {
4370     if (record_synch_count &lt; RECORD_SYNCH_LIMIT) {
4371       record_synch_name[record_synch_count] = name;
4372       record_synch_returning[record_synch_count] = returning;
4373       record_synch_thread[record_synch_count] = thr_self();
4374       record_synch_arg0ptr[record_synch_count] = &amp;name;
4375       record_synch_count++;
4376     }
4377     // put more checking code here:
4378     // ...
4379   }
4380 }
4381 
4382 void record_synch_enable() {
4383   // start collecting trace data, if not already doing so
4384   if (!record_synch_enabled)  record_synch_count = 0;
4385   record_synch_enabled = true;
4386 }
4387 
4388 void record_synch_disable() {
4389   // stop collecting trace data
4390   record_synch_enabled = false;
4391 }
4392 
4393 #endif // INTERPOSE_ON_SYSTEM_SYNCH_FUNCTIONS
4394 #endif // PRODUCT
4395 
4396 const intptr_t thr_time_off  = (intptr_t)(&amp;((prusage_t *)(NULL))-&gt;pr_utime);
4397 const intptr_t thr_time_size = (intptr_t)(&amp;((prusage_t *)(NULL))-&gt;pr_ttime) -
4398                                (intptr_t)(&amp;((prusage_t *)(NULL))-&gt;pr_utime);
4399 
4400 
4401 // JVMTI &amp; JVM monitoring and management support
4402 // The thread_cpu_time() and current_thread_cpu_time() are only
4403 // supported if is_thread_cpu_time_supported() returns true.
4404 // They are not supported on Solaris T1.
4405 
4406 // current_thread_cpu_time(bool) and thread_cpu_time(Thread*, bool)
4407 // are used by JVM M&amp;M and JVMTI to get user+sys or user CPU time
4408 // of a thread.
4409 //
4410 // current_thread_cpu_time() and thread_cpu_time(Thread *)
4411 // returns the fast estimate available on the platform.
4412 
4413 // hrtime_t gethrvtime() return value includes
4414 // user time but does not include system time
4415 jlong os::current_thread_cpu_time() {
4416   return (jlong) gethrvtime();
4417 }
4418 
4419 jlong os::thread_cpu_time(Thread *thread) {
4420   // return user level CPU time only to be consistent with
4421   // what current_thread_cpu_time returns.
4422   // thread_cpu_time_info() must be changed if this changes
4423   return os::thread_cpu_time(thread, false /* user time only */);
4424 }
4425 
4426 jlong os::current_thread_cpu_time(bool user_sys_cpu_time) {
4427   if (user_sys_cpu_time) {
4428     return os::thread_cpu_time(Thread::current(), user_sys_cpu_time);
4429   } else {
4430     return os::current_thread_cpu_time();
4431   }
4432 }
4433 
4434 jlong os::thread_cpu_time(Thread *thread, bool user_sys_cpu_time) {
4435   char proc_name[64];
4436   int count;
4437   prusage_t prusage;
4438   jlong lwp_time;
4439   int fd;
4440 
4441   sprintf(proc_name, &quot;/proc/%d/lwp/%d/lwpusage&quot;,
4442           getpid(),
4443           thread-&gt;osthread()-&gt;lwp_id());
4444   fd = ::open(proc_name, O_RDONLY);
4445   if (fd == -1) return -1;
4446 
4447   do {
4448     count = ::pread(fd,
4449                     (void *)&amp;prusage.pr_utime,
4450                     thr_time_size,
4451                     thr_time_off);
4452   } while (count &lt; 0 &amp;&amp; errno == EINTR);
4453   ::close(fd);
4454   if (count &lt; 0) return -1;
4455 
4456   if (user_sys_cpu_time) {
4457     // user + system CPU time
4458     lwp_time = (((jlong)prusage.pr_stime.tv_sec +
4459                  (jlong)prusage.pr_utime.tv_sec) * (jlong)1000000000) +
4460                  (jlong)prusage.pr_stime.tv_nsec +
4461                  (jlong)prusage.pr_utime.tv_nsec;
4462   } else {
4463     // user level CPU time only
4464     lwp_time = ((jlong)prusage.pr_utime.tv_sec * (jlong)1000000000) +
4465                 (jlong)prusage.pr_utime.tv_nsec;
4466   }
4467 
4468   return (lwp_time);
4469 }
4470 
4471 void os::current_thread_cpu_time_info(jvmtiTimerInfo *info_ptr) {
4472   info_ptr-&gt;max_value = ALL_64_BITS;      // will not wrap in less than 64 bits
4473   info_ptr-&gt;may_skip_backward = false;    // elapsed time not wall time
4474   info_ptr-&gt;may_skip_forward = false;     // elapsed time not wall time
4475   info_ptr-&gt;kind = JVMTI_TIMER_USER_CPU;  // only user time is returned
4476 }
4477 
4478 void os::thread_cpu_time_info(jvmtiTimerInfo *info_ptr) {
4479   info_ptr-&gt;max_value = ALL_64_BITS;      // will not wrap in less than 64 bits
4480   info_ptr-&gt;may_skip_backward = false;    // elapsed time not wall time
4481   info_ptr-&gt;may_skip_forward = false;     // elapsed time not wall time
4482   info_ptr-&gt;kind = JVMTI_TIMER_USER_CPU;  // only user time is returned
4483 }
4484 
4485 bool os::is_thread_cpu_time_supported() {
4486   return true;
4487 }
4488 
4489 // System loadavg support.  Returns -1 if load average cannot be obtained.
4490 // Return the load average for our processor set if the primitive exists
4491 // (Solaris 9 and later).  Otherwise just return system wide loadavg.
4492 int os::loadavg(double loadavg[], int nelem) {
4493   if (pset_getloadavg_ptr != NULL) {
4494     return (*pset_getloadavg_ptr)(PS_MYID, loadavg, nelem);
4495   } else {
4496     return ::getloadavg(loadavg, nelem);
4497   }
4498 }
4499 
4500 //---------------------------------------------------------------------------------
4501 
4502 bool os::find(address addr, outputStream* st) {
4503   Dl_info dlinfo;
4504   memset(&amp;dlinfo, 0, sizeof(dlinfo));
4505   if (dladdr(addr, &amp;dlinfo) != 0) {
4506     st-&gt;print(PTR_FORMAT &quot;: &quot;, addr);
4507     if (dlinfo.dli_sname != NULL &amp;&amp; dlinfo.dli_saddr != NULL) {
4508       st-&gt;print(&quot;%s+%#lx&quot;, dlinfo.dli_sname, addr-(intptr_t)dlinfo.dli_saddr);
4509     } else if (dlinfo.dli_fbase != NULL) {
4510       st-&gt;print(&quot;&lt;offset %#lx&gt;&quot;, addr-(intptr_t)dlinfo.dli_fbase);
4511     } else {
4512       st-&gt;print(&quot;&lt;absolute address&gt;&quot;);
4513     }
4514     if (dlinfo.dli_fname != NULL) {
4515       st-&gt;print(&quot; in %s&quot;, dlinfo.dli_fname);
4516     }
4517     if (dlinfo.dli_fbase != NULL) {
4518       st-&gt;print(&quot; at &quot; PTR_FORMAT, dlinfo.dli_fbase);
4519     }
4520     st-&gt;cr();
4521 
4522     if (Verbose) {
4523       // decode some bytes around the PC
4524       address begin = clamp_address_in_page(addr-40, addr, os::vm_page_size());
4525       address end   = clamp_address_in_page(addr+40, addr, os::vm_page_size());
4526       address       lowest = (address) dlinfo.dli_sname;
4527       if (!lowest)  lowest = (address) dlinfo.dli_fbase;
4528       if (begin &lt; lowest)  begin = lowest;
4529       Dl_info dlinfo2;
4530       if (dladdr(end, &amp;dlinfo2) != 0 &amp;&amp; dlinfo2.dli_saddr != dlinfo.dli_saddr
4531           &amp;&amp; end &gt; dlinfo2.dli_saddr &amp;&amp; dlinfo2.dli_saddr &gt; begin) {
4532         end = (address) dlinfo2.dli_saddr;
4533       }
4534       Disassembler::decode(begin, end, st);
4535     }
4536     return true;
4537   }
4538   return false;
4539 }
4540 
4541 // Following function has been added to support HotSparc&#39;s libjvm.so running
4542 // under Solaris production JDK 1.2.2 / 1.3.0.  These came from
4543 // src/solaris/hpi/native_threads in the EVM codebase.
4544 //
4545 // NOTE: This is no longer needed in the 1.3.1 and 1.4 production release
4546 // libraries and should thus be removed. We will leave it behind for a while
4547 // until we no longer want to able to run on top of 1.3.0 Solaris production
4548 // JDK. See 4341971.
4549 
4550 #define STACK_SLACK 0x800
4551 
4552 extern &quot;C&quot; {
4553   intptr_t sysThreadAvailableStackWithSlack() {
4554     stack_t st;
4555     intptr_t retval, stack_top;
4556     retval = thr_stksegment(&amp;st);
4557     assert(retval == 0, &quot;incorrect return value from thr_stksegment&quot;);
4558     assert((address)&amp;st &lt; (address)st.ss_sp, &quot;Invalid stack base returned&quot;);
4559     assert((address)&amp;st &gt; (address)st.ss_sp-st.ss_size, &quot;Invalid stack size returned&quot;);
4560     stack_top=(intptr_t)st.ss_sp-st.ss_size;
4561     return ((intptr_t)&amp;stack_top - stack_top - STACK_SLACK);
4562   }
4563 }
4564 
4565 // ObjectMonitor park-unpark infrastructure ...
4566 //
4567 // We implement Solaris and Linux PlatformEvents with the
4568 // obvious condvar-mutex-flag triple.
4569 // Another alternative that works quite well is pipes:
4570 // Each PlatformEvent consists of a pipe-pair.
4571 // The thread associated with the PlatformEvent
4572 // calls park(), which reads from the input end of the pipe.
4573 // Unpark() writes into the other end of the pipe.
4574 // The write-side of the pipe must be set NDELAY.
4575 // Unfortunately pipes consume a large # of handles.
4576 // Native solaris lwp_park() and lwp_unpark() work nicely, too.
4577 // Using pipes for the 1st few threads might be workable, however.
4578 //
4579 // park() is permitted to return spuriously.
4580 // Callers of park() should wrap the call to park() in
4581 // an appropriate loop.  A litmus test for the correct
4582 // usage of park is the following: if park() were modified
4583 // to immediately return 0 your code should still work,
4584 // albeit degenerating to a spin loop.
4585 //
4586 // In a sense, park()-unpark() just provides more polite spinning
4587 // and polling with the key difference over naive spinning being
4588 // that a parked thread needs to be explicitly unparked() in order
4589 // to wake up and to poll the underlying condition.
4590 //
4591 // Assumption:
4592 //    Only one parker can exist on an event, which is why we allocate
4593 //    them per-thread. Multiple unparkers can coexist.
4594 //
4595 // _Event transitions in park()
4596 //   -1 =&gt; -1 : illegal
4597 //    1 =&gt;  0 : pass - return immediately
4598 //    0 =&gt; -1 : block; then set _Event to 0 before returning
4599 //
4600 // _Event transitions in unpark()
4601 //    0 =&gt; 1 : just return
4602 //    1 =&gt; 1 : just return
4603 //   -1 =&gt; either 0 or 1; must signal target thread
4604 //         That is, we can safely transition _Event from -1 to either
4605 //         0 or 1.
4606 //
4607 // _Event serves as a restricted-range semaphore.
4608 //   -1 : thread is blocked, i.e. there is a waiter
4609 //    0 : neutral: thread is running or ready,
4610 //        could have been signaled after a wait started
4611 //    1 : signaled - thread is running or ready
4612 //
4613 // Another possible encoding of _Event would be with
4614 // explicit &quot;PARKED&quot; == 01b and &quot;SIGNALED&quot; == 10b bits.
4615 //
4616 // TODO-FIXME: add DTRACE probes for:
4617 // 1.   Tx parks
4618 // 2.   Ty unparks Tx
4619 // 3.   Tx resumes from park
4620 
4621 
4622 // value determined through experimentation
4623 #define ROUNDINGFIX 11
4624 
4625 // utility to compute the abstime argument to timedwait.
4626 // TODO-FIXME: switch from compute_abstime() to unpackTime().
4627 
4628 static timestruc_t* compute_abstime(timestruc_t* abstime, jlong millis) {
4629   // millis is the relative timeout time
4630   // abstime will be the absolute timeout time
4631   if (millis &lt; 0)  millis = 0;
4632   struct timeval now;
4633   int status = gettimeofday(&amp;now, NULL);
4634   assert(status == 0, &quot;gettimeofday&quot;);
4635   jlong seconds = millis / 1000;
4636   jlong max_wait_period;
4637 
4638   if (UseLWPSynchronization) {
4639     // forward port of fix for 4275818 (not sleeping long enough)
4640     // There was a bug in Solaris 6, 7 and pre-patch 5 of 8 where
4641     // _lwp_cond_timedwait() used a round_down algorithm rather
4642     // than a round_up. For millis less than our roundfactor
4643     // it rounded down to 0 which doesn&#39;t meet the spec.
4644     // For millis &gt; roundfactor we may return a bit sooner, but
4645     // since we can not accurately identify the patch level and
4646     // this has already been fixed in Solaris 9 and 8 we will
4647     // leave it alone rather than always rounding down.
4648 
4649     if (millis &gt; 0 &amp;&amp; millis &lt; ROUNDINGFIX) millis = ROUNDINGFIX;
4650     // It appears that when we go directly through Solaris _lwp_cond_timedwait()
4651     // the acceptable max time threshold is smaller than for libthread on 2.5.1 and 2.6
4652     max_wait_period = 21000000;
4653   } else {
4654     max_wait_period = 50000000;
4655   }
4656   millis %= 1000;
4657   if (seconds &gt; max_wait_period) {      // see man cond_timedwait(3T)
4658     seconds = max_wait_period;
4659   }
4660   abstime-&gt;tv_sec = now.tv_sec  + seconds;
4661   long       usec = now.tv_usec + millis * 1000;
4662   if (usec &gt;= 1000000) {
4663     abstime-&gt;tv_sec += 1;
4664     usec -= 1000000;
4665   }
4666   abstime-&gt;tv_nsec = usec * 1000;
4667   return abstime;
4668 }
4669 
4670 void os::PlatformEvent::park() {           // AKA: down()
4671   // Transitions for _Event:
4672   //   -1 =&gt; -1 : illegal
4673   //    1 =&gt;  0 : pass - return immediately
4674   //    0 =&gt; -1 : block; then set _Event to 0 before returning
4675 
4676   // Invariant: Only the thread associated with the Event/PlatformEvent
4677   // may call park().
4678   assert(_nParked == 0, &quot;invariant&quot;);
4679 
4680   int v;
4681   for (;;) {
4682     v = _Event;
4683     if (Atomic::cmpxchg(&amp;_Event, v, v-1) == v) break;
4684   }
4685   guarantee(v &gt;= 0, &quot;invariant&quot;);
4686   if (v == 0) {
4687     // Do this the hard way by blocking ...
4688     // See http://monaco.sfbay/detail.jsf?cr=5094058.
4689     int status = os::Solaris::mutex_lock(_mutex);
4690     assert_status(status == 0, status, &quot;mutex_lock&quot;);
4691     guarantee(_nParked == 0, &quot;invariant&quot;);
4692     ++_nParked;
4693     while (_Event &lt; 0) {
4694       // for some reason, under 2.7 lwp_cond_wait() may return ETIME ...
4695       // Treat this the same as if the wait was interrupted
4696       // With usr/lib/lwp going to kernel, always handle ETIME
4697       status = os::Solaris::cond_wait(_cond, _mutex);
4698       if (status == ETIME) status = EINTR;
4699       assert_status(status == 0 || status == EINTR, status, &quot;cond_wait&quot;);
4700     }
4701     --_nParked;
4702     _Event = 0;
4703     status = os::Solaris::mutex_unlock(_mutex);
4704     assert_status(status == 0, status, &quot;mutex_unlock&quot;);
4705     // Paranoia to ensure our locked and lock-free paths interact
4706     // correctly with each other.
4707     OrderAccess::fence();
4708   }
4709 }
4710 
4711 int os::PlatformEvent::park(jlong millis) {
4712   // Transitions for _Event:
4713   //   -1 =&gt; -1 : illegal
4714   //    1 =&gt;  0 : pass - return immediately
4715   //    0 =&gt; -1 : block; then set _Event to 0 before returning
4716 
4717   guarantee(_nParked == 0, &quot;invariant&quot;);
4718   int v;
4719   for (;;) {
4720     v = _Event;
4721     if (Atomic::cmpxchg(&amp;_Event, v, v-1) == v) break;
4722   }
4723   guarantee(v &gt;= 0, &quot;invariant&quot;);
4724   if (v != 0) return OS_OK;
4725 
4726   int ret = OS_TIMEOUT;
4727   timestruc_t abst;
4728   compute_abstime(&amp;abst, millis);
4729 
4730   // See http://monaco.sfbay/detail.jsf?cr=5094058.
4731   int status = os::Solaris::mutex_lock(_mutex);
4732   assert_status(status == 0, status, &quot;mutex_lock&quot;);
4733   guarantee(_nParked == 0, &quot;invariant&quot;);
4734   ++_nParked;
4735   while (_Event &lt; 0) {
4736     int status = os::Solaris::cond_timedwait(_cond, _mutex, &amp;abst);
4737     assert_status(status == 0 || status == EINTR ||
4738                   status == ETIME || status == ETIMEDOUT,
4739                   status, &quot;cond_timedwait&quot;);
4740     if (!FilterSpuriousWakeups) break;                // previous semantics
4741     if (status == ETIME || status == ETIMEDOUT) break;
4742     // We consume and ignore EINTR and spurious wakeups.
4743   }
4744   --_nParked;
4745   if (_Event &gt;= 0) ret = OS_OK;
4746   _Event = 0;
4747   status = os::Solaris::mutex_unlock(_mutex);
4748   assert_status(status == 0, status, &quot;mutex_unlock&quot;);
4749   // Paranoia to ensure our locked and lock-free paths interact
4750   // correctly with each other.
4751   OrderAccess::fence();
4752   return ret;
4753 }
4754 
4755 void os::PlatformEvent::unpark() {
4756   // Transitions for _Event:
4757   //    0 =&gt; 1 : just return
4758   //    1 =&gt; 1 : just return
4759   //   -1 =&gt; either 0 or 1; must signal target thread
4760   //         That is, we can safely transition _Event from -1 to either
4761   //         0 or 1.
4762   // See also: &quot;Semaphores in Plan 9&quot; by Mullender &amp; Cox
4763   //
4764   // Note: Forcing a transition from &quot;-1&quot; to &quot;1&quot; on an unpark() means
4765   // that it will take two back-to-back park() calls for the owning
4766   // thread to block. This has the benefit of forcing a spurious return
4767   // from the first park() call after an unpark() call which will help
4768   // shake out uses of park() and unpark() without condition variables.
4769 
4770   if (Atomic::xchg(&amp;_Event, 1) &gt;= 0) return;
4771 
4772   // If the thread associated with the event was parked, wake it.
4773   // Wait for the thread assoc with the PlatformEvent to vacate.
4774   int status = os::Solaris::mutex_lock(_mutex);
4775   assert_status(status == 0, status, &quot;mutex_lock&quot;);
4776   int AnyWaiters = _nParked;
4777   status = os::Solaris::mutex_unlock(_mutex);
4778   assert_status(status == 0, status, &quot;mutex_unlock&quot;);
4779   guarantee(AnyWaiters == 0 || AnyWaiters == 1, &quot;invariant&quot;);
4780   if (AnyWaiters != 0) {
4781     // Note that we signal() *after* dropping the lock for &quot;immortal&quot; Events.
4782     // This is safe and avoids a common class of  futile wakeups.  In rare
4783     // circumstances this can cause a thread to return prematurely from
4784     // cond_{timed}wait() but the spurious wakeup is benign and the victim
4785     // will simply re-test the condition and re-park itself.
4786     // This provides particular benefit if the underlying platform does not
4787     // provide wait morphing.
4788     status = os::Solaris::cond_signal(_cond);
4789     assert_status(status == 0, status, &quot;cond_signal&quot;);
4790   }
4791 }
4792 
4793 // JSR166
4794 // -------------------------------------------------------
4795 
4796 // The solaris and linux implementations of park/unpark are fairly
4797 // conservative for now, but can be improved. They currently use a
4798 // mutex/condvar pair, plus _counter.
4799 // Park decrements _counter if &gt; 0, else does a condvar wait.  Unpark
4800 // sets count to 1 and signals condvar.  Only one thread ever waits
4801 // on the condvar. Contention seen when trying to park implies that someone
4802 // is unparking you, so don&#39;t wait. And spurious returns are fine, so there
4803 // is no need to track notifications.
4804 
4805 #define MAX_SECS 100000000
4806 
4807 // This code is common to linux and solaris and will be moved to a
4808 // common place in dolphin.
4809 //
4810 // The passed in time value is either a relative time in nanoseconds
4811 // or an absolute time in milliseconds. Either way it has to be unpacked
4812 // into suitable seconds and nanoseconds components and stored in the
4813 // given timespec structure.
4814 // Given time is a 64-bit value and the time_t used in the timespec is only
4815 // a signed-32-bit value (except on 64-bit Linux) we have to watch for
4816 // overflow if times way in the future are given. Further on Solaris versions
4817 // prior to 10 there is a restriction (see cond_timedwait) that the specified
4818 // number of seconds, in abstime, is less than current_time  + 100,000,000.
4819 // As it will be 28 years before &quot;now + 100000000&quot; will overflow we can
4820 // ignore overflow and just impose a hard-limit on seconds using the value
4821 // of &quot;now + 100,000,000&quot;. This places a limit on the timeout of about 3.17
4822 // years from &quot;now&quot;.
4823 //
4824 static void unpackTime(timespec* absTime, bool isAbsolute, jlong time) {
4825   assert(time &gt; 0, &quot;convertTime&quot;);
4826 
4827   struct timeval now;
4828   int status = gettimeofday(&amp;now, NULL);
4829   assert(status == 0, &quot;gettimeofday&quot;);
4830 
4831   time_t max_secs = now.tv_sec + MAX_SECS;
4832 
4833   if (isAbsolute) {
4834     jlong secs = time / 1000;
4835     if (secs &gt; max_secs) {
4836       absTime-&gt;tv_sec = max_secs;
4837     } else {
4838       absTime-&gt;tv_sec = secs;
4839     }
4840     absTime-&gt;tv_nsec = (time % 1000) * NANOSECS_PER_MILLISEC;
4841   } else {
4842     jlong secs = time / NANOSECS_PER_SEC;
4843     if (secs &gt;= MAX_SECS) {
4844       absTime-&gt;tv_sec = max_secs;
4845       absTime-&gt;tv_nsec = 0;
4846     } else {
4847       absTime-&gt;tv_sec = now.tv_sec + secs;
4848       absTime-&gt;tv_nsec = (time % NANOSECS_PER_SEC) + now.tv_usec*1000;
4849       if (absTime-&gt;tv_nsec &gt;= NANOSECS_PER_SEC) {
4850         absTime-&gt;tv_nsec -= NANOSECS_PER_SEC;
4851         ++absTime-&gt;tv_sec; // note: this must be &lt;= max_secs
4852       }
4853     }
4854   }
4855   assert(absTime-&gt;tv_sec &gt;= 0, &quot;tv_sec &lt; 0&quot;);
4856   assert(absTime-&gt;tv_sec &lt;= max_secs, &quot;tv_sec &gt; max_secs&quot;);
4857   assert(absTime-&gt;tv_nsec &gt;= 0, &quot;tv_nsec &lt; 0&quot;);
4858   assert(absTime-&gt;tv_nsec &lt; NANOSECS_PER_SEC, &quot;tv_nsec &gt;= nanos_per_sec&quot;);
4859 }
4860 
4861 void Parker::park(bool isAbsolute, jlong time) {
4862   // Ideally we&#39;d do something useful while spinning, such
4863   // as calling unpackTime().
4864 
4865   // Optional fast-path check:
4866   // Return immediately if a permit is available.
4867   // We depend on Atomic::xchg() having full barrier semantics
4868   // since we are doing a lock-free update to _counter.
4869   if (Atomic::xchg(&amp;_counter, 0) &gt; 0) return;
4870 
4871   // Optional fast-exit: Check interrupt before trying to wait
4872   Thread* thread = Thread::current();
4873   assert(thread-&gt;is_Java_thread(), &quot;Must be JavaThread&quot;);
4874   JavaThread *jt = (JavaThread *)thread;
4875   if (jt-&gt;is_interrupted(false)) {
4876     return;
4877   }
4878 
4879   // First, demultiplex/decode time arguments
4880   timespec absTime;
4881   if (time &lt; 0 || (isAbsolute &amp;&amp; time == 0)) { // don&#39;t wait at all
4882     return;
4883   }
4884   if (time &gt; 0) {
4885     // Warning: this code might be exposed to the old Solaris time
4886     // round-down bugs.  Grep &quot;roundingFix&quot; for details.
4887     unpackTime(&amp;absTime, isAbsolute, time);
4888   }
4889 
4890   // Enter safepoint region
4891   // Beware of deadlocks such as 6317397.
4892   // The per-thread Parker:: _mutex is a classic leaf-lock.
4893   // In particular a thread must never block on the Threads_lock while
4894   // holding the Parker:: mutex.  If safepoints are pending both the
4895   // the ThreadBlockInVM() CTOR and DTOR may grab Threads_lock.
4896   ThreadBlockInVM tbivm(jt);
4897 
4898   // Can&#39;t access interrupt state now that we are _thread_blocked. If we&#39;ve
4899   // been interrupted since we checked above then _counter will be &gt; 0.
4900 
4901   // Don&#39;t wait if cannot get lock since interference arises from
4902   // unblocking.
4903   if (os::Solaris::mutex_trylock(_mutex) != 0) {
4904     return;
4905   }
4906 
4907   int status;
4908 
4909   if (_counter &gt; 0)  { // no wait needed
4910     _counter = 0;
4911     status = os::Solaris::mutex_unlock(_mutex);
4912     assert(status == 0, &quot;invariant&quot;);
4913     // Paranoia to ensure our locked and lock-free paths interact
4914     // correctly with each other and Java-level accesses.
4915     OrderAccess::fence();
4916     return;
4917   }
4918 
4919   OSThreadWaitState osts(thread-&gt;osthread(), false /* not Object.wait() */);
4920   jt-&gt;set_suspend_equivalent();
4921   // cleared by handle_special_suspend_equivalent_condition() or java_suspend_self()
4922 
4923   // Do this the hard way by blocking ...
4924   // See http://monaco.sfbay/detail.jsf?cr=5094058.
4925   if (time == 0) {
4926     status = os::Solaris::cond_wait(_cond, _mutex);
4927   } else {
4928     status = os::Solaris::cond_timedwait (_cond, _mutex, &amp;absTime);
4929   }
4930   // Note that an untimed cond_wait() can sometimes return ETIME on older
4931   // versions of the Solaris.
4932   assert_status(status == 0 || status == EINTR ||
4933                 status == ETIME || status == ETIMEDOUT,
4934                 status, &quot;cond_timedwait&quot;);
4935 
4936   _counter = 0;
4937   status = os::Solaris::mutex_unlock(_mutex);
4938   assert_status(status == 0, status, &quot;mutex_unlock&quot;);
4939   // Paranoia to ensure our locked and lock-free paths interact
4940   // correctly with each other and Java-level accesses.
4941   OrderAccess::fence();
4942 
4943   // If externally suspended while waiting, re-suspend
4944   if (jt-&gt;handle_special_suspend_equivalent_condition()) {
4945     jt-&gt;java_suspend_self();
4946   }
4947 }
4948 
4949 void Parker::unpark() {
4950   int status = os::Solaris::mutex_lock(_mutex);
4951   assert(status == 0, &quot;invariant&quot;);
4952   const int s = _counter;
4953   _counter = 1;
4954   status = os::Solaris::mutex_unlock(_mutex);
4955   assert(status == 0, &quot;invariant&quot;);
4956 
4957   if (s &lt; 1) {
4958     status = os::Solaris::cond_signal(_cond);
4959     assert(status == 0, &quot;invariant&quot;);
4960   }
4961 }
4962 
4963 // Platform Mutex/Monitor implementations
4964 
4965 os::PlatformMutex::PlatformMutex() {
4966   int status = os::Solaris::mutex_init(&amp;_mutex);
4967   assert_status(status == 0, status, &quot;mutex_init&quot;);
4968 }
4969 
4970 os::PlatformMutex::~PlatformMutex() {
4971   int status = os::Solaris::mutex_destroy(&amp;_mutex);
4972   assert_status(status == 0, status, &quot;mutex_destroy&quot;);
4973 }
4974 
4975 void os::PlatformMutex::lock() {
4976   int status = os::Solaris::mutex_lock(&amp;_mutex);
4977   assert_status(status == 0, status, &quot;mutex_lock&quot;);
4978 }
4979 
4980 void os::PlatformMutex::unlock() {
4981   int status = os::Solaris::mutex_unlock(&amp;_mutex);
4982   assert_status(status == 0, status, &quot;mutex_unlock&quot;);
4983 }
4984 
4985 bool os::PlatformMutex::try_lock() {
4986   int status = os::Solaris::mutex_trylock(&amp;_mutex);
4987   assert_status(status == 0 || status == EBUSY, status, &quot;mutex_trylock&quot;);
4988   return status == 0;
4989 }
4990 
4991 os::PlatformMonitor::PlatformMonitor() {
4992   int status = os::Solaris::cond_init(&amp;_cond);
4993   assert_status(status == 0, status, &quot;cond_init&quot;);
4994 }
4995 
4996 os::PlatformMonitor::~PlatformMonitor() {
4997   int status = os::Solaris::cond_destroy(&amp;_cond);
4998   assert_status(status == 0, status, &quot;cond_destroy&quot;);
4999 }
5000 
5001 // Must already be locked
5002 int os::PlatformMonitor::wait(jlong millis) {
5003   assert(millis &gt;= 0, &quot;negative timeout&quot;);
5004   if (millis &gt; 0) {
5005     timestruc_t abst;
5006     int ret = OS_TIMEOUT;
5007     compute_abstime(&amp;abst, millis);
5008     int status = os::Solaris::cond_timedwait(&amp;_cond, &amp;_mutex, &amp;abst);
5009     assert_status(status == 0 || status == EINTR ||
5010                   status == ETIME || status == ETIMEDOUT,
5011                   status, &quot;cond_timedwait&quot;);
5012     // EINTR acts as spurious wakeup - which is permitted anyway
5013     if (status == 0 || status == EINTR) {
5014       ret = OS_OK;
5015     }
5016     return ret;
5017   } else {
5018     int status = os::Solaris::cond_wait(&amp;_cond, &amp;_mutex);
5019     assert_status(status == 0 || status == EINTR,
5020                   status, &quot;cond_wait&quot;);
5021     return OS_OK;
5022   }
5023 }
5024 
5025 void os::PlatformMonitor::notify() {
5026   int status = os::Solaris::cond_signal(&amp;_cond);
5027   assert_status(status == 0, status, &quot;cond_signal&quot;);
5028 }
5029 
5030 void os::PlatformMonitor::notify_all() {
5031   int status = os::Solaris::cond_broadcast(&amp;_cond);
5032   assert_status(status == 0, status, &quot;cond_broadcast&quot;);
5033 }
5034 
5035 extern char** environ;
5036 
5037 // Run the specified command in a separate process. Return its exit value,
5038 // or -1 on failure (e.g. can&#39;t fork a new process).
5039 // Unlike system(), this function can be called from signal handler. It
5040 // doesn&#39;t block SIGINT et al.
5041 int os::fork_and_exec(char* cmd, bool use_vfork_if_available) {
5042   char * argv[4];
5043   argv[0] = (char *)&quot;sh&quot;;
5044   argv[1] = (char *)&quot;-c&quot;;
5045   argv[2] = cmd;
5046   argv[3] = NULL;
5047 
5048   // fork is async-safe, fork1 is not so can&#39;t use in signal handler
5049   pid_t pid;
5050   Thread* t = Thread::current_or_null_safe();
5051   if (t != NULL &amp;&amp; t-&gt;is_inside_signal_handler()) {
5052     pid = fork();
5053   } else {
5054     pid = fork1();
5055   }
5056 
5057   if (pid &lt; 0) {
5058     // fork failed
5059     warning(&quot;fork failed: %s&quot;, os::strerror(errno));
5060     return -1;
5061 
5062   } else if (pid == 0) {
5063     // child process
5064 
5065     // try to be consistent with system(), which uses &quot;/usr/bin/sh&quot; on Solaris
5066     execve(&quot;/usr/bin/sh&quot;, argv, environ);
5067 
5068     // execve failed
5069     _exit(-1);
5070 
5071   } else  {
5072     // copied from J2SE ..._waitForProcessExit() in UNIXProcess_md.c; we don&#39;t
5073     // care about the actual exit code, for now.
5074 
5075     int status;
5076 
5077     // Wait for the child process to exit.  This returns immediately if
5078     // the child has already exited. */
5079     while (waitpid(pid, &amp;status, 0) &lt; 0) {
5080       switch (errno) {
5081       case ECHILD: return 0;
5082       case EINTR: break;
5083       default: return -1;
5084       }
5085     }
5086 
5087     if (WIFEXITED(status)) {
5088       // The child exited normally; get its exit code.
5089       return WEXITSTATUS(status);
5090     } else if (WIFSIGNALED(status)) {
5091       // The child exited because of a signal
5092       // The best value to return is 0x80 + signal number,
5093       // because that is what all Unix shells do, and because
5094       // it allows callers to distinguish between process exit and
5095       // process death by signal.
5096       return 0x80 + WTERMSIG(status);
5097     } else {
5098       // Unknown exit code; pass it through
5099       return status;
5100     }
5101   }
5102 }
5103 
5104 size_t os::write(int fd, const void *buf, unsigned int nBytes) {
5105   size_t res;
5106   RESTARTABLE((size_t) ::write(fd, buf, (size_t) nBytes), res);
5107   return res;
5108 }
5109 
5110 int os::close(int fd) {
5111   return ::close(fd);
5112 }
5113 
5114 int os::socket_close(int fd) {
5115   return ::close(fd);
5116 }
5117 
5118 int os::recv(int fd, char* buf, size_t nBytes, uint flags) {
5119   assert(((JavaThread*)Thread::current())-&gt;thread_state() == _thread_in_native,
5120          &quot;Assumed _thread_in_native&quot;);
5121   RESTARTABLE_RETURN_INT((int)::recv(fd, buf, nBytes, flags));
5122 }
5123 
5124 int os::send(int fd, char* buf, size_t nBytes, uint flags) {
5125   assert(((JavaThread*)Thread::current())-&gt;thread_state() == _thread_in_native,
5126          &quot;Assumed _thread_in_native&quot;);
5127   RESTARTABLE_RETURN_INT((int)::send(fd, buf, nBytes, flags));
5128 }
5129 
5130 int os::raw_send(int fd, char* buf, size_t nBytes, uint flags) {
5131   RESTARTABLE_RETURN_INT((int)::send(fd, buf, nBytes, flags));
5132 }
5133 
5134 // As both poll and select can be interrupted by signals, we have to be
5135 // prepared to restart the system call after updating the timeout, unless
5136 // a poll() is done with timeout == -1, in which case we repeat with this
5137 // &quot;wait forever&quot; value.
5138 
5139 int os::connect(int fd, struct sockaddr *him, socklen_t len) {
5140   int _result;
5141   _result = ::connect(fd, him, len);
5142 
5143   // On Solaris, when a connect() call is interrupted, the connection
5144   // can be established asynchronously (see 6343810). Subsequent calls
5145   // to connect() must check the errno value which has the semantic
5146   // described below (copied from the connect() man page). Handling
5147   // of asynchronously established connections is required for both
5148   // blocking and non-blocking sockets.
5149   //     EINTR            The  connection  attempt  was   interrupted
5150   //                      before  any data arrived by the delivery of
5151   //                      a signal. The connection, however, will  be
5152   //                      established asynchronously.
5153   //
5154   //     EINPROGRESS      The socket is non-blocking, and the connec-
5155   //                      tion  cannot  be completed immediately.
5156   //
5157   //     EALREADY         The socket is non-blocking,  and a previous
5158   //                      connection  attempt  has  not yet been com-
5159   //                      pleted.
5160   //
5161   //     EISCONN          The socket is already connected.
5162   if (_result == OS_ERR &amp;&amp; errno == EINTR) {
5163     // restarting a connect() changes its errno semantics
5164     RESTARTABLE(::connect(fd, him, len), _result);
5165     // undo these changes
5166     if (_result == OS_ERR) {
5167       if (errno == EALREADY) {
5168         errno = EINPROGRESS; // fall through
5169       } else if (errno == EISCONN) {
5170         errno = 0;
5171         return OS_OK;
5172       }
5173     }
5174   }
5175   return _result;
5176 }
5177 
5178 // Get the default path to the core file
5179 // Returns the length of the string
5180 int os::get_core_path(char* buffer, size_t bufferSize) {
5181   const char* p = get_current_directory(buffer, bufferSize);
5182 
5183   if (p == NULL) {
5184     assert(p != NULL, &quot;failed to get current directory&quot;);
5185     return 0;
5186   }
5187 
5188   jio_snprintf(buffer, bufferSize, &quot;%s/core or core.%d&quot;,
5189                                               p, current_process_id());
5190 
5191   return strlen(buffer);
5192 }
5193 
5194 bool os::supports_map_sync() {
5195   return false;
5196 }
5197 
5198 #ifndef PRODUCT
5199 void TestReserveMemorySpecial_test() {
5200   // No tests available for this platform
5201 }
5202 #endif
5203 
5204 bool os::start_debugging(char *buf, int buflen) {
5205   int len = (int)strlen(buf);
5206   char *p = &amp;buf[len];
5207 
5208   jio_snprintf(p, buflen-len,
5209                &quot;\n\n&quot;
5210                &quot;Do you want to debug the problem?\n\n&quot;
5211                &quot;To debug, run &#39;dbx - %d&#39;; then switch to thread &quot; INTX_FORMAT &quot;\n&quot;
5212                &quot;Enter &#39;yes&#39; to launch dbx automatically (PATH must include dbx)\n&quot;
5213                &quot;Otherwise, press RETURN to abort...&quot;,
5214                os::current_process_id(), os::current_thread_id());
5215 
5216   bool yes = os::message_box(&quot;Unexpected Error&quot;, buf);
5217 
5218   if (yes) {
5219     // yes, user asked VM to launch debugger
5220     jio_snprintf(buf, sizeof(buf), &quot;dbx - %d&quot;, os::current_process_id());
5221 
5222     os::fork_and_exec(buf);
5223     yes = false;
5224   }
5225   return yes;
5226 }
    </pre>
  </body>
</html>