<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/.mx.jvmci/mx_jvmci.py</title>
    <link rel="stylesheet" href="../../../style.css" />
  </head>
<body>
<center><a href="../../../make/test/JtregNativeJdk.gmk.sdiff.html" target="_top">&lt; prev</a> <a href="../../../index.html" target="_top">index</a> <a href="suite.py.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/.mx.jvmci/mx_jvmci.py</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
370 def _unittest_vm_launcher(vmArgs, mainClass, mainClassArgs):
371     run_vm(vmArgs + [mainClass] + mainClassArgs)
372 
373 mx_unittest.set_vm_launcher(&#39;JVMCI VM launcher&#39;, _unittest_vm_launcher)
374 
375 def _jvmci_gate_runner(args, tasks):
376     # Build release server VM now so we can run the unit tests
377     with Task(&#39;BuildHotSpotJVMCIHosted: release&#39;, tasks) as t:
378         if t: _runmultimake([&#39;--jdk-jvm-variants&#39;, &#39;server&#39;, &#39;--jdk-debug-levels&#39;, &#39;release&#39;])
379 
380     # Run unit tests in hosted mode
381     with VM(jvmVariant=&#39;server&#39;, debugLevel=&#39;release&#39;, jvmciMode=&#39;hosted&#39;):
382         with Task(&#39;JVMCI UnitTests: hosted-release&#39;, tasks) as t:
383             if t: unittest([&#39;--suite&#39;, &#39;jvmci&#39;, &#39;--enable-timing&#39;, &#39;--verbose&#39;, &#39;--fail-fast&#39;])
384 
385     # Build the other VM flavors
386     with Task(&#39;BuildHotSpotJVMCIOthers: fastdebug&#39;, tasks) as t:
387         if t: _runmultimake([&#39;--jdk-jvm-variants&#39;, &#39;server&#39;, &#39;--jdk-debug-levels&#39;, &#39;fastdebug&#39;])
388 
389     with Task(&#39;CleanAndBuildIdealGraphVisualizer&#39;, tasks, disableJacoco=True) as t:
<span class="line-modified">390         if t and platform.processor() != &#39;sparc&#39;:</span>
391             buildxml = mx._cygpathU2W(join(_suite.dir, &#39;src&#39;, &#39;share&#39;, &#39;tools&#39;, &#39;IdealGraphVisualizer&#39;, &#39;build.xml&#39;))
392             mx.run([&#39;ant&#39;, &#39;-f&#39;, buildxml, &#39;-q&#39;, &#39;clean&#39;, &#39;build&#39;], env=_igvBuildEnv())
393 
394 mx_gate.add_gate_runner(_suite, _jvmci_gate_runner)
395 mx_gate.add_gate_argument(&#39;-g&#39;, &#39;--only-build-jvmci&#39;, action=&#39;store_false&#39;, dest=&#39;buildNonJVMCI&#39;, help=&#39;only build the JVMCI VM&#39;)
396 
397 def _igvJdk():
398     v8u20 = mx.VersionSpec(&quot;1.8.0_20&quot;)
399     v8u40 = mx.VersionSpec(&quot;1.8.0_40&quot;)
400     v8 = mx.VersionSpec(&quot;1.8&quot;)
401     def _igvJdkVersionCheck(version):
402         return version &gt;= v8 and (version &lt; v8u20 or version &gt;= v8u40)
403     return mx.get_jdk(_igvJdkVersionCheck, versionDescription=&#39;&gt;= 1.8 and &lt; 1.8.0u20 or &gt;= 1.8.0u40&#39;, purpose=&quot;building &amp; running IGV&quot;).home
404 
405 def _igvBuildEnv():
406         # When the http_proxy environment variable is set, convert it to the proxy settings that ant needs
407     env = dict(os.environ)
408     proxy = os.environ.get(&#39;http_proxy&#39;)
409     if not (proxy is None) and len(proxy) &gt; 0:
410         if &#39;://&#39; in proxy:
</pre>
<hr />
<pre>
469         zf = zipfile.ZipFile(archive, &#39;r&#39;)
470         zf.extractall(libpath)
471 
472     if not exists(executable):
473         mx.abort(&#39;C1Visualizer binary does not exist: &#39; + executable)
474 
475     if mx.get_os() != &#39;windows&#39;:
476         # Make sure that execution is allowed. The zip file does not always specfiy that correctly
477         os.chmod(executable, 0777)
478 
479     mx.run([executable])
480 
481 def hsdis(args, copyToDir=None):
482     &quot;&quot;&quot;download the hsdis library
483 
484     This is needed to support HotSpot&#39;s assembly dumping features.
485     By default it downloads the Intel syntax version, use the &#39;att&#39; argument to install AT&amp;T syntax.&quot;&quot;&quot;
486     flavor = &#39;intel&#39;
487     if &#39;att&#39; in args:
488         flavor = &#39;att&#39;
<span class="line-removed">489     if mx.get_arch() == &quot;sparcv9&quot;:</span>
<span class="line-removed">490         flavor = &quot;sparcv9&quot;</span>
491     lib = mx.add_lib_suffix(&#39;hsdis-&#39; + mx.get_arch())
492     path = join(_suite.dir, &#39;lib&#39;, lib)
493 
494     sha1s = {
495         &#39;att/hsdis-amd64.dll&#39; : &#39;bcbd535a9568b5075ab41e96205e26a2bac64f72&#39;,
496         &#39;att/hsdis-amd64.so&#39; : &#39;58919ba085d4ef7a513f25bae75e7e54ee73c049&#39;,
497         &#39;intel/hsdis-amd64.dll&#39; : &#39;6a388372cdd5fe905c1a26ced614334e405d1f30&#39;,
498         &#39;intel/hsdis-amd64.so&#39; : &#39;844ed9ffed64fe9599638f29a8450c50140e3192&#39;,
499         &#39;intel/hsdis-amd64.dylib&#39; : &#39;fdb13ef0d7d23d93dacaae9c98837bea0d4fc5a2&#39;,
<span class="line-removed">500         &#39;sparcv9/hsdis-sparcv9.so&#39;: &#39;970640a9af0bd63641f9063c11275b371a59ee60&#39;,</span>
501     }
502 
503     flavoredLib = flavor + &quot;/&quot; + lib
504     if flavoredLib not in sha1s:
505         mx.logv(&quot;hsdis not supported on this plattform or architecture&quot;)
506         return
507 
508     if not exists(path):
509         sha1 = sha1s[flavoredLib]
510         sha1path = path + &#39;.sha1&#39;
511         mx.download_file_with_sha1(&#39;hsdis&#39;, path, [&#39;https://lafo.ssw.uni-linz.ac.at/pub/hsdis/&#39; + flavoredLib], sha1, sha1path, True, True, sources=False)
512     if copyToDir is not None and exists(copyToDir):
513         shutil.copy(path, copyToDir)
514 
515 def hcfdis(args):
516     &quot;&quot;&quot;disassemble HexCodeFiles embedded in text files
517 
518     Run a tool over the input files to convert all embedded HexCodeFiles
519     to a disassembled format.&quot;&quot;&quot;
520 
</pre>
<hr />
<pre>
562 def jol(args):
563     &quot;&quot;&quot;Java Object Layout&quot;&quot;&quot;
564     joljar = mx.library(&#39;JOL_INTERNALS&#39;).get_path(resolve=True)
565     candidates = mx.findclass(args, logToConsole=False, matcher=lambda s, classname: s == classname or classname.endswith(&#39;.&#39; + s) or classname.endswith(&#39;$&#39; + s))
566 
567     if len(candidates) &gt; 0:
568         candidates = mx.select_items(sorted(candidates))
569     else:
570         # mx.findclass can be mistaken, don&#39;t give up yet
571         candidates = args
572 
573     run_vm([&#39;-javaagent:&#39; + joljar, &#39;-cp&#39;, os.pathsep.join([mx.classpath(), joljar]), &quot;org.openjdk.jol.MainObjectInternals&quot;] + candidates)
574 
575 def _get_openjdk_os():
576     # See: common/autoconf/platform.m4
577     os = mx.get_os()
578     if &#39;darwin&#39; in os:
579         os = &#39;macosx&#39;
580     elif &#39;linux&#39; in os:
581         os = &#39;linux&#39;
<span class="line-removed">582     elif &#39;solaris&#39; in os:</span>
<span class="line-removed">583         os = &#39;solaris&#39;</span>
584     elif &#39;cygwin&#39; in os or &#39;mingw&#39; in os:
585         os = &#39;windows&#39;
586     return os
587 
588 def _get_openjdk_cpu():
589     cpu = mx.get_arch()
590     if cpu == &#39;amd64&#39;:
591         cpu = &#39;x86_64&#39;
<span class="line-removed">592     elif cpu == &#39;sparcv9&#39;:</span>
<span class="line-removed">593         cpu = &#39;sparcv9&#39;</span>
594     return cpu
595 
596 def _get_openjdk_os_cpu():
597     return _get_openjdk_os() + &#39;-&#39; + _get_openjdk_cpu()
598 
599 def _get_jdk_dir():
600     suiteParentDir = dirname(_suite.dir)
601     # suitParentDir is now something like: /some_prefix/jdk10-hs/open/src
602     pathComponents = suiteParentDir.split(os.sep)
603     for i in range(0, len(pathComponents)):
604         if pathComponents[i] in [&quot;open&quot;, &quot;src&quot;]:
605             del pathComponents[i:]
606             break
607     return os.path.join(os.sep, *pathComponents)
608 
609 def _get_jdk_build_dir(debugLevel=None):
610     &quot;&quot;&quot;
611     Gets the directory into which the JDK is built. This directory contains
612     the exploded JDK under jdk/ and the JDK image under images/jdk/.
613     &quot;&quot;&quot;
</pre>
</td>
<td>
<hr />
<pre>
370 def _unittest_vm_launcher(vmArgs, mainClass, mainClassArgs):
371     run_vm(vmArgs + [mainClass] + mainClassArgs)
372 
373 mx_unittest.set_vm_launcher(&#39;JVMCI VM launcher&#39;, _unittest_vm_launcher)
374 
375 def _jvmci_gate_runner(args, tasks):
376     # Build release server VM now so we can run the unit tests
377     with Task(&#39;BuildHotSpotJVMCIHosted: release&#39;, tasks) as t:
378         if t: _runmultimake([&#39;--jdk-jvm-variants&#39;, &#39;server&#39;, &#39;--jdk-debug-levels&#39;, &#39;release&#39;])
379 
380     # Run unit tests in hosted mode
381     with VM(jvmVariant=&#39;server&#39;, debugLevel=&#39;release&#39;, jvmciMode=&#39;hosted&#39;):
382         with Task(&#39;JVMCI UnitTests: hosted-release&#39;, tasks) as t:
383             if t: unittest([&#39;--suite&#39;, &#39;jvmci&#39;, &#39;--enable-timing&#39;, &#39;--verbose&#39;, &#39;--fail-fast&#39;])
384 
385     # Build the other VM flavors
386     with Task(&#39;BuildHotSpotJVMCIOthers: fastdebug&#39;, tasks) as t:
387         if t: _runmultimake([&#39;--jdk-jvm-variants&#39;, &#39;server&#39;, &#39;--jdk-debug-levels&#39;, &#39;fastdebug&#39;])
388 
389     with Task(&#39;CleanAndBuildIdealGraphVisualizer&#39;, tasks, disableJacoco=True) as t:
<span class="line-modified">390         if t:</span>
391             buildxml = mx._cygpathU2W(join(_suite.dir, &#39;src&#39;, &#39;share&#39;, &#39;tools&#39;, &#39;IdealGraphVisualizer&#39;, &#39;build.xml&#39;))
392             mx.run([&#39;ant&#39;, &#39;-f&#39;, buildxml, &#39;-q&#39;, &#39;clean&#39;, &#39;build&#39;], env=_igvBuildEnv())
393 
394 mx_gate.add_gate_runner(_suite, _jvmci_gate_runner)
395 mx_gate.add_gate_argument(&#39;-g&#39;, &#39;--only-build-jvmci&#39;, action=&#39;store_false&#39;, dest=&#39;buildNonJVMCI&#39;, help=&#39;only build the JVMCI VM&#39;)
396 
397 def _igvJdk():
398     v8u20 = mx.VersionSpec(&quot;1.8.0_20&quot;)
399     v8u40 = mx.VersionSpec(&quot;1.8.0_40&quot;)
400     v8 = mx.VersionSpec(&quot;1.8&quot;)
401     def _igvJdkVersionCheck(version):
402         return version &gt;= v8 and (version &lt; v8u20 or version &gt;= v8u40)
403     return mx.get_jdk(_igvJdkVersionCheck, versionDescription=&#39;&gt;= 1.8 and &lt; 1.8.0u20 or &gt;= 1.8.0u40&#39;, purpose=&quot;building &amp; running IGV&quot;).home
404 
405 def _igvBuildEnv():
406         # When the http_proxy environment variable is set, convert it to the proxy settings that ant needs
407     env = dict(os.environ)
408     proxy = os.environ.get(&#39;http_proxy&#39;)
409     if not (proxy is None) and len(proxy) &gt; 0:
410         if &#39;://&#39; in proxy:
</pre>
<hr />
<pre>
469         zf = zipfile.ZipFile(archive, &#39;r&#39;)
470         zf.extractall(libpath)
471 
472     if not exists(executable):
473         mx.abort(&#39;C1Visualizer binary does not exist: &#39; + executable)
474 
475     if mx.get_os() != &#39;windows&#39;:
476         # Make sure that execution is allowed. The zip file does not always specfiy that correctly
477         os.chmod(executable, 0777)
478 
479     mx.run([executable])
480 
481 def hsdis(args, copyToDir=None):
482     &quot;&quot;&quot;download the hsdis library
483 
484     This is needed to support HotSpot&#39;s assembly dumping features.
485     By default it downloads the Intel syntax version, use the &#39;att&#39; argument to install AT&amp;T syntax.&quot;&quot;&quot;
486     flavor = &#39;intel&#39;
487     if &#39;att&#39; in args:
488         flavor = &#39;att&#39;


489     lib = mx.add_lib_suffix(&#39;hsdis-&#39; + mx.get_arch())
490     path = join(_suite.dir, &#39;lib&#39;, lib)
491 
492     sha1s = {
493         &#39;att/hsdis-amd64.dll&#39; : &#39;bcbd535a9568b5075ab41e96205e26a2bac64f72&#39;,
494         &#39;att/hsdis-amd64.so&#39; : &#39;58919ba085d4ef7a513f25bae75e7e54ee73c049&#39;,
495         &#39;intel/hsdis-amd64.dll&#39; : &#39;6a388372cdd5fe905c1a26ced614334e405d1f30&#39;,
496         &#39;intel/hsdis-amd64.so&#39; : &#39;844ed9ffed64fe9599638f29a8450c50140e3192&#39;,
497         &#39;intel/hsdis-amd64.dylib&#39; : &#39;fdb13ef0d7d23d93dacaae9c98837bea0d4fc5a2&#39;,

498     }
499 
500     flavoredLib = flavor + &quot;/&quot; + lib
501     if flavoredLib not in sha1s:
502         mx.logv(&quot;hsdis not supported on this plattform or architecture&quot;)
503         return
504 
505     if not exists(path):
506         sha1 = sha1s[flavoredLib]
507         sha1path = path + &#39;.sha1&#39;
508         mx.download_file_with_sha1(&#39;hsdis&#39;, path, [&#39;https://lafo.ssw.uni-linz.ac.at/pub/hsdis/&#39; + flavoredLib], sha1, sha1path, True, True, sources=False)
509     if copyToDir is not None and exists(copyToDir):
510         shutil.copy(path, copyToDir)
511 
512 def hcfdis(args):
513     &quot;&quot;&quot;disassemble HexCodeFiles embedded in text files
514 
515     Run a tool over the input files to convert all embedded HexCodeFiles
516     to a disassembled format.&quot;&quot;&quot;
517 
</pre>
<hr />
<pre>
559 def jol(args):
560     &quot;&quot;&quot;Java Object Layout&quot;&quot;&quot;
561     joljar = mx.library(&#39;JOL_INTERNALS&#39;).get_path(resolve=True)
562     candidates = mx.findclass(args, logToConsole=False, matcher=lambda s, classname: s == classname or classname.endswith(&#39;.&#39; + s) or classname.endswith(&#39;$&#39; + s))
563 
564     if len(candidates) &gt; 0:
565         candidates = mx.select_items(sorted(candidates))
566     else:
567         # mx.findclass can be mistaken, don&#39;t give up yet
568         candidates = args
569 
570     run_vm([&#39;-javaagent:&#39; + joljar, &#39;-cp&#39;, os.pathsep.join([mx.classpath(), joljar]), &quot;org.openjdk.jol.MainObjectInternals&quot;] + candidates)
571 
572 def _get_openjdk_os():
573     # See: common/autoconf/platform.m4
574     os = mx.get_os()
575     if &#39;darwin&#39; in os:
576         os = &#39;macosx&#39;
577     elif &#39;linux&#39; in os:
578         os = &#39;linux&#39;


579     elif &#39;cygwin&#39; in os or &#39;mingw&#39; in os:
580         os = &#39;windows&#39;
581     return os
582 
583 def _get_openjdk_cpu():
584     cpu = mx.get_arch()
585     if cpu == &#39;amd64&#39;:
586         cpu = &#39;x86_64&#39;


587     return cpu
588 
589 def _get_openjdk_os_cpu():
590     return _get_openjdk_os() + &#39;-&#39; + _get_openjdk_cpu()
591 
592 def _get_jdk_dir():
593     suiteParentDir = dirname(_suite.dir)
594     # suitParentDir is now something like: /some_prefix/jdk10-hs/open/src
595     pathComponents = suiteParentDir.split(os.sep)
596     for i in range(0, len(pathComponents)):
597         if pathComponents[i] in [&quot;open&quot;, &quot;src&quot;]:
598             del pathComponents[i:]
599             break
600     return os.path.join(os.sep, *pathComponents)
601 
602 def _get_jdk_build_dir(debugLevel=None):
603     &quot;&quot;&quot;
604     Gets the directory into which the JDK is built. This directory contains
605     the exploded JDK under jdk/ and the JDK image under images/jdk/.
606     &quot;&quot;&quot;
</pre>
</td>
</tr>
</table>
<center><a href="../../../make/test/JtregNativeJdk.gmk.sdiff.html" target="_top">&lt; prev</a> <a href="../../../index.html" target="_top">index</a> <a href="suite.py.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>