<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New make/scripts/compare.sh</title>
    <link rel="stylesheet" href="../../style.css" />
  </head>
  <body>
    <pre>
   1 #!/bin/bash
   2 #
   3 # Copyright (c) 2012, 2020, Oracle and/or its affiliates. All rights reserved.
   4 # DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   5 #
   6 # This code is free software; you can redistribute it and/or modify it
   7 # under the terms of the GNU General Public License version 2 only, as
   8 # published by the Free Software Foundation.
   9 #
  10 # This code is distributed in the hope that it will be useful, but WITHOUT
  11 # ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  12 # FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  13 # version 2 for more details (a copy is included in the LICENSE file that
  14 # accompanied this code).
  15 #
  16 # You should have received a copy of the GNU General Public License version
  17 # 2 along with this work; if not, write to the Free Software Foundation,
  18 # Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  19 #
  20 # Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  21 # or visit www.oracle.com if you need additional information or have any
  22 # questions.
  23 #
  24 
  25 # This script is processed by configure before it&#39;s usable. It is run from
  26 # the root of the build directory.
  27 
  28 
  29 ################################################################################
  30 
  31 # Check that we are run via the wrapper generated by configure
  32 if [ -z &quot;$TOPDIR&quot; ]; then
  33     echo &quot;Error: You must run this script using build/[conf]/compare.sh&quot;
  34     exit 1
  35 fi
  36 
  37 # Make sure all shell commands are executed with the C locale
  38 export LC_ALL=C
  39 
  40 if [ &quot;$OPENJDK_TARGET_OS&quot; = &quot;macosx&quot; ]; then
  41     FULLDUMP_CMD=&quot;$OTOOL -v -V -h -X -d&quot;
  42     LDD_CMD=&quot;$OTOOL -L&quot;
  43     DIS_CMD=&quot;$OTOOL -v -V -t&quot;
  44     STAT_PRINT_SIZE=&quot;-f %z&quot;
  45 elif [ &quot;$OPENJDK_TARGET_OS&quot; = &quot;windows&quot; ]; then
  46     FULLDUMP_CMD=&quot;$DUMPBIN -all&quot;
  47     LDD_CMD=&quot;$DUMPBIN -dependents&quot;
  48     DIS_CMD=&quot;$DUMPBIN -disasm:nobytes&quot;
  49     STAT_PRINT_SIZE=&quot;-c %s&quot;
  50 elif [ &quot;$OPENJDK_TARGET_OS&quot; = &quot;aix&quot; ]; then
  51     FULLDUMP_CMD=&quot;dump -h -r -t -n -X64&quot;
  52     LDD_CMD=&quot;$LDD&quot;
  53     DIS_CMD=&quot;$OBJDUMP -d&quot;
  54     STAT_PRINT_SIZE=&quot;-c %s&quot;
  55 else
  56     FULLDUMP_CMD=&quot;$READELF -a&quot;
  57     LDD_CMD=&quot;$LDD&quot;
  58     DIS_CMD=&quot;$OBJDUMP -d&quot;
  59     STAT_PRINT_SIZE=&quot;-c %s&quot;
  60 fi
  61 
  62 COMPARE_EXCEPTIONS_INCLUDE=&quot;$TOPDIR/make/scripts/compare_exceptions.sh.incl&quot;
  63 if [ ! -e &quot;$COMPARE_EXCEPTIONS_INCLUDE&quot; ]; then
  64     echo &quot;Error: Cannot locate the exceptions file, it should have been here: $COMPARE_EXCEPTIONS_INCLUDE&quot;
  65     exit 1
  66 fi
  67 # Include exception definitions
  68 . &quot;$COMPARE_EXCEPTIONS_INCLUDE&quot;
  69 
  70 ################################################################################
  71 #
  72 # Disassembly diff filters. These filters try to filter out ephemeral parts of the
  73 # disassembly, such as hard-coded addresses, to be able to catch &quot;actual&quot; differences.
  74 
  75 if [ &quot;$OPENJDK_TARGET_OS&quot; = &quot;windows&quot; ]; then
  76   if [ &quot;$OPENJDK_TARGET_CPU&quot; = &quot;x86&quot; ]; then
  77     DIS_DIFF_FILTER=&quot;$SED -r \
  78         -e &#39;s/^  [0-9A-F]{16}: //&#39; \
  79         -e &#39;s/^  [0-9A-F]{8}: /  &lt;ADDR&gt;: /&#39; \
  80         -e &#39;s/(offset \?\?)_C@_.*/\1&lt;SYM&gt;/&#39; \
  81         -e &#39;s/[@?][A-Za-z0-9_]{1,25}/&lt;SYM&gt;/&#39; \
  82         -e &#39;s/([-,+])[0-9A-F]{2,16}/\1&lt;HEXSTR&gt;/g&#39; \
  83         -e &#39;s/\[[0-9A-F]{4,16}h\]/[&lt;HEXSTR&gt;]/&#39; \
  84         -e &#39;s/: ([a-z]{2}[a-z ]{2})        [0-9A-F]{2,16}h?$/: \1        &lt;HEXSTR&gt;/&#39; \
  85         -e &#39;s/_20[0-9]{2}_[0-1][0-9]_[0-9]{2}/_&lt;DATE&gt;/&#39; \
  86         &quot;
  87   elif [ &quot;$OPENJDK_TARGET_CPU&quot; = &quot;x86_64&quot; ]; then
  88     DIS_DIFF_FILTER=&quot;$SED -r \
  89         -e &#39;s/^  [0-9A-F]{16}: //&#39; \
  90         -e &#39;s/\[[0-9A-F]{4,16}h\]/[&lt;HEXSTR&gt;]/&#39; \
  91         -e &#39;s/([,+])[0-9A-F]{2,16}h/\1&lt;HEXSTR&gt;/&#39; \
  92         -e &#39;s/([a-z]{2}[a-z ]{2})        [0-9A-F]{4,16}$/\1        &lt;HEXSTR&gt;/&#39; \
  93         -e &#39;s/\[\?\?_C@_.*/[&lt;SYM&gt;]/&#39; \
  94         &quot;
  95   fi
  96 elif [ &quot;$OPENJDK_TARGET_OS&quot; = &quot;macosx&quot; ]; then
  97   DIS_DIFF_FILTER=&quot;$SED \
  98       -e &#39;s/0x[0-9a-f]\{3,16\}/&lt;HEXSTR&gt;/g&#39; -e &#39;s/^[0-9a-f]\{12,20\}/&lt;ADDR&gt;/&#39; \
  99       -e &#39;s/-20[0-9][0-9]-[0-1][0-9]-[0-3][0-9]-[0-2][0-9]\{5\}/&lt;DATE&gt;/g&#39; \
 100       -e &#39;s/), built on .*/), &lt;DATE&gt;/&#39; \
 101       &quot;
 102 fi
 103 
 104 ################################################################################
 105 # Compare text files and ignore specific differences:
 106 #
 107 #  * Timestamps in Java sources generated by idl2java
 108 #  * Sorting order and cleanup style in .properties files
 109 
 110 diff_text() {
 111     OTHER_FILE=$1
 112     THIS_FILE=$2
 113 
 114     SUFFIX=&quot;${THIS_FILE##*.}&quot;
 115     NAME=&quot;${THIS_FILE##*/}&quot;
 116 
 117     TMP=$($DIFF $THIS_FILE $OTHER_FILE)
 118 
 119     if test &quot;x$SUFFIX&quot; = &quot;xclass&quot;; then
 120         if [ &quot;$NAME&quot; = &quot;SystemModules\$all.class&quot; ] \
 121            || [ &quot;$NAME&quot; = &quot;SystemModules\$default.class&quot; ]; then
 122             # The SystemModules\$*.classes are not comparable as they contain the
 123             # module hashes which would require a whole other level of
 124             # reproducible builds to get reproducible. There is also random
 125             # order of map initialization.
 126             TMP=&quot;&quot;
 127         elif [ &quot;$NAME&quot; = &quot;module-info.class&quot; ]; then
 128             # The module-info.class have several issues with random ordering of
 129             # elements in HashSets.
 130             MODULES_CLASS_FILTER=&quot;$SED \
 131                 -e &#39;s/,$//&#39; \
 132                 -e &#39;s/;$//&#39; \
 133                 -e &#39;s/^ *[0-9]*://&#39; \
 134                 -e &#39;s/#[0-9]* */#/&#39; \
 135                 -e &#39;s/ *\/\// \/\//&#39; \
 136                 -e &#39;s/aload *[0-9]*/aload X/&#39; \
 137                 -e &#39;s/ldc_w/ldc  /&#39; \
 138                 | $SORT \
 139                 &quot;
 140             $JAVAP -c -constants -l -p &quot;${OTHER_FILE}&quot; \
 141                 | eval &quot;$MODULES_CLASS_FILTER&quot; &gt;  ${OTHER_FILE}.javap &amp;
 142             $JAVAP -c -constants -l -p &quot;${THIS_FILE}&quot; \
 143                 | eval &quot;$MODULES_CLASS_FILTER&quot; &gt; ${THIS_FILE}.javap &amp;
 144             wait
 145             TMP=$($DIFF ${OTHER_FILE}.javap ${THIS_FILE}.javap)
 146         fi
 147     fi
 148 
 149     if test -n &quot;$TMP&quot;; then
 150         echo Files $OTHER_FILE and $THIS_FILE differ
 151         return 1
 152     fi
 153 
 154     return 0
 155 }
 156 
 157 ################################################################################
 158 # Compare directory structure
 159 
 160 compare_dirs() {
 161     THIS_DIR=$1
 162     OTHER_DIR=$2
 163     WORK_DIR=$3
 164 
 165     mkdir -p $WORK_DIR
 166 
 167     (cd $OTHER_DIR &amp;&amp; $FIND . -type d | $SORT &gt; $WORK_DIR/dirs_other)
 168     (cd $THIS_DIR &amp;&amp; $FIND . -type d | $SORT &gt; $WORK_DIR/dirs_this)
 169 
 170     $DIFF $WORK_DIR/dirs_other $WORK_DIR/dirs_this &gt; $WORK_DIR/dirs_diff
 171 
 172     echo -n Directory structure...
 173     if [ -s $WORK_DIR/dirs_diff ]; then
 174         echo Differences found.
 175         REGRESSIONS=true
 176         # Differences in directories found.
 177         ONLY_OTHER=$($GREP &#39;&lt;&#39; $WORK_DIR/dirs_diff)
 178         if [ &quot;$ONLY_OTHER&quot; ]; then
 179             echo Only in $OTHER
 180             $GREP &#39;&lt;&#39; $WORK_DIR/dirs_diff | $SED &#39;s|&lt; ./|    |g&#39;
 181         fi
 182         ONLY_THIS=$($GREP &#39;&gt;&#39; $WORK_DIR/dirs_diff)
 183         if [ &quot;$ONLY_THIS&quot; ]; then
 184             echo Only in $THIS
 185             $GREP &#39;&gt;&#39; $WORK_DIR/dirs_diff | $SED &#39;s|&gt; ./|    |g&#39;
 186         fi
 187     else
 188         echo Identical!
 189     fi
 190 }
 191 
 192 
 193 ################################################################################
 194 # Compare file structure
 195 
 196 compare_files() {
 197     THIS_DIR=$1
 198     OTHER_DIR=$2
 199     WORK_DIR=$3
 200 
 201     $MKDIR -p $WORK_DIR
 202 
 203     (cd $OTHER_DIR &amp;&amp; $FIND . ! -type d | $SORT &gt; $WORK_DIR/files_other)
 204     (cd $THIS_DIR &amp;&amp; $FIND . ! -type d | $SORT &gt; $WORK_DIR/files_this)
 205 
 206     $DIFF $WORK_DIR/files_other $WORK_DIR/files_this &gt; $WORK_DIR/files_diff
 207 
 208     echo -n File names...
 209     if [ -s $WORK_DIR/files_diff ]; then
 210         echo Differences found.
 211         REGRESSIONS=true
 212         # Differences in files found.
 213         ONLY_OTHER=$($GREP &#39;&lt;&#39; $WORK_DIR/files_diff)
 214         if [ &quot;$ONLY_OTHER&quot; ]; then
 215             echo Only in $OTHER
 216             $GREP &#39;&lt;&#39; $WORK_DIR/files_diff | $SED &#39;s|&lt; ./|    |g&#39;
 217         fi
 218         ONLY_THIS=$($GREP &#39;&gt;&#39; $WORK_DIR/files_diff)
 219         if [ &quot;$ONLY_THIS&quot; ]; then
 220             echo Only in $THIS
 221             $GREP &#39;&gt;&#39; $WORK_DIR/files_diff | $SED &#39;s|&gt; ./|    |g&#39;
 222         fi
 223     else
 224         echo Identical!
 225     fi
 226 }
 227 
 228 
 229 ################################################################################
 230 # Compare permissions
 231 
 232 compare_permissions() {
 233     THIS_DIR=$1
 234     OTHER_DIR=$2
 235     WORK_DIR=$3
 236 
 237     mkdir -p $WORK_DIR
 238 
 239     echo -n Permissions...
 240     found=&quot;&quot;
 241     for f in `cd $OTHER_DIR &amp;&amp; $FIND . -type f`
 242     do
 243         if [ ! -f ${OTHER_DIR}/$f ]; then continue; fi
 244         if [ ! -f ${THIS_DIR}/$f ]; then continue; fi
 245         OP=`ls -l ${OTHER_DIR}/$f | awk &#39;{printf(&quot;%.10s\n&quot;, $1);}&#39;`
 246         TP=`ls -l ${THIS_DIR}/$f | awk &#39;{printf(&quot;%.10s\n&quot;, $1);}&#39;`
 247         if [ &quot;$OP&quot; != &quot;$TP&quot; ]
 248         then
 249             if [ -z &quot;$found&quot; ]; then echo ; found=&quot;yes&quot;; fi
 250             $PRINTF &quot;\tother: ${OP} this: ${TP}\t$f\n&quot;
 251         fi
 252     done
 253     if [ -z &quot;$found&quot; ]; then
 254         echo &quot;Identical!&quot;
 255     else
 256         REGRESSIONS=true
 257     fi
 258 }
 259 
 260 ################################################################################
 261 # Compare file command output
 262 
 263 compare_file_types() {
 264     THIS_DIR=$1
 265     OTHER_DIR=$2
 266     WORK_DIR=$3
 267 
 268     $MKDIR -p $WORK_DIR
 269 
 270     FILE_TYPES_FILTER=&quot;$SED \
 271         -e &#39;s/BuildID[^,]*//&#39; \
 272         -e &#39;s/last modified: .*//&#39; \
 273         &quot;
 274 
 275     echo -n File types...
 276     found=&quot;&quot;
 277     # The file command does not know about jmod files and this sometimes results
 278     # in different types being detected more or less randomly.
 279     for f in $(cd $OTHER_DIR &amp;&amp; $FIND . ! -type d -a ! -name &quot;*.jmod&quot;)
 280     do
 281         if [ ! -f ${OTHER_DIR}/$f ]; then continue; fi
 282         if [ ! -f ${THIS_DIR}/$f ]; then continue; fi
 283         OF=$(cd ${OTHER_DIR} &amp;&amp; $FILE -h $f | eval $FILE_TYPES_FILTER)
 284         TF=$(cd ${THIS_DIR} &amp;&amp; $FILE -h $f | eval $FILE_TYPES_FILTER)
 285         if [ &quot;$OF&quot; != &quot;$TF&quot; ]
 286         then
 287             if [ &quot;`echo $OF | $GREP -c &#39;Zip archive data&#39;`&quot; -gt 0 ] \
 288                 &amp;&amp; [ &quot;`echo $TF | $GREP -c &#39;Zip archive data&#39;`&quot; -gt 0 ]
 289             then
 290                 # the way we produce zip-files make it so that directories are stored in
 291                 # old file but not in new (only files with full-path) this makes file
 292                 # report them as different
 293                 continue
 294             elif [ &quot;`echo $OF | $GREP -c &#39;MSVC program database ver 7.00&#39;`&quot; -gt 0 ] \
 295                      &amp;&amp; [ &quot;`echo $TF | $GREP -c &#39;MSVC program database ver 7.00&#39;`&quot; -gt 0 ]
 296             then
 297                 # For Windows pdb files the file command reports some kind of size data
 298                 # which may sometimes come out randomly different.
 299                 continue
 300             else
 301                 if [ -z &quot;$found&quot; ]; then echo ; found=&quot;yes&quot;; fi
 302                 $PRINTF &quot;\tother: ${OF}\n\tthis : ${TF}\n&quot;
 303             fi
 304         fi
 305     done
 306     if [ -z &quot;$found&quot; ]; then
 307         echo &quot;Identical!&quot;
 308     else
 309         REGRESSIONS=true
 310     fi
 311 }
 312 
 313 ################################################################################
 314 # Compare the rest of the files
 315 
 316 compare_general_files() {
 317     THIS_DIR=$1
 318     OTHER_DIR=$2
 319     WORK_DIR=$3
 320 
 321     GENERAL_FILES=$(cd $THIS_DIR &amp;&amp; $FIND . -type f ! -name &quot;*.so&quot; ! -name &quot;*.jar&quot; \
 322         ! -name &quot;*.zip&quot; ! -name &quot;*.debuginfo&quot; ! -name &quot;*.dylib&quot; ! -name &quot;jexec&quot; \
 323         ! -name &quot;modules&quot; ! -name &quot;ct.sym&quot; ! -name &quot;*.diz&quot; ! -name &quot;*.dll&quot; \
 324         ! -name &quot;*.cpl&quot; ! -name &quot;*.pdb&quot; ! -name &quot;*.exp&quot; ! -name &quot;*.ilk&quot; \
 325         ! -name &quot;*.lib&quot; ! -name &quot;*.jmod&quot; ! -name &quot;*.exe&quot; \
 326         ! -name &quot;*.obj&quot; ! -name &quot;*.o&quot; ! -name &quot;jspawnhelper&quot; ! -name &quot;*.a&quot; \
 327         ! -name &quot;*.tar.gz&quot; ! -name &quot;*.jsa&quot; ! -name &quot;gtestLauncher&quot; \
 328         ! -name &quot;*.map&quot; \
 329         | $GREP -v &quot;./bin/&quot;  | $SORT | $FILTER)
 330 
 331     echo Other files with binary differences...
 332     for f in $GENERAL_FILES
 333     do
 334         # Skip all files in test/*/native
 335         if [[ &quot;$f&quot; == */native/* ]]; then
 336             continue
 337         fi
 338         if [ -e $OTHER_DIR/$f ]; then
 339             SUFFIX=&quot;${f##*.}&quot;
 340             if [ &quot;$(basename $f)&quot; = &quot;release&quot; ]; then
 341                 # In release file, ignore differences in source rev numbers
 342                 OTHER_FILE=$WORK_DIR/$f.other
 343                 THIS_FILE=$WORK_DIR/$f.this
 344                 $MKDIR -p $(dirname $OTHER_FILE)
 345                 $MKDIR -p $(dirname $THIS_FILE)
 346                 RELEASE_FILTER=&quot;$SED -e &#39;s/SOURCE=&quot;.*&quot;/SOURCE=&lt;src-rev&gt;/g&#39;&quot;
 347                 $CAT $OTHER_DIR/$f | eval &quot;$RELEASE_FILTER&quot; &gt; $OTHER_FILE
 348                 $CAT $THIS_DIR/$f  | eval &quot;$RELEASE_FILTER&quot; &gt; $THIS_FILE
 349             elif [ &quot;$SUFFIX&quot; = &quot;svg&quot; ]; then
 350                 # GraphViz has non-determinism when generating svg files
 351                 OTHER_FILE=$WORK_DIR/$f.other
 352                 THIS_FILE=$WORK_DIR/$f.this
 353                 $MKDIR -p $(dirname $OTHER_FILE) $(dirname $THIS_FILE)
 354                 SVG_FILTER=&quot;$SED \
 355                     -e &#39;s/edge[0-9][0-9]*/edgeX/g&#39;
 356                     &quot;
 357                 $CAT $OTHER_DIR/$f | eval &quot;$SVG_FILTER&quot; &gt; $OTHER_FILE
 358                 $CAT $THIS_DIR/$f | eval &quot;$SVG_FILTER&quot; &gt; $THIS_FILE
 359             elif [[ &quot;$f&quot; = *&quot;/lib/classlist&quot; ]] || [ &quot;$SUFFIX&quot; = &quot;jar_contents&quot; ]; then
 360                 # The classlist files may have some lines in random order
 361                 OTHER_FILE=$WORK_DIR/$f.other
 362                 THIS_FILE=$WORK_DIR/$f.this
 363                 $MKDIR -p $(dirname $OTHER_FILE) $(dirname $THIS_FILE)
 364                 $RM $OTHER_FILE $THIS_FILE
 365                 $CAT $OTHER_DIR/$f | $SORT &gt; $OTHER_FILE
 366                 $CAT $THIS_DIR/$f  | $SORT &gt; $THIS_FILE
 367             else
 368                 OTHER_FILE=$OTHER_DIR/$f
 369                 THIS_FILE=$THIS_DIR/$f
 370             fi
 371             DIFF_OUT=$($DIFF $OTHER_FILE $THIS_FILE 2&gt;&amp;1)
 372             if [ -n &quot;$DIFF_OUT&quot; ]; then
 373                 echo $f
 374                 REGRESSIONS=true
 375                 if [ &quot;$SHOW_DIFFS&quot; = &quot;true&quot; ]; then
 376                     echo &quot;$DIFF_OUT&quot;
 377                 fi
 378             fi
 379         fi
 380     done
 381 
 382 
 383 }
 384 
 385 ################################################################################
 386 # Compare zip file
 387 
 388 compare_zip_file() {
 389     THIS_DIR=$1
 390     OTHER_DIR=$2
 391     WORK_DIR=$3
 392     ZIP_FILE=$4
 393     # Optionally provide different name for other zipfile
 394     OTHER_ZIP_FILE=$5
 395 
 396     THIS_ZIP=$THIS_DIR/$ZIP_FILE
 397     if [ -n &quot;$OTHER_ZIP_FILE&quot; ]; then
 398         OTHER_ZIP=$OTHER_DIR/$OTHER_ZIP_FILE
 399     else
 400         OTHER_ZIP=$OTHER_DIR/$ZIP_FILE
 401     fi
 402 
 403     THIS_SUFFIX=&quot;${THIS_ZIP##*.}&quot;
 404     OTHER_SUFFIX=&quot;${OTHER_ZIP##*.}&quot;
 405     if [ &quot;$THIS_SUFFIX&quot; != &quot;$OTHER_SUFFIX&quot; ]; then
 406         echo &quot;The files do not have the same suffix type! ($THIS_SUFFIX != $OTHER_SUFFIX)&quot;
 407         return 2
 408     fi
 409 
 410     TYPE=&quot;$THIS_SUFFIX&quot;
 411 
 412     if $CMP $OTHER_ZIP $THIS_ZIP &gt; /dev/null
 413     then
 414         return 0
 415     fi
 416     # Not quite identical, the might still contain the same data.
 417     # Unpack the jar/zip files in temp dirs
 418 
 419     THIS_UNZIPDIR=$WORK_DIR/$ZIP_FILE.this
 420     OTHER_UNZIPDIR=$WORK_DIR/$ZIP_FILE.other
 421     $RM -rf $THIS_UNZIPDIR $OTHER_UNZIPDIR
 422     $MKDIR -p $THIS_UNZIPDIR
 423     $MKDIR -p $OTHER_UNZIPDIR
 424     if [ &quot;$TYPE&quot; = &quot;jar&quot; -o &quot;$TYPE&quot; = &quot;war&quot; -o &quot;$TYPE&quot; = &quot;zip&quot; ]
 425     then
 426         (cd $THIS_UNZIPDIR &amp;&amp; $UNARCHIVE $THIS_ZIP)
 427         (cd $OTHER_UNZIPDIR &amp;&amp; $UNARCHIVE $OTHER_ZIP)
 428     elif [ &quot;$TYPE&quot; = &quot;gz&quot; ]
 429     then
 430         (cd $THIS_UNZIPDIR &amp;&amp; $GUNZIP -c $THIS_ZIP | $TAR xf -)
 431         (cd $OTHER_UNZIPDIR &amp;&amp; $GUNZIP -c $OTHER_ZIP | $TAR xf -)
 432     elif [ &quot;$TYPE&quot; = &quot;jmod&quot; ]
 433     then
 434         (cd $THIS_UNZIPDIR &amp;&amp; $JMOD extract $THIS_ZIP)
 435         (cd $OTHER_UNZIPDIR &amp;&amp; $JMOD extract $OTHER_ZIP)
 436     else
 437         (cd $THIS_UNZIPDIR &amp;&amp; $JIMAGE extract $THIS_ZIP)
 438         (cd $OTHER_UNZIPDIR &amp;&amp; $JIMAGE extract $OTHER_ZIP)
 439     fi
 440 
 441     CONTENTS_DIFF_FILE=$WORK_DIR/$ZIP_FILE.diff
 442     $DIFF -rq $OTHER_UNZIPDIR $THIS_UNZIPDIR &gt; $CONTENTS_DIFF_FILE
 443 
 444     ONLY_OTHER=$($GREP &quot;^Only in $OTHER_UNZIPDIR&quot; $CONTENTS_DIFF_FILE)
 445     ONLY_THIS=$($GREP &quot;^Only in $THIS_UNZIPDIR&quot; $CONTENTS_DIFF_FILE)
 446 
 447     return_value=0
 448 
 449     if [ -n &quot;$ONLY_OTHER&quot; ]; then
 450         echo &quot;        Only OTHER $ZIP_FILE contains:&quot;
 451         echo &quot;$ONLY_OTHER&quot; | sed &quot;s|Only in $OTHER_UNZIPDIR|            |&quot;g | sed &#39;s|: |/|g&#39;
 452         return_value=1
 453     fi
 454 
 455     if [ -n &quot;$ONLY_THIS&quot; ]; then
 456         echo &quot;        Only THIS $ZIP_FILE contains:&quot;
 457         echo &quot;$ONLY_THIS&quot; | sed &quot;s|Only in $THIS_UNZIPDIR|            |&quot;g | sed &#39;s|: |/|g&#39;
 458         return_value=1
 459     fi
 460 
 461     if [ &quot;$CMP_ZIPS_CONTENTS&quot; = &quot;true&quot; ]; then
 462         DIFFING_FILES=$($GREP -e &quot;differ$&quot; $CONTENTS_DIFF_FILE \
 463             | $CUT -f 2 -d &#39; &#39; | $SED &quot;s|$OTHER_UNZIPDIR/||g&quot;)
 464 
 465         # Separate executable/library files from other files in zip.
 466         DIFFING_TEXT_FILES=
 467         DIFFING_EXEC_FILES=
 468         for file in $DIFFING_FILES; do
 469             SUFFIX=&quot;${file##*.}&quot;
 470             if [ &quot;$SUFFIX&quot; = &quot;exe&quot; -o &quot;$SUFFIX&quot; = &quot;dll&quot; -o &quot;$SUFFIX&quot; = &quot;so&quot; \
 471                  -o &quot;$SUFFIX&quot; = &quot;dylib&quot; ]; then
 472                 DIFFING_EXEC_FILES=&quot;$DIFFING_EXEC_FILES $file&quot;
 473             else
 474                 DIFFING_TEXT_FILES=&quot;$DIFFING_TEXT_FILES $file&quot;
 475             fi
 476         done
 477 
 478         $RM -f $WORK_DIR/$ZIP_FILE.diffs
 479         for file in $DIFFING_TEXT_FILES; do
 480             if [[ &quot;$ACCEPTED_JARZIP_CONTENTS $EXCEPTIONS&quot; != *&quot;$file&quot;* ]]; then
 481                 diff_text $OTHER_UNZIPDIR/$file $THIS_UNZIPDIR/$file &gt;&gt; $WORK_DIR/$ZIP_FILE.diffs
 482             fi
 483         done
 484 
 485         if [ -s &quot;$WORK_DIR/$ZIP_FILE.diffs&quot; ]; then
 486             return_value=1
 487             echo &quot;        Differing files in $ZIP_FILE&quot;
 488             $CAT $WORK_DIR/$ZIP_FILE.diffs | $GREP &#39;differ$&#39; | cut -f 2 -d &#39; &#39; | \
 489                 $SED &quot;s|$OTHER_UNZIPDIR|            |g&quot; &gt; $WORK_DIR/$ZIP_FILE.difflist
 490             $CAT $WORK_DIR/$ZIP_FILE.difflist
 491 
 492             if [ -n &quot;$SHOW_DIFFS&quot; ]; then
 493                 for i in $(cat $WORK_DIR/$ZIP_FILE.difflist) ; do
 494                     if [ -f &quot;${OTHER_UNZIPDIR}/$i.javap&quot; ]; then
 495                         $DIFF ${OTHER_UNZIPDIR}/$i.javap ${THIS_UNZIPDIR}/$i.javap
 496                     elif [ -f &quot;${OTHER_UNZIPDIR}/$i.cleaned&quot; ]; then
 497                         $DIFF ${OTHER_UNZIPDIR}/$i.cleaned ${THIS_UNZIPDIR}/$i
 498                     else
 499                         $DIFF ${OTHER_UNZIPDIR}/$i ${THIS_UNZIPDIR}/$i
 500                     fi
 501                 done
 502             fi
 503         fi
 504 
 505         # Use the compare_bin_file function for comparing the executable files.
 506         for file in $DIFFING_EXEC_FILES; do
 507             compare_bin_file $THIS_UNZIPDIR $OTHER_UNZIPDIR $WORK_DIR/$ZIP_FILE.bin \
 508                              $file
 509             if [ &quot;$?&quot; != &quot;0&quot; ]; then
 510                 return_value=1
 511             fi
 512         done
 513     fi
 514 
 515     return $return_value
 516 }
 517 
 518 ################################################################################
 519 # Compare jmod file
 520 
 521 compare_jmod_file() {
 522     THIS_DIR=$1
 523     OTHER_DIR=$2
 524     WORK_DIR=$3
 525     JMOD_FILE=$4
 526 
 527     THIS_JMOD=$THIS_DIR/$JMOD_FILE
 528     OTHER_JMOD=$OTHER_DIR/$JMOD_FILE
 529 
 530     if $CMP $OTHER_JMOD $THIS_JMOD &gt; /dev/null; then
 531         return 0
 532     fi
 533 
 534     THIS_JMOD_LIST=$WORK_DIR/$JMOD_FILE.list.this
 535     OTHER_JMOD_LIST=$WORK_DIR/$JMOD_FILE.list.other
 536     mkdir -p $(dirname $THIS_JMOD_LIST) $(dirname $OTHER_JMOD_LIST)
 537 
 538     $JMOD list $THIS_JMOD | sort &gt; $THIS_JMOD_LIST
 539     $JMOD list $OTHER_JMOD | sort &gt; $OTHER_JMOD_LIST
 540     JMOD_LIST_DIFF_FILE=$WORK_DIR/$JMOD_FILE.list.diff
 541     $DIFF $THIS_JMOD_LIST $OTHER_JMOD_LIST &gt; $JMOD_LIST_DIFF_FILE
 542 
 543     ONLY_THIS=$($GREP &quot;^&lt;&quot; $JMOD_LIST_DIFF_FILE)
 544     ONLY_OTHER=$($GREP &quot;^&gt;&quot; $JMOD_LIST_DIFF_FILE)
 545 
 546     if [ -n &quot;$ONLY_OTHER&quot; ]; then
 547         echo &quot;        Only OTHER $JMOD_FILE contains:&quot;
 548         echo &quot;$ONLY_OTHER&quot; | sed &quot;s|^&gt;|            |&quot;g | sed &#39;s|: |/|g&#39;
 549         return_value=1
 550     fi
 551 
 552     if [ -n &quot;$ONLY_THIS&quot; ]; then
 553         echo &quot;        Only THIS $JMOD_FILE contains:&quot;
 554         echo &quot;$ONLY_THIS&quot; | sed &quot;s|^&lt;|            |&quot;g | sed &#39;s|: |/|g&#39;
 555         return_value=1
 556     fi
 557 
 558     return $return_value
 559 }
 560 
 561 ################################################################################
 562 # Compare all zip files
 563 
 564 compare_all_zip_files() {
 565     THIS_DIR=$1
 566     OTHER_DIR=$2
 567     WORK_DIR=$3
 568 
 569     ZIPS=$(cd $THIS_DIR &amp;&amp; $FIND . -type f -name &quot;*.zip&quot; -o -name &quot;*.tar.gz&quot; \
 570         | $SORT | $FILTER )
 571 
 572     if [ -n &quot;$ZIPS&quot; ]; then
 573         echo Zip/tar.gz files...
 574 
 575         return_value=0
 576         for f in $ZIPS; do
 577             if [ -f &quot;$OTHER_DIR/$f&quot; ]; then
 578                 compare_zip_file $THIS_DIR $OTHER_DIR $WORK_DIR $f
 579                 if [ &quot;$?&quot; != &quot;0&quot; ]; then
 580                     return_value=1
 581                     REGRESSIONS=true
 582                 fi
 583             fi
 584         done
 585     fi
 586 
 587     return $return_value
 588 }
 589 
 590 ################################################################################
 591 # Compare all jmod files
 592 
 593 compare_all_jmod_files() {
 594     THIS_DIR=$1
 595     OTHER_DIR=$2
 596     WORK_DIR=$3
 597 
 598     JMODS=$(cd $THIS_DIR &amp;&amp; $FIND . -type f -name &quot;*.jmod&quot; | $SORT | $FILTER )
 599 
 600     if [ -n &quot;$JMODS&quot; ]; then
 601         echo Jmod files...
 602 
 603         return_value=0
 604         for f in $JMODS; do
 605             if [ -f &quot;$OTHER_DIR/$f&quot; ]; then
 606                 compare_jmod_file $THIS_DIR $OTHER_DIR $WORK_DIR $f
 607                 if [ &quot;$?&quot; != &quot;0&quot; ]; then
 608                     return_value=1
 609                     REGRESSIONS=true
 610                 fi
 611             fi
 612         done
 613     fi
 614 
 615     return $return_value
 616 }
 617 
 618 ################################################################################
 619 # Compare all jar files
 620 
 621 compare_all_jar_files() {
 622     THIS_DIR=$1
 623     OTHER_DIR=$2
 624     WORK_DIR=$3
 625 
 626     # TODO filter?
 627     ZIPS=$(cd $THIS_DIR &amp;&amp; $FIND . -type f -name &quot;*.jar&quot; -o -name &quot;*.war&quot; \
 628         -o -name &quot;modules&quot; | $SORT | $FILTER)
 629 
 630     if [ -n &quot;$ZIPS&quot; ]; then
 631         echo Jar files...
 632 
 633         return_value=0
 634         for f in $ZIPS; do
 635             if [ -f &quot;$OTHER_DIR/$f&quot; ]; then
 636                 compare_zip_file $THIS_DIR $OTHER_DIR $WORK_DIR $f
 637                 if [ &quot;$?&quot; != &quot;0&quot; ]; then
 638                     return_value=1
 639                     REGRESSIONS=true
 640                 fi
 641             fi
 642         done
 643     fi
 644 
 645     return $return_value
 646 }
 647 
 648 ################################################################################
 649 # Compare binary (executable/library) file
 650 
 651 compare_bin_file() {
 652     THIS_DIR=$1
 653     OTHER_DIR=$2
 654     WORK_DIR=$3
 655     BIN_FILE=$4
 656     OTHER_BIN_FILE=$5
 657 
 658     THIS_FILE=$THIS_DIR/$BIN_FILE
 659     if [ -n &quot;$OTHER_BIN_FILE&quot; ]; then
 660         OTHER_FILE=$OTHER_DIR/$OTHER_BIN_FILE
 661     else
 662         OTHER_FILE=$OTHER_DIR/$BIN_FILE
 663     fi
 664     NAME=$(basename $BIN_FILE)
 665     WORK_FILE_BASE=$WORK_DIR/$BIN_FILE
 666     FILE_WORK_DIR=$(dirname $WORK_FILE_BASE)
 667 
 668     $MKDIR -p $FILE_WORK_DIR
 669 
 670     # Make soft links to original files from work dir to facilitate debugging
 671     $LN -f -s $THIS_FILE $WORK_FILE_BASE.this
 672     $LN -f -s $OTHER_FILE $WORK_FILE_BASE.other
 673 
 674     ORIG_THIS_FILE=&quot;$THIS_FILE&quot;
 675     ORIG_OTHER_FILE=&quot;$OTHER_FILE&quot;
 676 
 677     if [ &quot;$STRIP_ALL&quot; = &quot;true&quot; ] || [[ &quot;$STRIP_BEFORE_COMPARE&quot; = *&quot;$BIN_FILE&quot;* ]]; then
 678         THIS_STRIPPED_FILE=$FILE_WORK_DIR/this/$NAME
 679         OTHER_STRIPPED_FILE=$FILE_WORK_DIR/other/$NAME
 680         $MKDIR -p $FILE_WORK_DIR/this $FILE_WORK_DIR/other
 681         $CP $THIS_FILE $THIS_STRIPPED_FILE
 682         $CP $OTHER_FILE $OTHER_STRIPPED_FILE
 683         $STRIP $THIS_STRIPPED_FILE
 684         $STRIP $OTHER_STRIPPED_FILE
 685         THIS_FILE=&quot;$THIS_STRIPPED_FILE&quot;
 686         OTHER_FILE=&quot;$OTHER_STRIPPED_FILE&quot;
 687     fi
 688 
 689     if [ &quot;$OPENJDK_TARGET_OS&quot; = &quot;windows&quot; ]; then
 690         unset _NT_SYMBOL_PATH
 691         if [ &quot;$(uname -o)&quot; = &quot;Cygwin&quot; ]; then
 692             THIS=$(cygpath -msa $THIS)
 693             OTHER=$(cygpath -msa $OTHER)
 694         fi
 695         # Build an _NT_SYMBOL_PATH that contains all known locations for
 696         # pdb files.
 697         PDB_DIRS=&quot;$(ls -d \
 698             {$OTHER,$THIS}/support/modules_{cmds,libs}/{*,*/*} \
 699             {$OTHER,$THIS}/support/native/jdk.incubator.jpackage/* \
 700             )&quot;
 701         export _NT_SYMBOL_PATH=&quot;$(echo $PDB_DIRS | tr &#39; &#39; &#39;;&#39;)&quot;
 702     fi
 703 
 704     if cmp $OTHER_FILE $THIS_FILE &gt; /dev/null; then
 705         # The files were bytewise identical.
 706         if [ -n &quot;$VERBOSE&quot; ]; then
 707             echo &quot;        :           :         :         :          :          : $BIN_FILE&quot;
 708         fi
 709         return 0
 710     fi
 711     if [ -z &quot;$SKIP_BIN_DIFF&quot; ]; then
 712         BIN_MSG=&quot; diff &quot;
 713         if [[ &quot;$ACCEPTED_BIN_DIFF&quot; != *&quot;$BIN_FILE&quot;* ]]; then
 714             DIFF_BIN=true
 715             if [[ &quot;$KNOWN_BIN_DIFF&quot; != *&quot;$BIN_FILE&quot;* ]]; then
 716                 BIN_MSG=&quot;*$BIN_MSG*&quot;
 717                 REGRESSIONS=true
 718             else
 719                 BIN_MSG=&quot; $BIN_MSG &quot;
 720             fi
 721         else
 722             BIN_MSG=&quot;($BIN_MSG)&quot;
 723             DIFF_BIN=
 724         fi
 725     else
 726         BIN_MSG=
 727         DIFF_BIN=
 728     fi
 729 
 730     if [ -n &quot;$STAT&quot; ]; then
 731         THIS_SIZE=$($STAT $STAT_PRINT_SIZE &quot;$THIS_FILE&quot;)
 732         OTHER_SIZE=$($STAT $STAT_PRINT_SIZE &quot;$OTHER_FILE&quot;)
 733     else
 734         THIS_SIZE=$(ls -l &quot;$THIS_FILE&quot; | awk &#39;{ print $5 }&#39;)
 735         OTHER_SIZE=$(ls -l &quot;$OTHER_FILE&quot; | awk &#39;{ print $5 }&#39;)
 736     fi
 737     if [ $THIS_SIZE -ne $OTHER_SIZE ]; then
 738         DIFF_SIZE_NUM=$($EXPR $THIS_SIZE - $OTHER_SIZE)
 739         DIFF_SIZE_REL=$($EXPR $THIS_SIZE \* 100 / $OTHER_SIZE)
 740         SIZE_MSG=$($PRINTF &quot;%3d%% %4d&quot; $DIFF_SIZE_REL $DIFF_SIZE_NUM)
 741         if [[ &quot;$ACCEPTED_SMALL_SIZE_DIFF&quot; = *&quot;$BIN_FILE&quot;* || &quot;$ACCEPTED_SMALL_SIZE_DIFF&quot; = &quot;true&quot; ]] \
 742             &amp;&amp; [ &quot;$DIFF_SIZE_REL&quot; -gt 98 ] \
 743             &amp;&amp; [ &quot;$DIFF_SIZE_REL&quot; -lt 102 ]; then
 744             SIZE_MSG=&quot;($SIZE_MSG)&quot;
 745             DIFF_SIZE=
 746         elif [ &quot;$OPENJDK_TARGET_OS&quot; = &quot;windows&quot; ] \
 747             &amp;&amp; [[ &quot;$ACCEPTED_SMALL_SIZE_DIFF&quot; = *&quot;$BIN_FILE&quot;* ]] \
 748             &amp;&amp; [ &quot;$DIFF_SIZE_NUM&quot; = 512 ]; then
 749             # On windows, size of binaries increase in 512 increments.
 750             SIZE_MSG=&quot;($SIZE_MSG)&quot;
 751             DIFF_SIZE=
 752         elif [ &quot;$OPENJDK_TARGET_OS&quot; = &quot;windows&quot; ] \
 753             &amp;&amp; [[ &quot;$ACCEPTED_SMALL_SIZE_DIFF&quot; = *&quot;$BIN_FILE&quot;* ]] \
 754             &amp;&amp; [ &quot;$DIFF_SIZE_NUM&quot; = -512 ]; then
 755             # On windows, size of binaries increase in 512 increments.
 756             SIZE_MSG=&quot;($SIZE_MSG)&quot;
 757             DIFF_SIZE=
 758         else
 759             if [[ &quot;$ACCEPTED_SIZE_DIFF&quot; != *&quot;$BIN_FILE&quot;* ]]; then
 760                 DIFF_SIZE=true
 761                 if [[ &quot;$KNOWN_SIZE_DIFF&quot; != *&quot;$BIN_FILE&quot;* ]]; then
 762                     SIZE_MSG=&quot;*$SIZE_MSG*&quot;
 763                     REGRESSIONS=true
 764                 else
 765                     SIZE_MSG=&quot; $SIZE_MSG &quot;
 766                 fi
 767             else
 768                 SIZE_MSG=&quot;($SIZE_MSG)&quot;
 769                 DIFF_SIZE=
 770             fi
 771         fi
 772     else
 773         SIZE_MSG=&quot;           &quot;
 774         DIFF_SIZE=
 775         if [[ &quot;$KNOWN_SIZE_DIFF $ACCEPTED_SIZE_DIFF&quot; = *&quot;$BIN_FILE&quot;* ]]; then
 776             SIZE_MSG=&quot;     !     &quot;
 777         fi
 778     fi
 779 
 780     if [ &quot;$SORT_ALL_SYMBOLS&quot; = &quot;true&quot; ] || [[ &quot;$SORT_SYMBOLS&quot; = *&quot;$BIN_FILE&quot;* ]]; then
 781         SYM_SORT_CMD=&quot;sort&quot;
 782     else
 783         SYM_SORT_CMD=&quot;cat&quot;
 784     fi
 785 
 786     if [ -n &quot;$SYMBOLS_DIFF_FILTER&quot; ] &amp;&amp; [ -z &quot;$NEED_SYMBOLS_DIFF_FILTER&quot; ] \
 787             || [[ &quot;$NEED_SYMBOLS_DIFF_FILTER&quot; = *&quot;$BIN_FILE&quot;* ]]; then
 788         this_SYMBOLS_DIFF_FILTER=&quot;$SYMBOLS_DIFF_FILTER&quot;
 789     else
 790         this_SYMBOLS_DIFF_FILTER=&quot;$CAT&quot;
 791     fi
 792 
 793     # Check symbols
 794     if [ &quot;$OPENJDK_TARGET_OS&quot; = &quot;windows&quot; ]; then
 795         # The output from dumpbin on windows differs depending on if the debug symbol
 796         # files are still around at the location the binary is pointing too. Need
 797         # to filter out that extra information.
 798         $DUMPBIN -exports $OTHER_FILE | $GREP  -E &#39;^ +[0-9A-F]+ +[0-9A-F]+ [0-9A-F]+&#39; | sed &#39;s/ = .*//g&#39; | cut -c27- | $SYM_SORT_CMD &gt; $WORK_FILE_BASE.symbols.other
 799         $DUMPBIN -exports $THIS_FILE  | $GREP  -E &#39;^ +[0-9A-F]+ +[0-9A-F]+ [0-9A-F]+&#39; | sed &#39;s/ = .*//g&#39; | cut -c27- | $SYM_SORT_CMD &gt; $WORK_FILE_BASE.symbols.this
 800     elif [ &quot;$OPENJDK_TARGET_OS&quot; = &quot;aix&quot; ]; then
 801         $OBJDUMP -T $ORIG_OTHER_FILE 2&gt; /dev/null | $GREP -v $NAME | $AWK &#39;{print $2, $3, $4, $5}&#39; | $SYM_SORT_CMD &gt; $WORK_FILE_BASE.symbols.other
 802         $OBJDUMP -T $ORIG_THIS_FILE  2&gt; /dev/null | $GREP -v $NAME | $AWK &#39;{print $2, $3, $4, $5}&#39; | $SYM_SORT_CMD &gt; $WORK_FILE_BASE.symbols.this
 803     elif [ &quot;$OPENJDK_TARGET_OS&quot; = &quot;macosx&quot; ]; then
 804         $NM -j $ORIG_OTHER_FILE 2&gt; /dev/null | $SYM_SORT_CMD &gt; $WORK_FILE_BASE.symbols.other
 805         $NM -j $ORIG_THIS_FILE  2&gt; /dev/null | $SYM_SORT_CMD &gt; $WORK_FILE_BASE.symbols.this
 806     else
 807         $NM -a $ORIG_OTHER_FILE 2&gt; /dev/null | $GREP -v $NAME \
 808             | $AWK &#39;{print $2, $3, $4, $5}&#39; \
 809             | eval &quot;$this_SYMBOLS_DIFF_FILTER&quot; \
 810             | $SYM_SORT_CMD \
 811             &gt; $WORK_FILE_BASE.symbols.other
 812         $NM -a $ORIG_THIS_FILE  2&gt; /dev/null | $GREP -v $NAME \
 813             | $AWK &#39;{print $2, $3, $4, $5}&#39; \
 814             | eval &quot;$this_SYMBOLS_DIFF_FILTER&quot; \
 815             | $SYM_SORT_CMD \
 816             &gt; $WORK_FILE_BASE.symbols.this
 817     fi
 818 
 819     $DIFF $WORK_FILE_BASE.symbols.other $WORK_FILE_BASE.symbols.this &gt; $WORK_FILE_BASE.symbols.diff
 820     if [ -s $WORK_FILE_BASE.symbols.diff ]; then
 821         SYM_MSG=&quot; diff  &quot;
 822         if [[ &quot;$ACCEPTED_SYM_DIFF&quot; != *&quot;$BIN_FILE&quot;* ]]; then
 823             DIFF_SYM=true
 824             if [[ &quot;$KNOWN_SYM_DIFF&quot; != *&quot;$BIN_FILE&quot;* ]]; then
 825                 SYM_MSG=&quot;*$SYM_MSG*&quot;
 826                 REGRESSIONS=true
 827             else
 828                 SYM_MSG=&quot; $SYM_MSG &quot;
 829             fi
 830         else
 831             SYM_MSG=&quot;($SYM_MSG)&quot;
 832             DIFF_SYM=
 833         fi
 834     else
 835         SYM_MSG=&quot;         &quot;
 836         DIFF_SYM=
 837         if [[ &quot;$KNOWN_SYM_DIFF $ACCEPTED_SYM_DIFF&quot; = *&quot;$BIN_FILE&quot;* ]]; then
 838             SYM_MSG=&quot;    !    &quot;
 839         fi
 840     fi
 841 
 842     # Check dependencies
 843     if [ -n &quot;$LDD_CMD&quot; ]; then
 844         if [ &quot;$OPENJDK_TARGET_OS&quot; = &quot;windows&quot; ]; then
 845             LDD_FILTER=&quot;$GREP \.dll&quot;
 846         else
 847             LDD_FILTER=&quot;$CAT&quot;
 848         fi
 849         (cd $FILE_WORK_DIR &amp;&amp; $CP $OTHER_FILE . &amp;&amp; $LDD_CMD $NAME 2&gt;/dev/null \
 850                     | $LDD_FILTER | $AWK &#39;{ print $1;}&#39; | $SORT \
 851                     | $TEE $WORK_FILE_BASE.deps.other \
 852                     | $UNIQ &gt; $WORK_FILE_BASE.deps.other.uniq)
 853         (cd $FILE_WORK_DIR &amp;&amp; $CP $THIS_FILE . &amp;&amp; $LDD_CMD $NAME 2&lt;/dev/null \
 854                     | $LDD_FILTER | $AWK &#39;{ print $1;}&#39; | $SORT \
 855                     | $TEE $WORK_FILE_BASE.deps.this \
 856                     | $UNIQ &gt; $WORK_FILE_BASE.deps.this.uniq)
 857         (cd $FILE_WORK_DIR &amp;&amp; $RM -f $NAME)
 858 
 859         $DIFF $WORK_FILE_BASE.deps.other $WORK_FILE_BASE.deps.this \
 860               &gt; $WORK_FILE_BASE.deps.diff
 861         $DIFF $WORK_FILE_BASE.deps.other.uniq $WORK_FILE_BASE.deps.this.uniq \
 862               &gt; $WORK_FILE_BASE.deps.diff.uniq
 863 
 864         if [ -s $WORK_FILE_BASE.deps.diff ]; then
 865             if [ -s $WORK_FILE_BASE.deps.diff.uniq ]; then
 866                 DEP_MSG=&quot; diff  &quot;
 867             else
 868                 DEP_MSG=&quot; redun &quot;
 869             fi
 870             if [[ &quot;$ACCEPTED_DEP_DIFF&quot; != *&quot;$BIN_FILE&quot;* ]]; then
 871                 DIFF_DEP=true
 872                 if [[ &quot;$KNOWN_DEP_DIFF&quot; != *&quot;$BIN_FILE&quot;* ]]; then
 873                     DEP_MSG=&quot;*$DEP_MSG*&quot;
 874                     REGRESSIONS=true
 875                 else
 876                     DEP_MSG=&quot; $DEP_MSG &quot;
 877                 fi
 878             else
 879                 DEP_MSG=&quot;($DEP_MSG)&quot;
 880                 DIFF_DEP=
 881             fi
 882         else
 883             DEP_MSG=&quot;         &quot;
 884             DIFF_DEP=
 885             if [[ &quot;$KNOWN_DEP_DIFF $ACCEPTED_DEP_DIFF&quot; = *&quot;$BIN_FILE&quot;* ]]; then
 886                 DEP_MSG=&quot;     !      &quot;
 887             fi
 888         fi
 889     else
 890         DEP_MSG=&quot;    -    &quot;
 891     fi
 892 
 893     # Some linux compilers add a unique Build ID
 894     if [ &quot;$OPENJDK_TARGET_OS&quot; = &quot;linux&quot; ]; then
 895       BUILD_ID_FILTER=&quot;$SED -r &#39;s/(Build ID:) [0-9a-f]{40}/\1/&#39;&quot;
 896     else
 897       BUILD_ID_FILTER=&quot;$CAT&quot;
 898     fi
 899 
 900     # Compare fulldump output
 901     if [ -n &quot;$FULLDUMP_CMD&quot; ] &amp;&amp; [ -z &quot;$SKIP_FULLDUMP_DIFF&quot; ]; then
 902         if [ -z &quot;$FULLDUMP_DIFF_FILTER&quot; ]; then
 903             FULLDUMP_DIFF_FILTER=&quot;$CAT&quot;
 904         fi
 905         $FULLDUMP_CMD $OTHER_FILE | eval &quot;$BUILD_ID_FILTER&quot; | eval &quot;$FULLDUMP_DIFF_FILTER&quot; \
 906             &gt; $WORK_FILE_BASE.fulldump.other 2&gt;&amp;1 &amp;
 907         $FULLDUMP_CMD $THIS_FILE  | eval &quot;$BUILD_ID_FILTER&quot; | eval &quot;$FULLDUMP_DIFF_FILTER&quot; \
 908             &gt; $WORK_FILE_BASE.fulldump.this  2&gt;&amp;1 &amp;
 909         wait
 910 
 911         $DIFF $WORK_FILE_BASE.fulldump.other $WORK_FILE_BASE.fulldump.this \
 912             &gt; $WORK_FILE_BASE.fulldump.diff
 913 
 914         if [ -s $WORK_FILE_BASE.fulldump.diff ]; then
 915             FULLDUMP_DIFF_SIZE=$(ls -n $WORK_FILE_BASE.fulldump.diff | awk &#39;{print $5}&#39;)
 916             FULLDUMP_MSG=$($PRINTF &quot;%8d&quot; $FULLDUMP_DIFF_SIZE)
 917             if [[ &quot;$ACCEPTED_FULLDUMP_DIFF&quot; != *&quot;$BIN_FILE&quot;* ]]; then
 918                 DIFF_FULLDUMP=true
 919                 if [[ &quot;$KNOWN_FULLDUMP_DIFF&quot; != *&quot;$BIN_FILE&quot;* ]]; then
 920                     FULLDUMP_MSG=&quot;*$FULLDUMP_MSG*&quot;
 921                     REGRESSIONS=true
 922                 else
 923                     FULLDUMP_MSG=&quot; $FULLDUMP_MSG &quot;
 924                 fi
 925             else
 926                 FULLDUMP_MSG=&quot;($FULLDUMP_MSG)&quot;
 927                 DIFF_FULLDUMP=
 928             fi
 929         else
 930             FULLDUMP_MSG=&quot;          &quot;
 931             DIFF_FULLDUMP=
 932             if [[ &quot;$KNOWN_FULLDUMP_DIFF $ACCEPTED_FULLDUMP_DIFF&quot; = *&quot;$BIN_FILE&quot;* ]]; then
 933                 FULLDUMP_MSG=&quot;    !    &quot;
 934             fi
 935         fi
 936     fi
 937 
 938     # Compare disassemble output
 939     if [ -n &quot;$DIS_CMD&quot; ] &amp;&amp; [ -z &quot;$SKIP_DIS_DIFF&quot; ]; then
 940         this_DIS_DIFF_FILTER=&quot;$CAT&quot;
 941         if [ -n &quot;$DIS_DIFF_FILTER&quot; ]; then
 942             if [ -z &quot;$NEED_DIS_DIFF_FILTER&quot; ] \
 943                 || [[ &quot;$NEED_DIS_DIFF_FILTER&quot; = *&quot;$BIN_FILE&quot;* ]]; then
 944                 this_DIS_DIFF_FILTER=&quot;$DIS_DIFF_FILTER&quot;
 945             fi
 946         fi
 947         if [ &quot;$OPENJDK_TARGET_OS&quot; = &quot;windows&quot; ]; then
 948             DIS_GREP_ARG=-a
 949         else
 950             DIS_GREP_ARG=
 951         fi
 952         $DIS_CMD $OTHER_FILE | $GREP $DIS_GREP_ARG -v $NAME \
 953             | eval &quot;$this_DIS_DIFF_FILTER&quot; &gt; $WORK_FILE_BASE.dis.other 2&gt;&amp;1 &amp;
 954         $DIS_CMD $THIS_FILE  | $GREP $DIS_GREP_ARG -v $NAME \
 955             | eval &quot;$this_DIS_DIFF_FILTER&quot; &gt; $WORK_FILE_BASE.dis.this  2&gt;&amp;1 &amp;
 956         wait
 957 
 958         $DIFF $WORK_FILE_BASE.dis.other $WORK_FILE_BASE.dis.this &gt; $WORK_FILE_BASE.dis.diff
 959 
 960         if [ -s $WORK_FILE_BASE.dis.diff ]; then
 961             DIS_DIFF_SIZE=$(ls -n $WORK_FILE_BASE.dis.diff | awk &#39;{print $5}&#39;)
 962             DIS_MSG=$($PRINTF &quot;%8d&quot; $DIS_DIFF_SIZE)
 963             if [[ &quot;$ACCEPTED_DIS_DIFF&quot; != *&quot;$BIN_FILE&quot;* ]]; then
 964                 DIFF_DIS=true
 965                 if [ &quot;$MAX_KNOWN_DIS_DIFF_SIZE&quot; = &quot;&quot; ]; then
 966                     MAX_KNOWN_DIS_DIFF_SIZE=&quot;0&quot;
 967                 fi
 968                 if [[ &quot;$KNOWN_DIS_DIFF&quot; = *&quot;$BIN_FILE&quot;* ]] \
 969                     &amp;&amp; [ &quot;$DIS_DIFF_SIZE&quot; -lt &quot;$MAX_KNOWN_DIS_DIFF_SIZE&quot; ]; then
 970                     DIS_MSG=&quot; $DIS_MSG &quot;
 971                 else
 972                     DIS_MSG=&quot;*$DIS_MSG*&quot;
 973                     REGRESSIONS=true
 974                 fi
 975             else
 976                 DIS_MSG=&quot;($DIS_MSG)&quot;
 977                 DIFF_DIS=
 978             fi
 979         else
 980             DIS_MSG=&quot;          &quot;
 981             DIFF_DIS=
 982             if [[ &quot;$KNOWN_DEP_DIFF $ACCEPTED_DEP_DIFF&quot; = *&quot;$BIN_FILE&quot;* ]]; then
 983                 DIS_MSG=&quot;    !    &quot;
 984             fi
 985         fi
 986     fi
 987 
 988 
 989     if [ -n &quot;$DIFF_BIN$DIFF_SIZE$DIFF_SYM$DIFF_DEP$DIFF_FULLDUMP$DIFF_DIS&quot; ] || [ -n &quot;$VERBOSE&quot; ]; then
 990         if [ -n &quot;$BIN_MSG&quot; ]; then echo -n &quot;$BIN_MSG:&quot;; fi
 991         if [ -n &quot;$SIZE_MSG&quot; ]; then echo -n &quot;$SIZE_MSG:&quot;; fi
 992         if [ -n &quot;$SYM_MSG&quot; ]; then echo -n &quot;$SYM_MSG:&quot;; fi
 993         if [ -n &quot;$DEP_MSG&quot; ]; then echo -n &quot;$DEP_MSG:&quot;; fi
 994         if [ -n &quot;$FULLDUMP_MSG&quot; ]; then echo -n &quot;$FULLDUMP_MSG:&quot;; fi
 995         if [ -n &quot;$DIS_MSG&quot; ]; then echo -n &quot;$DIS_MSG:&quot;; fi
 996         echo &quot; $BIN_FILE&quot;
 997         if [ &quot;$SHOW_DIFFS&quot; = &quot;true&quot; ]; then
 998             if [ -s &quot;$WORK_FILE_BASE.symbols.diff&quot; ]; then
 999                 echo &quot;Symbols diff:&quot;
1000                 $CAT $WORK_FILE_BASE.symbols.diff
1001             fi
1002             if [ -s &quot;$WORK_FILE_BASE.deps.diff&quot; ]; then
1003                 echo &quot;Deps diff:&quot;
1004                 $CAT $WORK_FILE_BASE.deps.diff
1005             fi
1006             if [ -s &quot;$WORK_FILE_BASE.fulldump.diff&quot; ]; then
1007                 echo &quot;Fulldump diff:&quot;
1008                 $CAT $WORK_FILE_BASE.fulldump.diff
1009             fi
1010             if [ -s &quot;$WORK_FILE_BASE.dis.diff&quot; ]; then
1011                 echo &quot;Disassembly diff:&quot;
1012                 $CAT $WORK_FILE_BASE.dis.diff
1013             fi
1014         fi
1015         return 1
1016     fi
1017     return 0
1018 }
1019 
1020 ################################################################################
1021 # Print binary diff header
1022 
1023 print_binary_diff_header() {
1024     if [ -z &quot;$SKIP_BIN_DIFF&quot; ]; then echo -n &quot; Binary :&quot;; fi
1025     if [ -z &quot;$SKIP_SIZE_DIFF&quot; ]; then echo -n &quot;   Size    :&quot;; fi
1026     if [ -z &quot;$SKIP_SYM_DIFF&quot; ]; then echo -n &quot; Symbols :&quot;; fi
1027     if [ -z &quot;$SKIP_DEP_DIFF&quot; ]; then echo -n &quot;  Deps   :&quot;; fi
1028     if [ -z &quot;$SKIP_FULLDUMP_DIFF&quot; ]; then echo -n &quot; Fulldump :&quot;; fi
1029     if [ -z &quot;$SKIP_DIS_DIFF&quot; ]; then echo -n &quot; Disass   :&quot;; fi
1030     echo
1031 }
1032 
1033 ################################################################################
1034 # Compare all libraries
1035 
1036 compare_all_libs() {
1037     THIS_DIR=$1
1038     OTHER_DIR=$2
1039     WORK_DIR=$3
1040 
1041     LIBS=$(cd $THIS_DIR &amp;&amp; $FIND . -type f \( -name &#39;lib*.so&#39; -o -name &#39;*.dylib&#39; \
1042         -o -name &#39;*.dll&#39; -o -name &#39;*.obj&#39; -o -name &#39;*.o&#39; -o -name &#39;*.a&#39; \
1043         -o -name &#39;*.cpl&#39; \) | $SORT | $FILTER)
1044 
1045     # On macos, filter out the dSYM debug symbols files as they are also
1046     # named *.dylib.
1047     if [ &quot;$OPENJDK_TARGET_OS&quot; = &quot;macosx&quot; ]; then
1048         LIBS=$(echo &quot;$LIBS&quot; | $GREP -v &#39;\.dSYM/&#39;)
1049     fi
1050 
1051     if [ -n &quot;$LIBS&quot; ]; then
1052         echo Libraries...
1053         print_binary_diff_header
1054         for l in $LIBS; do
1055             if [ -f &quot;$OTHER_DIR/$l&quot; ]; then
1056                 compare_bin_file $THIS_DIR $OTHER_DIR $WORK_DIR $l
1057                 if [ &quot;$?&quot; != &quot;0&quot; ]; then
1058                     return_value=1
1059                 fi
1060             fi
1061         done
1062     fi
1063 
1064     return $return_value
1065 }
1066 
1067 ################################################################################
1068 # Compare all executables
1069 
1070 compare_all_execs() {
1071     THIS_DIR=$1
1072     OTHER_DIR=$2
1073     WORK_DIR=$3
1074 
1075     if [ &quot;$OPENJDK_TARGET_OS&quot; = &quot;windows&quot; ]; then
1076         EXECS=$(cd $THIS_DIR &amp;&amp; $FIND . -type f -name &#39;*.exe&#39; | $SORT | $FILTER)
1077     else
1078         EXECS=$(cd $THIS_DIR &amp;&amp; $FIND . -name db -prune -o -type f -perm -100 \! \
1079             \( -name &#39;*.so&#39; -o -name &#39;*.dylib&#39; -o -name &#39;*.dll&#39; -o -name &#39;*.cgi&#39; \
1080             -o -name &#39;*.jar&#39; -o -name &#39;*.diz&#39; -o -name &#39;jcontrol&#39; -o -name &#39;*.properties&#39; \
1081             -o -name &#39;*.data&#39; -o -name &#39;*.bfc&#39; -o -name &#39;*.src&#39; -o -name &#39;*.txt&#39; \
1082             -o -name &#39;*.cfg&#39; -o -name &#39;meta-index&#39; -o -name &#39;*.properties.ja&#39; \
1083             -o -name &#39;*.xml&#39; -o -name &#39;*.html&#39; -o -name &#39;*.png&#39; -o -name &#39;README&#39; \
1084             -o -name &#39;*.zip&#39; -o -name &#39;*.jimage&#39; -o -name &#39;*.java&#39; -o -name &#39;*.mf&#39; \
1085             -o -name &#39;*.jpg&#39; -o -name &#39;*.wsdl&#39; -o -name &#39;*.js&#39; -o -name &#39;*.sh&#39; \
1086             -o -name &#39;*.bat&#39; -o -name &#39;*LICENSE&#39; -o -name &#39;*.d&#39; -o -name &#39;*store&#39; \
1087             -o -name &#39;blacklist&#39; -o -name &#39;*certs&#39; -o -name &#39;*.ttf&#39; \
1088             -o -name &#39;*.jfc&#39; -o -name &#39;*.dat&#39;  -o -name &#39;release&#39; -o -name &#39;*.dir&#39;\
1089             -o -name &#39;*.sym&#39; -o -name &#39;*.idl&#39; -o -name &#39;*.h&#39; -o -name &#39;*.access&#39; \
1090             -o -name &#39;*.template&#39; -o -name &#39;*.policy&#39; -o -name &#39;*.security&#39; \
1091             -o -name &#39;COPYRIGHT&#39; -o -name &#39;*.1&#39; -o -name &#39;*.debuginfo&#39; \
1092             -o -name &#39;classlist&#39; \) | $SORT | $FILTER)
1093     fi
1094 
1095     if [ -n &quot;$EXECS&quot; ]; then
1096         echo Executables...
1097         print_binary_diff_header
1098         for e in $EXECS; do
1099             if [ -f &quot;$OTHER_DIR/$e&quot; ]; then
1100                 compare_bin_file $THIS_DIR $OTHER_DIR $WORK_DIR $e
1101                 if [ &quot;$?&quot; != &quot;0&quot; ]; then
1102                     return_value=1
1103                 fi
1104             fi
1105         done
1106     fi
1107 
1108     return $return_value
1109 }
1110 
1111 ################################################################################
1112 # Initiate configuration
1113 
1114 THIS=&quot;$SCRIPT_DIR&quot;
1115 echo &quot;$THIS&quot;
1116 THIS_SCRIPT=&quot;$0&quot;
1117 
1118 if [ -z &quot;$1&quot; ] || [ &quot;$1&quot; = &quot;-h&quot; ] || [ &quot;$1&quot; = &quot;-?&quot; ] || [ &quot;$1&quot; = &quot;/h&quot; ] || [ &quot;$1&quot; = &quot;/?&quot; ] || [ &quot;$1&quot; = &quot;-help&quot; ] || [ &quot;$1&quot; = &quot;--help&quot; ]; then
1119     echo &quot;bash ./compare.sh [OPTIONS] [FILTER]&quot;
1120     echo &quot;&quot;
1121     echo &quot;-all                Compare all files in all known ways&quot;
1122     echo &quot;-names              Compare the file names and directory structure&quot;
1123     echo &quot;-perms              Compare the permission bits on all files and directories&quot;
1124     echo &quot;-types              Compare the output of the file command on all files&quot;
1125     echo &quot;-general            Compare the files not convered by the specialized comparisons&quot;
1126     echo &quot;-zips               Compare the contents of all zip files and files in them&quot;
1127     echo &quot;-zips-names         Compare the file names inside all zip files&quot;
1128     echo &quot;-jars               Compare the contents of all jar files&quot;
1129     echo &quot;-jmods              Compare the listings of all jmod files&quot;
1130     echo &quot;-libs               Compare all native libraries&quot;
1131     echo &quot;-execs              Compare all executables&quot;
1132     echo &quot;-v                  Verbose output, does not hide known differences&quot;
1133     echo &quot;-vv                 More verbose output, shows diff output of all comparisons&quot;
1134     echo &quot;-o [OTHER]          Compare with build in other directory. Will default to the old build directory&quot;
1135     echo &quot;&quot;
1136     echo &quot;--sort-symbols      Sort all symbols before comparing&quot;
1137     echo &quot;--strip             Strip all binaries before comparing&quot;
1138     echo &quot;--clean             Clean all previous comparison results first&quot;
1139     echo &quot;&quot;
1140     echo &quot;[FILTER]            List filenames in the image to compare, works for jars, zips, libs and execs&quot;
1141     echo &quot;Example:&quot;
1142     echo &quot;bash ./make/scripts/compareimages.sh CodePointIM.jar&quot;
1143     echo &quot;&quot;
1144     echo &quot;-2zips &lt;file1&gt; &lt;file2&gt; Compare two zip files only&quot;
1145     echo &quot;-2bins &lt;file1&gt; &lt;file2&gt; Compare two binary files only&quot;
1146     echo &quot;-2dirs &lt;dir1&gt; &lt;dir2&gt; Compare two directories as if they were images&quot;
1147     echo &quot;&quot;
1148     exit 10
1149 fi
1150 
1151 CMP_NAMES=false
1152 CMP_PERMS=false
1153 CMP_TYPES=false
1154 CMP_GENERAL=false
1155 CMP_ZIPS=false
1156 CMP_ZIPS_CONTENTS=true
1157 CMP_JARS=false
1158 CMP_JMODS=false
1159 CMP_LIBS=false
1160 CMP_EXECS=false
1161 
1162 while [ -n &quot;$1&quot; ]; do
1163     case &quot;$1&quot; in
1164         -v)
1165             VERBOSE=true
1166             ;;
1167         -vv)
1168             VERBOSE=true
1169             SHOW_DIFFS=true
1170             ;;
1171         -o)
1172             OTHER=&quot;$2&quot;
1173             shift
1174             ;;
1175         -all)
1176             CMP_NAMES=true
1177             if [ &quot;$OPENJDK_TARGET_OS&quot; != &quot;windows&quot; ]; then
1178                 CMP_PERMS=true
1179             fi
1180             CMP_TYPES=true
1181             CMP_GENERAL=true
1182             CMP_ZIPS=true
1183             CMP_JARS=true
1184             CMP_JMODS=true
1185             CMP_LIBS=true
1186             CMP_EXECS=true
1187             ;;
1188         -names)
1189             CMP_NAMES=true
1190             ;;
1191         -perms)
1192             CMP_PERMS=true
1193             ;;
1194         -types)
1195             CMP_TYPES=true
1196             ;;
1197         -general)
1198             CMP_GENERAL=true
1199             ;;
1200         -zips)
1201             CMP_ZIPS=true
1202             CMP_ZIPS_CONTENTS=true
1203             ;;
1204         -zips-names)
1205             CMP_ZIPS=true
1206             CMP_ZIPS_CONTENTS=false
1207             ;;
1208         -jars)
1209             CMP_JARS=true
1210             ;;
1211         -jmods)
1212             CMP_JMODS=true
1213             ;;
1214         -libs)
1215             CMP_LIBS=true
1216             ;;
1217         -execs)
1218             CMP_EXECS=true
1219             ;;
1220         -2dirs)
1221             THIS=&quot;$(cd &quot;$2&quot; &gt; /dev/null &amp;&amp; pwd )&quot;
1222             OTHER=&quot;$(cd &quot;$3&quot; &gt; /dev/null &amp;&amp; pwd )&quot;
1223             THIS_BASE_DIR=&quot;$THIS&quot;
1224             OTHER_BASE_DIR=&quot;$OTHER&quot;
1225             SKIP_DEFAULT=true
1226             shift
1227             shift
1228             ;;
1229         -2zips)
1230             CMP_2_ZIPS=true
1231             THIS_FILE=$2
1232             OTHER_FILE=$3
1233             shift
1234             shift
1235             ;;
1236         -2bins)
1237             CMP_2_BINS=true
1238             THIS_FILE=$2
1239             OTHER_FILE=$3
1240             shift
1241             shift
1242             ;;
1243         --sort-symbols)
1244             SORT_ALL_SYMBOLS=true
1245             ;;
1246         --strip)
1247             STRIP_ALL=true
1248             ;;
1249         --clean)
1250             CLEAN_OUTPUT=true
1251             ;;
1252         *)
1253             CMP_NAMES=false
1254             CMP_PERMS=false
1255             CMP_TYPES=false
1256             CMP_ZIPS=true
1257             CMP_JARS=true
1258             CMP_JMODS=true
1259             CMP_LIBS=true
1260             CMP_EXECS=true
1261 
1262             if [ -z &quot;$FILTER&quot; ]; then
1263                 FILTER=&quot;$GREP&quot;
1264             fi
1265             FILTER=&quot;$FILTER -e $1&quot;
1266             ;;
1267     esac
1268     shift
1269 done
1270 
1271 if [ &quot;$STRIP_ALL&quot; = &quot;true&quot; ] &amp;&amp; [ -z &quot;$STRIP&quot; ]; then
1272   echo Warning: Not stripping even with --strip, since strip is missing on this platform
1273   STRIP_ALL=false
1274 fi
1275 
1276 COMPARE_ROOT=$OUTPUTDIR/compare-support
1277 if [ &quot;$CLEAN_OUTPUT&quot; = &quot;true&quot; ]; then
1278     echo Cleaning old output in $COMPARE_ROOT.
1279     $RM -rf $COMPARE_ROOT
1280 fi
1281 $MKDIR -p $COMPARE_ROOT
1282 if [ &quot;$OPENJDK_TARGET_OS&quot; = &quot;windows&quot; ]; then
1283     if [ &quot;$(uname -o)&quot; = &quot;Cygwin&quot; ]; then
1284         COMPARE_ROOT=$(cygpath -msa $COMPARE_ROOT)
1285     fi
1286 fi
1287 
1288 if [ &quot;$CMP_2_ZIPS&quot; = &quot;true&quot; ]; then
1289     THIS_DIR=&quot;$(dirname $THIS_FILE)&quot;
1290     THIS_DIR=&quot;$(cd &quot;$THIS_DIR&quot; &gt; /dev/null &amp;&amp; pwd )&quot;
1291     OTHER_DIR=&quot;$(dirname $OTHER_FILE)&quot;
1292     OTHER_DIR=&quot;$(cd &quot;$OTHER_DIR&quot; &gt; /dev/null &amp;&amp; pwd )&quot;
1293     THIS_FILE_NAME=&quot;$(basename $THIS_FILE)&quot;
1294     OTHER_FILE_NAME=&quot;$(basename $OTHER_FILE)&quot;
1295     echo Comparing $THIS_DIR/$THIS_FILE_NAME and $OTHER_DIR/$OTHER_FILE_NAME
1296     compare_zip_file $THIS_DIR $OTHER_DIR $COMPARE_ROOT/2zips $THIS_FILE_NAME $OTHER_FILE_NAME
1297     exit
1298 fi
1299 
1300 if [ &quot;$CMP_2_BINS&quot; = &quot;true&quot; ]; then
1301     THIS_DIR=&quot;$(dirname $THIS_FILE)&quot;
1302     THIS_DIR=&quot;$(cd &quot;$THIS_DIR&quot; &gt; /dev/null &amp;&amp; pwd )&quot;
1303     OTHER_DIR=&quot;$(dirname $OTHER_FILE)&quot;
1304     OTHER_DIR=&quot;$(cd &quot;$OTHER_DIR&quot; &gt; /dev/null &amp;&amp; pwd )&quot;
1305     THIS_FILE_NAME=&quot;$(basename $THIS_FILE)&quot;
1306     OTHER_FILE_NAME=&quot;$(basename $OTHER_FILE)&quot;
1307     echo Comparing $THIS_DIR/$THIS_FILE_NAME and $OTHER_DIR/$OTHER_FILE_NAME
1308     compare_bin_file $THIS_DIR $OTHER_DIR $COMPARE_ROOT/2bins $THIS_FILE_NAME $OTHER_FILE_NAME
1309     exit
1310 fi
1311 
1312 if [ &quot;$CMP_NAMES&quot; = &quot;false&quot; ] \
1313        &amp;&amp; [ &quot;$CMP_TYPES&quot; = &quot;false&quot; ] \
1314        &amp;&amp; [ &quot;$CMP_PERMS&quot; = &quot;false&quot; ] \
1315        &amp;&amp; [ &quot;$CMP_GENERAL&quot; = &quot;false&quot; ] \
1316        &amp;&amp; [ &quot;$CMP_ZIPS&quot; = &quot;false&quot; ] \
1317        &amp;&amp; [ &quot;$CMP_JARS&quot; = &quot;false&quot; ] \
1318        &amp;&amp; [ &quot;$CMP_JMODS&quot; = &quot;false&quot; ] \
1319        &amp;&amp; [ &quot;$CMP_LIBS&quot; = &quot;false&quot; ] \
1320        &amp;&amp; [ &quot;$CMP_EXECS&quot; = &quot;false&quot; ]; then
1321     CMP_NAMES=true
1322     CMP_PERMS=true
1323     CMP_TYPES=true
1324     CMP_GENERAL=true
1325     CMP_ZIPS=true
1326     CMP_JARS=true
1327     CMP_JMODS=true
1328     CMP_LIBS=true
1329     CMP_EXECS=true
1330 fi
1331 
1332 if [ -z &quot;$FILTER&quot; ]; then
1333     FILTER=&quot;$CAT&quot;
1334 fi
1335 
1336 if [ &quot;$SKIP_DEFAULT&quot; != &quot;true&quot; ]; then
1337     if [ -z &quot;$OTHER&quot; ]; then
1338         echo &quot;Nothing to compare to, set with -o&quot;
1339         exit 1
1340     else
1341         if [ ! -d &quot;$OTHER&quot; ]; then
1342             echo &quot;Other build directory does not exist:&quot;
1343             echo &quot;$OTHER&quot;
1344             exit 1
1345         fi
1346         OTHER=&quot;$( cd &quot;$OTHER&quot; &gt; /dev/null &amp;&amp; pwd )&quot;
1347         echo &quot;Comparing to:&quot;
1348         echo &quot;$OTHER&quot;
1349         echo
1350     fi
1351 
1352     # Find the common images to compare, prioritizing later build stages
1353     if [ -d &quot;$THIS/images/jdk&quot; ] &amp;&amp; [ -d &quot;$OTHER/images/jdk&quot; ]; then
1354         THIS_JDK=&quot;$THIS/images/jdk&quot;
1355         OTHER_JDK=&quot;$OTHER/images/jdk&quot;
1356         echo &quot;Selecting normal images for JDK compare&quot;
1357     elif [ -d &quot;$(ls -d $THIS/licensee-src/build/*/images/jdk 2&gt; /dev/null)&quot; ] \
1358         &amp;&amp; [ -d &quot;$(ls -d $OTHER/licensee-src/build/*/images/jdk 2&gt; /dev/null)&quot; ]
1359     then
1360         echo &quot;Selecting licensee images for compare&quot;
1361         # Simply override the THIS and OTHER dir with the build dir from
1362         # the nested licensee source build for the rest of the script
1363         # execution.
1364         OLD_THIS=&quot;$THIS&quot;
1365         OLD_OTHER=&quot;$OTHER&quot;
1366         THIS=&quot;$(ls -d $THIS/licensee-src/build/*)&quot;
1367         OTHER=&quot;$(ls -d $OTHER/licensee-src/build/*)&quot;
1368         THIS_JDK=&quot;$THIS/images/jdk&quot;
1369         OTHER_JDK=&quot;$OTHER/images/jdk&quot;
1370         # Rewrite the path to tools that are used from the build
1371         JIMAGE=&quot;$(echo &quot;$JIMAGE&quot; | $SED &quot;s|$OLD_THIS|$THIS|g&quot;)&quot;
1372         JMOD=&quot;$(echo &quot;$JMOD&quot; | $SED &quot;s|$OLD_THIS|$THIS|g&quot;)&quot;
1373         JAVAP=&quot;$(echo &quot;$JAVAP&quot; | $SED &quot;s|$OLD_THIS|$THIS|g&quot;)&quot;
1374     else
1375         echo &quot;No common images found.&quot;
1376         exit 1
1377     fi
1378     echo &quot;  $THIS_JDK&quot;
1379     echo &quot;  $OTHER_JDK&quot;
1380 
1381     if [ -d &quot;$THIS/images/jdk-bundle&quot; -o -d &quot;$THIS/deploy/images/jdk-bundle&quot; ] \
1382              &amp;&amp; [ -d &quot;$OTHER/images/jdk-bundle&quot; -o -d &quot;$OTHER/deploy/images/jdk-bundle&quot; ]; then
1383         if [ -d &quot;$THIS/deploy/images/jdk-bundle&quot; ]; then
1384             THIS_JDK_BUNDLE=&quot;$THIS/deploy/images/jdk-bundle&quot;
1385         else
1386             THIS_JDK_BUNDLE=&quot;$THIS/images/jdk-bundle&quot;
1387         fi
1388         if [ -d &quot;$OTHER/deploy/images/jdk-bundle&quot; ]; then
1389             OTHER_JDK_BUNDLE=&quot;$OTHER/deploy/images/jdk-bundle&quot;
1390         else
1391             OTHER_JDK_BUNDLE=&quot;$OTHER/images/jdk-bundle&quot;
1392         fi
1393         echo &quot;Also comparing jdk macosx bundles&quot;
1394         echo &quot;  $THIS_JDK_BUNDLE&quot;
1395         echo &quot;  $OTHER_JDK_BUNDLE&quot;
1396     fi
1397 
1398     THIS_SEC_DIR=&quot;$THIS/images&quot;
1399     OTHER_SEC_DIR=&quot;$OTHER/images&quot;
1400     if [ -f &quot;$THIS_SEC_DIR/sec-bin.zip&quot; ] &amp;&amp; [ -f &quot;$OTHER_SEC_DIR/sec-bin.zip&quot; ]; then
1401         OTHER_SEC_BIN=&quot;$OTHER_SEC_DIR/sec-bin.zip&quot;
1402         THIS_SEC_BIN=&quot;$THIS_SEC_DIR/sec-bin.zip&quot;
1403         if [ &quot;$OPENJDK_TARGET_OS&quot; = &quot;windows&quot; ]; then
1404             if [ &quot;$OPENJDK_TARGET_CPU&quot; = &quot;x86_64&quot; ]; then
1405                 JGSS_WINDOWS_BIN=&quot;jgss-windows-x64-bin.zip&quot;
1406             else
1407                 JGSS_WINDOWS_BIN=&quot;jgss-windows-i586-bin.zip&quot;
1408             fi
1409             OTHER_SEC_WINDOWS_BIN=&quot;$OTHER_SEC_DIR/sec-windows-bin.zip&quot;
1410             OTHER_JGSS_WINDOWS_BIN=&quot;$OTHER_SEC_DIR/$JGSS_WINDOWS_BIN&quot;
1411             THIS_SEC_WINDOWS_BIN=&quot;$THIS_SEC_DIR/sec-windows-bin.zip&quot;
1412             THIS_JGSS_WINDOWS_BIN=&quot;$THIS_SEC_DIR/$JGSS_WINDOWS_BIN&quot;
1413         fi
1414     fi
1415 
1416     if [ -d &quot;$THIS/images/docs&quot; ] &amp;&amp; [ -d &quot;$OTHER/images/docs&quot; ]; then
1417         THIS_DOCS=&quot;$THIS/images/docs&quot;
1418         OTHER_DOCS=&quot;$OTHER/images/docs&quot;
1419         echo &quot;Also comparing docs&quot;
1420     else
1421         echo &quot;WARNING! Docs haven&#39;t been built and won&#39;t be compared.&quot;
1422     fi
1423 
1424     if [ -d &quot;$THIS/images/test&quot; ] &amp;&amp; [ -d &quot;$OTHER/images/test&quot; ]; then
1425         THIS_TEST=&quot;$THIS/images/test&quot;
1426         OTHER_TEST=&quot;$OTHER/images/test&quot;
1427         echo &quot;Also comparing test image&quot;
1428     else
1429         echo &quot;WARNING! Test haven&#39;t been built and won&#39;t be compared.&quot;
1430     fi
1431 fi
1432 
1433 ################################################################################
1434 # Do the work
1435 
1436 if [ &quot;$CMP_NAMES&quot; = &quot;true&quot; ]; then
1437     if [ -n &quot;$THIS_JDK&quot; ] &amp;&amp; [ -n &quot;$OTHER_JDK&quot; ]; then
1438         echo -n &quot;JDK &quot;
1439         compare_dirs $THIS_JDK $OTHER_JDK $COMPARE_ROOT/jdk
1440         echo -n &quot;JDK &quot;
1441         compare_files $THIS_JDK $OTHER_JDK $COMPARE_ROOT/jdk
1442     fi
1443     if [ -n &quot;$THIS_JDK_BUNDLE&quot; ] &amp;&amp; [ -n &quot;$OTHER_JDK_BUNDLE&quot; ]; then
1444         echo -n &quot;JDK Bundle &quot;
1445         compare_dirs $THIS_JDK_BUNDLE $OTHER_JDK_BUNDLE $COMPARE_ROOT/jdk-bundle
1446 
1447         echo -n &quot;JDK Bundle &quot;
1448         compare_files $THIS_JDK_BUNDLE $OTHER_JDK_BUNDLE $COMPARE_ROOT/jdk-bundle
1449     fi
1450     if [ -n &quot;$THIS_DOCS&quot; ] &amp;&amp; [ -n &quot;$OTHER_DOCS&quot; ]; then
1451         echo -n &quot;Docs &quot;
1452         compare_dirs $THIS_DOCS $OTHER_DOCS $COMPARE_ROOT/docs
1453         echo -n &quot;Docs &quot;
1454         compare_files $THIS_DOCS $OTHER_DOCS $COMPARE_ROOT/docs
1455     fi
1456     if [ -n &quot;$THIS_TEST&quot; ] &amp;&amp; [ -n &quot;$OTHER_TEST&quot; ]; then
1457         echo -n &quot;Test &quot;
1458         compare_dirs $THIS_TEST $OTHER_TEST $COMPARE_ROOT/test
1459         echo -n &quot;Test &quot;
1460         compare_files $THIS_TEST $OTHER_TEST $COMPARE_ROOT/test
1461     fi
1462     if [ -n &quot;$THIS_BASE_DIR&quot; ] &amp;&amp; [ -n &quot;$OTHER_BASE_DIR&quot; ]; then
1463         compare_dirs $THIS_BASE_DIR $OTHER_BASE_DIR $COMPARE_ROOT/base_dir
1464         compare_files $THIS_BASE_DIR $OTHER_BASE_DIR $COMPARE_ROOT/base_dir
1465     fi
1466 fi
1467 
1468 if [ &quot;$CMP_LIBS&quot; = &quot;true&quot; ]; then
1469     if [ -n &quot;$THIS_JDK&quot; ] &amp;&amp; [ -n &quot;$OTHER_JDK&quot; ]; then
1470         echo -n &quot;JDK &quot;
1471         compare_all_libs $THIS_JDK $OTHER_JDK $COMPARE_ROOT/jdk
1472     fi
1473     if [ -n &quot;$THIS_TEST&quot; ] &amp;&amp; [ -n &quot;$OTHER_TEST&quot; ]; then
1474         echo -n &quot;Test &quot;
1475         STRIP_ALL_bak=&quot;$STRIP_ALL&quot;
1476         if [ &quot;$STRIP_TESTS_BEFORE_COMPARE&quot; = &quot;true&quot; ]; then
1477           STRIP_ALL=&quot;true&quot;
1478         fi
1479         compare_all_libs $THIS_TEST $OTHER_TEST $COMPARE_ROOT/test
1480         STRIP_ALL=&quot;$STRIP_ALL_bak&quot;
1481     fi
1482     if [ -n &quot;$THIS_BASE_DIR&quot; ] &amp;&amp; [ -n &quot;$OTHER_BASE_DIR&quot; ]; then
1483         compare_all_libs $THIS_BASE_DIR $OTHER_BASE_DIR $COMPARE_ROOT/base_dir
1484     fi
1485 fi
1486 
1487 if [ &quot;$CMP_EXECS&quot; = &quot;true&quot; ]; then
1488     if [ -n &quot;$THIS_JDK&quot; ] &amp;&amp; [ -n &quot;$OTHER_JDK&quot; ]; then
1489         echo -n &quot;JDK &quot;
1490         compare_all_execs $THIS_JDK $OTHER_JDK $COMPARE_ROOT/jdk
1491     fi
1492     if [ -n &quot;$THIS_TEST&quot; ] &amp;&amp; [ -n &quot;$OTHER_TEST&quot; ]; then
1493         echo -n &quot;Test &quot;
1494         STRIP_ALL_bak=&quot;$STRIP_ALL&quot;
1495         if [ &quot;$STRIP_TESTS_BEFORE_COMPARE&quot; = &quot;true&quot; ]; then
1496           STRIP_ALL=&quot;true&quot;
1497         fi
1498         compare_all_execs $THIS_TEST $OTHER_TEST $COMPARE_ROOT/test
1499         STRIP_ALL=&quot;$STRIP_ALL_bak&quot;
1500     fi
1501     if [ -n &quot;$THIS_BASE_DIR&quot; ] &amp;&amp; [ -n &quot;$OTHER_BASE_DIR&quot; ]; then
1502         compare_all_execs $THIS_BASE_DIR $OTHER_BASE_DIR $COMPARE_ROOT/base_dir
1503     fi
1504 fi
1505 
1506 if [ &quot;$CMP_GENERAL&quot; = &quot;true&quot; ]; then
1507     if [ -n &quot;$THIS_JDK&quot; ] &amp;&amp; [ -n &quot;$OTHER_JDK&quot; ]; then
1508         echo -n &quot;JDK &quot;
1509         compare_general_files $THIS_JDK $OTHER_JDK $COMPARE_ROOT/jdk
1510     fi
1511     if [ -n &quot;$THIS_JDK_BUNDLE&quot; ] &amp;&amp; [ -n &quot;$OTHER_JDK_BUNDLE&quot; ]; then
1512         echo -n &quot;JDK Bundle &quot;
1513         compare_general_files $THIS_JDK_BUNDLE $OTHER_JDK_BUNDLE $COMPARE_ROOT/jdk-bundle
1514     fi
1515     if [ -n &quot;$THIS_DOCS&quot; ] &amp;&amp; [ -n &quot;$OTHER_DOCS&quot; ]; then
1516         echo -n &quot;Docs &quot;
1517         compare_general_files $THIS_DOCS $OTHER_DOCS $COMPARE_ROOT/docs
1518     fi
1519     if [ -n &quot;$THIS_TEST&quot; ] &amp;&amp; [ -n &quot;$OTHER_TEST&quot; ]; then
1520         echo -n &quot;Test &quot;
1521         compare_general_files $THIS_TEST $OTHER_TEST $COMPARE_ROOT/test
1522     fi
1523     if [ -n &quot;$THIS_BASE_DIR&quot; ] &amp;&amp; [ -n &quot;$OTHER_BASE_DIR&quot; ]; then
1524         compare_general_files $THIS_BASE_DIR $OTHER_BASE_DIR $COMPARE_ROOT/base_dir
1525     fi
1526 fi
1527 
1528 if [ &quot;$CMP_ZIPS&quot; = &quot;true&quot; ]; then
1529     if [ -n &quot;$THIS_JDK&quot; ] &amp;&amp; [ -n &quot;$OTHER_JDK&quot; ]; then
1530         echo -n &quot;JDK &quot;
1531         compare_all_zip_files $THIS_JDK $OTHER_JDK $COMPARE_ROOT/jdk
1532     fi
1533     if [ -n &quot;$THIS_TEST&quot; ] &amp;&amp; [ -n &quot;$OTHER_TEST&quot; ]; then
1534         echo -n &quot;Test &quot;
1535         compare_all_zip_files $THIS_TEST $OTHER_TEST $COMPARE_ROOT/test
1536     fi
1537     if [ -n &quot;$THIS_SEC_BIN&quot; ] &amp;&amp; [ -n &quot;$OTHER_SEC_BIN&quot; ]; then
1538         if [ -n &quot;$(echo $THIS_SEC_BIN | $FILTER)&quot; ]; then
1539             echo &quot;sec-bin.zip...&quot;
1540             compare_zip_file $THIS_SEC_DIR $OTHER_SEC_DIR $COMPARE_ROOT/sec-bin sec-bin.zip
1541         fi
1542     fi
1543     if [ -n &quot;$THIS_SEC_WINDOWS_BIN&quot; ] &amp;&amp; [ -n &quot;$OTHER_SEC_WINDOWS_BIN&quot; ]; then
1544         if [ -n &quot;$(echo $THIS_SEC_WINDOWS_BIN | $FILTER)&quot; ]; then
1545             echo &quot;sec-windows-bin.zip...&quot;
1546             compare_zip_file $THIS_SEC_DIR $OTHER_SEC_DIR $COMPARE_ROOT/sec-bin sec-windows-bin.zip
1547         fi
1548     fi
1549     if [ -n &quot;$THIS_JGSS_WINDOWS_BIN&quot; ] &amp;&amp; [ -n &quot;$OTHER_JGSS_WINDOWS_BIN&quot; ]; then
1550         if [ -n &quot;$(echo $THIS_JGSS_WINDOWS_BIN | $FILTER)&quot; ]; then
1551             echo &quot;$JGSS_WINDOWS_BIN...&quot;
1552             compare_zip_file $THIS_SEC_DIR $OTHER_SEC_DIR $COMPARE_ROOT/sec-bin $JGSS_WINDOWS_BIN
1553         fi
1554     fi
1555     if [ -n &quot;$THIS_BASE_DIR&quot; ] &amp;&amp; [ -n &quot;$OTHER_BASE_DIR&quot; ]; then
1556         compare_all_zip_files $THIS_BASE_DIR $OTHER_BASE_DIR $COMPARE_ROOT/base_dir
1557     fi
1558 fi
1559 
1560 if [ &quot;$CMP_JARS&quot; = &quot;true&quot; ]; then
1561     if [ -n &quot;$THIS_JDK&quot; ] &amp;&amp; [ -n &quot;$OTHER_JDK&quot; ]; then
1562         echo -n &quot;JDK &quot;
1563         compare_all_jar_files $THIS_JDK $OTHER_JDK $COMPARE_ROOT/jdk
1564     fi
1565     if [ -n &quot;$THIS_TEST&quot; ] &amp;&amp; [ -n &quot;$OTHER_TEST&quot; ]; then
1566         echo -n &quot;Test &quot;
1567         compare_all_jar_files $THIS_TEST $OTHER_TEST $COMPARE_ROOT/test
1568     fi
1569     if [ -n &quot;$THIS_BASE_DIR&quot; ] &amp;&amp; [ -n &quot;$OTHER_BASE_DIR&quot; ]; then
1570         compare_all_jar_files $THIS_BASE_DIR $OTHER_BASE_DIR $COMPARE_ROOT/base_dir
1571     fi
1572 fi
1573 
1574 if [ &quot;$CMP_JMODS&quot; = &quot;true&quot; ]; then
1575     if [ -n &quot;$THIS_JDK&quot; ] &amp;&amp; [ -n &quot;$OTHER_JDK&quot; ]; then
1576         compare_all_jmod_files $THIS_JDK $OTHER_JDK $COMPARE_ROOT/jdk
1577     fi
1578     if [ -n &quot;$THIS_BASE_DIR&quot; ] &amp;&amp; [ -n &quot;$OTHER_BASE_DIR&quot; ]; then
1579         compare_all_jmod_files $THIS_BASE_DIR $OTHER_BASE_DIR $COMPARE_ROOT/base_dir
1580     fi
1581 fi
1582 
1583 if [ &quot;$CMP_PERMS&quot; = &quot;true&quot; ]; then
1584     if [ -n &quot;$THIS_JDK&quot; ] &amp;&amp; [ -n &quot;$OTHER_JDK&quot; ]; then
1585         echo -n &quot;JDK &quot;
1586         compare_permissions $THIS_JDK $OTHER_JDK $COMPARE_ROOT/jdk
1587     fi
1588     if [ -n &quot;$THIS_BASE_DIR&quot; ] &amp;&amp; [ -n &quot;$OTHER_BASE_DIR&quot; ]; then
1589         compare_permissions $THIS_BASE_DIR $OTHER_BASE_DIR $COMPARE_ROOT/base_dir
1590     fi
1591 fi
1592 
1593 if [ &quot;$CMP_TYPES&quot; = &quot;true&quot; ]; then
1594     if [ -n &quot;$THIS_JDK&quot; ] &amp;&amp; [ -n &quot;$OTHER_JDK&quot; ]; then
1595         echo -n &quot;JDK &quot;
1596         compare_file_types $THIS_JDK $OTHER_JDK $COMPARE_ROOT/jdk
1597     fi
1598     if [ -n &quot;$THIS_JDK_BUNDLE&quot; ] &amp;&amp; [ -n &quot;$OTHER_JDK_BUNDLE&quot; ]; then
1599         echo -n &quot;JDK Bundle &quot;
1600         compare_file_types $THIS_JDK_BUNDLE $OTHER_JDK_BUNDLE $COMPARE_ROOT/jdk-bundle
1601     fi
1602     if [ -n &quot;$THIS_TEST&quot; ] &amp;&amp; [ -n &quot;$OTHER_TEST&quot; ]; then
1603         echo -n &quot;Test &quot;
1604         compare_file_types $THIS_JDK $OTHER_JDK $COMPARE_ROOT/jdk
1605     fi
1606     if [ -n &quot;$THIS_BASE_DIR&quot; ] &amp;&amp; [ -n &quot;$OTHER_BASE_DIR&quot; ]; then
1607         compare_file_types $THIS_BASE_DIR $OTHER_BASE_DIR $COMPARE_ROOT/base_dir
1608     fi
1609 fi
1610 
1611 echo
1612 
1613 if [ -n &quot;$REGRESSIONS&quot; ]; then
1614     echo &quot;REGRESSIONS FOUND!&quot;
1615     echo
1616     exit 1
1617 else
1618     echo &quot;No regressions found&quot;
1619     echo
1620     exit 0
1621 fi
    </pre>
  </body>
</html>