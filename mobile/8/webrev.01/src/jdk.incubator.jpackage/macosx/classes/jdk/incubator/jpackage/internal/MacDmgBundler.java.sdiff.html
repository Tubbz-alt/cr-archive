<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.incubator.jpackage/macosx/classes/jdk/incubator/jpackage/internal/MacDmgBundler.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../../jdk.accessibility/windows/native/jaccesswalker/jaccesswalkerWindow.rc.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../jdk.internal.vm.ci/share/classes/jdk.vm.ci.hotspot/src/jdk/vm/ci/hotspot/HandleCleaner.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.incubator.jpackage/macosx/classes/jdk/incubator/jpackage/internal/MacDmgBundler.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 74         Log.verbose(MessageFormat.format(I18N.getString(&quot;message.building-dmg&quot;),
 75                 APP_NAME.fetchFrom(params)));
 76 
 77         IOUtils.writableOutputDir(outdir.toPath());
 78 
 79         try {
 80             File appLocation = prepareAppBundle(params);
 81 
 82             if (appLocation != null &amp;&amp; prepareConfigFiles(params)) {
 83                 File configScript = getConfig_Script(params);
 84                 if (configScript.exists()) {
 85                     Log.verbose(MessageFormat.format(
 86                             I18N.getString(&quot;message.running-script&quot;),
 87                             configScript.getAbsolutePath()));
 88                     IOUtils.run(&quot;bash&quot;, configScript);
 89                 }
 90 
 91                 return buildDMG(params, appLocation, outdir);
 92             }
 93             return null;
<span class="line-modified"> 94         } catch (IOException ex) {</span>
 95             Log.verbose(ex);
 96             throw new PackagerException(ex);
 97         }
 98     }
 99 
100     private static final String hdiutil = &quot;/usr/bin/hdiutil&quot;;
101 
102     private void prepareDMGSetupScript(Map&lt;String, ? super Object&gt; params)
103                                                                     throws IOException {
104         File dmgSetup = getConfig_VolumeScript(params);
105         Log.verbose(MessageFormat.format(
106                 I18N.getString(&quot;message.preparing-dmg-setup&quot;),
107                 dmgSetup.getAbsolutePath()));
108 
109         // We need to use URL for DMG to find it. We cannot use volume name, since
110         // user might have open DMG with same volume name already. Url should end with
111         // &#39;/&#39; and it should be real path (no symbolic links).
112         File imageDir = IMAGES_ROOT.fetchFrom(params);
113         if (!imageDir.exists()) imageDir.mkdirs(); // Create it, since it does not exist
114         Path rootPath = Path.of(imageDir.toString()).toRealPath();
</pre>
<hr />
<pre>
245 
246         // generic find attempt
247         try {
248             ProcessBuilder pb = new ProcessBuilder(&quot;xcrun&quot;, &quot;-find&quot;, &quot;SetFile&quot;);
249             Process p = pb.start();
250             InputStreamReader isr = new InputStreamReader(p.getInputStream());
251             BufferedReader br = new BufferedReader(isr);
252             String lineRead = br.readLine();
253             if (lineRead != null) {
254                 File f = new File(lineRead);
255                 if (f.exists() &amp;&amp; f.canExecute()) {
256                     return f.getAbsolutePath();
257                 }
258             }
259         } catch (IOException ignored) {}
260 
261         return null;
262     }
263 
264     private File buildDMG( Map&lt;String, ? super Object&gt; params,
<span class="line-modified">265             File appLocation, File outdir) throws IOException {</span>

266         File imagesRoot = IMAGES_ROOT.fetchFrom(params);
267         if (!imagesRoot.exists()) imagesRoot.mkdirs();
268 
269         File protoDMG = new File(imagesRoot,
270                 APP_NAME.fetchFrom(params) +&quot;-tmp.dmg&quot;);
271         File finalDMG = new File(outdir, INSTALLER_NAME.fetchFrom(params)
272                 + INSTALLER_SUFFIX.fetchFrom(params) + &quot;.dmg&quot;);
273 
274         File srcFolder = APP_IMAGE_TEMP_ROOT.fetchFrom(params);
275         File predefinedImage =
276                 StandardBundlerParam.getPredefinedAppImage(params);
277         if (predefinedImage != null) {
278             srcFolder = predefinedImage;
279         } else if (StandardBundlerParam.isRuntimeInstaller(params)) {
280             Path newRoot = Files.createTempDirectory(
281                 TEMP_ROOT.fetchFrom(params).toPath(), &quot;root-&quot;);
282 
283             // first, is this already a runtime with
284             // &lt;runtime&gt;/Contents/Home - if so we need the Home dir
285             Path original = appLocation.toPath();
</pre>
<hr />
<pre>
305                     &quot;message.dmg-cannot-be-overwritten&quot;),
306                     finalDMG.getAbsolutePath()));
307         }
308 
309         protoDMG.getParentFile().mkdirs();
310         finalDMG.getParentFile().mkdirs();
311 
312         String hdiUtilVerbosityFlag = VERBOSE.fetchFrom(params) ?
313                 &quot;-verbose&quot; : &quot;-quiet&quot;;
314 
315         // create temp image
316         ProcessBuilder pb = new ProcessBuilder(
317                 hdiutil,
318                 &quot;create&quot;,
319                 hdiUtilVerbosityFlag,
320                 &quot;-srcfolder&quot;, srcFolder.getAbsolutePath(),
321                 &quot;-volname&quot;, APP_NAME.fetchFrom(params),
322                 &quot;-ov&quot;, protoDMG.getAbsolutePath(),
323                 &quot;-fs&quot;, &quot;HFS+&quot;,
324                 &quot;-format&quot;, &quot;UDRW&quot;);
<span class="line-modified">325         IOUtils.exec(pb);</span>
























326 
327         // mount temp image
328         pb = new ProcessBuilder(
329                 hdiutil,
330                 &quot;attach&quot;,
331                 protoDMG.getAbsolutePath(),
332                 hdiUtilVerbosityFlag,
333                 &quot;-mountroot&quot;, imagesRoot.getAbsolutePath());
334         IOUtils.exec(pb, false, null, true);
335 
336         File mountedRoot = new File(imagesRoot.getAbsolutePath(),
337                     APP_NAME.fetchFrom(params));

















338         try {
339             // background image
340             File bgdir = new File(mountedRoot, BACKGROUND_IMAGE_FOLDER);
341             bgdir.mkdirs();
342             IOUtils.copyFile(getConfig_VolumeBackground(params),
343                     new File(bgdir, BACKGROUND_IMAGE));
344 
345             // We will not consider setting background image and creating link
346             // to install-dir in DMG as critical error, since it can fail in
347             // headless enviroment.
348             try {
349                 pb = new ProcessBuilder(&quot;osascript&quot;,
350                         getConfig_VolumeScript(params).getAbsolutePath());
351                 IOUtils.exec(pb);
352             } catch (IOException ex) {
353                 Log.verbose(ex);
354             }
355 
356             // volume icon
357             File volumeIconFile = new File(mountedRoot, &quot;.VolumeIcon.icns&quot;);
</pre>
</td>
<td>
<hr />
<pre>
 74         Log.verbose(MessageFormat.format(I18N.getString(&quot;message.building-dmg&quot;),
 75                 APP_NAME.fetchFrom(params)));
 76 
 77         IOUtils.writableOutputDir(outdir.toPath());
 78 
 79         try {
 80             File appLocation = prepareAppBundle(params);
 81 
 82             if (appLocation != null &amp;&amp; prepareConfigFiles(params)) {
 83                 File configScript = getConfig_Script(params);
 84                 if (configScript.exists()) {
 85                     Log.verbose(MessageFormat.format(
 86                             I18N.getString(&quot;message.running-script&quot;),
 87                             configScript.getAbsolutePath()));
 88                     IOUtils.run(&quot;bash&quot;, configScript);
 89                 }
 90 
 91                 return buildDMG(params, appLocation, outdir);
 92             }
 93             return null;
<span class="line-modified"> 94         } catch (IOException | PackagerException ex) {</span>
 95             Log.verbose(ex);
 96             throw new PackagerException(ex);
 97         }
 98     }
 99 
100     private static final String hdiutil = &quot;/usr/bin/hdiutil&quot;;
101 
102     private void prepareDMGSetupScript(Map&lt;String, ? super Object&gt; params)
103                                                                     throws IOException {
104         File dmgSetup = getConfig_VolumeScript(params);
105         Log.verbose(MessageFormat.format(
106                 I18N.getString(&quot;message.preparing-dmg-setup&quot;),
107                 dmgSetup.getAbsolutePath()));
108 
109         // We need to use URL for DMG to find it. We cannot use volume name, since
110         // user might have open DMG with same volume name already. Url should end with
111         // &#39;/&#39; and it should be real path (no symbolic links).
112         File imageDir = IMAGES_ROOT.fetchFrom(params);
113         if (!imageDir.exists()) imageDir.mkdirs(); // Create it, since it does not exist
114         Path rootPath = Path.of(imageDir.toString()).toRealPath();
</pre>
<hr />
<pre>
245 
246         // generic find attempt
247         try {
248             ProcessBuilder pb = new ProcessBuilder(&quot;xcrun&quot;, &quot;-find&quot;, &quot;SetFile&quot;);
249             Process p = pb.start();
250             InputStreamReader isr = new InputStreamReader(p.getInputStream());
251             BufferedReader br = new BufferedReader(isr);
252             String lineRead = br.readLine();
253             if (lineRead != null) {
254                 File f = new File(lineRead);
255                 if (f.exists() &amp;&amp; f.canExecute()) {
256                     return f.getAbsolutePath();
257                 }
258             }
259         } catch (IOException ignored) {}
260 
261         return null;
262     }
263 
264     private File buildDMG( Map&lt;String, ? super Object&gt; params,
<span class="line-modified">265             File appLocation, File outdir) throws IOException, PackagerException {</span>
<span class="line-added">266         boolean copyAppImage = false;</span>
267         File imagesRoot = IMAGES_ROOT.fetchFrom(params);
268         if (!imagesRoot.exists()) imagesRoot.mkdirs();
269 
270         File protoDMG = new File(imagesRoot,
271                 APP_NAME.fetchFrom(params) +&quot;-tmp.dmg&quot;);
272         File finalDMG = new File(outdir, INSTALLER_NAME.fetchFrom(params)
273                 + INSTALLER_SUFFIX.fetchFrom(params) + &quot;.dmg&quot;);
274 
275         File srcFolder = APP_IMAGE_TEMP_ROOT.fetchFrom(params);
276         File predefinedImage =
277                 StandardBundlerParam.getPredefinedAppImage(params);
278         if (predefinedImage != null) {
279             srcFolder = predefinedImage;
280         } else if (StandardBundlerParam.isRuntimeInstaller(params)) {
281             Path newRoot = Files.createTempDirectory(
282                 TEMP_ROOT.fetchFrom(params).toPath(), &quot;root-&quot;);
283 
284             // first, is this already a runtime with
285             // &lt;runtime&gt;/Contents/Home - if so we need the Home dir
286             Path original = appLocation.toPath();
</pre>
<hr />
<pre>
306                     &quot;message.dmg-cannot-be-overwritten&quot;),
307                     finalDMG.getAbsolutePath()));
308         }
309 
310         protoDMG.getParentFile().mkdirs();
311         finalDMG.getParentFile().mkdirs();
312 
313         String hdiUtilVerbosityFlag = VERBOSE.fetchFrom(params) ?
314                 &quot;-verbose&quot; : &quot;-quiet&quot;;
315 
316         // create temp image
317         ProcessBuilder pb = new ProcessBuilder(
318                 hdiutil,
319                 &quot;create&quot;,
320                 hdiUtilVerbosityFlag,
321                 &quot;-srcfolder&quot;, srcFolder.getAbsolutePath(),
322                 &quot;-volname&quot;, APP_NAME.fetchFrom(params),
323                 &quot;-ov&quot;, protoDMG.getAbsolutePath(),
324                 &quot;-fs&quot;, &quot;HFS+&quot;,
325                 &quot;-format&quot;, &quot;UDRW&quot;);
<span class="line-modified">326         try {</span>
<span class="line-added">327             IOUtils.exec(pb);</span>
<span class="line-added">328         } catch (IOException ex) {</span>
<span class="line-added">329             Log.verbose(ex); // Log exception</span>
<span class="line-added">330 </span>
<span class="line-added">331             // Creating DMG from entire app image failed, so lets try to create empty</span>
<span class="line-added">332             // DMG and copy files manually. See JDK-8248059.</span>
<span class="line-added">333             copyAppImage = true;</span>
<span class="line-added">334 </span>
<span class="line-added">335             long size = new PathGroup(Map.of(new Object(), srcFolder.toPath()))</span>
<span class="line-added">336                     .sizeInBytes();</span>
<span class="line-added">337             size += 50 * 1024 * 1024; // Add extra 50 megabytes. Actually DMG size will</span>
<span class="line-added">338             // not be bigger, but it will able to hold additional 50 megabytes of data.</span>
<span class="line-added">339             // We need extra room for icons and background image. When we providing</span>
<span class="line-added">340             // actual files to hdiutil, it will create DMG with ~50 megabytes extra room.</span>
<span class="line-added">341             pb = new ProcessBuilder(</span>
<span class="line-added">342                 hdiutil,</span>
<span class="line-added">343                 &quot;create&quot;,</span>
<span class="line-added">344                 hdiUtilVerbosityFlag,</span>
<span class="line-added">345                 &quot;-size&quot;, String.valueOf(size),</span>
<span class="line-added">346                 &quot;-volname&quot;, APP_NAME.fetchFrom(params),</span>
<span class="line-added">347                 &quot;-ov&quot;, protoDMG.getAbsolutePath(),</span>
<span class="line-added">348                 &quot;-fs&quot;, &quot;HFS+&quot;);</span>
<span class="line-added">349             IOUtils.exec(pb);</span>
<span class="line-added">350         }</span>
351 
352         // mount temp image
353         pb = new ProcessBuilder(
354                 hdiutil,
355                 &quot;attach&quot;,
356                 protoDMG.getAbsolutePath(),
357                 hdiUtilVerbosityFlag,
358                 &quot;-mountroot&quot;, imagesRoot.getAbsolutePath());
359         IOUtils.exec(pb, false, null, true);
360 
361         File mountedRoot = new File(imagesRoot.getAbsolutePath(),
362                     APP_NAME.fetchFrom(params));
<span class="line-added">363 </span>
<span class="line-added">364         // Copy app image, since we did not create DMG with it, but instead we created</span>
<span class="line-added">365         // empty one.</span>
<span class="line-added">366         if (copyAppImage) {</span>
<span class="line-added">367             // In case of predefine app image srcFolder will point to app bundle, so if</span>
<span class="line-added">368             // we use it as is we will copy content of app bundle, but we need app bundle</span>
<span class="line-added">369             // folder as well.</span>
<span class="line-added">370             if (srcFolder.toPath().toString().toLowerCase().endsWith(&quot;.app&quot;)) {</span>
<span class="line-added">371                 Path destPath = mountedRoot.toPath()</span>
<span class="line-added">372                         .resolve(srcFolder.toPath().getFileName());</span>
<span class="line-added">373                 Files.createDirectory(destPath);</span>
<span class="line-added">374                 IOUtils.copyRecursive(srcFolder.toPath(), destPath);</span>
<span class="line-added">375             } else {</span>
<span class="line-added">376                 IOUtils.copyRecursive(srcFolder.toPath(), mountedRoot.toPath());</span>
<span class="line-added">377             }</span>
<span class="line-added">378         }</span>
<span class="line-added">379 </span>
380         try {
381             // background image
382             File bgdir = new File(mountedRoot, BACKGROUND_IMAGE_FOLDER);
383             bgdir.mkdirs();
384             IOUtils.copyFile(getConfig_VolumeBackground(params),
385                     new File(bgdir, BACKGROUND_IMAGE));
386 
387             // We will not consider setting background image and creating link
388             // to install-dir in DMG as critical error, since it can fail in
389             // headless enviroment.
390             try {
391                 pb = new ProcessBuilder(&quot;osascript&quot;,
392                         getConfig_VolumeScript(params).getAbsolutePath());
393                 IOUtils.exec(pb);
394             } catch (IOException ex) {
395                 Log.verbose(ex);
396             }
397 
398             // volume icon
399             File volumeIconFile = new File(mountedRoot, &quot;.VolumeIcon.icns&quot;);
</pre>
</td>
</tr>
</table>
<center><a href="../../../../../../../jdk.accessibility/windows/native/jaccesswalker/jaccesswalkerWindow.rc.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../jdk.internal.vm.ci/share/classes/jdk.vm.ci.hotspot/src/jdk/vm/ci/hotspot/HandleCleaner.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>