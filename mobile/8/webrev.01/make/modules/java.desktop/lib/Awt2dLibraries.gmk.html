<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New make/modules/java.desktop/lib/Awt2dLibraries.gmk</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
  <body>
    <pre>
  1 #
  2 # Copyright (c) 2011, 2020, Oracle and/or its affiliates. All rights reserved.
  3 # DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4 #
  5 # This code is free software; you can redistribute it and/or modify it
  6 # under the terms of the GNU General Public License version 2 only, as
  7 # published by the Free Software Foundation.  Oracle designates this
  8 # particular file as subject to the &quot;Classpath&quot; exception as provided
  9 # by Oracle in the LICENSE file that accompanied this code.
 10 #
 11 # This code is distributed in the hope that it will be useful, but WITHOUT
 12 # ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13 # FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14 # version 2 for more details (a copy is included in the LICENSE file that
 15 # accompanied this code).
 16 #
 17 # You should have received a copy of the GNU General Public License version
 18 # 2 along with this work; if not, write to the Free Software Foundation,
 19 # Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20 #
 21 # Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22 # or visit www.oracle.com if you need additional information or have any
 23 # questions.
 24 #
 25 
 26 WIN_AWT_LIB := $(SUPPORT_OUTPUTDIR)/native/$(MODULE)/libawt/awt.lib
 27 
 28 LIBAWT_DEFAULT_HEADER_DIRS := \
 29     libawt/awt/image \
 30     libawt/awt/image/cvutils \
 31     libawt/java2d \
 32     libawt/java2d/loops \
 33     libawt/java2d/pipe \
 34     #
 35 
 36 ################################################################################
 37 
 38 BUILD_LIBMLIB_CFLAGS := -D__USE_J2D_NAMES -D__MEDIALIB_OLD_NAMES -DMLIB_NO_LIBSUNMATH
 39 
 40 ifeq ($(call isTargetCpuBits, 64), true)
 41   BUILD_LIBMLIB_CFLAGS += -DMLIB_OS64BIT
 42 endif
 43 
 44 $(eval $(call SetupJdkLibrary, BUILD_LIBMLIB_IMAGE, \
 45     NAME := mlib_image, \
 46     EXTRA_SRC := common/awt/medialib, \
 47     EXCLUDE_FILES := mlib_c_ImageBlendTable.c, \
 48     EXCLUDE_SRC_PATTERNS := $(BUILD_LIBMLIB_EXCLUDE_SRC_PATTERNS), \
 49     OPTIMIZATION := HIGHEST, \
 50     CFLAGS := $(CFLAGS_JDKLIB) \
 51         $(BUILD_LIBMLIB_CFLAGS), \
 52     DISABLED_WARNINGS_gcc := unused-function, \
 53     LDFLAGS := $(LDFLAGS_JDKLIB) \
 54         $(call SET_SHARED_LIBRARY_ORIGIN), \
 55     LIBS := $(JDKLIB_LIBS), \
 56     LIBS_unix := $(LIBM) $(LIBDL), \
 57 ))
 58 
 59 $(BUILD_LIBMLIB_IMAGE): $(call FindLib, java.base, java)
 60 
 61 TARGETS += $(BUILD_LIBMLIB_IMAGE)
 62 
 63 ################################################################################
 64 
 65 LIBAWT_EXTRA_SRC := \
 66     common/awt/debug \
 67     $(TOPDIR)/src/$(MODULE)/$(OPENJDK_TARGET_OS_TYPE)/native/common/awt \
 68     #
 69 
 70 ifeq ($(call isTargetOs, windows), true)
 71   LIBAWT_EXTRA_SRC += \
 72       $(TOPDIR)/src/$(MODULE)/share/native/common/awt/utility \
 73       $(TOPDIR)/src/$(MODULE)/share/native/common/font \
 74       $(TOPDIR)/src/$(MODULE)/share/native/common/java2d/opengl \
 75       $(TOPDIR)/src/$(MODULE)/$(OPENJDK_TARGET_OS_TYPE)/native/common/awt/systemscale \
 76       #
 77 endif
 78 
 79 ifeq ($(call isTargetOs, linux macosx aix), true)
 80   LIBAWT_EXFILES += awt_Font.c CUPSfuncs.c fontpath.c X11Color.c
 81 endif
 82 
 83 ifeq ($(call isTargetOs, macosx), true)
 84   LIBAWT_EXFILES += initIDs.c awt/image/cvutils/img_colors.c
 85 endif
 86 
 87 ifeq ($(call isTargetOs, windows), true)
 88   LIBAWT_EXFILES += \
 89       java2d/d3d/D3DShaderGen.c \
 90       awt/image/cvutils/img_colors.c \
 91       #
 92 endif
 93 
 94 LIBAWT_EXTRA_HEADER_DIRS := \
 95     $(LIBAWT_DEFAULT_HEADER_DIRS) \
 96     $(call GetJavaHeaderDir, java.base) \
 97     libawt/awt/medialib \
 98     libawt/java2d/d3d \
 99     libawt/java2d/opengl \
100     libawt/java2d/windows \
101     libawt/windows \
102     common/awt/medialib \
103     libmlib_image \
104     include \
105     java.base:libjava \
106     java.base:include \
107     #
108 
109 LIBAWT_CFLAGS += -D__MEDIALIB_OLD_NAMES -D__USE_J2D_NAMES $(X_CFLAGS)
110 
111 LIBAWT_CFLAGS += -DMLIB_NO_LIBSUNMATH
112 
113 ifeq ($(call isTargetOs, windows), true)
114   LIBAWT_CFLAGS += -EHsc -DUNICODE -D_UNICODE
115   ifeq ($(call isTargetCpuBits, 64), true)
116     LIBAWT_CFLAGS += -DMLIB_OS64BIT
117   endif
118 
119   LIBAWT_RCFLAGS ?= -I$(TOPDIR)/src/java.base/windows/native/launcher/icons
120   LIBAWT_VERSIONINFO_RESOURCE := $(TOPDIR)/src/$(MODULE)/windows/native/libawt/windows/awt.rc
121 endif
122 
123 ifeq ($(call isTargetOs, linux), true)
124   # FIXME: This is probably not what we want to do, but keep it now for compatibility.
125   LIBAWT_CFLAGS += $(EXPORT_ALL_SYMBOLS)
126 endif
127 
128 # Turn off all warnings for debug_mem.c This is needed because the specific warning
129 # about initializing a declared &#39;extern&#39; cannot be turned off individually. Only
130 # applies to debug builds.
131 ifeq ($(TOOLCHAIN_TYPE), gcc)
132   BUILD_LIBAWT_debug_mem.c_CFLAGS := -w
133   # This option improves performance of MaskFill in Java2D by 20% for some gcc
134   LIBAWT_CFLAGS += -fgcse-after-reload
135 endif
136 
137 $(eval $(call SetupJdkLibrary, BUILD_LIBAWT, \
138     NAME := awt, \
139     EXTRA_SRC := $(LIBAWT_EXTRA_SRC), \
140     EXCLUDES := $(LIBAWT_EXCLUDES), \
141     EXCLUDE_FILES := $(LIBAWT_EXFILES), \
142     OPTIMIZATION := LOW, \
143     CFLAGS := $(CFLAGS_JDKLIB) $(LIBAWT_CFLAGS), \
144     EXTRA_HEADER_DIRS := $(LIBAWT_EXTRA_HEADER_DIRS), \
145     DISABLED_WARNINGS_gcc := sign-compare unused-result maybe-uninitialized \
146         format-nonliteral parentheses unused-value unused-function, \
147     DISABLED_WARNINGS_clang := logical-op-parentheses extern-initializer \
148         sign-compare format-nonliteral, \
149     DISABLED_WARNINGS_microsoft := 4244 4267 4996, \
150     LDFLAGS := $(LDFLAGS_JDKLIB) $(call SET_SHARED_LIBRARY_ORIGIN), \
151     LDFLAGS_macosx := -L$(INSTALL_LIBRARIES_HERE), \
152     LDFLAGS_windows := -delayload:user32.dll -delayload:gdi32.dll \
153         -delayload:shell32.dll -delayload:winmm.dll \
154         -delayload:winspool.drv -delayload:imm32.dll \
155         -delayload:ole32.dll -delayload:comdlg32.dll \
156         -delayload:comctl32.dll -delayload:shlwapi.dll, \
157     LIBS_unix := -ljvm -ljava $(LIBM), \
158     LIBS_linux :=  $(LIBDL), \
159     LIBS_aix := $(LIBDL),\
160     LIBS_macosx := -lmlib_image \
161         -framework Cocoa \
162         -framework OpenGL \
163         -framework JavaNativeFoundation \
164         -framework JavaRuntimeSupport \
165         -framework ApplicationServices \
166         -framework AudioToolbox, \
167     LIBS_windows := kernel32.lib user32.lib gdi32.lib winspool.lib \
168         imm32.lib ole32.lib uuid.lib shell32.lib \
169         comdlg32.lib winmm.lib comctl32.lib shlwapi.lib \
170         delayimp.lib jvm.lib $(WIN_JAVA_LIB) advapi32.lib, \
171     VERSIONINFO_RESOURCE := $(LIBAWT_VERSIONINFO_RESOURCE), \
172     EXTRA_RCFLAGS := $(LIBAWT_RCFLAGS), \
173 ))
174 
175 $(BUILD_LIBAWT): $(call FindLib, java.base, java)
176 
177 ifeq ($(call isTargetOs, macosx), true)
178   $(BUILD_LIBAWT): $(BUILD_LIBMLIB_IMAGE)
179 endif
180 
181 TARGETS += $(BUILD_LIBAWT)
182 
183 ################################################################################
184 
185 ifeq ($(call isTargetOs, windows macosx), false)
186   ifeq ($(ENABLE_HEADLESS_ONLY), false)
187 
188     LIBAWT_XAWT_EXTRA_SRC := \
189         common/awt \
190         common/java2d \
191         common/font \
192         #
193 
194     LIBAWT_XAWT_EXCLUDES := medialib debug
195 
196     LIBAWT_XAWT_EXTRA_HEADER_DIRS := \
197         $(LIBAWT_DEFAULT_HEADER_DIRS) \
198         libawt_xawt/awt \
199         include \
200         common/awt/debug \
201         common/awt/systemscale \
202         common/font \
203         common/java2d/opengl \
204         common/java2d/x11 \
205         #
206 
207     LIBAWT_XAWT_CFLAGS += -DXAWT -DXAWT_HACK \
208         $(FONTCONFIG_CFLAGS) \
209         $(CUPS_CFLAGS)
210 
211     ifeq ($(call isTargetOs, linux), true)
212       ifeq ($(DISABLE_XRENDER), true)
213         LIBAWT_XAWT_CFLAGS += -DDISABLE_XRENDER_BY_DEFAULT=true
214       endif
215     endif
216 
217     LIBAWT_XAWT_LIBS := $(LIBM) -lawt -lXext -lX11 -lXrender $(LIBDL) -lXtst -lXi -ljava -ljvm
218 
219     ifeq ($(call isTargetOs, linux), true)
220       LIBAWT_XAWT_LIBS += -lpthread
221     endif
222 
223     ifeq ($(TOOLCHAIN_TYPE), gcc)
224       # Turn off all warnings for the following files since they contain warnings
225       # that cannot be turned of individually.
226       # redefining a macro
227       BUILD_LIBAWT_XAWT_gtk2_interface.c_CFLAGS := -w
228       # comparison between pointer and integer
229       BUILD_LIBAWT_XAWT_awt_Font.c_CFLAGS := -w
230       # initializing a declared &#39;extern&#39;
231       BUILD_LIBAWT_XAWT_debug_mem.c_CFLAGS := -w
232     endif
233 
234     $(eval $(call SetupJdkLibrary, BUILD_LIBAWT_XAWT, \
235         NAME := awt_xawt, \
236         EXTRA_SRC := $(LIBAWT_XAWT_EXTRA_SRC), \
237         EXTRA_HEADER_DIRS := $(LIBAWT_XAWT_EXTRA_HEADER_DIRS), \
238         EXCLUDES := $(LIBAWT_XAWT_EXCLUDES), \
239         OPTIMIZATION := LOW, \
240         CFLAGS := $(CFLAGS_JDKLIB) $(LIBAWT_XAWT_CFLAGS) \
241             $(X_CFLAGS), \
242         WARNINGS_AS_ERRORS_xlc := false, \
243         DISABLED_WARNINGS_gcc := type-limits pointer-to-int-cast \
244             unused-result maybe-uninitialized format \
245             format-security int-to-pointer-cast parentheses \
246             implicit-fallthrough undef unused-function, \
247         DISABLED_WARNINGS_clang := parentheses format undef \
248             logical-op-parentheses format-nonliteral int-conversion, \
249         LDFLAGS := $(LDFLAGS_JDKLIB) \
250             $(call SET_SHARED_LIBRARY_ORIGIN) \
251             -L$(INSTALL_LIBRARIES_HERE), \
252         LIBS :=  $(X_LIBS) $(LIBAWT_XAWT_LIBS), \
253     ))
254 
255     $(BUILD_LIBAWT_XAWT): $(call FindLib, java.base, java)
256 
257     $(BUILD_LIBAWT_XAWT): $(BUILD_LIBAWT)
258 
259     TARGETS += $(BUILD_LIBAWT_XAWT)
260 
261   endif
262 endif
263 
264 ################################################################################
265 
266 # The fast floor code loses precision.
267 LCMS_CFLAGS=-DCMS_DONT_USE_FAST_FLOOR
268 
269 ifeq ($(USE_EXTERNAL_LCMS), true)
270   # If we&#39;re using an external library, we&#39;ll just need the wrapper part.
271   # By including it explicitly, all other files will be excluded.
272   BUILD_LIBLCMS_INCLUDE_FILES := LCMS.c
273   # If we&#39;re using an external library, we can&#39;t include our own SRC path
274   # as includes, instead the system headers should be used.
275   LIBLCMS_HEADERS_FROM_SRC := false
276 else
277   BUILD_LIBLCMS_INCLUDE_FILES :=
278 endif
279 
280 $(eval $(call SetupJdkLibrary, BUILD_LIBLCMS, \
281     NAME := lcms, \
282     INCLUDE_FILES := $(BUILD_LIBLCMS_INCLUDE_FILES), \
283     OPTIMIZATION := HIGHEST, \
284     CFLAGS := $(CFLAGS_JDKLIB) \
285         $(LCMS_CFLAGS), \
286     CFLAGS_windows := -DCMS_IS_WINDOWS_, \
287     EXTRA_HEADER_DIRS := \
288         common/awt/debug \
289         libawt/java2d, \
290     HEADERS_FROM_SRC := $(LIBLCMS_HEADERS_FROM_SRC), \
291     DISABLED_WARNINGS_gcc := format-nonliteral type-limits \
292         misleading-indentation undef unused-function stringop-truncation, \
293     DISABLED_WARNINGS_clang := tautological-compare format-nonliteral undef, \
294     DISABLED_WARNINGS_microsoft := 4819, \
295     LDFLAGS := $(LDFLAGS_JDKLIB) \
296         $(call SET_SHARED_LIBRARY_ORIGIN), \
297     LDFLAGS_unix := -L$(INSTALL_LIBRARIES_HERE), \
298     LIBS_unix := -lawt -ljvm -ljava $(LCMS_LIBS) $(LIBM), \
299     LIBS_windows := $(WIN_AWT_LIB) $(WIN_JAVA_LIB), \
300 ))
301 
302 TARGETS += $(BUILD_LIBLCMS)
303 
304 $(BUILD_LIBLCMS): $(BUILD_LIBAWT)
305 
306 ################################################################################
307 
308 # &quot;DISABLED_WARNINGS_gcc := clobbered&quot; rationale:
309 # Suppress gcc warnings like &quot;variable might be clobbered by &#39;longjmp&#39;
310 # or &#39;vfork&#39;&quot;: this warning indicates that some variable is placed to
311 # a register by optimized compiler and it&#39;s value might be lost on longjmp().
312 # Recommended way to avoid such warning is to declare the variable as
313 # volatile to prevent the optimization. However, this approach does not
314 # work because we have to declare all variables as volatile in result.
315 
316 ifeq ($(USE_EXTERNAL_LIBJPEG), true)
317   LIBJPEG_LIBS := -ljpeg
318   BUILD_LIBJAVAJPEG_INCLUDE_FILES := \
319       imageioJPEG.c \
320       jpegdecoder.c
321   # If we&#39;re using an external library, we can&#39;t include our own SRC path
322   # as includes, instead the system headers should be used.
323   LIBJPEG_HEADERS_FROM_SRC := false
324 else
325   LIBJPEG_LIBS :=
326   BUILD_LIBJAVAJPEG_INCLUDE_FILES :=
327 endif
328 
329 $(eval $(call SetupJdkLibrary, BUILD_LIBJAVAJPEG, \
330     NAME := javajpeg, \
331     INCLUDE_FILES := $(BUILD_LIBJAVAJPEG_INCLUDE_FILES), \
332     OPTIMIZATION := HIGHEST, \
333     CFLAGS := $(CFLAGS_JDKLIB), \
334     HEADERS_FROM_SRC := $(LIBJPEG_HEADERS_FROM_SRC), \
335     DISABLED_WARNINGS_gcc := clobbered implicit-fallthrough shift-negative-value, \
336     LDFLAGS := $(LDFLAGS_JDKLIB) \
337         $(call SET_SHARED_LIBRARY_ORIGIN), \
338     LIBS := $(LIBJPEG_LIBS) $(JDKLIB_LIBS), \
339     LIBS_windows := $(WIN_JAVA_LIB) jvm.lib, \
340 ))
341 
342 $(BUILD_LIBJAVAJPEG): $(call FindLib, java.base, java)
343 
344 TARGETS += $(BUILD_LIBJAVAJPEG)
345 
346 ################################################################################
347 
348 # Mac and Windows only use the native AWT lib, do not build libawt_headless
349 ifeq ($(call isTargetOs, windows macosx), false)
350 
351   LIBAWT_HEADLESS_EXTRA_SRC := \
352       common/font \
353       common/java2d \
354       $(TOPDIR)/src/$(MODULE)/$(OPENJDK_TARGET_OS_TYPE)/native/common/awt \
355       #
356 
357   LIBAWT_HEADLESS_EXCLUDES := medialib
358 
359   LIBAWT_HEADLESS_EXTRA_HEADER_DIRS := \
360       $(LIBAWT_DEFAULT_HEADER_DIRS) \
361       common/awt/debug \
362       common/font \
363       common/java2d/opengl \
364       #
365 
366   LIBAWT_HEADLESS_CFLAGS := $(CUPS_CFLAGS) $(FONTCONFIG_CFLAGS) $(X_CFLAGS) \
367       -DHEADLESS=true
368 
369   $(eval $(call SetupJdkLibrary, BUILD_LIBAWT_HEADLESS, \
370       NAME := awt_headless, \
371       EXTRA_SRC := $(LIBAWT_HEADLESS_EXTRA_SRC), \
372       EXCLUDES := $(LIBAWT_HEADLESS_EXCLUDES), \
373       OPTIMIZATION := LOW, \
374       CFLAGS := $(CFLAGS_JDKLIB) \
375           $(LIBAWT_HEADLESS_CFLAGS), \
376       EXTRA_HEADER_DIRS := $(LIBAWT_HEADLESS_EXTRA_HEADER_DIRS), \
377       DISABLED_WARNINGS_gcc := unused-function, \
378       LDFLAGS := $(LDFLAGS_JDKLIB) \
379           $(call SET_SHARED_LIBRARY_ORIGIN), \
380       LDFLAGS_unix := -L$(INSTALL_LIBRARIES_HERE), \
381       LIBS_unix := -lawt -ljvm -ljava, \
382       LIBS_linux := $(LIBM) $(LIBDL), \
383   ))
384 
385   $(BUILD_LIBAWT_HEADLESS): $(BUILD_LIBAWT)
386 
387   TARGETS += $(BUILD_LIBAWT_HEADLESS)
388 
389 endif
390 
391 ################################################################################
392 
393 ifeq ($(FREETYPE_TO_USE), system)
394   # For use by libfontmanager:
395   LIBFREETYPE_CFLAGS := $(FREETYPE_CFLAGS)
396   LIBFREETYPE_LIBS := $(FREETYPE_LIBS)
397 else
398   BUILD_LIBFREETYPE_HEADER_DIRS := $(TOPDIR)/src/$(MODULE)/share/native/libfreetype/include
399   BUILD_LIBFREETYPE_CFLAGS := -DFT2_BUILD_LIBRARY $(EXPORT_ALL_SYMBOLS)
400 
401   # For use by libfontmanager:
402   LIBFREETYPE_CFLAGS := -I$(BUILD_LIBFREETYPE_HEADER_DIRS)
403   ifeq ($(call isTargetOs, windows), true)
404     LIBFREETYPE_LIBS := $(SUPPORT_OUTPUTDIR)/native/$(MODULE)/libfreetype/freetype.lib
405     # freetype now requires you to manually define this (see ftconfig.h)
406     BUILD_LIBFREETYPE_CFLAGS += -DDLL_EXPORT
407   else
408     LIBFREETYPE_LIBS := -lfreetype
409   endif
410 
411   $(eval $(call SetupJdkLibrary, BUILD_LIBFREETYPE, \
412       NAME := freetype, \
413       OPTIMIZATION := HIGHEST, \
414       CFLAGS := $(CFLAGS_JDKLIB) \
415           $(BUILD_LIBFREETYPE_CFLAGS), \
416       EXTRA_HEADER_DIRS := $(BUILD_LIBFREETYPE_HEADER_DIRS), \
417       DISABLED_WARNINGS_microsoft := 4018 4267 4244 4312 4819, \
418       DISABLED_WARNINGS_gcc := implicit-fallthrough cast-function-type bad-function-cast, \
419       LDFLAGS := $(LDFLAGS_JDKLIB) \
420           $(call SET_SHARED_LIBRARY_ORIGIN), \
421   ))
422 
423   TARGETS += $(BUILD_LIBFREETYPE)
424 endif
425 
426 ###########################################################################
427 
428 #### Begin harfbuzz configuration
429 
430 HARFBUZZ_CFLAGS := -DHAVE_OT -DHAVE_FALLBACK -DHAVE_UCDN -DHAVE_ROUND
431 
432 ifeq ($(call isTargetOs, windows), false)
433   HARFBUZZ_CFLAGS += -DGETPAGESIZE -DHAVE_MPROTECT -DHAVE_PTHREAD \
434                       -DHAVE_SYSCONF -DHAVE_SYS_MMAN_H -DHAVE_UNISTD_H \
435                       -DHB_NO_PRAGMA_GCC_DIAGNOSTIC
436 endif
437 ifeq ($(call isTargetOs, linux macosx), true)
438   HARFBUZZ_CFLAGS += -DHAVE_INTEL_ATOMIC_PRIMITIVES
439 endif
440 ifeq ($(call isTargetOs, macosx), true)
441   HARFBUZZ_CFLAGS += -DHAVE_CORETEXT
442 endif
443 ifeq ($(call isTargetOs, macosx), false)
444   LIBFONTMANAGER_EXCLUDE_FILES += harfbuzz/hb-coretext.cc
445 endif
446 # hb-ft.cc is not presently needed, and requires freetype 2.4.2 or later.
447 LIBFONTMANAGER_EXCLUDE_FILES += harfbuzz/hb-ft.cc
448 
449 LIBFONTMANAGER_CFLAGS += $(HARFBUZZ_CFLAGS)
450 
451 #### End harfbuzz configuration
452 
453 LIBFONTMANAGER_EXTRA_HEADER_DIRS := \
454     libfontmanager/harfbuzz \
455     libfontmanager/harfbuzz/hb-ucdn \
456     common/awt \
457     common/font \
458     libawt/java2d \
459     libawt/java2d/pipe \
460     libawt/java2d/loops \
461     #
462 
463 LIBFONTMANAGER_CFLAGS += $(LIBFREETYPE_CFLAGS)
464 BUILD_LIBFONTMANAGER_FONTLIB += $(LIBFREETYPE_LIBS)
465 
466 LIBFONTMANAGER_OPTIMIZATION := HIGH
467 
468 ifeq ($(call isTargetOs, windows), true)
469   LIBFONTMANAGER_EXCLUDE_FILES += X11FontScaler.c \
470       X11TextRenderer.c
471   LIBFONTMANAGER_OPTIMIZATION := HIGHEST
472 else ifeq ($(call isTargetOs, macosx), true)
473   LIBFONTMANAGER_EXCLUDE_FILES += X11FontScaler.c \
474       X11TextRenderer.c \
475       fontpath.c \
476       lcdglyph.c
477 else
478   LIBFONTMANAGER_EXCLUDE_FILES += fontpath.c \
479       lcdglyph.c
480 endif
481 
482 LIBFONTMANAGER_CFLAGS += $(X_CFLAGS) -DLE_STANDALONE -DHEADLESS
483 
484 ifeq ($(TOOLCHAIN_TYPE), gcc)
485   # Turn off all warnings for sunFont.c. This is needed because the specific warning
486   # about discarding &#39;const&#39; qualifier cannot be turned off individually.
487   BUILD_LIBFONTMANAGER_sunFont.c_CFLAGS := -w
488 endif
489 
490 # LDFLAGS clarification:
491 #   Filter relevant linker flags disallowing unresolved symbols as we cannot
492 #   build-time decide to which library to link against (libawt_headless or
493 #   libawt_xawt). See JDK-8196516 for details.
494 $(eval $(call SetupJdkLibrary, BUILD_LIBFONTMANAGER, \
495     NAME := fontmanager, \
496     EXCLUDE_FILES := $(LIBFONTMANAGER_EXCLUDE_FILES) \
497         AccelGlyphCache.c, \
498     TOOLCHAIN := TOOLCHAIN_LINK_CXX, \
499     CFLAGS := $(CFLAGS_JDKLIB) $(LIBFONTMANAGER_CFLAGS), \
500     CXXFLAGS := $(CXXFLAGS_JDKLIB) $(LIBFONTMANAGER_CFLAGS), \
501     OPTIMIZATION := $(LIBFONTMANAGER_OPTIMIZATION), \
502     CFLAGS_windows = -DCC_NOEX, \
503     EXTRA_HEADER_DIRS := $(LIBFONTMANAGER_EXTRA_HEADER_DIRS), \
504     WARNINGS_AS_ERRORS_xlc := false, \
505     DISABLED_WARNINGS_gcc := sign-compare int-to-pointer-cast \
506         type-limits missing-field-initializers implicit-fallthrough \
507         strict-aliasing undef unused-function, \
508     DISABLED_WARNINGS_CXX_gcc := reorder delete-non-virtual-dtor strict-overflow \
509         maybe-uninitialized class-memaccess, \
510     DISABLED_WARNINGS_clang := unused-value incompatible-pointer-types \
511         tautological-constant-out-of-range-compare int-to-pointer-cast \
512         sign-compare undef missing-field-initializers, \
513     DISABLED_WARNINGS_microsoft := 4267 4244 4018 4090 4996 4146 4334 4819 4101 4068 4805 4138, \
514     LDFLAGS := $(subst -Xlinker -z -Xlinker defs,, \
515         $(subst -Wl$(COMMA)-z$(COMMA)defs,,$(LDFLAGS_JDKLIB))) $(LDFLAGS_CXX_JDK) \
516         $(call SET_SHARED_LIBRARY_ORIGIN), \
517     LDFLAGS_unix := -L$(INSTALL_LIBRARIES_HERE), \
518     LDFLAGS_aix := -Wl$(COMMA)-berok, \
519     LIBS := $(BUILD_LIBFONTMANAGER_FONTLIB), \
520     LIBS_unix := -lawt -ljava -ljvm $(LIBM) $(LIBCXX), \
521     LIBS_macosx := -lawt_lwawt -framework CoreText -framework CoreFoundation \
522         -framework CoreGraphics, \
523     LIBS_windows := $(WIN_JAVA_LIB) advapi32.lib user32.lib gdi32.lib \
524         $(WIN_AWT_LIB), \
525 ))
526 
527 $(BUILD_LIBFONTMANAGER): $(BUILD_LIBAWT)
528 
529 ifeq ($(call isTargetOs, macosx), true)
530   $(BUILD_LIBFONTMANAGER): $(call FindLib, $(MODULE), awt_lwawt)
531 endif
532 
533 ifeq ($(FREETYPE_TO_USE), bundled)
534   $(BUILD_LIBFONTMANAGER): $(BUILD_LIBFREETYPE)
535 endif
536 
537 TARGETS += $(BUILD_LIBFONTMANAGER)
538 
539 ################################################################################
540 
541 ifeq ($(call isTargetOs, windows), true)
542 
543   LIBJAWT_CFLAGS := -EHsc -DUNICODE -D_UNICODE
544 
545   LIBJAWT_EXTRA_HEADER_DIRS := \
546       include \
547       common/awt/debug \
548       libawt/awt/image/cvutils \
549       libawt/java2d \
550       libawt/java2d/windows \
551       libawt/windows \
552       java.base:include \
553       java.base:libjava \
554       #
555 
556   ifeq ($(call isTargetCpu, x86), true)
557     KERNEL32_LIB := kernel32.lib
558   endif
559 
560   $(eval $(call SetupJdkLibrary, BUILD_LIBJAWT, \
561       NAME := jawt, \
562       OPTIMIZATION := LOW, \
563       CFLAGS := $(CXXFLAGS_JDKLIB) \
564           $(LIBJAWT_CFLAGS), \
565       EXTRA_HEADER_DIRS := $(LIBJAWT_EXTRA_HEADER_DIRS), \
566       LDFLAGS := $(LDFLAGS_JDKLIB) $(LDFLAGS_CXX_JDK), \
567       LIBS := $(JDKLIB_LIBS) $(KERNEL32_LIB) advapi32.lib $(WIN_AWT_LIB), \
568   ))
569 
570   $(BUILD_LIBJAWT): $(BUILD_LIBAWT)
571 
572   $(eval $(call SetupCopyFiles, COPY_JAWT_LIB, \
573       FILES := $(BUILD_LIBJAWT_IMPORT_LIBRARY), \
574       DEST := $(SUPPORT_OUTPUTDIR)/modules_libs/$(MODULE), \
575   ))
576 
577   $(COPY_JAWT_LIB): $(BUILD_LIBJAWT)
578 
579   TARGETS += $(COPY_JAWT_LIB)
580 
581 else # not windows
582 
583   ifeq ($(call isTargetOs, macosx), true)
584     # libjawt on macosx do not use the unix code
585     LIBJAWT_EXCLUDE_SRC_PATTERNS := /unix/
586   endif
587 
588   ifeq ($(call isTargetOs, macosx), true)
589     JAWT_LIBS := -lawt_lwawt
590   else
591     JAWT_LIBS := -lawt
592     ifeq ($(ENABLE_HEADLESS_ONLY), false)
593       JAWT_LIBS += -lawt_xawt
594     else
595       JAWT_LIBS += -lawt_headless
596       ifeq ($(call isTargetOs, linux), true)
597         JAWT_CFLAGS += -DHEADLESS
598       endif
599     endif
600   endif
601 
602   $(eval $(call SetupJdkLibrary, BUILD_LIBJAWT, \
603       NAME := jawt, \
604       EXCLUDE_SRC_PATTERNS := $(LIBJAWT_EXCLUDE_SRC_PATTERNS), \
605       INCLUDE_FILES := $(JAWT_FILES), \
606       OPTIMIZATION := LOW, \
607       CFLAGS := $(CFLAGS_JDKLIB) \
608           $(JAWT_CFLAGS), \
609       DISABLED_WARNINGS_clang := sign-compare, \
610       EXTRA_HEADER_DIRS := \
611           include \
612           common/awt, \
613       LDFLAGS := $(LDFLAGS_JDKLIB) \
614           $(call SET_SHARED_LIBRARY_ORIGIN), \
615       LDFLAGS_unix := -L$(INSTALL_LIBRARIES_HERE), \
616       LDFLAGS_macosx := -Wl$(COMMA)-rpath$(COMMA)@loader_path, \
617       LIBS_unix := $(JAWT_LIBS) $(JDKLIB_LIBS), \
618       LIBS_macosx := -framework Cocoa, \
619   ))
620 
621   ifeq ($(ENABLE_HEADLESS_ONLY), false)
622     $(BUILD_LIBJAWT): $(BUILD_LIBAWT_XAWT)
623   else
624     $(BUILD_LIBJAWT): $(call FindLib, $(MODULE), awt_headless)
625   endif
626 
627   ifeq ($(call isTargetOs, macosx), true)
628    $(BUILD_LIBJAWT): $(call FindLib, $(MODULE), awt_lwawt)
629   endif
630 
631 endif
632 
633 TARGETS += $(BUILD_LIBJAWT)
634 
635 ################################################################################
636 
637 ifeq ($(ENABLE_HEADLESS_ONLY), false)
638 
639   LIBSPLASHSCREEN_EXTRA_SRC := \
640       common/awt/systemscale \
641       #
642 
643   ifeq ($(USE_EXTERNAL_LIBGIF), false)
644     LIBSPLASHSCREEN_HEADER_DIRS += libsplashscreen/giflib
645   else
646     LIBSPLASHSCREEN_EXCLUDES := giflib
647     GIFLIB_LIBS := -lgif
648   endif
649 
650   ifeq ($(USE_EXTERNAL_LIBJPEG), false)
651     # While the following ought to work, it will currently pull in the closed
652     # additions to this library, and this was not done previously in the build.
653     # LIBSPLASHSCREEN_EXTRA_SRC += libjavajpeg
654     LIBSPLASHSCREEN_EXTRA_SRC += $(TOPDIR)/src/java.desktop/share/native/libjavajpeg
655   else
656     LIBJPEG_LIBS := -ljpeg
657   endif
658 
659   ifeq ($(USE_EXTERNAL_LIBPNG), false)
660     LIBSPLASHSCREEN_HEADER_DIRS += libsplashscreen/libpng
661   else
662     LIBSPLASHSCREEN_EXCLUDES += libpng
663   endif
664 
665   ifeq ($(USE_EXTERNAL_LIBZ), false)
666     LIBSPLASHSCREEN_EXTRA_SRC += java.base:libzip/zlib
667   endif
668 
669   ifeq ($(call isTargetOs, macosx), true)
670     # libsplashscreen on macosx do not use the unix code
671     LIBSPLASHSCREEN_EXCLUDE_SRC_PATTERNS := /unix/
672   endif
673 
674   LIBSPLASHSCREEN_CFLAGS += -DSPLASHSCREEN -DPNG_NO_MMX_CODE \
675                             -DPNG_ARM_NEON_OPT=0 -DPNG_ARM_NEON_IMPLEMENTATION=0
676 
677   ifeq ($(call isTargetOs, linux), true)
678     ifeq ($(call isTargetCpuArch, ppc), true)
679       LIBSPLASHSCREEN_CFLAGS += -DPNG_POWERPC_VSX_OPT=0
680     endif
681   endif
682 
683   ifeq ($(call isTargetOs, macosx), true)
684     LIBSPLASHSCREEN_CFLAGS += -DWITH_MACOSX
685 
686     BUILD_LIBSPLASHSCREEN_java_awt_SplashScreen.c_CFLAGS := -x objective-c -O0
687     BUILD_LIBSPLASHSCREEN_splashscreen_gfx_impl.c_CFLAGS := -x objective-c -O0
688     BUILD_LIBSPLASHSCREEN_splashscreen_gif.c_CFLAGS := -x objective-c -O0
689     BUILD_LIBSPLASHSCREEN_splashscreen_impl.c_CFLAGS := -x objective-c -O0
690     BUILD_LIBSPLASHSCREEN_splashscreen_jpeg.c_CFLAGS := -x objective-c -O0
691     BUILD_LIBSPLASHSCREEN_splashscreen_png.c_CFLAGS := -x objective-c -O0
692     BUILD_LIBSPLASHSCREEN_splashscreen_sys.m_CFLAGS := -O0
693 
694   else ifeq ($(call isTargetOs, windows), true)
695     LIBSPLASHSCREEN_CFLAGS += -DWITH_WIN32
696   else
697     LIBSPLASHSCREEN_CFLAGS += -DWITH_X11 $(X_CFLAGS)
698   endif
699 
700   LIBSPLASHSCREEN_LIBS :=
701 
702   ifeq ($(call isTargetOs, macosx), true)
703     LIBSPLASHSCREEN_LIBS += \
704         $(LIBM) -lpthread -liconv -losxapp \
705         -framework ApplicationServices \
706         -framework Foundation \
707         -framework Security \
708         -framework Cocoa \
709         -framework JavaNativeFoundation
710   else ifeq ($(call isTargetOs, windows), true)
711     LIBSPLASHSCREEN_LIBS += kernel32.lib user32.lib gdi32.lib delayimp.lib $(WIN_JAVA_LIB) jvm.lib
712   else
713     LIBSPLASHSCREEN_LIBS += $(X_LIBS) -lX11 -lXext $(LIBM) -lpthread -ldl
714   endif
715 
716   LIBSPLASHSCREEN_HEADER_DIRS += \
717       libosxapp \
718       java.base:include \
719       java.base:libjava \
720       #
721 
722   $(eval $(call SetupJdkLibrary, BUILD_LIBSPLASHSCREEN, \
723       NAME := splashscreen, \
724       EXTRA_SRC := $(LIBSPLASHSCREEN_EXTRA_SRC), \
725       EXCLUDE_SRC_PATTERNS := $(LIBSPLASHSCREEN_EXCLUDE_SRC_PATTERNS), \
726       EXCLUDE_FILES := imageioJPEG.c jpegdecoder.c pngtest.c, \
727       EXCLUDES := $(LIBSPLASHSCREEN_EXCLUDES), \
728       OPTIMIZATION := LOW, \
729       CFLAGS := $(CFLAGS_JDKLIB) $(LIBSPLASHSCREEN_CFLAGS) \
730           $(GIFLIB_CFLAGS) $(LIBJPEG_CFLAGS) $(PNG_CFLAGS) $(LIBZ_CFLAGS), \
731       EXTRA_HEADER_DIRS := $(LIBSPLASHSCREEN_HEADER_DIRS), \
732       DISABLED_WARNINGS_gcc := sign-compare type-limits unused-result \
733           maybe-uninitialized shift-negative-value implicit-fallthrough \
734           unused-function, \
735       DISABLED_WARNINGS_clang := incompatible-pointer-types sign-compare, \
736       DISABLED_WARNINGS_microsoft := 4018 4244 4267, \
737       LDFLAGS := $(LDFLAGS_JDKLIB) \
738           $(call SET_SHARED_LIBRARY_ORIGIN), \
739       LDFLAGS_macosx := -L$(INSTALL_LIBRARIES_HERE), \
740       LDFLAGS_windows := -delayload:user32.dll, \
741       LIBS := $(JDKLIB_LIBS) $(LIBSPLASHSCREEN_LIBS) $(LIBZ_LIBS) \
742           $(GIFLIB_LIBS) $(LIBJPEG_LIBS) $(PNG_LIBS), \
743       LIBS_aix := -liconv, \
744   ))
745 
746   TARGETS += $(BUILD_LIBSPLASHSCREEN)
747 
748   ifeq ($(call isTargetOs, macosx), true)
749     $(BUILD_LIBSPLASHSCREEN): $(call FindLib, $(MODULE), osxapp)
750   endif
751 
752 endif
753 
754 ################################################################################
755 
756 ifeq ($(call isTargetOs, macosx), true)
757 
758   LIBAWT_LWAWT_EXTRA_SRC := \
759       $(TOPDIR)/src/$(MODULE)/unix/native/common/awt \
760       $(TOPDIR)/src/$(MODULE)/share/native/common/font \
761       $(TOPDIR)/src/$(MODULE)/share/native/common/java2d \
762       #
763 
764   LIBAWT_LWAWT_EXTRA_HEADER_DIRS := \
765       $(LIBAWT_DEFAULT_HEADER_DIRS) \
766       libawt_lwawt/awt \
767       libawt_lwawt/font \
768       libawt_lwawt/java2d/opengl \
769       include \
770       common/awt/debug \
771       common/java2d/opengl \
772       libosxapp \
773       #
774 
775   LIBAWT_LWAWT_CFLAGS := $(X_CFLAGS) $(X_LIBS)
776 
777   LIBAWT_LWAWT_EXFILES := fontpath.c awt_Font.c X11Color.c
778   LIBAWT_LWAWT_EXCLUDES := $(TOPDIR)/src/$(MODULE)/unix/native/common/awt/medialib
779 
780   $(eval $(call SetupJdkLibrary, BUILD_LIBAWT_LWAWT, \
781       NAME := awt_lwawt, \
782       EXTRA_SRC := $(LIBAWT_LWAWT_EXTRA_SRC), \
783       INCLUDE_FILES := $(LIBAWT_LWAWT_FILES), \
784       EXCLUDE_FILES := $(LIBAWT_LWAWT_EXFILES), \
785       EXCLUDES := $(LIBAWT_LWAWT_EXCLUDES), \
786       OPTIMIZATION := LOW, \
787       CFLAGS := $(CFLAGS_JDKLIB) \
788           $(LIBAWT_LWAWT_CFLAGS), \
789       EXTRA_HEADER_DIRS := $(LIBAWT_LWAWT_EXTRA_HEADER_DIRS), \
790       DISABLED_WARNINGS_clang := incomplete-implementation enum-conversion \
791           deprecated-declarations objc-method-access bitwise-op-parentheses \
792           incompatible-pointer-types parentheses-equality extra-tokens \
793           sign-compare semicolon-before-method-body format-nonliteral undef \
794           pointer-arith, \
795       LDFLAGS := $(LDFLAGS_JDKLIB) \
796           $(call SET_SHARED_LIBRARY_ORIGIN) \
797           -L$(INSTALL_LIBRARIES_HERE), \
798       LIBS := -lawt -lmlib_image -losxapp -ljvm $(LIBM) \
799           -framework Accelerate \
800           -framework ApplicationServices \
801           -framework AudioToolbox \
802           -framework Carbon \
803           -framework Cocoa \
804           -framework Security \
805           -framework ExceptionHandling \
806           -framework JavaNativeFoundation \
807           -framework JavaRuntimeSupport \
808           -framework OpenGL \
809           -framework QuartzCore -ljava, \
810   ))
811 
812   TARGETS += $(BUILD_LIBAWT_LWAWT)
813 
814   $(BUILD_LIBAWT_LWAWT): $(BUILD_LIBAWT)
815 
816   $(BUILD_LIBAWT_LWAWT): $(BUILD_LIBMLIB_IMAGE)
817 
818   $(BUILD_LIBAWT_LWAWT): $(call FindLib, $(MODULE), osxapp)
819 
820   $(BUILD_LIBAWT_LWAWT): $(call FindLib, java.base, java)
821 
822 endif
823 
824 ################################################################################
825 
826 ifeq ($(call isTargetOs, macosx), true)
827 
828   $(eval $(call SetupJdkLibrary, BUILD_LIBOSXUI, \
829       NAME := osxui, \
830       OPTIMIZATION := LOW, \
831       CFLAGS := $(CFLAGS_JDKLIB), \
832       EXTRA_HEADER_DIRS := \
833           libawt_lwawt/awt \
834           libosxapp, \
835       DISABLED_WARNINGS_clang := deprecated-declarations sign-compare, \
836       LDFLAGS := $(LDFLAGS_JDKLIB) \
837           $(call SET_SHARED_LIBRARY_ORIGIN) \
838           -Wl$(COMMA)-rpath$(COMMA)@loader_path \
839           -L$(INSTALL_LIBRARIES_HERE), \
840       LIBS := -lawt -losxapp -lawt_lwawt \
841           -framework Cocoa \
842           -framework Carbon \
843           -framework ApplicationServices \
844           -framework JavaNativeFoundation \
845           -framework JavaRuntimeSupport \
846           -ljava -ljvm, \
847   ))
848 
849   TARGETS += $(BUILD_LIBOSXUI)
850 
851   $(BUILD_LIBOSXUI): $(BUILD_LIBAWT)
852 
853   $(BUILD_LIBOSXUI): $(call FindLib, $(MODULE), osxapp)
854 
855   $(BUILD_LIBOSXUI): $(BUILD_LIBAWT_LWAWT)
856 
857 endif
    </pre>
  </body>
</html>