<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames make/conf/jib-profiles.js</title>
    <link rel="stylesheet" href="../../style.css" />
    <script type="text/javascript" src="../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 2015, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.  Oracle designates this
   8  * particular file as subject to the &quot;Classpath&quot; exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
  23  * questions.
  24  */
  25 
  26 /*
  27  * This file defines build profiles for the JIB tool and others.
  28  *
  29  * A build profile defines a set of configuration options and external
  30  * dependencies that we for some reason or other care about specifically.
  31  * Typically, build profiles are defined for the build configurations we
  32  * build regularly.
  33  *
  34  * Contract against this file from the tools that use it, is to provide
  35  * a function on the form:
  36  *
  37  * getJibProfiles(input)
  38  *
  39  * which returns an object graph describing the profiles and their
  40  * dependencies. The name of the function is based on the name of this
  41  * file, minus the extension and the &#39;-&#39;, camel cased and prefixed with
  42  * &#39;get&#39;.
  43  *
  44  *
  45  * The parameter &#39;input&#39; is an object that optionally contains  some data.
  46  * Optionally because a tool may read the configuration for different purposes.
  47  * To initially get a list of available profiles, the active profile may not
  48  * yet be known for instance.
  49  *
  50  * Data that may be set on the input object:
  51  *
  52  * input.profile = &lt;name of active profile&gt;
  53  *
  54  * If the active profile is set, the following data from it must also
  55  * be provided:
  56  *
  57  * input.profile
  58  * input.build_id
  59  * input.target_os
  60  * input.target_cpu
  61  * input.target_libc
  62  * input.build_os
  63  * input.build_cpu
  64  * input.build_libc
  65  * input.target_platform
  66  * input.build_platform
  67  * // The build_osenv_* variables describe the unix layer on Windows systems,
  68  * // i.e. Cygwin, which may also be 32 or 64 bit.
  69  * input.build_osenv
  70  * input.build_osenv_cpu
  71  * input.build_osenv_platform
  72  *
  73  * For more complex nested attributes, there is a method &quot;get&quot;:
  74  *
  75  * input.get(&quot;&lt;dependency&gt;&quot;, &quot;&lt;attribute&gt;&quot;)
  76  *
  77  * Valid attributes are:
  78  * install_path
  79  * download_path
  80  * download_dir
  81  * home_path
  82  *
  83  *
  84  * The output data generated by this configuration file has the following
  85  * format:
  86  *
  87  * data: {
  88  *   // Identifies the version of this format to the tool reading it
  89  *   format_version: &quot;1.0&quot;,
  90  *
  91  *   // Name of base outputdir. JIB assumes the actual output dir is formed
  92  *   // by adding the configuration name: &lt;output_basedir&gt;/&lt;config-name&gt;
  93  *   output_basedir: &quot;build&quot;,
  94  *   // Configure argument to use to specify configuration name
  95  *   configuration_configure_arg:
  96  *   // Make argument to use to specify configuration name
  97  *   configuration_make_arg:
  98  *
  99  *   profiles: {
 100  *     &lt;profile-name&gt;: {
 101  *       // Name of os the profile is built to run on
 102  *       target_os; &lt;string&gt;
 103  *       // Name of cpu the profile is built to run on
 104  *       target_cpu; &lt;string&gt;
 105  *       // Optional libc string if non standard
 106  *       target_libc; &lt;string&gt;
 107  *       // Optional combination of target_os and target_cpu for convenience
 108  *       target_platform; &lt;string&gt;
 109  *       // Name of os the profile is built on
 110  *       build_os; &lt;string&gt;
 111  *       // Name of cpu the profile is built on
 112  *       build_cpu; &lt;string&gt;
 113  *       // Optional libc string if non standard
 114  *       build_libc; &lt;string&gt;
 115  *       // Optional combination of build_os and build_cpu for convenience
 116  *       build_platform; &lt;string&gt;
 117  *
 118  *       // List of dependencies needed to build this profile
 119  *       dependencies: &lt;Array of strings&gt;
 120  *
 121  *       // List of configure args to use for this profile
 122  *       configure_args: &lt;Array of strings&gt;
 123  *
 124  *       // List of free form labels describing aspects of this profile
 125  *       labels: &lt;Array of strings&gt;
 126  *     }
 127  *   }
 128  *
 129  *   // Dependencies use a Maven like deployment structure
 130  *   dependencies: {
 131  *     &lt;dependency-name&gt;: {
 132  *       // Organization part of path defining this dependency
 133  *       organization: &lt;string&gt;
 134  *       // File extension for this dependency
 135  *       ext: &lt;string&gt;
 136  *       // Module part of path for defining this dependency,
 137  *       // defaults to &lt;dependency-name&gt;
 138  *       module: &lt;string&gt;
 139  *       // Revision part of path for defining this dependency
 140  *       revision: &lt;string&gt;
 141  *
 142  *       // List of configure args to add when using this dependency,
 143  *       // defaults to
 144  *       // &quot;--with-&lt;dependency-name&gt;=input.get(&quot;&lt;dependency-name&quot;, &quot;install_path&quot;)&quot;
 145  *       configure_args: &lt;array of strings&gt;
 146  *
 147  *       // Name of environment variable to set when using this dependency
 148  *       // when running make
 149  *       environment_name: &lt;string&gt;
 150  *       // Value of environment variable to set when using this dependency
 151  *       // when running make
 152  *       environment_value: &lt;string&gt;
 153  *
 154  *       // Value to add to the PATH variable when using this dependency,
 155  *       // applies to both make and configure
 156  *       environment_path: &lt;string&gt;
 157  *     }
 158  *
 159  *     &lt;dependency-name&gt;: {
 160  *       // For certain dependencies where a legacy distribution mechanism is
 161  *       // already in place, the &quot;javare&quot; server layout is also supported
 162  *       // Indicate that an alternate server source and layout should be used
 163  *       server: &quot;javare&quot;
 164  *
 165  *       // For &quot;javare&quot;, a combination of module, revision,
 166  *       // build number (optional), files and checksum file is possible for
 167  *       // artifacts following the standard layout.
 168  *       module: &lt;string&gt;
 169  *       revision: &lt;string&gt;
 170  *       build_number: &lt;string&gt;
 171  *       checksum_file: &lt;string&gt;
 172  *       file: &lt;string&gt;
 173  *
 174  *       // For other files, use checksum path and path instead
 175  *       checksum_path: &lt;string&gt;
 176  *       path: &lt;string&gt;
 177  *     }
 178  *   }
 179  * }
 180  */
 181 
 182 /**
 183  * Main entry to generate the profile configuration
 184  *
 185  * @param input External data to use for generating the configuration
 186  * @returns {{}} Profile configuration
 187  */
 188 var getJibProfiles = function (input) {
 189 
 190     var data = {};
 191 
 192     // Identifies the version of this format to the tool reading it.
 193     // 1.1 signifies that the publish, publish-src and get-src features are usable.
 194     // 1.2 signifies that artifact uploads should fail on missing artifacts by default.
 195     // 1.3 input.get(&lt;dep&gt;, &quot;home_path&quot;) automatically goes down into a single top
 196     //     dir just like default configure_args and environment_path variables.
 197     data.format_version = &quot;1.3&quot;;
 198 
 199     // Organization, product and version are used when uploading/publishing build results
 200     data.organization = &quot;&quot;;
 201     data.product = &quot;jdk-portola&quot;;
 202     data.version = getVersion();
 203 
 204     // The base directory for the build output. JIB will assume that the
 205     // actual build directory will be &lt;output_basedir&gt;/&lt;configuration&gt;
 206     data.output_basedir = &quot;build&quot;;
 207     // The configure argument to use to specify the name of the configuration
 208     data.configuration_configure_arg = &quot;--with-conf-name=&quot;;
 209     // The make argument to use to specify the name of the configuration
 210     data.configuration_make_arg = &quot;CONF_NAME=&quot;;
 211 
 212     // Exclude list to use when Jib creates a source bundle
 213     data.src_bundle_excludes = [
 214         &quot;build&quot;, &quot;{,**/}webrev*&quot;, &quot;{,**/}.hg&quot;, &quot;{,**/}JTwork&quot;, &quot;{,**/}JTreport&quot;,
 215         &quot;{,**/}.git&quot;
 216     ];
 217     // Include list to use when creating a minimal jib source bundle which
 218     // contains just the jib configuration files.
 219     data.conf_bundle_includes = [
 220         &quot;make/autoconf/version-numbers&quot;,
 221     ];
 222 
 223     // Define some common values
 224     var common = getJibProfilesCommon(input, data);
 225     // Generate the profiles part of the configuration
 226     data.profiles = getJibProfilesProfiles(input, common, data);
 227     // Generate the dependencies part of the configuration
 228     data.dependencies = getJibProfilesDependencies(input, common, data);
 229 
 230     return data;
 231 };
 232 
 233 /**
 234  * Generates some common values
 235  *
 236  * @param input External data to use for generating the configuration
 237  * @returns Common values
 238  */
 239 var getJibProfilesCommon = function (input, data) {
 240     var common = {};
 241 
 242     common.organization = &quot;jpg.infra.builddeps&quot;;
 243     common.build_id = getBuildId(input);
 244     common.build_number = input.build_number != null ? input.build_number : &quot;0&quot;;
 245 
 246     // List of the main profile names used for iteration
 247     common.main_profile_names = [
 248         &quot;linux-x64&quot;, &quot;linux-x64-musl&quot;, &quot;linux-x86&quot;, &quot;macosx-x64&quot;, &quot;solaris-x64&quot;,
 249         &quot;solaris-sparcv9&quot;, &quot;windows-x64&quot;, &quot;windows-x86&quot;,
 250         &quot;linux-aarch64&quot;, &quot;linux-arm32&quot;, &quot;linux-ppc64le&quot;, &quot;linux-s390x&quot;
 251     ];
 252 
 253     // These are the base setttings for all the main build profiles.
 254     common.main_profile_base = {
 255         dependencies: [&quot;boot_jdk&quot;, &quot;gnumake&quot;, &quot;jtreg&quot;, &quot;jib&quot;, &quot;autoconf&quot;, &quot;jmh&quot;, &quot;jcov&quot;],
 256         default_make_targets: [&quot;product-bundles&quot;, &quot;test-bundles&quot;, &quot;static-libs-bundles&quot;],
 257         configure_args: concat(&quot;--enable-jtreg-failure-handler&quot;,
 258             &quot;--with-exclude-translations=de,es,fr,it,ko,pt_BR,sv,ca,tr,cs,sk,ja_JP_A,ja_JP_HA,ja_JP_HI,ja_JP_I,zh_TW,zh_HK&quot;,
 259             &quot;--disable-manpages&quot;,
 260             &quot;--disable-jvm-feature-shenandoahgc&quot;,
 261             versionArgs(input, common))
 262     };
 263     // Extra settings for debug profiles
 264     common.debug_suffix = &quot;-debug&quot;;
 265     common.debug_profile_base = {
 266         configure_args: [&quot;--enable-debug&quot;],
 267         labels: &quot;debug&quot;
 268     };
 269     // Extra settings for slowdebug profiles
 270     common.slowdebug_suffix = &quot;-slowdebug&quot;;
 271     common.slowdebug_profile_base = {
 272         configure_args: [&quot;--with-debug-level=slowdebug&quot;],
 273         labels: &quot;slowdebug&quot;
 274     };
 275     // Extra settings for openjdk only profiles
 276     common.open_suffix = &quot;-open&quot;;
 277     common.open_profile_base = {
 278         configure_args: [&quot;--enable-openjdk-only&quot;],
 279         labels: &quot;open&quot;
 280     };
 281 
 282     common.configure_args_64bit = [&quot;--with-target-bits=64&quot;];
 283     common.configure_args_32bit = [&quot;--with-target-bits=32&quot;];
 284 
 285     /**
 286      * Define common artifacts template for all main profiles
 287      * @param o - Object containing data for artifacts
 288      */
 289     common.main_profile_artifacts = function (o) {
 290         var jdk_subdir = (o.jdk_subdir != null ? o.jdk_subdir : &quot;jdk-&quot; + data.version);
 291         var jdk_suffix = (o.jdk_suffix != null ? o.jdk_suffix : &quot;tar.gz&quot;);
 292         var pf = o.platform
 293         return {
 294             artifacts: {
 295                 jdk: {
 296                     local: &quot;bundles/\\(jdk.*bin.&quot; + jdk_suffix + &quot;\\)&quot;,
 297                     remote: [
 298                         &quot;bundles/&quot; + pf + &quot;/jdk-&quot; + data.version + &quot;_&quot; + pf + &quot;_bin.&quot; + jdk_suffix,
 299                         &quot;bundles/&quot; + pf + &quot;/\\1&quot;
 300                     ],
 301                     subdir: jdk_subdir,
 302                     exploded: &quot;images/jdk&quot;
 303                 },
 304                 test: {
 305                     local: &quot;bundles/\\(jdk.*bin-tests.tar.gz\\)&quot;,
 306                     remote: [
 307                         &quot;bundles/&quot; + pf + &quot;/jdk-&quot; + data.version + &quot;_&quot; + pf + &quot;_bin-tests.tar.gz&quot;,
 308                         &quot;bundles/&quot; + pf + &quot;/\\1&quot;
 309                     ],
 310                     exploded: &quot;images/test&quot;
 311                 },
 312                 test_demos: {
 313                     local: &quot;bundles/\\(jdk.*bin-tests-demos.tar.gz\\)&quot;,
 314                     remote: [
 315                         &quot;bundles/&quot; + pf + &quot;/jdk-&quot; + data.version + &quot;_&quot; + pf + &quot;_bin-tests-demos.tar.gz&quot;,
 316                         &quot;bundles/&quot; + pf + &quot;/\\1&quot;
 317                     ],
 318                     exploded: &quot;images/test&quot;
 319                 },
 320                 jdk_symbols: {
 321                     local: &quot;bundles/\\(jdk.*bin-symbols.tar.gz\\)&quot;,
 322                     remote: [
 323                         &quot;bundles/&quot; + pf + &quot;/jdk-&quot; + data.version + &quot;_&quot; + pf + &quot;_bin-symbols.tar.gz&quot;,
 324                         &quot;bundles/&quot; + pf + &quot;/\\1&quot;
 325                     ],
 326                     subdir: jdk_subdir,
 327                     exploded: &quot;images/jdk&quot;
 328                 },
 329                 static_libs: {
 330                     local: &quot;bundles/\\(jdk.*bin-static-libs.tar.gz\\)&quot;,
 331                     remote: [
 332                         &quot;bundles/&quot; + pf + &quot;/jdk-&quot; + data.version + &quot;_&quot; + pf + &quot;_bin-static-libs.tar.gz&quot;,
 333                         &quot;bundles/&quot; + pf + &quot;/\\1&quot;
 334                     ],
 335                     subdir: jdk_subdir,
 336                 },
 337             }
 338         };
 339     };
 340 
 341 
 342     /**
 343      * Define common artifacts template for all debug profiles
 344      * @param o - Object containing data for artifacts
 345      */
 346     common.debug_profile_artifacts = function (o) {
 347         var jdk_subdir = &quot;jdk-&quot; + data.version + &quot;/fastdebug&quot;;
 348         var jdk_suffix = (o.jdk_suffix != null ? o.jdk_suffix : &quot;tar.gz&quot;);
 349         var pf = o.platform
 350         return {
 351             artifacts: {
 352                 jdk: {
 353                     local: &quot;bundles/\\(jdk.*bin-debug.&quot; + jdk_suffix + &quot;\\)&quot;,
 354                     remote: [
 355                         &quot;bundles/&quot; + pf + &quot;/jdk-&quot; + data.version + &quot;_&quot; + pf + &quot;_bin-debug.&quot; + jdk_suffix,
 356                         &quot;bundles/&quot; + pf + &quot;/\\1&quot;
 357                     ],
 358                     subdir: jdk_subdir,
 359                     exploded: &quot;images/jdk&quot;
 360                 },
 361                 test: {
 362                     local: &quot;bundles/\\(jdk.*bin-tests-debug.tar.gz\\)&quot;,
 363                     remote: [
 364                         &quot;bundles/&quot; + pf + &quot;/jdk-&quot; + data.version + &quot;_&quot; + pf + &quot;_bin-tests-debug.tar.gz&quot;,
 365                         &quot;bundles/&quot; + pf + &quot;/\\1&quot;
 366                     ],
 367                     exploded: &quot;images/test&quot;
 368                 },
 369                 jdk_symbols: {
 370                     local: &quot;bundles/\\(jdk.*bin-debug-symbols.tar.gz\\)&quot;,
 371                     remote: [
 372                         &quot;bundles/&quot; + pf + &quot;/jdk-&quot; + data.version + &quot;_&quot; + pf + &quot;_bin-debug-symbols.tar.gz&quot;,
 373                         &quot;bundles/&quot; + pf + &quot;/\\1&quot;
 374                     ],
 375                     subdir: jdk_subdir,
 376                     exploded: &quot;images/jdk&quot;
 377                 },
 378                 static_libs: {
 379                     local: &quot;bundles/\\(jdk.*bin-static-libs-debug.tar.gz\\)&quot;,
 380                     remote: [
 381                         &quot;bundles/&quot; + pf + &quot;/jdk-&quot; + data.version + &quot;_&quot; + pf + &quot;_bin-static-libs-debug.tar.gz&quot;,
 382                         &quot;bundles/&quot; + pf + &quot;/\\1&quot;
 383                     ],
 384                     subdir: jdk_subdir,
 385                 },
 386             }
 387         };
 388     };
 389 
<a name="1" id="anc1"></a><span class="line-modified"> 390     common.boot_jdk_version = &quot;14&quot;;</span>
<span class="line-modified"> 391     common.boot_jdk_build_number = &quot;36&quot;;</span>
 392     common.boot_jdk_home = input.get(&quot;boot_jdk&quot;, &quot;install_path&quot;) + &quot;/jdk-&quot;
 393         + common.boot_jdk_version
 394         + (input.build_os == &quot;macosx&quot; ? &quot;.jdk/Contents/Home&quot; : &quot;&quot;);
 395 
 396     return common;
 397 };
 398 
 399 /**
 400  * Generates the profiles part of the configuration.
 401  *
 402  * @param input External data to use for generating the configuration
 403  * @param common The common values
 404  * @returns {{}} Profiles part of the configuration
 405  */
 406 var getJibProfilesProfiles = function (input, common, data) {
 407     // Main SE profiles
 408     var profiles = {
 409 
 410         &quot;linux-x64&quot;: {
 411             target_os: &quot;linux&quot;,
 412             target_cpu: &quot;x64&quot;,
 413             dependencies: [&quot;devkit&quot;, &quot;graphviz&quot;, &quot;pandoc&quot;, &quot;graalunit_lib&quot;],
 414             configure_args: concat(common.configure_args_64bit,
 415                 &quot;--enable-full-docs&quot;, &quot;--with-zlib=system&quot;,
 416                 (isWsl(input) ? [ &quot;--host=x86_64-unknown-linux-gnu&quot;,
 417                     &quot;--build=x86_64-unknown-linux-gnu&quot; ] : [])),
 418             default_make_targets: [&quot;docs-bundles&quot;],
 419         },
 420 
 421         &quot;linux-x64-musl&quot;: {
 422             target_os: &quot;linux&quot;,
 423             target_cpu: &quot;x64&quot;,
 424             target_libc: &quot;musl&quot;,
 425             configure_args: concat(common.configure_args_64bit,
 426                 &quot;--with-zlib=system&quot;),
 427         },
 428 
 429         &quot;linux-x86&quot;: {
 430             target_os: &quot;linux&quot;,
 431             target_cpu: &quot;x86&quot;,
 432             build_cpu: &quot;x64&quot;,
 433             dependencies: [&quot;devkit&quot;],
 434             configure_args: concat(common.configure_args_32bit,
 435                 &quot;--with-jvm-variants=minimal,server&quot;, &quot;--with-zlib=system&quot;),
 436         },
 437 
 438         &quot;macosx-x64&quot;: {
 439             target_os: &quot;macosx&quot;,
 440             target_cpu: &quot;x64&quot;,
 441             dependencies: [&quot;devkit&quot;, &quot;pandoc&quot;, &quot;graalunit_lib&quot;],
 442             configure_args: concat(common.configure_args_64bit, &quot;--with-zlib=system&quot;,
 443                 &quot;--with-macosx-version-max=10.9.0&quot;),
 444         },
 445 
 446         &quot;solaris-x64&quot;: {
 447             target_os: &quot;solaris&quot;,
 448             target_cpu: &quot;x64&quot;,
 449             dependencies: [&quot;devkit&quot;, &quot;cups&quot;],
 450             configure_args: concat(common.configure_args_64bit,
 451                 &quot;--with-zlib=system&quot;, &quot;--enable-dtrace&quot;, &quot;--enable-deprecated-ports=yes&quot;),
 452         },
 453 
 454         &quot;solaris-sparcv9&quot;: {
 455             target_os: &quot;solaris&quot;,
 456             target_cpu: &quot;sparcv9&quot;,
 457             dependencies: [&quot;devkit&quot;, &quot;cups&quot;],
 458             configure_args: concat(common.configure_args_64bit,
 459                 &quot;--with-zlib=system&quot;, &quot;--enable-dtrace&quot;, &quot;--enable-deprecated-ports=yes&quot;),
 460         },
 461 
 462         &quot;windows-x64&quot;: {
 463             target_os: &quot;windows&quot;,
 464             target_cpu: &quot;x64&quot;,
 465             dependencies: [&quot;devkit&quot;, &quot;pandoc&quot;, &quot;graalunit_lib&quot;],
 466             configure_args: concat(common.configure_args_64bit),
 467         },
 468 
 469         &quot;windows-x86&quot;: {
 470             target_os: &quot;windows&quot;,
 471             target_cpu: &quot;x86&quot;,
 472             build_cpu: &quot;x64&quot;,
 473             dependencies: [&quot;devkit&quot;],
 474             configure_args: concat(common.configure_args_32bit),
 475         },
 476 
 477         &quot;linux-aarch64&quot;: {
 478             target_os: &quot;linux&quot;,
 479             target_cpu: &quot;aarch64&quot;,
 480             build_cpu: &quot;x64&quot;,
<a name="2" id="anc2"></a><span class="line-modified"> 481             dependencies: [&quot;devkit&quot;, &quot;build_devkit&quot;, &quot;pandoc&quot;],</span>
 482             configure_args: [
 483                 &quot;--openjdk-target=aarch64-linux-gnu&quot;,
<a name="3" id="anc3"></a><span class="line-added"> 484 		&quot;--disable-jvm-feature-jvmci&quot;,</span>
<span class="line-added"> 485 		&quot;--disable-jvm-feature-graal&quot;,</span>
<span class="line-added"> 486 		&quot;--disable-jvm-feature-aot&quot;,</span>
 487             ],
 488         },
 489 
 490         &quot;linux-arm32&quot;: {
 491             target_os: &quot;linux&quot;,
 492             target_cpu: &quot;arm&quot;,
 493             build_cpu: &quot;x64&quot;,
<a name="4" id="anc4"></a><span class="line-modified"> 494             dependencies: [&quot;devkit&quot;, &quot;build_devkit&quot;],</span>
 495             configure_args: [
 496                 &quot;--openjdk-target=arm-linux-gnueabihf&quot;, &quot;--with-freetype=bundled&quot;,
 497                 &quot;--with-abi-profile=arm-vfp-hflt&quot;, &quot;--disable-warnings-as-errors&quot;
 498             ],
 499         },
 500 
 501         &quot;linux-ppc64le&quot;: {
 502             target_os: &quot;linux&quot;,
 503             target_cpu: &quot;ppc64le&quot;,
 504             build_cpu: &quot;x64&quot;,
<a name="5" id="anc5"></a><span class="line-modified"> 505             dependencies: [&quot;devkit&quot;, &quot;build_devkit&quot;],</span>
 506             configure_args: [
 507                 &quot;--openjdk-target=ppc64le-linux-gnu&quot;, &quot;--with-freetype=bundled&quot;,
 508                 &quot;--disable-warnings-as-errors&quot;
 509             ],
 510         },
 511 
 512         &quot;linux-s390x&quot;: {
 513             target_os: &quot;linux&quot;,
 514             target_cpu: &quot;s390x&quot;,
 515             build_cpu: &quot;x64&quot;,
<a name="6" id="anc6"></a><span class="line-modified"> 516             dependencies: [&quot;devkit&quot;, &quot;build_devkit&quot;],</span>
 517             configure_args: [
 518                 &quot;--openjdk-target=s390x-linux-gnu&quot;, &quot;--with-freetype=bundled&quot;,
 519                 &quot;--disable-warnings-as-errors&quot;
 520             ],
 521         },
 522     };
 523 
 524     // Add the base settings to all the main profiles
 525     common.main_profile_names.forEach(function (name) {
 526         profiles[name] = concatObjects(common.main_profile_base, profiles[name]);
 527     });
 528 
 529     // Generate debug versions of all the main profiles
 530     common.main_profile_names.forEach(function (name) {
 531         var debugName = name + common.debug_suffix;
 532         profiles[debugName] = concatObjects(profiles[name],
 533                                             common.debug_profile_base);
 534     });
 535     // Generate slowdebug versions of all the main profiles
 536     common.main_profile_names.forEach(function (name) {
 537         var debugName = name + common.slowdebug_suffix;
 538         profiles[debugName] = concatObjects(profiles[name],
 539                                             common.slowdebug_profile_base);
 540     });
 541     // Generate testmake profiles for the main profile of each build host
 542     // platform. This profile only runs the makefile tests.
 543     // Ant is needed to run the idea project generator test.
 544     var testmakeBase = {
 545         dependencies: [ &quot;ant&quot; ],
 546         environment: {
 547             &quot;ANT_HOME&quot;: input.get(&quot;ant&quot;, &quot;home_path&quot;)
 548         }
 549     };
 550     [ &quot;linux-x64&quot;, &quot;macosx-x64&quot;, &quot;solaris-sparcv9&quot;, &quot;solaris-x64&quot;, &quot;windows-x64&quot;]
 551         .forEach(function (name) {
 552             var maketestName = name + &quot;-testmake&quot;;
 553             profiles[maketestName] = concatObjects(profiles[name], testmakeBase);
 554             profiles[maketestName].default_make_targets = [ &quot;test-make&quot; ];
 555         });
 556 
 557     // Generate -gcov profiles
 558     [ &quot;linux-aarch64&quot;, &quot;linux-x64&quot;, &quot;macosx-x64&quot; ].forEach(function (name) {
 559         var gcovName = name + &quot;-gcov&quot;;
 560         profiles[gcovName] = clone(profiles[name]);
 561         profiles[gcovName].default_make_targets = [&quot;product-bundles&quot;, &quot;test-bundles&quot;];
 562         profiles[gcovName].configure_args = concat(profiles[gcovName].configure_args,
 563             [&quot;--enable-native-coverage&quot;, &quot;--disable-warnings-as-errors&quot;]);
 564     });
 565 
 566     // Profiles for building the zero jvm variant. These are used for verification.
 567     var zeroProfiles = {
 568         &quot;linux-x64-zero&quot;: {
 569             target_os: &quot;linux&quot;,
 570             target_cpu: &quot;x64&quot;,
 571             dependencies: [&quot;devkit&quot;],
 572             configure_args: concat(common.configure_args_64bit, [
 573                 &quot;--with-zlib=system&quot;,
 574                 &quot;--with-jvm-variants=zero&quot;,
 575                 &quot;--enable-libffi-bundling&quot;
 576             ])
 577         },
 578 
 579         &quot;linux-x86-zero&quot;: {
 580             target_os: &quot;linux&quot;,
 581             target_cpu: &quot;x86&quot;,
 582             build_cpu: &quot;x64&quot;,
 583             dependencies: [&quot;devkit&quot;],
 584             configure_args:  concat(common.configure_args_32bit, [
 585                 &quot;--with-zlib=system&quot;,
 586                 &quot;--with-jvm-variants=zero&quot;,
 587                 &quot;--enable-libffi-bundling&quot;
 588             ])
 589         }
 590     }
 591     profiles = concatObjects(profiles, zeroProfiles);
 592 
 593     // Add the base settings to the zero profiles and generate debug profiles
 594     Object.keys(zeroProfiles).forEach(function (name) {
 595         var debugName = name + common.debug_suffix;
 596         profiles[name] = concatObjects(common.main_profile_base, profiles[name]);
 597         profiles[debugName] = concatObjects(profiles[name], common.debug_profile_base);
 598     });
 599 
 600     // Define a profile with precompiled headers disabled. This is just used for
 601     // verfication of this build configuration.
 602     var noPchProfiles = {
 603         &quot;linux-x64-debug-nopch&quot;: {
 604             target_os: &quot;linux&quot;,
 605             target_cpu: &quot;x64&quot;,
 606             dependencies: [&quot;devkit&quot;],
 607             configure_args: concat(common.configure_args_64bit,
 608                 &quot;--with-zlib=system&quot;, &quot;--disable-precompiled-headers&quot;),
 609         },
 610     };
 611     profiles = concatObjects(profiles, noPchProfiles);
 612     // Add base settings to noPch profiles
 613     Object.keys(noPchProfiles).forEach(function (name) {
 614         profiles[name] = concatObjects(common.main_profile_base, profiles[name]);
 615         profiles[name] = concatObjects(common.debug_profile_base, profiles[name]);
 616         // Override default make target with hotspot as that&#39;s the only part of
 617         // the build using precompiled headers.
 618         profiles[name].default_make_targets = [&quot;hotspot&quot;];
 619     });
 620 
 621     // Bootcycle profiles runs the build with itself as the boot jdk. This can
 622     // be done in two ways. Either using the builtin bootcycle target in the
 623     // build system. Or by supplying the main jdk build as bootjdk to configure.
 624     [ &quot;linux-x64&quot;, &quot;macosx-x64&quot;, &quot;solaris-sparcv9&quot;, &quot;windows-x64&quot;]
 625         .forEach(function (name) {
 626             var bootcycleName = name + &quot;-bootcycle&quot;;
 627             var bootcyclePrebuiltName = name + &quot;-bootcycle-prebuilt&quot;;
 628             // The base bootcycle profile just changes the default target
 629             // compared to the base profile
 630             profiles[bootcycleName] = clone(profiles[name]);
 631             profiles[bootcycleName].default_make_targets = [ &quot;bootcycle-images&quot; ];
 632             // The prebuilt bootcycle variant modifies the boot jdk argument
 633             var bootcyclePrebuiltBase = {
 634                 dependencies: [ name + &quot;.jdk&quot; ],
<a name="7" id="anc7"></a><span class="line-modified"> 635                 configure_args: [</span>
<span class="line-added"> 636                     &quot;--with-boot-jdk=&quot; + input.get(name + &quot;.jdk&quot;, &quot;home_path&quot;),</span>
<span class="line-added"> 637                     // Full docs do not currently work with bootcycle build</span>
<span class="line-added"> 638                     // since Nashorn was removed. This negates the</span>
<span class="line-added"> 639                     // --enable-full-docs from the main profile.</span>
<span class="line-added"> 640                     &quot;--enable-full-docs=auto&quot;,</span>
<span class="line-added"> 641                 ]</span>
 642             }
 643             profiles[bootcyclePrebuiltName] = concatObjects(profiles[name],
 644                 bootcyclePrebuiltBase);
 645             var bootJdkIndex = profiles[bootcyclePrebuiltName].dependencies.indexOf(&quot;boot_jdk&quot;);
 646             delete profiles[bootcyclePrebuiltName].dependencies[bootJdkIndex];
 647             profiles[bootcyclePrebuiltName].default_make_targets = [ &quot;product-images&quot; ];
 648         });
 649 
 650     // JCov profiles build JCov-instrumented JDK image based on images provided through dependencies.
 651     [ &quot;linux-aarch64&quot;, &quot;linux-x64&quot;, &quot;macosx-x64&quot;, &quot;solaris-sparcv9&quot;, &quot;windows-x64&quot;]
 652         .forEach(function (name) {
 653             var jcovName = name + &quot;-jcov&quot;;
 654             profiles[jcovName] = clone(common.main_profile_base);
 655             profiles[jcovName].target_os = profiles[name].target_os
 656             profiles[jcovName].target_cpu = profiles[name].target_cpu
 657             profiles[jcovName].default_make_targets = [ &quot;jcov-bundles&quot; ];
 658             profiles[jcovName].dependencies = concat(profiles[jcovName].dependencies,
 659                 [ name + &quot;.jdk&quot;, &quot;devkit&quot; ]);
 660             profiles[jcovName].configure_args = concat(profiles[jcovName].configure_args,
 661                 [&quot;--with-jcov-input-jdk=&quot; + input.get(name + &quot;.jdk&quot;, &quot;home_path&quot;)]);
 662         });
 663 
 664     //
 665     // Define artifacts for profiles
 666     //
 667     // Macosx bundles are named osx
 668     // tar.gz.
 669     var artifactData = {
 670         &quot;linux-x64&quot;: {
 671             platform: &quot;linux-x64&quot;,
 672         },
 673         &quot;linux-x64-musl&quot;: {
 674             platform: &quot;linux-x64-musl&quot;,
 675             demo_ext: &quot;tar.gz&quot;
 676         },
 677         &quot;linux-x86&quot;: {
 678             platform: &quot;linux-x86&quot;,
 679         },
 680         &quot;macosx-x64&quot;: {
 681             platform: &quot;osx-x64&quot;,
 682             jdk_subdir: &quot;jdk-&quot; + data.version +  &quot;.jdk/Contents/Home&quot;,
 683         },
 684         &quot;solaris-x64&quot;: {
 685             platform: &quot;solaris-x64&quot;,
 686         },
 687         &quot;solaris-sparcv9&quot;: {
 688             platform: &quot;solaris-sparcv9&quot;,
 689         },
 690         &quot;windows-x64&quot;: {
 691             platform: &quot;windows-x64&quot;,
 692             jdk_suffix: &quot;zip&quot;,
 693         },
 694         &quot;windows-x86&quot;: {
 695             platform: &quot;windows-x86&quot;,
 696             jdk_suffix: &quot;zip&quot;,
 697         },
 698        &quot;linux-aarch64&quot;: {
 699             platform: &quot;linux-aarch64&quot;,
 700         },
 701        &quot;linux-arm32&quot;: {
 702             platform: &quot;linux-arm32&quot;,
 703         },
 704        &quot;linux-ppc64le&quot;: {
 705             platform: &quot;linux-ppc64le&quot;,
 706         },
 707        &quot;linux-s390x&quot;: {
 708             platform: &quot;linux-s390x&quot;,
 709         }
 710     }
 711     // Generate common artifacts for all main profiles
 712     Object.keys(artifactData).forEach(function (name) {
 713         profiles[name] = concatObjects(profiles[name],
 714             common.main_profile_artifacts(artifactData[name]));
 715     });
 716 
 717     // Generate common artifacts for all debug profiles
 718     Object.keys(artifactData).forEach(function (name) {
 719         var debugName = name + common.debug_suffix;
 720         profiles[debugName] = concatObjects(profiles[debugName],
 721             common.debug_profile_artifacts(artifactData[name]));
 722     });
 723 
 724     profilesArtifacts = {
 725         &quot;linux-x64&quot;: {
 726             artifacts: {
 727                 doc_api_spec: {
 728                     local: &quot;bundles/\\(jdk.*doc-api-spec.tar.gz\\)&quot;,
 729                     remote: [
 730                         &quot;bundles/common/jdk-&quot; + data.version + &quot;_doc-api-spec.tar.gz&quot;,
 731                         &quot;bundles/linux-x64/\\1&quot;
 732                     ],
 733                 },
 734             }
 735         }
 736     };
 737     profiles = concatObjects(profiles, profilesArtifacts);
 738 
 739     // Generate open only profiles for all the main and debug profiles.
 740     // Rewrite artifact remote paths by adding &quot;openjdk/GPL&quot;.
 741     common.main_profile_names.forEach(function (name) {
 742         var openName = name + common.open_suffix;
 743         profiles[openName] = concatObjects(profiles[name],
 744             common.open_profile_base);
 745         for (artifactName in profiles[openName].artifacts) {
 746             var artifact = profiles[openName].artifacts[artifactName];
 747             artifact.remote = replaceAll(
 748                 &quot;bundles\/&quot;, &quot;bundles/openjdk/GPL/&quot;,
 749                 (artifact.remote != null ? artifact.remote : artifact.local));
 750         }
 751         var debugName = name + common.debug_suffix;
 752         var openDebugName = name + common.open_suffix + common.debug_suffix;
 753         profiles[openDebugName] = concatObjects(profiles[debugName],
 754             common.open_profile_base);
 755         for (artifactName in profiles[openDebugName].artifacts) {
 756             var artifact = profiles[openDebugName].artifacts[artifactName];
 757             artifact.remote = replaceAll(
 758                 &quot;bundles\/&quot;, &quot;bundles/openjdk/GPL/&quot;,
 759                 (artifact.remote != null ? artifact.remote : artifact.local));
 760         }
 761     });
 762 
 763     // Define the reference implementation profiles. These are basically the same
 764     // as the open profiles, but upload artifacts to a different location.
 765     common.main_profile_names.forEach(function (name) {
 766         var riName = name + &quot;-ri&quot;;
 767         var riDebugName = riName + common.debug_suffix;
 768         var openName = name + common.open_suffix;
 769         var openDebugName = openName + common.debug_suffix;
 770         profiles[riName] = clone(profiles[openName]);
 771         profiles[riDebugName] = clone(profiles[openDebugName]);
 772         // Rewrite all remote dirs to &quot;bundles/openjdk/BCL/...&quot;
 773         for (artifactName in profiles[riName].artifacts) {
 774             var artifact = profiles[riName].artifacts[artifactName];
 775             artifact.remote = replaceAll(
 776                 &quot;\/GPL\/&quot;, &quot;/BCL/&quot;,
 777                 (artifact.remote != null ? artifact.remote : artifact.local));
 778         }
 779     });
 780 
 781     // For open profiles, the non-debug jdk bundles, need an &quot;open&quot; prefix on the
 782     // remote bundle names, forming the word &quot;openjdk&quot;. See JDK-8188789.
 783     common.main_profile_names.forEach(function (name) {
 784         var openName = name + common.open_suffix;
 785         profiles[openName].artifacts[&quot;jdk&quot;].remote = replaceAll(
 786             &quot;\/jdk-&quot;, &quot;/openjdk-&quot;,
 787             replaceAll(&quot;\/\\1&quot;, &quot;/open\\1&quot;,
 788                        profiles[openName].artifacts[&quot;jdk&quot;].remote));
 789     });
 790 
 791     // Generate cmp-baseline profiles for each main profile and their
 792     // corresponding debug profile. This profile does a compare build run with no
 793     // changes to verify that the compare script has a clean baseline
 794     common.main_profile_names.forEach(function (name) {
 795         [ &quot;&quot;, common.open_suffix ].forEach(function (suffix) {
 796             var cmpBaselineName = name + suffix + &quot;-cmp-baseline&quot;;
 797             profiles[cmpBaselineName] = clone(profiles[name + suffix]);
 798             // Only compare the images target. This should pressumably be expanded
 799             // to include more build targets when possible.
 800             profiles[cmpBaselineName].default_make_targets = [ &quot;images&quot;, &quot;test-image&quot; ];
 801             if (name == &quot;linux-x64&quot;) {
 802                 profiles[cmpBaselineName].default_make_targets
 803                     = concat(profiles[cmpBaselineName].default_make_targets, &quot;docs&quot;);
 804             }
 805             profiles[cmpBaselineName].make_args = [ &quot;COMPARE_BUILD=CONF=&quot; ];
 806             profiles[cmpBaselineName].configure_args = concat(
 807                 profiles[cmpBaselineName].configure_args,
 808                 &quot;--with-hotspot-build-time=n/a&quot;, 
 809                 &quot;--disable-precompiled-headers&quot;);
 810             // Do not inherit artifact definitions from base profile
 811             delete profiles[cmpBaselineName].artifacts;
 812         });
 813     });
 814 
 815     // Artifacts of JCov profiles
 816     [ &quot;linux-aarch64&quot;, &quot;linux-x64&quot;, &quot;macosx-x64&quot;, &quot;solaris-sparcv9&quot;, &quot;windows-x64&quot;]
 817         .forEach(function (name) {
 818             var o = artifactData[name]
 819             var jdk_subdir = (o.jdk_subdir != null ? o.jdk_subdir : &quot;jdk-&quot; + data.version);
 820             var jdk_suffix = (o.jdk_suffix != null ? o.jdk_suffix : &quot;tar.gz&quot;);
 821             var pf = o.platform
 822             var jcovName = name + &quot;-jcov&quot;;
 823             profiles[jcovName].artifacts = {
 824                 jdk: {
 825                     local: &quot;bundles/\\(jdk-jcov.*bin.&quot; + jdk_suffix + &quot;\\)&quot;,
 826                     remote: [
 827                         &quot;bundles/&quot; + pf + &quot;/jdk-jcov-&quot; + data.version + &quot;_&quot; + pf + &quot;_bin.&quot; + jdk_suffix
 828                     ],
 829                     subdir: jdk_subdir,
 830                     exploded: &quot;images/jdk-jcov&quot;
 831                 }
 832             };
 833         });
 834 
 835     // Artifacts of gcov (native-code-coverage) profiles
 836     [ &quot;linux-aarch64&quot;, &quot;linux-x64&quot;, &quot;macosx-x64&quot; ].forEach(function (name) {
 837         var o = artifactData[name]
 838         var pf = o.platform
 839         var jdk_subdir = (o.jdk_subdir != null ? o.jdk_subdir : &quot;jdk-&quot; + data.version);
 840         var jdk_suffix = (o.jdk_suffix != null ? o.jdk_suffix : &quot;tar.gz&quot;);
 841         var gcovName = name + &quot;-gcov&quot;;
 842         profiles[gcovName].artifacts = {
 843             jdk: {
 844                 local: &quot;bundles/\\(jdk.*bin.&quot; + jdk_suffix + &quot;\\)&quot;,
 845                 remote: [
 846                     &quot;bundles/&quot; + pf + &quot;/jdk-&quot; + data.version + &quot;_&quot; + pf + &quot;_bin-gcov.&quot; + jdk_suffix,
 847                 ],
 848                 subdir: jdk_subdir,
 849                 exploded: &quot;images/jdk&quot;,
 850             },
 851             test: {
 852                     local: &quot;bundles/\\(jdk.*bin-tests.tar.gz\\)&quot;,
 853                     remote: [
 854                         &quot;bundles/&quot; + pf + &quot;/jdk-&quot; + data.version + &quot;_&quot; + pf + &quot;_bin-gcov-tests.tar.gz&quot;,
 855                     ],
 856                     exploded: &quot;images/test&quot;
 857             },
 858             jdk_symbols: {
 859                     local: &quot;bundles/\\(jdk.*bin-symbols.tar.gz\\)&quot;,
 860                     remote: [
 861                         &quot;bundles/&quot; + pf + &quot;/jdk-&quot; + data.version + &quot;_&quot; + pf + &quot;_bin-gcov-symbols.tar.gz&quot;,
 862                     ],
 863                     subdir: jdk_subdir,
 864                     exploded: &quot;images/jdk&quot;
 865                 },
 866             };
 867     });
 868 
 869     // Profiles used to run tests.
 870     var testOnlyProfiles = {
 871         &quot;run-test&quot;: {
 872             target_os: input.build_os,
 873             target_cpu: input.build_cpu,
 874             dependencies: [ &quot;jtreg&quot;, &quot;gnumake&quot;, &quot;boot_jdk&quot;, &quot;devkit&quot;, &quot;jib&quot; ],
 875             labels: &quot;test&quot;,
 876             environment: {
 877                 &quot;JT_JAVA&quot;: common.boot_jdk_home
 878             }
 879         }
 880     };
 881     profiles = concatObjects(profiles, testOnlyProfiles);
 882 
 883     // Profiles used to run tests using Jib for internal dependencies.
 884     var testedProfile = input.testedProfile;
 885     if (testedProfile == null) {
 886         testedProfile = input.build_os + &quot;-&quot; + input.build_cpu;
 887     }
 888     var testedProfileJdk = testedProfile + &quot;.jdk&quot;;
 889     // Make it possible to use the test image from a different profile
 890     var testImageProfile;
 891     if (input.testImageProfile != null) {
 892         testImageProfile = input.testImageProfile;
 893     } else if (testedProfile.endsWith(&quot;-jcov&quot;)) {
 894         testImageProfile = testedProfile.substring(0, testedProfile.length - &quot;-jcov&quot;.length);
 895     } else {
 896         testImageProfile = testedProfile;
 897     }
 898     var testedProfileTest = testImageProfile + &quot;.test&quot;
 899     var testOnlyMake = [ &quot;test-prebuilt&quot;, &quot;LOG_CMDLINES=true&quot;, &quot;JTREG_VERBOSE=fail,error,time&quot; ];
 900     if (testedProfile.endsWith(&quot;-gcov&quot;)) {
 901         testOnlyMake = concat(testOnlyMake, &quot;GCOV_ENABLED=true&quot;)
 902     }
 903     var testOnlyProfilesPrebuilt = {
 904         &quot;run-test-prebuilt&quot;: {
 905             target_os: input.build_os,
 906             target_cpu: input.build_cpu,
 907             dependencies: [
 908                 &quot;jtreg&quot;, &quot;gnumake&quot;, &quot;boot_jdk&quot;, &quot;devkit&quot;, &quot;jib&quot;, &quot;jcov&quot;, testedProfileJdk,
 909                 testedProfileTest
 910             ],
 911             src: &quot;src.conf&quot;,
 912             make_args: testOnlyMake,
 913             environment: {
 914                 &quot;BOOT_JDK&quot;: common.boot_jdk_home,
 915                 &quot;JT_HOME&quot;: input.get(&quot;jtreg&quot;, &quot;home_path&quot;),
 916                 &quot;JDK_IMAGE_DIR&quot;: input.get(testedProfileJdk, &quot;home_path&quot;),
 917                 &quot;TEST_IMAGE_DIR&quot;: input.get(testedProfileTest, &quot;home_path&quot;)
 918             },
 919             labels: &quot;test&quot;
 920         }
 921     };
 922 
 923     // If actually running the run-test-prebuilt profile, verify that the input
 924     // variable is valid and if so, add the appropriate target_* values from
 925     // the tested profile. Use testImageProfile value as backup.
 926     if (input.profile == &quot;run-test-prebuilt&quot;) {
 927         if (profiles[testedProfile] == null &amp;&amp; profiles[testImageProfile] == null) {
 928             error(&quot;testedProfile is not defined: &quot; + testedProfile + &quot; &quot; + testImageProfile);
 929         }
 930     }
 931     if (profiles[testedProfile] != null) {
 932         testOnlyProfilesPrebuilt[&quot;run-test-prebuilt&quot;][&quot;target_os&quot;]
 933             = profiles[testedProfile][&quot;target_os&quot;];
 934         testOnlyProfilesPrebuilt[&quot;run-test-prebuilt&quot;][&quot;target_cpu&quot;]
 935             = profiles[testedProfile][&quot;target_cpu&quot;];
 936     } else if (profiles[testImageProfile] != null) {
 937         testOnlyProfilesPrebuilt[&quot;run-test-prebuilt&quot;][&quot;target_os&quot;]
 938             = profiles[testImageProfile][&quot;target_os&quot;];
 939         testOnlyProfilesPrebuilt[&quot;run-test-prebuilt&quot;][&quot;target_cpu&quot;]
 940             = profiles[testImageProfile][&quot;target_cpu&quot;];
 941     }
 942     profiles = concatObjects(profiles, testOnlyProfilesPrebuilt);
 943 
 944     // On macosx add the devkit bin dir to the path in all the run-test profiles.
 945     // This gives us a guaranteed working version of lldb for the jtreg failure handler.
 946     if (input.build_os == &quot;macosx&quot;) {
 947         macosxRunTestExtra = {
 948             environment_path: input.get(&quot;devkit&quot;, &quot;install_path&quot;)
 949                 + &quot;/Xcode.app/Contents/Developer/usr/bin&quot;
 950         };
 951         profiles[&quot;run-test&quot;] = concatObjects(profiles[&quot;run-test&quot;], macosxRunTestExtra);
 952         profiles[&quot;run-test-prebuilt&quot;] = concatObjects(profiles[&quot;run-test-prebuilt&quot;], macosxRunTestExtra);
 953     }
 954     // On windows we want the debug symbols available at test time
 955     if (input.build_os == &quot;windows&quot;) {
 956         windowsRunTestPrebuiltExtra = {
 957             dependencies: [ testedProfile + &quot;.jdk_symbols&quot; ],
 958             environment: {
 959                 &quot;SYMBOLS_IMAGE_DIR&quot;: input.get(testedProfile + &quot;.jdk_symbols&quot;, &quot;home_path&quot;),
 960             }
 961         };
 962         profiles[&quot;run-test-prebuilt&quot;] = concatObjects(profiles[&quot;run-test-prebuilt&quot;],
 963             windowsRunTestPrebuiltExtra);
 964     }
 965 
 966     // The profile run-test-prebuilt defines src.conf as the src bundle. When
 967     // running in Mach 5, this reduces the time it takes to populate the
 968     // considerably. But with just src.conf, we cannot actually run any tests,
 969     // so if running from a workspace with just src.conf in it, we need to also
 970     // get src.full as a dependency, and define the work_dir (where make gets
 971     // run) to be in the src.full install path. By running in the install path,
 972     // the same cached installation of the full src can be reused for multiple
 973     // test tasks. Care must however be taken not to polute that work dir by
 974     // setting the appropriate make variables to control output directories.
 975     //
 976     // Use the existance of the top level README as indication of if this is
 977     // the full source or just src.conf.
 978     if (!new java.io.File(__DIR__, &quot;../../README&quot;).exists()) {
 979         var runTestPrebuiltSrcFullExtra = {
 980             dependencies: &quot;src.full&quot;,
 981             work_dir: input.get(&quot;src.full&quot;, &quot;install_path&quot;),
 982         }
 983         profiles[&quot;run-test-prebuilt&quot;] = concatObjects(profiles[&quot;run-test-prebuilt&quot;],
 984             runTestPrebuiltSrcFullExtra);
 985     }
 986 
 987     // Generate the missing platform attributes
 988     profiles = generatePlatformAttributes(profiles);
 989     profiles = generateDefaultMakeTargetsConfigureArg(common, profiles);
 990     return profiles;
 991 };
 992 
 993 /**
 994  * Generate the dependencies part of the configuration
 995  *
 996  * @param input External data to use for generating the configuration
 997  * @param common The common values
 998  * @returns {{}} Dependencies part of configuration
 999  */
1000 var getJibProfilesDependencies = function (input, common) {
1001 
1002     var devkit_platform_revisions = {
1003         linux_x64: &quot;gcc9.2.0-OL6.4+1.0&quot;,
1004         macosx_x64: &quot;Xcode10.1-MacOSX10.14+1.0&quot;,
1005         solaris_x64: &quot;SS12u4-Solaris11u1+1.0&quot;,
1006         solaris_sparcv9: &quot;SS12u6-Solaris11u3+1.0&quot;,
<a name="8" id="anc8"></a><span class="line-modified">1007         windows_x64: &quot;VS2019-16.5.3+1.0&quot;,</span>
<span class="line-modified">1008         linux_aarch64: &quot;gcc9.2.0-OL7.6+1.0&quot;,</span>
1009         linux_arm: &quot;gcc8.2.0-Fedora27+1.0&quot;,
1010         linux_ppc64le: &quot;gcc8.2.0-Fedora27+1.0&quot;,
1011         linux_s390x: &quot;gcc8.2.0-Fedora27+1.0&quot;
1012     };
1013 
1014     var devkit_platform = (input.target_cpu == &quot;x86&quot;
1015         ? input.target_os + &quot;_x64&quot;
1016         : input.target_platform);
1017 
1018     var devkit_cross_prefix = &quot;&quot;;
1019     if (input.build_platform != input.target_platform
1020        &amp;&amp; input.build_platform != devkit_platform) {
1021         devkit_cross_prefix = input.build_platform + &quot;-to-&quot;;
1022     }
1023 
1024     var boot_jdk_platform = (input.build_os == &quot;macosx&quot; ? &quot;osx&quot; : input.build_os)
1025         + &quot;-&quot; + input.build_cpu +
1026         (input.build_libc ? &quot;-&quot; + input.build_libc : &quot;&quot;);
1027     var boot_jdk_ext = (input.build_os == &quot;windows&quot; ? &quot;.zip&quot; : &quot;.tar.gz&quot;)
1028     // If running in WSL and building for Windows, it will look like Linux,
1029     // but we need a Windows boot JDK.
1030     if (isWsl(input) &amp;&amp; input.target_os == &quot;windows&quot;) {
1031         boot_jdk_platform = &quot;windows-&quot; + input.build_cpu;
1032         boot_jdk_ext = &quot;.zip&quot;;
1033     }
1034 
1035     var makeBinDir = (input.build_os == &quot;windows&quot;
1036         ? input.get(&quot;gnumake&quot;, &quot;install_path&quot;) + &quot;/cygwin/bin&quot;
1037         : input.get(&quot;gnumake&quot;, &quot;install_path&quot;) + &quot;/bin&quot;);
1038 
1039     if (input.build_cpu == &#39;aarch64&#39;) {
<a name="9" id="anc9"></a><span class="line-modified">1040         boot_jdk = {</span>
1041             organization: common.organization,
1042             ext: &quot;tar.gz&quot;,
1043             module: &quot;jdk-linux_aarch64&quot;,
<a name="10" id="anc10"></a><span class="line-modified">1044             revision: &quot;14+1.0&quot;,</span>
1045             configure_args: &quot;--with-boot-jdk=&quot; + common.boot_jdk_home,
1046             environment_path: common.boot_jdk_home + &quot;/bin&quot;
<a name="11" id="anc11"></a><span class="line-modified">1047         }</span>
1048     } else {
<a name="12" id="anc12"></a><span class="line-modified">1049         boot_jdk = {</span>
1050             server: &quot;jpg&quot;,
1051             product: input.build_libc == &quot;musl&quot; ? &quot;jdk-portola&quot; : &quot;jdk&quot;,
1052             version: common.boot_jdk_version,
1053             build_number: common.boot_jdk_build_number,
1054             file: &quot;bundles/&quot; + boot_jdk_platform + &quot;/jdk-&quot; + common.boot_jdk_version + &quot;_&quot;
1055                 + boot_jdk_platform + &quot;_bin&quot; + boot_jdk_ext,
1056             configure_args: &quot;--with-boot-jdk=&quot; + common.boot_jdk_home,
1057             environment_path: common.boot_jdk_home + &quot;/bin&quot;
<a name="13" id="anc13"></a><span class="line-modified">1058         }</span>
<span class="line-added">1059     }</span>
<span class="line-added">1060     if (input.build_cpu == &#39;sparcv9&#39;) {</span>
<span class="line-added">1061         boot_jdk.file = &quot;bundles/openjdk/GPL/&quot; + boot_jdk_platform</span>
<span class="line-added">1062             + &quot;/openjdk-&quot; + common.boot_jdk_version + &quot;_&quot;</span>
<span class="line-added">1063             + boot_jdk_platform + &quot;_bin&quot; + boot_jdk_ext;</span>
1064     }
1065 
1066     var dependencies = {
1067         boot_jdk: boot_jdk,
1068 
1069         devkit: {
1070             organization: common.organization,
1071             ext: &quot;tar.gz&quot;,
1072             module: &quot;devkit-&quot; + devkit_cross_prefix + devkit_platform,
1073             revision: devkit_platform_revisions[devkit_platform],
1074             environment: {
1075                 &quot;DEVKIT_HOME&quot;: input.get(&quot;devkit&quot;, &quot;home_path&quot;),
1076             }
1077         },
1078 
1079         build_devkit: {
1080             organization: common.organization,
1081             ext: &quot;tar.gz&quot;,
1082             module: &quot;devkit-&quot; + input.build_platform,
1083             revision: devkit_platform_revisions[input.build_platform]
1084         },
1085 
1086         cups: {
1087             organization: common.organization,
1088             ext: &quot;tar.gz&quot;,
1089             revision: &quot;1.0118+1.0&quot;
1090         },
1091 
1092         jtreg: {
1093             server: &quot;jpg&quot;,
1094             product: &quot;jtreg&quot;,
1095             version: &quot;5.0&quot;,
1096             build_number: &quot;b01&quot;,
1097             checksum_file: &quot;MD5_VALUES&quot;,
1098             file: &quot;bundles/jtreg_bin-5.0.zip&quot;,
1099             environment_name: &quot;JT_HOME&quot;,
1100             environment_path: input.get(&quot;jtreg&quot;, &quot;home_path&quot;) + &quot;/bin&quot;,
1101             configure_args: &quot;--with-jtreg=&quot; + input.get(&quot;jtreg&quot;, &quot;home_path&quot;),
1102         },
1103 
1104         jmh: {
1105             organization: common.organization,
1106             ext: &quot;tar.gz&quot;,
1107             revision: &quot;1.21+1.0&quot;
1108         },
1109 
1110         jcov: {
1111             // Until an official build of JCov is available, use custom
1112             // build to support classfile version 57.
1113             // See CODETOOLS-7902358 for more info.
1114             // server: &quot;jpg&quot;,
1115             // product: &quot;jcov&quot;,
1116             // version: &quot;3.0&quot;,
1117             // build_number: &quot;b07&quot;,
1118             // file: &quot;bundles/jcov-3_0.zip&quot;,
1119             organization: common.organization,
1120             revision: &quot;3.0-59-support+1.0&quot;,
1121             ext: &quot;zip&quot;,
1122             environment_name: &quot;JCOV_HOME&quot;,
1123         },
1124 
1125         gnumake: {
1126             organization: common.organization,
1127             ext: &quot;tar.gz&quot;,
1128             revision: &quot;4.0+1.0&quot;,
1129 
1130             module: (input.build_os == &quot;windows&quot;
1131                 ? &quot;gnumake-&quot; + input.build_osenv_platform
1132                 : &quot;gnumake-&quot; + input.build_platform),
1133 
1134             configure_args: &quot;MAKE=&quot; + makeBinDir + &quot;/make&quot;,
1135 
1136             environment: {
1137                 &quot;MAKE&quot;: makeBinDir + &quot;/make&quot;
1138             },
1139 
1140             environment_path: makeBinDir
1141         },
1142 
1143         autoconf: {
1144             organization: common.organization,
1145             ext: &quot;tar.gz&quot;,
1146             revision: &quot;2.69+1.0.1&quot;,
1147             module: (input.build_os == &quot;windows&quot;
1148                 ? &quot;autoconf-&quot; + input.build_osenv_platform
1149                 : &quot;autoconf-&quot; + input.build_platform),
1150             configure_args: &quot;&quot;,
1151             environment_path: input.get(&quot;autoconf&quot;, &quot;install_path&quot;)
1152         },
1153 
1154         graphviz: {
1155             organization: common.organization,
1156             ext: &quot;tar.gz&quot;,
1157             revision: &quot;2.38.0-1+1.1&quot;,
1158             module: &quot;graphviz-&quot; + input.target_platform,
1159             configure_args: &quot;DOT=&quot; + input.get(&quot;graphviz&quot;, &quot;install_path&quot;) + &quot;/dot&quot;,
1160             environment_path: input.get(&quot;graphviz&quot;, &quot;install_path&quot;)
1161         },
1162 
1163         pandoc: {
1164             organization: common.organization,
1165             ext: &quot;tar.gz&quot;,
<a name="14" id="anc14"></a><span class="line-modified">1166             revision: (input.build_cpu == &#39;aarch64&#39; ? &quot;2.5+1.0&quot; : &quot;2.3.1+1.0&quot;),</span>
1167             module: &quot;pandoc-&quot; + input.build_platform,
1168             configure_args: &quot;PANDOC=&quot; + input.get(&quot;pandoc&quot;, &quot;install_path&quot;) + &quot;/pandoc/pandoc&quot;,
1169             environment_path: input.get(&quot;pandoc&quot;, &quot;install_path&quot;) + &quot;/pandoc&quot;
1170         },
1171 
1172         // This adds java jib as a dependency for the test artifacts resolver
1173         jib: {
1174             organization: &quot;com.oracle.java.jib&quot;,
1175             ext: &quot;zip&quot;,
1176             classifier: &quot;distribution&quot;,
1177             revision: &quot;3.0-SNAPSHOT&quot;,
1178             environment_name: &quot;JIB_HOME&quot;,
1179             environment_value: input.get(&quot;jib&quot;, &quot;home_path&quot;)
1180         },
1181 
1182         ant: {
1183             organization: common.organization,
1184             ext: &quot;zip&quot;,
1185             revision: &quot;1.7.1+1.0&quot;,
1186             configure_args: &quot;&quot;,
1187         },
1188 
1189         graalunit_lib: {
1190             organization: common.organization,
1191             ext: &quot;zip&quot;,
1192             revision: &quot;619_Apr_12_2018&quot;,
1193             module: &quot;graalunit-lib&quot;,
1194             configure_args: &quot;--with-graalunit-lib=&quot; + input.get(&quot;graalunit_lib&quot;, &quot;install_path&quot;),
1195             environment_name: &quot;GRAALUNIT_LIB&quot;
1196         },
1197     };
1198 
1199     return dependencies;
1200 };
1201 
1202 /**
1203  * Generate the missing platform attributes for profiles
1204  *
1205  * @param profiles Profiles map to generate attributes on
1206  * @returns {{}} New profiles map with platform attributes fully filled in
1207  */
1208 var generatePlatformAttributes = function (profiles) {
1209     var ret = concatObjects(profiles, {});
1210     for (var profile in profiles) {
1211         if (ret[profile].build_os == null) {
1212             ret[profile].build_os = ret[profile].target_os;
1213         }
1214         if (ret[profile].build_cpu == null) {
1215             ret[profile].build_cpu = ret[profile].target_cpu;
1216         }
1217         ret[profile].target_platform = ret[profile].target_os + &quot;_&quot; + ret[profile].target_cpu;
1218         ret[profile].build_platform = ret[profile].build_os + &quot;_&quot; + ret[profile].build_cpu;
1219     }
1220     return ret;
1221 };
1222 
1223 /**
1224  * The default_make_targets attribute on a profile is not a real Jib attribute.
1225  * This function rewrites that attribute into the corresponding configure arg.
1226  * Calling this function multiple times on the same profiles object is safe.
1227  *
1228  * @param common Common values
1229  * @param profiles Profiles map to rewrite profiles for
1230  * @returns {{}} New map of profiles with the make targets converted
1231  */
1232 var generateDefaultMakeTargetsConfigureArg = function (common, profiles) {
1233     var ret = concatObjects(profiles, {});
1234     for (var profile in ret) {
1235         if (ret[profile][&quot;default_make_targets&quot;] != null) {
1236             var targetsString = concat(ret[profile].default_make_targets).join(&quot; &quot;);
1237             // Iterate over all configure args and see if --with-default-make-target
1238             // is already there and change it, otherwise add it.
1239             var found = false;
1240             for (var i in ret[profile].configure_args) {
1241                 var arg = ret[profile].configure_args[i];
1242                 if (arg != null &amp;&amp; arg.startsWith(&quot;--with-default-make-target=&quot;)) {
1243                     found = true;
1244                     ret[profile].configure_args[i]
1245                         = &quot;--with-default-make-target=&quot; + targetsString;
1246                 }
1247             }
1248             if (!found) {
1249                 ret[profile].configure_args = concat(
1250                     ret[profile].configure_args,
1251                     &quot;--with-default-make-target=&quot; + targetsString);
1252             }
1253         }
1254     }
1255     return ret;
1256 }
1257 
1258 var getBuildId = function (input) {
1259     if (input.build_id != null) {
1260         return input.build_id;
1261     } else {
1262         var topdir = new java.io.File(__DIR__, &quot;../..&quot;).getCanonicalFile().getName();
1263         var userName = java.lang.System.getProperty(&quot;user.name&quot;);
1264         return userName + &quot;.&quot; + topdir;
1265     }
1266 }
1267 
1268 /**
1269  * Deep clones an object tree.
1270  *
1271  * @param o Object to clone
1272  * @returns {{}} Clone of o
1273  */
1274 var clone = function (o) {
1275     return JSON.parse(JSON.stringify(o));
1276 };
1277 
1278 /**
1279  * Concatenates all arguments into a new array
1280  *
1281  * @returns {Array.&lt;T&gt;} New array containing all arguments
1282  */
1283 var concat = function () {
1284     return Array.prototype.concat.apply([], arguments);
1285 };
1286 
1287 /**
1288  * Takes a String or Array of Strings and does a replace operation on each
1289  * of them.
1290  *
1291  * @param pattern Pattern to look for
1292  * @param replacement Replacement text to insert
1293  * @param a String or Array of Strings to replace
1294  * @returns {Array} Either a new array or a new string depending on the input
1295  */
1296 var replaceAll = function (pattern, replacement, a) {
1297     // If a is an array
1298     if (Array === a.constructor) {
1299     var newA = [];
1300     for (var i in a) {
1301             newA.push(a[i].replace(pattern, replacement));
1302         }
1303         return newA;
1304         } else {
1305         return a.replace(pattern, replacement);
1306     }
1307 };
1308 
1309 /**
1310  * Deep concatenation of two objects. For each node encountered, merge
1311  * the contents with the corresponding node in the other object tree,
1312  * treating all strings as array elements.
1313  *
1314  * @param o1 Object to concatenate
1315  * @param o2 Object to concatenate
1316  * @returns {{}} New object tree containing the concatenation of o1 and o2
1317  */
1318 var concatObjects = function (o1, o2) {
1319     if (o1 == null) {
1320         return clone(o2);
1321     }
1322     if (o2 == null) {
1323         return clone(o1);
1324     }
1325     var ret = {};
1326     for (var a in o1) {
1327         if (o2[a] == null) {
1328             ret[a] = clone(o1[a]);
1329         }
1330     }
1331     for (var a in o2) {
1332         if (o1[a] == null) {
1333             ret[a] = clone(o2[a]);
1334         } else {
1335             if (typeof o1[a] == &#39;string&#39;) {
1336                 ret[a] = clone([o1[a]].concat(o2[a]));
1337             } else if (Array.isArray(o1[a])) {
1338                 ret[a] = clone(o1[a].concat(o2[a]));
1339             } else if (typeof o1[a] == &#39;object&#39;) {
1340                 ret[a] = concatObjects(o1[a], o2[a]);
1341             }
1342         }
1343     }
1344     return ret;
1345 };
1346 
1347 /**
1348  * Constructs the numeric version string from reading the
1349  * make/autoconf/version-numbers file and removing all trailing &quot;.0&quot;.
1350  *
1351  * @param feature Override feature version
1352  * @param interim Override interim version
1353  * @param update Override update version
1354  * @param patch Override patch version
1355  * @returns {String} The numeric version string
1356  */
1357 var getVersion = function (feature, interim, update, patch) {
1358     var version_numbers = getVersionNumbers();
1359     var version = (feature != null ? feature : version_numbers.get(&quot;DEFAULT_VERSION_FEATURE&quot;))
1360         + &quot;.&quot; + (interim != null ? interim : version_numbers.get(&quot;DEFAULT_VERSION_INTERIM&quot;))
1361         + &quot;.&quot; + (update != null ? update :  version_numbers.get(&quot;DEFAULT_VERSION_UPDATE&quot;))
1362         + &quot;.&quot; + (patch != null ? patch : version_numbers.get(&quot;DEFAULT_VERSION_PATCH&quot;))
1363         + &quot;.&quot; + version_numbers.get(&quot;DEFAULT_VERSION_EXTRA1&quot;)
1364         + &quot;.&quot; + version_numbers.get(&quot;DEFAULT_VERSION_EXTRA2&quot;)
1365         + &quot;.&quot; + version_numbers.get(&quot;DEFAULT_VERSION_EXTRA3&quot;);
1366     while (version.match(&quot;.*\\.0$&quot;)) {
1367         version = version.substring(0, version.length - 2);
1368     }
1369     return version;
1370 };
1371 
1372 /**
1373  * Constructs the common version configure args based on build type and
1374  * other version inputs
1375  */
1376 var versionArgs = function(input, common) {
1377     var args = [&quot;--with-version-build=&quot; + common.build_number];
1378     if (input.build_type == &quot;promoted&quot;) {
1379         args = concat(args,
1380                       &quot;--with-version-pre=&quot; + version_numbers.get(&quot;DEFAULT_PROMOTED_VERSION_PRE&quot;),
1381                       &quot;--without-version-opt&quot;);
1382     } else if (input.build_type == &quot;ci&quot;) {
1383         var optString = input.build_id_data.ciBuildNumber;
1384         var preString = input.build_id_data.projectName;
1385         if (preString == &quot;jdk&quot;) {
1386             preString = version_numbers.get(&quot;DEFAULT_PROMOTED_VERSION_PRE&quot;);
1387         }
1388         args = concat(args, &quot;--with-version-pre=&quot; + preString,
1389                      &quot;--with-version-opt=&quot; + optString);
1390     } else {
1391         args = concat(args, &quot;--with-version-opt=&quot; + common.build_id);
1392     }
1393     return args;
1394 }
1395 
1396 // Properties representation of the make/autoconf/version-numbers file. Lazily
1397 // initiated by the function below.
1398 var version_numbers;
1399 
1400 /**
1401  * Read the make/autoconf/version-numbers file into a Properties object.
1402  *
1403  * @returns {java.utilProperties}
1404  */
1405 var getVersionNumbers = function () {
1406     // Read version information from make/autoconf/version-numbers
1407     if (version_numbers == null) {
1408         version_numbers = new java.util.Properties();
1409         var stream = new java.io.FileInputStream(__DIR__ + &quot;/../autoconf/version-numbers&quot;);
1410         version_numbers.load(stream);
1411         stream.close();
1412     }
1413     return version_numbers;
1414 }
1415 
1416 /**
1417  * Returns true if running in Windows Subsystem for Linux. Jib does not yet
1418  * detect wsl as osenv, so fall back on linux with version containing Microsoft.
1419  */
1420 var isWsl = function (input) {
1421     return ( input.build_osenv == &quot;wsl&quot;
1422              || (input.build_os == &quot;linux&quot;
1423                  &amp;&amp; java.lang.System.getProperty(&quot;os.version&quot;).contains(&quot;Microsoft&quot;)));
1424 }
1425 
1426 var error = function (s) {
1427     java.lang.System.err.println(&quot;[ERROR] &quot; + s);
1428     exit(1);
1429 };
<a name="15" id="anc15"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="15" type="hidden" />
</body>
</html>