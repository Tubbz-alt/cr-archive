<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old src/hotspot/os/linux/os_linux.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 1999, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 // no precompiled headers
  26 #include &quot;jvm.h&quot;
  27 #include &quot;classfile/classLoader.hpp&quot;
  28 #include &quot;classfile/systemDictionary.hpp&quot;
  29 #include &quot;classfile/vmSymbols.hpp&quot;
  30 #include &quot;code/icBuffer.hpp&quot;
  31 #include &quot;code/vtableStubs.hpp&quot;
  32 #include &quot;compiler/compileBroker.hpp&quot;
  33 #include &quot;compiler/disassembler.hpp&quot;
  34 #include &quot;interpreter/interpreter.hpp&quot;
  35 #include &quot;logging/log.hpp&quot;
  36 #include &quot;logging/logStream.hpp&quot;
  37 #include &quot;memory/allocation.inline.hpp&quot;
  38 #include &quot;memory/filemap.hpp&quot;
  39 #include &quot;oops/oop.inline.hpp&quot;
  40 #include &quot;os_linux.inline.hpp&quot;
  41 #include &quot;os_posix.inline.hpp&quot;
  42 #include &quot;os_share_linux.hpp&quot;
  43 #include &quot;osContainer_linux.hpp&quot;
  44 #include &quot;prims/jniFastGetField.hpp&quot;
  45 #include &quot;prims/jvm_misc.hpp&quot;
  46 #include &quot;runtime/arguments.hpp&quot;
  47 #include &quot;runtime/atomic.hpp&quot;
  48 #include &quot;runtime/extendedPC.hpp&quot;
  49 #include &quot;runtime/globals.hpp&quot;
  50 #include &quot;runtime/interfaceSupport.inline.hpp&quot;
  51 #include &quot;runtime/init.hpp&quot;
  52 #include &quot;runtime/java.hpp&quot;
  53 #include &quot;runtime/javaCalls.hpp&quot;
  54 #include &quot;runtime/mutexLocker.hpp&quot;
  55 #include &quot;runtime/objectMonitor.hpp&quot;
  56 #include &quot;runtime/osThread.hpp&quot;
  57 #include &quot;runtime/perfMemory.hpp&quot;
  58 #include &quot;runtime/sharedRuntime.hpp&quot;
  59 #include &quot;runtime/statSampler.hpp&quot;
  60 #include &quot;runtime/stubRoutines.hpp&quot;
  61 #include &quot;runtime/thread.inline.hpp&quot;
  62 #include &quot;runtime/threadCritical.hpp&quot;
  63 #include &quot;runtime/threadSMR.hpp&quot;
  64 #include &quot;runtime/timer.hpp&quot;
  65 #include &quot;runtime/vm_version.hpp&quot;
  66 #include &quot;semaphore_posix.hpp&quot;
  67 #include &quot;services/attachListener.hpp&quot;
  68 #include &quot;services/memTracker.hpp&quot;
  69 #include &quot;services/runtimeService.hpp&quot;
  70 #include &quot;utilities/align.hpp&quot;
  71 #include &quot;utilities/decoder.hpp&quot;
  72 #include &quot;utilities/defaultStream.hpp&quot;
  73 #include &quot;utilities/events.hpp&quot;
  74 #include &quot;utilities/elfFile.hpp&quot;
  75 #include &quot;utilities/growableArray.hpp&quot;
  76 #include &quot;utilities/macros.hpp&quot;
  77 #include &quot;utilities/powerOfTwo.hpp&quot;
  78 #include &quot;utilities/vmError.hpp&quot;
  79 
  80 // put OS-includes here
  81 # include &lt;sys/types.h&gt;
  82 # include &lt;sys/mman.h&gt;
  83 # include &lt;sys/stat.h&gt;
  84 # include &lt;sys/select.h&gt;
  85 # include &lt;pthread.h&gt;
  86 # include &lt;signal.h&gt;
  87 # include &lt;endian.h&gt;
  88 # include &lt;errno.h&gt;
  89 # include &lt;dlfcn.h&gt;
  90 # include &lt;stdio.h&gt;
  91 # include &lt;unistd.h&gt;
  92 # include &lt;sys/resource.h&gt;
  93 # include &lt;pthread.h&gt;
  94 # include &lt;sys/stat.h&gt;
  95 # include &lt;sys/time.h&gt;
  96 # include &lt;sys/times.h&gt;
  97 # include &lt;sys/utsname.h&gt;
  98 # include &lt;sys/socket.h&gt;
  99 # include &lt;sys/wait.h&gt;
 100 # include &lt;pwd.h&gt;
 101 # include &lt;poll.h&gt;
 102 # include &lt;fcntl.h&gt;
 103 # include &lt;string.h&gt;
 104 # include &lt;syscall.h&gt;
 105 # include &lt;sys/sysinfo.h&gt;
 106 # include &lt;sys/ipc.h&gt;
 107 # include &lt;sys/shm.h&gt;
 108 # include &lt;link.h&gt;
 109 # include &lt;stdint.h&gt;
 110 # include &lt;inttypes.h&gt;
 111 # include &lt;sys/ioctl.h&gt;
 112 # include &lt;linux/elf-em.h&gt;
 113 
 114 #ifndef _GNU_SOURCE
 115   #define _GNU_SOURCE
 116   #include &lt;sched.h&gt;
 117   #undef _GNU_SOURCE
 118 #else
 119   #include &lt;sched.h&gt;
 120 #endif
 121 
 122 // if RUSAGE_THREAD for getrusage() has not been defined, do it here. The code calling
 123 // getrusage() is prepared to handle the associated failure.
 124 #ifndef RUSAGE_THREAD
 125   #define RUSAGE_THREAD   (1)               /* only the calling thread */
 126 #endif
 127 
 128 #define MAX_PATH    (2 * K)
 129 
 130 #define MAX_SECS 100000000
 131 
 132 // for timer info max values which include all bits
 133 #define ALL_64_BITS CONST64(0xFFFFFFFFFFFFFFFF)
 134 
 135 enum CoredumpFilterBit {
 136   FILE_BACKED_PVT_BIT = 1 &lt;&lt; 2,
 137   FILE_BACKED_SHARED_BIT = 1 &lt;&lt; 3,
 138   LARGEPAGES_BIT = 1 &lt;&lt; 6,
 139   DAX_SHARED_BIT = 1 &lt;&lt; 8
 140 };
 141 
 142 ////////////////////////////////////////////////////////////////////////////////
 143 // global variables
 144 julong os::Linux::_physical_memory = 0;
 145 
 146 address   os::Linux::_initial_thread_stack_bottom = NULL;
 147 uintptr_t os::Linux::_initial_thread_stack_size   = 0;
 148 
 149 int (*os::Linux::_pthread_getcpuclockid)(pthread_t, clockid_t *) = NULL;
 150 int (*os::Linux::_pthread_setname_np)(pthread_t, const char*) = NULL;
 151 pthread_t os::Linux::_main_thread;
 152 int os::Linux::_page_size = -1;
 153 bool os::Linux::_supports_fast_thread_cpu_time = false;
 154 const char * os::Linux::_glibc_version = &quot;unknown&quot;;
 155 const char * os::Linux::_libpthread_version = &quot;unknown&quot;;
 156 size_t os::Linux::_default_large_page_size = 0;
 157 
 158 static jlong initial_time_count=0;
 159 
 160 static int clock_tics_per_sec = 100;
 161 
 162 // If the VM might have been created on the primordial thread, we need to resolve the
 163 // primordial thread stack bounds and check if the current thread might be the
 164 // primordial thread in places. If we know that the primordial thread is never used,
 165 // such as when the VM was created by one of the standard java launchers, we can
 166 // avoid this
 167 static bool suppress_primordial_thread_resolution = false;
 168 
 169 // For diagnostics to print a message once. see run_periodic_checks
 170 static sigset_t check_signal_done;
 171 static bool check_signals = true;
 172 
 173 // Signal number used to suspend/resume a thread
 174 
 175 // do not use any signal number less than SIGSEGV, see 4355769
 176 static int SR_signum = SIGUSR2;
 177 sigset_t SR_sigset;
 178 
 179 // utility functions
 180 
 181 static int SR_initialize();
 182 
 183 julong os::available_memory() {
 184   return Linux::available_memory();
 185 }
 186 
 187 julong os::Linux::available_memory() {
 188   // values in struct sysinfo are &quot;unsigned long&quot;
 189   struct sysinfo si;
 190   julong avail_mem;
 191 
 192   if (OSContainer::is_containerized()) {
 193     jlong mem_limit, mem_usage;
 194     if ((mem_limit = OSContainer::memory_limit_in_bytes()) &lt; 1) {
 195       log_debug(os, container)(&quot;container memory limit %s: &quot; JLONG_FORMAT &quot;, using host value&quot;,
 196                              mem_limit == OSCONTAINER_ERROR ? &quot;failed&quot; : &quot;unlimited&quot;, mem_limit);
 197     }
 198     if (mem_limit &gt; 0 &amp;&amp; (mem_usage = OSContainer::memory_usage_in_bytes()) &lt; 1) {
 199       log_debug(os, container)(&quot;container memory usage failed: &quot; JLONG_FORMAT &quot;, using host value&quot;, mem_usage);
 200     }
 201     if (mem_limit &gt; 0 &amp;&amp; mem_usage &gt; 0 ) {
 202       avail_mem = mem_limit &gt; mem_usage ? (julong)mem_limit - (julong)mem_usage : 0;
 203       log_trace(os)(&quot;available container memory: &quot; JULONG_FORMAT, avail_mem);
 204       return avail_mem;
 205     }
 206   }
 207 
 208   sysinfo(&amp;si);
 209   avail_mem = (julong)si.freeram * si.mem_unit;
 210   log_trace(os)(&quot;available memory: &quot; JULONG_FORMAT, avail_mem);
 211   return avail_mem;
 212 }
 213 
 214 julong os::physical_memory() {
 215   jlong phys_mem = 0;
 216   if (OSContainer::is_containerized()) {
 217     jlong mem_limit;
 218     if ((mem_limit = OSContainer::memory_limit_in_bytes()) &gt; 0) {
 219       log_trace(os)(&quot;total container memory: &quot; JLONG_FORMAT, mem_limit);
 220       return mem_limit;
 221     }
 222     log_debug(os, container)(&quot;container memory limit %s: &quot; JLONG_FORMAT &quot;, using host value&quot;,
 223                             mem_limit == OSCONTAINER_ERROR ? &quot;failed&quot; : &quot;unlimited&quot;, mem_limit);
 224   }
 225 
 226   phys_mem = Linux::physical_memory();
 227   log_trace(os)(&quot;total system memory: &quot; JLONG_FORMAT, phys_mem);
 228   return phys_mem;
 229 }
 230 
 231 static uint64_t initial_total_ticks = 0;
 232 static uint64_t initial_steal_ticks = 0;
 233 static bool     has_initial_tick_info = false;
 234 
 235 static void next_line(FILE *f) {
 236   int c;
 237   do {
 238     c = fgetc(f);
 239   } while (c != &#39;\n&#39; &amp;&amp; c != EOF);
 240 }
 241 
 242 bool os::Linux::get_tick_information(CPUPerfTicks* pticks, int which_logical_cpu) {
 243   FILE*         fh;
 244   uint64_t      userTicks, niceTicks, systemTicks, idleTicks;
 245   // since at least kernel 2.6 : iowait: time waiting for I/O to complete
 246   // irq: time  servicing interrupts; softirq: time servicing softirqs
 247   uint64_t      iowTicks = 0, irqTicks = 0, sirqTicks= 0;
 248   // steal (since kernel 2.6.11): time spent in other OS when running in a virtualized environment
 249   uint64_t      stealTicks = 0;
 250   // guest (since kernel 2.6.24): time spent running a virtual CPU for guest OS under the
 251   // control of the Linux kernel
 252   uint64_t      guestNiceTicks = 0;
 253   int           logical_cpu = -1;
 254   const int     required_tickinfo_count = (which_logical_cpu == -1) ? 4 : 5;
 255   int           n;
 256 
 257   memset(pticks, 0, sizeof(CPUPerfTicks));
 258 
 259   if ((fh = fopen(&quot;/proc/stat&quot;, &quot;r&quot;)) == NULL) {
 260     return false;
 261   }
 262 
 263   if (which_logical_cpu == -1) {
 264     n = fscanf(fh, &quot;cpu &quot; UINT64_FORMAT &quot; &quot; UINT64_FORMAT &quot; &quot; UINT64_FORMAT &quot; &quot;
 265             UINT64_FORMAT &quot; &quot; UINT64_FORMAT &quot; &quot; UINT64_FORMAT &quot; &quot; UINT64_FORMAT &quot; &quot;
 266             UINT64_FORMAT &quot; &quot; UINT64_FORMAT &quot; &quot;,
 267             &amp;userTicks, &amp;niceTicks, &amp;systemTicks, &amp;idleTicks,
 268             &amp;iowTicks, &amp;irqTicks, &amp;sirqTicks,
 269             &amp;stealTicks, &amp;guestNiceTicks);
 270   } else {
 271     // Move to next line
 272     next_line(fh);
 273 
 274     // find the line for requested cpu faster to just iterate linefeeds?
 275     for (int i = 0; i &lt; which_logical_cpu; i++) {
 276       next_line(fh);
 277     }
 278 
 279     n = fscanf(fh, &quot;cpu%u &quot; UINT64_FORMAT &quot; &quot; UINT64_FORMAT &quot; &quot; UINT64_FORMAT &quot; &quot;
 280                UINT64_FORMAT &quot; &quot; UINT64_FORMAT &quot; &quot; UINT64_FORMAT &quot; &quot; UINT64_FORMAT &quot; &quot;
 281                UINT64_FORMAT &quot; &quot; UINT64_FORMAT &quot; &quot;,
 282                &amp;logical_cpu, &amp;userTicks, &amp;niceTicks,
 283                &amp;systemTicks, &amp;idleTicks, &amp;iowTicks, &amp;irqTicks, &amp;sirqTicks,
 284                &amp;stealTicks, &amp;guestNiceTicks);
 285   }
 286 
 287   fclose(fh);
 288   if (n &lt; required_tickinfo_count || logical_cpu != which_logical_cpu) {
 289     return false;
 290   }
 291   pticks-&gt;used       = userTicks + niceTicks;
 292   pticks-&gt;usedKernel = systemTicks + irqTicks + sirqTicks;
 293   pticks-&gt;total      = userTicks + niceTicks + systemTicks + idleTicks +
 294                        iowTicks + irqTicks + sirqTicks + stealTicks + guestNiceTicks;
 295 
 296   if (n &gt; required_tickinfo_count + 3) {
 297     pticks-&gt;steal = stealTicks;
 298     pticks-&gt;has_steal_ticks = true;
 299   } else {
 300     pticks-&gt;steal = 0;
 301     pticks-&gt;has_steal_ticks = false;
 302   }
 303 
 304   return true;
 305 }
 306 
 307 // Return true if user is running as root.
 308 
 309 bool os::have_special_privileges() {
 310   static bool init = false;
 311   static bool privileges = false;
 312   if (!init) {
 313     privileges = (getuid() != geteuid()) || (getgid() != getegid());
 314     init = true;
 315   }
 316   return privileges;
 317 }
 318 
 319 
 320 #ifndef SYS_gettid
 321 // i386: 224, ia64: 1105, amd64: 186, sparc 143
 322   #ifdef __ia64__
 323     #define SYS_gettid 1105
 324   #else
 325     #ifdef __i386__
 326       #define SYS_gettid 224
 327     #else
 328       #ifdef __amd64__
 329         #define SYS_gettid 186
 330       #else
 331         #ifdef __sparc__
 332           #define SYS_gettid 143
 333         #else
 334           #error define gettid for the arch
 335         #endif
 336       #endif
 337     #endif
 338   #endif
 339 #endif
 340 
 341 
 342 // pid_t gettid()
 343 //
 344 // Returns the kernel thread id of the currently running thread. Kernel
 345 // thread id is used to access /proc.
 346 pid_t os::Linux::gettid() {
 347   int rslt = syscall(SYS_gettid);
 348   assert(rslt != -1, &quot;must be.&quot;); // old linuxthreads implementation?
 349   return (pid_t)rslt;
 350 }
 351 
 352 // Most versions of linux have a bug where the number of processors are
 353 // determined by looking at the /proc file system.  In a chroot environment,
 354 // the system call returns 1.
 355 static bool unsafe_chroot_detected = false;
 356 static const char *unstable_chroot_error = &quot;/proc file system not found.\n&quot;
 357                      &quot;Java may be unstable running multithreaded in a chroot &quot;
 358                      &quot;environment on Linux when /proc filesystem is not mounted.&quot;;
 359 
 360 void os::Linux::initialize_system_info() {
 361   set_processor_count(sysconf(_SC_NPROCESSORS_CONF));
 362   if (processor_count() == 1) {
 363     pid_t pid = os::Linux::gettid();
 364     char fname[32];
 365     jio_snprintf(fname, sizeof(fname), &quot;/proc/%d&quot;, pid);
 366     FILE *fp = fopen(fname, &quot;r&quot;);
 367     if (fp == NULL) {
 368       unsafe_chroot_detected = true;
 369     } else {
 370       fclose(fp);
 371     }
 372   }
 373   _physical_memory = (julong)sysconf(_SC_PHYS_PAGES) * (julong)sysconf(_SC_PAGESIZE);
 374   assert(processor_count() &gt; 0, &quot;linux error&quot;);
 375 }
 376 
 377 void os::init_system_properties_values() {
 378   // The next steps are taken in the product version:
 379   //
 380   // Obtain the JAVA_HOME value from the location of libjvm.so.
 381   // This library should be located at:
 382   // &lt;JAVA_HOME&gt;/lib/{client|server}/libjvm.so.
 383   //
 384   // If &quot;/jre/lib/&quot; appears at the right place in the path, then we
 385   // assume libjvm.so is installed in a JDK and we use this path.
 386   //
 387   // Otherwise exit with message: &quot;Could not create the Java virtual machine.&quot;
 388   //
 389   // The following extra steps are taken in the debugging version:
 390   //
 391   // If &quot;/jre/lib/&quot; does NOT appear at the right place in the path
 392   // instead of exit check for $JAVA_HOME environment variable.
 393   //
 394   // If it is defined and we are able to locate $JAVA_HOME/jre/lib/&lt;arch&gt;,
 395   // then we append a fake suffix &quot;hotspot/libjvm.so&quot; to this path so
 396   // it looks like libjvm.so is installed there
 397   // &lt;JAVA_HOME&gt;/jre/lib/&lt;arch&gt;/hotspot/libjvm.so.
 398   //
 399   // Otherwise exit.
 400   //
 401   // Important note: if the location of libjvm.so changes this
 402   // code needs to be changed accordingly.
 403 
 404   // See ld(1):
 405   //      The linker uses the following search paths to locate required
 406   //      shared libraries:
 407   //        1: ...
 408   //        ...
 409   //        7: The default directories, normally /lib and /usr/lib.
 410 #ifndef OVERRIDE_LIBPATH
 411   #if defined(AMD64) || (defined(_LP64) &amp;&amp; defined(SPARC)) || defined(PPC64) || defined(S390)
 412     #define DEFAULT_LIBPATH &quot;/usr/lib64:/lib64:/lib:/usr/lib&quot;
 413   #else
 414     #define DEFAULT_LIBPATH &quot;/lib:/usr/lib&quot;
 415   #endif
 416 #else
 417   #define DEFAULT_LIBPATH OVERRIDE_LIBPATH
 418 #endif
 419 
 420 // Base path of extensions installed on the system.
 421 #define SYS_EXT_DIR     &quot;/usr/java/packages&quot;
 422 #define EXTENSIONS_DIR  &quot;/lib/ext&quot;
 423 
 424   // Buffer that fits several sprintfs.
 425   // Note that the space for the colon and the trailing null are provided
 426   // by the nulls included by the sizeof operator.
 427   const size_t bufsize =
 428     MAX2((size_t)MAXPATHLEN,  // For dll_dir &amp; friends.
 429          (size_t)MAXPATHLEN + sizeof(EXTENSIONS_DIR) + sizeof(SYS_EXT_DIR) + sizeof(EXTENSIONS_DIR)); // extensions dir
 430   char *buf = NEW_C_HEAP_ARRAY(char, bufsize, mtInternal);
 431 
 432   // sysclasspath, java_home, dll_dir
 433   {
 434     char *pslash;
 435     os::jvm_path(buf, bufsize);
 436 
 437     // Found the full path to libjvm.so.
 438     // Now cut the path to &lt;java_home&gt;/jre if we can.
 439     pslash = strrchr(buf, &#39;/&#39;);
 440     if (pslash != NULL) {
 441       *pslash = &#39;\0&#39;;            // Get rid of /libjvm.so.
 442     }
 443     pslash = strrchr(buf, &#39;/&#39;);
 444     if (pslash != NULL) {
 445       *pslash = &#39;\0&#39;;            // Get rid of /{client|server|hotspot}.
 446     }
 447     Arguments::set_dll_dir(buf);
 448 
 449     if (pslash != NULL) {
 450       pslash = strrchr(buf, &#39;/&#39;);
 451       if (pslash != NULL) {
 452         *pslash = &#39;\0&#39;;        // Get rid of /lib.
 453       }
 454     }
 455     Arguments::set_java_home(buf);
 456     if (!set_boot_path(&#39;/&#39;, &#39;:&#39;)) {
 457       vm_exit_during_initialization(&quot;Failed setting boot class path.&quot;, NULL);
 458     }
 459   }
 460 
 461   // Where to look for native libraries.
 462   //
 463   // Note: Due to a legacy implementation, most of the library path
 464   // is set in the launcher. This was to accomodate linking restrictions
 465   // on legacy Linux implementations (which are no longer supported).
 466   // Eventually, all the library path setting will be done here.
 467   //
 468   // However, to prevent the proliferation of improperly built native
 469   // libraries, the new path component /usr/java/packages is added here.
 470   // Eventually, all the library path setting will be done here.
 471   {
 472     // Get the user setting of LD_LIBRARY_PATH, and prepended it. It
 473     // should always exist (until the legacy problem cited above is
 474     // addressed).
 475     const char *v = ::getenv(&quot;LD_LIBRARY_PATH&quot;);
 476     const char *v_colon = &quot;:&quot;;
 477     if (v == NULL) { v = &quot;&quot;; v_colon = &quot;&quot;; }
 478     // That&#39;s +1 for the colon and +1 for the trailing &#39;\0&#39;.
 479     char *ld_library_path = NEW_C_HEAP_ARRAY(char,
 480                                              strlen(v) + 1 +
 481                                              sizeof(SYS_EXT_DIR) + sizeof(&quot;/lib/&quot;) + sizeof(DEFAULT_LIBPATH) + 1,
 482                                              mtInternal);
 483     sprintf(ld_library_path, &quot;%s%s&quot; SYS_EXT_DIR &quot;/lib:&quot; DEFAULT_LIBPATH, v, v_colon);
 484     Arguments::set_library_path(ld_library_path);
 485     FREE_C_HEAP_ARRAY(char, ld_library_path);
 486   }
 487 
 488   // Extensions directories.
 489   sprintf(buf, &quot;%s&quot; EXTENSIONS_DIR &quot;:&quot; SYS_EXT_DIR EXTENSIONS_DIR, Arguments::get_java_home());
 490   Arguments::set_ext_dirs(buf);
 491 
 492   FREE_C_HEAP_ARRAY(char, buf);
 493 
 494 #undef DEFAULT_LIBPATH
 495 #undef SYS_EXT_DIR
 496 #undef EXTENSIONS_DIR
 497 }
 498 
 499 ////////////////////////////////////////////////////////////////////////////////
 500 // breakpoint support
 501 
 502 void os::breakpoint() {
 503   BREAKPOINT;
 504 }
 505 
 506 extern &quot;C&quot; void breakpoint() {
 507   // use debugger to set breakpoint here
 508 }
 509 
 510 ////////////////////////////////////////////////////////////////////////////////
 511 // signal support
 512 
 513 debug_only(static bool signal_sets_initialized = false);
 514 static sigset_t unblocked_sigs, vm_sigs;
 515 
 516 void os::Linux::signal_sets_init() {
 517   // Should also have an assertion stating we are still single-threaded.
 518   assert(!signal_sets_initialized, &quot;Already initialized&quot;);
 519   // Fill in signals that are necessarily unblocked for all threads in
 520   // the VM. Currently, we unblock the following signals:
 521   // SHUTDOWN{1,2,3}_SIGNAL: for shutdown hooks support (unless over-ridden
 522   //                         by -Xrs (=ReduceSignalUsage));
 523   // BREAK_SIGNAL which is unblocked only by the VM thread and blocked by all
 524   // other threads. The &quot;ReduceSignalUsage&quot; boolean tells us not to alter
 525   // the dispositions or masks wrt these signals.
 526   // Programs embedding the VM that want to use the above signals for their
 527   // own purposes must, at this time, use the &quot;-Xrs&quot; option to prevent
 528   // interference with shutdown hooks and BREAK_SIGNAL thread dumping.
 529   // (See bug 4345157, and other related bugs).
 530   // In reality, though, unblocking these signals is really a nop, since
 531   // these signals are not blocked by default.
 532   sigemptyset(&amp;unblocked_sigs);
 533   sigaddset(&amp;unblocked_sigs, SIGILL);
 534   sigaddset(&amp;unblocked_sigs, SIGSEGV);
 535   sigaddset(&amp;unblocked_sigs, SIGBUS);
 536   sigaddset(&amp;unblocked_sigs, SIGFPE);
 537 #if defined(PPC64)
 538   sigaddset(&amp;unblocked_sigs, SIGTRAP);
 539 #endif
 540   sigaddset(&amp;unblocked_sigs, SR_signum);
 541 
 542   if (!ReduceSignalUsage) {
 543     if (!os::Posix::is_sig_ignored(SHUTDOWN1_SIGNAL)) {
 544       sigaddset(&amp;unblocked_sigs, SHUTDOWN1_SIGNAL);
 545     }
 546     if (!os::Posix::is_sig_ignored(SHUTDOWN2_SIGNAL)) {
 547       sigaddset(&amp;unblocked_sigs, SHUTDOWN2_SIGNAL);
 548     }
 549     if (!os::Posix::is_sig_ignored(SHUTDOWN3_SIGNAL)) {
 550       sigaddset(&amp;unblocked_sigs, SHUTDOWN3_SIGNAL);
 551     }
 552   }
 553   // Fill in signals that are blocked by all but the VM thread.
 554   sigemptyset(&amp;vm_sigs);
 555   if (!ReduceSignalUsage) {
 556     sigaddset(&amp;vm_sigs, BREAK_SIGNAL);
 557   }
 558   debug_only(signal_sets_initialized = true);
 559 
 560 }
 561 
 562 // These are signals that are unblocked while a thread is running Java.
 563 // (For some reason, they get blocked by default.)
 564 sigset_t* os::Linux::unblocked_signals() {
 565   assert(signal_sets_initialized, &quot;Not initialized&quot;);
 566   return &amp;unblocked_sigs;
 567 }
 568 
 569 // These are the signals that are blocked while a (non-VM) thread is
 570 // running Java. Only the VM thread handles these signals.
 571 sigset_t* os::Linux::vm_signals() {
 572   assert(signal_sets_initialized, &quot;Not initialized&quot;);
 573   return &amp;vm_sigs;
 574 }
 575 
 576 void os::Linux::hotspot_sigmask(Thread* thread) {
 577 
 578   //Save caller&#39;s signal mask before setting VM signal mask
 579   sigset_t caller_sigmask;
 580   pthread_sigmask(SIG_BLOCK, NULL, &amp;caller_sigmask);
 581 
 582   OSThread* osthread = thread-&gt;osthread();
 583   osthread-&gt;set_caller_sigmask(caller_sigmask);
 584 
 585   pthread_sigmask(SIG_UNBLOCK, os::Linux::unblocked_signals(), NULL);
 586 
 587   if (!ReduceSignalUsage) {
 588     if (thread-&gt;is_VM_thread()) {
 589       // Only the VM thread handles BREAK_SIGNAL ...
 590       pthread_sigmask(SIG_UNBLOCK, vm_signals(), NULL);
 591     } else {
 592       // ... all other threads block BREAK_SIGNAL
 593       pthread_sigmask(SIG_BLOCK, vm_signals(), NULL);
 594     }
 595   }
 596 }
 597 
 598 //////////////////////////////////////////////////////////////////////////////
 599 // detecting pthread library
 600 
 601 void os::Linux::libpthread_init() {
 602   // Save glibc and pthread version strings.
 603 #if !defined(_CS_GNU_LIBC_VERSION) || \
 604     !defined(_CS_GNU_LIBPTHREAD_VERSION)
 605   #error &quot;glibc too old (&lt; 2.3.2)&quot;
 606 #endif
 607 
 608   size_t n;
 609 
 610   n = confstr(_CS_GNU_LIBC_VERSION, NULL, 0);
 611   if (n &gt; 0) {
 612     char* str = (char *)malloc(n, mtInternal);
 613     confstr(_CS_GNU_LIBC_VERSION, str, n);
 614     os::Linux::set_glibc_version(str);
 615   }
 616 
 617   n = confstr(_CS_GNU_LIBPTHREAD_VERSION, NULL, 0);
 618   if (n &gt; 0) {
 619     char* str = (char *)malloc(n, mtInternal);
 620     confstr(_CS_GNU_LIBPTHREAD_VERSION, str, n);
 621     os::Linux::set_libpthread_version(str);
 622   }
 623 }
 624 
 625 /////////////////////////////////////////////////////////////////////////////
 626 // thread stack expansion
 627 
 628 // os::Linux::manually_expand_stack() takes care of expanding the thread
 629 // stack. Note that this is normally not needed: pthread stacks allocate
 630 // thread stack using mmap() without MAP_NORESERVE, so the stack is already
 631 // committed. Therefore it is not necessary to expand the stack manually.
 632 //
 633 // Manually expanding the stack was historically needed on LinuxThreads
 634 // thread stacks, which were allocated with mmap(MAP_GROWSDOWN). Nowadays
 635 // it is kept to deal with very rare corner cases:
 636 //
 637 // For one, user may run the VM on an own implementation of threads
 638 // whose stacks are - like the old LinuxThreads - implemented using
 639 // mmap(MAP_GROWSDOWN).
 640 //
 641 // Also, this coding may be needed if the VM is running on the primordial
 642 // thread. Normally we avoid running on the primordial thread; however,
 643 // user may still invoke the VM on the primordial thread.
 644 //
 645 // The following historical comment describes the details about running
 646 // on a thread stack allocated with mmap(MAP_GROWSDOWN):
 647 
 648 
 649 // Force Linux kernel to expand current thread stack. If &quot;bottom&quot; is close
 650 // to the stack guard, caller should block all signals.
 651 //
 652 // MAP_GROWSDOWN:
 653 //   A special mmap() flag that is used to implement thread stacks. It tells
 654 //   kernel that the memory region should extend downwards when needed. This
 655 //   allows early versions of LinuxThreads to only mmap the first few pages
 656 //   when creating a new thread. Linux kernel will automatically expand thread
 657 //   stack as needed (on page faults).
 658 //
 659 //   However, because the memory region of a MAP_GROWSDOWN stack can grow on
 660 //   demand, if a page fault happens outside an already mapped MAP_GROWSDOWN
 661 //   region, it&#39;s hard to tell if the fault is due to a legitimate stack
 662 //   access or because of reading/writing non-exist memory (e.g. buffer
 663 //   overrun). As a rule, if the fault happens below current stack pointer,
 664 //   Linux kernel does not expand stack, instead a SIGSEGV is sent to the
 665 //   application (see Linux kernel fault.c).
 666 //
 667 //   This Linux feature can cause SIGSEGV when VM bangs thread stack for
 668 //   stack overflow detection.
 669 //
 670 //   Newer version of LinuxThreads (since glibc-2.2, or, RH-7.x) and NPTL do
 671 //   not use MAP_GROWSDOWN.
 672 //
 673 // To get around the problem and allow stack banging on Linux, we need to
 674 // manually expand thread stack after receiving the SIGSEGV.
 675 //
 676 // There are two ways to expand thread stack to address &quot;bottom&quot;, we used
 677 // both of them in JVM before 1.5:
 678 //   1. adjust stack pointer first so that it is below &quot;bottom&quot;, and then
 679 //      touch &quot;bottom&quot;
 680 //   2. mmap() the page in question
 681 //
 682 // Now alternate signal stack is gone, it&#39;s harder to use 2. For instance,
 683 // if current sp is already near the lower end of page 101, and we need to
 684 // call mmap() to map page 100, it is possible that part of the mmap() frame
 685 // will be placed in page 100. When page 100 is mapped, it is zero-filled.
 686 // That will destroy the mmap() frame and cause VM to crash.
 687 //
 688 // The following code works by adjusting sp first, then accessing the &quot;bottom&quot;
 689 // page to force a page fault. Linux kernel will then automatically expand the
 690 // stack mapping.
 691 //
 692 // _expand_stack_to() assumes its frame size is less than page size, which
 693 // should always be true if the function is not inlined.
 694 
 695 static void NOINLINE _expand_stack_to(address bottom) {
 696   address sp;
 697   size_t size;
 698   volatile char *p;
 699 
 700   // Adjust bottom to point to the largest address within the same page, it
 701   // gives us a one-page buffer if alloca() allocates slightly more memory.
 702   bottom = (address)align_down((uintptr_t)bottom, os::Linux::page_size());
 703   bottom += os::Linux::page_size() - 1;
 704 
 705   // sp might be slightly above current stack pointer; if that&#39;s the case, we
 706   // will alloca() a little more space than necessary, which is OK. Don&#39;t use
 707   // os::current_stack_pointer(), as its result can be slightly below current
 708   // stack pointer, causing us to not alloca enough to reach &quot;bottom&quot;.
 709   sp = (address)&amp;sp;
 710 
 711   if (sp &gt; bottom) {
 712     size = sp - bottom;
 713     p = (volatile char *)alloca(size);
 714     assert(p != NULL &amp;&amp; p &lt;= (volatile char *)bottom, &quot;alloca problem?&quot;);
 715     p[0] = &#39;\0&#39;;
 716   }
 717 }
 718 
 719 void os::Linux::expand_stack_to(address bottom) {
 720   _expand_stack_to(bottom);
 721 }
 722 
 723 bool os::Linux::manually_expand_stack(JavaThread * t, address addr) {
 724   assert(t!=NULL, &quot;just checking&quot;);
 725   assert(t-&gt;osthread()-&gt;expanding_stack(), &quot;expand should be set&quot;);
 726 
 727   if (t-&gt;is_in_usable_stack(addr)) {
 728     sigset_t mask_all, old_sigset;
 729     sigfillset(&amp;mask_all);
 730     pthread_sigmask(SIG_SETMASK, &amp;mask_all, &amp;old_sigset);
 731     _expand_stack_to(addr);
 732     pthread_sigmask(SIG_SETMASK, &amp;old_sigset, NULL);
 733     return true;
 734   }
 735   return false;
 736 }
 737 
 738 //////////////////////////////////////////////////////////////////////////////
 739 // create new thread
 740 
 741 // Thread start routine for all newly created threads
 742 static void *thread_native_entry(Thread *thread) {
 743 
 744   thread-&gt;record_stack_base_and_size();
 745 
 746   // Try to randomize the cache line index of hot stack frames.
 747   // This helps when threads of the same stack traces evict each other&#39;s
 748   // cache lines. The threads can be either from the same JVM instance, or
 749   // from different JVM instances. The benefit is especially true for
 750   // processors with hyperthreading technology.
 751   static int counter = 0;
 752   int pid = os::current_process_id();
 753   alloca(((pid ^ counter++) &amp; 7) * 128);
 754 
 755   thread-&gt;initialize_thread_current();
 756 
 757   OSThread* osthread = thread-&gt;osthread();
 758   Monitor* sync = osthread-&gt;startThread_lock();
 759 
 760   osthread-&gt;set_thread_id(os::current_thread_id());
 761 
 762   log_info(os, thread)(&quot;Thread is alive (tid: &quot; UINTX_FORMAT &quot;, pthread id: &quot; UINTX_FORMAT &quot;).&quot;,
 763     os::current_thread_id(), (uintx) pthread_self());
 764 
 765   if (UseNUMA) {
 766     int lgrp_id = os::numa_get_group_id();
 767     if (lgrp_id != -1) {
 768       thread-&gt;set_lgrp_id(lgrp_id);
 769     }
 770   }
 771   // initialize signal mask for this thread
 772   os::Linux::hotspot_sigmask(thread);
 773 
 774   // initialize floating point control register
 775   os::Linux::init_thread_fpu_state();
 776 
 777   // handshaking with parent thread
 778   {
 779     MutexLocker ml(sync, Mutex::_no_safepoint_check_flag);
 780 
 781     // notify parent thread
 782     osthread-&gt;set_state(INITIALIZED);
 783     sync-&gt;notify_all();
 784 
 785     // wait until os::start_thread()
 786     while (osthread-&gt;get_state() == INITIALIZED) {
 787       sync-&gt;wait_without_safepoint_check();
 788     }
 789   }
 790 
 791   assert(osthread-&gt;pthread_id() != 0, &quot;pthread_id was not set as expected&quot;);
 792 
 793   // call one more level start routine
 794   thread-&gt;call_run();
 795 
 796   // Note: at this point the thread object may already have deleted itself.
 797   // Prevent dereferencing it from here on out.
 798   thread = NULL;
 799 
 800   log_info(os, thread)(&quot;Thread finished (tid: &quot; UINTX_FORMAT &quot;, pthread id: &quot; UINTX_FORMAT &quot;).&quot;,
 801     os::current_thread_id(), (uintx) pthread_self());
 802 
 803   return 0;
 804 }
 805 
 806 // On Linux, glibc places static TLS blocks (for __thread variables) on
 807 // the thread stack. This decreases the stack size actually available
 808 // to threads.
 809 //
 810 // For large static TLS sizes, this may cause threads to malfunction due
 811 // to insufficient stack space. This is a well-known issue in glibc:
 812 // http://sourceware.org/bugzilla/show_bug.cgi?id=11787.
 813 //
 814 // As a workaround, we call a private but assumed-stable glibc function,
 815 // __pthread_get_minstack() to obtain the minstack size and derive the
 816 // static TLS size from it. We then increase the user requested stack
 817 // size by this TLS size.
 818 //
 819 // Due to compatibility concerns, this size adjustment is opt-in and
 820 // controlled via AdjustStackSizeForTLS.
 821 typedef size_t (*GetMinStack)(const pthread_attr_t *attr);
 822 
 823 GetMinStack _get_minstack_func = NULL;
 824 
 825 static void get_minstack_init() {
 826   _get_minstack_func =
 827         (GetMinStack)dlsym(RTLD_DEFAULT, &quot;__pthread_get_minstack&quot;);
 828   log_info(os, thread)(&quot;Lookup of __pthread_get_minstack %s&quot;,
 829                        _get_minstack_func == NULL ? &quot;failed&quot; : &quot;succeeded&quot;);
 830 }
 831 
 832 // Returns the size of the static TLS area glibc puts on thread stacks.
 833 // The value is cached on first use, which occurs when the first thread
 834 // is created during VM initialization.
 835 static size_t get_static_tls_area_size(const pthread_attr_t *attr) {
 836   size_t tls_size = 0;
 837   if (_get_minstack_func != NULL) {
 838     // Obtain the pthread minstack size by calling __pthread_get_minstack.
 839     size_t minstack_size = _get_minstack_func(attr);
 840 
 841     // Remove non-TLS area size included in minstack size returned
 842     // by __pthread_get_minstack() to get the static TLS size.
 843     // In glibc before 2.27, minstack size includes guard_size.
 844     // In glibc 2.27 and later, guard_size is automatically added
 845     // to the stack size by pthread_create and is no longer included
 846     // in minstack size. In both cases, the guard_size is taken into
 847     // account, so there is no need to adjust the result for that.
 848     //
 849     // Although __pthread_get_minstack() is a private glibc function,
 850     // it is expected to have a stable behavior across future glibc
 851     // versions while glibc still allocates the static TLS blocks off
 852     // the stack. Following is glibc 2.28 __pthread_get_minstack():
 853     //
 854     // size_t
 855     // __pthread_get_minstack (const pthread_attr_t *attr)
 856     // {
 857     //   return GLRO(dl_pagesize) + __static_tls_size + PTHREAD_STACK_MIN;
 858     // }
 859     //
 860     //
 861     // The following &#39;minstack_size &gt; os::vm_page_size() + PTHREAD_STACK_MIN&#39;
 862     // if check is done for precaution.
 863     if (minstack_size &gt; (size_t)os::vm_page_size() + PTHREAD_STACK_MIN) {
 864       tls_size = minstack_size - os::vm_page_size() - PTHREAD_STACK_MIN;
 865     }
 866   }
 867 
 868   log_info(os, thread)(&quot;Stack size adjustment for TLS is &quot; SIZE_FORMAT,
 869                        tls_size);
 870   return tls_size;
 871 }
 872 
 873 bool os::create_thread(Thread* thread, ThreadType thr_type,
 874                        size_t req_stack_size) {
 875   assert(thread-&gt;osthread() == NULL, &quot;caller responsible&quot;);
 876 
 877   // Allocate the OSThread object
 878   OSThread* osthread = new OSThread(NULL, NULL);
 879   if (osthread == NULL) {
 880     return false;
 881   }
 882 
 883   // set the correct thread state
 884   osthread-&gt;set_thread_type(thr_type);
 885 
 886   // Initial state is ALLOCATED but not INITIALIZED
 887   osthread-&gt;set_state(ALLOCATED);
 888 
 889   thread-&gt;set_osthread(osthread);
 890 
 891   // init thread attributes
 892   pthread_attr_t attr;
 893   pthread_attr_init(&amp;attr);
 894   pthread_attr_setdetachstate(&amp;attr, PTHREAD_CREATE_DETACHED);
 895 
 896   // Calculate stack size if it&#39;s not specified by caller.
 897   size_t stack_size = os::Posix::get_initial_stack_size(thr_type, req_stack_size);
 898   // In glibc versions prior to 2.7 the guard size mechanism
 899   // is not implemented properly. The posix standard requires adding
 900   // the size of the guard pages to the stack size, instead Linux
 901   // takes the space out of &#39;stacksize&#39;. Thus we adapt the requested
 902   // stack_size by the size of the guard pages to mimick proper
 903   // behaviour. However, be careful not to end up with a size
 904   // of zero due to overflow. Don&#39;t add the guard page in that case.
 905   size_t guard_size = os::Linux::default_guard_size(thr_type);
 906   // Configure glibc guard page. Must happen before calling
 907   // get_static_tls_area_size(), which uses the guard_size.
 908   pthread_attr_setguardsize(&amp;attr, guard_size);
 909 
 910   size_t stack_adjust_size = 0;
 911   if (AdjustStackSizeForTLS) {
 912     // Adjust the stack_size for on-stack TLS - see get_static_tls_area_size().
 913     stack_adjust_size += get_static_tls_area_size(&amp;attr);
 914   } else {
 915     stack_adjust_size += guard_size;
 916   }
 917 
 918   stack_adjust_size = align_up(stack_adjust_size, os::vm_page_size());
 919   if (stack_size &lt;= SIZE_MAX - stack_adjust_size) {
 920     stack_size += stack_adjust_size;
 921   }
 922   assert(is_aligned(stack_size, os::vm_page_size()), &quot;stack_size not aligned&quot;);
 923 
 924   int status = pthread_attr_setstacksize(&amp;attr, stack_size);
 925   assert_status(status == 0, status, &quot;pthread_attr_setstacksize&quot;);
 926 
 927   ThreadState state;
 928 
 929   {
 930     pthread_t tid;
 931     int ret = pthread_create(&amp;tid, &amp;attr, (void* (*)(void*)) thread_native_entry, thread);
 932 
 933     char buf[64];
 934     if (ret == 0) {
 935       log_info(os, thread)(&quot;Thread started (pthread id: &quot; UINTX_FORMAT &quot;, attributes: %s). &quot;,
 936         (uintx) tid, os::Posix::describe_pthread_attr(buf, sizeof(buf), &amp;attr));
 937     } else {
 938       log_warning(os, thread)(&quot;Failed to start thread - pthread_create failed (%s) for attributes: %s.&quot;,
 939         os::errno_name(ret), os::Posix::describe_pthread_attr(buf, sizeof(buf), &amp;attr));
 940       // Log some OS information which might explain why creating the thread failed.
 941       log_info(os, thread)(&quot;Number of threads approx. running in the VM: %d&quot;, Threads::number_of_threads());
 942       LogStream st(Log(os, thread)::info());
 943       os::Posix::print_rlimit_info(&amp;st);
 944       os::print_memory_info(&amp;st);
 945       os::Linux::print_proc_sys_info(&amp;st);
 946       os::Linux::print_container_info(&amp;st);
 947     }
 948 
 949     pthread_attr_destroy(&amp;attr);
 950 
 951     if (ret != 0) {
 952       // Need to clean up stuff we&#39;ve allocated so far
 953       thread-&gt;set_osthread(NULL);
 954       delete osthread;
 955       return false;
 956     }
 957 
 958     // Store pthread info into the OSThread
 959     osthread-&gt;set_pthread_id(tid);
 960 
 961     // Wait until child thread is either initialized or aborted
 962     {
 963       Monitor* sync_with_child = osthread-&gt;startThread_lock();
 964       MutexLocker ml(sync_with_child, Mutex::_no_safepoint_check_flag);
 965       while ((state = osthread-&gt;get_state()) == ALLOCATED) {
 966         sync_with_child-&gt;wait_without_safepoint_check();
 967       }
 968     }
 969   }
 970 
 971   // Aborted due to thread limit being reached
 972   if (state == ZOMBIE) {
 973     thread-&gt;set_osthread(NULL);
 974     delete osthread;
 975     return false;
 976   }
 977 
 978   // The thread is returned suspended (in state INITIALIZED),
 979   // and is started higher up in the call chain
 980   assert(state == INITIALIZED, &quot;race condition&quot;);
 981   return true;
 982 }
 983 
 984 /////////////////////////////////////////////////////////////////////////////
 985 // attach existing thread
 986 
 987 // bootstrap the main thread
 988 bool os::create_main_thread(JavaThread* thread) {
 989   assert(os::Linux::_main_thread == pthread_self(), &quot;should be called inside main thread&quot;);
 990   return create_attached_thread(thread);
 991 }
 992 
 993 bool os::create_attached_thread(JavaThread* thread) {
 994 #ifdef ASSERT
 995   thread-&gt;verify_not_published();
 996 #endif
 997 
 998   // Allocate the OSThread object
 999   OSThread* osthread = new OSThread(NULL, NULL);
1000 
1001   if (osthread == NULL) {
1002     return false;
1003   }
1004 
1005   // Store pthread info into the OSThread
1006   osthread-&gt;set_thread_id(os::Linux::gettid());
1007   osthread-&gt;set_pthread_id(::pthread_self());
1008 
1009   // initialize floating point control register
1010   os::Linux::init_thread_fpu_state();
1011 
1012   // Initial thread state is RUNNABLE
1013   osthread-&gt;set_state(RUNNABLE);
1014 
1015   thread-&gt;set_osthread(osthread);
1016 
1017   if (UseNUMA) {
1018     int lgrp_id = os::numa_get_group_id();
1019     if (lgrp_id != -1) {
1020       thread-&gt;set_lgrp_id(lgrp_id);
1021     }
1022   }
1023 
1024   if (os::is_primordial_thread()) {
1025     // If current thread is primordial thread, its stack is mapped on demand,
1026     // see notes about MAP_GROWSDOWN. Here we try to force kernel to map
1027     // the entire stack region to avoid SEGV in stack banging.
1028     // It is also useful to get around the heap-stack-gap problem on SuSE
1029     // kernel (see 4821821 for details). We first expand stack to the top
1030     // of yellow zone, then enable stack yellow zone (order is significant,
1031     // enabling yellow zone first will crash JVM on SuSE Linux), so there
1032     // is no gap between the last two virtual memory regions.
1033 
1034     JavaThread *jt = (JavaThread *)thread;
1035     address addr = jt-&gt;stack_reserved_zone_base();
1036     assert(addr != NULL, &quot;initialization problem?&quot;);
1037     assert(jt-&gt;stack_available(addr) &gt; 0, &quot;stack guard should not be enabled&quot;);
1038 
1039     osthread-&gt;set_expanding_stack();
1040     os::Linux::manually_expand_stack(jt, addr);
1041     osthread-&gt;clear_expanding_stack();
1042   }
1043 
1044   // initialize signal mask for this thread
1045   // and save the caller&#39;s signal mask
1046   os::Linux::hotspot_sigmask(thread);
1047 
1048   log_info(os, thread)(&quot;Thread attached (tid: &quot; UINTX_FORMAT &quot;, pthread id: &quot; UINTX_FORMAT &quot;).&quot;,
1049     os::current_thread_id(), (uintx) pthread_self());
1050 
1051   return true;
1052 }
1053 
1054 void os::pd_start_thread(Thread* thread) {
1055   OSThread * osthread = thread-&gt;osthread();
1056   assert(osthread-&gt;get_state() != INITIALIZED, &quot;just checking&quot;);
1057   Monitor* sync_with_child = osthread-&gt;startThread_lock();
1058   MutexLocker ml(sync_with_child, Mutex::_no_safepoint_check_flag);
1059   sync_with_child-&gt;notify();
1060 }
1061 
1062 // Free Linux resources related to the OSThread
1063 void os::free_thread(OSThread* osthread) {
1064   assert(osthread != NULL, &quot;osthread not set&quot;);
1065 
1066   // We are told to free resources of the argument thread,
1067   // but we can only really operate on the current thread.
1068   assert(Thread::current()-&gt;osthread() == osthread,
1069          &quot;os::free_thread but not current thread&quot;);
1070 
1071 #ifdef ASSERT
1072   sigset_t current;
1073   sigemptyset(&amp;current);
1074   pthread_sigmask(SIG_SETMASK, NULL, &amp;current);
1075   assert(!sigismember(&amp;current, SR_signum), &quot;SR signal should not be blocked!&quot;);
1076 #endif
1077 
1078   // Restore caller&#39;s signal mask
1079   sigset_t sigmask = osthread-&gt;caller_sigmask();
1080   pthread_sigmask(SIG_SETMASK, &amp;sigmask, NULL);
1081 
1082   delete osthread;
1083 }
1084 
1085 //////////////////////////////////////////////////////////////////////////////
1086 // primordial thread
1087 
1088 // Check if current thread is the primordial thread, similar to Solaris thr_main.
1089 bool os::is_primordial_thread(void) {
1090   if (suppress_primordial_thread_resolution) {
1091     return false;
1092   }
1093   char dummy;
1094   // If called before init complete, thread stack bottom will be null.
1095   // Can be called if fatal error occurs before initialization.
1096   if (os::Linux::initial_thread_stack_bottom() == NULL) return false;
1097   assert(os::Linux::initial_thread_stack_bottom() != NULL &amp;&amp;
1098          os::Linux::initial_thread_stack_size()   != 0,
1099          &quot;os::init did not locate primordial thread&#39;s stack region&quot;);
1100   if ((address)&amp;dummy &gt;= os::Linux::initial_thread_stack_bottom() &amp;&amp;
1101       (address)&amp;dummy &lt; os::Linux::initial_thread_stack_bottom() +
1102                         os::Linux::initial_thread_stack_size()) {
1103     return true;
1104   } else {
1105     return false;
1106   }
1107 }
1108 
1109 // Find the virtual memory area that contains addr
1110 static bool find_vma(address addr, address* vma_low, address* vma_high) {
1111   FILE *fp = fopen(&quot;/proc/self/maps&quot;, &quot;r&quot;);
1112   if (fp) {
1113     address low, high;
1114     while (!feof(fp)) {
1115       if (fscanf(fp, &quot;%p-%p&quot;, &amp;low, &amp;high) == 2) {
1116         if (low &lt;= addr &amp;&amp; addr &lt; high) {
1117           if (vma_low)  *vma_low  = low;
1118           if (vma_high) *vma_high = high;
1119           fclose(fp);
1120           return true;
1121         }
1122       }
1123       for (;;) {
1124         int ch = fgetc(fp);
1125         if (ch == EOF || ch == (int)&#39;\n&#39;) break;
1126       }
1127     }
1128     fclose(fp);
1129   }
1130   return false;
1131 }
1132 
1133 // Locate primordial thread stack. This special handling of primordial thread stack
1134 // is needed because pthread_getattr_np() on most (all?) Linux distros returns
1135 // bogus value for the primordial process thread. While the launcher has created
1136 // the VM in a new thread since JDK 6, we still have to allow for the use of the
1137 // JNI invocation API from a primordial thread.
1138 void os::Linux::capture_initial_stack(size_t max_size) {
1139 
1140   // max_size is either 0 (which means accept OS default for thread stacks) or
1141   // a user-specified value known to be at least the minimum needed. If we
1142   // are actually on the primordial thread we can make it appear that we have a
1143   // smaller max_size stack by inserting the guard pages at that location. But we
1144   // cannot do anything to emulate a larger stack than what has been provided by
1145   // the OS or threading library. In fact if we try to use a stack greater than
1146   // what is set by rlimit then we will crash the hosting process.
1147 
1148   // Maximum stack size is the easy part, get it from RLIMIT_STACK.
1149   // If this is &quot;unlimited&quot; then it will be a huge value.
1150   struct rlimit rlim;
1151   getrlimit(RLIMIT_STACK, &amp;rlim);
1152   size_t stack_size = rlim.rlim_cur;
1153 
1154   // 6308388: a bug in ld.so will relocate its own .data section to the
1155   //   lower end of primordial stack; reduce ulimit -s value a little bit
1156   //   so we won&#39;t install guard page on ld.so&#39;s data section.
1157   //   But ensure we don&#39;t underflow the stack size - allow 1 page spare
1158   if (stack_size &gt;= (size_t)(3 * page_size())) {
1159     stack_size -= 2 * page_size();
1160   }
1161 
1162   // Try to figure out where the stack base (top) is. This is harder.
1163   //
1164   // When an application is started, glibc saves the initial stack pointer in
1165   // a global variable &quot;__libc_stack_end&quot;, which is then used by system
1166   // libraries. __libc_stack_end should be pretty close to stack top. The
1167   // variable is available since the very early days. However, because it is
1168   // a private interface, it could disappear in the future.
1169   //
1170   // Linux kernel saves start_stack information in /proc/&lt;pid&gt;/stat. Similar
1171   // to __libc_stack_end, it is very close to stack top, but isn&#39;t the real
1172   // stack top. Note that /proc may not exist if VM is running as a chroot
1173   // program, so reading /proc/&lt;pid&gt;/stat could fail. Also the contents of
1174   // /proc/&lt;pid&gt;/stat could change in the future (though unlikely).
1175   //
1176   // We try __libc_stack_end first. If that doesn&#39;t work, look for
1177   // /proc/&lt;pid&gt;/stat. If neither of them works, we use current stack pointer
1178   // as a hint, which should work well in most cases.
1179 
1180   uintptr_t stack_start;
1181 
1182   // try __libc_stack_end first
1183   uintptr_t *p = (uintptr_t *)dlsym(RTLD_DEFAULT, &quot;__libc_stack_end&quot;);
1184   if (p &amp;&amp; *p) {
1185     stack_start = *p;
1186   } else {
1187     // see if we can get the start_stack field from /proc/self/stat
1188     FILE *fp;
1189     int pid;
1190     char state;
1191     int ppid;
1192     int pgrp;
1193     int session;
1194     int nr;
1195     int tpgrp;
1196     unsigned long flags;
1197     unsigned long minflt;
1198     unsigned long cminflt;
1199     unsigned long majflt;
1200     unsigned long cmajflt;
1201     unsigned long utime;
1202     unsigned long stime;
1203     long cutime;
1204     long cstime;
1205     long prio;
1206     long nice;
1207     long junk;
1208     long it_real;
1209     uintptr_t start;
1210     uintptr_t vsize;
1211     intptr_t rss;
1212     uintptr_t rsslim;
1213     uintptr_t scodes;
1214     uintptr_t ecode;
1215     int i;
1216 
1217     // Figure what the primordial thread stack base is. Code is inspired
1218     // by email from Hans Boehm. /proc/self/stat begins with current pid,
1219     // followed by command name surrounded by parentheses, state, etc.
1220     char stat[2048];
1221     int statlen;
1222 
1223     fp = fopen(&quot;/proc/self/stat&quot;, &quot;r&quot;);
1224     if (fp) {
1225       statlen = fread(stat, 1, 2047, fp);
1226       stat[statlen] = &#39;\0&#39;;
1227       fclose(fp);
1228 
1229       // Skip pid and the command string. Note that we could be dealing with
1230       // weird command names, e.g. user could decide to rename java launcher
1231       // to &quot;java 1.4.2 :)&quot;, then the stat file would look like
1232       //                1234 (java 1.4.2 :)) R ... ...
1233       // We don&#39;t really need to know the command string, just find the last
1234       // occurrence of &quot;)&quot; and then start parsing from there. See bug 4726580.
1235       char * s = strrchr(stat, &#39;)&#39;);
1236 
1237       i = 0;
1238       if (s) {
1239         // Skip blank chars
1240         do { s++; } while (s &amp;&amp; isspace(*s));
1241 
1242 #define _UFM UINTX_FORMAT
1243 #define _DFM INTX_FORMAT
1244 
1245         //                                     1   1   1   1   1   1   1   1   1   1   2   2    2    2    2    2    2    2    2
1246         //              3  4  5  6  7  8   9   0   1   2   3   4   5   6   7   8   9   0   1    2    3    4    5    6    7    8
1247         i = sscanf(s, &quot;%c %d %d %d %d %d %lu %lu %lu %lu %lu %lu %lu %ld %ld %ld %ld %ld %ld &quot; _UFM _UFM _DFM _UFM _UFM _UFM _UFM,
1248                    &amp;state,          // 3  %c
1249                    &amp;ppid,           // 4  %d
1250                    &amp;pgrp,           // 5  %d
1251                    &amp;session,        // 6  %d
1252                    &amp;nr,             // 7  %d
1253                    &amp;tpgrp,          // 8  %d
1254                    &amp;flags,          // 9  %lu
1255                    &amp;minflt,         // 10 %lu
1256                    &amp;cminflt,        // 11 %lu
1257                    &amp;majflt,         // 12 %lu
1258                    &amp;cmajflt,        // 13 %lu
1259                    &amp;utime,          // 14 %lu
1260                    &amp;stime,          // 15 %lu
1261                    &amp;cutime,         // 16 %ld
1262                    &amp;cstime,         // 17 %ld
1263                    &amp;prio,           // 18 %ld
1264                    &amp;nice,           // 19 %ld
1265                    &amp;junk,           // 20 %ld
1266                    &amp;it_real,        // 21 %ld
1267                    &amp;start,          // 22 UINTX_FORMAT
1268                    &amp;vsize,          // 23 UINTX_FORMAT
1269                    &amp;rss,            // 24 INTX_FORMAT
1270                    &amp;rsslim,         // 25 UINTX_FORMAT
1271                    &amp;scodes,         // 26 UINTX_FORMAT
1272                    &amp;ecode,          // 27 UINTX_FORMAT
1273                    &amp;stack_start);   // 28 UINTX_FORMAT
1274       }
1275 
1276 #undef _UFM
1277 #undef _DFM
1278 
1279       if (i != 28 - 2) {
1280         assert(false, &quot;Bad conversion from /proc/self/stat&quot;);
1281         // product mode - assume we are the primordial thread, good luck in the
1282         // embedded case.
1283         warning(&quot;Can&#39;t detect primordial thread stack location - bad conversion&quot;);
1284         stack_start = (uintptr_t) &amp;rlim;
1285       }
1286     } else {
1287       // For some reason we can&#39;t open /proc/self/stat (for example, running on
1288       // FreeBSD with a Linux emulator, or inside chroot), this should work for
1289       // most cases, so don&#39;t abort:
1290       warning(&quot;Can&#39;t detect primordial thread stack location - no /proc/self/stat&quot;);
1291       stack_start = (uintptr_t) &amp;rlim;
1292     }
1293   }
1294 
1295   // Now we have a pointer (stack_start) very close to the stack top, the
1296   // next thing to do is to figure out the exact location of stack top. We
1297   // can find out the virtual memory area that contains stack_start by
1298   // reading /proc/self/maps, it should be the last vma in /proc/self/maps,
1299   // and its upper limit is the real stack top. (again, this would fail if
1300   // running inside chroot, because /proc may not exist.)
1301 
1302   uintptr_t stack_top;
1303   address low, high;
1304   if (find_vma((address)stack_start, &amp;low, &amp;high)) {
1305     // success, &quot;high&quot; is the true stack top. (ignore &quot;low&quot;, because initial
1306     // thread stack grows on demand, its real bottom is high - RLIMIT_STACK.)
1307     stack_top = (uintptr_t)high;
1308   } else {
1309     // failed, likely because /proc/self/maps does not exist
1310     warning(&quot;Can&#39;t detect primordial thread stack location - find_vma failed&quot;);
1311     // best effort: stack_start is normally within a few pages below the real
1312     // stack top, use it as stack top, and reduce stack size so we won&#39;t put
1313     // guard page outside stack.
1314     stack_top = stack_start;
1315     stack_size -= 16 * page_size();
1316   }
1317 
1318   // stack_top could be partially down the page so align it
1319   stack_top = align_up(stack_top, page_size());
1320 
1321   // Allowed stack value is minimum of max_size and what we derived from rlimit
1322   if (max_size &gt; 0) {
1323     _initial_thread_stack_size = MIN2(max_size, stack_size);
1324   } else {
1325     // Accept the rlimit max, but if stack is unlimited then it will be huge, so
1326     // clamp it at 8MB as we do on Solaris
1327     _initial_thread_stack_size = MIN2(stack_size, 8*M);
1328   }
1329   _initial_thread_stack_size = align_down(_initial_thread_stack_size, page_size());
1330   _initial_thread_stack_bottom = (address)stack_top - _initial_thread_stack_size;
1331 
1332   assert(_initial_thread_stack_bottom &lt; (address)stack_top, &quot;overflow!&quot;);
1333 
1334   if (log_is_enabled(Info, os, thread)) {
1335     // See if we seem to be on primordial process thread
1336     bool primordial = uintptr_t(&amp;rlim) &gt; uintptr_t(_initial_thread_stack_bottom) &amp;&amp;
1337                       uintptr_t(&amp;rlim) &lt; stack_top;
1338 
1339     log_info(os, thread)(&quot;Capturing initial stack in %s thread: req. size: &quot; SIZE_FORMAT &quot;K, actual size: &quot;
1340                          SIZE_FORMAT &quot;K, top=&quot; INTPTR_FORMAT &quot;, bottom=&quot; INTPTR_FORMAT,
1341                          primordial ? &quot;primordial&quot; : &quot;user&quot;, max_size / K,  _initial_thread_stack_size / K,
1342                          stack_top, intptr_t(_initial_thread_stack_bottom));
1343   }
1344 }
1345 
1346 ////////////////////////////////////////////////////////////////////////////////
1347 // time support
1348 
1349 #ifndef SUPPORTS_CLOCK_MONOTONIC
1350 #error &quot;Build platform doesn&#39;t support clock_gettime and related functionality&quot;
1351 #endif
1352 
1353 // Time since start-up in seconds to a fine granularity.
1354 // Used by VMSelfDestructTimer and the MemProfiler.
1355 double os::elapsedTime() {
1356 
1357   return ((double)os::elapsed_counter()) / os::elapsed_frequency(); // nanosecond resolution
1358 }
1359 
1360 jlong os::elapsed_counter() {
1361   return javaTimeNanos() - initial_time_count;
1362 }
1363 
1364 jlong os::elapsed_frequency() {
1365   return NANOSECS_PER_SEC; // nanosecond resolution
1366 }
1367 
1368 bool os::supports_vtime() { return true; }
1369 
1370 double os::elapsedVTime() {
1371   struct rusage usage;
1372   int retval = getrusage(RUSAGE_THREAD, &amp;usage);
1373   if (retval == 0) {
1374     return (double) (usage.ru_utime.tv_sec + usage.ru_stime.tv_sec) + (double) (usage.ru_utime.tv_usec + usage.ru_stime.tv_usec) / (1000 * 1000);
1375   } else {
1376     // better than nothing, but not much
1377     return elapsedTime();
1378   }
1379 }
1380 
1381 jlong os::javaTimeMillis() {
1382   if (os::Posix::supports_clock_gettime()) {
1383     struct timespec ts;
1384     int status = os::Posix::clock_gettime(CLOCK_REALTIME, &amp;ts);
1385     assert_status(status == 0, status, &quot;gettime error&quot;);
1386     return jlong(ts.tv_sec) * MILLIUNITS +
1387            jlong(ts.tv_nsec) / NANOUNITS_PER_MILLIUNIT;
1388   } else {
1389     timeval time;
1390     int status = gettimeofday(&amp;time, NULL);
1391     assert(status != -1, &quot;linux error&quot;);
1392     return jlong(time.tv_sec) * MILLIUNITS  +
1393            jlong(time.tv_usec) / (MICROUNITS / MILLIUNITS);
1394   }
1395 }
1396 
1397 void os::javaTimeSystemUTC(jlong &amp;seconds, jlong &amp;nanos) {
1398   if (os::Posix::supports_clock_gettime()) {
1399     struct timespec ts;
1400     int status = os::Posix::clock_gettime(CLOCK_REALTIME, &amp;ts);
1401     assert_status(status == 0, status, &quot;gettime error&quot;);
1402     seconds = jlong(ts.tv_sec);
1403     nanos = jlong(ts.tv_nsec);
1404   } else {
1405     timeval time;
1406     int status = gettimeofday(&amp;time, NULL);
1407     assert(status != -1, &quot;linux error&quot;);
1408     seconds = jlong(time.tv_sec);
1409     nanos = jlong(time.tv_usec) * (NANOUNITS / MICROUNITS);
1410   }
1411 }
1412 
1413 void os::Linux::fast_thread_clock_init() {
1414   if (!UseLinuxPosixThreadCPUClocks) {
1415     return;
1416   }
1417   clockid_t clockid;
1418   struct timespec tp;
1419   int (*pthread_getcpuclockid_func)(pthread_t, clockid_t *) =
1420       (int(*)(pthread_t, clockid_t *)) dlsym(RTLD_DEFAULT, &quot;pthread_getcpuclockid&quot;);
1421 
1422   // Switch to using fast clocks for thread cpu time if
1423   // the clock_getres() returns 0 error code.
1424   // Note, that some kernels may support the current thread
1425   // clock (CLOCK_THREAD_CPUTIME_ID) but not the clocks
1426   // returned by the pthread_getcpuclockid().
1427   // If the fast Posix clocks are supported then the clock_getres()
1428   // must return at least tp.tv_sec == 0 which means a resolution
1429   // better than 1 sec. This is extra check for reliability.
1430 
1431   if (pthread_getcpuclockid_func &amp;&amp;
1432       pthread_getcpuclockid_func(_main_thread, &amp;clockid) == 0 &amp;&amp;
1433       os::Posix::clock_getres(clockid, &amp;tp) == 0 &amp;&amp; tp.tv_sec == 0) {
1434     _supports_fast_thread_cpu_time = true;
1435     _pthread_getcpuclockid = pthread_getcpuclockid_func;
1436   }
1437 }
1438 
1439 jlong os::javaTimeNanos() {
1440   if (os::supports_monotonic_clock()) {
1441     struct timespec tp;
1442     int status = os::Posix::clock_gettime(CLOCK_MONOTONIC, &amp;tp);
1443     assert(status == 0, &quot;gettime error&quot;);
1444     jlong result = jlong(tp.tv_sec) * (1000 * 1000 * 1000) + jlong(tp.tv_nsec);
1445     return result;
1446   } else {
1447     timeval time;
1448     int status = gettimeofday(&amp;time, NULL);
1449     assert(status != -1, &quot;linux error&quot;);
1450     jlong usecs = jlong(time.tv_sec) * (1000 * 1000) + jlong(time.tv_usec);
1451     return 1000 * usecs;
1452   }
1453 }
1454 
1455 void os::javaTimeNanos_info(jvmtiTimerInfo *info_ptr) {
1456   if (os::supports_monotonic_clock()) {
1457     info_ptr-&gt;max_value = ALL_64_BITS;
1458 
1459     // CLOCK_MONOTONIC - amount of time since some arbitrary point in the past
1460     info_ptr-&gt;may_skip_backward = false;      // not subject to resetting or drifting
1461     info_ptr-&gt;may_skip_forward = false;       // not subject to resetting or drifting
1462   } else {
1463     // gettimeofday - based on time in seconds since the Epoch thus does not wrap
1464     info_ptr-&gt;max_value = ALL_64_BITS;
1465 
1466     // gettimeofday is a real time clock so it skips
1467     info_ptr-&gt;may_skip_backward = true;
1468     info_ptr-&gt;may_skip_forward = true;
1469   }
1470 
1471   info_ptr-&gt;kind = JVMTI_TIMER_ELAPSED;                // elapsed not CPU time
1472 }
1473 
1474 // Return the real, user, and system times in seconds from an
1475 // arbitrary fixed point in the past.
1476 bool os::getTimesSecs(double* process_real_time,
1477                       double* process_user_time,
1478                       double* process_system_time) {
1479   struct tms ticks;
1480   clock_t real_ticks = times(&amp;ticks);
1481 
1482   if (real_ticks == (clock_t) (-1)) {
1483     return false;
1484   } else {
1485     double ticks_per_second = (double) clock_tics_per_sec;
1486     *process_user_time = ((double) ticks.tms_utime) / ticks_per_second;
1487     *process_system_time = ((double) ticks.tms_stime) / ticks_per_second;
1488     *process_real_time = ((double) real_ticks) / ticks_per_second;
1489 
1490     return true;
1491   }
1492 }
1493 
1494 
1495 char * os::local_time_string(char *buf, size_t buflen) {
1496   struct tm t;
1497   time_t long_time;
1498   time(&amp;long_time);
1499   localtime_r(&amp;long_time, &amp;t);
1500   jio_snprintf(buf, buflen, &quot;%d-%02d-%02d %02d:%02d:%02d&quot;,
1501                t.tm_year + 1900, t.tm_mon + 1, t.tm_mday,
1502                t.tm_hour, t.tm_min, t.tm_sec);
1503   return buf;
1504 }
1505 
1506 struct tm* os::localtime_pd(const time_t* clock, struct tm*  res) {
1507   return localtime_r(clock, res);
1508 }
1509 
1510 ////////////////////////////////////////////////////////////////////////////////
1511 // runtime exit support
1512 
1513 // Note: os::shutdown() might be called very early during initialization, or
1514 // called from signal handler. Before adding something to os::shutdown(), make
1515 // sure it is async-safe and can handle partially initialized VM.
1516 void os::shutdown() {
1517 
1518   // allow PerfMemory to attempt cleanup of any persistent resources
1519   perfMemory_exit();
1520 
1521   // needs to remove object in file system
1522   AttachListener::abort();
1523 
1524   // flush buffered output, finish log files
1525   ostream_abort();
1526 
1527   // Check for abort hook
1528   abort_hook_t abort_hook = Arguments::abort_hook();
1529   if (abort_hook != NULL) {
1530     abort_hook();
1531   }
1532 
1533 }
1534 
1535 // Note: os::abort() might be called very early during initialization, or
1536 // called from signal handler. Before adding something to os::abort(), make
1537 // sure it is async-safe and can handle partially initialized VM.
1538 void os::abort(bool dump_core, void* siginfo, const void* context) {
1539   os::shutdown();
1540   if (dump_core) {
1541     if (DumpPrivateMappingsInCore) {
1542       ClassLoader::close_jrt_image();
1543     }
1544     ::abort(); // dump core
1545   }
1546 
1547   ::exit(1);
1548 }
1549 
1550 // Die immediately, no exit hook, no abort hook, no cleanup.
1551 // Dump a core file, if possible, for debugging.
1552 void os::die() {
1553   if (TestUnresponsiveErrorHandler &amp;&amp; !CreateCoredumpOnCrash) {
1554     // For TimeoutInErrorHandlingTest.java, we just kill the VM
1555     // and don&#39;t take the time to generate a core file.
1556     os::signal_raise(SIGKILL);
1557   } else {
1558     ::abort();
1559   }
1560 }
1561 
1562 // thread_id is kernel thread id (similar to Solaris LWP id)
1563 intx os::current_thread_id() { return os::Linux::gettid(); }
1564 int os::current_process_id() {
1565   return ::getpid();
1566 }
1567 
1568 // DLL functions
1569 
1570 const char* os::dll_file_extension() { return &quot;.so&quot;; }
1571 
1572 // This must be hard coded because it&#39;s the system&#39;s temporary
1573 // directory not the java application&#39;s temp directory, ala java.io.tmpdir.
1574 const char* os::get_temp_directory() { return &quot;/tmp&quot;; }
1575 
1576 static bool file_exists(const char* filename) {
1577   struct stat statbuf;
1578   if (filename == NULL || strlen(filename) == 0) {
1579     return false;
1580   }
1581   return os::stat(filename, &amp;statbuf) == 0;
1582 }
1583 
1584 // check if addr is inside libjvm.so
1585 bool os::address_is_in_vm(address addr) {
1586   static address libjvm_base_addr;
1587   Dl_info dlinfo;
1588 
1589   if (libjvm_base_addr == NULL) {
1590     if (dladdr(CAST_FROM_FN_PTR(void *, os::address_is_in_vm), &amp;dlinfo) != 0) {
1591       libjvm_base_addr = (address)dlinfo.dli_fbase;
1592     }
1593     assert(libjvm_base_addr !=NULL, &quot;Cannot obtain base address for libjvm&quot;);
1594   }
1595 
1596   if (dladdr((void *)addr, &amp;dlinfo) != 0) {
1597     if (libjvm_base_addr == (address)dlinfo.dli_fbase) return true;
1598   }
1599 
1600   return false;
1601 }
1602 
1603 bool os::dll_address_to_function_name(address addr, char *buf,
1604                                       int buflen, int *offset,
1605                                       bool demangle) {
1606   // buf is not optional, but offset is optional
1607   assert(buf != NULL, &quot;sanity check&quot;);
1608 
1609   Dl_info dlinfo;
1610 
1611   if (dladdr((void*)addr, &amp;dlinfo) != 0) {
1612     // see if we have a matching symbol
1613     if (dlinfo.dli_saddr != NULL &amp;&amp; dlinfo.dli_sname != NULL) {
1614       if (!(demangle &amp;&amp; Decoder::demangle(dlinfo.dli_sname, buf, buflen))) {
1615         jio_snprintf(buf, buflen, &quot;%s&quot;, dlinfo.dli_sname);
1616       }
1617       if (offset != NULL) *offset = addr - (address)dlinfo.dli_saddr;
1618       return true;
1619     }
1620     // no matching symbol so try for just file info
1621     if (dlinfo.dli_fname != NULL &amp;&amp; dlinfo.dli_fbase != NULL) {
1622       if (Decoder::decode((address)(addr - (address)dlinfo.dli_fbase),
1623                           buf, buflen, offset, dlinfo.dli_fname, demangle)) {
1624         return true;
1625       }
1626     }
1627   }
1628 
1629   buf[0] = &#39;\0&#39;;
1630   if (offset != NULL) *offset = -1;
1631   return false;
1632 }
1633 
1634 struct _address_to_library_name {
1635   address addr;          // input : memory address
1636   size_t  buflen;        //         size of fname
1637   char*   fname;         // output: library name
1638   address base;          //         library base addr
1639 };
1640 
1641 static int address_to_library_name_callback(struct dl_phdr_info *info,
1642                                             size_t size, void *data) {
1643   int i;
1644   bool found = false;
1645   address libbase = NULL;
1646   struct _address_to_library_name * d = (struct _address_to_library_name *)data;
1647 
1648   // iterate through all loadable segments
1649   for (i = 0; i &lt; info-&gt;dlpi_phnum; i++) {
1650     address segbase = (address)(info-&gt;dlpi_addr + info-&gt;dlpi_phdr[i].p_vaddr);
1651     if (info-&gt;dlpi_phdr[i].p_type == PT_LOAD) {
1652       // base address of a library is the lowest address of its loaded
1653       // segments.
1654       if (libbase == NULL || libbase &gt; segbase) {
1655         libbase = segbase;
1656       }
1657       // see if &#39;addr&#39; is within current segment
1658       if (segbase &lt;= d-&gt;addr &amp;&amp;
1659           d-&gt;addr &lt; segbase + info-&gt;dlpi_phdr[i].p_memsz) {
1660         found = true;
1661       }
1662     }
1663   }
1664 
1665   // dlpi_name is NULL or empty if the ELF file is executable, return 0
1666   // so dll_address_to_library_name() can fall through to use dladdr() which
1667   // can figure out executable name from argv[0].
1668   if (found &amp;&amp; info-&gt;dlpi_name &amp;&amp; info-&gt;dlpi_name[0]) {
1669     d-&gt;base = libbase;
1670     if (d-&gt;fname) {
1671       jio_snprintf(d-&gt;fname, d-&gt;buflen, &quot;%s&quot;, info-&gt;dlpi_name);
1672     }
1673     return 1;
1674   }
1675   return 0;
1676 }
1677 
1678 bool os::dll_address_to_library_name(address addr, char* buf,
1679                                      int buflen, int* offset) {
1680   // buf is not optional, but offset is optional
1681   assert(buf != NULL, &quot;sanity check&quot;);
1682 
1683   Dl_info dlinfo;
1684   struct _address_to_library_name data;
1685 
1686   // There is a bug in old glibc dladdr() implementation that it could resolve
1687   // to wrong library name if the .so file has a base address != NULL. Here
1688   // we iterate through the program headers of all loaded libraries to find
1689   // out which library &#39;addr&#39; really belongs to. This workaround can be
1690   // removed once the minimum requirement for glibc is moved to 2.3.x.
1691   data.addr = addr;
1692   data.fname = buf;
1693   data.buflen = buflen;
1694   data.base = NULL;
1695   int rslt = dl_iterate_phdr(address_to_library_name_callback, (void *)&amp;data);
1696 
1697   if (rslt) {
1698     // buf already contains library name
1699     if (offset) *offset = addr - data.base;
1700     return true;
1701   }
1702   if (dladdr((void*)addr, &amp;dlinfo) != 0) {
1703     if (dlinfo.dli_fname != NULL) {
1704       jio_snprintf(buf, buflen, &quot;%s&quot;, dlinfo.dli_fname);
1705     }
1706     if (dlinfo.dli_fbase != NULL &amp;&amp; offset != NULL) {
1707       *offset = addr - (address)dlinfo.dli_fbase;
1708     }
1709     return true;
1710   }
1711 
1712   buf[0] = &#39;\0&#39;;
1713   if (offset) *offset = -1;
1714   return false;
1715 }
1716 
1717 // Loads .dll/.so and
1718 // in case of error it checks if .dll/.so was built for the
1719 // same architecture as Hotspot is running on
1720 
1721 
1722 // Remember the stack&#39;s state. The Linux dynamic linker will change
1723 // the stack to &#39;executable&#39; at most once, so we must safepoint only once.
1724 bool os::Linux::_stack_is_executable = false;
1725 
1726 // VM operation that loads a library.  This is necessary if stack protection
1727 // of the Java stacks can be lost during loading the library.  If we
1728 // do not stop the Java threads, they can stack overflow before the stacks
1729 // are protected again.
1730 class VM_LinuxDllLoad: public VM_Operation {
1731  private:
1732   const char *_filename;
1733   char *_ebuf;
1734   int _ebuflen;
1735   void *_lib;
1736  public:
1737   VM_LinuxDllLoad(const char *fn, char *ebuf, int ebuflen) :
1738     _filename(fn), _ebuf(ebuf), _ebuflen(ebuflen), _lib(NULL) {}
1739   VMOp_Type type() const { return VMOp_LinuxDllLoad; }
1740   void doit() {
1741     _lib = os::Linux::dll_load_in_vmthread(_filename, _ebuf, _ebuflen);
1742     os::Linux::_stack_is_executable = true;
1743   }
1744   void* loaded_library() { return _lib; }
1745 };
1746 
1747 void * os::dll_load(const char *filename, char *ebuf, int ebuflen) {
1748   void * result = NULL;
1749   bool load_attempted = false;
1750 
1751   log_info(os)(&quot;attempting shared library load of %s&quot;, filename);
1752 
1753   // Check whether the library to load might change execution rights
1754   // of the stack. If they are changed, the protection of the stack
1755   // guard pages will be lost. We need a safepoint to fix this.
1756   //
1757   // See Linux man page execstack(8) for more info.
1758   if (os::uses_stack_guard_pages() &amp;&amp; !os::Linux::_stack_is_executable) {
1759     if (!ElfFile::specifies_noexecstack(filename)) {
1760       if (!is_init_completed()) {
1761         os::Linux::_stack_is_executable = true;
1762         // This is OK - No Java threads have been created yet, and hence no
1763         // stack guard pages to fix.
1764         //
1765         // Dynamic loader will make all stacks executable after
1766         // this function returns, and will not do that again.
1767         assert(Threads::number_of_threads() == 0, &quot;no Java threads should exist yet.&quot;);
1768       } else {
1769         warning(&quot;You have loaded library %s which might have disabled stack guard. &quot;
1770                 &quot;The VM will try to fix the stack guard now.\n&quot;
1771                 &quot;It&#39;s highly recommended that you fix the library with &quot;
1772                 &quot;&#39;execstack -c &lt;libfile&gt;&#39;, or link it with &#39;-z noexecstack&#39;.&quot;,
1773                 filename);
1774 
1775         assert(Thread::current()-&gt;is_Java_thread(), &quot;must be Java thread&quot;);
1776         JavaThread *jt = JavaThread::current();
1777         if (jt-&gt;thread_state() != _thread_in_native) {
1778           // This happens when a compiler thread tries to load a hsdis-&lt;arch&gt;.so file
1779           // that requires ExecStack. Cannot enter safe point. Let&#39;s give up.
1780           warning(&quot;Unable to fix stack guard. Giving up.&quot;);
1781         } else {
1782           if (!LoadExecStackDllInVMThread) {
1783             // This is for the case where the DLL has an static
1784             // constructor function that executes JNI code. We cannot
1785             // load such DLLs in the VMThread.
1786             result = os::Linux::dlopen_helper(filename, ebuf, ebuflen);
1787           }
1788 
1789           ThreadInVMfromNative tiv(jt);
1790           debug_only(VMNativeEntryWrapper vew;)
1791 
1792           VM_LinuxDllLoad op(filename, ebuf, ebuflen);
1793           VMThread::execute(&amp;op);
1794           if (LoadExecStackDllInVMThread) {
1795             result = op.loaded_library();
1796           }
1797           load_attempted = true;
1798         }
1799       }
1800     }
1801   }
1802 
1803   if (!load_attempted) {
1804     result = os::Linux::dlopen_helper(filename, ebuf, ebuflen);
1805   }
1806 
1807   if (result != NULL) {
1808     // Successful loading
1809     return result;
1810   }
1811 
1812   Elf32_Ehdr elf_head;
1813   int diag_msg_max_length=ebuflen-strlen(ebuf);
1814   char* diag_msg_buf=ebuf+strlen(ebuf);
1815 
1816   if (diag_msg_max_length==0) {
1817     // No more space in ebuf for additional diagnostics message
1818     return NULL;
1819   }
1820 
1821 
1822   int file_descriptor= ::open(filename, O_RDONLY | O_NONBLOCK);
1823 
1824   if (file_descriptor &lt; 0) {
1825     // Can&#39;t open library, report dlerror() message
1826     return NULL;
1827   }
1828 
1829   bool failed_to_read_elf_head=
1830     (sizeof(elf_head)!=
1831      (::read(file_descriptor, &amp;elf_head,sizeof(elf_head))));
1832 
1833   ::close(file_descriptor);
1834   if (failed_to_read_elf_head) {
1835     // file i/o error - report dlerror() msg
1836     return NULL;
1837   }
1838 
1839   if (elf_head.e_ident[EI_DATA] != LITTLE_ENDIAN_ONLY(ELFDATA2LSB) BIG_ENDIAN_ONLY(ELFDATA2MSB)) {
1840     // handle invalid/out of range endianness values
1841     if (elf_head.e_ident[EI_DATA] == 0 || elf_head.e_ident[EI_DATA] &gt; 2) {
1842       return NULL;
1843     }
1844 
1845 #if defined(VM_LITTLE_ENDIAN)
1846     // VM is LE, shared object BE
1847     elf_head.e_machine = be16toh(elf_head.e_machine);
1848 #else
1849     // VM is BE, shared object LE
1850     elf_head.e_machine = le16toh(elf_head.e_machine);
1851 #endif
1852   }
1853 
1854   typedef struct {
1855     Elf32_Half    code;         // Actual value as defined in elf.h
1856     Elf32_Half    compat_class; // Compatibility of archs at VM&#39;s sense
1857     unsigned char elf_class;    // 32 or 64 bit
1858     unsigned char endianness;   // MSB or LSB
1859     char*         name;         // String representation
1860   } arch_t;
1861 
1862 #ifndef EM_AARCH64
1863   #define EM_AARCH64    183               /* ARM AARCH64 */
1864 #endif
1865 #ifndef EM_RISCV
1866   #define EM_RISCV      243               /* RISC-V */
1867 #endif
1868 
1869   static const arch_t arch_array[]={
1870     {EM_386,         EM_386,     ELFCLASS32, ELFDATA2LSB, (char*)&quot;IA 32&quot;},
1871     {EM_486,         EM_386,     ELFCLASS32, ELFDATA2LSB, (char*)&quot;IA 32&quot;},
1872     {EM_IA_64,       EM_IA_64,   ELFCLASS64, ELFDATA2LSB, (char*)&quot;IA 64&quot;},
1873     {EM_X86_64,      EM_X86_64,  ELFCLASS64, ELFDATA2LSB, (char*)&quot;AMD 64&quot;},
1874     {EM_SPARC,       EM_SPARC,   ELFCLASS32, ELFDATA2MSB, (char*)&quot;Sparc 32&quot;},
1875     {EM_SPARC32PLUS, EM_SPARC,   ELFCLASS32, ELFDATA2MSB, (char*)&quot;Sparc 32&quot;},
1876     {EM_SPARCV9,     EM_SPARCV9, ELFCLASS64, ELFDATA2MSB, (char*)&quot;Sparc v9 64&quot;},
1877     {EM_PPC,         EM_PPC,     ELFCLASS32, ELFDATA2MSB, (char*)&quot;Power PC 32&quot;},
1878 #if defined(VM_LITTLE_ENDIAN)
1879     {EM_PPC64,       EM_PPC64,   ELFCLASS64, ELFDATA2LSB, (char*)&quot;Power PC 64 LE&quot;},
1880     {EM_SH,          EM_SH,      ELFCLASS32, ELFDATA2LSB, (char*)&quot;SuperH&quot;},
1881 #else
1882     {EM_PPC64,       EM_PPC64,   ELFCLASS64, ELFDATA2MSB, (char*)&quot;Power PC 64&quot;},
1883     {EM_SH,          EM_SH,      ELFCLASS32, ELFDATA2MSB, (char*)&quot;SuperH BE&quot;},
1884 #endif
1885     {EM_ARM,         EM_ARM,     ELFCLASS32, ELFDATA2LSB, (char*)&quot;ARM&quot;},
1886     // we only support 64 bit z architecture
1887     {EM_S390,        EM_S390,    ELFCLASS64, ELFDATA2MSB, (char*)&quot;IBM System/390&quot;},
1888     {EM_ALPHA,       EM_ALPHA,   ELFCLASS64, ELFDATA2LSB, (char*)&quot;Alpha&quot;},
1889     {EM_MIPS_RS3_LE, EM_MIPS_RS3_LE, ELFCLASS32, ELFDATA2LSB, (char*)&quot;MIPSel&quot;},
1890     {EM_MIPS,        EM_MIPS,    ELFCLASS32, ELFDATA2MSB, (char*)&quot;MIPS&quot;},
1891     {EM_PARISC,      EM_PARISC,  ELFCLASS32, ELFDATA2MSB, (char*)&quot;PARISC&quot;},
1892     {EM_68K,         EM_68K,     ELFCLASS32, ELFDATA2MSB, (char*)&quot;M68k&quot;},
1893     {EM_AARCH64,     EM_AARCH64, ELFCLASS64, ELFDATA2LSB, (char*)&quot;AARCH64&quot;},
1894     {EM_RISCV,       EM_RISCV,   ELFCLASS64, ELFDATA2LSB, (char*)&quot;RISC-V&quot;},
1895   };
1896 
1897 #if  (defined IA32)
1898   static  Elf32_Half running_arch_code=EM_386;
1899 #elif   (defined AMD64) || (defined X32)
1900   static  Elf32_Half running_arch_code=EM_X86_64;
1901 #elif  (defined IA64)
1902   static  Elf32_Half running_arch_code=EM_IA_64;
1903 #elif  (defined __sparc) &amp;&amp; (defined _LP64)
1904   static  Elf32_Half running_arch_code=EM_SPARCV9;
1905 #elif  (defined __sparc) &amp;&amp; (!defined _LP64)
1906   static  Elf32_Half running_arch_code=EM_SPARC;
1907 #elif  (defined __powerpc64__)
1908   static  Elf32_Half running_arch_code=EM_PPC64;
1909 #elif  (defined __powerpc__)
1910   static  Elf32_Half running_arch_code=EM_PPC;
1911 #elif  (defined AARCH64)
1912   static  Elf32_Half running_arch_code=EM_AARCH64;
1913 #elif  (defined ARM)
1914   static  Elf32_Half running_arch_code=EM_ARM;
1915 #elif  (defined S390)
1916   static  Elf32_Half running_arch_code=EM_S390;
1917 #elif  (defined ALPHA)
1918   static  Elf32_Half running_arch_code=EM_ALPHA;
1919 #elif  (defined MIPSEL)
1920   static  Elf32_Half running_arch_code=EM_MIPS_RS3_LE;
1921 #elif  (defined PARISC)
1922   static  Elf32_Half running_arch_code=EM_PARISC;
1923 #elif  (defined MIPS)
1924   static  Elf32_Half running_arch_code=EM_MIPS;
1925 #elif  (defined M68K)
1926   static  Elf32_Half running_arch_code=EM_68K;
1927 #elif  (defined SH)
1928   static  Elf32_Half running_arch_code=EM_SH;
1929 #elif  (defined RISCV)
1930   static  Elf32_Half running_arch_code=EM_RISCV;
1931 #else
1932     #error Method os::dll_load requires that one of following is defined:\
1933         AARCH64, ALPHA, ARM, AMD64, IA32, IA64, M68K, MIPS, MIPSEL, PARISC, __powerpc__, __powerpc64__, RISCV, S390, SH, __sparc
1934 #endif
1935 
1936   // Identify compatibility class for VM&#39;s architecture and library&#39;s architecture
1937   // Obtain string descriptions for architectures
1938 
1939   arch_t lib_arch={elf_head.e_machine,0,elf_head.e_ident[EI_CLASS], elf_head.e_ident[EI_DATA], NULL};
1940   int running_arch_index=-1;
1941 
1942   for (unsigned int i=0; i &lt; ARRAY_SIZE(arch_array); i++) {
1943     if (running_arch_code == arch_array[i].code) {
1944       running_arch_index    = i;
1945     }
1946     if (lib_arch.code == arch_array[i].code) {
1947       lib_arch.compat_class = arch_array[i].compat_class;
1948       lib_arch.name         = arch_array[i].name;
1949     }
1950   }
1951 
1952   assert(running_arch_index != -1,
1953          &quot;Didn&#39;t find running architecture code (running_arch_code) in arch_array&quot;);
1954   if (running_arch_index == -1) {
1955     // Even though running architecture detection failed
1956     // we may still continue with reporting dlerror() message
1957     return NULL;
1958   }
1959 
1960   if (lib_arch.compat_class != arch_array[running_arch_index].compat_class) {
1961     if (lib_arch.name != NULL) {
1962       ::snprintf(diag_msg_buf, diag_msg_max_length-1,
1963                  &quot; (Possible cause: can&#39;t load %s .so on a %s platform)&quot;,
1964                  lib_arch.name, arch_array[running_arch_index].name);
1965     } else {
1966       ::snprintf(diag_msg_buf, diag_msg_max_length-1,
1967                  &quot; (Possible cause: can&#39;t load this .so (machine code=0x%x) on a %s platform)&quot;,
1968                  lib_arch.code, arch_array[running_arch_index].name);
1969     }
1970     return NULL;
1971   }
1972 
1973   if (lib_arch.endianness != arch_array[running_arch_index].endianness) {
1974     ::snprintf(diag_msg_buf, diag_msg_max_length-1, &quot; (Possible cause: endianness mismatch)&quot;);
1975     return NULL;
1976   }
1977 
1978   // ELF file class/capacity : 0 - invalid, 1 - 32bit, 2 - 64bit
1979   if (lib_arch.elf_class &gt; 2 || lib_arch.elf_class &lt; 1) {
1980     ::snprintf(diag_msg_buf, diag_msg_max_length-1, &quot; (Possible cause: invalid ELF file class)&quot;);
1981     return NULL;
1982   }
1983 
1984   if (lib_arch.elf_class != arch_array[running_arch_index].elf_class) {
1985     ::snprintf(diag_msg_buf, diag_msg_max_length-1,
1986                &quot; (Possible cause: architecture word width mismatch, can&#39;t load %d-bit .so on a %d-bit platform)&quot;,
1987                (int) lib_arch.elf_class * 32, arch_array[running_arch_index].elf_class * 32);
1988     return NULL;
1989   }
1990 
1991   return NULL;
1992 }
1993 
1994 void * os::Linux::dlopen_helper(const char *filename, char *ebuf,
1995                                 int ebuflen) {
1996   void * result = ::dlopen(filename, RTLD_LAZY);
1997   if (result == NULL) {
1998     const char* error_report = ::dlerror();
1999     if (error_report == NULL) {
2000       error_report = &quot;dlerror returned no error description&quot;;
2001     }
2002     if (ebuf != NULL &amp;&amp; ebuflen &gt; 0) {
2003       ::strncpy(ebuf, error_report, ebuflen-1);
2004       ebuf[ebuflen-1]=&#39;\0&#39;;
2005     }
2006     Events::log(NULL, &quot;Loading shared library %s failed, %s&quot;, filename, error_report);
2007     log_info(os)(&quot;shared library load of %s failed, %s&quot;, filename, error_report);
2008   } else {
2009     Events::log(NULL, &quot;Loaded shared library %s&quot;, filename);
2010     log_info(os)(&quot;shared library load of %s was successful&quot;, filename);
2011   }
2012   return result;
2013 }
2014 
2015 void * os::Linux::dll_load_in_vmthread(const char *filename, char *ebuf,
2016                                        int ebuflen) {
2017   void * result = NULL;
2018   if (LoadExecStackDllInVMThread) {
2019     result = dlopen_helper(filename, ebuf, ebuflen);
2020   }
2021 
2022   // Since 7019808, libjvm.so is linked with -noexecstack. If the VM loads a
2023   // library that requires an executable stack, or which does not have this
2024   // stack attribute set, dlopen changes the stack attribute to executable. The
2025   // read protection of the guard pages gets lost.
2026   //
2027   // Need to check _stack_is_executable again as multiple VM_LinuxDllLoad
2028   // may have been queued at the same time.
2029 
2030   if (!_stack_is_executable) {
2031     for (JavaThreadIteratorWithHandle jtiwh; JavaThread *jt = jtiwh.next(); ) {
2032       if (!jt-&gt;stack_guard_zone_unused() &amp;&amp;     // Stack not yet fully initialized
2033           jt-&gt;stack_guards_enabled()) {         // No pending stack overflow exceptions
2034         if (!os::guard_memory((char *)jt-&gt;stack_end(), jt-&gt;stack_guard_zone_size())) {
2035           warning(&quot;Attempt to reguard stack yellow zone failed.&quot;);
2036         }
2037       }
2038     }
2039   }
2040 
2041   return result;
2042 }
2043 
2044 void* os::dll_lookup(void* handle, const char* name) {
2045   void* res = dlsym(handle, name);
2046   return res;
2047 }
2048 
2049 void* os::get_default_process_handle() {
2050   return (void*)::dlopen(NULL, RTLD_LAZY);
2051 }
2052 
2053 static bool _print_ascii_file(const char* filename, outputStream* st, const char* hdr = NULL) {
2054   int fd = ::open(filename, O_RDONLY);
2055   if (fd == -1) {
2056     return false;
2057   }
2058 
2059   if (hdr != NULL) {
2060     st-&gt;print_cr(&quot;%s&quot;, hdr);
2061   }
2062 
2063   char buf[33];
2064   int bytes;
2065   buf[32] = &#39;\0&#39;;
2066   while ((bytes = ::read(fd, buf, sizeof(buf)-1)) &gt; 0) {
2067     st-&gt;print_raw(buf, bytes);
2068   }
2069 
2070   ::close(fd);
2071 
2072   return true;
2073 }
2074 
2075 static void _print_ascii_file_h(const char* header, const char* filename, outputStream* st, bool same_line = true) {
2076   st-&gt;print(&quot;%s:%c&quot;, header, same_line ? &#39; &#39; : &#39;\n&#39;);
2077   if (!_print_ascii_file(filename, st)) {
2078     st-&gt;print_cr(&quot;&lt;Not Available&gt;&quot;);
2079   }
2080 }
2081 
2082 void os::print_dll_info(outputStream *st) {
2083   st-&gt;print_cr(&quot;Dynamic libraries:&quot;);
2084 
2085   char fname[32];
2086   pid_t pid = os::Linux::gettid();
2087 
2088   jio_snprintf(fname, sizeof(fname), &quot;/proc/%d/maps&quot;, pid);
2089 
2090   if (!_print_ascii_file(fname, st)) {
2091     st-&gt;print_cr(&quot;Can not get library information for pid = %d&quot;, pid);
2092   }
2093 }
2094 
2095 struct loaded_modules_info_param {
2096   os::LoadedModulesCallbackFunc callback;
2097   void *param;
2098 };
2099 
2100 static int dl_iterate_callback(struct dl_phdr_info *info, size_t size, void *data) {
2101   if ((info-&gt;dlpi_name == NULL) || (*info-&gt;dlpi_name == &#39;\0&#39;)) {
2102     return 0;
2103   }
2104 
2105   struct loaded_modules_info_param *callback_param = reinterpret_cast&lt;struct loaded_modules_info_param *&gt;(data);
2106   address base = NULL;
2107   address top = NULL;
2108   for (int idx = 0; idx &lt; info-&gt;dlpi_phnum; idx++) {
2109     const ElfW(Phdr) *phdr = info-&gt;dlpi_phdr + idx;
2110     if (phdr-&gt;p_type == PT_LOAD) {
2111       address raw_phdr_base = reinterpret_cast&lt;address&gt;(info-&gt;dlpi_addr + phdr-&gt;p_vaddr);
2112 
2113       address phdr_base = align_down(raw_phdr_base, phdr-&gt;p_align);
2114       if ((base == NULL) || (base &gt; phdr_base)) {
2115         base = phdr_base;
2116       }
2117 
2118       address phdr_top = align_up(raw_phdr_base + phdr-&gt;p_memsz, phdr-&gt;p_align);
2119       if ((top == NULL) || (top &lt; phdr_top)) {
2120         top = phdr_top;
2121       }
2122     }
2123   }
2124 
2125   return callback_param-&gt;callback(info-&gt;dlpi_name, base, top, callback_param-&gt;param);
2126 }
2127 
2128 int os::get_loaded_modules_info(os::LoadedModulesCallbackFunc callback, void *param) {
2129   struct loaded_modules_info_param callback_param = {callback, param};
2130   return dl_iterate_phdr(&amp;dl_iterate_callback, &amp;callback_param);
2131 }
2132 
2133 void os::print_os_info_brief(outputStream* st) {
2134   os::Linux::print_distro_info(st);
2135 
2136   os::Posix::print_uname_info(st);
2137 
2138   os::Linux::print_libversion_info(st);
2139 
2140 }
2141 
2142 void os::print_os_info(outputStream* st) {
2143   st-&gt;print_cr(&quot;OS:&quot;);
2144 
2145   os::Linux::print_distro_info(st);
2146 
2147   os::Posix::print_uname_info(st);
2148 
2149   os::Linux::print_uptime_info(st);
2150 
2151   // Print warning if unsafe chroot environment detected
2152   if (unsafe_chroot_detected) {
2153     st-&gt;print_cr(&quot;WARNING!! %s&quot;, unstable_chroot_error);
2154   }
2155 
2156   os::Linux::print_libversion_info(st);
2157 
2158   os::Posix::print_rlimit_info(st);
2159 
2160   os::Posix::print_load_average(st);
2161   st-&gt;cr();
2162 
2163   os::Linux::print_full_memory_info(st);
2164   st-&gt;cr();
2165 
2166   os::Linux::print_proc_sys_info(st);
2167   st-&gt;cr();
2168 
2169   if (os::Linux::print_ld_preload_file(st)) {
2170     st-&gt;cr();
2171   }
2172 
2173   if (os::Linux::print_container_info(st)) {
2174     st-&gt;cr();
2175   }
2176 
2177   VM_Version::print_platform_virtualization_info(st);
2178 
2179   os::Linux::print_steal_info(st);
2180 }
2181 
2182 // Try to identify popular distros.
2183 // Most Linux distributions have a /etc/XXX-release file, which contains
2184 // the OS version string. Newer Linux distributions have a /etc/lsb-release
2185 // file that also contains the OS version string. Some have more than one
2186 // /etc/XXX-release file (e.g. Mandrake has both /etc/mandrake-release and
2187 // /etc/redhat-release.), so the order is important.
2188 // Any Linux that is based on Redhat (i.e. Oracle, Mandrake, Sun JDS...) have
2189 // their own specific XXX-release file as well as a redhat-release file.
2190 // Because of this the XXX-release file needs to be searched for before the
2191 // redhat-release file.
2192 // Since Red Hat and SuSE have an lsb-release file that is not very descriptive the
2193 // search for redhat-release / SuSE-release needs to be before lsb-release.
2194 // Since the lsb-release file is the new standard it needs to be searched
2195 // before the older style release files.
2196 // Searching system-release (Red Hat) and os-release (other Linuxes) are a
2197 // next to last resort.  The os-release file is a new standard that contains
2198 // distribution information and the system-release file seems to be an old
2199 // standard that has been replaced by the lsb-release and os-release files.
2200 // Searching for the debian_version file is the last resort.  It contains
2201 // an informative string like &quot;6.0.6&quot; or &quot;wheezy/sid&quot;. Because of this
2202 // &quot;Debian &quot; is printed before the contents of the debian_version file.
2203 
2204 const char* distro_files[] = {
2205   &quot;/etc/oracle-release&quot;,
2206   &quot;/etc/mandriva-release&quot;,
2207   &quot;/etc/mandrake-release&quot;,
2208   &quot;/etc/sun-release&quot;,
2209   &quot;/etc/redhat-release&quot;,
2210   &quot;/etc/SuSE-release&quot;,
2211   &quot;/etc/lsb-release&quot;,
2212   &quot;/etc/turbolinux-release&quot;,
2213   &quot;/etc/gentoo-release&quot;,
2214   &quot;/etc/ltib-release&quot;,
2215   &quot;/etc/angstrom-version&quot;,
2216   &quot;/etc/system-release&quot;,
2217   &quot;/etc/os-release&quot;,
2218   NULL };
2219 
2220 void os::Linux::print_distro_info(outputStream* st) {
2221   for (int i = 0;; i++) {
2222     const char* file = distro_files[i];
2223     if (file == NULL) {
2224       break;  // done
2225     }
2226     // If file prints, we found it.
2227     if (_print_ascii_file(file, st)) {
2228       return;
2229     }
2230   }
2231 
2232   if (file_exists(&quot;/etc/debian_version&quot;)) {
2233     st-&gt;print(&quot;Debian &quot;);
2234     _print_ascii_file(&quot;/etc/debian_version&quot;, st);
2235   } else {
2236     st-&gt;print_cr(&quot;Linux&quot;);
2237   }
2238 }
2239 
2240 static void parse_os_info_helper(FILE* fp, char* distro, size_t length, bool get_first_line) {
2241   char buf[256];
2242   while (fgets(buf, sizeof(buf), fp)) {
2243     // Edit out extra stuff in expected format
2244     if (strstr(buf, &quot;DISTRIB_DESCRIPTION=&quot;) != NULL || strstr(buf, &quot;PRETTY_NAME=&quot;) != NULL) {
2245       char* ptr = strstr(buf, &quot;\&quot;&quot;);  // the name is in quotes
2246       if (ptr != NULL) {
2247         ptr++; // go beyond first quote
2248         char* nl = strchr(ptr, &#39;\&quot;&#39;);
2249         if (nl != NULL) *nl = &#39;\0&#39;;
2250         strncpy(distro, ptr, length);
2251       } else {
2252         ptr = strstr(buf, &quot;=&quot;);
2253         ptr++; // go beyond equals then
2254         char* nl = strchr(ptr, &#39;\n&#39;);
2255         if (nl != NULL) *nl = &#39;\0&#39;;
2256         strncpy(distro, ptr, length);
2257       }
2258       return;
2259     } else if (get_first_line) {
2260       char* nl = strchr(buf, &#39;\n&#39;);
2261       if (nl != NULL) *nl = &#39;\0&#39;;
2262       strncpy(distro, buf, length);
2263       return;
2264     }
2265   }
2266   // print last line and close
2267   char* nl = strchr(buf, &#39;\n&#39;);
2268   if (nl != NULL) *nl = &#39;\0&#39;;
2269   strncpy(distro, buf, length);
2270 }
2271 
2272 static void parse_os_info(char* distro, size_t length, const char* file) {
2273   FILE* fp = fopen(file, &quot;r&quot;);
2274   if (fp != NULL) {
2275     // if suse format, print out first line
2276     bool get_first_line = (strcmp(file, &quot;/etc/SuSE-release&quot;) == 0);
2277     parse_os_info_helper(fp, distro, length, get_first_line);
2278     fclose(fp);
2279   }
2280 }
2281 
2282 void os::get_summary_os_info(char* buf, size_t buflen) {
2283   for (int i = 0;; i++) {
2284     const char* file = distro_files[i];
2285     if (file == NULL) {
2286       break; // ran out of distro_files
2287     }
2288     if (file_exists(file)) {
2289       parse_os_info(buf, buflen, file);
2290       return;
2291     }
2292   }
2293   // special case for debian
2294   if (file_exists(&quot;/etc/debian_version&quot;)) {
2295     strncpy(buf, &quot;Debian &quot;, buflen);
2296     if (buflen &gt; 7) {
2297       parse_os_info(&amp;buf[7], buflen-7, &quot;/etc/debian_version&quot;);
2298     }
2299   } else {
2300     strncpy(buf, &quot;Linux&quot;, buflen);
2301   }
2302 }
2303 
2304 void os::Linux::print_libversion_info(outputStream* st) {
2305   // libc, pthread
2306   st-&gt;print(&quot;libc: &quot;);
2307   st-&gt;print(&quot;%s &quot;, os::Linux::glibc_version());
2308   st-&gt;print(&quot;%s &quot;, os::Linux::libpthread_version());
2309   st-&gt;cr();
2310 }
2311 
2312 void os::Linux::print_proc_sys_info(outputStream* st) {
2313   _print_ascii_file_h(&quot;/proc/sys/kernel/threads-max (system-wide limit on the number of threads)&quot;,
2314                       &quot;/proc/sys/kernel/threads-max&quot;, st);
2315   _print_ascii_file_h(&quot;/proc/sys/vm/max_map_count (maximum number of memory map areas a process may have)&quot;,
2316                       &quot;/proc/sys/vm/max_map_count&quot;, st);
2317   _print_ascii_file_h(&quot;/proc/sys/kernel/pid_max (system-wide limit on number of process identifiers)&quot;,
2318                       &quot;/proc/sys/kernel/pid_max&quot;, st);
2319 }
2320 
2321 void os::Linux::print_full_memory_info(outputStream* st) {
2322   _print_ascii_file_h(&quot;/proc/meminfo&quot;, &quot;/proc/meminfo&quot;, st, false);
2323   st-&gt;cr();
2324 
2325   // some information regarding THPs; for details see
2326   // https://www.kernel.org/doc/Documentation/vm/transhuge.txt
2327   _print_ascii_file_h(&quot;/sys/kernel/mm/transparent_hugepage/enabled&quot;,
2328                       &quot;/sys/kernel/mm/transparent_hugepage/enabled&quot;, st);
2329   _print_ascii_file_h(&quot;/sys/kernel/mm/transparent_hugepage/defrag (defrag/compaction efforts parameter)&quot;,
2330                       &quot;/sys/kernel/mm/transparent_hugepage/defrag&quot;, st);
2331 }
2332 
2333 bool os::Linux::print_ld_preload_file(outputStream* st) {
2334   return _print_ascii_file(&quot;/etc/ld.so.preload&quot;, st, &quot;/etc/ld.so.preload:&quot;);
2335 }
2336 
2337 void os::Linux::print_uptime_info(outputStream* st) {
2338   struct sysinfo sinfo;
2339   int ret = sysinfo(&amp;sinfo);
2340   if (ret == 0) {
2341     os::print_dhm(st, &quot;OS uptime:&quot;, (long) sinfo.uptime);
2342   }
2343 }
2344 
2345 bool os::Linux::print_container_info(outputStream* st) {
2346   if (!OSContainer::is_containerized()) {
2347     return false;
2348   }
2349 
2350   st-&gt;print_cr(&quot;container (cgroup) information:&quot;);
2351 
2352   const char *p_ct = OSContainer::container_type();
2353   st-&gt;print_cr(&quot;container_type: %s&quot;, p_ct != NULL ? p_ct : &quot;not supported&quot;);
2354 
2355   char *p = OSContainer::cpu_cpuset_cpus();
2356   st-&gt;print_cr(&quot;cpu_cpuset_cpus: %s&quot;, p != NULL ? p : &quot;not supported&quot;);
2357   free(p);
2358 
2359   p = OSContainer::cpu_cpuset_memory_nodes();
2360   st-&gt;print_cr(&quot;cpu_memory_nodes: %s&quot;, p != NULL ? p : &quot;not supported&quot;);
2361   free(p);
2362 
2363   int i = OSContainer::active_processor_count();
2364   st-&gt;print(&quot;active_processor_count: &quot;);
2365   if (i &gt; 0) {
2366     st-&gt;print_cr(&quot;%d&quot;, i);
2367   } else {
2368     st-&gt;print_cr(&quot;not supported&quot;);
2369   }
2370 
2371   i = OSContainer::cpu_quota();
2372   st-&gt;print(&quot;cpu_quota: &quot;);
2373   if (i &gt; 0) {
2374     st-&gt;print_cr(&quot;%d&quot;, i);
2375   } else {
2376     st-&gt;print_cr(&quot;%s&quot;, i == OSCONTAINER_ERROR ? &quot;not supported&quot; : &quot;no quota&quot;);
2377   }
2378 
2379   i = OSContainer::cpu_period();
2380   st-&gt;print(&quot;cpu_period: &quot;);
2381   if (i &gt; 0) {
2382     st-&gt;print_cr(&quot;%d&quot;, i);
2383   } else {
2384     st-&gt;print_cr(&quot;%s&quot;, i == OSCONTAINER_ERROR ? &quot;not supported&quot; : &quot;no period&quot;);
2385   }
2386 
2387   i = OSContainer::cpu_shares();
2388   st-&gt;print(&quot;cpu_shares: &quot;);
2389   if (i &gt; 0) {
2390     st-&gt;print_cr(&quot;%d&quot;, i);
2391   } else {
2392     st-&gt;print_cr(&quot;%s&quot;, i == OSCONTAINER_ERROR ? &quot;not supported&quot; : &quot;no shares&quot;);
2393   }
2394 
2395   jlong j = OSContainer::memory_limit_in_bytes();
2396   st-&gt;print(&quot;memory_limit_in_bytes: &quot;);
2397   if (j &gt; 0) {
2398     st-&gt;print_cr(JLONG_FORMAT, j);
2399   } else {
2400     st-&gt;print_cr(&quot;%s&quot;, j == OSCONTAINER_ERROR ? &quot;not supported&quot; : &quot;unlimited&quot;);
2401   }
2402 
2403   j = OSContainer::memory_and_swap_limit_in_bytes();
2404   st-&gt;print(&quot;memory_and_swap_limit_in_bytes: &quot;);
2405   if (j &gt; 0) {
2406     st-&gt;print_cr(JLONG_FORMAT, j);
2407   } else {
2408     st-&gt;print_cr(&quot;%s&quot;, j == OSCONTAINER_ERROR ? &quot;not supported&quot; : &quot;unlimited&quot;);
2409   }
2410 
2411   j = OSContainer::memory_soft_limit_in_bytes();
2412   st-&gt;print(&quot;memory_soft_limit_in_bytes: &quot;);
2413   if (j &gt; 0) {
2414     st-&gt;print_cr(JLONG_FORMAT, j);
2415   } else {
2416     st-&gt;print_cr(&quot;%s&quot;, j == OSCONTAINER_ERROR ? &quot;not supported&quot; : &quot;unlimited&quot;);
2417   }
2418 
2419   j = OSContainer::OSContainer::memory_usage_in_bytes();
2420   st-&gt;print(&quot;memory_usage_in_bytes: &quot;);
2421   if (j &gt; 0) {
2422     st-&gt;print_cr(JLONG_FORMAT, j);
2423   } else {
2424     st-&gt;print_cr(&quot;%s&quot;, j == OSCONTAINER_ERROR ? &quot;not supported&quot; : &quot;unlimited&quot;);
2425   }
2426 
2427   j = OSContainer::OSContainer::memory_max_usage_in_bytes();
2428   st-&gt;print(&quot;memory_max_usage_in_bytes: &quot;);
2429   if (j &gt; 0) {
2430     st-&gt;print_cr(JLONG_FORMAT, j);
2431   } else {
2432     st-&gt;print_cr(&quot;%s&quot;, j == OSCONTAINER_ERROR ? &quot;not supported&quot; : &quot;unlimited&quot;);
2433   }
2434 
2435   return true;
2436 }
2437 
2438 void os::Linux::print_steal_info(outputStream* st) {
2439   if (has_initial_tick_info) {
2440     CPUPerfTicks pticks;
2441     bool res = os::Linux::get_tick_information(&amp;pticks, -1);
2442 
2443     if (res &amp;&amp; pticks.has_steal_ticks) {
2444       uint64_t steal_ticks_difference = pticks.steal - initial_steal_ticks;
2445       uint64_t total_ticks_difference = pticks.total - initial_total_ticks;
2446       double steal_ticks_perc = 0.0;
2447       if (total_ticks_difference != 0) {
2448         steal_ticks_perc = (double) steal_ticks_difference / total_ticks_difference;
2449       }
2450       st-&gt;print_cr(&quot;Steal ticks since vm start: &quot; UINT64_FORMAT, steal_ticks_difference);
2451       st-&gt;print_cr(&quot;Steal ticks percentage since vm start:%7.3f&quot;, steal_ticks_perc);
2452     }
2453   }
2454 }
2455 
2456 void os::print_memory_info(outputStream* st) {
2457 
2458   st-&gt;print(&quot;Memory:&quot;);
2459   st-&gt;print(&quot; %dk page&quot;, os::vm_page_size()&gt;&gt;10);
2460 
2461   // values in struct sysinfo are &quot;unsigned long&quot;
2462   struct sysinfo si;
2463   sysinfo(&amp;si);
2464 
2465   st-&gt;print(&quot;, physical &quot; UINT64_FORMAT &quot;k&quot;,
2466             os::physical_memory() &gt;&gt; 10);
2467   st-&gt;print(&quot;(&quot; UINT64_FORMAT &quot;k free)&quot;,
2468             os::available_memory() &gt;&gt; 10);
2469   st-&gt;print(&quot;, swap &quot; UINT64_FORMAT &quot;k&quot;,
2470             ((jlong)si.totalswap * si.mem_unit) &gt;&gt; 10);
2471   st-&gt;print(&quot;(&quot; UINT64_FORMAT &quot;k free)&quot;,
2472             ((jlong)si.freeswap * si.mem_unit) &gt;&gt; 10);
2473   st-&gt;cr();
2474 }
2475 
2476 // Print the first &quot;model name&quot; line and the first &quot;flags&quot; line
2477 // that we find and nothing more. We assume &quot;model name&quot; comes
2478 // before &quot;flags&quot; so if we find a second &quot;model name&quot;, then the
2479 // &quot;flags&quot; field is considered missing.
2480 static bool print_model_name_and_flags(outputStream* st, char* buf, size_t buflen) {
2481 #if defined(IA32) || defined(AMD64)
2482   // Other platforms have less repetitive cpuinfo files
2483   FILE *fp = fopen(&quot;/proc/cpuinfo&quot;, &quot;r&quot;);
2484   if (fp) {
2485     while (!feof(fp)) {
2486       if (fgets(buf, buflen, fp)) {
2487         // Assume model name comes before flags
2488         bool model_name_printed = false;
2489         if (strstr(buf, &quot;model name&quot;) != NULL) {
2490           if (!model_name_printed) {
2491             st-&gt;print_raw(&quot;CPU Model and flags from /proc/cpuinfo:\n&quot;);
2492             st-&gt;print_raw(buf);
2493             model_name_printed = true;
2494           } else {
2495             // model name printed but not flags?  Odd, just return
2496             fclose(fp);
2497             return true;
2498           }
2499         }
2500         // print the flags line too
2501         if (strstr(buf, &quot;flags&quot;) != NULL) {
2502           st-&gt;print_raw(buf);
2503           fclose(fp);
2504           return true;
2505         }
2506       }
2507     }
2508     fclose(fp);
2509   }
2510 #endif // x86 platforms
2511   return false;
2512 }
2513 
2514 // additional information about CPU e.g. available frequency ranges
2515 static void print_sys_devices_cpu_info(outputStream* st, char* buf, size_t buflen) {
2516   _print_ascii_file_h(&quot;Online cpus&quot;, &quot;/sys/devices/system/cpu/online&quot;, st);
2517   _print_ascii_file_h(&quot;Offline cpus&quot;, &quot;/sys/devices/system/cpu/offline&quot;, st);
2518 
2519   if (ExtensiveErrorReports) {
2520     // cache related info (cpu 0, should be similar for other CPUs)
2521     for (unsigned int i=0; i &lt; 10; i++) { // handle max. 10 cache entries
2522       char hbuf_level[60];
2523       char hbuf_type[60];
2524       char hbuf_size[60];
2525       char hbuf_coherency_line_size[80];
2526       snprintf(hbuf_level, 60, &quot;/sys/devices/system/cpu/cpu0/cache/index%u/level&quot;, i);
2527       snprintf(hbuf_type, 60, &quot;/sys/devices/system/cpu/cpu0/cache/index%u/type&quot;, i);
2528       snprintf(hbuf_size, 60, &quot;/sys/devices/system/cpu/cpu0/cache/index%u/size&quot;, i);
2529       snprintf(hbuf_coherency_line_size, 80, &quot;/sys/devices/system/cpu/cpu0/cache/index%u/coherency_line_size&quot;, i);
2530       if (file_exists(hbuf_level)) {
2531         _print_ascii_file_h(&quot;cache level&quot;, hbuf_level, st);
2532         _print_ascii_file_h(&quot;cache type&quot;, hbuf_type, st);
2533         _print_ascii_file_h(&quot;cache size&quot;, hbuf_size, st);
2534         _print_ascii_file_h(&quot;cache coherency line size&quot;, hbuf_coherency_line_size, st);
2535       }
2536     }
2537   }
2538 
2539   // we miss the cpufreq entries on Power and s390x
2540 #if defined(IA32) || defined(AMD64)
2541   _print_ascii_file_h(&quot;BIOS frequency limitation&quot;, &quot;/sys/devices/system/cpu/cpu0/cpufreq/bios_limit&quot;, st);
2542   _print_ascii_file_h(&quot;Frequency switch latency (ns)&quot;, &quot;/sys/devices/system/cpu/cpu0/cpufreq/cpuinfo_transition_latency&quot;, st);
2543   _print_ascii_file_h(&quot;Available cpu frequencies&quot;, &quot;/sys/devices/system/cpu/cpu0/cpufreq/scaling_available_frequencies&quot;, st);
2544   // min and max should be in the Available range but still print them (not all info might be available for all kernels)
2545   if (ExtensiveErrorReports) {
2546     _print_ascii_file_h(&quot;Maximum cpu frequency&quot;, &quot;/sys/devices/system/cpu/cpu0/cpufreq/cpuinfo_max_freq&quot;, st);
2547     _print_ascii_file_h(&quot;Minimum cpu frequency&quot;, &quot;/sys/devices/system/cpu/cpu0/cpufreq/cpuinfo_min_freq&quot;, st);
2548     _print_ascii_file_h(&quot;Current cpu frequency&quot;, &quot;/sys/devices/system/cpu/cpu0/cpufreq/scaling_cur_freq&quot;, st);
2549   }
2550   // governors are power schemes, see https://wiki.archlinux.org/index.php/CPU_frequency_scaling
2551   if (ExtensiveErrorReports) {
2552     _print_ascii_file_h(&quot;Available governors&quot;, &quot;/sys/devices/system/cpu/cpu0/cpufreq/scaling_available_governors&quot;, st);
2553   }
2554   _print_ascii_file_h(&quot;Current governor&quot;, &quot;/sys/devices/system/cpu/cpu0/cpufreq/scaling_governor&quot;, st);
2555   // Core performance boost, see https://www.kernel.org/doc/Documentation/cpu-freq/boost.txt
2556   // Raise operating frequency of some cores in a multi-core package if certain conditions apply, e.g.
2557   // whole chip is not fully utilized
2558   _print_ascii_file_h(&quot;Core performance/turbo boost&quot;, &quot;/sys/devices/system/cpu/cpufreq/boost&quot;, st);
2559 #endif
2560 }
2561 
2562 void os::pd_print_cpu_info(outputStream* st, char* buf, size_t buflen) {
2563   // Only print the model name if the platform provides this as a summary
2564   if (!print_model_name_and_flags(st, buf, buflen)) {
2565     _print_ascii_file_h(&quot;/proc/cpuinfo&quot;, &quot;/proc/cpuinfo&quot;, st, false);
2566   }
2567   st-&gt;cr();
2568   print_sys_devices_cpu_info(st, buf, buflen);
2569 }
2570 
2571 #if defined(AMD64) || defined(IA32) || defined(X32)
2572 const char* search_string = &quot;model name&quot;;
2573 #elif defined(M68K)
2574 const char* search_string = &quot;CPU&quot;;
2575 #elif defined(PPC64)
2576 const char* search_string = &quot;cpu&quot;;
2577 #elif defined(S390)
2578 const char* search_string = &quot;machine =&quot;;
2579 #elif defined(SPARC)
2580 const char* search_string = &quot;cpu&quot;;
2581 #else
2582 const char* search_string = &quot;Processor&quot;;
2583 #endif
2584 
2585 // Parses the cpuinfo file for string representing the model name.
2586 void os::get_summary_cpu_info(char* cpuinfo, size_t length) {
2587   FILE* fp = fopen(&quot;/proc/cpuinfo&quot;, &quot;r&quot;);
2588   if (fp != NULL) {
2589     while (!feof(fp)) {
2590       char buf[256];
2591       if (fgets(buf, sizeof(buf), fp)) {
2592         char* start = strstr(buf, search_string);
2593         if (start != NULL) {
2594           char *ptr = start + strlen(search_string);
2595           char *end = buf + strlen(buf);
2596           while (ptr != end) {
2597              // skip whitespace and colon for the rest of the name.
2598              if (*ptr != &#39; &#39; &amp;&amp; *ptr != &#39;\t&#39; &amp;&amp; *ptr != &#39;:&#39;) {
2599                break;
2600              }
2601              ptr++;
2602           }
2603           if (ptr != end) {
2604             // reasonable string, get rid of newline and keep the rest
2605             char* nl = strchr(buf, &#39;\n&#39;);
2606             if (nl != NULL) *nl = &#39;\0&#39;;
2607             strncpy(cpuinfo, ptr, length);
2608             fclose(fp);
2609             return;
2610           }
2611         }
2612       }
2613     }
2614     fclose(fp);
2615   }
2616   // cpuinfo not found or parsing failed, just print generic string.  The entire
2617   // /proc/cpuinfo file will be printed later in the file (or enough of it for x86)
2618 #if   defined(AARCH64)
2619   strncpy(cpuinfo, &quot;AArch64&quot;, length);
2620 #elif defined(AMD64)
2621   strncpy(cpuinfo, &quot;x86_64&quot;, length);
2622 #elif defined(ARM)  // Order wrt. AARCH64 is relevant!
2623   strncpy(cpuinfo, &quot;ARM&quot;, length);
2624 #elif defined(IA32)
2625   strncpy(cpuinfo, &quot;x86_32&quot;, length);
2626 #elif defined(IA64)
2627   strncpy(cpuinfo, &quot;IA64&quot;, length);
2628 #elif defined(PPC)
2629   strncpy(cpuinfo, &quot;PPC64&quot;, length);
2630 #elif defined(S390)
2631   strncpy(cpuinfo, &quot;S390&quot;, length);
2632 #elif defined(SPARC)
2633   strncpy(cpuinfo, &quot;sparcv9&quot;, length);
2634 #elif defined(ZERO_LIBARCH)
2635   strncpy(cpuinfo, ZERO_LIBARCH, length);
2636 #else
2637   strncpy(cpuinfo, &quot;unknown&quot;, length);
2638 #endif
2639 }
2640 
2641 static void print_signal_handler(outputStream* st, int sig,
2642                                  char* buf, size_t buflen);
2643 
2644 void os::print_signal_handlers(outputStream* st, char* buf, size_t buflen) {
2645   st-&gt;print_cr(&quot;Signal Handlers:&quot;);
2646   print_signal_handler(st, SIGSEGV, buf, buflen);
2647   print_signal_handler(st, SIGBUS , buf, buflen);
2648   print_signal_handler(st, SIGFPE , buf, buflen);
2649   print_signal_handler(st, SIGPIPE, buf, buflen);
2650   print_signal_handler(st, SIGXFSZ, buf, buflen);
2651   print_signal_handler(st, SIGILL , buf, buflen);
2652   print_signal_handler(st, SR_signum, buf, buflen);
2653   print_signal_handler(st, SHUTDOWN1_SIGNAL, buf, buflen);
2654   print_signal_handler(st, SHUTDOWN2_SIGNAL , buf, buflen);
2655   print_signal_handler(st, SHUTDOWN3_SIGNAL , buf, buflen);
2656   print_signal_handler(st, BREAK_SIGNAL, buf, buflen);
2657 #if defined(PPC64)
2658   print_signal_handler(st, SIGTRAP, buf, buflen);
2659 #endif
2660 }
2661 
2662 static char saved_jvm_path[MAXPATHLEN] = {0};
2663 
2664 // Find the full path to the current module, libjvm.so
2665 void os::jvm_path(char *buf, jint buflen) {
2666   // Error checking.
2667   if (buflen &lt; MAXPATHLEN) {
2668     assert(false, &quot;must use a large-enough buffer&quot;);
2669     buf[0] = &#39;\0&#39;;
2670     return;
2671   }
2672   // Lazy resolve the path to current module.
2673   if (saved_jvm_path[0] != 0) {
2674     strcpy(buf, saved_jvm_path);
2675     return;
2676   }
2677 
2678   char dli_fname[MAXPATHLEN];
2679   bool ret = dll_address_to_library_name(
2680                                          CAST_FROM_FN_PTR(address, os::jvm_path),
2681                                          dli_fname, sizeof(dli_fname), NULL);
2682   assert(ret, &quot;cannot locate libjvm&quot;);
2683   char *rp = NULL;
2684   if (ret &amp;&amp; dli_fname[0] != &#39;\0&#39;) {
2685     rp = os::Posix::realpath(dli_fname, buf, buflen);
2686   }
2687   if (rp == NULL) {
2688     return;
2689   }
2690 
2691   if (Arguments::sun_java_launcher_is_altjvm()) {
2692     // Support for the java launcher&#39;s &#39;-XXaltjvm=&lt;path&gt;&#39; option. Typical
2693     // value for buf is &quot;&lt;JAVA_HOME&gt;/jre/lib/&lt;vmtype&gt;/libjvm.so&quot;.
2694     // If &quot;/jre/lib/&quot; appears at the right place in the string, then
2695     // assume we are installed in a JDK and we&#39;re done. Otherwise, check
2696     // for a JAVA_HOME environment variable and fix up the path so it
2697     // looks like libjvm.so is installed there (append a fake suffix
2698     // hotspot/libjvm.so).
2699     const char *p = buf + strlen(buf) - 1;
2700     for (int count = 0; p &gt; buf &amp;&amp; count &lt; 5; ++count) {
2701       for (--p; p &gt; buf &amp;&amp; *p != &#39;/&#39;; --p)
2702         /* empty */ ;
2703     }
2704 
2705     if (strncmp(p, &quot;/jre/lib/&quot;, 9) != 0) {
2706       // Look for JAVA_HOME in the environment.
2707       char* java_home_var = ::getenv(&quot;JAVA_HOME&quot;);
2708       if (java_home_var != NULL &amp;&amp; java_home_var[0] != 0) {
2709         char* jrelib_p;
2710         int len;
2711 
2712         // Check the current module name &quot;libjvm.so&quot;.
2713         p = strrchr(buf, &#39;/&#39;);
2714         if (p == NULL) {
2715           return;
2716         }
2717         assert(strstr(p, &quot;/libjvm&quot;) == p, &quot;invalid library name&quot;);
2718 
2719         rp = os::Posix::realpath(java_home_var, buf, buflen);
2720         if (rp == NULL) {
2721           return;
2722         }
2723 
2724         // determine if this is a legacy image or modules image
2725         // modules image doesn&#39;t have &quot;jre&quot; subdirectory
2726         len = strlen(buf);
2727         assert(len &lt; buflen, &quot;Ran out of buffer room&quot;);
2728         jrelib_p = buf + len;
2729         snprintf(jrelib_p, buflen-len, &quot;/jre/lib&quot;);
2730         if (0 != access(buf, F_OK)) {
2731           snprintf(jrelib_p, buflen-len, &quot;/lib&quot;);
2732         }
2733 
2734         if (0 == access(buf, F_OK)) {
2735           // Use current module name &quot;libjvm.so&quot;
2736           len = strlen(buf);
2737           snprintf(buf + len, buflen-len, &quot;/hotspot/libjvm.so&quot;);
2738         } else {
2739           // Go back to path of .so
2740           rp = os::Posix::realpath(dli_fname, buf, buflen);
2741           if (rp == NULL) {
2742             return;
2743           }
2744         }
2745       }
2746     }
2747   }
2748 
2749   strncpy(saved_jvm_path, buf, MAXPATHLEN);
2750   saved_jvm_path[MAXPATHLEN - 1] = &#39;\0&#39;;
2751 }
2752 
2753 void os::print_jni_name_prefix_on(outputStream* st, int args_size) {
2754   // no prefix required, not even &quot;_&quot;
2755 }
2756 
2757 void os::print_jni_name_suffix_on(outputStream* st, int args_size) {
2758   // no suffix required
2759 }
2760 
2761 ////////////////////////////////////////////////////////////////////////////////
2762 // sun.misc.Signal support
2763 
2764 static void UserHandler(int sig, void *siginfo, void *context) {
2765   // Ctrl-C is pressed during error reporting, likely because the error
2766   // handler fails to abort. Let VM die immediately.
2767   if (sig == SIGINT &amp;&amp; VMError::is_error_reported()) {
2768     os::die();
2769   }
2770 
2771   os::signal_notify(sig);
2772 }
2773 
2774 void* os::user_handler() {
2775   return CAST_FROM_FN_PTR(void*, UserHandler);
2776 }
2777 
2778 extern &quot;C&quot; {
2779   typedef void (*sa_handler_t)(int);
2780   typedef void (*sa_sigaction_t)(int, siginfo_t *, void *);
2781 }
2782 
2783 void* os::signal(int signal_number, void* handler) {
2784   struct sigaction sigAct, oldSigAct;
2785 
2786   sigfillset(&amp;(sigAct.sa_mask));
2787   sigAct.sa_flags   = SA_RESTART|SA_SIGINFO;
2788   sigAct.sa_handler = CAST_TO_FN_PTR(sa_handler_t, handler);
2789 
2790   if (sigaction(signal_number, &amp;sigAct, &amp;oldSigAct)) {
2791     // -1 means registration failed
2792     return (void *)-1;
2793   }
2794 
2795   return CAST_FROM_FN_PTR(void*, oldSigAct.sa_handler);
2796 }
2797 
2798 void os::signal_raise(int signal_number) {
2799   ::raise(signal_number);
2800 }
2801 
2802 // The following code is moved from os.cpp for making this
2803 // code platform specific, which it is by its very nature.
2804 
2805 // Will be modified when max signal is changed to be dynamic
2806 int os::sigexitnum_pd() {
2807   return NSIG;
2808 }
2809 
2810 // a counter for each possible signal value
2811 static volatile jint pending_signals[NSIG+1] = { 0 };
2812 
2813 // Linux(POSIX) specific hand shaking semaphore.
2814 static Semaphore* sig_sem = NULL;
2815 static PosixSemaphore sr_semaphore;
2816 
2817 static void jdk_misc_signal_init() {
2818   // Initialize signal structures
2819   ::memset((void*)pending_signals, 0, sizeof(pending_signals));
2820 
2821   // Initialize signal semaphore
2822   sig_sem = new Semaphore();
2823 }
2824 
2825 void os::signal_notify(int sig) {
2826   if (sig_sem != NULL) {
2827     Atomic::inc(&amp;pending_signals[sig]);
2828     sig_sem-&gt;signal();
2829   } else {
2830     // Signal thread is not created with ReduceSignalUsage and jdk_misc_signal_init
2831     // initialization isn&#39;t called.
2832     assert(ReduceSignalUsage, &quot;signal semaphore should be created&quot;);
2833   }
2834 }
2835 
2836 static int check_pending_signals() {
2837   for (;;) {
2838     for (int i = 0; i &lt; NSIG + 1; i++) {
2839       jint n = pending_signals[i];
2840       if (n &gt; 0 &amp;&amp; n == Atomic::cmpxchg(&amp;pending_signals[i], n, n - 1)) {
2841         return i;
2842       }
2843     }
2844     JavaThread *thread = JavaThread::current();
2845     ThreadBlockInVM tbivm(thread);
2846 
2847     bool threadIsSuspended;
2848     do {
2849       thread-&gt;set_suspend_equivalent();
2850       // cleared by handle_special_suspend_equivalent_condition() or java_suspend_self()
2851       sig_sem-&gt;wait();
2852 
2853       // were we externally suspended while we were waiting?
2854       threadIsSuspended = thread-&gt;handle_special_suspend_equivalent_condition();
2855       if (threadIsSuspended) {
2856         // The semaphore has been incremented, but while we were waiting
2857         // another thread suspended us. We don&#39;t want to continue running
2858         // while suspended because that would surprise the thread that
2859         // suspended us.
2860         sig_sem-&gt;signal();
2861 
2862         thread-&gt;java_suspend_self();
2863       }
2864     } while (threadIsSuspended);
2865   }
2866 }
2867 
2868 int os::signal_wait() {
2869   return check_pending_signals();
2870 }
2871 
2872 ////////////////////////////////////////////////////////////////////////////////
2873 // Virtual Memory
2874 
2875 int os::vm_page_size() {
2876   // Seems redundant as all get out
2877   assert(os::Linux::page_size() != -1, &quot;must call os::init&quot;);
2878   return os::Linux::page_size();
2879 }
2880 
2881 // Solaris allocates memory by pages.
2882 int os::vm_allocation_granularity() {
2883   assert(os::Linux::page_size() != -1, &quot;must call os::init&quot;);
2884   return os::Linux::page_size();
2885 }
2886 
2887 // Rationale behind this function:
2888 //  current (Mon Apr 25 20:12:18 MSD 2005) oprofile drops samples without executable
2889 //  mapping for address (see lookup_dcookie() in the kernel module), thus we cannot get
2890 //  samples for JITted code. Here we create private executable mapping over the code cache
2891 //  and then we can use standard (well, almost, as mapping can change) way to provide
2892 //  info for the reporting script by storing timestamp and location of symbol
2893 void linux_wrap_code(char* base, size_t size) {
2894   static volatile jint cnt = 0;
2895 
2896   if (!UseOprofile) {
2897     return;
2898   }
2899 
2900   char buf[PATH_MAX+1];
2901   int num = Atomic::add(&amp;cnt, 1);
2902 
2903   snprintf(buf, sizeof(buf), &quot;%s/hs-vm-%d-%d&quot;,
2904            os::get_temp_directory(), os::current_process_id(), num);
2905   unlink(buf);
2906 
2907   int fd = ::open(buf, O_CREAT | O_RDWR, S_IRWXU);
2908 
2909   if (fd != -1) {
2910     off_t rv = ::lseek(fd, size-2, SEEK_SET);
2911     if (rv != (off_t)-1) {
2912       if (::write(fd, &quot;&quot;, 1) == 1) {
2913         mmap(base, size,
2914              PROT_READ|PROT_WRITE|PROT_EXEC,
2915              MAP_PRIVATE|MAP_FIXED|MAP_NORESERVE, fd, 0);
2916       }
2917     }
2918     ::close(fd);
2919     unlink(buf);
2920   }
2921 }
2922 
2923 static bool recoverable_mmap_error(int err) {
2924   // See if the error is one we can let the caller handle. This
2925   // list of errno values comes from JBS-6843484. I can&#39;t find a
2926   // Linux man page that documents this specific set of errno
2927   // values so while this list currently matches Solaris, it may
2928   // change as we gain experience with this failure mode.
2929   switch (err) {
2930   case EBADF:
2931   case EINVAL:
2932   case ENOTSUP:
2933     // let the caller deal with these errors
2934     return true;
2935 
2936   default:
2937     // Any remaining errors on this OS can cause our reserved mapping
2938     // to be lost. That can cause confusion where different data
2939     // structures think they have the same memory mapped. The worst
2940     // scenario is if both the VM and a library think they have the
2941     // same memory mapped.
2942     return false;
2943   }
2944 }
2945 
2946 static void warn_fail_commit_memory(char* addr, size_t size, bool exec,
2947                                     int err) {
2948   warning(&quot;INFO: os::commit_memory(&quot; PTR_FORMAT &quot;, &quot; SIZE_FORMAT
2949           &quot;, %d) failed; error=&#39;%s&#39; (errno=%d)&quot;, p2i(addr), size, exec,
2950           os::strerror(err), err);
2951 }
2952 
2953 static void warn_fail_commit_memory(char* addr, size_t size,
2954                                     size_t alignment_hint, bool exec,
2955                                     int err) {
2956   warning(&quot;INFO: os::commit_memory(&quot; PTR_FORMAT &quot;, &quot; SIZE_FORMAT
2957           &quot;, &quot; SIZE_FORMAT &quot;, %d) failed; error=&#39;%s&#39; (errno=%d)&quot;, p2i(addr), size,
2958           alignment_hint, exec, os::strerror(err), err);
2959 }
2960 
2961 // NOTE: Linux kernel does not really reserve the pages for us.
2962 //       All it does is to check if there are enough free pages
2963 //       left at the time of mmap(). This could be a potential
2964 //       problem.
2965 int os::Linux::commit_memory_impl(char* addr, size_t size, bool exec) {
2966   int prot = exec ? PROT_READ|PROT_WRITE|PROT_EXEC : PROT_READ|PROT_WRITE;
2967   uintptr_t res = (uintptr_t) ::mmap(addr, size, prot,
2968                                      MAP_PRIVATE|MAP_FIXED|MAP_ANONYMOUS, -1, 0);
2969   if (res != (uintptr_t) MAP_FAILED) {
2970     if (UseNUMAInterleaving) {
2971       numa_make_global(addr, size);
2972     }
2973     return 0;
2974   }
2975 
2976   int err = errno;  // save errno from mmap() call above
2977 
2978   if (!recoverable_mmap_error(err)) {
2979     warn_fail_commit_memory(addr, size, exec, err);
2980     vm_exit_out_of_memory(size, OOM_MMAP_ERROR, &quot;committing reserved memory.&quot;);
2981   }
2982 
2983   return err;
2984 }
2985 
2986 bool os::pd_commit_memory(char* addr, size_t size, bool exec) {
2987   return os::Linux::commit_memory_impl(addr, size, exec) == 0;
2988 }
2989 
2990 void os::pd_commit_memory_or_exit(char* addr, size_t size, bool exec,
2991                                   const char* mesg) {
2992   assert(mesg != NULL, &quot;mesg must be specified&quot;);
2993   int err = os::Linux::commit_memory_impl(addr, size, exec);
2994   if (err != 0) {
2995     // the caller wants all commit errors to exit with the specified mesg:
2996     warn_fail_commit_memory(addr, size, exec, err);
2997     vm_exit_out_of_memory(size, OOM_MMAP_ERROR, &quot;%s&quot;, mesg);
2998   }
2999 }
3000 
3001 // Define MAP_HUGETLB here so we can build HotSpot on old systems.
3002 #ifndef MAP_HUGETLB
3003   #define MAP_HUGETLB 0x40000
3004 #endif
3005 
3006 // If mmap flags are set with MAP_HUGETLB and the system supports multiple
3007 // huge page sizes, flag bits [26:31] can be used to encode the log2 of the
3008 // desired huge page size. Otherwise, the system&#39;s default huge page size will be used.
3009 // See mmap(2) man page for more info (since Linux 3.8).
3010 // https://lwn.net/Articles/533499/
3011 #ifndef MAP_HUGE_SHIFT
3012   #define MAP_HUGE_SHIFT 26
3013 #endif
3014 
3015 // Define MADV_HUGEPAGE here so we can build HotSpot on old systems.
3016 #ifndef MADV_HUGEPAGE
3017   #define MADV_HUGEPAGE 14
3018 #endif
3019 
3020 int os::Linux::commit_memory_impl(char* addr, size_t size,
3021                                   size_t alignment_hint, bool exec) {
3022   int err = os::Linux::commit_memory_impl(addr, size, exec);
3023   if (err == 0) {
3024     realign_memory(addr, size, alignment_hint);
3025   }
3026   return err;
3027 }
3028 
3029 bool os::pd_commit_memory(char* addr, size_t size, size_t alignment_hint,
3030                           bool exec) {
3031   return os::Linux::commit_memory_impl(addr, size, alignment_hint, exec) == 0;
3032 }
3033 
3034 void os::pd_commit_memory_or_exit(char* addr, size_t size,
3035                                   size_t alignment_hint, bool exec,
3036                                   const char* mesg) {
3037   assert(mesg != NULL, &quot;mesg must be specified&quot;);
3038   int err = os::Linux::commit_memory_impl(addr, size, alignment_hint, exec);
3039   if (err != 0) {
3040     // the caller wants all commit errors to exit with the specified mesg:
3041     warn_fail_commit_memory(addr, size, alignment_hint, exec, err);
3042     vm_exit_out_of_memory(size, OOM_MMAP_ERROR, &quot;%s&quot;, mesg);
3043   }
3044 }
3045 
3046 void os::pd_realign_memory(char *addr, size_t bytes, size_t alignment_hint) {
3047   if (UseTransparentHugePages &amp;&amp; alignment_hint &gt; (size_t)vm_page_size()) {
3048     // We don&#39;t check the return value: madvise(MADV_HUGEPAGE) may not
3049     // be supported or the memory may already be backed by huge pages.
3050     ::madvise(addr, bytes, MADV_HUGEPAGE);
3051   }
3052 }
3053 
3054 void os::pd_free_memory(char *addr, size_t bytes, size_t alignment_hint) {
3055   // This method works by doing an mmap over an existing mmaping and effectively discarding
3056   // the existing pages. However it won&#39;t work for SHM-based large pages that cannot be
3057   // uncommitted at all. We don&#39;t do anything in this case to avoid creating a segment with
3058   // small pages on top of the SHM segment. This method always works for small pages, so we
3059   // allow that in any case.
3060   if (alignment_hint &lt;= (size_t)os::vm_page_size() || can_commit_large_page_memory()) {
3061     commit_memory(addr, bytes, alignment_hint, !ExecMem);
3062   }
3063 }
3064 
3065 void os::numa_make_global(char *addr, size_t bytes) {
3066   Linux::numa_interleave_memory(addr, bytes);
3067 }
3068 
3069 // Define for numa_set_bind_policy(int). Setting the argument to 0 will set the
3070 // bind policy to MPOL_PREFERRED for the current thread.
3071 #define USE_MPOL_PREFERRED 0
3072 
3073 void os::numa_make_local(char *addr, size_t bytes, int lgrp_hint) {
3074   // To make NUMA and large pages more robust when both enabled, we need to ease
3075   // the requirements on where the memory should be allocated. MPOL_BIND is the
3076   // default policy and it will force memory to be allocated on the specified
3077   // node. Changing this to MPOL_PREFERRED will prefer to allocate the memory on
3078   // the specified node, but will not force it. Using this policy will prevent
3079   // getting SIGBUS when trying to allocate large pages on NUMA nodes with no
3080   // free large pages.
3081   Linux::numa_set_bind_policy(USE_MPOL_PREFERRED);
3082   Linux::numa_tonode_memory(addr, bytes, lgrp_hint);
3083 }
3084 
3085 bool os::numa_topology_changed() { return false; }
3086 
3087 size_t os::numa_get_groups_num() {
3088   // Return just the number of nodes in which it&#39;s possible to allocate memory
3089   // (in numa terminology, configured nodes).
3090   return Linux::numa_num_configured_nodes();
3091 }
3092 
3093 int os::numa_get_group_id() {
3094   int cpu_id = Linux::sched_getcpu();
3095   if (cpu_id != -1) {
3096     int lgrp_id = Linux::get_node_by_cpu(cpu_id);
3097     if (lgrp_id != -1) {
3098       return lgrp_id;
3099     }
3100   }
3101   return 0;
3102 }
3103 
3104 int os::numa_get_group_id_for_address(const void* address) {
3105   void** pages = const_cast&lt;void**&gt;(&amp;address);
3106   int id = -1;
3107 
3108   if (os::Linux::numa_move_pages(0, 1, pages, NULL, &amp;id, 0) == -1) {
3109     return -1;
3110   }
3111   if (id &lt; 0) {
3112     return -1;
3113   }
3114   return id;
3115 }
3116 
3117 int os::Linux::get_existing_num_nodes() {
3118   int node;
3119   int highest_node_number = Linux::numa_max_node();
3120   int num_nodes = 0;
3121 
3122   // Get the total number of nodes in the system including nodes without memory.
3123   for (node = 0; node &lt;= highest_node_number; node++) {
3124     if (is_node_in_existing_nodes(node)) {
3125       num_nodes++;
3126     }
3127   }
3128   return num_nodes;
3129 }
3130 
3131 size_t os::numa_get_leaf_groups(int *ids, size_t size) {
3132   int highest_node_number = Linux::numa_max_node();
3133   size_t i = 0;
3134 
3135   // Map all node ids in which it is possible to allocate memory. Also nodes are
3136   // not always consecutively available, i.e. available from 0 to the highest
3137   // node number. If the nodes have been bound explicitly using numactl membind,
3138   // then allocate memory from those nodes only.
3139   for (int node = 0; node &lt;= highest_node_number; node++) {
3140     if (Linux::is_node_in_bound_nodes((unsigned int)node)) {
3141       ids[i++] = node;
3142     }
3143   }
3144   return i;
3145 }
3146 
3147 bool os::get_page_info(char *start, page_info* info) {
3148   return false;
3149 }
3150 
3151 char *os::scan_pages(char *start, char* end, page_info* page_expected,
3152                      page_info* page_found) {
3153   return end;
3154 }
3155 
3156 
3157 int os::Linux::sched_getcpu_syscall(void) {
3158   unsigned int cpu = 0;
3159   int retval = -1;
3160 
3161 #if defined(IA32)
3162   #ifndef SYS_getcpu
3163     #define SYS_getcpu 318
3164   #endif
3165   retval = syscall(SYS_getcpu, &amp;cpu, NULL, NULL);
3166 #elif defined(AMD64)
3167 // Unfortunately we have to bring all these macros here from vsyscall.h
3168 // to be able to compile on old linuxes.
3169   #define __NR_vgetcpu 2
3170   #define VSYSCALL_START (-10UL &lt;&lt; 20)
3171   #define VSYSCALL_SIZE 1024
3172   #define VSYSCALL_ADDR(vsyscall_nr) (VSYSCALL_START+VSYSCALL_SIZE*(vsyscall_nr))
3173   typedef long (*vgetcpu_t)(unsigned int *cpu, unsigned int *node, unsigned long *tcache);
3174   vgetcpu_t vgetcpu = (vgetcpu_t)VSYSCALL_ADDR(__NR_vgetcpu);
3175   retval = vgetcpu(&amp;cpu, NULL, NULL);
3176 #endif
3177 
3178   return (retval == -1) ? retval : cpu;
3179 }
3180 
3181 void os::Linux::sched_getcpu_init() {
3182   // sched_getcpu() should be in libc.
3183   set_sched_getcpu(CAST_TO_FN_PTR(sched_getcpu_func_t,
3184                                   dlsym(RTLD_DEFAULT, &quot;sched_getcpu&quot;)));
3185 
3186   // If it&#39;s not, try a direct syscall.
3187   if (sched_getcpu() == -1) {
3188     set_sched_getcpu(CAST_TO_FN_PTR(sched_getcpu_func_t,
3189                                     (void*)&amp;sched_getcpu_syscall));
3190   }
3191 
3192   if (sched_getcpu() == -1) {
3193     vm_exit_during_initialization(&quot;getcpu(2) system call not supported by kernel&quot;);
3194   }
3195 }
3196 
3197 // Something to do with the numa-aware allocator needs these symbols
3198 extern &quot;C&quot; JNIEXPORT void numa_warn(int number, char *where, ...) { }
3199 extern &quot;C&quot; JNIEXPORT void numa_error(char *where) { }
3200 
3201 static void* dlvsym_if_available(void* handle, const char* name, const char* version) {
3202   typedef void* (*dlvsym_func_type)(void* handle, const char* name, const char* version);
3203   static dlvsym_func_type dlvsym_func;
3204   static bool initialized = false;
3205 
3206   if (!initialized) {
3207     dlvsym_func = (dlvsym_func_type)dlsym(RTLD_NEXT, &quot;dlvsym&quot;);
3208     initialized = true;
3209   }
3210 
3211   if (dlvsym_func != NULL) {
3212     void *f = dlvsym_func(handle, name, version);
3213     if (f != NULL) {
3214       return f;
3215     }
3216   }
3217 
3218   return dlsym(handle, name);
3219 }
3220 
3221 // Handle request to load libnuma symbol version 1.1 (API v1). If it fails
3222 // load symbol from base version instead.
3223 void* os::Linux::libnuma_dlsym(void* handle, const char *name) {
3224   return dlvsym_if_available(handle, name, &quot;libnuma_1.1&quot;);
3225 }
3226 
3227 // Handle request to load libnuma symbol version 1.2 (API v2) only.
3228 // Return NULL if the symbol is not defined in this particular version.
3229 void* os::Linux::libnuma_v2_dlsym(void* handle, const char* name) {
3230   return dlvsym_if_available(handle, name, &quot;libnuma_1.2&quot;);
3231 }
3232 
3233 bool os::Linux::libnuma_init() {
3234   if (sched_getcpu() != -1) { // Requires sched_getcpu() support
3235     void *handle = dlopen(&quot;libnuma.so.1&quot;, RTLD_LAZY);
3236     if (handle != NULL) {
3237       set_numa_node_to_cpus(CAST_TO_FN_PTR(numa_node_to_cpus_func_t,
3238                                            libnuma_dlsym(handle, &quot;numa_node_to_cpus&quot;)));
3239       set_numa_max_node(CAST_TO_FN_PTR(numa_max_node_func_t,
3240                                        libnuma_dlsym(handle, &quot;numa_max_node&quot;)));
3241       set_numa_num_configured_nodes(CAST_TO_FN_PTR(numa_num_configured_nodes_func_t,
3242                                                    libnuma_dlsym(handle, &quot;numa_num_configured_nodes&quot;)));
3243       set_numa_available(CAST_TO_FN_PTR(numa_available_func_t,
3244                                         libnuma_dlsym(handle, &quot;numa_available&quot;)));
3245       set_numa_tonode_memory(CAST_TO_FN_PTR(numa_tonode_memory_func_t,
3246                                             libnuma_dlsym(handle, &quot;numa_tonode_memory&quot;)));
3247       set_numa_interleave_memory(CAST_TO_FN_PTR(numa_interleave_memory_func_t,
3248                                                 libnuma_dlsym(handle, &quot;numa_interleave_memory&quot;)));
3249       set_numa_interleave_memory_v2(CAST_TO_FN_PTR(numa_interleave_memory_v2_func_t,
3250                                                 libnuma_v2_dlsym(handle, &quot;numa_interleave_memory&quot;)));
3251       set_numa_set_bind_policy(CAST_TO_FN_PTR(numa_set_bind_policy_func_t,
3252                                               libnuma_dlsym(handle, &quot;numa_set_bind_policy&quot;)));
3253       set_numa_bitmask_isbitset(CAST_TO_FN_PTR(numa_bitmask_isbitset_func_t,
3254                                                libnuma_dlsym(handle, &quot;numa_bitmask_isbitset&quot;)));
3255       set_numa_distance(CAST_TO_FN_PTR(numa_distance_func_t,
3256                                        libnuma_dlsym(handle, &quot;numa_distance&quot;)));
3257       set_numa_get_membind(CAST_TO_FN_PTR(numa_get_membind_func_t,
3258                                           libnuma_v2_dlsym(handle, &quot;numa_get_membind&quot;)));
3259       set_numa_get_interleave_mask(CAST_TO_FN_PTR(numa_get_interleave_mask_func_t,
3260                                                   libnuma_v2_dlsym(handle, &quot;numa_get_interleave_mask&quot;)));
3261       set_numa_move_pages(CAST_TO_FN_PTR(numa_move_pages_func_t,
3262                                          libnuma_dlsym(handle, &quot;numa_move_pages&quot;)));
3263       set_numa_set_preferred(CAST_TO_FN_PTR(numa_set_preferred_func_t,
3264                                             libnuma_dlsym(handle, &quot;numa_set_preferred&quot;)));
3265 
3266       if (numa_available() != -1) {
3267         set_numa_all_nodes((unsigned long*)libnuma_dlsym(handle, &quot;numa_all_nodes&quot;));
3268         set_numa_all_nodes_ptr((struct bitmask **)libnuma_dlsym(handle, &quot;numa_all_nodes_ptr&quot;));
3269         set_numa_nodes_ptr((struct bitmask **)libnuma_dlsym(handle, &quot;numa_nodes_ptr&quot;));
3270         set_numa_interleave_bitmask(_numa_get_interleave_mask());
3271         set_numa_membind_bitmask(_numa_get_membind());
3272         // Create an index -&gt; node mapping, since nodes are not always consecutive
3273         _nindex_to_node = new (ResourceObj::C_HEAP, mtInternal) GrowableArray&lt;int&gt;(0, true);
3274         rebuild_nindex_to_node_map();
3275         // Create a cpu -&gt; node mapping
3276         _cpu_to_node = new (ResourceObj::C_HEAP, mtInternal) GrowableArray&lt;int&gt;(0, true);
3277         rebuild_cpu_to_node_map();
3278         return true;
3279       }
3280     }
3281   }
3282   return false;
3283 }
3284 
3285 size_t os::Linux::default_guard_size(os::ThreadType thr_type) {
3286   // Creating guard page is very expensive. Java thread has HotSpot
3287   // guard pages, only enable glibc guard page for non-Java threads.
3288   // (Remember: compiler thread is a Java thread, too!)
3289   return ((thr_type == java_thread || thr_type == compiler_thread) ? 0 : page_size());
3290 }
3291 
3292 void os::Linux::rebuild_nindex_to_node_map() {
3293   int highest_node_number = Linux::numa_max_node();
3294 
3295   nindex_to_node()-&gt;clear();
3296   for (int node = 0; node &lt;= highest_node_number; node++) {
3297     if (Linux::is_node_in_existing_nodes(node)) {
3298       nindex_to_node()-&gt;append(node);
3299     }
3300   }
3301 }
3302 
3303 // rebuild_cpu_to_node_map() constructs a table mapping cpud id to node id.
3304 // The table is later used in get_node_by_cpu().
3305 void os::Linux::rebuild_cpu_to_node_map() {
3306   const size_t NCPUS = 32768; // Since the buffer size computation is very obscure
3307                               // in libnuma (possible values are starting from 16,
3308                               // and continuing up with every other power of 2, but less
3309                               // than the maximum number of CPUs supported by kernel), and
3310                               // is a subject to change (in libnuma version 2 the requirements
3311                               // are more reasonable) we&#39;ll just hardcode the number they use
3312                               // in the library.
3313   const size_t BitsPerCLong = sizeof(long) * CHAR_BIT;
3314 
3315   size_t cpu_num = processor_count();
3316   size_t cpu_map_size = NCPUS / BitsPerCLong;
3317   size_t cpu_map_valid_size =
3318     MIN2((cpu_num + BitsPerCLong - 1) / BitsPerCLong, cpu_map_size);
3319 
3320   cpu_to_node()-&gt;clear();
3321   cpu_to_node()-&gt;at_grow(cpu_num - 1);
3322 
3323   size_t node_num = get_existing_num_nodes();
3324 
3325   int distance = 0;
3326   int closest_distance = INT_MAX;
3327   int closest_node = 0;
3328   unsigned long *cpu_map = NEW_C_HEAP_ARRAY(unsigned long, cpu_map_size, mtInternal);
3329   for (size_t i = 0; i &lt; node_num; i++) {
3330     // Check if node is configured (not a memory-less node). If it is not, find
3331     // the closest configured node. Check also if node is bound, i.e. it&#39;s allowed
3332     // to allocate memory from the node. If it&#39;s not allowed, map cpus in that node
3333     // to the closest node from which memory allocation is allowed.
3334     if (!is_node_in_configured_nodes(nindex_to_node()-&gt;at(i)) ||
3335         !is_node_in_bound_nodes(nindex_to_node()-&gt;at(i))) {
3336       closest_distance = INT_MAX;
3337       // Check distance from all remaining nodes in the system. Ignore distance
3338       // from itself, from another non-configured node, and from another non-bound
3339       // node.
3340       for (size_t m = 0; m &lt; node_num; m++) {
3341         if (m != i &amp;&amp;
3342             is_node_in_configured_nodes(nindex_to_node()-&gt;at(m)) &amp;&amp;
3343             is_node_in_bound_nodes(nindex_to_node()-&gt;at(m))) {
3344           distance = numa_distance(nindex_to_node()-&gt;at(i), nindex_to_node()-&gt;at(m));
3345           // If a closest node is found, update. There is always at least one
3346           // configured and bound node in the system so there is always at least
3347           // one node close.
3348           if (distance != 0 &amp;&amp; distance &lt; closest_distance) {
3349             closest_distance = distance;
3350             closest_node = nindex_to_node()-&gt;at(m);
3351           }
3352         }
3353       }
3354      } else {
3355        // Current node is already a configured node.
3356        closest_node = nindex_to_node()-&gt;at(i);
3357      }
3358 
3359     // Get cpus from the original node and map them to the closest node. If node
3360     // is a configured node (not a memory-less node), then original node and
3361     // closest node are the same.
3362     if (numa_node_to_cpus(nindex_to_node()-&gt;at(i), cpu_map, cpu_map_size * sizeof(unsigned long)) != -1) {
3363       for (size_t j = 0; j &lt; cpu_map_valid_size; j++) {
3364         if (cpu_map[j] != 0) {
3365           for (size_t k = 0; k &lt; BitsPerCLong; k++) {
3366             if (cpu_map[j] &amp; (1UL &lt;&lt; k)) {
3367               cpu_to_node()-&gt;at_put(j * BitsPerCLong + k, closest_node);
3368             }
3369           }
3370         }
3371       }
3372     }
3373   }
3374   FREE_C_HEAP_ARRAY(unsigned long, cpu_map);
3375 }
3376 
3377 int os::Linux::get_node_by_cpu(int cpu_id) {
3378   if (cpu_to_node() != NULL &amp;&amp; cpu_id &gt;= 0 &amp;&amp; cpu_id &lt; cpu_to_node()-&gt;length()) {
3379     return cpu_to_node()-&gt;at(cpu_id);
3380   }
3381   return -1;
3382 }
3383 
3384 GrowableArray&lt;int&gt;* os::Linux::_cpu_to_node;
3385 GrowableArray&lt;int&gt;* os::Linux::_nindex_to_node;
3386 os::Linux::sched_getcpu_func_t os::Linux::_sched_getcpu;
3387 os::Linux::numa_node_to_cpus_func_t os::Linux::_numa_node_to_cpus;
3388 os::Linux::numa_max_node_func_t os::Linux::_numa_max_node;
3389 os::Linux::numa_num_configured_nodes_func_t os::Linux::_numa_num_configured_nodes;
3390 os::Linux::numa_available_func_t os::Linux::_numa_available;
3391 os::Linux::numa_tonode_memory_func_t os::Linux::_numa_tonode_memory;
3392 os::Linux::numa_interleave_memory_func_t os::Linux::_numa_interleave_memory;
3393 os::Linux::numa_interleave_memory_v2_func_t os::Linux::_numa_interleave_memory_v2;
3394 os::Linux::numa_set_bind_policy_func_t os::Linux::_numa_set_bind_policy;
3395 os::Linux::numa_bitmask_isbitset_func_t os::Linux::_numa_bitmask_isbitset;
3396 os::Linux::numa_distance_func_t os::Linux::_numa_distance;
3397 os::Linux::numa_get_membind_func_t os::Linux::_numa_get_membind;
3398 os::Linux::numa_get_interleave_mask_func_t os::Linux::_numa_get_interleave_mask;
3399 os::Linux::numa_move_pages_func_t os::Linux::_numa_move_pages;
3400 os::Linux::numa_set_preferred_func_t os::Linux::_numa_set_preferred;
3401 os::Linux::NumaAllocationPolicy os::Linux::_current_numa_policy;
3402 unsigned long* os::Linux::_numa_all_nodes;
3403 struct bitmask* os::Linux::_numa_all_nodes_ptr;
3404 struct bitmask* os::Linux::_numa_nodes_ptr;
3405 struct bitmask* os::Linux::_numa_interleave_bitmask;
3406 struct bitmask* os::Linux::_numa_membind_bitmask;
3407 
3408 bool os::pd_uncommit_memory(char* addr, size_t size) {
3409   uintptr_t res = (uintptr_t) ::mmap(addr, size, PROT_NONE,
3410                                      MAP_PRIVATE|MAP_FIXED|MAP_NORESERVE|MAP_ANONYMOUS, -1, 0);
3411   return res  != (uintptr_t) MAP_FAILED;
3412 }
3413 
3414 static address get_stack_commited_bottom(address bottom, size_t size) {
3415   address nbot = bottom;
3416   address ntop = bottom + size;
3417 
3418   size_t page_sz = os::vm_page_size();
3419   unsigned pages = size / page_sz;
3420 
3421   unsigned char vec[1];
3422   unsigned imin = 1, imax = pages + 1, imid;
3423   int mincore_return_value = 0;
3424 
3425   assert(imin &lt;= imax, &quot;Unexpected page size&quot;);
3426 
3427   while (imin &lt; imax) {
3428     imid = (imax + imin) / 2;
3429     nbot = ntop - (imid * page_sz);
3430 
3431     // Use a trick with mincore to check whether the page is mapped or not.
3432     // mincore sets vec to 1 if page resides in memory and to 0 if page
3433     // is swapped output but if page we are asking for is unmapped
3434     // it returns -1,ENOMEM
3435     mincore_return_value = mincore(nbot, page_sz, vec);
3436 
3437     if (mincore_return_value == -1) {
3438       // Page is not mapped go up
3439       // to find first mapped page
3440       if (errno != EAGAIN) {
3441         assert(errno == ENOMEM, &quot;Unexpected mincore errno&quot;);
3442         imax = imid;
3443       }
3444     } else {
3445       // Page is mapped go down
3446       // to find first not mapped page
3447       imin = imid + 1;
3448     }
3449   }
3450 
3451   nbot = nbot + page_sz;
3452 
3453   // Adjust stack bottom one page up if last checked page is not mapped
3454   if (mincore_return_value == -1) {
3455     nbot = nbot + page_sz;
3456   }
3457 
3458   return nbot;
3459 }
3460 
3461 bool os::committed_in_range(address start, size_t size, address&amp; committed_start, size_t&amp; committed_size) {
3462   int mincore_return_value;
3463   const size_t stripe = 1024;  // query this many pages each time
3464   unsigned char vec[stripe + 1];
3465   // set a guard
3466   vec[stripe] = &#39;X&#39;;
3467 
3468   const size_t page_sz = os::vm_page_size();
3469   size_t pages = size / page_sz;
3470 
3471   assert(is_aligned(start, page_sz), &quot;Start address must be page aligned&quot;);
3472   assert(is_aligned(size, page_sz), &quot;Size must be page aligned&quot;);
3473 
3474   committed_start = NULL;
3475 
3476   int loops = (pages + stripe - 1) / stripe;
3477   int committed_pages = 0;
3478   address loop_base = start;
3479   bool found_range = false;
3480 
3481   for (int index = 0; index &lt; loops &amp;&amp; !found_range; index ++) {
3482     assert(pages &gt; 0, &quot;Nothing to do&quot;);
3483     int pages_to_query = (pages &gt;= stripe) ? stripe : pages;
3484     pages -= pages_to_query;
3485 
3486     // Get stable read
3487     while ((mincore_return_value = mincore(loop_base, pages_to_query * page_sz, vec)) == -1 &amp;&amp; errno == EAGAIN);
3488 
3489     // During shutdown, some memory goes away without properly notifying NMT,
3490     // E.g. ConcurrentGCThread/WatcherThread can exit without deleting thread object.
3491     // Bailout and return as not committed for now.
3492     if (mincore_return_value == -1 &amp;&amp; errno == ENOMEM) {
3493       return false;
3494     }
3495 
3496     assert(vec[stripe] == &#39;X&#39;, &quot;overflow guard&quot;);
3497     assert(mincore_return_value == 0, &quot;Range must be valid&quot;);
3498     // Process this stripe
3499     for (int vecIdx = 0; vecIdx &lt; pages_to_query; vecIdx ++) {
3500       if ((vec[vecIdx] &amp; 0x01) == 0) { // not committed
3501         // End of current contiguous region
3502         if (committed_start != NULL) {
3503           found_range = true;
3504           break;
3505         }
3506       } else { // committed
3507         // Start of region
3508         if (committed_start == NULL) {
3509           committed_start = loop_base + page_sz * vecIdx;
3510         }
3511         committed_pages ++;
3512       }
3513     }
3514 
3515     loop_base += pages_to_query * page_sz;
3516   }
3517 
3518   if (committed_start != NULL) {
3519     assert(committed_pages &gt; 0, &quot;Must have committed region&quot;);
3520     assert(committed_pages &lt;= int(size / page_sz), &quot;Can not commit more than it has&quot;);
3521     assert(committed_start &gt;= start &amp;&amp; committed_start &lt; start + size, &quot;Out of range&quot;);
3522     committed_size = page_sz * committed_pages;
3523     return true;
3524   } else {
3525     assert(committed_pages == 0, &quot;Should not have committed region&quot;);
3526     return false;
3527   }
3528 }
3529 
3530 
3531 // Linux uses a growable mapping for the stack, and if the mapping for
3532 // the stack guard pages is not removed when we detach a thread the
3533 // stack cannot grow beyond the pages where the stack guard was
3534 // mapped.  If at some point later in the process the stack expands to
3535 // that point, the Linux kernel cannot expand the stack any further
3536 // because the guard pages are in the way, and a segfault occurs.
3537 //
3538 // However, it&#39;s essential not to split the stack region by unmapping
3539 // a region (leaving a hole) that&#39;s already part of the stack mapping,
3540 // so if the stack mapping has already grown beyond the guard pages at
3541 // the time we create them, we have to truncate the stack mapping.
3542 // So, we need to know the extent of the stack mapping when
3543 // create_stack_guard_pages() is called.
3544 
3545 // We only need this for stacks that are growable: at the time of
3546 // writing thread stacks don&#39;t use growable mappings (i.e. those
3547 // creeated with MAP_GROWSDOWN), and aren&#39;t marked &quot;[stack]&quot;, so this
3548 // only applies to the main thread.
3549 
3550 // If the (growable) stack mapping already extends beyond the point
3551 // where we&#39;re going to put our guard pages, truncate the mapping at
3552 // that point by munmap()ping it.  This ensures that when we later
3553 // munmap() the guard pages we don&#39;t leave a hole in the stack
3554 // mapping. This only affects the main/primordial thread
3555 
3556 bool os::pd_create_stack_guard_pages(char* addr, size_t size) {
3557   if (os::is_primordial_thread()) {
3558     // As we manually grow stack up to bottom inside create_attached_thread(),
3559     // it&#39;s likely that os::Linux::initial_thread_stack_bottom is mapped and
3560     // we don&#39;t need to do anything special.
3561     // Check it first, before calling heavy function.
3562     uintptr_t stack_extent = (uintptr_t) os::Linux::initial_thread_stack_bottom();
3563     unsigned char vec[1];
3564 
3565     if (mincore((address)stack_extent, os::vm_page_size(), vec) == -1) {
3566       // Fallback to slow path on all errors, including EAGAIN
3567       stack_extent = (uintptr_t) get_stack_commited_bottom(
3568                                                            os::Linux::initial_thread_stack_bottom(),
3569                                                            (size_t)addr - stack_extent);
3570     }
3571 
3572     if (stack_extent &lt; (uintptr_t)addr) {
3573       ::munmap((void*)stack_extent, (uintptr_t)(addr - stack_extent));
3574     }
3575   }
3576 
3577   return os::commit_memory(addr, size, !ExecMem);
3578 }
3579 
3580 // If this is a growable mapping, remove the guard pages entirely by
3581 // munmap()ping them.  If not, just call uncommit_memory(). This only
3582 // affects the main/primordial thread, but guard against future OS changes.
3583 // It&#39;s safe to always unmap guard pages for primordial thread because we
3584 // always place it right after end of the mapped region.
3585 
3586 bool os::remove_stack_guard_pages(char* addr, size_t size) {
3587   uintptr_t stack_extent, stack_base;
3588 
3589   if (os::is_primordial_thread()) {
3590     return ::munmap(addr, size) == 0;
3591   }
3592 
3593   return os::uncommit_memory(addr, size);
3594 }
3595 
3596 // If &#39;fixed&#39; is true, anon_mmap() will attempt to reserve anonymous memory
3597 // at &#39;requested_addr&#39;. If there are existing memory mappings at the same
3598 // location, however, they will be overwritten. If &#39;fixed&#39; is false,
3599 // &#39;requested_addr&#39; is only treated as a hint, the return value may or
3600 // may not start from the requested address. Unlike Linux mmap(), this
3601 // function returns NULL to indicate failure.
3602 static char* anon_mmap(char* requested_addr, size_t bytes, bool fixed) {
3603   char * addr;
3604   int flags;
3605 
3606   flags = MAP_PRIVATE | MAP_NORESERVE | MAP_ANONYMOUS;
3607   if (fixed) {
3608     assert((uintptr_t)requested_addr % os::Linux::page_size() == 0, &quot;unaligned address&quot;);
3609     flags |= MAP_FIXED;
3610   }
3611 
3612   // Map reserved/uncommitted pages PROT_NONE so we fail early if we
3613   // touch an uncommitted page. Otherwise, the read/write might
3614   // succeed if we have enough swap space to back the physical page.
3615   addr = (char*)::mmap(requested_addr, bytes, PROT_NONE,
3616                        flags, -1, 0);
3617 
3618   return addr == MAP_FAILED ? NULL : addr;
3619 }
3620 
3621 // Allocate (using mmap, NO_RESERVE, with small pages) at either a given request address
3622 //   (req_addr != NULL) or with a given alignment.
3623 //  - bytes shall be a multiple of alignment.
3624 //  - req_addr can be NULL. If not NULL, it must be a multiple of alignment.
3625 //  - alignment sets the alignment at which memory shall be allocated.
3626 //     It must be a multiple of allocation granularity.
3627 // Returns address of memory or NULL. If req_addr was not NULL, will only return
3628 //  req_addr or NULL.
3629 static char* anon_mmap_aligned(size_t bytes, size_t alignment, char* req_addr) {
3630 
3631   size_t extra_size = bytes;
3632   if (req_addr == NULL &amp;&amp; alignment &gt; 0) {
3633     extra_size += alignment;
3634   }
3635 
3636   char* start = (char*) ::mmap(req_addr, extra_size, PROT_NONE,
3637     MAP_PRIVATE|MAP_ANONYMOUS|MAP_NORESERVE,
3638     -1, 0);
3639   if (start == MAP_FAILED) {
3640     start = NULL;
3641   } else {
3642     if (req_addr != NULL) {
3643       if (start != req_addr) {
3644         ::munmap(start, extra_size);
3645         start = NULL;
3646       }
3647     } else {
3648       char* const start_aligned = align_up(start, alignment);
3649       char* const end_aligned = start_aligned + bytes;
3650       char* const end = start + extra_size;
3651       if (start_aligned &gt; start) {
3652         ::munmap(start, start_aligned - start);
3653       }
3654       if (end_aligned &lt; end) {
3655         ::munmap(end_aligned, end - end_aligned);
3656       }
3657       start = start_aligned;
3658     }
3659   }
3660   return start;
3661 }
3662 
3663 static int anon_munmap(char * addr, size_t size) {
3664   return ::munmap(addr, size) == 0;
3665 }
3666 
3667 char* os::pd_reserve_memory(size_t bytes, char* requested_addr,
3668                             size_t alignment_hint) {
3669   return anon_mmap(requested_addr, bytes, (requested_addr != NULL));
3670 }
3671 
3672 bool os::pd_release_memory(char* addr, size_t size) {
3673   return anon_munmap(addr, size);
3674 }
3675 
3676 static bool linux_mprotect(char* addr, size_t size, int prot) {
3677   // Linux wants the mprotect address argument to be page aligned.
3678   char* bottom = (char*)align_down((intptr_t)addr, os::Linux::page_size());
3679 
3680   // According to SUSv3, mprotect() should only be used with mappings
3681   // established by mmap(), and mmap() always maps whole pages. Unaligned
3682   // &#39;addr&#39; likely indicates problem in the VM (e.g. trying to change
3683   // protection of malloc&#39;ed or statically allocated memory). Check the
3684   // caller if you hit this assert.
3685   assert(addr == bottom, &quot;sanity check&quot;);
3686 
3687   size = align_up(pointer_delta(addr, bottom, 1) + size, os::Linux::page_size());
3688   Events::log(NULL, &quot;Protecting memory [&quot; INTPTR_FORMAT &quot;,&quot; INTPTR_FORMAT &quot;] with protection modes %x&quot;, p2i(bottom), p2i(bottom+size), prot);
3689   return ::mprotect(bottom, size, prot) == 0;
3690 }
3691 
3692 // Set protections specified
3693 bool os::protect_memory(char* addr, size_t bytes, ProtType prot,
3694                         bool is_committed) {
3695   unsigned int p = 0;
3696   switch (prot) {
3697   case MEM_PROT_NONE: p = PROT_NONE; break;
3698   case MEM_PROT_READ: p = PROT_READ; break;
3699   case MEM_PROT_RW:   p = PROT_READ|PROT_WRITE; break;
3700   case MEM_PROT_RWX:  p = PROT_READ|PROT_WRITE|PROT_EXEC; break;
3701   default:
3702     ShouldNotReachHere();
3703   }
3704   // is_committed is unused.
3705   return linux_mprotect(addr, bytes, p);
3706 }
3707 
3708 bool os::guard_memory(char* addr, size_t size) {
3709   return linux_mprotect(addr, size, PROT_NONE);
3710 }
3711 
3712 bool os::unguard_memory(char* addr, size_t size) {
3713   return linux_mprotect(addr, size, PROT_READ|PROT_WRITE);
3714 }
3715 
3716 bool os::Linux::transparent_huge_pages_sanity_check(bool warn,
3717                                                     size_t page_size) {
3718   bool result = false;
3719   void *p = mmap(NULL, page_size * 2, PROT_READ|PROT_WRITE,
3720                  MAP_ANONYMOUS|MAP_PRIVATE,
3721                  -1, 0);
3722   if (p != MAP_FAILED) {
3723     void *aligned_p = align_up(p, page_size);
3724 
3725     result = madvise(aligned_p, page_size, MADV_HUGEPAGE) == 0;
3726 
3727     munmap(p, page_size * 2);
3728   }
3729 
3730   if (warn &amp;&amp; !result) {
3731     warning(&quot;TransparentHugePages is not supported by the operating system.&quot;);
3732   }
3733 
3734   return result;
3735 }
3736 
3737 bool os::Linux::hugetlbfs_sanity_check(bool warn, size_t page_size) {
3738   bool result = false;
3739   void *p = mmap(NULL, page_size, PROT_READ|PROT_WRITE,
3740                  MAP_ANONYMOUS|MAP_PRIVATE|MAP_HUGETLB,
3741                  -1, 0);
3742 
3743   if (p != MAP_FAILED) {
3744     // We don&#39;t know if this really is a huge page or not.
3745     FILE *fp = fopen(&quot;/proc/self/maps&quot;, &quot;r&quot;);
3746     if (fp) {
3747       while (!feof(fp)) {
3748         char chars[257];
3749         long x = 0;
3750         if (fgets(chars, sizeof(chars), fp)) {
3751           if (sscanf(chars, &quot;%lx-%*x&quot;, &amp;x) == 1
3752               &amp;&amp; x == (long)p) {
3753             if (strstr (chars, &quot;hugepage&quot;)) {
3754               result = true;
3755               break;
3756             }
3757           }
3758         }
3759       }
3760       fclose(fp);
3761     }
3762     munmap(p, page_size);
3763   }
3764 
3765   if (warn &amp;&amp; !result) {
3766     warning(&quot;HugeTLBFS is not supported by the operating system.&quot;);
3767   }
3768 
3769   return result;
3770 }
3771 
3772 // From the coredump_filter documentation:
3773 //
3774 // - (bit 0) anonymous private memory
3775 // - (bit 1) anonymous shared memory
3776 // - (bit 2) file-backed private memory
3777 // - (bit 3) file-backed shared memory
3778 // - (bit 4) ELF header pages in file-backed private memory areas (it is
3779 //           effective only if the bit 2 is cleared)
3780 // - (bit 5) hugetlb private memory
3781 // - (bit 6) hugetlb shared memory
3782 // - (bit 7) dax private memory
3783 // - (bit 8) dax shared memory
3784 //
3785 static void set_coredump_filter(CoredumpFilterBit bit) {
3786   FILE *f;
3787   long cdm;
3788 
3789   if ((f = fopen(&quot;/proc/self/coredump_filter&quot;, &quot;r+&quot;)) == NULL) {
3790     return;
3791   }
3792 
3793   if (fscanf(f, &quot;%lx&quot;, &amp;cdm) != 1) {
3794     fclose(f);
3795     return;
3796   }
3797 
3798   long saved_cdm = cdm;
3799   rewind(f);
3800   cdm |= bit;
3801 
3802   if (cdm != saved_cdm) {
3803     fprintf(f, &quot;%#lx&quot;, cdm);
3804   }
3805 
3806   fclose(f);
3807 }
3808 
3809 // Large page support
3810 
3811 static size_t _large_page_size = 0;
3812 
3813 size_t os::Linux::find_default_large_page_size() {
3814   if (_default_large_page_size != 0) {
3815     return _default_large_page_size;
3816   }
3817   size_t large_page_size = 0;
3818 
3819   // large_page_size on Linux is used to round up heap size. x86 uses either
3820   // 2M or 4M page, depending on whether PAE (Physical Address Extensions)
3821   // mode is enabled. AMD64/EM64T uses 2M page in 64bit mode. IA64 can use
3822   // page as large as 256M.
3823   //
3824   // Here we try to figure out page size by parsing /proc/meminfo and looking
3825   // for a line with the following format:
3826   //    Hugepagesize:     2048 kB
3827   //
3828   // If we can&#39;t determine the value (e.g. /proc is not mounted, or the text
3829   // format has been changed), we&#39;ll use the largest page size supported by
3830   // the processor.
3831 
3832 #ifndef ZERO
3833   large_page_size =
3834     AARCH64_ONLY(2 * M)
3835     AMD64_ONLY(2 * M)
3836     ARM32_ONLY(2 * M)
3837     IA32_ONLY(4 * M)
3838     IA64_ONLY(256 * M)
3839     PPC_ONLY(4 * M)
3840     S390_ONLY(1 * M);
3841 #endif // ZERO
3842 
3843   FILE *fp = fopen(&quot;/proc/meminfo&quot;, &quot;r&quot;);
3844   if (fp) {
3845     while (!feof(fp)) {
3846       int x = 0;
3847       char buf[16];
3848       if (fscanf(fp, &quot;Hugepagesize: %d&quot;, &amp;x) == 1) {
3849         if (x &amp;&amp; fgets(buf, sizeof(buf), fp) &amp;&amp; strcmp(buf, &quot; kB\n&quot;) == 0) {
3850           large_page_size = x * K;
3851           break;
3852         }
3853       } else {
3854         // skip to next line
3855         for (;;) {
3856           int ch = fgetc(fp);
3857           if (ch == EOF || ch == (int)&#39;\n&#39;) break;
3858         }
3859       }
3860     }
3861     fclose(fp);
3862   }
3863   return large_page_size;
3864 }
3865 
3866 size_t os::Linux::find_large_page_size(size_t large_page_size) {
3867   if (_default_large_page_size == 0) {
3868     _default_large_page_size = Linux::find_default_large_page_size();
3869   }
3870   // We need to scan /sys/kernel/mm/hugepages
3871   // to discover the available page sizes
3872   const char* sys_hugepages = &quot;/sys/kernel/mm/hugepages&quot;;
3873 
3874   DIR *dir = opendir(sys_hugepages);
3875   if (dir == NULL) {
3876     return _default_large_page_size;
3877   }
3878 
3879   struct dirent *entry;
3880   size_t page_size;
3881   while ((entry = readdir(dir)) != NULL) {
3882     if (entry-&gt;d_type == DT_DIR &amp;&amp;
3883         sscanf(entry-&gt;d_name, &quot;hugepages-%zukB&quot;, &amp;page_size) == 1) {
3884       // The kernel is using kB, hotspot uses bytes
3885       if (large_page_size == page_size * K) {
3886         closedir(dir);
3887         return large_page_size;
3888       }
3889     }
3890   }
3891   closedir(dir);
3892   return _default_large_page_size;
3893 }
3894 
3895 size_t os::Linux::setup_large_page_size() {
3896   _default_large_page_size = Linux::find_default_large_page_size();
3897 
3898   if (!FLAG_IS_DEFAULT(LargePageSizeInBytes) &amp;&amp; LargePageSizeInBytes != _default_large_page_size ) {
3899     _large_page_size = find_large_page_size(LargePageSizeInBytes);
3900     if (_large_page_size == _default_large_page_size) {
3901       warning(&quot;Setting LargePageSizeInBytes=&quot; SIZE_FORMAT &quot; has no effect on this OS. Using the default large page size &quot;
3902               SIZE_FORMAT &quot;%s.&quot;,
3903               LargePageSizeInBytes,
3904               byte_size_in_proper_unit(_large_page_size), proper_unit_for_byte_size(_large_page_size));
3905     }
3906   } else {
3907     _large_page_size = _default_large_page_size;
3908   }
3909 
3910   const size_t default_page_size = (size_t)Linux::page_size();
3911   if (_large_page_size &gt; default_page_size) {
3912     _page_sizes[0] = _large_page_size;
3913     _page_sizes[1] = default_page_size;
3914     _page_sizes[2] = 0;
3915   }
3916 
3917   return _large_page_size;
3918 }
3919 
3920 size_t os::Linux::default_large_page_size() {
3921   return _default_large_page_size;
3922 }
3923 
3924 bool os::Linux::setup_large_page_type(size_t page_size) {
3925   if (FLAG_IS_DEFAULT(UseHugeTLBFS) &amp;&amp;
3926       FLAG_IS_DEFAULT(UseSHM) &amp;&amp;
3927       FLAG_IS_DEFAULT(UseTransparentHugePages)) {
3928 
3929     // The type of large pages has not been specified by the user.
3930 
3931     // Try UseHugeTLBFS and then UseSHM.
3932     UseHugeTLBFS = UseSHM = true;
3933 
3934     // Don&#39;t try UseTransparentHugePages since there are known
3935     // performance issues with it turned on. This might change in the future.
3936     UseTransparentHugePages = false;
3937   }
3938 
3939   if (UseTransparentHugePages) {
3940     bool warn_on_failure = !FLAG_IS_DEFAULT(UseTransparentHugePages);
3941     if (transparent_huge_pages_sanity_check(warn_on_failure, page_size)) {
3942       UseHugeTLBFS = false;
3943       UseSHM = false;
3944       return true;
3945     }
3946     UseTransparentHugePages = false;
3947   }
3948 
3949   if (UseHugeTLBFS) {
3950     bool warn_on_failure = !FLAG_IS_DEFAULT(UseHugeTLBFS);
3951     if (hugetlbfs_sanity_check(warn_on_failure, page_size)) {
3952       UseSHM = false;
3953       return true;
3954     }
3955     UseHugeTLBFS = false;
3956   }
3957 
3958   return UseSHM;
3959 }
3960 
3961 void os::large_page_init() {
3962   if (!UseLargePages &amp;&amp;
3963       !UseTransparentHugePages &amp;&amp;
3964       !UseHugeTLBFS &amp;&amp;
3965       !UseSHM) {
3966     // Not using large pages.
3967     return;
3968   }
3969 
3970   if (!FLAG_IS_DEFAULT(UseLargePages) &amp;&amp; !UseLargePages) {
3971     // The user explicitly turned off large pages.
3972     // Ignore the rest of the large pages flags.
3973     UseTransparentHugePages = false;
3974     UseHugeTLBFS = false;
3975     UseSHM = false;
3976     return;
3977   }
3978 
3979   size_t large_page_size = Linux::setup_large_page_size();
3980   UseLargePages          = Linux::setup_large_page_type(large_page_size);
3981 
3982   set_coredump_filter(LARGEPAGES_BIT);
3983 }
3984 
3985 #ifndef SHM_HUGETLB
3986   #define SHM_HUGETLB 04000
3987 #endif
3988 
3989 #define shm_warning_format(format, ...)              \
3990   do {                                               \
3991     if (UseLargePages &amp;&amp;                             \
3992         (!FLAG_IS_DEFAULT(UseLargePages) ||          \
3993          !FLAG_IS_DEFAULT(UseSHM) ||                 \
3994          !FLAG_IS_DEFAULT(LargePageSizeInBytes))) {  \
3995       warning(format, __VA_ARGS__);                  \
3996     }                                                \
3997   } while (0)
3998 
3999 #define shm_warning(str) shm_warning_format(&quot;%s&quot;, str)
4000 
4001 #define shm_warning_with_errno(str)                \
4002   do {                                             \
4003     int err = errno;                               \
4004     shm_warning_format(str &quot; (error = %d)&quot;, err);  \
4005   } while (0)
4006 
4007 static char* shmat_with_alignment(int shmid, size_t bytes, size_t alignment) {
4008   assert(is_aligned(bytes, alignment), &quot;Must be divisible by the alignment&quot;);
4009 
4010   if (!is_aligned(alignment, SHMLBA)) {
4011     assert(false, &quot;Code below assumes that alignment is at least SHMLBA aligned&quot;);
4012     return NULL;
4013   }
4014 
4015   // To ensure that we get &#39;alignment&#39; aligned memory from shmat,
4016   // we pre-reserve aligned virtual memory and then attach to that.
4017 
4018   char* pre_reserved_addr = anon_mmap_aligned(bytes, alignment, NULL);
4019   if (pre_reserved_addr == NULL) {
4020     // Couldn&#39;t pre-reserve aligned memory.
4021     shm_warning(&quot;Failed to pre-reserve aligned memory for shmat.&quot;);
4022     return NULL;
4023   }
4024 
4025   // SHM_REMAP is needed to allow shmat to map over an existing mapping.
4026   char* addr = (char*)shmat(shmid, pre_reserved_addr, SHM_REMAP);
4027 
4028   if ((intptr_t)addr == -1) {
4029     int err = errno;
4030     shm_warning_with_errno(&quot;Failed to attach shared memory.&quot;);
4031 
4032     assert(err != EACCES, &quot;Unexpected error&quot;);
4033     assert(err != EIDRM,  &quot;Unexpected error&quot;);
4034     assert(err != EINVAL, &quot;Unexpected error&quot;);
4035 
4036     // Since we don&#39;t know if the kernel unmapped the pre-reserved memory area
4037     // we can&#39;t unmap it, since that would potentially unmap memory that was
4038     // mapped from other threads.
4039     return NULL;
4040   }
4041 
4042   return addr;
4043 }
4044 
4045 static char* shmat_at_address(int shmid, char* req_addr) {
4046   if (!is_aligned(req_addr, SHMLBA)) {
4047     assert(false, &quot;Requested address needs to be SHMLBA aligned&quot;);
4048     return NULL;
4049   }
4050 
4051   char* addr = (char*)shmat(shmid, req_addr, 0);
4052 
4053   if ((intptr_t)addr == -1) {
4054     shm_warning_with_errno(&quot;Failed to attach shared memory.&quot;);
4055     return NULL;
4056   }
4057 
4058   return addr;
4059 }
4060 
4061 static char* shmat_large_pages(int shmid, size_t bytes, size_t alignment, char* req_addr) {
4062   // If a req_addr has been provided, we assume that the caller has already aligned the address.
4063   if (req_addr != NULL) {
4064     assert(is_aligned(req_addr, os::large_page_size()), &quot;Must be divisible by the large page size&quot;);
4065     assert(is_aligned(req_addr, alignment), &quot;Must be divisible by given alignment&quot;);
4066     return shmat_at_address(shmid, req_addr);
4067   }
4068 
4069   // Since shmid has been setup with SHM_HUGETLB, shmat will automatically
4070   // return large page size aligned memory addresses when req_addr == NULL.
4071   // However, if the alignment is larger than the large page size, we have
4072   // to manually ensure that the memory returned is &#39;alignment&#39; aligned.
4073   if (alignment &gt; os::large_page_size()) {
4074     assert(is_aligned(alignment, os::large_page_size()), &quot;Must be divisible by the large page size&quot;);
4075     return shmat_with_alignment(shmid, bytes, alignment);
4076   } else {
4077     return shmat_at_address(shmid, NULL);
4078   }
4079 }
4080 
4081 char* os::Linux::reserve_memory_special_shm(size_t bytes, size_t alignment,
4082                                             char* req_addr, bool exec) {
4083   // &quot;exec&quot; is passed in but not used.  Creating the shared image for
4084   // the code cache doesn&#39;t have an SHM_X executable permission to check.
4085   assert(UseLargePages &amp;&amp; UseSHM, &quot;only for SHM large pages&quot;);
4086   assert(is_aligned(req_addr, os::large_page_size()), &quot;Unaligned address&quot;);
4087   assert(is_aligned(req_addr, alignment), &quot;Unaligned address&quot;);
4088 
4089   if (!is_aligned(bytes, os::large_page_size())) {
4090     return NULL; // Fallback to small pages.
4091   }
4092 
4093   // Create a large shared memory region to attach to based on size.
4094   // Currently, size is the total size of the heap.
4095   int shmid = shmget(IPC_PRIVATE, bytes, SHM_HUGETLB|IPC_CREAT|SHM_R|SHM_W);
4096   if (shmid == -1) {
4097     // Possible reasons for shmget failure:
4098     // 1. shmmax is too small for Java heap.
4099     //    &gt; check shmmax value: cat /proc/sys/kernel/shmmax
4100     //    &gt; increase shmmax value: echo &quot;0xffffffff&quot; &gt; /proc/sys/kernel/shmmax
4101     // 2. not enough large page memory.
4102     //    &gt; check available large pages: cat /proc/meminfo
4103     //    &gt; increase amount of large pages:
4104     //          echo new_value &gt; /proc/sys/vm/nr_hugepages
4105     //      Note 1: different Linux may use different name for this property,
4106     //            e.g. on Redhat AS-3 it is &quot;hugetlb_pool&quot;.
4107     //      Note 2: it&#39;s possible there&#39;s enough physical memory available but
4108     //            they are so fragmented after a long run that they can&#39;t
4109     //            coalesce into large pages. Try to reserve large pages when
4110     //            the system is still &quot;fresh&quot;.
4111     shm_warning_with_errno(&quot;Failed to reserve shared memory.&quot;);
4112     return NULL;
4113   }
4114 
4115   // Attach to the region.
4116   char* addr = shmat_large_pages(shmid, bytes, alignment, req_addr);
4117 
4118   // Remove shmid. If shmat() is successful, the actual shared memory segment
4119   // will be deleted when it&#39;s detached by shmdt() or when the process
4120   // terminates. If shmat() is not successful this will remove the shared
4121   // segment immediately.
4122   shmctl(shmid, IPC_RMID, NULL);
4123 
4124   return addr;
4125 }
4126 
4127 static void warn_on_large_pages_failure(char* req_addr, size_t bytes,
4128                                         int error) {
4129   assert(error == ENOMEM, &quot;Only expect to fail if no memory is available&quot;);
4130 
4131   bool warn_on_failure = UseLargePages &amp;&amp;
4132       (!FLAG_IS_DEFAULT(UseLargePages) ||
4133        !FLAG_IS_DEFAULT(UseHugeTLBFS) ||
4134        !FLAG_IS_DEFAULT(LargePageSizeInBytes));
4135 
4136   if (warn_on_failure) {
4137     char msg[128];
4138     jio_snprintf(msg, sizeof(msg), &quot;Failed to reserve large pages memory req_addr: &quot;
4139                  PTR_FORMAT &quot; bytes: &quot; SIZE_FORMAT &quot; (errno = %d).&quot;, req_addr, bytes, error);
4140     warning(&quot;%s&quot;, msg);
4141   }
4142 }
4143 
4144 char* os::Linux::reserve_memory_special_huge_tlbfs_only(size_t bytes,
4145                                                         char* req_addr,
4146                                                         bool exec) {
4147   assert(UseLargePages &amp;&amp; UseHugeTLBFS, &quot;only for Huge TLBFS large pages&quot;);
4148   assert(is_aligned(bytes, os::large_page_size()), &quot;Unaligned size&quot;);
4149   assert(is_aligned(req_addr, os::large_page_size()), &quot;Unaligned address&quot;);
4150 
4151   int prot = exec ? PROT_READ|PROT_WRITE|PROT_EXEC : PROT_READ|PROT_WRITE;
4152   int flags = MAP_PRIVATE|MAP_ANONYMOUS|MAP_HUGETLB;
4153 
4154   if (os::large_page_size() != default_large_page_size()) {
4155     flags |= (exact_log2(os::large_page_size()) &lt;&lt; MAP_HUGE_SHIFT);
4156   }
4157   char* addr = (char*)::mmap(req_addr, bytes, prot, flags, -1, 0);
4158 
4159   if (addr == MAP_FAILED) {
4160     warn_on_large_pages_failure(req_addr, bytes, errno);
4161     return NULL;
4162   }
4163 
4164   assert(is_aligned(addr, os::large_page_size()), &quot;Must be&quot;);
4165 
4166   return addr;
4167 }
4168 
4169 // Reserve memory using mmap(MAP_HUGETLB).
4170 //  - bytes shall be a multiple of alignment.
4171 //  - req_addr can be NULL. If not NULL, it must be a multiple of alignment.
4172 //  - alignment sets the alignment at which memory shall be allocated.
4173 //     It must be a multiple of allocation granularity.
4174 // Returns address of memory or NULL. If req_addr was not NULL, will only return
4175 //  req_addr or NULL.
4176 char* os::Linux::reserve_memory_special_huge_tlbfs_mixed(size_t bytes,
4177                                                          size_t alignment,
4178                                                          char* req_addr,
4179                                                          bool exec) {
4180   size_t large_page_size = os::large_page_size();
4181   assert(bytes &gt;= large_page_size, &quot;Shouldn&#39;t allocate large pages for small sizes&quot;);
4182 
4183   assert(is_aligned(req_addr, alignment), &quot;Must be&quot;);
4184   assert(is_aligned(bytes, alignment), &quot;Must be&quot;);
4185 
4186   // First reserve - but not commit - the address range in small pages.
4187   char* const start = anon_mmap_aligned(bytes, alignment, req_addr);
4188 
4189   if (start == NULL) {
4190     return NULL;
4191   }
4192 
4193   assert(is_aligned(start, alignment), &quot;Must be&quot;);
4194 
4195   char* end = start + bytes;
4196 
4197   // Find the regions of the allocated chunk that can be promoted to large pages.
4198   char* lp_start = align_up(start, large_page_size);
4199   char* lp_end   = align_down(end, large_page_size);
4200 
4201   size_t lp_bytes = lp_end - lp_start;
4202 
4203   assert(is_aligned(lp_bytes, large_page_size), &quot;Must be&quot;);
4204 
4205   if (lp_bytes == 0) {
4206     // The mapped region doesn&#39;t even span the start and the end of a large page.
4207     // Fall back to allocate a non-special area.
4208     ::munmap(start, end - start);
4209     return NULL;
4210   }
4211 
4212   int prot = exec ? PROT_READ|PROT_WRITE|PROT_EXEC : PROT_READ|PROT_WRITE;
4213   int flags = MAP_PRIVATE|MAP_ANONYMOUS|MAP_FIXED;
4214   void* result;
4215 
4216   // Commit small-paged leading area.
4217   if (start != lp_start) {
4218     result = ::mmap(start, lp_start - start, prot, flags, -1, 0);
4219     if (result == MAP_FAILED) {
4220       ::munmap(lp_start, end - lp_start);
4221       return NULL;
4222     }
4223   }
4224 
4225   // Commit large-paged area.
4226   flags |= MAP_HUGETLB;
4227 
4228   if (os::large_page_size() != default_large_page_size()) {
4229     flags |= (exact_log2(os::large_page_size()) &lt;&lt; MAP_HUGE_SHIFT);
4230   }
4231 
4232   result = ::mmap(lp_start, lp_bytes, prot, flags, -1, 0);
4233   if (result == MAP_FAILED) {
4234     warn_on_large_pages_failure(lp_start, lp_bytes, errno);
4235     // If the mmap above fails, the large pages region will be unmapped and we
4236     // have regions before and after with small pages. Release these regions.
4237     //
4238     // |  mapped  |  unmapped  |  mapped  |
4239     // ^          ^            ^          ^
4240     // start      lp_start     lp_end     end
4241     //
4242     ::munmap(start, lp_start - start);
4243     ::munmap(lp_end, end - lp_end);
4244     return NULL;
4245   }
4246 
4247   // Commit small-paged trailing area.
4248   if (lp_end != end) {
4249     result = ::mmap(lp_end, end - lp_end, prot,
4250                     MAP_PRIVATE|MAP_ANONYMOUS|MAP_FIXED,
4251                     -1, 0);
4252     if (result == MAP_FAILED) {
4253       ::munmap(start, lp_end - start);
4254       return NULL;
4255     }
4256   }
4257 
4258   return start;
4259 }
4260 
4261 char* os::Linux::reserve_memory_special_huge_tlbfs(size_t bytes,
4262                                                    size_t alignment,
4263                                                    char* req_addr,
4264                                                    bool exec) {
4265   assert(UseLargePages &amp;&amp; UseHugeTLBFS, &quot;only for Huge TLBFS large pages&quot;);
4266   assert(is_aligned(req_addr, alignment), &quot;Must be&quot;);
4267   assert(is_aligned(alignment, os::vm_allocation_granularity()), &quot;Must be&quot;);
4268   assert(is_power_of_2(os::large_page_size()), &quot;Must be&quot;);
4269   assert(bytes &gt;= os::large_page_size(), &quot;Shouldn&#39;t allocate large pages for small sizes&quot;);
4270 
4271   if (is_aligned(bytes, os::large_page_size()) &amp;&amp; alignment &lt;= os::large_page_size()) {
4272     return reserve_memory_special_huge_tlbfs_only(bytes, req_addr, exec);
4273   } else {
4274     return reserve_memory_special_huge_tlbfs_mixed(bytes, alignment, req_addr, exec);
4275   }
4276 }
4277 
4278 char* os::pd_reserve_memory_special(size_t bytes, size_t alignment,
4279                                     char* req_addr, bool exec) {
4280   assert(UseLargePages, &quot;only for large pages&quot;);
4281 
4282   char* addr;
4283   if (UseSHM) {
4284     addr = os::Linux::reserve_memory_special_shm(bytes, alignment, req_addr, exec);
4285   } else {
4286     assert(UseHugeTLBFS, &quot;must be&quot;);
4287     addr = os::Linux::reserve_memory_special_huge_tlbfs(bytes, alignment, req_addr, exec);
4288   }
4289 
4290   if (addr != NULL) {
4291     if (UseNUMAInterleaving) {
4292       numa_make_global(addr, bytes);
4293     }
4294   }
4295 
4296   return addr;
4297 }
4298 
4299 bool os::Linux::release_memory_special_shm(char* base, size_t bytes) {
4300   // detaching the SHM segment will also delete it, see reserve_memory_special_shm()
4301   return shmdt(base) == 0;
4302 }
4303 
4304 bool os::Linux::release_memory_special_huge_tlbfs(char* base, size_t bytes) {
4305   return pd_release_memory(base, bytes);
4306 }
4307 
4308 bool os::pd_release_memory_special(char* base, size_t bytes) {
4309   assert(UseLargePages, &quot;only for large pages&quot;);
4310   bool res;
4311 
4312   if (UseSHM) {
4313     res = os::Linux::release_memory_special_shm(base, bytes);
4314   } else {
4315     assert(UseHugeTLBFS, &quot;must be&quot;);
4316     res = os::Linux::release_memory_special_huge_tlbfs(base, bytes);
4317   }
4318   return res;
4319 }
4320 
4321 size_t os::large_page_size() {
4322   return _large_page_size;
4323 }
4324 
4325 // With SysV SHM the entire memory region must be allocated as shared
4326 // memory.
4327 // HugeTLBFS allows application to commit large page memory on demand.
4328 // However, when committing memory with HugeTLBFS fails, the region
4329 // that was supposed to be committed will lose the old reservation
4330 // and allow other threads to steal that memory region. Because of this
4331 // behavior we can&#39;t commit HugeTLBFS memory.
4332 bool os::can_commit_large_page_memory() {
4333   return UseTransparentHugePages;
4334 }
4335 
4336 bool os::can_execute_large_page_memory() {
4337   return UseTransparentHugePages || UseHugeTLBFS;
4338 }
4339 
4340 char* os::pd_attempt_reserve_memory_at(size_t bytes, char* requested_addr, int file_desc) {
4341   assert(file_desc &gt;= 0, &quot;file_desc is not valid&quot;);
4342   char* result = pd_attempt_reserve_memory_at(bytes, requested_addr);
4343   if (result != NULL) {
4344     if (replace_existing_mapping_with_file_mapping(result, bytes, file_desc) == NULL) {
4345       vm_exit_during_initialization(err_msg(&quot;Error in mapping Java heap at the given filesystem directory&quot;));
4346     }
4347   }
4348   return result;
4349 }
4350 
4351 // Reserve memory at an arbitrary address, only if that area is
4352 // available (and not reserved for something else).
4353 
4354 char* os::pd_attempt_reserve_memory_at(size_t bytes, char* requested_addr) {
4355   // Assert only that the size is a multiple of the page size, since
4356   // that&#39;s all that mmap requires, and since that&#39;s all we really know
4357   // about at this low abstraction level.  If we need higher alignment,
4358   // we can either pass an alignment to this method or verify alignment
4359   // in one of the methods further up the call chain.  See bug 5044738.
4360   assert(bytes % os::vm_page_size() == 0, &quot;reserving unexpected size block&quot;);
4361 
4362   // Repeatedly allocate blocks until the block is allocated at the
4363   // right spot.
4364 
4365   // Linux mmap allows caller to pass an address as hint; give it a try first,
4366   // if kernel honors the hint then we can return immediately.
4367   char * addr = anon_mmap(requested_addr, bytes, false);
4368   if (addr == requested_addr) {
4369     return requested_addr;
4370   }
4371 
4372   if (addr != NULL) {
4373     // mmap() is successful but it fails to reserve at the requested address
4374     anon_munmap(addr, bytes);
4375   }
4376 
4377   return NULL;
4378 }
4379 
4380 // Sleep forever; naked call to OS-specific sleep; use with CAUTION
4381 void os::infinite_sleep() {
4382   while (true) {    // sleep forever ...
4383     ::sleep(100);   // ... 100 seconds at a time
4384   }
4385 }
4386 
4387 // Used to convert frequent JVM_Yield() to nops
4388 bool os::dont_yield() {
4389   return DontYieldALot;
4390 }
4391 
4392 // Linux CFS scheduler (since 2.6.23) does not guarantee sched_yield(2) will
4393 // actually give up the CPU. Since skip buddy (v2.6.28):
4394 //
4395 // * Sets the yielding task as skip buddy for current CPU&#39;s run queue.
4396 // * Picks next from run queue, if empty, picks a skip buddy (can be the yielding task).
4397 // * Clears skip buddies for this run queue (yielding task no longer a skip buddy).
4398 //
4399 // An alternative is calling os::naked_short_nanosleep with a small number to avoid
4400 // getting re-scheduled immediately.
4401 //
4402 void os::naked_yield() {
4403   sched_yield();
4404 }
4405 
4406 ////////////////////////////////////////////////////////////////////////////////
4407 // thread priority support
4408 
4409 // Note: Normal Linux applications are run with SCHED_OTHER policy. SCHED_OTHER
4410 // only supports dynamic priority, static priority must be zero. For real-time
4411 // applications, Linux supports SCHED_RR which allows static priority (1-99).
4412 // However, for large multi-threaded applications, SCHED_RR is not only slower
4413 // than SCHED_OTHER, but also very unstable (my volano tests hang hard 4 out
4414 // of 5 runs - Sep 2005).
4415 //
4416 // The following code actually changes the niceness of kernel-thread/LWP. It
4417 // has an assumption that setpriority() only modifies one kernel-thread/LWP,
4418 // not the entire user process, and user level threads are 1:1 mapped to kernel
4419 // threads. It has always been the case, but could change in the future. For
4420 // this reason, the code should not be used as default (ThreadPriorityPolicy=0).
4421 // It is only used when ThreadPriorityPolicy=1 and may require system level permission
4422 // (e.g., root privilege or CAP_SYS_NICE capability).
4423 
4424 int os::java_to_os_priority[CriticalPriority + 1] = {
4425   19,              // 0 Entry should never be used
4426 
4427    4,              // 1 MinPriority
4428    3,              // 2
4429    2,              // 3
4430 
4431    1,              // 4
4432    0,              // 5 NormPriority
4433   -1,              // 6
4434 
4435   -2,              // 7
4436   -3,              // 8
4437   -4,              // 9 NearMaxPriority
4438 
4439   -5,              // 10 MaxPriority
4440 
4441   -5               // 11 CriticalPriority
4442 };
4443 
4444 static int prio_init() {
4445   if (ThreadPriorityPolicy == 1) {
4446     if (geteuid() != 0) {
4447       if (!FLAG_IS_DEFAULT(ThreadPriorityPolicy) &amp;&amp; !FLAG_IS_JIMAGE_RESOURCE(ThreadPriorityPolicy)) {
4448         warning(&quot;-XX:ThreadPriorityPolicy=1 may require system level permission, &quot; \
4449                 &quot;e.g., being the root user. If the necessary permission is not &quot; \
4450                 &quot;possessed, changes to priority will be silently ignored.&quot;);
4451       }
4452     }
4453   }
4454   if (UseCriticalJavaThreadPriority) {
4455     os::java_to_os_priority[MaxPriority] = os::java_to_os_priority[CriticalPriority];
4456   }
4457   return 0;
4458 }
4459 
4460 OSReturn os::set_native_priority(Thread* thread, int newpri) {
4461   if (!UseThreadPriorities || ThreadPriorityPolicy == 0) return OS_OK;
4462 
4463   int ret = setpriority(PRIO_PROCESS, thread-&gt;osthread()-&gt;thread_id(), newpri);
4464   return (ret == 0) ? OS_OK : OS_ERR;
4465 }
4466 
4467 OSReturn os::get_native_priority(const Thread* const thread,
4468                                  int *priority_ptr) {
4469   if (!UseThreadPriorities || ThreadPriorityPolicy == 0) {
4470     *priority_ptr = java_to_os_priority[NormPriority];
4471     return OS_OK;
4472   }
4473 
4474   errno = 0;
4475   *priority_ptr = getpriority(PRIO_PROCESS, thread-&gt;osthread()-&gt;thread_id());
4476   return (*priority_ptr != -1 || errno == 0 ? OS_OK : OS_ERR);
4477 }
4478 
4479 ////////////////////////////////////////////////////////////////////////////////
4480 // suspend/resume support
4481 
4482 //  The low-level signal-based suspend/resume support is a remnant from the
4483 //  old VM-suspension that used to be for java-suspension, safepoints etc,
4484 //  within hotspot. Currently used by JFR&#39;s OSThreadSampler
4485 //
4486 //  The remaining code is greatly simplified from the more general suspension
4487 //  code that used to be used.
4488 //
4489 //  The protocol is quite simple:
4490 //  - suspend:
4491 //      - sends a signal to the target thread
4492 //      - polls the suspend state of the osthread using a yield loop
4493 //      - target thread signal handler (SR_handler) sets suspend state
4494 //        and blocks in sigsuspend until continued
4495 //  - resume:
4496 //      - sets target osthread state to continue
4497 //      - sends signal to end the sigsuspend loop in the SR_handler
4498 //
4499 //  Note that the SR_lock plays no role in this suspend/resume protocol,
4500 //  but is checked for NULL in SR_handler as a thread termination indicator.
4501 //  The SR_lock is, however, used by JavaThread::java_suspend()/java_resume() APIs.
4502 //
4503 //  Note that resume_clear_context() and suspend_save_context() are needed
4504 //  by SR_handler(), so that fetch_frame_from_ucontext() works,
4505 //  which in part is used by:
4506 //    - Forte Analyzer: AsyncGetCallTrace()
4507 //    - StackBanging: get_frame_at_stack_banging_point()
4508 
4509 static void resume_clear_context(OSThread *osthread) {
4510   osthread-&gt;set_ucontext(NULL);
4511   osthread-&gt;set_siginfo(NULL);
4512 }
4513 
4514 static void suspend_save_context(OSThread *osthread, siginfo_t* siginfo,
4515                                  ucontext_t* context) {
4516   osthread-&gt;set_ucontext(context);
4517   osthread-&gt;set_siginfo(siginfo);
4518 }
4519 
4520 // Handler function invoked when a thread&#39;s execution is suspended or
4521 // resumed. We have to be careful that only async-safe functions are
4522 // called here (Note: most pthread functions are not async safe and
4523 // should be avoided.)
4524 //
4525 // Note: sigwait() is a more natural fit than sigsuspend() from an
4526 // interface point of view, but sigwait() prevents the signal hander
4527 // from being run. libpthread would get very confused by not having
4528 // its signal handlers run and prevents sigwait()&#39;s use with the
4529 // mutex granting granting signal.
4530 //
4531 // Currently only ever called on the VMThread and JavaThreads (PC sampling)
4532 //
4533 static void SR_handler(int sig, siginfo_t* siginfo, ucontext_t* context) {
4534   // Save and restore errno to avoid confusing native code with EINTR
4535   // after sigsuspend.
4536   int old_errno = errno;
4537 
4538   Thread* thread = Thread::current_or_null_safe();
4539   assert(thread != NULL, &quot;Missing current thread in SR_handler&quot;);
4540 
4541   // On some systems we have seen signal delivery get &quot;stuck&quot; until the signal
4542   // mask is changed as part of thread termination. Check that the current thread
4543   // has not already terminated (via SR_lock()) - else the following assertion
4544   // will fail because the thread is no longer a JavaThread as the ~JavaThread
4545   // destructor has completed.
4546 
4547   if (thread-&gt;SR_lock() == NULL) {
4548     return;
4549   }
4550 
4551   assert(thread-&gt;is_VM_thread() || thread-&gt;is_Java_thread(), &quot;Must be VMThread or JavaThread&quot;);
4552 
4553   OSThread* osthread = thread-&gt;osthread();
4554 
4555   os::SuspendResume::State current = osthread-&gt;sr.state();
4556   if (current == os::SuspendResume::SR_SUSPEND_REQUEST) {
4557     suspend_save_context(osthread, siginfo, context);
4558 
4559     // attempt to switch the state, we assume we had a SUSPEND_REQUEST
4560     os::SuspendResume::State state = osthread-&gt;sr.suspended();
4561     if (state == os::SuspendResume::SR_SUSPENDED) {
4562       sigset_t suspend_set;  // signals for sigsuspend()
4563       sigemptyset(&amp;suspend_set);
4564       // get current set of blocked signals and unblock resume signal
4565       pthread_sigmask(SIG_BLOCK, NULL, &amp;suspend_set);
4566       sigdelset(&amp;suspend_set, SR_signum);
4567 
4568       sr_semaphore.signal();
4569       // wait here until we are resumed
4570       while (1) {
4571         sigsuspend(&amp;suspend_set);
4572 
4573         os::SuspendResume::State result = osthread-&gt;sr.running();
4574         if (result == os::SuspendResume::SR_RUNNING) {
4575           sr_semaphore.signal();
4576           break;
4577         }
4578       }
4579 
4580     } else if (state == os::SuspendResume::SR_RUNNING) {
4581       // request was cancelled, continue
4582     } else {
4583       ShouldNotReachHere();
4584     }
4585 
4586     resume_clear_context(osthread);
4587   } else if (current == os::SuspendResume::SR_RUNNING) {
4588     // request was cancelled, continue
4589   } else if (current == os::SuspendResume::SR_WAKEUP_REQUEST) {
4590     // ignore
4591   } else {
4592     // ignore
4593   }
4594 
4595   errno = old_errno;
4596 }
4597 
4598 static int SR_initialize() {
4599   struct sigaction act;
4600   char *s;
4601 
4602   // Get signal number to use for suspend/resume
4603   if ((s = ::getenv(&quot;_JAVA_SR_SIGNUM&quot;)) != 0) {
4604     int sig = ::strtol(s, 0, 10);
4605     if (sig &gt; MAX2(SIGSEGV, SIGBUS) &amp;&amp;  // See 4355769.
4606         sig &lt; NSIG) {                   // Must be legal signal and fit into sigflags[].
4607       SR_signum = sig;
4608     } else {
4609       warning(&quot;You set _JAVA_SR_SIGNUM=%d. It must be in range [%d, %d]. Using %d instead.&quot;,
4610               sig, MAX2(SIGSEGV, SIGBUS)+1, NSIG-1, SR_signum);
4611     }
4612   }
4613 
4614   assert(SR_signum &gt; SIGSEGV &amp;&amp; SR_signum &gt; SIGBUS,
4615          &quot;SR_signum must be greater than max(SIGSEGV, SIGBUS), see 4355769&quot;);
4616 
4617   sigemptyset(&amp;SR_sigset);
4618   sigaddset(&amp;SR_sigset, SR_signum);
4619 
4620   // Set up signal handler for suspend/resume
4621   act.sa_flags = SA_RESTART|SA_SIGINFO;
4622   act.sa_handler = (void (*)(int)) SR_handler;
4623 
4624   // SR_signum is blocked by default.
4625   // 4528190 - We also need to block pthread restart signal (32 on all
4626   // supported Linux platforms). Note that LinuxThreads need to block
4627   // this signal for all threads to work properly. So we don&#39;t have
4628   // to use hard-coded signal number when setting up the mask.
4629   pthread_sigmask(SIG_BLOCK, NULL, &amp;act.sa_mask);
4630 
4631   if (sigaction(SR_signum, &amp;act, 0) == -1) {
4632     return -1;
4633   }
4634 
4635   // Save signal flag
4636   os::Linux::set_our_sigflags(SR_signum, act.sa_flags);
4637   return 0;
4638 }
4639 
4640 static int sr_notify(OSThread* osthread) {
4641   int status = pthread_kill(osthread-&gt;pthread_id(), SR_signum);
4642   assert_status(status == 0, status, &quot;pthread_kill&quot;);
4643   return status;
4644 }
4645 
4646 // &quot;Randomly&quot; selected value for how long we want to spin
4647 // before bailing out on suspending a thread, also how often
4648 // we send a signal to a thread we want to resume
4649 static const int RANDOMLY_LARGE_INTEGER = 1000000;
4650 static const int RANDOMLY_LARGE_INTEGER2 = 100;
4651 
4652 // returns true on success and false on error - really an error is fatal
4653 // but this seems the normal response to library errors
4654 static bool do_suspend(OSThread* osthread) {
4655   assert(osthread-&gt;sr.is_running(), &quot;thread should be running&quot;);
4656   assert(!sr_semaphore.trywait(), &quot;semaphore has invalid state&quot;);
4657 
4658   // mark as suspended and send signal
4659   if (osthread-&gt;sr.request_suspend() != os::SuspendResume::SR_SUSPEND_REQUEST) {
4660     // failed to switch, state wasn&#39;t running?
4661     ShouldNotReachHere();
4662     return false;
4663   }
4664 
4665   if (sr_notify(osthread) != 0) {
4666     ShouldNotReachHere();
4667   }
4668 
4669   // managed to send the signal and switch to SUSPEND_REQUEST, now wait for SUSPENDED
4670   while (true) {
4671     if (sr_semaphore.timedwait(2)) {
4672       break;
4673     } else {
4674       // timeout
4675       os::SuspendResume::State cancelled = osthread-&gt;sr.cancel_suspend();
4676       if (cancelled == os::SuspendResume::SR_RUNNING) {
4677         return false;
4678       } else if (cancelled == os::SuspendResume::SR_SUSPENDED) {
4679         // make sure that we consume the signal on the semaphore as well
4680         sr_semaphore.wait();
4681         break;
4682       } else {
4683         ShouldNotReachHere();
4684         return false;
4685       }
4686     }
4687   }
4688 
4689   guarantee(osthread-&gt;sr.is_suspended(), &quot;Must be suspended&quot;);
4690   return true;
4691 }
4692 
4693 static void do_resume(OSThread* osthread) {
4694   assert(osthread-&gt;sr.is_suspended(), &quot;thread should be suspended&quot;);
4695   assert(!sr_semaphore.trywait(), &quot;invalid semaphore state&quot;);
4696 
4697   if (osthread-&gt;sr.request_wakeup() != os::SuspendResume::SR_WAKEUP_REQUEST) {
4698     // failed to switch to WAKEUP_REQUEST
4699     ShouldNotReachHere();
4700     return;
4701   }
4702 
4703   while (true) {
4704     if (sr_notify(osthread) == 0) {
4705       if (sr_semaphore.timedwait(2)) {
4706         if (osthread-&gt;sr.is_running()) {
4707           return;
4708         }
4709       }
4710     } else {
4711       ShouldNotReachHere();
4712     }
4713   }
4714 
4715   guarantee(osthread-&gt;sr.is_running(), &quot;Must be running!&quot;);
4716 }
4717 
4718 ///////////////////////////////////////////////////////////////////////////////////
4719 // signal handling (except suspend/resume)
4720 
4721 // This routine may be used by user applications as a &quot;hook&quot; to catch signals.
4722 // The user-defined signal handler must pass unrecognized signals to this
4723 // routine, and if it returns true (non-zero), then the signal handler must
4724 // return immediately.  If the flag &quot;abort_if_unrecognized&quot; is true, then this
4725 // routine will never retun false (zero), but instead will execute a VM panic
4726 // routine kill the process.
4727 //
4728 // If this routine returns false, it is OK to call it again.  This allows
4729 // the user-defined signal handler to perform checks either before or after
4730 // the VM performs its own checks.  Naturally, the user code would be making
4731 // a serious error if it tried to handle an exception (such as a null check
4732 // or breakpoint) that the VM was generating for its own correct operation.
4733 //
4734 // This routine may recognize any of the following kinds of signals:
4735 //    SIGBUS, SIGSEGV, SIGILL, SIGFPE, SIGQUIT, SIGPIPE, SIGXFSZ, SIGUSR1.
4736 // It should be consulted by handlers for any of those signals.
4737 //
4738 // The caller of this routine must pass in the three arguments supplied
4739 // to the function referred to in the &quot;sa_sigaction&quot; (not the &quot;sa_handler&quot;)
4740 // field of the structure passed to sigaction().  This routine assumes that
4741 // the sa_flags field passed to sigaction() includes SA_SIGINFO and SA_RESTART.
4742 //
4743 // Note that the VM will print warnings if it detects conflicting signal
4744 // handlers, unless invoked with the option &quot;-XX:+AllowUserSignalHandlers&quot;.
4745 //
4746 extern &quot;C&quot; JNIEXPORT int JVM_handle_linux_signal(int signo,
4747                                                  siginfo_t* siginfo,
4748                                                  void* ucontext,
4749                                                  int abort_if_unrecognized);
4750 
4751 static void signalHandler(int sig, siginfo_t* info, void* uc) {
4752   assert(info != NULL &amp;&amp; uc != NULL, &quot;it must be old kernel&quot;);
4753   int orig_errno = errno;  // Preserve errno value over signal handler.
4754   JVM_handle_linux_signal(sig, info, uc, true);
4755   errno = orig_errno;
4756 }
4757 
4758 
4759 // This boolean allows users to forward their own non-matching signals
4760 // to JVM_handle_linux_signal, harmlessly.
4761 bool os::Linux::signal_handlers_are_installed = false;
4762 
4763 // For signal-chaining
4764 bool os::Linux::libjsig_is_loaded = false;
4765 typedef struct sigaction *(*get_signal_t)(int);
4766 get_signal_t os::Linux::get_signal_action = NULL;
4767 
4768 struct sigaction* os::Linux::get_chained_signal_action(int sig) {
4769   struct sigaction *actp = NULL;
4770 
4771   if (libjsig_is_loaded) {
4772     // Retrieve the old signal handler from libjsig
4773     actp = (*get_signal_action)(sig);
4774   }
4775   if (actp == NULL) {
4776     // Retrieve the preinstalled signal handler from jvm
4777     actp = os::Posix::get_preinstalled_handler(sig);
4778   }
4779 
4780   return actp;
4781 }
4782 
4783 static bool call_chained_handler(struct sigaction *actp, int sig,
4784                                  siginfo_t *siginfo, void *context) {
4785   // Call the old signal handler
4786   if (actp-&gt;sa_handler == SIG_DFL) {
4787     // It&#39;s more reasonable to let jvm treat it as an unexpected exception
4788     // instead of taking the default action.
4789     return false;
4790   } else if (actp-&gt;sa_handler != SIG_IGN) {
4791     if ((actp-&gt;sa_flags &amp; SA_NODEFER) == 0) {
4792       // automaticlly block the signal
4793       sigaddset(&amp;(actp-&gt;sa_mask), sig);
4794     }
4795 
4796     sa_handler_t hand = NULL;
4797     sa_sigaction_t sa = NULL;
4798     bool siginfo_flag_set = (actp-&gt;sa_flags &amp; SA_SIGINFO) != 0;
4799     // retrieve the chained handler
4800     if (siginfo_flag_set) {
4801       sa = actp-&gt;sa_sigaction;
4802     } else {
4803       hand = actp-&gt;sa_handler;
4804     }
4805 
4806     if ((actp-&gt;sa_flags &amp; SA_RESETHAND) != 0) {
4807       actp-&gt;sa_handler = SIG_DFL;
4808     }
4809 
4810     // try to honor the signal mask
4811     sigset_t oset;
4812     sigemptyset(&amp;oset);
4813     pthread_sigmask(SIG_SETMASK, &amp;(actp-&gt;sa_mask), &amp;oset);
4814 
4815     // call into the chained handler
4816     if (siginfo_flag_set) {
4817       (*sa)(sig, siginfo, context);
4818     } else {
4819       (*hand)(sig);
4820     }
4821 
4822     // restore the signal mask
4823     pthread_sigmask(SIG_SETMASK, &amp;oset, NULL);
4824   }
4825   // Tell jvm&#39;s signal handler the signal is taken care of.
4826   return true;
4827 }
4828 
4829 bool os::Linux::chained_handler(int sig, siginfo_t* siginfo, void* context) {
4830   bool chained = false;
4831   // signal-chaining
4832   if (UseSignalChaining) {
4833     struct sigaction *actp = get_chained_signal_action(sig);
4834     if (actp != NULL) {
4835       chained = call_chained_handler(actp, sig, siginfo, context);
4836     }
4837   }
4838   return chained;
4839 }
4840 
4841 // for diagnostic
4842 int sigflags[NSIG];
4843 
4844 int os::Linux::get_our_sigflags(int sig) {
4845   assert(sig &gt; 0 &amp;&amp; sig &lt; NSIG, &quot;vm signal out of expected range&quot;);
4846   return sigflags[sig];
4847 }
4848 
4849 void os::Linux::set_our_sigflags(int sig, int flags) {
4850   assert(sig &gt; 0 &amp;&amp; sig &lt; NSIG, &quot;vm signal out of expected range&quot;);
4851   if (sig &gt; 0 &amp;&amp; sig &lt; NSIG) {
4852     sigflags[sig] = flags;
4853   }
4854 }
4855 
4856 void os::Linux::set_signal_handler(int sig, bool set_installed) {
4857   // Check for overwrite.
4858   struct sigaction oldAct;
4859   sigaction(sig, (struct sigaction*)NULL, &amp;oldAct);
4860 
4861   void* oldhand = oldAct.sa_sigaction
4862                 ? CAST_FROM_FN_PTR(void*,  oldAct.sa_sigaction)
4863                 : CAST_FROM_FN_PTR(void*,  oldAct.sa_handler);
4864   if (oldhand != CAST_FROM_FN_PTR(void*, SIG_DFL) &amp;&amp;
4865       oldhand != CAST_FROM_FN_PTR(void*, SIG_IGN) &amp;&amp;
4866       oldhand != CAST_FROM_FN_PTR(void*, (sa_sigaction_t)signalHandler)) {
4867     if (AllowUserSignalHandlers || !set_installed) {
4868       // Do not overwrite; user takes responsibility to forward to us.
4869       return;
4870     } else if (UseSignalChaining) {
4871       // save the old handler in jvm
4872       os::Posix::save_preinstalled_handler(sig, oldAct);
4873       // libjsig also interposes the sigaction() call below and saves the
4874       // old sigaction on it own.
4875     } else {
4876       fatal(&quot;Encountered unexpected pre-existing sigaction handler &quot;
4877             &quot;%#lx for signal %d.&quot;, (long)oldhand, sig);
4878     }
4879   }
4880 
4881   struct sigaction sigAct;
4882   sigfillset(&amp;(sigAct.sa_mask));
4883   sigAct.sa_handler = SIG_DFL;
4884   if (!set_installed) {
4885     sigAct.sa_flags = SA_SIGINFO|SA_RESTART;
4886   } else {
4887     sigAct.sa_sigaction = signalHandler;
4888     sigAct.sa_flags = SA_SIGINFO|SA_RESTART;
4889   }
4890   // Save flags, which are set by ours
4891   assert(sig &gt; 0 &amp;&amp; sig &lt; NSIG, &quot;vm signal out of expected range&quot;);
4892   sigflags[sig] = sigAct.sa_flags;
4893 
4894   int ret = sigaction(sig, &amp;sigAct, &amp;oldAct);
4895   assert(ret == 0, &quot;check&quot;);
4896 
4897   void* oldhand2  = oldAct.sa_sigaction
4898                   ? CAST_FROM_FN_PTR(void*, oldAct.sa_sigaction)
4899                   : CAST_FROM_FN_PTR(void*, oldAct.sa_handler);
4900   assert(oldhand2 == oldhand, &quot;no concurrent signal handler installation&quot;);
4901 }
4902 
4903 // install signal handlers for signals that HotSpot needs to
4904 // handle in order to support Java-level exception handling.
4905 
4906 void os::Linux::install_signal_handlers() {
4907   if (!signal_handlers_are_installed) {
4908     signal_handlers_are_installed = true;
4909 
4910     // signal-chaining
4911     typedef void (*signal_setting_t)();
4912     signal_setting_t begin_signal_setting = NULL;
4913     signal_setting_t end_signal_setting = NULL;
4914     begin_signal_setting = CAST_TO_FN_PTR(signal_setting_t,
4915                                           dlsym(RTLD_DEFAULT, &quot;JVM_begin_signal_setting&quot;));
4916     if (begin_signal_setting != NULL) {
4917       end_signal_setting = CAST_TO_FN_PTR(signal_setting_t,
4918                                           dlsym(RTLD_DEFAULT, &quot;JVM_end_signal_setting&quot;));
4919       get_signal_action = CAST_TO_FN_PTR(get_signal_t,
4920                                          dlsym(RTLD_DEFAULT, &quot;JVM_get_signal_action&quot;));
4921       libjsig_is_loaded = true;
4922       assert(UseSignalChaining, &quot;should enable signal-chaining&quot;);
4923     }
4924     if (libjsig_is_loaded) {
4925       // Tell libjsig jvm is setting signal handlers
4926       (*begin_signal_setting)();
4927     }
4928 
4929     set_signal_handler(SIGSEGV, true);
4930     set_signal_handler(SIGPIPE, true);
4931     set_signal_handler(SIGBUS, true);
4932     set_signal_handler(SIGILL, true);
4933     set_signal_handler(SIGFPE, true);
4934 #if defined(PPC64)
4935     set_signal_handler(SIGTRAP, true);
4936 #endif
4937     set_signal_handler(SIGXFSZ, true);
4938 
4939     if (libjsig_is_loaded) {
4940       // Tell libjsig jvm finishes setting signal handlers
4941       (*end_signal_setting)();
4942     }
4943 
4944     // We don&#39;t activate signal checker if libjsig is in place, we trust ourselves
4945     // and if UserSignalHandler is installed all bets are off.
4946     // Log that signal checking is off only if -verbose:jni is specified.
4947     if (CheckJNICalls) {
4948       if (libjsig_is_loaded) {
4949         log_debug(jni, resolve)(&quot;Info: libjsig is activated, all active signal checking is disabled&quot;);
4950         check_signals = false;
4951       }
4952       if (AllowUserSignalHandlers) {
4953         log_debug(jni, resolve)(&quot;Info: AllowUserSignalHandlers is activated, all active signal checking is disabled&quot;);
4954         check_signals = false;
4955       }
4956     }
4957   }
4958 }
4959 
4960 // This is the fastest way to get thread cpu time on Linux.
4961 // Returns cpu time (user+sys) for any thread, not only for current.
4962 // POSIX compliant clocks are implemented in the kernels 2.6.16+.
4963 // It might work on 2.6.10+ with a special kernel/glibc patch.
4964 // For reference, please, see IEEE Std 1003.1-2004:
4965 //   http://www.unix.org/single_unix_specification
4966 
4967 jlong os::Linux::fast_thread_cpu_time(clockid_t clockid) {
4968   struct timespec tp;
4969   int rc = os::Posix::clock_gettime(clockid, &amp;tp);
4970   assert(rc == 0, &quot;clock_gettime is expected to return 0 code&quot;);
4971 
4972   return (tp.tv_sec * NANOSECS_PER_SEC) + tp.tv_nsec;
4973 }
4974 
4975 /////
4976 // glibc on Linux platform uses non-documented flag
4977 // to indicate, that some special sort of signal
4978 // trampoline is used.
4979 // We will never set this flag, and we should
4980 // ignore this flag in our diagnostic
4981 #ifdef SIGNIFICANT_SIGNAL_MASK
4982   #undef SIGNIFICANT_SIGNAL_MASK
4983 #endif
4984 #define SIGNIFICANT_SIGNAL_MASK (~0x04000000)
4985 
4986 static const char* get_signal_handler_name(address handler,
4987                                            char* buf, int buflen) {
4988   int offset = 0;
4989   bool found = os::dll_address_to_library_name(handler, buf, buflen, &amp;offset);
4990   if (found) {
4991     // skip directory names
4992     const char *p1, *p2;
4993     p1 = buf;
4994     size_t len = strlen(os::file_separator());
4995     while ((p2 = strstr(p1, os::file_separator())) != NULL) p1 = p2 + len;
4996     jio_snprintf(buf, buflen, &quot;%s+0x%x&quot;, p1, offset);
4997   } else {
4998     jio_snprintf(buf, buflen, PTR_FORMAT, handler);
4999   }
5000   return buf;
5001 }
5002 
5003 static void print_signal_handler(outputStream* st, int sig,
5004                                  char* buf, size_t buflen) {
5005   struct sigaction sa;
5006 
5007   sigaction(sig, NULL, &amp;sa);
5008 
5009   // See comment for SIGNIFICANT_SIGNAL_MASK define
5010   sa.sa_flags &amp;= SIGNIFICANT_SIGNAL_MASK;
5011 
5012   st-&gt;print(&quot;%s: &quot;, os::exception_name(sig, buf, buflen));
5013 
5014   address handler = (sa.sa_flags &amp; SA_SIGINFO)
5015     ? CAST_FROM_FN_PTR(address, sa.sa_sigaction)
5016     : CAST_FROM_FN_PTR(address, sa.sa_handler);
5017 
5018   if (handler == CAST_FROM_FN_PTR(address, SIG_DFL)) {
5019     st-&gt;print(&quot;SIG_DFL&quot;);
5020   } else if (handler == CAST_FROM_FN_PTR(address, SIG_IGN)) {
5021     st-&gt;print(&quot;SIG_IGN&quot;);
5022   } else {
5023     st-&gt;print(&quot;[%s]&quot;, get_signal_handler_name(handler, buf, buflen));
5024   }
5025 
5026   st-&gt;print(&quot;, sa_mask[0]=&quot;);
5027   os::Posix::print_signal_set_short(st, &amp;sa.sa_mask);
5028 
5029   address rh = VMError::get_resetted_sighandler(sig);
5030   // May be, handler was resetted by VMError?
5031   if (rh != NULL) {
5032     handler = rh;
5033     sa.sa_flags = VMError::get_resetted_sigflags(sig) &amp; SIGNIFICANT_SIGNAL_MASK;
5034   }
5035 
5036   st-&gt;print(&quot;, sa_flags=&quot;);
5037   os::Posix::print_sa_flags(st, sa.sa_flags);
5038 
5039   // Check: is it our handler?
5040   if (handler == CAST_FROM_FN_PTR(address, (sa_sigaction_t)signalHandler) ||
5041       handler == CAST_FROM_FN_PTR(address, (sa_sigaction_t)SR_handler)) {
5042     // It is our signal handler
5043     // check for flags, reset system-used one!
5044     if ((int)sa.sa_flags != os::Linux::get_our_sigflags(sig)) {
5045       st-&gt;print(
5046                 &quot;, flags was changed from &quot; PTR32_FORMAT &quot;, consider using jsig library&quot;,
5047                 os::Linux::get_our_sigflags(sig));
5048     }
5049   }
5050   st-&gt;cr();
5051 }
5052 
5053 
5054 #define DO_SIGNAL_CHECK(sig)                      \
5055   do {                                            \
5056     if (!sigismember(&amp;check_signal_done, sig)) {  \
5057       os::Linux::check_signal_handler(sig);       \
5058     }                                             \
5059   } while (0)
5060 
5061 // This method is a periodic task to check for misbehaving JNI applications
5062 // under CheckJNI, we can add any periodic checks here
5063 
5064 void os::run_periodic_checks() {
5065   if (check_signals == false) return;
5066 
5067   // SEGV and BUS if overridden could potentially prevent
5068   // generation of hs*.log in the event of a crash, debugging
5069   // such a case can be very challenging, so we absolutely
5070   // check the following for a good measure:
5071   DO_SIGNAL_CHECK(SIGSEGV);
5072   DO_SIGNAL_CHECK(SIGILL);
5073   DO_SIGNAL_CHECK(SIGFPE);
5074   DO_SIGNAL_CHECK(SIGBUS);
5075   DO_SIGNAL_CHECK(SIGPIPE);
5076   DO_SIGNAL_CHECK(SIGXFSZ);
5077 #if defined(PPC64)
5078   DO_SIGNAL_CHECK(SIGTRAP);
5079 #endif
5080 
5081   // ReduceSignalUsage allows the user to override these handlers
5082   // see comments at the very top and jvm_md.h
5083   if (!ReduceSignalUsage) {
5084     DO_SIGNAL_CHECK(SHUTDOWN1_SIGNAL);
5085     DO_SIGNAL_CHECK(SHUTDOWN2_SIGNAL);
5086     DO_SIGNAL_CHECK(SHUTDOWN3_SIGNAL);
5087     DO_SIGNAL_CHECK(BREAK_SIGNAL);
5088   }
5089 
5090   DO_SIGNAL_CHECK(SR_signum);
5091 }
5092 
5093 typedef int (*os_sigaction_t)(int, const struct sigaction *, struct sigaction *);
5094 
5095 static os_sigaction_t os_sigaction = NULL;
5096 
5097 void os::Linux::check_signal_handler(int sig) {
5098   char buf[O_BUFLEN];
5099   address jvmHandler = NULL;
5100 
5101 
5102   struct sigaction act;
5103   if (os_sigaction == NULL) {
5104     // only trust the default sigaction, in case it has been interposed
5105     os_sigaction = (os_sigaction_t)dlsym(RTLD_DEFAULT, &quot;sigaction&quot;);
5106     if (os_sigaction == NULL) return;
5107   }
5108 
5109   os_sigaction(sig, (struct sigaction*)NULL, &amp;act);
5110 
5111 
5112   act.sa_flags &amp;= SIGNIFICANT_SIGNAL_MASK;
5113 
5114   address thisHandler = (act.sa_flags &amp; SA_SIGINFO)
5115     ? CAST_FROM_FN_PTR(address, act.sa_sigaction)
5116     : CAST_FROM_FN_PTR(address, act.sa_handler);
5117 
5118 
5119   switch (sig) {
5120   case SIGSEGV:
5121   case SIGBUS:
5122   case SIGFPE:
5123   case SIGPIPE:
5124   case SIGILL:
5125   case SIGXFSZ:
5126     jvmHandler = CAST_FROM_FN_PTR(address, (sa_sigaction_t)signalHandler);
5127     break;
5128 
5129   case SHUTDOWN1_SIGNAL:
5130   case SHUTDOWN2_SIGNAL:
5131   case SHUTDOWN3_SIGNAL:
5132   case BREAK_SIGNAL:
5133     jvmHandler = (address)user_handler();
5134     break;
5135 
5136   default:
5137     if (sig == SR_signum) {
5138       jvmHandler = CAST_FROM_FN_PTR(address, (sa_sigaction_t)SR_handler);
5139     } else {
5140       return;
5141     }
5142     break;
5143   }
5144 
5145   if (thisHandler != jvmHandler) {
5146     tty-&gt;print(&quot;Warning: %s handler &quot;, exception_name(sig, buf, O_BUFLEN));
5147     tty-&gt;print(&quot;expected:%s&quot;, get_signal_handler_name(jvmHandler, buf, O_BUFLEN));
5148     tty-&gt;print_cr(&quot;  found:%s&quot;, get_signal_handler_name(thisHandler, buf, O_BUFLEN));
5149     // No need to check this sig any longer
5150     sigaddset(&amp;check_signal_done, sig);
5151     // Running under non-interactive shell, SHUTDOWN2_SIGNAL will be reassigned SIG_IGN
5152     if (sig == SHUTDOWN2_SIGNAL &amp;&amp; !isatty(fileno(stdin))) {
5153       tty-&gt;print_cr(&quot;Running in non-interactive shell, %s handler is replaced by shell&quot;,
5154                     exception_name(sig, buf, O_BUFLEN));
5155     }
5156   } else if(os::Linux::get_our_sigflags(sig) != 0 &amp;&amp; (int)act.sa_flags != os::Linux::get_our_sigflags(sig)) {
5157     tty-&gt;print(&quot;Warning: %s handler flags &quot;, exception_name(sig, buf, O_BUFLEN));
5158     tty-&gt;print(&quot;expected:&quot;);
5159     os::Posix::print_sa_flags(tty, os::Linux::get_our_sigflags(sig));
5160     tty-&gt;cr();
5161     tty-&gt;print(&quot;  found:&quot;);
5162     os::Posix::print_sa_flags(tty, act.sa_flags);
5163     tty-&gt;cr();
5164     // No need to check this sig any longer
5165     sigaddset(&amp;check_signal_done, sig);
5166   }
5167 
5168   // Dump all the signal
5169   if (sigismember(&amp;check_signal_done, sig)) {
5170     print_signal_handlers(tty, buf, O_BUFLEN);
5171   }
5172 }
5173 
5174 extern void report_error(char* file_name, int line_no, char* title,
5175                          char* format, ...);
5176 
5177 // Some linux distributions (notably: Alpine Linux) include the
5178 // grsecurity in the kernel by default. Of particular interest from a
5179 // JVM perspective is PaX (https://pax.grsecurity.net/), which adds
5180 // some security features related to page attributes. Specifically,
5181 // the MPROTECT PaX functionality
5182 // (https://pax.grsecurity.net/docs/mprotect.txt) prevents dynamic
5183 // code generation by disallowing a (previously) writable page to be
5184 // marked as executable. This is, of course, exactly what HotSpot does
5185 // for both JIT compiled method, as well as for stubs, adapters, etc.
5186 //
5187 // Instead of crashing &quot;lazily&quot; when trying to make a page executable,
5188 // this code probes for the presence of PaX and reports the failure
5189 // eagerly.
5190 static void check_pax(void) {
5191   // Zero doesn&#39;t generate code dynamically, so no need to perform the PaX check
5192 #ifndef ZERO
5193   size_t size = os::Linux::page_size();
5194 
5195   void* p = ::mmap(NULL, size, PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0);
5196   if (p == MAP_FAILED) {
5197     vm_exit_out_of_memory(size, OOM_MMAP_ERROR, &quot;failed to allocate memory for PaX check.&quot;);
5198   }
5199 
5200   int res = ::mprotect(p, size, PROT_WRITE|PROT_EXEC);
5201   if (res == -1) {
5202     vm_exit_during_initialization(&quot;Failed to mark memory page as executable&quot;,
5203                                   &quot;Please check if grsecurity/PaX is enabled in your kernel.\n&quot;
5204                                   &quot;\n&quot;
5205                                   &quot;For example, you can do this by running (note: you may need root privileges):\n&quot;
5206                                   &quot;\n&quot;
5207                                   &quot;    sysctl kernel.pax.softmode\n&quot;
5208                                   &quot;\n&quot;
5209                                   &quot;If PaX is included in the kernel you will see something like this:\n&quot;
5210                                   &quot;\n&quot;
5211                                   &quot;    kernel.pax.softmode = 0\n&quot;
5212                                   &quot;\n&quot;
5213                                   &quot;In particular, if the value is 0 (zero), then PaX is enabled.\n&quot;
5214                                   &quot;\n&quot;
5215                                   &quot;PaX includes security functionality which interferes with the dynamic code\n&quot;
5216                                   &quot;generation the JVM relies on. Specifically, the MPROTECT functionality as\n&quot;
5217                                   &quot;described on https://pax.grsecurity.net/docs/mprotect.txt is not compatible\n&quot;
5218                                   &quot;with the JVM. If you want to allow the JVM to run you will have to disable PaX.\n&quot;
5219                                   &quot;You can do this on a per-executable basis using the paxctl tool, for example:\n&quot;
5220                                   &quot;\n&quot;
5221                                   &quot;    paxctl -cm bin/java\n&quot;
5222                                   &quot;\n&quot;
5223                                   &quot;Please note that this modifies the executable binary in-place, so you may want\n&quot;
5224                                   &quot;to make a backup of it first. Also note that you have to repeat this for other\n&quot;
5225                                   &quot;executables like javac, jar, jcmd, etc.\n&quot;
5226                                   );
5227 
5228   }
5229 
5230   ::munmap(p, size);
5231 #endif
5232 }
5233 
5234 // this is called _before_ most of the global arguments have been parsed
5235 void os::init(void) {
5236   char dummy;   // used to get a guess on initial stack address
5237 
5238   clock_tics_per_sec = sysconf(_SC_CLK_TCK);
5239 
5240   init_random(1234567);
5241 
5242   Linux::set_page_size(sysconf(_SC_PAGESIZE));
5243   if (Linux::page_size() == -1) {
5244     fatal(&quot;os_linux.cpp: os::init: sysconf failed (%s)&quot;,
5245           os::strerror(errno));
5246   }
5247   init_page_sizes((size_t) Linux::page_size());
5248 
5249   Linux::initialize_system_info();
5250 
5251   os::Linux::CPUPerfTicks pticks;
5252   bool res = os::Linux::get_tick_information(&amp;pticks, -1);
5253 
5254   if (res &amp;&amp; pticks.has_steal_ticks) {
5255     has_initial_tick_info = true;
5256     initial_total_ticks = pticks.total;
5257     initial_steal_ticks = pticks.steal;
5258   }
5259 
5260   // _main_thread points to the thread that created/loaded the JVM.
5261   Linux::_main_thread = pthread_self();
5262 
5263   // retrieve entry point for pthread_setname_np
5264   Linux::_pthread_setname_np =
5265     (int(*)(pthread_t, const char*))dlsym(RTLD_DEFAULT, &quot;pthread_setname_np&quot;);
5266 
5267   check_pax();
5268 
5269   os::Posix::init();
5270 
5271   initial_time_count = javaTimeNanos();
5272 
5273   // Always warn if no monotonic clock available
5274   if (!os::Posix::supports_monotonic_clock()) {
5275     warning(&quot;No monotonic clock was available - timed services may &quot;    \
5276             &quot;be adversely affected if the time-of-day clock changes&quot;);
5277   }
5278 }
5279 
5280 // To install functions for atexit system call
5281 extern &quot;C&quot; {
5282   static void perfMemory_exit_helper() {
5283     perfMemory_exit();
5284   }
5285 }
5286 
5287 void os::pd_init_container_support() {
5288   OSContainer::init();
5289 }
5290 
5291 void os::Linux::numa_init() {
5292 
5293   // Java can be invoked as
5294   // 1. Without numactl and heap will be allocated/configured on all nodes as
5295   //    per the system policy.
5296   // 2. With numactl --interleave:
5297   //      Use numa_get_interleave_mask(v2) API to get nodes bitmask. The same
5298   //      API for membind case bitmask is reset.
5299   //      Interleave is only hint and Kernel can fallback to other nodes if
5300   //      no memory is available on the target nodes.
5301   // 3. With numactl --membind:
5302   //      Use numa_get_membind(v2) API to get nodes bitmask. The same API for
5303   //      interleave case returns bitmask of all nodes.
5304   // numa_all_nodes_ptr holds bitmask of all nodes.
5305   // numa_get_interleave_mask(v2) and numa_get_membind(v2) APIs returns correct
5306   // bitmask when externally configured to run on all or fewer nodes.
5307 
5308   if (!Linux::libnuma_init()) {
5309     FLAG_SET_ERGO(UseNUMA, false);
5310     FLAG_SET_ERGO(UseNUMAInterleaving, false); // Also depends on libnuma.
5311   } else {
5312     if ((Linux::numa_max_node() &lt; 1) || Linux::is_bound_to_single_node()) {
5313       // If there&#39;s only one node (they start from 0) or if the process
5314       // is bound explicitly to a single node using membind, disable NUMA unless
5315       // user explicilty forces NUMA optimizations on single-node/UMA systems
5316       UseNUMA = ForceNUMA;
5317     } else {
5318 
5319       LogTarget(Info,os) log;
5320       LogStream ls(log);
5321 
5322       Linux::set_configured_numa_policy(Linux::identify_numa_policy());
5323 
5324       struct bitmask* bmp = Linux::_numa_membind_bitmask;
5325       const char* numa_mode = &quot;membind&quot;;
5326 
5327       if (Linux::is_running_in_interleave_mode()) {
5328         bmp = Linux::_numa_interleave_bitmask;
5329         numa_mode = &quot;interleave&quot;;
5330       }
5331 
5332       ls.print(&quot;UseNUMA is enabled and invoked in &#39;%s&#39; mode.&quot;
5333                &quot; Heap will be configured using NUMA memory nodes:&quot;, numa_mode);
5334 
5335       for (int node = 0; node &lt;= Linux::numa_max_node(); node++) {
5336         if (Linux::_numa_bitmask_isbitset(bmp, node)) {
5337           ls.print(&quot; %d&quot;, node);
5338         }
5339       }
5340     }
5341   }
5342 
5343   // When NUMA requested, not-NUMA-aware allocations default to interleaving.
5344   if (UseNUMA &amp;&amp; !UseNUMAInterleaving) {
5345     FLAG_SET_ERGO_IF_DEFAULT(UseNUMAInterleaving, true);
5346   }
5347 
5348   if (UseParallelGC &amp;&amp; UseNUMA &amp;&amp; UseLargePages &amp;&amp; !can_commit_large_page_memory()) {
5349     // With SHM and HugeTLBFS large pages we cannot uncommit a page, so there&#39;s no way
5350     // we can make the adaptive lgrp chunk resizing work. If the user specified both
5351     // UseNUMA and UseLargePages (or UseSHM/UseHugeTLBFS) on the command line - warn
5352     // and disable adaptive resizing.
5353     if (UseAdaptiveSizePolicy || UseAdaptiveNUMAChunkSizing) {
5354       warning(&quot;UseNUMA is not fully compatible with SHM/HugeTLBFS large pages, &quot;
5355               &quot;disabling adaptive resizing (-XX:-UseAdaptiveSizePolicy -XX:-UseAdaptiveNUMAChunkSizing)&quot;);
5356       UseAdaptiveSizePolicy = false;
5357       UseAdaptiveNUMAChunkSizing = false;
5358     }
5359   }
5360 }
5361 
5362 // this is called _after_ the global arguments have been parsed
5363 jint os::init_2(void) {
5364 
5365   // This could be set after os::Posix::init() but all platforms
5366   // have to set it the same so we have to mirror Solaris.
5367   DEBUG_ONLY(os::set_mutex_init_done();)
5368 
5369   os::Posix::init_2();
5370 
5371   Linux::fast_thread_clock_init();
5372 
5373   // initialize suspend/resume support - must do this before signal_sets_init()
5374   if (SR_initialize() != 0) {
5375     perror(&quot;SR_initialize failed&quot;);
5376     return JNI_ERR;
5377   }
5378 
5379   Linux::signal_sets_init();
5380   Linux::install_signal_handlers();
5381   // Initialize data for jdk.internal.misc.Signal
5382   if (!ReduceSignalUsage) {
5383     jdk_misc_signal_init();
5384   }
5385 
5386   if (AdjustStackSizeForTLS) {
5387     get_minstack_init();
5388   }
5389 
5390   // Check and sets minimum stack sizes against command line options
5391   if (Posix::set_minimum_stack_sizes() == JNI_ERR) {
5392     return JNI_ERR;
5393   }
5394 
5395 #if defined(IA32)
5396   // Need to ensure we&#39;ve determined the process&#39;s initial stack to
5397   // perform the workaround
5398   Linux::capture_initial_stack(JavaThread::stack_size_at_create());
5399   workaround_expand_exec_shield_cs_limit();
5400 #else
5401   suppress_primordial_thread_resolution = Arguments::created_by_java_launcher();
5402   if (!suppress_primordial_thread_resolution) {
5403     Linux::capture_initial_stack(JavaThread::stack_size_at_create());
5404   }
5405 #endif
5406 
5407   Linux::libpthread_init();
5408   Linux::sched_getcpu_init();
5409   log_info(os)(&quot;HotSpot is running with %s, %s&quot;,
5410                Linux::glibc_version(), Linux::libpthread_version());
5411 
5412   if (UseNUMA || UseNUMAInterleaving) {
5413     Linux::numa_init();
5414   }
5415 
5416   if (MaxFDLimit) {
5417     // set the number of file descriptors to max. print out error
5418     // if getrlimit/setrlimit fails but continue regardless.
5419     struct rlimit nbr_files;
5420     int status = getrlimit(RLIMIT_NOFILE, &amp;nbr_files);
5421     if (status != 0) {
5422       log_info(os)(&quot;os::init_2 getrlimit failed: %s&quot;, os::strerror(errno));
5423     } else {
5424       nbr_files.rlim_cur = nbr_files.rlim_max;
5425       status = setrlimit(RLIMIT_NOFILE, &amp;nbr_files);
5426       if (status != 0) {
5427         log_info(os)(&quot;os::init_2 setrlimit failed: %s&quot;, os::strerror(errno));
5428       }
5429     }
5430   }
5431 
5432   // at-exit methods are called in the reverse order of their registration.
5433   // atexit functions are called on return from main or as a result of a
5434   // call to exit(3C). There can be only 32 of these functions registered
5435   // and atexit() does not set errno.
5436 
5437   if (PerfAllowAtExitRegistration) {
5438     // only register atexit functions if PerfAllowAtExitRegistration is set.
5439     // atexit functions can be delayed until process exit time, which
5440     // can be problematic for embedded VM situations. Embedded VMs should
5441     // call DestroyJavaVM() to assure that VM resources are released.
5442 
5443     // note: perfMemory_exit_helper atexit function may be removed in
5444     // the future if the appropriate cleanup code can be added to the
5445     // VM_Exit VMOperation&#39;s doit method.
5446     if (atexit(perfMemory_exit_helper) != 0) {
5447       warning(&quot;os::init_2 atexit(perfMemory_exit_helper) failed&quot;);
5448     }
5449   }
5450 
5451   // initialize thread priority policy
5452   prio_init();
5453 
5454   if (!FLAG_IS_DEFAULT(AllocateHeapAt) || !FLAG_IS_DEFAULT(AllocateOldGenAt)) {
5455     set_coredump_filter(DAX_SHARED_BIT);
5456   }
5457 
5458   if (DumpPrivateMappingsInCore) {
5459     set_coredump_filter(FILE_BACKED_PVT_BIT);
5460   }
5461 
5462   if (DumpSharedMappingsInCore) {
5463     set_coredump_filter(FILE_BACKED_SHARED_BIT);
5464   }
5465 
5466   return JNI_OK;
5467 }
5468 
5469 // older glibc versions don&#39;t have this macro (which expands to
5470 // an optimized bit-counting function) so we have to roll our own
5471 #ifndef CPU_COUNT
5472 
5473 static int _cpu_count(const cpu_set_t* cpus) {
5474   int count = 0;
5475   // only look up to the number of configured processors
5476   for (int i = 0; i &lt; os::processor_count(); i++) {
5477     if (CPU_ISSET(i, cpus)) {
5478       count++;
5479     }
5480   }
5481   return count;
5482 }
5483 
5484 #define CPU_COUNT(cpus) _cpu_count(cpus)
5485 
5486 #endif // CPU_COUNT
5487 
5488 // Get the current number of available processors for this process.
5489 // This value can change at any time during a process&#39;s lifetime.
5490 // sched_getaffinity gives an accurate answer as it accounts for cpusets.
5491 // If it appears there may be more than 1024 processors then we do a
5492 // dynamic check - see 6515172 for details.
5493 // If anything goes wrong we fallback to returning the number of online
5494 // processors - which can be greater than the number available to the process.
5495 int os::Linux::active_processor_count() {
5496   cpu_set_t cpus;  // can represent at most 1024 (CPU_SETSIZE) processors
5497   cpu_set_t* cpus_p = &amp;cpus;
5498   int cpus_size = sizeof(cpu_set_t);
5499 
5500   int configured_cpus = os::processor_count();  // upper bound on available cpus
5501   int cpu_count = 0;
5502 
5503 // old build platforms may not support dynamic cpu sets
5504 #ifdef CPU_ALLOC
5505 
5506   // To enable easy testing of the dynamic path on different platforms we
5507   // introduce a diagnostic flag: UseCpuAllocPath
5508   if (configured_cpus &gt;= CPU_SETSIZE || UseCpuAllocPath) {
5509     // kernel may use a mask bigger than cpu_set_t
5510     log_trace(os)(&quot;active_processor_count: using dynamic path %s&quot;
5511                   &quot;- configured processors: %d&quot;,
5512                   UseCpuAllocPath ? &quot;(forced) &quot; : &quot;&quot;,
5513                   configured_cpus);
5514     cpus_p = CPU_ALLOC(configured_cpus);
5515     if (cpus_p != NULL) {
5516       cpus_size = CPU_ALLOC_SIZE(configured_cpus);
5517       // zero it just to be safe
5518       CPU_ZERO_S(cpus_size, cpus_p);
5519     }
5520     else {
5521        // failed to allocate so fallback to online cpus
5522        int online_cpus = ::sysconf(_SC_NPROCESSORS_ONLN);
5523        log_trace(os)(&quot;active_processor_count: &quot;
5524                      &quot;CPU_ALLOC failed (%s) - using &quot;
5525                      &quot;online processor count: %d&quot;,
5526                      os::strerror(errno), online_cpus);
5527        return online_cpus;
5528     }
5529   }
5530   else {
5531     log_trace(os)(&quot;active_processor_count: using static path - configured processors: %d&quot;,
5532                   configured_cpus);
5533   }
5534 #else // CPU_ALLOC
5535 // these stubs won&#39;t be executed
5536 #define CPU_COUNT_S(size, cpus) -1
5537 #define CPU_FREE(cpus)
5538 
5539   log_trace(os)(&quot;active_processor_count: only static path available - configured processors: %d&quot;,
5540                 configured_cpus);
5541 #endif // CPU_ALLOC
5542 
5543   // pid 0 means the current thread - which we have to assume represents the process
5544   if (sched_getaffinity(0, cpus_size, cpus_p) == 0) {
5545     if (cpus_p != &amp;cpus) { // can only be true when CPU_ALLOC used
5546       cpu_count = CPU_COUNT_S(cpus_size, cpus_p);
5547     }
5548     else {
5549       cpu_count = CPU_COUNT(cpus_p);
5550     }
5551     log_trace(os)(&quot;active_processor_count: sched_getaffinity processor count: %d&quot;, cpu_count);
5552   }
5553   else {
5554     cpu_count = ::sysconf(_SC_NPROCESSORS_ONLN);
5555     warning(&quot;sched_getaffinity failed (%s)- using online processor count (%d) &quot;
5556             &quot;which may exceed available processors&quot;, os::strerror(errno), cpu_count);
5557   }
5558 
5559   if (cpus_p != &amp;cpus) { // can only be true when CPU_ALLOC used
5560     CPU_FREE(cpus_p);
5561   }
5562 
5563   assert(cpu_count &gt; 0 &amp;&amp; cpu_count &lt;= os::processor_count(), &quot;sanity check&quot;);
5564   return cpu_count;
5565 }
5566 
5567 // Determine the active processor count from one of
5568 // three different sources:
5569 //
5570 // 1. User option -XX:ActiveProcessorCount
5571 // 2. kernel os calls (sched_getaffinity or sysconf(_SC_NPROCESSORS_ONLN)
5572 // 3. extracted from cgroup cpu subsystem (shares and quotas)
5573 //
5574 // Option 1, if specified, will always override.
5575 // If the cgroup subsystem is active and configured, we
5576 // will return the min of the cgroup and option 2 results.
5577 // This is required since tools, such as numactl, that
5578 // alter cpu affinity do not update cgroup subsystem
5579 // cpuset configuration files.
5580 int os::active_processor_count() {
5581   // User has overridden the number of active processors
5582   if (ActiveProcessorCount &gt; 0) {
5583     log_trace(os)(&quot;active_processor_count: &quot;
5584                   &quot;active processor count set by user : %d&quot;,
5585                   ActiveProcessorCount);
5586     return ActiveProcessorCount;
5587   }
5588 
5589   int active_cpus;
5590   if (OSContainer::is_containerized()) {
5591     active_cpus = OSContainer::active_processor_count();
5592     log_trace(os)(&quot;active_processor_count: determined by OSContainer: %d&quot;,
5593                    active_cpus);
5594   } else {
5595     active_cpus = os::Linux::active_processor_count();
5596   }
5597 
5598   return active_cpus;
5599 }
5600 
5601 uint os::processor_id() {
5602   const int id = Linux::sched_getcpu();
5603   assert(id &gt;= 0 &amp;&amp; id &lt; _processor_count, &quot;Invalid processor id&quot;);
5604   return (uint)id;
5605 }
5606 
5607 void os::set_native_thread_name(const char *name) {
5608   if (Linux::_pthread_setname_np) {
5609     char buf [16]; // according to glibc manpage, 16 chars incl. &#39;/0&#39;
5610     snprintf(buf, sizeof(buf), &quot;%s&quot;, name);
5611     buf[sizeof(buf) - 1] = &#39;\0&#39;;
5612     const int rc = Linux::_pthread_setname_np(pthread_self(), buf);
5613     // ERANGE should not happen; all other errors should just be ignored.
5614     assert(rc != ERANGE, &quot;pthread_setname_np failed&quot;);
5615   }
5616 }
5617 
5618 bool os::bind_to_processor(uint processor_id) {
5619   // Not yet implemented.
5620   return false;
5621 }
5622 
5623 ///
5624 
5625 void os::SuspendedThreadTask::internal_do_task() {
5626   if (do_suspend(_thread-&gt;osthread())) {
5627     SuspendedThreadTaskContext context(_thread, _thread-&gt;osthread()-&gt;ucontext());
5628     do_task(context);
5629     do_resume(_thread-&gt;osthread());
5630   }
5631 }
5632 
5633 ////////////////////////////////////////////////////////////////////////////////
5634 // debug support
5635 
5636 bool os::find(address addr, outputStream* st) {
5637   Dl_info dlinfo;
5638   memset(&amp;dlinfo, 0, sizeof(dlinfo));
5639   if (dladdr(addr, &amp;dlinfo) != 0) {
5640     st-&gt;print(PTR_FORMAT &quot;: &quot;, p2i(addr));
5641     if (dlinfo.dli_sname != NULL &amp;&amp; dlinfo.dli_saddr != NULL) {
5642       st-&gt;print(&quot;%s+&quot; PTR_FORMAT, dlinfo.dli_sname,
5643                 p2i(addr) - p2i(dlinfo.dli_saddr));
5644     } else if (dlinfo.dli_fbase != NULL) {
5645       st-&gt;print(&quot;&lt;offset &quot; PTR_FORMAT &quot;&gt;&quot;, p2i(addr) - p2i(dlinfo.dli_fbase));
5646     } else {
5647       st-&gt;print(&quot;&lt;absolute address&gt;&quot;);
5648     }
5649     if (dlinfo.dli_fname != NULL) {
5650       st-&gt;print(&quot; in %s&quot;, dlinfo.dli_fname);
5651     }
5652     if (dlinfo.dli_fbase != NULL) {
5653       st-&gt;print(&quot; at &quot; PTR_FORMAT, p2i(dlinfo.dli_fbase));
5654     }
5655     st-&gt;cr();
5656 
5657     if (Verbose) {
5658       // decode some bytes around the PC
5659       address begin = clamp_address_in_page(addr-40, addr, os::vm_page_size());
5660       address end   = clamp_address_in_page(addr+40, addr, os::vm_page_size());
5661       address       lowest = (address) dlinfo.dli_sname;
5662       if (!lowest)  lowest = (address) dlinfo.dli_fbase;
5663       if (begin &lt; lowest)  begin = lowest;
5664       Dl_info dlinfo2;
5665       if (dladdr(end, &amp;dlinfo2) != 0 &amp;&amp; dlinfo2.dli_saddr != dlinfo.dli_saddr
5666           &amp;&amp; end &gt; dlinfo2.dli_saddr &amp;&amp; dlinfo2.dli_saddr &gt; begin) {
5667         end = (address) dlinfo2.dli_saddr;
5668       }
5669       Disassembler::decode(begin, end, st);
5670     }
5671     return true;
5672   }
5673   return false;
5674 }
5675 
5676 ////////////////////////////////////////////////////////////////////////////////
5677 // misc
5678 
5679 // This does not do anything on Linux. This is basically a hook for being
5680 // able to use structured exception handling (thread-local exception filters)
5681 // on, e.g., Win32.
5682 void
5683 os::os_exception_wrapper(java_call_t f, JavaValue* value, const methodHandle&amp; method,
5684                          JavaCallArguments* args, Thread* thread) {
5685   f(value, method, args, thread);
5686 }
5687 
5688 void os::print_statistics() {
5689 }
5690 
5691 bool os::message_box(const char* title, const char* message) {
5692   int i;
5693   fdStream err(defaultStream::error_fd());
5694   for (i = 0; i &lt; 78; i++) err.print_raw(&quot;=&quot;);
5695   err.cr();
5696   err.print_raw_cr(title);
5697   for (i = 0; i &lt; 78; i++) err.print_raw(&quot;-&quot;);
5698   err.cr();
5699   err.print_raw_cr(message);
5700   for (i = 0; i &lt; 78; i++) err.print_raw(&quot;=&quot;);
5701   err.cr();
5702 
5703   char buf[16];
5704   // Prevent process from exiting upon &quot;read error&quot; without consuming all CPU
5705   while (::read(0, buf, sizeof(buf)) &lt;= 0) { ::sleep(100); }
5706 
5707   return buf[0] == &#39;y&#39; || buf[0] == &#39;Y&#39;;
5708 }
5709 
5710 // Is a (classpath) directory empty?
5711 bool os::dir_is_empty(const char* path) {
5712   DIR *dir = NULL;
5713   struct dirent *ptr;
5714 
5715   dir = opendir(path);
5716   if (dir == NULL) return true;
5717 
5718   // Scan the directory
5719   bool result = true;
5720   while (result &amp;&amp; (ptr = readdir(dir)) != NULL) {
5721     if (strcmp(ptr-&gt;d_name, &quot;.&quot;) != 0 &amp;&amp; strcmp(ptr-&gt;d_name, &quot;..&quot;) != 0) {
5722       result = false;
5723     }
5724   }
5725   closedir(dir);
5726   return result;
5727 }
5728 
5729 // This code originates from JDK&#39;s sysOpen and open64_w
5730 // from src/solaris/hpi/src/system_md.c
5731 
5732 int os::open(const char *path, int oflag, int mode) {
5733   if (strlen(path) &gt; MAX_PATH - 1) {
5734     errno = ENAMETOOLONG;
5735     return -1;
5736   }
5737 
5738   // All file descriptors that are opened in the Java process and not
5739   // specifically destined for a subprocess should have the close-on-exec
5740   // flag set.  If we don&#39;t set it, then careless 3rd party native code
5741   // might fork and exec without closing all appropriate file descriptors
5742   // (e.g. as we do in closeDescriptors in UNIXProcess.c), and this in
5743   // turn might:
5744   //
5745   // - cause end-of-file to fail to be detected on some file
5746   //   descriptors, resulting in mysterious hangs, or
5747   //
5748   // - might cause an fopen in the subprocess to fail on a system
5749   //   suffering from bug 1085341.
5750   //
5751   // (Yes, the default setting of the close-on-exec flag is a Unix
5752   // design flaw)
5753   //
5754   // See:
5755   // 1085341: 32-bit stdio routines should support file descriptors &gt;255
5756   // 4843136: (process) pipe file descriptor from Runtime.exec not being closed
5757   // 6339493: (process) Runtime.exec does not close all file descriptors on Solaris 9
5758   //
5759   // Modern Linux kernels (after 2.6.23 2007) support O_CLOEXEC with open().
5760   // O_CLOEXEC is preferable to using FD_CLOEXEC on an open file descriptor
5761   // because it saves a system call and removes a small window where the flag
5762   // is unset.  On ancient Linux kernels the O_CLOEXEC flag will be ignored
5763   // and we fall back to using FD_CLOEXEC (see below).
5764 #ifdef O_CLOEXEC
5765   oflag |= O_CLOEXEC;
5766 #endif
5767 
5768   int fd = ::open64(path, oflag, mode);
5769   if (fd == -1) return -1;
5770 
5771   //If the open succeeded, the file might still be a directory
5772   {
5773     struct stat64 buf64;
5774     int ret = ::fstat64(fd, &amp;buf64);
5775     int st_mode = buf64.st_mode;
5776 
5777     if (ret != -1) {
5778       if ((st_mode &amp; S_IFMT) == S_IFDIR) {
5779         errno = EISDIR;
5780         ::close(fd);
5781         return -1;
5782       }
5783     } else {
5784       ::close(fd);
5785       return -1;
5786     }
5787   }
5788 
5789 #ifdef FD_CLOEXEC
5790   // Validate that the use of the O_CLOEXEC flag on open above worked.
5791   // With recent kernels, we will perform this check exactly once.
5792   static sig_atomic_t O_CLOEXEC_is_known_to_work = 0;
5793   if (!O_CLOEXEC_is_known_to_work) {
5794     int flags = ::fcntl(fd, F_GETFD);
5795     if (flags != -1) {
5796       if ((flags &amp; FD_CLOEXEC) != 0)
5797         O_CLOEXEC_is_known_to_work = 1;
5798       else
5799         ::fcntl(fd, F_SETFD, flags | FD_CLOEXEC);
5800     }
5801   }
5802 #endif
5803 
5804   return fd;
5805 }
5806 
5807 
5808 // create binary file, rewriting existing file if required
5809 int os::create_binary_file(const char* path, bool rewrite_existing) {
5810   int oflags = O_WRONLY | O_CREAT;
5811   if (!rewrite_existing) {
5812     oflags |= O_EXCL;
5813   }
5814   return ::open64(path, oflags, S_IREAD | S_IWRITE);
5815 }
5816 
5817 // return current position of file pointer
5818 jlong os::current_file_offset(int fd) {
5819   return (jlong)::lseek64(fd, (off64_t)0, SEEK_CUR);
5820 }
5821 
5822 // move file pointer to the specified offset
5823 jlong os::seek_to_file_offset(int fd, jlong offset) {
5824   return (jlong)::lseek64(fd, (off64_t)offset, SEEK_SET);
5825 }
5826 
5827 // This code originates from JDK&#39;s sysAvailable
5828 // from src/solaris/hpi/src/native_threads/src/sys_api_td.c
5829 
5830 int os::available(int fd, jlong *bytes) {
5831   jlong cur, end;
5832   int mode;
5833   struct stat64 buf64;
5834 
5835   if (::fstat64(fd, &amp;buf64) &gt;= 0) {
5836     mode = buf64.st_mode;
5837     if (S_ISCHR(mode) || S_ISFIFO(mode) || S_ISSOCK(mode)) {
5838       int n;
5839       if (::ioctl(fd, FIONREAD, &amp;n) &gt;= 0) {
5840         *bytes = n;
5841         return 1;
5842       }
5843     }
5844   }
5845   if ((cur = ::lseek64(fd, 0L, SEEK_CUR)) == -1) {
5846     return 0;
5847   } else if ((end = ::lseek64(fd, 0L, SEEK_END)) == -1) {
5848     return 0;
5849   } else if (::lseek64(fd, cur, SEEK_SET) == -1) {
5850     return 0;
5851   }
5852   *bytes = end - cur;
5853   return 1;
5854 }
5855 
5856 // Map a block of memory.
5857 char* os::pd_map_memory(int fd, const char* file_name, size_t file_offset,
5858                         char *addr, size_t bytes, bool read_only,
5859                         bool allow_exec) {
5860   int prot;
5861   int flags = MAP_PRIVATE;
5862 
5863   if (read_only) {
5864     prot = PROT_READ;
5865   } else {
5866     prot = PROT_READ | PROT_WRITE;
5867   }
5868 
5869   if (allow_exec) {
5870     prot |= PROT_EXEC;
5871   }
5872 
5873   if (addr != NULL) {
5874     flags |= MAP_FIXED;
5875   }
5876 
5877   char* mapped_address = (char*)mmap(addr, (size_t)bytes, prot, flags,
5878                                      fd, file_offset);
5879   if (mapped_address == MAP_FAILED) {
5880     return NULL;
5881   }
5882   return mapped_address;
5883 }
5884 
5885 
5886 // Remap a block of memory.
5887 char* os::pd_remap_memory(int fd, const char* file_name, size_t file_offset,
5888                           char *addr, size_t bytes, bool read_only,
5889                           bool allow_exec) {
5890   // same as map_memory() on this OS
5891   return os::map_memory(fd, file_name, file_offset, addr, bytes, read_only,
5892                         allow_exec);
5893 }
5894 
5895 
5896 // Unmap a block of memory.
5897 bool os::pd_unmap_memory(char* addr, size_t bytes) {
5898   return munmap(addr, bytes) == 0;
5899 }
5900 
5901 static jlong slow_thread_cpu_time(Thread *thread, bool user_sys_cpu_time);
5902 
5903 static jlong fast_cpu_time(Thread *thread) {
5904     clockid_t clockid;
5905     int rc = os::Linux::pthread_getcpuclockid(thread-&gt;osthread()-&gt;pthread_id(),
5906                                               &amp;clockid);
5907     if (rc == 0) {
5908       return os::Linux::fast_thread_cpu_time(clockid);
5909     } else {
5910       // It&#39;s possible to encounter a terminated native thread that failed
5911       // to detach itself from the VM - which should result in ESRCH.
5912       assert_status(rc == ESRCH, rc, &quot;pthread_getcpuclockid failed&quot;);
5913       return -1;
5914     }
5915 }
5916 
5917 // current_thread_cpu_time(bool) and thread_cpu_time(Thread*, bool)
5918 // are used by JVM M&amp;M and JVMTI to get user+sys or user CPU time
5919 // of a thread.
5920 //
5921 // current_thread_cpu_time() and thread_cpu_time(Thread*) returns
5922 // the fast estimate available on the platform.
5923 
5924 jlong os::current_thread_cpu_time() {
5925   if (os::Linux::supports_fast_thread_cpu_time()) {
5926     return os::Linux::fast_thread_cpu_time(CLOCK_THREAD_CPUTIME_ID);
5927   } else {
5928     // return user + sys since the cost is the same
5929     return slow_thread_cpu_time(Thread::current(), true /* user + sys */);
5930   }
5931 }
5932 
5933 jlong os::thread_cpu_time(Thread* thread) {
5934   // consistent with what current_thread_cpu_time() returns
5935   if (os::Linux::supports_fast_thread_cpu_time()) {
5936     return fast_cpu_time(thread);
5937   } else {
5938     return slow_thread_cpu_time(thread, true /* user + sys */);
5939   }
5940 }
5941 
5942 jlong os::current_thread_cpu_time(bool user_sys_cpu_time) {
5943   if (user_sys_cpu_time &amp;&amp; os::Linux::supports_fast_thread_cpu_time()) {
5944     return os::Linux::fast_thread_cpu_time(CLOCK_THREAD_CPUTIME_ID);
5945   } else {
5946     return slow_thread_cpu_time(Thread::current(), user_sys_cpu_time);
5947   }
5948 }
5949 
5950 jlong os::thread_cpu_time(Thread *thread, bool user_sys_cpu_time) {
5951   if (user_sys_cpu_time &amp;&amp; os::Linux::supports_fast_thread_cpu_time()) {
5952     return fast_cpu_time(thread);
5953   } else {
5954     return slow_thread_cpu_time(thread, user_sys_cpu_time);
5955   }
5956 }
5957 
5958 //  -1 on error.
5959 static jlong slow_thread_cpu_time(Thread *thread, bool user_sys_cpu_time) {
5960   pid_t  tid = thread-&gt;osthread()-&gt;thread_id();
5961   char *s;
5962   char stat[2048];
5963   int statlen;
5964   char proc_name[64];
5965   int count;
5966   long sys_time, user_time;
5967   char cdummy;
5968   int idummy;
5969   long ldummy;
5970   FILE *fp;
5971 
5972   snprintf(proc_name, 64, &quot;/proc/self/task/%d/stat&quot;, tid);
5973   fp = fopen(proc_name, &quot;r&quot;);
5974   if (fp == NULL) return -1;
5975   statlen = fread(stat, 1, 2047, fp);
5976   stat[statlen] = &#39;\0&#39;;
5977   fclose(fp);
5978 
5979   // Skip pid and the command string. Note that we could be dealing with
5980   // weird command names, e.g. user could decide to rename java launcher
5981   // to &quot;java 1.4.2 :)&quot;, then the stat file would look like
5982   //                1234 (java 1.4.2 :)) R ... ...
5983   // We don&#39;t really need to know the command string, just find the last
5984   // occurrence of &quot;)&quot; and then start parsing from there. See bug 4726580.
5985   s = strrchr(stat, &#39;)&#39;);
5986   if (s == NULL) return -1;
5987 
5988   // Skip blank chars
5989   do { s++; } while (s &amp;&amp; isspace(*s));
5990 
5991   count = sscanf(s,&quot;%c %d %d %d %d %d %lu %lu %lu %lu %lu %lu %lu&quot;,
5992                  &amp;cdummy, &amp;idummy, &amp;idummy, &amp;idummy, &amp;idummy, &amp;idummy,
5993                  &amp;ldummy, &amp;ldummy, &amp;ldummy, &amp;ldummy, &amp;ldummy,
5994                  &amp;user_time, &amp;sys_time);
5995   if (count != 13) return -1;
5996   if (user_sys_cpu_time) {
5997     return ((jlong)sys_time + (jlong)user_time) * (1000000000 / clock_tics_per_sec);
5998   } else {
5999     return (jlong)user_time * (1000000000 / clock_tics_per_sec);
6000   }
6001 }
6002 
6003 void os::current_thread_cpu_time_info(jvmtiTimerInfo *info_ptr) {
6004   info_ptr-&gt;max_value = ALL_64_BITS;       // will not wrap in less than 64 bits
6005   info_ptr-&gt;may_skip_backward = false;     // elapsed time not wall time
6006   info_ptr-&gt;may_skip_forward = false;      // elapsed time not wall time
6007   info_ptr-&gt;kind = JVMTI_TIMER_TOTAL_CPU;  // user+system time is returned
6008 }
6009 
6010 void os::thread_cpu_time_info(jvmtiTimerInfo *info_ptr) {
6011   info_ptr-&gt;max_value = ALL_64_BITS;       // will not wrap in less than 64 bits
6012   info_ptr-&gt;may_skip_backward = false;     // elapsed time not wall time
6013   info_ptr-&gt;may_skip_forward = false;      // elapsed time not wall time
6014   info_ptr-&gt;kind = JVMTI_TIMER_TOTAL_CPU;  // user+system time is returned
6015 }
6016 
6017 bool os::is_thread_cpu_time_supported() {
6018   return true;
6019 }
6020 
6021 // System loadavg support.  Returns -1 if load average cannot be obtained.
6022 // Linux doesn&#39;t yet have a (official) notion of processor sets,
6023 // so just return the system wide load average.
6024 int os::loadavg(double loadavg[], int nelem) {
6025   return ::getloadavg(loadavg, nelem);
6026 }
6027 
6028 void os::pause() {
6029   char filename[MAX_PATH];
6030   if (PauseAtStartupFile &amp;&amp; PauseAtStartupFile[0]) {
6031     jio_snprintf(filename, MAX_PATH, &quot;%s&quot;, PauseAtStartupFile);
6032   } else {
6033     jio_snprintf(filename, MAX_PATH, &quot;./vm.paused.%d&quot;, current_process_id());
6034   }
6035 
6036   int fd = ::open(filename, O_WRONLY | O_CREAT | O_TRUNC, 0666);
6037   if (fd != -1) {
6038     struct stat buf;
6039     ::close(fd);
6040     while (::stat(filename, &amp;buf) == 0) {
6041       (void)::poll(NULL, 0, 100);
6042     }
6043   } else {
6044     jio_fprintf(stderr,
6045                 &quot;Could not open pause file &#39;%s&#39;, continuing immediately.\n&quot;, filename);
6046   }
6047 }
6048 
6049 extern char** environ;
6050 
6051 // Run the specified command in a separate process. Return its exit value,
6052 // or -1 on failure (e.g. can&#39;t fork a new process).
6053 // Unlike system(), this function can be called from signal handler. It
6054 // doesn&#39;t block SIGINT et al.
6055 int os::fork_and_exec(char* cmd, bool use_vfork_if_available) {
6056   const char * argv[4] = {&quot;sh&quot;, &quot;-c&quot;, cmd, NULL};
6057 
6058   pid_t pid ;
6059 
6060   if (use_vfork_if_available) {
6061     pid = vfork();
6062   } else {
6063     pid = fork();
6064   }
6065 
6066   if (pid &lt; 0) {
6067     // fork failed
6068     return -1;
6069 
6070   } else if (pid == 0) {
6071     // child process
6072 
6073     execve(&quot;/bin/sh&quot;, (char* const*)argv, environ);
6074 
6075     // execve failed
6076     _exit(-1);
6077 
6078   } else  {
6079     // copied from J2SE ..._waitForProcessExit() in UNIXProcess_md.c; we don&#39;t
6080     // care about the actual exit code, for now.
6081 
6082     int status;
6083 
6084     // Wait for the child process to exit.  This returns immediately if
6085     // the child has already exited. */
6086     while (waitpid(pid, &amp;status, 0) &lt; 0) {
6087       switch (errno) {
6088       case ECHILD: return 0;
6089       case EINTR: break;
6090       default: return -1;
6091       }
6092     }
6093 
6094     if (WIFEXITED(status)) {
6095       // The child exited normally; get its exit code.
6096       return WEXITSTATUS(status);
6097     } else if (WIFSIGNALED(status)) {
6098       // The child exited because of a signal
6099       // The best value to return is 0x80 + signal number,
6100       // because that is what all Unix shells do, and because
6101       // it allows callers to distinguish between process exit and
6102       // process death by signal.
6103       return 0x80 + WTERMSIG(status);
6104     } else {
6105       // Unknown exit code; pass it through
6106       return status;
6107     }
6108   }
6109 }
6110 
6111 // Get the default path to the core file
6112 // Returns the length of the string
6113 int os::get_core_path(char* buffer, size_t bufferSize) {
6114   /*
6115    * Max length of /proc/sys/kernel/core_pattern is 128 characters.
6116    * See https://www.kernel.org/doc/Documentation/sysctl/kernel.txt
6117    */
6118   const int core_pattern_len = 129;
6119   char core_pattern[core_pattern_len] = {0};
6120 
6121   int core_pattern_file = ::open(&quot;/proc/sys/kernel/core_pattern&quot;, O_RDONLY);
6122   if (core_pattern_file == -1) {
6123     return -1;
6124   }
6125 
6126   ssize_t ret = ::read(core_pattern_file, core_pattern, core_pattern_len);
6127   ::close(core_pattern_file);
6128   if (ret &lt;= 0 || ret &gt;= core_pattern_len || core_pattern[0] == &#39;\n&#39;) {
6129     return -1;
6130   }
6131   if (core_pattern[ret-1] == &#39;\n&#39;) {
6132     core_pattern[ret-1] = &#39;\0&#39;;
6133   } else {
6134     core_pattern[ret] = &#39;\0&#39;;
6135   }
6136 
6137   // Replace the %p in the core pattern with the process id. NOTE: we do this
6138   // only if the pattern doesn&#39;t start with &quot;|&quot;, and we support only one %p in
6139   // the pattern.
6140   char *pid_pos = strstr(core_pattern, &quot;%p&quot;);
6141   const char* tail = (pid_pos != NULL) ? (pid_pos + 2) : &quot;&quot;;  // skip over the &quot;%p&quot;
6142   int written;
6143 
6144   if (core_pattern[0] == &#39;/&#39;) {
6145     if (pid_pos != NULL) {
6146       *pid_pos = &#39;\0&#39;;
6147       written = jio_snprintf(buffer, bufferSize, &quot;%s%d%s&quot;, core_pattern,
6148                              current_process_id(), tail);
6149     } else {
6150       written = jio_snprintf(buffer, bufferSize, &quot;%s&quot;, core_pattern);
6151     }
6152   } else {
6153     char cwd[PATH_MAX];
6154 
6155     const char* p = get_current_directory(cwd, PATH_MAX);
6156     if (p == NULL) {
6157       return -1;
6158     }
6159 
6160     if (core_pattern[0] == &#39;|&#39;) {
6161       written = jio_snprintf(buffer, bufferSize,
6162                              &quot;\&quot;%s\&quot; (or dumping to %s/core.%d)&quot;,
6163                              &amp;core_pattern[1], p, current_process_id());
6164     } else if (pid_pos != NULL) {
6165       *pid_pos = &#39;\0&#39;;
6166       written = jio_snprintf(buffer, bufferSize, &quot;%s/%s%d%s&quot;, p, core_pattern,
6167                              current_process_id(), tail);
6168     } else {
6169       written = jio_snprintf(buffer, bufferSize, &quot;%s/%s&quot;, p, core_pattern);
6170     }
6171   }
6172 
6173   if (written &lt; 0) {
6174     return -1;
6175   }
6176 
6177   if (((size_t)written &lt; bufferSize) &amp;&amp; (pid_pos == NULL) &amp;&amp; (core_pattern[0] != &#39;|&#39;)) {
6178     int core_uses_pid_file = ::open(&quot;/proc/sys/kernel/core_uses_pid&quot;, O_RDONLY);
6179 
6180     if (core_uses_pid_file != -1) {
6181       char core_uses_pid = 0;
6182       ssize_t ret = ::read(core_uses_pid_file, &amp;core_uses_pid, 1);
6183       ::close(core_uses_pid_file);
6184 
6185       if (core_uses_pid == &#39;1&#39;) {
6186         jio_snprintf(buffer + written, bufferSize - written,
6187                                           &quot;.%d&quot;, current_process_id());
6188       }
6189     }
6190   }
6191 
6192   return strlen(buffer);
6193 }
6194 
6195 bool os::start_debugging(char *buf, int buflen) {
6196   int len = (int)strlen(buf);
6197   char *p = &amp;buf[len];
6198 
6199   jio_snprintf(p, buflen-len,
6200                &quot;\n\n&quot;
6201                &quot;Do you want to debug the problem?\n\n&quot;
6202                &quot;To debug, run &#39;gdb /proc/%d/exe %d&#39;; then switch to thread &quot; UINTX_FORMAT &quot; (&quot; INTPTR_FORMAT &quot;)\n&quot;
6203                &quot;Enter &#39;yes&#39; to launch gdb automatically (PATH must include gdb)\n&quot;
6204                &quot;Otherwise, press RETURN to abort...&quot;,
6205                os::current_process_id(), os::current_process_id(),
6206                os::current_thread_id(), os::current_thread_id());
6207 
6208   bool yes = os::message_box(&quot;Unexpected Error&quot;, buf);
6209 
6210   if (yes) {
6211     // yes, user asked VM to launch debugger
6212     jio_snprintf(buf, sizeof(char)*buflen, &quot;gdb /proc/%d/exe %d&quot;,
6213                  os::current_process_id(), os::current_process_id());
6214 
6215     os::fork_and_exec(buf);
6216     yes = false;
6217   }
6218   return yes;
6219 }
6220 
6221 
6222 // Java/Compiler thread:
6223 //
6224 //   Low memory addresses
6225 // P0 +------------------------+
6226 //    |                        |\  Java thread created by VM does not have glibc
6227 //    |    glibc guard page    | - guard page, attached Java thread usually has
6228 //    |                        |/  1 glibc guard page.
6229 // P1 +------------------------+ Thread::stack_base() - Thread::stack_size()
6230 //    |                        |\
6231 //    |  HotSpot Guard Pages   | - red, yellow and reserved pages
6232 //    |                        |/
6233 //    +------------------------+ JavaThread::stack_reserved_zone_base()
6234 //    |                        |\
6235 //    |      Normal Stack      | -
6236 //    |                        |/
6237 // P2 +------------------------+ Thread::stack_base()
6238 //
6239 // Non-Java thread:
6240 //
6241 //   Low memory addresses
6242 // P0 +------------------------+
6243 //    |                        |\
6244 //    |  glibc guard page      | - usually 1 page
6245 //    |                        |/
6246 // P1 +------------------------+ Thread::stack_base() - Thread::stack_size()
6247 //    |                        |\
6248 //    |      Normal Stack      | -
6249 //    |                        |/
6250 // P2 +------------------------+ Thread::stack_base()
6251 //
6252 // ** P1 (aka bottom) and size (P2 = P1 - size) are the address and stack size
6253 //    returned from pthread_attr_getstack().
6254 // ** Due to NPTL implementation error, linux takes the glibc guard page out
6255 //    of the stack size given in pthread_attr. We work around this for
6256 //    threads created by the VM. (We adapt bottom to be P1 and size accordingly.)
6257 //
6258 #ifndef ZERO
6259 static void current_stack_region(address * bottom, size_t * size) {
6260   if (os::is_primordial_thread()) {
6261     // primordial thread needs special handling because pthread_getattr_np()
6262     // may return bogus value.
6263     *bottom = os::Linux::initial_thread_stack_bottom();
6264     *size   = os::Linux::initial_thread_stack_size();
6265   } else {
6266     pthread_attr_t attr;
6267 
6268     int rslt = pthread_getattr_np(pthread_self(), &amp;attr);
6269 
6270     // JVM needs to know exact stack location, abort if it fails
6271     if (rslt != 0) {
6272       if (rslt == ENOMEM) {
6273         vm_exit_out_of_memory(0, OOM_MMAP_ERROR, &quot;pthread_getattr_np&quot;);
6274       } else {
6275         fatal(&quot;pthread_getattr_np failed with error = %d&quot;, rslt);
6276       }
6277     }
6278 
6279     if (pthread_attr_getstack(&amp;attr, (void **)bottom, size) != 0) {
6280       fatal(&quot;Cannot locate current stack attributes!&quot;);
6281     }
6282 
6283     // Work around NPTL stack guard error.
6284     size_t guard_size = 0;
6285     rslt = pthread_attr_getguardsize(&amp;attr, &amp;guard_size);
6286     if (rslt != 0) {
6287       fatal(&quot;pthread_attr_getguardsize failed with error = %d&quot;, rslt);
6288     }
6289     *bottom += guard_size;
6290     *size   -= guard_size;
6291 
6292     pthread_attr_destroy(&amp;attr);
6293 
6294   }
6295   assert(os::current_stack_pointer() &gt;= *bottom &amp;&amp;
6296          os::current_stack_pointer() &lt; *bottom + *size, &quot;just checking&quot;);
6297 }
6298 
6299 address os::current_stack_base() {
6300   address bottom;
6301   size_t size;
6302   current_stack_region(&amp;bottom, &amp;size);
6303   return (bottom + size);
6304 }
6305 
6306 size_t os::current_stack_size() {
6307   // This stack size includes the usable stack and HotSpot guard pages
6308   // (for the threads that have Hotspot guard pages).
6309   address bottom;
6310   size_t size;
6311   current_stack_region(&amp;bottom, &amp;size);
6312   return size;
6313 }
6314 #endif
6315 
6316 static inline struct timespec get_mtime(const char* filename) {
6317   struct stat st;
6318   int ret = os::stat(filename, &amp;st);
6319   assert(ret == 0, &quot;failed to stat() file &#39;%s&#39;: %s&quot;, filename, os::strerror(errno));
6320   return st.st_mtim;
6321 }
6322 
6323 int os::compare_file_modified_times(const char* file1, const char* file2) {
6324   struct timespec filetime1 = get_mtime(file1);
6325   struct timespec filetime2 = get_mtime(file2);
6326   int diff = filetime1.tv_sec - filetime2.tv_sec;
6327   if (diff == 0) {
6328     return filetime1.tv_nsec - filetime2.tv_nsec;
6329   }
6330   return diff;
6331 }
6332 
6333 bool os::supports_map_sync() {
6334   return true;
6335 }
6336 
6337 /////////////// Unit tests ///////////////
6338 
6339 #ifndef PRODUCT
6340 
6341 class TestReserveMemorySpecial : AllStatic {
6342  public:
6343   static void small_page_write(void* addr, size_t size) {
6344     size_t page_size = os::vm_page_size();
6345 
6346     char* end = (char*)addr + size;
6347     for (char* p = (char*)addr; p &lt; end; p += page_size) {
6348       *p = 1;
6349     }
6350   }
6351 
6352   static void test_reserve_memory_special_huge_tlbfs_only(size_t size) {
6353     if (!UseHugeTLBFS) {
6354       return;
6355     }
6356 
6357     char* addr = os::Linux::reserve_memory_special_huge_tlbfs_only(size, NULL, false);
6358 
6359     if (addr != NULL) {
6360       small_page_write(addr, size);
6361 
6362       os::Linux::release_memory_special_huge_tlbfs(addr, size);
6363     }
6364   }
6365 
6366   static void test_reserve_memory_special_huge_tlbfs_only() {
6367     if (!UseHugeTLBFS) {
6368       return;
6369     }
6370 
6371     size_t lp = os::large_page_size();
6372 
6373     for (size_t size = lp; size &lt;= lp * 10; size += lp) {
6374       test_reserve_memory_special_huge_tlbfs_only(size);
6375     }
6376   }
6377 
6378   static void test_reserve_memory_special_huge_tlbfs_mixed() {
6379     size_t lp = os::large_page_size();
6380     size_t ag = os::vm_allocation_granularity();
6381 
6382     // sizes to test
6383     const size_t sizes[] = {
6384       lp, lp + ag, lp + lp / 2, lp * 2,
6385       lp * 2 + ag, lp * 2 - ag, lp * 2 + lp / 2,
6386       lp * 10, lp * 10 + lp / 2
6387     };
6388     const int num_sizes = sizeof(sizes) / sizeof(size_t);
6389 
6390     // For each size/alignment combination, we test three scenarios:
6391     // 1) with req_addr == NULL
6392     // 2) with a non-null req_addr at which we expect to successfully allocate
6393     // 3) with a non-null req_addr which contains a pre-existing mapping, at which we
6394     //    expect the allocation to either fail or to ignore req_addr
6395 
6396     // Pre-allocate two areas; they shall be as large as the largest allocation
6397     //  and aligned to the largest alignment we will be testing.
6398     const size_t mapping_size = sizes[num_sizes - 1] * 2;
6399     char* const mapping1 = (char*) ::mmap(NULL, mapping_size,
6400       PROT_NONE, MAP_PRIVATE|MAP_ANONYMOUS|MAP_NORESERVE,
6401       -1, 0);
6402     assert(mapping1 != MAP_FAILED, &quot;should work&quot;);
6403 
6404     char* const mapping2 = (char*) ::mmap(NULL, mapping_size,
6405       PROT_NONE, MAP_PRIVATE|MAP_ANONYMOUS|MAP_NORESERVE,
6406       -1, 0);
6407     assert(mapping2 != MAP_FAILED, &quot;should work&quot;);
6408 
6409     // Unmap the first mapping, but leave the second mapping intact: the first
6410     // mapping will serve as a value for a &quot;good&quot; req_addr (case 2). The second
6411     // mapping, still intact, as &quot;bad&quot; req_addr (case 3).
6412     ::munmap(mapping1, mapping_size);
6413 
6414     // Case 1
6415     for (int i = 0; i &lt; num_sizes; i++) {
6416       const size_t size = sizes[i];
6417       for (size_t alignment = ag; is_aligned(size, alignment); alignment *= 2) {
6418         char* p = os::Linux::reserve_memory_special_huge_tlbfs_mixed(size, alignment, NULL, false);
6419         if (p != NULL) {
6420           assert(is_aligned(p, alignment), &quot;must be&quot;);
6421           small_page_write(p, size);
6422           os::Linux::release_memory_special_huge_tlbfs(p, size);
6423         }
6424       }
6425     }
6426 
6427     // Case 2
6428     for (int i = 0; i &lt; num_sizes; i++) {
6429       const size_t size = sizes[i];
6430       for (size_t alignment = ag; is_aligned(size, alignment); alignment *= 2) {
6431         char* const req_addr = align_up(mapping1, alignment);
6432         char* p = os::Linux::reserve_memory_special_huge_tlbfs_mixed(size, alignment, req_addr, false);
6433         if (p != NULL) {
6434           assert(p == req_addr, &quot;must be&quot;);
6435           small_page_write(p, size);
6436           os::Linux::release_memory_special_huge_tlbfs(p, size);
6437         }
6438       }
6439     }
6440 
6441     // Case 3
6442     for (int i = 0; i &lt; num_sizes; i++) {
6443       const size_t size = sizes[i];
6444       for (size_t alignment = ag; is_aligned(size, alignment); alignment *= 2) {
6445         char* const req_addr = align_up(mapping2, alignment);
6446         char* p = os::Linux::reserve_memory_special_huge_tlbfs_mixed(size, alignment, req_addr, false);
6447         // as the area around req_addr contains already existing mappings, the API should always
6448         // return NULL (as per contract, it cannot return another address)
6449         assert(p == NULL, &quot;must be&quot;);
6450       }
6451     }
6452 
6453     ::munmap(mapping2, mapping_size);
6454 
6455   }
6456 
6457   static void test_reserve_memory_special_huge_tlbfs() {
6458     if (!UseHugeTLBFS) {
6459       return;
6460     }
6461 
6462     test_reserve_memory_special_huge_tlbfs_only();
6463     test_reserve_memory_special_huge_tlbfs_mixed();
6464   }
6465 
6466   static void test_reserve_memory_special_shm(size_t size, size_t alignment) {
6467     if (!UseSHM) {
6468       return;
6469     }
6470 
6471     char* addr = os::Linux::reserve_memory_special_shm(size, alignment, NULL, false);
6472 
6473     if (addr != NULL) {
6474       assert(is_aligned(addr, alignment), &quot;Check&quot;);
6475       assert(is_aligned(addr, os::large_page_size()), &quot;Check&quot;);
6476 
6477       small_page_write(addr, size);
6478 
6479       os::Linux::release_memory_special_shm(addr, size);
6480     }
6481   }
6482 
6483   static void test_reserve_memory_special_shm() {
6484     size_t lp = os::large_page_size();
6485     size_t ag = os::vm_allocation_granularity();
6486 
6487     for (size_t size = ag; size &lt; lp * 3; size += ag) {
6488       for (size_t alignment = ag; is_aligned(size, alignment); alignment *= 2) {
6489         test_reserve_memory_special_shm(size, alignment);
6490       }
6491     }
6492   }
6493 
6494   static void test() {
6495     test_reserve_memory_special_huge_tlbfs();
6496     test_reserve_memory_special_shm();
6497   }
6498 };
6499 
6500 void TestReserveMemorySpecial_test() {
6501   TestReserveMemorySpecial::test();
6502 }
6503 
6504 #endif
    </pre>
  </body>
</html>