<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/tools/launcher/TestHelper.java</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="../../TEST.ROOT.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>test/jdk/tools/launcher/TestHelper.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2008, 2014, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
</pre>
<hr />
<pre>
 85             System.getProperty(&quot;sun.arch.data.model&quot;).equals(&quot;64&quot;);
 86     static final boolean is32Bit =
 87             System.getProperty(&quot;sun.arch.data.model&quot;).equals(&quot;32&quot;);
 88     static final boolean isSolaris =
 89             System.getProperty(&quot;os.name&quot;, &quot;unknown&quot;).startsWith(&quot;SunOS&quot;);
 90     static final boolean isLinux =
 91             System.getProperty(&quot;os.name&quot;, &quot;unknown&quot;).startsWith(&quot;Linux&quot;);
 92     static final boolean isAIX =
 93             System.getProperty(&quot;os.name&quot;, &quot;unknown&quot;).startsWith(&quot;AIX&quot;);
 94     static final boolean isMusl = isMuslLibc();
 95     static final String LIBJVM = isWindows
 96                         ? &quot;jvm.dll&quot;
 97                         : &quot;libjvm&quot; + (isMacOSX ? &quot;.dylib&quot; : &quot;.so&quot;);
 98     static final boolean isExpandedSharedLibraryPath = isAIX || isMusl;
 99 
100     static final boolean isSparc = System.getProperty(&quot;os.arch&quot;).startsWith(&quot;sparc&quot;);
101 
102     // make a note of the golden default locale
103     static final Locale DefaultLocale = Locale.getDefault();
104 
<span class="line-modified">105     static final String JAVA_FILE_EXT  = &quot;.java&quot;;</span>
<span class="line-modified">106     static final String CLASS_FILE_EXT = &quot;.class&quot;;</span>
<span class="line-modified">107     static final String JAR_FILE_EXT   = &quot;.jar&quot;;</span>
<span class="line-modified">108     static final String EXE_FILE_EXT   = &quot;.exe&quot;;</span>


109     static final String JLDEBUG_KEY     = &quot;_JAVA_LAUNCHER_DEBUG&quot;;
110     static final String EXPECTED_MARKER = &quot;TRACER_MARKER:About to EXEC&quot;;
111     static final String TEST_PREFIX     = &quot;###TestError###: &quot;;
112 
113     static int testExitValue = 0;
114 
115     static {
116         String tmp = System.getProperty(&quot;test.classes&quot;, null);
117         if (tmp == null) {
118             throw new Error(&quot;property test.classes not defined ??&quot;);
119         }
120         TEST_CLASSES_DIR = new File(tmp).getAbsoluteFile();
121 
122         tmp = System.getProperty(&quot;test.src&quot;, null);
123         if (tmp == null) {
124             throw new Error(&quot;property test.src not defined ??&quot;);
125         }
126         TEST_SOURCES_DIR = new File(tmp).getAbsoluteFile();
127 
128         if (is64Bit &amp;&amp; is32Bit) {
</pre>
<hr />
<pre>
540      * Check if we run with musl libc.
541      *
542      * @return true if we run with musl libc.
543      */
544     private static boolean isMuslLibc() {
545         try {
546             ProcessBuilder pb = new ProcessBuilder(&quot;ldd&quot;, &quot;--version&quot;);
547             pb.redirectErrorStream(true);
548             final Process p = pb.start();
549             try (BufferedReader br = new BufferedReader(new InputStreamReader(p.getInputStream()))) {
550                 return br.lines()
551                         .findFirst()
552                         .filter(line -&gt; line.contains(&quot;musl&quot;))
553                         .isPresent();
554             }
555         } catch (Exception ignore) {
556         }
557         return false;
558     }
559 





































560     /*
561      * A class to encapsulate the test results and stuff, with some ease
562      * of use methods to check the test results.
563      */
564     static class TestResult {
565         PrintWriter status;
566         StringWriter sw;
567         int exitValue;
568         List&lt;String&gt; testOutput;
569         Map&lt;String, String&gt; env;
570         Throwable t;
571         boolean testStatus;
572 
573         public TestResult(String str, int rv, List&lt;String&gt; oList,
574                 Map&lt;String, String&gt; env, Throwable t) {
575             sw = new StringWriter();
576             status = new PrintWriter(sw);
577             status.println(&quot;Executed command: &quot; + str + &quot;\n&quot;);
578             exitValue = rv;
579             testOutput = oList;
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2008, 2020, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
</pre>
<hr />
<pre>
 85             System.getProperty(&quot;sun.arch.data.model&quot;).equals(&quot;64&quot;);
 86     static final boolean is32Bit =
 87             System.getProperty(&quot;sun.arch.data.model&quot;).equals(&quot;32&quot;);
 88     static final boolean isSolaris =
 89             System.getProperty(&quot;os.name&quot;, &quot;unknown&quot;).startsWith(&quot;SunOS&quot;);
 90     static final boolean isLinux =
 91             System.getProperty(&quot;os.name&quot;, &quot;unknown&quot;).startsWith(&quot;Linux&quot;);
 92     static final boolean isAIX =
 93             System.getProperty(&quot;os.name&quot;, &quot;unknown&quot;).startsWith(&quot;AIX&quot;);
 94     static final boolean isMusl = isMuslLibc();
 95     static final String LIBJVM = isWindows
 96                         ? &quot;jvm.dll&quot;
 97                         : &quot;libjvm&quot; + (isMacOSX ? &quot;.dylib&quot; : &quot;.so&quot;);
 98     static final boolean isExpandedSharedLibraryPath = isAIX || isMusl;
 99 
100     static final boolean isSparc = System.getProperty(&quot;os.arch&quot;).startsWith(&quot;sparc&quot;);
101 
102     // make a note of the golden default locale
103     static final Locale DefaultLocale = Locale.getDefault();
104 
<span class="line-modified">105     static final String JAVA_FILE_EXT   = &quot;.java&quot;;</span>
<span class="line-modified">106     static final String CLASS_FILE_EXT  = &quot;.class&quot;;</span>
<span class="line-modified">107     static final String JAR_FILE_EXT    = &quot;.jar&quot;;</span>
<span class="line-modified">108     static final String EXE_FILE_EXT    = &quot;.exe&quot;;</span>
<span class="line-added">109     static final String MAC_DSYM_EXT    = &quot;.dsym&quot;;</span>
<span class="line-added">110     static final String NIX_DBGINFO_EXT = &quot;.debuginfo&quot;;</span>
111     static final String JLDEBUG_KEY     = &quot;_JAVA_LAUNCHER_DEBUG&quot;;
112     static final String EXPECTED_MARKER = &quot;TRACER_MARKER:About to EXEC&quot;;
113     static final String TEST_PREFIX     = &quot;###TestError###: &quot;;
114 
115     static int testExitValue = 0;
116 
117     static {
118         String tmp = System.getProperty(&quot;test.classes&quot;, null);
119         if (tmp == null) {
120             throw new Error(&quot;property test.classes not defined ??&quot;);
121         }
122         TEST_CLASSES_DIR = new File(tmp).getAbsoluteFile();
123 
124         tmp = System.getProperty(&quot;test.src&quot;, null);
125         if (tmp == null) {
126             throw new Error(&quot;property test.src not defined ??&quot;);
127         }
128         TEST_SOURCES_DIR = new File(tmp).getAbsoluteFile();
129 
130         if (is64Bit &amp;&amp; is32Bit) {
</pre>
<hr />
<pre>
542      * Check if we run with musl libc.
543      *
544      * @return true if we run with musl libc.
545      */
546     private static boolean isMuslLibc() {
547         try {
548             ProcessBuilder pb = new ProcessBuilder(&quot;ldd&quot;, &quot;--version&quot;);
549             pb.redirectErrorStream(true);
550             final Process p = pb.start();
551             try (BufferedReader br = new BufferedReader(new InputStreamReader(p.getInputStream()))) {
552                 return br.lines()
553                         .findFirst()
554                         .filter(line -&gt; line.contains(&quot;musl&quot;))
555                         .isPresent();
556             }
557         } catch (Exception ignore) {
558         }
559         return false;
560     }
561 
<span class="line-added">562     static class ToolFilter implements FileFilter {</span>
<span class="line-added">563         final List&lt;String&gt; exclude = new ArrayList&lt;&gt;();</span>
<span class="line-added">564         protected ToolFilter(String... exclude) {</span>
<span class="line-added">565             for (String x : exclude) {</span>
<span class="line-added">566                 String str = x + ((isWindows) ? EXE_FILE_EXT : &quot;&quot;);</span>
<span class="line-added">567                 this.exclude.add(str.toLowerCase());</span>
<span class="line-added">568             }</span>
<span class="line-added">569         }</span>
<span class="line-added">570 </span>
<span class="line-added">571         @Override</span>
<span class="line-added">572         public boolean accept(File pathname) {</span>
<span class="line-added">573             if (!pathname.isFile() || !pathname.canExecute()) {</span>
<span class="line-added">574                 return false;</span>
<span class="line-added">575             }</span>
<span class="line-added">576             String name = pathname.getName().toLowerCase();</span>
<span class="line-added">577             if (isWindows) {</span>
<span class="line-added">578                 if (!name.endsWith(EXE_FILE_EXT)) {</span>
<span class="line-added">579                     return false;</span>
<span class="line-added">580                 }</span>
<span class="line-added">581             } else if (isMacOSX) {</span>
<span class="line-added">582                 if (name.endsWith(MAC_DSYM_EXT)) {</span>
<span class="line-added">583                     return false;</span>
<span class="line-added">584                 }</span>
<span class="line-added">585             } else {</span>
<span class="line-added">586                 if (name.endsWith(NIX_DBGINFO_EXT)) {</span>
<span class="line-added">587                     return false;</span>
<span class="line-added">588                 }</span>
<span class="line-added">589             }</span>
<span class="line-added">590             for (String x : exclude) {</span>
<span class="line-added">591                 if (name.endsWith(x)) {</span>
<span class="line-added">592                     return false;</span>
<span class="line-added">593                 }</span>
<span class="line-added">594             }</span>
<span class="line-added">595             return true;</span>
<span class="line-added">596         }</span>
<span class="line-added">597     }</span>
<span class="line-added">598 </span>
599     /*
600      * A class to encapsulate the test results and stuff, with some ease
601      * of use methods to check the test results.
602      */
603     static class TestResult {
604         PrintWriter status;
605         StringWriter sw;
606         int exitValue;
607         List&lt;String&gt; testOutput;
608         Map&lt;String, String&gt; env;
609         Throwable t;
610         boolean testStatus;
611 
612         public TestResult(String str, int rv, List&lt;String&gt; oList,
613                 Map&lt;String, String&gt; env, Throwable t) {
614             sw = new StringWriter();
615             status = new PrintWriter(sw);
616             status.println(&quot;Executed command: &quot; + str + &quot;\n&quot;);
617             exitValue = rv;
618             testOutput = oList;
</pre>
</td>
</tr>
</table>
<center><a href="../../TEST.ROOT.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>