<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/os/linux/os_linux.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 1999, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 // no precompiled headers
  26 #include &quot;jvm.h&quot;
  27 #include &quot;classfile/classLoader.hpp&quot;
  28 #include &quot;classfile/systemDictionary.hpp&quot;
  29 #include &quot;classfile/vmSymbols.hpp&quot;
  30 #include &quot;code/icBuffer.hpp&quot;
  31 #include &quot;code/vtableStubs.hpp&quot;
  32 #include &quot;compiler/compileBroker.hpp&quot;
  33 #include &quot;compiler/disassembler.hpp&quot;
  34 #include &quot;interpreter/interpreter.hpp&quot;
  35 #include &quot;logging/log.hpp&quot;
  36 #include &quot;logging/logStream.hpp&quot;
  37 #include &quot;memory/allocation.inline.hpp&quot;
  38 #include &quot;memory/filemap.hpp&quot;
  39 #include &quot;oops/oop.inline.hpp&quot;
  40 #include &quot;os_linux.inline.hpp&quot;
  41 #include &quot;os_posix.inline.hpp&quot;
  42 #include &quot;os_share_linux.hpp&quot;
  43 #include &quot;osContainer_linux.hpp&quot;
  44 #include &quot;prims/jniFastGetField.hpp&quot;
  45 #include &quot;prims/jvm_misc.hpp&quot;
  46 #include &quot;runtime/arguments.hpp&quot;
  47 #include &quot;runtime/atomic.hpp&quot;
  48 #include &quot;runtime/extendedPC.hpp&quot;
  49 #include &quot;runtime/globals.hpp&quot;
  50 #include &quot;runtime/interfaceSupport.inline.hpp&quot;
  51 #include &quot;runtime/init.hpp&quot;
  52 #include &quot;runtime/java.hpp&quot;
  53 #include &quot;runtime/javaCalls.hpp&quot;
  54 #include &quot;runtime/mutexLocker.hpp&quot;
  55 #include &quot;runtime/objectMonitor.hpp&quot;
  56 #include &quot;runtime/osThread.hpp&quot;
  57 #include &quot;runtime/perfMemory.hpp&quot;
  58 #include &quot;runtime/sharedRuntime.hpp&quot;
  59 #include &quot;runtime/statSampler.hpp&quot;
  60 #include &quot;runtime/stubRoutines.hpp&quot;
  61 #include &quot;runtime/thread.inline.hpp&quot;
  62 #include &quot;runtime/threadCritical.hpp&quot;
  63 #include &quot;runtime/threadSMR.hpp&quot;
  64 #include &quot;runtime/timer.hpp&quot;
  65 #include &quot;runtime/vm_version.hpp&quot;
  66 #include &quot;semaphore_posix.hpp&quot;
  67 #include &quot;services/attachListener.hpp&quot;
  68 #include &quot;services/memTracker.hpp&quot;
  69 #include &quot;services/runtimeService.hpp&quot;
  70 #include &quot;utilities/align.hpp&quot;
  71 #include &quot;utilities/decoder.hpp&quot;
  72 #include &quot;utilities/defaultStream.hpp&quot;
  73 #include &quot;utilities/events.hpp&quot;
  74 #include &quot;utilities/elfFile.hpp&quot;
  75 #include &quot;utilities/growableArray.hpp&quot;
  76 #include &quot;utilities/macros.hpp&quot;
  77 #include &quot;utilities/powerOfTwo.hpp&quot;
  78 #include &quot;utilities/vmError.hpp&quot;
  79 
  80 // put OS-includes here
  81 # include &lt;sys/types.h&gt;
  82 # include &lt;sys/mman.h&gt;
  83 # include &lt;sys/stat.h&gt;
  84 # include &lt;sys/select.h&gt;
  85 # include &lt;pthread.h&gt;
  86 # include &lt;signal.h&gt;
  87 # include &lt;endian.h&gt;
  88 # include &lt;errno.h&gt;
  89 # include &lt;dlfcn.h&gt;
  90 # include &lt;stdio.h&gt;
  91 # include &lt;unistd.h&gt;
  92 # include &lt;sys/resource.h&gt;
  93 # include &lt;pthread.h&gt;
  94 # include &lt;sys/stat.h&gt;
  95 # include &lt;sys/time.h&gt;
  96 # include &lt;sys/times.h&gt;
  97 # include &lt;sys/utsname.h&gt;
  98 # include &lt;sys/socket.h&gt;
  99 # include &lt;sys/wait.h&gt;
 100 # include &lt;pwd.h&gt;
 101 # include &lt;poll.h&gt;
 102 # include &lt;fcntl.h&gt;
 103 # include &lt;string.h&gt;
 104 # include &lt;syscall.h&gt;
 105 # include &lt;sys/sysinfo.h&gt;
<a name="1" id="anc1"></a>
 106 # include &lt;sys/ipc.h&gt;
 107 # include &lt;sys/shm.h&gt;
 108 # include &lt;link.h&gt;
 109 # include &lt;stdint.h&gt;
 110 # include &lt;inttypes.h&gt;
 111 # include &lt;sys/ioctl.h&gt;
 112 
 113 #ifndef _GNU_SOURCE
 114   #define _GNU_SOURCE
 115   #include &lt;sched.h&gt;
 116   #undef _GNU_SOURCE
 117 #else
 118   #include &lt;sched.h&gt;
 119 #endif
 120 
 121 // if RUSAGE_THREAD for getrusage() has not been defined, do it here. The code calling
 122 // getrusage() is prepared to handle the associated failure.
 123 #ifndef RUSAGE_THREAD
 124   #define RUSAGE_THREAD   (1)               /* only the calling thread */
 125 #endif
 126 
 127 #define MAX_PATH    (2 * K)
 128 
 129 #define MAX_SECS 100000000
 130 
 131 // for timer info max values which include all bits
 132 #define ALL_64_BITS CONST64(0xFFFFFFFFFFFFFFFF)
 133 
 134 enum CoredumpFilterBit {
 135   FILE_BACKED_PVT_BIT = 1 &lt;&lt; 2,
 136   FILE_BACKED_SHARED_BIT = 1 &lt;&lt; 3,
 137   LARGEPAGES_BIT = 1 &lt;&lt; 6,
 138   DAX_SHARED_BIT = 1 &lt;&lt; 8
 139 };
 140 
 141 ////////////////////////////////////////////////////////////////////////////////
 142 // global variables
 143 julong os::Linux::_physical_memory = 0;
 144 
 145 address   os::Linux::_initial_thread_stack_bottom = NULL;
 146 uintptr_t os::Linux::_initial_thread_stack_size   = 0;
 147 
 148 int (*os::Linux::_pthread_getcpuclockid)(pthread_t, clockid_t *) = NULL;
 149 int (*os::Linux::_pthread_setname_np)(pthread_t, const char*) = NULL;
 150 pthread_t os::Linux::_main_thread;
 151 int os::Linux::_page_size = -1;
 152 bool os::Linux::_supports_fast_thread_cpu_time = false;
<a name="2" id="anc2"></a><span class="line-modified"> 153 const char * os::Linux::_glibc_version = &quot;unknown&quot;;</span>
<span class="line-modified"> 154 const char * os::Linux::_libpthread_version = &quot;unknown&quot;;</span>
 155 
 156 static jlong initial_time_count=0;
 157 
 158 static int clock_tics_per_sec = 100;
 159 
 160 // If the VM might have been created on the primordial thread, we need to resolve the
 161 // primordial thread stack bounds and check if the current thread might be the
 162 // primordial thread in places. If we know that the primordial thread is never used,
 163 // such as when the VM was created by one of the standard java launchers, we can
 164 // avoid this
 165 static bool suppress_primordial_thread_resolution = false;
 166 
 167 // For diagnostics to print a message once. see run_periodic_checks
 168 static sigset_t check_signal_done;
 169 static bool check_signals = true;
 170 
 171 // Signal number used to suspend/resume a thread
 172 
 173 // do not use any signal number less than SIGSEGV, see 4355769
 174 static int SR_signum = SIGUSR2;
 175 sigset_t SR_sigset;
 176 
 177 // utility functions
 178 
 179 static int SR_initialize();
 180 
 181 julong os::available_memory() {
 182   return Linux::available_memory();
 183 }
 184 
 185 julong os::Linux::available_memory() {
 186   // values in struct sysinfo are &quot;unsigned long&quot;
 187   struct sysinfo si;
 188   julong avail_mem;
 189 
 190   if (OSContainer::is_containerized()) {
 191     jlong mem_limit, mem_usage;
 192     if ((mem_limit = OSContainer::memory_limit_in_bytes()) &lt; 1) {
 193       log_debug(os, container)(&quot;container memory limit %s: &quot; JLONG_FORMAT &quot;, using host value&quot;,
 194                              mem_limit == OSCONTAINER_ERROR ? &quot;failed&quot; : &quot;unlimited&quot;, mem_limit);
 195     }
 196     if (mem_limit &gt; 0 &amp;&amp; (mem_usage = OSContainer::memory_usage_in_bytes()) &lt; 1) {
 197       log_debug(os, container)(&quot;container memory usage failed: &quot; JLONG_FORMAT &quot;, using host value&quot;, mem_usage);
 198     }
 199     if (mem_limit &gt; 0 &amp;&amp; mem_usage &gt; 0 ) {
 200       avail_mem = mem_limit &gt; mem_usage ? (julong)mem_limit - (julong)mem_usage : 0;
 201       log_trace(os)(&quot;available container memory: &quot; JULONG_FORMAT, avail_mem);
 202       return avail_mem;
 203     }
 204   }
 205 
 206   sysinfo(&amp;si);
 207   avail_mem = (julong)si.freeram * si.mem_unit;
 208   log_trace(os)(&quot;available memory: &quot; JULONG_FORMAT, avail_mem);
 209   return avail_mem;
 210 }
 211 
 212 julong os::physical_memory() {
 213   jlong phys_mem = 0;
 214   if (OSContainer::is_containerized()) {
 215     jlong mem_limit;
 216     if ((mem_limit = OSContainer::memory_limit_in_bytes()) &gt; 0) {
 217       log_trace(os)(&quot;total container memory: &quot; JLONG_FORMAT, mem_limit);
 218       return mem_limit;
 219     }
 220     log_debug(os, container)(&quot;container memory limit %s: &quot; JLONG_FORMAT &quot;, using host value&quot;,
 221                             mem_limit == OSCONTAINER_ERROR ? &quot;failed&quot; : &quot;unlimited&quot;, mem_limit);
 222   }
 223 
 224   phys_mem = Linux::physical_memory();
 225   log_trace(os)(&quot;total system memory: &quot; JLONG_FORMAT, phys_mem);
 226   return phys_mem;
 227 }
 228 
 229 static uint64_t initial_total_ticks = 0;
 230 static uint64_t initial_steal_ticks = 0;
 231 static bool     has_initial_tick_info = false;
 232 
 233 static void next_line(FILE *f) {
 234   int c;
 235   do {
 236     c = fgetc(f);
 237   } while (c != &#39;\n&#39; &amp;&amp; c != EOF);
 238 }
 239 
 240 bool os::Linux::get_tick_information(CPUPerfTicks* pticks, int which_logical_cpu) {
 241   FILE*         fh;
 242   uint64_t      userTicks, niceTicks, systemTicks, idleTicks;
 243   // since at least kernel 2.6 : iowait: time waiting for I/O to complete
 244   // irq: time  servicing interrupts; softirq: time servicing softirqs
 245   uint64_t      iowTicks = 0, irqTicks = 0, sirqTicks= 0;
 246   // steal (since kernel 2.6.11): time spent in other OS when running in a virtualized environment
 247   uint64_t      stealTicks = 0;
 248   // guest (since kernel 2.6.24): time spent running a virtual CPU for guest OS under the
 249   // control of the Linux kernel
 250   uint64_t      guestNiceTicks = 0;
 251   int           logical_cpu = -1;
 252   const int     required_tickinfo_count = (which_logical_cpu == -1) ? 4 : 5;
 253   int           n;
 254 
 255   memset(pticks, 0, sizeof(CPUPerfTicks));
 256 
 257   if ((fh = fopen(&quot;/proc/stat&quot;, &quot;r&quot;)) == NULL) {
 258     return false;
 259   }
 260 
 261   if (which_logical_cpu == -1) {
 262     n = fscanf(fh, &quot;cpu &quot; UINT64_FORMAT &quot; &quot; UINT64_FORMAT &quot; &quot; UINT64_FORMAT &quot; &quot;
 263             UINT64_FORMAT &quot; &quot; UINT64_FORMAT &quot; &quot; UINT64_FORMAT &quot; &quot; UINT64_FORMAT &quot; &quot;
 264             UINT64_FORMAT &quot; &quot; UINT64_FORMAT &quot; &quot;,
 265             &amp;userTicks, &amp;niceTicks, &amp;systemTicks, &amp;idleTicks,
 266             &amp;iowTicks, &amp;irqTicks, &amp;sirqTicks,
 267             &amp;stealTicks, &amp;guestNiceTicks);
 268   } else {
 269     // Move to next line
 270     next_line(fh);
 271 
 272     // find the line for requested cpu faster to just iterate linefeeds?
 273     for (int i = 0; i &lt; which_logical_cpu; i++) {
 274       next_line(fh);
 275     }
 276 
 277     n = fscanf(fh, &quot;cpu%u &quot; UINT64_FORMAT &quot; &quot; UINT64_FORMAT &quot; &quot; UINT64_FORMAT &quot; &quot;
 278                UINT64_FORMAT &quot; &quot; UINT64_FORMAT &quot; &quot; UINT64_FORMAT &quot; &quot; UINT64_FORMAT &quot; &quot;
 279                UINT64_FORMAT &quot; &quot; UINT64_FORMAT &quot; &quot;,
 280                &amp;logical_cpu, &amp;userTicks, &amp;niceTicks,
 281                &amp;systemTicks, &amp;idleTicks, &amp;iowTicks, &amp;irqTicks, &amp;sirqTicks,
 282                &amp;stealTicks, &amp;guestNiceTicks);
 283   }
 284 
 285   fclose(fh);
 286   if (n &lt; required_tickinfo_count || logical_cpu != which_logical_cpu) {
 287     return false;
 288   }
 289   pticks-&gt;used       = userTicks + niceTicks;
 290   pticks-&gt;usedKernel = systemTicks + irqTicks + sirqTicks;
 291   pticks-&gt;total      = userTicks + niceTicks + systemTicks + idleTicks +
 292                        iowTicks + irqTicks + sirqTicks + stealTicks + guestNiceTicks;
 293 
 294   if (n &gt; required_tickinfo_count + 3) {
 295     pticks-&gt;steal = stealTicks;
 296     pticks-&gt;has_steal_ticks = true;
 297   } else {
 298     pticks-&gt;steal = 0;
 299     pticks-&gt;has_steal_ticks = false;
 300   }
 301 
 302   return true;
 303 }
 304 
 305 // Return true if user is running as root.
 306 
 307 bool os::have_special_privileges() {
 308   static bool init = false;
 309   static bool privileges = false;
 310   if (!init) {
 311     privileges = (getuid() != geteuid()) || (getgid() != getegid());
 312     init = true;
 313   }
 314   return privileges;
 315 }
 316 
 317 
 318 #ifndef SYS_gettid
 319 // i386: 224, ia64: 1105, amd64: 186, sparc 143
 320   #ifdef __ia64__
 321     #define SYS_gettid 1105
 322   #else
 323     #ifdef __i386__
 324       #define SYS_gettid 224
 325     #else
 326       #ifdef __amd64__
 327         #define SYS_gettid 186
 328       #else
 329         #ifdef __sparc__
 330           #define SYS_gettid 143
 331         #else
 332           #error define gettid for the arch
 333         #endif
 334       #endif
 335     #endif
 336   #endif
 337 #endif
 338 
 339 
 340 // pid_t gettid()
 341 //
 342 // Returns the kernel thread id of the currently running thread. Kernel
 343 // thread id is used to access /proc.
 344 pid_t os::Linux::gettid() {
 345   int rslt = syscall(SYS_gettid);
 346   assert(rslt != -1, &quot;must be.&quot;); // old linuxthreads implementation?
 347   return (pid_t)rslt;
 348 }
 349 
 350 // Most versions of linux have a bug where the number of processors are
 351 // determined by looking at the /proc file system.  In a chroot environment,
 352 // the system call returns 1.
 353 static bool unsafe_chroot_detected = false;
 354 static const char *unstable_chroot_error = &quot;/proc file system not found.\n&quot;
 355                      &quot;Java may be unstable running multithreaded in a chroot &quot;
 356                      &quot;environment on Linux when /proc filesystem is not mounted.&quot;;
 357 
 358 void os::Linux::initialize_system_info() {
 359   set_processor_count(sysconf(_SC_NPROCESSORS_CONF));
 360   if (processor_count() == 1) {
 361     pid_t pid = os::Linux::gettid();
 362     char fname[32];
 363     jio_snprintf(fname, sizeof(fname), &quot;/proc/%d&quot;, pid);
 364     FILE *fp = fopen(fname, &quot;r&quot;);
 365     if (fp == NULL) {
 366       unsafe_chroot_detected = true;
 367     } else {
 368       fclose(fp);
 369     }
 370   }
 371   _physical_memory = (julong)sysconf(_SC_PHYS_PAGES) * (julong)sysconf(_SC_PAGESIZE);
 372   assert(processor_count() &gt; 0, &quot;linux error&quot;);
 373 }
 374 
 375 void os::init_system_properties_values() {
 376   // The next steps are taken in the product version:
 377   //
 378   // Obtain the JAVA_HOME value from the location of libjvm.so.
 379   // This library should be located at:
 380   // &lt;JAVA_HOME&gt;/lib/{client|server}/libjvm.so.
 381   //
 382   // If &quot;/jre/lib/&quot; appears at the right place in the path, then we
 383   // assume libjvm.so is installed in a JDK and we use this path.
 384   //
 385   // Otherwise exit with message: &quot;Could not create the Java virtual machine.&quot;
 386   //
 387   // The following extra steps are taken in the debugging version:
 388   //
 389   // If &quot;/jre/lib/&quot; does NOT appear at the right place in the path
 390   // instead of exit check for $JAVA_HOME environment variable.
 391   //
 392   // If it is defined and we are able to locate $JAVA_HOME/jre/lib/&lt;arch&gt;,
 393   // then we append a fake suffix &quot;hotspot/libjvm.so&quot; to this path so
 394   // it looks like libjvm.so is installed there
 395   // &lt;JAVA_HOME&gt;/jre/lib/&lt;arch&gt;/hotspot/libjvm.so.
 396   //
 397   // Otherwise exit.
 398   //
 399   // Important note: if the location of libjvm.so changes this
 400   // code needs to be changed accordingly.
 401 
 402   // See ld(1):
 403   //      The linker uses the following search paths to locate required
 404   //      shared libraries:
 405   //        1: ...
 406   //        ...
 407   //        7: The default directories, normally /lib and /usr/lib.
 408 #ifndef OVERRIDE_LIBPATH
 409   #if defined(AMD64) || (defined(_LP64) &amp;&amp; defined(SPARC)) || defined(PPC64) || defined(S390)
 410     #define DEFAULT_LIBPATH &quot;/usr/lib64:/lib64:/lib:/usr/lib&quot;
 411   #else
 412     #define DEFAULT_LIBPATH &quot;/lib:/usr/lib&quot;
 413   #endif
 414 #else
 415   #define DEFAULT_LIBPATH OVERRIDE_LIBPATH
 416 #endif
 417 
 418 // Base path of extensions installed on the system.
 419 #define SYS_EXT_DIR     &quot;/usr/java/packages&quot;
 420 #define EXTENSIONS_DIR  &quot;/lib/ext&quot;
 421 
 422   // Buffer that fits several sprintfs.
 423   // Note that the space for the colon and the trailing null are provided
 424   // by the nulls included by the sizeof operator.
 425   const size_t bufsize =
 426     MAX2((size_t)MAXPATHLEN,  // For dll_dir &amp; friends.
 427          (size_t)MAXPATHLEN + sizeof(EXTENSIONS_DIR) + sizeof(SYS_EXT_DIR) + sizeof(EXTENSIONS_DIR)); // extensions dir
 428   char *buf = NEW_C_HEAP_ARRAY(char, bufsize, mtInternal);
 429 
 430   // sysclasspath, java_home, dll_dir
 431   {
 432     char *pslash;
 433     os::jvm_path(buf, bufsize);
 434 
 435     // Found the full path to libjvm.so.
 436     // Now cut the path to &lt;java_home&gt;/jre if we can.
 437     pslash = strrchr(buf, &#39;/&#39;);
 438     if (pslash != NULL) {
 439       *pslash = &#39;\0&#39;;            // Get rid of /libjvm.so.
 440     }
 441     pslash = strrchr(buf, &#39;/&#39;);
 442     if (pslash != NULL) {
 443       *pslash = &#39;\0&#39;;            // Get rid of /{client|server|hotspot}.
 444     }
 445     Arguments::set_dll_dir(buf);
 446 
 447     if (pslash != NULL) {
 448       pslash = strrchr(buf, &#39;/&#39;);
 449       if (pslash != NULL) {
 450         *pslash = &#39;\0&#39;;        // Get rid of /lib.
 451       }
 452     }
 453     Arguments::set_java_home(buf);
 454     if (!set_boot_path(&#39;/&#39;, &#39;:&#39;)) {
 455       vm_exit_during_initialization(&quot;Failed setting boot class path.&quot;, NULL);
 456     }
 457   }
 458 
 459   // Where to look for native libraries.
 460   //
 461   // Note: Due to a legacy implementation, most of the library path
 462   // is set in the launcher. This was to accomodate linking restrictions
 463   // on legacy Linux implementations (which are no longer supported).
 464   // Eventually, all the library path setting will be done here.
 465   //
 466   // However, to prevent the proliferation of improperly built native
 467   // libraries, the new path component /usr/java/packages is added here.
 468   // Eventually, all the library path setting will be done here.
 469   {
 470     // Get the user setting of LD_LIBRARY_PATH, and prepended it. It
 471     // should always exist (until the legacy problem cited above is
 472     // addressed).
 473     const char *v = ::getenv(&quot;LD_LIBRARY_PATH&quot;);
 474     const char *v_colon = &quot;:&quot;;
 475     if (v == NULL) { v = &quot;&quot;; v_colon = &quot;&quot;; }
 476     // That&#39;s +1 for the colon and +1 for the trailing &#39;\0&#39;.
 477     char *ld_library_path = NEW_C_HEAP_ARRAY(char,
 478                                              strlen(v) + 1 +
 479                                              sizeof(SYS_EXT_DIR) + sizeof(&quot;/lib/&quot;) + sizeof(DEFAULT_LIBPATH) + 1,
 480                                              mtInternal);
 481     sprintf(ld_library_path, &quot;%s%s&quot; SYS_EXT_DIR &quot;/lib:&quot; DEFAULT_LIBPATH, v, v_colon);
 482     Arguments::set_library_path(ld_library_path);
 483     FREE_C_HEAP_ARRAY(char, ld_library_path);
 484   }
 485 
 486   // Extensions directories.
 487   sprintf(buf, &quot;%s&quot; EXTENSIONS_DIR &quot;:&quot; SYS_EXT_DIR EXTENSIONS_DIR, Arguments::get_java_home());
 488   Arguments::set_ext_dirs(buf);
 489 
 490   FREE_C_HEAP_ARRAY(char, buf);
 491 
 492 #undef DEFAULT_LIBPATH
 493 #undef SYS_EXT_DIR
 494 #undef EXTENSIONS_DIR
 495 }
 496 
 497 ////////////////////////////////////////////////////////////////////////////////
 498 // breakpoint support
 499 
 500 void os::breakpoint() {
 501   BREAKPOINT;
 502 }
 503 
 504 extern &quot;C&quot; void breakpoint() {
 505   // use debugger to set breakpoint here
 506 }
 507 
 508 ////////////////////////////////////////////////////////////////////////////////
 509 // signal support
 510 
 511 debug_only(static bool signal_sets_initialized = false);
 512 static sigset_t unblocked_sigs, vm_sigs;
 513 
 514 void os::Linux::signal_sets_init() {
 515   // Should also have an assertion stating we are still single-threaded.
 516   assert(!signal_sets_initialized, &quot;Already initialized&quot;);
 517   // Fill in signals that are necessarily unblocked for all threads in
 518   // the VM. Currently, we unblock the following signals:
 519   // SHUTDOWN{1,2,3}_SIGNAL: for shutdown hooks support (unless over-ridden
 520   //                         by -Xrs (=ReduceSignalUsage));
 521   // BREAK_SIGNAL which is unblocked only by the VM thread and blocked by all
 522   // other threads. The &quot;ReduceSignalUsage&quot; boolean tells us not to alter
 523   // the dispositions or masks wrt these signals.
 524   // Programs embedding the VM that want to use the above signals for their
 525   // own purposes must, at this time, use the &quot;-Xrs&quot; option to prevent
 526   // interference with shutdown hooks and BREAK_SIGNAL thread dumping.
 527   // (See bug 4345157, and other related bugs).
 528   // In reality, though, unblocking these signals is really a nop, since
 529   // these signals are not blocked by default.
 530   sigemptyset(&amp;unblocked_sigs);
 531   sigaddset(&amp;unblocked_sigs, SIGILL);
 532   sigaddset(&amp;unblocked_sigs, SIGSEGV);
 533   sigaddset(&amp;unblocked_sigs, SIGBUS);
 534   sigaddset(&amp;unblocked_sigs, SIGFPE);
 535 #if defined(PPC64)
 536   sigaddset(&amp;unblocked_sigs, SIGTRAP);
 537 #endif
 538   sigaddset(&amp;unblocked_sigs, SR_signum);
 539 
 540   if (!ReduceSignalUsage) {
 541     if (!os::Posix::is_sig_ignored(SHUTDOWN1_SIGNAL)) {
 542       sigaddset(&amp;unblocked_sigs, SHUTDOWN1_SIGNAL);
 543     }
 544     if (!os::Posix::is_sig_ignored(SHUTDOWN2_SIGNAL)) {
 545       sigaddset(&amp;unblocked_sigs, SHUTDOWN2_SIGNAL);
 546     }
 547     if (!os::Posix::is_sig_ignored(SHUTDOWN3_SIGNAL)) {
 548       sigaddset(&amp;unblocked_sigs, SHUTDOWN3_SIGNAL);
 549     }
 550   }
 551   // Fill in signals that are blocked by all but the VM thread.
 552   sigemptyset(&amp;vm_sigs);
 553   if (!ReduceSignalUsage) {
 554     sigaddset(&amp;vm_sigs, BREAK_SIGNAL);
 555   }
 556   debug_only(signal_sets_initialized = true);
 557 
 558 }
 559 
 560 // These are signals that are unblocked while a thread is running Java.
 561 // (For some reason, they get blocked by default.)
 562 sigset_t* os::Linux::unblocked_signals() {
 563   assert(signal_sets_initialized, &quot;Not initialized&quot;);
 564   return &amp;unblocked_sigs;
 565 }
 566 
 567 // These are the signals that are blocked while a (non-VM) thread is
 568 // running Java. Only the VM thread handles these signals.
 569 sigset_t* os::Linux::vm_signals() {
 570   assert(signal_sets_initialized, &quot;Not initialized&quot;);
 571   return &amp;vm_sigs;
 572 }
 573 
 574 void os::Linux::hotspot_sigmask(Thread* thread) {
 575 
 576   //Save caller&#39;s signal mask before setting VM signal mask
 577   sigset_t caller_sigmask;
 578   pthread_sigmask(SIG_BLOCK, NULL, &amp;caller_sigmask);
 579 
 580   OSThread* osthread = thread-&gt;osthread();
 581   osthread-&gt;set_caller_sigmask(caller_sigmask);
 582 
 583   pthread_sigmask(SIG_UNBLOCK, os::Linux::unblocked_signals(), NULL);
 584 
 585   if (!ReduceSignalUsage) {
 586     if (thread-&gt;is_VM_thread()) {
 587       // Only the VM thread handles BREAK_SIGNAL ...
 588       pthread_sigmask(SIG_UNBLOCK, vm_signals(), NULL);
 589     } else {
 590       // ... all other threads block BREAK_SIGNAL
 591       pthread_sigmask(SIG_BLOCK, vm_signals(), NULL);
 592     }
 593   }
 594 }
 595 
 596 //////////////////////////////////////////////////////////////////////////////
 597 // detecting pthread library
 598 
 599 void os::Linux::libpthread_init() {
 600   // Save glibc and pthread version strings.
 601 #if !defined(_CS_GNU_LIBC_VERSION) || \
 602     !defined(_CS_GNU_LIBPTHREAD_VERSION)
 603   #error &quot;glibc too old (&lt; 2.3.2)&quot;
 604 #endif
 605 
<a name="3" id="anc3"></a><span class="line-modified"> 606   size_t n;</span>
<span class="line-modified"> 607 </span>
<span class="line-modified"> 608   n = confstr(_CS_GNU_LIBC_VERSION, NULL, 0);</span>
<span class="line-modified"> 609   if (n &gt; 0) {</span>
<span class="line-modified"> 610     char* str = (char *)malloc(n, mtInternal);</span>
<span class="line-added"> 611     confstr(_CS_GNU_LIBC_VERSION, str, n);</span>
<span class="line-added"> 612     os::Linux::set_glibc_version(str);</span>
<span class="line-added"> 613   }</span>
 614 
 615   n = confstr(_CS_GNU_LIBPTHREAD_VERSION, NULL, 0);
<a name="4" id="anc4"></a><span class="line-modified"> 616   if (n &gt; 0) {</span>
<span class="line-modified"> 617     char* str = (char *)malloc(n, mtInternal);</span>
<span class="line-modified"> 618     confstr(_CS_GNU_LIBPTHREAD_VERSION, str, n);</span>
<span class="line-modified"> 619     os::Linux::set_libpthread_version(str);</span>
<span class="line-added"> 620   }</span>
 621 }
 622 
 623 /////////////////////////////////////////////////////////////////////////////
 624 // thread stack expansion
 625 
 626 // os::Linux::manually_expand_stack() takes care of expanding the thread
 627 // stack. Note that this is normally not needed: pthread stacks allocate
 628 // thread stack using mmap() without MAP_NORESERVE, so the stack is already
 629 // committed. Therefore it is not necessary to expand the stack manually.
 630 //
 631 // Manually expanding the stack was historically needed on LinuxThreads
 632 // thread stacks, which were allocated with mmap(MAP_GROWSDOWN). Nowadays
 633 // it is kept to deal with very rare corner cases:
 634 //
 635 // For one, user may run the VM on an own implementation of threads
 636 // whose stacks are - like the old LinuxThreads - implemented using
 637 // mmap(MAP_GROWSDOWN).
 638 //
 639 // Also, this coding may be needed if the VM is running on the primordial
 640 // thread. Normally we avoid running on the primordial thread; however,
 641 // user may still invoke the VM on the primordial thread.
 642 //
 643 // The following historical comment describes the details about running
 644 // on a thread stack allocated with mmap(MAP_GROWSDOWN):
 645 
 646 
 647 // Force Linux kernel to expand current thread stack. If &quot;bottom&quot; is close
 648 // to the stack guard, caller should block all signals.
 649 //
 650 // MAP_GROWSDOWN:
 651 //   A special mmap() flag that is used to implement thread stacks. It tells
 652 //   kernel that the memory region should extend downwards when needed. This
 653 //   allows early versions of LinuxThreads to only mmap the first few pages
 654 //   when creating a new thread. Linux kernel will automatically expand thread
 655 //   stack as needed (on page faults).
 656 //
 657 //   However, because the memory region of a MAP_GROWSDOWN stack can grow on
 658 //   demand, if a page fault happens outside an already mapped MAP_GROWSDOWN
 659 //   region, it&#39;s hard to tell if the fault is due to a legitimate stack
 660 //   access or because of reading/writing non-exist memory (e.g. buffer
 661 //   overrun). As a rule, if the fault happens below current stack pointer,
 662 //   Linux kernel does not expand stack, instead a SIGSEGV is sent to the
 663 //   application (see Linux kernel fault.c).
 664 //
 665 //   This Linux feature can cause SIGSEGV when VM bangs thread stack for
 666 //   stack overflow detection.
 667 //
 668 //   Newer version of LinuxThreads (since glibc-2.2, or, RH-7.x) and NPTL do
 669 //   not use MAP_GROWSDOWN.
 670 //
 671 // To get around the problem and allow stack banging on Linux, we need to
 672 // manually expand thread stack after receiving the SIGSEGV.
 673 //
 674 // There are two ways to expand thread stack to address &quot;bottom&quot;, we used
 675 // both of them in JVM before 1.5:
 676 //   1. adjust stack pointer first so that it is below &quot;bottom&quot;, and then
 677 //      touch &quot;bottom&quot;
 678 //   2. mmap() the page in question
 679 //
 680 // Now alternate signal stack is gone, it&#39;s harder to use 2. For instance,
 681 // if current sp is already near the lower end of page 101, and we need to
 682 // call mmap() to map page 100, it is possible that part of the mmap() frame
 683 // will be placed in page 100. When page 100 is mapped, it is zero-filled.
 684 // That will destroy the mmap() frame and cause VM to crash.
 685 //
 686 // The following code works by adjusting sp first, then accessing the &quot;bottom&quot;
 687 // page to force a page fault. Linux kernel will then automatically expand the
 688 // stack mapping.
 689 //
 690 // _expand_stack_to() assumes its frame size is less than page size, which
 691 // should always be true if the function is not inlined.
 692 
 693 static void NOINLINE _expand_stack_to(address bottom) {
 694   address sp;
 695   size_t size;
 696   volatile char *p;
 697 
 698   // Adjust bottom to point to the largest address within the same page, it
 699   // gives us a one-page buffer if alloca() allocates slightly more memory.
 700   bottom = (address)align_down((uintptr_t)bottom, os::Linux::page_size());
 701   bottom += os::Linux::page_size() - 1;
 702 
 703   // sp might be slightly above current stack pointer; if that&#39;s the case, we
 704   // will alloca() a little more space than necessary, which is OK. Don&#39;t use
 705   // os::current_stack_pointer(), as its result can be slightly below current
 706   // stack pointer, causing us to not alloca enough to reach &quot;bottom&quot;.
 707   sp = (address)&amp;sp;
 708 
 709   if (sp &gt; bottom) {
 710     size = sp - bottom;
 711     p = (volatile char *)alloca(size);
 712     assert(p != NULL &amp;&amp; p &lt;= (volatile char *)bottom, &quot;alloca problem?&quot;);
 713     p[0] = &#39;\0&#39;;
 714   }
 715 }
 716 
 717 void os::Linux::expand_stack_to(address bottom) {
 718   _expand_stack_to(bottom);
 719 }
 720 
 721 bool os::Linux::manually_expand_stack(JavaThread * t, address addr) {
 722   assert(t!=NULL, &quot;just checking&quot;);
 723   assert(t-&gt;osthread()-&gt;expanding_stack(), &quot;expand should be set&quot;);
 724 
 725   if (t-&gt;is_in_usable_stack(addr)) {
 726     sigset_t mask_all, old_sigset;
 727     sigfillset(&amp;mask_all);
 728     pthread_sigmask(SIG_SETMASK, &amp;mask_all, &amp;old_sigset);
 729     _expand_stack_to(addr);
 730     pthread_sigmask(SIG_SETMASK, &amp;old_sigset, NULL);
 731     return true;
 732   }
 733   return false;
 734 }
 735 
 736 //////////////////////////////////////////////////////////////////////////////
 737 // create new thread
 738 
 739 // Thread start routine for all newly created threads
 740 static void *thread_native_entry(Thread *thread) {
 741 
 742   thread-&gt;record_stack_base_and_size();
 743 
 744   // Try to randomize the cache line index of hot stack frames.
 745   // This helps when threads of the same stack traces evict each other&#39;s
 746   // cache lines. The threads can be either from the same JVM instance, or
 747   // from different JVM instances. The benefit is especially true for
 748   // processors with hyperthreading technology.
 749   static int counter = 0;
 750   int pid = os::current_process_id();
 751   alloca(((pid ^ counter++) &amp; 7) * 128);
 752 
 753   thread-&gt;initialize_thread_current();
 754 
 755   OSThread* osthread = thread-&gt;osthread();
 756   Monitor* sync = osthread-&gt;startThread_lock();
 757 
 758   osthread-&gt;set_thread_id(os::current_thread_id());
 759 
 760   log_info(os, thread)(&quot;Thread is alive (tid: &quot; UINTX_FORMAT &quot;, pthread id: &quot; UINTX_FORMAT &quot;).&quot;,
 761     os::current_thread_id(), (uintx) pthread_self());
 762 
 763   if (UseNUMA) {
 764     int lgrp_id = os::numa_get_group_id();
 765     if (lgrp_id != -1) {
 766       thread-&gt;set_lgrp_id(lgrp_id);
 767     }
 768   }
 769   // initialize signal mask for this thread
 770   os::Linux::hotspot_sigmask(thread);
 771 
 772   // initialize floating point control register
 773   os::Linux::init_thread_fpu_state();
 774 
 775   // handshaking with parent thread
 776   {
 777     MutexLocker ml(sync, Mutex::_no_safepoint_check_flag);
 778 
 779     // notify parent thread
 780     osthread-&gt;set_state(INITIALIZED);
 781     sync-&gt;notify_all();
 782 
 783     // wait until os::start_thread()
 784     while (osthread-&gt;get_state() == INITIALIZED) {
 785       sync-&gt;wait_without_safepoint_check();
 786     }
 787   }
 788 
 789   assert(osthread-&gt;pthread_id() != 0, &quot;pthread_id was not set as expected&quot;);
 790 
 791   // call one more level start routine
 792   thread-&gt;call_run();
 793 
 794   // Note: at this point the thread object may already have deleted itself.
 795   // Prevent dereferencing it from here on out.
 796   thread = NULL;
 797 
 798   log_info(os, thread)(&quot;Thread finished (tid: &quot; UINTX_FORMAT &quot;, pthread id: &quot; UINTX_FORMAT &quot;).&quot;,
 799     os::current_thread_id(), (uintx) pthread_self());
 800 
 801   return 0;
 802 }
 803 
 804 // On Linux, glibc places static TLS blocks (for __thread variables) on
 805 // the thread stack. This decreases the stack size actually available
 806 // to threads.
 807 //
 808 // For large static TLS sizes, this may cause threads to malfunction due
 809 // to insufficient stack space. This is a well-known issue in glibc:
 810 // http://sourceware.org/bugzilla/show_bug.cgi?id=11787.
 811 //
 812 // As a workaround, we call a private but assumed-stable glibc function,
 813 // __pthread_get_minstack() to obtain the minstack size and derive the
 814 // static TLS size from it. We then increase the user requested stack
 815 // size by this TLS size.
 816 //
 817 // Due to compatibility concerns, this size adjustment is opt-in and
 818 // controlled via AdjustStackSizeForTLS.
 819 typedef size_t (*GetMinStack)(const pthread_attr_t *attr);
 820 
 821 GetMinStack _get_minstack_func = NULL;
 822 
 823 static void get_minstack_init() {
 824   _get_minstack_func =
 825         (GetMinStack)dlsym(RTLD_DEFAULT, &quot;__pthread_get_minstack&quot;);
 826   log_info(os, thread)(&quot;Lookup of __pthread_get_minstack %s&quot;,
 827                        _get_minstack_func == NULL ? &quot;failed&quot; : &quot;succeeded&quot;);
 828 }
 829 
 830 // Returns the size of the static TLS area glibc puts on thread stacks.
 831 // The value is cached on first use, which occurs when the first thread
 832 // is created during VM initialization.
 833 static size_t get_static_tls_area_size(const pthread_attr_t *attr) {
 834   size_t tls_size = 0;
 835   if (_get_minstack_func != NULL) {
 836     // Obtain the pthread minstack size by calling __pthread_get_minstack.
 837     size_t minstack_size = _get_minstack_func(attr);
 838 
 839     // Remove non-TLS area size included in minstack size returned
 840     // by __pthread_get_minstack() to get the static TLS size.
 841     // In glibc before 2.27, minstack size includes guard_size.
 842     // In glibc 2.27 and later, guard_size is automatically added
 843     // to the stack size by pthread_create and is no longer included
 844     // in minstack size. In both cases, the guard_size is taken into
 845     // account, so there is no need to adjust the result for that.
 846     //
 847     // Although __pthread_get_minstack() is a private glibc function,
 848     // it is expected to have a stable behavior across future glibc
 849     // versions while glibc still allocates the static TLS blocks off
 850     // the stack. Following is glibc 2.28 __pthread_get_minstack():
 851     //
 852     // size_t
 853     // __pthread_get_minstack (const pthread_attr_t *attr)
 854     // {
 855     //   return GLRO(dl_pagesize) + __static_tls_size + PTHREAD_STACK_MIN;
 856     // }
 857     //
 858     //
 859     // The following &#39;minstack_size &gt; os::vm_page_size() + PTHREAD_STACK_MIN&#39;
 860     // if check is done for precaution.
 861     if (minstack_size &gt; (size_t)os::vm_page_size() + PTHREAD_STACK_MIN) {
 862       tls_size = minstack_size - os::vm_page_size() - PTHREAD_STACK_MIN;
 863     }
 864   }
 865 
 866   log_info(os, thread)(&quot;Stack size adjustment for TLS is &quot; SIZE_FORMAT,
 867                        tls_size);
 868   return tls_size;
 869 }
 870 
 871 bool os::create_thread(Thread* thread, ThreadType thr_type,
 872                        size_t req_stack_size) {
 873   assert(thread-&gt;osthread() == NULL, &quot;caller responsible&quot;);
 874 
 875   // Allocate the OSThread object
 876   OSThread* osthread = new OSThread(NULL, NULL);
 877   if (osthread == NULL) {
 878     return false;
 879   }
 880 
 881   // set the correct thread state
 882   osthread-&gt;set_thread_type(thr_type);
 883 
 884   // Initial state is ALLOCATED but not INITIALIZED
 885   osthread-&gt;set_state(ALLOCATED);
 886 
 887   thread-&gt;set_osthread(osthread);
 888 
 889   // init thread attributes
 890   pthread_attr_t attr;
 891   pthread_attr_init(&amp;attr);
 892   pthread_attr_setdetachstate(&amp;attr, PTHREAD_CREATE_DETACHED);
 893 
 894   // Calculate stack size if it&#39;s not specified by caller.
 895   size_t stack_size = os::Posix::get_initial_stack_size(thr_type, req_stack_size);
 896   // In glibc versions prior to 2.7 the guard size mechanism
 897   // is not implemented properly. The posix standard requires adding
 898   // the size of the guard pages to the stack size, instead Linux
 899   // takes the space out of &#39;stacksize&#39;. Thus we adapt the requested
 900   // stack_size by the size of the guard pages to mimick proper
 901   // behaviour. However, be careful not to end up with a size
 902   // of zero due to overflow. Don&#39;t add the guard page in that case.
 903   size_t guard_size = os::Linux::default_guard_size(thr_type);
 904   // Configure glibc guard page. Must happen before calling
 905   // get_static_tls_area_size(), which uses the guard_size.
 906   pthread_attr_setguardsize(&amp;attr, guard_size);
 907 
 908   size_t stack_adjust_size = 0;
 909   if (AdjustStackSizeForTLS) {
 910     // Adjust the stack_size for on-stack TLS - see get_static_tls_area_size().
 911     stack_adjust_size += get_static_tls_area_size(&amp;attr);
 912   } else {
 913     stack_adjust_size += guard_size;
 914   }
 915 
 916   stack_adjust_size = align_up(stack_adjust_size, os::vm_page_size());
 917   if (stack_size &lt;= SIZE_MAX - stack_adjust_size) {
 918     stack_size += stack_adjust_size;
 919   }
 920   assert(is_aligned(stack_size, os::vm_page_size()), &quot;stack_size not aligned&quot;);
 921 
 922   int status = pthread_attr_setstacksize(&amp;attr, stack_size);
 923   assert_status(status == 0, status, &quot;pthread_attr_setstacksize&quot;);
 924 
 925   ThreadState state;
 926 
 927   {
 928     pthread_t tid;
 929     int ret = pthread_create(&amp;tid, &amp;attr, (void* (*)(void*)) thread_native_entry, thread);
 930 
 931     char buf[64];
 932     if (ret == 0) {
 933       log_info(os, thread)(&quot;Thread started (pthread id: &quot; UINTX_FORMAT &quot;, attributes: %s). &quot;,
 934         (uintx) tid, os::Posix::describe_pthread_attr(buf, sizeof(buf), &amp;attr));
 935     } else {
 936       log_warning(os, thread)(&quot;Failed to start thread - pthread_create failed (%s) for attributes: %s.&quot;,
 937         os::errno_name(ret), os::Posix::describe_pthread_attr(buf, sizeof(buf), &amp;attr));
 938       // Log some OS information which might explain why creating the thread failed.
 939       log_info(os, thread)(&quot;Number of threads approx. running in the VM: %d&quot;, Threads::number_of_threads());
 940       LogStream st(Log(os, thread)::info());
 941       os::Posix::print_rlimit_info(&amp;st);
 942       os::print_memory_info(&amp;st);
 943       os::Linux::print_proc_sys_info(&amp;st);
 944       os::Linux::print_container_info(&amp;st);
 945     }
 946 
 947     pthread_attr_destroy(&amp;attr);
 948 
 949     if (ret != 0) {
 950       // Need to clean up stuff we&#39;ve allocated so far
 951       thread-&gt;set_osthread(NULL);
 952       delete osthread;
 953       return false;
 954     }
 955 
 956     // Store pthread info into the OSThread
 957     osthread-&gt;set_pthread_id(tid);
 958 
 959     // Wait until child thread is either initialized or aborted
 960     {
 961       Monitor* sync_with_child = osthread-&gt;startThread_lock();
 962       MutexLocker ml(sync_with_child, Mutex::_no_safepoint_check_flag);
 963       while ((state = osthread-&gt;get_state()) == ALLOCATED) {
 964         sync_with_child-&gt;wait_without_safepoint_check();
 965       }
 966     }
 967   }
 968 
 969   // Aborted due to thread limit being reached
 970   if (state == ZOMBIE) {
 971     thread-&gt;set_osthread(NULL);
 972     delete osthread;
 973     return false;
 974   }
 975 
 976   // The thread is returned suspended (in state INITIALIZED),
 977   // and is started higher up in the call chain
 978   assert(state == INITIALIZED, &quot;race condition&quot;);
 979   return true;
 980 }
 981 
 982 /////////////////////////////////////////////////////////////////////////////
 983 // attach existing thread
 984 
 985 // bootstrap the main thread
 986 bool os::create_main_thread(JavaThread* thread) {
 987   assert(os::Linux::_main_thread == pthread_self(), &quot;should be called inside main thread&quot;);
 988   return create_attached_thread(thread);
 989 }
 990 
 991 bool os::create_attached_thread(JavaThread* thread) {
 992 #ifdef ASSERT
 993   thread-&gt;verify_not_published();
 994 #endif
 995 
 996   // Allocate the OSThread object
 997   OSThread* osthread = new OSThread(NULL, NULL);
 998 
 999   if (osthread == NULL) {
1000     return false;
1001   }
1002 
1003   // Store pthread info into the OSThread
1004   osthread-&gt;set_thread_id(os::Linux::gettid());
1005   osthread-&gt;set_pthread_id(::pthread_self());
1006 
1007   // initialize floating point control register
1008   os::Linux::init_thread_fpu_state();
1009 
1010   // Initial thread state is RUNNABLE
1011   osthread-&gt;set_state(RUNNABLE);
1012 
1013   thread-&gt;set_osthread(osthread);
1014 
1015   if (UseNUMA) {
1016     int lgrp_id = os::numa_get_group_id();
1017     if (lgrp_id != -1) {
1018       thread-&gt;set_lgrp_id(lgrp_id);
1019     }
1020   }
1021 
1022   if (os::is_primordial_thread()) {
1023     // If current thread is primordial thread, its stack is mapped on demand,
1024     // see notes about MAP_GROWSDOWN. Here we try to force kernel to map
1025     // the entire stack region to avoid SEGV in stack banging.
1026     // It is also useful to get around the heap-stack-gap problem on SuSE
1027     // kernel (see 4821821 for details). We first expand stack to the top
1028     // of yellow zone, then enable stack yellow zone (order is significant,
1029     // enabling yellow zone first will crash JVM on SuSE Linux), so there
1030     // is no gap between the last two virtual memory regions.
1031 
1032     JavaThread *jt = (JavaThread *)thread;
1033     address addr = jt-&gt;stack_reserved_zone_base();
1034     assert(addr != NULL, &quot;initialization problem?&quot;);
1035     assert(jt-&gt;stack_available(addr) &gt; 0, &quot;stack guard should not be enabled&quot;);
1036 
1037     osthread-&gt;set_expanding_stack();
1038     os::Linux::manually_expand_stack(jt, addr);
1039     osthread-&gt;clear_expanding_stack();
1040   }
1041 
1042   // initialize signal mask for this thread
1043   // and save the caller&#39;s signal mask
1044   os::Linux::hotspot_sigmask(thread);
1045 
1046   log_info(os, thread)(&quot;Thread attached (tid: &quot; UINTX_FORMAT &quot;, pthread id: &quot; UINTX_FORMAT &quot;).&quot;,
1047     os::current_thread_id(), (uintx) pthread_self());
1048 
1049   return true;
1050 }
1051 
1052 void os::pd_start_thread(Thread* thread) {
1053   OSThread * osthread = thread-&gt;osthread();
1054   assert(osthread-&gt;get_state() != INITIALIZED, &quot;just checking&quot;);
1055   Monitor* sync_with_child = osthread-&gt;startThread_lock();
1056   MutexLocker ml(sync_with_child, Mutex::_no_safepoint_check_flag);
1057   sync_with_child-&gt;notify();
1058 }
1059 
1060 // Free Linux resources related to the OSThread
1061 void os::free_thread(OSThread* osthread) {
1062   assert(osthread != NULL, &quot;osthread not set&quot;);
1063 
1064   // We are told to free resources of the argument thread,
1065   // but we can only really operate on the current thread.
1066   assert(Thread::current()-&gt;osthread() == osthread,
1067          &quot;os::free_thread but not current thread&quot;);
1068 
1069 #ifdef ASSERT
1070   sigset_t current;
1071   sigemptyset(&amp;current);
1072   pthread_sigmask(SIG_SETMASK, NULL, &amp;current);
1073   assert(!sigismember(&amp;current, SR_signum), &quot;SR signal should not be blocked!&quot;);
1074 #endif
1075 
1076   // Restore caller&#39;s signal mask
1077   sigset_t sigmask = osthread-&gt;caller_sigmask();
1078   pthread_sigmask(SIG_SETMASK, &amp;sigmask, NULL);
1079 
1080   delete osthread;
1081 }
1082 
1083 //////////////////////////////////////////////////////////////////////////////
1084 // primordial thread
1085 
1086 // Check if current thread is the primordial thread, similar to Solaris thr_main.
1087 bool os::is_primordial_thread(void) {
1088   if (suppress_primordial_thread_resolution) {
1089     return false;
1090   }
1091   char dummy;
1092   // If called before init complete, thread stack bottom will be null.
1093   // Can be called if fatal error occurs before initialization.
1094   if (os::Linux::initial_thread_stack_bottom() == NULL) return false;
1095   assert(os::Linux::initial_thread_stack_bottom() != NULL &amp;&amp;
1096          os::Linux::initial_thread_stack_size()   != 0,
1097          &quot;os::init did not locate primordial thread&#39;s stack region&quot;);
1098   if ((address)&amp;dummy &gt;= os::Linux::initial_thread_stack_bottom() &amp;&amp;
1099       (address)&amp;dummy &lt; os::Linux::initial_thread_stack_bottom() +
1100                         os::Linux::initial_thread_stack_size()) {
1101     return true;
1102   } else {
1103     return false;
1104   }
1105 }
1106 
1107 // Find the virtual memory area that contains addr
1108 static bool find_vma(address addr, address* vma_low, address* vma_high) {
1109   FILE *fp = fopen(&quot;/proc/self/maps&quot;, &quot;r&quot;);
1110   if (fp) {
1111     address low, high;
1112     while (!feof(fp)) {
1113       if (fscanf(fp, &quot;%p-%p&quot;, &amp;low, &amp;high) == 2) {
1114         if (low &lt;= addr &amp;&amp; addr &lt; high) {
1115           if (vma_low)  *vma_low  = low;
1116           if (vma_high) *vma_high = high;
1117           fclose(fp);
1118           return true;
1119         }
1120       }
1121       for (;;) {
1122         int ch = fgetc(fp);
1123         if (ch == EOF || ch == (int)&#39;\n&#39;) break;
1124       }
1125     }
1126     fclose(fp);
1127   }
1128   return false;
1129 }
1130 
1131 // Locate primordial thread stack. This special handling of primordial thread stack
1132 // is needed because pthread_getattr_np() on most (all?) Linux distros returns
1133 // bogus value for the primordial process thread. While the launcher has created
1134 // the VM in a new thread since JDK 6, we still have to allow for the use of the
1135 // JNI invocation API from a primordial thread.
1136 void os::Linux::capture_initial_stack(size_t max_size) {
1137 
1138   // max_size is either 0 (which means accept OS default for thread stacks) or
1139   // a user-specified value known to be at least the minimum needed. If we
1140   // are actually on the primordial thread we can make it appear that we have a
1141   // smaller max_size stack by inserting the guard pages at that location. But we
1142   // cannot do anything to emulate a larger stack than what has been provided by
1143   // the OS or threading library. In fact if we try to use a stack greater than
1144   // what is set by rlimit then we will crash the hosting process.
1145 
1146   // Maximum stack size is the easy part, get it from RLIMIT_STACK.
1147   // If this is &quot;unlimited&quot; then it will be a huge value.
1148   struct rlimit rlim;
1149   getrlimit(RLIMIT_STACK, &amp;rlim);
1150   size_t stack_size = rlim.rlim_cur;
1151 
1152   // 6308388: a bug in ld.so will relocate its own .data section to the
1153   //   lower end of primordial stack; reduce ulimit -s value a little bit
1154   //   so we won&#39;t install guard page on ld.so&#39;s data section.
1155   //   But ensure we don&#39;t underflow the stack size - allow 1 page spare
1156   if (stack_size &gt;= (size_t)(3 * page_size())) {
1157     stack_size -= 2 * page_size();
1158   }
1159 
1160   // Try to figure out where the stack base (top) is. This is harder.
1161   //
1162   // When an application is started, glibc saves the initial stack pointer in
1163   // a global variable &quot;__libc_stack_end&quot;, which is then used by system
1164   // libraries. __libc_stack_end should be pretty close to stack top. The
1165   // variable is available since the very early days. However, because it is
1166   // a private interface, it could disappear in the future.
1167   //
1168   // Linux kernel saves start_stack information in /proc/&lt;pid&gt;/stat. Similar
1169   // to __libc_stack_end, it is very close to stack top, but isn&#39;t the real
1170   // stack top. Note that /proc may not exist if VM is running as a chroot
1171   // program, so reading /proc/&lt;pid&gt;/stat could fail. Also the contents of
1172   // /proc/&lt;pid&gt;/stat could change in the future (though unlikely).
1173   //
1174   // We try __libc_stack_end first. If that doesn&#39;t work, look for
1175   // /proc/&lt;pid&gt;/stat. If neither of them works, we use current stack pointer
1176   // as a hint, which should work well in most cases.
1177 
1178   uintptr_t stack_start;
1179 
1180   // try __libc_stack_end first
1181   uintptr_t *p = (uintptr_t *)dlsym(RTLD_DEFAULT, &quot;__libc_stack_end&quot;);
1182   if (p &amp;&amp; *p) {
1183     stack_start = *p;
1184   } else {
1185     // see if we can get the start_stack field from /proc/self/stat
1186     FILE *fp;
1187     int pid;
1188     char state;
1189     int ppid;
1190     int pgrp;
1191     int session;
1192     int nr;
1193     int tpgrp;
1194     unsigned long flags;
1195     unsigned long minflt;
1196     unsigned long cminflt;
1197     unsigned long majflt;
1198     unsigned long cmajflt;
1199     unsigned long utime;
1200     unsigned long stime;
1201     long cutime;
1202     long cstime;
1203     long prio;
1204     long nice;
1205     long junk;
1206     long it_real;
1207     uintptr_t start;
1208     uintptr_t vsize;
1209     intptr_t rss;
1210     uintptr_t rsslim;
1211     uintptr_t scodes;
1212     uintptr_t ecode;
1213     int i;
1214 
1215     // Figure what the primordial thread stack base is. Code is inspired
1216     // by email from Hans Boehm. /proc/self/stat begins with current pid,
1217     // followed by command name surrounded by parentheses, state, etc.
1218     char stat[2048];
1219     int statlen;
1220 
1221     fp = fopen(&quot;/proc/self/stat&quot;, &quot;r&quot;);
1222     if (fp) {
1223       statlen = fread(stat, 1, 2047, fp);
1224       stat[statlen] = &#39;\0&#39;;
1225       fclose(fp);
1226 
1227       // Skip pid and the command string. Note that we could be dealing with
1228       // weird command names, e.g. user could decide to rename java launcher
1229       // to &quot;java 1.4.2 :)&quot;, then the stat file would look like
1230       //                1234 (java 1.4.2 :)) R ... ...
1231       // We don&#39;t really need to know the command string, just find the last
1232       // occurrence of &quot;)&quot; and then start parsing from there. See bug 4726580.
1233       char * s = strrchr(stat, &#39;)&#39;);
1234 
1235       i = 0;
1236       if (s) {
1237         // Skip blank chars
1238         do { s++; } while (s &amp;&amp; isspace(*s));
1239 
1240 #define _UFM UINTX_FORMAT
1241 #define _DFM INTX_FORMAT
1242 
1243         //                                     1   1   1   1   1   1   1   1   1   1   2   2    2    2    2    2    2    2    2
1244         //              3  4  5  6  7  8   9   0   1   2   3   4   5   6   7   8   9   0   1    2    3    4    5    6    7    8
1245         i = sscanf(s, &quot;%c %d %d %d %d %d %lu %lu %lu %lu %lu %lu %lu %ld %ld %ld %ld %ld %ld &quot; _UFM _UFM _DFM _UFM _UFM _UFM _UFM,
1246                    &amp;state,          // 3  %c
1247                    &amp;ppid,           // 4  %d
1248                    &amp;pgrp,           // 5  %d
1249                    &amp;session,        // 6  %d
1250                    &amp;nr,             // 7  %d
1251                    &amp;tpgrp,          // 8  %d
1252                    &amp;flags,          // 9  %lu
1253                    &amp;minflt,         // 10 %lu
1254                    &amp;cminflt,        // 11 %lu
1255                    &amp;majflt,         // 12 %lu
1256                    &amp;cmajflt,        // 13 %lu
1257                    &amp;utime,          // 14 %lu
1258                    &amp;stime,          // 15 %lu
1259                    &amp;cutime,         // 16 %ld
1260                    &amp;cstime,         // 17 %ld
1261                    &amp;prio,           // 18 %ld
1262                    &amp;nice,           // 19 %ld
1263                    &amp;junk,           // 20 %ld
1264                    &amp;it_real,        // 21 %ld
1265                    &amp;start,          // 22 UINTX_FORMAT
1266                    &amp;vsize,          // 23 UINTX_FORMAT
1267                    &amp;rss,            // 24 INTX_FORMAT
1268                    &amp;rsslim,         // 25 UINTX_FORMAT
1269                    &amp;scodes,         // 26 UINTX_FORMAT
1270                    &amp;ecode,          // 27 UINTX_FORMAT
1271                    &amp;stack_start);   // 28 UINTX_FORMAT
1272       }
1273 
1274 #undef _UFM
1275 #undef _DFM
1276 
1277       if (i != 28 - 2) {
1278         assert(false, &quot;Bad conversion from /proc/self/stat&quot;);
1279         // product mode - assume we are the primordial thread, good luck in the
1280         // embedded case.
1281         warning(&quot;Can&#39;t detect primordial thread stack location - bad conversion&quot;);
1282         stack_start = (uintptr_t) &amp;rlim;
1283       }
1284     } else {
1285       // For some reason we can&#39;t open /proc/self/stat (for example, running on
1286       // FreeBSD with a Linux emulator, or inside chroot), this should work for
1287       // most cases, so don&#39;t abort:
1288       warning(&quot;Can&#39;t detect primordial thread stack location - no /proc/self/stat&quot;);
1289       stack_start = (uintptr_t) &amp;rlim;
1290     }
1291   }
1292 
1293   // Now we have a pointer (stack_start) very close to the stack top, the
1294   // next thing to do is to figure out the exact location of stack top. We
1295   // can find out the virtual memory area that contains stack_start by
1296   // reading /proc/self/maps, it should be the last vma in /proc/self/maps,
1297   // and its upper limit is the real stack top. (again, this would fail if
1298   // running inside chroot, because /proc may not exist.)
1299 
1300   uintptr_t stack_top;
1301   address low, high;
1302   if (find_vma((address)stack_start, &amp;low, &amp;high)) {
1303     // success, &quot;high&quot; is the true stack top. (ignore &quot;low&quot;, because initial
1304     // thread stack grows on demand, its real bottom is high - RLIMIT_STACK.)
1305     stack_top = (uintptr_t)high;
1306   } else {
1307     // failed, likely because /proc/self/maps does not exist
1308     warning(&quot;Can&#39;t detect primordial thread stack location - find_vma failed&quot;);
1309     // best effort: stack_start is normally within a few pages below the real
1310     // stack top, use it as stack top, and reduce stack size so we won&#39;t put
1311     // guard page outside stack.
1312     stack_top = stack_start;
1313     stack_size -= 16 * page_size();
1314   }
1315 
1316   // stack_top could be partially down the page so align it
1317   stack_top = align_up(stack_top, page_size());
1318 
1319   // Allowed stack value is minimum of max_size and what we derived from rlimit
1320   if (max_size &gt; 0) {
1321     _initial_thread_stack_size = MIN2(max_size, stack_size);
1322   } else {
1323     // Accept the rlimit max, but if stack is unlimited then it will be huge, so
1324     // clamp it at 8MB as we do on Solaris
1325     _initial_thread_stack_size = MIN2(stack_size, 8*M);
1326   }
1327   _initial_thread_stack_size = align_down(_initial_thread_stack_size, page_size());
1328   _initial_thread_stack_bottom = (address)stack_top - _initial_thread_stack_size;
1329 
1330   assert(_initial_thread_stack_bottom &lt; (address)stack_top, &quot;overflow!&quot;);
1331 
1332   if (log_is_enabled(Info, os, thread)) {
1333     // See if we seem to be on primordial process thread
1334     bool primordial = uintptr_t(&amp;rlim) &gt; uintptr_t(_initial_thread_stack_bottom) &amp;&amp;
1335                       uintptr_t(&amp;rlim) &lt; stack_top;
1336 
1337     log_info(os, thread)(&quot;Capturing initial stack in %s thread: req. size: &quot; SIZE_FORMAT &quot;K, actual size: &quot;
1338                          SIZE_FORMAT &quot;K, top=&quot; INTPTR_FORMAT &quot;, bottom=&quot; INTPTR_FORMAT,
1339                          primordial ? &quot;primordial&quot; : &quot;user&quot;, max_size / K,  _initial_thread_stack_size / K,
1340                          stack_top, intptr_t(_initial_thread_stack_bottom));
1341   }
1342 }
1343 
1344 ////////////////////////////////////////////////////////////////////////////////
1345 // time support
1346 
1347 #ifndef SUPPORTS_CLOCK_MONOTONIC
1348 #error &quot;Build platform doesn&#39;t support clock_gettime and related functionality&quot;
1349 #endif
1350 
1351 // Time since start-up in seconds to a fine granularity.
1352 // Used by VMSelfDestructTimer and the MemProfiler.
1353 double os::elapsedTime() {
1354 
1355   return ((double)os::elapsed_counter()) / os::elapsed_frequency(); // nanosecond resolution
1356 }
1357 
1358 jlong os::elapsed_counter() {
1359   return javaTimeNanos() - initial_time_count;
1360 }
1361 
1362 jlong os::elapsed_frequency() {
1363   return NANOSECS_PER_SEC; // nanosecond resolution
1364 }
1365 
1366 bool os::supports_vtime() { return true; }
1367 
1368 double os::elapsedVTime() {
1369   struct rusage usage;
1370   int retval = getrusage(RUSAGE_THREAD, &amp;usage);
1371   if (retval == 0) {
1372     return (double) (usage.ru_utime.tv_sec + usage.ru_stime.tv_sec) + (double) (usage.ru_utime.tv_usec + usage.ru_stime.tv_usec) / (1000 * 1000);
1373   } else {
1374     // better than nothing, but not much
1375     return elapsedTime();
1376   }
1377 }
1378 
1379 jlong os::javaTimeMillis() {
1380   timeval time;
1381   int status = gettimeofday(&amp;time, NULL);
1382   assert(status != -1, &quot;linux error&quot;);
1383   return jlong(time.tv_sec) * 1000  +  jlong(time.tv_usec / 1000);
1384 }
1385 
1386 void os::javaTimeSystemUTC(jlong &amp;seconds, jlong &amp;nanos) {
1387   timeval time;
1388   int status = gettimeofday(&amp;time, NULL);
1389   assert(status != -1, &quot;linux error&quot;);
1390   seconds = jlong(time.tv_sec);
1391   nanos = jlong(time.tv_usec) * 1000;
1392 }
1393 
1394 void os::Linux::fast_thread_clock_init() {
1395   if (!UseLinuxPosixThreadCPUClocks) {
1396     return;
1397   }
1398   clockid_t clockid;
1399   struct timespec tp;
1400   int (*pthread_getcpuclockid_func)(pthread_t, clockid_t *) =
1401       (int(*)(pthread_t, clockid_t *)) dlsym(RTLD_DEFAULT, &quot;pthread_getcpuclockid&quot;);
1402 
1403   // Switch to using fast clocks for thread cpu time if
1404   // the clock_getres() returns 0 error code.
1405   // Note, that some kernels may support the current thread
1406   // clock (CLOCK_THREAD_CPUTIME_ID) but not the clocks
1407   // returned by the pthread_getcpuclockid().
1408   // If the fast Posix clocks are supported then the clock_getres()
1409   // must return at least tp.tv_sec == 0 which means a resolution
1410   // better than 1 sec. This is extra check for reliability.
1411 
1412   if (pthread_getcpuclockid_func &amp;&amp;
1413       pthread_getcpuclockid_func(_main_thread, &amp;clockid) == 0 &amp;&amp;
1414       os::Posix::clock_getres(clockid, &amp;tp) == 0 &amp;&amp; tp.tv_sec == 0) {
1415     _supports_fast_thread_cpu_time = true;
1416     _pthread_getcpuclockid = pthread_getcpuclockid_func;
1417   }
1418 }
1419 
1420 jlong os::javaTimeNanos() {
1421   if (os::supports_monotonic_clock()) {
1422     struct timespec tp;
1423     int status = os::Posix::clock_gettime(CLOCK_MONOTONIC, &amp;tp);
1424     assert(status == 0, &quot;gettime error&quot;);
1425     jlong result = jlong(tp.tv_sec) * (1000 * 1000 * 1000) + jlong(tp.tv_nsec);
1426     return result;
1427   } else {
1428     timeval time;
1429     int status = gettimeofday(&amp;time, NULL);
1430     assert(status != -1, &quot;linux error&quot;);
1431     jlong usecs = jlong(time.tv_sec) * (1000 * 1000) + jlong(time.tv_usec);
1432     return 1000 * usecs;
1433   }
1434 }
1435 
1436 void os::javaTimeNanos_info(jvmtiTimerInfo *info_ptr) {
1437   if (os::supports_monotonic_clock()) {
1438     info_ptr-&gt;max_value = ALL_64_BITS;
1439 
1440     // CLOCK_MONOTONIC - amount of time since some arbitrary point in the past
1441     info_ptr-&gt;may_skip_backward = false;      // not subject to resetting or drifting
1442     info_ptr-&gt;may_skip_forward = false;       // not subject to resetting or drifting
1443   } else {
1444     // gettimeofday - based on time in seconds since the Epoch thus does not wrap
1445     info_ptr-&gt;max_value = ALL_64_BITS;
1446 
1447     // gettimeofday is a real time clock so it skips
1448     info_ptr-&gt;may_skip_backward = true;
1449     info_ptr-&gt;may_skip_forward = true;
1450   }
1451 
1452   info_ptr-&gt;kind = JVMTI_TIMER_ELAPSED;                // elapsed not CPU time
1453 }
1454 
1455 // Return the real, user, and system times in seconds from an
1456 // arbitrary fixed point in the past.
1457 bool os::getTimesSecs(double* process_real_time,
1458                       double* process_user_time,
1459                       double* process_system_time) {
1460   struct tms ticks;
1461   clock_t real_ticks = times(&amp;ticks);
1462 
1463   if (real_ticks == (clock_t) (-1)) {
1464     return false;
1465   } else {
1466     double ticks_per_second = (double) clock_tics_per_sec;
1467     *process_user_time = ((double) ticks.tms_utime) / ticks_per_second;
1468     *process_system_time = ((double) ticks.tms_stime) / ticks_per_second;
1469     *process_real_time = ((double) real_ticks) / ticks_per_second;
1470 
1471     return true;
1472   }
1473 }
1474 
1475 
1476 char * os::local_time_string(char *buf, size_t buflen) {
1477   struct tm t;
1478   time_t long_time;
1479   time(&amp;long_time);
1480   localtime_r(&amp;long_time, &amp;t);
1481   jio_snprintf(buf, buflen, &quot;%d-%02d-%02d %02d:%02d:%02d&quot;,
1482                t.tm_year + 1900, t.tm_mon + 1, t.tm_mday,
1483                t.tm_hour, t.tm_min, t.tm_sec);
1484   return buf;
1485 }
1486 
1487 struct tm* os::localtime_pd(const time_t* clock, struct tm*  res) {
1488   return localtime_r(clock, res);
1489 }
1490 
1491 ////////////////////////////////////////////////////////////////////////////////
1492 // runtime exit support
1493 
1494 // Note: os::shutdown() might be called very early during initialization, or
1495 // called from signal handler. Before adding something to os::shutdown(), make
1496 // sure it is async-safe and can handle partially initialized VM.
1497 void os::shutdown() {
1498 
1499   // allow PerfMemory to attempt cleanup of any persistent resources
1500   perfMemory_exit();
1501 
1502   // needs to remove object in file system
1503   AttachListener::abort();
1504 
1505   // flush buffered output, finish log files
1506   ostream_abort();
1507 
1508   // Check for abort hook
1509   abort_hook_t abort_hook = Arguments::abort_hook();
1510   if (abort_hook != NULL) {
1511     abort_hook();
1512   }
1513 
1514 }
1515 
1516 // Note: os::abort() might be called very early during initialization, or
1517 // called from signal handler. Before adding something to os::abort(), make
1518 // sure it is async-safe and can handle partially initialized VM.
1519 void os::abort(bool dump_core, void* siginfo, const void* context) {
1520   os::shutdown();
1521   if (dump_core) {
1522     if (DumpPrivateMappingsInCore) {
1523       ClassLoader::close_jrt_image();
1524     }
1525 #ifndef PRODUCT
1526     fdStream out(defaultStream::output_fd());
1527     out.print_raw(&quot;Current thread is &quot;);
1528     char buf[16];
1529     jio_snprintf(buf, sizeof(buf), UINTX_FORMAT, os::current_thread_id());
1530     out.print_raw_cr(buf);
1531     out.print_raw_cr(&quot;Dumping core ...&quot;);
1532 #endif
1533     ::abort(); // dump core
1534   }
1535 
1536   ::exit(1);
1537 }
1538 
1539 // Die immediately, no exit hook, no abort hook, no cleanup.
1540 // Dump a core file, if possible, for debugging.
1541 void os::die() {
1542   if (TestUnresponsiveErrorHandler &amp;&amp; !CreateCoredumpOnCrash) {
1543     // For TimeoutInErrorHandlingTest.java, we just kill the VM
1544     // and don&#39;t take the time to generate a core file.
1545     os::signal_raise(SIGKILL);
1546   } else {
1547     ::abort();
1548   }
1549 }
1550 
1551 // thread_id is kernel thread id (similar to Solaris LWP id)
1552 intx os::current_thread_id() { return os::Linux::gettid(); }
1553 int os::current_process_id() {
1554   return ::getpid();
1555 }
1556 
1557 // DLL functions
1558 
1559 const char* os::dll_file_extension() { return &quot;.so&quot;; }
1560 
1561 // This must be hard coded because it&#39;s the system&#39;s temporary
1562 // directory not the java application&#39;s temp directory, ala java.io.tmpdir.
1563 const char* os::get_temp_directory() { return &quot;/tmp&quot;; }
1564 
1565 static bool file_exists(const char* filename) {
1566   struct stat statbuf;
1567   if (filename == NULL || strlen(filename) == 0) {
1568     return false;
1569   }
1570   return os::stat(filename, &amp;statbuf) == 0;
1571 }
1572 
1573 // check if addr is inside libjvm.so
1574 bool os::address_is_in_vm(address addr) {
1575   static address libjvm_base_addr;
1576   Dl_info dlinfo;
1577 
1578   if (libjvm_base_addr == NULL) {
1579     if (dladdr(CAST_FROM_FN_PTR(void *, os::address_is_in_vm), &amp;dlinfo) != 0) {
1580       libjvm_base_addr = (address)dlinfo.dli_fbase;
1581     }
1582     assert(libjvm_base_addr !=NULL, &quot;Cannot obtain base address for libjvm&quot;);
1583   }
1584 
1585   if (dladdr((void *)addr, &amp;dlinfo) != 0) {
1586     if (libjvm_base_addr == (address)dlinfo.dli_fbase) return true;
1587   }
1588 
1589   return false;
1590 }
1591 
1592 bool os::dll_address_to_function_name(address addr, char *buf,
1593                                       int buflen, int *offset,
1594                                       bool demangle) {
1595   // buf is not optional, but offset is optional
1596   assert(buf != NULL, &quot;sanity check&quot;);
1597 
1598   Dl_info dlinfo;
1599 
1600   if (dladdr((void*)addr, &amp;dlinfo) != 0) {
1601     // see if we have a matching symbol
1602     if (dlinfo.dli_saddr != NULL &amp;&amp; dlinfo.dli_sname != NULL) {
1603       if (!(demangle &amp;&amp; Decoder::demangle(dlinfo.dli_sname, buf, buflen))) {
1604         jio_snprintf(buf, buflen, &quot;%s&quot;, dlinfo.dli_sname);
1605       }
1606       if (offset != NULL) *offset = addr - (address)dlinfo.dli_saddr;
1607       return true;
1608     }
1609     // no matching symbol so try for just file info
1610     if (dlinfo.dli_fname != NULL &amp;&amp; dlinfo.dli_fbase != NULL) {
1611       if (Decoder::decode((address)(addr - (address)dlinfo.dli_fbase),
1612                           buf, buflen, offset, dlinfo.dli_fname, demangle)) {
1613         return true;
1614       }
1615     }
1616   }
1617 
1618   buf[0] = &#39;\0&#39;;
1619   if (offset != NULL) *offset = -1;
1620   return false;
1621 }
1622 
1623 struct _address_to_library_name {
1624   address addr;          // input : memory address
1625   size_t  buflen;        //         size of fname
1626   char*   fname;         // output: library name
1627   address base;          //         library base addr
1628 };
1629 
1630 static int address_to_library_name_callback(struct dl_phdr_info *info,
1631                                             size_t size, void *data) {
1632   int i;
1633   bool found = false;
1634   address libbase = NULL;
1635   struct _address_to_library_name * d = (struct _address_to_library_name *)data;
1636 
1637   // iterate through all loadable segments
1638   for (i = 0; i &lt; info-&gt;dlpi_phnum; i++) {
1639     address segbase = (address)(info-&gt;dlpi_addr + info-&gt;dlpi_phdr[i].p_vaddr);
1640     if (info-&gt;dlpi_phdr[i].p_type == PT_LOAD) {
1641       // base address of a library is the lowest address of its loaded
1642       // segments.
1643       if (libbase == NULL || libbase &gt; segbase) {
1644         libbase = segbase;
1645       }
1646       // see if &#39;addr&#39; is within current segment
1647       if (segbase &lt;= d-&gt;addr &amp;&amp;
1648           d-&gt;addr &lt; segbase + info-&gt;dlpi_phdr[i].p_memsz) {
1649         found = true;
1650       }
1651     }
1652   }
1653 
1654   // dlpi_name is NULL or empty if the ELF file is executable, return 0
1655   // so dll_address_to_library_name() can fall through to use dladdr() which
1656   // can figure out executable name from argv[0].
1657   if (found &amp;&amp; info-&gt;dlpi_name &amp;&amp; info-&gt;dlpi_name[0]) {
1658     d-&gt;base = libbase;
1659     if (d-&gt;fname) {
1660       jio_snprintf(d-&gt;fname, d-&gt;buflen, &quot;%s&quot;, info-&gt;dlpi_name);
1661     }
1662     return 1;
1663   }
1664   return 0;
1665 }
1666 
1667 bool os::dll_address_to_library_name(address addr, char* buf,
1668                                      int buflen, int* offset) {
1669   // buf is not optional, but offset is optional
1670   assert(buf != NULL, &quot;sanity check&quot;);
1671 
1672   Dl_info dlinfo;
1673   struct _address_to_library_name data;
1674 
1675   // There is a bug in old glibc dladdr() implementation that it could resolve
1676   // to wrong library name if the .so file has a base address != NULL. Here
1677   // we iterate through the program headers of all loaded libraries to find
1678   // out which library &#39;addr&#39; really belongs to. This workaround can be
1679   // removed once the minimum requirement for glibc is moved to 2.3.x.
1680   data.addr = addr;
1681   data.fname = buf;
1682   data.buflen = buflen;
1683   data.base = NULL;
1684   int rslt = dl_iterate_phdr(address_to_library_name_callback, (void *)&amp;data);
1685 
1686   if (rslt) {
1687     // buf already contains library name
1688     if (offset) *offset = addr - data.base;
1689     return true;
1690   }
1691   if (dladdr((void*)addr, &amp;dlinfo) != 0) {
1692     if (dlinfo.dli_fname != NULL) {
1693       jio_snprintf(buf, buflen, &quot;%s&quot;, dlinfo.dli_fname);
1694     }
1695     if (dlinfo.dli_fbase != NULL &amp;&amp; offset != NULL) {
1696       *offset = addr - (address)dlinfo.dli_fbase;
1697     }
1698     return true;
1699   }
1700 
1701   buf[0] = &#39;\0&#39;;
1702   if (offset) *offset = -1;
1703   return false;
1704 }
1705 
1706 // Loads .dll/.so and
1707 // in case of error it checks if .dll/.so was built for the
1708 // same architecture as Hotspot is running on
1709 
1710 
1711 // Remember the stack&#39;s state. The Linux dynamic linker will change
1712 // the stack to &#39;executable&#39; at most once, so we must safepoint only once.
1713 bool os::Linux::_stack_is_executable = false;
1714 
1715 // VM operation that loads a library.  This is necessary if stack protection
1716 // of the Java stacks can be lost during loading the library.  If we
1717 // do not stop the Java threads, they can stack overflow before the stacks
1718 // are protected again.
1719 class VM_LinuxDllLoad: public VM_Operation {
1720  private:
1721   const char *_filename;
1722   char *_ebuf;
1723   int _ebuflen;
1724   void *_lib;
1725  public:
1726   VM_LinuxDllLoad(const char *fn, char *ebuf, int ebuflen) :
1727     _filename(fn), _ebuf(ebuf), _ebuflen(ebuflen), _lib(NULL) {}
1728   VMOp_Type type() const { return VMOp_LinuxDllLoad; }
1729   void doit() {
1730     _lib = os::Linux::dll_load_in_vmthread(_filename, _ebuf, _ebuflen);
1731     os::Linux::_stack_is_executable = true;
1732   }
1733   void* loaded_library() { return _lib; }
1734 };
1735 
1736 void * os::dll_load(const char *filename, char *ebuf, int ebuflen) {
1737   void * result = NULL;
1738   bool load_attempted = false;
1739 
1740   log_info(os)(&quot;attempting shared library load of %s&quot;, filename);
1741 
1742   // Check whether the library to load might change execution rights
1743   // of the stack. If they are changed, the protection of the stack
1744   // guard pages will be lost. We need a safepoint to fix this.
1745   //
1746   // See Linux man page execstack(8) for more info.
1747   if (os::uses_stack_guard_pages() &amp;&amp; !os::Linux::_stack_is_executable) {
1748     if (!ElfFile::specifies_noexecstack(filename)) {
1749       if (!is_init_completed()) {
1750         os::Linux::_stack_is_executable = true;
1751         // This is OK - No Java threads have been created yet, and hence no
1752         // stack guard pages to fix.
1753         //
1754         // Dynamic loader will make all stacks executable after
1755         // this function returns, and will not do that again.
1756         assert(Threads::number_of_threads() == 0, &quot;no Java threads should exist yet.&quot;);
1757       } else {
1758         warning(&quot;You have loaded library %s which might have disabled stack guard. &quot;
1759                 &quot;The VM will try to fix the stack guard now.\n&quot;
1760                 &quot;It&#39;s highly recommended that you fix the library with &quot;
1761                 &quot;&#39;execstack -c &lt;libfile&gt;&#39;, or link it with &#39;-z noexecstack&#39;.&quot;,
1762                 filename);
1763 
1764         assert(Thread::current()-&gt;is_Java_thread(), &quot;must be Java thread&quot;);
1765         JavaThread *jt = JavaThread::current();
1766         if (jt-&gt;thread_state() != _thread_in_native) {
1767           // This happens when a compiler thread tries to load a hsdis-&lt;arch&gt;.so file
1768           // that requires ExecStack. Cannot enter safe point. Let&#39;s give up.
1769           warning(&quot;Unable to fix stack guard. Giving up.&quot;);
1770         } else {
1771           if (!LoadExecStackDllInVMThread) {
1772             // This is for the case where the DLL has an static
1773             // constructor function that executes JNI code. We cannot
1774             // load such DLLs in the VMThread.
1775             result = os::Linux::dlopen_helper(filename, ebuf, ebuflen);
1776           }
1777 
1778           ThreadInVMfromNative tiv(jt);
1779           debug_only(VMNativeEntryWrapper vew;)
1780 
1781           VM_LinuxDllLoad op(filename, ebuf, ebuflen);
1782           VMThread::execute(&amp;op);
1783           if (LoadExecStackDllInVMThread) {
1784             result = op.loaded_library();
1785           }
1786           load_attempted = true;
1787         }
1788       }
1789     }
1790   }
1791 
1792   if (!load_attempted) {
1793     result = os::Linux::dlopen_helper(filename, ebuf, ebuflen);
1794   }
1795 
1796   if (result != NULL) {
1797     // Successful loading
1798     return result;
1799   }
1800 
1801   Elf32_Ehdr elf_head;
1802   int diag_msg_max_length=ebuflen-strlen(ebuf);
1803   char* diag_msg_buf=ebuf+strlen(ebuf);
1804 
1805   if (diag_msg_max_length==0) {
1806     // No more space in ebuf for additional diagnostics message
1807     return NULL;
1808   }
1809 
1810 
1811   int file_descriptor= ::open(filename, O_RDONLY | O_NONBLOCK);
1812 
1813   if (file_descriptor &lt; 0) {
1814     // Can&#39;t open library, report dlerror() message
1815     return NULL;
1816   }
1817 
1818   bool failed_to_read_elf_head=
1819     (sizeof(elf_head)!=
1820      (::read(file_descriptor, &amp;elf_head,sizeof(elf_head))));
1821 
1822   ::close(file_descriptor);
1823   if (failed_to_read_elf_head) {
1824     // file i/o error - report dlerror() msg
1825     return NULL;
1826   }
1827 
1828   if (elf_head.e_ident[EI_DATA] != LITTLE_ENDIAN_ONLY(ELFDATA2LSB) BIG_ENDIAN_ONLY(ELFDATA2MSB)) {
1829     // handle invalid/out of range endianness values
1830     if (elf_head.e_ident[EI_DATA] == 0 || elf_head.e_ident[EI_DATA] &gt; 2) {
1831       return NULL;
1832     }
1833 
1834 #if defined(VM_LITTLE_ENDIAN)
1835     // VM is LE, shared object BE
1836     elf_head.e_machine = be16toh(elf_head.e_machine);
1837 #else
1838     // VM is BE, shared object LE
1839     elf_head.e_machine = le16toh(elf_head.e_machine);
1840 #endif
1841   }
1842 
1843   typedef struct {
1844     Elf32_Half    code;         // Actual value as defined in elf.h
1845     Elf32_Half    compat_class; // Compatibility of archs at VM&#39;s sense
1846     unsigned char elf_class;    // 32 or 64 bit
1847     unsigned char endianness;   // MSB or LSB
1848     char*         name;         // String representation
1849   } arch_t;
1850 
1851 #ifndef EM_486
1852   #define EM_486          6               /* Intel 80486 */
1853 #endif
1854 #ifndef EM_AARCH64
1855   #define EM_AARCH64    183               /* ARM AARCH64 */
1856 #endif
1857 
1858   static const arch_t arch_array[]={
1859     {EM_386,         EM_386,     ELFCLASS32, ELFDATA2LSB, (char*)&quot;IA 32&quot;},
1860     {EM_486,         EM_386,     ELFCLASS32, ELFDATA2LSB, (char*)&quot;IA 32&quot;},
1861     {EM_IA_64,       EM_IA_64,   ELFCLASS64, ELFDATA2LSB, (char*)&quot;IA 64&quot;},
1862     {EM_X86_64,      EM_X86_64,  ELFCLASS64, ELFDATA2LSB, (char*)&quot;AMD 64&quot;},
1863     {EM_SPARC,       EM_SPARC,   ELFCLASS32, ELFDATA2MSB, (char*)&quot;Sparc 32&quot;},
1864     {EM_SPARC32PLUS, EM_SPARC,   ELFCLASS32, ELFDATA2MSB, (char*)&quot;Sparc 32&quot;},
1865     {EM_SPARCV9,     EM_SPARCV9, ELFCLASS64, ELFDATA2MSB, (char*)&quot;Sparc v9 64&quot;},
1866     {EM_PPC,         EM_PPC,     ELFCLASS32, ELFDATA2MSB, (char*)&quot;Power PC 32&quot;},
1867 #if defined(VM_LITTLE_ENDIAN)
1868     {EM_PPC64,       EM_PPC64,   ELFCLASS64, ELFDATA2LSB, (char*)&quot;Power PC 64 LE&quot;},
1869     {EM_SH,          EM_SH,      ELFCLASS32, ELFDATA2LSB, (char*)&quot;SuperH&quot;},
1870 #else
1871     {EM_PPC64,       EM_PPC64,   ELFCLASS64, ELFDATA2MSB, (char*)&quot;Power PC 64&quot;},
1872     {EM_SH,          EM_SH,      ELFCLASS32, ELFDATA2MSB, (char*)&quot;SuperH BE&quot;},
1873 #endif
1874     {EM_ARM,         EM_ARM,     ELFCLASS32, ELFDATA2LSB, (char*)&quot;ARM&quot;},
1875     // we only support 64 bit z architecture
1876     {EM_S390,        EM_S390,    ELFCLASS64, ELFDATA2MSB, (char*)&quot;IBM System/390&quot;},
1877     {EM_ALPHA,       EM_ALPHA,   ELFCLASS64, ELFDATA2LSB, (char*)&quot;Alpha&quot;},
1878     {EM_MIPS_RS3_LE, EM_MIPS_RS3_LE, ELFCLASS32, ELFDATA2LSB, (char*)&quot;MIPSel&quot;},
1879     {EM_MIPS,        EM_MIPS,    ELFCLASS32, ELFDATA2MSB, (char*)&quot;MIPS&quot;},
1880     {EM_PARISC,      EM_PARISC,  ELFCLASS32, ELFDATA2MSB, (char*)&quot;PARISC&quot;},
1881     {EM_68K,         EM_68K,     ELFCLASS32, ELFDATA2MSB, (char*)&quot;M68k&quot;},
1882     {EM_AARCH64,     EM_AARCH64, ELFCLASS64, ELFDATA2LSB, (char*)&quot;AARCH64&quot;},
1883   };
1884 
1885 #if  (defined IA32)
1886   static  Elf32_Half running_arch_code=EM_386;
1887 #elif   (defined AMD64) || (defined X32)
1888   static  Elf32_Half running_arch_code=EM_X86_64;
1889 #elif  (defined IA64)
1890   static  Elf32_Half running_arch_code=EM_IA_64;
1891 #elif  (defined __sparc) &amp;&amp; (defined _LP64)
1892   static  Elf32_Half running_arch_code=EM_SPARCV9;
1893 #elif  (defined __sparc) &amp;&amp; (!defined _LP64)
1894   static  Elf32_Half running_arch_code=EM_SPARC;
1895 #elif  (defined __powerpc64__)
1896   static  Elf32_Half running_arch_code=EM_PPC64;
1897 #elif  (defined __powerpc__)
1898   static  Elf32_Half running_arch_code=EM_PPC;
1899 #elif  (defined AARCH64)
1900   static  Elf32_Half running_arch_code=EM_AARCH64;
1901 #elif  (defined ARM)
1902   static  Elf32_Half running_arch_code=EM_ARM;
1903 #elif  (defined S390)
1904   static  Elf32_Half running_arch_code=EM_S390;
1905 #elif  (defined ALPHA)
1906   static  Elf32_Half running_arch_code=EM_ALPHA;
1907 #elif  (defined MIPSEL)
1908   static  Elf32_Half running_arch_code=EM_MIPS_RS3_LE;
1909 #elif  (defined PARISC)
1910   static  Elf32_Half running_arch_code=EM_PARISC;
1911 #elif  (defined MIPS)
1912   static  Elf32_Half running_arch_code=EM_MIPS;
1913 #elif  (defined M68K)
1914   static  Elf32_Half running_arch_code=EM_68K;
1915 #elif  (defined SH)
1916   static  Elf32_Half running_arch_code=EM_SH;
1917 #else
1918     #error Method os::dll_load requires that one of following is defined:\
1919         AARCH64, ALPHA, ARM, AMD64, IA32, IA64, M68K, MIPS, MIPSEL, PARISC, __powerpc__, __powerpc64__, S390, SH, __sparc
1920 #endif
1921 
1922   // Identify compatibility class for VM&#39;s architecture and library&#39;s architecture
1923   // Obtain string descriptions for architectures
1924 
1925   arch_t lib_arch={elf_head.e_machine,0,elf_head.e_ident[EI_CLASS], elf_head.e_ident[EI_DATA], NULL};
1926   int running_arch_index=-1;
1927 
1928   for (unsigned int i=0; i &lt; ARRAY_SIZE(arch_array); i++) {
1929     if (running_arch_code == arch_array[i].code) {
1930       running_arch_index    = i;
1931     }
1932     if (lib_arch.code == arch_array[i].code) {
1933       lib_arch.compat_class = arch_array[i].compat_class;
1934       lib_arch.name         = arch_array[i].name;
1935     }
1936   }
1937 
1938   assert(running_arch_index != -1,
1939          &quot;Didn&#39;t find running architecture code (running_arch_code) in arch_array&quot;);
1940   if (running_arch_index == -1) {
1941     // Even though running architecture detection failed
1942     // we may still continue with reporting dlerror() message
1943     return NULL;
1944   }
1945 
1946   if (lib_arch.compat_class != arch_array[running_arch_index].compat_class) {
1947     if (lib_arch.name != NULL) {
1948       ::snprintf(diag_msg_buf, diag_msg_max_length-1,
1949                  &quot; (Possible cause: can&#39;t load %s .so on a %s platform)&quot;,
1950                  lib_arch.name, arch_array[running_arch_index].name);
1951     } else {
1952       ::snprintf(diag_msg_buf, diag_msg_max_length-1,
1953                  &quot; (Possible cause: can&#39;t load this .so (machine code=0x%x) on a %s platform)&quot;,
1954                  lib_arch.code, arch_array[running_arch_index].name);
1955     }
1956     return NULL;
1957   }
1958 
1959   if (lib_arch.endianness != arch_array[running_arch_index].endianness) {
1960     ::snprintf(diag_msg_buf, diag_msg_max_length-1, &quot; (Possible cause: endianness mismatch)&quot;);
1961     return NULL;
1962   }
1963 
1964   // ELF file class/capacity : 0 - invalid, 1 - 32bit, 2 - 64bit
1965   if (lib_arch.elf_class &gt; 2 || lib_arch.elf_class &lt; 1) {
1966     ::snprintf(diag_msg_buf, diag_msg_max_length-1, &quot; (Possible cause: invalid ELF file class)&quot;);
1967     return NULL;
1968   }
1969 
1970   if (lib_arch.elf_class != arch_array[running_arch_index].elf_class) {
1971     ::snprintf(diag_msg_buf, diag_msg_max_length-1,
1972                &quot; (Possible cause: architecture word width mismatch, can&#39;t load %d-bit .so on a %d-bit platform)&quot;,
1973                (int) lib_arch.elf_class * 32, arch_array[running_arch_index].elf_class * 32);
1974     return NULL;
1975   }
1976 
1977   return NULL;
1978 }
1979 
1980 void * os::Linux::dlopen_helper(const char *filename, char *ebuf,
1981                                 int ebuflen) {
1982   void * result = ::dlopen(filename, RTLD_LAZY);
1983   if (result == NULL) {
1984     const char* error_report = ::dlerror();
1985     if (error_report == NULL) {
1986       error_report = &quot;dlerror returned no error description&quot;;
1987     }
1988     if (ebuf != NULL &amp;&amp; ebuflen &gt; 0) {
1989       ::strncpy(ebuf, error_report, ebuflen-1);
1990       ebuf[ebuflen-1]=&#39;\0&#39;;
1991     }
1992     Events::log(NULL, &quot;Loading shared library %s failed, %s&quot;, filename, error_report);
1993     log_info(os)(&quot;shared library load of %s failed, %s&quot;, filename, error_report);
1994   } else {
1995     Events::log(NULL, &quot;Loaded shared library %s&quot;, filename);
1996     log_info(os)(&quot;shared library load of %s was successful&quot;, filename);
1997   }
1998   return result;
1999 }
2000 
2001 void * os::Linux::dll_load_in_vmthread(const char *filename, char *ebuf,
2002                                        int ebuflen) {
2003   void * result = NULL;
2004   if (LoadExecStackDllInVMThread) {
2005     result = dlopen_helper(filename, ebuf, ebuflen);
2006   }
2007 
2008   // Since 7019808, libjvm.so is linked with -noexecstack. If the VM loads a
2009   // library that requires an executable stack, or which does not have this
2010   // stack attribute set, dlopen changes the stack attribute to executable. The
2011   // read protection of the guard pages gets lost.
2012   //
2013   // Need to check _stack_is_executable again as multiple VM_LinuxDllLoad
2014   // may have been queued at the same time.
2015 
2016   if (!_stack_is_executable) {
2017     for (JavaThreadIteratorWithHandle jtiwh; JavaThread *jt = jtiwh.next(); ) {
2018       if (!jt-&gt;stack_guard_zone_unused() &amp;&amp;     // Stack not yet fully initialized
2019           jt-&gt;stack_guards_enabled()) {         // No pending stack overflow exceptions
2020         if (!os::guard_memory((char *)jt-&gt;stack_end(), jt-&gt;stack_guard_zone_size())) {
2021           warning(&quot;Attempt to reguard stack yellow zone failed.&quot;);
2022         }
2023       }
2024     }
2025   }
2026 
2027   return result;
2028 }
2029 
2030 void* os::dll_lookup(void* handle, const char* name) {
2031   void* res = dlsym(handle, name);
2032   return res;
2033 }
2034 
2035 void* os::get_default_process_handle() {
2036   return (void*)::dlopen(NULL, RTLD_LAZY);
2037 }
2038 
2039 static bool _print_ascii_file(const char* filename, outputStream* st, const char* hdr = NULL) {
2040   int fd = ::open(filename, O_RDONLY);
2041   if (fd == -1) {
2042     return false;
2043   }
2044 
2045   if (hdr != NULL) {
2046     st-&gt;print_cr(&quot;%s&quot;, hdr);
2047   }
2048 
2049   char buf[33];
2050   int bytes;
2051   buf[32] = &#39;\0&#39;;
2052   while ((bytes = ::read(fd, buf, sizeof(buf)-1)) &gt; 0) {
2053     st-&gt;print_raw(buf, bytes);
2054   }
2055 
2056   ::close(fd);
2057 
2058   return true;
2059 }
2060 
2061 void os::print_dll_info(outputStream *st) {
2062   st-&gt;print_cr(&quot;Dynamic libraries:&quot;);
2063 
2064   char fname[32];
2065   pid_t pid = os::Linux::gettid();
2066 
2067   jio_snprintf(fname, sizeof(fname), &quot;/proc/%d/maps&quot;, pid);
2068 
2069   if (!_print_ascii_file(fname, st)) {
2070     st-&gt;print(&quot;Can not get library information for pid = %d\n&quot;, pid);
2071   }
2072 }
2073 
2074 int os::get_loaded_modules_info(os::LoadedModulesCallbackFunc callback, void *param) {
2075   FILE *procmapsFile = NULL;
2076 
2077   // Open the procfs maps file for the current process
2078   if ((procmapsFile = fopen(&quot;/proc/self/maps&quot;, &quot;r&quot;)) != NULL) {
2079     // Allocate PATH_MAX for file name plus a reasonable size for other fields.
2080     char line[PATH_MAX + 100];
2081 
2082     // Read line by line from &#39;file&#39;
2083     while (fgets(line, sizeof(line), procmapsFile) != NULL) {
2084       u8 base, top, offset, inode;
2085       char permissions[5];
2086       char device[6];
2087       char name[sizeof(line)];
2088 
2089       // Parse fields from line
2090       int matches = sscanf(line, UINT64_FORMAT_X &quot;-&quot; UINT64_FORMAT_X &quot; %4s &quot; UINT64_FORMAT_X &quot; %5s &quot; INT64_FORMAT &quot; %s&quot;,
2091              &amp;base, &amp;top, permissions, &amp;offset, device, &amp;inode, name);
2092       // the last entry &#39;name&#39; is empty for some entries, so we might have 6 matches instead of 7 for some lines
2093       if (matches &lt; 6) continue;
2094       if (matches == 6) name[0] = &#39;\0&#39;;
2095 
2096       // Filter by device id &#39;00:00&#39; so that we only get file system mapped files.
2097       if (strcmp(device, &quot;00:00&quot;) != 0) {
2098 
2099         // Call callback with the fields of interest
2100         if(callback(name, (address)base, (address)top, param)) {
2101           // Oops abort, callback aborted
2102           fclose(procmapsFile);
2103           return 1;
2104         }
2105       }
2106     }
2107     fclose(procmapsFile);
2108   }
2109   return 0;
2110 }
2111 
2112 void os::print_os_info_brief(outputStream* st) {
2113   os::Linux::print_distro_info(st);
2114 
2115   os::Posix::print_uname_info(st);
2116 
2117   os::Linux::print_libversion_info(st);
2118 
2119 }
2120 
2121 void os::print_os_info(outputStream* st) {
2122   st-&gt;print(&quot;OS:&quot;);
2123 
2124   os::Linux::print_distro_info(st);
2125 
2126   os::Posix::print_uname_info(st);
2127 
2128   os::Linux::print_uptime_info(st);
2129 
2130   // Print warning if unsafe chroot environment detected
2131   if (unsafe_chroot_detected) {
2132     st-&gt;print(&quot;WARNING!! &quot;);
2133     st-&gt;print_cr(&quot;%s&quot;, unstable_chroot_error);
2134   }
2135 
2136   os::Linux::print_libversion_info(st);
2137 
2138   os::Posix::print_rlimit_info(st);
2139 
2140   os::Posix::print_load_average(st);
2141 
2142   os::Linux::print_full_memory_info(st);
2143 
2144   os::Linux::print_proc_sys_info(st);
2145 
2146   os::Linux::print_ld_preload_file(st);
2147 
2148   os::Linux::print_container_info(st);
2149 
2150   VM_Version::print_platform_virtualization_info(st);
2151 
2152   os::Linux::print_steal_info(st);
2153 }
2154 
2155 // Try to identify popular distros.
2156 // Most Linux distributions have a /etc/XXX-release file, which contains
2157 // the OS version string. Newer Linux distributions have a /etc/lsb-release
2158 // file that also contains the OS version string. Some have more than one
2159 // /etc/XXX-release file (e.g. Mandrake has both /etc/mandrake-release and
2160 // /etc/redhat-release.), so the order is important.
2161 // Any Linux that is based on Redhat (i.e. Oracle, Mandrake, Sun JDS...) have
2162 // their own specific XXX-release file as well as a redhat-release file.
2163 // Because of this the XXX-release file needs to be searched for before the
2164 // redhat-release file.
2165 // Since Red Hat and SuSE have an lsb-release file that is not very descriptive the
2166 // search for redhat-release / SuSE-release needs to be before lsb-release.
2167 // Since the lsb-release file is the new standard it needs to be searched
2168 // before the older style release files.
2169 // Searching system-release (Red Hat) and os-release (other Linuxes) are a
2170 // next to last resort.  The os-release file is a new standard that contains
2171 // distribution information and the system-release file seems to be an old
2172 // standard that has been replaced by the lsb-release and os-release files.
2173 // Searching for the debian_version file is the last resort.  It contains
2174 // an informative string like &quot;6.0.6&quot; or &quot;wheezy/sid&quot;. Because of this
2175 // &quot;Debian &quot; is printed before the contents of the debian_version file.
2176 
2177 const char* distro_files[] = {
2178   &quot;/etc/oracle-release&quot;,
2179   &quot;/etc/mandriva-release&quot;,
2180   &quot;/etc/mandrake-release&quot;,
2181   &quot;/etc/sun-release&quot;,
2182   &quot;/etc/redhat-release&quot;,
2183   &quot;/etc/SuSE-release&quot;,
2184   &quot;/etc/lsb-release&quot;,
2185   &quot;/etc/turbolinux-release&quot;,
2186   &quot;/etc/gentoo-release&quot;,
2187   &quot;/etc/ltib-release&quot;,
2188   &quot;/etc/angstrom-version&quot;,
2189   &quot;/etc/system-release&quot;,
2190   &quot;/etc/os-release&quot;,
2191   NULL };
2192 
2193 void os::Linux::print_distro_info(outputStream* st) {
2194   for (int i = 0;; i++) {
2195     const char* file = distro_files[i];
2196     if (file == NULL) {
2197       break;  // done
2198     }
2199     // If file prints, we found it.
2200     if (_print_ascii_file(file, st)) {
2201       return;
2202     }
2203   }
2204 
2205   if (file_exists(&quot;/etc/debian_version&quot;)) {
2206     st-&gt;print(&quot;Debian &quot;);
2207     _print_ascii_file(&quot;/etc/debian_version&quot;, st);
2208   } else {
2209     st-&gt;print(&quot;Linux&quot;);
2210   }
2211   st-&gt;cr();
2212 }
2213 
2214 static void parse_os_info_helper(FILE* fp, char* distro, size_t length, bool get_first_line) {
2215   char buf[256];
2216   while (fgets(buf, sizeof(buf), fp)) {
2217     // Edit out extra stuff in expected format
2218     if (strstr(buf, &quot;DISTRIB_DESCRIPTION=&quot;) != NULL || strstr(buf, &quot;PRETTY_NAME=&quot;) != NULL) {
2219       char* ptr = strstr(buf, &quot;\&quot;&quot;);  // the name is in quotes
2220       if (ptr != NULL) {
2221         ptr++; // go beyond first quote
2222         char* nl = strchr(ptr, &#39;\&quot;&#39;);
2223         if (nl != NULL) *nl = &#39;\0&#39;;
2224         strncpy(distro, ptr, length);
2225       } else {
2226         ptr = strstr(buf, &quot;=&quot;);
2227         ptr++; // go beyond equals then
2228         char* nl = strchr(ptr, &#39;\n&#39;);
2229         if (nl != NULL) *nl = &#39;\0&#39;;
2230         strncpy(distro, ptr, length);
2231       }
2232       return;
2233     } else if (get_first_line) {
2234       char* nl = strchr(buf, &#39;\n&#39;);
2235       if (nl != NULL) *nl = &#39;\0&#39;;
2236       strncpy(distro, buf, length);
2237       return;
2238     }
2239   }
2240   // print last line and close
2241   char* nl = strchr(buf, &#39;\n&#39;);
2242   if (nl != NULL) *nl = &#39;\0&#39;;
2243   strncpy(distro, buf, length);
2244 }
2245 
2246 static void parse_os_info(char* distro, size_t length, const char* file) {
2247   FILE* fp = fopen(file, &quot;r&quot;);
2248   if (fp != NULL) {
2249     // if suse format, print out first line
2250     bool get_first_line = (strcmp(file, &quot;/etc/SuSE-release&quot;) == 0);
2251     parse_os_info_helper(fp, distro, length, get_first_line);
2252     fclose(fp);
2253   }
2254 }
2255 
2256 void os::get_summary_os_info(char* buf, size_t buflen) {
2257   for (int i = 0;; i++) {
2258     const char* file = distro_files[i];
2259     if (file == NULL) {
2260       break; // ran out of distro_files
2261     }
2262     if (file_exists(file)) {
2263       parse_os_info(buf, buflen, file);
2264       return;
2265     }
2266   }
2267   // special case for debian
2268   if (file_exists(&quot;/etc/debian_version&quot;)) {
2269     strncpy(buf, &quot;Debian &quot;, buflen);
2270     if (buflen &gt; 7) {
2271       parse_os_info(&amp;buf[7], buflen-7, &quot;/etc/debian_version&quot;);
2272     }
2273   } else {
2274     strncpy(buf, &quot;Linux&quot;, buflen);
2275   }
2276 }
2277 
2278 void os::Linux::print_libversion_info(outputStream* st) {
2279   // libc, pthread
2280   st-&gt;print(&quot;libc:&quot;);
2281   st-&gt;print(&quot;%s &quot;, os::Linux::glibc_version());
2282   st-&gt;print(&quot;%s &quot;, os::Linux::libpthread_version());
2283   st-&gt;cr();
2284 }
2285 
2286 void os::Linux::print_proc_sys_info(outputStream* st) {
2287   st-&gt;cr();
2288   st-&gt;print_cr(&quot;/proc/sys/kernel/threads-max (system-wide limit on the number of threads):&quot;);
2289   _print_ascii_file(&quot;/proc/sys/kernel/threads-max&quot;, st);
2290   st-&gt;cr();
2291   st-&gt;cr();
2292 
2293   st-&gt;print_cr(&quot;/proc/sys/vm/max_map_count (maximum number of memory map areas a process may have):&quot;);
2294   _print_ascii_file(&quot;/proc/sys/vm/max_map_count&quot;, st);
2295   st-&gt;cr();
2296   st-&gt;cr();
2297 
2298   st-&gt;print_cr(&quot;/proc/sys/kernel/pid_max (system-wide limit on number of process identifiers):&quot;);
2299   _print_ascii_file(&quot;/proc/sys/kernel/pid_max&quot;, st);
2300   st-&gt;cr();
2301   st-&gt;cr();
2302 }
2303 
2304 void os::Linux::print_full_memory_info(outputStream* st) {
2305   st-&gt;print(&quot;\n/proc/meminfo:\n&quot;);
2306   _print_ascii_file(&quot;/proc/meminfo&quot;, st);
2307   st-&gt;cr();
2308 }
2309 
2310 void os::Linux::print_ld_preload_file(outputStream* st) {
2311   _print_ascii_file(&quot;/etc/ld.so.preload&quot;, st, &quot;\n/etc/ld.so.preload:&quot;);
2312   st-&gt;cr();
2313 }
2314 
2315 void os::Linux::print_uptime_info(outputStream* st) {
2316   struct sysinfo sinfo;
2317   int ret = sysinfo(&amp;sinfo);
2318   if (ret == 0) {
2319     os::print_dhm(st, &quot;OS uptime:&quot;, (long) sinfo.uptime);
2320   }
2321 }
2322 
2323 
2324 void os::Linux::print_container_info(outputStream* st) {
2325   if (!OSContainer::is_containerized()) {
2326     return;
2327   }
2328 
2329   st-&gt;print(&quot;container (cgroup) information:\n&quot;);
2330 
2331   const char *p_ct = OSContainer::container_type();
2332   st-&gt;print(&quot;container_type: %s\n&quot;, p_ct != NULL ? p_ct : &quot;not supported&quot;);
2333 
2334   char *p = OSContainer::cpu_cpuset_cpus();
2335   st-&gt;print(&quot;cpu_cpuset_cpus: %s\n&quot;, p != NULL ? p : &quot;not supported&quot;);
2336   free(p);
2337 
2338   p = OSContainer::cpu_cpuset_memory_nodes();
2339   st-&gt;print(&quot;cpu_memory_nodes: %s\n&quot;, p != NULL ? p : &quot;not supported&quot;);
2340   free(p);
2341 
2342   int i = OSContainer::active_processor_count();
2343   st-&gt;print(&quot;active_processor_count: &quot;);
2344   if (i &gt; 0) {
2345     st-&gt;print(&quot;%d\n&quot;, i);
2346   } else {
2347     st-&gt;print(&quot;not supported\n&quot;);
2348   }
2349 
2350   i = OSContainer::cpu_quota();
2351   st-&gt;print(&quot;cpu_quota: &quot;);
2352   if (i &gt; 0) {
2353     st-&gt;print(&quot;%d\n&quot;, i);
2354   } else {
2355     st-&gt;print(&quot;%s\n&quot;, i == OSCONTAINER_ERROR ? &quot;not supported&quot; : &quot;no quota&quot;);
2356   }
2357 
2358   i = OSContainer::cpu_period();
2359   st-&gt;print(&quot;cpu_period: &quot;);
2360   if (i &gt; 0) {
2361     st-&gt;print(&quot;%d\n&quot;, i);
2362   } else {
2363     st-&gt;print(&quot;%s\n&quot;, i == OSCONTAINER_ERROR ? &quot;not supported&quot; : &quot;no period&quot;);
2364   }
2365 
2366   i = OSContainer::cpu_shares();
2367   st-&gt;print(&quot;cpu_shares: &quot;);
2368   if (i &gt; 0) {
2369     st-&gt;print(&quot;%d\n&quot;, i);
2370   } else {
2371     st-&gt;print(&quot;%s\n&quot;, i == OSCONTAINER_ERROR ? &quot;not supported&quot; : &quot;no shares&quot;);
2372   }
2373 
2374   jlong j = OSContainer::memory_limit_in_bytes();
2375   st-&gt;print(&quot;memory_limit_in_bytes: &quot;);
2376   if (j &gt; 0) {
2377     st-&gt;print(JLONG_FORMAT &quot;\n&quot;, j);
2378   } else {
2379     st-&gt;print(&quot;%s\n&quot;, j == OSCONTAINER_ERROR ? &quot;not supported&quot; : &quot;unlimited&quot;);
2380   }
2381 
2382   j = OSContainer::memory_and_swap_limit_in_bytes();
2383   st-&gt;print(&quot;memory_and_swap_limit_in_bytes: &quot;);
2384   if (j &gt; 0) {
2385     st-&gt;print(JLONG_FORMAT &quot;\n&quot;, j);
2386   } else {
2387     st-&gt;print(&quot;%s\n&quot;, j == OSCONTAINER_ERROR ? &quot;not supported&quot; : &quot;unlimited&quot;);
2388   }
2389 
2390   j = OSContainer::memory_soft_limit_in_bytes();
2391   st-&gt;print(&quot;memory_soft_limit_in_bytes: &quot;);
2392   if (j &gt; 0) {
2393     st-&gt;print(JLONG_FORMAT &quot;\n&quot;, j);
2394   } else {
2395     st-&gt;print(&quot;%s\n&quot;, j == OSCONTAINER_ERROR ? &quot;not supported&quot; : &quot;unlimited&quot;);
2396   }
2397 
2398   j = OSContainer::OSContainer::memory_usage_in_bytes();
2399   st-&gt;print(&quot;memory_usage_in_bytes: &quot;);
2400   if (j &gt; 0) {
2401     st-&gt;print(JLONG_FORMAT &quot;\n&quot;, j);
2402   } else {
2403     st-&gt;print(&quot;%s\n&quot;, j == OSCONTAINER_ERROR ? &quot;not supported&quot; : &quot;unlimited&quot;);
2404   }
2405 
2406   j = OSContainer::OSContainer::memory_max_usage_in_bytes();
2407   st-&gt;print(&quot;memory_max_usage_in_bytes: &quot;);
2408   if (j &gt; 0) {
2409     st-&gt;print(JLONG_FORMAT &quot;\n&quot;, j);
2410   } else {
2411     st-&gt;print(&quot;%s\n&quot;, j == OSCONTAINER_ERROR ? &quot;not supported&quot; : &quot;unlimited&quot;);
2412   }
2413   st-&gt;cr();
2414 }
2415 
2416 void os::Linux::print_steal_info(outputStream* st) {
2417   if (has_initial_tick_info) {
2418     CPUPerfTicks pticks;
2419     bool res = os::Linux::get_tick_information(&amp;pticks, -1);
2420 
2421     if (res &amp;&amp; pticks.has_steal_ticks) {
2422       uint64_t steal_ticks_difference = pticks.steal - initial_steal_ticks;
2423       uint64_t total_ticks_difference = pticks.total - initial_total_ticks;
2424       double steal_ticks_perc = 0.0;
2425       if (total_ticks_difference != 0) {
2426         steal_ticks_perc = (double) steal_ticks_difference / total_ticks_difference;
2427       }
2428       st-&gt;print_cr(&quot;Steal ticks since vm start: &quot; UINT64_FORMAT, steal_ticks_difference);
2429       st-&gt;print_cr(&quot;Steal ticks percentage since vm start:%7.3f&quot;, steal_ticks_perc);
2430     }
2431   }
2432 }
2433 
2434 void os::print_memory_info(outputStream* st) {
2435 
2436   st-&gt;print(&quot;Memory:&quot;);
2437   st-&gt;print(&quot; %dk page&quot;, os::vm_page_size()&gt;&gt;10);
2438 
2439   // values in struct sysinfo are &quot;unsigned long&quot;
2440   struct sysinfo si;
2441   sysinfo(&amp;si);
2442 
2443   st-&gt;print(&quot;, physical &quot; UINT64_FORMAT &quot;k&quot;,
2444             os::physical_memory() &gt;&gt; 10);
2445   st-&gt;print(&quot;(&quot; UINT64_FORMAT &quot;k free)&quot;,
2446             os::available_memory() &gt;&gt; 10);
2447   st-&gt;print(&quot;, swap &quot; UINT64_FORMAT &quot;k&quot;,
2448             ((jlong)si.totalswap * si.mem_unit) &gt;&gt; 10);
2449   st-&gt;print(&quot;(&quot; UINT64_FORMAT &quot;k free)&quot;,
2450             ((jlong)si.freeswap * si.mem_unit) &gt;&gt; 10);
2451   st-&gt;cr();
2452 }
2453 
2454 // Print the first &quot;model name&quot; line and the first &quot;flags&quot; line
2455 // that we find and nothing more. We assume &quot;model name&quot; comes
2456 // before &quot;flags&quot; so if we find a second &quot;model name&quot;, then the
2457 // &quot;flags&quot; field is considered missing.
2458 static bool print_model_name_and_flags(outputStream* st, char* buf, size_t buflen) {
2459 #if defined(IA32) || defined(AMD64)
2460   // Other platforms have less repetitive cpuinfo files
2461   FILE *fp = fopen(&quot;/proc/cpuinfo&quot;, &quot;r&quot;);
2462   if (fp) {
2463     while (!feof(fp)) {
2464       if (fgets(buf, buflen, fp)) {
2465         // Assume model name comes before flags
2466         bool model_name_printed = false;
2467         if (strstr(buf, &quot;model name&quot;) != NULL) {
2468           if (!model_name_printed) {
2469             st-&gt;print_raw(&quot;CPU Model and flags from /proc/cpuinfo:\n&quot;);
2470             st-&gt;print_raw(buf);
2471             model_name_printed = true;
2472           } else {
2473             // model name printed but not flags?  Odd, just return
2474             fclose(fp);
2475             return true;
2476           }
2477         }
2478         // print the flags line too
2479         if (strstr(buf, &quot;flags&quot;) != NULL) {
2480           st-&gt;print_raw(buf);
2481           fclose(fp);
2482           return true;
2483         }
2484       }
2485     }
2486     fclose(fp);
2487   }
2488 #endif // x86 platforms
2489   return false;
2490 }
2491 
2492 void os::pd_print_cpu_info(outputStream* st, char* buf, size_t buflen) {
2493   // Only print the model name if the platform provides this as a summary
2494   if (!print_model_name_and_flags(st, buf, buflen)) {
2495     st-&gt;print(&quot;\n/proc/cpuinfo:\n&quot;);
2496     if (!_print_ascii_file(&quot;/proc/cpuinfo&quot;, st)) {
2497       st-&gt;print_cr(&quot;  &lt;Not Available&gt;&quot;);
2498     }
2499   }
2500 }
2501 
2502 #if defined(AMD64) || defined(IA32) || defined(X32)
2503 const char* search_string = &quot;model name&quot;;
2504 #elif defined(M68K)
2505 const char* search_string = &quot;CPU&quot;;
2506 #elif defined(PPC64)
2507 const char* search_string = &quot;cpu&quot;;
2508 #elif defined(S390)
2509 const char* search_string = &quot;machine =&quot;;
2510 #elif defined(SPARC)
2511 const char* search_string = &quot;cpu&quot;;
2512 #else
2513 const char* search_string = &quot;Processor&quot;;
2514 #endif
2515 
2516 // Parses the cpuinfo file for string representing the model name.
2517 void os::get_summary_cpu_info(char* cpuinfo, size_t length) {
2518   FILE* fp = fopen(&quot;/proc/cpuinfo&quot;, &quot;r&quot;);
2519   if (fp != NULL) {
2520     while (!feof(fp)) {
2521       char buf[256];
2522       if (fgets(buf, sizeof(buf), fp)) {
2523         char* start = strstr(buf, search_string);
2524         if (start != NULL) {
2525           char *ptr = start + strlen(search_string);
2526           char *end = buf + strlen(buf);
2527           while (ptr != end) {
2528              // skip whitespace and colon for the rest of the name.
2529              if (*ptr != &#39; &#39; &amp;&amp; *ptr != &#39;\t&#39; &amp;&amp; *ptr != &#39;:&#39;) {
2530                break;
2531              }
2532              ptr++;
2533           }
2534           if (ptr != end) {
2535             // reasonable string, get rid of newline and keep the rest
2536             char* nl = strchr(buf, &#39;\n&#39;);
2537             if (nl != NULL) *nl = &#39;\0&#39;;
2538             strncpy(cpuinfo, ptr, length);
2539             fclose(fp);
2540             return;
2541           }
2542         }
2543       }
2544     }
2545     fclose(fp);
2546   }
2547   // cpuinfo not found or parsing failed, just print generic string.  The entire
2548   // /proc/cpuinfo file will be printed later in the file (or enough of it for x86)
2549 #if   defined(AARCH64)
2550   strncpy(cpuinfo, &quot;AArch64&quot;, length);
2551 #elif defined(AMD64)
2552   strncpy(cpuinfo, &quot;x86_64&quot;, length);
2553 #elif defined(ARM)  // Order wrt. AARCH64 is relevant!
2554   strncpy(cpuinfo, &quot;ARM&quot;, length);
2555 #elif defined(IA32)
2556   strncpy(cpuinfo, &quot;x86_32&quot;, length);
2557 #elif defined(IA64)
2558   strncpy(cpuinfo, &quot;IA64&quot;, length);
2559 #elif defined(PPC)
2560   strncpy(cpuinfo, &quot;PPC64&quot;, length);
2561 #elif defined(S390)
2562   strncpy(cpuinfo, &quot;S390&quot;, length);
2563 #elif defined(SPARC)
2564   strncpy(cpuinfo, &quot;sparcv9&quot;, length);
2565 #elif defined(ZERO_LIBARCH)
2566   strncpy(cpuinfo, ZERO_LIBARCH, length);
2567 #else
2568   strncpy(cpuinfo, &quot;unknown&quot;, length);
2569 #endif
2570 }
2571 
2572 static void print_signal_handler(outputStream* st, int sig,
2573                                  char* buf, size_t buflen);
2574 
2575 void os::print_signal_handlers(outputStream* st, char* buf, size_t buflen) {
2576   st-&gt;print_cr(&quot;Signal Handlers:&quot;);
2577   print_signal_handler(st, SIGSEGV, buf, buflen);
2578   print_signal_handler(st, SIGBUS , buf, buflen);
2579   print_signal_handler(st, SIGFPE , buf, buflen);
2580   print_signal_handler(st, SIGPIPE, buf, buflen);
2581   print_signal_handler(st, SIGXFSZ, buf, buflen);
2582   print_signal_handler(st, SIGILL , buf, buflen);
2583   print_signal_handler(st, SR_signum, buf, buflen);
2584   print_signal_handler(st, SHUTDOWN1_SIGNAL, buf, buflen);
2585   print_signal_handler(st, SHUTDOWN2_SIGNAL , buf, buflen);
2586   print_signal_handler(st, SHUTDOWN3_SIGNAL , buf, buflen);
2587   print_signal_handler(st, BREAK_SIGNAL, buf, buflen);
2588 #if defined(PPC64)
2589   print_signal_handler(st, SIGTRAP, buf, buflen);
2590 #endif
2591 }
2592 
2593 static char saved_jvm_path[MAXPATHLEN] = {0};
2594 
2595 // Find the full path to the current module, libjvm.so
2596 void os::jvm_path(char *buf, jint buflen) {
2597   // Error checking.
2598   if (buflen &lt; MAXPATHLEN) {
2599     assert(false, &quot;must use a large-enough buffer&quot;);
2600     buf[0] = &#39;\0&#39;;
2601     return;
2602   }
2603   // Lazy resolve the path to current module.
2604   if (saved_jvm_path[0] != 0) {
2605     strcpy(buf, saved_jvm_path);
2606     return;
2607   }
2608 
2609   char dli_fname[MAXPATHLEN];
2610   bool ret = dll_address_to_library_name(
2611                                          CAST_FROM_FN_PTR(address, os::jvm_path),
2612                                          dli_fname, sizeof(dli_fname), NULL);
2613   assert(ret, &quot;cannot locate libjvm&quot;);
2614   char *rp = NULL;
2615   if (ret &amp;&amp; dli_fname[0] != &#39;\0&#39;) {
2616     rp = os::Posix::realpath(dli_fname, buf, buflen);
2617   }
2618   if (rp == NULL) {
2619     return;
2620   }
2621 
2622   if (Arguments::sun_java_launcher_is_altjvm()) {
2623     // Support for the java launcher&#39;s &#39;-XXaltjvm=&lt;path&gt;&#39; option. Typical
2624     // value for buf is &quot;&lt;JAVA_HOME&gt;/jre/lib/&lt;vmtype&gt;/libjvm.so&quot;.
2625     // If &quot;/jre/lib/&quot; appears at the right place in the string, then
2626     // assume we are installed in a JDK and we&#39;re done. Otherwise, check
2627     // for a JAVA_HOME environment variable and fix up the path so it
2628     // looks like libjvm.so is installed there (append a fake suffix
2629     // hotspot/libjvm.so).
2630     const char *p = buf + strlen(buf) - 1;
2631     for (int count = 0; p &gt; buf &amp;&amp; count &lt; 5; ++count) {
2632       for (--p; p &gt; buf &amp;&amp; *p != &#39;/&#39;; --p)
2633         /* empty */ ;
2634     }
2635 
2636     if (strncmp(p, &quot;/jre/lib/&quot;, 9) != 0) {
2637       // Look for JAVA_HOME in the environment.
2638       char* java_home_var = ::getenv(&quot;JAVA_HOME&quot;);
2639       if (java_home_var != NULL &amp;&amp; java_home_var[0] != 0) {
2640         char* jrelib_p;
2641         int len;
2642 
2643         // Check the current module name &quot;libjvm.so&quot;.
2644         p = strrchr(buf, &#39;/&#39;);
2645         if (p == NULL) {
2646           return;
2647         }
2648         assert(strstr(p, &quot;/libjvm&quot;) == p, &quot;invalid library name&quot;);
2649 
2650         rp = os::Posix::realpath(java_home_var, buf, buflen);
2651         if (rp == NULL) {
2652           return;
2653         }
2654 
2655         // determine if this is a legacy image or modules image
2656         // modules image doesn&#39;t have &quot;jre&quot; subdirectory
2657         len = strlen(buf);
2658         assert(len &lt; buflen, &quot;Ran out of buffer room&quot;);
2659         jrelib_p = buf + len;
2660         snprintf(jrelib_p, buflen-len, &quot;/jre/lib&quot;);
2661         if (0 != access(buf, F_OK)) {
2662           snprintf(jrelib_p, buflen-len, &quot;/lib&quot;);
2663         }
2664 
2665         if (0 == access(buf, F_OK)) {
2666           // Use current module name &quot;libjvm.so&quot;
2667           len = strlen(buf);
2668           snprintf(buf + len, buflen-len, &quot;/hotspot/libjvm.so&quot;);
2669         } else {
2670           // Go back to path of .so
2671           rp = os::Posix::realpath(dli_fname, buf, buflen);
2672           if (rp == NULL) {
2673             return;
2674           }
2675         }
2676       }
2677     }
2678   }
2679 
2680   strncpy(saved_jvm_path, buf, MAXPATHLEN);
2681   saved_jvm_path[MAXPATHLEN - 1] = &#39;\0&#39;;
2682 }
2683 
2684 void os::print_jni_name_prefix_on(outputStream* st, int args_size) {
2685   // no prefix required, not even &quot;_&quot;
2686 }
2687 
2688 void os::print_jni_name_suffix_on(outputStream* st, int args_size) {
2689   // no suffix required
2690 }
2691 
2692 ////////////////////////////////////////////////////////////////////////////////
2693 // sun.misc.Signal support
2694 
2695 static void UserHandler(int sig, void *siginfo, void *context) {
2696   // Ctrl-C is pressed during error reporting, likely because the error
2697   // handler fails to abort. Let VM die immediately.
2698   if (sig == SIGINT &amp;&amp; VMError::is_error_reported()) {
2699     os::die();
2700   }
2701 
2702   os::signal_notify(sig);
2703 }
2704 
2705 void* os::user_handler() {
2706   return CAST_FROM_FN_PTR(void*, UserHandler);
2707 }
2708 
2709 extern &quot;C&quot; {
2710   typedef void (*sa_handler_t)(int);
2711   typedef void (*sa_sigaction_t)(int, siginfo_t *, void *);
2712 }
2713 
2714 void* os::signal(int signal_number, void* handler) {
2715   struct sigaction sigAct, oldSigAct;
2716 
2717   sigfillset(&amp;(sigAct.sa_mask));
2718   sigAct.sa_flags   = SA_RESTART|SA_SIGINFO;
2719   sigAct.sa_handler = CAST_TO_FN_PTR(sa_handler_t, handler);
2720 
2721   if (sigaction(signal_number, &amp;sigAct, &amp;oldSigAct)) {
2722     // -1 means registration failed
2723     return (void *)-1;
2724   }
2725 
2726   return CAST_FROM_FN_PTR(void*, oldSigAct.sa_handler);
2727 }
2728 
2729 void os::signal_raise(int signal_number) {
2730   ::raise(signal_number);
2731 }
2732 
2733 // The following code is moved from os.cpp for making this
2734 // code platform specific, which it is by its very nature.
2735 
2736 // Will be modified when max signal is changed to be dynamic
2737 int os::sigexitnum_pd() {
2738   return NSIG;
2739 }
2740 
2741 // a counter for each possible signal value
2742 static volatile jint pending_signals[NSIG+1] = { 0 };
2743 
2744 // Linux(POSIX) specific hand shaking semaphore.
2745 static Semaphore* sig_sem = NULL;
2746 static PosixSemaphore sr_semaphore;
2747 
2748 static void jdk_misc_signal_init() {
2749   // Initialize signal structures
2750   ::memset((void*)pending_signals, 0, sizeof(pending_signals));
2751 
2752   // Initialize signal semaphore
2753   sig_sem = new Semaphore();
2754 }
2755 
2756 void os::signal_notify(int sig) {
2757   if (sig_sem != NULL) {
2758     Atomic::inc(&amp;pending_signals[sig]);
2759     sig_sem-&gt;signal();
2760   } else {
2761     // Signal thread is not created with ReduceSignalUsage and jdk_misc_signal_init
2762     // initialization isn&#39;t called.
2763     assert(ReduceSignalUsage, &quot;signal semaphore should be created&quot;);
2764   }
2765 }
2766 
2767 static int check_pending_signals() {
2768   for (;;) {
2769     for (int i = 0; i &lt; NSIG + 1; i++) {
2770       jint n = pending_signals[i];
2771       if (n &gt; 0 &amp;&amp; n == Atomic::cmpxchg(&amp;pending_signals[i], n, n - 1)) {
2772         return i;
2773       }
2774     }
2775     JavaThread *thread = JavaThread::current();
2776     ThreadBlockInVM tbivm(thread);
2777 
2778     bool threadIsSuspended;
2779     do {
2780       thread-&gt;set_suspend_equivalent();
2781       // cleared by handle_special_suspend_equivalent_condition() or java_suspend_self()
2782       sig_sem-&gt;wait();
2783 
2784       // were we externally suspended while we were waiting?
2785       threadIsSuspended = thread-&gt;handle_special_suspend_equivalent_condition();
2786       if (threadIsSuspended) {
2787         // The semaphore has been incremented, but while we were waiting
2788         // another thread suspended us. We don&#39;t want to continue running
2789         // while suspended because that would surprise the thread that
2790         // suspended us.
2791         sig_sem-&gt;signal();
2792 
2793         thread-&gt;java_suspend_self();
2794       }
2795     } while (threadIsSuspended);
2796   }
2797 }
2798 
2799 int os::signal_wait() {
2800   return check_pending_signals();
2801 }
2802 
2803 ////////////////////////////////////////////////////////////////////////////////
2804 // Virtual Memory
2805 
2806 int os::vm_page_size() {
2807   // Seems redundant as all get out
2808   assert(os::Linux::page_size() != -1, &quot;must call os::init&quot;);
2809   return os::Linux::page_size();
2810 }
2811 
2812 // Solaris allocates memory by pages.
2813 int os::vm_allocation_granularity() {
2814   assert(os::Linux::page_size() != -1, &quot;must call os::init&quot;);
2815   return os::Linux::page_size();
2816 }
2817 
2818 // Rationale behind this function:
2819 //  current (Mon Apr 25 20:12:18 MSD 2005) oprofile drops samples without executable
2820 //  mapping for address (see lookup_dcookie() in the kernel module), thus we cannot get
2821 //  samples for JITted code. Here we create private executable mapping over the code cache
2822 //  and then we can use standard (well, almost, as mapping can change) way to provide
2823 //  info for the reporting script by storing timestamp and location of symbol
2824 void linux_wrap_code(char* base, size_t size) {
2825   static volatile jint cnt = 0;
2826 
2827   if (!UseOprofile) {
2828     return;
2829   }
2830 
2831   char buf[PATH_MAX+1];
2832   int num = Atomic::add(&amp;cnt, 1);
2833 
2834   snprintf(buf, sizeof(buf), &quot;%s/hs-vm-%d-%d&quot;,
2835            os::get_temp_directory(), os::current_process_id(), num);
2836   unlink(buf);
2837 
2838   int fd = ::open(buf, O_CREAT | O_RDWR, S_IRWXU);
2839 
2840   if (fd != -1) {
2841     off_t rv = ::lseek(fd, size-2, SEEK_SET);
2842     if (rv != (off_t)-1) {
2843       if (::write(fd, &quot;&quot;, 1) == 1) {
2844         mmap(base, size,
2845              PROT_READ|PROT_WRITE|PROT_EXEC,
2846              MAP_PRIVATE|MAP_FIXED|MAP_NORESERVE, fd, 0);
2847       }
2848     }
2849     ::close(fd);
2850     unlink(buf);
2851   }
2852 }
2853 
2854 static bool recoverable_mmap_error(int err) {
2855   // See if the error is one we can let the caller handle. This
2856   // list of errno values comes from JBS-6843484. I can&#39;t find a
2857   // Linux man page that documents this specific set of errno
2858   // values so while this list currently matches Solaris, it may
2859   // change as we gain experience with this failure mode.
2860   switch (err) {
2861   case EBADF:
2862   case EINVAL:
2863   case ENOTSUP:
2864     // let the caller deal with these errors
2865     return true;
2866 
2867   default:
2868     // Any remaining errors on this OS can cause our reserved mapping
2869     // to be lost. That can cause confusion where different data
2870     // structures think they have the same memory mapped. The worst
2871     // scenario is if both the VM and a library think they have the
2872     // same memory mapped.
2873     return false;
2874   }
2875 }
2876 
2877 static void warn_fail_commit_memory(char* addr, size_t size, bool exec,
2878                                     int err) {
2879   warning(&quot;INFO: os::commit_memory(&quot; PTR_FORMAT &quot;, &quot; SIZE_FORMAT
2880           &quot;, %d) failed; error=&#39;%s&#39; (errno=%d)&quot;, p2i(addr), size, exec,
2881           os::strerror(err), err);
2882 }
2883 
2884 static void warn_fail_commit_memory(char* addr, size_t size,
2885                                     size_t alignment_hint, bool exec,
2886                                     int err) {
2887   warning(&quot;INFO: os::commit_memory(&quot; PTR_FORMAT &quot;, &quot; SIZE_FORMAT
2888           &quot;, &quot; SIZE_FORMAT &quot;, %d) failed; error=&#39;%s&#39; (errno=%d)&quot;, p2i(addr), size,
2889           alignment_hint, exec, os::strerror(err), err);
2890 }
2891 
2892 // NOTE: Linux kernel does not really reserve the pages for us.
2893 //       All it does is to check if there are enough free pages
2894 //       left at the time of mmap(). This could be a potential
2895 //       problem.
2896 int os::Linux::commit_memory_impl(char* addr, size_t size, bool exec) {
2897   int prot = exec ? PROT_READ|PROT_WRITE|PROT_EXEC : PROT_READ|PROT_WRITE;
2898   uintptr_t res = (uintptr_t) ::mmap(addr, size, prot,
2899                                      MAP_PRIVATE|MAP_FIXED|MAP_ANONYMOUS, -1, 0);
2900   if (res != (uintptr_t) MAP_FAILED) {
2901     if (UseNUMAInterleaving) {
2902       numa_make_global(addr, size);
2903     }
2904     return 0;
2905   }
2906 
2907   int err = errno;  // save errno from mmap() call above
2908 
2909   if (!recoverable_mmap_error(err)) {
2910     warn_fail_commit_memory(addr, size, exec, err);
2911     vm_exit_out_of_memory(size, OOM_MMAP_ERROR, &quot;committing reserved memory.&quot;);
2912   }
2913 
2914   return err;
2915 }
2916 
2917 bool os::pd_commit_memory(char* addr, size_t size, bool exec) {
2918   return os::Linux::commit_memory_impl(addr, size, exec) == 0;
2919 }
2920 
2921 void os::pd_commit_memory_or_exit(char* addr, size_t size, bool exec,
2922                                   const char* mesg) {
2923   assert(mesg != NULL, &quot;mesg must be specified&quot;);
2924   int err = os::Linux::commit_memory_impl(addr, size, exec);
2925   if (err != 0) {
2926     // the caller wants all commit errors to exit with the specified mesg:
2927     warn_fail_commit_memory(addr, size, exec, err);
2928     vm_exit_out_of_memory(size, OOM_MMAP_ERROR, &quot;%s&quot;, mesg);
2929   }
2930 }
2931 
2932 // Define MAP_HUGETLB here so we can build HotSpot on old systems.
2933 #ifndef MAP_HUGETLB
2934   #define MAP_HUGETLB 0x40000
2935 #endif
2936 
2937 // Define MADV_HUGEPAGE here so we can build HotSpot on old systems.
2938 #ifndef MADV_HUGEPAGE
2939   #define MADV_HUGEPAGE 14
2940 #endif
2941 
2942 int os::Linux::commit_memory_impl(char* addr, size_t size,
2943                                   size_t alignment_hint, bool exec) {
2944   int err = os::Linux::commit_memory_impl(addr, size, exec);
2945   if (err == 0) {
2946     realign_memory(addr, size, alignment_hint);
2947   }
2948   return err;
2949 }
2950 
2951 bool os::pd_commit_memory(char* addr, size_t size, size_t alignment_hint,
2952                           bool exec) {
2953   return os::Linux::commit_memory_impl(addr, size, alignment_hint, exec) == 0;
2954 }
2955 
2956 void os::pd_commit_memory_or_exit(char* addr, size_t size,
2957                                   size_t alignment_hint, bool exec,
2958                                   const char* mesg) {
2959   assert(mesg != NULL, &quot;mesg must be specified&quot;);
2960   int err = os::Linux::commit_memory_impl(addr, size, alignment_hint, exec);
2961   if (err != 0) {
2962     // the caller wants all commit errors to exit with the specified mesg:
2963     warn_fail_commit_memory(addr, size, alignment_hint, exec, err);
2964     vm_exit_out_of_memory(size, OOM_MMAP_ERROR, &quot;%s&quot;, mesg);
2965   }
2966 }
2967 
2968 void os::pd_realign_memory(char *addr, size_t bytes, size_t alignment_hint) {
2969   if (UseTransparentHugePages &amp;&amp; alignment_hint &gt; (size_t)vm_page_size()) {
2970     // We don&#39;t check the return value: madvise(MADV_HUGEPAGE) may not
2971     // be supported or the memory may already be backed by huge pages.
2972     ::madvise(addr, bytes, MADV_HUGEPAGE);
2973   }
2974 }
2975 
2976 void os::pd_free_memory(char *addr, size_t bytes, size_t alignment_hint) {
2977   // This method works by doing an mmap over an existing mmaping and effectively discarding
2978   // the existing pages. However it won&#39;t work for SHM-based large pages that cannot be
2979   // uncommitted at all. We don&#39;t do anything in this case to avoid creating a segment with
2980   // small pages on top of the SHM segment. This method always works for small pages, so we
2981   // allow that in any case.
2982   if (alignment_hint &lt;= (size_t)os::vm_page_size() || can_commit_large_page_memory()) {
2983     commit_memory(addr, bytes, alignment_hint, !ExecMem);
2984   }
2985 }
2986 
2987 void os::numa_make_global(char *addr, size_t bytes) {
2988   Linux::numa_interleave_memory(addr, bytes);
2989 }
2990 
2991 // Define for numa_set_bind_policy(int). Setting the argument to 0 will set the
2992 // bind policy to MPOL_PREFERRED for the current thread.
2993 #define USE_MPOL_PREFERRED 0
2994 
2995 void os::numa_make_local(char *addr, size_t bytes, int lgrp_hint) {
2996   // To make NUMA and large pages more robust when both enabled, we need to ease
2997   // the requirements on where the memory should be allocated. MPOL_BIND is the
2998   // default policy and it will force memory to be allocated on the specified
2999   // node. Changing this to MPOL_PREFERRED will prefer to allocate the memory on
3000   // the specified node, but will not force it. Using this policy will prevent
3001   // getting SIGBUS when trying to allocate large pages on NUMA nodes with no
3002   // free large pages.
3003   Linux::numa_set_bind_policy(USE_MPOL_PREFERRED);
3004   Linux::numa_tonode_memory(addr, bytes, lgrp_hint);
3005 }
3006 
3007 bool os::numa_topology_changed() { return false; }
3008 
3009 size_t os::numa_get_groups_num() {
3010   // Return just the number of nodes in which it&#39;s possible to allocate memory
3011   // (in numa terminology, configured nodes).
3012   return Linux::numa_num_configured_nodes();
3013 }
3014 
3015 int os::numa_get_group_id() {
3016   int cpu_id = Linux::sched_getcpu();
3017   if (cpu_id != -1) {
3018     int lgrp_id = Linux::get_node_by_cpu(cpu_id);
3019     if (lgrp_id != -1) {
3020       return lgrp_id;
3021     }
3022   }
3023   return 0;
3024 }
3025 
3026 int os::numa_get_group_id_for_address(const void* address) {
3027   void** pages = const_cast&lt;void**&gt;(&amp;address);
3028   int id = -1;
3029 
3030   if (os::Linux::numa_move_pages(0, 1, pages, NULL, &amp;id, 0) == -1) {
3031     return -1;
3032   }
3033   if (id &lt; 0) {
3034     return -1;
3035   }
3036   return id;
3037 }
3038 
3039 int os::Linux::get_existing_num_nodes() {
3040   int node;
3041   int highest_node_number = Linux::numa_max_node();
3042   int num_nodes = 0;
3043 
3044   // Get the total number of nodes in the system including nodes without memory.
3045   for (node = 0; node &lt;= highest_node_number; node++) {
3046     if (is_node_in_existing_nodes(node)) {
3047       num_nodes++;
3048     }
3049   }
3050   return num_nodes;
3051 }
3052 
3053 size_t os::numa_get_leaf_groups(int *ids, size_t size) {
3054   int highest_node_number = Linux::numa_max_node();
3055   size_t i = 0;
3056 
3057   // Map all node ids in which it is possible to allocate memory. Also nodes are
3058   // not always consecutively available, i.e. available from 0 to the highest
3059   // node number. If the nodes have been bound explicitly using numactl membind,
3060   // then allocate memory from those nodes only.
3061   for (int node = 0; node &lt;= highest_node_number; node++) {
3062     if (Linux::is_node_in_bound_nodes((unsigned int)node)) {
3063       ids[i++] = node;
3064     }
3065   }
3066   return i;
3067 }
3068 
3069 bool os::get_page_info(char *start, page_info* info) {
3070   return false;
3071 }
3072 
3073 char *os::scan_pages(char *start, char* end, page_info* page_expected,
3074                      page_info* page_found) {
3075   return end;
3076 }
3077 
3078 
3079 int os::Linux::sched_getcpu_syscall(void) {
3080   unsigned int cpu = 0;
3081   int retval = -1;
3082 
3083 #if defined(IA32)
3084   #ifndef SYS_getcpu
3085     #define SYS_getcpu 318
3086   #endif
3087   retval = syscall(SYS_getcpu, &amp;cpu, NULL, NULL);
3088 #elif defined(AMD64)
3089 // Unfortunately we have to bring all these macros here from vsyscall.h
3090 // to be able to compile on old linuxes.
3091   #define __NR_vgetcpu 2
3092   #define VSYSCALL_START (-10UL &lt;&lt; 20)
3093   #define VSYSCALL_SIZE 1024
3094   #define VSYSCALL_ADDR(vsyscall_nr) (VSYSCALL_START+VSYSCALL_SIZE*(vsyscall_nr))
3095   typedef long (*vgetcpu_t)(unsigned int *cpu, unsigned int *node, unsigned long *tcache);
3096   vgetcpu_t vgetcpu = (vgetcpu_t)VSYSCALL_ADDR(__NR_vgetcpu);
3097   retval = vgetcpu(&amp;cpu, NULL, NULL);
3098 #endif
3099 
3100   return (retval == -1) ? retval : cpu;
3101 }
3102 
3103 void os::Linux::sched_getcpu_init() {
3104   // sched_getcpu() should be in libc.
3105   set_sched_getcpu(CAST_TO_FN_PTR(sched_getcpu_func_t,
3106                                   dlsym(RTLD_DEFAULT, &quot;sched_getcpu&quot;)));
3107 
3108   // If it&#39;s not, try a direct syscall.
3109   if (sched_getcpu() == -1) {
3110     set_sched_getcpu(CAST_TO_FN_PTR(sched_getcpu_func_t,
3111                                     (void*)&amp;sched_getcpu_syscall));
3112   }
3113 
3114   if (sched_getcpu() == -1) {
3115     vm_exit_during_initialization(&quot;getcpu(2) system call not supported by kernel&quot;);
3116   }
3117 }
3118 
3119 // Something to do with the numa-aware allocator needs these symbols
3120 extern &quot;C&quot; JNIEXPORT void numa_warn(int number, char *where, ...) { }
3121 extern &quot;C&quot; JNIEXPORT void numa_error(char *where) { }
3122 
<a name="5" id="anc5"></a><span class="line-added">3123 static void* dlvsym_if_available(void* handle, const char* name, const char* version) {</span>
<span class="line-added">3124   typedef void* (*dlvsym_func_type)(void* handle, const char* name, const char* version);</span>
<span class="line-added">3125   static dlvsym_func_type dlvsym_func;</span>
<span class="line-added">3126   static bool initialized = false;</span>
<span class="line-added">3127 </span>
<span class="line-added">3128   if (!initialized) {</span>
<span class="line-added">3129     dlvsym_func = (dlvsym_func_type)dlsym(RTLD_NEXT, &quot;dlvsym&quot;);</span>
<span class="line-added">3130     initialized = true;</span>
<span class="line-added">3131   }</span>
<span class="line-added">3132 </span>
<span class="line-added">3133   if (dlvsym_func != NULL) {</span>
<span class="line-added">3134     void *f = dlvsym_func(handle, name, version);</span>
<span class="line-added">3135     if (f != NULL) {</span>
<span class="line-added">3136       return f;</span>
<span class="line-added">3137     }</span>
<span class="line-added">3138   }</span>
<span class="line-added">3139 </span>
<span class="line-added">3140   return dlsym(handle, name);</span>
<span class="line-added">3141 }</span>
<span class="line-added">3142 </span>
3143 // Handle request to load libnuma symbol version 1.1 (API v1). If it fails
3144 // load symbol from base version instead.
3145 void* os::Linux::libnuma_dlsym(void* handle, const char *name) {
<a name="6" id="anc6"></a><span class="line-modified">3146   return dlvsym_if_available(handle, name, &quot;libnuma_1.1&quot;);</span>




3147 }
3148 
3149 // Handle request to load libnuma symbol version 1.2 (API v2) only.
3150 // Return NULL if the symbol is not defined in this particular version.
3151 void* os::Linux::libnuma_v2_dlsym(void* handle, const char* name) {
<a name="7" id="anc7"></a><span class="line-modified">3152   return dlvsym_if_available(handle, name, &quot;libnuma_1.2&quot;);</span>
3153 }
3154 
3155 bool os::Linux::libnuma_init() {
3156   if (sched_getcpu() != -1) { // Requires sched_getcpu() support
3157     void *handle = dlopen(&quot;libnuma.so.1&quot;, RTLD_LAZY);
3158     if (handle != NULL) {
3159       set_numa_node_to_cpus(CAST_TO_FN_PTR(numa_node_to_cpus_func_t,
3160                                            libnuma_dlsym(handle, &quot;numa_node_to_cpus&quot;)));
3161       set_numa_max_node(CAST_TO_FN_PTR(numa_max_node_func_t,
3162                                        libnuma_dlsym(handle, &quot;numa_max_node&quot;)));
3163       set_numa_num_configured_nodes(CAST_TO_FN_PTR(numa_num_configured_nodes_func_t,
3164                                                    libnuma_dlsym(handle, &quot;numa_num_configured_nodes&quot;)));
3165       set_numa_available(CAST_TO_FN_PTR(numa_available_func_t,
3166                                         libnuma_dlsym(handle, &quot;numa_available&quot;)));
3167       set_numa_tonode_memory(CAST_TO_FN_PTR(numa_tonode_memory_func_t,
3168                                             libnuma_dlsym(handle, &quot;numa_tonode_memory&quot;)));
3169       set_numa_interleave_memory(CAST_TO_FN_PTR(numa_interleave_memory_func_t,
3170                                                 libnuma_dlsym(handle, &quot;numa_interleave_memory&quot;)));
3171       set_numa_interleave_memory_v2(CAST_TO_FN_PTR(numa_interleave_memory_v2_func_t,
3172                                                 libnuma_v2_dlsym(handle, &quot;numa_interleave_memory&quot;)));
3173       set_numa_set_bind_policy(CAST_TO_FN_PTR(numa_set_bind_policy_func_t,
3174                                               libnuma_dlsym(handle, &quot;numa_set_bind_policy&quot;)));
3175       set_numa_bitmask_isbitset(CAST_TO_FN_PTR(numa_bitmask_isbitset_func_t,
3176                                                libnuma_dlsym(handle, &quot;numa_bitmask_isbitset&quot;)));
3177       set_numa_distance(CAST_TO_FN_PTR(numa_distance_func_t,
3178                                        libnuma_dlsym(handle, &quot;numa_distance&quot;)));
3179       set_numa_get_membind(CAST_TO_FN_PTR(numa_get_membind_func_t,
3180                                           libnuma_v2_dlsym(handle, &quot;numa_get_membind&quot;)));
3181       set_numa_get_interleave_mask(CAST_TO_FN_PTR(numa_get_interleave_mask_func_t,
3182                                                   libnuma_v2_dlsym(handle, &quot;numa_get_interleave_mask&quot;)));
3183       set_numa_move_pages(CAST_TO_FN_PTR(numa_move_pages_func_t,
3184                                          libnuma_dlsym(handle, &quot;numa_move_pages&quot;)));
3185       set_numa_set_preferred(CAST_TO_FN_PTR(numa_set_preferred_func_t,
3186                                             libnuma_dlsym(handle, &quot;numa_set_preferred&quot;)));
3187 
3188       if (numa_available() != -1) {
3189         set_numa_all_nodes((unsigned long*)libnuma_dlsym(handle, &quot;numa_all_nodes&quot;));
3190         set_numa_all_nodes_ptr((struct bitmask **)libnuma_dlsym(handle, &quot;numa_all_nodes_ptr&quot;));
3191         set_numa_nodes_ptr((struct bitmask **)libnuma_dlsym(handle, &quot;numa_nodes_ptr&quot;));
3192         set_numa_interleave_bitmask(_numa_get_interleave_mask());
3193         set_numa_membind_bitmask(_numa_get_membind());
3194         // Create an index -&gt; node mapping, since nodes are not always consecutive
3195         _nindex_to_node = new (ResourceObj::C_HEAP, mtInternal) GrowableArray&lt;int&gt;(0, true);
3196         rebuild_nindex_to_node_map();
3197         // Create a cpu -&gt; node mapping
3198         _cpu_to_node = new (ResourceObj::C_HEAP, mtInternal) GrowableArray&lt;int&gt;(0, true);
3199         rebuild_cpu_to_node_map();
3200         return true;
3201       }
3202     }
3203   }
3204   return false;
3205 }
3206 
3207 size_t os::Linux::default_guard_size(os::ThreadType thr_type) {
3208   // Creating guard page is very expensive. Java thread has HotSpot
3209   // guard pages, only enable glibc guard page for non-Java threads.
3210   // (Remember: compiler thread is a Java thread, too!)
3211   return ((thr_type == java_thread || thr_type == compiler_thread) ? 0 : page_size());
3212 }
3213 
3214 void os::Linux::rebuild_nindex_to_node_map() {
3215   int highest_node_number = Linux::numa_max_node();
3216 
3217   nindex_to_node()-&gt;clear();
3218   for (int node = 0; node &lt;= highest_node_number; node++) {
3219     if (Linux::is_node_in_existing_nodes(node)) {
3220       nindex_to_node()-&gt;append(node);
3221     }
3222   }
3223 }
3224 
3225 // rebuild_cpu_to_node_map() constructs a table mapping cpud id to node id.
3226 // The table is later used in get_node_by_cpu().
3227 void os::Linux::rebuild_cpu_to_node_map() {
3228   const size_t NCPUS = 32768; // Since the buffer size computation is very obscure
3229                               // in libnuma (possible values are starting from 16,
3230                               // and continuing up with every other power of 2, but less
3231                               // than the maximum number of CPUs supported by kernel), and
3232                               // is a subject to change (in libnuma version 2 the requirements
3233                               // are more reasonable) we&#39;ll just hardcode the number they use
3234                               // in the library.
3235   const size_t BitsPerCLong = sizeof(long) * CHAR_BIT;
3236 
3237   size_t cpu_num = processor_count();
3238   size_t cpu_map_size = NCPUS / BitsPerCLong;
3239   size_t cpu_map_valid_size =
3240     MIN2((cpu_num + BitsPerCLong - 1) / BitsPerCLong, cpu_map_size);
3241 
3242   cpu_to_node()-&gt;clear();
3243   cpu_to_node()-&gt;at_grow(cpu_num - 1);
3244 
3245   size_t node_num = get_existing_num_nodes();
3246 
3247   int distance = 0;
3248   int closest_distance = INT_MAX;
3249   int closest_node = 0;
3250   unsigned long *cpu_map = NEW_C_HEAP_ARRAY(unsigned long, cpu_map_size, mtInternal);
3251   for (size_t i = 0; i &lt; node_num; i++) {
3252     // Check if node is configured (not a memory-less node). If it is not, find
3253     // the closest configured node. Check also if node is bound, i.e. it&#39;s allowed
3254     // to allocate memory from the node. If it&#39;s not allowed, map cpus in that node
3255     // to the closest node from which memory allocation is allowed.
3256     if (!is_node_in_configured_nodes(nindex_to_node()-&gt;at(i)) ||
3257         !is_node_in_bound_nodes(nindex_to_node()-&gt;at(i))) {
3258       closest_distance = INT_MAX;
3259       // Check distance from all remaining nodes in the system. Ignore distance
3260       // from itself, from another non-configured node, and from another non-bound
3261       // node.
3262       for (size_t m = 0; m &lt; node_num; m++) {
3263         if (m != i &amp;&amp;
3264             is_node_in_configured_nodes(nindex_to_node()-&gt;at(m)) &amp;&amp;
3265             is_node_in_bound_nodes(nindex_to_node()-&gt;at(m))) {
3266           distance = numa_distance(nindex_to_node()-&gt;at(i), nindex_to_node()-&gt;at(m));
3267           // If a closest node is found, update. There is always at least one
3268           // configured and bound node in the system so there is always at least
3269           // one node close.
3270           if (distance != 0 &amp;&amp; distance &lt; closest_distance) {
3271             closest_distance = distance;
3272             closest_node = nindex_to_node()-&gt;at(m);
3273           }
3274         }
3275       }
3276      } else {
3277        // Current node is already a configured node.
3278        closest_node = nindex_to_node()-&gt;at(i);
3279      }
3280 
3281     // Get cpus from the original node and map them to the closest node. If node
3282     // is a configured node (not a memory-less node), then original node and
3283     // closest node are the same.
3284     if (numa_node_to_cpus(nindex_to_node()-&gt;at(i), cpu_map, cpu_map_size * sizeof(unsigned long)) != -1) {
3285       for (size_t j = 0; j &lt; cpu_map_valid_size; j++) {
3286         if (cpu_map[j] != 0) {
3287           for (size_t k = 0; k &lt; BitsPerCLong; k++) {
3288             if (cpu_map[j] &amp; (1UL &lt;&lt; k)) {
3289               cpu_to_node()-&gt;at_put(j * BitsPerCLong + k, closest_node);
3290             }
3291           }
3292         }
3293       }
3294     }
3295   }
3296   FREE_C_HEAP_ARRAY(unsigned long, cpu_map);
3297 }
3298 
3299 int os::Linux::get_node_by_cpu(int cpu_id) {
3300   if (cpu_to_node() != NULL &amp;&amp; cpu_id &gt;= 0 &amp;&amp; cpu_id &lt; cpu_to_node()-&gt;length()) {
3301     return cpu_to_node()-&gt;at(cpu_id);
3302   }
3303   return -1;
3304 }
3305 
3306 GrowableArray&lt;int&gt;* os::Linux::_cpu_to_node;
3307 GrowableArray&lt;int&gt;* os::Linux::_nindex_to_node;
3308 os::Linux::sched_getcpu_func_t os::Linux::_sched_getcpu;
3309 os::Linux::numa_node_to_cpus_func_t os::Linux::_numa_node_to_cpus;
3310 os::Linux::numa_max_node_func_t os::Linux::_numa_max_node;
3311 os::Linux::numa_num_configured_nodes_func_t os::Linux::_numa_num_configured_nodes;
3312 os::Linux::numa_available_func_t os::Linux::_numa_available;
3313 os::Linux::numa_tonode_memory_func_t os::Linux::_numa_tonode_memory;
3314 os::Linux::numa_interleave_memory_func_t os::Linux::_numa_interleave_memory;
3315 os::Linux::numa_interleave_memory_v2_func_t os::Linux::_numa_interleave_memory_v2;
3316 os::Linux::numa_set_bind_policy_func_t os::Linux::_numa_set_bind_policy;
3317 os::Linux::numa_bitmask_isbitset_func_t os::Linux::_numa_bitmask_isbitset;
3318 os::Linux::numa_distance_func_t os::Linux::_numa_distance;
3319 os::Linux::numa_get_membind_func_t os::Linux::_numa_get_membind;
3320 os::Linux::numa_get_interleave_mask_func_t os::Linux::_numa_get_interleave_mask;
3321 os::Linux::numa_move_pages_func_t os::Linux::_numa_move_pages;
3322 os::Linux::numa_set_preferred_func_t os::Linux::_numa_set_preferred;
3323 os::Linux::NumaAllocationPolicy os::Linux::_current_numa_policy;
3324 unsigned long* os::Linux::_numa_all_nodes;
3325 struct bitmask* os::Linux::_numa_all_nodes_ptr;
3326 struct bitmask* os::Linux::_numa_nodes_ptr;
3327 struct bitmask* os::Linux::_numa_interleave_bitmask;
3328 struct bitmask* os::Linux::_numa_membind_bitmask;
3329 
3330 bool os::pd_uncommit_memory(char* addr, size_t size) {
3331   uintptr_t res = (uintptr_t) ::mmap(addr, size, PROT_NONE,
3332                                      MAP_PRIVATE|MAP_FIXED|MAP_NORESERVE|MAP_ANONYMOUS, -1, 0);
3333   return res  != (uintptr_t) MAP_FAILED;
3334 }
3335 
3336 static address get_stack_commited_bottom(address bottom, size_t size) {
3337   address nbot = bottom;
3338   address ntop = bottom + size;
3339 
3340   size_t page_sz = os::vm_page_size();
3341   unsigned pages = size / page_sz;
3342 
3343   unsigned char vec[1];
3344   unsigned imin = 1, imax = pages + 1, imid;
3345   int mincore_return_value = 0;
3346 
3347   assert(imin &lt;= imax, &quot;Unexpected page size&quot;);
3348 
3349   while (imin &lt; imax) {
3350     imid = (imax + imin) / 2;
3351     nbot = ntop - (imid * page_sz);
3352 
3353     // Use a trick with mincore to check whether the page is mapped or not.
3354     // mincore sets vec to 1 if page resides in memory and to 0 if page
3355     // is swapped output but if page we are asking for is unmapped
3356     // it returns -1,ENOMEM
3357     mincore_return_value = mincore(nbot, page_sz, vec);
3358 
3359     if (mincore_return_value == -1) {
3360       // Page is not mapped go up
3361       // to find first mapped page
3362       if (errno != EAGAIN) {
3363         assert(errno == ENOMEM, &quot;Unexpected mincore errno&quot;);
3364         imax = imid;
3365       }
3366     } else {
3367       // Page is mapped go down
3368       // to find first not mapped page
3369       imin = imid + 1;
3370     }
3371   }
3372 
3373   nbot = nbot + page_sz;
3374 
3375   // Adjust stack bottom one page up if last checked page is not mapped
3376   if (mincore_return_value == -1) {
3377     nbot = nbot + page_sz;
3378   }
3379 
3380   return nbot;
3381 }
3382 
3383 bool os::committed_in_range(address start, size_t size, address&amp; committed_start, size_t&amp; committed_size) {
3384   int mincore_return_value;
3385   const size_t stripe = 1024;  // query this many pages each time
3386   unsigned char vec[stripe + 1];
3387   // set a guard
3388   vec[stripe] = &#39;X&#39;;
3389 
3390   const size_t page_sz = os::vm_page_size();
3391   size_t pages = size / page_sz;
3392 
3393   assert(is_aligned(start, page_sz), &quot;Start address must be page aligned&quot;);
3394   assert(is_aligned(size, page_sz), &quot;Size must be page aligned&quot;);
3395 
3396   committed_start = NULL;
3397 
3398   int loops = (pages + stripe - 1) / stripe;
3399   int committed_pages = 0;
3400   address loop_base = start;
3401   bool found_range = false;
3402 
3403   for (int index = 0; index &lt; loops &amp;&amp; !found_range; index ++) {
3404     assert(pages &gt; 0, &quot;Nothing to do&quot;);
3405     int pages_to_query = (pages &gt;= stripe) ? stripe : pages;
3406     pages -= pages_to_query;
3407 
3408     // Get stable read
3409     while ((mincore_return_value = mincore(loop_base, pages_to_query * page_sz, vec)) == -1 &amp;&amp; errno == EAGAIN);
3410 
3411     // During shutdown, some memory goes away without properly notifying NMT,
3412     // E.g. ConcurrentGCThread/WatcherThread can exit without deleting thread object.
3413     // Bailout and return as not committed for now.
3414     if (mincore_return_value == -1 &amp;&amp; errno == ENOMEM) {
3415       return false;
3416     }
3417 
3418     assert(vec[stripe] == &#39;X&#39;, &quot;overflow guard&quot;);
3419     assert(mincore_return_value == 0, &quot;Range must be valid&quot;);
3420     // Process this stripe
3421     for (int vecIdx = 0; vecIdx &lt; pages_to_query; vecIdx ++) {
3422       if ((vec[vecIdx] &amp; 0x01) == 0) { // not committed
3423         // End of current contiguous region
3424         if (committed_start != NULL) {
3425           found_range = true;
3426           break;
3427         }
3428       } else { // committed
3429         // Start of region
3430         if (committed_start == NULL) {
3431           committed_start = loop_base + page_sz * vecIdx;
3432         }
3433         committed_pages ++;
3434       }
3435     }
3436 
3437     loop_base += pages_to_query * page_sz;
3438   }
3439 
3440   if (committed_start != NULL) {
3441     assert(committed_pages &gt; 0, &quot;Must have committed region&quot;);
3442     assert(committed_pages &lt;= int(size / page_sz), &quot;Can not commit more than it has&quot;);
3443     assert(committed_start &gt;= start &amp;&amp; committed_start &lt; start + size, &quot;Out of range&quot;);
3444     committed_size = page_sz * committed_pages;
3445     return true;
3446   } else {
3447     assert(committed_pages == 0, &quot;Should not have committed region&quot;);
3448     return false;
3449   }
3450 }
3451 
3452 
3453 // Linux uses a growable mapping for the stack, and if the mapping for
3454 // the stack guard pages is not removed when we detach a thread the
3455 // stack cannot grow beyond the pages where the stack guard was
3456 // mapped.  If at some point later in the process the stack expands to
3457 // that point, the Linux kernel cannot expand the stack any further
3458 // because the guard pages are in the way, and a segfault occurs.
3459 //
3460 // However, it&#39;s essential not to split the stack region by unmapping
3461 // a region (leaving a hole) that&#39;s already part of the stack mapping,
3462 // so if the stack mapping has already grown beyond the guard pages at
3463 // the time we create them, we have to truncate the stack mapping.
3464 // So, we need to know the extent of the stack mapping when
3465 // create_stack_guard_pages() is called.
3466 
3467 // We only need this for stacks that are growable: at the time of
3468 // writing thread stacks don&#39;t use growable mappings (i.e. those
3469 // creeated with MAP_GROWSDOWN), and aren&#39;t marked &quot;[stack]&quot;, so this
3470 // only applies to the main thread.
3471 
3472 // If the (growable) stack mapping already extends beyond the point
3473 // where we&#39;re going to put our guard pages, truncate the mapping at
3474 // that point by munmap()ping it.  This ensures that when we later
3475 // munmap() the guard pages we don&#39;t leave a hole in the stack
3476 // mapping. This only affects the main/primordial thread
3477 
3478 bool os::pd_create_stack_guard_pages(char* addr, size_t size) {
3479   if (os::is_primordial_thread()) {
3480     // As we manually grow stack up to bottom inside create_attached_thread(),
3481     // it&#39;s likely that os::Linux::initial_thread_stack_bottom is mapped and
3482     // we don&#39;t need to do anything special.
3483     // Check it first, before calling heavy function.
3484     uintptr_t stack_extent = (uintptr_t) os::Linux::initial_thread_stack_bottom();
3485     unsigned char vec[1];
3486 
3487     if (mincore((address)stack_extent, os::vm_page_size(), vec) == -1) {
3488       // Fallback to slow path on all errors, including EAGAIN
3489       stack_extent = (uintptr_t) get_stack_commited_bottom(
3490                                                            os::Linux::initial_thread_stack_bottom(),
3491                                                            (size_t)addr - stack_extent);
3492     }
3493 
3494     if (stack_extent &lt; (uintptr_t)addr) {
3495       ::munmap((void*)stack_extent, (uintptr_t)(addr - stack_extent));
3496     }
3497   }
3498 
3499   return os::commit_memory(addr, size, !ExecMem);
3500 }
3501 
3502 // If this is a growable mapping, remove the guard pages entirely by
3503 // munmap()ping them.  If not, just call uncommit_memory(). This only
3504 // affects the main/primordial thread, but guard against future OS changes.
3505 // It&#39;s safe to always unmap guard pages for primordial thread because we
3506 // always place it right after end of the mapped region.
3507 
3508 bool os::remove_stack_guard_pages(char* addr, size_t size) {
3509   uintptr_t stack_extent, stack_base;
3510 
3511   if (os::is_primordial_thread()) {
3512     return ::munmap(addr, size) == 0;
3513   }
3514 
3515   return os::uncommit_memory(addr, size);
3516 }
3517 
3518 // If &#39;fixed&#39; is true, anon_mmap() will attempt to reserve anonymous memory
3519 // at &#39;requested_addr&#39;. If there are existing memory mappings at the same
3520 // location, however, they will be overwritten. If &#39;fixed&#39; is false,
3521 // &#39;requested_addr&#39; is only treated as a hint, the return value may or
3522 // may not start from the requested address. Unlike Linux mmap(), this
3523 // function returns NULL to indicate failure.
3524 static char* anon_mmap(char* requested_addr, size_t bytes, bool fixed) {
3525   char * addr;
3526   int flags;
3527 
3528   flags = MAP_PRIVATE | MAP_NORESERVE | MAP_ANONYMOUS;
3529   if (fixed) {
3530     assert((uintptr_t)requested_addr % os::Linux::page_size() == 0, &quot;unaligned address&quot;);
3531     flags |= MAP_FIXED;
3532   }
3533 
3534   // Map reserved/uncommitted pages PROT_NONE so we fail early if we
3535   // touch an uncommitted page. Otherwise, the read/write might
3536   // succeed if we have enough swap space to back the physical page.
3537   addr = (char*)::mmap(requested_addr, bytes, PROT_NONE,
3538                        flags, -1, 0);
3539 
3540   return addr == MAP_FAILED ? NULL : addr;
3541 }
3542 
3543 // Allocate (using mmap, NO_RESERVE, with small pages) at either a given request address
3544 //   (req_addr != NULL) or with a given alignment.
3545 //  - bytes shall be a multiple of alignment.
3546 //  - req_addr can be NULL. If not NULL, it must be a multiple of alignment.
3547 //  - alignment sets the alignment at which memory shall be allocated.
3548 //     It must be a multiple of allocation granularity.
3549 // Returns address of memory or NULL. If req_addr was not NULL, will only return
3550 //  req_addr or NULL.
3551 static char* anon_mmap_aligned(size_t bytes, size_t alignment, char* req_addr) {
3552 
3553   size_t extra_size = bytes;
3554   if (req_addr == NULL &amp;&amp; alignment &gt; 0) {
3555     extra_size += alignment;
3556   }
3557 
3558   char* start = (char*) ::mmap(req_addr, extra_size, PROT_NONE,
3559     MAP_PRIVATE|MAP_ANONYMOUS|MAP_NORESERVE,
3560     -1, 0);
3561   if (start == MAP_FAILED) {
3562     start = NULL;
3563   } else {
3564     if (req_addr != NULL) {
3565       if (start != req_addr) {
3566         ::munmap(start, extra_size);
3567         start = NULL;
3568       }
3569     } else {
3570       char* const start_aligned = align_up(start, alignment);
3571       char* const end_aligned = start_aligned + bytes;
3572       char* const end = start + extra_size;
3573       if (start_aligned &gt; start) {
3574         ::munmap(start, start_aligned - start);
3575       }
3576       if (end_aligned &lt; end) {
3577         ::munmap(end_aligned, end - end_aligned);
3578       }
3579       start = start_aligned;
3580     }
3581   }
3582   return start;
3583 }
3584 
3585 static int anon_munmap(char * addr, size_t size) {
3586   return ::munmap(addr, size) == 0;
3587 }
3588 
3589 char* os::pd_reserve_memory(size_t bytes, char* requested_addr,
3590                             size_t alignment_hint) {
3591   return anon_mmap(requested_addr, bytes, (requested_addr != NULL));
3592 }
3593 
3594 bool os::pd_release_memory(char* addr, size_t size) {
3595   return anon_munmap(addr, size);
3596 }
3597 
3598 static bool linux_mprotect(char* addr, size_t size, int prot) {
3599   // Linux wants the mprotect address argument to be page aligned.
3600   char* bottom = (char*)align_down((intptr_t)addr, os::Linux::page_size());
3601 
3602   // According to SUSv3, mprotect() should only be used with mappings
3603   // established by mmap(), and mmap() always maps whole pages. Unaligned
3604   // &#39;addr&#39; likely indicates problem in the VM (e.g. trying to change
3605   // protection of malloc&#39;ed or statically allocated memory). Check the
3606   // caller if you hit this assert.
3607   assert(addr == bottom, &quot;sanity check&quot;);
3608 
3609   size = align_up(pointer_delta(addr, bottom, 1) + size, os::Linux::page_size());
3610   Events::log(NULL, &quot;Protecting memory [&quot; INTPTR_FORMAT &quot;,&quot; INTPTR_FORMAT &quot;] with protection modes %x&quot;, p2i(bottom), p2i(bottom+size), prot);
3611   return ::mprotect(bottom, size, prot) == 0;
3612 }
3613 
3614 // Set protections specified
3615 bool os::protect_memory(char* addr, size_t bytes, ProtType prot,
3616                         bool is_committed) {
3617   unsigned int p = 0;
3618   switch (prot) {
3619   case MEM_PROT_NONE: p = PROT_NONE; break;
3620   case MEM_PROT_READ: p = PROT_READ; break;
3621   case MEM_PROT_RW:   p = PROT_READ|PROT_WRITE; break;
3622   case MEM_PROT_RWX:  p = PROT_READ|PROT_WRITE|PROT_EXEC; break;
3623   default:
3624     ShouldNotReachHere();
3625   }
3626   // is_committed is unused.
3627   return linux_mprotect(addr, bytes, p);
3628 }
3629 
3630 bool os::guard_memory(char* addr, size_t size) {
3631   return linux_mprotect(addr, size, PROT_NONE);
3632 }
3633 
3634 bool os::unguard_memory(char* addr, size_t size) {
3635   return linux_mprotect(addr, size, PROT_READ|PROT_WRITE);
3636 }
3637 
3638 bool os::Linux::transparent_huge_pages_sanity_check(bool warn,
3639                                                     size_t page_size) {
3640   bool result = false;
3641   void *p = mmap(NULL, page_size * 2, PROT_READ|PROT_WRITE,
3642                  MAP_ANONYMOUS|MAP_PRIVATE,
3643                  -1, 0);
3644   if (p != MAP_FAILED) {
3645     void *aligned_p = align_up(p, page_size);
3646 
3647     result = madvise(aligned_p, page_size, MADV_HUGEPAGE) == 0;
3648 
3649     munmap(p, page_size * 2);
3650   }
3651 
3652   if (warn &amp;&amp; !result) {
3653     warning(&quot;TransparentHugePages is not supported by the operating system.&quot;);
3654   }
3655 
3656   return result;
3657 }
3658 
3659 bool os::Linux::hugetlbfs_sanity_check(bool warn, size_t page_size) {
3660   bool result = false;
3661   void *p = mmap(NULL, page_size, PROT_READ|PROT_WRITE,
3662                  MAP_ANONYMOUS|MAP_PRIVATE|MAP_HUGETLB,
3663                  -1, 0);
3664 
3665   if (p != MAP_FAILED) {
3666     // We don&#39;t know if this really is a huge page or not.
3667     FILE *fp = fopen(&quot;/proc/self/maps&quot;, &quot;r&quot;);
3668     if (fp) {
3669       while (!feof(fp)) {
3670         char chars[257];
3671         long x = 0;
3672         if (fgets(chars, sizeof(chars), fp)) {
3673           if (sscanf(chars, &quot;%lx-%*x&quot;, &amp;x) == 1
3674               &amp;&amp; x == (long)p) {
3675             if (strstr (chars, &quot;hugepage&quot;)) {
3676               result = true;
3677               break;
3678             }
3679           }
3680         }
3681       }
3682       fclose(fp);
3683     }
3684     munmap(p, page_size);
3685   }
3686 
3687   if (warn &amp;&amp; !result) {
3688     warning(&quot;HugeTLBFS is not supported by the operating system.&quot;);
3689   }
3690 
3691   return result;
3692 }
3693 
3694 // From the coredump_filter documentation:
3695 //
3696 // - (bit 0) anonymous private memory
3697 // - (bit 1) anonymous shared memory
3698 // - (bit 2) file-backed private memory
3699 // - (bit 3) file-backed shared memory
3700 // - (bit 4) ELF header pages in file-backed private memory areas (it is
3701 //           effective only if the bit 2 is cleared)
3702 // - (bit 5) hugetlb private memory
3703 // - (bit 6) hugetlb shared memory
3704 // - (bit 7) dax private memory
3705 // - (bit 8) dax shared memory
3706 //
3707 static void set_coredump_filter(CoredumpFilterBit bit) {
3708   FILE *f;
3709   long cdm;
3710 
3711   if ((f = fopen(&quot;/proc/self/coredump_filter&quot;, &quot;r+&quot;)) == NULL) {
3712     return;
3713   }
3714 
3715   if (fscanf(f, &quot;%lx&quot;, &amp;cdm) != 1) {
3716     fclose(f);
3717     return;
3718   }
3719 
3720   long saved_cdm = cdm;
3721   rewind(f);
3722   cdm |= bit;
3723 
3724   if (cdm != saved_cdm) {
3725     fprintf(f, &quot;%#lx&quot;, cdm);
3726   }
3727 
3728   fclose(f);
3729 }
3730 
3731 // Large page support
3732 
3733 static size_t _large_page_size = 0;
3734 
3735 size_t os::Linux::find_large_page_size() {
3736   size_t large_page_size = 0;
3737 
3738   // large_page_size on Linux is used to round up heap size. x86 uses either
3739   // 2M or 4M page, depending on whether PAE (Physical Address Extensions)
3740   // mode is enabled. AMD64/EM64T uses 2M page in 64bit mode. IA64 can use
3741   // page as large as 256M.
3742   //
3743   // Here we try to figure out page size by parsing /proc/meminfo and looking
3744   // for a line with the following format:
3745   //    Hugepagesize:     2048 kB
3746   //
3747   // If we can&#39;t determine the value (e.g. /proc is not mounted, or the text
3748   // format has been changed), we&#39;ll use the largest page size supported by
3749   // the processor.
3750 
3751 #ifndef ZERO
3752   large_page_size =
3753     AARCH64_ONLY(2 * M)
3754     AMD64_ONLY(2 * M)
3755     ARM32_ONLY(2 * M)
3756     IA32_ONLY(4 * M)
3757     IA64_ONLY(256 * M)
3758     PPC_ONLY(4 * M)
3759     S390_ONLY(1 * M)
3760     SPARC_ONLY(4 * M);
3761 #endif // ZERO
3762 
3763   FILE *fp = fopen(&quot;/proc/meminfo&quot;, &quot;r&quot;);
3764   if (fp) {
3765     while (!feof(fp)) {
3766       int x = 0;
3767       char buf[16];
3768       if (fscanf(fp, &quot;Hugepagesize: %d&quot;, &amp;x) == 1) {
3769         if (x &amp;&amp; fgets(buf, sizeof(buf), fp) &amp;&amp; strcmp(buf, &quot; kB\n&quot;) == 0) {
3770           large_page_size = x * K;
3771           break;
3772         }
3773       } else {
3774         // skip to next line
3775         for (;;) {
3776           int ch = fgetc(fp);
3777           if (ch == EOF || ch == (int)&#39;\n&#39;) break;
3778         }
3779       }
3780     }
3781     fclose(fp);
3782   }
3783 
3784   if (!FLAG_IS_DEFAULT(LargePageSizeInBytes) &amp;&amp; LargePageSizeInBytes != large_page_size) {
3785     warning(&quot;Setting LargePageSizeInBytes has no effect on this OS. Large page size is &quot;
3786             SIZE_FORMAT &quot;%s.&quot;, byte_size_in_proper_unit(large_page_size),
3787             proper_unit_for_byte_size(large_page_size));
3788   }
3789 
3790   return large_page_size;
3791 }
3792 
3793 size_t os::Linux::setup_large_page_size() {
3794   _large_page_size = Linux::find_large_page_size();
3795   const size_t default_page_size = (size_t)Linux::page_size();
3796   if (_large_page_size &gt; default_page_size) {
3797     _page_sizes[0] = _large_page_size;
3798     _page_sizes[1] = default_page_size;
3799     _page_sizes[2] = 0;
3800   }
3801 
3802   return _large_page_size;
3803 }
3804 
3805 bool os::Linux::setup_large_page_type(size_t page_size) {
3806   if (FLAG_IS_DEFAULT(UseHugeTLBFS) &amp;&amp;
3807       FLAG_IS_DEFAULT(UseSHM) &amp;&amp;
3808       FLAG_IS_DEFAULT(UseTransparentHugePages)) {
3809 
3810     // The type of large pages has not been specified by the user.
3811 
3812     // Try UseHugeTLBFS and then UseSHM.
3813     UseHugeTLBFS = UseSHM = true;
3814 
3815     // Don&#39;t try UseTransparentHugePages since there are known
3816     // performance issues with it turned on. This might change in the future.
3817     UseTransparentHugePages = false;
3818   }
3819 
3820   if (UseTransparentHugePages) {
3821     bool warn_on_failure = !FLAG_IS_DEFAULT(UseTransparentHugePages);
3822     if (transparent_huge_pages_sanity_check(warn_on_failure, page_size)) {
3823       UseHugeTLBFS = false;
3824       UseSHM = false;
3825       return true;
3826     }
3827     UseTransparentHugePages = false;
3828   }
3829 
3830   if (UseHugeTLBFS) {
3831     bool warn_on_failure = !FLAG_IS_DEFAULT(UseHugeTLBFS);
3832     if (hugetlbfs_sanity_check(warn_on_failure, page_size)) {
3833       UseSHM = false;
3834       return true;
3835     }
3836     UseHugeTLBFS = false;
3837   }
3838 
3839   return UseSHM;
3840 }
3841 
3842 void os::large_page_init() {
3843   if (!UseLargePages &amp;&amp;
3844       !UseTransparentHugePages &amp;&amp;
3845       !UseHugeTLBFS &amp;&amp;
3846       !UseSHM) {
3847     // Not using large pages.
3848     return;
3849   }
3850 
3851   if (!FLAG_IS_DEFAULT(UseLargePages) &amp;&amp; !UseLargePages) {
3852     // The user explicitly turned off large pages.
3853     // Ignore the rest of the large pages flags.
3854     UseTransparentHugePages = false;
3855     UseHugeTLBFS = false;
3856     UseSHM = false;
3857     return;
3858   }
3859 
3860   size_t large_page_size = Linux::setup_large_page_size();
3861   UseLargePages          = Linux::setup_large_page_type(large_page_size);
3862 
3863   set_coredump_filter(LARGEPAGES_BIT);
3864 }
3865 
3866 #ifndef SHM_HUGETLB
3867   #define SHM_HUGETLB 04000
3868 #endif
3869 
3870 #define shm_warning_format(format, ...)              \
3871   do {                                               \
3872     if (UseLargePages &amp;&amp;                             \
3873         (!FLAG_IS_DEFAULT(UseLargePages) ||          \
3874          !FLAG_IS_DEFAULT(UseSHM) ||                 \
3875          !FLAG_IS_DEFAULT(LargePageSizeInBytes))) {  \
3876       warning(format, __VA_ARGS__);                  \
3877     }                                                \
3878   } while (0)
3879 
3880 #define shm_warning(str) shm_warning_format(&quot;%s&quot;, str)
3881 
3882 #define shm_warning_with_errno(str)                \
3883   do {                                             \
3884     int err = errno;                               \
3885     shm_warning_format(str &quot; (error = %d)&quot;, err);  \
3886   } while (0)
3887 
3888 static char* shmat_with_alignment(int shmid, size_t bytes, size_t alignment) {
3889   assert(is_aligned(bytes, alignment), &quot;Must be divisible by the alignment&quot;);
3890 
3891   if (!is_aligned(alignment, SHMLBA)) {
3892     assert(false, &quot;Code below assumes that alignment is at least SHMLBA aligned&quot;);
3893     return NULL;
3894   }
3895 
3896   // To ensure that we get &#39;alignment&#39; aligned memory from shmat,
3897   // we pre-reserve aligned virtual memory and then attach to that.
3898 
3899   char* pre_reserved_addr = anon_mmap_aligned(bytes, alignment, NULL);
3900   if (pre_reserved_addr == NULL) {
3901     // Couldn&#39;t pre-reserve aligned memory.
3902     shm_warning(&quot;Failed to pre-reserve aligned memory for shmat.&quot;);
3903     return NULL;
3904   }
3905 
3906   // SHM_REMAP is needed to allow shmat to map over an existing mapping.
3907   char* addr = (char*)shmat(shmid, pre_reserved_addr, SHM_REMAP);
3908 
3909   if ((intptr_t)addr == -1) {
3910     int err = errno;
3911     shm_warning_with_errno(&quot;Failed to attach shared memory.&quot;);
3912 
3913     assert(err != EACCES, &quot;Unexpected error&quot;);
3914     assert(err != EIDRM,  &quot;Unexpected error&quot;);
3915     assert(err != EINVAL, &quot;Unexpected error&quot;);
3916 
3917     // Since we don&#39;t know if the kernel unmapped the pre-reserved memory area
3918     // we can&#39;t unmap it, since that would potentially unmap memory that was
3919     // mapped from other threads.
3920     return NULL;
3921   }
3922 
3923   return addr;
3924 }
3925 
3926 static char* shmat_at_address(int shmid, char* req_addr) {
3927   if (!is_aligned(req_addr, SHMLBA)) {
3928     assert(false, &quot;Requested address needs to be SHMLBA aligned&quot;);
3929     return NULL;
3930   }
3931 
3932   char* addr = (char*)shmat(shmid, req_addr, 0);
3933 
3934   if ((intptr_t)addr == -1) {
3935     shm_warning_with_errno(&quot;Failed to attach shared memory.&quot;);
3936     return NULL;
3937   }
3938 
3939   return addr;
3940 }
3941 
3942 static char* shmat_large_pages(int shmid, size_t bytes, size_t alignment, char* req_addr) {
3943   // If a req_addr has been provided, we assume that the caller has already aligned the address.
3944   if (req_addr != NULL) {
3945     assert(is_aligned(req_addr, os::large_page_size()), &quot;Must be divisible by the large page size&quot;);
3946     assert(is_aligned(req_addr, alignment), &quot;Must be divisible by given alignment&quot;);
3947     return shmat_at_address(shmid, req_addr);
3948   }
3949 
3950   // Since shmid has been setup with SHM_HUGETLB, shmat will automatically
3951   // return large page size aligned memory addresses when req_addr == NULL.
3952   // However, if the alignment is larger than the large page size, we have
3953   // to manually ensure that the memory returned is &#39;alignment&#39; aligned.
3954   if (alignment &gt; os::large_page_size()) {
3955     assert(is_aligned(alignment, os::large_page_size()), &quot;Must be divisible by the large page size&quot;);
3956     return shmat_with_alignment(shmid, bytes, alignment);
3957   } else {
3958     return shmat_at_address(shmid, NULL);
3959   }
3960 }
3961 
3962 char* os::Linux::reserve_memory_special_shm(size_t bytes, size_t alignment,
3963                                             char* req_addr, bool exec) {
3964   // &quot;exec&quot; is passed in but not used.  Creating the shared image for
3965   // the code cache doesn&#39;t have an SHM_X executable permission to check.
3966   assert(UseLargePages &amp;&amp; UseSHM, &quot;only for SHM large pages&quot;);
3967   assert(is_aligned(req_addr, os::large_page_size()), &quot;Unaligned address&quot;);
3968   assert(is_aligned(req_addr, alignment), &quot;Unaligned address&quot;);
3969 
3970   if (!is_aligned(bytes, os::large_page_size())) {
3971     return NULL; // Fallback to small pages.
3972   }
3973 
3974   // Create a large shared memory region to attach to based on size.
3975   // Currently, size is the total size of the heap.
3976   int shmid = shmget(IPC_PRIVATE, bytes, SHM_HUGETLB|IPC_CREAT|SHM_R|SHM_W);
3977   if (shmid == -1) {
3978     // Possible reasons for shmget failure:
3979     // 1. shmmax is too small for Java heap.
3980     //    &gt; check shmmax value: cat /proc/sys/kernel/shmmax
3981     //    &gt; increase shmmax value: echo &quot;0xffffffff&quot; &gt; /proc/sys/kernel/shmmax
3982     // 2. not enough large page memory.
3983     //    &gt; check available large pages: cat /proc/meminfo
3984     //    &gt; increase amount of large pages:
3985     //          echo new_value &gt; /proc/sys/vm/nr_hugepages
3986     //      Note 1: different Linux may use different name for this property,
3987     //            e.g. on Redhat AS-3 it is &quot;hugetlb_pool&quot;.
3988     //      Note 2: it&#39;s possible there&#39;s enough physical memory available but
3989     //            they are so fragmented after a long run that they can&#39;t
3990     //            coalesce into large pages. Try to reserve large pages when
3991     //            the system is still &quot;fresh&quot;.
3992     shm_warning_with_errno(&quot;Failed to reserve shared memory.&quot;);
3993     return NULL;
3994   }
3995 
3996   // Attach to the region.
3997   char* addr = shmat_large_pages(shmid, bytes, alignment, req_addr);
3998 
3999   // Remove shmid. If shmat() is successful, the actual shared memory segment
4000   // will be deleted when it&#39;s detached by shmdt() or when the process
4001   // terminates. If shmat() is not successful this will remove the shared
4002   // segment immediately.
4003   shmctl(shmid, IPC_RMID, NULL);
4004 
4005   return addr;
4006 }
4007 
4008 static void warn_on_large_pages_failure(char* req_addr, size_t bytes,
4009                                         int error) {
4010   assert(error == ENOMEM, &quot;Only expect to fail if no memory is available&quot;);
4011 
4012   bool warn_on_failure = UseLargePages &amp;&amp;
4013       (!FLAG_IS_DEFAULT(UseLargePages) ||
4014        !FLAG_IS_DEFAULT(UseHugeTLBFS) ||
4015        !FLAG_IS_DEFAULT(LargePageSizeInBytes));
4016 
4017   if (warn_on_failure) {
4018     char msg[128];
4019     jio_snprintf(msg, sizeof(msg), &quot;Failed to reserve large pages memory req_addr: &quot;
4020                  PTR_FORMAT &quot; bytes: &quot; SIZE_FORMAT &quot; (errno = %d).&quot;, req_addr, bytes, error);
4021     warning(&quot;%s&quot;, msg);
4022   }
4023 }
4024 
4025 char* os::Linux::reserve_memory_special_huge_tlbfs_only(size_t bytes,
4026                                                         char* req_addr,
4027                                                         bool exec) {
4028   assert(UseLargePages &amp;&amp; UseHugeTLBFS, &quot;only for Huge TLBFS large pages&quot;);
4029   assert(is_aligned(bytes, os::large_page_size()), &quot;Unaligned size&quot;);
4030   assert(is_aligned(req_addr, os::large_page_size()), &quot;Unaligned address&quot;);
4031 
4032   int prot = exec ? PROT_READ|PROT_WRITE|PROT_EXEC : PROT_READ|PROT_WRITE;
4033   char* addr = (char*)::mmap(req_addr, bytes, prot,
4034                              MAP_PRIVATE|MAP_ANONYMOUS|MAP_HUGETLB,
4035                              -1, 0);
4036 
4037   if (addr == MAP_FAILED) {
4038     warn_on_large_pages_failure(req_addr, bytes, errno);
4039     return NULL;
4040   }
4041 
4042   assert(is_aligned(addr, os::large_page_size()), &quot;Must be&quot;);
4043 
4044   return addr;
4045 }
4046 
4047 // Reserve memory using mmap(MAP_HUGETLB).
4048 //  - bytes shall be a multiple of alignment.
4049 //  - req_addr can be NULL. If not NULL, it must be a multiple of alignment.
4050 //  - alignment sets the alignment at which memory shall be allocated.
4051 //     It must be a multiple of allocation granularity.
4052 // Returns address of memory or NULL. If req_addr was not NULL, will only return
4053 //  req_addr or NULL.
4054 char* os::Linux::reserve_memory_special_huge_tlbfs_mixed(size_t bytes,
4055                                                          size_t alignment,
4056                                                          char* req_addr,
4057                                                          bool exec) {
4058   size_t large_page_size = os::large_page_size();
4059   assert(bytes &gt;= large_page_size, &quot;Shouldn&#39;t allocate large pages for small sizes&quot;);
4060 
4061   assert(is_aligned(req_addr, alignment), &quot;Must be&quot;);
4062   assert(is_aligned(bytes, alignment), &quot;Must be&quot;);
4063 
4064   // First reserve - but not commit - the address range in small pages.
4065   char* const start = anon_mmap_aligned(bytes, alignment, req_addr);
4066 
4067   if (start == NULL) {
4068     return NULL;
4069   }
4070 
4071   assert(is_aligned(start, alignment), &quot;Must be&quot;);
4072 
4073   char* end = start + bytes;
4074 
4075   // Find the regions of the allocated chunk that can be promoted to large pages.
4076   char* lp_start = align_up(start, large_page_size);
4077   char* lp_end   = align_down(end, large_page_size);
4078 
4079   size_t lp_bytes = lp_end - lp_start;
4080 
4081   assert(is_aligned(lp_bytes, large_page_size), &quot;Must be&quot;);
4082 
4083   if (lp_bytes == 0) {
4084     // The mapped region doesn&#39;t even span the start and the end of a large page.
4085     // Fall back to allocate a non-special area.
4086     ::munmap(start, end - start);
4087     return NULL;
4088   }
4089 
4090   int prot = exec ? PROT_READ|PROT_WRITE|PROT_EXEC : PROT_READ|PROT_WRITE;
4091 
4092   void* result;
4093 
4094   // Commit small-paged leading area.
4095   if (start != lp_start) {
4096     result = ::mmap(start, lp_start - start, prot,
4097                     MAP_PRIVATE|MAP_ANONYMOUS|MAP_FIXED,
4098                     -1, 0);
4099     if (result == MAP_FAILED) {
4100       ::munmap(lp_start, end - lp_start);
4101       return NULL;
4102     }
4103   }
4104 
4105   // Commit large-paged area.
4106   result = ::mmap(lp_start, lp_bytes, prot,
4107                   MAP_PRIVATE|MAP_ANONYMOUS|MAP_FIXED|MAP_HUGETLB,
4108                   -1, 0);
4109   if (result == MAP_FAILED) {
4110     warn_on_large_pages_failure(lp_start, lp_bytes, errno);
4111     // If the mmap above fails, the large pages region will be unmapped and we
4112     // have regions before and after with small pages. Release these regions.
4113     //
4114     // |  mapped  |  unmapped  |  mapped  |
4115     // ^          ^            ^          ^
4116     // start      lp_start     lp_end     end
4117     //
4118     ::munmap(start, lp_start - start);
4119     ::munmap(lp_end, end - lp_end);
4120     return NULL;
4121   }
4122 
4123   // Commit small-paged trailing area.
4124   if (lp_end != end) {
4125     result = ::mmap(lp_end, end - lp_end, prot,
4126                     MAP_PRIVATE|MAP_ANONYMOUS|MAP_FIXED,
4127                     -1, 0);
4128     if (result == MAP_FAILED) {
4129       ::munmap(start, lp_end - start);
4130       return NULL;
4131     }
4132   }
4133 
4134   return start;
4135 }
4136 
4137 char* os::Linux::reserve_memory_special_huge_tlbfs(size_t bytes,
4138                                                    size_t alignment,
4139                                                    char* req_addr,
4140                                                    bool exec) {
4141   assert(UseLargePages &amp;&amp; UseHugeTLBFS, &quot;only for Huge TLBFS large pages&quot;);
4142   assert(is_aligned(req_addr, alignment), &quot;Must be&quot;);
4143   assert(is_aligned(alignment, os::vm_allocation_granularity()), &quot;Must be&quot;);
4144   assert(is_power_of_2(os::large_page_size()), &quot;Must be&quot;);
4145   assert(bytes &gt;= os::large_page_size(), &quot;Shouldn&#39;t allocate large pages for small sizes&quot;);
4146 
4147   if (is_aligned(bytes, os::large_page_size()) &amp;&amp; alignment &lt;= os::large_page_size()) {
4148     return reserve_memory_special_huge_tlbfs_only(bytes, req_addr, exec);
4149   } else {
4150     return reserve_memory_special_huge_tlbfs_mixed(bytes, alignment, req_addr, exec);
4151   }
4152 }
4153 
4154 char* os::reserve_memory_special(size_t bytes, size_t alignment,
4155                                  char* req_addr, bool exec) {
4156   assert(UseLargePages, &quot;only for large pages&quot;);
4157 
4158   char* addr;
4159   if (UseSHM) {
4160     addr = os::Linux::reserve_memory_special_shm(bytes, alignment, req_addr, exec);
4161   } else {
4162     assert(UseHugeTLBFS, &quot;must be&quot;);
4163     addr = os::Linux::reserve_memory_special_huge_tlbfs(bytes, alignment, req_addr, exec);
4164   }
4165 
4166   if (addr != NULL) {
4167     if (UseNUMAInterleaving) {
4168       numa_make_global(addr, bytes);
4169     }
4170 
4171     // The memory is committed
4172     MemTracker::record_virtual_memory_reserve_and_commit((address)addr, bytes, CALLER_PC);
4173   }
4174 
4175   return addr;
4176 }
4177 
4178 bool os::Linux::release_memory_special_shm(char* base, size_t bytes) {
4179   // detaching the SHM segment will also delete it, see reserve_memory_special_shm()
4180   return shmdt(base) == 0;
4181 }
4182 
4183 bool os::Linux::release_memory_special_huge_tlbfs(char* base, size_t bytes) {
4184   return pd_release_memory(base, bytes);
4185 }
4186 
4187 bool os::release_memory_special(char* base, size_t bytes) {
4188   bool res;
4189   if (MemTracker::tracking_level() &gt; NMT_minimal) {
4190     Tracker tkr(Tracker::release);
4191     res = os::Linux::release_memory_special_impl(base, bytes);
4192     if (res) {
4193       tkr.record((address)base, bytes);
4194     }
4195 
4196   } else {
4197     res = os::Linux::release_memory_special_impl(base, bytes);
4198   }
4199   return res;
4200 }
4201 
4202 bool os::Linux::release_memory_special_impl(char* base, size_t bytes) {
4203   assert(UseLargePages, &quot;only for large pages&quot;);
4204   bool res;
4205 
4206   if (UseSHM) {
4207     res = os::Linux::release_memory_special_shm(base, bytes);
4208   } else {
4209     assert(UseHugeTLBFS, &quot;must be&quot;);
4210     res = os::Linux::release_memory_special_huge_tlbfs(base, bytes);
4211   }
4212   return res;
4213 }
4214 
4215 size_t os::large_page_size() {
4216   return _large_page_size;
4217 }
4218 
4219 // With SysV SHM the entire memory region must be allocated as shared
4220 // memory.
4221 // HugeTLBFS allows application to commit large page memory on demand.
4222 // However, when committing memory with HugeTLBFS fails, the region
4223 // that was supposed to be committed will lose the old reservation
4224 // and allow other threads to steal that memory region. Because of this
4225 // behavior we can&#39;t commit HugeTLBFS memory.
4226 bool os::can_commit_large_page_memory() {
4227   return UseTransparentHugePages;
4228 }
4229 
4230 bool os::can_execute_large_page_memory() {
4231   return UseTransparentHugePages || UseHugeTLBFS;
4232 }
4233 
4234 char* os::pd_attempt_reserve_memory_at(size_t bytes, char* requested_addr, int file_desc) {
4235   assert(file_desc &gt;= 0, &quot;file_desc is not valid&quot;);
4236   char* result = pd_attempt_reserve_memory_at(bytes, requested_addr);
4237   if (result != NULL) {
4238     if (replace_existing_mapping_with_file_mapping(result, bytes, file_desc) == NULL) {
4239       vm_exit_during_initialization(err_msg(&quot;Error in mapping Java heap at the given filesystem directory&quot;));
4240     }
4241   }
4242   return result;
4243 }
4244 
4245 // Reserve memory at an arbitrary address, only if that area is
4246 // available (and not reserved for something else).
4247 
4248 char* os::pd_attempt_reserve_memory_at(size_t bytes, char* requested_addr) {
4249   // Assert only that the size is a multiple of the page size, since
4250   // that&#39;s all that mmap requires, and since that&#39;s all we really know
4251   // about at this low abstraction level.  If we need higher alignment,
4252   // we can either pass an alignment to this method or verify alignment
4253   // in one of the methods further up the call chain.  See bug 5044738.
4254   assert(bytes % os::vm_page_size() == 0, &quot;reserving unexpected size block&quot;);
4255 
4256   // Repeatedly allocate blocks until the block is allocated at the
4257   // right spot.
4258 
4259   // Linux mmap allows caller to pass an address as hint; give it a try first,
4260   // if kernel honors the hint then we can return immediately.
4261   char * addr = anon_mmap(requested_addr, bytes, false);
4262   if (addr == requested_addr) {
4263     return requested_addr;
4264   }
4265 
4266   if (addr != NULL) {
4267     // mmap() is successful but it fails to reserve at the requested address
4268     anon_munmap(addr, bytes);
4269   }
4270 
4271   return NULL;
4272 }
4273 
4274 // Sleep forever; naked call to OS-specific sleep; use with CAUTION
4275 void os::infinite_sleep() {
4276   while (true) {    // sleep forever ...
4277     ::sleep(100);   // ... 100 seconds at a time
4278   }
4279 }
4280 
4281 // Used to convert frequent JVM_Yield() to nops
4282 bool os::dont_yield() {
4283   return DontYieldALot;
4284 }
4285 
4286 // Linux CFS scheduler (since 2.6.23) does not guarantee sched_yield(2) will
4287 // actually give up the CPU. Since skip buddy (v2.6.28):
4288 //
4289 // * Sets the yielding task as skip buddy for current CPU&#39;s run queue.
4290 // * Picks next from run queue, if empty, picks a skip buddy (can be the yielding task).
4291 // * Clears skip buddies for this run queue (yielding task no longer a skip buddy).
4292 //
4293 // An alternative is calling os::naked_short_nanosleep with a small number to avoid
4294 // getting re-scheduled immediately.
4295 //
4296 void os::naked_yield() {
4297   sched_yield();
4298 }
4299 
4300 ////////////////////////////////////////////////////////////////////////////////
4301 // thread priority support
4302 
4303 // Note: Normal Linux applications are run with SCHED_OTHER policy. SCHED_OTHER
4304 // only supports dynamic priority, static priority must be zero. For real-time
4305 // applications, Linux supports SCHED_RR which allows static priority (1-99).
4306 // However, for large multi-threaded applications, SCHED_RR is not only slower
4307 // than SCHED_OTHER, but also very unstable (my volano tests hang hard 4 out
4308 // of 5 runs - Sep 2005).
4309 //
4310 // The following code actually changes the niceness of kernel-thread/LWP. It
4311 // has an assumption that setpriority() only modifies one kernel-thread/LWP,
4312 // not the entire user process, and user level threads are 1:1 mapped to kernel
4313 // threads. It has always been the case, but could change in the future. For
4314 // this reason, the code should not be used as default (ThreadPriorityPolicy=0).
4315 // It is only used when ThreadPriorityPolicy=1 and may require system level permission
4316 // (e.g., root privilege or CAP_SYS_NICE capability).
4317 
4318 int os::java_to_os_priority[CriticalPriority + 1] = {
4319   19,              // 0 Entry should never be used
4320 
4321    4,              // 1 MinPriority
4322    3,              // 2
4323    2,              // 3
4324 
4325    1,              // 4
4326    0,              // 5 NormPriority
4327   -1,              // 6
4328 
4329   -2,              // 7
4330   -3,              // 8
4331   -4,              // 9 NearMaxPriority
4332 
4333   -5,              // 10 MaxPriority
4334 
4335   -5               // 11 CriticalPriority
4336 };
4337 
4338 static int prio_init() {
4339   if (ThreadPriorityPolicy == 1) {
4340     if (geteuid() != 0) {
4341       if (!FLAG_IS_DEFAULT(ThreadPriorityPolicy)) {
4342         warning(&quot;-XX:ThreadPriorityPolicy=1 may require system level permission, &quot; \
4343                 &quot;e.g., being the root user. If the necessary permission is not &quot; \
4344                 &quot;possessed, changes to priority will be silently ignored.&quot;);
4345       }
4346     }
4347   }
4348   if (UseCriticalJavaThreadPriority) {
4349     os::java_to_os_priority[MaxPriority] = os::java_to_os_priority[CriticalPriority];
4350   }
4351   return 0;
4352 }
4353 
4354 OSReturn os::set_native_priority(Thread* thread, int newpri) {
4355   if (!UseThreadPriorities || ThreadPriorityPolicy == 0) return OS_OK;
4356 
4357   int ret = setpriority(PRIO_PROCESS, thread-&gt;osthread()-&gt;thread_id(), newpri);
4358   return (ret == 0) ? OS_OK : OS_ERR;
4359 }
4360 
4361 OSReturn os::get_native_priority(const Thread* const thread,
4362                                  int *priority_ptr) {
4363   if (!UseThreadPriorities || ThreadPriorityPolicy == 0) {
4364     *priority_ptr = java_to_os_priority[NormPriority];
4365     return OS_OK;
4366   }
4367 
4368   errno = 0;
4369   *priority_ptr = getpriority(PRIO_PROCESS, thread-&gt;osthread()-&gt;thread_id());
4370   return (*priority_ptr != -1 || errno == 0 ? OS_OK : OS_ERR);
4371 }
4372 
4373 ////////////////////////////////////////////////////////////////////////////////
4374 // suspend/resume support
4375 
4376 //  The low-level signal-based suspend/resume support is a remnant from the
4377 //  old VM-suspension that used to be for java-suspension, safepoints etc,
4378 //  within hotspot. Currently used by JFR&#39;s OSThreadSampler
4379 //
4380 //  The remaining code is greatly simplified from the more general suspension
4381 //  code that used to be used.
4382 //
4383 //  The protocol is quite simple:
4384 //  - suspend:
4385 //      - sends a signal to the target thread
4386 //      - polls the suspend state of the osthread using a yield loop
4387 //      - target thread signal handler (SR_handler) sets suspend state
4388 //        and blocks in sigsuspend until continued
4389 //  - resume:
4390 //      - sets target osthread state to continue
4391 //      - sends signal to end the sigsuspend loop in the SR_handler
4392 //
4393 //  Note that the SR_lock plays no role in this suspend/resume protocol,
4394 //  but is checked for NULL in SR_handler as a thread termination indicator.
4395 //  The SR_lock is, however, used by JavaThread::java_suspend()/java_resume() APIs.
4396 //
4397 //  Note that resume_clear_context() and suspend_save_context() are needed
4398 //  by SR_handler(), so that fetch_frame_from_ucontext() works,
4399 //  which in part is used by:
4400 //    - Forte Analyzer: AsyncGetCallTrace()
4401 //    - StackBanging: get_frame_at_stack_banging_point()
4402 
4403 static void resume_clear_context(OSThread *osthread) {
4404   osthread-&gt;set_ucontext(NULL);
4405   osthread-&gt;set_siginfo(NULL);
4406 }
4407 
4408 static void suspend_save_context(OSThread *osthread, siginfo_t* siginfo,
4409                                  ucontext_t* context) {
4410   osthread-&gt;set_ucontext(context);
4411   osthread-&gt;set_siginfo(siginfo);
4412 }
4413 
4414 // Handler function invoked when a thread&#39;s execution is suspended or
4415 // resumed. We have to be careful that only async-safe functions are
4416 // called here (Note: most pthread functions are not async safe and
4417 // should be avoided.)
4418 //
4419 // Note: sigwait() is a more natural fit than sigsuspend() from an
4420 // interface point of view, but sigwait() prevents the signal hander
4421 // from being run. libpthread would get very confused by not having
4422 // its signal handlers run and prevents sigwait()&#39;s use with the
4423 // mutex granting granting signal.
4424 //
4425 // Currently only ever called on the VMThread and JavaThreads (PC sampling)
4426 //
4427 static void SR_handler(int sig, siginfo_t* siginfo, ucontext_t* context) {
4428   // Save and restore errno to avoid confusing native code with EINTR
4429   // after sigsuspend.
4430   int old_errno = errno;
4431 
4432   Thread* thread = Thread::current_or_null_safe();
4433   assert(thread != NULL, &quot;Missing current thread in SR_handler&quot;);
4434 
4435   // On some systems we have seen signal delivery get &quot;stuck&quot; until the signal
4436   // mask is changed as part of thread termination. Check that the current thread
4437   // has not already terminated (via SR_lock()) - else the following assertion
4438   // will fail because the thread is no longer a JavaThread as the ~JavaThread
4439   // destructor has completed.
4440 
4441   if (thread-&gt;SR_lock() == NULL) {
4442     return;
4443   }
4444 
4445   assert(thread-&gt;is_VM_thread() || thread-&gt;is_Java_thread(), &quot;Must be VMThread or JavaThread&quot;);
4446 
4447   OSThread* osthread = thread-&gt;osthread();
4448 
4449   os::SuspendResume::State current = osthread-&gt;sr.state();
4450   if (current == os::SuspendResume::SR_SUSPEND_REQUEST) {
4451     suspend_save_context(osthread, siginfo, context);
4452 
4453     // attempt to switch the state, we assume we had a SUSPEND_REQUEST
4454     os::SuspendResume::State state = osthread-&gt;sr.suspended();
4455     if (state == os::SuspendResume::SR_SUSPENDED) {
4456       sigset_t suspend_set;  // signals for sigsuspend()
4457       sigemptyset(&amp;suspend_set);
4458       // get current set of blocked signals and unblock resume signal
4459       pthread_sigmask(SIG_BLOCK, NULL, &amp;suspend_set);
4460       sigdelset(&amp;suspend_set, SR_signum);
4461 
4462       sr_semaphore.signal();
4463       // wait here until we are resumed
4464       while (1) {
4465         sigsuspend(&amp;suspend_set);
4466 
4467         os::SuspendResume::State result = osthread-&gt;sr.running();
4468         if (result == os::SuspendResume::SR_RUNNING) {
4469           sr_semaphore.signal();
4470           break;
4471         }
4472       }
4473 
4474     } else if (state == os::SuspendResume::SR_RUNNING) {
4475       // request was cancelled, continue
4476     } else {
4477       ShouldNotReachHere();
4478     }
4479 
4480     resume_clear_context(osthread);
4481   } else if (current == os::SuspendResume::SR_RUNNING) {
4482     // request was cancelled, continue
4483   } else if (current == os::SuspendResume::SR_WAKEUP_REQUEST) {
4484     // ignore
4485   } else {
4486     // ignore
4487   }
4488 
4489   errno = old_errno;
4490 }
4491 
4492 static int SR_initialize() {
4493   struct sigaction act;
4494   char *s;
4495 
4496   // Get signal number to use for suspend/resume
4497   if ((s = ::getenv(&quot;_JAVA_SR_SIGNUM&quot;)) != 0) {
4498     int sig = ::strtol(s, 0, 10);
4499     if (sig &gt; MAX2(SIGSEGV, SIGBUS) &amp;&amp;  // See 4355769.
4500         sig &lt; NSIG) {                   // Must be legal signal and fit into sigflags[].
4501       SR_signum = sig;
4502     } else {
4503       warning(&quot;You set _JAVA_SR_SIGNUM=%d. It must be in range [%d, %d]. Using %d instead.&quot;,
4504               sig, MAX2(SIGSEGV, SIGBUS)+1, NSIG-1, SR_signum);
4505     }
4506   }
4507 
4508   assert(SR_signum &gt; SIGSEGV &amp;&amp; SR_signum &gt; SIGBUS,
4509          &quot;SR_signum must be greater than max(SIGSEGV, SIGBUS), see 4355769&quot;);
4510 
4511   sigemptyset(&amp;SR_sigset);
4512   sigaddset(&amp;SR_sigset, SR_signum);
4513 
4514   // Set up signal handler for suspend/resume
4515   act.sa_flags = SA_RESTART|SA_SIGINFO;
4516   act.sa_handler = (void (*)(int)) SR_handler;
4517 
4518   // SR_signum is blocked by default.
4519   // 4528190 - We also need to block pthread restart signal (32 on all
4520   // supported Linux platforms). Note that LinuxThreads need to block
4521   // this signal for all threads to work properly. So we don&#39;t have
4522   // to use hard-coded signal number when setting up the mask.
4523   pthread_sigmask(SIG_BLOCK, NULL, &amp;act.sa_mask);
4524 
4525   if (sigaction(SR_signum, &amp;act, 0) == -1) {
4526     return -1;
4527   }
4528 
4529   // Save signal flag
4530   os::Linux::set_our_sigflags(SR_signum, act.sa_flags);
4531   return 0;
4532 }
4533 
4534 static int sr_notify(OSThread* osthread) {
4535   int status = pthread_kill(osthread-&gt;pthread_id(), SR_signum);
4536   assert_status(status == 0, status, &quot;pthread_kill&quot;);
4537   return status;
4538 }
4539 
4540 // &quot;Randomly&quot; selected value for how long we want to spin
4541 // before bailing out on suspending a thread, also how often
4542 // we send a signal to a thread we want to resume
4543 static const int RANDOMLY_LARGE_INTEGER = 1000000;
4544 static const int RANDOMLY_LARGE_INTEGER2 = 100;
4545 
4546 // returns true on success and false on error - really an error is fatal
4547 // but this seems the normal response to library errors
4548 static bool do_suspend(OSThread* osthread) {
4549   assert(osthread-&gt;sr.is_running(), &quot;thread should be running&quot;);
4550   assert(!sr_semaphore.trywait(), &quot;semaphore has invalid state&quot;);
4551 
4552   // mark as suspended and send signal
4553   if (osthread-&gt;sr.request_suspend() != os::SuspendResume::SR_SUSPEND_REQUEST) {
4554     // failed to switch, state wasn&#39;t running?
4555     ShouldNotReachHere();
4556     return false;
4557   }
4558 
4559   if (sr_notify(osthread) != 0) {
4560     ShouldNotReachHere();
4561   }
4562 
4563   // managed to send the signal and switch to SUSPEND_REQUEST, now wait for SUSPENDED
4564   while (true) {
4565     if (sr_semaphore.timedwait(2)) {
4566       break;
4567     } else {
4568       // timeout
4569       os::SuspendResume::State cancelled = osthread-&gt;sr.cancel_suspend();
4570       if (cancelled == os::SuspendResume::SR_RUNNING) {
4571         return false;
4572       } else if (cancelled == os::SuspendResume::SR_SUSPENDED) {
4573         // make sure that we consume the signal on the semaphore as well
4574         sr_semaphore.wait();
4575         break;
4576       } else {
4577         ShouldNotReachHere();
4578         return false;
4579       }
4580     }
4581   }
4582 
4583   guarantee(osthread-&gt;sr.is_suspended(), &quot;Must be suspended&quot;);
4584   return true;
4585 }
4586 
4587 static void do_resume(OSThread* osthread) {
4588   assert(osthread-&gt;sr.is_suspended(), &quot;thread should be suspended&quot;);
4589   assert(!sr_semaphore.trywait(), &quot;invalid semaphore state&quot;);
4590 
4591   if (osthread-&gt;sr.request_wakeup() != os::SuspendResume::SR_WAKEUP_REQUEST) {
4592     // failed to switch to WAKEUP_REQUEST
4593     ShouldNotReachHere();
4594     return;
4595   }
4596 
4597   while (true) {
4598     if (sr_notify(osthread) == 0) {
4599       if (sr_semaphore.timedwait(2)) {
4600         if (osthread-&gt;sr.is_running()) {
4601           return;
4602         }
4603       }
4604     } else {
4605       ShouldNotReachHere();
4606     }
4607   }
4608 
4609   guarantee(osthread-&gt;sr.is_running(), &quot;Must be running!&quot;);
4610 }
4611 
4612 ///////////////////////////////////////////////////////////////////////////////////
4613 // signal handling (except suspend/resume)
4614 
4615 // This routine may be used by user applications as a &quot;hook&quot; to catch signals.
4616 // The user-defined signal handler must pass unrecognized signals to this
4617 // routine, and if it returns true (non-zero), then the signal handler must
4618 // return immediately.  If the flag &quot;abort_if_unrecognized&quot; is true, then this
4619 // routine will never retun false (zero), but instead will execute a VM panic
4620 // routine kill the process.
4621 //
4622 // If this routine returns false, it is OK to call it again.  This allows
4623 // the user-defined signal handler to perform checks either before or after
4624 // the VM performs its own checks.  Naturally, the user code would be making
4625 // a serious error if it tried to handle an exception (such as a null check
4626 // or breakpoint) that the VM was generating for its own correct operation.
4627 //
4628 // This routine may recognize any of the following kinds of signals:
4629 //    SIGBUS, SIGSEGV, SIGILL, SIGFPE, SIGQUIT, SIGPIPE, SIGXFSZ, SIGUSR1.
4630 // It should be consulted by handlers for any of those signals.
4631 //
4632 // The caller of this routine must pass in the three arguments supplied
4633 // to the function referred to in the &quot;sa_sigaction&quot; (not the &quot;sa_handler&quot;)
4634 // field of the structure passed to sigaction().  This routine assumes that
4635 // the sa_flags field passed to sigaction() includes SA_SIGINFO and SA_RESTART.
4636 //
4637 // Note that the VM will print warnings if it detects conflicting signal
4638 // handlers, unless invoked with the option &quot;-XX:+AllowUserSignalHandlers&quot;.
4639 //
4640 extern &quot;C&quot; JNIEXPORT int JVM_handle_linux_signal(int signo,
4641                                                  siginfo_t* siginfo,
4642                                                  void* ucontext,
4643                                                  int abort_if_unrecognized);
4644 
4645 static void signalHandler(int sig, siginfo_t* info, void* uc) {
4646   assert(info != NULL &amp;&amp; uc != NULL, &quot;it must be old kernel&quot;);
4647   int orig_errno = errno;  // Preserve errno value over signal handler.
4648   JVM_handle_linux_signal(sig, info, uc, true);
4649   errno = orig_errno;
4650 }
4651 
4652 
4653 // This boolean allows users to forward their own non-matching signals
4654 // to JVM_handle_linux_signal, harmlessly.
4655 bool os::Linux::signal_handlers_are_installed = false;
4656 
4657 // For signal-chaining
4658 bool os::Linux::libjsig_is_loaded = false;
4659 typedef struct sigaction *(*get_signal_t)(int);
4660 get_signal_t os::Linux::get_signal_action = NULL;
4661 
4662 struct sigaction* os::Linux::get_chained_signal_action(int sig) {
4663   struct sigaction *actp = NULL;
4664 
4665   if (libjsig_is_loaded) {
4666     // Retrieve the old signal handler from libjsig
4667     actp = (*get_signal_action)(sig);
4668   }
4669   if (actp == NULL) {
4670     // Retrieve the preinstalled signal handler from jvm
4671     actp = os::Posix::get_preinstalled_handler(sig);
4672   }
4673 
4674   return actp;
4675 }
4676 
4677 static bool call_chained_handler(struct sigaction *actp, int sig,
4678                                  siginfo_t *siginfo, void *context) {
4679   // Call the old signal handler
4680   if (actp-&gt;sa_handler == SIG_DFL) {
4681     // It&#39;s more reasonable to let jvm treat it as an unexpected exception
4682     // instead of taking the default action.
4683     return false;
4684   } else if (actp-&gt;sa_handler != SIG_IGN) {
4685     if ((actp-&gt;sa_flags &amp; SA_NODEFER) == 0) {
4686       // automaticlly block the signal
4687       sigaddset(&amp;(actp-&gt;sa_mask), sig);
4688     }
4689 
4690     sa_handler_t hand = NULL;
4691     sa_sigaction_t sa = NULL;
4692     bool siginfo_flag_set = (actp-&gt;sa_flags &amp; SA_SIGINFO) != 0;
4693     // retrieve the chained handler
4694     if (siginfo_flag_set) {
4695       sa = actp-&gt;sa_sigaction;
4696     } else {
4697       hand = actp-&gt;sa_handler;
4698     }
4699 
4700     if ((actp-&gt;sa_flags &amp; SA_RESETHAND) != 0) {
4701       actp-&gt;sa_handler = SIG_DFL;
4702     }
4703 
4704     // try to honor the signal mask
4705     sigset_t oset;
4706     sigemptyset(&amp;oset);
4707     pthread_sigmask(SIG_SETMASK, &amp;(actp-&gt;sa_mask), &amp;oset);
4708 
4709     // call into the chained handler
4710     if (siginfo_flag_set) {
4711       (*sa)(sig, siginfo, context);
4712     } else {
4713       (*hand)(sig);
4714     }
4715 
4716     // restore the signal mask
4717     pthread_sigmask(SIG_SETMASK, &amp;oset, NULL);
4718   }
4719   // Tell jvm&#39;s signal handler the signal is taken care of.
4720   return true;
4721 }
4722 
4723 bool os::Linux::chained_handler(int sig, siginfo_t* siginfo, void* context) {
4724   bool chained = false;
4725   // signal-chaining
4726   if (UseSignalChaining) {
4727     struct sigaction *actp = get_chained_signal_action(sig);
4728     if (actp != NULL) {
4729       chained = call_chained_handler(actp, sig, siginfo, context);
4730     }
4731   }
4732   return chained;
4733 }
4734 
4735 // for diagnostic
4736 int sigflags[NSIG];
4737 
4738 int os::Linux::get_our_sigflags(int sig) {
4739   assert(sig &gt; 0 &amp;&amp; sig &lt; NSIG, &quot;vm signal out of expected range&quot;);
4740   return sigflags[sig];
4741 }
4742 
4743 void os::Linux::set_our_sigflags(int sig, int flags) {
4744   assert(sig &gt; 0 &amp;&amp; sig &lt; NSIG, &quot;vm signal out of expected range&quot;);
4745   if (sig &gt; 0 &amp;&amp; sig &lt; NSIG) {
4746     sigflags[sig] = flags;
4747   }
4748 }
4749 
4750 void os::Linux::set_signal_handler(int sig, bool set_installed) {
4751   // Check for overwrite.
4752   struct sigaction oldAct;
4753   sigaction(sig, (struct sigaction*)NULL, &amp;oldAct);
4754 
4755   void* oldhand = oldAct.sa_sigaction
4756                 ? CAST_FROM_FN_PTR(void*,  oldAct.sa_sigaction)
4757                 : CAST_FROM_FN_PTR(void*,  oldAct.sa_handler);
4758   if (oldhand != CAST_FROM_FN_PTR(void*, SIG_DFL) &amp;&amp;
4759       oldhand != CAST_FROM_FN_PTR(void*, SIG_IGN) &amp;&amp;
4760       oldhand != CAST_FROM_FN_PTR(void*, (sa_sigaction_t)signalHandler)) {
4761     if (AllowUserSignalHandlers || !set_installed) {
4762       // Do not overwrite; user takes responsibility to forward to us.
4763       return;
4764     } else if (UseSignalChaining) {
4765       // save the old handler in jvm
4766       os::Posix::save_preinstalled_handler(sig, oldAct);
4767       // libjsig also interposes the sigaction() call below and saves the
4768       // old sigaction on it own.
4769     } else {
4770       fatal(&quot;Encountered unexpected pre-existing sigaction handler &quot;
4771             &quot;%#lx for signal %d.&quot;, (long)oldhand, sig);
4772     }
4773   }
4774 
4775   struct sigaction sigAct;
4776   sigfillset(&amp;(sigAct.sa_mask));
4777   sigAct.sa_handler = SIG_DFL;
4778   if (!set_installed) {
4779     sigAct.sa_flags = SA_SIGINFO|SA_RESTART;
4780   } else {
4781     sigAct.sa_sigaction = signalHandler;
4782     sigAct.sa_flags = SA_SIGINFO|SA_RESTART;
4783   }
4784   // Save flags, which are set by ours
4785   assert(sig &gt; 0 &amp;&amp; sig &lt; NSIG, &quot;vm signal out of expected range&quot;);
4786   sigflags[sig] = sigAct.sa_flags;
4787 
4788   int ret = sigaction(sig, &amp;sigAct, &amp;oldAct);
4789   assert(ret == 0, &quot;check&quot;);
4790 
4791   void* oldhand2  = oldAct.sa_sigaction
4792                   ? CAST_FROM_FN_PTR(void*, oldAct.sa_sigaction)
4793                   : CAST_FROM_FN_PTR(void*, oldAct.sa_handler);
4794   assert(oldhand2 == oldhand, &quot;no concurrent signal handler installation&quot;);
4795 }
4796 
4797 // install signal handlers for signals that HotSpot needs to
4798 // handle in order to support Java-level exception handling.
4799 
4800 void os::Linux::install_signal_handlers() {
4801   if (!signal_handlers_are_installed) {
4802     signal_handlers_are_installed = true;
4803 
4804     // signal-chaining
4805     typedef void (*signal_setting_t)();
4806     signal_setting_t begin_signal_setting = NULL;
4807     signal_setting_t end_signal_setting = NULL;
4808     begin_signal_setting = CAST_TO_FN_PTR(signal_setting_t,
4809                                           dlsym(RTLD_DEFAULT, &quot;JVM_begin_signal_setting&quot;));
4810     if (begin_signal_setting != NULL) {
4811       end_signal_setting = CAST_TO_FN_PTR(signal_setting_t,
4812                                           dlsym(RTLD_DEFAULT, &quot;JVM_end_signal_setting&quot;));
4813       get_signal_action = CAST_TO_FN_PTR(get_signal_t,
4814                                          dlsym(RTLD_DEFAULT, &quot;JVM_get_signal_action&quot;));
4815       libjsig_is_loaded = true;
4816       assert(UseSignalChaining, &quot;should enable signal-chaining&quot;);
4817     }
4818     if (libjsig_is_loaded) {
4819       // Tell libjsig jvm is setting signal handlers
4820       (*begin_signal_setting)();
4821     }
4822 
4823     set_signal_handler(SIGSEGV, true);
4824     set_signal_handler(SIGPIPE, true);
4825     set_signal_handler(SIGBUS, true);
4826     set_signal_handler(SIGILL, true);
4827     set_signal_handler(SIGFPE, true);
4828 #if defined(PPC64)
4829     set_signal_handler(SIGTRAP, true);
4830 #endif
4831     set_signal_handler(SIGXFSZ, true);
4832 
4833     if (libjsig_is_loaded) {
4834       // Tell libjsig jvm finishes setting signal handlers
4835       (*end_signal_setting)();
4836     }
4837 
4838     // We don&#39;t activate signal checker if libjsig is in place, we trust ourselves
4839     // and if UserSignalHandler is installed all bets are off.
4840     // Log that signal checking is off only if -verbose:jni is specified.
4841     if (CheckJNICalls) {
4842       if (libjsig_is_loaded) {
4843         log_debug(jni, resolve)(&quot;Info: libjsig is activated, all active signal checking is disabled&quot;);
4844         check_signals = false;
4845       }
4846       if (AllowUserSignalHandlers) {
4847         log_debug(jni, resolve)(&quot;Info: AllowUserSignalHandlers is activated, all active signal checking is disabled&quot;);
4848         check_signals = false;
4849       }
4850     }
4851   }
4852 }
4853 
4854 // This is the fastest way to get thread cpu time on Linux.
4855 // Returns cpu time (user+sys) for any thread, not only for current.
4856 // POSIX compliant clocks are implemented in the kernels 2.6.16+.
4857 // It might work on 2.6.10+ with a special kernel/glibc patch.
4858 // For reference, please, see IEEE Std 1003.1-2004:
4859 //   http://www.unix.org/single_unix_specification
4860 
4861 jlong os::Linux::fast_thread_cpu_time(clockid_t clockid) {
4862   struct timespec tp;
4863   int rc = os::Posix::clock_gettime(clockid, &amp;tp);
4864   assert(rc == 0, &quot;clock_gettime is expected to return 0 code&quot;);
4865 
4866   return (tp.tv_sec * NANOSECS_PER_SEC) + tp.tv_nsec;
4867 }
4868 
4869 /////
4870 // glibc on Linux platform uses non-documented flag
4871 // to indicate, that some special sort of signal
4872 // trampoline is used.
4873 // We will never set this flag, and we should
4874 // ignore this flag in our diagnostic
4875 #ifdef SIGNIFICANT_SIGNAL_MASK
4876   #undef SIGNIFICANT_SIGNAL_MASK
4877 #endif
4878 #define SIGNIFICANT_SIGNAL_MASK (~0x04000000)
4879 
4880 static const char* get_signal_handler_name(address handler,
4881                                            char* buf, int buflen) {
4882   int offset = 0;
4883   bool found = os::dll_address_to_library_name(handler, buf, buflen, &amp;offset);
4884   if (found) {
4885     // skip directory names
4886     const char *p1, *p2;
4887     p1 = buf;
4888     size_t len = strlen(os::file_separator());
4889     while ((p2 = strstr(p1, os::file_separator())) != NULL) p1 = p2 + len;
4890     jio_snprintf(buf, buflen, &quot;%s+0x%x&quot;, p1, offset);
4891   } else {
4892     jio_snprintf(buf, buflen, PTR_FORMAT, handler);
4893   }
4894   return buf;
4895 }
4896 
4897 static void print_signal_handler(outputStream* st, int sig,
4898                                  char* buf, size_t buflen) {
4899   struct sigaction sa;
4900 
4901   sigaction(sig, NULL, &amp;sa);
4902 
4903   // See comment for SIGNIFICANT_SIGNAL_MASK define
4904   sa.sa_flags &amp;= SIGNIFICANT_SIGNAL_MASK;
4905 
4906   st-&gt;print(&quot;%s: &quot;, os::exception_name(sig, buf, buflen));
4907 
4908   address handler = (sa.sa_flags &amp; SA_SIGINFO)
4909     ? CAST_FROM_FN_PTR(address, sa.sa_sigaction)
4910     : CAST_FROM_FN_PTR(address, sa.sa_handler);
4911 
4912   if (handler == CAST_FROM_FN_PTR(address, SIG_DFL)) {
4913     st-&gt;print(&quot;SIG_DFL&quot;);
4914   } else if (handler == CAST_FROM_FN_PTR(address, SIG_IGN)) {
4915     st-&gt;print(&quot;SIG_IGN&quot;);
4916   } else {
4917     st-&gt;print(&quot;[%s]&quot;, get_signal_handler_name(handler, buf, buflen));
4918   }
4919 
4920   st-&gt;print(&quot;, sa_mask[0]=&quot;);
4921   os::Posix::print_signal_set_short(st, &amp;sa.sa_mask);
4922 
4923   address rh = VMError::get_resetted_sighandler(sig);
4924   // May be, handler was resetted by VMError?
4925   if (rh != NULL) {
4926     handler = rh;
4927     sa.sa_flags = VMError::get_resetted_sigflags(sig) &amp; SIGNIFICANT_SIGNAL_MASK;
4928   }
4929 
4930   st-&gt;print(&quot;, sa_flags=&quot;);
4931   os::Posix::print_sa_flags(st, sa.sa_flags);
4932 
4933   // Check: is it our handler?
4934   if (handler == CAST_FROM_FN_PTR(address, (sa_sigaction_t)signalHandler) ||
4935       handler == CAST_FROM_FN_PTR(address, (sa_sigaction_t)SR_handler)) {
4936     // It is our signal handler
4937     // check for flags, reset system-used one!
4938     if ((int)sa.sa_flags != os::Linux::get_our_sigflags(sig)) {
4939       st-&gt;print(
4940                 &quot;, flags was changed from &quot; PTR32_FORMAT &quot;, consider using jsig library&quot;,
4941                 os::Linux::get_our_sigflags(sig));
4942     }
4943   }
4944   st-&gt;cr();
4945 }
4946 
4947 
4948 #define DO_SIGNAL_CHECK(sig)                      \
4949   do {                                            \
4950     if (!sigismember(&amp;check_signal_done, sig)) {  \
4951       os::Linux::check_signal_handler(sig);       \
4952     }                                             \
4953   } while (0)
4954 
4955 // This method is a periodic task to check for misbehaving JNI applications
4956 // under CheckJNI, we can add any periodic checks here
4957 
4958 void os::run_periodic_checks() {
4959   if (check_signals == false) return;
4960 
4961   // SEGV and BUS if overridden could potentially prevent
4962   // generation of hs*.log in the event of a crash, debugging
4963   // such a case can be very challenging, so we absolutely
4964   // check the following for a good measure:
4965   DO_SIGNAL_CHECK(SIGSEGV);
4966   DO_SIGNAL_CHECK(SIGILL);
4967   DO_SIGNAL_CHECK(SIGFPE);
4968   DO_SIGNAL_CHECK(SIGBUS);
4969   DO_SIGNAL_CHECK(SIGPIPE);
4970   DO_SIGNAL_CHECK(SIGXFSZ);
4971 #if defined(PPC64)
4972   DO_SIGNAL_CHECK(SIGTRAP);
4973 #endif
4974 
4975   // ReduceSignalUsage allows the user to override these handlers
4976   // see comments at the very top and jvm_md.h
4977   if (!ReduceSignalUsage) {
4978     DO_SIGNAL_CHECK(SHUTDOWN1_SIGNAL);
4979     DO_SIGNAL_CHECK(SHUTDOWN2_SIGNAL);
4980     DO_SIGNAL_CHECK(SHUTDOWN3_SIGNAL);
4981     DO_SIGNAL_CHECK(BREAK_SIGNAL);
4982   }
4983 
4984   DO_SIGNAL_CHECK(SR_signum);
4985 }
4986 
4987 typedef int (*os_sigaction_t)(int, const struct sigaction *, struct sigaction *);
4988 
4989 static os_sigaction_t os_sigaction = NULL;
4990 
4991 void os::Linux::check_signal_handler(int sig) {
4992   char buf[O_BUFLEN];
4993   address jvmHandler = NULL;
4994 
4995 
4996   struct sigaction act;
4997   if (os_sigaction == NULL) {
4998     // only trust the default sigaction, in case it has been interposed
4999     os_sigaction = (os_sigaction_t)dlsym(RTLD_DEFAULT, &quot;sigaction&quot;);
5000     if (os_sigaction == NULL) return;
5001   }
5002 
5003   os_sigaction(sig, (struct sigaction*)NULL, &amp;act);
5004 
5005 
5006   act.sa_flags &amp;= SIGNIFICANT_SIGNAL_MASK;
5007 
5008   address thisHandler = (act.sa_flags &amp; SA_SIGINFO)
5009     ? CAST_FROM_FN_PTR(address, act.sa_sigaction)
5010     : CAST_FROM_FN_PTR(address, act.sa_handler);
5011 
5012 
5013   switch (sig) {
5014   case SIGSEGV:
5015   case SIGBUS:
5016   case SIGFPE:
5017   case SIGPIPE:
5018   case SIGILL:
5019   case SIGXFSZ:
5020     jvmHandler = CAST_FROM_FN_PTR(address, (sa_sigaction_t)signalHandler);
5021     break;
5022 
5023   case SHUTDOWN1_SIGNAL:
5024   case SHUTDOWN2_SIGNAL:
5025   case SHUTDOWN3_SIGNAL:
5026   case BREAK_SIGNAL:
5027     jvmHandler = (address)user_handler();
5028     break;
5029 
5030   default:
5031     if (sig == SR_signum) {
5032       jvmHandler = CAST_FROM_FN_PTR(address, (sa_sigaction_t)SR_handler);
5033     } else {
5034       return;
5035     }
5036     break;
5037   }
5038 
5039   if (thisHandler != jvmHandler) {
5040     tty-&gt;print(&quot;Warning: %s handler &quot;, exception_name(sig, buf, O_BUFLEN));
5041     tty-&gt;print(&quot;expected:%s&quot;, get_signal_handler_name(jvmHandler, buf, O_BUFLEN));
5042     tty-&gt;print_cr(&quot;  found:%s&quot;, get_signal_handler_name(thisHandler, buf, O_BUFLEN));
5043     // No need to check this sig any longer
5044     sigaddset(&amp;check_signal_done, sig);
5045     // Running under non-interactive shell, SHUTDOWN2_SIGNAL will be reassigned SIG_IGN
5046     if (sig == SHUTDOWN2_SIGNAL &amp;&amp; !isatty(fileno(stdin))) {
5047       tty-&gt;print_cr(&quot;Running in non-interactive shell, %s handler is replaced by shell&quot;,
5048                     exception_name(sig, buf, O_BUFLEN));
5049     }
5050   } else if(os::Linux::get_our_sigflags(sig) != 0 &amp;&amp; (int)act.sa_flags != os::Linux::get_our_sigflags(sig)) {
5051     tty-&gt;print(&quot;Warning: %s handler flags &quot;, exception_name(sig, buf, O_BUFLEN));
5052     tty-&gt;print(&quot;expected:&quot;);
5053     os::Posix::print_sa_flags(tty, os::Linux::get_our_sigflags(sig));
5054     tty-&gt;cr();
5055     tty-&gt;print(&quot;  found:&quot;);
5056     os::Posix::print_sa_flags(tty, act.sa_flags);
5057     tty-&gt;cr();
5058     // No need to check this sig any longer
5059     sigaddset(&amp;check_signal_done, sig);
5060   }
5061 
5062   // Dump all the signal
5063   if (sigismember(&amp;check_signal_done, sig)) {
5064     print_signal_handlers(tty, buf, O_BUFLEN);
5065   }
5066 }
5067 
5068 extern void report_error(char* file_name, int line_no, char* title,
5069                          char* format, ...);
5070 
<a name="8" id="anc8"></a><span class="line-added">5071 // Some linux distributions (notably: Alpine Linux) include the</span>
<span class="line-added">5072 // grsecurity in the kernel by default. Of particular interest from a</span>
<span class="line-added">5073 // JVM perspective is PaX (https://pax.grsecurity.net/), which adds</span>
<span class="line-added">5074 // some security features related to page attributes. Specifically,</span>
<span class="line-added">5075 // the MPROTECT PaX functionality</span>
<span class="line-added">5076 // (https://pax.grsecurity.net/docs/mprotect.txt) prevents dynamic</span>
<span class="line-added">5077 // code generation by disallowing a (previously) writable page to be</span>
<span class="line-added">5078 // marked as executable. This is, of course, exactly what HotSpot does</span>
<span class="line-added">5079 // for both JIT compiled method, as well as for stubs, adapters, etc.</span>
<span class="line-added">5080 //</span>
<span class="line-added">5081 // Instead of crashing &quot;lazily&quot; when trying to make a page executable,</span>
<span class="line-added">5082 // this code probes for the presence of PaX and reports the failure</span>
<span class="line-added">5083 // eagerly.</span>
<span class="line-added">5084 static void check_pax(void) {</span>
<span class="line-added">5085   // Zero doesn&#39;t generate code dynamically, so no need to perform the PaX check</span>
<span class="line-added">5086 #ifndef ZERO</span>
<span class="line-added">5087   size_t size = os::Linux::page_size();</span>
<span class="line-added">5088 </span>
<span class="line-added">5089   void* p = ::mmap(NULL, size, PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0);</span>
<span class="line-added">5090   if (p == MAP_FAILED) {</span>
<span class="line-added">5091     vm_exit_out_of_memory(size, OOM_MMAP_ERROR, &quot;failed to allocate memory for PaX check.&quot;);</span>
<span class="line-added">5092   }</span>
<span class="line-added">5093 </span>
<span class="line-added">5094   int res = ::mprotect(p, size, PROT_WRITE|PROT_EXEC);</span>
<span class="line-added">5095   if (res == -1) {</span>
<span class="line-added">5096     vm_exit_during_initialization(&quot;Failed to mark memory page as executable&quot;,</span>
<span class="line-added">5097                                   &quot;Please check if grsecurity/PaX is enabled in your kernel.\n&quot;</span>
<span class="line-added">5098                                   &quot;\n&quot;</span>
<span class="line-added">5099                                   &quot;For example, you can do this by running (note: you may need root privileges):\n&quot;</span>
<span class="line-added">5100                                   &quot;\n&quot;</span>
<span class="line-added">5101                                   &quot;    sysctl kernel.pax.softmode\n&quot;</span>
<span class="line-added">5102                                   &quot;\n&quot;</span>
<span class="line-added">5103                                   &quot;If PaX is included in the kernel you will see something like this:\n&quot;</span>
<span class="line-added">5104                                   &quot;\n&quot;</span>
<span class="line-added">5105                                   &quot;    kernel.pax.softmode = 0\n&quot;</span>
<span class="line-added">5106                                   &quot;\n&quot;</span>
<span class="line-added">5107                                   &quot;In particular, if the value is 0 (zero), then PaX is enabled.\n&quot;</span>
<span class="line-added">5108                                   &quot;\n&quot;</span>
<span class="line-added">5109                                   &quot;PaX includes security functionality which interferes with the dynamic code\n&quot;</span>
<span class="line-added">5110                                   &quot;generation the JVM relies on. Specifically, the MPROTECT functionality as\n&quot;</span>
<span class="line-added">5111                                   &quot;described on https://pax.grsecurity.net/docs/mprotect.txt is not compatible\n&quot;</span>
<span class="line-added">5112                                   &quot;with the JVM. If you want to allow the JVM to run you will have to disable PaX.\n&quot;</span>
<span class="line-added">5113                                   &quot;You can do this on a per-executable basis using the paxctl tool, for example:\n&quot;</span>
<span class="line-added">5114                                   &quot;\n&quot;</span>
<span class="line-added">5115                                   &quot;    paxctl -cm bin/java\n&quot;</span>
<span class="line-added">5116                                   &quot;\n&quot;</span>
<span class="line-added">5117                                   &quot;Please note that this modifies the executable binary in-place, so you may want\n&quot;</span>
<span class="line-added">5118                                   &quot;to make a backup of it first. Also note that you have to repeat this for other\n&quot;</span>
<span class="line-added">5119                                   &quot;executables like javac, jar, jcmd, etc.\n&quot;</span>
<span class="line-added">5120                                   );</span>
<span class="line-added">5121 </span>
<span class="line-added">5122   }</span>
<span class="line-added">5123 </span>
<span class="line-added">5124   ::munmap(p, size);</span>
<span class="line-added">5125 #endif</span>
<span class="line-added">5126 }</span>
<span class="line-added">5127 </span>
5128 // this is called _before_ most of the global arguments have been parsed
5129 void os::init(void) {
5130   char dummy;   // used to get a guess on initial stack address
5131 
5132   clock_tics_per_sec = sysconf(_SC_CLK_TCK);
5133 
5134   init_random(1234567);
5135 
5136   Linux::set_page_size(sysconf(_SC_PAGESIZE));
5137   if (Linux::page_size() == -1) {
5138     fatal(&quot;os_linux.cpp: os::init: sysconf failed (%s)&quot;,
5139           os::strerror(errno));
5140   }
5141   init_page_sizes((size_t) Linux::page_size());
5142 
5143   Linux::initialize_system_info();
5144 
5145   os::Linux::CPUPerfTicks pticks;
5146   bool res = os::Linux::get_tick_information(&amp;pticks, -1);
5147 
5148   if (res &amp;&amp; pticks.has_steal_ticks) {
5149     has_initial_tick_info = true;
5150     initial_total_ticks = pticks.total;
5151     initial_steal_ticks = pticks.steal;
5152   }
5153 
5154   // _main_thread points to the thread that created/loaded the JVM.
5155   Linux::_main_thread = pthread_self();
5156 
5157   // retrieve entry point for pthread_setname_np
5158   Linux::_pthread_setname_np =
5159     (int(*)(pthread_t, const char*))dlsym(RTLD_DEFAULT, &quot;pthread_setname_np&quot;);
5160 
<a name="9" id="anc9"></a><span class="line-added">5161   check_pax();</span>
<span class="line-added">5162 </span>
5163   os::Posix::init();
5164 
5165   initial_time_count = javaTimeNanos();
5166 
5167   // Always warn if no monotonic clock available
5168   if (!os::Posix::supports_monotonic_clock()) {
5169     warning(&quot;No monotonic clock was available - timed services may &quot;    \
5170             &quot;be adversely affected if the time-of-day clock changes&quot;);
5171   }
5172 }
5173 
5174 // To install functions for atexit system call
5175 extern &quot;C&quot; {
5176   static void perfMemory_exit_helper() {
5177     perfMemory_exit();
5178   }
5179 }
5180 
5181 void os::pd_init_container_support() {
5182   OSContainer::init();
5183 }
5184 
5185 void os::Linux::numa_init() {
5186 
5187   // Java can be invoked as
5188   // 1. Without numactl and heap will be allocated/configured on all nodes as
5189   //    per the system policy.
5190   // 2. With numactl --interleave:
5191   //      Use numa_get_interleave_mask(v2) API to get nodes bitmask. The same
5192   //      API for membind case bitmask is reset.
5193   //      Interleave is only hint and Kernel can fallback to other nodes if
5194   //      no memory is available on the target nodes.
5195   // 3. With numactl --membind:
5196   //      Use numa_get_membind(v2) API to get nodes bitmask. The same API for
5197   //      interleave case returns bitmask of all nodes.
5198   // numa_all_nodes_ptr holds bitmask of all nodes.
5199   // numa_get_interleave_mask(v2) and numa_get_membind(v2) APIs returns correct
5200   // bitmask when externally configured to run on all or fewer nodes.
5201 
5202   if (!Linux::libnuma_init()) {
5203     UseNUMA = false;
5204   } else {
5205     if ((Linux::numa_max_node() &lt; 1) || Linux::is_bound_to_single_node()) {
5206       // If there&#39;s only one node (they start from 0) or if the process
5207       // is bound explicitly to a single node using membind, disable NUMA unless
5208       // user explicilty forces NUMA optimizations on single-node/UMA systems
5209       UseNUMA = ForceNUMA;
5210     } else {
5211 
5212       LogTarget(Info,os) log;
5213       LogStream ls(log);
5214 
5215       Linux::set_configured_numa_policy(Linux::identify_numa_policy());
5216 
5217       struct bitmask* bmp = Linux::_numa_membind_bitmask;
5218       const char* numa_mode = &quot;membind&quot;;
5219 
5220       if (Linux::is_running_in_interleave_mode()) {
5221         bmp = Linux::_numa_interleave_bitmask;
5222         numa_mode = &quot;interleave&quot;;
5223       }
5224 
5225       ls.print(&quot;UseNUMA is enabled and invoked in &#39;%s&#39; mode.&quot;
5226                &quot; Heap will be configured using NUMA memory nodes:&quot;, numa_mode);
5227 
5228       for (int node = 0; node &lt;= Linux::numa_max_node(); node++) {
5229         if (Linux::_numa_bitmask_isbitset(bmp, node)) {
5230           ls.print(&quot; %d&quot;, node);
5231         }
5232       }
5233     }
5234   }
5235 
5236   if (UseParallelGC &amp;&amp; UseNUMA &amp;&amp; UseLargePages &amp;&amp; !can_commit_large_page_memory()) {
5237     // With SHM and HugeTLBFS large pages we cannot uncommit a page, so there&#39;s no way
5238     // we can make the adaptive lgrp chunk resizing work. If the user specified both
5239     // UseNUMA and UseLargePages (or UseSHM/UseHugeTLBFS) on the command line - warn
5240     // and disable adaptive resizing.
5241     if (UseAdaptiveSizePolicy || UseAdaptiveNUMAChunkSizing) {
5242       warning(&quot;UseNUMA is not fully compatible with SHM/HugeTLBFS large pages, &quot;
5243               &quot;disabling adaptive resizing (-XX:-UseAdaptiveSizePolicy -XX:-UseAdaptiveNUMAChunkSizing)&quot;);
5244       UseAdaptiveSizePolicy = false;
5245       UseAdaptiveNUMAChunkSizing = false;
5246     }
5247   }
5248 }
5249 
5250 // this is called _after_ the global arguments have been parsed
5251 jint os::init_2(void) {
5252 
5253   // This could be set after os::Posix::init() but all platforms
5254   // have to set it the same so we have to mirror Solaris.
5255   DEBUG_ONLY(os::set_mutex_init_done();)
5256 
5257   os::Posix::init_2();
5258 
5259   Linux::fast_thread_clock_init();
5260 
5261   // initialize suspend/resume support - must do this before signal_sets_init()
5262   if (SR_initialize() != 0) {
5263     perror(&quot;SR_initialize failed&quot;);
5264     return JNI_ERR;
5265   }
5266 
5267   Linux::signal_sets_init();
5268   Linux::install_signal_handlers();
5269   // Initialize data for jdk.internal.misc.Signal
5270   if (!ReduceSignalUsage) {
5271     jdk_misc_signal_init();
5272   }
5273 
5274   if (AdjustStackSizeForTLS) {
5275     get_minstack_init();
5276   }
5277 
5278   // Check and sets minimum stack sizes against command line options
5279   if (Posix::set_minimum_stack_sizes() == JNI_ERR) {
5280     return JNI_ERR;
5281   }
5282 
5283 #if defined(IA32)
5284   // Need to ensure we&#39;ve determined the process&#39;s initial stack to
5285   // perform the workaround
5286   Linux::capture_initial_stack(JavaThread::stack_size_at_create());
5287   workaround_expand_exec_shield_cs_limit();
5288 #else
5289   suppress_primordial_thread_resolution = Arguments::created_by_java_launcher();
5290   if (!suppress_primordial_thread_resolution) {
5291     Linux::capture_initial_stack(JavaThread::stack_size_at_create());
5292   }
5293 #endif
5294 
5295   Linux::libpthread_init();
5296   Linux::sched_getcpu_init();
5297   log_info(os)(&quot;HotSpot is running with %s, %s&quot;,
5298                Linux::glibc_version(), Linux::libpthread_version());
5299 
5300   if (UseNUMA) {
5301     Linux::numa_init();
5302   }
5303 
5304   if (MaxFDLimit) {
5305     // set the number of file descriptors to max. print out error
5306     // if getrlimit/setrlimit fails but continue regardless.
5307     struct rlimit nbr_files;
5308     int status = getrlimit(RLIMIT_NOFILE, &amp;nbr_files);
5309     if (status != 0) {
5310       log_info(os)(&quot;os::init_2 getrlimit failed: %s&quot;, os::strerror(errno));
5311     } else {
5312       nbr_files.rlim_cur = nbr_files.rlim_max;
5313       status = setrlimit(RLIMIT_NOFILE, &amp;nbr_files);
5314       if (status != 0) {
5315         log_info(os)(&quot;os::init_2 setrlimit failed: %s&quot;, os::strerror(errno));
5316       }
5317     }
5318   }
5319 
5320   // at-exit methods are called in the reverse order of their registration.
5321   // atexit functions are called on return from main or as a result of a
5322   // call to exit(3C). There can be only 32 of these functions registered
5323   // and atexit() does not set errno.
5324 
5325   if (PerfAllowAtExitRegistration) {
5326     // only register atexit functions if PerfAllowAtExitRegistration is set.
5327     // atexit functions can be delayed until process exit time, which
5328     // can be problematic for embedded VM situations. Embedded VMs should
5329     // call DestroyJavaVM() to assure that VM resources are released.
5330 
5331     // note: perfMemory_exit_helper atexit function may be removed in
5332     // the future if the appropriate cleanup code can be added to the
5333     // VM_Exit VMOperation&#39;s doit method.
5334     if (atexit(perfMemory_exit_helper) != 0) {
5335       warning(&quot;os::init_2 atexit(perfMemory_exit_helper) failed&quot;);
5336     }
5337   }
5338 
5339   // initialize thread priority policy
5340   prio_init();
5341 
5342   if (!FLAG_IS_DEFAULT(AllocateHeapAt) || !FLAG_IS_DEFAULT(AllocateOldGenAt)) {
5343     set_coredump_filter(DAX_SHARED_BIT);
5344   }
5345 
5346   if (DumpPrivateMappingsInCore) {
5347     set_coredump_filter(FILE_BACKED_PVT_BIT);
5348   }
5349 
5350   if (DumpSharedMappingsInCore) {
5351     set_coredump_filter(FILE_BACKED_SHARED_BIT);
5352   }
5353 
5354   return JNI_OK;
5355 }
5356 
5357 // Mark the polling page as unreadable
5358 void os::make_polling_page_unreadable(void) {
5359   if (!guard_memory((char*)_polling_page, Linux::page_size())) {
5360     fatal(&quot;Could not disable polling page&quot;);
5361   }
5362 }
5363 
5364 // Mark the polling page as readable
5365 void os::make_polling_page_readable(void) {
5366   if (!linux_mprotect((char *)_polling_page, Linux::page_size(), PROT_READ)) {
5367     fatal(&quot;Could not enable polling page&quot;);
5368   }
5369 }
5370 
5371 // older glibc versions don&#39;t have this macro (which expands to
5372 // an optimized bit-counting function) so we have to roll our own
5373 #ifndef CPU_COUNT
5374 
5375 static int _cpu_count(const cpu_set_t* cpus) {
5376   int count = 0;
5377   // only look up to the number of configured processors
5378   for (int i = 0; i &lt; os::processor_count(); i++) {
5379     if (CPU_ISSET(i, cpus)) {
5380       count++;
5381     }
5382   }
5383   return count;
5384 }
5385 
5386 #define CPU_COUNT(cpus) _cpu_count(cpus)
5387 
5388 #endif // CPU_COUNT
5389 
5390 // Get the current number of available processors for this process.
5391 // This value can change at any time during a process&#39;s lifetime.
5392 // sched_getaffinity gives an accurate answer as it accounts for cpusets.
5393 // If it appears there may be more than 1024 processors then we do a
5394 // dynamic check - see 6515172 for details.
5395 // If anything goes wrong we fallback to returning the number of online
5396 // processors - which can be greater than the number available to the process.
5397 int os::Linux::active_processor_count() {
5398   cpu_set_t cpus;  // can represent at most 1024 (CPU_SETSIZE) processors
5399   cpu_set_t* cpus_p = &amp;cpus;
5400   int cpus_size = sizeof(cpu_set_t);
5401 
5402   int configured_cpus = os::processor_count();  // upper bound on available cpus
5403   int cpu_count = 0;
5404 
5405 // old build platforms may not support dynamic cpu sets
5406 #ifdef CPU_ALLOC
5407 
5408   // To enable easy testing of the dynamic path on different platforms we
5409   // introduce a diagnostic flag: UseCpuAllocPath
5410   if (configured_cpus &gt;= CPU_SETSIZE || UseCpuAllocPath) {
5411     // kernel may use a mask bigger than cpu_set_t
5412     log_trace(os)(&quot;active_processor_count: using dynamic path %s&quot;
5413                   &quot;- configured processors: %d&quot;,
5414                   UseCpuAllocPath ? &quot;(forced) &quot; : &quot;&quot;,
5415                   configured_cpus);
5416     cpus_p = CPU_ALLOC(configured_cpus);
5417     if (cpus_p != NULL) {
5418       cpus_size = CPU_ALLOC_SIZE(configured_cpus);
5419       // zero it just to be safe
5420       CPU_ZERO_S(cpus_size, cpus_p);
5421     }
5422     else {
5423        // failed to allocate so fallback to online cpus
5424        int online_cpus = ::sysconf(_SC_NPROCESSORS_ONLN);
5425        log_trace(os)(&quot;active_processor_count: &quot;
5426                      &quot;CPU_ALLOC failed (%s) - using &quot;
5427                      &quot;online processor count: %d&quot;,
5428                      os::strerror(errno), online_cpus);
5429        return online_cpus;
5430     }
5431   }
5432   else {
5433     log_trace(os)(&quot;active_processor_count: using static path - configured processors: %d&quot;,
5434                   configured_cpus);
5435   }
5436 #else // CPU_ALLOC
5437 // these stubs won&#39;t be executed
5438 #define CPU_COUNT_S(size, cpus) -1
5439 #define CPU_FREE(cpus)
5440 
5441   log_trace(os)(&quot;active_processor_count: only static path available - configured processors: %d&quot;,
5442                 configured_cpus);
5443 #endif // CPU_ALLOC
5444 
5445   // pid 0 means the current thread - which we have to assume represents the process
5446   if (sched_getaffinity(0, cpus_size, cpus_p) == 0) {
5447     if (cpus_p != &amp;cpus) { // can only be true when CPU_ALLOC used
5448       cpu_count = CPU_COUNT_S(cpus_size, cpus_p);
5449     }
5450     else {
5451       cpu_count = CPU_COUNT(cpus_p);
5452     }
5453     log_trace(os)(&quot;active_processor_count: sched_getaffinity processor count: %d&quot;, cpu_count);
5454   }
5455   else {
5456     cpu_count = ::sysconf(_SC_NPROCESSORS_ONLN);
5457     warning(&quot;sched_getaffinity failed (%s)- using online processor count (%d) &quot;
5458             &quot;which may exceed available processors&quot;, os::strerror(errno), cpu_count);
5459   }
5460 
5461   if (cpus_p != &amp;cpus) { // can only be true when CPU_ALLOC used
5462     CPU_FREE(cpus_p);
5463   }
5464 
5465   assert(cpu_count &gt; 0 &amp;&amp; cpu_count &lt;= os::processor_count(), &quot;sanity check&quot;);
5466   return cpu_count;
5467 }
5468 
5469 // Determine the active processor count from one of
5470 // three different sources:
5471 //
5472 // 1. User option -XX:ActiveProcessorCount
5473 // 2. kernel os calls (sched_getaffinity or sysconf(_SC_NPROCESSORS_ONLN)
5474 // 3. extracted from cgroup cpu subsystem (shares and quotas)
5475 //
5476 // Option 1, if specified, will always override.
5477 // If the cgroup subsystem is active and configured, we
5478 // will return the min of the cgroup and option 2 results.
5479 // This is required since tools, such as numactl, that
5480 // alter cpu affinity do not update cgroup subsystem
5481 // cpuset configuration files.
5482 int os::active_processor_count() {
5483   // User has overridden the number of active processors
5484   if (ActiveProcessorCount &gt; 0) {
5485     log_trace(os)(&quot;active_processor_count: &quot;
5486                   &quot;active processor count set by user : %d&quot;,
5487                   ActiveProcessorCount);
5488     return ActiveProcessorCount;
5489   }
5490 
5491   int active_cpus;
5492   if (OSContainer::is_containerized()) {
5493     active_cpus = OSContainer::active_processor_count();
5494     log_trace(os)(&quot;active_processor_count: determined by OSContainer: %d&quot;,
5495                    active_cpus);
5496   } else {
5497     active_cpus = os::Linux::active_processor_count();
5498   }
5499 
5500   return active_cpus;
5501 }
5502 
5503 uint os::processor_id() {
5504   const int id = Linux::sched_getcpu();
5505   assert(id &gt;= 0 &amp;&amp; id &lt; _processor_count, &quot;Invalid processor id&quot;);
5506   return (uint)id;
5507 }
5508 
5509 void os::set_native_thread_name(const char *name) {
5510   if (Linux::_pthread_setname_np) {
5511     char buf [16]; // according to glibc manpage, 16 chars incl. &#39;/0&#39;
5512     snprintf(buf, sizeof(buf), &quot;%s&quot;, name);
5513     buf[sizeof(buf) - 1] = &#39;\0&#39;;
5514     const int rc = Linux::_pthread_setname_np(pthread_self(), buf);
5515     // ERANGE should not happen; all other errors should just be ignored.
5516     assert(rc != ERANGE, &quot;pthread_setname_np failed&quot;);
5517   }
5518 }
5519 
5520 bool os::bind_to_processor(uint processor_id) {
5521   // Not yet implemented.
5522   return false;
5523 }
5524 
5525 ///
5526 
5527 void os::SuspendedThreadTask::internal_do_task() {
5528   if (do_suspend(_thread-&gt;osthread())) {
5529     SuspendedThreadTaskContext context(_thread, _thread-&gt;osthread()-&gt;ucontext());
5530     do_task(context);
5531     do_resume(_thread-&gt;osthread());
5532   }
5533 }
5534 
5535 ////////////////////////////////////////////////////////////////////////////////
5536 // debug support
5537 
5538 bool os::find(address addr, outputStream* st) {
5539   Dl_info dlinfo;
5540   memset(&amp;dlinfo, 0, sizeof(dlinfo));
5541   if (dladdr(addr, &amp;dlinfo) != 0) {
5542     st-&gt;print(PTR_FORMAT &quot;: &quot;, p2i(addr));
5543     if (dlinfo.dli_sname != NULL &amp;&amp; dlinfo.dli_saddr != NULL) {
5544       st-&gt;print(&quot;%s+&quot; PTR_FORMAT, dlinfo.dli_sname,
5545                 p2i(addr) - p2i(dlinfo.dli_saddr));
5546     } else if (dlinfo.dli_fbase != NULL) {
5547       st-&gt;print(&quot;&lt;offset &quot; PTR_FORMAT &quot;&gt;&quot;, p2i(addr) - p2i(dlinfo.dli_fbase));
5548     } else {
5549       st-&gt;print(&quot;&lt;absolute address&gt;&quot;);
5550     }
5551     if (dlinfo.dli_fname != NULL) {
5552       st-&gt;print(&quot; in %s&quot;, dlinfo.dli_fname);
5553     }
5554     if (dlinfo.dli_fbase != NULL) {
5555       st-&gt;print(&quot; at &quot; PTR_FORMAT, p2i(dlinfo.dli_fbase));
5556     }
5557     st-&gt;cr();
5558 
5559     if (Verbose) {
5560       // decode some bytes around the PC
5561       address begin = clamp_address_in_page(addr-40, addr, os::vm_page_size());
5562       address end   = clamp_address_in_page(addr+40, addr, os::vm_page_size());
5563       address       lowest = (address) dlinfo.dli_sname;
5564       if (!lowest)  lowest = (address) dlinfo.dli_fbase;
5565       if (begin &lt; lowest)  begin = lowest;
5566       Dl_info dlinfo2;
5567       if (dladdr(end, &amp;dlinfo2) != 0 &amp;&amp; dlinfo2.dli_saddr != dlinfo.dli_saddr
5568           &amp;&amp; end &gt; dlinfo2.dli_saddr &amp;&amp; dlinfo2.dli_saddr &gt; begin) {
5569         end = (address) dlinfo2.dli_saddr;
5570       }
5571       Disassembler::decode(begin, end, st);
5572     }
5573     return true;
5574   }
5575   return false;
5576 }
5577 
5578 ////////////////////////////////////////////////////////////////////////////////
5579 // misc
5580 
5581 // This does not do anything on Linux. This is basically a hook for being
5582 // able to use structured exception handling (thread-local exception filters)
5583 // on, e.g., Win32.
5584 void
5585 os::os_exception_wrapper(java_call_t f, JavaValue* value, const methodHandle&amp; method,
5586                          JavaCallArguments* args, Thread* thread) {
5587   f(value, method, args, thread);
5588 }
5589 
5590 void os::print_statistics() {
5591 }
5592 
5593 bool os::message_box(const char* title, const char* message) {
5594   int i;
5595   fdStream err(defaultStream::error_fd());
5596   for (i = 0; i &lt; 78; i++) err.print_raw(&quot;=&quot;);
5597   err.cr();
5598   err.print_raw_cr(title);
5599   for (i = 0; i &lt; 78; i++) err.print_raw(&quot;-&quot;);
5600   err.cr();
5601   err.print_raw_cr(message);
5602   for (i = 0; i &lt; 78; i++) err.print_raw(&quot;=&quot;);
5603   err.cr();
5604 
5605   char buf[16];
5606   // Prevent process from exiting upon &quot;read error&quot; without consuming all CPU
5607   while (::read(0, buf, sizeof(buf)) &lt;= 0) { ::sleep(100); }
5608 
5609   return buf[0] == &#39;y&#39; || buf[0] == &#39;Y&#39;;
5610 }
5611 
5612 // Is a (classpath) directory empty?
5613 bool os::dir_is_empty(const char* path) {
5614   DIR *dir = NULL;
5615   struct dirent *ptr;
5616 
5617   dir = opendir(path);
5618   if (dir == NULL) return true;
5619 
5620   // Scan the directory
5621   bool result = true;
5622   while (result &amp;&amp; (ptr = readdir(dir)) != NULL) {
5623     if (strcmp(ptr-&gt;d_name, &quot;.&quot;) != 0 &amp;&amp; strcmp(ptr-&gt;d_name, &quot;..&quot;) != 0) {
5624       result = false;
5625     }
5626   }
5627   closedir(dir);
5628   return result;
5629 }
5630 
5631 // This code originates from JDK&#39;s sysOpen and open64_w
5632 // from src/solaris/hpi/src/system_md.c
5633 
5634 int os::open(const char *path, int oflag, int mode) {
5635   if (strlen(path) &gt; MAX_PATH - 1) {
5636     errno = ENAMETOOLONG;
5637     return -1;
5638   }
5639 
5640   // All file descriptors that are opened in the Java process and not
5641   // specifically destined for a subprocess should have the close-on-exec
5642   // flag set.  If we don&#39;t set it, then careless 3rd party native code
5643   // might fork and exec without closing all appropriate file descriptors
5644   // (e.g. as we do in closeDescriptors in UNIXProcess.c), and this in
5645   // turn might:
5646   //
5647   // - cause end-of-file to fail to be detected on some file
5648   //   descriptors, resulting in mysterious hangs, or
5649   //
5650   // - might cause an fopen in the subprocess to fail on a system
5651   //   suffering from bug 1085341.
5652   //
5653   // (Yes, the default setting of the close-on-exec flag is a Unix
5654   // design flaw)
5655   //
5656   // See:
5657   // 1085341: 32-bit stdio routines should support file descriptors &gt;255
5658   // 4843136: (process) pipe file descriptor from Runtime.exec not being closed
5659   // 6339493: (process) Runtime.exec does not close all file descriptors on Solaris 9
5660   //
5661   // Modern Linux kernels (after 2.6.23 2007) support O_CLOEXEC with open().
5662   // O_CLOEXEC is preferable to using FD_CLOEXEC on an open file descriptor
5663   // because it saves a system call and removes a small window where the flag
5664   // is unset.  On ancient Linux kernels the O_CLOEXEC flag will be ignored
5665   // and we fall back to using FD_CLOEXEC (see below).
5666 #ifdef O_CLOEXEC
5667   oflag |= O_CLOEXEC;
5668 #endif
5669 
5670   int fd = ::open64(path, oflag, mode);
5671   if (fd == -1) return -1;
5672 
5673   //If the open succeeded, the file might still be a directory
5674   {
5675     struct stat64 buf64;
5676     int ret = ::fstat64(fd, &amp;buf64);
5677     int st_mode = buf64.st_mode;
5678 
5679     if (ret != -1) {
5680       if ((st_mode &amp; S_IFMT) == S_IFDIR) {
5681         errno = EISDIR;
5682         ::close(fd);
5683         return -1;
5684       }
5685     } else {
5686       ::close(fd);
5687       return -1;
5688     }
5689   }
5690 
5691 #ifdef FD_CLOEXEC
5692   // Validate that the use of the O_CLOEXEC flag on open above worked.
5693   // With recent kernels, we will perform this check exactly once.
5694   static sig_atomic_t O_CLOEXEC_is_known_to_work = 0;
5695   if (!O_CLOEXEC_is_known_to_work) {
5696     int flags = ::fcntl(fd, F_GETFD);
5697     if (flags != -1) {
5698       if ((flags &amp; FD_CLOEXEC) != 0)
5699         O_CLOEXEC_is_known_to_work = 1;
5700       else
5701         ::fcntl(fd, F_SETFD, flags | FD_CLOEXEC);
5702     }
5703   }
5704 #endif
5705 
5706   return fd;
5707 }
5708 
5709 
5710 // create binary file, rewriting existing file if required
5711 int os::create_binary_file(const char* path, bool rewrite_existing) {
5712   int oflags = O_WRONLY | O_CREAT;
5713   if (!rewrite_existing) {
5714     oflags |= O_EXCL;
5715   }
5716   return ::open64(path, oflags, S_IREAD | S_IWRITE);
5717 }
5718 
5719 // return current position of file pointer
5720 jlong os::current_file_offset(int fd) {
5721   return (jlong)::lseek64(fd, (off64_t)0, SEEK_CUR);
5722 }
5723 
5724 // move file pointer to the specified offset
5725 jlong os::seek_to_file_offset(int fd, jlong offset) {
5726   return (jlong)::lseek64(fd, (off64_t)offset, SEEK_SET);
5727 }
5728 
5729 // This code originates from JDK&#39;s sysAvailable
5730 // from src/solaris/hpi/src/native_threads/src/sys_api_td.c
5731 
5732 int os::available(int fd, jlong *bytes) {
5733   jlong cur, end;
5734   int mode;
5735   struct stat64 buf64;
5736 
5737   if (::fstat64(fd, &amp;buf64) &gt;= 0) {
5738     mode = buf64.st_mode;
5739     if (S_ISCHR(mode) || S_ISFIFO(mode) || S_ISSOCK(mode)) {
5740       int n;
5741       if (::ioctl(fd, FIONREAD, &amp;n) &gt;= 0) {
5742         *bytes = n;
5743         return 1;
5744       }
5745     }
5746   }
5747   if ((cur = ::lseek64(fd, 0L, SEEK_CUR)) == -1) {
5748     return 0;
5749   } else if ((end = ::lseek64(fd, 0L, SEEK_END)) == -1) {
5750     return 0;
5751   } else if (::lseek64(fd, cur, SEEK_SET) == -1) {
5752     return 0;
5753   }
5754   *bytes = end - cur;
5755   return 1;
5756 }
5757 
5758 // Map a block of memory.
5759 char* os::pd_map_memory(int fd, const char* file_name, size_t file_offset,
5760                         char *addr, size_t bytes, bool read_only,
5761                         bool allow_exec) {
5762   int prot;
5763   int flags = MAP_PRIVATE;
5764 
5765   if (read_only) {
5766     prot = PROT_READ;
5767   } else {
5768     prot = PROT_READ | PROT_WRITE;
5769   }
5770 
5771   if (allow_exec) {
5772     prot |= PROT_EXEC;
5773   }
5774 
5775   if (addr != NULL) {
5776     flags |= MAP_FIXED;
5777   }
5778 
5779   char* mapped_address = (char*)mmap(addr, (size_t)bytes, prot, flags,
5780                                      fd, file_offset);
5781   if (mapped_address == MAP_FAILED) {
5782     return NULL;
5783   }
5784   return mapped_address;
5785 }
5786 
5787 
5788 // Remap a block of memory.
5789 char* os::pd_remap_memory(int fd, const char* file_name, size_t file_offset,
5790                           char *addr, size_t bytes, bool read_only,
5791                           bool allow_exec) {
5792   // same as map_memory() on this OS
5793   return os::map_memory(fd, file_name, file_offset, addr, bytes, read_only,
5794                         allow_exec);
5795 }
5796 
5797 
5798 // Unmap a block of memory.
5799 bool os::pd_unmap_memory(char* addr, size_t bytes) {
5800   return munmap(addr, bytes) == 0;
5801 }
5802 
5803 static jlong slow_thread_cpu_time(Thread *thread, bool user_sys_cpu_time);
5804 
5805 static jlong fast_cpu_time(Thread *thread) {
5806     clockid_t clockid;
5807     int rc = os::Linux::pthread_getcpuclockid(thread-&gt;osthread()-&gt;pthread_id(),
5808                                               &amp;clockid);
5809     if (rc == 0) {
5810       return os::Linux::fast_thread_cpu_time(clockid);
5811     } else {
5812       // It&#39;s possible to encounter a terminated native thread that failed
5813       // to detach itself from the VM - which should result in ESRCH.
5814       assert_status(rc == ESRCH, rc, &quot;pthread_getcpuclockid failed&quot;);
5815       return -1;
5816     }
5817 }
5818 
5819 // current_thread_cpu_time(bool) and thread_cpu_time(Thread*, bool)
5820 // are used by JVM M&amp;M and JVMTI to get user+sys or user CPU time
5821 // of a thread.
5822 //
5823 // current_thread_cpu_time() and thread_cpu_time(Thread*) returns
5824 // the fast estimate available on the platform.
5825 
5826 jlong os::current_thread_cpu_time() {
5827   if (os::Linux::supports_fast_thread_cpu_time()) {
5828     return os::Linux::fast_thread_cpu_time(CLOCK_THREAD_CPUTIME_ID);
5829   } else {
5830     // return user + sys since the cost is the same
5831     return slow_thread_cpu_time(Thread::current(), true /* user + sys */);
5832   }
5833 }
5834 
5835 jlong os::thread_cpu_time(Thread* thread) {
5836   // consistent with what current_thread_cpu_time() returns
5837   if (os::Linux::supports_fast_thread_cpu_time()) {
5838     return fast_cpu_time(thread);
5839   } else {
5840     return slow_thread_cpu_time(thread, true /* user + sys */);
5841   }
5842 }
5843 
5844 jlong os::current_thread_cpu_time(bool user_sys_cpu_time) {
5845   if (user_sys_cpu_time &amp;&amp; os::Linux::supports_fast_thread_cpu_time()) {
5846     return os::Linux::fast_thread_cpu_time(CLOCK_THREAD_CPUTIME_ID);
5847   } else {
5848     return slow_thread_cpu_time(Thread::current(), user_sys_cpu_time);
5849   }
5850 }
5851 
5852 jlong os::thread_cpu_time(Thread *thread, bool user_sys_cpu_time) {
5853   if (user_sys_cpu_time &amp;&amp; os::Linux::supports_fast_thread_cpu_time()) {
5854     return fast_cpu_time(thread);
5855   } else {
5856     return slow_thread_cpu_time(thread, user_sys_cpu_time);
5857   }
5858 }
5859 
5860 //  -1 on error.
5861 static jlong slow_thread_cpu_time(Thread *thread, bool user_sys_cpu_time) {
5862   pid_t  tid = thread-&gt;osthread()-&gt;thread_id();
5863   char *s;
5864   char stat[2048];
5865   int statlen;
5866   char proc_name[64];
5867   int count;
5868   long sys_time, user_time;
5869   char cdummy;
5870   int idummy;
5871   long ldummy;
5872   FILE *fp;
5873 
5874   snprintf(proc_name, 64, &quot;/proc/self/task/%d/stat&quot;, tid);
5875   fp = fopen(proc_name, &quot;r&quot;);
5876   if (fp == NULL) return -1;
5877   statlen = fread(stat, 1, 2047, fp);
5878   stat[statlen] = &#39;\0&#39;;
5879   fclose(fp);
5880 
5881   // Skip pid and the command string. Note that we could be dealing with
5882   // weird command names, e.g. user could decide to rename java launcher
5883   // to &quot;java 1.4.2 :)&quot;, then the stat file would look like
5884   //                1234 (java 1.4.2 :)) R ... ...
5885   // We don&#39;t really need to know the command string, just find the last
5886   // occurrence of &quot;)&quot; and then start parsing from there. See bug 4726580.
5887   s = strrchr(stat, &#39;)&#39;);
5888   if (s == NULL) return -1;
5889 
5890   // Skip blank chars
5891   do { s++; } while (s &amp;&amp; isspace(*s));
5892 
5893   count = sscanf(s,&quot;%c %d %d %d %d %d %lu %lu %lu %lu %lu %lu %lu&quot;,
5894                  &amp;cdummy, &amp;idummy, &amp;idummy, &amp;idummy, &amp;idummy, &amp;idummy,
5895                  &amp;ldummy, &amp;ldummy, &amp;ldummy, &amp;ldummy, &amp;ldummy,
5896                  &amp;user_time, &amp;sys_time);
5897   if (count != 13) return -1;
5898   if (user_sys_cpu_time) {
5899     return ((jlong)sys_time + (jlong)user_time) * (1000000000 / clock_tics_per_sec);
5900   } else {
5901     return (jlong)user_time * (1000000000 / clock_tics_per_sec);
5902   }
5903 }
5904 
5905 void os::current_thread_cpu_time_info(jvmtiTimerInfo *info_ptr) {
5906   info_ptr-&gt;max_value = ALL_64_BITS;       // will not wrap in less than 64 bits
5907   info_ptr-&gt;may_skip_backward = false;     // elapsed time not wall time
5908   info_ptr-&gt;may_skip_forward = false;      // elapsed time not wall time
5909   info_ptr-&gt;kind = JVMTI_TIMER_TOTAL_CPU;  // user+system time is returned
5910 }
5911 
5912 void os::thread_cpu_time_info(jvmtiTimerInfo *info_ptr) {
5913   info_ptr-&gt;max_value = ALL_64_BITS;       // will not wrap in less than 64 bits
5914   info_ptr-&gt;may_skip_backward = false;     // elapsed time not wall time
5915   info_ptr-&gt;may_skip_forward = false;      // elapsed time not wall time
5916   info_ptr-&gt;kind = JVMTI_TIMER_TOTAL_CPU;  // user+system time is returned
5917 }
5918 
5919 bool os::is_thread_cpu_time_supported() {
5920   return true;
5921 }
5922 
5923 // System loadavg support.  Returns -1 if load average cannot be obtained.
5924 // Linux doesn&#39;t yet have a (official) notion of processor sets,
5925 // so just return the system wide load average.
5926 int os::loadavg(double loadavg[], int nelem) {
5927   return ::getloadavg(loadavg, nelem);
5928 }
5929 
5930 void os::pause() {
5931   char filename[MAX_PATH];
5932   if (PauseAtStartupFile &amp;&amp; PauseAtStartupFile[0]) {
5933     jio_snprintf(filename, MAX_PATH, &quot;%s&quot;, PauseAtStartupFile);
5934   } else {
5935     jio_snprintf(filename, MAX_PATH, &quot;./vm.paused.%d&quot;, current_process_id());
5936   }
5937 
5938   int fd = ::open(filename, O_WRONLY | O_CREAT | O_TRUNC, 0666);
5939   if (fd != -1) {
5940     struct stat buf;
5941     ::close(fd);
5942     while (::stat(filename, &amp;buf) == 0) {
5943       (void)::poll(NULL, 0, 100);
5944     }
5945   } else {
5946     jio_fprintf(stderr,
5947                 &quot;Could not open pause file &#39;%s&#39;, continuing immediately.\n&quot;, filename);
5948   }
5949 }
5950 
5951 extern char** environ;
5952 
5953 // Run the specified command in a separate process. Return its exit value,
5954 // or -1 on failure (e.g. can&#39;t fork a new process).
5955 // Unlike system(), this function can be called from signal handler. It
5956 // doesn&#39;t block SIGINT et al.
5957 int os::fork_and_exec(char* cmd, bool use_vfork_if_available) {
5958   const char * argv[4] = {&quot;sh&quot;, &quot;-c&quot;, cmd, NULL};
5959 
5960   pid_t pid ;
5961 
5962   if (use_vfork_if_available) {
5963     pid = vfork();
5964   } else {
5965     pid = fork();
5966   }
5967 
5968   if (pid &lt; 0) {
5969     // fork failed
5970     return -1;
5971 
5972   } else if (pid == 0) {
5973     // child process
5974 
5975     execve(&quot;/bin/sh&quot;, (char* const*)argv, environ);
5976 
5977     // execve failed
5978     _exit(-1);
5979 
5980   } else  {
5981     // copied from J2SE ..._waitForProcessExit() in UNIXProcess_md.c; we don&#39;t
5982     // care about the actual exit code, for now.
5983 
5984     int status;
5985 
5986     // Wait for the child process to exit.  This returns immediately if
5987     // the child has already exited. */
5988     while (waitpid(pid, &amp;status, 0) &lt; 0) {
5989       switch (errno) {
5990       case ECHILD: return 0;
5991       case EINTR: break;
5992       default: return -1;
5993       }
5994     }
5995 
5996     if (WIFEXITED(status)) {
5997       // The child exited normally; get its exit code.
5998       return WEXITSTATUS(status);
5999     } else if (WIFSIGNALED(status)) {
6000       // The child exited because of a signal
6001       // The best value to return is 0x80 + signal number,
6002       // because that is what all Unix shells do, and because
6003       // it allows callers to distinguish between process exit and
6004       // process death by signal.
6005       return 0x80 + WTERMSIG(status);
6006     } else {
6007       // Unknown exit code; pass it through
6008       return status;
6009     }
6010   }
6011 }
6012 
6013 // Get the default path to the core file
6014 // Returns the length of the string
6015 int os::get_core_path(char* buffer, size_t bufferSize) {
6016   /*
6017    * Max length of /proc/sys/kernel/core_pattern is 128 characters.
6018    * See https://www.kernel.org/doc/Documentation/sysctl/kernel.txt
6019    */
6020   const int core_pattern_len = 129;
6021   char core_pattern[core_pattern_len] = {0};
6022 
6023   int core_pattern_file = ::open(&quot;/proc/sys/kernel/core_pattern&quot;, O_RDONLY);
6024   if (core_pattern_file == -1) {
6025     return -1;
6026   }
6027 
6028   ssize_t ret = ::read(core_pattern_file, core_pattern, core_pattern_len);
6029   ::close(core_pattern_file);
6030   if (ret &lt;= 0 || ret &gt;= core_pattern_len || core_pattern[0] == &#39;\n&#39;) {
6031     return -1;
6032   }
6033   if (core_pattern[ret-1] == &#39;\n&#39;) {
6034     core_pattern[ret-1] = &#39;\0&#39;;
6035   } else {
6036     core_pattern[ret] = &#39;\0&#39;;
6037   }
6038 
6039   // Replace the %p in the core pattern with the process id. NOTE: we do this
6040   // only if the pattern doesn&#39;t start with &quot;|&quot;, and we support only one %p in
6041   // the pattern.
6042   char *pid_pos = strstr(core_pattern, &quot;%p&quot;);
6043   const char* tail = (pid_pos != NULL) ? (pid_pos + 2) : &quot;&quot;;  // skip over the &quot;%p&quot;
6044   int written;
6045 
6046   if (core_pattern[0] == &#39;/&#39;) {
6047     if (pid_pos != NULL) {
6048       *pid_pos = &#39;\0&#39;;
6049       written = jio_snprintf(buffer, bufferSize, &quot;%s%d%s&quot;, core_pattern,
6050                              current_process_id(), tail);
6051     } else {
6052       written = jio_snprintf(buffer, bufferSize, &quot;%s&quot;, core_pattern);
6053     }
6054   } else {
6055     char cwd[PATH_MAX];
6056 
6057     const char* p = get_current_directory(cwd, PATH_MAX);
6058     if (p == NULL) {
6059       return -1;
6060     }
6061 
6062     if (core_pattern[0] == &#39;|&#39;) {
6063       written = jio_snprintf(buffer, bufferSize,
6064                              &quot;\&quot;%s\&quot; (or dumping to %s/core.%d)&quot;,
6065                              &amp;core_pattern[1], p, current_process_id());
6066     } else if (pid_pos != NULL) {
6067       *pid_pos = &#39;\0&#39;;
6068       written = jio_snprintf(buffer, bufferSize, &quot;%s/%s%d%s&quot;, p, core_pattern,
6069                              current_process_id(), tail);
6070     } else {
6071       written = jio_snprintf(buffer, bufferSize, &quot;%s/%s&quot;, p, core_pattern);
6072     }
6073   }
6074 
6075   if (written &lt; 0) {
6076     return -1;
6077   }
6078 
6079   if (((size_t)written &lt; bufferSize) &amp;&amp; (pid_pos == NULL) &amp;&amp; (core_pattern[0] != &#39;|&#39;)) {
6080     int core_uses_pid_file = ::open(&quot;/proc/sys/kernel/core_uses_pid&quot;, O_RDONLY);
6081 
6082     if (core_uses_pid_file != -1) {
6083       char core_uses_pid = 0;
6084       ssize_t ret = ::read(core_uses_pid_file, &amp;core_uses_pid, 1);
6085       ::close(core_uses_pid_file);
6086 
6087       if (core_uses_pid == &#39;1&#39;) {
6088         jio_snprintf(buffer + written, bufferSize - written,
6089                                           &quot;.%d&quot;, current_process_id());
6090       }
6091     }
6092   }
6093 
6094   return strlen(buffer);
6095 }
6096 
6097 bool os::start_debugging(char *buf, int buflen) {
6098   int len = (int)strlen(buf);
6099   char *p = &amp;buf[len];
6100 
6101   jio_snprintf(p, buflen-len,
6102                &quot;\n\n&quot;
6103                &quot;Do you want to debug the problem?\n\n&quot;
6104                &quot;To debug, run &#39;gdb /proc/%d/exe %d&#39;; then switch to thread &quot; UINTX_FORMAT &quot; (&quot; INTPTR_FORMAT &quot;)\n&quot;
6105                &quot;Enter &#39;yes&#39; to launch gdb automatically (PATH must include gdb)\n&quot;
6106                &quot;Otherwise, press RETURN to abort...&quot;,
6107                os::current_process_id(), os::current_process_id(),
6108                os::current_thread_id(), os::current_thread_id());
6109 
6110   bool yes = os::message_box(&quot;Unexpected Error&quot;, buf);
6111 
6112   if (yes) {
6113     // yes, user asked VM to launch debugger
6114     jio_snprintf(buf, sizeof(char)*buflen, &quot;gdb /proc/%d/exe %d&quot;,
6115                  os::current_process_id(), os::current_process_id());
6116 
6117     os::fork_and_exec(buf);
6118     yes = false;
6119   }
6120   return yes;
6121 }
6122 
6123 
6124 // Java/Compiler thread:
6125 //
6126 //   Low memory addresses
6127 // P0 +------------------------+
6128 //    |                        |\  Java thread created by VM does not have glibc
6129 //    |    glibc guard page    | - guard page, attached Java thread usually has
6130 //    |                        |/  1 glibc guard page.
6131 // P1 +------------------------+ Thread::stack_base() - Thread::stack_size()
6132 //    |                        |\
6133 //    |  HotSpot Guard Pages   | - red, yellow and reserved pages
6134 //    |                        |/
6135 //    +------------------------+ JavaThread::stack_reserved_zone_base()
6136 //    |                        |\
6137 //    |      Normal Stack      | -
6138 //    |                        |/
6139 // P2 +------------------------+ Thread::stack_base()
6140 //
6141 // Non-Java thread:
6142 //
6143 //   Low memory addresses
6144 // P0 +------------------------+
6145 //    |                        |\
6146 //    |  glibc guard page      | - usually 1 page
6147 //    |                        |/
6148 // P1 +------------------------+ Thread::stack_base() - Thread::stack_size()
6149 //    |                        |\
6150 //    |      Normal Stack      | -
6151 //    |                        |/
6152 // P2 +------------------------+ Thread::stack_base()
6153 //
6154 // ** P1 (aka bottom) and size (P2 = P1 - size) are the address and stack size
6155 //    returned from pthread_attr_getstack().
6156 // ** Due to NPTL implementation error, linux takes the glibc guard page out
6157 //    of the stack size given in pthread_attr. We work around this for
6158 //    threads created by the VM. (We adapt bottom to be P1 and size accordingly.)
6159 //
6160 #ifndef ZERO
6161 static void current_stack_region(address * bottom, size_t * size) {
6162   if (os::is_primordial_thread()) {
6163     // primordial thread needs special handling because pthread_getattr_np()
6164     // may return bogus value.
6165     *bottom = os::Linux::initial_thread_stack_bottom();
6166     *size   = os::Linux::initial_thread_stack_size();
6167   } else {
6168     pthread_attr_t attr;
6169 
6170     int rslt = pthread_getattr_np(pthread_self(), &amp;attr);
6171 
6172     // JVM needs to know exact stack location, abort if it fails
6173     if (rslt != 0) {
6174       if (rslt == ENOMEM) {
6175         vm_exit_out_of_memory(0, OOM_MMAP_ERROR, &quot;pthread_getattr_np&quot;);
6176       } else {
6177         fatal(&quot;pthread_getattr_np failed with error = %d&quot;, rslt);
6178       }
6179     }
6180 
6181     if (pthread_attr_getstack(&amp;attr, (void **)bottom, size) != 0) {
6182       fatal(&quot;Cannot locate current stack attributes!&quot;);
6183     }
6184 
6185     // Work around NPTL stack guard error.
6186     size_t guard_size = 0;
6187     rslt = pthread_attr_getguardsize(&amp;attr, &amp;guard_size);
6188     if (rslt != 0) {
6189       fatal(&quot;pthread_attr_getguardsize failed with error = %d&quot;, rslt);
6190     }
6191     *bottom += guard_size;
6192     *size   -= guard_size;
6193 
6194     pthread_attr_destroy(&amp;attr);
6195 
6196   }
6197   assert(os::current_stack_pointer() &gt;= *bottom &amp;&amp;
6198          os::current_stack_pointer() &lt; *bottom + *size, &quot;just checking&quot;);
6199 }
6200 
6201 address os::current_stack_base() {
6202   address bottom;
6203   size_t size;
6204   current_stack_region(&amp;bottom, &amp;size);
6205   return (bottom + size);
6206 }
6207 
6208 size_t os::current_stack_size() {
6209   // This stack size includes the usable stack and HotSpot guard pages
6210   // (for the threads that have Hotspot guard pages).
6211   address bottom;
6212   size_t size;
6213   current_stack_region(&amp;bottom, &amp;size);
6214   return size;
6215 }
6216 #endif
6217 
6218 static inline struct timespec get_mtime(const char* filename) {
6219   struct stat st;
6220   int ret = os::stat(filename, &amp;st);
6221   assert(ret == 0, &quot;failed to stat() file &#39;%s&#39;: %s&quot;, filename, os::strerror(errno));
6222   return st.st_mtim;
6223 }
6224 
6225 int os::compare_file_modified_times(const char* file1, const char* file2) {
6226   struct timespec filetime1 = get_mtime(file1);
6227   struct timespec filetime2 = get_mtime(file2);
6228   int diff = filetime1.tv_sec - filetime2.tv_sec;
6229   if (diff == 0) {
6230     return filetime1.tv_nsec - filetime2.tv_nsec;
6231   }
6232   return diff;
6233 }
6234 
6235 bool os::supports_map_sync() {
6236   return true;
6237 }
6238 
6239 /////////////// Unit tests ///////////////
6240 
6241 #ifndef PRODUCT
6242 
6243 class TestReserveMemorySpecial : AllStatic {
6244  public:
6245   static void small_page_write(void* addr, size_t size) {
6246     size_t page_size = os::vm_page_size();
6247 
6248     char* end = (char*)addr + size;
6249     for (char* p = (char*)addr; p &lt; end; p += page_size) {
6250       *p = 1;
6251     }
6252   }
6253 
6254   static void test_reserve_memory_special_huge_tlbfs_only(size_t size) {
6255     if (!UseHugeTLBFS) {
6256       return;
6257     }
6258 
6259     char* addr = os::Linux::reserve_memory_special_huge_tlbfs_only(size, NULL, false);
6260 
6261     if (addr != NULL) {
6262       small_page_write(addr, size);
6263 
6264       os::Linux::release_memory_special_huge_tlbfs(addr, size);
6265     }
6266   }
6267 
6268   static void test_reserve_memory_special_huge_tlbfs_only() {
6269     if (!UseHugeTLBFS) {
6270       return;
6271     }
6272 
6273     size_t lp = os::large_page_size();
6274 
6275     for (size_t size = lp; size &lt;= lp * 10; size += lp) {
6276       test_reserve_memory_special_huge_tlbfs_only(size);
6277     }
6278   }
6279 
6280   static void test_reserve_memory_special_huge_tlbfs_mixed() {
6281     size_t lp = os::large_page_size();
6282     size_t ag = os::vm_allocation_granularity();
6283 
6284     // sizes to test
6285     const size_t sizes[] = {
6286       lp, lp + ag, lp + lp / 2, lp * 2,
6287       lp * 2 + ag, lp * 2 - ag, lp * 2 + lp / 2,
6288       lp * 10, lp * 10 + lp / 2
6289     };
6290     const int num_sizes = sizeof(sizes) / sizeof(size_t);
6291 
6292     // For each size/alignment combination, we test three scenarios:
6293     // 1) with req_addr == NULL
6294     // 2) with a non-null req_addr at which we expect to successfully allocate
6295     // 3) with a non-null req_addr which contains a pre-existing mapping, at which we
6296     //    expect the allocation to either fail or to ignore req_addr
6297 
6298     // Pre-allocate two areas; they shall be as large as the largest allocation
6299     //  and aligned to the largest alignment we will be testing.
6300     const size_t mapping_size = sizes[num_sizes - 1] * 2;
6301     char* const mapping1 = (char*) ::mmap(NULL, mapping_size,
6302       PROT_NONE, MAP_PRIVATE|MAP_ANONYMOUS|MAP_NORESERVE,
6303       -1, 0);
6304     assert(mapping1 != MAP_FAILED, &quot;should work&quot;);
6305 
6306     char* const mapping2 = (char*) ::mmap(NULL, mapping_size,
6307       PROT_NONE, MAP_PRIVATE|MAP_ANONYMOUS|MAP_NORESERVE,
6308       -1, 0);
6309     assert(mapping2 != MAP_FAILED, &quot;should work&quot;);
6310 
6311     // Unmap the first mapping, but leave the second mapping intact: the first
6312     // mapping will serve as a value for a &quot;good&quot; req_addr (case 2). The second
6313     // mapping, still intact, as &quot;bad&quot; req_addr (case 3).
6314     ::munmap(mapping1, mapping_size);
6315 
6316     // Case 1
6317     for (int i = 0; i &lt; num_sizes; i++) {
6318       const size_t size = sizes[i];
6319       for (size_t alignment = ag; is_aligned(size, alignment); alignment *= 2) {
6320         char* p = os::Linux::reserve_memory_special_huge_tlbfs_mixed(size, alignment, NULL, false);
6321         if (p != NULL) {
6322           assert(is_aligned(p, alignment), &quot;must be&quot;);
6323           small_page_write(p, size);
6324           os::Linux::release_memory_special_huge_tlbfs(p, size);
6325         }
6326       }
6327     }
6328 
6329     // Case 2
6330     for (int i = 0; i &lt; num_sizes; i++) {
6331       const size_t size = sizes[i];
6332       for (size_t alignment = ag; is_aligned(size, alignment); alignment *= 2) {
6333         char* const req_addr = align_up(mapping1, alignment);
6334         char* p = os::Linux::reserve_memory_special_huge_tlbfs_mixed(size, alignment, req_addr, false);
6335         if (p != NULL) {
6336           assert(p == req_addr, &quot;must be&quot;);
6337           small_page_write(p, size);
6338           os::Linux::release_memory_special_huge_tlbfs(p, size);
6339         }
6340       }
6341     }
6342 
6343     // Case 3
6344     for (int i = 0; i &lt; num_sizes; i++) {
6345       const size_t size = sizes[i];
6346       for (size_t alignment = ag; is_aligned(size, alignment); alignment *= 2) {
6347         char* const req_addr = align_up(mapping2, alignment);
6348         char* p = os::Linux::reserve_memory_special_huge_tlbfs_mixed(size, alignment, req_addr, false);
6349         // as the area around req_addr contains already existing mappings, the API should always
6350         // return NULL (as per contract, it cannot return another address)
6351         assert(p == NULL, &quot;must be&quot;);
6352       }
6353     }
6354 
6355     ::munmap(mapping2, mapping_size);
6356 
6357   }
6358 
6359   static void test_reserve_memory_special_huge_tlbfs() {
6360     if (!UseHugeTLBFS) {
6361       return;
6362     }
6363 
6364     test_reserve_memory_special_huge_tlbfs_only();
6365     test_reserve_memory_special_huge_tlbfs_mixed();
6366   }
6367 
6368   static void test_reserve_memory_special_shm(size_t size, size_t alignment) {
6369     if (!UseSHM) {
6370       return;
6371     }
6372 
6373     char* addr = os::Linux::reserve_memory_special_shm(size, alignment, NULL, false);
6374 
6375     if (addr != NULL) {
6376       assert(is_aligned(addr, alignment), &quot;Check&quot;);
6377       assert(is_aligned(addr, os::large_page_size()), &quot;Check&quot;);
6378 
6379       small_page_write(addr, size);
6380 
6381       os::Linux::release_memory_special_shm(addr, size);
6382     }
6383   }
6384 
6385   static void test_reserve_memory_special_shm() {
6386     size_t lp = os::large_page_size();
6387     size_t ag = os::vm_allocation_granularity();
6388 
6389     for (size_t size = ag; size &lt; lp * 3; size += ag) {
6390       for (size_t alignment = ag; is_aligned(size, alignment); alignment *= 2) {
6391         test_reserve_memory_special_shm(size, alignment);
6392       }
6393     }
6394   }
6395 
6396   static void test() {
6397     test_reserve_memory_special_huge_tlbfs();
6398     test_reserve_memory_special_shm();
6399   }
6400 };
6401 
6402 void TestReserveMemorySpecial_test() {
6403   TestReserveMemorySpecial::test();
6404 }
6405 
6406 #endif
<a name="10" id="anc10"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="10" type="hidden" />
</body>
</html>