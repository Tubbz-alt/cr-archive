<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New modules/javafx.base/src/main/java/com/sun/javafx/binding/BidirectionalBinding.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2011, 2020, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package com.sun.javafx.binding;
 27 
 28 import javafx.beans.WeakListener;
 29 import javafx.beans.property.*;
 30 import javafx.beans.value.ChangeListener;
 31 import javafx.beans.value.ObservableValue;
 32 import javafx.util.StringConverter;
 33 
 34 import java.lang.ref.WeakReference;
 35 import java.text.Format;
 36 import java.text.ParseException;
 37 import java.util.Objects;
 38 
 39 public abstract class BidirectionalBinding&lt;T&gt; implements ChangeListener&lt;T&gt;, WeakListener {
 40 
 41     private static void checkParameters(Object property1, Object property2) {
 42         Objects.requireNonNull(property1, &quot;Both properties must be specified.&quot;);
 43         Objects.requireNonNull(property2, &quot;Both properties must be specified.&quot;);
 44         if (property1 == property2) {
 45             throw new IllegalArgumentException(&quot;Cannot bind property to itself&quot;);
 46         }
 47     }
 48 
 49     public static &lt;T&gt; BidirectionalBinding bind(Property&lt;T&gt; property1, Property&lt;T&gt; property2) {
 50         checkParameters(property1, property2);
 51         final BidirectionalBinding binding =
 52                 ((property1 instanceof DoubleProperty) &amp;&amp; (property2 instanceof DoubleProperty)) ?
 53                         new BidirectionalDoubleBinding((DoubleProperty) property1, (DoubleProperty) property2)
 54                 : ((property1 instanceof FloatProperty) &amp;&amp; (property2 instanceof FloatProperty)) ?
 55                         new BidirectionalFloatBinding((FloatProperty) property1, (FloatProperty) property2)
 56                 : ((property1 instanceof IntegerProperty) &amp;&amp; (property2 instanceof IntegerProperty)) ?
 57                         new BidirectionalIntegerBinding((IntegerProperty) property1, (IntegerProperty) property2)
 58                 : ((property1 instanceof LongProperty) &amp;&amp; (property2 instanceof LongProperty)) ?
 59                         new BidirectionalLongBinding((LongProperty) property1, (LongProperty) property2)
 60                 : ((property1 instanceof BooleanProperty) &amp;&amp; (property2 instanceof BooleanProperty)) ?
 61                         new BidirectionalBooleanBinding((BooleanProperty) property1, (BooleanProperty) property2)
 62                 : new TypedGenericBidirectionalBinding&lt;T&gt;(property1, property2);
 63         property1.setValue(property2.getValue());
 64         property1.addListener(binding);
 65         property2.addListener(binding);
 66         return binding;
 67     }
 68 
 69     public static Object bind(Property&lt;String&gt; stringProperty, Property&lt;?&gt; otherProperty, Format format) {
 70         checkParameters(stringProperty, otherProperty);
 71         Objects.requireNonNull(format, &quot;Format cannot be null&quot;);
 72         final var binding = new StringFormatBidirectionalBinding(stringProperty, otherProperty, format);
 73         stringProperty.setValue(format.format(otherProperty.getValue()));
 74         stringProperty.addListener(binding);
 75         otherProperty.addListener(binding);
 76         return binding;
 77     }
 78 
 79     public static &lt;T&gt; Object bind(Property&lt;String&gt; stringProperty, Property&lt;T&gt; otherProperty, StringConverter&lt;T&gt; converter) {
 80         checkParameters(stringProperty, otherProperty);
 81         Objects.requireNonNull(converter, &quot;Converter cannot be null&quot;);
 82         final var binding = new StringConverterBidirectionalBinding&lt;&gt;(stringProperty, otherProperty, converter);
 83         stringProperty.setValue(converter.toString(otherProperty.getValue()));
 84         stringProperty.addListener(binding);
 85         otherProperty.addListener(binding);
 86         return binding;
 87     }
 88 
 89     public static &lt;T&gt; void unbind(Property&lt;T&gt; property1, Property&lt;T&gt; property2) {
 90         checkParameters(property1, property2);
 91         final BidirectionalBinding binding = new UntypedGenericBidirectionalBinding(property1, property2);
 92         property1.removeListener(binding);
 93         property2.removeListener(binding);
 94     }
 95 
 96     public static void unbind(Object property1, Object property2) {
 97         checkParameters(property1, property2);
 98         final BidirectionalBinding binding = new UntypedGenericBidirectionalBinding(property1, property2);
 99         if (property1 instanceof ObservableValue) {
100             ((ObservableValue) property1).removeListener(binding);
101         }
102         if (property2 instanceof ObservableValue) {
103             ((ObservableValue) property2).removeListener(binding);
104         }
105     }
106 
107     public static BidirectionalBinding bindNumber(Property&lt;Integer&gt; property1, IntegerProperty property2) {
108         return bindNumber(property1, (Property&lt;Number&gt;)property2);
109     }
110 
111     public static BidirectionalBinding bindNumber(Property&lt;Long&gt; property1, LongProperty property2) {
112         return bindNumber(property1, (Property&lt;Number&gt;)property2);
113     }
114 
115     public static BidirectionalBinding bindNumber(Property&lt;Float&gt; property1, FloatProperty property2) {
116         return bindNumber(property1, (Property&lt;Number&gt;)property2);
117     }
118 
119     public static BidirectionalBinding bindNumber(Property&lt;Double&gt; property1, DoubleProperty property2) {
120         return bindNumber(property1, (Property&lt;Number&gt;)property2);
121     }
122 
123     public static BidirectionalBinding bindNumber(IntegerProperty property1, Property&lt;Integer&gt; property2) {
124         return bindNumberObject(property1, property2);
125     }
126 
127     public static BidirectionalBinding bindNumber(LongProperty property1, Property&lt;Long&gt; property2) {
128         return bindNumberObject(property1, property2);
129     }
130 
131     public static BidirectionalBinding bindNumber(FloatProperty property1, Property&lt;Float&gt; property2) {
132         return bindNumberObject(property1, property2);
133     }
134 
135     public static BidirectionalBinding bindNumber(DoubleProperty property1, Property&lt;Double&gt; property2) {
136         return bindNumberObject(property1, property2);
137     }
138 
139     private static &lt;T extends Number&gt; BidirectionalBinding bindNumberObject(Property&lt;Number&gt; property1, Property&lt;T&gt; property2) {
140         checkParameters(property1, property2);
141 
142         final BidirectionalBinding&lt;Number&gt; binding = new TypedNumberBidirectionalBinding&lt;T&gt;(property2, property1);
143 
144         property1.setValue(property2.getValue());
145         property1.addListener(binding);
146         property2.addListener(binding);
147         return binding;
148     }
149 
150     private static &lt;T extends Number&gt; BidirectionalBinding bindNumber(Property&lt;T&gt; property1, Property&lt;Number&gt; property2) {
151         checkParameters(property1, property2);
152 
153         final BidirectionalBinding&lt;Number&gt; binding = new TypedNumberBidirectionalBinding&lt;T&gt;(property1, property2);
154 
155         property1.setValue((T)property2.getValue());
156         property1.addListener(binding);
157         property2.addListener(binding);
158         return binding;
159     }
160 
161     private final int cachedHashCode;
162 
163     private BidirectionalBinding(Object property1, Object property2) {
164         cachedHashCode = property1.hashCode() * property2.hashCode();
165     }
166 
167     protected abstract Object getProperty1();
168 
169     protected abstract Object getProperty2();
170 
171     @Override
172     public int hashCode() {
173         return cachedHashCode;
174     }
175 
176     @Override
177     public boolean wasGarbageCollected() {
178         return (getProperty1() == null) || (getProperty2() == null);
179     }
180 
181     @Override
182     public boolean equals(Object obj) {
183         if (this == obj) {
184             return true;
185         }
186 
187         final Object propertyA1 = getProperty1();
188         final Object propertyA2 = getProperty2();
189         if ((propertyA1 == null) || (propertyA2 == null)) {
190             return false;
191         }
192 
193         if (obj instanceof BidirectionalBinding) {
194             final BidirectionalBinding otherBinding = (BidirectionalBinding) obj;
195             final Object propertyB1 = otherBinding.getProperty1();
196             final Object propertyB2 = otherBinding.getProperty2();
197             if ((propertyB1 == null) || (propertyB2 == null)) {
198                 return false;
199             }
200 
201             if (propertyA1 == propertyB1 &amp;&amp; propertyA2 == propertyB2) {
202                 return true;
203             }
204             if (propertyA1 == propertyB2 &amp;&amp; propertyA2 == propertyB1) {
205                 return true;
206             }
207         }
208         return false;
209     }
210 
211     private static class BidirectionalBooleanBinding extends BidirectionalBinding&lt;Boolean&gt; {
212         private final WeakReference&lt;BooleanProperty&gt; propertyRef1;
213         private final WeakReference&lt;BooleanProperty&gt; propertyRef2;
214         private boolean updating = false;
215 
216         private BidirectionalBooleanBinding(BooleanProperty property1, BooleanProperty property2) {
217             super(property1, property2);
218             propertyRef1 = new WeakReference&lt;BooleanProperty&gt;(property1);
219             propertyRef2 = new WeakReference&lt;BooleanProperty&gt;(property2);
220         }
221 
222         @Override
223         protected Property&lt;Boolean&gt; getProperty1() {
224             return propertyRef1.get();
225         }
226 
227         @Override
228         protected Property&lt;Boolean&gt; getProperty2() {
229             return propertyRef2.get();
230         }
231 
232         @Override
233         public void changed(ObservableValue&lt;? extends Boolean&gt; sourceProperty, Boolean oldValue, Boolean newValue) {
234             if (!updating) {
235                 final BooleanProperty property1 = propertyRef1.get();
236                 final BooleanProperty property2 = propertyRef2.get();
237                 if ((property1 == null) || (property2 == null)) {
238                     if (property1 != null) {
239                         property1.removeListener(this);
240                     }
241                     if (property2 != null) {
242                         property2.removeListener(this);
243                     }
244                 } else {
245                     try {
246                         updating = true;
247                         if (property1 == sourceProperty) {
248                             property2.set(newValue);
249                         } else {
250                             property1.set(newValue);
251                         }
252                     } catch (RuntimeException e) {
253                         try {
254                             if (property1 == sourceProperty) {
255                                 property1.set(oldValue);
256                             } else {
257                                 property2.set(oldValue);
258                             }
259                         } catch (Exception e2) {
260                             e2.addSuppressed(e);
261                             unbind(property1, property2);
262                             throw new RuntimeException(
263                                 &quot;Bidirectional binding failed together with an attempt&quot;
264                                         + &quot; to restore the source property to the previous value.&quot;
265                                         + &quot; Removing the bidirectional binding from properties &quot; +
266                                         property1 + &quot; and &quot; + property2, e2);
267                         }
268                         throw new RuntimeException(
269                                 &quot;Bidirectional binding failed, setting to the previous value&quot;, e);
270                     } finally {
271                         updating = false;
272                     }
273                 }
274             }
275         }
276     }
277 
278     private static class BidirectionalDoubleBinding extends BidirectionalBinding&lt;Number&gt; {
279         private final WeakReference&lt;DoubleProperty&gt; propertyRef1;
280         private final WeakReference&lt;DoubleProperty&gt; propertyRef2;
281         private boolean updating = false;
282 
283         private BidirectionalDoubleBinding(DoubleProperty property1, DoubleProperty property2) {
284             super(property1, property2);
285             propertyRef1 = new WeakReference&lt;DoubleProperty&gt;(property1);
286             propertyRef2 = new WeakReference&lt;DoubleProperty&gt;(property2);
287         }
288 
289         @Override
290         protected Property&lt;Number&gt; getProperty1() {
291             return propertyRef1.get();
292         }
293 
294         @Override
295         protected Property&lt;Number&gt; getProperty2() {
296             return propertyRef2.get();
297         }
298 
299         @Override
300         public void changed(ObservableValue&lt;? extends Number&gt; sourceProperty, Number oldValue, Number newValue) {
301             if (!updating) {
302                 final DoubleProperty property1 = propertyRef1.get();
303                 final DoubleProperty property2 = propertyRef2.get();
304                 if ((property1 == null) || (property2 == null)) {
305                     if (property1 != null) {
306                         property1.removeListener(this);
307                     }
308                     if (property2 != null) {
309                         property2.removeListener(this);
310                     }
311                 } else {
312                     try {
313                         updating = true;
314                         if (property1 == sourceProperty) {
315                             property2.set(newValue.doubleValue());
316                         } else {
317                             property1.set(newValue.doubleValue());
318                         }
319                     } catch (RuntimeException e) {
320                         try {
321                             if (property1 == sourceProperty) {
322                                 property1.set(oldValue.doubleValue());
323                             } else {
324                                 property2.set(oldValue.doubleValue());
325                             }
326                         } catch (Exception e2) {
327                             e2.addSuppressed(e);
328                             unbind(property1, property2);
329                             throw new RuntimeException(
330                                 &quot;Bidirectional binding failed together with an attempt&quot;
331                                         + &quot; to restore the source property to the previous value.&quot;
332                                         + &quot; Removing the bidirectional binding from properties &quot; +
333                                         property1 + &quot; and &quot; + property2, e2);
334                         }
335                         throw new RuntimeException(
336                                         &quot;Bidirectional binding failed, setting to the previous value&quot;, e);
337                     } finally {
338                         updating = false;
339                     }
340                 }
341             }
342         }
343     }
344 
345     private static class BidirectionalFloatBinding extends BidirectionalBinding&lt;Number&gt; {
346         private final WeakReference&lt;FloatProperty&gt; propertyRef1;
347         private final WeakReference&lt;FloatProperty&gt; propertyRef2;
348         private boolean updating = false;
349 
350         private BidirectionalFloatBinding(FloatProperty property1, FloatProperty property2) {
351             super(property1, property2);
352             propertyRef1 = new WeakReference&lt;FloatProperty&gt;(property1);
353             propertyRef2 = new WeakReference&lt;FloatProperty&gt;(property2);
354         }
355 
356         @Override
357         protected Property&lt;Number&gt; getProperty1() {
358             return propertyRef1.get();
359         }
360 
361         @Override
362         protected Property&lt;Number&gt; getProperty2() {
363             return propertyRef2.get();
364         }
365 
366         @Override
367         public void changed(ObservableValue&lt;? extends Number&gt; sourceProperty, Number oldValue, Number newValue) {
368             if (!updating) {
369                 final FloatProperty property1 = propertyRef1.get();
370                 final FloatProperty property2 = propertyRef2.get();
371                 if ((property1 == null) || (property2 == null)) {
372                     if (property1 != null) {
373                         property1.removeListener(this);
374                     }
375                     if (property2 != null) {
376                         property2.removeListener(this);
377                     }
378                 } else {
379                     try {
380                         updating = true;
381                         if (property1 == sourceProperty) {
382                             property2.set(newValue.floatValue());
383                         } else {
384                             property1.set(newValue.floatValue());
385                         }
386                     } catch (RuntimeException e) {
387                         try {
388                             if (property1 == sourceProperty) {
389                                 property1.set(oldValue.floatValue());
390                             } else {
391                                 property2.set(oldValue.floatValue());
392                             }
393                         } catch (Exception e2) {
394                             e2.addSuppressed(e);
395                             unbind(property1, property2);
396                             throw new RuntimeException(
397                                 &quot;Bidirectional binding failed together with an attempt&quot;
398                                         + &quot; to restore the source property to the previous value.&quot;
399                                         + &quot; Removing the bidirectional binding from properties &quot; +
400                                         property1 + &quot; and &quot; + property2, e2);
401                         }
402                         throw new RuntimeException(
403                                 &quot;Bidirectional binding failed, setting to the previous value&quot;, e);
404                     } finally {
405                         updating = false;
406                     }
407                 }
408             }
409         }
410     }
411 
412     private static class BidirectionalIntegerBinding extends BidirectionalBinding&lt;Number&gt;{
413         private final WeakReference&lt;IntegerProperty&gt; propertyRef1;
414         private final WeakReference&lt;IntegerProperty&gt; propertyRef2;
415         private boolean updating = false;
416 
417         private BidirectionalIntegerBinding(IntegerProperty property1, IntegerProperty property2) {
418             super(property1, property2);
419             propertyRef1 = new WeakReference&lt;IntegerProperty&gt;(property1);
420             propertyRef2 = new WeakReference&lt;IntegerProperty&gt;(property2);
421         }
422 
423         @Override
424         protected Property&lt;Number&gt; getProperty1() {
425             return propertyRef1.get();
426         }
427 
428         @Override
429         protected Property&lt;Number&gt; getProperty2() {
430             return propertyRef2.get();
431         }
432 
433         @Override
434         public void changed(ObservableValue&lt;? extends Number&gt; sourceProperty, Number oldValue, Number newValue) {
435             if (!updating) {
436                 final IntegerProperty property1 = propertyRef1.get();
437                 final IntegerProperty property2 = propertyRef2.get();
438                 if ((property1 == null) || (property2 == null)) {
439                     if (property1 != null) {
440                         property1.removeListener(this);
441                     }
442                     if (property2 != null) {
443                         property2.removeListener(this);
444                     }
445                 } else {
446                     try {
447                         updating = true;
448                         if (property1 == sourceProperty) {
449                             property2.set(newValue.intValue());
450                         } else {
451                             property1.set(newValue.intValue());
452                         }
453                     } catch (RuntimeException e) {
454                         try {
455                             if (property1 == sourceProperty) {
456                                 property1.set(oldValue.intValue());
457                             } else {
458                                 property2.set(oldValue.intValue());
459                             }
460                         } catch (Exception e2) {
461                             e2.addSuppressed(e);
462                             unbind(property1, property2);
463                             throw new RuntimeException(
464                                 &quot;Bidirectional binding failed together with an attempt&quot;
465                                         + &quot; to restore the source property to the previous value.&quot;
466                                         + &quot; Removing the bidirectional binding from properties &quot; +
467                                         property1 + &quot; and &quot; + property2, e2);
468                         }
469                         throw new RuntimeException(
470                                         &quot;Bidirectional binding failed, setting to the previous value&quot;, e);
471                     } finally {
472                         updating = false;
473                     }
474                 }
475             }
476         }
477     }
478 
479     private static class BidirectionalLongBinding extends BidirectionalBinding&lt;Number&gt; {
480         private final WeakReference&lt;LongProperty&gt; propertyRef1;
481         private final WeakReference&lt;LongProperty&gt; propertyRef2;
482         private boolean updating = false;
483 
484         private BidirectionalLongBinding(LongProperty property1, LongProperty property2) {
485             super(property1, property2);
486             propertyRef1 = new WeakReference&lt;LongProperty&gt;(property1);
487             propertyRef2 = new WeakReference&lt;LongProperty&gt;(property2);
488         }
489 
490         @Override
491         protected Property&lt;Number&gt; getProperty1() {
492             return propertyRef1.get();
493         }
494 
495         @Override
496         protected Property&lt;Number&gt; getProperty2() {
497             return propertyRef2.get();
498         }
499 
500         @Override
501         public void changed(ObservableValue&lt;? extends Number&gt; sourceProperty, Number oldValue, Number newValue) {
502             if (!updating) {
503                 final LongProperty property1 = propertyRef1.get();
504                 final LongProperty property2 = propertyRef2.get();
505                 if ((property1 == null) || (property2 == null)) {
506                     if (property1 != null) {
507                         property1.removeListener(this);
508                     }
509                     if (property2 != null) {
510                         property2.removeListener(this);
511                     }
512                 } else {
513                     try {
514                         updating = true;
515                         if (property1 == sourceProperty) {
516                             property2.set(newValue.longValue());
517                         } else {
518                             property1.set(newValue.longValue());
519                         }
520                     } catch (RuntimeException e) {
521                         try {
522                             if (property1 == sourceProperty) {
523                                 property1.set(oldValue.longValue());
524                             } else {
525                                 property2.set(oldValue.longValue());
526                             }
527                         } catch (Exception e2) {
528                             e2.addSuppressed(e);
529                             unbind(property1, property2);
530                             throw new RuntimeException(
531                                 &quot;Bidirectional binding failed together with an attempt&quot;
532                                         + &quot; to restore the source property to the previous value.&quot;
533                                         + &quot; Removing the bidirectional binding from properties &quot; +
534                                         property1 + &quot; and &quot; + property2, e2);
535                         }
536                         throw new RuntimeException(
537                                 &quot;Bidirectional binding failed, setting to the previous value&quot;, e);
538                     } finally {
539                         updating = false;
540                     }
541                 }
542             }
543         }
544     }
545 
546     private static class TypedGenericBidirectionalBinding&lt;T&gt; extends BidirectionalBinding&lt;T&gt; {
547         private final WeakReference&lt;Property&lt;T&gt;&gt; propertyRef1;
548         private final WeakReference&lt;Property&lt;T&gt;&gt; propertyRef2;
549         private boolean updating = false;
550 
551         private TypedGenericBidirectionalBinding(Property&lt;T&gt; property1, Property&lt;T&gt; property2) {
552             super(property1, property2);
553             propertyRef1 = new WeakReference&lt;Property&lt;T&gt;&gt;(property1);
554             propertyRef2 = new WeakReference&lt;Property&lt;T&gt;&gt;(property2);
555         }
556 
557         @Override
558         protected Property&lt;T&gt; getProperty1() {
559             return propertyRef1.get();
560         }
561 
562         @Override
563         protected Property&lt;T&gt; getProperty2() {
564             return propertyRef2.get();
565         }
566 
567         @Override
568         public void changed(ObservableValue&lt;? extends T&gt; sourceProperty, T oldValue, T newValue) {
569             if (!updating) {
570                 final Property&lt;T&gt; property1 = propertyRef1.get();
571                 final Property&lt;T&gt; property2 = propertyRef2.get();
572                 if ((property1 == null) || (property2 == null)) {
573                     if (property1 != null) {
574                         property1.removeListener(this);
575                     }
576                     if (property2 != null) {
577                         property2.removeListener(this);
578                     }
579                 } else {
580                     try {
581                         updating = true;
582                         if (property1 == sourceProperty) {
583                             property2.setValue(newValue);
584                         } else {
585                             property1.setValue(newValue);
586                         }
587                     } catch (RuntimeException e) {
588                         try {
589                             if (property1 == sourceProperty) {
590                                 property1.setValue(oldValue);
591                             } else {
592                                 property2.setValue(oldValue);
593                             }
594                         } catch (Exception e2) {
595                             e2.addSuppressed(e);
596                             unbind(property1, property2);
597                             throw new RuntimeException(
598                                 &quot;Bidirectional binding failed together with an attempt&quot;
599                                         + &quot; to restore the source property to the previous value.&quot;
600                                         + &quot; Removing the bidirectional binding from properties &quot; +
601                                         property1 + &quot; and &quot; + property2, e2);
602                         }
603                         throw new RuntimeException(
604                                 &quot;Bidirectional binding failed, setting to the previous value&quot;, e);
605                     } finally {
606                         updating = false;
607                     }
608                 }
609             }
610         }
611     }
612 
613     private static class TypedNumberBidirectionalBinding&lt;T extends Number&gt; extends BidirectionalBinding&lt;Number&gt; {
614         private final WeakReference&lt;Property&lt;T&gt;&gt; propertyRef1;
615         private final WeakReference&lt;Property&lt;Number&gt;&gt; propertyRef2;
616         private boolean updating = false;
617 
618         private TypedNumberBidirectionalBinding(Property&lt;T&gt; property1, Property&lt;Number&gt; property2) {
619             super(property1, property2);
620             propertyRef1 = new WeakReference&lt;Property&lt;T&gt;&gt;(property1);
621             propertyRef2 = new WeakReference&lt;Property&lt;Number&gt;&gt;(property2);
622         }
623 
624         @Override
625         protected Property&lt;T&gt; getProperty1() {
626             return propertyRef1.get();
627         }
628 
629         @Override
630         protected Property&lt;Number&gt; getProperty2() {
631             return propertyRef2.get();
632         }
633 
634         @Override
635         public void changed(ObservableValue&lt;? extends Number&gt; sourceProperty, Number oldValue, Number newValue) {
636             if (!updating) {
637                 final Property&lt;T&gt; property1 = propertyRef1.get();
638                 final Property&lt;Number&gt; property2 = propertyRef2.get();
639                 if ((property1 == null) || (property2 == null)) {
640                     if (property1 != null) {
641                         property1.removeListener(this);
642                     }
643                     if (property2 != null) {
644                         property2.removeListener(this);
645                     }
646                 } else {
647                     try {
648                         updating = true;
649                         if (property1 == sourceProperty) {
650                             property2.setValue(newValue);
651                         } else {
652                             property1.setValue((T)newValue);
653                         }
654                     } catch (RuntimeException e) {
655                         try {
656                             if (property1 == sourceProperty) {
657                                 property1.setValue((T)oldValue);
658                             } else {
659                                 property2.setValue(oldValue);
660                             }
661                         } catch (Exception e2) {
662                             e2.addSuppressed(e);
663                             unbind(property1, property2);
664                             throw new RuntimeException(
665                                 &quot;Bidirectional binding failed together with an attempt&quot;
666                                         + &quot; to restore the source property to the previous value.&quot;
667                                         + &quot; Removing the bidirectional binding from properties &quot; +
668                                         property1 + &quot; and &quot; + property2, e2);
669                         }
670                         throw new RuntimeException(
671                                         &quot;Bidirectional binding failed, setting to the previous value&quot;, e);
672                     } finally {
673                         updating = false;
674                     }
675                 }
676             }
677         }
678     }
679 
680     private static class UntypedGenericBidirectionalBinding extends BidirectionalBinding&lt;Object&gt; {
681 
682         private final Object property1;
683         private final Object property2;
684 
685         public UntypedGenericBidirectionalBinding(Object property1, Object property2) {
686             super(property1, property2);
687             this.property1 = property1;
688             this.property2 = property2;
689         }
690 
691         @Override
692         protected Object getProperty1() {
693             return property1;
694         }
695 
696         @Override
697         protected Object getProperty2() {
698             return property2;
699         }
700 
701         @Override
702         public void changed(ObservableValue&lt;? extends Object&gt; sourceProperty, Object oldValue, Object newValue) {
703             throw new RuntimeException(&quot;Should not reach here&quot;);
704         }
705     }
706 
707     public abstract static class StringConversionBidirectionalBinding&lt;T&gt; extends BidirectionalBinding&lt;Object&gt; {
708 
709         private final WeakReference&lt;Property&lt;String&gt;&gt; stringPropertyRef;
710         private final WeakReference&lt;Property&lt;T&gt;&gt; otherPropertyRef;
711         private boolean updating;
712 
713         public StringConversionBidirectionalBinding(Property&lt;String&gt; stringProperty, Property&lt;T&gt; otherProperty) {
714             super(stringProperty, otherProperty);
715             stringPropertyRef = new WeakReference&lt;Property&lt;String&gt;&gt;(stringProperty);
716             otherPropertyRef = new WeakReference&lt;Property&lt;T&gt;&gt;(otherProperty);
717         }
718 
719         protected abstract String toString(T value);
720 
721         protected abstract T fromString(String value) throws ParseException;
722 
723         @Override
724         protected Object getProperty1() {
725             return stringPropertyRef.get();
726         }
727 
728         @Override
729         protected Object getProperty2() {
730             return otherPropertyRef.get();
731         }
732 
733         @Override
734         public void changed(ObservableValue&lt;? extends Object&gt; observable, Object oldValue, Object newValue) {
735             if (!updating) {
736                 final Property&lt;String&gt; property1 = stringPropertyRef.get();
737                 final Property&lt;T&gt; property2 = otherPropertyRef.get();
738                 if ((property1 == null) || (property2 == null)) {
739                     if (property1 != null) {
740                         property1.removeListener(this);
741                     }
742                     if (property2 != null) {
743                         property2.removeListener(this);
744                     }
745                 } else {
746                     try {
747                         updating = true;
748                         if (property1 == observable) {
749                             try {
750                                 property2.setValue(fromString(property1.getValue()));
751                             } catch (Exception e) {
752                                 Logging.getLogger().warning(&quot;Exception while parsing String in bidirectional binding&quot;, e);
753                                 property2.setValue(null);
754                             }
755                         } else {
756                             try {
757                                 property1.setValue(toString(property2.getValue()));
758                             } catch (Exception e) {
759                                 Logging.getLogger().warning(&quot;Exception while converting Object to String in bidirectional binding&quot;, e);
760                                 property1.setValue(&quot;&quot;);
761                             }
762                         }
763                     } finally {
764                         updating = false;
765                     }
766                 }
767             }
768         }
769     }
770 
771     private static class StringFormatBidirectionalBinding extends StringConversionBidirectionalBinding {
772 
773         private final Format format;
774 
775         @SuppressWarnings(&quot;unchecked&quot;)
776         public StringFormatBidirectionalBinding(Property&lt;String&gt; stringProperty, Property&lt;?&gt; otherProperty, Format format) {
777             super(stringProperty, otherProperty);
778             this.format = format;
779         }
780 
781         @Override
782         protected String toString(Object value) {
783             return format.format(value);
784         }
785 
786         @Override
787         protected Object fromString(String value) throws ParseException {
788             return format.parseObject(value);
789         }
790     }
791 
792     private static class StringConverterBidirectionalBinding&lt;T&gt; extends StringConversionBidirectionalBinding&lt;T&gt; {
793 
794         private final StringConverter&lt;T&gt; converter;
795 
796         public StringConverterBidirectionalBinding(Property&lt;String&gt; stringProperty, Property&lt;T&gt; otherProperty, StringConverter&lt;T&gt; converter) {
797             super(stringProperty, otherProperty);
798             this.converter = converter;
799         }
800 
801         @Override
802         protected String toString(T value) {
803             return converter.toString(value);
804         }
805 
806         @Override
807         protected T fromString(String value) throws ParseException {
808             return converter.fromString(value);
809         }
810     }
811 }
    </pre>
  </body>
</html>