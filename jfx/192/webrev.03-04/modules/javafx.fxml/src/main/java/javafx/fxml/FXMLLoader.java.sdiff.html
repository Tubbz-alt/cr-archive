<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.fxml/src/main/java/javafx/fxml/FXMLLoader.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../docs/javafx/fxml/doc-files/introduction_to_fxml.html.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../tests/system/src/testscriptapp2/java/mymod/myapp2/FXMLScriptDeployment2Compile_Fail_Compilation.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.fxml/src/main/java/javafx/fxml/FXMLLoader.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
1555                     } else {
1556                         if (FXMLLoader.this.location == null) {
1557                             throw constructLoadException(&quot;Base location is undefined.&quot;);
1558                         }
1559 
1560                         location = new URL(FXMLLoader.this.location, source);
1561                     }
1562                     Bindings engineBindings = engine.getBindings(ScriptContext.ENGINE_SCOPE);
1563                     String filename = location.getPath();
1564                     engineBindings.put(engine.FILENAME, filename);
1565 
1566                     InputStreamReader scriptReader = null;
1567                     String script=null;
1568                     try {
1569                         scriptReader = new InputStreamReader(location.openStream(), charset);
1570                         StringBuilder sb = new StringBuilder();
1571                         final int bufSize = 4096;
1572                         char[] charBuffer = new char[bufSize];
1573                         int n;
1574                         do {
<span class="line-modified">1575                           n = scriptReader.read(charBuffer,0,bufSize);</span>
<span class="line-modified">1576                           if (n &gt; 0) {</span>
<span class="line-modified">1577                               sb.append(new String(charBuffer,0,n));</span>
1578                           }
1579                         } while (n &gt; -1);
1580                         script = sb.toString();
1581                     } catch (IOException exception) {
1582                         throw constructLoadException(exception);
1583                     } finally {
1584                         if (scriptReader != null) {
1585                             scriptReader.close();
1586                         }
1587                     }
1588                     try {
1589                         if (engine instanceof Compilable &amp;&amp; compileScript) {
1590                             CompiledScript compiledScript = null;
1591                             try {
1592                                 compiledScript=((Compilable) engine).compile(script);
1593                             } catch (ScriptException compileExc) {
<span class="line-modified">1594                                Logging.getJavaFXLogger().warning(filename+&quot;: compiling caused \&quot;&quot;+compileExc+&quot;\&quot;, falling back to evaluating script in uncompiled mode&quot;);</span>

1595                             }
1596                             if (compiledScript != null) {
<span class="line-modified">1597                                compiledScript.eval();</span>
1598                             } else { // fallback to uncompiled mode
<span class="line-modified">1599                                engine.eval(script);</span>
1600                             }
1601                         } else {
<span class="line-modified">1602                            engine.eval(script);</span>
1603                         }
1604                     } catch (ScriptException exception) {
<span class="line-modified">1605                         System.err.println(filename+&quot;: caused ScriptException&quot;);</span>
1606                         exception.printStackTrace();
1607                     }
1608                 }
1609                 catch (IOException exception) {
1610                   throw constructLoadException(exception);
1611                 }
1612             }
1613         }
1614 
1615         @Override
1616         public void processEndElement() throws IOException {
1617             super.processEndElement();
1618 
1619             if (value != null &amp;&amp; !staticLoad) {
1620                 // Evaluate the script
1621                 String filename = null;
1622                 try {
1623                     Bindings engineBindings = scriptEngine.getBindings(ScriptContext.ENGINE_SCOPE);
1624                     String script = (String) value;
1625                     filename = location.getPath() + &quot;-script_starting_at_line_&quot;
1626                                        + (getLineNumber() - (int) script.codePoints().filter(c -&gt; c == &#39;\n&#39;).count());
1627                     engineBindings.put(scriptEngine.FILENAME, filename);
1628                     if (scriptEngine instanceof Compilable &amp;&amp; compileScript) {
1629                         CompiledScript compiledScript = null;
1630                         try {
1631                             compiledScript=((Compilable) scriptEngine).compile(script);
1632                         } catch (ScriptException compileExc) {
<span class="line-modified">1633                             Logging.getJavaFXLogger().warning(filename+&quot;: compiling caused \&quot;&quot;+compileExc+&quot;\&quot;, falling back to evaluating script in uncompiled mode&quot;);</span>

1634                         }
1635                         if (compiledScript != null) {
<span class="line-modified">1636                            compiledScript.eval();</span>
1637                         } else { // fallback to uncompiled mode
<span class="line-modified">1638                            scriptEngine.eval(script);</span>
1639                         }
1640                     } else {
<span class="line-modified">1641                        scriptEngine.eval(script);</span>
1642                     }
1643                 } catch (ScriptException exception) {
<span class="line-modified">1644                     System.err.println(filename+&quot;: caused ScriptException\n&quot;+exception.getMessage());</span>
1645                 }
1646             }
1647         }
1648 
1649         @Override
1650         public void processCharacters() throws LoadException {
1651             if (source != null) {
1652                 throw constructLoadException(&quot;Script source already specified.&quot;);
1653             }
1654 
1655             if (scriptEngine == null &amp;&amp; !staticLoad) {
1656                 throw constructLoadException(&quot;Page language not specified.&quot;);
1657             }
1658 
1659             updateValue(xmlStreamReader.getText());
1660         }
1661 
1662         @Override
1663         public void processAttribute(String prefix, String localName, String value)
1664             throws IOException {
</pre>
<hr />
<pre>
1724 
1725         @Override
1726         public void handle(T event) {
1727             handler.invoke(event);
1728         }
1729     }
1730 
1731     // Event handler implemented in script code
1732     private static class ScriptEventHandler implements EventHandler&lt;Event&gt; {
1733         public final String script;
1734         public final ScriptEngine scriptEngine;
1735         public final String filename;
1736         public CompiledScript compiledScript;
1737         public boolean isCompiled=false;
1738 
1739         public ScriptEventHandler(String script, ScriptEngine scriptEngine, String filename) {
1740             this.script = script;
1741             this.scriptEngine = scriptEngine;
1742             this.filename = filename;
1743             if (scriptEngine instanceof Compilable  &amp;&amp; compileScript) {
<span class="line-modified">1744                try {</span>
<span class="line-modified">1745                   // supply the filename to the scriptEngine engine scope Bindings in case it is needed for compilation</span>
<span class="line-modified">1746                   scriptEngine.getBindings(ScriptContext.ENGINE_SCOPE).put(scriptEngine.FILENAME, filename);</span>
<span class="line-modified">1747                   this.compiledScript = ((Compilable) scriptEngine).compile(script);</span>
<span class="line-modified">1748                   this.isCompiled = true;</span>
<span class="line-modified">1749                } catch (ScriptException compileExc){</span>
<span class="line-modified">1750                     Logging.getJavaFXLogger().warning(filename+&quot;: compiling caused \&quot;&quot;+compileExc+&quot;\&quot;, falling back to evaluating script in uncompiled mode&quot;);</span>
<span class="line-modified">1751                }</span>

1752             }
1753         }
1754 
1755         @Override
1756         public void handle(Event event) {
1757             // Don&#39;t pollute the page namespace with values defined in the script
1758             Bindings engineBindings = scriptEngine.getBindings(ScriptContext.ENGINE_SCOPE);
1759             Bindings localBindings = scriptEngine.createBindings();
1760             localBindings.putAll(engineBindings);
1761             localBindings.put(EVENT_KEY, event);
1762             localBindings.put(scriptEngine.ARGV, new Object[]{event});
1763             localBindings.put(scriptEngine.FILENAME, filename);
1764             // Execute the script
1765             try {
1766                 if (isCompiled) {
1767                    compiledScript.eval(localBindings);
1768                 } else {
1769                    scriptEngine.eval(script, localBindings);
1770                 }
<span class="line-modified">1771             } catch (ScriptException exception){</span>
<span class="line-modified">1772                 throw new RuntimeException(filename+&quot;: caused ScriptException&quot;, exception);</span>
1773             }
1774         }
1775     }
1776 
1777     // Observable list change listener
1778     private static class ObservableListChangeAdapter implements ListChangeListener {
1779         private final MethodHandler handler;
1780 
1781         public ObservableListChangeAdapter(MethodHandler handler) {
1782             this.handler = handler;
1783         }
1784 
1785         @Override
1786         @SuppressWarnings(&quot;unchecked&quot;)
1787         public void onChanged(Change change) {
1788             if (handler != null) {
1789                 handler.invoke(change);
1790             }
1791         }
1792     }
</pre>
<hr />
<pre>
3617             final int untransformedAccess =
3618                     fullModifiers &amp; (Modifier.PRIVATE | Modifier.PROTECTED
3619                                                       | Modifier.PUBLIC);
3620 
3621             switch (untransformedAccess) {
3622                 case Modifier.PUBLIC:
3623                     return PUBLIC;
3624 
3625                 case Modifier.PROTECTED:
3626                     return PROTECTED;
3627 
3628                 case Modifier.PRIVATE:
3629                     return PRIVATE;
3630 
3631                 default:
3632                     return PACKAGE;
3633             }
3634         }
3635     }
3636 }
<span class="line-removed">3637 </span>
<span class="line-removed">3638 </span>
</pre>
</td>
<td>
<hr />
<pre>
1555                     } else {
1556                         if (FXMLLoader.this.location == null) {
1557                             throw constructLoadException(&quot;Base location is undefined.&quot;);
1558                         }
1559 
1560                         location = new URL(FXMLLoader.this.location, source);
1561                     }
1562                     Bindings engineBindings = engine.getBindings(ScriptContext.ENGINE_SCOPE);
1563                     String filename = location.getPath();
1564                     engineBindings.put(engine.FILENAME, filename);
1565 
1566                     InputStreamReader scriptReader = null;
1567                     String script=null;
1568                     try {
1569                         scriptReader = new InputStreamReader(location.openStream(), charset);
1570                         StringBuilder sb = new StringBuilder();
1571                         final int bufSize = 4096;
1572                         char[] charBuffer = new char[bufSize];
1573                         int n;
1574                         do {
<span class="line-modified">1575                             n = scriptReader.read(charBuffer,0,bufSize);</span>
<span class="line-modified">1576                             if (n &gt; 0) {</span>
<span class="line-modified">1577                                 sb.append(new String(charBuffer,0,n));</span>
1578                           }
1579                         } while (n &gt; -1);
1580                         script = sb.toString();
1581                     } catch (IOException exception) {
1582                         throw constructLoadException(exception);
1583                     } finally {
1584                         if (scriptReader != null) {
1585                             scriptReader.close();
1586                         }
1587                     }
1588                     try {
1589                         if (engine instanceof Compilable &amp;&amp; compileScript) {
1590                             CompiledScript compiledScript = null;
1591                             try {
1592                                 compiledScript=((Compilable) engine).compile(script);
1593                             } catch (ScriptException compileExc) {
<span class="line-modified">1594                                 Logging.getJavaFXLogger().warning(filename + &quot;: compiling caused \&quot;&quot; + compileExc +</span>
<span class="line-added">1595                                     &quot;\&quot;, falling back to evaluating script in uncompiled mode&quot;);</span>
1596                             }
1597                             if (compiledScript != null) {
<span class="line-modified">1598                                 compiledScript.eval();</span>
1599                             } else { // fallback to uncompiled mode
<span class="line-modified">1600                                 engine.eval(script);</span>
1601                             }
1602                         } else {
<span class="line-modified">1603                             engine.eval(script);</span>
1604                         }
1605                     } catch (ScriptException exception) {
<span class="line-modified">1606                         System.err.println(filename + &quot;: caused ScriptException&quot;);</span>
1607                         exception.printStackTrace();
1608                     }
1609                 }
1610                 catch (IOException exception) {
1611                   throw constructLoadException(exception);
1612                 }
1613             }
1614         }
1615 
1616         @Override
1617         public void processEndElement() throws IOException {
1618             super.processEndElement();
1619 
1620             if (value != null &amp;&amp; !staticLoad) {
1621                 // Evaluate the script
1622                 String filename = null;
1623                 try {
1624                     Bindings engineBindings = scriptEngine.getBindings(ScriptContext.ENGINE_SCOPE);
1625                     String script = (String) value;
1626                     filename = location.getPath() + &quot;-script_starting_at_line_&quot;
1627                                        + (getLineNumber() - (int) script.codePoints().filter(c -&gt; c == &#39;\n&#39;).count());
1628                     engineBindings.put(scriptEngine.FILENAME, filename);
1629                     if (scriptEngine instanceof Compilable &amp;&amp; compileScript) {
1630                         CompiledScript compiledScript = null;
1631                         try {
1632                             compiledScript=((Compilable) scriptEngine).compile(script);
1633                         } catch (ScriptException compileExc) {
<span class="line-modified">1634                             Logging.getJavaFXLogger().warning(filename + &quot;: compiling caused \&quot;&quot; + compileExc +</span>
<span class="line-added">1635                                 &quot;\&quot;, falling back to evaluating script in uncompiled mode&quot;);</span>
1636                         }
1637                         if (compiledScript != null) {
<span class="line-modified">1638                             compiledScript.eval();</span>
1639                         } else { // fallback to uncompiled mode
<span class="line-modified">1640                             scriptEngine.eval(script);</span>
1641                         }
1642                     } else {
<span class="line-modified">1643                         scriptEngine.eval(script);</span>
1644                     }
1645                 } catch (ScriptException exception) {
<span class="line-modified">1646                     System.err.println(filename + &quot;: caused ScriptException\n&quot; + exception.getMessage());</span>
1647                 }
1648             }
1649         }
1650 
1651         @Override
1652         public void processCharacters() throws LoadException {
1653             if (source != null) {
1654                 throw constructLoadException(&quot;Script source already specified.&quot;);
1655             }
1656 
1657             if (scriptEngine == null &amp;&amp; !staticLoad) {
1658                 throw constructLoadException(&quot;Page language not specified.&quot;);
1659             }
1660 
1661             updateValue(xmlStreamReader.getText());
1662         }
1663 
1664         @Override
1665         public void processAttribute(String prefix, String localName, String value)
1666             throws IOException {
</pre>
<hr />
<pre>
1726 
1727         @Override
1728         public void handle(T event) {
1729             handler.invoke(event);
1730         }
1731     }
1732 
1733     // Event handler implemented in script code
1734     private static class ScriptEventHandler implements EventHandler&lt;Event&gt; {
1735         public final String script;
1736         public final ScriptEngine scriptEngine;
1737         public final String filename;
1738         public CompiledScript compiledScript;
1739         public boolean isCompiled=false;
1740 
1741         public ScriptEventHandler(String script, ScriptEngine scriptEngine, String filename) {
1742             this.script = script;
1743             this.scriptEngine = scriptEngine;
1744             this.filename = filename;
1745             if (scriptEngine instanceof Compilable  &amp;&amp; compileScript) {
<span class="line-modified">1746                 try {</span>
<span class="line-modified">1747                     // supply the filename to the scriptEngine engine scope Bindings in case it is needed for compilation</span>
<span class="line-modified">1748                     scriptEngine.getBindings(ScriptContext.ENGINE_SCOPE).put(scriptEngine.FILENAME, filename);</span>
<span class="line-modified">1749                     this.compiledScript = ((Compilable) scriptEngine).compile(script);</span>
<span class="line-modified">1750                     this.isCompiled = true;</span>
<span class="line-modified">1751                 } catch (ScriptException compileExc) {</span>
<span class="line-modified">1752                     Logging.getJavaFXLogger().warning(filename + &quot;: compiling caused \&quot;&quot; + compileExc +</span>
<span class="line-modified">1753                         &quot;\&quot;, falling back to evaluating script in uncompiled mode&quot;);</span>
<span class="line-added">1754                 }</span>
1755             }
1756         }
1757 
1758         @Override
1759         public void handle(Event event) {
1760             // Don&#39;t pollute the page namespace with values defined in the script
1761             Bindings engineBindings = scriptEngine.getBindings(ScriptContext.ENGINE_SCOPE);
1762             Bindings localBindings = scriptEngine.createBindings();
1763             localBindings.putAll(engineBindings);
1764             localBindings.put(EVENT_KEY, event);
1765             localBindings.put(scriptEngine.ARGV, new Object[]{event});
1766             localBindings.put(scriptEngine.FILENAME, filename);
1767             // Execute the script
1768             try {
1769                 if (isCompiled) {
1770                    compiledScript.eval(localBindings);
1771                 } else {
1772                    scriptEngine.eval(script, localBindings);
1773                 }
<span class="line-modified">1774             } catch (ScriptException exception) {</span>
<span class="line-modified">1775                 throw new RuntimeException(filename + &quot;: caused ScriptException&quot;, exception);</span>
1776             }
1777         }
1778     }
1779 
1780     // Observable list change listener
1781     private static class ObservableListChangeAdapter implements ListChangeListener {
1782         private final MethodHandler handler;
1783 
1784         public ObservableListChangeAdapter(MethodHandler handler) {
1785             this.handler = handler;
1786         }
1787 
1788         @Override
1789         @SuppressWarnings(&quot;unchecked&quot;)
1790         public void onChanged(Change change) {
1791             if (handler != null) {
1792                 handler.invoke(change);
1793             }
1794         }
1795     }
</pre>
<hr />
<pre>
3620             final int untransformedAccess =
3621                     fullModifiers &amp; (Modifier.PRIVATE | Modifier.PROTECTED
3622                                                       | Modifier.PUBLIC);
3623 
3624             switch (untransformedAccess) {
3625                 case Modifier.PUBLIC:
3626                     return PUBLIC;
3627 
3628                 case Modifier.PROTECTED:
3629                     return PROTECTED;
3630 
3631                 case Modifier.PRIVATE:
3632                     return PRIVATE;
3633 
3634                 default:
3635                     return PACKAGE;
3636             }
3637         }
3638     }
3639 }


</pre>
</td>
</tr>
</table>
<center><a href="../../../docs/javafx/fxml/doc-files/introduction_to_fxml.html.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../tests/system/src/testscriptapp2/java/mymod/myapp2/FXMLScriptDeployment2Compile_Fail_Compilation.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>