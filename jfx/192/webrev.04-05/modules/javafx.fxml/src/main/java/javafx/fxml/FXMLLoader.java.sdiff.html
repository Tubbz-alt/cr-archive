<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.fxml/src/main/java/javafx/fxml/FXMLLoader.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../tests/system/src/test/java/test/launchertest/ModuleLauncherTest.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.fxml/src/main/java/javafx/fxml/FXMLLoader.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
1547                         + &quot; extension &quot; + extension + &quot;.&quot;);
1548                 }
1549 
1550                 try {
1551                     URL location;
1552                     if (source.charAt(0) == &#39;/&#39;) {
1553                         // FIXME: JIGSAW -- use Class.getResourceAsStream if resource is in a module
1554                         location = cl.getResource(source.substring(1));
1555                     } else {
1556                         if (FXMLLoader.this.location == null) {
1557                             throw constructLoadException(&quot;Base location is undefined.&quot;);
1558                         }
1559 
1560                         location = new URL(FXMLLoader.this.location, source);
1561                     }
1562                     Bindings engineBindings = engine.getBindings(ScriptContext.ENGINE_SCOPE);
1563                     String filename = location.getPath();
1564                     engineBindings.put(engine.FILENAME, filename);
1565 
1566                     InputStreamReader scriptReader = null;
<span class="line-modified">1567                     String script=null;</span>
1568                     try {
1569                         scriptReader = new InputStreamReader(location.openStream(), charset);
1570                         StringBuilder sb = new StringBuilder();
1571                         final int bufSize = 4096;
1572                         char[] charBuffer = new char[bufSize];
1573                         int n;
1574                         do {
1575                             n = scriptReader.read(charBuffer,0,bufSize);
1576                             if (n &gt; 0) {
1577                                 sb.append(new String(charBuffer,0,n));
1578                           }
1579                         } while (n &gt; -1);
1580                         script = sb.toString();
1581                     } catch (IOException exception) {
1582                         throw constructLoadException(exception);
1583                     } finally {
1584                         if (scriptReader != null) {
1585                             scriptReader.close();
1586                         }
1587                     }
1588                     try {
1589                         if (engine instanceof Compilable &amp;&amp; compileScript) {
1590                             CompiledScript compiledScript = null;
1591                             try {
<span class="line-modified">1592                                 compiledScript=((Compilable) engine).compile(script);</span>
1593                             } catch (ScriptException compileExc) {
1594                                 Logging.getJavaFXLogger().warning(filename + &quot;: compiling caused \&quot;&quot; + compileExc +
1595                                     &quot;\&quot;, falling back to evaluating script in uncompiled mode&quot;);
1596                             }
1597                             if (compiledScript != null) {
1598                                 compiledScript.eval();
1599                             } else { // fallback to uncompiled mode
1600                                 engine.eval(script);
1601                             }
1602                         } else {
1603                             engine.eval(script);
1604                         }
1605                     } catch (ScriptException exception) {
1606                         System.err.println(filename + &quot;: caused ScriptException&quot;);
1607                         exception.printStackTrace();
1608                     }
1609                 }
1610                 catch (IOException exception) {
1611                   throw constructLoadException(exception);
1612                 }
1613             }
1614         }
1615 
1616         @Override
1617         public void processEndElement() throws IOException {
1618             super.processEndElement();
1619 
1620             if (value != null &amp;&amp; !staticLoad) {
1621                 // Evaluate the script
1622                 String filename = null;
1623                 try {
1624                     Bindings engineBindings = scriptEngine.getBindings(ScriptContext.ENGINE_SCOPE);
1625                     String script = (String) value;
1626                     filename = location.getPath() + &quot;-script_starting_at_line_&quot;
1627                                        + (getLineNumber() - (int) script.codePoints().filter(c -&gt; c == &#39;\n&#39;).count());
1628                     engineBindings.put(scriptEngine.FILENAME, filename);
1629                     if (scriptEngine instanceof Compilable &amp;&amp; compileScript) {
1630                         CompiledScript compiledScript = null;
1631                         try {
<span class="line-modified">1632                             compiledScript=((Compilable) scriptEngine).compile(script);</span>
1633                         } catch (ScriptException compileExc) {
1634                             Logging.getJavaFXLogger().warning(filename + &quot;: compiling caused \&quot;&quot; + compileExc +
1635                                 &quot;\&quot;, falling back to evaluating script in uncompiled mode&quot;);
1636                         }
1637                         if (compiledScript != null) {
1638                             compiledScript.eval();
1639                         } else { // fallback to uncompiled mode
1640                             scriptEngine.eval(script);
1641                         }
1642                     } else {
1643                         scriptEngine.eval(script);
1644                     }
1645                 } catch (ScriptException exception) {
1646                     System.err.println(filename + &quot;: caused ScriptException\n&quot; + exception.getMessage());
1647                 }
1648             }
1649         }
1650 
1651         @Override
1652         public void processCharacters() throws LoadException {
</pre>
<hr />
<pre>
1719     // Event handler that delegates to a method defined by the controller object
1720     private static class ControllerMethodEventHandler&lt;T extends Event&gt; implements EventHandler&lt;T&gt; {
1721         private final MethodHandler handler;
1722 
1723         public ControllerMethodEventHandler(MethodHandler handler) {
1724             this.handler = handler;
1725         }
1726 
1727         @Override
1728         public void handle(T event) {
1729             handler.invoke(event);
1730         }
1731     }
1732 
1733     // Event handler implemented in script code
1734     private static class ScriptEventHandler implements EventHandler&lt;Event&gt; {
1735         public final String script;
1736         public final ScriptEngine scriptEngine;
1737         public final String filename;
1738         public CompiledScript compiledScript;
<span class="line-modified">1739         public boolean isCompiled=false;</span>
1740 
1741         public ScriptEventHandler(String script, ScriptEngine scriptEngine, String filename) {
1742             this.script = script;
1743             this.scriptEngine = scriptEngine;
1744             this.filename = filename;
1745             if (scriptEngine instanceof Compilable  &amp;&amp; compileScript) {
1746                 try {
1747                     // supply the filename to the scriptEngine engine scope Bindings in case it is needed for compilation
1748                     scriptEngine.getBindings(ScriptContext.ENGINE_SCOPE).put(scriptEngine.FILENAME, filename);
1749                     this.compiledScript = ((Compilable) scriptEngine).compile(script);
1750                     this.isCompiled = true;
1751                 } catch (ScriptException compileExc) {
1752                     Logging.getJavaFXLogger().warning(filename + &quot;: compiling caused \&quot;&quot; + compileExc +
1753                         &quot;\&quot;, falling back to evaluating script in uncompiled mode&quot;);
1754                 }
1755             }
1756         }
1757 
1758         @Override
1759         public void handle(Event event) {
</pre>
<hr />
<pre>
2740     ParseTraceElement[] getParseTrace() {
2741         ParseTraceElement[] parseTrace = new ParseTraceElement[loaders.size()];
2742 
2743         int i = 0;
2744         for (FXMLLoader loader : loaders) {
2745             parseTrace[i++] = new ParseTraceElement(loader.location, (loader.current != null) ?
2746                 loader.getLineNumber() : -1);
2747         }
2748 
2749         return parseTrace;
2750     }
2751 
2752     private void processProcessingInstruction() throws LoadException {
2753         String piTarget = xmlStreamReader.getPITarget().trim();
2754 
2755         if (piTarget.equals(LANGUAGE_PROCESSING_INSTRUCTION)) {
2756             processLanguage();
2757         } else if (piTarget.equals(IMPORT_PROCESSING_INSTRUCTION)) {
2758             processImport();
2759         } else if (piTarget.equals(COMPILE_PROCESSING_INSTRUCTION)) {
<span class="line-modified">2760             String strCompile=xmlStreamReader.getPIData().trim();</span>
2761             // if PIData() is empty string then default to true, otherwise use Boolean.parseBoolean(string) to determine the boolean value
<span class="line-modified">2762             compileScript = (strCompile.length()==0 ? true : Boolean.parseBoolean(strCompile));</span>
2763         }
2764     }
2765 
2766     private void processLanguage() throws LoadException {
2767         if (scriptEngine != null) {
2768             throw constructLoadException(&quot;Page language already set.&quot;);
2769         }
2770 
2771         String language = xmlStreamReader.getPIData();
2772 
2773         if (loadListener != null) {
2774             loadListener.readLanguageProcessingInstruction(language);
2775         }
2776 
2777         if (!staticLoad) {
2778             ScriptEngineManager scriptEngineManager = getScriptEngineManager();
2779             scriptEngine = scriptEngineManager.getEngineByName(language);
2780         }
2781     }
2782 
</pre>
</td>
<td>
<hr />
<pre>
1547                         + &quot; extension &quot; + extension + &quot;.&quot;);
1548                 }
1549 
1550                 try {
1551                     URL location;
1552                     if (source.charAt(0) == &#39;/&#39;) {
1553                         // FIXME: JIGSAW -- use Class.getResourceAsStream if resource is in a module
1554                         location = cl.getResource(source.substring(1));
1555                     } else {
1556                         if (FXMLLoader.this.location == null) {
1557                             throw constructLoadException(&quot;Base location is undefined.&quot;);
1558                         }
1559 
1560                         location = new URL(FXMLLoader.this.location, source);
1561                     }
1562                     Bindings engineBindings = engine.getBindings(ScriptContext.ENGINE_SCOPE);
1563                     String filename = location.getPath();
1564                     engineBindings.put(engine.FILENAME, filename);
1565 
1566                     InputStreamReader scriptReader = null;
<span class="line-modified">1567                     String script = null;</span>
1568                     try {
1569                         scriptReader = new InputStreamReader(location.openStream(), charset);
1570                         StringBuilder sb = new StringBuilder();
1571                         final int bufSize = 4096;
1572                         char[] charBuffer = new char[bufSize];
1573                         int n;
1574                         do {
1575                             n = scriptReader.read(charBuffer,0,bufSize);
1576                             if (n &gt; 0) {
1577                                 sb.append(new String(charBuffer,0,n));
1578                           }
1579                         } while (n &gt; -1);
1580                         script = sb.toString();
1581                     } catch (IOException exception) {
1582                         throw constructLoadException(exception);
1583                     } finally {
1584                         if (scriptReader != null) {
1585                             scriptReader.close();
1586                         }
1587                     }
1588                     try {
1589                         if (engine instanceof Compilable &amp;&amp; compileScript) {
1590                             CompiledScript compiledScript = null;
1591                             try {
<span class="line-modified">1592                                 compiledScript = ((Compilable) engine).compile(script);</span>
1593                             } catch (ScriptException compileExc) {
1594                                 Logging.getJavaFXLogger().warning(filename + &quot;: compiling caused \&quot;&quot; + compileExc +
1595                                     &quot;\&quot;, falling back to evaluating script in uncompiled mode&quot;);
1596                             }
1597                             if (compiledScript != null) {
1598                                 compiledScript.eval();
1599                             } else { // fallback to uncompiled mode
1600                                 engine.eval(script);
1601                             }
1602                         } else {
1603                             engine.eval(script);
1604                         }
1605                     } catch (ScriptException exception) {
1606                         System.err.println(filename + &quot;: caused ScriptException&quot;);
1607                         exception.printStackTrace();
1608                     }
1609                 }
1610                 catch (IOException exception) {
1611                   throw constructLoadException(exception);
1612                 }
1613             }
1614         }
1615 
1616         @Override
1617         public void processEndElement() throws IOException {
1618             super.processEndElement();
1619 
1620             if (value != null &amp;&amp; !staticLoad) {
1621                 // Evaluate the script
1622                 String filename = null;
1623                 try {
1624                     Bindings engineBindings = scriptEngine.getBindings(ScriptContext.ENGINE_SCOPE);
1625                     String script = (String) value;
1626                     filename = location.getPath() + &quot;-script_starting_at_line_&quot;
1627                                        + (getLineNumber() - (int) script.codePoints().filter(c -&gt; c == &#39;\n&#39;).count());
1628                     engineBindings.put(scriptEngine.FILENAME, filename);
1629                     if (scriptEngine instanceof Compilable &amp;&amp; compileScript) {
1630                         CompiledScript compiledScript = null;
1631                         try {
<span class="line-modified">1632                             compiledScript = ((Compilable) scriptEngine).compile(script);</span>
1633                         } catch (ScriptException compileExc) {
1634                             Logging.getJavaFXLogger().warning(filename + &quot;: compiling caused \&quot;&quot; + compileExc +
1635                                 &quot;\&quot;, falling back to evaluating script in uncompiled mode&quot;);
1636                         }
1637                         if (compiledScript != null) {
1638                             compiledScript.eval();
1639                         } else { // fallback to uncompiled mode
1640                             scriptEngine.eval(script);
1641                         }
1642                     } else {
1643                         scriptEngine.eval(script);
1644                     }
1645                 } catch (ScriptException exception) {
1646                     System.err.println(filename + &quot;: caused ScriptException\n&quot; + exception.getMessage());
1647                 }
1648             }
1649         }
1650 
1651         @Override
1652         public void processCharacters() throws LoadException {
</pre>
<hr />
<pre>
1719     // Event handler that delegates to a method defined by the controller object
1720     private static class ControllerMethodEventHandler&lt;T extends Event&gt; implements EventHandler&lt;T&gt; {
1721         private final MethodHandler handler;
1722 
1723         public ControllerMethodEventHandler(MethodHandler handler) {
1724             this.handler = handler;
1725         }
1726 
1727         @Override
1728         public void handle(T event) {
1729             handler.invoke(event);
1730         }
1731     }
1732 
1733     // Event handler implemented in script code
1734     private static class ScriptEventHandler implements EventHandler&lt;Event&gt; {
1735         public final String script;
1736         public final ScriptEngine scriptEngine;
1737         public final String filename;
1738         public CompiledScript compiledScript;
<span class="line-modified">1739         public boolean isCompiled = false;</span>
1740 
1741         public ScriptEventHandler(String script, ScriptEngine scriptEngine, String filename) {
1742             this.script = script;
1743             this.scriptEngine = scriptEngine;
1744             this.filename = filename;
1745             if (scriptEngine instanceof Compilable  &amp;&amp; compileScript) {
1746                 try {
1747                     // supply the filename to the scriptEngine engine scope Bindings in case it is needed for compilation
1748                     scriptEngine.getBindings(ScriptContext.ENGINE_SCOPE).put(scriptEngine.FILENAME, filename);
1749                     this.compiledScript = ((Compilable) scriptEngine).compile(script);
1750                     this.isCompiled = true;
1751                 } catch (ScriptException compileExc) {
1752                     Logging.getJavaFXLogger().warning(filename + &quot;: compiling caused \&quot;&quot; + compileExc +
1753                         &quot;\&quot;, falling back to evaluating script in uncompiled mode&quot;);
1754                 }
1755             }
1756         }
1757 
1758         @Override
1759         public void handle(Event event) {
</pre>
<hr />
<pre>
2740     ParseTraceElement[] getParseTrace() {
2741         ParseTraceElement[] parseTrace = new ParseTraceElement[loaders.size()];
2742 
2743         int i = 0;
2744         for (FXMLLoader loader : loaders) {
2745             parseTrace[i++] = new ParseTraceElement(loader.location, (loader.current != null) ?
2746                 loader.getLineNumber() : -1);
2747         }
2748 
2749         return parseTrace;
2750     }
2751 
2752     private void processProcessingInstruction() throws LoadException {
2753         String piTarget = xmlStreamReader.getPITarget().trim();
2754 
2755         if (piTarget.equals(LANGUAGE_PROCESSING_INSTRUCTION)) {
2756             processLanguage();
2757         } else if (piTarget.equals(IMPORT_PROCESSING_INSTRUCTION)) {
2758             processImport();
2759         } else if (piTarget.equals(COMPILE_PROCESSING_INSTRUCTION)) {
<span class="line-modified">2760             String strCompile = xmlStreamReader.getPIData().trim();</span>
2761             // if PIData() is empty string then default to true, otherwise use Boolean.parseBoolean(string) to determine the boolean value
<span class="line-modified">2762             compileScript = (strCompile.length() == 0 ? true : Boolean.parseBoolean(strCompile));</span>
2763         }
2764     }
2765 
2766     private void processLanguage() throws LoadException {
2767         if (scriptEngine != null) {
2768             throw constructLoadException(&quot;Page language already set.&quot;);
2769         }
2770 
2771         String language = xmlStreamReader.getPIData();
2772 
2773         if (loadListener != null) {
2774             loadListener.readLanguageProcessingInstruction(language);
2775         }
2776 
2777         if (!staticLoad) {
2778             ScriptEngineManager scriptEngineManager = getScriptEngineManager();
2779             scriptEngine = scriptEngineManager.getEngineByName(language);
2780         }
2781     }
2782 
</pre>
</td>
</tr>
</table>
<center>&lt; prev <a href="../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../tests/system/src/test/java/test/launchertest/ModuleLauncherTest.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>