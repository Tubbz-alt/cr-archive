<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.graphics/src/main/native-glass/mac/GlassDialogs.m</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="GlassApplication.m.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>modules/javafx.graphics/src/main/native-glass/mac/GlassDialogs.m</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 #import &quot;common.h&quot;
 27 #import &quot;com_sun_glass_ui_mac_MacCommonDialogs.h&quot;
 28 
 29 #import &quot;GlassMacros.h&quot;
 30 #import &quot;GlassDialogs.h&quot;
 31 #import &quot;GlassApplication.h&quot;
 32 #import &quot;GlassHelper.h&quot;
 33 
 34 //#define VERBOSE
 35 #ifndef VERBOSE
 36     #define LOG(MSG, ...)
 37 #else
 38     #define LOG(MSG, ...) GLASS_LOG(MSG, ## __VA_ARGS__);
 39 #endif
 40 
<span class="line-removed"> 41 static BOOL doPerformKeyEquivalent(NSEvent* theEvent, NSWindow* panel)</span>
<span class="line-removed"> 42 {</span>
<span class="line-removed"> 43     NSResponder* responder = [panel firstResponder];</span>
<span class="line-removed"> 44     if ([responder isKindOfClass:[NSText class]])</span>
<span class="line-removed"> 45     {</span>
<span class="line-removed"> 46         NSText* text = (NSText*)responder;</span>
<span class="line-removed"> 47         if ([theEvent type] == NSKeyDown</span>
<span class="line-removed"> 48             &amp;&amp; ([theEvent modifierFlags] &amp; NSDeviceIndependentModifierFlagsMask) == NSCommandKeyMask)</span>
<span class="line-removed"> 49         {</span>
<span class="line-removed"> 50             NSRange range = [text selectedRange];</span>
<span class="line-removed"> 51             BOOL hasSelectedText = range.length &gt; 0;</span>
<span class="line-removed"> 52             if ([theEvent keyCode] == 7 &amp;&amp; hasSelectedText) // Cmd + X - Cut</span>
<span class="line-removed"> 53             {</span>
<span class="line-removed"> 54                 [text cut:panel];</span>
<span class="line-removed"> 55                 return true;</span>
<span class="line-removed"> 56             }</span>
<span class="line-removed"> 57             if ([theEvent keyCode] == 8 &amp;&amp; hasSelectedText) // Cmd + C - Copy</span>
<span class="line-removed"> 58             {</span>
<span class="line-removed"> 59                 [text copy:panel];</span>
<span class="line-removed"> 60                 return true;</span>
<span class="line-removed"> 61             }</span>
<span class="line-removed"> 62             if ([theEvent keyCode] == 9) // Cmd + V - Paste</span>
<span class="line-removed"> 63             {</span>
<span class="line-removed"> 64                 [text paste:panel];</span>
<span class="line-removed"> 65                 return true;</span>
<span class="line-removed"> 66             }</span>
<span class="line-removed"> 67         }</span>
<span class="line-removed"> 68     }</span>
<span class="line-removed"> 69     return false;</span>
<span class="line-removed"> 70 }</span>
<span class="line-removed"> 71 </span>
<span class="line-removed"> 72 /*</span>
<span class="line-removed"> 73  * Function to determine whether or not to use raw NSPanel classes</span>
<span class="line-removed"> 74  * (either NSSavePanel or NSOpenPanel).</span>
<span class="line-removed"> 75  *</span>
<span class="line-removed"> 76  * Return: YES if we need to use the raw NSPanel classes; NO if we</span>
<span class="line-removed"> 77  * can use the Glass subclasses</span>
<span class="line-removed"> 78  */</span>
<span class="line-removed"> 79 static BOOL useNSPanel()</span>
<span class="line-removed"> 80 {</span>
<span class="line-removed"> 81     // As of macOS 10.15 all file dialogs are out of process, so we</span>
<span class="line-removed"> 82     // effectively can&#39;t subclass them.</span>
<span class="line-removed"> 83     if (@available(macOS 10.15, *)) {</span>
<span class="line-removed"> 84         return YES;</span>
<span class="line-removed"> 85     } else {</span>
<span class="line-removed"> 86         return [GlassApplication isSandboxed];</span>
<span class="line-removed"> 87     }</span>
<span class="line-removed"> 88 }</span>
<span class="line-removed"> 89 </span>
<span class="line-removed"> 90 @interface GlassSavePanel : NSSavePanel</span>
<span class="line-removed"> 91 @end</span>
<span class="line-removed"> 92 </span>
<span class="line-removed"> 93 @implementation GlassSavePanel</span>
<span class="line-removed"> 94 </span>
<span class="line-removed"> 95 - (BOOL)performKeyEquivalent:(NSEvent *)theEvent</span>
<span class="line-removed"> 96 {</span>
<span class="line-removed"> 97     if (doPerformKeyEquivalent(theEvent, self)) {</span>
<span class="line-removed"> 98         return true;</span>
<span class="line-removed"> 99     }</span>
<span class="line-removed">100     return [super performKeyEquivalent:theEvent];</span>
<span class="line-removed">101 }</span>
<span class="line-removed">102 @end</span>
<span class="line-removed">103 </span>
<span class="line-removed">104 @interface GlassOpenPanel : NSOpenPanel</span>
<span class="line-removed">105 @end</span>
<span class="line-removed">106 </span>
<span class="line-removed">107 @implementation GlassOpenPanel</span>
<span class="line-removed">108 </span>
<span class="line-removed">109 - (BOOL)performKeyEquivalent:(NSEvent *)theEvent</span>
<span class="line-removed">110 {</span>
<span class="line-removed">111     if (doPerformKeyEquivalent(theEvent, self)) {</span>
<span class="line-removed">112         return true;</span>
<span class="line-removed">113     }</span>
<span class="line-removed">114     return [super performKeyEquivalent:theEvent];</span>
<span class="line-removed">115 }</span>
<span class="line-removed">116 @end</span>
<span class="line-removed">117 </span>
<span class="line-removed">118 </span>
119 #pragma mark --- Dispatcher
120 
121 @interface DialogDispatcher : NSObject
122 {
123     NSSavePanel *panel;
124     NSWindow    *owner;
125     NSInteger    button;
126     jobject      eventLoop;
127     NSArray     *m_filters;
128 }
129 
130 - initWithPanel:(NSSavePanel*)panel owner:(NSWindow*)owner;
131 - (void)runModally;
132 - (NSInteger)getButton;
133 
134 - (void)applyExtensions:(jobjectArray)jExtensionFilters withDefaultIndex:(jint)index withEnv:(JNIEnv*)env;
135 - (void)extensionFilterChanged:(NSPopUpButton*)sender;
136 @end
137 
138 @implementation DialogDispatcher
</pre>
<hr />
<pre>
486         return;
487     }
488     javaIDs.FileChooserResult.init = (*env)-&gt;GetMethodID(env, cls, &quot;&lt;init&gt;&quot;, &quot;(Ljava/util/List;Lcom/sun/glass/ui/CommonDialogs$ExtensionFilter;)V&quot;);
489 }
490 
491 /*
492  * Class:     com_sun_glass_ui_mac_MacCommonDialogs
493  * Method:    _showFileOpenChooser
494  * Signature: (JLjava/lang/String;Ljava/lang/String;Z[Lcom/sun/glass/ui/CommonDialogs$ExtensionFilter;I)Lcom.sun.glass.ui.CommonDialogs$FileChooserResult;
495  */
496 JNIEXPORT jobject JNICALL Java_com_sun_glass_ui_mac_MacCommonDialogs__1showFileOpenChooser
497 (JNIEnv *env, jclass cls, jlong owner, jstring jFolder, jstring jTitle, jboolean jMultipleMode, jobjectArray jExtensionFilters, jint defaultIndex)
498 {
499     LOG(&quot;Java_com_sun_glass_ui_mac_MacCommonDialogs__1showFileOpenChooser&quot;);
500 
501     jobject result = NULL;
502 
503     GLASS_ASSERT_MAIN_JAVA_THREAD(env);
504     GLASS_POOL_ENTER;
505     {
<span class="line-modified">506         NSOpenPanel *panel = useNSPanel() ? [NSOpenPanel openPanel] : [GlassOpenPanel openPanel];</span>
507         [panel setAllowsMultipleSelection:(jMultipleMode==JNI_TRUE)];
508         [panel setTitle:[GlassHelper nsStringWithJavaString:jTitle withEnv:env]];
509         NSString *folder = [GlassHelper nsStringWithJavaString:jFolder withEnv:env];
510         if ([folder length] &gt; 0)
511         {
512             [panel setDirectoryURL:[NSURL fileURLWithPath:folder isDirectory:YES]];
513         }
514 
515         [panel setResolvesAliases:YES];
516         [panel setCanChooseFiles:YES];
517         [panel setCanChooseDirectories:NO];
518         [panel setShowsHiddenFiles:YES];
519         [panel setExtensionHidden:NO];
520         [panel setCanSelectHiddenExtension:YES];
521         [panel setAllowsOtherFileTypes:NO];
522         [panel setCanCreateDirectories:NO];
523 
524         jobject chosenFiles = NULL;
525         jobject chosenFilter = NULL;
526 
</pre>
<hr />
<pre>
562     GLASS_CHECK_EXCEPTION(env);
563 
564     return result;
565 }
566 
567 /*
568  * Class:     com_sun_glass_ui_mac_MacCommonDialogs
569  * Method:    _showFileSaveChooser
570  * Signature: (JLjava/lang/String;Ljava/lang/String;Ljava/lang/String;[Lcom/sun/glass/ui/CommonDialogs$ExtensionFilter;I)Lcom.sun.glass.ui.CommonDialogs$FileChooserResult;
571  */
572 JNIEXPORT jobject JNICALL Java_com_sun_glass_ui_mac_MacCommonDialogs__1showFileSaveChooser
573 (JNIEnv *env, jclass cls, jlong owner, jstring jFolder, jstring jFilename, jstring jTitle, jobjectArray jExtensionFilters, jint defaultIndex)
574 {
575     LOG(&quot;Java_com_sun_glass_ui_mac_MacCommonDialogs__1showFileSaveChooser&quot;);
576 
577     jobject result = NULL;
578 
579     GLASS_ASSERT_MAIN_JAVA_THREAD(env);
580     GLASS_POOL_ENTER;
581     {
<span class="line-modified">582         NSSavePanel *panel = useNSPanel() ? [NSSavePanel savePanel] : [GlassSavePanel savePanel];</span>
583         [panel setTitle:[GlassHelper nsStringWithJavaString:jTitle withEnv:env]];
584         NSString *folder = [GlassHelper nsStringWithJavaString:jFolder withEnv:env];
585         if ([folder length] &gt; 0)
586         {
587             [panel setDirectoryURL:[NSURL fileURLWithPath:folder isDirectory:YES]];
588         }
589 
590         NSString *filename = [GlassHelper nsStringWithJavaString:jFilename withEnv:env];
591         if ([filename length] &gt; 0) {
592             [panel setNameFieldStringValue:filename];
593         }
594 
595         [panel setShowsHiddenFiles:YES];
596         [panel setExtensionHidden:NO];
597         [panel setCanSelectHiddenExtension:YES];
598         [panel setAllowsOtherFileTypes:NO];
599         [panel setCanCreateDirectories:YES];
600 
601         jobject chosenFile = NULL;
602         jobject chosenFilter = NULL;
</pre>
<hr />
<pre>
634     GLASS_CHECK_EXCEPTION(env);
635 
636     return result;
637 }
638 
639 /*
640  * Class:     com_sun_glass_ui_mac_MacCommonDialogs
641  * Method:    _showFolderChooser
642  * Signature: (JLjava/lang/String;Ljava/lang/String;)Ljava/io/File;
643  */
644 JNIEXPORT jobject JNICALL Java_com_sun_glass_ui_mac_MacCommonDialogs__1showFolderChooser
645 (JNIEnv *env, jclass cls, jlong owner, jstring jFolder, jstring jTitle)
646 {
647     LOG(&quot;Java_com_sun_glass_ui_mac_MacCommonDialogs__1showFolderChooser&quot;);
648 
649     jobject chosen = NULL;
650 
651     GLASS_ASSERT_MAIN_JAVA_THREAD(env);
652     GLASS_POOL_ENTER;
653     {
<span class="line-modified">654         NSOpenPanel *panel = useNSPanel() ? [NSOpenPanel openPanel] : [GlassOpenPanel openPanel];</span>
655         [panel setTitle:[GlassHelper nsStringWithJavaString:jTitle withEnv:env]];
656         NSString *folder = [GlassHelper nsStringWithJavaString:jFolder withEnv:env];
657         if ([folder length] &gt; 0)
658         {
659             [panel setDirectoryURL:[NSURL fileURLWithPath:folder isDirectory:YES]];
660         }
661 
662         [panel setAllowsMultipleSelection:NO];
663         [panel setResolvesAliases:YES];
664         [panel setCanChooseFiles:NO];
665         [panel setCanChooseDirectories:YES];
666         [panel setShowsHiddenFiles:NO];
667         [panel setExtensionHidden:YES];
668         [panel setCanSelectHiddenExtension:NO];
669         [panel setAllowsOtherFileTypes:NO];
670         [panel setCanCreateDirectories:YES];
671 
672         DialogDispatcher *dispatcher = [[DialogDispatcher alloc] initWithPanel:panel owner:(NSWindow*)jlong_to_ptr(owner)];
673         {
674             [dispatcher performSelectorOnMainThread:@selector(runModally) withObject:panel waitUntilDone:YES];
</pre>
</td>
<td>
<hr />
<pre>
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 #import &quot;common.h&quot;
 27 #import &quot;com_sun_glass_ui_mac_MacCommonDialogs.h&quot;
 28 
 29 #import &quot;GlassMacros.h&quot;
 30 #import &quot;GlassDialogs.h&quot;
 31 #import &quot;GlassApplication.h&quot;
 32 #import &quot;GlassHelper.h&quot;
 33 
 34 //#define VERBOSE
 35 #ifndef VERBOSE
 36     #define LOG(MSG, ...)
 37 #else
 38     #define LOG(MSG, ...) GLASS_LOG(MSG, ## __VA_ARGS__);
 39 #endif
 40 














































































 41 #pragma mark --- Dispatcher
 42 
 43 @interface DialogDispatcher : NSObject
 44 {
 45     NSSavePanel *panel;
 46     NSWindow    *owner;
 47     NSInteger    button;
 48     jobject      eventLoop;
 49     NSArray     *m_filters;
 50 }
 51 
 52 - initWithPanel:(NSSavePanel*)panel owner:(NSWindow*)owner;
 53 - (void)runModally;
 54 - (NSInteger)getButton;
 55 
 56 - (void)applyExtensions:(jobjectArray)jExtensionFilters withDefaultIndex:(jint)index withEnv:(JNIEnv*)env;
 57 - (void)extensionFilterChanged:(NSPopUpButton*)sender;
 58 @end
 59 
 60 @implementation DialogDispatcher
</pre>
<hr />
<pre>
408         return;
409     }
410     javaIDs.FileChooserResult.init = (*env)-&gt;GetMethodID(env, cls, &quot;&lt;init&gt;&quot;, &quot;(Ljava/util/List;Lcom/sun/glass/ui/CommonDialogs$ExtensionFilter;)V&quot;);
411 }
412 
413 /*
414  * Class:     com_sun_glass_ui_mac_MacCommonDialogs
415  * Method:    _showFileOpenChooser
416  * Signature: (JLjava/lang/String;Ljava/lang/String;Z[Lcom/sun/glass/ui/CommonDialogs$ExtensionFilter;I)Lcom.sun.glass.ui.CommonDialogs$FileChooserResult;
417  */
418 JNIEXPORT jobject JNICALL Java_com_sun_glass_ui_mac_MacCommonDialogs__1showFileOpenChooser
419 (JNIEnv *env, jclass cls, jlong owner, jstring jFolder, jstring jTitle, jboolean jMultipleMode, jobjectArray jExtensionFilters, jint defaultIndex)
420 {
421     LOG(&quot;Java_com_sun_glass_ui_mac_MacCommonDialogs__1showFileOpenChooser&quot;);
422 
423     jobject result = NULL;
424 
425     GLASS_ASSERT_MAIN_JAVA_THREAD(env);
426     GLASS_POOL_ENTER;
427     {
<span class="line-modified">428         NSOpenPanel *panel = [NSOpenPanel openPanel];</span>
429         [panel setAllowsMultipleSelection:(jMultipleMode==JNI_TRUE)];
430         [panel setTitle:[GlassHelper nsStringWithJavaString:jTitle withEnv:env]];
431         NSString *folder = [GlassHelper nsStringWithJavaString:jFolder withEnv:env];
432         if ([folder length] &gt; 0)
433         {
434             [panel setDirectoryURL:[NSURL fileURLWithPath:folder isDirectory:YES]];
435         }
436 
437         [panel setResolvesAliases:YES];
438         [panel setCanChooseFiles:YES];
439         [panel setCanChooseDirectories:NO];
440         [panel setShowsHiddenFiles:YES];
441         [panel setExtensionHidden:NO];
442         [panel setCanSelectHiddenExtension:YES];
443         [panel setAllowsOtherFileTypes:NO];
444         [panel setCanCreateDirectories:NO];
445 
446         jobject chosenFiles = NULL;
447         jobject chosenFilter = NULL;
448 
</pre>
<hr />
<pre>
484     GLASS_CHECK_EXCEPTION(env);
485 
486     return result;
487 }
488 
489 /*
490  * Class:     com_sun_glass_ui_mac_MacCommonDialogs
491  * Method:    _showFileSaveChooser
492  * Signature: (JLjava/lang/String;Ljava/lang/String;Ljava/lang/String;[Lcom/sun/glass/ui/CommonDialogs$ExtensionFilter;I)Lcom.sun.glass.ui.CommonDialogs$FileChooserResult;
493  */
494 JNIEXPORT jobject JNICALL Java_com_sun_glass_ui_mac_MacCommonDialogs__1showFileSaveChooser
495 (JNIEnv *env, jclass cls, jlong owner, jstring jFolder, jstring jFilename, jstring jTitle, jobjectArray jExtensionFilters, jint defaultIndex)
496 {
497     LOG(&quot;Java_com_sun_glass_ui_mac_MacCommonDialogs__1showFileSaveChooser&quot;);
498 
499     jobject result = NULL;
500 
501     GLASS_ASSERT_MAIN_JAVA_THREAD(env);
502     GLASS_POOL_ENTER;
503     {
<span class="line-modified">504         NSSavePanel *panel = [NSSavePanel savePanel];</span>
505         [panel setTitle:[GlassHelper nsStringWithJavaString:jTitle withEnv:env]];
506         NSString *folder = [GlassHelper nsStringWithJavaString:jFolder withEnv:env];
507         if ([folder length] &gt; 0)
508         {
509             [panel setDirectoryURL:[NSURL fileURLWithPath:folder isDirectory:YES]];
510         }
511 
512         NSString *filename = [GlassHelper nsStringWithJavaString:jFilename withEnv:env];
513         if ([filename length] &gt; 0) {
514             [panel setNameFieldStringValue:filename];
515         }
516 
517         [panel setShowsHiddenFiles:YES];
518         [panel setExtensionHidden:NO];
519         [panel setCanSelectHiddenExtension:YES];
520         [panel setAllowsOtherFileTypes:NO];
521         [panel setCanCreateDirectories:YES];
522 
523         jobject chosenFile = NULL;
524         jobject chosenFilter = NULL;
</pre>
<hr />
<pre>
556     GLASS_CHECK_EXCEPTION(env);
557 
558     return result;
559 }
560 
561 /*
562  * Class:     com_sun_glass_ui_mac_MacCommonDialogs
563  * Method:    _showFolderChooser
564  * Signature: (JLjava/lang/String;Ljava/lang/String;)Ljava/io/File;
565  */
566 JNIEXPORT jobject JNICALL Java_com_sun_glass_ui_mac_MacCommonDialogs__1showFolderChooser
567 (JNIEnv *env, jclass cls, jlong owner, jstring jFolder, jstring jTitle)
568 {
569     LOG(&quot;Java_com_sun_glass_ui_mac_MacCommonDialogs__1showFolderChooser&quot;);
570 
571     jobject chosen = NULL;
572 
573     GLASS_ASSERT_MAIN_JAVA_THREAD(env);
574     GLASS_POOL_ENTER;
575     {
<span class="line-modified">576         NSOpenPanel *panel = [NSOpenPanel openPanel];</span>
577         [panel setTitle:[GlassHelper nsStringWithJavaString:jTitle withEnv:env]];
578         NSString *folder = [GlassHelper nsStringWithJavaString:jFolder withEnv:env];
579         if ([folder length] &gt; 0)
580         {
581             [panel setDirectoryURL:[NSURL fileURLWithPath:folder isDirectory:YES]];
582         }
583 
584         [panel setAllowsMultipleSelection:NO];
585         [panel setResolvesAliases:YES];
586         [panel setCanChooseFiles:NO];
587         [panel setCanChooseDirectories:YES];
588         [panel setShowsHiddenFiles:NO];
589         [panel setExtensionHidden:YES];
590         [panel setCanSelectHiddenExtension:NO];
591         [panel setAllowsOtherFileTypes:NO];
592         [panel setCanCreateDirectories:YES];
593 
594         DialogDispatcher *dispatcher = [[DialogDispatcher alloc] initWithPanel:panel owner:(NSWindow*)jlong_to_ptr(owner)];
595         {
596             [dispatcher performSelectorOnMainThread:@selector(runModally) withObject:panel waitUntilDone:YES];
</pre>
</td>
</tr>
</table>
<center><a href="GlassApplication.m.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>