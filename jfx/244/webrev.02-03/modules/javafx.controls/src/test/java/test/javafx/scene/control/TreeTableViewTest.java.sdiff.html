<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.controls/src/test/java/test/javafx/scene/control/TreeTableViewTest.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../main/java/javafx/scene/control/TreeTableView.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>modules/javafx.controls/src/test/java/test/javafx/scene/control/TreeTableViewTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 357         col.setSortType(ASCENDING);
 358         col.setCellValueFactory(param -&gt; new ReadOnlyObjectWrapper&lt;String&gt;(param.getValue().getValue()));
 359         treeTableView.getColumns().add(col);
 360 
 361         TreeItem&lt;String&gt; newRoot = new TreeItem&lt;String&gt;(&quot;root&quot;);
 362         newRoot.setExpanded(true);
 363         newRoot.getChildren().addAll(
 364                 apple  = new TreeItem(&quot;Apple&quot;),
 365                 orange = new TreeItem(&quot;Orange&quot;),
 366                 banana = new TreeItem(&quot;Banana&quot;));
 367 
 368         treeTableView.setRoot(newRoot);
 369 
 370         return col;
 371     }
 372 
 373     private int countSelectedIndexChangeEvent;
 374     private int countSelectedItemChangeEvent;
 375     private int countSelectedIndicesChangeEvent;
 376     private int countSelectedItemsChangeEvent;
<span class="line-modified"> 377     private TreeItem&lt;String&gt; selectedItem;</span>
<span class="line-modified"> 378     private List&lt;TreeTablePosition&lt;String,?&gt;&gt; selectedCellsBeforePermutation;</span>


 379 
 380     @Test public void testSelectionUpdatesCorrectlyAfterSort() {
<span class="line-modified"> 381         TreeTableColumn&lt;String, String&gt; col = initSortTestStructure();</span>
<span class="line-removed"> 382         setupForPermutationTest();</span>
<span class="line-removed"> 383         VirtualFlowTestUtils.assertListContainsItemsInOrder(treeTableView.getRoot().getChildren(), apple, orange, banana);</span>
 384         treeTableView.getSortOrder().add(col);
<span class="line-removed"> 385         VirtualFlowTestUtils.assertListContainsItemsInOrder(treeTableView.getRoot().getChildren(), apple, banana, orange);</span>
 386         verifySelectionAfterPermutation();
 387     }
 388 
 389     @Test public void testSelectionUpdatesCorrectlyAfterRootSetAll() {
<span class="line-removed"> 390         initSortTestStructure();</span>
 391         setupForPermutationTest();
<span class="line-modified"> 392         treeTableView.getRoot().getChildren().setAll(banana, apple, orange);</span>
 393         verifySelectionAfterPermutation();
 394     }
 395 
 396     @Test public void testSelectionUpdatesCorrectlyAfterChildSetAll() {
<span class="line-removed"> 397         initSortTestStructure();</span>
 398         setupForPermutationTest();
<span class="line-modified"> 399         banana.getChildren().setAll(banana.getChildren().get(2), banana.getChildren().get(0), banana.getChildren().get(1));</span>
 400         verifySelectionAfterPermutation();
 401     }
 402 
<span class="line-modified"> 403     private void setupForPermutationTest() {</span>









 404         countSelectedIndexChangeEvent = 0;
 405         countSelectedItemChangeEvent = 0;
 406         countSelectedIndicesChangeEvent = 0;
 407         countSelectedItemsChangeEvent = 0;
 408 
<span class="line-modified"> 409         apple.getChildren().addAll(new TreeItem(&quot;Apple3&quot;), new TreeItem(&quot;Apple2&quot;), new TreeItem(&quot;Apple1&quot;));</span>
<span class="line-modified"> 410         apple.setExpanded(true);</span>
<span class="line-modified"> 411         orange.getChildren().addAll(new TreeItem(&quot;Orange3&quot;), new TreeItem(&quot;Orange2&quot;), new TreeItem(&quot;Orange1&quot;));</span>
<span class="line-modified"> 412         orange.setExpanded(true);</span>
<span class="line-modified"> 413         banana.getChildren().addAll(new TreeItem(&quot;Banana3&quot;), new TreeItem(&quot;Banana2&quot;), new TreeItem(&quot;Banana1&quot;));</span>
<span class="line-modified"> 414         banana.setExpanded(true);</span>
































 415 
 416         sm.setSelectionMode(SelectionMode.MULTIPLE);
<span class="line-modified"> 417         sm.selectIndices(2, 5, 8, 10);</span>

 418 
 419         // Sanity checks
<span class="line-modified"> 420         assertEquals(4, sm.getSelectedIndices().size());</span>
<span class="line-modified"> 421         assertEquals(10, sm.getSelectedIndex());</span>
<span class="line-modified"> 422         assertEquals(treeTableView.getTreeItem(10), sm.getSelectedItem());</span>


 423 
<span class="line-modified"> 424         selectedItem = (TreeItem&lt;String&gt;) sm.getSelectedItem();</span>
<span class="line-modified"> 425         selectedCellsBeforePermutation = new ArrayList&lt;&gt;(sm.getSelectedCells());</span>


 426 
 427         sm.selectedIndexProperty().addListener(ov -&gt; {
 428             countSelectedIndexChangeEvent++;

 429         });
 430         sm.selectedItemProperty().addListener(l -&gt; {
 431             countSelectedItemChangeEvent++;
 432         });
 433         sm.getSelectedIndices().addListener((ListChangeListener) c -&gt; {
 434             countSelectedIndicesChangeEvent++;






 435         });
 436         sm.getSelectedItems().addListener((ListChangeListener) c -&gt; {
 437             countSelectedItemsChangeEvent++;






 438         });


 439     }
 440 
<span class="line-modified"> 441     private void verifySelectionAfterPermutation() {</span>
<span class="line-modified"> 442         assertEquals(&quot;Selected index should be updated&quot;, treeTableView.getRow(selectedItem), sm.getSelectedIndex());</span>
<span class="line-modified"> 443         assertEquals(&quot;Selected Item should remain same&quot;, selectedItem, sm.getSelectedItem());</span>
<span class="line-removed"> 444 </span>
<span class="line-removed"> 445         final List&lt;TreeTablePosition&lt;String,?&gt;&gt; selectedCellsAfterPermutation =</span>
<span class="line-removed"> 446                 new ArrayList&lt;&gt;(sm.getSelectedCells());</span>
<span class="line-removed"> 447         assertEquals(&quot;The number of selected items before and after permutation, should remain same&quot;,</span>
<span class="line-removed"> 448                 selectedCellsBeforePermutation.size(), selectedCellsAfterPermutation.size());</span>
<span class="line-removed"> 449         // Verify that the cells that were selected before permutation,</span>
<span class="line-removed"> 450         // remain selected after permutation.</span>
<span class="line-removed"> 451         for (TreeTablePosition beforePos : selectedCellsBeforePermutation) {</span>
 452             boolean isCellStillSelected = false;
<span class="line-modified"> 453             for (TreeTablePosition afterPos : selectedCellsAfterPermutation) {</span>
 454                 if ((beforePos.getTreeItem() == afterPos.getTreeItem()) &amp;&amp;
 455                         (beforePos.getTableColumn() == afterPos.getTableColumn()) &amp;&amp;
 456                         (beforePos.getColumn() == afterPos.getColumn())) {
 457                     isCellStillSelected = true;
 458                 }
 459             }
 460             assertTrue(&quot;The item (&quot; + beforePos.getRow() + &quot;, &quot; + beforePos.getColumn() +
 461                     &quot;) lost selection during permutation&quot;, isCellStillSelected);
 462         }


















 463         assertEquals(1, countSelectedIndexChangeEvent);
 464         assertEquals(0, countSelectedItemChangeEvent);
 465         assertEquals(1, countSelectedIndicesChangeEvent);
 466         assertEquals(1, countSelectedItemsChangeEvent);







 467     }
 468 
 469     @Ignore(&quot;This test is only valid if sort event consumption should revert changes&quot;)
 470     @Test public void testSortEventCanBeConsumedToStopSortOccurring_changeSortOrderList() {
 471         TreeTableColumn&lt;String, String&gt; col = initSortTestStructure();
 472         treeTableView.setOnSort(event -&gt; {
 473             event.consume();
 474         });
 475 
 476         VirtualFlowTestUtils.assertListContainsItemsInOrder(treeTableView.getRoot().getChildren(), apple, orange, banana);
 477         treeTableView.getSortOrder().add(col);
 478         VirtualFlowTestUtils.assertListContainsItemsInOrder(treeTableView.getRoot().getChildren(), apple, orange, banana);
 479 
 480         // the sort order list should be returned back to its original state
 481         assertTrue(treeTableView.getSortOrder().isEmpty());
 482     }
 483 
 484     @Test public void testSortEventCanBeNotConsumedToAllowSortToOccur_changeSortOrderList() {
 485         TreeTableColumn&lt;String, String&gt; col = initSortTestStructure();
 486         treeTableView.setOnSort(event -&gt; {
</pre>
</td>
<td>
<hr />
<pre>
 357         col.setSortType(ASCENDING);
 358         col.setCellValueFactory(param -&gt; new ReadOnlyObjectWrapper&lt;String&gt;(param.getValue().getValue()));
 359         treeTableView.getColumns().add(col);
 360 
 361         TreeItem&lt;String&gt; newRoot = new TreeItem&lt;String&gt;(&quot;root&quot;);
 362         newRoot.setExpanded(true);
 363         newRoot.getChildren().addAll(
 364                 apple  = new TreeItem(&quot;Apple&quot;),
 365                 orange = new TreeItem(&quot;Orange&quot;),
 366                 banana = new TreeItem(&quot;Banana&quot;));
 367 
 368         treeTableView.setRoot(newRoot);
 369 
 370         return col;
 371     }
 372 
 373     private int countSelectedIndexChangeEvent;
 374     private int countSelectedItemChangeEvent;
 375     private int countSelectedIndicesChangeEvent;
 376     private int countSelectedItemsChangeEvent;
<span class="line-modified"> 377     private TreeItem&lt;String&gt; selectedItemBefore;</span>
<span class="line-modified"> 378     private List&lt;TreeItem&lt;String&gt;&gt; selectedItemsBefore;</span>
<span class="line-added"> 379     private List&lt;Integer&gt; selectedIndicesBefore;</span>
<span class="line-added"> 380     private List&lt;TreeTablePosition&lt;String,?&gt;&gt; selectedCellsBefore;</span>
 381 
 382     @Test public void testSelectionUpdatesCorrectlyAfterSort() {
<span class="line-modified"> 383         TreeTableColumn&lt;String, String&gt; col = setupForPermutationTest();</span>


 384         treeTableView.getSortOrder().add(col);

 385         verifySelectionAfterPermutation();
 386     }
 387 
 388     @Test public void testSelectionUpdatesCorrectlyAfterRootSetAll() {

 389         setupForPermutationTest();
<span class="line-modified"> 390         reverseChildrenOrder(treeTableView.getRoot());</span>
 391         verifySelectionAfterPermutation();
 392     }
 393 
 394     @Test public void testSelectionUpdatesCorrectlyAfterChildSetAll() {

 395         setupForPermutationTest();
<span class="line-modified"> 396         reverseChildrenOrder(((TreeItem&lt;String&gt;)sm.getSelectedItem()).getParent());</span>
 397         verifySelectionAfterPermutation();
 398     }
 399 
<span class="line-modified"> 400     private void reverseChildrenOrder(TreeItem&lt;String&gt; treeItem) {</span>
<span class="line-added"> 401         List&lt;TreeItem&lt;String&gt;&gt; childrenReversed = new ArrayList&lt;&gt;();</span>
<span class="line-added"> 402         int childrenSize = treeItem.getChildren().size();</span>
<span class="line-added"> 403         for (int i = 0; i &lt; childrenSize; i++) {</span>
<span class="line-added"> 404             childrenReversed.add(treeItem.getChildren().get(childrenSize - 1 - i));</span>
<span class="line-added"> 405         }</span>
<span class="line-added"> 406         treeItem.getChildren().setAll(childrenReversed);</span>
<span class="line-added"> 407     }</span>
<span class="line-added"> 408 </span>
<span class="line-added"> 409     private TreeTableColumn&lt;String, String&gt; setupForPermutationTest() {</span>
 410         countSelectedIndexChangeEvent = 0;
 411         countSelectedItemChangeEvent = 0;
 412         countSelectedIndicesChangeEvent = 0;
 413         countSelectedItemsChangeEvent = 0;
 414 
<span class="line-modified"> 415         TreeTableColumn&lt;String, String&gt; col = new TreeTableColumn&lt;String, String&gt;(&quot;column&quot;);</span>
<span class="line-modified"> 416         col.setSortType(DESCENDING);</span>
<span class="line-modified"> 417         col.setCellValueFactory(param -&gt; new ReadOnlyObjectWrapper&lt;String&gt;(param.getValue().getValue()));</span>
<span class="line-modified"> 418         treeTableView.getColumns().add(col);</span>
<span class="line-modified"> 419 </span>
<span class="line-modified"> 420         TreeItem&lt;String&gt; treeRoot = new TreeItem&lt;String&gt;(&quot;root&quot;);</span>
<span class="line-added"> 421         treeRoot.setExpanded(true);</span>
<span class="line-added"> 422         treeTableView.setRoot(treeRoot);</span>
<span class="line-added"> 423 </span>
<span class="line-added"> 424         final int FIRST_LEVEL_COUNT = 8;</span>
<span class="line-added"> 425         for (int i = 0; i &lt; FIRST_LEVEL_COUNT; i++) {</span>
<span class="line-added"> 426             TreeItem&lt;String&gt; ti = new TreeItem&lt;&gt;( &quot;&quot; + i);</span>
<span class="line-added"> 427             ti.setExpanded(true);</span>
<span class="line-added"> 428             treeRoot.getChildren().add(ti);</span>
<span class="line-added"> 429 </span>
<span class="line-added"> 430             for (int j = 0; j &lt; FIRST_LEVEL_COUNT - 1; j++) {</span>
<span class="line-added"> 431                 TreeItem&lt;String&gt; tj = new TreeItem&lt;&gt;(&quot;&quot; + i + j);</span>
<span class="line-added"> 432                 tj.setExpanded(true);</span>
<span class="line-added"> 433                 ti.getChildren().add(tj);</span>
<span class="line-added"> 434 </span>
<span class="line-added"> 435                 for (int k = 0; k &lt; FIRST_LEVEL_COUNT - 2; k++) {</span>
<span class="line-added"> 436                     TreeItem&lt;String&gt; tk = new TreeItem&lt;&gt;(&quot;&quot; + i + j + k);</span>
<span class="line-added"> 437                     tk.setExpanded(true);</span>
<span class="line-added"> 438                     tj.getChildren().add(tk);</span>
<span class="line-added"> 439 </span>
<span class="line-added"> 440                     for (int l = 0; l &lt; FIRST_LEVEL_COUNT - 3; l++) {</span>
<span class="line-added"> 441                         TreeItem&lt;String&gt; tl = new TreeItem&lt;&gt;(&quot;&quot; + i + j + k + l);</span>
<span class="line-added"> 442                         tl.setExpanded(true);</span>
<span class="line-added"> 443                         tk.getChildren().add(tl);</span>
<span class="line-added"> 444 </span>
<span class="line-added"> 445                         for (int m = 0; m &lt; FIRST_LEVEL_COUNT - 4; m++) {</span>
<span class="line-added"> 446                             TreeItem&lt;String&gt; tm = new TreeItem&lt;&gt;(&quot;&quot; + i + j + k + l + m);</span>
<span class="line-added"> 447                             tl.getChildren().add(tm);</span>
<span class="line-added"> 448                         }</span>
<span class="line-added"> 449                     }</span>
<span class="line-added"> 450                 }</span>
<span class="line-added"> 451             }</span>
<span class="line-added"> 452         }</span>
 453 
 454         sm.setSelectionMode(SelectionMode.MULTIPLE);
<span class="line-modified"> 455         int indices[] = new int[] {1, 400, 800, 1200, 1600, 2000, 2400, 2800, 3200, 3600, 4000, 4400, 4800, 5200, 5600, 6000, 6400};</span>
<span class="line-added"> 456         sm.selectIndices(1, 400, 800, 1200, 1600, 2000, 2400, 2800, 3200, 3600, 4000, 4400, 4800, 5200, 5600, 6000, 6400);</span>
 457 
 458         // Sanity checks
<span class="line-modified"> 459         assertEquals(indices.length, sm.getSelectedIndices().size());</span>
<span class="line-modified"> 460         assertEquals(indices.length, sm.getSelectedItems().size());</span>
<span class="line-modified"> 461         assertEquals(indices.length, sm.getSelectedCells().size());</span>
<span class="line-added"> 462         assertEquals(indices[indices.length - 1], sm.getSelectedIndex());</span>
<span class="line-added"> 463         assertEquals(treeTableView.getTreeItem(indices[indices.length - 1]), sm.getSelectedItem());</span>
 464 
<span class="line-modified"> 465         selectedItemBefore = (TreeItem&lt;String&gt;) sm.getSelectedItem();</span>
<span class="line-modified"> 466         selectedItemsBefore = new ArrayList&lt;&gt;(sm.getSelectedItems());</span>
<span class="line-added"> 467         selectedIndicesBefore = new ArrayList&lt;&gt;(sm.getSelectedIndices());</span>
<span class="line-added"> 468         selectedCellsBefore = new ArrayList&lt;&gt;(sm.getSelectedCells());</span>
 469 
 470         sm.selectedIndexProperty().addListener(ov -&gt; {
 471             countSelectedIndexChangeEvent++;
<span class="line-added"> 472             assertEquals(selectedItemBefore, treeTableView.getTreeItem(sm.getSelectedIndex()));</span>
 473         });
 474         sm.selectedItemProperty().addListener(l -&gt; {
 475             countSelectedItemChangeEvent++;
 476         });
 477         sm.getSelectedIndices().addListener((ListChangeListener) c -&gt; {
 478             countSelectedIndicesChangeEvent++;
<span class="line-added"> 479             c.next();</span>
<span class="line-added"> 480             if (c.wasRemoved()) {</span>
<span class="line-added"> 481                 assertTrue(selectedIndicesBefore.equals(c.getRemoved()));</span>
<span class="line-added"> 482             }</span>
<span class="line-added"> 483             verifySelectedIndices(c.getAddedSubList());</span>
<span class="line-added"> 484             verifySelectedIndices(c.getList());</span>
 485         });
 486         sm.getSelectedItems().addListener((ListChangeListener) c -&gt; {
 487             countSelectedItemsChangeEvent++;
<span class="line-added"> 488             c.next();</span>
<span class="line-added"> 489             if (c.wasRemoved()) {</span>
<span class="line-added"> 490                 verifySelectedItems(c.getRemoved());</span>
<span class="line-added"> 491             }</span>
<span class="line-added"> 492             verifySelectedItems(c.getAddedSubList());</span>
<span class="line-added"> 493             verifySelectedItems(c.getList());</span>
 494         });
<span class="line-added"> 495 </span>
<span class="line-added"> 496         return col;</span>
 497     }
 498 
<span class="line-modified"> 499     private void verifySelectedCells(List&lt;TreeTablePosition&lt;String, ?&gt;&gt; selectedCells) {</span>
<span class="line-modified"> 500         assertEquals(selectedCellsBefore.size(), selectedCells.size());</span>
<span class="line-modified"> 501         for (TreeTablePosition beforePos : selectedCellsBefore) {</span>








 502             boolean isCellStillSelected = false;
<span class="line-modified"> 503             for (TreeTablePosition afterPos : selectedCells) {</span>
 504                 if ((beforePos.getTreeItem() == afterPos.getTreeItem()) &amp;&amp;
 505                         (beforePos.getTableColumn() == afterPos.getTableColumn()) &amp;&amp;
 506                         (beforePos.getColumn() == afterPos.getColumn())) {
 507                     isCellStillSelected = true;
 508                 }
 509             }
 510             assertTrue(&quot;The item (&quot; + beforePos.getRow() + &quot;, &quot; + beforePos.getColumn() +
 511                     &quot;) lost selection during permutation&quot;, isCellStillSelected);
 512         }
<span class="line-added"> 513     }</span>
<span class="line-added"> 514 </span>
<span class="line-added"> 515     private void verifySelectedItems(List&lt;TreeItem&lt;String&gt;&gt; selectedItems) {</span>
<span class="line-added"> 516         assertEquals(selectedItemsBefore.size(), selectedItems.size());</span>
<span class="line-added"> 517         for (TreeItem&lt;String&gt; item : selectedItemsBefore) {</span>
<span class="line-added"> 518             assertTrue(&quot;The item (&quot; + item + &quot;) lost selection during permutation&quot;,</span>
<span class="line-added"> 519                     selectedItems.contains(item));</span>
<span class="line-added"> 520         }</span>
<span class="line-added"> 521     }</span>
<span class="line-added"> 522 </span>
<span class="line-added"> 523     private void verifySelectedIndices(List&lt;Integer&gt; currentIndices) {</span>
<span class="line-added"> 524         assertEquals(selectedIndicesBefore.size(), currentIndices.size());</span>
<span class="line-added"> 525         for (Integer row : currentIndices) {</span>
<span class="line-added"> 526             assertTrue(selectedItemsBefore.contains(treeTableView.getTreeItem(row)));</span>
<span class="line-added"> 527         }</span>
<span class="line-added"> 528     }</span>
<span class="line-added"> 529 </span>
<span class="line-added"> 530     private void verifySelectionAfterPermutation() {</span>
 531         assertEquals(1, countSelectedIndexChangeEvent);
 532         assertEquals(0, countSelectedItemChangeEvent);
 533         assertEquals(1, countSelectedIndicesChangeEvent);
 534         assertEquals(1, countSelectedItemsChangeEvent);
<span class="line-added"> 535 </span>
<span class="line-added"> 536         assertEquals(&quot;Selected Item should remain same&quot;, selectedItemBefore, sm.getSelectedItem());</span>
<span class="line-added"> 537         assertEquals(&quot;Selected index should be updated&quot;, treeTableView.getRow(selectedItemBefore), sm.getSelectedIndex());</span>
<span class="line-added"> 538 </span>
<span class="line-added"> 539         verifySelectedCells(sm.getSelectedCells());</span>
<span class="line-added"> 540         verifySelectedItems(sm.getSelectedItems());</span>
<span class="line-added"> 541         verifySelectedIndices(sm.getSelectedIndices());</span>
 542     }
 543 
 544     @Ignore(&quot;This test is only valid if sort event consumption should revert changes&quot;)
 545     @Test public void testSortEventCanBeConsumedToStopSortOccurring_changeSortOrderList() {
 546         TreeTableColumn&lt;String, String&gt; col = initSortTestStructure();
 547         treeTableView.setOnSort(event -&gt; {
 548             event.consume();
 549         });
 550 
 551         VirtualFlowTestUtils.assertListContainsItemsInOrder(treeTableView.getRoot().getChildren(), apple, orange, banana);
 552         treeTableView.getSortOrder().add(col);
 553         VirtualFlowTestUtils.assertListContainsItemsInOrder(treeTableView.getRoot().getChildren(), apple, orange, banana);
 554 
 555         // the sort order list should be returned back to its original state
 556         assertTrue(treeTableView.getSortOrder().isEmpty());
 557     }
 558 
 559     @Test public void testSortEventCanBeNotConsumedToAllowSortToOccur_changeSortOrderList() {
 560         TreeTableColumn&lt;String, String&gt; col = initSortTestStructure();
 561         treeTableView.setOnSort(event -&gt; {
</pre>
</td>
</tr>
</table>
<center><a href="../../../../../../main/java/javafx/scene/control/TreeTableView.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>