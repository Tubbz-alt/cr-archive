<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.controls/src/test/java/test/javafx/scene/control/TreeTableViewTest.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../main/java/javafx/scene/control/TreeTableView.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>modules/javafx.controls/src/test/java/test/javafx/scene/control/TreeTableViewTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 372,100 ***</span>
  
      private int countSelectedIndexChangeEvent;
      private int countSelectedItemChangeEvent;
      private int countSelectedIndicesChangeEvent;
      private int countSelectedItemsChangeEvent;
<span class="line-modified">!     private TreeItem&lt;String&gt; selectedItem;</span>
<span class="line-modified">!     private List&lt;TreeTablePosition&lt;String,?&gt;&gt; selectedCellsBeforePermutation;</span>
  
      @Test public void testSelectionUpdatesCorrectlyAfterSort() {
<span class="line-modified">!         TreeTableColumn&lt;String, String&gt; col = initSortTestStructure();</span>
<span class="line-removed">-         setupForPermutationTest();</span>
<span class="line-removed">-         VirtualFlowTestUtils.assertListContainsItemsInOrder(treeTableView.getRoot().getChildren(), apple, orange, banana);</span>
          treeTableView.getSortOrder().add(col);
<span class="line-removed">-         VirtualFlowTestUtils.assertListContainsItemsInOrder(treeTableView.getRoot().getChildren(), apple, banana, orange);</span>
          verifySelectionAfterPermutation();
      }
  
      @Test public void testSelectionUpdatesCorrectlyAfterRootSetAll() {
<span class="line-removed">-         initSortTestStructure();</span>
          setupForPermutationTest();
<span class="line-modified">!         treeTableView.getRoot().getChildren().setAll(banana, apple, orange);</span>
          verifySelectionAfterPermutation();
      }
  
      @Test public void testSelectionUpdatesCorrectlyAfterChildSetAll() {
<span class="line-removed">-         initSortTestStructure();</span>
          setupForPermutationTest();
<span class="line-modified">!         banana.getChildren().setAll(banana.getChildren().get(2), banana.getChildren().get(0), banana.getChildren().get(1));</span>
          verifySelectionAfterPermutation();
      }
  
<span class="line-modified">!     private void setupForPermutationTest() {</span>
          countSelectedIndexChangeEvent = 0;
          countSelectedItemChangeEvent = 0;
          countSelectedIndicesChangeEvent = 0;
          countSelectedItemsChangeEvent = 0;
  
<span class="line-modified">!         apple.getChildren().addAll(new TreeItem(&quot;Apple3&quot;), new TreeItem(&quot;Apple2&quot;), new TreeItem(&quot;Apple1&quot;));</span>
<span class="line-modified">!         apple.setExpanded(true);</span>
<span class="line-modified">!         orange.getChildren().addAll(new TreeItem(&quot;Orange3&quot;), new TreeItem(&quot;Orange2&quot;), new TreeItem(&quot;Orange1&quot;));</span>
<span class="line-modified">!         orange.setExpanded(true);</span>
<span class="line-modified">!         banana.getChildren().addAll(new TreeItem(&quot;Banana3&quot;), new TreeItem(&quot;Banana2&quot;), new TreeItem(&quot;Banana1&quot;));</span>
<span class="line-modified">!         banana.setExpanded(true);</span>
  
          sm.setSelectionMode(SelectionMode.MULTIPLE);
<span class="line-modified">!         sm.selectIndices(2, 5, 8, 10);</span>
  
          // Sanity checks
<span class="line-modified">!         assertEquals(4, sm.getSelectedIndices().size());</span>
<span class="line-modified">!         assertEquals(10, sm.getSelectedIndex());</span>
<span class="line-modified">!         assertEquals(treeTableView.getTreeItem(10), sm.getSelectedItem());</span>
  
<span class="line-modified">!         selectedItem = (TreeItem&lt;String&gt;) sm.getSelectedItem();</span>
<span class="line-modified">!         selectedCellsBeforePermutation = new ArrayList&lt;&gt;(sm.getSelectedCells());</span>
  
          sm.selectedIndexProperty().addListener(ov -&gt; {
              countSelectedIndexChangeEvent++;
          });
          sm.selectedItemProperty().addListener(l -&gt; {
              countSelectedItemChangeEvent++;
          });
          sm.getSelectedIndices().addListener((ListChangeListener) c -&gt; {
              countSelectedIndicesChangeEvent++;
          });
          sm.getSelectedItems().addListener((ListChangeListener) c -&gt; {
              countSelectedItemsChangeEvent++;
          });
      }
  
<span class="line-modified">!     private void verifySelectionAfterPermutation() {</span>
<span class="line-modified">!         assertEquals(&quot;Selected index should be updated&quot;, treeTableView.getRow(selectedItem), sm.getSelectedIndex());</span>
<span class="line-modified">!         assertEquals(&quot;Selected Item should remain same&quot;, selectedItem, sm.getSelectedItem());</span>
<span class="line-removed">- </span>
<span class="line-removed">-         final List&lt;TreeTablePosition&lt;String,?&gt;&gt; selectedCellsAfterPermutation =</span>
<span class="line-removed">-                 new ArrayList&lt;&gt;(sm.getSelectedCells());</span>
<span class="line-removed">-         assertEquals(&quot;The number of selected items before and after permutation, should remain same&quot;,</span>
<span class="line-removed">-                 selectedCellsBeforePermutation.size(), selectedCellsAfterPermutation.size());</span>
<span class="line-removed">-         // Verify that the cells that were selected before permutation,</span>
<span class="line-removed">-         // remain selected after permutation.</span>
<span class="line-removed">-         for (TreeTablePosition beforePos : selectedCellsBeforePermutation) {</span>
              boolean isCellStillSelected = false;
<span class="line-modified">!             for (TreeTablePosition afterPos : selectedCellsAfterPermutation) {</span>
                  if ((beforePos.getTreeItem() == afterPos.getTreeItem()) &amp;&amp;
                          (beforePos.getTableColumn() == afterPos.getTableColumn()) &amp;&amp;
                          (beforePos.getColumn() == afterPos.getColumn())) {
                      isCellStillSelected = true;
                  }
              }
              assertTrue(&quot;The item (&quot; + beforePos.getRow() + &quot;, &quot; + beforePos.getColumn() +
                      &quot;) lost selection during permutation&quot;, isCellStillSelected);
          }
          assertEquals(1, countSelectedIndexChangeEvent);
          assertEquals(0, countSelectedItemChangeEvent);
          assertEquals(1, countSelectedIndicesChangeEvent);
          assertEquals(1, countSelectedItemsChangeEvent);
      }
  
      @Ignore(&quot;This test is only valid if sort event consumption should revert changes&quot;)
      @Test public void testSortEventCanBeConsumedToStopSortOccurring_changeSortOrderList() {
          TreeTableColumn&lt;String, String&gt; col = initSortTestStructure();
<span class="line-new-header">--- 372,175 ---</span>
  
      private int countSelectedIndexChangeEvent;
      private int countSelectedItemChangeEvent;
      private int countSelectedIndicesChangeEvent;
      private int countSelectedItemsChangeEvent;
<span class="line-modified">!     private TreeItem&lt;String&gt; selectedItemBefore;</span>
<span class="line-modified">!     private List&lt;TreeItem&lt;String&gt;&gt; selectedItemsBefore;</span>
<span class="line-added">+     private List&lt;Integer&gt; selectedIndicesBefore;</span>
<span class="line-added">+     private List&lt;TreeTablePosition&lt;String,?&gt;&gt; selectedCellsBefore;</span>
  
      @Test public void testSelectionUpdatesCorrectlyAfterSort() {
<span class="line-modified">!         TreeTableColumn&lt;String, String&gt; col = setupForPermutationTest();</span>
          treeTableView.getSortOrder().add(col);
          verifySelectionAfterPermutation();
      }
  
      @Test public void testSelectionUpdatesCorrectlyAfterRootSetAll() {
          setupForPermutationTest();
<span class="line-modified">!         reverseChildrenOrder(treeTableView.getRoot());</span>
          verifySelectionAfterPermutation();
      }
  
      @Test public void testSelectionUpdatesCorrectlyAfterChildSetAll() {
          setupForPermutationTest();
<span class="line-modified">!         reverseChildrenOrder(((TreeItem&lt;String&gt;)sm.getSelectedItem()).getParent());</span>
          verifySelectionAfterPermutation();
      }
  
<span class="line-modified">!     private void reverseChildrenOrder(TreeItem&lt;String&gt; treeItem) {</span>
<span class="line-added">+         List&lt;TreeItem&lt;String&gt;&gt; childrenReversed = new ArrayList&lt;&gt;();</span>
<span class="line-added">+         int childrenSize = treeItem.getChildren().size();</span>
<span class="line-added">+         for (int i = 0; i &lt; childrenSize; i++) {</span>
<span class="line-added">+             childrenReversed.add(treeItem.getChildren().get(childrenSize - 1 - i));</span>
<span class="line-added">+         }</span>
<span class="line-added">+         treeItem.getChildren().setAll(childrenReversed);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     private TreeTableColumn&lt;String, String&gt; setupForPermutationTest() {</span>
          countSelectedIndexChangeEvent = 0;
          countSelectedItemChangeEvent = 0;
          countSelectedIndicesChangeEvent = 0;
          countSelectedItemsChangeEvent = 0;
  
<span class="line-modified">!         TreeTableColumn&lt;String, String&gt; col = new TreeTableColumn&lt;String, String&gt;(&quot;column&quot;);</span>
<span class="line-modified">!         col.setSortType(DESCENDING);</span>
<span class="line-modified">!         col.setCellValueFactory(param -&gt; new ReadOnlyObjectWrapper&lt;String&gt;(param.getValue().getValue()));</span>
<span class="line-modified">!         treeTableView.getColumns().add(col);</span>
<span class="line-modified">! </span>
<span class="line-modified">!         TreeItem&lt;String&gt; treeRoot = new TreeItem&lt;String&gt;(&quot;root&quot;);</span>
<span class="line-added">+         treeRoot.setExpanded(true);</span>
<span class="line-added">+         treeTableView.setRoot(treeRoot);</span>
<span class="line-added">+ </span>
<span class="line-added">+         final int FIRST_LEVEL_COUNT = 8;</span>
<span class="line-added">+         for (int i = 0; i &lt; FIRST_LEVEL_COUNT; i++) {</span>
<span class="line-added">+             TreeItem&lt;String&gt; ti = new TreeItem&lt;&gt;( &quot;&quot; + i);</span>
<span class="line-added">+             ti.setExpanded(true);</span>
<span class="line-added">+             treeRoot.getChildren().add(ti);</span>
<span class="line-added">+ </span>
<span class="line-added">+             for (int j = 0; j &lt; FIRST_LEVEL_COUNT - 1; j++) {</span>
<span class="line-added">+                 TreeItem&lt;String&gt; tj = new TreeItem&lt;&gt;(&quot;&quot; + i + j);</span>
<span class="line-added">+                 tj.setExpanded(true);</span>
<span class="line-added">+                 ti.getChildren().add(tj);</span>
<span class="line-added">+ </span>
<span class="line-added">+                 for (int k = 0; k &lt; FIRST_LEVEL_COUNT - 2; k++) {</span>
<span class="line-added">+                     TreeItem&lt;String&gt; tk = new TreeItem&lt;&gt;(&quot;&quot; + i + j + k);</span>
<span class="line-added">+                     tk.setExpanded(true);</span>
<span class="line-added">+                     tj.getChildren().add(tk);</span>
<span class="line-added">+ </span>
<span class="line-added">+                     for (int l = 0; l &lt; FIRST_LEVEL_COUNT - 3; l++) {</span>
<span class="line-added">+                         TreeItem&lt;String&gt; tl = new TreeItem&lt;&gt;(&quot;&quot; + i + j + k + l);</span>
<span class="line-added">+                         tl.setExpanded(true);</span>
<span class="line-added">+                         tk.getChildren().add(tl);</span>
<span class="line-added">+ </span>
<span class="line-added">+                         for (int m = 0; m &lt; FIRST_LEVEL_COUNT - 4; m++) {</span>
<span class="line-added">+                             TreeItem&lt;String&gt; tm = new TreeItem&lt;&gt;(&quot;&quot; + i + j + k + l + m);</span>
<span class="line-added">+                             tl.getChildren().add(tm);</span>
<span class="line-added">+                         }</span>
<span class="line-added">+                     }</span>
<span class="line-added">+                 }</span>
<span class="line-added">+             }</span>
<span class="line-added">+         }</span>
  
          sm.setSelectionMode(SelectionMode.MULTIPLE);
<span class="line-modified">!         int indices[] = new int[] {1, 400, 800, 1200, 1600, 2000, 2400, 2800, 3200, 3600, 4000, 4400, 4800, 5200, 5600, 6000, 6400};</span>
<span class="line-added">+         sm.selectIndices(1, 400, 800, 1200, 1600, 2000, 2400, 2800, 3200, 3600, 4000, 4400, 4800, 5200, 5600, 6000, 6400);</span>
  
          // Sanity checks
<span class="line-modified">!         assertEquals(indices.length, sm.getSelectedIndices().size());</span>
<span class="line-modified">!         assertEquals(indices.length, sm.getSelectedItems().size());</span>
<span class="line-modified">!         assertEquals(indices.length, sm.getSelectedCells().size());</span>
<span class="line-added">+         assertEquals(indices[indices.length - 1], sm.getSelectedIndex());</span>
<span class="line-added">+         assertEquals(treeTableView.getTreeItem(indices[indices.length - 1]), sm.getSelectedItem());</span>
  
<span class="line-modified">!         selectedItemBefore = (TreeItem&lt;String&gt;) sm.getSelectedItem();</span>
<span class="line-modified">!         selectedItemsBefore = new ArrayList&lt;&gt;(sm.getSelectedItems());</span>
<span class="line-added">+         selectedIndicesBefore = new ArrayList&lt;&gt;(sm.getSelectedIndices());</span>
<span class="line-added">+         selectedCellsBefore = new ArrayList&lt;&gt;(sm.getSelectedCells());</span>
  
          sm.selectedIndexProperty().addListener(ov -&gt; {
              countSelectedIndexChangeEvent++;
<span class="line-added">+             assertEquals(selectedItemBefore, treeTableView.getTreeItem(sm.getSelectedIndex()));</span>
          });
          sm.selectedItemProperty().addListener(l -&gt; {
              countSelectedItemChangeEvent++;
          });
          sm.getSelectedIndices().addListener((ListChangeListener) c -&gt; {
              countSelectedIndicesChangeEvent++;
<span class="line-added">+             c.next();</span>
<span class="line-added">+             if (c.wasRemoved()) {</span>
<span class="line-added">+                 assertTrue(selectedIndicesBefore.equals(c.getRemoved()));</span>
<span class="line-added">+             }</span>
<span class="line-added">+             verifySelectedIndices(c.getAddedSubList());</span>
<span class="line-added">+             verifySelectedIndices(c.getList());</span>
          });
          sm.getSelectedItems().addListener((ListChangeListener) c -&gt; {
              countSelectedItemsChangeEvent++;
<span class="line-added">+             c.next();</span>
<span class="line-added">+             if (c.wasRemoved()) {</span>
<span class="line-added">+                 verifySelectedItems(c.getRemoved());</span>
<span class="line-added">+             }</span>
<span class="line-added">+             verifySelectedItems(c.getAddedSubList());</span>
<span class="line-added">+             verifySelectedItems(c.getList());</span>
          });
<span class="line-added">+ </span>
<span class="line-added">+         return col;</span>
      }
  
<span class="line-modified">!     private void verifySelectedCells(List&lt;TreeTablePosition&lt;String, ?&gt;&gt; selectedCells) {</span>
<span class="line-modified">!         assertEquals(selectedCellsBefore.size(), selectedCells.size());</span>
<span class="line-modified">!         for (TreeTablePosition beforePos : selectedCellsBefore) {</span>
              boolean isCellStillSelected = false;
<span class="line-modified">!             for (TreeTablePosition afterPos : selectedCells) {</span>
                  if ((beforePos.getTreeItem() == afterPos.getTreeItem()) &amp;&amp;
                          (beforePos.getTableColumn() == afterPos.getTableColumn()) &amp;&amp;
                          (beforePos.getColumn() == afterPos.getColumn())) {
                      isCellStillSelected = true;
                  }
              }
              assertTrue(&quot;The item (&quot; + beforePos.getRow() + &quot;, &quot; + beforePos.getColumn() +
                      &quot;) lost selection during permutation&quot;, isCellStillSelected);
          }
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     private void verifySelectedItems(List&lt;TreeItem&lt;String&gt;&gt; selectedItems) {</span>
<span class="line-added">+         assertEquals(selectedItemsBefore.size(), selectedItems.size());</span>
<span class="line-added">+         for (TreeItem&lt;String&gt; item : selectedItemsBefore) {</span>
<span class="line-added">+             assertTrue(&quot;The item (&quot; + item + &quot;) lost selection during permutation&quot;,</span>
<span class="line-added">+                     selectedItems.contains(item));</span>
<span class="line-added">+         }</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     private void verifySelectedIndices(List&lt;Integer&gt; currentIndices) {</span>
<span class="line-added">+         assertEquals(selectedIndicesBefore.size(), currentIndices.size());</span>
<span class="line-added">+         for (Integer row : currentIndices) {</span>
<span class="line-added">+             assertTrue(selectedItemsBefore.contains(treeTableView.getTreeItem(row)));</span>
<span class="line-added">+         }</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     private void verifySelectionAfterPermutation() {</span>
          assertEquals(1, countSelectedIndexChangeEvent);
          assertEquals(0, countSelectedItemChangeEvent);
          assertEquals(1, countSelectedIndicesChangeEvent);
          assertEquals(1, countSelectedItemsChangeEvent);
<span class="line-added">+ </span>
<span class="line-added">+         assertEquals(&quot;Selected Item should remain same&quot;, selectedItemBefore, sm.getSelectedItem());</span>
<span class="line-added">+         assertEquals(&quot;Selected index should be updated&quot;, treeTableView.getRow(selectedItemBefore), sm.getSelectedIndex());</span>
<span class="line-added">+ </span>
<span class="line-added">+         verifySelectedCells(sm.getSelectedCells());</span>
<span class="line-added">+         verifySelectedItems(sm.getSelectedItems());</span>
<span class="line-added">+         verifySelectedIndices(sm.getSelectedIndices());</span>
      }
  
      @Ignore(&quot;This test is only valid if sort event consumption should revert changes&quot;)
      @Test public void testSortEventCanBeConsumedToStopSortOccurring_changeSortOrderList() {
          TreeTableColumn&lt;String, String&gt; col = initSortTestStructure();
</pre>
<center><a href="../../../../../../main/java/javafx/scene/control/TreeTableView.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>