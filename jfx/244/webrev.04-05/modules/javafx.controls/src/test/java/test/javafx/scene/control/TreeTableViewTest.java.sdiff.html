<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.controls/src/test/java/test/javafx/scene/control/TreeTableViewTest.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../main/java/javafx/scene/control/TreeTableView.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>modules/javafx.controls/src/test/java/test/javafx/scene/control/TreeTableViewTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 357         col.setSortType(ASCENDING);
 358         col.setCellValueFactory(param -&gt; new ReadOnlyObjectWrapper&lt;String&gt;(param.getValue().getValue()));
 359         treeTableView.getColumns().add(col);
 360 
 361         TreeItem&lt;String&gt; newRoot = new TreeItem&lt;String&gt;(&quot;root&quot;);
 362         newRoot.setExpanded(true);
 363         newRoot.getChildren().addAll(
 364                 apple  = new TreeItem(&quot;Apple&quot;),
 365                 orange = new TreeItem(&quot;Orange&quot;),
 366                 banana = new TreeItem(&quot;Banana&quot;));
 367 
 368         treeTableView.setRoot(newRoot);
 369 
 370         return col;
 371     }
 372 
 373     private int countSelectedIndexChangeEvent;
 374     private int countSelectedItemChangeEvent;
 375     private int countSelectedIndicesChangeEvent;
 376     private int countSelectedItemsChangeEvent;




 377     private TreeItem&lt;String&gt; selectedItemBefore;
 378     private List&lt;TreeItem&lt;String&gt;&gt; selectedItemsBefore;
 379     private List&lt;Integer&gt; selectedIndicesBefore;
 380     private List&lt;TreeTablePosition&lt;String,?&gt;&gt; selectedCellsBefore;
 381 
 382     @Test public void testSelectionUpdatesCorrectlyAfterSort() {
 383         TreeTableColumn&lt;String, String&gt; col = setupForPermutationTest();
 384         treeTableView.getSortOrder().add(col);
 385         verifySelectionAfterPermutation();
 386     }
 387 
<span class="line-modified"> 388     @Test public void testSelectionUpdatesCorrectlyAfterRootSetAll() {</span>
 389         setupForPermutationTest();
<span class="line-modified"> 390         reverseChildrenOrder(treeTableView.getRoot());</span>


 391         verifySelectionAfterPermutation();
 392     }
 393 
<span class="line-modified"> 394     @Test public void testSelectionUpdatesCorrectlyAfterChildSetAll() {</span>

 395         setupForPermutationTest();
<span class="line-modified"> 396         reverseChildrenOrder(((TreeItem&lt;String&gt;)sm.getSelectedItem()).getParent());</span>




 397         verifySelectionAfterPermutation();
 398     }
 399 
<span class="line-modified"> 400     private void reverseChildrenOrder(TreeItem&lt;String&gt; treeItem) {</span>



















































 401         List&lt;TreeItem&lt;String&gt;&gt; childrenReversed = new ArrayList&lt;&gt;();
 402         int childrenSize = treeItem.getChildren().size();
 403         for (int i = 0; i &lt; childrenSize; i++) {
 404             childrenReversed.add(treeItem.getChildren().get(childrenSize - 1 - i));
 405         }
<span class="line-modified"> 406         treeItem.getChildren().setAll(childrenReversed);</span>
 407     }
 408 
 409     private TreeTableColumn&lt;String, String&gt; setupForPermutationTest() {
 410         countSelectedIndexChangeEvent = 0;
 411         countSelectedItemChangeEvent = 0;
 412         countSelectedIndicesChangeEvent = 0;
 413         countSelectedItemsChangeEvent = 0;




 414 
 415         TreeTableColumn&lt;String, String&gt; col = new TreeTableColumn&lt;String, String&gt;(&quot;column&quot;);
 416         col.setSortType(DESCENDING);
 417         col.setCellValueFactory(param -&gt; new ReadOnlyObjectWrapper&lt;String&gt;(param.getValue().getValue()));
 418         treeTableView.getColumns().add(col);
 419 
 420         TreeItem&lt;String&gt; treeRoot = new TreeItem&lt;String&gt;(&quot;root&quot;);
 421         treeRoot.setExpanded(true);
 422         treeTableView.setRoot(treeRoot);
 423 
 424         final int FIRST_LEVEL_COUNT = 8;
 425         for (int i = 0; i &lt; FIRST_LEVEL_COUNT; i++) {
 426             TreeItem&lt;String&gt; ti = new TreeItem&lt;&gt;( &quot;&quot; + i);
 427             ti.setExpanded(true);
 428             treeRoot.getChildren().add(ti);
 429 
 430             for (int j = 0; j &lt; FIRST_LEVEL_COUNT - 1; j++) {
 431                 TreeItem&lt;String&gt; tj = new TreeItem&lt;&gt;(&quot;&quot; + i + j);
 432                 tj.setExpanded(true);
 433                 ti.getChildren().add(tj);
</pre>
<hr />
<pre>
 511                     &quot;) lost selection during permutation&quot;, isCellStillSelected);
 512         }
 513     }
 514 
 515     private void verifySelectedItems(List&lt;TreeItem&lt;String&gt;&gt; selectedItems) {
 516         assertEquals(selectedItemsBefore.size(), selectedItems.size());
 517         for (TreeItem&lt;String&gt; item : selectedItemsBefore) {
 518             assertTrue(&quot;The item (&quot; + item + &quot;) lost selection during permutation&quot;,
 519                     selectedItems.contains(item));
 520         }
 521     }
 522 
 523     private void verifySelectedIndices(List&lt;Integer&gt; currentIndices) {
 524         assertEquals(selectedIndicesBefore.size(), currentIndices.size());
 525         for (Integer row : currentIndices) {
 526             assertTrue(selectedItemsBefore.contains(treeTableView.getTreeItem(row)));
 527         }
 528     }
 529 
 530     private void verifySelectionAfterPermutation() {
<span class="line-modified"> 531         assertEquals(1, countSelectedIndexChangeEvent);</span>
<span class="line-modified"> 532         assertEquals(0, countSelectedItemChangeEvent);</span>
<span class="line-modified"> 533         assertEquals(1, countSelectedIndicesChangeEvent);</span>
<span class="line-modified"> 534         assertEquals(1, countSelectedItemsChangeEvent);</span>
 535 
 536         assertEquals(&quot;Selected Item should remain same&quot;, selectedItemBefore, sm.getSelectedItem());
 537         assertEquals(&quot;Selected index should be updated&quot;, treeTableView.getRow(selectedItemBefore), sm.getSelectedIndex());
 538 
 539         verifySelectedCells(sm.getSelectedCells());
 540         verifySelectedItems(sm.getSelectedItems());
 541         verifySelectedIndices(sm.getSelectedIndices());
 542     }
 543 
 544     @Ignore(&quot;This test is only valid if sort event consumption should revert changes&quot;)
 545     @Test public void testSortEventCanBeConsumedToStopSortOccurring_changeSortOrderList() {
 546         TreeTableColumn&lt;String, String&gt; col = initSortTestStructure();
 547         treeTableView.setOnSort(event -&gt; {
 548             event.consume();
 549         });
 550 
 551         VirtualFlowTestUtils.assertListContainsItemsInOrder(treeTableView.getRoot().getChildren(), apple, orange, banana);
 552         treeTableView.getSortOrder().add(col);
 553         VirtualFlowTestUtils.assertListContainsItemsInOrder(treeTableView.getRoot().getChildren(), apple, orange, banana);
 554 
</pre>
</td>
<td>
<hr />
<pre>
 357         col.setSortType(ASCENDING);
 358         col.setCellValueFactory(param -&gt; new ReadOnlyObjectWrapper&lt;String&gt;(param.getValue().getValue()));
 359         treeTableView.getColumns().add(col);
 360 
 361         TreeItem&lt;String&gt; newRoot = new TreeItem&lt;String&gt;(&quot;root&quot;);
 362         newRoot.setExpanded(true);
 363         newRoot.getChildren().addAll(
 364                 apple  = new TreeItem(&quot;Apple&quot;),
 365                 orange = new TreeItem(&quot;Orange&quot;),
 366                 banana = new TreeItem(&quot;Banana&quot;));
 367 
 368         treeTableView.setRoot(newRoot);
 369 
 370         return col;
 371     }
 372 
 373     private int countSelectedIndexChangeEvent;
 374     private int countSelectedItemChangeEvent;
 375     private int countSelectedIndicesChangeEvent;
 376     private int countSelectedItemsChangeEvent;
<span class="line-added"> 377     private int expectedCountSelectedIndexChangeEvent;</span>
<span class="line-added"> 378     private int expectedCountSelectedItemChangeEvent;</span>
<span class="line-added"> 379     private int expectedCountSelectedIndicesChangeEvent;</span>
<span class="line-added"> 380     private int expectedCountSelectedItemsChangeEvent;</span>
 381     private TreeItem&lt;String&gt; selectedItemBefore;
 382     private List&lt;TreeItem&lt;String&gt;&gt; selectedItemsBefore;
 383     private List&lt;Integer&gt; selectedIndicesBefore;
 384     private List&lt;TreeTablePosition&lt;String,?&gt;&gt; selectedCellsBefore;
 385 
 386     @Test public void testSelectionUpdatesCorrectlyAfterSort() {
 387         TreeTableColumn&lt;String, String&gt; col = setupForPermutationTest();
 388         treeTableView.getSortOrder().add(col);
 389         verifySelectionAfterPermutation();
 390     }
 391 
<span class="line-modified"> 392     @Test public void testSelectionUpdatesCorrectlyAfterRootReverseAndSetAll() {</span>
 393         setupForPermutationTest();
<span class="line-modified"> 394         TreeItem&lt;String&gt; parentTreeItem = treeTableView.getRoot();</span>
<span class="line-added"> 395         List&lt;TreeItem&lt;String&gt;&gt; childrenReversed = getReverseChildrenOrder(parentTreeItem);</span>
<span class="line-added"> 396         parentTreeItem.getChildren().setAll(childrenReversed);</span>
 397         verifySelectionAfterPermutation();
 398     }
 399 
<span class="line-modified"> 400     @Ignore(&quot;JDK-8248217&quot;)</span>
<span class="line-added"> 401     @Test public void testSelectionUpdatesCorrectlyAfterRemovingSelectedItem() {</span>
 402         setupForPermutationTest();
<span class="line-modified"> 403         TreeItem&lt;String&gt; parentOfSelectedTreeItem = ((TreeItem&lt;String&gt;)sm.getSelectedItem()).getParent();</span>
<span class="line-added"> 404         expectedCountSelectedItemChangeEvent = 1;</span>
<span class="line-added"> 405         selectedItemBefore = treeTableView.getTreeItem(</span>
<span class="line-added"> 406                 (int)sm.getSelectedIndices().get(sm.getSelectedIndices().size() - 1));</span>
<span class="line-added"> 407         parentOfSelectedTreeItem.getChildren().remove(sm.getSelectedItem());</span>
 408         verifySelectionAfterPermutation();
 409     }
 410 
<span class="line-modified"> 411     @Ignore(&quot;JDK-8248217&quot;)</span>
<span class="line-added"> 412     @Test public void testSelectionUpdatesCorrectlyAfterAddingAnItemBeforeSelectedItem() {</span>
<span class="line-added"> 413         setupForPermutationTest();</span>
<span class="line-added"> 414         TreeItem&lt;String&gt; parentOfSelectedTreeItem = ((TreeItem&lt;String&gt;)sm.getSelectedItem()).getParent();</span>
<span class="line-added"> 415         int indexOfSelectedItem = parentOfSelectedTreeItem.getChildren().indexOf(sm.getSelectedItem());</span>
<span class="line-added"> 416         if (indexOfSelectedItem &gt; 0) {</span>
<span class="line-added"> 417             indexOfSelectedItem--;</span>
<span class="line-added"> 418         }</span>
<span class="line-added"> 419         parentOfSelectedTreeItem.getChildren().add(indexOfSelectedItem, new TreeItem(&quot;AddingOne&quot;));</span>
<span class="line-added"> 420         verifySelectionAfterPermutation();</span>
<span class="line-added"> 421     }</span>
<span class="line-added"> 422 </span>
<span class="line-added"> 423     @Test public void testSelectionUpdatesCorrectlyAfterChildReverseAndSetAll() {</span>
<span class="line-added"> 424         setupForPermutationTest();</span>
<span class="line-added"> 425         TreeItem&lt;String&gt; parentTreeItem = ((TreeItem&lt;String&gt;)sm.getSelectedItem()).getParent();</span>
<span class="line-added"> 426         List&lt;TreeItem&lt;String&gt;&gt; childrenReversed = getReverseChildrenOrder(parentTreeItem);</span>
<span class="line-added"> 427         parentTreeItem.getChildren().setAll(childrenReversed);</span>
<span class="line-added"> 428         verifySelectionAfterPermutation();</span>
<span class="line-added"> 429     }</span>
<span class="line-added"> 430 </span>
<span class="line-added"> 431     @Ignore(&quot;JDK-8248217&quot;)</span>
<span class="line-added"> 432     @Test public void testSelectionUpdatesCorrectlyAfterChildReverseRemoveOneAndSetAll() {</span>
<span class="line-added"> 433         setupForPermutationTest();</span>
<span class="line-added"> 434         TreeItem&lt;String&gt; parentTreeItem = ((TreeItem&lt;String&gt;)sm.getSelectedItem()).getParent();</span>
<span class="line-added"> 435         List&lt;TreeItem&lt;String&gt;&gt; childrenReversed = getReverseChildrenOrder(parentTreeItem);</span>
<span class="line-added"> 436         childrenReversed.remove(0);</span>
<span class="line-added"> 437         parentTreeItem.getChildren().setAll(childrenReversed);</span>
<span class="line-added"> 438         verifySelectionAfterPermutation();</span>
<span class="line-added"> 439     }</span>
<span class="line-added"> 440 </span>
<span class="line-added"> 441     @Ignore(&quot;JDK-8248217&quot;)</span>
<span class="line-added"> 442     @Test public void testSelectionUpdatesCorrectlyAfterChildRemoveOneAndSetAll() {</span>
<span class="line-added"> 443         TreeTableColumn&lt;String, String&gt; col = setupForPermutationTest();</span>
<span class="line-added"> 444         TreeItem&lt;String&gt; parentTreeItem = ((TreeItem&lt;String&gt;)sm.getSelectedItem()).getParent();</span>
<span class="line-added"> 445         List&lt;TreeItem&lt;String&gt;&gt; children = new ArrayList&lt;&gt;(parentTreeItem.getChildren());</span>
<span class="line-added"> 446         children.remove(0);</span>
<span class="line-added"> 447         parentTreeItem.getChildren().setAll(children);</span>
<span class="line-added"> 448         verifySelectionAfterPermutation();</span>
<span class="line-added"> 449     }</span>
<span class="line-added"> 450 </span>
<span class="line-added"> 451     @Ignore(&quot;JDK-8248217&quot;)</span>
<span class="line-added"> 452     @Test public void testSelectionUpdatesCorrectlyAfterChildRemoveOneAndSetAllAndSort() {</span>
<span class="line-added"> 453         TreeTableColumn&lt;String, String&gt; col = setupForPermutationTest();</span>
<span class="line-added"> 454         TreeItem&lt;String&gt; parentTreeItem = ((TreeItem&lt;String&gt;)sm.getSelectedItem()).getParent();</span>
<span class="line-added"> 455         List&lt;TreeItem&lt;String&gt;&gt; children = new ArrayList&lt;&gt;(parentTreeItem.getChildren());</span>
<span class="line-added"> 456         children.remove(0);</span>
<span class="line-added"> 457         parentTreeItem.getChildren().setAll(children);</span>
<span class="line-added"> 458         treeTableView.getSortOrder().add(col);</span>
<span class="line-added"> 459         verifySelectionAfterPermutation();</span>
<span class="line-added"> 460     }</span>
<span class="line-added"> 461 </span>
<span class="line-added"> 462     private List&lt;TreeItem&lt;String&gt;&gt; getReverseChildrenOrder(TreeItem&lt;String&gt; treeItem) {</span>
 463         List&lt;TreeItem&lt;String&gt;&gt; childrenReversed = new ArrayList&lt;&gt;();
 464         int childrenSize = treeItem.getChildren().size();
 465         for (int i = 0; i &lt; childrenSize; i++) {
 466             childrenReversed.add(treeItem.getChildren().get(childrenSize - 1 - i));
 467         }
<span class="line-modified"> 468         return childrenReversed;</span>
 469     }
 470 
 471     private TreeTableColumn&lt;String, String&gt; setupForPermutationTest() {
 472         countSelectedIndexChangeEvent = 0;
 473         countSelectedItemChangeEvent = 0;
 474         countSelectedIndicesChangeEvent = 0;
 475         countSelectedItemsChangeEvent = 0;
<span class="line-added"> 476         expectedCountSelectedIndexChangeEvent = 1;</span>
<span class="line-added"> 477         expectedCountSelectedItemChangeEvent = 0;</span>
<span class="line-added"> 478         expectedCountSelectedIndicesChangeEvent = 1;</span>
<span class="line-added"> 479         expectedCountSelectedItemsChangeEvent = 1;</span>
 480 
 481         TreeTableColumn&lt;String, String&gt; col = new TreeTableColumn&lt;String, String&gt;(&quot;column&quot;);
 482         col.setSortType(DESCENDING);
 483         col.setCellValueFactory(param -&gt; new ReadOnlyObjectWrapper&lt;String&gt;(param.getValue().getValue()));
 484         treeTableView.getColumns().add(col);
 485 
 486         TreeItem&lt;String&gt; treeRoot = new TreeItem&lt;String&gt;(&quot;root&quot;);
 487         treeRoot.setExpanded(true);
 488         treeTableView.setRoot(treeRoot);
 489 
 490         final int FIRST_LEVEL_COUNT = 8;
 491         for (int i = 0; i &lt; FIRST_LEVEL_COUNT; i++) {
 492             TreeItem&lt;String&gt; ti = new TreeItem&lt;&gt;( &quot;&quot; + i);
 493             ti.setExpanded(true);
 494             treeRoot.getChildren().add(ti);
 495 
 496             for (int j = 0; j &lt; FIRST_LEVEL_COUNT - 1; j++) {
 497                 TreeItem&lt;String&gt; tj = new TreeItem&lt;&gt;(&quot;&quot; + i + j);
 498                 tj.setExpanded(true);
 499                 ti.getChildren().add(tj);
</pre>
<hr />
<pre>
 577                     &quot;) lost selection during permutation&quot;, isCellStillSelected);
 578         }
 579     }
 580 
 581     private void verifySelectedItems(List&lt;TreeItem&lt;String&gt;&gt; selectedItems) {
 582         assertEquals(selectedItemsBefore.size(), selectedItems.size());
 583         for (TreeItem&lt;String&gt; item : selectedItemsBefore) {
 584             assertTrue(&quot;The item (&quot; + item + &quot;) lost selection during permutation&quot;,
 585                     selectedItems.contains(item));
 586         }
 587     }
 588 
 589     private void verifySelectedIndices(List&lt;Integer&gt; currentIndices) {
 590         assertEquals(selectedIndicesBefore.size(), currentIndices.size());
 591         for (Integer row : currentIndices) {
 592             assertTrue(selectedItemsBefore.contains(treeTableView.getTreeItem(row)));
 593         }
 594     }
 595 
 596     private void verifySelectionAfterPermutation() {
<span class="line-modified"> 597         assertEquals(expectedCountSelectedIndexChangeEvent, countSelectedIndexChangeEvent);</span>
<span class="line-modified"> 598         assertEquals(expectedCountSelectedItemChangeEvent, countSelectedItemChangeEvent);</span>
<span class="line-modified"> 599         assertEquals(expectedCountSelectedIndicesChangeEvent, countSelectedIndicesChangeEvent);</span>
<span class="line-modified"> 600         assertEquals(expectedCountSelectedItemsChangeEvent, countSelectedItemsChangeEvent);</span>
 601 
 602         assertEquals(&quot;Selected Item should remain same&quot;, selectedItemBefore, sm.getSelectedItem());
 603         assertEquals(&quot;Selected index should be updated&quot;, treeTableView.getRow(selectedItemBefore), sm.getSelectedIndex());
 604 
 605         verifySelectedCells(sm.getSelectedCells());
 606         verifySelectedItems(sm.getSelectedItems());
 607         verifySelectedIndices(sm.getSelectedIndices());
 608     }
 609 
 610     @Ignore(&quot;This test is only valid if sort event consumption should revert changes&quot;)
 611     @Test public void testSortEventCanBeConsumedToStopSortOccurring_changeSortOrderList() {
 612         TreeTableColumn&lt;String, String&gt; col = initSortTestStructure();
 613         treeTableView.setOnSort(event -&gt; {
 614             event.consume();
 615         });
 616 
 617         VirtualFlowTestUtils.assertListContainsItemsInOrder(treeTableView.getRoot().getChildren(), apple, orange, banana);
 618         treeTableView.getSortOrder().add(col);
 619         VirtualFlowTestUtils.assertListContainsItemsInOrder(treeTableView.getRoot().getChildren(), apple, orange, banana);
 620 
</pre>
</td>
</tr>
</table>
<center><a href="../../../../../../main/java/javafx/scene/control/TreeTableView.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>