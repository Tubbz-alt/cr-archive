<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old modules/javafx.base/src/test/java/test/javafx/binding/GenericBindingTest.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2011, 2016, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package test.javafx.binding;
 27 
 28 import test.javafx.beans.InvalidationListenerMock;
 29 import javafx.beans.Observable;
 30 import javafx.beans.binding.*;
 31 import test.javafx.beans.value.ChangeListenerMock;
 32 import javafx.beans.value.ObservableValueBase;
 33 import javafx.collections.FXCollections;
 34 import javafx.collections.ObservableList;
 35 import org.junit.After;
 36 import org.junit.Before;
 37 import org.junit.Test;
 38 import org.junit.runner.RunWith;
 39 import org.junit.runners.Parameterized;
 40 
 41 import java.util.Arrays;
 42 import java.util.Collection;
 43 
 44 import static org.junit.Assert.assertEquals;
 45 import static org.junit.Assert.fail;
 46 
 47 @RunWith(Parameterized.class)
 48 public class GenericBindingTest&lt;T&gt; {
 49 
 50     private static final Object UNDEFINED = null;
 51 
 52     private final ObservableStub dependency1;
 53     private final ObservableStub dependency2;
 54     private final BindingMock&lt;T&gt; binding0;
 55     private final BindingMock&lt;T&gt; binding1;
 56     private final BindingMock&lt;T&gt; binding2;
 57     private final T value1;
 58     private final T value2;
 59     private InvalidationListenerMock invalidationListener;
 60     private ChangeListenerMock&lt;Object&gt; changeListener;
 61 
 62     public GenericBindingTest(
 63             T value1, T value2,
 64             ObservableStub dependency1,
 65             ObservableStub dependency2,
 66             BindingMock&lt;T&gt; binding0, BindingMock&lt;T&gt; binding1, BindingMock&lt;T&gt; binding2) {
 67         this.value1 = value1;
 68         this.value2 = value2;
 69         this.dependency1 = dependency1;
 70         this.dependency2 = dependency2;
 71         this.binding0 = binding0;
 72         this.binding1 = binding1;
 73         this.binding2 = binding2;
 74     }
 75 
 76     @Before
 77     public void setUp() {
 78         invalidationListener = new InvalidationListenerMock();
 79         changeListener = new ChangeListenerMock&lt;Object&gt;(UNDEFINED);
 80         binding0.setValue(value2);
 81         binding1.setValue(value2);
 82         binding2.setValue(value2);
 83     }
 84 
 85     @After
 86     public void tearDown() {
 87         binding0.removeListener(invalidationListener);
 88         binding0.removeListener(changeListener);
 89         binding1.removeListener(invalidationListener);
 90         binding1.removeListener(changeListener);
 91         binding2.removeListener(invalidationListener);
 92         binding2.removeListener(changeListener);
 93     }
 94 
 95     @Test
 96     public void testNoDependencyLazy() {
 97         binding0.getValue();
 98         binding0.addListener(invalidationListener);
 99         System.gc(); // making sure we did not not overdo weak references
100         assertEquals(true, binding0.isValid());
101 
102         // calling getValue()
103         binding0.reset();
104         binding0.getValue();
105         assertEquals(0, binding0.getComputeValueCounter());
106         invalidationListener.check(null, 0);
107         assertEquals(true, binding0.isValid());
108     }
109 
110     @Test
111     public void testNoDependencyEager() {
112         binding0.getValue();
113         binding0.addListener(changeListener);
114         System.gc(); // making sure we did not not overdo weak references
115         assertEquals(true, binding0.isValid());
116 
117         // calling getValue()
118         binding0.reset();
119         binding0.getValue();
120         assertEquals(0, binding0.getComputeValueCounter());
121         changeListener.check(null, UNDEFINED, UNDEFINED, 0);
122         assertEquals(true, binding0.isValid());
123     }
124 
125     @Test
126     public void testSingleDependencyLazy() {
127         binding1.getValue();
128         binding1.addListener(invalidationListener);
129         System.gc(); // making sure we did not not overdo weak references
130         assertEquals(true, binding1.isValid());
131 
132         // fire single change event
133         binding1.reset();
134         invalidationListener.reset();
135         binding1.setValue(value1);
136         dependency1.fireValueChangedEvent();
137         assertEquals(0, binding1.getComputeValueCounter());
138         invalidationListener.check(binding1, 1);
139         assertEquals(false, binding1.isValid());
140 
141         binding1.getValue();
142         assertEquals(1, binding1.getComputeValueCounter());
143         invalidationListener.check(null, 0);
144         assertEquals(true, binding1.isValid());
145 
146         // fire single change event with same value
147         binding1.setValue(value1);
148         dependency1.fireValueChangedEvent();
149         assertEquals(0, binding1.getComputeValueCounter());
150         invalidationListener.check(binding1, 1);
151         assertEquals(false, binding1.isValid());
152 
153         binding1.getValue();
154         assertEquals(1, binding1.getComputeValueCounter());
155         invalidationListener.check(null, 0);
156         assertEquals(true, binding1.isValid());
157 
158         // fire two change events with different values
159         binding1.setValue(value2);
160         dependency1.fireValueChangedEvent();
161         binding1.setValue(value1);
162         dependency1.fireValueChangedEvent();
163         assertEquals(0, binding1.getComputeValueCounter());
164         invalidationListener.check(binding1, 1);
165         assertEquals(false, binding1.isValid());
166 
167         binding1.getValue();
168         assertEquals(1, binding1.getComputeValueCounter());
169         invalidationListener.check(null, 0);
170         assertEquals(true, binding1.isValid());
171 
172         // fire two change events with same values
173         binding1.setValue(value2);
174         dependency1.fireValueChangedEvent();
175         binding1.setValue(value2);
176         dependency1.fireValueChangedEvent();
177         assertEquals(0, binding1.getComputeValueCounter());
178         invalidationListener.check(binding1, 1);
179         assertEquals(false, binding1.isValid());
180 
181         binding1.getValue();
182         assertEquals(1, binding1.getComputeValueCounter());
183         invalidationListener.check(null, 0);
184         assertEquals(true, binding1.isValid());
185     }
186 
187     @Test
188     public void testSingleDependencyEager() {
189         binding1.getValue();
190         binding1.addListener(changeListener);
191         System.gc(); // making sure we did not not overdo weak references
192         assertEquals(true, binding1.isValid());
193 
194         // fire single change event
195         binding1.reset();
196         changeListener.reset();
197         binding1.setValue(value1);
198         dependency1.fireValueChangedEvent();
199         assertEquals(1, binding1.getComputeValueCounter());
200         changeListener.check(binding1, value2, value1, 1);
201         assertEquals(true, binding1.isValid());
202 
203         binding1.getValue();
204         assertEquals(0, binding1.getComputeValueCounter());
205         changeListener.check(null, UNDEFINED, UNDEFINED, 0);
206         assertEquals(true, binding1.isValid());
207 
208         // fire single change event with same value
209         binding1.setValue(value1);
210         dependency1.fireValueChangedEvent();
211         assertEquals(1, binding1.getComputeValueCounter());
212         changeListener.check(null, UNDEFINED, UNDEFINED, 0);
213         assertEquals(true, binding1.isValid());
214 
215         binding1.getValue();
216         assertEquals(0, binding1.getComputeValueCounter());
217         changeListener.check(null, UNDEFINED, UNDEFINED, 0);
218         assertEquals(true, binding1.isValid());
219 
220         // fire two change events
221         binding1.setValue(value2);
222         dependency1.fireValueChangedEvent();
223         binding1.setValue(value1);
224         dependency1.fireValueChangedEvent();
225         assertEquals(2, binding1.getComputeValueCounter());
226         changeListener.check(binding1, value2, value1, 2);
227         assertEquals(true, binding1.isValid());
228 
229         binding1.getValue();
230         assertEquals(0, binding1.getComputeValueCounter());
231         changeListener.check(null, UNDEFINED, UNDEFINED, 0);
232         assertEquals(true, binding1.isValid());
233 
234         // fire two change events with same value
235         binding1.setValue(value2);
236         dependency1.fireValueChangedEvent();
237         binding1.setValue(value2);
238         dependency1.fireValueChangedEvent();
239         assertEquals(2, binding1.getComputeValueCounter());
240         changeListener.check(binding1, value1, value2, 1);
241         assertEquals(true, binding1.isValid());
242 
243         binding1.getValue();
244         assertEquals(0, binding1.getComputeValueCounter());
245         changeListener.check(null, UNDEFINED, UNDEFINED, 0);
246         assertEquals(true, binding1.isValid());
247     }
248 
249     @Test
250     public void testTwoDependencies() {
251         binding2.getValue();
252         binding2.addListener(invalidationListener);
253         System.gc(); // making sure we did not not overdo weak references
254         assertEquals(true, binding2.isValid());
255 
256         // fire single change event on first dependency
257         binding2.reset();
258         invalidationListener.reset();
259         dependency1.fireValueChangedEvent();
260         assertEquals(0, binding2.getComputeValueCounter());
261         invalidationListener.check(binding2, 1);
262         assertEquals(false, binding2.isValid());
263 
264         binding2.getValue();
265         assertEquals(1, binding2.getComputeValueCounter());
266         invalidationListener.check(null, 0);
267         assertEquals(true, binding2.isValid());
268 
269         // fire single change event on second dependency
270         binding2.reset();
271         dependency2.fireValueChangedEvent();
272         assertEquals(0, binding2.getComputeValueCounter());
273         invalidationListener.check(binding2, 1);
274         assertEquals(false, binding2.isValid());
275 
276         binding2.getValue();
277         assertEquals(1, binding2.getComputeValueCounter());
278         invalidationListener.check(null, 0);
279         assertEquals(true, binding2.isValid());
280 
281         // fire change events on each dependency
282         binding2.reset();
283         dependency1.fireValueChangedEvent();
284         dependency2.fireValueChangedEvent();
285         assertEquals(0, binding2.getComputeValueCounter());
286         invalidationListener.check(binding2, 1);
287         assertEquals(false, binding2.isValid());
288 
289         binding2.getValue();
290         assertEquals(1, binding2.getComputeValueCounter());
291         invalidationListener.check(null, 0);
292         assertEquals(true, binding2.isValid());
293     }
294 
295     @Parameterized.Parameters
296     public static Collection&lt;Object[]&gt; parameters() {
297         final ObservableStub dependency1 = new ObservableStub();
298         final ObservableStub dependency2 = new ObservableStub();
299         return Arrays.asList(new Object[][] {
300             {
301                 Float.MIN_VALUE, Float.MAX_VALUE,
302                 dependency1, dependency2,
303                 new FloatBindingImpl(),
304                 new FloatBindingImpl(dependency1),
305                 new FloatBindingImpl(dependency1, dependency2),
306             },
307             {
308                 Double.MIN_VALUE, Double.MAX_VALUE,
309                 dependency1, dependency2,
310                 new DoubleBindingImpl(),
311                 new DoubleBindingImpl(dependency1),
312                 new DoubleBindingImpl(dependency1, dependency2),
313             },
314             {
315                 Long.MIN_VALUE, Long.MAX_VALUE,
316                 dependency1, dependency2,
317                 new LongBindingImpl(),
318                 new LongBindingImpl(dependency1),
319                 new LongBindingImpl(dependency1, dependency2),
320             },
321             {
322                 Integer.MIN_VALUE, Integer.MAX_VALUE,
323                 dependency1, dependency2,
324                 new IntegerBindingImpl(),
325                 new IntegerBindingImpl(dependency1),
326                 new IntegerBindingImpl(dependency1, dependency2),
327             },
328             {
329                 true, false,
330                 dependency1, dependency2,
331                 new BooleanBindingImpl(),
332                 new BooleanBindingImpl(dependency1),
333                 new BooleanBindingImpl(dependency1, dependency2),
334             },
335             {
336                 &quot;Hello World&quot;, &quot;Goodbye&quot;,
337                 dependency1, dependency2,
338                 new StringBindingImpl(),
339                 new StringBindingImpl(dependency1),
340                 new StringBindingImpl(dependency1, dependency2),
341             },
342             {
343                     new Object(), new Object(),
344                     dependency1, dependency2,
345                     new ObjectBindingImpl(),
346                     new ObjectBindingImpl(dependency1),
347                     new ObjectBindingImpl(dependency1, dependency2),
348             },
349             {
350                     FXCollections.observableArrayList(), FXCollections.observableArrayList(),
351                     dependency1, dependency2,
352                     new ListBindingImpl(),
353                     new ListBindingImpl(dependency1),
354                     new ListBindingImpl(dependency1, dependency2),
355             },
356         });
357     }
358 
359     public static class ObservableStub extends ObservableValueBase&lt;Object&gt; {
360         @Override public void fireValueChangedEvent() {super.fireValueChangedEvent();}
361 
362         @Override
363         public Object getValue() {
364             return null;
365         }
366     }
367 
368     public static interface BindingMock&lt;T&gt; extends Binding&lt;T&gt; {
369         int getComputeValueCounter();
370         void reset();
371         void setValue(T value);
372     }
373 
374     private static class DoubleBindingImpl extends DoubleBinding implements BindingMock&lt;Number&gt; {
375 
376         private int computeValueCounter = 0;
377         private double value;
378 
379         @Override
380         public void setValue(Number value) {this.value = value.doubleValue();}
381 
382         public DoubleBindingImpl(Observable... dep) {
383             super.bind(dep);
384         }
385 
386         @Override public int getComputeValueCounter() {
387             final int result = computeValueCounter;
388             reset();
389             return result;
390         }
391 
392         @Override public void reset() {computeValueCounter = 0;}
393 
394         @Override
395         public double computeValue() {
396             computeValueCounter++;
397             return value;
398         }
399 
400         public ObservableList&lt;?&gt; getDependencies() {
401             fail(&quot;Should not reach here&quot;);
402             return null;
403         }
404     }
405 
406     private static class FloatBindingImpl extends FloatBinding implements BindingMock&lt;Number&gt; {
407 
408         private int computeValueCounter = 0;
409         private float value;
410 
411         @Override
412         public void setValue(Number value) {this.value = value.floatValue();}
413 
414         public FloatBindingImpl(Observable... dep) {
415             super.bind(dep);
416         }
417 
418         @Override public int getComputeValueCounter() {
419             final int result = computeValueCounter;
420             reset();
421             return result;
422         }
423 
424         @Override public void reset() {computeValueCounter = 0;}
425 
426         @Override
427         public float computeValue() {
428             computeValueCounter++;
429             return value;
430         }
431 
432         public ObservableList&lt;?&gt; getDependencies() {
433             fail(&quot;Should not reach here&quot;);
434             return null;
435         }
436     }
437 
438     private static class LongBindingImpl extends LongBinding implements BindingMock&lt;Number&gt; {
439 
440         private int computeValueCounter = 0;
441         private long value;
442 
443         @Override
444         public void setValue(Number value) {this.value = value.longValue();}
445 
446         public LongBindingImpl(Observable... dep) {
447             super.bind(dep);
448         }
449 
450         @Override public int getComputeValueCounter() {
451             final int result = computeValueCounter;
452             reset();
453             return result;
454         }
455 
456         @Override public void reset() {computeValueCounter = 0;}
457 
458         @Override
459         public long computeValue() {
460             computeValueCounter++;
461             return value;
462         }
463 
464         public ObservableList&lt;?&gt; getDependencies() {
465             fail(&quot;Should not reach here&quot;);
466             return null;
467         }
468     }
469 
470     private static class IntegerBindingImpl extends IntegerBinding implements BindingMock&lt;Number&gt; {
471 
472         private int computeValueCounter = 0;
473         private int value;
474 
475         @Override
476         public void setValue(Number value) {this.value = value.intValue();}
477 
478         public IntegerBindingImpl(Observable... dep) {
479             super.bind(dep);
480         }
481 
482         @Override public int getComputeValueCounter() {
483             final int result = computeValueCounter;
484             reset();
485             return result;
486         }
487 
488         @Override public void reset() {computeValueCounter = 0;}
489 
490         @Override
491         public int computeValue() {
492             computeValueCounter++;
493             return value;
494         }
495 
496         public ObservableList&lt;?&gt; getDependencies() {
497             fail(&quot;Should not reach here&quot;);
498             return null;
499         }
500     }
501 
502     private static class BooleanBindingImpl extends BooleanBinding implements BindingMock&lt;Boolean&gt; {
503 
504         private int computeValueCounter = 0;
505         private boolean value;
506 
507         @Override
508         public void setValue(Boolean value) {this.value = value;}
509 
510         public BooleanBindingImpl(Observable... dep) {
511             super.bind(dep);
512         }
513 
514         @Override public int getComputeValueCounter() {
515             final int result = computeValueCounter;
516             reset();
517             return result;
518         }
519 
520         @Override public void reset() {computeValueCounter = 0;}
521 
522         @Override
523         public boolean computeValue() {
524             computeValueCounter++;
525             return value;
526         }
527 
528         public ObservableList&lt;?&gt; getDependencies() {
529             fail(&quot;Should not reach here&quot;);
530             return null;
531         }
532     }
533 
534     private static class ObjectBindingImpl extends ObjectBinding&lt;Object&gt; implements BindingMock&lt;Object&gt; {
535 
536         private int computeValueCounter = 0;
537         private Object value;
538 
539         @Override
540         public void setValue(Object value) {this.value = value;}
541 
542         public ObjectBindingImpl(Observable... dep) {
543             super.bind(dep);
544         }
545 
546         @Override public int getComputeValueCounter() {
547             final int result = computeValueCounter;
548             reset();
549             return result;
550         }
551 
552         @Override public void reset() {computeValueCounter = 0;}
553 
554         @Override
555         public Object computeValue() {
556             computeValueCounter++;
557             return value;
558         }
559 
560         public ObservableList&lt;?&gt; getDependencies() {
561             fail(&quot;Should not reach here&quot;);
562             return null;
563         }
564     }
565 
566     private static class StringBindingImpl extends StringBinding implements BindingMock&lt;String&gt; {
567 
568         private int computeValueCounter = 0;
569         private String value;
570 
571         @Override
572         public void setValue(String value) {this.value = value;}
573 
574         public StringBindingImpl(Observable... dep) {
575             super.bind(dep);
576         }
577 
578         @Override public int getComputeValueCounter() {
579             final int result = computeValueCounter;
580             reset();
581             return result;
582         }
583 
584         @Override public void reset() {computeValueCounter = 0;}
585 
586         @Override
587         public String computeValue() {
588             computeValueCounter++;
589             return value;
590         }
591 
592         public ObservableList&lt;?&gt; getDependencies() {
593             fail(&quot;Should not reach here&quot;);
594             return null;
595         }
596     }
597 
598     private static class ListBindingImpl extends ListBinding&lt;Object&gt; implements BindingMock&lt;ObservableList&lt;Object&gt;&gt; {
599 
600         private int computeValueCounter = 0;
601         private ObservableList&lt;Object&gt; value;
602 
603         @Override
604         public void setValue(ObservableList&lt;Object&gt; value) {this.value = value;}
605 
606         public ListBindingImpl(Observable... dep) {
607             super.bind(dep);
608         }
609 
610         @Override public int getComputeValueCounter() {
611             final int result = computeValueCounter;
612             reset();
613             return result;
614         }
615 
616         @Override public void reset() {computeValueCounter = 0;}
617 
618         @Override
619         public ObservableList&lt;Object&gt; computeValue() {
620             computeValueCounter++;
621             return value;
622         }
623 
624         public ObservableList&lt;?&gt; getDependencies() {
625             fail(&quot;Should not reach here&quot;);
626             return null;
627         }
628     }
629 
630 
631 }
    </pre>
  </body>
</html>