<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.controls/src/test/java/test/javafx/scene/control/TabPaneTest.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="SelectionFocusModelMemoryTest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>modules/javafx.controls/src/test/java/test/javafx/scene/control/TabPaneTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
  23  * questions.
  24  */
  25 
  26 package test.javafx.scene.control;
  27 
  28 import com.sun.javafx.scene.SceneHelper;
  29 import static test.com.sun.javafx.scene.control.infrastructure.ControlTestUtils.assertPseudoClassDoesNotExist;
  30 import static test.com.sun.javafx.scene.control.infrastructure.ControlTestUtils.assertPseudoClassExists;
  31 import static test.com.sun.javafx.scene.control.infrastructure.ControlTestUtils.assertStyleClassContains;
  32 import static org.junit.Assert.assertEquals;
  33 import static org.junit.Assert.assertFalse;
  34 import static org.junit.Assert.assertNotNull;
  35 import static org.junit.Assert.assertNull;
  36 import static org.junit.Assert.assertSame;
  37 import static org.junit.Assert.assertTrue;
  38 import static org.junit.Assert.fail;
  39 


  40 import test.com.sun.javafx.scene.control.infrastructure.StageLoader;
  41 import javafx.application.Platform;
  42 import javafx.beans.property.BooleanProperty;
  43 import javafx.beans.property.DoubleProperty;
  44 import javafx.beans.property.ObjectProperty;
  45 import javafx.beans.property.SimpleBooleanProperty;
  46 import javafx.beans.property.SimpleDoubleProperty;
  47 import javafx.beans.property.SimpleObjectProperty;
  48 import javafx.beans.value.ChangeListener;
  49 import javafx.css.CssMetaData;
  50 import javafx.css.StyleableProperty;
  51 import javafx.event.Event;
  52 import javafx.geometry.Bounds;
  53 import javafx.geometry.Side;
  54 import javafx.scene.Group;
  55 import javafx.scene.Scene;
  56 import javafx.scene.input.KeyEvent;
  57 import javafx.scene.input.MouseEvent;
  58 import javafx.scene.layout.StackPane;
  59 import javafx.scene.layout.VBox;
</pre>
<hr />
<pre>
1138         tabPane.getTabs().add(1, tabPane.getTabs().remove(0));
1139         tk.firePulse();
1140         tabPane.getSelectionModel().select(tab1);
1141         tk.firePulse();
1142 
1143         double xval = (tabPane.localToScene(tabPane.getLayoutBounds())).getMinX();
1144         double yval = (tabPane.localToScene(tabPane.getLayoutBounds())).getMinY();
1145 
1146         SceneHelper.processMouseEvent(scene,
1147             MouseEventGenerator.generateMouseEvent(MouseEvent.MOUSE_PRESSED, xval + 19, yval + 17));
1148         tk.firePulse();
1149         SceneHelper.processMouseEvent(scene,
1150             MouseEventGenerator.generateMouseEvent(MouseEvent.MOUSE_PRESSED, xval + 19, yval + 17));
1151         tk.firePulse();
1152 
1153         assertEquals(&quot;Tabpane should have 3 tabs.&quot;, 3, tabPane.getTabs().size());
1154         assertEquals(&quot;tab2 should be at index 0.&quot;, tab2, tabPane.getSelectionModel().getSelectedItem());
1155     }
1156 
1157     // Test for JDK-8154039
<span class="line-removed">1158     WeakReference&lt;Tab&gt; weakTab;</span>
1159     @Test public void testSelectNonChildTab() {
1160         tabPane.getTabs().addAll(tab1);
1161         root.getChildren().add(tabPane);
1162         show();
1163         tk.firePulse();
<span class="line-modified">1164         weakTab = new WeakReference&lt;&gt;(new Tab(&quot;NonChildTab&quot;));</span>
1165         tabPane.getSelectionModel().select(weakTab.get());
1166         tk.firePulse();
<span class="line-modified">1167         attemptGC(10);</span>
1168         tk.firePulse();
1169         assertNull(weakTab.get());
1170     }
1171 
<span class="line-modified">1172     private void attemptGC(int n) {</span>
1173         // Attempt gc n times
1174         for (int i = 0; i &lt; n; i++) {
1175             System.gc();
1176             System.runFinalization();
1177 
<span class="line-modified">1178             if (weakTab.get() == null) {</span>
1179                 break;
1180             }
1181             try {
1182                 Thread.sleep(500);
1183             } catch (InterruptedException e) {
1184                 fail(&quot;InterruptedException occurred during Thread.sleep()&quot;);
1185             }
1186         }
1187     }
1188 
1189     // Test for JDK-8157690
1190     @Test public void testPopupItemsOnSortingTabs() {
1191         tabPane.setMaxSize(20, 20);
1192         root.getChildren().add(tabPane);
1193         tabPane.getTabs().addAll(tab1, tab2, tab3);
1194         show();
1195         tk.firePulse();
1196         TabPaneSkin tbSkin = (TabPaneSkin) tabPane.getSkin();
1197         assertNotNull(tbSkin);
1198         ContextMenu tabsMenu = TabPaneSkinShim.getTabsMenu(tbSkin);
1199         assertNotNull(tabsMenu);
1200         assertEquals(&quot;ContextMenu should contain 3 items.&quot;, 3, tabsMenu.getItems().size());
1201 
1202         tabPane.getTabs().sort((o1, o2) -&gt; sortCompare(o1, o2));
1203         tk.firePulse();
1204         assertEquals(&quot;ContextMenu should contain 3 items.&quot;, 3, tabsMenu.getItems().size());
1205     }
1206 
1207     private int sortCompare(Tab t1, Tab t2) {
1208         return t2.getText().compareTo(t1.getText());
1209     }





































1210 }
</pre>
</td>
<td>
<hr />
<pre>
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
  23  * questions.
  24  */
  25 
  26 package test.javafx.scene.control;
  27 
  28 import com.sun.javafx.scene.SceneHelper;
  29 import static test.com.sun.javafx.scene.control.infrastructure.ControlTestUtils.assertPseudoClassDoesNotExist;
  30 import static test.com.sun.javafx.scene.control.infrastructure.ControlTestUtils.assertPseudoClassExists;
  31 import static test.com.sun.javafx.scene.control.infrastructure.ControlTestUtils.assertStyleClassContains;
  32 import static org.junit.Assert.assertEquals;
  33 import static org.junit.Assert.assertFalse;
  34 import static org.junit.Assert.assertNotNull;
  35 import static org.junit.Assert.assertNull;
  36 import static org.junit.Assert.assertSame;
  37 import static org.junit.Assert.assertTrue;
  38 import static org.junit.Assert.fail;
  39 
<span class="line-added">  40 import javafx.scene.control.SelectionModel;</span>
<span class="line-added">  41 import javafx.scene.control.Skin;</span>
  42 import test.com.sun.javafx.scene.control.infrastructure.StageLoader;
  43 import javafx.application.Platform;
  44 import javafx.beans.property.BooleanProperty;
  45 import javafx.beans.property.DoubleProperty;
  46 import javafx.beans.property.ObjectProperty;
  47 import javafx.beans.property.SimpleBooleanProperty;
  48 import javafx.beans.property.SimpleDoubleProperty;
  49 import javafx.beans.property.SimpleObjectProperty;
  50 import javafx.beans.value.ChangeListener;
  51 import javafx.css.CssMetaData;
  52 import javafx.css.StyleableProperty;
  53 import javafx.event.Event;
  54 import javafx.geometry.Bounds;
  55 import javafx.geometry.Side;
  56 import javafx.scene.Group;
  57 import javafx.scene.Scene;
  58 import javafx.scene.input.KeyEvent;
  59 import javafx.scene.input.MouseEvent;
  60 import javafx.scene.layout.StackPane;
  61 import javafx.scene.layout.VBox;
</pre>
<hr />
<pre>
1140         tabPane.getTabs().add(1, tabPane.getTabs().remove(0));
1141         tk.firePulse();
1142         tabPane.getSelectionModel().select(tab1);
1143         tk.firePulse();
1144 
1145         double xval = (tabPane.localToScene(tabPane.getLayoutBounds())).getMinX();
1146         double yval = (tabPane.localToScene(tabPane.getLayoutBounds())).getMinY();
1147 
1148         SceneHelper.processMouseEvent(scene,
1149             MouseEventGenerator.generateMouseEvent(MouseEvent.MOUSE_PRESSED, xval + 19, yval + 17));
1150         tk.firePulse();
1151         SceneHelper.processMouseEvent(scene,
1152             MouseEventGenerator.generateMouseEvent(MouseEvent.MOUSE_PRESSED, xval + 19, yval + 17));
1153         tk.firePulse();
1154 
1155         assertEquals(&quot;Tabpane should have 3 tabs.&quot;, 3, tabPane.getTabs().size());
1156         assertEquals(&quot;tab2 should be at index 0.&quot;, tab2, tabPane.getSelectionModel().getSelectedItem());
1157     }
1158 
1159     // Test for JDK-8154039

1160     @Test public void testSelectNonChildTab() {
1161         tabPane.getTabs().addAll(tab1);
1162         root.getChildren().add(tabPane);
1163         show();
1164         tk.firePulse();
<span class="line-modified">1165         WeakReference&lt;Tab&gt; weakTab = new WeakReference&lt;&gt;(new Tab(&quot;NonChildTab&quot;));</span>
1166         tabPane.getSelectionModel().select(weakTab.get());
1167         tk.firePulse();
<span class="line-modified">1168         attemptGC(10, weakTab);</span>
1169         tk.firePulse();
1170         assertNull(weakTab.get());
1171     }
1172 
<span class="line-modified">1173     private void attemptGC(int n, WeakReference&lt;?&gt; weakRef) {</span>
1174         // Attempt gc n times
1175         for (int i = 0; i &lt; n; i++) {
1176             System.gc();
1177             System.runFinalization();
1178 
<span class="line-modified">1179             if (weakRef.get() == null) {</span>
1180                 break;
1181             }
1182             try {
1183                 Thread.sleep(500);
1184             } catch (InterruptedException e) {
1185                 fail(&quot;InterruptedException occurred during Thread.sleep()&quot;);
1186             }
1187         }
1188     }
1189 
1190     // Test for JDK-8157690
1191     @Test public void testPopupItemsOnSortingTabs() {
1192         tabPane.setMaxSize(20, 20);
1193         root.getChildren().add(tabPane);
1194         tabPane.getTabs().addAll(tab1, tab2, tab3);
1195         show();
1196         tk.firePulse();
1197         TabPaneSkin tbSkin = (TabPaneSkin) tabPane.getSkin();
1198         assertNotNull(tbSkin);
1199         ContextMenu tabsMenu = TabPaneSkinShim.getTabsMenu(tbSkin);
1200         assertNotNull(tabsMenu);
1201         assertEquals(&quot;ContextMenu should contain 3 items.&quot;, 3, tabsMenu.getItems().size());
1202 
1203         tabPane.getTabs().sort((o1, o2) -&gt; sortCompare(o1, o2));
1204         tk.firePulse();
1205         assertEquals(&quot;ContextMenu should contain 3 items.&quot;, 3, tabsMenu.getItems().size());
1206     }
1207 
1208     private int sortCompare(Tab t1, Tab t2) {
1209         return t2.getText().compareTo(t1.getText());
1210     }
<span class="line-added">1211 </span>
<span class="line-added">1212     class TabPaneSkin1 extends TabPaneSkin {</span>
<span class="line-added">1213         TabPaneSkin1(TabPane tabPane) {</span>
<span class="line-added">1214             super(tabPane);</span>
<span class="line-added">1215         }</span>
<span class="line-added">1216     }</span>
<span class="line-added">1217 </span>
<span class="line-added">1218     @Ignore(&quot;JDK-8242621&quot;)</span>
<span class="line-added">1219     @Test</span>
<span class="line-added">1220     public void testNPEOnSwitchSkinAndChangeSelection() {</span>
<span class="line-added">1221         // Because of JDK-8242621, this test fails with NPE.</span>
<span class="line-added">1222         tabPane.getTabs().addAll(tab1, tab2);</span>
<span class="line-added">1223         root.getChildren().add(tabPane);</span>
<span class="line-added">1224         stage.show();</span>
<span class="line-added">1225         tk.firePulse();</span>
<span class="line-added">1226 </span>
<span class="line-added">1227         tabPane.setSkin(new TabPaneSkin1(tabPane));</span>
<span class="line-added">1228         tk.firePulse();</span>
<span class="line-added">1229         tabPane.getSelectionModel().select(1);</span>
<span class="line-added">1230         tk.firePulse();</span>
<span class="line-added">1231     }</span>
<span class="line-added">1232 </span>
<span class="line-added">1233     @Test</span>
<span class="line-added">1234     public void testSMLeakOnSwitchSkinAndSM() {</span>
<span class="line-added">1235         tabPane.getTabs().addAll(tab1, tab2);</span>
<span class="line-added">1236         root.getChildren().add(tabPane);</span>
<span class="line-added">1237         stage.show();</span>
<span class="line-added">1238         tk.firePulse();</span>
<span class="line-added">1239 </span>
<span class="line-added">1240         WeakReference&lt;SelectionModel&lt;Tab&gt;&gt; weakSMRef = new WeakReference&lt;&gt;(tabPane.getSelectionModel());</span>
<span class="line-added">1241         tabPane.setSkin(new TabPaneSkin1(tabPane));</span>
<span class="line-added">1242         tk.firePulse();</span>
<span class="line-added">1243         tabPane.setSelectionModel(TabPaneShim.getTabPaneSelectionModel(tabPane));</span>
<span class="line-added">1244         tk.firePulse();</span>
<span class="line-added">1245         attemptGC(10, weakSMRef);</span>
<span class="line-added">1246         assertNull(weakSMRef.get());</span>
<span class="line-added">1247     }</span>
1248 }
</pre>
</td>
</tr>
</table>
<center><a href="SelectionFocusModelMemoryTest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>