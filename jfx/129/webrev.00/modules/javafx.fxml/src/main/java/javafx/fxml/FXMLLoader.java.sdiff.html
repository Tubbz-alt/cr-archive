<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.fxml/src/main/java/javafx/fxml/FXMLLoader.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../../build.gradle.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../tests/system/src/test/java/test/launchertest/ModuleLauncherTest.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.fxml/src/main/java/javafx/fxml/FXMLLoader.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  46 import java.util.LinkedList;
  47 import java.util.List;
  48 import java.util.Map;
  49 import java.util.ResourceBundle;
  50 import java.util.Set;
  51 import java.util.regex.Pattern;
  52 
  53 import javafx.beans.DefaultProperty;
  54 import javafx.beans.InvalidationListener;
  55 import javafx.beans.property.Property;
  56 import javafx.beans.value.ChangeListener;
  57 import javafx.beans.value.ObservableValue;
  58 import javafx.collections.*;
  59 import javafx.event.Event;
  60 import javafx.event.EventHandler;
  61 import javafx.util.Builder;
  62 import javafx.util.BuilderFactory;
  63 import javafx.util.Callback;
  64 
  65 import javax.script.Bindings;


  66 import javax.script.ScriptContext;
  67 import javax.script.ScriptEngine;
  68 import javax.script.ScriptEngineManager;
  69 import javax.script.ScriptException;
  70 import javax.script.SimpleBindings;
  71 import javax.xml.stream.XMLInputFactory;
  72 import javax.xml.stream.XMLStreamConstants;
  73 import javax.xml.stream.XMLStreamException;
  74 import javax.xml.stream.XMLStreamReader;
  75 import javax.xml.stream.util.StreamReaderDelegate;
  76 
  77 import com.sun.javafx.beans.IDProperty;
  78 import com.sun.javafx.fxml.BeanAdapter;
  79 import com.sun.javafx.fxml.ParseTraceElement;
  80 import com.sun.javafx.fxml.PropertyNotFoundException;
  81 import com.sun.javafx.fxml.expression.Expression;
  82 import com.sun.javafx.fxml.expression.ExpressionValue;
  83 import com.sun.javafx.fxml.expression.KeyPath;
  84 import static com.sun.javafx.FXPermissions.MODIFY_FXML_CLASS_LOADER_PERMISSION;
  85 import com.sun.javafx.fxml.FXMLLoaderHelper;
</pre>
<hr />
<pre>
1546                 }
1547 
1548                 try {
1549                     URL location;
1550                     if (source.charAt(0) == &#39;/&#39;) {
1551                         // FIXME: JIGSAW -- use Class.getResourceAsStream if resource is in a module
1552                         location = cl.getResource(source.substring(1));
1553                     } else {
1554                         if (FXMLLoader.this.location == null) {
1555                             throw constructLoadException(&quot;Base location is undefined.&quot;);
1556                         }
1557 
1558                         location = new URL(FXMLLoader.this.location, source);
1559                     }
1560                     Bindings engineBindings = engine.getBindings(ScriptContext.ENGINE_SCOPE);
1561                     engineBindings.put(engine.FILENAME, location.getPath());
1562 
1563                     InputStreamReader scriptReader = null;
1564                     try {
1565                         scriptReader = new InputStreamReader(location.openStream(), charset);
<span class="line-modified">1566                         engine.eval(scriptReader);</span>





1567                     } catch(ScriptException exception) {
1568                         exception.printStackTrace();
1569                     } finally {
1570                         if (scriptReader != null) {
1571                             scriptReader.close();
1572                         }
1573                     }
1574                 } catch (IOException exception) {
1575                     throw constructLoadException(exception);
1576                 }
1577             }
1578         }
1579 
1580         @Override
1581         public void processEndElement() throws IOException {
1582             super.processEndElement();
1583 
1584             if (value != null &amp;&amp; !staticLoad) {
1585                 // Evaluate the script
1586                 try {
1587                     Bindings engineBindings = scriptEngine.getBindings(ScriptContext.ENGINE_SCOPE);
1588                     engineBindings.put(scriptEngine.FILENAME, location.getPath() + &quot;-script_starting_at_line_&quot;
1589                                        + (getLineNumber() - (int) ((String) value).codePoints().filter(c -&gt; c == &#39;\n&#39;).count()));
<span class="line-modified">1590                     scriptEngine.eval((String)value);</span>






1591                 } catch (ScriptException exception) {
1592                     System.err.println(exception.getMessage());
1593                 }
1594             }
1595         }
1596 
1597         @Override
1598         public void processCharacters() throws LoadException {
1599             if (source != null) {
1600                 throw constructLoadException(&quot;Script source already specified.&quot;);
1601             }
1602 
1603             if (scriptEngine == null &amp;&amp; !staticLoad) {
1604                 throw constructLoadException(&quot;Page language not specified.&quot;);
1605             }
1606 
1607             updateValue(xmlStreamReader.getText());
1608         }
1609 
1610         @Override
</pre>
<hr />
<pre>
1664 
1665     // Event handler that delegates to a method defined by the controller object
1666     private static class ControllerMethodEventHandler&lt;T extends Event&gt; implements EventHandler&lt;T&gt; {
1667         private final MethodHandler handler;
1668 
1669         public ControllerMethodEventHandler(MethodHandler handler) {
1670             this.handler = handler;
1671         }
1672 
1673         @Override
1674         public void handle(T event) {
1675             handler.invoke(event);
1676         }
1677     }
1678 
1679     // Event handler implemented in script code
1680     private static class ScriptEventHandler implements EventHandler&lt;Event&gt; {
1681         public final String script;
1682         public final ScriptEngine scriptEngine;
1683         public final String filename;


1684 
1685         public ScriptEventHandler(String script, ScriptEngine scriptEngine, String filename) {
1686             this.script = script;
1687             this.scriptEngine = scriptEngine;
1688             this.filename = filename;










1689         }
1690 
1691         @Override
1692         public void handle(Event event) {
1693             // Don&#39;t pollute the page namespace with values defined in the script
1694             Bindings engineBindings = scriptEngine.getBindings(ScriptContext.ENGINE_SCOPE);
1695             Bindings localBindings = scriptEngine.createBindings();
1696             localBindings.putAll(engineBindings);
1697             localBindings.put(EVENT_KEY, event);
1698             localBindings.put(scriptEngine.ARGV, new Object[]{event});
1699             localBindings.put(scriptEngine.FILENAME, filename);
1700             // Execute the script
1701             try {
<span class="line-modified">1702                 scriptEngine.eval(script, localBindings);</span>





1703             } catch (ScriptException exception){
1704                 throw new RuntimeException(exception);
1705             }
1706         }
1707     }
1708 
1709     // Observable list change listener
1710     private static class ObservableListChangeAdapter implements ListChangeListener {
1711         private final MethodHandler handler;
1712 
1713         public ObservableListChangeAdapter(MethodHandler handler) {
1714             this.handler = handler;
1715         }
1716 
1717         @Override
1718         @SuppressWarnings(&quot;unchecked&quot;)
1719         public void onChanged(Change change) {
1720             if (handler != null) {
1721                 handler.invoke(change);
1722             }
</pre>
</td>
<td>
<hr />
<pre>
  46 import java.util.LinkedList;
  47 import java.util.List;
  48 import java.util.Map;
  49 import java.util.ResourceBundle;
  50 import java.util.Set;
  51 import java.util.regex.Pattern;
  52 
  53 import javafx.beans.DefaultProperty;
  54 import javafx.beans.InvalidationListener;
  55 import javafx.beans.property.Property;
  56 import javafx.beans.value.ChangeListener;
  57 import javafx.beans.value.ObservableValue;
  58 import javafx.collections.*;
  59 import javafx.event.Event;
  60 import javafx.event.EventHandler;
  61 import javafx.util.Builder;
  62 import javafx.util.BuilderFactory;
  63 import javafx.util.Callback;
  64 
  65 import javax.script.Bindings;
<span class="line-added">  66 import javax.script.Compilable;</span>
<span class="line-added">  67 import javax.script.CompiledScript;</span>
  68 import javax.script.ScriptContext;
  69 import javax.script.ScriptEngine;
  70 import javax.script.ScriptEngineManager;
  71 import javax.script.ScriptException;
  72 import javax.script.SimpleBindings;
  73 import javax.xml.stream.XMLInputFactory;
  74 import javax.xml.stream.XMLStreamConstants;
  75 import javax.xml.stream.XMLStreamException;
  76 import javax.xml.stream.XMLStreamReader;
  77 import javax.xml.stream.util.StreamReaderDelegate;
  78 
  79 import com.sun.javafx.beans.IDProperty;
  80 import com.sun.javafx.fxml.BeanAdapter;
  81 import com.sun.javafx.fxml.ParseTraceElement;
  82 import com.sun.javafx.fxml.PropertyNotFoundException;
  83 import com.sun.javafx.fxml.expression.Expression;
  84 import com.sun.javafx.fxml.expression.ExpressionValue;
  85 import com.sun.javafx.fxml.expression.KeyPath;
  86 import static com.sun.javafx.FXPermissions.MODIFY_FXML_CLASS_LOADER_PERMISSION;
  87 import com.sun.javafx.fxml.FXMLLoaderHelper;
</pre>
<hr />
<pre>
1548                 }
1549 
1550                 try {
1551                     URL location;
1552                     if (source.charAt(0) == &#39;/&#39;) {
1553                         // FIXME: JIGSAW -- use Class.getResourceAsStream if resource is in a module
1554                         location = cl.getResource(source.substring(1));
1555                     } else {
1556                         if (FXMLLoader.this.location == null) {
1557                             throw constructLoadException(&quot;Base location is undefined.&quot;);
1558                         }
1559 
1560                         location = new URL(FXMLLoader.this.location, source);
1561                     }
1562                     Bindings engineBindings = engine.getBindings(ScriptContext.ENGINE_SCOPE);
1563                     engineBindings.put(engine.FILENAME, location.getPath());
1564 
1565                     InputStreamReader scriptReader = null;
1566                     try {
1567                         scriptReader = new InputStreamReader(location.openStream(), charset);
<span class="line-modified">1568                         if (engine instanceof Compilable) {</span>
<span class="line-added">1569                             ((Compilable) engine).compile(scriptReader).eval();</span>
<span class="line-added">1570                         }</span>
<span class="line-added">1571                         else {</span>
<span class="line-added">1572                            engine.eval(scriptReader);</span>
<span class="line-added">1573                         }</span>
1574                     } catch(ScriptException exception) {
1575                         exception.printStackTrace();
1576                     } finally {
1577                         if (scriptReader != null) {
1578                             scriptReader.close();
1579                         }
1580                     }
1581                 } catch (IOException exception) {
1582                     throw constructLoadException(exception);
1583                 }
1584             }
1585         }
1586 
1587         @Override
1588         public void processEndElement() throws IOException {
1589             super.processEndElement();
1590 
1591             if (value != null &amp;&amp; !staticLoad) {
1592                 // Evaluate the script
1593                 try {
1594                     Bindings engineBindings = scriptEngine.getBindings(ScriptContext.ENGINE_SCOPE);
1595                     engineBindings.put(scriptEngine.FILENAME, location.getPath() + &quot;-script_starting_at_line_&quot;
1596                                        + (getLineNumber() - (int) ((String) value).codePoints().filter(c -&gt; c == &#39;\n&#39;).count()));
<span class="line-modified">1597 </span>
<span class="line-added">1598                     if (scriptEngine instanceof Compilable) {</span>
<span class="line-added">1599                        ((Compilable) scriptEngine).compile((String)value).eval();</span>
<span class="line-added">1600                     }</span>
<span class="line-added">1601                     else {</span>
<span class="line-added">1602                        scriptEngine.eval((String)value);</span>
<span class="line-added">1603                     }</span>
1604                 } catch (ScriptException exception) {
1605                     System.err.println(exception.getMessage());
1606                 }
1607             }
1608         }
1609 
1610         @Override
1611         public void processCharacters() throws LoadException {
1612             if (source != null) {
1613                 throw constructLoadException(&quot;Script source already specified.&quot;);
1614             }
1615 
1616             if (scriptEngine == null &amp;&amp; !staticLoad) {
1617                 throw constructLoadException(&quot;Page language not specified.&quot;);
1618             }
1619 
1620             updateValue(xmlStreamReader.getText());
1621         }
1622 
1623         @Override
</pre>
<hr />
<pre>
1677 
1678     // Event handler that delegates to a method defined by the controller object
1679     private static class ControllerMethodEventHandler&lt;T extends Event&gt; implements EventHandler&lt;T&gt; {
1680         private final MethodHandler handler;
1681 
1682         public ControllerMethodEventHandler(MethodHandler handler) {
1683             this.handler = handler;
1684         }
1685 
1686         @Override
1687         public void handle(T event) {
1688             handler.invoke(event);
1689         }
1690     }
1691 
1692     // Event handler implemented in script code
1693     private static class ScriptEventHandler implements EventHandler&lt;Event&gt; {
1694         public final String script;
1695         public final ScriptEngine scriptEngine;
1696         public final String filename;
<span class="line-added">1697         public CompiledScript compiledScript;</span>
<span class="line-added">1698         public boolean isCompiled=false;</span>
1699 
1700         public ScriptEventHandler(String script, ScriptEngine scriptEngine, String filename) {
1701             this.script = script;
1702             this.scriptEngine = scriptEngine;
1703             this.filename = filename;
<span class="line-added">1704             if (scriptEngine instanceof Compilable) {</span>
<span class="line-added">1705                try {</span>
<span class="line-added">1706                   // supply the filename to the scriptEngine engine scope Bindings in case it is needed for compilation</span>
<span class="line-added">1707                   scriptEngine.getBindings(ScriptContext.ENGINE_SCOPE).put(scriptEngine.FILENAME, filename);</span>
<span class="line-added">1708                   this.compiledScript = ((Compilable) scriptEngine).compile(script);</span>
<span class="line-added">1709                   this.isCompiled = true;</span>
<span class="line-added">1710                } catch (ScriptException exception){</span>
<span class="line-added">1711                    throw new RuntimeException(exception);</span>
<span class="line-added">1712                }</span>
<span class="line-added">1713             }</span>
1714         }
1715 
1716         @Override
1717         public void handle(Event event) {
1718             // Don&#39;t pollute the page namespace with values defined in the script
1719             Bindings engineBindings = scriptEngine.getBindings(ScriptContext.ENGINE_SCOPE);
1720             Bindings localBindings = scriptEngine.createBindings();
1721             localBindings.putAll(engineBindings);
1722             localBindings.put(EVENT_KEY, event);
1723             localBindings.put(scriptEngine.ARGV, new Object[]{event});
1724             localBindings.put(scriptEngine.FILENAME, filename);
1725             // Execute the script
1726             try {
<span class="line-modified">1727                 if (isCompiled) {</span>
<span class="line-added">1728                    compiledScript.eval(localBindings);</span>
<span class="line-added">1729                 }</span>
<span class="line-added">1730                 else {</span>
<span class="line-added">1731                    scriptEngine.eval(script, localBindings);</span>
<span class="line-added">1732                 }</span>
1733             } catch (ScriptException exception){
1734                 throw new RuntimeException(exception);
1735             }
1736         }
1737     }
1738 
1739     // Observable list change listener
1740     private static class ObservableListChangeAdapter implements ListChangeListener {
1741         private final MethodHandler handler;
1742 
1743         public ObservableListChangeAdapter(MethodHandler handler) {
1744             this.handler = handler;
1745         }
1746 
1747         @Override
1748         @SuppressWarnings(&quot;unchecked&quot;)
1749         public void onChanged(Change change) {
1750             if (handler != null) {
1751                 handler.invoke(change);
1752             }
</pre>
</td>
</tr>
</table>
<center><a href="../../../../../../../build.gradle.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../tests/system/src/test/java/test/launchertest/ModuleLauncherTest.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>