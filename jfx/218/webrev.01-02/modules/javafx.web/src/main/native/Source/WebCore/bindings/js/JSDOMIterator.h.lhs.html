<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/WebCore/bindings/js/JSDOMIterator.h</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (C) 2016 Canon, Inc. All rights reserved.
  3  * Copyright (C) 2016-2017 Apple Inc. All rights reserved.
  4  *
  5  * Redistribution and use in source and binary forms, with or without
  6  * modification, are permitted provided that the following conditions
  7  * are met:
  8  * 1. Redistributions of source code must retain the above copyright
  9  *    notice, this list of conditions and the following disclaimer.
 10  * 2. Redistributions in binary form must reproduce the above copyright
 11  *    notice, this list of conditions and the following disclaimer in the
 12  *    documentation and/or other materials provided with the distribution.
 13  *
 14  * THIS SOFTWARE IS PROVIDED BY CANON INC. ``AS IS&#39;&#39; AND ANY
 15  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 16  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 17  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL CANON INC. OR
 18  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 19  * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 20  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 21  * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 22  * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 23  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 24  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 25  */
 26 
 27 #pragma once
 28 
 29 #include &quot;JSDOMConvert.h&quot;
 30 #include &lt;JavaScriptCore/IteratorPrototype.h&gt;
<a name="1" id="anc1"></a>
 31 #include &lt;type_traits&gt;
 32 
 33 namespace WebCore {
 34 
 35 void addValueIterableMethods(JSC::JSGlobalObject&amp;, JSC::JSObject&amp;);
 36 
 37 enum class JSDOMIteratorType { Set, Map };
 38 
 39 // struct IteratorTraits {
 40 //     static constexpr JSDOMIteratorType type = [Map|Set];
 41 //     using KeyType = [IDLType|void];
 42 //     using ValueType = [IDLType];
 43 // };
 44 
 45 template&lt;typename T, typename U = void&gt; using EnableIfMap = typename std::enable_if&lt;T::type == JSDOMIteratorType::Map, U&gt;::type;
 46 template&lt;typename T, typename U = void&gt; using EnableIfSet = typename std::enable_if&lt;T::type == JSDOMIteratorType::Set, U&gt;::type;
 47 
<a name="2" id="anc2"></a><span class="line-modified"> 48 template&lt;typename JSWrapper, typename IteratorTraits&gt; class JSDOMIteratorPrototype : public JSC::JSNonFinalObject {</span>
 49 public:
 50     using Base = JSC::JSNonFinalObject;
 51     using DOMWrapped = typename JSWrapper::DOMWrapped;
 52 
 53     static JSDOMIteratorPrototype* create(JSC::VM&amp; vm, JSC::JSGlobalObject* globalObject, JSC::Structure* structure)
 54     {
<a name="3" id="anc3"></a>
 55         JSDOMIteratorPrototype* prototype = new (NotNull, JSC::allocateCell&lt;JSDOMIteratorPrototype&gt;(vm.heap)) JSDOMIteratorPrototype(vm, structure);
 56         prototype-&gt;finishCreation(vm, globalObject);
 57         return prototype;
 58     }
 59 
 60     DECLARE_INFO;
 61 
 62     static JSC::Structure* createStructure(JSC::VM&amp; vm, JSC::JSGlobalObject* globalObject, JSC::JSValue prototype)
 63     {
 64         return JSC::Structure::create(vm, globalObject, prototype, JSC::TypeInfo(JSC::ObjectType, StructureFlags), info());
 65     }
 66 
<a name="4" id="anc4"></a><span class="line-modified"> 67     static JSC::EncodedJSValue JSC_HOST_CALL next(JSC::ExecState*);</span>
 68 
 69 private:
 70     JSDOMIteratorPrototype(JSC::VM&amp; vm, JSC::Structure* structure) : Base(vm, structure) { }
 71 
 72     void finishCreation(JSC::VM&amp;, JSC::JSGlobalObject*);
 73 };
 74 
<a name="5" id="anc5"></a><span class="line-modified"> 75 enum class IterationKind { Key, Value, KeyValue };</span>
 76 
 77 template&lt;typename JSWrapper, typename IteratorTraits&gt; class JSDOMIterator : public JSDOMObject {
 78 public:
 79     using Base = JSDOMObject;
 80 
 81     using Wrapper = JSWrapper;
 82     using Traits = IteratorTraits;
 83 
 84     using DOMWrapped = typename Wrapper::DOMWrapped;
 85     using Prototype = JSDOMIteratorPrototype&lt;Wrapper, Traits&gt;;
 86 
 87     DECLARE_INFO;
 88 
 89     static JSC::Structure* createStructure(JSC::VM&amp; vm, JSC::JSGlobalObject* globalObject, JSC::JSValue prototype)
 90     {
 91         return JSC::Structure::create(vm, globalObject, prototype, JSC::TypeInfo(JSC::ObjectType, StructureFlags), info());
 92     }
 93 
 94     static JSDOMIterator* create(JSC::VM&amp; vm, JSC::Structure* structure, JSWrapper&amp; iteratedObject, IterationKind kind)
 95     {
 96         JSDOMIterator* instance = new (NotNull, JSC::allocateCell&lt;JSDOMIterator&gt;(vm.heap)) JSDOMIterator(structure, iteratedObject, kind);
 97         instance-&gt;finishCreation(vm);
 98         return instance;
 99     }
100 
101     static Prototype* createPrototype(JSC::VM&amp; vm, JSC::JSGlobalObject&amp; globalObject)
102     {
103         return Prototype::create(vm, &amp;globalObject, Prototype::createStructure(vm, &amp;globalObject, globalObject.iteratorPrototype()));
104     }
105 
<a name="6" id="anc6"></a><span class="line-modified">106     JSC::JSValue next(JSC::ExecState&amp;);</span>
107 
108 private:
109     JSDOMIterator(JSC::Structure* structure, JSWrapper&amp; iteratedObject, IterationKind kind)
110         : Base(structure, *iteratedObject.globalObject())
111         , m_iterator(iteratedObject.wrapped().createIterator())
112         , m_kind(kind)
113     {
114     }
115 
<a name="7" id="anc7"></a><span class="line-modified">116     template&lt;typename IteratorValue, typename T = Traits&gt; EnableIfMap&lt;T, JSC::JSValue&gt; asJS(JSC::ExecState&amp;, IteratorValue&amp;);</span>
<span class="line-modified">117     template&lt;typename IteratorValue, typename T = Traits&gt; EnableIfSet&lt;T, JSC::JSValue&gt; asJS(JSC::ExecState&amp;, IteratorValue&amp;);</span>
118 
119     static void destroy(JSC::JSCell*);
120 
121     Optional&lt;typename DOMWrapped::Iterator&gt; m_iterator;
122     IterationKind m_kind;
123 };
124 
<a name="8" id="anc8"></a><span class="line-modified">125 inline JSC::JSValue jsPair(JSC::ExecState&amp; state, JSDOMGlobalObject&amp; globalObject, JSC::JSValue value1, JSC::JSValue value2)</span>
126 {
127     JSC::MarkedArgumentBuffer arguments;
128     arguments.append(value1);
129     arguments.append(value2);
130     ASSERT(!arguments.hasOverflowed());
<a name="9" id="anc9"></a><span class="line-modified">131     return constructArray(&amp;state, nullptr, &amp;globalObject, arguments);</span>
132 }
133 
134 template&lt;typename FirstType, typename SecondType, typename T, typename U&gt;
<a name="10" id="anc10"></a><span class="line-modified">135 inline JSC::JSValue jsPair(JSC::ExecState&amp; state, JSDOMGlobalObject&amp; globalObject, const T&amp; value1, const U&amp; value2)</span>
136 {
<a name="11" id="anc11"></a><span class="line-modified">137     return jsPair(state, globalObject, toJS&lt;FirstType&gt;(state, globalObject, value1), toJS&lt;SecondType&gt;(state, globalObject, value2));</span>
138 }
139 
140 template&lt;typename JSIterator&gt; JSC::JSValue iteratorCreate(typename JSIterator::Wrapper&amp;, IterationKind);
<a name="12" id="anc12"></a><span class="line-modified">141 template&lt;typename JSIterator&gt; JSC::JSValue iteratorForEach(JSC::ExecState&amp;, typename JSIterator::Wrapper&amp;, JSC::ThrowScope&amp;);</span>
142 
143 template&lt;typename JSIterator&gt; JSC::JSValue iteratorCreate(typename JSIterator::Wrapper&amp; thisObject, IterationKind kind)
144 {
145     ASSERT(thisObject.globalObject());
146     JSDOMGlobalObject&amp; globalObject = *thisObject.globalObject();
147     return JSIterator::create(globalObject.vm(), getDOMStructure&lt;JSIterator&gt;(globalObject.vm(), globalObject), thisObject, kind);
148 }
149 
150 template&lt;typename JSWrapper, typename IteratorTraits&gt;
<a name="13" id="anc13"></a><span class="line-modified">151 template&lt;typename IteratorValue, typename T&gt; inline EnableIfMap&lt;T, JSC::JSValue&gt; JSDOMIterator&lt;JSWrapper, IteratorTraits&gt;::asJS(JSC::ExecState&amp; state, IteratorValue&amp; value)</span>
152 {
153     ASSERT(value);
154 
155     switch (m_kind) {
<a name="14" id="anc14"></a><span class="line-modified">156     case IterationKind::Key:</span>
<span class="line-modified">157         return toJS&lt;typename Traits::KeyType&gt;(state, *globalObject(), value-&gt;key);</span>
<span class="line-modified">158     case IterationKind::Value:</span>
<span class="line-modified">159         return toJS&lt;typename Traits::ValueType&gt;(state, *globalObject(), value-&gt;value);</span>
<span class="line-modified">160     case IterationKind::KeyValue:</span>
<span class="line-modified">161         return jsPair&lt;typename Traits::KeyType, typename Traits::ValueType&gt;(state, *globalObject(), value-&gt;key, value-&gt;value);</span>
162     };
163 
164     ASSERT_NOT_REACHED();
165     return { };
166 }
167 
168 template&lt;typename JSWrapper, typename IteratorTraits&gt;
<a name="15" id="anc15"></a><span class="line-modified">169 template&lt;typename IteratorValue, typename T&gt; inline EnableIfSet&lt;T, JSC::JSValue&gt; JSDOMIterator&lt;JSWrapper, IteratorTraits&gt;::asJS(JSC::ExecState&amp; state, IteratorValue&amp; value)</span>
170 {
171     ASSERT(value);
172 
173     auto globalObject = this-&gt;globalObject();
<a name="16" id="anc16"></a><span class="line-modified">174     auto result = toJS&lt;typename Traits::ValueType&gt;(state, *globalObject, value);</span>
175 
176     switch (m_kind) {
<a name="17" id="anc17"></a><span class="line-modified">177     case IterationKind::Key:</span>
<span class="line-modified">178     case IterationKind::Value:</span>
179         return result;
<a name="18" id="anc18"></a><span class="line-modified">180     case IterationKind::KeyValue:</span>
<span class="line-modified">181         return jsPair(state, *globalObject, result, result);</span>
182     };
183 
184     ASSERT_NOT_REACHED();
185     return { };
186 }
187 
<a name="19" id="anc19"></a><span class="line-modified">188 template&lt;typename JSIterator, typename IteratorValue&gt; EnableIfMap&lt;typename JSIterator::Traits&gt; appendForEachArguments(JSC::ExecState&amp; state, JSDOMGlobalObject&amp; globalObject, JSC::MarkedArgumentBuffer&amp; arguments, IteratorValue&amp; value)</span>
189 {
190     ASSERT(value);
<a name="20" id="anc20"></a><span class="line-modified">191     arguments.append(toJS&lt;typename JSIterator::Traits::ValueType&gt;(state, globalObject, value-&gt;value));</span>
<span class="line-modified">192     arguments.append(toJS&lt;typename JSIterator::Traits::KeyType&gt;(state, globalObject, value-&gt;key));</span>
193 }
194 
<a name="21" id="anc21"></a><span class="line-modified">195 template&lt;typename JSIterator, typename IteratorValue&gt; EnableIfSet&lt;typename JSIterator::Traits&gt; appendForEachArguments(JSC::ExecState&amp; state, JSDOMGlobalObject&amp; globalObject, JSC::MarkedArgumentBuffer&amp; arguments, IteratorValue&amp; value)</span>
196 {
197     ASSERT(value);
<a name="22" id="anc22"></a><span class="line-modified">198     auto argument = toJS&lt;typename JSIterator::Traits::ValueType&gt;(state, globalObject, value);</span>
199     arguments.append(argument);
200     arguments.append(argument);
201 }
202 
<a name="23" id="anc23"></a><span class="line-modified">203 template&lt;typename JSIterator&gt; JSC::JSValue iteratorForEach(JSC::ExecState&amp; state, typename JSIterator::Wrapper&amp; thisObject, JSC::ThrowScope&amp; scope)</span>
204 {
<a name="24" id="anc24"></a><span class="line-modified">205     JSC::JSValue callback = state.argument(0);</span>
<span class="line-modified">206     JSC::JSValue thisValue = state.argument(1);</span>
207 
208     JSC::CallData callData;
<a name="25" id="anc25"></a><span class="line-modified">209     JSC::CallType callType = JSC::getCallData(state.vm(), callback, callData);</span>
210     if (callType == JSC::CallType::None)
<a name="26" id="anc26"></a><span class="line-modified">211         return throwTypeError(&amp;state, scope, &quot;Cannot call callback&quot;_s);</span>
212 
213     auto iterator = thisObject.wrapped().createIterator();
214     while (auto value = iterator.next()) {
215         JSC::MarkedArgumentBuffer arguments;
<a name="27" id="anc27"></a><span class="line-modified">216         appendForEachArguments&lt;JSIterator&gt;(state, *thisObject.globalObject(), arguments, value);</span>
217         arguments.append(&amp;thisObject);
218         if (UNLIKELY(arguments.hasOverflowed())) {
<a name="28" id="anc28"></a><span class="line-modified">219             throwOutOfMemoryError(&amp;state, scope);</span>
220             return { };
221         }
<a name="29" id="anc29"></a><span class="line-modified">222         JSC::call(&amp;state, callback, callType, callData, thisValue, arguments);</span>
223         if (UNLIKELY(scope.exception()))
224             break;
225     }
226     return JSC::jsUndefined();
227 }
228 
229 template&lt;typename JSWrapper, typename IteratorTraits&gt;
230 void JSDOMIterator&lt;JSWrapper, IteratorTraits&gt;::destroy(JSCell* cell)
231 {
232     JSDOMIterator&lt;JSWrapper, IteratorTraits&gt;* thisObject = static_cast&lt;JSDOMIterator&lt;JSWrapper, IteratorTraits&gt;*&gt;(cell);
233     thisObject-&gt;JSDOMIterator&lt;JSWrapper, IteratorTraits&gt;::~JSDOMIterator();
234 }
235 
236 template&lt;typename JSWrapper, typename IteratorTraits&gt;
<a name="30" id="anc30"></a><span class="line-modified">237 JSC::JSValue JSDOMIterator&lt;JSWrapper, IteratorTraits&gt;::next(JSC::ExecState&amp; state)</span>
238 {
239     if (m_iterator) {
240         auto iteratorValue = m_iterator-&gt;next();
241         if (iteratorValue)
<a name="31" id="anc31"></a><span class="line-modified">242             return createIteratorResultObject(&amp;state, asJS(state, iteratorValue), false);</span>
243         m_iterator = WTF::nullopt;
244     }
<a name="32" id="anc32"></a><span class="line-modified">245     return createIteratorResultObject(&amp;state, JSC::jsUndefined(), true);</span>
246 }
247 
248 template&lt;typename JSWrapper, typename IteratorTraits&gt;
<a name="33" id="anc33"></a><span class="line-modified">249 JSC::EncodedJSValue JSC_HOST_CALL JSDOMIteratorPrototype&lt;JSWrapper, IteratorTraits&gt;::next(JSC::ExecState* state)</span>
250 {
<a name="34" id="anc34"></a><span class="line-modified">251     JSC::VM&amp; vm = state-&gt;vm();</span>
252     auto scope = DECLARE_THROW_SCOPE(vm);
253 
<a name="35" id="anc35"></a><span class="line-modified">254     auto iterator = JSC::jsDynamicCast&lt;JSDOMIterator&lt;JSWrapper, IteratorTraits&gt;*&gt;(vm, state-&gt;thisValue());</span>
255     if (!iterator)
<a name="36" id="anc36"></a><span class="line-modified">256         return JSC::JSValue::encode(throwTypeError(state, scope, &quot;Cannot call next() on a non-Iterator object&quot;_s));</span>
257 
<a name="37" id="anc37"></a><span class="line-modified">258     return JSC::JSValue::encode(iterator-&gt;next(*state));</span>
259 }
260 
261 template&lt;typename JSWrapper, typename IteratorTraits&gt;
262 void JSDOMIteratorPrototype&lt;JSWrapper, IteratorTraits&gt;::finishCreation(JSC::VM&amp; vm, JSC::JSGlobalObject* globalObject)
263 {
264     Base::finishCreation(vm);
265     ASSERT(inherits(vm, info()));
266 
<a name="38" id="anc38"></a>
267     JSC_NATIVE_INTRINSIC_FUNCTION_WITHOUT_TRANSITION(vm.propertyNames-&gt;next, next, 0, 0, JSC::NoIntrinsic);
268 }
269 
270 }
<a name="39" id="anc39"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="39" type="hidden" />
</body>
</html>