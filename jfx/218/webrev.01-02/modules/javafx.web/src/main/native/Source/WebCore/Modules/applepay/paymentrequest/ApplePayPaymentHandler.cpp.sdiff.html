<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WebCore/Modules/applepay/paymentrequest/ApplePayPaymentHandler.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../PaymentSession.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="ApplePayPaymentHandler.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/Modules/applepay/paymentrequest/ApplePayPaymentHandler.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 24  */
 25 
 26 #include &quot;config.h&quot;
 27 #include &quot;ApplePayPaymentHandler.h&quot;
 28 
 29 #if ENABLE(APPLE_PAY) &amp;&amp; ENABLE(PAYMENT_REQUEST)
 30 
 31 #include &quot;AddressErrors.h&quot;
 32 #include &quot;ApplePayContactField.h&quot;
 33 #include &quot;ApplePayMerchantCapability.h&quot;
 34 #include &quot;ApplePayModifier.h&quot;
 35 #include &quot;ApplePayPayment.h&quot;
 36 #include &quot;ApplePaySessionPaymentRequest.h&quot;
 37 #include &quot;Document.h&quot;
 38 #include &quot;EventNames.h&quot;
 39 #include &quot;Frame.h&quot;
 40 #include &quot;JSApplePayError.h&quot;
 41 #include &quot;JSApplePayPayment.h&quot;
 42 #include &quot;JSApplePayPaymentMethod.h&quot;
 43 #include &quot;JSApplePayRequest.h&quot;

 44 #include &quot;LinkIconCollector.h&quot;
 45 #include &quot;MerchantValidationEvent.h&quot;
 46 #include &quot;Page.h&quot;
 47 #include &quot;PayerErrorFields.h&quot;
 48 #include &quot;Payment.h&quot;
 49 #include &quot;PaymentAuthorizationStatus.h&quot;
 50 #include &quot;PaymentContact.h&quot;
 51 #include &quot;PaymentCoordinator.h&quot;
 52 #include &quot;PaymentMerchantSession.h&quot;
 53 #include &quot;PaymentMethod.h&quot;

 54 #include &quot;PaymentRequestValidator.h&quot;
 55 #include &quot;PaymentResponse.h&quot;
 56 #include &quot;PaymentValidationErrors.h&quot;
 57 #include &quot;Settings.h&quot;

 58 
 59 namespace WebCore {
 60 






















 61 bool ApplePayPaymentHandler::handlesIdentifier(const PaymentRequest::MethodIdentifier&amp; identifier)
 62 {
 63     if (!WTF::holds_alternative&lt;URL&gt;(identifier))
 64         return false;
 65 
 66     auto&amp; url = WTF::get&lt;URL&gt;(identifier);
 67     return url.host() == &quot;apple.com&quot; &amp;&amp; url.path() == &quot;/apple-pay&quot;;
 68 }
 69 
 70 static inline PaymentCoordinator&amp; paymentCoordinator(Document&amp; document)
 71 {
 72     ASSERT(document.page());
 73     return document.page()-&gt;paymentCoordinator();
 74 }
 75 
 76 bool ApplePayPaymentHandler::hasActiveSession(Document&amp; document)
 77 {
 78     return WebCore::paymentCoordinator(document).hasActiveSession();
 79 }
 80 
</pre>
<hr />
<pre>
140         return ApplePaySessionPaymentRequest::ShippingType::StorePickup;
141     }
142 
143     ASSERT_NOT_REACHED();
144     return ApplePaySessionPaymentRequest::ShippingType::Shipping;
145 }
146 
147 static ExceptionOr&lt;ApplePaySessionPaymentRequest::ShippingMethod&gt; convertAndValidate(const PaymentShippingOption&amp; shippingOption, const String&amp; expectedCurrency)
148 {
149     auto exception = validate(shippingOption.amount, expectedCurrency);
150     if (exception.hasException())
151         return exception.releaseException();
152 
153     ApplePaySessionPaymentRequest::ShippingMethod result;
154     result.amount = shippingOption.amount.value;
155     result.label = shippingOption.label;
156     result.identifier = shippingOption.id;
157     return { WTFMove(result) };
158 }
159 
<span class="line-modified">160 ExceptionOr&lt;void&gt; ApplePayPaymentHandler::convertData(JSC::JSValue&amp;&amp; data)</span>
161 {
<span class="line-modified">162     if (data.isEmpty())</span>
<span class="line-modified">163         return Exception { TypeError, &quot;Missing payment method data.&quot; };</span>
<span class="line-modified">164 </span>
<span class="line-removed">165     auto&amp; context = *scriptExecutionContext();</span>
<span class="line-removed">166     auto throwScope = DECLARE_THROW_SCOPE(context.vm());</span>
<span class="line-removed">167     auto applePayRequest = convertDictionary&lt;ApplePayRequest&gt;(*context.execState(), WTFMove(data));</span>
<span class="line-removed">168     if (throwScope.exception())</span>
<span class="line-removed">169         return Exception { ExistingExceptionError };</span>
170 
<span class="line-modified">171     m_applePayRequest = WTFMove(applePayRequest);</span>
172     return { };
173 }
174 
175 static void mergePaymentOptions(const PaymentOptions&amp; options, ApplePaySessionPaymentRequest&amp; request)
176 {
177     auto requiredShippingContactFields = request.requiredShippingContactFields();
178     requiredShippingContactFields.email |= options.requestPayerEmail;
179     requiredShippingContactFields.name |= options.requestPayerName;
180     requiredShippingContactFields.phone |= options.requestPayerPhone;
181     requiredShippingContactFields.postalAddress |= options.requestShipping;
182     request.setRequiredShippingContactFields(requiredShippingContactFields);
183 
184     if (options.requestShipping)
185         request.setShippingType(convert(options.shippingType));
186 }
187 
188 ExceptionOr&lt;void&gt; ApplePayPaymentHandler::show(Document&amp; document)
189 {
190     auto validatedRequest = convertAndValidate(document, m_applePayRequest-&gt;version, *m_applePayRequest, paymentCoordinator());
191     if (validatedRequest.hasException())
</pre>
<hr />
<pre>
264 
265     auto convertedLineItems = convertAndValidate(details.displayItems, currency);
266     if (convertedLineItems.hasException())
267         return convertedLineItems.releaseException();
268     auto lineItems = convertedLineItems.releaseReturnValue();
269 
270     if (!m_selectedPaymentMethodType)
271         return ApplePaySessionPaymentRequest::TotalAndLineItems { WTFMove(total), WTFMove(lineItems) };
272 
273     auto&amp; modifiers = details.modifiers;
274     auto&amp; serializedModifierData = m_paymentRequest-&gt;serializedModifierData();
275     ASSERT(modifiers.size() == serializedModifierData.size());
276     for (size_t i = 0; i &lt; modifiers.size(); ++i) {
277         auto convertedIdentifier = convertAndValidatePaymentMethodIdentifier(modifiers[i].supportedMethods);
278         if (!convertedIdentifier || !handlesIdentifier(*convertedIdentifier))
279             continue;
280 
281         if (serializedModifierData[i].isEmpty())
282             continue;
283 
<span class="line-modified">284         auto&amp; execState = *document().execState();</span>
<span class="line-modified">285         auto scope = DECLARE_THROW_SCOPE(execState.vm());</span>
286         JSC::JSValue data;
287         {
<span class="line-modified">288             auto lock = JSC::JSLockHolder { &amp;execState };</span>
<span class="line-modified">289             data = JSONParse(&amp;execState, serializedModifierData[i]);</span>
290             if (scope.exception())
291                 return Exception { ExistingExceptionError };
292         }
293 
<span class="line-modified">294         auto applePayModifier = convertDictionary&lt;ApplePayModifier&gt;(execState, WTFMove(data));</span>
295         if (scope.exception())
296             return Exception { ExistingExceptionError };
297 
298         if (applePayModifier.paymentMethodType != *m_selectedPaymentMethodType)
299             continue;
300 
301         if (modifiers[i].total) {
302             auto totalOverride = convertAndValidate(*modifiers[i].total, currency);
303             if (totalOverride.hasException())
304                 return totalOverride.releaseException();
305             total = totalOverride.releaseReturnValue();
306         }
307 
308         auto additionalDisplayItems = convertAndValidate(modifiers[i].additionalDisplayItems, currency);
309         if (additionalDisplayItems.hasException())
310             return additionalDisplayItems.releaseException();
311         lineItems.appendVector(additionalDisplayItems.releaseReturnValue());
312         break;
313     }
314 
</pre>
<hr />
<pre>
456 {
457     ASSERT(m_isUpdating);
458     m_isUpdating = false;
459 
460     ShippingMethodUpdate update;
461 
462     auto newTotalAndLineItems = computeTotalAndLineItems();
463     if (newTotalAndLineItems.hasException())
464         return newTotalAndLineItems.releaseException();
465     update.newTotalAndLineItems = newTotalAndLineItems.releaseReturnValue();
466 
467     paymentCoordinator().completeShippingMethodSelection(WTFMove(update));
468     return { };
469 }
470 
471 ExceptionOr&lt;void&gt; ApplePayPaymentHandler::paymentMethodUpdated()
472 {
473     ASSERT(m_isUpdating);
474     m_isUpdating = false;
475 
<span class="line-removed">476     PaymentMethodUpdate update;</span>
<span class="line-removed">477 </span>
478     auto newTotalAndLineItems = computeTotalAndLineItems();
479     if (newTotalAndLineItems.hasException())
480         return newTotalAndLineItems.releaseException();
<span class="line-removed">481     update.newTotalAndLineItems = newTotalAndLineItems.releaseReturnValue();</span>
482 
<span class="line-modified">483     paymentCoordinator().completePaymentMethodSelection(WTFMove(update));</span>
484     return { };
485 }
486 
487 void ApplePayPaymentHandler::complete(Optional&lt;PaymentComplete&gt;&amp;&amp; result)
488 {
489     if (!result) {
490         ASSERT(isFinalStateResult(WTF::nullopt));
491         paymentCoordinator().completePaymentSession(WTF::nullopt);
492         return;
493     }
494 
495     PaymentAuthorizationResult authorizationResult;
496     switch (*result) {
497     case PaymentComplete::Fail:
498     case PaymentComplete::Unknown:
499         authorizationResult.status = PaymentAuthorizationStatus::Failure;
500         break;
501     case PaymentComplete::Success:
502         authorizationResult.status = PaymentAuthorizationStatus::Success;
503         break;
</pre>
<hr />
<pre>
528     return { };
529 }
530 
531 unsigned ApplePayPaymentHandler::version() const
532 {
533     return m_applePayRequest ? m_applePayRequest-&gt;version : 0;
534 }
535 
536 void ApplePayPaymentHandler::validateMerchant(URL&amp;&amp; validationURL)
537 {
538     if (validationURL.isValid())
539         m_paymentRequest-&gt;dispatchEvent(MerchantValidationEvent::create(eventNames().merchantvalidationEvent, WTF::get&lt;URL&gt;(m_identifier).string(), WTFMove(validationURL)).get());
540 }
541 
542 static Ref&lt;PaymentAddress&gt; convert(const ApplePayPaymentContact&amp; contact)
543 {
544     return PaymentAddress::create(contact.countryCode, contact.addressLines.valueOr(Vector&lt;String&gt;()), contact.administrativeArea, contact.locality, contact.subLocality, contact.postalCode, String(), String(), contact.localizedName, contact.phoneNumber);
545 }
546 
547 template&lt;typename T&gt;
<span class="line-modified">548 static JSC::Strong&lt;JSC::JSObject&gt; toJSDictionary(JSC::ExecState&amp; execState, const T&amp; value)</span>
549 {
<span class="line-modified">550     JSC::JSLockHolder lock { &amp;execState };</span>
<span class="line-modified">551     return { execState.vm(), asObject(toJS&lt;IDLDictionary&lt;T&gt;&gt;(execState, *JSC::jsCast&lt;JSDOMGlobalObject*&gt;(execState.lexicalGlobalObject()), value)) };</span>
552 }
553 
554 void ApplePayPaymentHandler::didAuthorizePayment(const Payment&amp; payment)
555 {
556     ASSERT(!m_isUpdating);
557 
558     auto applePayPayment = payment.toApplePayPayment(version());
559     auto shippingContact = applePayPayment.shippingContact.valueOr(ApplePayPaymentContact());
<span class="line-modified">560     auto detailsFunction = [applePayPayment = WTFMove(applePayPayment)](JSC::ExecState&amp; execState) {</span>
<span class="line-modified">561         return toJSDictionary(execState, applePayPayment);</span>
562     };
563 
564     m_paymentRequest-&gt;accept(WTF::get&lt;URL&gt;(m_identifier).string(), WTFMove(detailsFunction), convert(shippingContact), shippingContact.localizedName, shippingContact.emailAddress, shippingContact.phoneNumber);
565 }
566 
567 void ApplePayPaymentHandler::didSelectShippingMethod(const ApplePaySessionPaymentRequest::ShippingMethod&amp; shippingMethod)
568 {
569     ASSERT(!m_isUpdating);
570     m_isUpdating = true;
571 
572     m_paymentRequest-&gt;shippingOptionChanged(shippingMethod.identifier);
573 }
574 
575 void ApplePayPaymentHandler::didSelectShippingContact(const PaymentContact&amp; shippingContact)
576 {
577     ASSERT(!m_isUpdating);
578     m_isUpdating = true;
579 
580     m_paymentRequest-&gt;shippingAddressChanged(convert(shippingContact.toApplePayPaymentContact(version())));
581 }
582 
583 void ApplePayPaymentHandler::didSelectPaymentMethod(const PaymentMethod&amp; paymentMethod)
584 {
585     ASSERT(!m_isUpdating);
586     m_isUpdating = true;
587 
588     auto applePayPaymentMethod = paymentMethod.toApplePayPaymentMethod();
589     m_selectedPaymentMethodType = applePayPaymentMethod.type;
<span class="line-modified">590     m_paymentRequest-&gt;paymentMethodChanged(WTF::get&lt;URL&gt;(m_identifier).string(), [applePayPaymentMethod = WTFMove(applePayPaymentMethod)](JSC::ExecState&amp; execState) {</span>
<span class="line-modified">591         return toJSDictionary(execState, applePayPaymentMethod);</span>
592     });
593 }
594 
<span class="line-modified">595 void ApplePayPaymentHandler::didCancelPaymentSession()</span>
596 {
597     m_paymentRequest-&gt;cancel();
598 }
599 
600 } // namespace WebCore
601 
602 #endif // ENABLE(APPLE_PAY) &amp;&amp; ENABLE(PAYMENT_REQUEST)
</pre>
</td>
<td>
<hr />
<pre>
 24  */
 25 
 26 #include &quot;config.h&quot;
 27 #include &quot;ApplePayPaymentHandler.h&quot;
 28 
 29 #if ENABLE(APPLE_PAY) &amp;&amp; ENABLE(PAYMENT_REQUEST)
 30 
 31 #include &quot;AddressErrors.h&quot;
 32 #include &quot;ApplePayContactField.h&quot;
 33 #include &quot;ApplePayMerchantCapability.h&quot;
 34 #include &quot;ApplePayModifier.h&quot;
 35 #include &quot;ApplePayPayment.h&quot;
 36 #include &quot;ApplePaySessionPaymentRequest.h&quot;
 37 #include &quot;Document.h&quot;
 38 #include &quot;EventNames.h&quot;
 39 #include &quot;Frame.h&quot;
 40 #include &quot;JSApplePayError.h&quot;
 41 #include &quot;JSApplePayPayment.h&quot;
 42 #include &quot;JSApplePayPaymentMethod.h&quot;
 43 #include &quot;JSApplePayRequest.h&quot;
<span class="line-added"> 44 #include &quot;JSDOMConvert.h&quot;</span>
 45 #include &quot;LinkIconCollector.h&quot;
 46 #include &quot;MerchantValidationEvent.h&quot;
 47 #include &quot;Page.h&quot;
 48 #include &quot;PayerErrorFields.h&quot;
 49 #include &quot;Payment.h&quot;
 50 #include &quot;PaymentAuthorizationStatus.h&quot;
 51 #include &quot;PaymentContact.h&quot;
 52 #include &quot;PaymentCoordinator.h&quot;
 53 #include &quot;PaymentMerchantSession.h&quot;
 54 #include &quot;PaymentMethod.h&quot;
<span class="line-added"> 55 #include &quot;PaymentMethodUpdate.h&quot;</span>
 56 #include &quot;PaymentRequestValidator.h&quot;
 57 #include &quot;PaymentResponse.h&quot;
 58 #include &quot;PaymentValidationErrors.h&quot;
 59 #include &quot;Settings.h&quot;
<span class="line-added"> 60 #include &lt;JavaScriptCore/JSONObject.h&gt;</span>
 61 
 62 namespace WebCore {
 63 
<span class="line-added"> 64 static ExceptionOr&lt;ApplePayRequest&gt; convertAndValidate(ScriptExecutionContext&amp; context, JSC::JSValue data)</span>
<span class="line-added"> 65 {</span>
<span class="line-added"> 66     if (data.isEmpty())</span>
<span class="line-added"> 67         return Exception { TypeError, &quot;Missing payment method data.&quot; };</span>
<span class="line-added"> 68 </span>
<span class="line-added"> 69     auto throwScope = DECLARE_THROW_SCOPE(context.vm());</span>
<span class="line-added"> 70     auto applePayRequest = convertDictionary&lt;ApplePayRequest&gt;(*context.execState(), data);</span>
<span class="line-added"> 71     if (throwScope.exception())</span>
<span class="line-added"> 72         return Exception { ExistingExceptionError };</span>
<span class="line-added"> 73 </span>
<span class="line-added"> 74     return WTFMove(applePayRequest);</span>
<span class="line-added"> 75 }</span>
<span class="line-added"> 76 </span>
<span class="line-added"> 77 ExceptionOr&lt;void&gt; ApplePayPaymentHandler::validateData(Document&amp; document, JSC::JSValue data)</span>
<span class="line-added"> 78 {</span>
<span class="line-added"> 79     auto requestOrException = convertAndValidate(document, data);</span>
<span class="line-added"> 80     if (requestOrException.hasException())</span>
<span class="line-added"> 81         return requestOrException.releaseException();</span>
<span class="line-added"> 82 </span>
<span class="line-added"> 83     return { };</span>
<span class="line-added"> 84 }</span>
<span class="line-added"> 85 </span>
 86 bool ApplePayPaymentHandler::handlesIdentifier(const PaymentRequest::MethodIdentifier&amp; identifier)
 87 {
 88     if (!WTF::holds_alternative&lt;URL&gt;(identifier))
 89         return false;
 90 
 91     auto&amp; url = WTF::get&lt;URL&gt;(identifier);
 92     return url.host() == &quot;apple.com&quot; &amp;&amp; url.path() == &quot;/apple-pay&quot;;
 93 }
 94 
 95 static inline PaymentCoordinator&amp; paymentCoordinator(Document&amp; document)
 96 {
 97     ASSERT(document.page());
 98     return document.page()-&gt;paymentCoordinator();
 99 }
100 
101 bool ApplePayPaymentHandler::hasActiveSession(Document&amp; document)
102 {
103     return WebCore::paymentCoordinator(document).hasActiveSession();
104 }
105 
</pre>
<hr />
<pre>
165         return ApplePaySessionPaymentRequest::ShippingType::StorePickup;
166     }
167 
168     ASSERT_NOT_REACHED();
169     return ApplePaySessionPaymentRequest::ShippingType::Shipping;
170 }
171 
172 static ExceptionOr&lt;ApplePaySessionPaymentRequest::ShippingMethod&gt; convertAndValidate(const PaymentShippingOption&amp; shippingOption, const String&amp; expectedCurrency)
173 {
174     auto exception = validate(shippingOption.amount, expectedCurrency);
175     if (exception.hasException())
176         return exception.releaseException();
177 
178     ApplePaySessionPaymentRequest::ShippingMethod result;
179     result.amount = shippingOption.amount.value;
180     result.label = shippingOption.label;
181     result.identifier = shippingOption.id;
182     return { WTFMove(result) };
183 }
184 
<span class="line-modified">185 ExceptionOr&lt;void&gt; ApplePayPaymentHandler::convertData(JSC::JSValue data)</span>
186 {
<span class="line-modified">187     auto requestOrException = convertAndValidate(*scriptExecutionContext(), data);</span>
<span class="line-modified">188     if (requestOrException.hasException())</span>
<span class="line-modified">189         return requestOrException.releaseException();</span>





190 
<span class="line-modified">191     m_applePayRequest = requestOrException.releaseReturnValue();</span>
192     return { };
193 }
194 
195 static void mergePaymentOptions(const PaymentOptions&amp; options, ApplePaySessionPaymentRequest&amp; request)
196 {
197     auto requiredShippingContactFields = request.requiredShippingContactFields();
198     requiredShippingContactFields.email |= options.requestPayerEmail;
199     requiredShippingContactFields.name |= options.requestPayerName;
200     requiredShippingContactFields.phone |= options.requestPayerPhone;
201     requiredShippingContactFields.postalAddress |= options.requestShipping;
202     request.setRequiredShippingContactFields(requiredShippingContactFields);
203 
204     if (options.requestShipping)
205         request.setShippingType(convert(options.shippingType));
206 }
207 
208 ExceptionOr&lt;void&gt; ApplePayPaymentHandler::show(Document&amp; document)
209 {
210     auto validatedRequest = convertAndValidate(document, m_applePayRequest-&gt;version, *m_applePayRequest, paymentCoordinator());
211     if (validatedRequest.hasException())
</pre>
<hr />
<pre>
284 
285     auto convertedLineItems = convertAndValidate(details.displayItems, currency);
286     if (convertedLineItems.hasException())
287         return convertedLineItems.releaseException();
288     auto lineItems = convertedLineItems.releaseReturnValue();
289 
290     if (!m_selectedPaymentMethodType)
291         return ApplePaySessionPaymentRequest::TotalAndLineItems { WTFMove(total), WTFMove(lineItems) };
292 
293     auto&amp; modifiers = details.modifiers;
294     auto&amp; serializedModifierData = m_paymentRequest-&gt;serializedModifierData();
295     ASSERT(modifiers.size() == serializedModifierData.size());
296     for (size_t i = 0; i &lt; modifiers.size(); ++i) {
297         auto convertedIdentifier = convertAndValidatePaymentMethodIdentifier(modifiers[i].supportedMethods);
298         if (!convertedIdentifier || !handlesIdentifier(*convertedIdentifier))
299             continue;
300 
301         if (serializedModifierData[i].isEmpty())
302             continue;
303 
<span class="line-modified">304         auto&amp; lexicalGlobalObject = *document().execState();</span>
<span class="line-modified">305         auto scope = DECLARE_THROW_SCOPE(lexicalGlobalObject.vm());</span>
306         JSC::JSValue data;
307         {
<span class="line-modified">308             auto lock = JSC::JSLockHolder { &amp;lexicalGlobalObject };</span>
<span class="line-modified">309             data = JSONParse(&amp;lexicalGlobalObject, serializedModifierData[i]);</span>
310             if (scope.exception())
311                 return Exception { ExistingExceptionError };
312         }
313 
<span class="line-modified">314         auto applePayModifier = convertDictionary&lt;ApplePayModifier&gt;(lexicalGlobalObject, WTFMove(data));</span>
315         if (scope.exception())
316             return Exception { ExistingExceptionError };
317 
318         if (applePayModifier.paymentMethodType != *m_selectedPaymentMethodType)
319             continue;
320 
321         if (modifiers[i].total) {
322             auto totalOverride = convertAndValidate(*modifiers[i].total, currency);
323             if (totalOverride.hasException())
324                 return totalOverride.releaseException();
325             total = totalOverride.releaseReturnValue();
326         }
327 
328         auto additionalDisplayItems = convertAndValidate(modifiers[i].additionalDisplayItems, currency);
329         if (additionalDisplayItems.hasException())
330             return additionalDisplayItems.releaseException();
331         lineItems.appendVector(additionalDisplayItems.releaseReturnValue());
332         break;
333     }
334 
</pre>
<hr />
<pre>
476 {
477     ASSERT(m_isUpdating);
478     m_isUpdating = false;
479 
480     ShippingMethodUpdate update;
481 
482     auto newTotalAndLineItems = computeTotalAndLineItems();
483     if (newTotalAndLineItems.hasException())
484         return newTotalAndLineItems.releaseException();
485     update.newTotalAndLineItems = newTotalAndLineItems.releaseReturnValue();
486 
487     paymentCoordinator().completeShippingMethodSelection(WTFMove(update));
488     return { };
489 }
490 
491 ExceptionOr&lt;void&gt; ApplePayPaymentHandler::paymentMethodUpdated()
492 {
493     ASSERT(m_isUpdating);
494     m_isUpdating = false;
495 


496     auto newTotalAndLineItems = computeTotalAndLineItems();
497     if (newTotalAndLineItems.hasException())
498         return newTotalAndLineItems.releaseException();

499 
<span class="line-modified">500     paymentCoordinator().completePaymentMethodSelection(PaymentMethodUpdate { newTotalAndLineItems.releaseReturnValue() });</span>
501     return { };
502 }
503 
504 void ApplePayPaymentHandler::complete(Optional&lt;PaymentComplete&gt;&amp;&amp; result)
505 {
506     if (!result) {
507         ASSERT(isFinalStateResult(WTF::nullopt));
508         paymentCoordinator().completePaymentSession(WTF::nullopt);
509         return;
510     }
511 
512     PaymentAuthorizationResult authorizationResult;
513     switch (*result) {
514     case PaymentComplete::Fail:
515     case PaymentComplete::Unknown:
516         authorizationResult.status = PaymentAuthorizationStatus::Failure;
517         break;
518     case PaymentComplete::Success:
519         authorizationResult.status = PaymentAuthorizationStatus::Success;
520         break;
</pre>
<hr />
<pre>
545     return { };
546 }
547 
548 unsigned ApplePayPaymentHandler::version() const
549 {
550     return m_applePayRequest ? m_applePayRequest-&gt;version : 0;
551 }
552 
553 void ApplePayPaymentHandler::validateMerchant(URL&amp;&amp; validationURL)
554 {
555     if (validationURL.isValid())
556         m_paymentRequest-&gt;dispatchEvent(MerchantValidationEvent::create(eventNames().merchantvalidationEvent, WTF::get&lt;URL&gt;(m_identifier).string(), WTFMove(validationURL)).get());
557 }
558 
559 static Ref&lt;PaymentAddress&gt; convert(const ApplePayPaymentContact&amp; contact)
560 {
561     return PaymentAddress::create(contact.countryCode, contact.addressLines.valueOr(Vector&lt;String&gt;()), contact.administrativeArea, contact.locality, contact.subLocality, contact.postalCode, String(), String(), contact.localizedName, contact.phoneNumber);
562 }
563 
564 template&lt;typename T&gt;
<span class="line-modified">565 static JSC::Strong&lt;JSC::JSObject&gt; toJSDictionary(JSC::JSGlobalObject&amp; lexicalGlobalObject, const T&amp; value)</span>
566 {
<span class="line-modified">567     JSC::JSLockHolder lock { &amp;lexicalGlobalObject };</span>
<span class="line-modified">568     return { lexicalGlobalObject.vm(), asObject(toJS&lt;IDLDictionary&lt;T&gt;&gt;(lexicalGlobalObject, *JSC::jsCast&lt;JSDOMGlobalObject*&gt;(&amp;lexicalGlobalObject), value)) };</span>
569 }
570 
571 void ApplePayPaymentHandler::didAuthorizePayment(const Payment&amp; payment)
572 {
573     ASSERT(!m_isUpdating);
574 
575     auto applePayPayment = payment.toApplePayPayment(version());
576     auto shippingContact = applePayPayment.shippingContact.valueOr(ApplePayPaymentContact());
<span class="line-modified">577     auto detailsFunction = [applePayPayment = WTFMove(applePayPayment)](JSC::JSGlobalObject&amp; lexicalGlobalObject) {</span>
<span class="line-modified">578         return toJSDictionary(lexicalGlobalObject, applePayPayment);</span>
579     };
580 
581     m_paymentRequest-&gt;accept(WTF::get&lt;URL&gt;(m_identifier).string(), WTFMove(detailsFunction), convert(shippingContact), shippingContact.localizedName, shippingContact.emailAddress, shippingContact.phoneNumber);
582 }
583 
584 void ApplePayPaymentHandler::didSelectShippingMethod(const ApplePaySessionPaymentRequest::ShippingMethod&amp; shippingMethod)
585 {
586     ASSERT(!m_isUpdating);
587     m_isUpdating = true;
588 
589     m_paymentRequest-&gt;shippingOptionChanged(shippingMethod.identifier);
590 }
591 
592 void ApplePayPaymentHandler::didSelectShippingContact(const PaymentContact&amp; shippingContact)
593 {
594     ASSERT(!m_isUpdating);
595     m_isUpdating = true;
596 
597     m_paymentRequest-&gt;shippingAddressChanged(convert(shippingContact.toApplePayPaymentContact(version())));
598 }
599 
600 void ApplePayPaymentHandler::didSelectPaymentMethod(const PaymentMethod&amp; paymentMethod)
601 {
602     ASSERT(!m_isUpdating);
603     m_isUpdating = true;
604 
605     auto applePayPaymentMethod = paymentMethod.toApplePayPaymentMethod();
606     m_selectedPaymentMethodType = applePayPaymentMethod.type;
<span class="line-modified">607     m_paymentRequest-&gt;paymentMethodChanged(WTF::get&lt;URL&gt;(m_identifier).string(), [applePayPaymentMethod = WTFMove(applePayPaymentMethod)](JSC::JSGlobalObject&amp; lexicalGlobalObject) {</span>
<span class="line-modified">608         return toJSDictionary(lexicalGlobalObject, applePayPaymentMethod);</span>
609     });
610 }
611 
<span class="line-modified">612 void ApplePayPaymentHandler::didCancelPaymentSession(PaymentSessionError&amp;&amp;)</span>
613 {
614     m_paymentRequest-&gt;cancel();
615 }
616 
617 } // namespace WebCore
618 
619 #endif // ENABLE(APPLE_PAY) &amp;&amp; ENABLE(PAYMENT_REQUEST)
</pre>
</td>
</tr>
</table>
<center><a href="../PaymentSession.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="ApplePayPaymentHandler.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>