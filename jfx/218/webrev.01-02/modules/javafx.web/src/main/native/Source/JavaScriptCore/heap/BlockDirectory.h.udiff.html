<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/JavaScriptCore/heap/BlockDirectory.h</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="BlockDirectory.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="BlockDirectoryInlines.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/JavaScriptCore/heap/BlockDirectory.h</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -24,10 +24,11 @@</span>
   */
  
  #pragma once
  
  #include &quot;AllocationFailureMode.h&quot;
<span class="udiff-line-added">+ #include &quot;BlockDirectoryBits.h&quot;</span>
  #include &quot;CellAttributes.h&quot;
  #include &quot;FreeList.h&quot;
  #include &quot;LocalAllocator.h&quot;
  #include &quot;MarkedBlock.h&quot;
  #include &lt;wtf/DataLog.h&gt;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -42,45 +43,20 @@</span>
  class Heap;
  class IsoCellSet;
  class MarkedSpace;
  class LLIntOffsetsExtractor;
  
<span class="udiff-line-modified-removed">- #define FOR_EACH_BLOCK_DIRECTORY_BIT(macro) \</span>
<span class="udiff-line-removed">-     macro(live, Live) /* The set of block indices that have actual blocks. */\</span>
<span class="udiff-line-removed">-     macro(empty, Empty) /* The set of all blocks that have no live objects. */ \</span>
<span class="udiff-line-removed">-     macro(allocated, Allocated) /* The set of all blocks that are full of live objects. */\</span>
<span class="udiff-line-removed">-     macro(canAllocateButNotEmpty, CanAllocateButNotEmpty) /* The set of all blocks are neither empty nor retired (i.e. are more than minMarkedBlockUtilization full). */ \</span>
<span class="udiff-line-removed">-     macro(destructible, Destructible) /* The set of all blocks that may have destructors to run. */\</span>
<span class="udiff-line-removed">-     macro(eden, Eden) /* The set of all blocks that have new objects since the last GC. */\</span>
<span class="udiff-line-removed">-     macro(unswept, Unswept) /* The set of all blocks that could be swept by the incremental sweeper. */\</span>
<span class="udiff-line-removed">-     \</span>
<span class="udiff-line-removed">-     /* These are computed during marking. */\</span>
<span class="udiff-line-removed">-     macro(markingNotEmpty, MarkingNotEmpty) /* The set of all blocks that are not empty. */ \</span>
<span class="udiff-line-removed">-     macro(markingRetired, MarkingRetired) /* The set of all blocks that are retired. */</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- // FIXME: We defined canAllocateButNotEmpty and empty to be exclusive:</span>
<span class="udiff-line-removed">- //</span>
<span class="udiff-line-removed">- //     canAllocateButNotEmpty &amp; empty == 0</span>
<span class="udiff-line-removed">- //</span>
<span class="udiff-line-removed">- // Instead of calling it canAllocate and making it inclusive:</span>
<span class="udiff-line-removed">- //</span>
<span class="udiff-line-removed">- //     canAllocate &amp; empty == empty</span>
<span class="udiff-line-removed">- //</span>
<span class="udiff-line-removed">- // The latter is probably better. I&#39;ll leave it to a future bug to fix that, since breathing on</span>
<span class="udiff-line-removed">- // this code leads to regressions for days, and it&#39;s not clear that making this change would</span>
<span class="udiff-line-removed">- // improve perf since it would not change the collector&#39;s behavior, and either way the directory</span>
<span class="udiff-line-removed">- // has to look at both bitvectors.</span>
<span class="udiff-line-removed">- // https://bugs.webkit.org/show_bug.cgi?id=162121</span>
<span class="udiff-line-modified-added">+ DECLARE_ALLOCATOR_WITH_HEAP_IDENTIFIER(BlockDirectory);</span>
  
  class BlockDirectory {
      WTF_MAKE_NONCOPYABLE(BlockDirectory);
<span class="udiff-line-modified-removed">-     WTF_MAKE_FAST_ALLOCATED;</span>
<span class="udiff-line-modified-added">+     WTF_MAKE_FAST_ALLOCATED_WITH_HEAP_IDENTIFIER(BlockDirectory);</span>
  
      friend class LLIntOffsetsExtractor;
  
  public:
<span class="udiff-line-modified-removed">-     BlockDirectory(Heap*, size_t cellSize);</span>
<span class="udiff-line-modified-added">+     BlockDirectory(size_t cellSize);</span>
      ~BlockDirectory();
      void setSubspace(Subspace*);
      void lastChanceToFinalize();
      void prepareForAllocation();
      void stopAllocating();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -96,11 +72,10 @@</span>
      size_t cellSize() const { return m_cellSize; }
      const CellAttributes&amp; attributes() const { return m_attributes; }
      bool needsDestruction() const { return m_attributes.destruction == NeedsDestruction; }
      DestructionMode destruction() const { return m_attributes.destruction; }
      HeapCell::Kind cellKind() const { return m_attributes.cellKind; }
<span class="udiff-line-removed">-     Heap* heap() { return m_heap; }</span>
  
      bool isFreeListedCell(const void* target);
  
      template&lt;typename Functor&gt; void forEachBlock(const Functor&amp;);
      template&lt;typename Functor&gt; void forEachNotEmptyBlock(const Functor&amp;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -113,31 +88,31 @@</span>
      bool isPagedOut(MonotonicTime deadline);
  
      Lock&amp; bitvectorLock() { return m_bitvectorLock; }
  
  #define BLOCK_DIRECTORY_BIT_ACCESSORS(lowerBitName, capitalBitName)     \
<span class="udiff-line-modified-removed">-     bool is ## capitalBitName(const AbstractLocker&amp;, size_t index) const { return m_ ## lowerBitName[index]; } \</span>
<span class="udiff-line-modified-added">+     bool is ## capitalBitName(const AbstractLocker&amp;, size_t index) const { return m_bits.is ## capitalBitName(index); } \</span>
      bool is ## capitalBitName(const AbstractLocker&amp; locker, MarkedBlock::Handle* block) const { return is ## capitalBitName(locker, block-&gt;index()); } \
<span class="udiff-line-modified-removed">-     void setIs ## capitalBitName(const AbstractLocker&amp;, size_t index, bool value) { m_ ## lowerBitName[index] = value; } \</span>
<span class="udiff-line-modified-added">+     void setIs ## capitalBitName(const AbstractLocker&amp;, size_t index, bool value) { m_bits.setIs ## capitalBitName(index, value); } \</span>
      void setIs ## capitalBitName(const AbstractLocker&amp; locker, MarkedBlock::Handle* block, bool value) { setIs ## capitalBitName(locker, block-&gt;index(), value); }
      FOR_EACH_BLOCK_DIRECTORY_BIT(BLOCK_DIRECTORY_BIT_ACCESSORS)
  #undef BLOCK_DIRECTORY_BIT_ACCESSORS
  
      template&lt;typename Func&gt;
      void forEachBitVector(const AbstractLocker&amp;, const Func&amp; func)
      {
  #define BLOCK_DIRECTORY_BIT_CALLBACK(lowerBitName, capitalBitName) \
<span class="udiff-line-modified-removed">-         func(m_ ## lowerBitName);</span>
<span class="udiff-line-modified-added">+         func(m_bits.lowerBitName());</span>
          FOR_EACH_BLOCK_DIRECTORY_BIT(BLOCK_DIRECTORY_BIT_CALLBACK);
  #undef BLOCK_DIRECTORY_BIT_CALLBACK
      }
  
      template&lt;typename Func&gt;
      void forEachBitVectorWithName(const AbstractLocker&amp;, const Func&amp; func)
      {
  #define BLOCK_DIRECTORY_BIT_CALLBACK(lowerBitName, capitalBitName) \
<span class="udiff-line-modified-removed">-         func(m_ ## lowerBitName, #capitalBitName);</span>
<span class="udiff-line-modified-added">+         func(m_bits.lowerBitName(), #capitalBitName);</span>
          FOR_EACH_BLOCK_DIRECTORY_BIT(BLOCK_DIRECTORY_BIT_CALLBACK);
  #undef BLOCK_DIRECTORY_BIT_CALLBACK
      }
  
      BlockDirectory* nextDirectory() const { return m_nextDirectory; }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -164,35 +139,32 @@</span>
      friend class LocalSideAllocator;
      friend class MarkedBlock;
  
      MarkedBlock::Handle* findBlockForAllocation(LocalAllocator&amp;);
  
<span class="udiff-line-modified-removed">-     MarkedBlock::Handle* tryAllocateBlock();</span>
<span class="udiff-line-modified-added">+     MarkedBlock::Handle* tryAllocateBlock(Heap&amp;);</span>
  
      Vector&lt;MarkedBlock::Handle*&gt; m_blocks;
      Vector&lt;unsigned&gt; m_freeBlockIndices;
  
      // Mutator uses this to guard resizing the bitvectors. Those things in the GC that may run
      // concurrently to the mutator must lock this when accessing the bitvectors.
<span class="udiff-line-modified-removed">- #define BLOCK_DIRECTORY_BIT_DECLARATION(lowerBitName, capitalBitName) \</span>
<span class="udiff-line-removed">-     FastBitVector m_ ## lowerBitName;</span>
<span class="udiff-line-removed">-     FOR_EACH_BLOCK_DIRECTORY_BIT(BLOCK_DIRECTORY_BIT_DECLARATION)</span>
<span class="udiff-line-removed">- #undef BLOCK_DIRECTORY_BIT_DECLARATION</span>
<span class="udiff-line-modified-added">+     BlockDirectoryBits m_bits;</span>
      Lock m_bitvectorLock;
      Lock m_localAllocatorsLock;
      CellAttributes m_attributes;
  
      unsigned m_cellSize;
  
      // After you do something to a block based on one of these cursors, you clear the bit in the
<span class="udiff-line-modified-removed">-     // corresponding bitvector and leave the cursor where it was.</span>
<span class="udiff-line-modified-removed">-     size_t m_emptyCursor { 0 };</span>
<span class="udiff-line-modified-removed">-     size_t m_unsweptCursor { 0 }; // Points to the next block that is a candidate for incremental sweeping.</span>
<span class="udiff-line-modified-added">+     // corresponding bitvector and leave the cursor where it was. We can use unsigned instead of size_t since</span>
<span class="udiff-line-modified-added">+     // this number is bound by capacity of Vector m_blocks, which must be within unsigned.</span>
<span class="udiff-line-modified-added">+     unsigned m_emptyCursor { 0 };</span>
<span class="udiff-line-added">+     unsigned m_unsweptCursor { 0 }; // Points to the next block that is a candidate for incremental sweeping.</span>
  
      // FIXME: All of these should probably be references.
      // https://bugs.webkit.org/show_bug.cgi?id=166988
<span class="udiff-line-removed">-     Heap* m_heap { nullptr };</span>
      Subspace* m_subspace { nullptr };
      BlockDirectory* m_nextDirectory { nullptr };
      BlockDirectory* m_nextDirectoryInSubspace { nullptr };
      BlockDirectory* m_nextDirectoryInAlignedMemoryAllocator { nullptr };
  
</pre>
<center><a href="BlockDirectory.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="BlockDirectoryInlines.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>