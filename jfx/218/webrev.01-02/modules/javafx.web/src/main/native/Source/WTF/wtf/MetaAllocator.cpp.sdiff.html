<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WTF/wtf/MetaAllocator.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="MediaTime.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="MetaAllocatorHandle.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WTF/wtf/MetaAllocator.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 14  *     its contributors may be used to endorse or promote products derived
 15  *     from this software without specific prior written permission.
 16  *
 17  * THIS SOFTWARE IS PROVIDED BY APPLE AND ITS CONTRIBUTORS &quot;AS IS&quot; AND ANY
 18  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 19  * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 20  * DISCLAIMED. IN NO EVENT SHALL APPLE OR ITS CONTRIBUTORS BE LIABLE FOR ANY
 21  * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 22  * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 23  * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
 24  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 25  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
 26  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 27  */
 28 
 29 #include &quot;config.h&quot;
 30 #include &lt;wtf/MetaAllocator.h&gt;
 31 
 32 #include &lt;wtf/DataLog.h&gt;
 33 #include &lt;wtf/FastMalloc.h&gt;

 34 #include &lt;wtf/ProcessID.h&gt;
 35 
 36 namespace WTF {
 37 





 38 MetaAllocator::~MetaAllocator()
 39 {
 40     for (FreeSpaceNode* node = m_freeSpaceSizeMap.first(); node;) {
 41         FreeSpaceNode* next = node-&gt;successor();
 42         m_freeSpaceSizeMap.remove(node);
 43         freeFreeSpaceNode(node);
 44         node = next;
 45     }
 46 #ifndef NDEBUG
 47     ASSERT(!m_mallocBalance);
 48 #endif
 49 }
 50 
 51 void MetaAllocatorTracker::notify(MetaAllocatorHandle* handle)
 52 {
 53     m_allocations.insert(handle);
 54 }
 55 
 56 void MetaAllocatorTracker::release(MetaAllocatorHandle* handle)
 57 {
</pre>
<hr />
<pre>
455 
456 bool MetaAllocator::isInAllocatedMemory(const AbstractLocker&amp;, void* address)
457 {
458     ASSERT(m_lock.isLocked());
459     uintptr_t page = reinterpret_cast&lt;uintptr_t&gt;(address) &gt;&gt; m_logPageSize;
460     return m_pageOccupancyMap.contains(page);
461 }
462 
463 size_t MetaAllocator::roundUp(size_t sizeInBytes)
464 {
465     if (std::numeric_limits&lt;size_t&gt;::max() - m_allocationGranule &lt;= sizeInBytes)
466         CRASH();
467     return (sizeInBytes + m_allocationGranule - 1) &amp; ~(m_allocationGranule - 1);
468 }
469 
470 MetaAllocator::FreeSpaceNode* MetaAllocator::allocFreeSpaceNode()
471 {
472 #ifndef NDEBUG
473     m_mallocBalance++;
474 #endif
<span class="line-modified">475     return new (NotNull, fastMalloc(sizeof(FreeSpaceNode))) FreeSpaceNode();</span>
476 }
477 
478 void MetaAllocator::freeFreeSpaceNode(FreeSpaceNode* node)
479 {
480 #ifndef NDEBUG
481     m_mallocBalance--;
482 #endif
<span class="line-modified">483     fastFree(node);</span>
484 }
485 
486 #if ENABLE(META_ALLOCATOR_PROFILE)
487 void MetaAllocator::dumpProfile()
488 {
489     dataLogF(
490         &quot;%d: MetaAllocator(%p): num allocations = %u, num frees = %u, allocated = %lu, reserved = %lu, committed = %lu\n&quot;,
491         getCurrentProcessID(), this, m_numAllocations, m_numFrees, m_bytesAllocated, m_bytesReserved, m_bytesCommitted);
492 }
493 #endif
494 
495 } // namespace WTF
496 
497 
</pre>
</td>
<td>
<hr />
<pre>
 14  *     its contributors may be used to endorse or promote products derived
 15  *     from this software without specific prior written permission.
 16  *
 17  * THIS SOFTWARE IS PROVIDED BY APPLE AND ITS CONTRIBUTORS &quot;AS IS&quot; AND ANY
 18  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 19  * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 20  * DISCLAIMED. IN NO EVENT SHALL APPLE OR ITS CONTRIBUTORS BE LIABLE FOR ANY
 21  * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 22  * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 23  * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
 24  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 25  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
 26  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 27  */
 28 
 29 #include &quot;config.h&quot;
 30 #include &lt;wtf/MetaAllocator.h&gt;
 31 
 32 #include &lt;wtf/DataLog.h&gt;
 33 #include &lt;wtf/FastMalloc.h&gt;
<span class="line-added"> 34 #include &lt;wtf/NeverDestroyed.h&gt;</span>
 35 #include &lt;wtf/ProcessID.h&gt;
 36 
 37 namespace WTF {
 38 
<span class="line-added"> 39 DEFINE_ALLOCATOR_WITH_HEAP_IDENTIFIER(MetaAllocatorHandle);</span>
<span class="line-added"> 40 </span>
<span class="line-added"> 41 DECLARE_ALLOCATOR_WITH_HEAP_IDENTIFIER(MetaAllocatorFreeSpace);</span>
<span class="line-added"> 42 DEFINE_ALLOCATOR_WITH_HEAP_IDENTIFIER(MetaAllocatorFreeSpace);</span>
<span class="line-added"> 43 </span>
 44 MetaAllocator::~MetaAllocator()
 45 {
 46     for (FreeSpaceNode* node = m_freeSpaceSizeMap.first(); node;) {
 47         FreeSpaceNode* next = node-&gt;successor();
 48         m_freeSpaceSizeMap.remove(node);
 49         freeFreeSpaceNode(node);
 50         node = next;
 51     }
 52 #ifndef NDEBUG
 53     ASSERT(!m_mallocBalance);
 54 #endif
 55 }
 56 
 57 void MetaAllocatorTracker::notify(MetaAllocatorHandle* handle)
 58 {
 59     m_allocations.insert(handle);
 60 }
 61 
 62 void MetaAllocatorTracker::release(MetaAllocatorHandle* handle)
 63 {
</pre>
<hr />
<pre>
461 
462 bool MetaAllocator::isInAllocatedMemory(const AbstractLocker&amp;, void* address)
463 {
464     ASSERT(m_lock.isLocked());
465     uintptr_t page = reinterpret_cast&lt;uintptr_t&gt;(address) &gt;&gt; m_logPageSize;
466     return m_pageOccupancyMap.contains(page);
467 }
468 
469 size_t MetaAllocator::roundUp(size_t sizeInBytes)
470 {
471     if (std::numeric_limits&lt;size_t&gt;::max() - m_allocationGranule &lt;= sizeInBytes)
472         CRASH();
473     return (sizeInBytes + m_allocationGranule - 1) &amp; ~(m_allocationGranule - 1);
474 }
475 
476 MetaAllocator::FreeSpaceNode* MetaAllocator::allocFreeSpaceNode()
477 {
478 #ifndef NDEBUG
479     m_mallocBalance++;
480 #endif
<span class="line-modified">481     return new (NotNull, MetaAllocatorFreeSpaceMalloc::malloc(sizeof(FreeSpaceNode))) FreeSpaceNode();</span>
482 }
483 
484 void MetaAllocator::freeFreeSpaceNode(FreeSpaceNode* node)
485 {
486 #ifndef NDEBUG
487     m_mallocBalance--;
488 #endif
<span class="line-modified">489     MetaAllocatorFreeSpaceMalloc::free(node);</span>
490 }
491 
492 #if ENABLE(META_ALLOCATOR_PROFILE)
493 void MetaAllocator::dumpProfile()
494 {
495     dataLogF(
496         &quot;%d: MetaAllocator(%p): num allocations = %u, num frees = %u, allocated = %lu, reserved = %lu, committed = %lu\n&quot;,
497         getCurrentProcessID(), this, m_numAllocations, m_numFrees, m_bytesAllocated, m_bytesReserved, m_bytesCommitted);
498 }
499 #endif
500 
501 } // namespace WTF
502 
503 
</pre>
</td>
</tr>
</table>
<center><a href="MediaTime.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="MetaAllocatorHandle.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>