<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WebCore/Modules/fetch/FetchRequest.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="FetchLoader.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="FetchRequest.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/Modules/fetch/FetchRequest.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
144 
145     return { };
146 }
147 
148 static inline Optional&lt;Exception&gt; processInvalidSignal(ScriptExecutionContext&amp; context)
149 {
150     ASCIILiteral message { &quot;FetchRequestInit.signal should be undefined, null or an AbortSignal object. This will throw in a future release.&quot;_s };
151     context.addConsoleMessage(MessageSource::JS, MessageLevel::Warning, message);
152 
153     if (is&lt;Document&gt;(context) &amp;&amp; downcast&lt;Document&gt;(context).quirks().shouldIgnoreInvalidSignal())
154         return { };
155 
156     RELEASE_LOG_ERROR(ResourceLoading, &quot;FetchRequestInit.signal should be undefined, null or an AbortSignal object.&quot;);
157     return Exception { TypeError, message };
158 }
159 
160 ExceptionOr&lt;void&gt; FetchRequest::initializeWith(const String&amp; url, Init&amp;&amp; init)
161 {
162     ASSERT(scriptExecutionContext());
163     // FIXME: Tighten the URL parsing algorithm according https://url.spec.whatwg.org/#concept-url-parser.
<span class="line-modified">164     URL requestURL = scriptExecutionContext()-&gt;completeURL(url);</span>
165     if (!requestURL.isValid() || !requestURL.user().isEmpty() || !requestURL.pass().isEmpty())
166         return Exception { TypeError, &quot;URL is not valid or contains user credentials.&quot;_s };
167 
168     m_options.mode = Mode::Cors;
169     m_options.credentials = Credentials::SameOrigin;
170     m_referrer = &quot;client&quot;_s;
171     m_request.setURL(requestURL);
172     m_request.setRequester(ResourceRequest::Requester::Fetch);
173     m_request.setInitiatorIdentifier(scriptExecutionContext()-&gt;resourceRequestIdentifier());
174 
175     auto optionsResult = initializeOptions(init);
176     if (optionsResult.hasException())
177         return optionsResult.releaseException();
178 
179     if (init.signal) {
180         if (auto* signal = JSAbortSignal::toWrapped(scriptExecutionContext()-&gt;vm(), init.signal))
181             m_signal-&gt;follow(*signal);
182         else if (!init.signal.isUndefinedOrNull())  {
183             if (auto exception = processInvalidSignal(*scriptExecutionContext()))
184                 return WTFMove(*exception);
</pre>
<hr />
<pre>
205 {
206     m_request = input.m_request;
207     m_options = input.m_options;
208     m_referrer = input.m_referrer;
209 
210     auto optionsResult = initializeOptions(init);
211     if (optionsResult.hasException())
212         return optionsResult.releaseException();
213 
214     if (init.signal &amp;&amp; !init.signal.isUndefined()) {
215         if (auto* signal = JSAbortSignal::toWrapped(scriptExecutionContext()-&gt;vm(), init.signal))
216             m_signal-&gt;follow(*signal);
217         else if (!init.signal.isNull()) {
218             if (auto exception = processInvalidSignal(*scriptExecutionContext()))
219                 return WTFMove(*exception);
220         }
221 
222     } else
223         m_signal-&gt;follow(input.m_signal.get());
224 
<span class="line-modified">225     auto fillResult = init.headers ? m_headers-&gt;fill(*init.headers) : m_headers-&gt;fill(input.headers());</span>
<span class="line-modified">226     if (fillResult.hasException())</span>
<span class="line-modified">227         return fillResult;</span>



228 
229     auto setBodyResult = init.body ? setBody(WTFMove(*init.body)) : setBody(input);
230     if (setBodyResult.hasException())
231         return setBodyResult;
232 
233     updateContentType();
234     return { };
235 }
236 
237 ExceptionOr&lt;void&gt; FetchRequest::setBody(FetchBody::Init&amp;&amp; body)
238 {
239     if (!methodCanHaveBody(m_request))
240         return Exception { TypeError, makeString(&quot;Request has method &#39;&quot;, m_request.httpMethod(), &quot;&#39; and cannot have a body&quot;) };
241 
242     ASSERT(scriptExecutionContext());
243     auto result = extractBody(WTFMove(body));
244     if (result.hasException())
245         return result;
246 
247     if (m_options.keepAlive &amp;&amp; hasReadableStreamBody())
</pre>
<hr />
<pre>
291     if (m_referrer == &quot;client&quot;)
292         return &quot;about:client&quot;_s;
293     return m_referrer;
294 }
295 
296 const String&amp; FetchRequest::urlString() const
297 {
298     if (m_requestURL.isNull())
299         m_requestURL = m_request.url();
300     return m_requestURL;
301 }
302 
303 ResourceRequest FetchRequest::resourceRequest() const
304 {
305     ASSERT(scriptExecutionContext());
306 
307     ResourceRequest request = m_request;
308     request.setHTTPHeaderFields(m_headers-&gt;internalHeaders());
309 
310     if (!isBodyNull())
<span class="line-modified">311         request.setHTTPBody(body().bodyAsFormData(*scriptExecutionContext()));</span>
312 
313     return request;
314 }
315 
316 ExceptionOr&lt;Ref&lt;FetchRequest&gt;&gt; FetchRequest::clone(ScriptExecutionContext&amp; context)
317 {
318     if (isDisturbedOrLocked())
319         return Exception { TypeError, &quot;Body is disturbed or locked&quot;_s };
320 
321     auto clone = adoptRef(*new FetchRequest(context, WTF::nullopt, FetchHeaders::create(m_headers.get()), ResourceRequest { m_request }, FetchOptions { m_options}, String { m_referrer }));
322     clone-&gt;cloneBody(*this);
323     clone-&gt;m_signal-&gt;follow(m_signal);
324     return clone;
325 }
326 
327 const char* FetchRequest::activeDOMObjectName() const
328 {
329     return &quot;Request&quot;;
330 }
331 
<span class="line-removed">332 bool FetchRequest::canSuspendForDocumentSuspension() const</span>
<span class="line-removed">333 {</span>
<span class="line-removed">334     // FIXME: We can probably do the same strategy as XHR.</span>
<span class="line-removed">335     return !isActive();</span>
<span class="line-removed">336 }</span>
<span class="line-removed">337 </span>
338 } // namespace WebCore
339 
</pre>
</td>
<td>
<hr />
<pre>
144 
145     return { };
146 }
147 
148 static inline Optional&lt;Exception&gt; processInvalidSignal(ScriptExecutionContext&amp; context)
149 {
150     ASCIILiteral message { &quot;FetchRequestInit.signal should be undefined, null or an AbortSignal object. This will throw in a future release.&quot;_s };
151     context.addConsoleMessage(MessageSource::JS, MessageLevel::Warning, message);
152 
153     if (is&lt;Document&gt;(context) &amp;&amp; downcast&lt;Document&gt;(context).quirks().shouldIgnoreInvalidSignal())
154         return { };
155 
156     RELEASE_LOG_ERROR(ResourceLoading, &quot;FetchRequestInit.signal should be undefined, null or an AbortSignal object.&quot;);
157     return Exception { TypeError, message };
158 }
159 
160 ExceptionOr&lt;void&gt; FetchRequest::initializeWith(const String&amp; url, Init&amp;&amp; init)
161 {
162     ASSERT(scriptExecutionContext());
163     // FIXME: Tighten the URL parsing algorithm according https://url.spec.whatwg.org/#concept-url-parser.
<span class="line-modified">164     URL requestURL = scriptExecutionContext()-&gt;completeURL(url, ScriptExecutionContext::ForceUTF8::Yes);</span>
165     if (!requestURL.isValid() || !requestURL.user().isEmpty() || !requestURL.pass().isEmpty())
166         return Exception { TypeError, &quot;URL is not valid or contains user credentials.&quot;_s };
167 
168     m_options.mode = Mode::Cors;
169     m_options.credentials = Credentials::SameOrigin;
170     m_referrer = &quot;client&quot;_s;
171     m_request.setURL(requestURL);
172     m_request.setRequester(ResourceRequest::Requester::Fetch);
173     m_request.setInitiatorIdentifier(scriptExecutionContext()-&gt;resourceRequestIdentifier());
174 
175     auto optionsResult = initializeOptions(init);
176     if (optionsResult.hasException())
177         return optionsResult.releaseException();
178 
179     if (init.signal) {
180         if (auto* signal = JSAbortSignal::toWrapped(scriptExecutionContext()-&gt;vm(), init.signal))
181             m_signal-&gt;follow(*signal);
182         else if (!init.signal.isUndefinedOrNull())  {
183             if (auto exception = processInvalidSignal(*scriptExecutionContext()))
184                 return WTFMove(*exception);
</pre>
<hr />
<pre>
205 {
206     m_request = input.m_request;
207     m_options = input.m_options;
208     m_referrer = input.m_referrer;
209 
210     auto optionsResult = initializeOptions(init);
211     if (optionsResult.hasException())
212         return optionsResult.releaseException();
213 
214     if (init.signal &amp;&amp; !init.signal.isUndefined()) {
215         if (auto* signal = JSAbortSignal::toWrapped(scriptExecutionContext()-&gt;vm(), init.signal))
216             m_signal-&gt;follow(*signal);
217         else if (!init.signal.isNull()) {
218             if (auto exception = processInvalidSignal(*scriptExecutionContext()))
219                 return WTFMove(*exception);
220         }
221 
222     } else
223         m_signal-&gt;follow(input.m_signal.get());
224 
<span class="line-modified">225     if (init.hasMembers()) {</span>
<span class="line-modified">226         auto fillResult = init.headers ? m_headers-&gt;fill(*init.headers) : m_headers-&gt;fill(input.headers());</span>
<span class="line-modified">227         if (fillResult.hasException())</span>
<span class="line-added">228             return fillResult;</span>
<span class="line-added">229     } else</span>
<span class="line-added">230         m_headers-&gt;setInternalHeaders(HTTPHeaderMap { input.headers().internalHeaders() });</span>
231 
232     auto setBodyResult = init.body ? setBody(WTFMove(*init.body)) : setBody(input);
233     if (setBodyResult.hasException())
234         return setBodyResult;
235 
236     updateContentType();
237     return { };
238 }
239 
240 ExceptionOr&lt;void&gt; FetchRequest::setBody(FetchBody::Init&amp;&amp; body)
241 {
242     if (!methodCanHaveBody(m_request))
243         return Exception { TypeError, makeString(&quot;Request has method &#39;&quot;, m_request.httpMethod(), &quot;&#39; and cannot have a body&quot;) };
244 
245     ASSERT(scriptExecutionContext());
246     auto result = extractBody(WTFMove(body));
247     if (result.hasException())
248         return result;
249 
250     if (m_options.keepAlive &amp;&amp; hasReadableStreamBody())
</pre>
<hr />
<pre>
294     if (m_referrer == &quot;client&quot;)
295         return &quot;about:client&quot;_s;
296     return m_referrer;
297 }
298 
299 const String&amp; FetchRequest::urlString() const
300 {
301     if (m_requestURL.isNull())
302         m_requestURL = m_request.url();
303     return m_requestURL;
304 }
305 
306 ResourceRequest FetchRequest::resourceRequest() const
307 {
308     ASSERT(scriptExecutionContext());
309 
310     ResourceRequest request = m_request;
311     request.setHTTPHeaderFields(m_headers-&gt;internalHeaders());
312 
313     if (!isBodyNull())
<span class="line-modified">314         request.setHTTPBody(body().bodyAsFormData());</span>
315 
316     return request;
317 }
318 
319 ExceptionOr&lt;Ref&lt;FetchRequest&gt;&gt; FetchRequest::clone(ScriptExecutionContext&amp; context)
320 {
321     if (isDisturbedOrLocked())
322         return Exception { TypeError, &quot;Body is disturbed or locked&quot;_s };
323 
324     auto clone = adoptRef(*new FetchRequest(context, WTF::nullopt, FetchHeaders::create(m_headers.get()), ResourceRequest { m_request }, FetchOptions { m_options}, String { m_referrer }));
325     clone-&gt;cloneBody(*this);
326     clone-&gt;m_signal-&gt;follow(m_signal);
327     return clone;
328 }
329 
330 const char* FetchRequest::activeDOMObjectName() const
331 {
332     return &quot;Request&quot;;
333 }
334 






335 } // namespace WebCore
336 
</pre>
</td>
</tr>
</table>
<center><a href="FetchLoader.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="FetchRequest.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>