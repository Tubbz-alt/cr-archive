<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/JavaScriptCore/runtime/ObjectConstructor.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="NumberPrototype.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="ObjectConstructor.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/JavaScriptCore/runtime/ObjectConstructor.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  23 
  24 #include &quot;BuiltinNames.h&quot;
  25 #include &quot;ButterflyInlines.h&quot;
  26 #include &quot;Error.h&quot;
  27 #include &quot;ExceptionHelpers.h&quot;
  28 #include &quot;JSArray.h&quot;
  29 #include &quot;JSCInlines.h&quot;
  30 #include &quot;JSFunction.h&quot;
  31 #include &quot;JSGlobalObject.h&quot;
  32 #include &quot;JSGlobalObjectFunctions.h&quot;
  33 #include &quot;JSImmutableButterfly.h&quot;
  34 #include &quot;Lookup.h&quot;
  35 #include &quot;ObjectPrototype.h&quot;
  36 #include &quot;PropertyDescriptor.h&quot;
  37 #include &quot;PropertyNameArray.h&quot;
  38 #include &quot;StackVisitor.h&quot;
  39 #include &quot;Symbol.h&quot;
  40 
  41 namespace JSC {
  42 
<span class="line-modified">  43 EncodedJSValue JSC_HOST_CALL objectConstructorAssign(ExecState*);</span>
<span class="line-modified">  44 EncodedJSValue JSC_HOST_CALL objectConstructorValues(ExecState*);</span>
<span class="line-modified">  45 EncodedJSValue JSC_HOST_CALL objectConstructorGetPrototypeOf(ExecState*);</span>
<span class="line-modified">  46 EncodedJSValue JSC_HOST_CALL objectConstructorSetPrototypeOf(ExecState*);</span>
<span class="line-modified">  47 EncodedJSValue JSC_HOST_CALL objectConstructorGetOwnPropertyNames(ExecState*);</span>
<span class="line-modified">  48 EncodedJSValue JSC_HOST_CALL objectConstructorDefineProperty(ExecState*);</span>
<span class="line-modified">  49 EncodedJSValue JSC_HOST_CALL objectConstructorDefineProperties(ExecState*);</span>
<span class="line-modified">  50 EncodedJSValue JSC_HOST_CALL objectConstructorCreate(ExecState*);</span>
<span class="line-modified">  51 EncodedJSValue JSC_HOST_CALL objectConstructorSeal(ExecState*);</span>
<span class="line-modified">  52 EncodedJSValue JSC_HOST_CALL objectConstructorFreeze(ExecState*);</span>
<span class="line-modified">  53 EncodedJSValue JSC_HOST_CALL objectConstructorPreventExtensions(ExecState*);</span>
<span class="line-modified">  54 EncodedJSValue JSC_HOST_CALL objectConstructorIsSealed(ExecState*);</span>
<span class="line-modified">  55 EncodedJSValue JSC_HOST_CALL objectConstructorIsFrozen(ExecState*);</span>
<span class="line-modified">  56 EncodedJSValue JSC_HOST_CALL objectConstructorIsExtensible(ExecState*);</span>
<span class="line-modified">  57 EncodedJSValue JSC_HOST_CALL objectConstructorIs(ExecState*);</span>
  58 
  59 }
  60 
  61 #include &quot;ObjectConstructor.lut.h&quot;
  62 
  63 namespace JSC {
  64 
  65 STATIC_ASSERT_IS_TRIVIALLY_DESTRUCTIBLE(ObjectConstructor);
  66 
  67 const ClassInfo ObjectConstructor::s_info = { &quot;Function&quot;, &amp;InternalFunction::s_info, &amp;objectConstructorTable, nullptr, CREATE_METHOD_TABLE(ObjectConstructor) };
  68 
  69 /* Source for ObjectConstructor.lut.h
  70 @begin objectConstructorTable
  71   getPrototypeOf            objectConstructorGetPrototypeOf             DontEnum|Function 1 ObjectGetPrototypeOfIntrinsic
  72   setPrototypeOf            objectConstructorSetPrototypeOf             DontEnum|Function 2
  73   getOwnPropertyDescriptor  objectConstructorGetOwnPropertyDescriptor   DontEnum|Function 2
  74   getOwnPropertyDescriptors objectConstructorGetOwnPropertyDescriptors  DontEnum|Function 1
  75   getOwnPropertyNames       objectConstructorGetOwnPropertyNames        DontEnum|Function 1
  76   getOwnPropertySymbols     objectConstructorGetOwnPropertySymbols      DontEnum|Function 1
  77   keys                      objectConstructorKeys                       DontEnum|Function 1 ObjectKeysIntrinsic
  78   defineProperty            objectConstructorDefineProperty             DontEnum|Function 3
  79   defineProperties          objectConstructorDefineProperties           DontEnum|Function 2
  80   create                    objectConstructorCreate                     DontEnum|Function 2 ObjectCreateIntrinsic
  81   seal                      objectConstructorSeal                       DontEnum|Function 1
  82   freeze                    objectConstructorFreeze                     DontEnum|Function 1
  83   preventExtensions         objectConstructorPreventExtensions          DontEnum|Function 1
  84   isSealed                  objectConstructorIsSealed                   DontEnum|Function 1
  85   isFrozen                  objectConstructorIsFrozen                   DontEnum|Function 1
  86   isExtensible              objectConstructorIsExtensible               DontEnum|Function 1
  87   is                        objectConstructorIs                         DontEnum|Function 2 ObjectIsIntrinsic
  88   assign                    objectConstructorAssign                     DontEnum|Function 2
  89   values                    objectConstructorValues                     DontEnum|Function 1
  90   entries                   JSBuiltin                                   DontEnum|Function 1
  91   fromEntries               JSBuiltin                                   DontEnum|Function 1
  92 @end
  93 */
  94 
  95 
<span class="line-modified">  96 static EncodedJSValue JSC_HOST_CALL callObjectConstructor(ExecState*);</span>
<span class="line-modified">  97 static EncodedJSValue JSC_HOST_CALL constructWithObjectConstructor(ExecState*);</span>
  98 
  99 ObjectConstructor::ObjectConstructor(VM&amp; vm, Structure* structure)
 100     : InternalFunction(vm, structure, callObjectConstructor, constructWithObjectConstructor)
 101 {
 102 }
 103 
 104 void ObjectConstructor::finishCreation(VM&amp; vm, JSGlobalObject* globalObject, ObjectPrototype* objectPrototype)
 105 {
<span class="line-modified"> 106     Base::finishCreation(vm, vm.propertyNames-&gt;Object.string(), NameVisibility::Visible, NameAdditionMode::WithoutStructureTransition);</span>
 107 
 108     putDirectWithoutTransition(vm, vm.propertyNames-&gt;prototype, objectPrototype, PropertyAttribute::DontEnum | PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly);
 109     putDirectWithoutTransition(vm, vm.propertyNames-&gt;length, jsNumber(1), PropertyAttribute::ReadOnly | PropertyAttribute::DontEnum);
 110 
 111     JSC_NATIVE_FUNCTION_WITHOUT_TRANSITION(vm.propertyNames-&gt;builtinNames().createPrivateName(), objectConstructorCreate, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum), 2);
 112     JSC_NATIVE_FUNCTION_WITHOUT_TRANSITION(vm.propertyNames-&gt;builtinNames().definePropertyPrivateName(), objectConstructorDefineProperty, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum), 3);
 113     JSC_NATIVE_FUNCTION_WITHOUT_TRANSITION(vm.propertyNames-&gt;builtinNames().getPrototypeOfPrivateName(), objectConstructorGetPrototypeOf, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum), 1);
 114     JSC_NATIVE_FUNCTION_WITHOUT_TRANSITION(vm.propertyNames-&gt;builtinNames().getOwnPropertyNamesPrivateName(), objectConstructorGetOwnPropertyNames, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum), 1);
 115 }
 116 
 117 // ES 19.1.1.1 Object([value])
<span class="line-modified"> 118 static ALWAYS_INLINE JSObject* constructObject(ExecState* exec, JSValue newTarget)</span>
 119 {
<span class="line-modified"> 120     VM&amp; vm = exec-&gt;vm();</span>
<span class="line-modified"> 121     ObjectConstructor* objectConstructor = jsCast&lt;ObjectConstructor*&gt;(exec-&gt;jsCallee());</span>
<span class="line-removed"> 122     JSGlobalObject* globalObject = objectConstructor-&gt;globalObject(vm);</span>
 123     auto scope = DECLARE_THROW_SCOPE(vm);
 124 
 125     // We need to check newTarget condition in this caller side instead of InternalFunction::createSubclassStructure side.
 126     // Since if we found this condition is met, we should not fall into the type conversion in the step 3.
 127 
 128     // 1. If NewTarget is neither undefined nor the active function, then
 129     if (newTarget &amp;&amp; newTarget != objectConstructor) {
 130         // a. Return ? OrdinaryCreateFromConstructor(NewTarget, &quot;%ObjectPrototype%&quot;).
<span class="line-modified"> 131         Structure* objectStructure = InternalFunction::createSubclassStructure(exec, newTarget, globalObject-&gt;objectStructureForObjectConstructor());</span>
 132         RETURN_IF_EXCEPTION(scope, nullptr);
<span class="line-modified"> 133         return constructEmptyObject(exec, objectStructure);</span>
 134     }
 135 
 136     // 2. If value is null, undefined or not supplied, return ObjectCreate(%ObjectPrototype%).
<span class="line-modified"> 137     ArgList args(exec);</span>
<span class="line-modified"> 138     JSValue arg = args.at(0);</span>
<span class="line-modified"> 139     if (arg.isUndefinedOrNull())</span>
<span class="line-removed"> 140         return constructEmptyObject(exec, globalObject-&gt;objectStructureForObjectConstructor());</span>
 141 
 142     // 3. Return ToObject(value).
<span class="line-modified"> 143     RELEASE_AND_RETURN(scope, arg.toObject(exec, globalObject));</span>
 144 }
 145 
<span class="line-modified"> 146 static EncodedJSValue JSC_HOST_CALL constructWithObjectConstructor(ExecState* exec)</span>
 147 {
<span class="line-modified"> 148     return JSValue::encode(constructObject(exec, exec-&gt;newTarget()));</span>
 149 }
 150 
<span class="line-modified"> 151 static EncodedJSValue JSC_HOST_CALL callObjectConstructor(ExecState* exec)</span>
 152 {
<span class="line-modified"> 153     return JSValue::encode(constructObject(exec, JSValue()));</span>
 154 }
 155 
<span class="line-modified"> 156 EncodedJSValue JSC_HOST_CALL objectConstructorGetPrototypeOf(ExecState* exec)</span>
 157 {
<span class="line-modified"> 158     VM&amp; vm = exec-&gt;vm();</span>
 159     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified"> 160     JSObject* object = exec-&gt;argument(0).toObject(exec);</span>
 161     RETURN_IF_EXCEPTION(scope, encodedJSValue());
<span class="line-modified"> 162     RELEASE_AND_RETURN(scope, JSValue::encode(object-&gt;getPrototype(vm, exec)));</span>
 163 }
 164 
<span class="line-modified"> 165 EncodedJSValue JSC_HOST_CALL objectConstructorSetPrototypeOf(ExecState* exec)</span>
 166 {
<span class="line-modified"> 167     VM&amp; vm = exec-&gt;vm();</span>
 168     auto scope = DECLARE_THROW_SCOPE(vm);
 169 
<span class="line-modified"> 170     JSValue objectValue = exec-&gt;argument(0);</span>
 171     if (objectValue.isUndefinedOrNull())
<span class="line-modified"> 172         return throwVMTypeError(exec, scope, &quot;Cannot set prototype of undefined or null&quot;_s);</span>
 173 
<span class="line-modified"> 174     JSValue protoValue = exec-&gt;argument(1);</span>
 175     if (!protoValue.isObject() &amp;&amp; !protoValue.isNull())
<span class="line-modified"> 176         return throwVMTypeError(exec, scope, &quot;Prototype value can only be an object or null&quot;_s);</span>
 177 
<span class="line-modified"> 178     JSObject* object = objectValue.toObject(exec);</span>
 179     RETURN_IF_EXCEPTION(scope, encodedJSValue());
 180 
 181     bool shouldThrowIfCantSet = true;
<span class="line-modified"> 182     bool didSetPrototype = object-&gt;setPrototype(vm, exec, protoValue, shouldThrowIfCantSet);</span>
 183     EXCEPTION_ASSERT_UNUSED(didSetPrototype, scope.exception() || didSetPrototype);
 184     return JSValue::encode(objectValue);
 185 }
 186 
<span class="line-modified"> 187 JSValue objectConstructorGetOwnPropertyDescriptor(ExecState* exec, JSObject* object, const Identifier&amp; propertyName)</span>
 188 {
<span class="line-modified"> 189     VM&amp; vm = exec-&gt;vm();</span>
 190     auto scope = DECLARE_THROW_SCOPE(vm);
 191     PropertyDescriptor descriptor;
<span class="line-modified"> 192     if (!object-&gt;getOwnPropertyDescriptor(exec, propertyName, descriptor))</span>
 193         RELEASE_AND_RETURN(scope, jsUndefined());
 194     RETURN_IF_EXCEPTION(scope, { });
 195 
<span class="line-modified"> 196     JSObject* result = constructObjectFromPropertyDescriptor(exec, descriptor);</span>
 197     EXCEPTION_ASSERT(!!scope.exception() == !result);
 198     if (!result)
 199         return jsUndefined();
 200     return result;
 201 }
 202 
<span class="line-modified"> 203 JSValue objectConstructorGetOwnPropertyDescriptors(ExecState* exec, JSObject* object)</span>
 204 {
<span class="line-modified"> 205     VM&amp; vm = exec-&gt;vm();</span>
 206     auto scope = DECLARE_THROW_SCOPE(vm);
 207     PropertyNameArray properties(vm, PropertyNameMode::StringsAndSymbols, PrivateSymbolMode::Exclude);
<span class="line-modified"> 208     object-&gt;methodTable(vm)-&gt;getOwnPropertyNames(object, exec, properties, EnumerationMode(DontEnumPropertiesMode::Include));</span>
 209     RETURN_IF_EXCEPTION(scope, { });
 210 
<span class="line-modified"> 211     JSObject* descriptors = constructEmptyObject(exec);</span>
 212     RETURN_IF_EXCEPTION(scope, { });
 213 
 214     for (auto&amp; propertyName : properties) {
 215         PropertyDescriptor descriptor;
<span class="line-modified"> 216         bool didGetDescriptor = object-&gt;getOwnPropertyDescriptor(exec, propertyName, descriptor);</span>
 217         RETURN_IF_EXCEPTION(scope, { });
 218 
 219         if (!didGetDescriptor)
 220             continue;
 221 
<span class="line-modified"> 222         JSObject* fromDescriptor = constructObjectFromPropertyDescriptor(exec, descriptor);</span>
 223         EXCEPTION_ASSERT(!!scope.exception() == !fromDescriptor);
 224         if (!fromDescriptor)
 225             return jsUndefined();
 226 
 227         PutPropertySlot slot(descriptors);
<span class="line-modified"> 228         descriptors-&gt;putOwnDataPropertyMayBeIndex(exec, propertyName, fromDescriptor, slot);</span>
 229         scope.assertNoException();
 230     }
 231 
 232     return descriptors;
 233 }
 234 
<span class="line-modified"> 235 EncodedJSValue JSC_HOST_CALL objectConstructorGetOwnPropertyDescriptor(ExecState* exec)</span>
 236 {
<span class="line-modified"> 237     VM&amp; vm = exec-&gt;vm();</span>
 238     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified"> 239     JSObject* object = exec-&gt;argument(0).toObject(exec);</span>
 240     RETURN_IF_EXCEPTION(scope, encodedJSValue());
<span class="line-modified"> 241     auto propertyName = exec-&gt;argument(1).toPropertyKey(exec);</span>
 242     RETURN_IF_EXCEPTION(scope, encodedJSValue());
<span class="line-modified"> 243     RELEASE_AND_RETURN(scope, JSValue::encode(objectConstructorGetOwnPropertyDescriptor(exec, object, propertyName)));</span>
 244 }
 245 
<span class="line-modified"> 246 EncodedJSValue JSC_HOST_CALL objectConstructorGetOwnPropertyDescriptors(ExecState* exec)</span>
 247 {
<span class="line-modified"> 248     VM&amp; vm = exec-&gt;vm();</span>
 249     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified"> 250     JSObject* object = exec-&gt;argument(0).toObject(exec);</span>
 251     RETURN_IF_EXCEPTION(scope, encodedJSValue());
<span class="line-modified"> 252     RELEASE_AND_RETURN(scope, JSValue::encode(objectConstructorGetOwnPropertyDescriptors(exec, object)));</span>
 253 }
 254 
 255 // FIXME: Use the enumeration cache.
<span class="line-modified"> 256 EncodedJSValue JSC_HOST_CALL objectConstructorGetOwnPropertyNames(ExecState* exec)</span>
 257 {
<span class="line-modified"> 258     VM&amp; vm = exec-&gt;vm();</span>
 259     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified"> 260     JSObject* object = exec-&gt;argument(0).toObject(exec);</span>
 261     RETURN_IF_EXCEPTION(scope, encodedJSValue());
<span class="line-modified"> 262     RELEASE_AND_RETURN(scope, JSValue::encode(ownPropertyKeys(exec, object, PropertyNameMode::Strings, DontEnumPropertiesMode::Include)));</span>
 263 }
 264 
 265 // FIXME: Use the enumeration cache.
<span class="line-modified"> 266 EncodedJSValue JSC_HOST_CALL objectConstructorGetOwnPropertySymbols(ExecState* exec)</span>
 267 {
<span class="line-modified"> 268     VM&amp; vm = exec-&gt;vm();</span>
 269     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified"> 270     JSObject* object = exec-&gt;argument(0).toObject(exec);</span>
 271     RETURN_IF_EXCEPTION(scope, encodedJSValue());
<span class="line-modified"> 272     RELEASE_AND_RETURN(scope, JSValue::encode(ownPropertyKeys(exec, object, PropertyNameMode::Symbols, DontEnumPropertiesMode::Include)));</span>
 273 }
 274 
<span class="line-modified"> 275 EncodedJSValue JSC_HOST_CALL objectConstructorKeys(ExecState* exec)</span>
 276 {
<span class="line-modified"> 277     VM&amp; vm = exec-&gt;vm();</span>
 278     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified"> 279     JSObject* object = exec-&gt;argument(0).toObject(exec);</span>
 280     RETURN_IF_EXCEPTION(scope, encodedJSValue());
<span class="line-modified"> 281     RELEASE_AND_RETURN(scope, JSValue::encode(ownPropertyKeys(exec, object, PropertyNameMode::Strings, DontEnumPropertiesMode::Exclude)));</span>
 282 }
 283 
<span class="line-modified"> 284 EncodedJSValue JSC_HOST_CALL objectConstructorAssign(ExecState* exec)</span>
 285 {
<span class="line-modified"> 286     VM&amp; vm = exec-&gt;vm();</span>
 287     auto scope = DECLARE_THROW_SCOPE(vm);
 288 
<span class="line-modified"> 289     JSValue targetValue = exec-&gt;argument(0);</span>
 290     if (targetValue.isUndefinedOrNull())
<span class="line-modified"> 291         return throwVMTypeError(exec, scope, &quot;Object.assign requires that input parameter not be null or undefined&quot;_s);</span>
<span class="line-modified"> 292     JSObject* target = targetValue.toObject(exec);</span>
 293     RETURN_IF_EXCEPTION(scope, { });
 294 
 295     // FIXME: Extend this for non JSFinalObject. For example, we would like to use this fast path for function objects too.
 296     // https://bugs.webkit.org/show_bug.cgi?id=185358
 297     bool targetCanPerformFastPut = jsDynamicCast&lt;JSFinalObject*&gt;(vm, target) &amp;&amp; target-&gt;canPerformFastPutInlineExcludingProto(vm);
 298 
 299     Vector&lt;RefPtr&lt;UniquedStringImpl&gt;, 8&gt; properties;
 300     MarkedArgumentBuffer values;
<span class="line-modified"> 301     unsigned argsCount = exec-&gt;argumentCount();</span>
 302     for (unsigned i = 1; i &lt; argsCount; ++i) {
<span class="line-modified"> 303         JSValue sourceValue = exec-&gt;uncheckedArgument(i);</span>
 304         if (sourceValue.isUndefinedOrNull())
 305             continue;
<span class="line-modified"> 306         JSObject* source = sourceValue.toObject(exec);</span>
 307         RETURN_IF_EXCEPTION(scope, { });
 308 
 309         if (targetCanPerformFastPut) {
 310             if (!source-&gt;staticPropertiesReified(vm)) {
<span class="line-modified"> 311                 source-&gt;reifyAllStaticProperties(exec);</span>
 312                 RETURN_IF_EXCEPTION(scope, { });
 313             }
 314 
 315             auto canPerformFastPropertyEnumerationForObjectAssign = [] (Structure* structure) {
 316                 if (structure-&gt;typeInfo().overridesGetOwnPropertySlot())
 317                     return false;
 318                 if (structure-&gt;typeInfo().overridesGetPropertyNames())
 319                     return false;
 320                 // FIXME: Indexed properties can be handled.
 321                 // https://bugs.webkit.org/show_bug.cgi?id=185358
 322                 if (hasIndexedProperties(structure-&gt;indexingType()))
 323                     return false;
 324                 if (structure-&gt;hasGetterSetterProperties())
 325                     return false;
 326                 if (structure-&gt;isUncacheableDictionary())
 327                     return false;
 328                 // Cannot perform fast [[Put]] to |target| if the property names of the |source| contain &quot;__proto__&quot;.
 329                 if (structure-&gt;hasUnderscoreProtoPropertyExcludingOriginalProto())
 330                     return false;
 331                 return true;
</pre>
<hr />
<pre>
 357                     values.appendWithCrashOnOverflow(source-&gt;getDirect(entry.offset));
 358 
 359                     return true;
 360                 });
 361 
 362                 for (size_t i = 0; i &lt; properties.size(); ++i) {
 363                     // FIXME: We could put properties in a batching manner to accelerate Object.assign more.
 364                     // https://bugs.webkit.org/show_bug.cgi?id=185358
 365                     PutPropertySlot putPropertySlot(target, true);
 366                     target-&gt;putOwnDataProperty(vm, properties[i].get(), values.at(i), putPropertySlot);
 367                 }
 368                 continue;
 369             }
 370         }
 371 
 372         // [[GetOwnPropertyNames]], [[Get]] etc. could modify target object and invalidate this assumption.
 373         // For example, [[Get]] of source object could configure setter to target object. So disable the fast path.
 374         targetCanPerformFastPut = false;
 375 
 376         PropertyNameArray properties(vm, PropertyNameMode::StringsAndSymbols, PrivateSymbolMode::Exclude);
<span class="line-modified"> 377         source-&gt;methodTable(vm)-&gt;getOwnPropertyNames(source, exec, properties, EnumerationMode(DontEnumPropertiesMode::Include));</span>
 378         RETURN_IF_EXCEPTION(scope, { });
 379 
 380         auto assign = [&amp;] (PropertyName propertyName) {
 381             PropertySlot slot(source, PropertySlot::InternalMethodType::GetOwnProperty);
<span class="line-modified"> 382             bool hasProperty = source-&gt;methodTable(vm)-&gt;getOwnPropertySlot(source, exec, propertyName, slot);</span>
 383             RETURN_IF_EXCEPTION(scope, void());
 384             if (!hasProperty)
 385                 return;
 386             if (slot.attributes() &amp; PropertyAttribute::DontEnum)
 387                 return;
 388 
 389             JSValue value;
 390             if (LIKELY(!slot.isTaintedByOpaqueObject()))
<span class="line-modified"> 391                 value = slot.getValue(exec, propertyName);</span>
 392             else
<span class="line-modified"> 393                 value = source-&gt;get(exec, propertyName);</span>
 394             RETURN_IF_EXCEPTION(scope, void());
 395 
 396             PutPropertySlot putPropertySlot(target, true);
<span class="line-modified"> 397             target-&gt;putInline(exec, propertyName, value, putPropertySlot);</span>
 398         };
 399 
 400         // First loop is for strings. Second loop is for symbols to keep standardized order requirement in the spec.
 401         // https://tc39.github.io/ecma262/#sec-ordinaryownpropertykeys
 402         bool foundSymbol = false;
 403         unsigned numProperties = properties.size();
 404         for (unsigned j = 0; j &lt; numProperties; j++) {
 405             const auto&amp; propertyName = properties[j];
 406             if (propertyName.isSymbol()) {
 407                 foundSymbol = true;
 408                 continue;
 409             }
 410 
 411             assign(propertyName);
 412             RETURN_IF_EXCEPTION(scope, { });
 413         }
 414 
 415         if (foundSymbol) {
 416             for (unsigned j = 0; j &lt; numProperties; j++) {
 417                 const auto&amp; propertyName = properties[j];
 418                 if (propertyName.isSymbol()) {
 419                     ASSERT(!propertyName.isPrivateName());
 420                     assign(propertyName);
 421                     RETURN_IF_EXCEPTION(scope, { });
 422                 }
 423             }
 424         }
 425     }
 426     return JSValue::encode(target);
 427 }
 428 
<span class="line-modified"> 429 EncodedJSValue JSC_HOST_CALL objectConstructorValues(ExecState* exec)</span>
 430 {
<span class="line-modified"> 431     VM&amp; vm = exec-&gt;vm();</span>
 432     auto scope = DECLARE_THROW_SCOPE(vm);
 433 
<span class="line-modified"> 434     JSValue targetValue = exec-&gt;argument(0);</span>
 435     if (targetValue.isUndefinedOrNull())
<span class="line-modified"> 436         return throwVMTypeError(exec, scope, &quot;Object.values requires that input parameter not be null or undefined&quot;_s);</span>
<span class="line-modified"> 437     JSObject* target = targetValue.toObject(exec);</span>
 438     RETURN_IF_EXCEPTION(scope, { });
 439 
<span class="line-modified"> 440     JSArray* values = constructEmptyArray(exec, nullptr);</span>
 441     RETURN_IF_EXCEPTION(scope, { });
 442 
 443     PropertyNameArray properties(vm, PropertyNameMode::Strings, PrivateSymbolMode::Exclude);
<span class="line-modified"> 444     target-&gt;methodTable(vm)-&gt;getOwnPropertyNames(target, exec, properties, EnumerationMode(DontEnumPropertiesMode::Include));</span>
 445     RETURN_IF_EXCEPTION(scope, { });
 446 
 447     unsigned index = 0;
 448     auto addValue = [&amp;] (PropertyName propertyName) {
 449         PropertySlot slot(target, PropertySlot::InternalMethodType::GetOwnProperty);
<span class="line-modified"> 450         bool hasProperty = target-&gt;methodTable(vm)-&gt;getOwnPropertySlot(target, exec, propertyName, slot);</span>
 451         RETURN_IF_EXCEPTION(scope, void());
 452         if (!hasProperty)
 453             return;
 454         if (slot.attributes() &amp; PropertyAttribute::DontEnum)
 455             return;
 456 
 457         JSValue value;
 458         if (LIKELY(!slot.isTaintedByOpaqueObject()))
<span class="line-modified"> 459             value = slot.getValue(exec, propertyName);</span>
 460         else
<span class="line-modified"> 461             value = target-&gt;get(exec, propertyName);</span>
 462         RETURN_IF_EXCEPTION(scope, void());
 463 
<span class="line-modified"> 464         values-&gt;putDirectIndex(exec, index++, value);</span>
 465     };
 466 
 467     for (unsigned i = 0, numProperties = properties.size(); i &lt; numProperties; i++) {
 468         const auto&amp; propertyName = properties[i];
 469         if (propertyName.isSymbol())
 470             continue;
 471 
 472         addValue(propertyName);
 473         RETURN_IF_EXCEPTION(scope, { });
 474     }
 475 
 476     return JSValue::encode(values);
 477 }
 478 
 479 
 480 // ES6 6.2.4.5 ToPropertyDescriptor
 481 // https://tc39.github.io/ecma262/#sec-topropertydescriptor
<span class="line-modified"> 482 bool toPropertyDescriptor(ExecState* exec, JSValue in, PropertyDescriptor&amp; desc)</span>
 483 {
<span class="line-modified"> 484     VM&amp; vm = exec-&gt;vm();</span>
 485     auto scope = DECLARE_THROW_SCOPE(vm);
 486 
 487     if (!in.isObject()) {
<span class="line-modified"> 488         throwTypeError(exec, scope, &quot;Property description must be an object.&quot;_s);</span>
 489         return false;
 490     }
 491     JSObject* description = asObject(in);
 492 
<span class="line-modified"> 493     bool hasProperty = description-&gt;hasProperty(exec, vm.propertyNames-&gt;enumerable);</span>
 494     EXCEPTION_ASSERT(!scope.exception() || !hasProperty);
 495     if (hasProperty) {
<span class="line-modified"> 496         JSValue value = description-&gt;get(exec, vm.propertyNames-&gt;enumerable);</span>
 497         RETURN_IF_EXCEPTION(scope, false);
<span class="line-modified"> 498         desc.setEnumerable(value.toBoolean(exec));</span>
 499     } else
 500         RETURN_IF_EXCEPTION(scope, false);
 501 
<span class="line-modified"> 502     hasProperty = description-&gt;hasProperty(exec, vm.propertyNames-&gt;configurable);</span>
 503     EXCEPTION_ASSERT(!scope.exception() || !hasProperty);
 504     if (hasProperty) {
<span class="line-modified"> 505         JSValue value = description-&gt;get(exec, vm.propertyNames-&gt;configurable);</span>
 506         RETURN_IF_EXCEPTION(scope, false);
<span class="line-modified"> 507         desc.setConfigurable(value.toBoolean(exec));</span>
 508     } else
 509         RETURN_IF_EXCEPTION(scope, false);
 510 
 511     JSValue value;
<span class="line-modified"> 512     hasProperty = description-&gt;hasProperty(exec, vm.propertyNames-&gt;value);</span>
 513     EXCEPTION_ASSERT(!scope.exception() || !hasProperty);
 514     if (hasProperty) {
<span class="line-modified"> 515         JSValue value = description-&gt;get(exec, vm.propertyNames-&gt;value);</span>
 516         RETURN_IF_EXCEPTION(scope, false);
 517         desc.setValue(value);
 518     } else
 519         RETURN_IF_EXCEPTION(scope, false);
 520 
<span class="line-modified"> 521     hasProperty = description-&gt;hasProperty(exec, vm.propertyNames-&gt;writable);</span>
 522     EXCEPTION_ASSERT(!scope.exception() || !hasProperty);
 523     if (hasProperty) {
<span class="line-modified"> 524         JSValue value = description-&gt;get(exec, vm.propertyNames-&gt;writable);</span>
 525         RETURN_IF_EXCEPTION(scope, false);
<span class="line-modified"> 526         desc.setWritable(value.toBoolean(exec));</span>
 527     } else
 528         RETURN_IF_EXCEPTION(scope, false);
 529 
<span class="line-modified"> 530     hasProperty = description-&gt;hasProperty(exec, vm.propertyNames-&gt;get);</span>
 531     EXCEPTION_ASSERT(!scope.exception() || !hasProperty);
 532     if (hasProperty) {
<span class="line-modified"> 533         JSValue get = description-&gt;get(exec, vm.propertyNames-&gt;get);</span>
 534         RETURN_IF_EXCEPTION(scope, false);
 535         if (!get.isUndefined()) {
 536             CallData callData;
 537             if (getCallData(vm, get, callData) == CallType::None) {
<span class="line-modified"> 538                 throwTypeError(exec, scope, &quot;Getter must be a function.&quot;_s);</span>
 539                 return false;
 540             }
 541         }
 542         desc.setGetter(get);
 543     } else
 544         RETURN_IF_EXCEPTION(scope, false);
 545 
<span class="line-modified"> 546     hasProperty = description-&gt;hasProperty(exec, vm.propertyNames-&gt;set);</span>
 547     EXCEPTION_ASSERT(!scope.exception() || !hasProperty);
 548     if (hasProperty) {
<span class="line-modified"> 549         JSValue set = description-&gt;get(exec, vm.propertyNames-&gt;set);</span>
 550         RETURN_IF_EXCEPTION(scope, false);
 551         if (!set.isUndefined()) {
 552             CallData callData;
 553             if (getCallData(vm, set, callData) == CallType::None) {
<span class="line-modified"> 554                 throwTypeError(exec, scope, &quot;Setter must be a function.&quot;_s);</span>
 555                 return false;
 556             }
 557         }
 558         desc.setSetter(set);
 559     } else
 560         RETURN_IF_EXCEPTION(scope, false);
 561 
 562     if (!desc.isAccessorDescriptor())
 563         return true;
 564 
 565     if (desc.value()) {
<span class="line-modified"> 566         throwTypeError(exec, scope, &quot;Invalid property.  &#39;value&#39; present on property with getter or setter.&quot;_s);</span>
 567         return false;
 568     }
 569 
 570     if (desc.writablePresent()) {
<span class="line-modified"> 571         throwTypeError(exec, scope, &quot;Invalid property.  &#39;writable&#39; present on property with getter or setter.&quot;_s);</span>
 572         return false;
 573     }
 574     return true;
 575 }
 576 
<span class="line-modified"> 577 EncodedJSValue JSC_HOST_CALL objectConstructorDefineProperty(ExecState* exec)</span>
 578 {
<span class="line-modified"> 579     VM&amp; vm = exec-&gt;vm();</span>
 580     auto scope = DECLARE_THROW_SCOPE(vm);
 581 
<span class="line-modified"> 582     if (!exec-&gt;argument(0).isObject())</span>
<span class="line-modified"> 583         return throwVMTypeError(exec, scope, &quot;Properties can only be defined on Objects.&quot;_s);</span>
<span class="line-modified"> 584     JSObject* obj = asObject(exec-&gt;argument(0));</span>
<span class="line-modified"> 585     auto propertyName = exec-&gt;argument(1).toPropertyKey(exec);</span>
 586     RETURN_IF_EXCEPTION(scope, encodedJSValue());
 587     PropertyDescriptor descriptor;
<span class="line-modified"> 588     auto success = toPropertyDescriptor(exec, exec-&gt;argument(2), descriptor);</span>
 589     EXCEPTION_ASSERT(!scope.exception() == success);
 590     if (!success)
 591         return JSValue::encode(jsNull());
 592     ASSERT((descriptor.attributes() &amp; PropertyAttribute::Accessor) || (!descriptor.isAccessorDescriptor()));
 593     scope.assertNoException();
<span class="line-modified"> 594     obj-&gt;methodTable(vm)-&gt;defineOwnProperty(obj, exec, propertyName, descriptor, true);</span>
 595     RELEASE_AND_RETURN(scope, JSValue::encode(obj));
 596 }
 597 
<span class="line-modified"> 598 static JSValue defineProperties(ExecState* exec, JSObject* object, JSObject* properties)</span>
 599 {
<span class="line-modified"> 600     VM&amp; vm = exec-&gt;vm();</span>
 601     auto scope = DECLARE_THROW_SCOPE(vm);
 602 
 603     PropertyNameArray propertyNames(vm, PropertyNameMode::StringsAndSymbols, PrivateSymbolMode::Exclude);
<span class="line-modified"> 604     asObject(properties)-&gt;methodTable(vm)-&gt;getOwnPropertyNames(asObject(properties), exec, propertyNames, EnumerationMode(DontEnumPropertiesMode::Exclude));</span>
 605     RETURN_IF_EXCEPTION(scope, { });
 606     size_t numProperties = propertyNames.size();
 607     Vector&lt;PropertyDescriptor&gt; descriptors;
 608     MarkedArgumentBuffer markBuffer;
 609 #define RETURN_IF_EXCEPTION_CLEARING_OVERFLOW(value) do { \
 610     if (scope.exception()) { \
 611         markBuffer.overflowCheckNotNeeded(); \
 612         return value; \
 613     } \
 614 } while (false)
 615     for (size_t i = 0; i &lt; numProperties; i++) {
<span class="line-modified"> 616         JSValue prop = properties-&gt;get(exec, propertyNames[i]);</span>
 617         RETURN_IF_EXCEPTION_CLEARING_OVERFLOW({ });
 618         PropertyDescriptor descriptor;
<span class="line-modified"> 619         toPropertyDescriptor(exec, prop, descriptor);</span>
 620         RETURN_IF_EXCEPTION_CLEARING_OVERFLOW({ });
 621         descriptors.append(descriptor);
 622         // Ensure we mark all the values that we&#39;re accumulating
 623         if (descriptor.isDataDescriptor() &amp;&amp; descriptor.value())
 624             markBuffer.append(descriptor.value());
 625         if (descriptor.isAccessorDescriptor()) {
 626             if (descriptor.getter())
 627                 markBuffer.append(descriptor.getter());
 628             if (descriptor.setter())
 629                 markBuffer.append(descriptor.setter());
 630         }
 631     }
 632     RELEASE_ASSERT(!markBuffer.hasOverflowed());
 633 #undef RETURN_IF_EXCEPTION_CLEARING_OVERFLOW
 634     for (size_t i = 0; i &lt; numProperties; i++) {
 635         auto&amp; propertyName = propertyNames[i];
 636         ASSERT(!propertyName.isPrivateName());
 637 
<span class="line-modified"> 638         object-&gt;methodTable(vm)-&gt;defineOwnProperty(object, exec, propertyName, descriptors[i], true);</span>
 639         RETURN_IF_EXCEPTION(scope, { });
 640     }
 641     return object;
 642 }
 643 
<span class="line-modified"> 644 EncodedJSValue JSC_HOST_CALL objectConstructorDefineProperties(ExecState* exec)</span>
 645 {
<span class="line-modified"> 646     VM&amp; vm = exec-&gt;vm();</span>
 647     auto scope = DECLARE_THROW_SCOPE(vm);
 648 
<span class="line-modified"> 649     if (!exec-&gt;argument(0).isObject())</span>
<span class="line-modified"> 650         return throwVMTypeError(exec, scope, &quot;Properties can only be defined on Objects.&quot;_s);</span>
<span class="line-modified"> 651     JSObject* targetObj = asObject(exec-&gt;argument(0));</span>
<span class="line-modified"> 652     JSObject* props = exec-&gt;argument(1).toObject(exec);</span>
 653     EXCEPTION_ASSERT(!!scope.exception() == !props);
 654     if (UNLIKELY(!props))
 655         return encodedJSValue();
<span class="line-modified"> 656     RELEASE_AND_RETURN(scope, JSValue::encode(defineProperties(exec, targetObj, props)));</span>
 657 }
 658 
<span class="line-modified"> 659 EncodedJSValue JSC_HOST_CALL objectConstructorCreate(ExecState* exec)</span>
 660 {
<span class="line-modified"> 661     VM&amp; vm = exec-&gt;vm();</span>
 662     auto scope = DECLARE_THROW_SCOPE(vm);
 663 
<span class="line-modified"> 664     JSValue proto = exec-&gt;argument(0);</span>
 665     if (!proto.isObject() &amp;&amp; !proto.isNull())
<span class="line-modified"> 666         return throwVMTypeError(exec, scope, &quot;Object prototype may only be an Object or null.&quot;_s);</span>
 667     JSObject* newObject = proto.isObject()
<span class="line-modified"> 668         ? constructEmptyObject(exec, asObject(proto))</span>
<span class="line-modified"> 669         : constructEmptyObject(exec, exec-&gt;lexicalGlobalObject()-&gt;nullPrototypeObjectStructure());</span>
<span class="line-modified"> 670     if (exec-&gt;argument(1).isUndefined())</span>
 671         return JSValue::encode(newObject);
<span class="line-modified"> 672     JSObject* properties = exec-&gt;uncheckedArgument(1).toObject(exec);</span>
 673     RETURN_IF_EXCEPTION(scope, { });
 674 
<span class="line-modified"> 675     RELEASE_AND_RETURN(scope, JSValue::encode(defineProperties(exec, newObject, properties)));</span>
 676 }
 677 
 678 enum class IntegrityLevel {
 679     Sealed,
 680     Frozen
 681 };
 682 
 683 template&lt;IntegrityLevel level&gt;
<span class="line-modified"> 684 bool setIntegrityLevel(ExecState* exec, VM&amp; vm, JSObject* object)</span>
 685 {
 686     // See https://tc39.github.io/ecma262/#sec-setintegritylevel.
 687     auto scope = DECLARE_THROW_SCOPE(vm);
 688 
<span class="line-modified"> 689     bool success = object-&gt;methodTable(vm)-&gt;preventExtensions(object, exec);</span>
 690     RETURN_IF_EXCEPTION(scope, false);
 691     if (UNLIKELY(!success))
 692         return false;
 693 
 694     PropertyNameArray properties(vm, PropertyNameMode::StringsAndSymbols, PrivateSymbolMode::Exclude);
<span class="line-modified"> 695     object-&gt;methodTable(vm)-&gt;getOwnPropertyNames(object, exec, properties, EnumerationMode(DontEnumPropertiesMode::Include));</span>
 696     RETURN_IF_EXCEPTION(scope, false);
 697 
 698     PropertyNameArray::const_iterator end = properties.end();
 699     for (PropertyNameArray::const_iterator iter = properties.begin(); iter != end; ++iter) {
 700         auto&amp; propertyName = *iter;
 701         ASSERT(!propertyName.isPrivateName());
 702 
 703         PropertyDescriptor desc;
 704         if (level == IntegrityLevel::Sealed)
 705             desc.setConfigurable(false);
 706         else {
<span class="line-modified"> 707             bool hasPropertyDescriptor = object-&gt;getOwnPropertyDescriptor(exec, propertyName, desc);</span>
 708             RETURN_IF_EXCEPTION(scope, false);
 709             if (!hasPropertyDescriptor)
 710                 continue;
 711 
 712             if (desc.isDataDescriptor())
 713                 desc.setWritable(false);
 714 
 715             desc.setConfigurable(false);
 716         }
 717 
<span class="line-modified"> 718         object-&gt;methodTable(vm)-&gt;defineOwnProperty(object, exec, propertyName, desc, true);</span>
 719         RETURN_IF_EXCEPTION(scope, false);
 720     }
 721     return true;
 722 }
 723 
 724 template&lt;IntegrityLevel level&gt;
<span class="line-modified"> 725 bool testIntegrityLevel(ExecState* exec, VM&amp; vm, JSObject* object)</span>
 726 {
 727     auto scope = DECLARE_THROW_SCOPE(vm);
 728 
 729     // 1. Assert: Type(O) is Object.
 730     // 2. Assert: level is either &quot;sealed&quot; or &quot;frozen&quot;.
 731 
 732     // 3. Let status be ?IsExtensible(O).
<span class="line-modified"> 733     bool status = object-&gt;isExtensible(exec);</span>
 734     RETURN_IF_EXCEPTION(scope, { });
 735 
 736     // 4. If status is true, return false.
 737     if (status)
 738         return false;
 739 
 740     // 6. Let keys be ? O.[[OwnPropertyKeys]]().
 741     PropertyNameArray keys(vm, PropertyNameMode::StringsAndSymbols, PrivateSymbolMode::Exclude);
<span class="line-modified"> 742     object-&gt;methodTable(vm)-&gt;getOwnPropertyNames(object, exec, keys, EnumerationMode(DontEnumPropertiesMode::Include));</span>
 743     RETURN_IF_EXCEPTION(scope, { });
 744 
 745     // 7. For each element k of keys, do
 746     PropertyNameArray::const_iterator end = keys.end();
 747     for (PropertyNameArray::const_iterator iter = keys.begin(); iter != end; ++iter) {
 748         auto&amp; propertyName = *iter;
 749         ASSERT(!propertyName.isPrivateName());
 750 
 751         // a. Let currentDesc be ? O.[[GetOwnProperty]](k)
 752         PropertyDescriptor desc;
<span class="line-modified"> 753         bool didGetDescriptor = object-&gt;getOwnPropertyDescriptor(exec, propertyName, desc);</span>
 754         RETURN_IF_EXCEPTION(scope, { });
 755 
 756         // b. If currentDesc is not undefined, then
 757         if (!didGetDescriptor)
 758             continue;
 759 
 760         // i. If currentDesc.[[Configurable]] is true, return false.
 761         if (desc.configurable())
 762             return false;
 763 
 764         // ii. If level is &quot;frozen&quot; and IsDataDescriptor(currentDesc) is true, then
 765         // 1. If currentDesc.[[Writable]] is true, return false.
 766         if (level == IntegrityLevel::Frozen &amp;&amp; desc.isDataDescriptor() &amp;&amp; desc.writable())
 767             return false;
 768     }
 769 
 770     return true;
 771 }
 772 
<span class="line-modified"> 773 JSObject* objectConstructorSeal(ExecState* exec, JSObject* object)</span>
 774 {
<span class="line-modified"> 775     VM&amp; vm = exec-&gt;vm();</span>
 776     auto scope = DECLARE_THROW_SCOPE(vm);
 777 
 778     if (jsDynamicCast&lt;JSFinalObject*&gt;(vm, object) &amp;&amp; !hasIndexedProperties(object-&gt;indexingType())) {
 779         object-&gt;seal(vm);
 780         return object;
 781     }
 782 
<span class="line-modified"> 783     bool success = setIntegrityLevel&lt;IntegrityLevel::Sealed&gt;(exec, vm, object);</span>
 784     RETURN_IF_EXCEPTION(scope, nullptr);
 785     if (UNLIKELY(!success)) {
<span class="line-modified"> 786         throwTypeError(exec, scope, &quot;Unable to prevent extension in Object.seal&quot;_s);</span>
 787         return nullptr;
 788     }
 789 
 790     return object;
 791 }
 792 
<span class="line-modified"> 793 EncodedJSValue JSC_HOST_CALL objectConstructorSeal(ExecState* exec)</span>
 794 {
<span class="line-modified"> 795     VM&amp; vm = exec-&gt;vm();</span>
 796     auto scope = DECLARE_THROW_SCOPE(vm);
 797 
 798     // 1. If Type(O) is not Object, return O.
<span class="line-modified"> 799     JSValue obj = exec-&gt;argument(0);</span>
 800     if (!obj.isObject())
 801         return JSValue::encode(obj);
 802 
<span class="line-modified"> 803     RELEASE_AND_RETURN(scope, JSValue::encode(objectConstructorSeal(exec, asObject(obj))));</span>
 804 }
 805 
<span class="line-modified"> 806 JSObject* objectConstructorFreeze(ExecState* exec, JSObject* object)</span>
 807 {
<span class="line-modified"> 808     VM&amp; vm = exec-&gt;vm();</span>
 809     auto scope = DECLARE_THROW_SCOPE(vm);
 810 
 811     if (jsDynamicCast&lt;JSFinalObject*&gt;(vm, object) &amp;&amp; !hasIndexedProperties(object-&gt;indexingType())) {
 812         object-&gt;freeze(vm);
 813         return object;
 814     }
 815 
<span class="line-modified"> 816     bool success = setIntegrityLevel&lt;IntegrityLevel::Frozen&gt;(exec, vm, object);</span>
 817     RETURN_IF_EXCEPTION(scope, nullptr);
 818     if (UNLIKELY(!success)) {
<span class="line-modified"> 819         throwTypeError(exec, scope, &quot;Unable to prevent extension in Object.freeze&quot;_s);</span>
 820         return nullptr;
 821     }
 822     return object;
 823 }
 824 
<span class="line-modified"> 825 EncodedJSValue JSC_HOST_CALL objectConstructorFreeze(ExecState* exec)</span>
 826 {
<span class="line-modified"> 827     VM&amp; vm = exec-&gt;vm();</span>
 828     auto scope = DECLARE_THROW_SCOPE(vm);
 829     // 1. If Type(O) is not Object, return O.
<span class="line-modified"> 830     JSValue obj = exec-&gt;argument(0);</span>
 831     if (!obj.isObject())
 832         return JSValue::encode(obj);
<span class="line-modified"> 833     JSObject* result = objectConstructorFreeze(exec, asObject(obj));</span>
 834     RETURN_IF_EXCEPTION(scope, encodedJSValue());
 835     return JSValue::encode(result);
 836 }
 837 
<span class="line-modified"> 838 EncodedJSValue JSC_HOST_CALL objectConstructorPreventExtensions(ExecState* exec)</span>
 839 {
<span class="line-modified"> 840     VM&amp; vm = exec-&gt;vm();</span>
<span class="line-modified"> 841     JSValue argument = exec-&gt;argument(0);</span>


 842     if (!argument.isObject())
 843         return JSValue::encode(argument);
 844     JSObject* object = asObject(argument);
<span class="line-modified"> 845     object-&gt;methodTable(vm)-&gt;preventExtensions(object, exec);</span>



 846     return JSValue::encode(object);
 847 }
 848 
<span class="line-modified"> 849 EncodedJSValue JSC_HOST_CALL objectConstructorIsSealed(ExecState* exec)</span>
 850 {
<span class="line-modified"> 851     VM&amp; vm = exec-&gt;vm();</span>
 852 
 853     // 1. If Type(O) is not Object, return true.
<span class="line-modified"> 854     JSValue obj = exec-&gt;argument(0);</span>
 855     if (!obj.isObject())
 856         return JSValue::encode(jsBoolean(true));
 857     JSObject* object = asObject(obj);
 858 
 859     // Quick check for final objects.
 860     if (jsDynamicCast&lt;JSFinalObject*&gt;(vm, object) &amp;&amp; !hasIndexedProperties(object-&gt;indexingType()))
 861         return JSValue::encode(jsBoolean(object-&gt;isSealed(vm)));
 862 
 863     // 2. Return ? TestIntegrityLevel(O, &quot;sealed&quot;).
<span class="line-modified"> 864     return JSValue::encode(jsBoolean(testIntegrityLevel&lt;IntegrityLevel::Sealed&gt;(exec, vm, object)));</span>
 865 }
 866 
<span class="line-modified"> 867 EncodedJSValue JSC_HOST_CALL objectConstructorIsFrozen(ExecState* exec)</span>
 868 {
<span class="line-modified"> 869     VM&amp; vm = exec-&gt;vm();</span>
 870 
 871     // 1. If Type(O) is not Object, return true.
<span class="line-modified"> 872     JSValue obj = exec-&gt;argument(0);</span>
 873     if (!obj.isObject())
 874         return JSValue::encode(jsBoolean(true));
 875     JSObject* object = asObject(obj);
 876 
 877     // Quick check for final objects.
 878     if (jsDynamicCast&lt;JSFinalObject*&gt;(vm, object) &amp;&amp; !hasIndexedProperties(object-&gt;indexingType()))
 879         return JSValue::encode(jsBoolean(object-&gt;isFrozen(vm)));
 880 
 881     // 2. Return ? TestIntegrityLevel(O, &quot;frozen&quot;).
<span class="line-modified"> 882     return JSValue::encode(jsBoolean(testIntegrityLevel&lt;IntegrityLevel::Frozen&gt;(exec, vm, object)));</span>
 883 }
 884 
<span class="line-modified"> 885 EncodedJSValue JSC_HOST_CALL objectConstructorIsExtensible(ExecState* exec)</span>
 886 {
<span class="line-modified"> 887     VM&amp; vm = exec-&gt;vm();</span>
 888     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified"> 889     JSValue obj = exec-&gt;argument(0);</span>
 890     if (!obj.isObject())
 891         return JSValue::encode(jsBoolean(false));
 892     JSObject* object = asObject(obj);
<span class="line-modified"> 893     bool isExtensible = object-&gt;isExtensible(exec);</span>
 894     RETURN_IF_EXCEPTION(scope, encodedJSValue());
 895     return JSValue::encode(jsBoolean(isExtensible));
 896 }
 897 
<span class="line-modified"> 898 EncodedJSValue JSC_HOST_CALL objectConstructorIs(ExecState* exec)</span>
 899 {
<span class="line-modified"> 900     return JSValue::encode(jsBoolean(sameValue(exec, exec-&gt;argument(0), exec-&gt;argument(1))));</span>
 901 }
 902 
<span class="line-modified"> 903 JSArray* ownPropertyKeys(ExecState* exec, JSObject* object, PropertyNameMode propertyNameMode, DontEnumPropertiesMode dontEnumPropertiesMode)</span>
 904 {
<span class="line-modified"> 905     VM&amp; vm = exec-&gt;vm();</span>
 906     auto scope = DECLARE_THROW_SCOPE(vm);
 907 
<span class="line-removed"> 908     auto* globalObject = exec-&gt;lexicalGlobalObject();</span>
 909     bool isObjectKeys = propertyNameMode == PropertyNameMode::Strings &amp;&amp; dontEnumPropertiesMode == DontEnumPropertiesMode::Exclude;
 910     // We attempt to look up own property keys cache in Object.keys case.
 911     if (isObjectKeys) {
 912         if (LIKELY(!globalObject-&gt;isHavingABadTime())) {
 913             if (auto* immutableButterfly = object-&gt;structure(vm)-&gt;cachedOwnKeys()) {
 914                 Structure* arrayStructure = globalObject-&gt;originalArrayStructureForIndexingType(immutableButterfly-&gt;indexingMode());
 915                 return JSArray::createWithButterfly(vm, nullptr, arrayStructure, immutableButterfly-&gt;toButterfly());
 916             }
 917         }
 918     }
 919 
 920     PropertyNameArray properties(vm, propertyNameMode, PrivateSymbolMode::Exclude);
<span class="line-modified"> 921     object-&gt;methodTable(vm)-&gt;getOwnPropertyNames(object, exec, properties, EnumerationMode(dontEnumPropertiesMode));</span>
 922     RETURN_IF_EXCEPTION(scope, nullptr);
 923 
 924     if (propertyNameMode != PropertyNameMode::StringsAndSymbols) {
 925         ASSERT(propertyNameMode == PropertyNameMode::Strings || propertyNameMode == PropertyNameMode::Symbols);
 926         if (properties.size() &lt; MIN_SPARSE_ARRAY_INDEX) {
 927             if (LIKELY(!globalObject-&gt;isHavingABadTime())) {
 928                 if (isObjectKeys) {
 929                     Structure* structure = object-&gt;structure(vm);
 930                     if (structure-&gt;canCacheOwnKeys()) {
 931                         auto* cachedButterfly = structure-&gt;cachedOwnKeysIgnoringSentinel();
 932                         if (cachedButterfly == StructureRareData::cachedOwnKeysSentinel()) {
 933                             size_t numProperties = properties.size();
 934                             auto* newButterfly = JSImmutableButterfly::create(vm, CopyOnWriteArrayWithContiguous, numProperties);
 935                             for (size_t i = 0; i &lt; numProperties; i++) {
 936                                 const auto&amp; identifier = properties[i];
 937                                 ASSERT(!identifier.isSymbol());
 938                                 newButterfly-&gt;setIndex(vm, i, jsOwnedString(vm, identifier.string()));
 939                             }
 940 
 941                             structure-&gt;setCachedOwnKeys(vm, newButterfly);
</pre>
<hr />
<pre>
 949                 }
 950 
 951                 size_t numProperties = properties.size();
 952                 JSArray* keys = JSArray::create(vm, globalObject-&gt;originalArrayStructureForIndexingType(ArrayWithContiguous), numProperties);
 953                 WriteBarrier&lt;Unknown&gt;* buffer = keys-&gt;butterfly()-&gt;contiguous().data();
 954                 for (size_t i = 0; i &lt; numProperties; i++) {
 955                     const auto&amp; identifier = properties[i];
 956                     if (propertyNameMode == PropertyNameMode::Strings) {
 957                         ASSERT(!identifier.isSymbol());
 958                         buffer[i].set(vm, keys, jsOwnedString(vm, identifier.string()));
 959                     } else {
 960                         ASSERT(identifier.isSymbol());
 961                         buffer[i].set(vm, keys, Symbol::create(vm, static_cast&lt;SymbolImpl&amp;&gt;(*identifier.impl())));
 962                     }
 963                 }
 964                 return keys;
 965             }
 966         }
 967     }
 968 
<span class="line-modified"> 969     JSArray* keys = constructEmptyArray(exec, nullptr);</span>
 970     RETURN_IF_EXCEPTION(scope, nullptr);
 971 
 972     unsigned index = 0;
<span class="line-modified"> 973     auto pushDirect = [&amp;] (ExecState* exec, JSArray* array, JSValue value) {</span>
<span class="line-modified"> 974         array-&gt;putDirectIndex(exec, index++, value);</span>
 975     };
 976 
 977     switch (propertyNameMode) {
 978     case PropertyNameMode::Strings: {
 979         size_t numProperties = properties.size();
 980         for (size_t i = 0; i &lt; numProperties; i++) {
 981             const auto&amp; identifier = properties[i];
 982             ASSERT(!identifier.isSymbol());
<span class="line-modified"> 983             pushDirect(exec, keys, jsOwnedString(vm, identifier.string()));</span>
 984             RETURN_IF_EXCEPTION(scope, nullptr);
 985         }
 986         break;
 987     }
 988 
 989     case PropertyNameMode::Symbols: {
 990         size_t numProperties = properties.size();
 991         for (size_t i = 0; i &lt; numProperties; i++) {
 992             const auto&amp; identifier = properties[i];
 993             ASSERT(identifier.isSymbol());
 994             ASSERT(!identifier.isPrivateName());
<span class="line-modified"> 995             pushDirect(exec, keys, Symbol::create(vm, static_cast&lt;SymbolImpl&amp;&gt;(*identifier.impl())));</span>
 996             RETURN_IF_EXCEPTION(scope, nullptr);
 997         }
 998         break;
 999     }
1000 
1001     case PropertyNameMode::StringsAndSymbols: {
1002         Vector&lt;Identifier, 16&gt; propertySymbols;
1003         size_t numProperties = properties.size();
1004         for (size_t i = 0; i &lt; numProperties; i++) {
1005             const auto&amp; identifier = properties[i];
1006             if (identifier.isSymbol()) {
1007                 ASSERT(!identifier.isPrivateName());
1008                 propertySymbols.append(identifier);
1009                 continue;
1010             }
1011 
<span class="line-modified">1012             pushDirect(exec, keys, jsOwnedString(vm, identifier.string()));</span>
1013             RETURN_IF_EXCEPTION(scope, nullptr);
1014         }
1015 
1016         // To ensure the order defined in the spec (9.1.12), we append symbols at the last elements of keys.
1017         for (const auto&amp; identifier : propertySymbols) {
<span class="line-modified">1018             pushDirect(exec, keys, Symbol::create(vm, static_cast&lt;SymbolImpl&amp;&gt;(*identifier.impl())));</span>
1019             RETURN_IF_EXCEPTION(scope, nullptr);
1020         }
1021 
1022         break;
1023     }
1024     }
1025 
1026     return keys;
1027 }
1028 
1029 } // namespace JSC
</pre>
</td>
<td>
<hr />
<pre>
  23 
  24 #include &quot;BuiltinNames.h&quot;
  25 #include &quot;ButterflyInlines.h&quot;
  26 #include &quot;Error.h&quot;
  27 #include &quot;ExceptionHelpers.h&quot;
  28 #include &quot;JSArray.h&quot;
  29 #include &quot;JSCInlines.h&quot;
  30 #include &quot;JSFunction.h&quot;
  31 #include &quot;JSGlobalObject.h&quot;
  32 #include &quot;JSGlobalObjectFunctions.h&quot;
  33 #include &quot;JSImmutableButterfly.h&quot;
  34 #include &quot;Lookup.h&quot;
  35 #include &quot;ObjectPrototype.h&quot;
  36 #include &quot;PropertyDescriptor.h&quot;
  37 #include &quot;PropertyNameArray.h&quot;
  38 #include &quot;StackVisitor.h&quot;
  39 #include &quot;Symbol.h&quot;
  40 
  41 namespace JSC {
  42 
<span class="line-modified">  43 EncodedJSValue JSC_HOST_CALL objectConstructorAssign(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">  44 EncodedJSValue JSC_HOST_CALL objectConstructorValues(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">  45 EncodedJSValue JSC_HOST_CALL objectConstructorGetPrototypeOf(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">  46 EncodedJSValue JSC_HOST_CALL objectConstructorSetPrototypeOf(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">  47 EncodedJSValue JSC_HOST_CALL objectConstructorGetOwnPropertyNames(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">  48 EncodedJSValue JSC_HOST_CALL objectConstructorDefineProperty(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">  49 EncodedJSValue JSC_HOST_CALL objectConstructorDefineProperties(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">  50 EncodedJSValue JSC_HOST_CALL objectConstructorCreate(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">  51 EncodedJSValue JSC_HOST_CALL objectConstructorSeal(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">  52 EncodedJSValue JSC_HOST_CALL objectConstructorFreeze(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">  53 EncodedJSValue JSC_HOST_CALL objectConstructorPreventExtensions(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">  54 EncodedJSValue JSC_HOST_CALL objectConstructorIsSealed(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">  55 EncodedJSValue JSC_HOST_CALL objectConstructorIsFrozen(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">  56 EncodedJSValue JSC_HOST_CALL objectConstructorIsExtensible(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">  57 EncodedJSValue JSC_HOST_CALL objectConstructorIs(JSGlobalObject*, CallFrame*);</span>
  58 
  59 }
  60 
  61 #include &quot;ObjectConstructor.lut.h&quot;
  62 
  63 namespace JSC {
  64 
  65 STATIC_ASSERT_IS_TRIVIALLY_DESTRUCTIBLE(ObjectConstructor);
  66 
  67 const ClassInfo ObjectConstructor::s_info = { &quot;Function&quot;, &amp;InternalFunction::s_info, &amp;objectConstructorTable, nullptr, CREATE_METHOD_TABLE(ObjectConstructor) };
  68 
  69 /* Source for ObjectConstructor.lut.h
  70 @begin objectConstructorTable
  71   getPrototypeOf            objectConstructorGetPrototypeOf             DontEnum|Function 1 ObjectGetPrototypeOfIntrinsic
  72   setPrototypeOf            objectConstructorSetPrototypeOf             DontEnum|Function 2
  73   getOwnPropertyDescriptor  objectConstructorGetOwnPropertyDescriptor   DontEnum|Function 2
  74   getOwnPropertyDescriptors objectConstructorGetOwnPropertyDescriptors  DontEnum|Function 1
  75   getOwnPropertyNames       objectConstructorGetOwnPropertyNames        DontEnum|Function 1
  76   getOwnPropertySymbols     objectConstructorGetOwnPropertySymbols      DontEnum|Function 1
  77   keys                      objectConstructorKeys                       DontEnum|Function 1 ObjectKeysIntrinsic
  78   defineProperty            objectConstructorDefineProperty             DontEnum|Function 3
  79   defineProperties          objectConstructorDefineProperties           DontEnum|Function 2
  80   create                    objectConstructorCreate                     DontEnum|Function 2 ObjectCreateIntrinsic
  81   seal                      objectConstructorSeal                       DontEnum|Function 1
  82   freeze                    objectConstructorFreeze                     DontEnum|Function 1
  83   preventExtensions         objectConstructorPreventExtensions          DontEnum|Function 1
  84   isSealed                  objectConstructorIsSealed                   DontEnum|Function 1
  85   isFrozen                  objectConstructorIsFrozen                   DontEnum|Function 1
  86   isExtensible              objectConstructorIsExtensible               DontEnum|Function 1
  87   is                        objectConstructorIs                         DontEnum|Function 2 ObjectIsIntrinsic
  88   assign                    objectConstructorAssign                     DontEnum|Function 2
  89   values                    objectConstructorValues                     DontEnum|Function 1
  90   entries                   JSBuiltin                                   DontEnum|Function 1
  91   fromEntries               JSBuiltin                                   DontEnum|Function 1
  92 @end
  93 */
  94 
  95 
<span class="line-modified">  96 static EncodedJSValue JSC_HOST_CALL callObjectConstructor(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">  97 static EncodedJSValue JSC_HOST_CALL constructWithObjectConstructor(JSGlobalObject*, CallFrame*);</span>
  98 
  99 ObjectConstructor::ObjectConstructor(VM&amp; vm, Structure* structure)
 100     : InternalFunction(vm, structure, callObjectConstructor, constructWithObjectConstructor)
 101 {
 102 }
 103 
 104 void ObjectConstructor::finishCreation(VM&amp; vm, JSGlobalObject* globalObject, ObjectPrototype* objectPrototype)
 105 {
<span class="line-modified"> 106     Base::finishCreation(vm, vm.propertyNames-&gt;Object.string(), NameAdditionMode::WithoutStructureTransition);</span>
 107 
 108     putDirectWithoutTransition(vm, vm.propertyNames-&gt;prototype, objectPrototype, PropertyAttribute::DontEnum | PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly);
 109     putDirectWithoutTransition(vm, vm.propertyNames-&gt;length, jsNumber(1), PropertyAttribute::ReadOnly | PropertyAttribute::DontEnum);
 110 
 111     JSC_NATIVE_FUNCTION_WITHOUT_TRANSITION(vm.propertyNames-&gt;builtinNames().createPrivateName(), objectConstructorCreate, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum), 2);
 112     JSC_NATIVE_FUNCTION_WITHOUT_TRANSITION(vm.propertyNames-&gt;builtinNames().definePropertyPrivateName(), objectConstructorDefineProperty, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum), 3);
 113     JSC_NATIVE_FUNCTION_WITHOUT_TRANSITION(vm.propertyNames-&gt;builtinNames().getPrototypeOfPrivateName(), objectConstructorGetPrototypeOf, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum), 1);
 114     JSC_NATIVE_FUNCTION_WITHOUT_TRANSITION(vm.propertyNames-&gt;builtinNames().getOwnPropertyNamesPrivateName(), objectConstructorGetOwnPropertyNames, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum), 1);
 115 }
 116 
 117 // ES 19.1.1.1 Object([value])
<span class="line-modified"> 118 static ALWAYS_INLINE JSObject* constructObjectWithNewTarget(JSGlobalObject* globalObject, CallFrame* callFrame, JSValue newTarget)</span>
 119 {
<span class="line-modified"> 120     VM&amp; vm = globalObject-&gt;vm();</span>
<span class="line-modified"> 121     ObjectConstructor* objectConstructor = jsCast&lt;ObjectConstructor*&gt;(callFrame-&gt;jsCallee());</span>

 122     auto scope = DECLARE_THROW_SCOPE(vm);
 123 
 124     // We need to check newTarget condition in this caller side instead of InternalFunction::createSubclassStructure side.
 125     // Since if we found this condition is met, we should not fall into the type conversion in the step 3.
 126 
 127     // 1. If NewTarget is neither undefined nor the active function, then
 128     if (newTarget &amp;&amp; newTarget != objectConstructor) {
 129         // a. Return ? OrdinaryCreateFromConstructor(NewTarget, &quot;%ObjectPrototype%&quot;).
<span class="line-modified"> 130         Structure* objectStructure = InternalFunction::createSubclassStructure(globalObject, objectConstructor, newTarget, globalObject-&gt;objectStructureForObjectConstructor());</span>
 131         RETURN_IF_EXCEPTION(scope, nullptr);
<span class="line-modified"> 132         return constructEmptyObject(vm, objectStructure);</span>
 133     }
 134 
 135     // 2. If value is null, undefined or not supplied, return ObjectCreate(%ObjectPrototype%).
<span class="line-modified"> 136     JSValue argument = callFrame-&gt;argument(0);</span>
<span class="line-modified"> 137     if (argument.isUndefinedOrNull())</span>
<span class="line-modified"> 138         return constructEmptyObject(vm, globalObject-&gt;objectStructureForObjectConstructor());</span>

 139 
 140     // 3. Return ToObject(value).
<span class="line-modified"> 141     RELEASE_AND_RETURN(scope, argument.toObject(globalObject));</span>
 142 }
 143 
<span class="line-modified"> 144 static EncodedJSValue JSC_HOST_CALL constructWithObjectConstructor(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 145 {
<span class="line-modified"> 146     return JSValue::encode(constructObjectWithNewTarget(globalObject, callFrame, callFrame-&gt;newTarget()));</span>
 147 }
 148 
<span class="line-modified"> 149 static EncodedJSValue JSC_HOST_CALL callObjectConstructor(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 150 {
<span class="line-modified"> 151     return JSValue::encode(constructObjectWithNewTarget(globalObject, callFrame, JSValue()));</span>
 152 }
 153 
<span class="line-modified"> 154 EncodedJSValue JSC_HOST_CALL objectConstructorGetPrototypeOf(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 155 {
<span class="line-modified"> 156     VM&amp; vm = globalObject-&gt;vm();</span>
 157     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified"> 158     JSObject* object = callFrame-&gt;argument(0).toObject(globalObject);</span>
 159     RETURN_IF_EXCEPTION(scope, encodedJSValue());
<span class="line-modified"> 160     RELEASE_AND_RETURN(scope, JSValue::encode(object-&gt;getPrototype(vm, globalObject)));</span>
 161 }
 162 
<span class="line-modified"> 163 EncodedJSValue JSC_HOST_CALL objectConstructorSetPrototypeOf(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 164 {
<span class="line-modified"> 165     VM&amp; vm = globalObject-&gt;vm();</span>
 166     auto scope = DECLARE_THROW_SCOPE(vm);
 167 
<span class="line-modified"> 168     JSValue objectValue = callFrame-&gt;argument(0);</span>
 169     if (objectValue.isUndefinedOrNull())
<span class="line-modified"> 170         return throwVMTypeError(globalObject, scope, &quot;Cannot set prototype of undefined or null&quot;_s);</span>
 171 
<span class="line-modified"> 172     JSValue protoValue = callFrame-&gt;argument(1);</span>
 173     if (!protoValue.isObject() &amp;&amp; !protoValue.isNull())
<span class="line-modified"> 174         return throwVMTypeError(globalObject, scope, &quot;Prototype value can only be an object or null&quot;_s);</span>
 175 
<span class="line-modified"> 176     JSObject* object = objectValue.toObject(globalObject);</span>
 177     RETURN_IF_EXCEPTION(scope, encodedJSValue());
 178 
 179     bool shouldThrowIfCantSet = true;
<span class="line-modified"> 180     bool didSetPrototype = object-&gt;setPrototype(vm, globalObject, protoValue, shouldThrowIfCantSet);</span>
 181     EXCEPTION_ASSERT_UNUSED(didSetPrototype, scope.exception() || didSetPrototype);
 182     return JSValue::encode(objectValue);
 183 }
 184 
<span class="line-modified"> 185 JSValue objectConstructorGetOwnPropertyDescriptor(JSGlobalObject* globalObject, JSObject* object, const Identifier&amp; propertyName)</span>
 186 {
<span class="line-modified"> 187     VM&amp; vm = globalObject-&gt;vm();</span>
 188     auto scope = DECLARE_THROW_SCOPE(vm);
 189     PropertyDescriptor descriptor;
<span class="line-modified"> 190     if (!object-&gt;getOwnPropertyDescriptor(globalObject, propertyName, descriptor))</span>
 191         RELEASE_AND_RETURN(scope, jsUndefined());
 192     RETURN_IF_EXCEPTION(scope, { });
 193 
<span class="line-modified"> 194     JSObject* result = constructObjectFromPropertyDescriptor(globalObject, descriptor);</span>
 195     EXCEPTION_ASSERT(!!scope.exception() == !result);
 196     if (!result)
 197         return jsUndefined();
 198     return result;
 199 }
 200 
<span class="line-modified"> 201 JSValue objectConstructorGetOwnPropertyDescriptors(JSGlobalObject* globalObject, JSObject* object)</span>
 202 {
<span class="line-modified"> 203     VM&amp; vm = globalObject-&gt;vm();</span>
 204     auto scope = DECLARE_THROW_SCOPE(vm);
 205     PropertyNameArray properties(vm, PropertyNameMode::StringsAndSymbols, PrivateSymbolMode::Exclude);
<span class="line-modified"> 206     object-&gt;methodTable(vm)-&gt;getOwnPropertyNames(object, globalObject, properties, EnumerationMode(DontEnumPropertiesMode::Include));</span>
 207     RETURN_IF_EXCEPTION(scope, { });
 208 
<span class="line-modified"> 209     JSObject* descriptors = constructEmptyObject(globalObject);</span>
 210     RETURN_IF_EXCEPTION(scope, { });
 211 
 212     for (auto&amp; propertyName : properties) {
 213         PropertyDescriptor descriptor;
<span class="line-modified"> 214         bool didGetDescriptor = object-&gt;getOwnPropertyDescriptor(globalObject, propertyName, descriptor);</span>
 215         RETURN_IF_EXCEPTION(scope, { });
 216 
 217         if (!didGetDescriptor)
 218             continue;
 219 
<span class="line-modified"> 220         JSObject* fromDescriptor = constructObjectFromPropertyDescriptor(globalObject, descriptor);</span>
 221         EXCEPTION_ASSERT(!!scope.exception() == !fromDescriptor);
 222         if (!fromDescriptor)
 223             return jsUndefined();
 224 
 225         PutPropertySlot slot(descriptors);
<span class="line-modified"> 226         descriptors-&gt;putOwnDataPropertyMayBeIndex(globalObject, propertyName, fromDescriptor, slot);</span>
 227         scope.assertNoException();
 228     }
 229 
 230     return descriptors;
 231 }
 232 
<span class="line-modified"> 233 EncodedJSValue JSC_HOST_CALL objectConstructorGetOwnPropertyDescriptor(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 234 {
<span class="line-modified"> 235     VM&amp; vm = globalObject-&gt;vm();</span>
 236     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified"> 237     JSObject* object = callFrame-&gt;argument(0).toObject(globalObject);</span>
 238     RETURN_IF_EXCEPTION(scope, encodedJSValue());
<span class="line-modified"> 239     auto propertyName = callFrame-&gt;argument(1).toPropertyKey(globalObject);</span>
 240     RETURN_IF_EXCEPTION(scope, encodedJSValue());
<span class="line-modified"> 241     RELEASE_AND_RETURN(scope, JSValue::encode(objectConstructorGetOwnPropertyDescriptor(globalObject, object, propertyName)));</span>
 242 }
 243 
<span class="line-modified"> 244 EncodedJSValue JSC_HOST_CALL objectConstructorGetOwnPropertyDescriptors(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 245 {
<span class="line-modified"> 246     VM&amp; vm = globalObject-&gt;vm();</span>
 247     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified"> 248     JSObject* object = callFrame-&gt;argument(0).toObject(globalObject);</span>
 249     RETURN_IF_EXCEPTION(scope, encodedJSValue());
<span class="line-modified"> 250     RELEASE_AND_RETURN(scope, JSValue::encode(objectConstructorGetOwnPropertyDescriptors(globalObject, object)));</span>
 251 }
 252 
 253 // FIXME: Use the enumeration cache.
<span class="line-modified"> 254 EncodedJSValue JSC_HOST_CALL objectConstructorGetOwnPropertyNames(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 255 {
<span class="line-modified"> 256     VM&amp; vm = globalObject-&gt;vm();</span>
 257     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified"> 258     JSObject* object = callFrame-&gt;argument(0).toObject(globalObject);</span>
 259     RETURN_IF_EXCEPTION(scope, encodedJSValue());
<span class="line-modified"> 260     RELEASE_AND_RETURN(scope, JSValue::encode(ownPropertyKeys(globalObject, object, PropertyNameMode::Strings, DontEnumPropertiesMode::Include)));</span>
 261 }
 262 
 263 // FIXME: Use the enumeration cache.
<span class="line-modified"> 264 EncodedJSValue JSC_HOST_CALL objectConstructorGetOwnPropertySymbols(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 265 {
<span class="line-modified"> 266     VM&amp; vm = globalObject-&gt;vm();</span>
 267     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified"> 268     JSObject* object = callFrame-&gt;argument(0).toObject(globalObject);</span>
 269     RETURN_IF_EXCEPTION(scope, encodedJSValue());
<span class="line-modified"> 270     RELEASE_AND_RETURN(scope, JSValue::encode(ownPropertyKeys(globalObject, object, PropertyNameMode::Symbols, DontEnumPropertiesMode::Include)));</span>
 271 }
 272 
<span class="line-modified"> 273 EncodedJSValue JSC_HOST_CALL objectConstructorKeys(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 274 {
<span class="line-modified"> 275     VM&amp; vm = globalObject-&gt;vm();</span>
 276     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified"> 277     JSObject* object = callFrame-&gt;argument(0).toObject(globalObject);</span>
 278     RETURN_IF_EXCEPTION(scope, encodedJSValue());
<span class="line-modified"> 279     RELEASE_AND_RETURN(scope, JSValue::encode(ownPropertyKeys(globalObject, object, PropertyNameMode::Strings, DontEnumPropertiesMode::Exclude)));</span>
 280 }
 281 
<span class="line-modified"> 282 EncodedJSValue JSC_HOST_CALL objectConstructorAssign(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 283 {
<span class="line-modified"> 284     VM&amp; vm = globalObject-&gt;vm();</span>
 285     auto scope = DECLARE_THROW_SCOPE(vm);
 286 
<span class="line-modified"> 287     JSValue targetValue = callFrame-&gt;argument(0);</span>
 288     if (targetValue.isUndefinedOrNull())
<span class="line-modified"> 289         return throwVMTypeError(globalObject, scope, &quot;Object.assign requires that input parameter not be null or undefined&quot;_s);</span>
<span class="line-modified"> 290     JSObject* target = targetValue.toObject(globalObject);</span>
 291     RETURN_IF_EXCEPTION(scope, { });
 292 
 293     // FIXME: Extend this for non JSFinalObject. For example, we would like to use this fast path for function objects too.
 294     // https://bugs.webkit.org/show_bug.cgi?id=185358
 295     bool targetCanPerformFastPut = jsDynamicCast&lt;JSFinalObject*&gt;(vm, target) &amp;&amp; target-&gt;canPerformFastPutInlineExcludingProto(vm);
 296 
 297     Vector&lt;RefPtr&lt;UniquedStringImpl&gt;, 8&gt; properties;
 298     MarkedArgumentBuffer values;
<span class="line-modified"> 299     unsigned argsCount = callFrame-&gt;argumentCount();</span>
 300     for (unsigned i = 1; i &lt; argsCount; ++i) {
<span class="line-modified"> 301         JSValue sourceValue = callFrame-&gt;uncheckedArgument(i);</span>
 302         if (sourceValue.isUndefinedOrNull())
 303             continue;
<span class="line-modified"> 304         JSObject* source = sourceValue.toObject(globalObject);</span>
 305         RETURN_IF_EXCEPTION(scope, { });
 306 
 307         if (targetCanPerformFastPut) {
 308             if (!source-&gt;staticPropertiesReified(vm)) {
<span class="line-modified"> 309                 source-&gt;reifyAllStaticProperties(globalObject);</span>
 310                 RETURN_IF_EXCEPTION(scope, { });
 311             }
 312 
 313             auto canPerformFastPropertyEnumerationForObjectAssign = [] (Structure* structure) {
 314                 if (structure-&gt;typeInfo().overridesGetOwnPropertySlot())
 315                     return false;
 316                 if (structure-&gt;typeInfo().overridesGetPropertyNames())
 317                     return false;
 318                 // FIXME: Indexed properties can be handled.
 319                 // https://bugs.webkit.org/show_bug.cgi?id=185358
 320                 if (hasIndexedProperties(structure-&gt;indexingType()))
 321                     return false;
 322                 if (structure-&gt;hasGetterSetterProperties())
 323                     return false;
 324                 if (structure-&gt;isUncacheableDictionary())
 325                     return false;
 326                 // Cannot perform fast [[Put]] to |target| if the property names of the |source| contain &quot;__proto__&quot;.
 327                 if (structure-&gt;hasUnderscoreProtoPropertyExcludingOriginalProto())
 328                     return false;
 329                 return true;
</pre>
<hr />
<pre>
 355                     values.appendWithCrashOnOverflow(source-&gt;getDirect(entry.offset));
 356 
 357                     return true;
 358                 });
 359 
 360                 for (size_t i = 0; i &lt; properties.size(); ++i) {
 361                     // FIXME: We could put properties in a batching manner to accelerate Object.assign more.
 362                     // https://bugs.webkit.org/show_bug.cgi?id=185358
 363                     PutPropertySlot putPropertySlot(target, true);
 364                     target-&gt;putOwnDataProperty(vm, properties[i].get(), values.at(i), putPropertySlot);
 365                 }
 366                 continue;
 367             }
 368         }
 369 
 370         // [[GetOwnPropertyNames]], [[Get]] etc. could modify target object and invalidate this assumption.
 371         // For example, [[Get]] of source object could configure setter to target object. So disable the fast path.
 372         targetCanPerformFastPut = false;
 373 
 374         PropertyNameArray properties(vm, PropertyNameMode::StringsAndSymbols, PrivateSymbolMode::Exclude);
<span class="line-modified"> 375         source-&gt;methodTable(vm)-&gt;getOwnPropertyNames(source, globalObject, properties, EnumerationMode(DontEnumPropertiesMode::Include));</span>
 376         RETURN_IF_EXCEPTION(scope, { });
 377 
 378         auto assign = [&amp;] (PropertyName propertyName) {
 379             PropertySlot slot(source, PropertySlot::InternalMethodType::GetOwnProperty);
<span class="line-modified"> 380             bool hasProperty = source-&gt;methodTable(vm)-&gt;getOwnPropertySlot(source, globalObject, propertyName, slot);</span>
 381             RETURN_IF_EXCEPTION(scope, void());
 382             if (!hasProperty)
 383                 return;
 384             if (slot.attributes() &amp; PropertyAttribute::DontEnum)
 385                 return;
 386 
 387             JSValue value;
 388             if (LIKELY(!slot.isTaintedByOpaqueObject()))
<span class="line-modified"> 389                 value = slot.getValue(globalObject, propertyName);</span>
 390             else
<span class="line-modified"> 391                 value = source-&gt;get(globalObject, propertyName);</span>
 392             RETURN_IF_EXCEPTION(scope, void());
 393 
 394             PutPropertySlot putPropertySlot(target, true);
<span class="line-modified"> 395             target-&gt;putInline(globalObject, propertyName, value, putPropertySlot);</span>
 396         };
 397 
 398         // First loop is for strings. Second loop is for symbols to keep standardized order requirement in the spec.
 399         // https://tc39.github.io/ecma262/#sec-ordinaryownpropertykeys
 400         bool foundSymbol = false;
 401         unsigned numProperties = properties.size();
 402         for (unsigned j = 0; j &lt; numProperties; j++) {
 403             const auto&amp; propertyName = properties[j];
 404             if (propertyName.isSymbol()) {
 405                 foundSymbol = true;
 406                 continue;
 407             }
 408 
 409             assign(propertyName);
 410             RETURN_IF_EXCEPTION(scope, { });
 411         }
 412 
 413         if (foundSymbol) {
 414             for (unsigned j = 0; j &lt; numProperties; j++) {
 415                 const auto&amp; propertyName = properties[j];
 416                 if (propertyName.isSymbol()) {
 417                     ASSERT(!propertyName.isPrivateName());
 418                     assign(propertyName);
 419                     RETURN_IF_EXCEPTION(scope, { });
 420                 }
 421             }
 422         }
 423     }
 424     return JSValue::encode(target);
 425 }
 426 
<span class="line-modified"> 427 EncodedJSValue JSC_HOST_CALL objectConstructorValues(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 428 {
<span class="line-modified"> 429     VM&amp; vm = globalObject-&gt;vm();</span>
 430     auto scope = DECLARE_THROW_SCOPE(vm);
 431 
<span class="line-modified"> 432     JSValue targetValue = callFrame-&gt;argument(0);</span>
 433     if (targetValue.isUndefinedOrNull())
<span class="line-modified"> 434         return throwVMTypeError(globalObject, scope, &quot;Object.values requires that input parameter not be null or undefined&quot;_s);</span>
<span class="line-modified"> 435     JSObject* target = targetValue.toObject(globalObject);</span>
 436     RETURN_IF_EXCEPTION(scope, { });
 437 
<span class="line-modified"> 438     JSArray* values = constructEmptyArray(globalObject, nullptr);</span>
 439     RETURN_IF_EXCEPTION(scope, { });
 440 
 441     PropertyNameArray properties(vm, PropertyNameMode::Strings, PrivateSymbolMode::Exclude);
<span class="line-modified"> 442     target-&gt;methodTable(vm)-&gt;getOwnPropertyNames(target, globalObject, properties, EnumerationMode(DontEnumPropertiesMode::Include));</span>
 443     RETURN_IF_EXCEPTION(scope, { });
 444 
 445     unsigned index = 0;
 446     auto addValue = [&amp;] (PropertyName propertyName) {
 447         PropertySlot slot(target, PropertySlot::InternalMethodType::GetOwnProperty);
<span class="line-modified"> 448         bool hasProperty = target-&gt;methodTable(vm)-&gt;getOwnPropertySlot(target, globalObject, propertyName, slot);</span>
 449         RETURN_IF_EXCEPTION(scope, void());
 450         if (!hasProperty)
 451             return;
 452         if (slot.attributes() &amp; PropertyAttribute::DontEnum)
 453             return;
 454 
 455         JSValue value;
 456         if (LIKELY(!slot.isTaintedByOpaqueObject()))
<span class="line-modified"> 457             value = slot.getValue(globalObject, propertyName);</span>
 458         else
<span class="line-modified"> 459             value = target-&gt;get(globalObject, propertyName);</span>
 460         RETURN_IF_EXCEPTION(scope, void());
 461 
<span class="line-modified"> 462         values-&gt;putDirectIndex(globalObject, index++, value);</span>
 463     };
 464 
 465     for (unsigned i = 0, numProperties = properties.size(); i &lt; numProperties; i++) {
 466         const auto&amp; propertyName = properties[i];
 467         if (propertyName.isSymbol())
 468             continue;
 469 
 470         addValue(propertyName);
 471         RETURN_IF_EXCEPTION(scope, { });
 472     }
 473 
 474     return JSValue::encode(values);
 475 }
 476 
 477 
 478 // ES6 6.2.4.5 ToPropertyDescriptor
 479 // https://tc39.github.io/ecma262/#sec-topropertydescriptor
<span class="line-modified"> 480 bool toPropertyDescriptor(JSGlobalObject* globalObject, JSValue in, PropertyDescriptor&amp; desc)</span>
 481 {
<span class="line-modified"> 482     VM&amp; vm = globalObject-&gt;vm();</span>
 483     auto scope = DECLARE_THROW_SCOPE(vm);
 484 
 485     if (!in.isObject()) {
<span class="line-modified"> 486         throwTypeError(globalObject, scope, &quot;Property description must be an object.&quot;_s);</span>
 487         return false;
 488     }
 489     JSObject* description = asObject(in);
 490 
<span class="line-modified"> 491     bool hasProperty = description-&gt;hasProperty(globalObject, vm.propertyNames-&gt;enumerable);</span>
 492     EXCEPTION_ASSERT(!scope.exception() || !hasProperty);
 493     if (hasProperty) {
<span class="line-modified"> 494         JSValue value = description-&gt;get(globalObject, vm.propertyNames-&gt;enumerable);</span>
 495         RETURN_IF_EXCEPTION(scope, false);
<span class="line-modified"> 496         desc.setEnumerable(value.toBoolean(globalObject));</span>
 497     } else
 498         RETURN_IF_EXCEPTION(scope, false);
 499 
<span class="line-modified"> 500     hasProperty = description-&gt;hasProperty(globalObject, vm.propertyNames-&gt;configurable);</span>
 501     EXCEPTION_ASSERT(!scope.exception() || !hasProperty);
 502     if (hasProperty) {
<span class="line-modified"> 503         JSValue value = description-&gt;get(globalObject, vm.propertyNames-&gt;configurable);</span>
 504         RETURN_IF_EXCEPTION(scope, false);
<span class="line-modified"> 505         desc.setConfigurable(value.toBoolean(globalObject));</span>
 506     } else
 507         RETURN_IF_EXCEPTION(scope, false);
 508 
 509     JSValue value;
<span class="line-modified"> 510     hasProperty = description-&gt;hasProperty(globalObject, vm.propertyNames-&gt;value);</span>
 511     EXCEPTION_ASSERT(!scope.exception() || !hasProperty);
 512     if (hasProperty) {
<span class="line-modified"> 513         JSValue value = description-&gt;get(globalObject, vm.propertyNames-&gt;value);</span>
 514         RETURN_IF_EXCEPTION(scope, false);
 515         desc.setValue(value);
 516     } else
 517         RETURN_IF_EXCEPTION(scope, false);
 518 
<span class="line-modified"> 519     hasProperty = description-&gt;hasProperty(globalObject, vm.propertyNames-&gt;writable);</span>
 520     EXCEPTION_ASSERT(!scope.exception() || !hasProperty);
 521     if (hasProperty) {
<span class="line-modified"> 522         JSValue value = description-&gt;get(globalObject, vm.propertyNames-&gt;writable);</span>
 523         RETURN_IF_EXCEPTION(scope, false);
<span class="line-modified"> 524         desc.setWritable(value.toBoolean(globalObject));</span>
 525     } else
 526         RETURN_IF_EXCEPTION(scope, false);
 527 
<span class="line-modified"> 528     hasProperty = description-&gt;hasProperty(globalObject, vm.propertyNames-&gt;get);</span>
 529     EXCEPTION_ASSERT(!scope.exception() || !hasProperty);
 530     if (hasProperty) {
<span class="line-modified"> 531         JSValue get = description-&gt;get(globalObject, vm.propertyNames-&gt;get);</span>
 532         RETURN_IF_EXCEPTION(scope, false);
 533         if (!get.isUndefined()) {
 534             CallData callData;
 535             if (getCallData(vm, get, callData) == CallType::None) {
<span class="line-modified"> 536                 throwTypeError(globalObject, scope, &quot;Getter must be a function.&quot;_s);</span>
 537                 return false;
 538             }
 539         }
 540         desc.setGetter(get);
 541     } else
 542         RETURN_IF_EXCEPTION(scope, false);
 543 
<span class="line-modified"> 544     hasProperty = description-&gt;hasProperty(globalObject, vm.propertyNames-&gt;set);</span>
 545     EXCEPTION_ASSERT(!scope.exception() || !hasProperty);
 546     if (hasProperty) {
<span class="line-modified"> 547         JSValue set = description-&gt;get(globalObject, vm.propertyNames-&gt;set);</span>
 548         RETURN_IF_EXCEPTION(scope, false);
 549         if (!set.isUndefined()) {
 550             CallData callData;
 551             if (getCallData(vm, set, callData) == CallType::None) {
<span class="line-modified"> 552                 throwTypeError(globalObject, scope, &quot;Setter must be a function.&quot;_s);</span>
 553                 return false;
 554             }
 555         }
 556         desc.setSetter(set);
 557     } else
 558         RETURN_IF_EXCEPTION(scope, false);
 559 
 560     if (!desc.isAccessorDescriptor())
 561         return true;
 562 
 563     if (desc.value()) {
<span class="line-modified"> 564         throwTypeError(globalObject, scope, &quot;Invalid property.  &#39;value&#39; present on property with getter or setter.&quot;_s);</span>
 565         return false;
 566     }
 567 
 568     if (desc.writablePresent()) {
<span class="line-modified"> 569         throwTypeError(globalObject, scope, &quot;Invalid property.  &#39;writable&#39; present on property with getter or setter.&quot;_s);</span>
 570         return false;
 571     }
 572     return true;
 573 }
 574 
<span class="line-modified"> 575 EncodedJSValue JSC_HOST_CALL objectConstructorDefineProperty(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 576 {
<span class="line-modified"> 577     VM&amp; vm = globalObject-&gt;vm();</span>
 578     auto scope = DECLARE_THROW_SCOPE(vm);
 579 
<span class="line-modified"> 580     if (!callFrame-&gt;argument(0).isObject())</span>
<span class="line-modified"> 581         return throwVMTypeError(globalObject, scope, &quot;Properties can only be defined on Objects.&quot;_s);</span>
<span class="line-modified"> 582     JSObject* obj = asObject(callFrame-&gt;argument(0));</span>
<span class="line-modified"> 583     auto propertyName = callFrame-&gt;argument(1).toPropertyKey(globalObject);</span>
 584     RETURN_IF_EXCEPTION(scope, encodedJSValue());
 585     PropertyDescriptor descriptor;
<span class="line-modified"> 586     auto success = toPropertyDescriptor(globalObject, callFrame-&gt;argument(2), descriptor);</span>
 587     EXCEPTION_ASSERT(!scope.exception() == success);
 588     if (!success)
 589         return JSValue::encode(jsNull());
 590     ASSERT((descriptor.attributes() &amp; PropertyAttribute::Accessor) || (!descriptor.isAccessorDescriptor()));
 591     scope.assertNoException();
<span class="line-modified"> 592     obj-&gt;methodTable(vm)-&gt;defineOwnProperty(obj, globalObject, propertyName, descriptor, true);</span>
 593     RELEASE_AND_RETURN(scope, JSValue::encode(obj));
 594 }
 595 
<span class="line-modified"> 596 static JSValue defineProperties(JSGlobalObject* globalObject, JSObject* object, JSObject* properties)</span>
 597 {
<span class="line-modified"> 598     VM&amp; vm = globalObject-&gt;vm();</span>
 599     auto scope = DECLARE_THROW_SCOPE(vm);
 600 
 601     PropertyNameArray propertyNames(vm, PropertyNameMode::StringsAndSymbols, PrivateSymbolMode::Exclude);
<span class="line-modified"> 602     asObject(properties)-&gt;methodTable(vm)-&gt;getOwnPropertyNames(asObject(properties), globalObject, propertyNames, EnumerationMode(DontEnumPropertiesMode::Exclude));</span>
 603     RETURN_IF_EXCEPTION(scope, { });
 604     size_t numProperties = propertyNames.size();
 605     Vector&lt;PropertyDescriptor&gt; descriptors;
 606     MarkedArgumentBuffer markBuffer;
 607 #define RETURN_IF_EXCEPTION_CLEARING_OVERFLOW(value) do { \
 608     if (scope.exception()) { \
 609         markBuffer.overflowCheckNotNeeded(); \
 610         return value; \
 611     } \
 612 } while (false)
 613     for (size_t i = 0; i &lt; numProperties; i++) {
<span class="line-modified"> 614         JSValue prop = properties-&gt;get(globalObject, propertyNames[i]);</span>
 615         RETURN_IF_EXCEPTION_CLEARING_OVERFLOW({ });
 616         PropertyDescriptor descriptor;
<span class="line-modified"> 617         toPropertyDescriptor(globalObject, prop, descriptor);</span>
 618         RETURN_IF_EXCEPTION_CLEARING_OVERFLOW({ });
 619         descriptors.append(descriptor);
 620         // Ensure we mark all the values that we&#39;re accumulating
 621         if (descriptor.isDataDescriptor() &amp;&amp; descriptor.value())
 622             markBuffer.append(descriptor.value());
 623         if (descriptor.isAccessorDescriptor()) {
 624             if (descriptor.getter())
 625                 markBuffer.append(descriptor.getter());
 626             if (descriptor.setter())
 627                 markBuffer.append(descriptor.setter());
 628         }
 629     }
 630     RELEASE_ASSERT(!markBuffer.hasOverflowed());
 631 #undef RETURN_IF_EXCEPTION_CLEARING_OVERFLOW
 632     for (size_t i = 0; i &lt; numProperties; i++) {
 633         auto&amp; propertyName = propertyNames[i];
 634         ASSERT(!propertyName.isPrivateName());
 635 
<span class="line-modified"> 636         object-&gt;methodTable(vm)-&gt;defineOwnProperty(object, globalObject, propertyName, descriptors[i], true);</span>
 637         RETURN_IF_EXCEPTION(scope, { });
 638     }
 639     return object;
 640 }
 641 
<span class="line-modified"> 642 EncodedJSValue JSC_HOST_CALL objectConstructorDefineProperties(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 643 {
<span class="line-modified"> 644     VM&amp; vm = globalObject-&gt;vm();</span>
 645     auto scope = DECLARE_THROW_SCOPE(vm);
 646 
<span class="line-modified"> 647     if (!callFrame-&gt;argument(0).isObject())</span>
<span class="line-modified"> 648         return throwVMTypeError(globalObject, scope, &quot;Properties can only be defined on Objects.&quot;_s);</span>
<span class="line-modified"> 649     JSObject* targetObj = asObject(callFrame-&gt;argument(0));</span>
<span class="line-modified"> 650     JSObject* props = callFrame-&gt;argument(1).toObject(globalObject);</span>
 651     EXCEPTION_ASSERT(!!scope.exception() == !props);
 652     if (UNLIKELY(!props))
 653         return encodedJSValue();
<span class="line-modified"> 654     RELEASE_AND_RETURN(scope, JSValue::encode(defineProperties(globalObject, targetObj, props)));</span>
 655 }
 656 
<span class="line-modified"> 657 EncodedJSValue JSC_HOST_CALL objectConstructorCreate(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 658 {
<span class="line-modified"> 659     VM&amp; vm = globalObject-&gt;vm();</span>
 660     auto scope = DECLARE_THROW_SCOPE(vm);
 661 
<span class="line-modified"> 662     JSValue proto = callFrame-&gt;argument(0);</span>
 663     if (!proto.isObject() &amp;&amp; !proto.isNull())
<span class="line-modified"> 664         return throwVMTypeError(globalObject, scope, &quot;Object prototype may only be an Object or null.&quot;_s);</span>
 665     JSObject* newObject = proto.isObject()
<span class="line-modified"> 666         ? constructEmptyObject(globalObject, asObject(proto))</span>
<span class="line-modified"> 667         : constructEmptyObject(vm, globalObject-&gt;nullPrototypeObjectStructure());</span>
<span class="line-modified"> 668     if (callFrame-&gt;argument(1).isUndefined())</span>
 669         return JSValue::encode(newObject);
<span class="line-modified"> 670     JSObject* properties = callFrame-&gt;uncheckedArgument(1).toObject(globalObject);</span>
 671     RETURN_IF_EXCEPTION(scope, { });
 672 
<span class="line-modified"> 673     RELEASE_AND_RETURN(scope, JSValue::encode(defineProperties(globalObject, newObject, properties)));</span>
 674 }
 675 
 676 enum class IntegrityLevel {
 677     Sealed,
 678     Frozen
 679 };
 680 
 681 template&lt;IntegrityLevel level&gt;
<span class="line-modified"> 682 bool setIntegrityLevel(JSGlobalObject* globalObject, VM&amp; vm, JSObject* object)</span>
 683 {
 684     // See https://tc39.github.io/ecma262/#sec-setintegritylevel.
 685     auto scope = DECLARE_THROW_SCOPE(vm);
 686 
<span class="line-modified"> 687     bool success = object-&gt;methodTable(vm)-&gt;preventExtensions(object, globalObject);</span>
 688     RETURN_IF_EXCEPTION(scope, false);
 689     if (UNLIKELY(!success))
 690         return false;
 691 
 692     PropertyNameArray properties(vm, PropertyNameMode::StringsAndSymbols, PrivateSymbolMode::Exclude);
<span class="line-modified"> 693     object-&gt;methodTable(vm)-&gt;getOwnPropertyNames(object, globalObject, properties, EnumerationMode(DontEnumPropertiesMode::Include));</span>
 694     RETURN_IF_EXCEPTION(scope, false);
 695 
 696     PropertyNameArray::const_iterator end = properties.end();
 697     for (PropertyNameArray::const_iterator iter = properties.begin(); iter != end; ++iter) {
 698         auto&amp; propertyName = *iter;
 699         ASSERT(!propertyName.isPrivateName());
 700 
 701         PropertyDescriptor desc;
 702         if (level == IntegrityLevel::Sealed)
 703             desc.setConfigurable(false);
 704         else {
<span class="line-modified"> 705             bool hasPropertyDescriptor = object-&gt;getOwnPropertyDescriptor(globalObject, propertyName, desc);</span>
 706             RETURN_IF_EXCEPTION(scope, false);
 707             if (!hasPropertyDescriptor)
 708                 continue;
 709 
 710             if (desc.isDataDescriptor())
 711                 desc.setWritable(false);
 712 
 713             desc.setConfigurable(false);
 714         }
 715 
<span class="line-modified"> 716         object-&gt;methodTable(vm)-&gt;defineOwnProperty(object, globalObject, propertyName, desc, true);</span>
 717         RETURN_IF_EXCEPTION(scope, false);
 718     }
 719     return true;
 720 }
 721 
 722 template&lt;IntegrityLevel level&gt;
<span class="line-modified"> 723 bool testIntegrityLevel(JSGlobalObject* globalObject, VM&amp; vm, JSObject* object)</span>
 724 {
 725     auto scope = DECLARE_THROW_SCOPE(vm);
 726 
 727     // 1. Assert: Type(O) is Object.
 728     // 2. Assert: level is either &quot;sealed&quot; or &quot;frozen&quot;.
 729 
 730     // 3. Let status be ?IsExtensible(O).
<span class="line-modified"> 731     bool status = object-&gt;isExtensible(globalObject);</span>
 732     RETURN_IF_EXCEPTION(scope, { });
 733 
 734     // 4. If status is true, return false.
 735     if (status)
 736         return false;
 737 
 738     // 6. Let keys be ? O.[[OwnPropertyKeys]]().
 739     PropertyNameArray keys(vm, PropertyNameMode::StringsAndSymbols, PrivateSymbolMode::Exclude);
<span class="line-modified"> 740     object-&gt;methodTable(vm)-&gt;getOwnPropertyNames(object, globalObject, keys, EnumerationMode(DontEnumPropertiesMode::Include));</span>
 741     RETURN_IF_EXCEPTION(scope, { });
 742 
 743     // 7. For each element k of keys, do
 744     PropertyNameArray::const_iterator end = keys.end();
 745     for (PropertyNameArray::const_iterator iter = keys.begin(); iter != end; ++iter) {
 746         auto&amp; propertyName = *iter;
 747         ASSERT(!propertyName.isPrivateName());
 748 
 749         // a. Let currentDesc be ? O.[[GetOwnProperty]](k)
 750         PropertyDescriptor desc;
<span class="line-modified"> 751         bool didGetDescriptor = object-&gt;getOwnPropertyDescriptor(globalObject, propertyName, desc);</span>
 752         RETURN_IF_EXCEPTION(scope, { });
 753 
 754         // b. If currentDesc is not undefined, then
 755         if (!didGetDescriptor)
 756             continue;
 757 
 758         // i. If currentDesc.[[Configurable]] is true, return false.
 759         if (desc.configurable())
 760             return false;
 761 
 762         // ii. If level is &quot;frozen&quot; and IsDataDescriptor(currentDesc) is true, then
 763         // 1. If currentDesc.[[Writable]] is true, return false.
 764         if (level == IntegrityLevel::Frozen &amp;&amp; desc.isDataDescriptor() &amp;&amp; desc.writable())
 765             return false;
 766     }
 767 
 768     return true;
 769 }
 770 
<span class="line-modified"> 771 JSObject* objectConstructorSeal(JSGlobalObject* globalObject, JSObject* object)</span>
 772 {
<span class="line-modified"> 773     VM&amp; vm = globalObject-&gt;vm();</span>
 774     auto scope = DECLARE_THROW_SCOPE(vm);
 775 
 776     if (jsDynamicCast&lt;JSFinalObject*&gt;(vm, object) &amp;&amp; !hasIndexedProperties(object-&gt;indexingType())) {
 777         object-&gt;seal(vm);
 778         return object;
 779     }
 780 
<span class="line-modified"> 781     bool success = setIntegrityLevel&lt;IntegrityLevel::Sealed&gt;(globalObject, vm, object);</span>
 782     RETURN_IF_EXCEPTION(scope, nullptr);
 783     if (UNLIKELY(!success)) {
<span class="line-modified"> 784         throwTypeError(globalObject, scope, &quot;Unable to prevent extension in Object.seal&quot;_s);</span>
 785         return nullptr;
 786     }
 787 
 788     return object;
 789 }
 790 
<span class="line-modified"> 791 EncodedJSValue JSC_HOST_CALL objectConstructorSeal(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 792 {
<span class="line-modified"> 793     VM&amp; vm = globalObject-&gt;vm();</span>
 794     auto scope = DECLARE_THROW_SCOPE(vm);
 795 
 796     // 1. If Type(O) is not Object, return O.
<span class="line-modified"> 797     JSValue obj = callFrame-&gt;argument(0);</span>
 798     if (!obj.isObject())
 799         return JSValue::encode(obj);
 800 
<span class="line-modified"> 801     RELEASE_AND_RETURN(scope, JSValue::encode(objectConstructorSeal(globalObject, asObject(obj))));</span>
 802 }
 803 
<span class="line-modified"> 804 JSObject* objectConstructorFreeze(JSGlobalObject* globalObject, JSObject* object)</span>
 805 {
<span class="line-modified"> 806     VM&amp; vm = globalObject-&gt;vm();</span>
 807     auto scope = DECLARE_THROW_SCOPE(vm);
 808 
 809     if (jsDynamicCast&lt;JSFinalObject*&gt;(vm, object) &amp;&amp; !hasIndexedProperties(object-&gt;indexingType())) {
 810         object-&gt;freeze(vm);
 811         return object;
 812     }
 813 
<span class="line-modified"> 814     bool success = setIntegrityLevel&lt;IntegrityLevel::Frozen&gt;(globalObject, vm, object);</span>
 815     RETURN_IF_EXCEPTION(scope, nullptr);
 816     if (UNLIKELY(!success)) {
<span class="line-modified"> 817         throwTypeError(globalObject, scope, &quot;Unable to prevent extension in Object.freeze&quot;_s);</span>
 818         return nullptr;
 819     }
 820     return object;
 821 }
 822 
<span class="line-modified"> 823 EncodedJSValue JSC_HOST_CALL objectConstructorFreeze(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 824 {
<span class="line-modified"> 825     VM&amp; vm = globalObject-&gt;vm();</span>
 826     auto scope = DECLARE_THROW_SCOPE(vm);
 827     // 1. If Type(O) is not Object, return O.
<span class="line-modified"> 828     JSValue obj = callFrame-&gt;argument(0);</span>
 829     if (!obj.isObject())
 830         return JSValue::encode(obj);
<span class="line-modified"> 831     JSObject* result = objectConstructorFreeze(globalObject, asObject(obj));</span>
 832     RETURN_IF_EXCEPTION(scope, encodedJSValue());
 833     return JSValue::encode(result);
 834 }
 835 
<span class="line-modified"> 836 EncodedJSValue JSC_HOST_CALL objectConstructorPreventExtensions(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 837 {
<span class="line-modified"> 838     VM&amp; vm = globalObject-&gt;vm();</span>
<span class="line-modified"> 839     auto scope = DECLARE_THROW_SCOPE(vm);</span>
<span class="line-added"> 840 </span>
<span class="line-added"> 841     JSValue argument = callFrame-&gt;argument(0);</span>
 842     if (!argument.isObject())
 843         return JSValue::encode(argument);
 844     JSObject* object = asObject(argument);
<span class="line-modified"> 845     bool status = object-&gt;methodTable(vm)-&gt;preventExtensions(object, globalObject);</span>
<span class="line-added"> 846     RETURN_IF_EXCEPTION(scope, { });</span>
<span class="line-added"> 847     if (UNLIKELY(!status))</span>
<span class="line-added"> 848         return throwVMTypeError(globalObject, scope, &quot;Unable to prevent extension in Object.preventExtensions&quot;_s);</span>
 849     return JSValue::encode(object);
 850 }
 851 
<span class="line-modified"> 852 EncodedJSValue JSC_HOST_CALL objectConstructorIsSealed(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 853 {
<span class="line-modified"> 854     VM&amp; vm = globalObject-&gt;vm();</span>
 855 
 856     // 1. If Type(O) is not Object, return true.
<span class="line-modified"> 857     JSValue obj = callFrame-&gt;argument(0);</span>
 858     if (!obj.isObject())
 859         return JSValue::encode(jsBoolean(true));
 860     JSObject* object = asObject(obj);
 861 
 862     // Quick check for final objects.
 863     if (jsDynamicCast&lt;JSFinalObject*&gt;(vm, object) &amp;&amp; !hasIndexedProperties(object-&gt;indexingType()))
 864         return JSValue::encode(jsBoolean(object-&gt;isSealed(vm)));
 865 
 866     // 2. Return ? TestIntegrityLevel(O, &quot;sealed&quot;).
<span class="line-modified"> 867     return JSValue::encode(jsBoolean(testIntegrityLevel&lt;IntegrityLevel::Sealed&gt;(globalObject, vm, object)));</span>
 868 }
 869 
<span class="line-modified"> 870 EncodedJSValue JSC_HOST_CALL objectConstructorIsFrozen(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 871 {
<span class="line-modified"> 872     VM&amp; vm = globalObject-&gt;vm();</span>
 873 
 874     // 1. If Type(O) is not Object, return true.
<span class="line-modified"> 875     JSValue obj = callFrame-&gt;argument(0);</span>
 876     if (!obj.isObject())
 877         return JSValue::encode(jsBoolean(true));
 878     JSObject* object = asObject(obj);
 879 
 880     // Quick check for final objects.
 881     if (jsDynamicCast&lt;JSFinalObject*&gt;(vm, object) &amp;&amp; !hasIndexedProperties(object-&gt;indexingType()))
 882         return JSValue::encode(jsBoolean(object-&gt;isFrozen(vm)));
 883 
 884     // 2. Return ? TestIntegrityLevel(O, &quot;frozen&quot;).
<span class="line-modified"> 885     return JSValue::encode(jsBoolean(testIntegrityLevel&lt;IntegrityLevel::Frozen&gt;(globalObject, vm, object)));</span>
 886 }
 887 
<span class="line-modified"> 888 EncodedJSValue JSC_HOST_CALL objectConstructorIsExtensible(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 889 {
<span class="line-modified"> 890     VM&amp; vm = globalObject-&gt;vm();</span>
 891     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified"> 892     JSValue obj = callFrame-&gt;argument(0);</span>
 893     if (!obj.isObject())
 894         return JSValue::encode(jsBoolean(false));
 895     JSObject* object = asObject(obj);
<span class="line-modified"> 896     bool isExtensible = object-&gt;isExtensible(globalObject);</span>
 897     RETURN_IF_EXCEPTION(scope, encodedJSValue());
 898     return JSValue::encode(jsBoolean(isExtensible));
 899 }
 900 
<span class="line-modified"> 901 EncodedJSValue JSC_HOST_CALL objectConstructorIs(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 902 {
<span class="line-modified"> 903     return JSValue::encode(jsBoolean(sameValue(globalObject, callFrame-&gt;argument(0), callFrame-&gt;argument(1))));</span>
 904 }
 905 
<span class="line-modified"> 906 JSArray* ownPropertyKeys(JSGlobalObject* globalObject, JSObject* object, PropertyNameMode propertyNameMode, DontEnumPropertiesMode dontEnumPropertiesMode)</span>
 907 {
<span class="line-modified"> 908     VM&amp; vm = globalObject-&gt;vm();</span>
 909     auto scope = DECLARE_THROW_SCOPE(vm);
 910 

 911     bool isObjectKeys = propertyNameMode == PropertyNameMode::Strings &amp;&amp; dontEnumPropertiesMode == DontEnumPropertiesMode::Exclude;
 912     // We attempt to look up own property keys cache in Object.keys case.
 913     if (isObjectKeys) {
 914         if (LIKELY(!globalObject-&gt;isHavingABadTime())) {
 915             if (auto* immutableButterfly = object-&gt;structure(vm)-&gt;cachedOwnKeys()) {
 916                 Structure* arrayStructure = globalObject-&gt;originalArrayStructureForIndexingType(immutableButterfly-&gt;indexingMode());
 917                 return JSArray::createWithButterfly(vm, nullptr, arrayStructure, immutableButterfly-&gt;toButterfly());
 918             }
 919         }
 920     }
 921 
 922     PropertyNameArray properties(vm, propertyNameMode, PrivateSymbolMode::Exclude);
<span class="line-modified"> 923     object-&gt;methodTable(vm)-&gt;getOwnPropertyNames(object, globalObject, properties, EnumerationMode(dontEnumPropertiesMode));</span>
 924     RETURN_IF_EXCEPTION(scope, nullptr);
 925 
 926     if (propertyNameMode != PropertyNameMode::StringsAndSymbols) {
 927         ASSERT(propertyNameMode == PropertyNameMode::Strings || propertyNameMode == PropertyNameMode::Symbols);
 928         if (properties.size() &lt; MIN_SPARSE_ARRAY_INDEX) {
 929             if (LIKELY(!globalObject-&gt;isHavingABadTime())) {
 930                 if (isObjectKeys) {
 931                     Structure* structure = object-&gt;structure(vm);
 932                     if (structure-&gt;canCacheOwnKeys()) {
 933                         auto* cachedButterfly = structure-&gt;cachedOwnKeysIgnoringSentinel();
 934                         if (cachedButterfly == StructureRareData::cachedOwnKeysSentinel()) {
 935                             size_t numProperties = properties.size();
 936                             auto* newButterfly = JSImmutableButterfly::create(vm, CopyOnWriteArrayWithContiguous, numProperties);
 937                             for (size_t i = 0; i &lt; numProperties; i++) {
 938                                 const auto&amp; identifier = properties[i];
 939                                 ASSERT(!identifier.isSymbol());
 940                                 newButterfly-&gt;setIndex(vm, i, jsOwnedString(vm, identifier.string()));
 941                             }
 942 
 943                             structure-&gt;setCachedOwnKeys(vm, newButterfly);
</pre>
<hr />
<pre>
 951                 }
 952 
 953                 size_t numProperties = properties.size();
 954                 JSArray* keys = JSArray::create(vm, globalObject-&gt;originalArrayStructureForIndexingType(ArrayWithContiguous), numProperties);
 955                 WriteBarrier&lt;Unknown&gt;* buffer = keys-&gt;butterfly()-&gt;contiguous().data();
 956                 for (size_t i = 0; i &lt; numProperties; i++) {
 957                     const auto&amp; identifier = properties[i];
 958                     if (propertyNameMode == PropertyNameMode::Strings) {
 959                         ASSERT(!identifier.isSymbol());
 960                         buffer[i].set(vm, keys, jsOwnedString(vm, identifier.string()));
 961                     } else {
 962                         ASSERT(identifier.isSymbol());
 963                         buffer[i].set(vm, keys, Symbol::create(vm, static_cast&lt;SymbolImpl&amp;&gt;(*identifier.impl())));
 964                     }
 965                 }
 966                 return keys;
 967             }
 968         }
 969     }
 970 
<span class="line-modified"> 971     JSArray* keys = constructEmptyArray(globalObject, nullptr);</span>
 972     RETURN_IF_EXCEPTION(scope, nullptr);
 973 
 974     unsigned index = 0;
<span class="line-modified"> 975     auto pushDirect = [&amp;] (JSGlobalObject* globalObject, JSArray* array, JSValue value) {</span>
<span class="line-modified"> 976         array-&gt;putDirectIndex(globalObject, index++, value);</span>
 977     };
 978 
 979     switch (propertyNameMode) {
 980     case PropertyNameMode::Strings: {
 981         size_t numProperties = properties.size();
 982         for (size_t i = 0; i &lt; numProperties; i++) {
 983             const auto&amp; identifier = properties[i];
 984             ASSERT(!identifier.isSymbol());
<span class="line-modified"> 985             pushDirect(globalObject, keys, jsOwnedString(vm, identifier.string()));</span>
 986             RETURN_IF_EXCEPTION(scope, nullptr);
 987         }
 988         break;
 989     }
 990 
 991     case PropertyNameMode::Symbols: {
 992         size_t numProperties = properties.size();
 993         for (size_t i = 0; i &lt; numProperties; i++) {
 994             const auto&amp; identifier = properties[i];
 995             ASSERT(identifier.isSymbol());
 996             ASSERT(!identifier.isPrivateName());
<span class="line-modified"> 997             pushDirect(globalObject, keys, Symbol::create(vm, static_cast&lt;SymbolImpl&amp;&gt;(*identifier.impl())));</span>
 998             RETURN_IF_EXCEPTION(scope, nullptr);
 999         }
1000         break;
1001     }
1002 
1003     case PropertyNameMode::StringsAndSymbols: {
1004         Vector&lt;Identifier, 16&gt; propertySymbols;
1005         size_t numProperties = properties.size();
1006         for (size_t i = 0; i &lt; numProperties; i++) {
1007             const auto&amp; identifier = properties[i];
1008             if (identifier.isSymbol()) {
1009                 ASSERT(!identifier.isPrivateName());
1010                 propertySymbols.append(identifier);
1011                 continue;
1012             }
1013 
<span class="line-modified">1014             pushDirect(globalObject, keys, jsOwnedString(vm, identifier.string()));</span>
1015             RETURN_IF_EXCEPTION(scope, nullptr);
1016         }
1017 
1018         // To ensure the order defined in the spec (9.1.12), we append symbols at the last elements of keys.
1019         for (const auto&amp; identifier : propertySymbols) {
<span class="line-modified">1020             pushDirect(globalObject, keys, Symbol::create(vm, static_cast&lt;SymbolImpl&amp;&gt;(*identifier.impl())));</span>
1021             RETURN_IF_EXCEPTION(scope, nullptr);
1022         }
1023 
1024         break;
1025     }
1026     }
1027 
1028     return keys;
1029 }
1030 
1031 } // namespace JSC
</pre>
</td>
</tr>
</table>
<center><a href="NumberPrototype.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="ObjectConstructor.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>