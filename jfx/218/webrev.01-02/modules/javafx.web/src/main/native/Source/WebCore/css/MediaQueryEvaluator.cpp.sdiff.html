<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WebCore/css/MediaQueryEvaluator.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="MediaList.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="MediaQueryEvaluator.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/css/MediaQueryEvaluator.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 28 
 29 #include &quot;config.h&quot;
 30 #include &quot;MediaQueryEvaluator.h&quot;
 31 
 32 #include &quot;CSSAspectRatioValue.h&quot;
 33 #include &quot;CSSPrimitiveValue.h&quot;
 34 #include &quot;CSSToLengthConversionData.h&quot;
 35 #include &quot;CSSValueKeywords.h&quot;
 36 #include &quot;Frame.h&quot;
 37 #include &quot;FrameView.h&quot;
 38 #include &quot;Logging.h&quot;
 39 #include &quot;MediaFeatureNames.h&quot;
 40 #include &quot;MediaList.h&quot;
 41 #include &quot;MediaQuery.h&quot;
 42 #include &quot;MediaQueryParserContext.h&quot;
 43 #include &quot;NodeRenderStyle.h&quot;
 44 #include &quot;Page.h&quot;
 45 #include &quot;PlatformScreen.h&quot;
 46 #include &quot;RenderStyle.h&quot;
 47 #include &quot;RenderView.h&quot;
<span class="line-removed"> 48 #include &quot;RuntimeEnabledFeatures.h&quot;</span>
 49 #include &quot;Settings.h&quot;
<span class="line-removed"> 50 #include &quot;StyleResolver.h&quot;</span>
 51 #include &quot;Theme.h&quot;
 52 #include &lt;wtf/HashMap.h&gt;
 53 #include &lt;wtf/text/StringConcatenateNumbers.h&gt;
 54 #include &lt;wtf/text/TextStream.h&gt;
 55 
 56 #if ENABLE(3D_TRANSFORMS)
 57 #include &quot;RenderLayerCompositor.h&quot;
 58 #endif
 59 
 60 namespace WebCore {
 61 
 62 enum MediaFeaturePrefix { MinPrefix, MaxPrefix, NoPrefix };
 63 
 64 #ifndef LOG_DISABLED
 65 static TextStream&amp; operator&lt;&lt;(TextStream&amp; ts, MediaFeaturePrefix op)
 66 {
 67     switch (op) {
 68     case MinPrefix: ts &lt;&lt; &quot;min&quot;; break;
 69     case MaxPrefix: ts &lt;&lt; &quot;max&quot;; break;
 70     case NoPrefix: ts &lt;&lt; &quot;&quot;; break;
</pre>
<hr />
<pre>
130 {
131     return mediaTypeToMatch.isEmpty()
132         || equalLettersIgnoringASCIICase(mediaTypeToMatch, &quot;all&quot;)
133         || equalIgnoringASCIICase(mediaTypeToMatch, m_mediaType);
134 }
135 
136 bool MediaQueryEvaluator::mediaTypeMatchSpecific(const char* mediaTypeToMatch) const
137 {
138     // Like mediaTypeMatch, but without the special cases for &quot;&quot; and &quot;all&quot;.
139     ASSERT(mediaTypeToMatch);
140     ASSERT(mediaTypeToMatch[0] != &#39;\0&#39;);
141     ASSERT(!equalLettersIgnoringASCIICase(StringView(mediaTypeToMatch), &quot;all&quot;));
142     return equalIgnoringASCIICase(m_mediaType, mediaTypeToMatch);
143 }
144 
145 static bool applyRestrictor(MediaQuery::Restrictor r, bool value)
146 {
147     return r == MediaQuery::Not ? !value : value;
148 }
149 
<span class="line-modified">150 bool MediaQueryEvaluator::evaluate(const MediaQuerySet&amp; querySet, StyleResolver* styleResolver) const</span>
151 {
152     LOG_WITH_STREAM(MediaQueries, stream &lt;&lt; &quot;MediaQueryEvaluator::evaluate on &quot; &lt;&lt; (m_document ? m_document-&gt;url().string() : emptyString()));
153 
154     auto&amp; queries = querySet.queryVector();
155     if (!queries.size()) {
156         LOG_WITH_STREAM(MediaQueries, stream &lt;&lt; &quot;MediaQueryEvaluator::evaluate &quot; &lt;&lt; querySet &lt;&lt; &quot; returning true&quot;);
157         return true; // Empty query list evaluates to true.
158     }
159 
160     // Iterate over queries, stop if any of them eval to true (OR semantics).
161     bool result = false;
162     for (size_t i = 0; i &lt; queries.size() &amp;&amp; !result; ++i) {
163         auto&amp; query = queries[i];
164 
165         if (query.ignored() || (!query.expressions().size() &amp;&amp; query.mediaType().isEmpty()))
166             continue;
167 
168         if (mediaTypeMatch(query.mediaType())) {
169             auto&amp; expressions = query.expressions();
170             // Iterate through expressions, stop if any of them eval to false (AND semantics).

171             size_t j = 0;
172             for (; j &lt; expressions.size(); ++j) {
173                 bool expressionResult = evaluate(expressions[j]);
<span class="line-modified">174                 if (styleResolver &amp;&amp; isViewportDependent(expressions[j].mediaFeature()))</span>
<span class="line-modified">175                     styleResolver-&gt;addViewportDependentMediaQueryResult(expressions[j], expressionResult);</span>
<span class="line-modified">176                 if (styleResolver &amp;&amp; isAccessibilitySettingsDependent(expressions[j].mediaFeature()))</span>
<span class="line-modified">177                     styleResolver-&gt;addAccessibilitySettingsDependentMediaQueryResult(expressions[j], expressionResult);</span>
<span class="line-modified">178                 if (styleResolver &amp;&amp; isAppearanceDependent(expressions[j].mediaFeature()))</span>
<span class="line-modified">179                     styleResolver-&gt;addAppearanceDependentMediaQueryResult(expressions[j], expressionResult);</span>











180                 if (!expressionResult)
181                     break;
182             }
183 





184             // Assume true if we are at the end of the list, otherwise assume false.
185             result = applyRestrictor(query.restrictor(), expressions.size() == j);
186         } else
187             result = applyRestrictor(query.restrictor(), false);
188     }
189 
190     LOG_WITH_STREAM(MediaQueries, stream &lt;&lt; &quot;MediaQueryEvaluator::evaluate &quot; &lt;&lt; querySet &lt;&lt; &quot; returning &quot; &lt;&lt; result);
191     return result;
192 }
193 
<span class="line-modified">194 bool MediaQueryEvaluator::evaluate(const MediaQuerySet&amp; querySet, Vector&lt;MediaQueryResult&gt;&amp; viewportDependentResults, Vector&lt;MediaQueryResult&gt;&amp; appearanceDependentResults) const</span>
195 {
<span class="line-modified">196     auto&amp; queries = querySet.queryVector();</span>
<span class="line-modified">197     if (!queries.size())</span>
<span class="line-modified">198         return true;</span>
<span class="line-modified">199 </span>
<span class="line-modified">200     bool result = false;</span>
<span class="line-modified">201     for (size_t i = 0; i &lt; queries.size() &amp;&amp; !result; ++i) {</span>
<span class="line-modified">202         auto&amp; query = queries[i];</span>
<span class="line-removed">203 </span>
<span class="line-removed">204         if (query.ignored())</span>
<span class="line-removed">205             continue;</span>
<span class="line-removed">206 </span>
<span class="line-removed">207         if (mediaTypeMatch(query.mediaType())) {</span>
<span class="line-removed">208             auto&amp; expressions = query.expressions();</span>
<span class="line-removed">209             size_t j = 0;</span>
<span class="line-removed">210             for (; j &lt; expressions.size(); ++j) {</span>
<span class="line-removed">211                 bool expressionResult = evaluate(expressions[j]);</span>
<span class="line-removed">212                 if (isViewportDependent(expressions[j].mediaFeature()))</span>
<span class="line-removed">213                     viewportDependentResults.append({ expressions[j], expressionResult });</span>
<span class="line-removed">214                 if (isAppearanceDependent(expressions[j].mediaFeature()))</span>
<span class="line-removed">215                     appearanceDependentResults.append({ expressions[j], expressionResult });</span>
<span class="line-removed">216                 if (!expressionResult)</span>
<span class="line-removed">217                     break;</span>
<span class="line-removed">218             }</span>
<span class="line-removed">219             result = applyRestrictor(query.restrictor(), expressions.size() == j);</span>
<span class="line-removed">220         } else</span>
<span class="line-removed">221             result = applyRestrictor(query.restrictor(), false);</span>
<span class="line-removed">222     }</span>
223 
<span class="line-modified">224     return result;</span>
225 }
226 
227 template&lt;typename T, typename U&gt; bool compareValue(T a, U b, MediaFeaturePrefix op)
228 {
229     switch (op) {
230     case MinPrefix:
231         return a &gt;= b;
232     case MaxPrefix:
233         return a &lt;= b;
234     case NoPrefix:
235         return a == b;
236     }
237     return false;
238 }
239 
240 #if !LOG_DISABLED
241 
242 static String aspectRatioValueAsString(CSSValue* value)
243 {
244     if (!is&lt;CSSAspectRatioValue&gt;(value))
245         return emptyString();
246 
247     auto&amp; aspectRatio = downcast&lt;CSSAspectRatioValue&gt;(*value);
<span class="line-modified">248     return makeString(FormattedNumber::fixedWidth(aspectRatio.numeratorValue(), 6), &#39;/&#39;, FormattedNumber::fixedWidth(aspectRatio.denominatorValue(), 6));</span>
249 }
250 
251 #endif
252 
253 static bool compareAspectRatioValue(CSSValue* value, int width, int height, MediaFeaturePrefix op)
254 {
255     if (!is&lt;CSSAspectRatioValue&gt;(value))
256         return false;
257     auto&amp; aspectRatio = downcast&lt;CSSAspectRatioValue&gt;(*value);
258     return compareValue(width * aspectRatio.denominatorValue(), height * aspectRatio.numeratorValue(), op);
259 }
260 
261 static Optional&lt;double&gt; doubleValue(CSSValue* value)
262 {
263     if (!is&lt;CSSPrimitiveValue&gt;(value) || !downcast&lt;CSSPrimitiveValue&gt;(*value).isNumber())
264         return WTF::nullopt;
<span class="line-modified">265     return downcast&lt;CSSPrimitiveValue&gt;(*value).doubleValue(CSSPrimitiveValue::CSS_NUMBER);</span>
266 }
267 
268 static bool zeroEvaluate(CSSValue* value, MediaFeaturePrefix op)
269 {
270     auto numericValue = doubleValue(value);
271     return numericValue &amp;&amp; compareValue(0, numericValue.value(), op);
272 }
273 
274 static bool oneEvaluate(CSSValue* value, MediaFeaturePrefix op)
275 {
276     if (!value)
277         return true;
278     auto numericValue = doubleValue(value);
279     return numericValue &amp;&amp; compareValue(1, numericValue.value(), op);
280 }
281 
282 static bool colorEvaluate(CSSValue* value, const CSSToLengthConversionData&amp;, Frame&amp; frame, MediaFeaturePrefix op)
283 {
284     int bitsPerComponent = screenDepthPerComponent(frame.mainFrame().view());
285     auto numericValue = doubleValue(value);
</pre>
<hr />
<pre>
411     // this method only got called if this media type matches the one defined
412     // in the query. Thus, if if the document&#39;s media type is &quot;print&quot;, the
413     // media type of the query will either be &quot;print&quot; or &quot;all&quot;.
414     String mediaType = view-&gt;mediaType();
415     if (equalLettersIgnoringASCIICase(mediaType, &quot;screen&quot;))
416         deviceScaleFactor = frame.page() ? frame.page()-&gt;deviceScaleFactor() : 1;
417     else if (equalLettersIgnoringASCIICase(mediaType, &quot;print&quot;)) {
418         // The resolution of images while printing should not depend on the dpi
419         // of the screen. Until we support proper ways of querying this info
420         // we use 300px which is considered minimum for current printers.
421         deviceScaleFactor = 3.125; // 300dpi / 96dpi;
422     }
423 
424     if (!value)
425         return !!deviceScaleFactor;
426 
427     if (!is&lt;CSSPrimitiveValue&gt;(value))
428         return false;
429 
430     auto&amp; resolution = downcast&lt;CSSPrimitiveValue&gt;(*value);
<span class="line-modified">431     float resolutionValue = resolution.isNumber() ? resolution.floatValue() : resolution.floatValue(CSSPrimitiveValue::CSS_DPPX);</span>
432     bool result = compareValue(deviceScaleFactor, resolutionValue, op);
433     LOG_WITH_STREAM(MediaQueries, stream &lt;&lt; &quot;  evaluateResolution: &quot; &lt;&lt; op &lt;&lt; &quot; &quot; &lt;&lt; resolutionValue &lt;&lt; &quot; device scale factor &quot; &lt;&lt; deviceScaleFactor &lt;&lt; &quot;: &quot; &lt;&lt; result);
434     return result;
435 }
436 
437 static bool devicePixelRatioEvaluate(CSSValue* value, const CSSToLengthConversionData&amp;, Frame&amp; frame, MediaFeaturePrefix op)
438 {
439     return (!value || (is&lt;CSSPrimitiveValue&gt;(*value) &amp;&amp; downcast&lt;CSSPrimitiveValue&gt;(*value).isNumber())) &amp;&amp; evaluateResolution(value, frame, op);
440 }
441 
442 static bool resolutionEvaluate(CSSValue* value, const CSSToLengthConversionData&amp;, Frame&amp; frame, MediaFeaturePrefix op)
443 {
444 #if ENABLE(RESOLUTION_MEDIA_QUERY)
445     return (!value || (is&lt;CSSPrimitiveValue&gt;(*value) &amp;&amp; downcast&lt;CSSPrimitiveValue&gt;(*value).isResolution())) &amp;&amp; evaluateResolution(value, frame, op);
446 #else
447     UNUSED_PARAM(value);
448     UNUSED_PARAM(frame);
449     UNUSED_PARAM(op);
450     return false;
451 #endif
452 }
453 



























454 static bool gridEvaluate(CSSValue* value, const CSSToLengthConversionData&amp;, Frame&amp;, MediaFeaturePrefix op)
455 {
456     return zeroEvaluate(value, op);
457 }
458 
459 static bool computeLength(CSSValue* value, bool strict, const CSSToLengthConversionData&amp; conversionData, int&amp; result)
460 {
461     if (!is&lt;CSSPrimitiveValue&gt;(value))
462         return false;
463 
464     auto&amp; primitiveValue = downcast&lt;CSSPrimitiveValue&gt;(*value);
465 
466     if (primitiveValue.isNumber()) {
467         result = primitiveValue.intValue();
468         return !strict || !result;
469     }
470 
471     if (primitiveValue.isLength()) {
472         result = primitiveValue.computeLength&lt;int&gt;(conversionData);
473         return true;
</pre>
</td>
<td>
<hr />
<pre>
 28 
 29 #include &quot;config.h&quot;
 30 #include &quot;MediaQueryEvaluator.h&quot;
 31 
 32 #include &quot;CSSAspectRatioValue.h&quot;
 33 #include &quot;CSSPrimitiveValue.h&quot;
 34 #include &quot;CSSToLengthConversionData.h&quot;
 35 #include &quot;CSSValueKeywords.h&quot;
 36 #include &quot;Frame.h&quot;
 37 #include &quot;FrameView.h&quot;
 38 #include &quot;Logging.h&quot;
 39 #include &quot;MediaFeatureNames.h&quot;
 40 #include &quot;MediaList.h&quot;
 41 #include &quot;MediaQuery.h&quot;
 42 #include &quot;MediaQueryParserContext.h&quot;
 43 #include &quot;NodeRenderStyle.h&quot;
 44 #include &quot;Page.h&quot;
 45 #include &quot;PlatformScreen.h&quot;
 46 #include &quot;RenderStyle.h&quot;
 47 #include &quot;RenderView.h&quot;

 48 #include &quot;Settings.h&quot;

 49 #include &quot;Theme.h&quot;
 50 #include &lt;wtf/HashMap.h&gt;
 51 #include &lt;wtf/text/StringConcatenateNumbers.h&gt;
 52 #include &lt;wtf/text/TextStream.h&gt;
 53 
 54 #if ENABLE(3D_TRANSFORMS)
 55 #include &quot;RenderLayerCompositor.h&quot;
 56 #endif
 57 
 58 namespace WebCore {
 59 
 60 enum MediaFeaturePrefix { MinPrefix, MaxPrefix, NoPrefix };
 61 
 62 #ifndef LOG_DISABLED
 63 static TextStream&amp; operator&lt;&lt;(TextStream&amp; ts, MediaFeaturePrefix op)
 64 {
 65     switch (op) {
 66     case MinPrefix: ts &lt;&lt; &quot;min&quot;; break;
 67     case MaxPrefix: ts &lt;&lt; &quot;max&quot;; break;
 68     case NoPrefix: ts &lt;&lt; &quot;&quot;; break;
</pre>
<hr />
<pre>
128 {
129     return mediaTypeToMatch.isEmpty()
130         || equalLettersIgnoringASCIICase(mediaTypeToMatch, &quot;all&quot;)
131         || equalIgnoringASCIICase(mediaTypeToMatch, m_mediaType);
132 }
133 
134 bool MediaQueryEvaluator::mediaTypeMatchSpecific(const char* mediaTypeToMatch) const
135 {
136     // Like mediaTypeMatch, but without the special cases for &quot;&quot; and &quot;all&quot;.
137     ASSERT(mediaTypeToMatch);
138     ASSERT(mediaTypeToMatch[0] != &#39;\0&#39;);
139     ASSERT(!equalLettersIgnoringASCIICase(StringView(mediaTypeToMatch), &quot;all&quot;));
140     return equalIgnoringASCIICase(m_mediaType, mediaTypeToMatch);
141 }
142 
143 static bool applyRestrictor(MediaQuery::Restrictor r, bool value)
144 {
145     return r == MediaQuery::Not ? !value : value;
146 }
147 
<span class="line-modified">148 bool MediaQueryEvaluator::evaluate(const MediaQuerySet&amp; querySet, MediaQueryDynamicResults* dynamicResults, Mode mode) const</span>
149 {
150     LOG_WITH_STREAM(MediaQueries, stream &lt;&lt; &quot;MediaQueryEvaluator::evaluate on &quot; &lt;&lt; (m_document ? m_document-&gt;url().string() : emptyString()));
151 
152     auto&amp; queries = querySet.queryVector();
153     if (!queries.size()) {
154         LOG_WITH_STREAM(MediaQueries, stream &lt;&lt; &quot;MediaQueryEvaluator::evaluate &quot; &lt;&lt; querySet &lt;&lt; &quot; returning true&quot;);
155         return true; // Empty query list evaluates to true.
156     }
157 
158     // Iterate over queries, stop if any of them eval to true (OR semantics).
159     bool result = false;
160     for (size_t i = 0; i &lt; queries.size() &amp;&amp; !result; ++i) {
161         auto&amp; query = queries[i];
162 
163         if (query.ignored() || (!query.expressions().size() &amp;&amp; query.mediaType().isEmpty()))
164             continue;
165 
166         if (mediaTypeMatch(query.mediaType())) {
167             auto&amp; expressions = query.expressions();
168             // Iterate through expressions, stop if any of them eval to false (AND semantics).
<span class="line-added">169             bool isDynamic = false;</span>
170             size_t j = 0;
171             for (; j &lt; expressions.size(); ++j) {
172                 bool expressionResult = evaluate(expressions[j]);
<span class="line-modified">173                 if (dynamicResults) {</span>
<span class="line-modified">174                     if (isViewportDependent(expressions[j].mediaFeature())) {</span>
<span class="line-modified">175                         isDynamic = true;</span>
<span class="line-modified">176                         dynamicResults-&gt;viewport.append({ expressions[j], expressionResult });</span>
<span class="line-modified">177                     }</span>
<span class="line-modified">178                     if (isAppearanceDependent(expressions[j].mediaFeature())) {</span>
<span class="line-added">179                         isDynamic = true;</span>
<span class="line-added">180                         dynamicResults-&gt;appearance.append({ expressions[j], expressionResult });</span>
<span class="line-added">181                     }</span>
<span class="line-added">182                     if (isAccessibilitySettingsDependent(expressions[j].mediaFeature())) {</span>
<span class="line-added">183                         isDynamic = true;</span>
<span class="line-added">184                         dynamicResults-&gt;accessibilitySettings.append({ expressions[j], expressionResult });</span>
<span class="line-added">185                     }</span>
<span class="line-added">186                 }</span>
<span class="line-added">187                 if (mode == Mode::AlwaysMatchDynamic &amp;&amp; isDynamic)</span>
<span class="line-added">188                     continue;</span>
<span class="line-added">189 </span>
190                 if (!expressionResult)
191                     break;
192             }
193 
<span class="line-added">194             if (mode == Mode::AlwaysMatchDynamic &amp;&amp; isDynamic) {</span>
<span class="line-added">195                 result = true;</span>
<span class="line-added">196                 continue;</span>
<span class="line-added">197             }</span>
<span class="line-added">198 </span>
199             // Assume true if we are at the end of the list, otherwise assume false.
200             result = applyRestrictor(query.restrictor(), expressions.size() == j);
201         } else
202             result = applyRestrictor(query.restrictor(), false);
203     }
204 
205     LOG_WITH_STREAM(MediaQueries, stream &lt;&lt; &quot;MediaQueryEvaluator::evaluate &quot; &lt;&lt; querySet &lt;&lt; &quot; returning &quot; &lt;&lt; result);
206     return result;
207 }
208 
<span class="line-modified">209 bool MediaQueryEvaluator::evaluateForChanges(const MediaQueryDynamicResults&amp; dynamicResults) const</span>
210 {
<span class="line-modified">211     auto hasChanges = [&amp;](auto&amp; dynamicResultsVector) {</span>
<span class="line-modified">212         for (auto&amp; dynamicResult : dynamicResultsVector) {</span>
<span class="line-modified">213             if (evaluate(dynamicResult.expression) != dynamicResult.result)</span>
<span class="line-modified">214                 return true;</span>
<span class="line-modified">215         }</span>
<span class="line-modified">216         return false;</span>
<span class="line-modified">217     };</span>




















218 
<span class="line-modified">219     return hasChanges(dynamicResults.viewport) || hasChanges(dynamicResults.appearance) || hasChanges(dynamicResults.accessibilitySettings);</span>
220 }
221 
222 template&lt;typename T, typename U&gt; bool compareValue(T a, U b, MediaFeaturePrefix op)
223 {
224     switch (op) {
225     case MinPrefix:
226         return a &gt;= b;
227     case MaxPrefix:
228         return a &lt;= b;
229     case NoPrefix:
230         return a == b;
231     }
232     return false;
233 }
234 
235 #if !LOG_DISABLED
236 
237 static String aspectRatioValueAsString(CSSValue* value)
238 {
239     if (!is&lt;CSSAspectRatioValue&gt;(value))
240         return emptyString();
241 
242     auto&amp; aspectRatio = downcast&lt;CSSAspectRatioValue&gt;(*value);
<span class="line-modified">243     return makeString(aspectRatio.numeratorValue(), &#39;/&#39;, aspectRatio.denominatorValue());</span>
244 }
245 
246 #endif
247 
248 static bool compareAspectRatioValue(CSSValue* value, int width, int height, MediaFeaturePrefix op)
249 {
250     if (!is&lt;CSSAspectRatioValue&gt;(value))
251         return false;
252     auto&amp; aspectRatio = downcast&lt;CSSAspectRatioValue&gt;(*value);
253     return compareValue(width * aspectRatio.denominatorValue(), height * aspectRatio.numeratorValue(), op);
254 }
255 
256 static Optional&lt;double&gt; doubleValue(CSSValue* value)
257 {
258     if (!is&lt;CSSPrimitiveValue&gt;(value) || !downcast&lt;CSSPrimitiveValue&gt;(*value).isNumber())
259         return WTF::nullopt;
<span class="line-modified">260     return downcast&lt;CSSPrimitiveValue&gt;(*value).doubleValue(CSSUnitType::CSS_NUMBER);</span>
261 }
262 
263 static bool zeroEvaluate(CSSValue* value, MediaFeaturePrefix op)
264 {
265     auto numericValue = doubleValue(value);
266     return numericValue &amp;&amp; compareValue(0, numericValue.value(), op);
267 }
268 
269 static bool oneEvaluate(CSSValue* value, MediaFeaturePrefix op)
270 {
271     if (!value)
272         return true;
273     auto numericValue = doubleValue(value);
274     return numericValue &amp;&amp; compareValue(1, numericValue.value(), op);
275 }
276 
277 static bool colorEvaluate(CSSValue* value, const CSSToLengthConversionData&amp;, Frame&amp; frame, MediaFeaturePrefix op)
278 {
279     int bitsPerComponent = screenDepthPerComponent(frame.mainFrame().view());
280     auto numericValue = doubleValue(value);
</pre>
<hr />
<pre>
406     // this method only got called if this media type matches the one defined
407     // in the query. Thus, if if the document&#39;s media type is &quot;print&quot;, the
408     // media type of the query will either be &quot;print&quot; or &quot;all&quot;.
409     String mediaType = view-&gt;mediaType();
410     if (equalLettersIgnoringASCIICase(mediaType, &quot;screen&quot;))
411         deviceScaleFactor = frame.page() ? frame.page()-&gt;deviceScaleFactor() : 1;
412     else if (equalLettersIgnoringASCIICase(mediaType, &quot;print&quot;)) {
413         // The resolution of images while printing should not depend on the dpi
414         // of the screen. Until we support proper ways of querying this info
415         // we use 300px which is considered minimum for current printers.
416         deviceScaleFactor = 3.125; // 300dpi / 96dpi;
417     }
418 
419     if (!value)
420         return !!deviceScaleFactor;
421 
422     if (!is&lt;CSSPrimitiveValue&gt;(value))
423         return false;
424 
425     auto&amp; resolution = downcast&lt;CSSPrimitiveValue&gt;(*value);
<span class="line-modified">426     float resolutionValue = resolution.isNumber() ? resolution.floatValue() : resolution.floatValue(CSSUnitType::CSS_DPPX);</span>
427     bool result = compareValue(deviceScaleFactor, resolutionValue, op);
428     LOG_WITH_STREAM(MediaQueries, stream &lt;&lt; &quot;  evaluateResolution: &quot; &lt;&lt; op &lt;&lt; &quot; &quot; &lt;&lt; resolutionValue &lt;&lt; &quot; device scale factor &quot; &lt;&lt; deviceScaleFactor &lt;&lt; &quot;: &quot; &lt;&lt; result);
429     return result;
430 }
431 
432 static bool devicePixelRatioEvaluate(CSSValue* value, const CSSToLengthConversionData&amp;, Frame&amp; frame, MediaFeaturePrefix op)
433 {
434     return (!value || (is&lt;CSSPrimitiveValue&gt;(*value) &amp;&amp; downcast&lt;CSSPrimitiveValue&gt;(*value).isNumber())) &amp;&amp; evaluateResolution(value, frame, op);
435 }
436 
437 static bool resolutionEvaluate(CSSValue* value, const CSSToLengthConversionData&amp;, Frame&amp; frame, MediaFeaturePrefix op)
438 {
439 #if ENABLE(RESOLUTION_MEDIA_QUERY)
440     return (!value || (is&lt;CSSPrimitiveValue&gt;(*value) &amp;&amp; downcast&lt;CSSPrimitiveValue&gt;(*value).isResolution())) &amp;&amp; evaluateResolution(value, frame, op);
441 #else
442     UNUSED_PARAM(value);
443     UNUSED_PARAM(frame);
444     UNUSED_PARAM(op);
445     return false;
446 #endif
447 }
448 
<span class="line-added">449 static bool dynamicRangeEvaluate(CSSValue* value, const CSSToLengthConversionData&amp;, Frame&amp; frame, MediaFeaturePrefix)</span>
<span class="line-added">450 {</span>
<span class="line-added">451     if (!value)</span>
<span class="line-added">452         return false;</span>
<span class="line-added">453 </span>
<span class="line-added">454     if (!frame.settings().hdrMediaCapabilitiesEnabled())</span>
<span class="line-added">455         return false;</span>
<span class="line-added">456 </span>
<span class="line-added">457     bool supportsHighDynamicRange;</span>
<span class="line-added">458 </span>
<span class="line-added">459     if (frame.settings().forcedSupportsHighDynamicRangeValue() == Settings::ForcedAccessibilityValue::On)</span>
<span class="line-added">460         supportsHighDynamicRange = true;</span>
<span class="line-added">461     else if (frame.settings().forcedSupportsHighDynamicRangeValue() == Settings::ForcedAccessibilityValue::Off)</span>
<span class="line-added">462         supportsHighDynamicRange = false;</span>
<span class="line-added">463     else</span>
<span class="line-added">464         supportsHighDynamicRange = screenSupportsHighDynamicRange(frame.mainFrame().view());</span>
<span class="line-added">465 </span>
<span class="line-added">466     switch (downcast&lt;CSSPrimitiveValue&gt;(*value).valueID()) {</span>
<span class="line-added">467     case CSSValueHigh:</span>
<span class="line-added">468         return supportsHighDynamicRange;</span>
<span class="line-added">469     case CSSValueStandard:</span>
<span class="line-added">470         return true;</span>
<span class="line-added">471     default:</span>
<span class="line-added">472         return false; // Any unknown value should not be considered a match.</span>
<span class="line-added">473     }</span>
<span class="line-added">474 }</span>
<span class="line-added">475 </span>
476 static bool gridEvaluate(CSSValue* value, const CSSToLengthConversionData&amp;, Frame&amp;, MediaFeaturePrefix op)
477 {
478     return zeroEvaluate(value, op);
479 }
480 
481 static bool computeLength(CSSValue* value, bool strict, const CSSToLengthConversionData&amp; conversionData, int&amp; result)
482 {
483     if (!is&lt;CSSPrimitiveValue&gt;(value))
484         return false;
485 
486     auto&amp; primitiveValue = downcast&lt;CSSPrimitiveValue&gt;(*value);
487 
488     if (primitiveValue.isNumber()) {
489         result = primitiveValue.intValue();
490         return !strict || !result;
491     }
492 
493     if (primitiveValue.isLength()) {
494         result = primitiveValue.computeLength&lt;int&gt;(conversionData);
495         return true;
</pre>
</td>
</tr>
</table>
<center><a href="MediaList.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="MediaQueryEvaluator.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>