<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/WebCore/inspector/InspectorStyleSheet.h</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (C) 2010, Google Inc. All rights reserved.
  3  *
  4  * Redistribution and use in source and binary forms, with or without
  5  * modification, are permitted provided that the following conditions
  6  * are met:
  7  * 1.  Redistributions of source code must retain the above copyright
  8  *     notice, this list of conditions and the following disclaimer.
  9  * 2.  Redistributions in binary form must reproduce the above copyright
 10  *     notice, this list of conditions and the following disclaimer in the
 11  *     documentation and/or other materials provided with the distribution.
 12  *
 13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. AND ITS CONTRIBUTORS ``AS IS&#39;&#39; AND ANY
 14  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 15  * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 16  * DISCLAIMED. IN NO EVENT SHALL APPLE INC. OR ITS CONTRIBUTORS BE LIABLE FOR ANY
 17  * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 18  * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 19  * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
 20  * ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 21  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
 22  * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 23  */
 24 
 25 #pragma once
 26 
 27 #include &quot;CSSPropertySourceData.h&quot;
 28 #include &quot;CSSStyleDeclaration.h&quot;
 29 #include &lt;JavaScriptCore/InspectorProtocolObjects.h&gt;
 30 #include &lt;wtf/HashMap.h&gt;
 31 #include &lt;wtf/JSONValues.h&gt;
 32 #include &lt;wtf/Vector.h&gt;
 33 
 34 class ParsedStyleSheet;
 35 
 36 namespace WebCore {
 37 
 38 class CSSRuleList;
 39 class CSSSelector;
 40 class CSSStyleDeclaration;
 41 class CSSStyleRule;
 42 class CSSStyleSheet;
 43 class Document;
 44 class Element;
 45 class InspectorPageAgent;
 46 class InspectorStyleSheet;
 47 
 48 typedef String ErrorString;
 49 
 50 class InspectorCSSId {
 51 public:
 52     InspectorCSSId() = default;
 53 
 54     explicit InspectorCSSId(const JSON::Object&amp; value)
 55     {
 56         if (!value.getString(&quot;styleSheetId&quot;_s, m_styleSheetId))
 57             return;
 58 
 59         if (!value.getInteger(&quot;ordinal&quot;_s, m_ordinal))
 60             m_styleSheetId = String();
 61     }
 62 
 63     InspectorCSSId(const String&amp; styleSheetId, unsigned ordinal)
 64         : m_styleSheetId(styleSheetId)
 65         , m_ordinal(ordinal)
 66     {
 67     }
 68 
 69     bool isEmpty() const { return m_styleSheetId.isEmpty(); }
 70 
 71     const String&amp; styleSheetId() const { return m_styleSheetId; }
 72     unsigned ordinal() const { return m_ordinal; }
 73 
 74     // ID type is either Inspector::Protocol::CSS::CSSStyleId or Inspector::Protocol::CSS::CSSRuleId.
 75     template&lt;typename ID&gt;
 76     RefPtr&lt;ID&gt; asProtocolValue() const
 77     {
 78         if (isEmpty())
 79             return nullptr;
 80 
 81         return ID::create()
 82             .setStyleSheetId(m_styleSheetId)
 83             .setOrdinal(m_ordinal)
 84             .release();
 85     }
 86 
 87 private:
 88     String m_styleSheetId;
 89     unsigned m_ordinal = {0};
 90 };
 91 
 92 struct InspectorStyleProperty {
 93     InspectorStyleProperty()
 94         : hasSource(false)
 95         , disabled(false)
 96     {
 97     }
 98 
 99     InspectorStyleProperty(CSSPropertySourceData sourceData, bool hasSource, bool disabled)
100         : sourceData(sourceData)
101         , hasSource(hasSource)
102         , disabled(disabled)
103     {
104     }
105 
106     void setRawTextFromStyleDeclaration(const String&amp; styleDeclaration)
107     {
108         unsigned start = sourceData.range.start;
109         unsigned end = sourceData.range.end;
110         ASSERT_WITH_SECURITY_IMPLICATION(start &lt; end);
111         ASSERT(end &lt;= styleDeclaration.length());
112         rawText = styleDeclaration.substring(start, end - start);
113     }
114 
115     bool hasRawText() const { return !rawText.isEmpty(); }
116 
117     CSSPropertySourceData sourceData;
118     bool hasSource;
119     bool disabled;
120     String rawText;
121 };
122 
123 class InspectorStyle final : public RefCounted&lt;InspectorStyle&gt; {
124 public:
125     static Ref&lt;InspectorStyle&gt; create(const InspectorCSSId&amp; styleId, Ref&lt;CSSStyleDeclaration&gt;&amp;&amp;, InspectorStyleSheet* parentStyleSheet);
126     ~InspectorStyle();
127 
128     CSSStyleDeclaration&amp; cssStyle() const { return m_style.get(); }
129     RefPtr&lt;Inspector::Protocol::CSS::CSSStyle&gt; buildObjectForStyle() const;
130     Ref&lt;JSON::ArrayOf&lt;Inspector::Protocol::CSS::CSSComputedStyleProperty&gt;&gt; buildArrayForComputedStyle() const;
131 
132     ExceptionOr&lt;String&gt; text() const;
133     ExceptionOr&lt;void&gt; setText(const String&amp;);
134 
135 private:
136     InspectorStyle(const InspectorCSSId&amp; styleId, Ref&lt;CSSStyleDeclaration&gt;&amp;&amp;, InspectorStyleSheet* parentStyleSheet);
137 
<a name="1" id="anc1"></a><span class="line-modified">138     Vector&lt;InspectorStyleProperty&gt; collectProperties(bool includeAll) const;</span>
139     Ref&lt;Inspector::Protocol::CSS::CSSStyle&gt; styleWithProperties() const;
140     RefPtr&lt;CSSRuleSourceData&gt; extractSourceData() const;
141     String shorthandValue(const String&amp; shorthandProperty) const;
142     String shorthandPriority(const String&amp; shorthandProperty) const;
143     Vector&lt;String&gt; longhandProperties(const String&amp; shorthandProperty) const;
144 
145     InspectorCSSId m_styleId;
146     Ref&lt;CSSStyleDeclaration&gt; m_style;
147     InspectorStyleSheet* m_parentStyleSheet;
148 };
149 
150 class InspectorStyleSheet : public RefCounted&lt;InspectorStyleSheet&gt; {
151 public:
152     class Listener {
153     public:
154         Listener() = default;
155         virtual ~Listener() = default;
156         virtual void styleSheetChanged(InspectorStyleSheet*) = 0;
157     };
158 
159     typedef HashMap&lt;CSSStyleDeclaration*, RefPtr&lt;InspectorStyle&gt;&gt; InspectorStyleMap;
160     static Ref&lt;InspectorStyleSheet&gt; create(InspectorPageAgent*, const String&amp; id, RefPtr&lt;CSSStyleSheet&gt;&amp;&amp; pageStyleSheet, Inspector::Protocol::CSS::StyleSheetOrigin, const String&amp; documentURL, Listener*);
161     static String styleSheetURL(CSSStyleSheet* pageStyleSheet);
162 
163     virtual ~InspectorStyleSheet();
164 
165     String id() const { return m_id; }
166     String finalURL() const;
167     CSSStyleSheet* pageStyleSheet() const { return m_pageStyleSheet.get(); }
168     void reparseStyleSheet(const String&amp;);
169     ExceptionOr&lt;void&gt; setText(const String&amp;);
170     ExceptionOr&lt;String&gt; ruleSelector(const InspectorCSSId&amp;);
171     ExceptionOr&lt;void&gt; setRuleSelector(const InspectorCSSId&amp;, const String&amp; selector);
172     ExceptionOr&lt;CSSStyleRule*&gt; addRule(const String&amp; selector);
173     ExceptionOr&lt;void&gt; deleteRule(const InspectorCSSId&amp;);
174     CSSStyleRule* ruleForId(const InspectorCSSId&amp;) const;
175     RefPtr&lt;Inspector::Protocol::CSS::CSSStyleSheetBody&gt; buildObjectForStyleSheet();
176     RefPtr&lt;Inspector::Protocol::CSS::CSSStyleSheetHeader&gt; buildObjectForStyleSheetInfo();
177     RefPtr&lt;Inspector::Protocol::CSS::CSSRule&gt; buildObjectForRule(CSSStyleRule*, Element*);
178     RefPtr&lt;Inspector::Protocol::CSS::CSSStyle&gt; buildObjectForStyle(CSSStyleDeclaration*);
179     ExceptionOr&lt;void&gt; setStyleText(const InspectorCSSId&amp;, const String&amp; text, String* oldText);
180 
181     virtual ExceptionOr&lt;String&gt; text() const;
182     virtual CSSStyleDeclaration* styleForId(const InspectorCSSId&amp;) const;
183     void fireStyleSheetChanged();
184 
185     InspectorCSSId ruleId(CSSStyleRule*) const;
186     InspectorCSSId styleId(CSSStyleDeclaration* style) const { return ruleOrStyleId(style); }
187 
188 protected:
189     InspectorStyleSheet(InspectorPageAgent*, const String&amp; id, RefPtr&lt;CSSStyleSheet&gt;&amp;&amp; pageStyleSheet, Inspector::Protocol::CSS::StyleSheetOrigin, const String&amp; documentURL, Listener*);
190 
191     bool canBind() const { return m_origin != Inspector::Protocol::CSS::StyleSheetOrigin::UserAgent &amp;&amp; m_origin != Inspector::Protocol::CSS::StyleSheetOrigin::User; }
192     InspectorCSSId ruleOrStyleId(CSSStyleDeclaration*) const;
193     virtual Document* ownerDocument() const;
194     virtual RefPtr&lt;CSSRuleSourceData&gt; ruleSourceDataFor(CSSStyleDeclaration*) const;
195     virtual unsigned ruleIndexByStyle(CSSStyleDeclaration*) const;
196     virtual bool ensureParsedDataReady();
197     virtual RefPtr&lt;InspectorStyle&gt; inspectorStyleForId(const InspectorCSSId&amp;);
198 
199     // Also accessed by friend class InspectorStyle.
200     virtual ExceptionOr&lt;void&gt; setStyleText(CSSStyleDeclaration*, const String&amp;);
201     virtual Vector&lt;size_t&gt; lineEndings() const;
202 
203 private:
204     typedef Vector&lt;RefPtr&lt;CSSStyleRule&gt;&gt; CSSStyleRuleVector;
205     friend class InspectorStyle;
206 
207     static void collectFlatRules(RefPtr&lt;CSSRuleList&gt;&amp;&amp;, CSSStyleRuleVector* result);
208     bool styleSheetMutated() const;
209     bool ensureText() const;
210     bool ensureSourceData();
211     void ensureFlatRules() const;
212     bool styleSheetTextWithChangedStyle(CSSStyleDeclaration*, const String&amp; newStyleText, String* result);
213     bool originalStyleSheetText(String* result) const;
214     bool resourceStyleSheetText(String* result) const;
215     bool inlineStyleSheetText(String* result) const;
<a name="2" id="anc2"></a><span class="line-added">216     bool extensionStyleSheetText(String* result) const;</span>
217     Ref&lt;JSON::ArrayOf&lt;Inspector::Protocol::CSS::CSSRule&gt;&gt; buildArrayForRuleList(CSSRuleList*);
218     Ref&lt;Inspector::Protocol::CSS::CSSSelector&gt; buildObjectForSelector(const CSSSelector*, Element*);
219     Ref&lt;Inspector::Protocol::CSS::SelectorList&gt; buildObjectForSelectorList(CSSStyleRule*, Element*, int&amp; endingLine);
220 
221     InspectorPageAgent* m_pageAgent;
222     String m_id;
223     RefPtr&lt;CSSStyleSheet&gt; m_pageStyleSheet;
224     Inspector::Protocol::CSS::StyleSheetOrigin m_origin;
225     String m_documentURL;
226     ParsedStyleSheet* m_parsedStyleSheet;
227     mutable CSSStyleRuleVector m_flatRules;
228     Listener* m_listener;
229 };
230 
231 class InspectorStyleSheetForInlineStyle final : public InspectorStyleSheet {
232 public:
233     static Ref&lt;InspectorStyleSheetForInlineStyle&gt; create(InspectorPageAgent*, const String&amp; id, Ref&lt;StyledElement&gt;&amp;&amp;, Inspector::Protocol::CSS::StyleSheetOrigin, Listener*);
234 
235     void didModifyElementAttribute();
236     ExceptionOr&lt;String&gt; text() const final;
237     CSSStyleDeclaration* styleForId(const InspectorCSSId&amp; id) const final { ASSERT_UNUSED(id, !id.ordinal()); return &amp;inlineStyle(); }
238 
239 protected:
240     InspectorStyleSheetForInlineStyle(InspectorPageAgent*, const String&amp; id, Ref&lt;StyledElement&gt;&amp;&amp;, Inspector::Protocol::CSS::StyleSheetOrigin, Listener*);
241 
242     Document* ownerDocument() const final;
243     RefPtr&lt;CSSRuleSourceData&gt; ruleSourceDataFor(CSSStyleDeclaration* style) const final { ASSERT_UNUSED(style, style == &amp;inlineStyle()); return m_ruleSourceData; }
244     unsigned ruleIndexByStyle(CSSStyleDeclaration*) const final { return 0; }
245     bool ensureParsedDataReady() final;
246     RefPtr&lt;InspectorStyle&gt; inspectorStyleForId(const InspectorCSSId&amp;) final;
247 
248     // Also accessed by friend class InspectorStyle.
249     ExceptionOr&lt;void&gt; setStyleText(CSSStyleDeclaration*, const String&amp;) final;
250     Vector&lt;size_t&gt; lineEndings() const final;
251 
252 private:
253     CSSStyleDeclaration&amp; inlineStyle() const;
254     const String&amp; elementStyleText() const;
255     Ref&lt;CSSRuleSourceData&gt; ruleSourceData() const;
256 
257     Ref&lt;StyledElement&gt; m_element;
258     RefPtr&lt;CSSRuleSourceData&gt; m_ruleSourceData;
259     RefPtr&lt;InspectorStyle&gt; m_inspectorStyle;
260 
261     // Contains &quot;style&quot; attribute value.
262     mutable String m_styleText;
263     mutable bool m_isStyleTextValid;
264 };
265 
266 } // namespace WebCore
<a name="3" id="anc3"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="3" type="hidden" />
</body>
</html>