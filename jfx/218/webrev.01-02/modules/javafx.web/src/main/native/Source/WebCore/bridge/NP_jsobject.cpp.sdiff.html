<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WebCore/bridge/NP_jsobject.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../bindings/scripts/preprocess-idls.pl.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="c/CRuntimeObject.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/bridge/NP_jsobject.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 93     };
 94     RootObjectInvalidationCallback m_invalidationCallback;
 95 
 96     // JSObjects are protected by RootObject.
 97     typedef HashMap&lt;JSObject*, NPObject*&gt; JSToNPObjectMap;
 98     HashMap&lt;RootObject*, JSToNPObjectMap&gt; m_map;
 99 };
100 
101 
102 static ObjectMap&amp; objectMap()
103 {
104     static NeverDestroyed&lt;ObjectMap&gt; map;
105     return map;
106 }
107 
108 void ObjectMap::RootObjectInvalidationCallback::operator()(RootObject* rootObject)
109 {
110     objectMap().remove(rootObject);
111 }
112 
<span class="line-modified">113 static void getListFromVariantArgs(ExecState* exec, const NPVariant* args, unsigned argCount, RootObject* rootObject, MarkedArgumentBuffer&amp; aList)</span>
114 {
115     for (unsigned i = 0; i &lt; argCount; ++i)
<span class="line-modified">116         aList.append(convertNPVariantToValue(exec, &amp;args[i], rootObject));</span>
117 }
118 
119 static NPObject* jsAllocate(NPP, NPClass*)
120 {
121     return static_cast&lt;NPObject*&gt;(malloc(sizeof(JavaScriptObject)));
122 }
123 
124 static void jsDeallocate(NPObject* npObj)
125 {
126     JavaScriptObject* obj = reinterpret_cast&lt;JavaScriptObject*&gt;(npObj);
127 
128     if (obj-&gt;rootObject &amp;&amp; obj-&gt;rootObject-&gt;isValid()) {
129         objectMap().remove(obj-&gt;rootObject, obj-&gt;imp);
130         obj-&gt;rootObject-&gt;gcUnprotect(obj-&gt;imp);
131     }
132 
133     if (obj-&gt;rootObject)
134         obj-&gt;rootObject-&gt;deref();
135 
136     free(obj);
</pre>
<hr />
<pre>
167     return _NPN_CreateObject(0, NPNoScriptObjectClass);
168 }
169 
170 bool _NPN_InvokeDefault(NPP, NPObject* o, const NPVariant* args, uint32_t argCount, NPVariant* result)
171 {
172     if (o-&gt;_class == NPScriptObjectClass) {
173         JavaScriptObject* obj = reinterpret_cast&lt;JavaScriptObject*&gt;(o);
174 
175         VOID_TO_NPVARIANT(*result);
176 
177         // Lookup the function object.
178         RootObject* rootObject = obj-&gt;rootObject;
179         if (!rootObject || !rootObject-&gt;isValid())
180             return false;
181 
182         auto globalObject = rootObject-&gt;globalObject();
183         VM&amp; vm = globalObject-&gt;vm();
184         JSLockHolder lock(vm);
185         auto scope = DECLARE_CATCH_SCOPE(vm);
186 
<span class="line-modified">187         ExecState* exec = globalObject-&gt;globalExec();</span>
188 
189         // Call the function object.
190         JSValue function = obj-&gt;imp;
191         CallData callData;
192         CallType callType = getCallData(vm, function, callData);
193         if (callType == CallType::None)
194             return false;
195 
196         MarkedArgumentBuffer argList;
<span class="line-modified">197         getListFromVariantArgs(exec, args, argCount, rootObject, argList);</span>
198         RELEASE_ASSERT(!argList.hasOverflowed());
<span class="line-modified">199         JSValue resultV = JSC::call(exec, function, callType, callData, function, argList);</span>
200 
201         // Convert and return the result of the function call.
<span class="line-modified">202         convertValueToNPVariant(exec, resultV, result);</span>
203         scope.clearException();
204         return true;
205     }
206 
207     if (o-&gt;_class-&gt;invokeDefault)
208         return o-&gt;_class-&gt;invokeDefault(o, args, argCount, result);
209     VOID_TO_NPVARIANT(*result);
210     return true;
211 }
212 
213 bool _NPN_Invoke(NPP npp, NPObject* o, NPIdentifier methodName, const NPVariant* args, uint32_t argCount, NPVariant* result)
214 {
215     if (o-&gt;_class == NPScriptObjectClass) {
216         JavaScriptObject* obj = reinterpret_cast&lt;JavaScriptObject*&gt;(o);
217 
218         IdentifierRep* i = static_cast&lt;IdentifierRep*&gt;(methodName);
219         if (!i-&gt;isString())
220             return false;
221 
222         // Special case the &quot;eval&quot; method.
223         if (methodName == _NPN_GetStringIdentifier(&quot;eval&quot;)) {
224             if (argCount != 1)
225                 return false;
226             if (args[0].type != NPVariantType_String)
227                 return false;
228             return _NPN_Evaluate(npp, o, const_cast&lt;NPString*&gt;(&amp;args[0].value.stringValue), result);
229         }
230 
231         // Look up the function object.
232         RootObject* rootObject = obj-&gt;rootObject;
233         if (!rootObject || !rootObject-&gt;isValid())
234             return false;
235 
236         auto globalObject = rootObject-&gt;globalObject();
237         VM&amp; vm = globalObject-&gt;vm();
238         JSLockHolder lock(vm);
239         auto scope = DECLARE_CATCH_SCOPE(vm);
240 
<span class="line-modified">241         ExecState* exec = globalObject-&gt;globalExec();</span>
<span class="line-modified">242         JSValue function = obj-&gt;imp-&gt;get(exec, identifierFromNPIdentifier(exec, i-&gt;string()));</span>
243         CallData callData;
244         CallType callType = getCallData(vm, function, callData);
245         if (callType == CallType::None)
246             return false;
247 
248         // Call the function object.
249         MarkedArgumentBuffer argList;
<span class="line-modified">250         getListFromVariantArgs(exec, args, argCount, rootObject, argList);</span>
251         RELEASE_ASSERT(!argList.hasOverflowed());
<span class="line-modified">252         JSValue resultV = JSC::call(exec, function, callType, callData, obj-&gt;imp, argList);</span>
253 
254         // Convert and return the result of the function call.
<span class="line-modified">255         convertValueToNPVariant(exec, resultV, result);</span>
256         scope.clearException();
257         return true;
258     }
259 
260     if (o-&gt;_class-&gt;invoke)
261         return o-&gt;_class-&gt;invoke(o, methodName, args, argCount, result);
262 
263     VOID_TO_NPVARIANT(*result);
264     return true;
265 }
266 
267 bool _NPN_Evaluate(NPP, NPObject* o, NPString* s, NPVariant* variant)
268 {
269     if (o-&gt;_class == NPScriptObjectClass) {
270         JavaScriptObject* obj = reinterpret_cast&lt;JavaScriptObject*&gt;(o);
271 
272         RootObject* rootObject = obj-&gt;rootObject;
273         if (!rootObject || !rootObject-&gt;isValid())
274             return false;
275 
276         auto globalObject = rootObject-&gt;globalObject();
277         VM&amp; vm = globalObject-&gt;vm();
278         JSLockHolder lock(vm);
279         auto scope = DECLARE_CATCH_SCOPE(vm);
280 
<span class="line-modified">281         ExecState* exec = globalObject-&gt;globalExec();</span>
282         String scriptString = convertNPStringToUTF16(s);
283 
<span class="line-modified">284         JSValue returnValue = JSC::evaluate(exec, JSC::makeSource(scriptString, { }), JSC::JSValue());</span>
285 
<span class="line-modified">286         convertValueToNPVariant(exec, returnValue, variant);</span>
287         scope.clearException();
288         return true;
289     }
290 
291     VOID_TO_NPVARIANT(*variant);
292     return false;
293 }
294 
295 bool _NPN_GetProperty(NPP, NPObject* o, NPIdentifier propertyName, NPVariant* variant)
296 {
297     if (o-&gt;_class == NPScriptObjectClass) {
298         JavaScriptObject* obj = reinterpret_cast&lt;JavaScriptObject*&gt;(o);
299 
300         RootObject* rootObject = obj-&gt;rootObject;
301         if (!rootObject || !rootObject-&gt;isValid())
302             return false;
303 
304         auto globalObject = rootObject-&gt;globalObject();
305         VM&amp; vm = globalObject-&gt;vm();
306         JSLockHolder lock(vm);
307         auto scope = DECLARE_CATCH_SCOPE(vm);
308 
<span class="line-modified">309         ExecState* exec = globalObject-&gt;globalExec();</span>
310         IdentifierRep* i = static_cast&lt;IdentifierRep*&gt;(propertyName);
311 
312         JSValue result;
313         if (i-&gt;isString())
<span class="line-modified">314             result = obj-&gt;imp-&gt;get(exec, identifierFromNPIdentifier(exec, i-&gt;string()));</span>
315         else
<span class="line-modified">316             result = obj-&gt;imp-&gt;get(exec, i-&gt;number());</span>
317 
<span class="line-modified">318         convertValueToNPVariant(exec, result, variant);</span>
319         scope.clearException();
320         return true;
321     }
322 
323     if (o-&gt;_class-&gt;hasProperty &amp;&amp; o-&gt;_class-&gt;getProperty) {
324         if (o-&gt;_class-&gt;hasProperty(o, propertyName))
325             return o-&gt;_class-&gt;getProperty(o, propertyName, variant);
326         return false;
327     }
328 
329     VOID_TO_NPVARIANT(*variant);
330     return false;
331 }
332 
333 bool _NPN_SetProperty(NPP, NPObject* o, NPIdentifier propertyName, const NPVariant* variant)
334 {
335     if (o-&gt;_class == NPScriptObjectClass) {
336         JavaScriptObject* obj = reinterpret_cast&lt;JavaScriptObject*&gt;(o);
337 
338         RootObject* rootObject = obj-&gt;rootObject;
339         if (!rootObject || !rootObject-&gt;isValid())
340             return false;
341 
342         auto globalObject = rootObject-&gt;globalObject();
343         VM&amp; vm = globalObject-&gt;vm();
344         JSLockHolder lock(vm);
345         auto scope = DECLARE_CATCH_SCOPE(vm);
346 
<span class="line-modified">347         ExecState* exec = globalObject-&gt;globalExec();</span>
348         IdentifierRep* i = static_cast&lt;IdentifierRep*&gt;(propertyName);
349 
350         if (i-&gt;isString()) {
351             PutPropertySlot slot(obj-&gt;imp);
<span class="line-modified">352             obj-&gt;imp-&gt;methodTable(vm)-&gt;put(obj-&gt;imp, exec, identifierFromNPIdentifier(exec, i-&gt;string()), convertNPVariantToValue(exec, variant, rootObject), slot);</span>
353         } else
<span class="line-modified">354             obj-&gt;imp-&gt;methodTable(vm)-&gt;putByIndex(obj-&gt;imp, exec, i-&gt;number(), convertNPVariantToValue(exec, variant, rootObject), false);</span>
355         scope.clearException();
356         return true;
357     }
358 
359     if (o-&gt;_class-&gt;setProperty)
360         return o-&gt;_class-&gt;setProperty(o, propertyName, variant);
361 
362     return false;
363 }
364 
365 bool _NPN_RemoveProperty(NPP, NPObject* o, NPIdentifier propertyName)
366 {
367     if (o-&gt;_class == NPScriptObjectClass) {
368         JavaScriptObject* obj = reinterpret_cast&lt;JavaScriptObject*&gt;(o);
369 
370         RootObject* rootObject = obj-&gt;rootObject;
371         if (!rootObject || !rootObject-&gt;isValid())
372             return false;
373 
374         auto globalObject = rootObject-&gt;globalObject();
375         VM&amp; vm = globalObject-&gt;vm();
376         JSLockHolder lock(vm);
377         auto scope = DECLARE_CATCH_SCOPE(vm);
378 
<span class="line-modified">379         ExecState* exec = globalObject-&gt;globalExec();</span>
380 
381         IdentifierRep* i = static_cast&lt;IdentifierRep*&gt;(propertyName);
382         if (i-&gt;isString()) {
<span class="line-modified">383             if (!obj-&gt;imp-&gt;hasProperty(exec, identifierFromNPIdentifier(exec, i-&gt;string()))) {</span>
384                 scope.clearException();
385                 return false;
386             }
387         } else {
<span class="line-modified">388             if (!obj-&gt;imp-&gt;hasProperty(exec, i-&gt;number())) {</span>
389                 scope.clearException();
390                 return false;
391             }
392         }
393 
394         if (i-&gt;isString())
<span class="line-modified">395             obj-&gt;imp-&gt;methodTable(vm)-&gt;deleteProperty(obj-&gt;imp, exec, identifierFromNPIdentifier(exec, i-&gt;string()));</span>
396         else
<span class="line-modified">397             obj-&gt;imp-&gt;methodTable(vm)-&gt;deletePropertyByIndex(obj-&gt;imp, exec, i-&gt;number());</span>
398 
399         scope.clearException();
400         return true;
401     }
402     return false;
403 }
404 
405 bool _NPN_HasProperty(NPP, NPObject* o, NPIdentifier propertyName)
406 {
407     if (o-&gt;_class == NPScriptObjectClass) {
408         JavaScriptObject* obj = reinterpret_cast&lt;JavaScriptObject*&gt;(o);
409 
410         RootObject* rootObject = obj-&gt;rootObject;
411         if (!rootObject || !rootObject-&gt;isValid())
412             return false;
413 
414         auto globalObject = rootObject-&gt;globalObject();
415         VM&amp; vm = globalObject-&gt;vm();
416         JSLockHolder lock(vm);
417         auto scope = DECLARE_CATCH_SCOPE(vm);
418 
<span class="line-modified">419         ExecState* exec = globalObject-&gt;globalExec();</span>
420         IdentifierRep* i = static_cast&lt;IdentifierRep*&gt;(propertyName);
421         if (i-&gt;isString()) {
<span class="line-modified">422             bool result = obj-&gt;imp-&gt;hasProperty(exec, identifierFromNPIdentifier(exec, i-&gt;string()));</span>
423             scope.clearException();
424             return result;
425         }
426 
<span class="line-modified">427         bool result = obj-&gt;imp-&gt;hasProperty(exec, i-&gt;number());</span>
428         scope.clearException();
429         return result;
430     }
431 
432     if (o-&gt;_class-&gt;hasProperty)
433         return o-&gt;_class-&gt;hasProperty(o, propertyName);
434 
435     return false;
436 }
437 
438 bool _NPN_HasMethod(NPP, NPObject* o, NPIdentifier methodName)
439 {
440     if (o-&gt;_class == NPScriptObjectClass) {
441         JavaScriptObject* obj = reinterpret_cast&lt;JavaScriptObject*&gt;(o);
442 
443         IdentifierRep* i = static_cast&lt;IdentifierRep*&gt;(methodName);
444         if (!i-&gt;isString())
445             return false;
446 
447         RootObject* rootObject = obj-&gt;rootObject;
448         if (!rootObject || !rootObject-&gt;isValid())
449             return false;
450 
451         auto globalObject = rootObject-&gt;globalObject();
452         VM&amp; vm = globalObject-&gt;vm();
453         JSLockHolder lock(vm);
454         auto scope = DECLARE_CATCH_SCOPE(vm);
455 
<span class="line-modified">456         ExecState* exec = globalObject-&gt;globalExec();</span>
<span class="line-modified">457         JSValue func = obj-&gt;imp-&gt;get(exec, identifierFromNPIdentifier(exec, i-&gt;string()));</span>
458         scope.clearException();
459         return !func.isUndefined();
460     }
461 
462     if (o-&gt;_class-&gt;hasMethod)
463         return o-&gt;_class-&gt;hasMethod(o, methodName);
464 
465     return false;
466 }
467 
468 void _NPN_SetException(NPObject*, const NPUTF8* message)
469 {
470     // Ignoring the NPObject param is consistent with the Mozilla implementation.
471     String exception(message);
472     CInstance::setGlobalException(exception);
473 }
474 
475 bool _NPN_Enumerate(NPP, NPObject* o, NPIdentifier** identifier, uint32_t* count)
476 {
477     if (o-&gt;_class == NPScriptObjectClass) {
478         JavaScriptObject* obj = reinterpret_cast&lt;JavaScriptObject*&gt;(o);
479 
480         RootObject* rootObject = obj-&gt;rootObject;
481         if (!rootObject || !rootObject-&gt;isValid())
482             return false;
483 
484         auto globalObject = rootObject-&gt;globalObject();
485         VM&amp; vm = globalObject-&gt;vm();
486         JSLockHolder lock(vm);
487         auto scope = DECLARE_CATCH_SCOPE(vm);
488 
<span class="line-modified">489         ExecState* exec = globalObject-&gt;globalExec();</span>
490         PropertyNameArray propertyNames(vm, PropertyNameMode::Strings, PrivateSymbolMode::Exclude);
491 
<span class="line-modified">492         obj-&gt;imp-&gt;methodTable(vm)-&gt;getPropertyNames(obj-&gt;imp, exec, propertyNames, EnumerationMode());</span>
493         unsigned size = static_cast&lt;unsigned&gt;(propertyNames.size());
494         // FIXME: This should really call NPN_MemAlloc but that&#39;s in WebKit
495         NPIdentifier* identifiers = static_cast&lt;NPIdentifier*&gt;(malloc(sizeof(NPIdentifier) * size));
496 
497         for (unsigned i = 0; i &lt; size; ++i)
498             identifiers[i] = _NPN_GetStringIdentifier(propertyNames[i].string().utf8().data());
499 
500         *identifier = identifiers;
501         *count = size;
502 
503         scope.clearException();
504         return true;
505     }
506 
507     if (NP_CLASS_STRUCT_VERSION_HAS_ENUM(o-&gt;_class) &amp;&amp; o-&gt;_class-&gt;enumerate)
508         return o-&gt;_class-&gt;enumerate(o, identifier, count);
509 
510     return false;
511 }
512 
513 bool _NPN_Construct(NPP, NPObject* o, const NPVariant* args, uint32_t argCount, NPVariant* result)
514 {
515     if (o-&gt;_class == NPScriptObjectClass) {
516         JavaScriptObject* obj = reinterpret_cast&lt;JavaScriptObject*&gt;(o);
517 
518         VOID_TO_NPVARIANT(*result);
519 
520         // Lookup the constructor object.
521         RootObject* rootObject = obj-&gt;rootObject;
522         if (!rootObject || !rootObject-&gt;isValid())
523             return false;
524 
525         auto globalObject = rootObject-&gt;globalObject();
526         VM&amp; vm = globalObject-&gt;vm();
527         JSLockHolder lock(vm);
528         auto scope = DECLARE_CATCH_SCOPE(vm);
529 
<span class="line-modified">530         ExecState* exec = globalObject-&gt;globalExec();</span>
531 
532         // Call the constructor object.
533         JSValue constructor = obj-&gt;imp;
534         ConstructData constructData;
535         ConstructType constructType = getConstructData(vm, constructor, constructData);
536         if (constructType == ConstructType::None)
537             return false;
538 
539         MarkedArgumentBuffer argList;
<span class="line-modified">540         getListFromVariantArgs(exec, args, argCount, rootObject, argList);</span>
541         RELEASE_ASSERT(!argList.hasOverflowed());
<span class="line-modified">542         JSValue resultV = JSC::construct(exec, constructor, constructType, constructData, argList);</span>
543 
544         // Convert and return the result.
<span class="line-modified">545         convertValueToNPVariant(exec, resultV, result);</span>
546         scope.clearException();
547         return true;
548     }
549 
550     if (NP_CLASS_STRUCT_VERSION_HAS_CTOR(o-&gt;_class) &amp;&amp; o-&gt;_class-&gt;construct)
551         return o-&gt;_class-&gt;construct(o, args, argCount, result);
552 
553     return false;
554 }
555 
556 } // extern &quot;C&quot;
557 
558 } // namespace JSC
559 
560 #endif // ENABLE(NETSCAPE_PLUGIN_API)
</pre>
</td>
<td>
<hr />
<pre>
 93     };
 94     RootObjectInvalidationCallback m_invalidationCallback;
 95 
 96     // JSObjects are protected by RootObject.
 97     typedef HashMap&lt;JSObject*, NPObject*&gt; JSToNPObjectMap;
 98     HashMap&lt;RootObject*, JSToNPObjectMap&gt; m_map;
 99 };
100 
101 
102 static ObjectMap&amp; objectMap()
103 {
104     static NeverDestroyed&lt;ObjectMap&gt; map;
105     return map;
106 }
107 
108 void ObjectMap::RootObjectInvalidationCallback::operator()(RootObject* rootObject)
109 {
110     objectMap().remove(rootObject);
111 }
112 
<span class="line-modified">113 static void getListFromVariantArgs(JSGlobalObject* lexicalGlobalObject, const NPVariant* args, unsigned argCount, RootObject* rootObject, MarkedArgumentBuffer&amp; aList)</span>
114 {
115     for (unsigned i = 0; i &lt; argCount; ++i)
<span class="line-modified">116         aList.append(convertNPVariantToValue(lexicalGlobalObject, &amp;args[i], rootObject));</span>
117 }
118 
119 static NPObject* jsAllocate(NPP, NPClass*)
120 {
121     return static_cast&lt;NPObject*&gt;(malloc(sizeof(JavaScriptObject)));
122 }
123 
124 static void jsDeallocate(NPObject* npObj)
125 {
126     JavaScriptObject* obj = reinterpret_cast&lt;JavaScriptObject*&gt;(npObj);
127 
128     if (obj-&gt;rootObject &amp;&amp; obj-&gt;rootObject-&gt;isValid()) {
129         objectMap().remove(obj-&gt;rootObject, obj-&gt;imp);
130         obj-&gt;rootObject-&gt;gcUnprotect(obj-&gt;imp);
131     }
132 
133     if (obj-&gt;rootObject)
134         obj-&gt;rootObject-&gt;deref();
135 
136     free(obj);
</pre>
<hr />
<pre>
167     return _NPN_CreateObject(0, NPNoScriptObjectClass);
168 }
169 
170 bool _NPN_InvokeDefault(NPP, NPObject* o, const NPVariant* args, uint32_t argCount, NPVariant* result)
171 {
172     if (o-&gt;_class == NPScriptObjectClass) {
173         JavaScriptObject* obj = reinterpret_cast&lt;JavaScriptObject*&gt;(o);
174 
175         VOID_TO_NPVARIANT(*result);
176 
177         // Lookup the function object.
178         RootObject* rootObject = obj-&gt;rootObject;
179         if (!rootObject || !rootObject-&gt;isValid())
180             return false;
181 
182         auto globalObject = rootObject-&gt;globalObject();
183         VM&amp; vm = globalObject-&gt;vm();
184         JSLockHolder lock(vm);
185         auto scope = DECLARE_CATCH_SCOPE(vm);
186 
<span class="line-modified">187         JSGlobalObject* lexicalGlobalObject = globalObject;</span>
188 
189         // Call the function object.
190         JSValue function = obj-&gt;imp;
191         CallData callData;
192         CallType callType = getCallData(vm, function, callData);
193         if (callType == CallType::None)
194             return false;
195 
196         MarkedArgumentBuffer argList;
<span class="line-modified">197         getListFromVariantArgs(lexicalGlobalObject, args, argCount, rootObject, argList);</span>
198         RELEASE_ASSERT(!argList.hasOverflowed());
<span class="line-modified">199         JSValue resultV = JSC::call(lexicalGlobalObject, function, callType, callData, function, argList);</span>
200 
201         // Convert and return the result of the function call.
<span class="line-modified">202         convertValueToNPVariant(lexicalGlobalObject, resultV, result);</span>
203         scope.clearException();
204         return true;
205     }
206 
207     if (o-&gt;_class-&gt;invokeDefault)
208         return o-&gt;_class-&gt;invokeDefault(o, args, argCount, result);
209     VOID_TO_NPVARIANT(*result);
210     return true;
211 }
212 
213 bool _NPN_Invoke(NPP npp, NPObject* o, NPIdentifier methodName, const NPVariant* args, uint32_t argCount, NPVariant* result)
214 {
215     if (o-&gt;_class == NPScriptObjectClass) {
216         JavaScriptObject* obj = reinterpret_cast&lt;JavaScriptObject*&gt;(o);
217 
218         IdentifierRep* i = static_cast&lt;IdentifierRep*&gt;(methodName);
219         if (!i-&gt;isString())
220             return false;
221 
222         // Special case the &quot;eval&quot; method.
223         if (methodName == _NPN_GetStringIdentifier(&quot;eval&quot;)) {
224             if (argCount != 1)
225                 return false;
226             if (args[0].type != NPVariantType_String)
227                 return false;
228             return _NPN_Evaluate(npp, o, const_cast&lt;NPString*&gt;(&amp;args[0].value.stringValue), result);
229         }
230 
231         // Look up the function object.
232         RootObject* rootObject = obj-&gt;rootObject;
233         if (!rootObject || !rootObject-&gt;isValid())
234             return false;
235 
236         auto globalObject = rootObject-&gt;globalObject();
237         VM&amp; vm = globalObject-&gt;vm();
238         JSLockHolder lock(vm);
239         auto scope = DECLARE_CATCH_SCOPE(vm);
240 
<span class="line-modified">241         JSGlobalObject* lexicalGlobalObject = globalObject;</span>
<span class="line-modified">242         JSValue function = obj-&gt;imp-&gt;get(lexicalGlobalObject, identifierFromNPIdentifier(lexicalGlobalObject, i-&gt;string()));</span>
243         CallData callData;
244         CallType callType = getCallData(vm, function, callData);
245         if (callType == CallType::None)
246             return false;
247 
248         // Call the function object.
249         MarkedArgumentBuffer argList;
<span class="line-modified">250         getListFromVariantArgs(lexicalGlobalObject, args, argCount, rootObject, argList);</span>
251         RELEASE_ASSERT(!argList.hasOverflowed());
<span class="line-modified">252         JSValue resultV = JSC::call(lexicalGlobalObject, function, callType, callData, obj-&gt;imp, argList);</span>
253 
254         // Convert and return the result of the function call.
<span class="line-modified">255         convertValueToNPVariant(lexicalGlobalObject, resultV, result);</span>
256         scope.clearException();
257         return true;
258     }
259 
260     if (o-&gt;_class-&gt;invoke)
261         return o-&gt;_class-&gt;invoke(o, methodName, args, argCount, result);
262 
263     VOID_TO_NPVARIANT(*result);
264     return true;
265 }
266 
267 bool _NPN_Evaluate(NPP, NPObject* o, NPString* s, NPVariant* variant)
268 {
269     if (o-&gt;_class == NPScriptObjectClass) {
270         JavaScriptObject* obj = reinterpret_cast&lt;JavaScriptObject*&gt;(o);
271 
272         RootObject* rootObject = obj-&gt;rootObject;
273         if (!rootObject || !rootObject-&gt;isValid())
274             return false;
275 
276         auto globalObject = rootObject-&gt;globalObject();
277         VM&amp; vm = globalObject-&gt;vm();
278         JSLockHolder lock(vm);
279         auto scope = DECLARE_CATCH_SCOPE(vm);
280 
<span class="line-modified">281         JSGlobalObject* lexicalGlobalObject = globalObject;</span>
282         String scriptString = convertNPStringToUTF16(s);
283 
<span class="line-modified">284         JSValue returnValue = JSC::evaluate(lexicalGlobalObject, JSC::makeSource(scriptString, { }), JSC::JSValue());</span>
285 
<span class="line-modified">286         convertValueToNPVariant(lexicalGlobalObject, returnValue, variant);</span>
287         scope.clearException();
288         return true;
289     }
290 
291     VOID_TO_NPVARIANT(*variant);
292     return false;
293 }
294 
295 bool _NPN_GetProperty(NPP, NPObject* o, NPIdentifier propertyName, NPVariant* variant)
296 {
297     if (o-&gt;_class == NPScriptObjectClass) {
298         JavaScriptObject* obj = reinterpret_cast&lt;JavaScriptObject*&gt;(o);
299 
300         RootObject* rootObject = obj-&gt;rootObject;
301         if (!rootObject || !rootObject-&gt;isValid())
302             return false;
303 
304         auto globalObject = rootObject-&gt;globalObject();
305         VM&amp; vm = globalObject-&gt;vm();
306         JSLockHolder lock(vm);
307         auto scope = DECLARE_CATCH_SCOPE(vm);
308 
<span class="line-modified">309         JSGlobalObject* lexicalGlobalObject = globalObject;</span>
310         IdentifierRep* i = static_cast&lt;IdentifierRep*&gt;(propertyName);
311 
312         JSValue result;
313         if (i-&gt;isString())
<span class="line-modified">314             result = obj-&gt;imp-&gt;get(lexicalGlobalObject, identifierFromNPIdentifier(lexicalGlobalObject, i-&gt;string()));</span>
315         else
<span class="line-modified">316             result = obj-&gt;imp-&gt;get(lexicalGlobalObject, i-&gt;number());</span>
317 
<span class="line-modified">318         convertValueToNPVariant(lexicalGlobalObject, result, variant);</span>
319         scope.clearException();
320         return true;
321     }
322 
323     if (o-&gt;_class-&gt;hasProperty &amp;&amp; o-&gt;_class-&gt;getProperty) {
324         if (o-&gt;_class-&gt;hasProperty(o, propertyName))
325             return o-&gt;_class-&gt;getProperty(o, propertyName, variant);
326         return false;
327     }
328 
329     VOID_TO_NPVARIANT(*variant);
330     return false;
331 }
332 
333 bool _NPN_SetProperty(NPP, NPObject* o, NPIdentifier propertyName, const NPVariant* variant)
334 {
335     if (o-&gt;_class == NPScriptObjectClass) {
336         JavaScriptObject* obj = reinterpret_cast&lt;JavaScriptObject*&gt;(o);
337 
338         RootObject* rootObject = obj-&gt;rootObject;
339         if (!rootObject || !rootObject-&gt;isValid())
340             return false;
341 
342         auto globalObject = rootObject-&gt;globalObject();
343         VM&amp; vm = globalObject-&gt;vm();
344         JSLockHolder lock(vm);
345         auto scope = DECLARE_CATCH_SCOPE(vm);
346 
<span class="line-modified">347         JSGlobalObject* lexicalGlobalObject = globalObject;</span>
348         IdentifierRep* i = static_cast&lt;IdentifierRep*&gt;(propertyName);
349 
350         if (i-&gt;isString()) {
351             PutPropertySlot slot(obj-&gt;imp);
<span class="line-modified">352             obj-&gt;imp-&gt;methodTable(vm)-&gt;put(obj-&gt;imp, lexicalGlobalObject, identifierFromNPIdentifier(lexicalGlobalObject, i-&gt;string()), convertNPVariantToValue(lexicalGlobalObject, variant, rootObject), slot);</span>
353         } else
<span class="line-modified">354             obj-&gt;imp-&gt;methodTable(vm)-&gt;putByIndex(obj-&gt;imp, lexicalGlobalObject, i-&gt;number(), convertNPVariantToValue(lexicalGlobalObject, variant, rootObject), false);</span>
355         scope.clearException();
356         return true;
357     }
358 
359     if (o-&gt;_class-&gt;setProperty)
360         return o-&gt;_class-&gt;setProperty(o, propertyName, variant);
361 
362     return false;
363 }
364 
365 bool _NPN_RemoveProperty(NPP, NPObject* o, NPIdentifier propertyName)
366 {
367     if (o-&gt;_class == NPScriptObjectClass) {
368         JavaScriptObject* obj = reinterpret_cast&lt;JavaScriptObject*&gt;(o);
369 
370         RootObject* rootObject = obj-&gt;rootObject;
371         if (!rootObject || !rootObject-&gt;isValid())
372             return false;
373 
374         auto globalObject = rootObject-&gt;globalObject();
375         VM&amp; vm = globalObject-&gt;vm();
376         JSLockHolder lock(vm);
377         auto scope = DECLARE_CATCH_SCOPE(vm);
378 
<span class="line-modified">379         JSGlobalObject* lexicalGlobalObject = globalObject;</span>
380 
381         IdentifierRep* i = static_cast&lt;IdentifierRep*&gt;(propertyName);
382         if (i-&gt;isString()) {
<span class="line-modified">383             if (!obj-&gt;imp-&gt;hasProperty(lexicalGlobalObject, identifierFromNPIdentifier(lexicalGlobalObject, i-&gt;string()))) {</span>
384                 scope.clearException();
385                 return false;
386             }
387         } else {
<span class="line-modified">388             if (!obj-&gt;imp-&gt;hasProperty(lexicalGlobalObject, i-&gt;number())) {</span>
389                 scope.clearException();
390                 return false;
391             }
392         }
393 
394         if (i-&gt;isString())
<span class="line-modified">395             obj-&gt;imp-&gt;methodTable(vm)-&gt;deleteProperty(obj-&gt;imp, lexicalGlobalObject, identifierFromNPIdentifier(lexicalGlobalObject, i-&gt;string()));</span>
396         else
<span class="line-modified">397             obj-&gt;imp-&gt;methodTable(vm)-&gt;deletePropertyByIndex(obj-&gt;imp, lexicalGlobalObject, i-&gt;number());</span>
398 
399         scope.clearException();
400         return true;
401     }
402     return false;
403 }
404 
405 bool _NPN_HasProperty(NPP, NPObject* o, NPIdentifier propertyName)
406 {
407     if (o-&gt;_class == NPScriptObjectClass) {
408         JavaScriptObject* obj = reinterpret_cast&lt;JavaScriptObject*&gt;(o);
409 
410         RootObject* rootObject = obj-&gt;rootObject;
411         if (!rootObject || !rootObject-&gt;isValid())
412             return false;
413 
414         auto globalObject = rootObject-&gt;globalObject();
415         VM&amp; vm = globalObject-&gt;vm();
416         JSLockHolder lock(vm);
417         auto scope = DECLARE_CATCH_SCOPE(vm);
418 
<span class="line-modified">419         JSGlobalObject* lexicalGlobalObject = globalObject;</span>
420         IdentifierRep* i = static_cast&lt;IdentifierRep*&gt;(propertyName);
421         if (i-&gt;isString()) {
<span class="line-modified">422             bool result = obj-&gt;imp-&gt;hasProperty(lexicalGlobalObject, identifierFromNPIdentifier(lexicalGlobalObject, i-&gt;string()));</span>
423             scope.clearException();
424             return result;
425         }
426 
<span class="line-modified">427         bool result = obj-&gt;imp-&gt;hasProperty(lexicalGlobalObject, i-&gt;number());</span>
428         scope.clearException();
429         return result;
430     }
431 
432     if (o-&gt;_class-&gt;hasProperty)
433         return o-&gt;_class-&gt;hasProperty(o, propertyName);
434 
435     return false;
436 }
437 
438 bool _NPN_HasMethod(NPP, NPObject* o, NPIdentifier methodName)
439 {
440     if (o-&gt;_class == NPScriptObjectClass) {
441         JavaScriptObject* obj = reinterpret_cast&lt;JavaScriptObject*&gt;(o);
442 
443         IdentifierRep* i = static_cast&lt;IdentifierRep*&gt;(methodName);
444         if (!i-&gt;isString())
445             return false;
446 
447         RootObject* rootObject = obj-&gt;rootObject;
448         if (!rootObject || !rootObject-&gt;isValid())
449             return false;
450 
451         auto globalObject = rootObject-&gt;globalObject();
452         VM&amp; vm = globalObject-&gt;vm();
453         JSLockHolder lock(vm);
454         auto scope = DECLARE_CATCH_SCOPE(vm);
455 
<span class="line-modified">456         JSGlobalObject* lexicalGlobalObject = globalObject;</span>
<span class="line-modified">457         JSValue func = obj-&gt;imp-&gt;get(lexicalGlobalObject, identifierFromNPIdentifier(lexicalGlobalObject, i-&gt;string()));</span>
458         scope.clearException();
459         return !func.isUndefined();
460     }
461 
462     if (o-&gt;_class-&gt;hasMethod)
463         return o-&gt;_class-&gt;hasMethod(o, methodName);
464 
465     return false;
466 }
467 
468 void _NPN_SetException(NPObject*, const NPUTF8* message)
469 {
470     // Ignoring the NPObject param is consistent with the Mozilla implementation.
471     String exception(message);
472     CInstance::setGlobalException(exception);
473 }
474 
475 bool _NPN_Enumerate(NPP, NPObject* o, NPIdentifier** identifier, uint32_t* count)
476 {
477     if (o-&gt;_class == NPScriptObjectClass) {
478         JavaScriptObject* obj = reinterpret_cast&lt;JavaScriptObject*&gt;(o);
479 
480         RootObject* rootObject = obj-&gt;rootObject;
481         if (!rootObject || !rootObject-&gt;isValid())
482             return false;
483 
484         auto globalObject = rootObject-&gt;globalObject();
485         VM&amp; vm = globalObject-&gt;vm();
486         JSLockHolder lock(vm);
487         auto scope = DECLARE_CATCH_SCOPE(vm);
488 
<span class="line-modified">489         JSGlobalObject* lexicalGlobalObject = globalObject;</span>
490         PropertyNameArray propertyNames(vm, PropertyNameMode::Strings, PrivateSymbolMode::Exclude);
491 
<span class="line-modified">492         obj-&gt;imp-&gt;methodTable(vm)-&gt;getPropertyNames(obj-&gt;imp, lexicalGlobalObject, propertyNames, EnumerationMode());</span>
493         unsigned size = static_cast&lt;unsigned&gt;(propertyNames.size());
494         // FIXME: This should really call NPN_MemAlloc but that&#39;s in WebKit
495         NPIdentifier* identifiers = static_cast&lt;NPIdentifier*&gt;(malloc(sizeof(NPIdentifier) * size));
496 
497         for (unsigned i = 0; i &lt; size; ++i)
498             identifiers[i] = _NPN_GetStringIdentifier(propertyNames[i].string().utf8().data());
499 
500         *identifier = identifiers;
501         *count = size;
502 
503         scope.clearException();
504         return true;
505     }
506 
507     if (NP_CLASS_STRUCT_VERSION_HAS_ENUM(o-&gt;_class) &amp;&amp; o-&gt;_class-&gt;enumerate)
508         return o-&gt;_class-&gt;enumerate(o, identifier, count);
509 
510     return false;
511 }
512 
513 bool _NPN_Construct(NPP, NPObject* o, const NPVariant* args, uint32_t argCount, NPVariant* result)
514 {
515     if (o-&gt;_class == NPScriptObjectClass) {
516         JavaScriptObject* obj = reinterpret_cast&lt;JavaScriptObject*&gt;(o);
517 
518         VOID_TO_NPVARIANT(*result);
519 
520         // Lookup the constructor object.
521         RootObject* rootObject = obj-&gt;rootObject;
522         if (!rootObject || !rootObject-&gt;isValid())
523             return false;
524 
525         auto globalObject = rootObject-&gt;globalObject();
526         VM&amp; vm = globalObject-&gt;vm();
527         JSLockHolder lock(vm);
528         auto scope = DECLARE_CATCH_SCOPE(vm);
529 
<span class="line-modified">530         JSGlobalObject* lexicalGlobalObject = globalObject;</span>
531 
532         // Call the constructor object.
533         JSValue constructor = obj-&gt;imp;
534         ConstructData constructData;
535         ConstructType constructType = getConstructData(vm, constructor, constructData);
536         if (constructType == ConstructType::None)
537             return false;
538 
539         MarkedArgumentBuffer argList;
<span class="line-modified">540         getListFromVariantArgs(lexicalGlobalObject, args, argCount, rootObject, argList);</span>
541         RELEASE_ASSERT(!argList.hasOverflowed());
<span class="line-modified">542         JSValue resultV = JSC::construct(lexicalGlobalObject, constructor, constructType, constructData, argList);</span>
543 
544         // Convert and return the result.
<span class="line-modified">545         convertValueToNPVariant(lexicalGlobalObject, resultV, result);</span>
546         scope.clearException();
547         return true;
548     }
549 
550     if (NP_CLASS_STRUCT_VERSION_HAS_CTOR(o-&gt;_class) &amp;&amp; o-&gt;_class-&gt;construct)
551         return o-&gt;_class-&gt;construct(o, args, argCount, result);
552 
553     return false;
554 }
555 
556 } // extern &quot;C&quot;
557 
558 } // namespace JSC
559 
560 #endif // ENABLE(NETSCAPE_PLUGIN_API)
</pre>
</td>
</tr>
</table>
<center><a href="../bindings/scripts/preprocess-idls.pl.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="c/CRuntimeObject.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>