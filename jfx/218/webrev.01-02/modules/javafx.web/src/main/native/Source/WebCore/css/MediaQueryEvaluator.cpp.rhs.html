<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/WebCore/css/MediaQueryEvaluator.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * CSS Media Query Evaluator
  3  *
  4  * Copyright (C) 2006 Kimmo Kinnunen &lt;kimmo.t.kinnunen@nokia.com&gt;.
  5  * Copyright (C) 2013 Apple Inc. All rights reserved.
  6  *
  7  * Redistribution and use in source and binary forms, with or without
  8  * modification, are permitted provided that the following conditions
  9  * are met:
 10  * 1. Redistributions of source code must retain the above copyright
 11  *    notice, this list of conditions and the following disclaimer.
 12  * 2. Redistributions in binary form must reproduce the above copyright
 13  *    notice, this list of conditions and the following disclaimer in the
 14  *    documentation and/or other materials provided with the distribution.
 15  *
 16  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS&#39;&#39; AND ANY
 17  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 18  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 19  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE INC. OR
 20  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 21  * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 22  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 23  * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 24  * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 25  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 26  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 27  */
 28 
 29 #include &quot;config.h&quot;
 30 #include &quot;MediaQueryEvaluator.h&quot;
 31 
 32 #include &quot;CSSAspectRatioValue.h&quot;
 33 #include &quot;CSSPrimitiveValue.h&quot;
 34 #include &quot;CSSToLengthConversionData.h&quot;
 35 #include &quot;CSSValueKeywords.h&quot;
 36 #include &quot;Frame.h&quot;
 37 #include &quot;FrameView.h&quot;
 38 #include &quot;Logging.h&quot;
 39 #include &quot;MediaFeatureNames.h&quot;
 40 #include &quot;MediaList.h&quot;
 41 #include &quot;MediaQuery.h&quot;
 42 #include &quot;MediaQueryParserContext.h&quot;
 43 #include &quot;NodeRenderStyle.h&quot;
 44 #include &quot;Page.h&quot;
 45 #include &quot;PlatformScreen.h&quot;
 46 #include &quot;RenderStyle.h&quot;
 47 #include &quot;RenderView.h&quot;
<a name="1" id="anc1"></a>
 48 #include &quot;Settings.h&quot;
<a name="2" id="anc2"></a>
 49 #include &quot;Theme.h&quot;
 50 #include &lt;wtf/HashMap.h&gt;
 51 #include &lt;wtf/text/StringConcatenateNumbers.h&gt;
 52 #include &lt;wtf/text/TextStream.h&gt;
 53 
 54 #if ENABLE(3D_TRANSFORMS)
 55 #include &quot;RenderLayerCompositor.h&quot;
 56 #endif
 57 
 58 namespace WebCore {
 59 
 60 enum MediaFeaturePrefix { MinPrefix, MaxPrefix, NoPrefix };
 61 
 62 #ifndef LOG_DISABLED
 63 static TextStream&amp; operator&lt;&lt;(TextStream&amp; ts, MediaFeaturePrefix op)
 64 {
 65     switch (op) {
 66     case MinPrefix: ts &lt;&lt; &quot;min&quot;; break;
 67     case MaxPrefix: ts &lt;&lt; &quot;max&quot;; break;
 68     case NoPrefix: ts &lt;&lt; &quot;&quot;; break;
 69     }
 70     return ts;
 71 }
 72 #endif
 73 
 74 typedef bool (*MediaQueryFunction)(CSSValue*, const CSSToLengthConversionData&amp;, Frame&amp;, MediaFeaturePrefix);
 75 typedef HashMap&lt;AtomStringImpl*, MediaQueryFunction&gt; MediaQueryFunctionMap;
 76 
 77 static bool isAccessibilitySettingsDependent(const AtomString&amp; mediaFeature)
 78 {
 79     return mediaFeature == MediaFeatureNames::invertedColors
 80         || mediaFeature == MediaFeatureNames::maxMonochrome
 81         || mediaFeature == MediaFeatureNames::minMonochrome
 82         || mediaFeature == MediaFeatureNames::monochrome
 83         || mediaFeature == MediaFeatureNames::prefersReducedMotion;
 84 }
 85 
 86 static bool isViewportDependent(const AtomString&amp; mediaFeature)
 87 {
 88     return mediaFeature == MediaFeatureNames::width
 89         || mediaFeature == MediaFeatureNames::height
 90         || mediaFeature == MediaFeatureNames::minWidth
 91         || mediaFeature == MediaFeatureNames::minHeight
 92         || mediaFeature == MediaFeatureNames::maxWidth
 93         || mediaFeature == MediaFeatureNames::maxHeight
 94         || mediaFeature == MediaFeatureNames::orientation
 95         || mediaFeature == MediaFeatureNames::aspectRatio
 96         || mediaFeature == MediaFeatureNames::minAspectRatio
 97         || mediaFeature == MediaFeatureNames::maxAspectRatio;
 98 }
 99 
100 static bool isAppearanceDependent(const AtomString&amp; mediaFeature)
101 {
102     return mediaFeature == MediaFeatureNames::prefersDarkInterface
103 #if ENABLE(DARK_MODE_CSS)
104         || mediaFeature == MediaFeatureNames::prefersColorScheme
105 #endif
106     ;
107 }
108 
109 MediaQueryEvaluator::MediaQueryEvaluator(bool mediaFeatureResult)
110     : m_fallbackResult(mediaFeatureResult)
111 {
112 }
113 
114 MediaQueryEvaluator::MediaQueryEvaluator(const String&amp; acceptedMediaType, bool mediaFeatureResult)
115     : m_mediaType(acceptedMediaType)
116     , m_fallbackResult(mediaFeatureResult)
117 {
118 }
119 
120 MediaQueryEvaluator::MediaQueryEvaluator(const String&amp; acceptedMediaType, const Document&amp; document, const RenderStyle* style)
121     : m_mediaType(acceptedMediaType)
122     , m_document(makeWeakPtr(document))
123     , m_style(style)
124 {
125 }
126 
127 bool MediaQueryEvaluator::mediaTypeMatch(const String&amp; mediaTypeToMatch) const
128 {
129     return mediaTypeToMatch.isEmpty()
130         || equalLettersIgnoringASCIICase(mediaTypeToMatch, &quot;all&quot;)
131         || equalIgnoringASCIICase(mediaTypeToMatch, m_mediaType);
132 }
133 
134 bool MediaQueryEvaluator::mediaTypeMatchSpecific(const char* mediaTypeToMatch) const
135 {
136     // Like mediaTypeMatch, but without the special cases for &quot;&quot; and &quot;all&quot;.
137     ASSERT(mediaTypeToMatch);
138     ASSERT(mediaTypeToMatch[0] != &#39;\0&#39;);
139     ASSERT(!equalLettersIgnoringASCIICase(StringView(mediaTypeToMatch), &quot;all&quot;));
140     return equalIgnoringASCIICase(m_mediaType, mediaTypeToMatch);
141 }
142 
143 static bool applyRestrictor(MediaQuery::Restrictor r, bool value)
144 {
145     return r == MediaQuery::Not ? !value : value;
146 }
147 
<a name="3" id="anc3"></a><span class="line-modified">148 bool MediaQueryEvaluator::evaluate(const MediaQuerySet&amp; querySet, MediaQueryDynamicResults* dynamicResults, Mode mode) const</span>
149 {
150     LOG_WITH_STREAM(MediaQueries, stream &lt;&lt; &quot;MediaQueryEvaluator::evaluate on &quot; &lt;&lt; (m_document ? m_document-&gt;url().string() : emptyString()));
151 
152     auto&amp; queries = querySet.queryVector();
153     if (!queries.size()) {
154         LOG_WITH_STREAM(MediaQueries, stream &lt;&lt; &quot;MediaQueryEvaluator::evaluate &quot; &lt;&lt; querySet &lt;&lt; &quot; returning true&quot;);
155         return true; // Empty query list evaluates to true.
156     }
157 
158     // Iterate over queries, stop if any of them eval to true (OR semantics).
159     bool result = false;
160     for (size_t i = 0; i &lt; queries.size() &amp;&amp; !result; ++i) {
161         auto&amp; query = queries[i];
162 
163         if (query.ignored() || (!query.expressions().size() &amp;&amp; query.mediaType().isEmpty()))
164             continue;
165 
166         if (mediaTypeMatch(query.mediaType())) {
167             auto&amp; expressions = query.expressions();
168             // Iterate through expressions, stop if any of them eval to false (AND semantics).
<a name="4" id="anc4"></a><span class="line-added">169             bool isDynamic = false;</span>
170             size_t j = 0;
171             for (; j &lt; expressions.size(); ++j) {
172                 bool expressionResult = evaluate(expressions[j]);
<a name="5" id="anc5"></a><span class="line-modified">173                 if (dynamicResults) {</span>
<span class="line-modified">174                     if (isViewportDependent(expressions[j].mediaFeature())) {</span>
<span class="line-modified">175                         isDynamic = true;</span>
<span class="line-modified">176                         dynamicResults-&gt;viewport.append({ expressions[j], expressionResult });</span>
<span class="line-modified">177                     }</span>
<span class="line-modified">178                     if (isAppearanceDependent(expressions[j].mediaFeature())) {</span>
<span class="line-added">179                         isDynamic = true;</span>
<span class="line-added">180                         dynamicResults-&gt;appearance.append({ expressions[j], expressionResult });</span>
<span class="line-added">181                     }</span>
<span class="line-added">182                     if (isAccessibilitySettingsDependent(expressions[j].mediaFeature())) {</span>
<span class="line-added">183                         isDynamic = true;</span>
<span class="line-added">184                         dynamicResults-&gt;accessibilitySettings.append({ expressions[j], expressionResult });</span>
<span class="line-added">185                     }</span>
<span class="line-added">186                 }</span>
<span class="line-added">187                 if (mode == Mode::AlwaysMatchDynamic &amp;&amp; isDynamic)</span>
<span class="line-added">188                     continue;</span>
<span class="line-added">189 </span>
190                 if (!expressionResult)
191                     break;
192             }
193 
<a name="6" id="anc6"></a><span class="line-added">194             if (mode == Mode::AlwaysMatchDynamic &amp;&amp; isDynamic) {</span>
<span class="line-added">195                 result = true;</span>
<span class="line-added">196                 continue;</span>
<span class="line-added">197             }</span>
<span class="line-added">198 </span>
199             // Assume true if we are at the end of the list, otherwise assume false.
200             result = applyRestrictor(query.restrictor(), expressions.size() == j);
201         } else
202             result = applyRestrictor(query.restrictor(), false);
203     }
204 
205     LOG_WITH_STREAM(MediaQueries, stream &lt;&lt; &quot;MediaQueryEvaluator::evaluate &quot; &lt;&lt; querySet &lt;&lt; &quot; returning &quot; &lt;&lt; result);
206     return result;
207 }
208 
<a name="7" id="anc7"></a><span class="line-modified">209 bool MediaQueryEvaluator::evaluateForChanges(const MediaQueryDynamicResults&amp; dynamicResults) const</span>
210 {
<a name="8" id="anc8"></a><span class="line-modified">211     auto hasChanges = [&amp;](auto&amp; dynamicResultsVector) {</span>
<span class="line-modified">212         for (auto&amp; dynamicResult : dynamicResultsVector) {</span>
<span class="line-modified">213             if (evaluate(dynamicResult.expression) != dynamicResult.result)</span>
<span class="line-modified">214                 return true;</span>
<span class="line-modified">215         }</span>
<span class="line-modified">216         return false;</span>
<span class="line-modified">217     };</span>




















218 
<a name="9" id="anc9"></a><span class="line-modified">219     return hasChanges(dynamicResults.viewport) || hasChanges(dynamicResults.appearance) || hasChanges(dynamicResults.accessibilitySettings);</span>
220 }
221 
222 template&lt;typename T, typename U&gt; bool compareValue(T a, U b, MediaFeaturePrefix op)
223 {
224     switch (op) {
225     case MinPrefix:
226         return a &gt;= b;
227     case MaxPrefix:
228         return a &lt;= b;
229     case NoPrefix:
230         return a == b;
231     }
232     return false;
233 }
234 
235 #if !LOG_DISABLED
236 
237 static String aspectRatioValueAsString(CSSValue* value)
238 {
239     if (!is&lt;CSSAspectRatioValue&gt;(value))
240         return emptyString();
241 
242     auto&amp; aspectRatio = downcast&lt;CSSAspectRatioValue&gt;(*value);
<a name="10" id="anc10"></a><span class="line-modified">243     return makeString(aspectRatio.numeratorValue(), &#39;/&#39;, aspectRatio.denominatorValue());</span>
244 }
245 
246 #endif
247 
248 static bool compareAspectRatioValue(CSSValue* value, int width, int height, MediaFeaturePrefix op)
249 {
250     if (!is&lt;CSSAspectRatioValue&gt;(value))
251         return false;
252     auto&amp; aspectRatio = downcast&lt;CSSAspectRatioValue&gt;(*value);
253     return compareValue(width * aspectRatio.denominatorValue(), height * aspectRatio.numeratorValue(), op);
254 }
255 
256 static Optional&lt;double&gt; doubleValue(CSSValue* value)
257 {
258     if (!is&lt;CSSPrimitiveValue&gt;(value) || !downcast&lt;CSSPrimitiveValue&gt;(*value).isNumber())
259         return WTF::nullopt;
<a name="11" id="anc11"></a><span class="line-modified">260     return downcast&lt;CSSPrimitiveValue&gt;(*value).doubleValue(CSSUnitType::CSS_NUMBER);</span>
261 }
262 
263 static bool zeroEvaluate(CSSValue* value, MediaFeaturePrefix op)
264 {
265     auto numericValue = doubleValue(value);
266     return numericValue &amp;&amp; compareValue(0, numericValue.value(), op);
267 }
268 
269 static bool oneEvaluate(CSSValue* value, MediaFeaturePrefix op)
270 {
271     if (!value)
272         return true;
273     auto numericValue = doubleValue(value);
274     return numericValue &amp;&amp; compareValue(1, numericValue.value(), op);
275 }
276 
277 static bool colorEvaluate(CSSValue* value, const CSSToLengthConversionData&amp;, Frame&amp; frame, MediaFeaturePrefix op)
278 {
279     int bitsPerComponent = screenDepthPerComponent(frame.mainFrame().view());
280     auto numericValue = doubleValue(value);
281     if (!numericValue)
282         return bitsPerComponent;
283     return compareValue(bitsPerComponent, numericValue.value(), op);
284 }
285 
286 static bool colorIndexEvaluate(CSSValue* value, const CSSToLengthConversionData&amp;, Frame&amp;, MediaFeaturePrefix op)
287 {
288     // Always return false for indexed display.
289     return zeroEvaluate(value, op);
290 }
291 
292 static bool colorGamutEvaluate(CSSValue* value, const CSSToLengthConversionData&amp;, Frame&amp; frame, MediaFeaturePrefix)
293 {
294     if (!value)
295         return true;
296 
297     switch (downcast&lt;CSSPrimitiveValue&gt;(*value).valueID()) {
298     case CSSValueSRGB:
299         return true;
300     case CSSValueP3:
301         // FIXME: For the moment we just assume any &quot;extended color&quot; display is at least as good as P3.
302         return screenSupportsExtendedColor(frame.mainFrame().view());
303     case CSSValueRec2020:
304         // FIXME: At some point we should start detecting displays that support more colors.
305         return false;
306     default:
307         return false; // Any unknown value should not be considered a match.
308     }
309 }
310 
311 static bool monochromeEvaluate(CSSValue* value, const CSSToLengthConversionData&amp; conversionData, Frame&amp; frame, MediaFeaturePrefix op)
312 {
313     bool isMonochrome;
314 
315     if (frame.settings().forcedDisplayIsMonochromeAccessibilityValue() == Settings::ForcedAccessibilityValue::On)
316         isMonochrome = true;
317     else if (frame.settings().forcedDisplayIsMonochromeAccessibilityValue() == Settings::ForcedAccessibilityValue::Off)
318         isMonochrome = false;
319     else
320         isMonochrome = screenIsMonochrome(frame.mainFrame().view());
321 
322     if (!isMonochrome)
323         return zeroEvaluate(value, op);
324     return colorEvaluate(value, conversionData, frame, op);
325 }
326 
327 static bool invertedColorsEvaluate(CSSValue* value, const CSSToLengthConversionData&amp;, Frame&amp; frame, MediaFeaturePrefix)
328 {
329     bool isInverted;
330 
331     if (frame.settings().forcedColorsAreInvertedAccessibilityValue() == Settings::ForcedAccessibilityValue::On)
332         isInverted = true;
333     else if (frame.settings().forcedColorsAreInvertedAccessibilityValue() == Settings::ForcedAccessibilityValue::Off)
334         isInverted = false;
335     else
336         isInverted = screenHasInvertedColors();
337 
338     if (!value)
339         return isInverted;
340 
341     return downcast&lt;CSSPrimitiveValue&gt;(*value).valueID() == (isInverted ? CSSValueInverted : CSSValueNone);
342 }
343 
344 static bool orientationEvaluate(CSSValue* value, const CSSToLengthConversionData&amp;, Frame&amp; frame, MediaFeaturePrefix)
345 {
346     FrameView* view = frame.view();
347     if (!view)
348         return false;
349 
350     auto width = view-&gt;layoutWidth();
351     auto height = view-&gt;layoutHeight();
352 
353     if (!is&lt;CSSPrimitiveValue&gt;(value)) {
354         // Expression (orientation) evaluates to true if width and height &gt;= 0.
355         return height &gt;= 0 &amp;&amp; width &gt;= 0;
356     }
357 
358     auto keyword = downcast&lt;CSSPrimitiveValue&gt;(*value).valueID();
359     bool result;
360     if (width &gt; height) // Square viewport is portrait.
361         result = keyword == CSSValueLandscape;
362     else
363         result = keyword == CSSValuePortrait;
364 
365     LOG_WITH_STREAM(MediaQueries, stream &lt;&lt; &quot;  orientationEvaluate: view size &quot; &lt;&lt; width &lt;&lt; &quot;x&quot; &lt;&lt; height &lt;&lt; &quot; is &quot; &lt;&lt; value-&gt;cssText() &lt;&lt; &quot;: &quot; &lt;&lt; result);
366     return result;
367 }
368 
369 static bool aspectRatioEvaluate(CSSValue* value, const CSSToLengthConversionData&amp;, Frame&amp; frame, MediaFeaturePrefix op)
370 {
371     // ({,min-,max-}aspect-ratio)
372     // assume if we have a device, its aspect ratio is non-zero
373     if (!value)
374         return true;
375     FrameView* view = frame.view();
376     if (!view)
377         return true;
378     bool result = compareAspectRatioValue(value, view-&gt;layoutWidth(), view-&gt;layoutHeight(), op);
379     LOG_WITH_STREAM(MediaQueries, stream &lt;&lt; &quot;  aspectRatioEvaluate: &quot; &lt;&lt; op &lt;&lt; &quot; &quot; &lt;&lt; aspectRatioValueAsString(value) &lt;&lt; &quot; actual view size &quot; &lt;&lt; view-&gt;layoutWidth() &lt;&lt; &quot;x&quot; &lt;&lt; view-&gt;layoutHeight() &lt;&lt; &quot; : &quot; &lt;&lt; result);
380     return result;
381 }
382 
383 static bool deviceAspectRatioEvaluate(CSSValue* value, const CSSToLengthConversionData&amp;, Frame&amp; frame, MediaFeaturePrefix op)
384 {
385     // ({,min-,max-}device-aspect-ratio)
386     // assume if we have a device, its aspect ratio is non-zero
387     if (!value)
388         return true;
389 
390     auto size = screenRect(frame.mainFrame().view()).size();
391     bool result = compareAspectRatioValue(value, size.width(), size.height(), op);
392     LOG_WITH_STREAM(MediaQueries, stream &lt;&lt; &quot;  deviceAspectRatioEvaluate: &quot; &lt;&lt; op &lt;&lt; &quot; &quot; &lt;&lt; aspectRatioValueAsString(value) &lt;&lt; &quot; actual screen size &quot; &lt;&lt; size &lt;&lt; &quot;: &quot; &lt;&lt; result);
393     return result;
394 }
395 
396 static bool evaluateResolution(CSSValue* value, Frame&amp; frame, MediaFeaturePrefix op)
397 {
398     // FIXME: Possible handle other media types than &#39;screen&#39; and &#39;print&#39;.
399     FrameView* view = frame.view();
400     if (!view)
401         return false;
402 
403     float deviceScaleFactor = 0;
404 
405     // This checks the actual media type applied to the document, and we know
406     // this method only got called if this media type matches the one defined
407     // in the query. Thus, if if the document&#39;s media type is &quot;print&quot;, the
408     // media type of the query will either be &quot;print&quot; or &quot;all&quot;.
409     String mediaType = view-&gt;mediaType();
410     if (equalLettersIgnoringASCIICase(mediaType, &quot;screen&quot;))
411         deviceScaleFactor = frame.page() ? frame.page()-&gt;deviceScaleFactor() : 1;
412     else if (equalLettersIgnoringASCIICase(mediaType, &quot;print&quot;)) {
413         // The resolution of images while printing should not depend on the dpi
414         // of the screen. Until we support proper ways of querying this info
415         // we use 300px which is considered minimum for current printers.
416         deviceScaleFactor = 3.125; // 300dpi / 96dpi;
417     }
418 
419     if (!value)
420         return !!deviceScaleFactor;
421 
422     if (!is&lt;CSSPrimitiveValue&gt;(value))
423         return false;
424 
425     auto&amp; resolution = downcast&lt;CSSPrimitiveValue&gt;(*value);
<a name="12" id="anc12"></a><span class="line-modified">426     float resolutionValue = resolution.isNumber() ? resolution.floatValue() : resolution.floatValue(CSSUnitType::CSS_DPPX);</span>
427     bool result = compareValue(deviceScaleFactor, resolutionValue, op);
428     LOG_WITH_STREAM(MediaQueries, stream &lt;&lt; &quot;  evaluateResolution: &quot; &lt;&lt; op &lt;&lt; &quot; &quot; &lt;&lt; resolutionValue &lt;&lt; &quot; device scale factor &quot; &lt;&lt; deviceScaleFactor &lt;&lt; &quot;: &quot; &lt;&lt; result);
429     return result;
430 }
431 
432 static bool devicePixelRatioEvaluate(CSSValue* value, const CSSToLengthConversionData&amp;, Frame&amp; frame, MediaFeaturePrefix op)
433 {
434     return (!value || (is&lt;CSSPrimitiveValue&gt;(*value) &amp;&amp; downcast&lt;CSSPrimitiveValue&gt;(*value).isNumber())) &amp;&amp; evaluateResolution(value, frame, op);
435 }
436 
437 static bool resolutionEvaluate(CSSValue* value, const CSSToLengthConversionData&amp;, Frame&amp; frame, MediaFeaturePrefix op)
438 {
439 #if ENABLE(RESOLUTION_MEDIA_QUERY)
440     return (!value || (is&lt;CSSPrimitiveValue&gt;(*value) &amp;&amp; downcast&lt;CSSPrimitiveValue&gt;(*value).isResolution())) &amp;&amp; evaluateResolution(value, frame, op);
441 #else
442     UNUSED_PARAM(value);
443     UNUSED_PARAM(frame);
444     UNUSED_PARAM(op);
445     return false;
446 #endif
447 }
448 
<a name="13" id="anc13"></a><span class="line-added">449 static bool dynamicRangeEvaluate(CSSValue* value, const CSSToLengthConversionData&amp;, Frame&amp; frame, MediaFeaturePrefix)</span>
<span class="line-added">450 {</span>
<span class="line-added">451     if (!value)</span>
<span class="line-added">452         return false;</span>
<span class="line-added">453 </span>
<span class="line-added">454     if (!frame.settings().hdrMediaCapabilitiesEnabled())</span>
<span class="line-added">455         return false;</span>
<span class="line-added">456 </span>
<span class="line-added">457     bool supportsHighDynamicRange;</span>
<span class="line-added">458 </span>
<span class="line-added">459     if (frame.settings().forcedSupportsHighDynamicRangeValue() == Settings::ForcedAccessibilityValue::On)</span>
<span class="line-added">460         supportsHighDynamicRange = true;</span>
<span class="line-added">461     else if (frame.settings().forcedSupportsHighDynamicRangeValue() == Settings::ForcedAccessibilityValue::Off)</span>
<span class="line-added">462         supportsHighDynamicRange = false;</span>
<span class="line-added">463     else</span>
<span class="line-added">464         supportsHighDynamicRange = screenSupportsHighDynamicRange(frame.mainFrame().view());</span>
<span class="line-added">465 </span>
<span class="line-added">466     switch (downcast&lt;CSSPrimitiveValue&gt;(*value).valueID()) {</span>
<span class="line-added">467     case CSSValueHigh:</span>
<span class="line-added">468         return supportsHighDynamicRange;</span>
<span class="line-added">469     case CSSValueStandard:</span>
<span class="line-added">470         return true;</span>
<span class="line-added">471     default:</span>
<span class="line-added">472         return false; // Any unknown value should not be considered a match.</span>
<span class="line-added">473     }</span>
<span class="line-added">474 }</span>
<span class="line-added">475 </span>
476 static bool gridEvaluate(CSSValue* value, const CSSToLengthConversionData&amp;, Frame&amp;, MediaFeaturePrefix op)
477 {
478     return zeroEvaluate(value, op);
479 }
480 
481 static bool computeLength(CSSValue* value, bool strict, const CSSToLengthConversionData&amp; conversionData, int&amp; result)
482 {
483     if (!is&lt;CSSPrimitiveValue&gt;(value))
484         return false;
485 
486     auto&amp; primitiveValue = downcast&lt;CSSPrimitiveValue&gt;(*value);
487 
488     if (primitiveValue.isNumber()) {
489         result = primitiveValue.intValue();
490         return !strict || !result;
491     }
492 
493     if (primitiveValue.isLength()) {
494         result = primitiveValue.computeLength&lt;int&gt;(conversionData);
495         return true;
496     }
497 
498     return false;
499 }
500 
501 static bool deviceHeightEvaluate(CSSValue* value, const CSSToLengthConversionData&amp; conversionData, Frame&amp; frame, MediaFeaturePrefix op)
502 {
503     // ({,min-,max-}device-height)
504     // assume if we have a device, assume non-zero
505     if (!value)
506         return true;
507     int length;
508     auto height = screenRect(frame.mainFrame().view()).height();
509     if (!computeLength(value, !frame.document()-&gt;inQuirksMode(), conversionData, length))
510         return false;
511 
512     LOG_WITH_STREAM(MediaQueries, stream &lt;&lt; &quot;  deviceHeightEvaluate: query &quot; &lt;&lt; op &lt;&lt; &quot; height &quot; &lt;&lt; length &lt;&lt; &quot;, actual height &quot; &lt;&lt; height &lt;&lt; &quot; result: &quot; &lt;&lt; compareValue(height, length, op));
513 
514     return compareValue(height, length, op);
515 }
516 
517 static bool deviceWidthEvaluate(CSSValue* value, const CSSToLengthConversionData&amp; conversionData, Frame&amp; frame, MediaFeaturePrefix op)
518 {
519     // ({,min-,max-}device-width)
520     // assume if we have a device, assume non-zero
521     if (!value)
522         return true;
523     int length;
524     auto width = screenRect(frame.mainFrame().view()).width();
525     if (!computeLength(value, !frame.document()-&gt;inQuirksMode(), conversionData, length))
526         return false;
527 
528     LOG_WITH_STREAM(MediaQueries, stream &lt;&lt; &quot;  deviceWidthEvaluate: query &quot; &lt;&lt; op &lt;&lt; &quot; width &quot; &lt;&lt; length &lt;&lt; &quot;, actual width &quot; &lt;&lt; width &lt;&lt; &quot; result: &quot; &lt;&lt; compareValue(width, length, op));
529 
530     return compareValue(width, length, op);
531 }
532 
533 static bool heightEvaluate(CSSValue* value, const CSSToLengthConversionData&amp; conversionData, Frame&amp; frame, MediaFeaturePrefix op)
534 {
535     FrameView* view = frame.view();
536     if (!view)
537         return false;
538     int height = view-&gt;layoutHeight();
539     if (!value)
540         return height;
541     if (auto* renderView = frame.document()-&gt;renderView())
542         height = adjustForAbsoluteZoom(height, *renderView);
543 
544     int length;
545     if (!computeLength(value, !frame.document()-&gt;inQuirksMode(), conversionData, length))
546         return false;
547 
548     LOG_WITH_STREAM(MediaQueries, stream &lt;&lt; &quot;  heightEvaluate: query &quot; &lt;&lt; op &lt;&lt; &quot; height &quot; &lt;&lt; length &lt;&lt; &quot;, actual height &quot; &lt;&lt; height &lt;&lt; &quot; result: &quot; &lt;&lt; compareValue(height, length, op));
549 
550     return compareValue(height, length, op);
551 }
552 
553 static bool widthEvaluate(CSSValue* value, const CSSToLengthConversionData&amp; conversionData, Frame&amp; frame, MediaFeaturePrefix op)
554 {
555     FrameView* view = frame.view();
556     if (!view)
557         return false;
558     int width = view-&gt;layoutWidth();
559     if (!value)
560         return width;
561     if (auto* renderView = frame.document()-&gt;renderView())
562         width = adjustForAbsoluteZoom(width, *renderView);
563 
564     int length;
565     if (!computeLength(value, !frame.document()-&gt;inQuirksMode(), conversionData, length))
566         return false;
567 
568     LOG_WITH_STREAM(MediaQueries, stream &lt;&lt; &quot;  widthEvaluate: query &quot; &lt;&lt; op &lt;&lt; &quot; width &quot; &lt;&lt; length &lt;&lt; &quot;, actual width &quot; &lt;&lt; width &lt;&lt; &quot; result: &quot; &lt;&lt; compareValue(width, length, op));
569 
570     return compareValue(width, length, op);
571 }
572 
573 static bool minColorEvaluate(CSSValue* value, const CSSToLengthConversionData&amp; conversionData, Frame&amp; frame, MediaFeaturePrefix)
574 {
575     return colorEvaluate(value, conversionData, frame, MinPrefix);
576 }
577 
578 static bool maxColorEvaluate(CSSValue* value, const CSSToLengthConversionData&amp; conversionData, Frame&amp; frame, MediaFeaturePrefix)
579 {
580     return colorEvaluate(value, conversionData, frame, MaxPrefix);
581 }
582 
583 static bool minColorIndexEvaluate(CSSValue* value, const CSSToLengthConversionData&amp; conversionData, Frame&amp; frame, MediaFeaturePrefix)
584 {
585     return colorIndexEvaluate(value, conversionData, frame, MinPrefix);
586 }
587 
588 static bool maxColorIndexEvaluate(CSSValue* value, const CSSToLengthConversionData&amp; conversionData, Frame&amp; frame, MediaFeaturePrefix)
589 {
590     return colorIndexEvaluate(value, conversionData, frame, MaxPrefix);
591 }
592 
593 static bool minMonochromeEvaluate(CSSValue* value, const CSSToLengthConversionData&amp; conversionData, Frame&amp; frame, MediaFeaturePrefix)
594 {
595     return monochromeEvaluate(value, conversionData, frame, MinPrefix);
596 }
597 
598 static bool maxMonochromeEvaluate(CSSValue* value, const CSSToLengthConversionData&amp; conversionData, Frame&amp; frame, MediaFeaturePrefix)
599 {
600     return monochromeEvaluate(value, conversionData, frame, MaxPrefix);
601 }
602 
603 static bool minAspectRatioEvaluate(CSSValue* value, const CSSToLengthConversionData&amp; conversionData, Frame&amp; frame, MediaFeaturePrefix)
604 {
605     return aspectRatioEvaluate(value, conversionData, frame, MinPrefix);
606 }
607 
608 static bool maxAspectRatioEvaluate(CSSValue* value, const CSSToLengthConversionData&amp; conversionData, Frame&amp; frame, MediaFeaturePrefix)
609 {
610     return aspectRatioEvaluate(value, conversionData, frame, MaxPrefix);
611 }
612 
613 static bool minDeviceAspectRatioEvaluate(CSSValue* value, const CSSToLengthConversionData&amp; conversionData, Frame&amp; frame, MediaFeaturePrefix)
614 {
615     return deviceAspectRatioEvaluate(value, conversionData, frame, MinPrefix);
616 }
617 
618 static bool maxDeviceAspectRatioEvaluate(CSSValue* value, const CSSToLengthConversionData&amp; conversionData, Frame&amp; frame, MediaFeaturePrefix)
619 {
620     return deviceAspectRatioEvaluate(value, conversionData, frame, MaxPrefix);
621 }
622 
623 static bool minDevicePixelRatioEvaluate(CSSValue* value, const CSSToLengthConversionData&amp; conversionData, Frame&amp; frame, MediaFeaturePrefix)
624 {
625     return devicePixelRatioEvaluate(value, conversionData, frame, MinPrefix);
626 }
627 
628 static bool maxDevicePixelRatioEvaluate(CSSValue* value, const CSSToLengthConversionData&amp; conversionData, Frame&amp; frame, MediaFeaturePrefix)
629 {
630     return devicePixelRatioEvaluate(value, conversionData, frame, MaxPrefix);
631 }
632 
633 static bool minHeightEvaluate(CSSValue* value, const CSSToLengthConversionData&amp; conversionData, Frame&amp; frame, MediaFeaturePrefix)
634 {
635     return heightEvaluate(value, conversionData, frame, MinPrefix);
636 }
637 
638 static bool maxHeightEvaluate(CSSValue* value, const CSSToLengthConversionData&amp; conversionData, Frame&amp; frame, MediaFeaturePrefix)
639 {
640     return heightEvaluate(value, conversionData, frame, MaxPrefix);
641 }
642 
643 static bool minWidthEvaluate(CSSValue* value, const CSSToLengthConversionData&amp; conversionData, Frame&amp; frame, MediaFeaturePrefix)
644 {
645     return widthEvaluate(value, conversionData, frame, MinPrefix);
646 }
647 
648 static bool maxWidthEvaluate(CSSValue* value, const CSSToLengthConversionData&amp; conversionData, Frame&amp; frame, MediaFeaturePrefix)
649 {
650     return widthEvaluate(value, conversionData, frame, MaxPrefix);
651 }
652 
653 static bool minDeviceHeightEvaluate(CSSValue* value, const CSSToLengthConversionData&amp; conversionData, Frame&amp; frame, MediaFeaturePrefix)
654 {
655     return deviceHeightEvaluate(value, conversionData, frame, MinPrefix);
656 }
657 
658 static bool maxDeviceHeightEvaluate(CSSValue* value, const CSSToLengthConversionData&amp; conversionData, Frame&amp; frame, MediaFeaturePrefix)
659 {
660     return deviceHeightEvaluate(value, conversionData, frame, MaxPrefix);
661 }
662 
663 static bool minDeviceWidthEvaluate(CSSValue* value, const CSSToLengthConversionData&amp; conversionData, Frame&amp; frame, MediaFeaturePrefix)
664 {
665     return deviceWidthEvaluate(value, conversionData, frame, MinPrefix);
666 }
667 
668 static bool maxDeviceWidthEvaluate(CSSValue* value, const CSSToLengthConversionData&amp; conversionData, Frame&amp; frame, MediaFeaturePrefix)
669 {
670     return deviceWidthEvaluate(value, conversionData, frame, MaxPrefix);
671 }
672 
673 static bool minResolutionEvaluate(CSSValue* value, const CSSToLengthConversionData&amp; conversionData, Frame&amp; frame, MediaFeaturePrefix)
674 {
675     return resolutionEvaluate(value, conversionData, frame, MinPrefix);
676 }
677 
678 static bool maxResolutionEvaluate(CSSValue* value, const CSSToLengthConversionData&amp; conversionData, Frame&amp; frame, MediaFeaturePrefix)
679 {
680     return resolutionEvaluate(value, conversionData, frame, MaxPrefix);
681 }
682 
683 static bool animationEvaluate(CSSValue* value, const CSSToLengthConversionData&amp;, Frame&amp;, MediaFeaturePrefix op)
684 {
685     return oneEvaluate(value, op);
686 }
687 
688 static bool transitionEvaluate(CSSValue* value, const CSSToLengthConversionData&amp;, Frame&amp;, MediaFeaturePrefix op)
689 {
690     return oneEvaluate(value, op);
691 }
692 
693 static bool transform2dEvaluate(CSSValue* value, const CSSToLengthConversionData&amp;, Frame&amp;, MediaFeaturePrefix op)
694 {
695     return oneEvaluate(value, op);
696 }
697 
698 static bool transform3dEvaluate(CSSValue* value, const CSSToLengthConversionData&amp;, Frame&amp; frame, MediaFeaturePrefix op)
699 {
700 #if ENABLE(3D_TRANSFORMS)
701     auto* view = frame.contentRenderer();
702     return view &amp;&amp; view-&gt;compositor().canRender3DTransforms() ? oneEvaluate(value, op) : zeroEvaluate(value, op);
703 #else
704     UNUSED_PARAM(frame);
705     return zeroEvaluate(value, op);
706 #endif
707 }
708 
709 static bool videoPlayableInlineEvaluate(CSSValue*, const CSSToLengthConversionData&amp;, Frame&amp; frame, MediaFeaturePrefix)
710 {
711     return frame.settings().allowsInlineMediaPlayback();
712 }
713 
714 static bool hoverEvaluate(CSSValue* value, const CSSToLengthConversionData&amp;, Frame&amp;, MediaFeaturePrefix)
715 {
716     if (!is&lt;CSSPrimitiveValue&gt;(value)) {
717 #if ENABLE(TOUCH_EVENTS)
718         return !screenIsTouchPrimaryInputDevice();
719 #else
720         return true;
721 #endif
722     }
723 
724     auto keyword = downcast&lt;CSSPrimitiveValue&gt;(*value).valueID();
725 #if ENABLE(TOUCH_EVENTS)
726     if (screenIsTouchPrimaryInputDevice())
727         return keyword == CSSValueNone;
728 #endif
729     return keyword == CSSValueHover;
730 }
731 
732 static bool anyHoverEvaluate(CSSValue* value, const CSSToLengthConversionData&amp;, Frame&amp;, MediaFeaturePrefix)
733 {
734     if (!is&lt;CSSPrimitiveValue&gt;(value)) {
735 #if ENABLE(TOUCH_EVENTS)
736         return !screenHasTouchDevice();
737 #else
738         return true;
739 #endif
740     }
741 
742     auto keyword = downcast&lt;CSSPrimitiveValue&gt;(*value).valueID();
743 #if ENABLE(TOUCH_EVENTS)
744     if (screenHasTouchDevice())
745         return keyword == CSSValueNone;
746 #endif
747     return keyword == CSSValueHover;
748 }
749 
750 static bool pointerEvaluate(CSSValue* value, const CSSToLengthConversionData&amp;, Frame&amp;, MediaFeaturePrefix)
751 {
752     if (!is&lt;CSSPrimitiveValue&gt;(value))
753         return true;
754 
755     auto keyword = downcast&lt;CSSPrimitiveValue&gt;(*value).valueID();
756 #if ENABLE(TOUCH_EVENTS)
757     if (screenIsTouchPrimaryInputDevice())
758         return keyword == CSSValueCoarse;
759 #endif
760     return keyword == CSSValueFine;
761 }
762 
763 static bool anyPointerEvaluate(CSSValue* value, const CSSToLengthConversionData&amp;, Frame&amp;, MediaFeaturePrefix)
764 {
765     if (!is&lt;CSSPrimitiveValue&gt;(value))
766         return true;
767 
768     auto keyword = downcast&lt;CSSPrimitiveValue&gt;(*value).valueID();
769 #if ENABLE(TOUCH_EVENTS)
770     if (screenHasTouchDevice())
771         return keyword == CSSValueCoarse;
772 #endif
773     return keyword == CSSValueFine;
774 }
775 
776 static bool prefersDarkInterfaceEvaluate(CSSValue* value, const CSSToLengthConversionData&amp;, Frame&amp; frame, MediaFeaturePrefix)
777 {
778     bool prefersDarkInterface = false;
779 
780     if (frame.page()-&gt;useSystemAppearance() &amp;&amp; frame.page()-&gt;useDarkAppearance())
781         prefersDarkInterface = true;
782 
783     if (!value)
784         return prefersDarkInterface;
785 
786     return downcast&lt;CSSPrimitiveValue&gt;(*value).valueID() == (prefersDarkInterface ? CSSValuePrefers : CSSValueNoPreference);
787 }
788 
789 #if ENABLE(DARK_MODE_CSS)
790 static bool prefersColorSchemeEvaluate(CSSValue* value, const CSSToLengthConversionData&amp;, Frame&amp; frame, MediaFeaturePrefix)
791 {
792     if (!value)
793         return true;
794 
795     if (!is&lt;CSSPrimitiveValue&gt;(value))
796         return false;
797 
798     auto keyword = downcast&lt;CSSPrimitiveValue&gt;(*value).valueID();
799     bool useDarkAppearance = frame.page()-&gt;useDarkAppearance();
800 
801     switch (keyword) {
802     case CSSValueNoPreference:
803         return false;
804     case CSSValueDark:
805         return useDarkAppearance;
806     case CSSValueLight:
807         return !useDarkAppearance;
808     default:
809         return false;
810     }
811 }
812 #endif
813 
814 static bool prefersReducedMotionEvaluate(CSSValue* value, const CSSToLengthConversionData&amp;, Frame&amp; frame, MediaFeaturePrefix)
815 {
816     bool userPrefersReducedMotion = false;
817 
818     switch (frame.settings().forcedPrefersReducedMotionAccessibilityValue()) {
819     case Settings::ForcedAccessibilityValue::On:
820         userPrefersReducedMotion = true;
821         break;
822     case Settings::ForcedAccessibilityValue::Off:
823         break;
824     case Settings::ForcedAccessibilityValue::System:
825 #if USE(NEW_THEME) || PLATFORM(IOS_FAMILY)
826         userPrefersReducedMotion = Theme::singleton().userPrefersReducedMotion();
827 #endif
828         break;
829     }
830 
831     if (!value)
832         return userPrefersReducedMotion;
833 
834     return downcast&lt;CSSPrimitiveValue&gt;(*value).valueID() == (userPrefersReducedMotion ? CSSValueReduce : CSSValueNoPreference);
835 }
836 
837 #if ENABLE(APPLICATION_MANIFEST)
838 static bool displayModeEvaluate(CSSValue* value, const CSSToLengthConversionData&amp;, Frame&amp; frame, MediaFeaturePrefix)
839 {
840     if (!value)
841         return true;
842 
843     auto keyword = downcast&lt;CSSPrimitiveValue&gt;(*value).valueID();
844 
845     auto manifest = frame.page() ? frame.page()-&gt;applicationManifest() : WTF::nullopt;
846     if (!manifest)
847         return keyword == CSSValueBrowser;
848 
849     switch (manifest-&gt;display) {
850     case ApplicationManifest::Display::Fullscreen:
851         return keyword == CSSValueFullscreen;
852     case ApplicationManifest::Display::Standalone:
853         return keyword == CSSValueStandalone;
854     case ApplicationManifest::Display::MinimalUI:
855         return keyword == CSSValueMinimalUi;
856     case ApplicationManifest::Display::Browser:
857         return keyword == CSSValueBrowser;
858     }
859 
860     return false;
861 }
862 #endif // ENABLE(APPLICATION_MANIFEST)
863 
864 // Use this function instead of calling add directly to avoid inlining.
865 static void add(MediaQueryFunctionMap&amp; map, AtomStringImpl* key, MediaQueryFunction value)
866 {
867     map.add(key, value);
868 }
869 
870 bool MediaQueryEvaluator::evaluate(const MediaQueryExpression&amp; expression) const
871 {
872     if (!m_document)
873         return m_fallbackResult;
874 
875     auto&amp; document = *m_document;
876     auto* frame = document.frame();
877     if (!frame || !frame-&gt;view() || !m_style)
878         return m_fallbackResult;
879 
880     if (!expression.isValid())
881         return false;
882 
883     static NeverDestroyed&lt;MediaQueryFunctionMap&gt; map = [] {
884         MediaQueryFunctionMap map;
885 #define ADD_TO_FUNCTIONMAP(name, str) add(map, MediaFeatureNames::name-&gt;impl(), name##Evaluate);
886         CSS_MEDIAQUERY_NAMES_FOR_EACH_MEDIAFEATURE(ADD_TO_FUNCTIONMAP);
887 #undef ADD_TO_FUNCTIONMAP
888         return map;
889     }();
890 
891     auto function = map.get().get(expression.mediaFeature().impl());
892     if (!function)
893         return false;
894 
895     if (!document.documentElement())
896         return false;
897     return function(expression.value(), { m_style, document.documentElement()-&gt;renderStyle(), document.renderView(), 1, false }, *frame, NoPrefix);
898 }
899 
900 bool MediaQueryEvaluator::mediaAttributeMatches(Document&amp; document, const String&amp; attributeValue)
901 {
902     ASSERT(document.renderView());
903     auto mediaQueries = MediaQuerySet::create(attributeValue, MediaQueryParserContext(document));
904     return MediaQueryEvaluator { &quot;screen&quot;, document, &amp;document.renderView()-&gt;style() }.evaluate(mediaQueries.get());
905 }
906 
907 } // WebCore
<a name="14" id="anc14"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="14" type="hidden" />
</body>
</html>