<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WebCore/html/MediaDocument.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="LinkRelAttribute.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="MediaDocument.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/html/MediaDocument.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
127 
128     body-&gt;appendChild(videoElement);
129 
130     RefPtr&lt;Frame&gt; frame = document.frame();
131     if (!frame)
132         return;
133 
134     frame-&gt;loader().activeDocumentLoader()-&gt;setMainResourceDataBufferingPolicy(DataBufferingPolicy::DoNotBufferData);
135     frame-&gt;loader().setOutgoingReferrer(document.completeURL(m_outgoingReferrer));
136 }
137 
138 void MediaDocumentParser::appendBytes(DocumentWriter&amp;, const char*, size_t)
139 {
140     if (m_mediaElement)
141         return;
142 
143     createDocumentStructure();
144     finish();
145 }
146 
<span class="line-modified">147 MediaDocument::MediaDocument(PAL::SessionID sessionID, Frame* frame, const URL&amp; url)</span>
<span class="line-modified">148     : HTMLDocument(sessionID, frame, url, MediaDocumentClass)</span>
<span class="line-removed">149     , m_replaceMediaElementTimer(*this, &amp;MediaDocument::replaceMediaElementTimerFired)</span>
150 {
151     setCompatibilityMode(DocumentCompatibilityMode::QuirksMode);
152     lockCompatibilityMode();
153     if (frame)
154         m_outgoingReferrer = frame-&gt;loader().outgoingReferrer();
155 }
156 
157 MediaDocument::~MediaDocument()
158 {
<span class="line-removed">159     ASSERT(!m_replaceMediaElementTimer.isActive());</span>
160 }
161 
162 Ref&lt;DocumentParser&gt; MediaDocument::createParser()
163 {
164     return MediaDocumentParser::create(*this);
165 }
166 
167 static inline HTMLVideoElement* descendantVideoElement(ContainerNode&amp; node)
168 {
169     if (is&lt;HTMLVideoElement&gt;(node))
170         return downcast&lt;HTMLVideoElement&gt;(&amp;node);
171 
172     return descendantsOfType&lt;HTMLVideoElement&gt;(node).first();
173 }
174 
175 static inline HTMLVideoElement* ancestorVideoElement(Node* node)
176 {
177     while (node &amp;&amp; !is&lt;HTMLVideoElement&gt;(*node))
178         node = node-&gt;parentOrShadowHostNode();
179 
</pre>
<hr />
<pre>
211         return;
212     auto&amp; targetContainer = downcast&lt;ContainerNode&gt;(targetNode);
213 
214     if (event.type() == eventNames().keydownEvent &amp;&amp; is&lt;KeyboardEvent&gt;(event)) {
215         auto video = makeRefPtr(descendantVideoElement(targetContainer));
216         if (!video)
217             return;
218 
219         auto&amp; keyboardEvent = downcast&lt;KeyboardEvent&gt;(event);
220         if (keyboardEvent.keyIdentifier() == &quot;U+0020&quot;) { // space
221             if (video-&gt;paused()) {
222                 if (video-&gt;canPlay())
223                     video-&gt;play();
224             } else
225                 video-&gt;pause();
226             keyboardEvent.setDefaultHandled();
227         }
228     }
229 }
230 
<span class="line-removed">231 void MediaDocument::mediaElementSawUnsupportedTracks()</span>
<span class="line-removed">232 {</span>
<span class="line-removed">233     // The HTMLMediaElement was told it has something that the underlying</span>
<span class="line-removed">234     // MediaPlayer cannot handle so we should switch from &lt;video&gt; to &lt;embed&gt;</span>
<span class="line-removed">235     // and let the plugin handle this. Don&#39;t do it immediately as this</span>
<span class="line-removed">236     // function may be called directly from a media engine callback, and</span>
<span class="line-removed">237     // replaceChild will destroy the element, media player, and media engine.</span>
<span class="line-removed">238     m_replaceMediaElementTimer.startOneShot(0_s);</span>
<span class="line-removed">239 }</span>
<span class="line-removed">240 </span>
241 void MediaDocument::replaceMediaElementTimerFired()
242 {
243     auto htmlBody = makeRefPtr(bodyOrFrameset());
244     if (!htmlBody)
245         return;
246 
247     // Set body margin width and height to 0 as that is what a PluginDocument uses.
248     htmlBody-&gt;setAttributeWithoutSynchronization(marginwidthAttr, AtomString(&quot;0&quot;, AtomString::ConstructFromLiteral));
249     htmlBody-&gt;setAttributeWithoutSynchronization(marginheightAttr, AtomString(&quot;0&quot;, AtomString::ConstructFromLiteral));
250 
251     if (auto videoElement = makeRefPtr(descendantVideoElement(*htmlBody))) {
252         auto embedElement = HTMLEmbedElement::create(*this);
253 
254         embedElement-&gt;setAttributeWithoutSynchronization(widthAttr, AtomString(&quot;100%&quot;, AtomString::ConstructFromLiteral));
255         embedElement-&gt;setAttributeWithoutSynchronization(heightAttr, AtomString(&quot;100%&quot;, AtomString::ConstructFromLiteral));
256         embedElement-&gt;setAttributeWithoutSynchronization(nameAttr, AtomString(&quot;plugin&quot;, AtomString::ConstructFromLiteral));
257         embedElement-&gt;setAttributeWithoutSynchronization(srcAttr, url().string());
258 
259         ASSERT(loader());
260         if (auto loader = makeRefPtr(this-&gt;loader()))
</pre>
</td>
<td>
<hr />
<pre>
127 
128     body-&gt;appendChild(videoElement);
129 
130     RefPtr&lt;Frame&gt; frame = document.frame();
131     if (!frame)
132         return;
133 
134     frame-&gt;loader().activeDocumentLoader()-&gt;setMainResourceDataBufferingPolicy(DataBufferingPolicy::DoNotBufferData);
135     frame-&gt;loader().setOutgoingReferrer(document.completeURL(m_outgoingReferrer));
136 }
137 
138 void MediaDocumentParser::appendBytes(DocumentWriter&amp;, const char*, size_t)
139 {
140     if (m_mediaElement)
141         return;
142 
143     createDocumentStructure();
144     finish();
145 }
146 
<span class="line-modified">147 MediaDocument::MediaDocument(Frame* frame, const URL&amp; url)</span>
<span class="line-modified">148     : HTMLDocument(frame, url, MediaDocumentClass)</span>

149 {
150     setCompatibilityMode(DocumentCompatibilityMode::QuirksMode);
151     lockCompatibilityMode();
152     if (frame)
153         m_outgoingReferrer = frame-&gt;loader().outgoingReferrer();
154 }
155 
156 MediaDocument::~MediaDocument()
157 {

158 }
159 
160 Ref&lt;DocumentParser&gt; MediaDocument::createParser()
161 {
162     return MediaDocumentParser::create(*this);
163 }
164 
165 static inline HTMLVideoElement* descendantVideoElement(ContainerNode&amp; node)
166 {
167     if (is&lt;HTMLVideoElement&gt;(node))
168         return downcast&lt;HTMLVideoElement&gt;(&amp;node);
169 
170     return descendantsOfType&lt;HTMLVideoElement&gt;(node).first();
171 }
172 
173 static inline HTMLVideoElement* ancestorVideoElement(Node* node)
174 {
175     while (node &amp;&amp; !is&lt;HTMLVideoElement&gt;(*node))
176         node = node-&gt;parentOrShadowHostNode();
177 
</pre>
<hr />
<pre>
209         return;
210     auto&amp; targetContainer = downcast&lt;ContainerNode&gt;(targetNode);
211 
212     if (event.type() == eventNames().keydownEvent &amp;&amp; is&lt;KeyboardEvent&gt;(event)) {
213         auto video = makeRefPtr(descendantVideoElement(targetContainer));
214         if (!video)
215             return;
216 
217         auto&amp; keyboardEvent = downcast&lt;KeyboardEvent&gt;(event);
218         if (keyboardEvent.keyIdentifier() == &quot;U+0020&quot;) { // space
219             if (video-&gt;paused()) {
220                 if (video-&gt;canPlay())
221                     video-&gt;play();
222             } else
223                 video-&gt;pause();
224             keyboardEvent.setDefaultHandled();
225         }
226     }
227 }
228 










229 void MediaDocument::replaceMediaElementTimerFired()
230 {
231     auto htmlBody = makeRefPtr(bodyOrFrameset());
232     if (!htmlBody)
233         return;
234 
235     // Set body margin width and height to 0 as that is what a PluginDocument uses.
236     htmlBody-&gt;setAttributeWithoutSynchronization(marginwidthAttr, AtomString(&quot;0&quot;, AtomString::ConstructFromLiteral));
237     htmlBody-&gt;setAttributeWithoutSynchronization(marginheightAttr, AtomString(&quot;0&quot;, AtomString::ConstructFromLiteral));
238 
239     if (auto videoElement = makeRefPtr(descendantVideoElement(*htmlBody))) {
240         auto embedElement = HTMLEmbedElement::create(*this);
241 
242         embedElement-&gt;setAttributeWithoutSynchronization(widthAttr, AtomString(&quot;100%&quot;, AtomString::ConstructFromLiteral));
243         embedElement-&gt;setAttributeWithoutSynchronization(heightAttr, AtomString(&quot;100%&quot;, AtomString::ConstructFromLiteral));
244         embedElement-&gt;setAttributeWithoutSynchronization(nameAttr, AtomString(&quot;plugin&quot;, AtomString::ConstructFromLiteral));
245         embedElement-&gt;setAttributeWithoutSynchronization(srcAttr, url().string());
246 
247         ASSERT(loader());
248         if (auto loader = makeRefPtr(this-&gt;loader()))
</pre>
</td>
</tr>
</table>
<center><a href="LinkRelAttribute.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="MediaDocument.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>