<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/WebCore/platform/network/ResourceRequestBase.h</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (C) 2003, 2006 Apple Inc.  All rights reserved.
  3  * Copyright (C) 2006 Samuel Weinig &lt;sam.weinig@gmail.com&gt;
  4  * Copyright (C) 2009, 2012 Google Inc. All rights reserved.
  5  *
  6  * Redistribution and use in source and binary forms, with or without
  7  * modification, are permitted provided that the following conditions
  8  * are met:
  9  * 1. Redistributions of source code must retain the above copyright
 10  *    notice, this list of conditions and the following disclaimer.
 11  * 2. Redistributions in binary form must reproduce the above copyright
 12  *    notice, this list of conditions and the following disclaimer in the
 13  *    documentation and/or other materials provided with the distribution.
 14  *
 15  * THIS SOFTWARE IS PROVIDED BY APPLE INC. ``AS IS&#39;&#39; AND ANY
 16  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 17  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 18  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE INC. OR
 19  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 20  * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 21  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 22  * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 23  * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 24  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 25  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 26  */
 27 
 28 #ifndef ResourceRequestBase_h
 29 #define ResourceRequestBase_h
 30 
 31 #include &quot;FormData.h&quot;
<a name="1" id="anc1"></a><span class="line-added"> 32 #include &quot;FrameLoaderTypes.h&quot;</span>
 33 #include &quot;HTTPHeaderMap.h&quot;
 34 #include &quot;IntRect.h&quot;
 35 #include &quot;ResourceLoadPriority.h&quot;
 36 #include &lt;wtf/URL.h&gt;
 37 
 38 namespace WebCore {
 39 
 40 enum class ResourceRequestCachePolicy : uint8_t {
 41     UseProtocolCachePolicy, // normal load, equivalent to fetch &quot;default&quot; cache mode.
 42     ReloadIgnoringCacheData, // reload, equivalent to fetch &quot;reload&quot;cache mode.
 43     ReturnCacheDataElseLoad, // back/forward or encoding change - allow stale data, equivalent to fetch &quot;force-cache&quot; cache mode.
 44     ReturnCacheDataDontLoad, // results of a post - allow stale data and only use cache, equivalent to fetch &quot;only-if-cached&quot; cache mode.
 45     DoNotUseAnyCache, // Bypass the cache entirely, equivalent to fetch &quot;no-store&quot; cache mode.
 46     RefreshAnyCacheData, // Serve cache data only if revalidated, equivalent to fetch &quot;no-cache&quot; mode.
 47 };
 48 
 49 enum HTTPBodyUpdatePolicy : uint8_t {
 50     DoNotUpdateHTTPBody,
 51     UpdateHTTPBody
 52 };
 53 
 54 class ResourceRequest;
 55 class ResourceResponse;
 56 
 57 // Do not use this type directly.  Use ResourceRequest instead.
 58 class ResourceRequestBase {
 59     WTF_MAKE_FAST_ALLOCATED;
 60 public:
 61     WEBCORE_EXPORT ResourceRequest isolatedCopy() const;
 62     WEBCORE_EXPORT void setAsIsolatedCopy(const ResourceRequest&amp;);
 63 
 64     WEBCORE_EXPORT bool isNull() const;
 65     WEBCORE_EXPORT bool isEmpty() const;
 66 
 67     WEBCORE_EXPORT const URL&amp; url() const;
 68     WEBCORE_EXPORT void setURL(const URL&amp; url);
 69 
 70     WEBCORE_EXPORT ResourceRequest redirectedRequest(const ResourceResponse&amp;, bool shouldClearReferrerOnHTTPSToHTTPRedirect) const;
 71 
 72     WEBCORE_EXPORT void removeCredentials();
 73 
 74     WEBCORE_EXPORT ResourceRequestCachePolicy cachePolicy() const;
 75     WEBCORE_EXPORT void setCachePolicy(ResourceRequestCachePolicy cachePolicy);
 76 
<a name="2" id="anc2"></a><span class="line-modified"> 77     WEBCORE_EXPORT double timeoutInterval() const; // May return 0 when using platform default.</span>
 78     void setTimeoutInterval(double timeoutInterval);
 79 
 80     WEBCORE_EXPORT const URL&amp; firstPartyForCookies() const;
 81     WEBCORE_EXPORT void setFirstPartyForCookies(const URL&amp;);
 82 
 83     // Same-Site cookies; see &lt;https://tools.ietf.org/html/draft-ietf-httpbis-cookie-same-site-00#section-2.1&gt;
 84     // and &lt;https://tools.ietf.org/html/draft-ietf-httpbis-cookie-same-site-00#section-5.2&gt;.
 85     // FIXME: For some reason the main resource request may be updated more than once. We start off as Unspecified
 86     // to detect if we need to compute the same-site and top-site state or not. See FIXME in DocumentLoader::startLoadingMainResource().
 87     enum class SameSiteDisposition : uint8_t { Unspecified, SameSite, CrossSite };
 88     bool isSameSiteUnspecified() const { return m_sameSiteDisposition == SameSiteDisposition::Unspecified; }
 89     WEBCORE_EXPORT bool isSameSite() const; // Whether this request&#39;s registrable domain matches the request&#39;s initiator&#39;s &quot;site for cookies&quot;.
 90     WEBCORE_EXPORT void setIsSameSite(bool);
 91     WEBCORE_EXPORT bool isTopSite() const; // Whether this request is for a top-level navigation.
 92     WEBCORE_EXPORT void setIsTopSite(bool);
 93 
 94     WEBCORE_EXPORT const String&amp; httpMethod() const;
 95     WEBCORE_EXPORT void setHTTPMethod(const String&amp; httpMethod);
 96 
 97     WEBCORE_EXPORT const HTTPHeaderMap&amp; httpHeaderFields() const;
 98     WEBCORE_EXPORT void setHTTPHeaderFields(HTTPHeaderMap);
 99 
100     WEBCORE_EXPORT String httpHeaderField(const String&amp; name) const;
101     WEBCORE_EXPORT String httpHeaderField(HTTPHeaderName) const;
102     WEBCORE_EXPORT void setHTTPHeaderField(const String&amp; name, const String&amp; value);
103     WEBCORE_EXPORT void setHTTPHeaderField(HTTPHeaderName, const String&amp; value);
104     WEBCORE_EXPORT void addHTTPHeaderField(HTTPHeaderName, const String&amp; value);
105     WEBCORE_EXPORT void addHTTPHeaderField(const String&amp; name, const String&amp; value);
106     WEBCORE_EXPORT void addHTTPHeaderFieldIfNotPresent(HTTPHeaderName, const String&amp;);
107 
108     WEBCORE_EXPORT bool hasHTTPHeaderField(HTTPHeaderName) const;
109 
110     // Instead of passing a string literal to any of these functions, just use a HTTPHeaderName instead.
111     template&lt;size_t length&gt; String httpHeaderField(const char (&amp;)[length]) const = delete;
112     template&lt;size_t length&gt; void setHTTPHeaderField(const char (&amp;)[length], const String&amp;) = delete;
113     template&lt;size_t length&gt; void addHTTPHeaderField(const char (&amp;)[length], const String&amp;) = delete;
114 
115     WEBCORE_EXPORT void clearHTTPAuthorization();
116 
117     WEBCORE_EXPORT String httpContentType() const;
118     WEBCORE_EXPORT void setHTTPContentType(const String&amp;);
119     WEBCORE_EXPORT void clearHTTPContentType();
120 
121     bool hasHTTPHeader(HTTPHeaderName) const;
122 
123     WEBCORE_EXPORT String httpReferrer() const;
124     bool hasHTTPReferrer() const;
125     WEBCORE_EXPORT void setHTTPReferrer(const String&amp;);
126     WEBCORE_EXPORT void setExistingHTTPReferrerToOriginString();
127     WEBCORE_EXPORT void clearHTTPReferrer();
128 
129     WEBCORE_EXPORT String httpOrigin() const;
130     bool hasHTTPOrigin() const;
131     void setHTTPOrigin(const String&amp;);
132     WEBCORE_EXPORT void clearHTTPOrigin();
133 
134     WEBCORE_EXPORT String httpUserAgent() const;
135     WEBCORE_EXPORT void setHTTPUserAgent(const String&amp;);
136     void clearHTTPUserAgent();
137 
138     String httpAccept() const;
139     void setHTTPAccept(const String&amp;);
140     void clearHTTPAccept();
141 
142     void clearHTTPAcceptEncoding();
143 
144     WEBCORE_EXPORT void clearPurpose();
145 
146     const Vector&lt;String&gt;&amp; responseContentDispositionEncodingFallbackArray() const { return m_responseContentDispositionEncodingFallbackArray; }
147     WEBCORE_EXPORT void setResponseContentDispositionEncodingFallbackArray(const String&amp; encoding1, const String&amp; encoding2 = String(), const String&amp; encoding3 = String());
148 
149     WEBCORE_EXPORT FormData* httpBody() const;
150     WEBCORE_EXPORT bool hasUpload() const;
151     WEBCORE_EXPORT void setHTTPBody(RefPtr&lt;FormData&gt;&amp;&amp;);
152 
153     bool allowCookies() const;
154     void setAllowCookies(bool allowCookies);
155 
156     WEBCORE_EXPORT ResourceLoadPriority priority() const;
157     WEBCORE_EXPORT void setPriority(ResourceLoadPriority);
158 
159     WEBCORE_EXPORT static String partitionName(const String&amp; domain);
160     const String&amp; cachePartition() const { return m_cachePartition; }
161     WEBCORE_EXPORT void setCachePartition(const String&amp;);
162     void setDomainForCachePartition(const String&amp; domain) { setCachePartition(partitionName(domain)); }
163 
164     WEBCORE_EXPORT bool isConditional() const;
165     WEBCORE_EXPORT void makeUnconditional();
166 
167     // Whether this request should be hidden from the Inspector.
168     bool hiddenFromInspector() const { return m_hiddenFromInspector; }
169     void setHiddenFromInspector(bool hiddenFromInspector) { m_hiddenFromInspector = hiddenFromInspector; }
170 
171     enum class Requester : uint8_t { Unspecified, Main, XHR, Fetch, Media, ImportScripts };
172     Requester requester() const { return m_requester; }
173     void setRequester(Requester requester) { m_requester = requester; }
174 
175     // Who initiated the request so the Inspector can associate it with a context. E.g. a Web Worker.
176     String initiatorIdentifier() const { return m_initiatorIdentifier; }
177     void setInitiatorIdentifier(const String&amp; identifier) { m_initiatorIdentifier = identifier; }
178 
179     // Additional information for the Inspector to be able to identify the node that initiated this request.
180     const Optional&lt;int&gt;&amp; inspectorInitiatorNodeIdentifier() const { return m_inspectorInitiatorNodeIdentifier; }
181     void setInspectorInitiatorNodeIdentifier(int inspectorInitiatorNodeIdentifier) { m_inspectorInitiatorNodeIdentifier = inspectorInitiatorNodeIdentifier; }
182 
183 #if USE(SYSTEM_PREVIEW)
184     WEBCORE_EXPORT bool isSystemPreview() const;
<a name="3" id="anc3"></a>
185 
<a name="4" id="anc4"></a><span class="line-modified">186     WEBCORE_EXPORT SystemPreviewInfo systemPreviewInfo() const;</span>
<span class="line-modified">187     WEBCORE_EXPORT void setSystemPreviewInfo(const SystemPreviewInfo&amp;);</span>
188 #endif
189 
190 #if !PLATFORM(COCOA)
191     bool encodingRequiresPlatformData() const { return true; }
192 #endif
193     template&lt;class Encoder&gt; void encodeWithoutPlatformData(Encoder&amp;) const;
194     template&lt;class Decoder&gt; bool decodeWithoutPlatformData(Decoder&amp;);
195 
196     WEBCORE_EXPORT static double defaultTimeoutInterval(); // May return 0 when using platform default.
197     WEBCORE_EXPORT static void setDefaultTimeoutInterval(double);
198 
199     WEBCORE_EXPORT static bool equal(const ResourceRequest&amp;, const ResourceRequest&amp;);
200 
201 protected:
202     // Used when ResourceRequest is initialized from a platform representation of the request
203     ResourceRequestBase()
<a name="5" id="anc5"></a><span class="line-modified">204         : m_allowCookies(false)</span>
<span class="line-added">205         , m_resourceRequestUpdated(false)</span>
<span class="line-added">206         , m_platformRequestUpdated(true)</span>
<span class="line-added">207         , m_resourceRequestBodyUpdated(false)</span>
208         , m_platformRequestBodyUpdated(true)
<a name="6" id="anc6"></a><span class="line-added">209         , m_hiddenFromInspector(false)</span>
<span class="line-added">210         , m_isTopSite(false)</span>
211     {
212     }
213 
214     ResourceRequestBase(const URL&amp; url, ResourceRequestCachePolicy policy)
215         : m_url(url)
216         , m_timeoutInterval(s_defaultTimeoutInterval)
217         , m_httpMethod(&quot;GET&quot;_s)
218         , m_cachePolicy(policy)
219         , m_allowCookies(true)
220         , m_resourceRequestUpdated(true)
<a name="7" id="anc7"></a><span class="line-added">221         , m_platformRequestUpdated(false)</span>
222         , m_resourceRequestBodyUpdated(true)
<a name="8" id="anc8"></a><span class="line-added">223         , m_platformRequestBodyUpdated(false)</span>
<span class="line-added">224         , m_hiddenFromInspector(false)</span>
<span class="line-added">225         , m_isTopSite(false)</span>
226     {
227     }
228 
229     void updatePlatformRequest(HTTPBodyUpdatePolicy = HTTPBodyUpdatePolicy::DoNotUpdateHTTPBody) const;
230     void updateResourceRequest(HTTPBodyUpdatePolicy = HTTPBodyUpdatePolicy::DoNotUpdateHTTPBody) const;
231 
232     template&lt;class Encoder&gt; void encodeBase(Encoder&amp;) const;
233     template&lt;class Decoder&gt; bool decodeBase(Decoder&amp;);
234 
235     // The ResourceRequest subclass may &quot;shadow&quot; this method to compare platform specific fields
236     static bool platformCompare(const ResourceRequest&amp;, const ResourceRequest&amp;) { return true; }
237 
238     URL m_url;
239     double m_timeoutInterval; // 0 is a magic value for platform default on platforms that have one.
240     URL m_firstPartyForCookies;
241     String m_httpMethod;
242     String m_initiatorIdentifier;
243     String m_cachePartition { emptyString() };
244     HTTPHeaderMap m_httpHeaderFields;
245     Vector&lt;String&gt; m_responseContentDispositionEncodingFallbackArray;
246     RefPtr&lt;FormData&gt; m_httpBody;
247     ResourceRequestCachePolicy m_cachePolicy { ResourceRequestCachePolicy::UseProtocolCachePolicy };
248     SameSiteDisposition m_sameSiteDisposition { SameSiteDisposition::Unspecified };
249     ResourceLoadPriority m_priority { ResourceLoadPriority::Low };
250     Requester m_requester { Requester::Unspecified };
251     Optional&lt;int&gt; m_inspectorInitiatorNodeIdentifier;
<a name="9" id="anc9"></a><span class="line-modified">252     bool m_allowCookies : 1;</span>
<span class="line-modified">253     mutable bool m_resourceRequestUpdated : 1;</span>
<span class="line-modified">254     mutable bool m_platformRequestUpdated : 1;</span>
<span class="line-modified">255     mutable bool m_resourceRequestBodyUpdated : 1;</span>
<span class="line-modified">256     mutable bool m_platformRequestBodyUpdated : 1;</span>
<span class="line-modified">257     bool m_hiddenFromInspector : 1;</span>
<span class="line-modified">258     bool m_isTopSite : 1;</span>
259 #if USE(SYSTEM_PREVIEW)
<a name="10" id="anc10"></a><span class="line-modified">260     Optional&lt;SystemPreviewInfo&gt; m_systemPreviewInfo;</span>

261 #endif
262 
263 private:
264     const ResourceRequest&amp; asResourceRequest() const;
265 
266     WEBCORE_EXPORT static double s_defaultTimeoutInterval;
267 };
268 
269 bool equalIgnoringHeaderFields(const ResourceRequestBase&amp;, const ResourceRequestBase&amp;);
270 
271 inline bool operator==(const ResourceRequest&amp; a, const ResourceRequest&amp; b) { return ResourceRequestBase::equal(a, b); }
272 inline bool operator!=(ResourceRequest&amp; a, const ResourceRequest&amp; b) { return !(a == b); }
273 
274 WEBCORE_EXPORT unsigned initializeMaximumHTTPConnectionCountPerHost();
275 #if PLATFORM(IOS_FAMILY)
276 WEBCORE_EXPORT void initializeHTTPConnectionSettingsOnStartup();
277 #endif
278 
279 template&lt;class Encoder&gt;
280 ALWAYS_INLINE void ResourceRequestBase::encodeBase(Encoder&amp; encoder) const
281 {
282     encoder &lt;&lt; m_url;
283     encoder &lt;&lt; m_timeoutInterval;
284     encoder &lt;&lt; m_firstPartyForCookies.string();
285     encoder &lt;&lt; m_httpMethod;
286     encoder &lt;&lt; m_httpHeaderFields;
287     encoder &lt;&lt; m_responseContentDispositionEncodingFallbackArray;
288     encoder.encodeEnum(m_cachePolicy);
289     encoder &lt;&lt; m_allowCookies;
290     encoder.encodeEnum(m_sameSiteDisposition);
291     encoder &lt;&lt; m_isTopSite;
292     encoder.encodeEnum(m_priority);
293     encoder.encodeEnum(m_requester);
294 }
295 
296 template&lt;class Decoder&gt;
297 ALWAYS_INLINE bool ResourceRequestBase::decodeBase(Decoder&amp; decoder)
298 {
299     if (!decoder.decode(m_url))
300         return false;
301 
302     if (!decoder.decode(m_timeoutInterval))
303         return false;
304 
305     String firstPartyForCookies;
306     if (!decoder.decode(firstPartyForCookies))
307         return false;
308     m_firstPartyForCookies = URL({ }, firstPartyForCookies);
309 
310     if (!decoder.decode(m_httpMethod))
311         return false;
312 
313     if (!decoder.decode(m_httpHeaderFields))
314         return false;
315 
316     if (!decoder.decode(m_responseContentDispositionEncodingFallbackArray))
317         return false;
318 
319     ResourceRequestCachePolicy cachePolicy;
320     if (!decoder.decodeEnum(cachePolicy))
321         return false;
322     m_cachePolicy = cachePolicy;
323 
324     bool allowCookies;
325     if (!decoder.decode(allowCookies))
326         return false;
327     m_allowCookies = allowCookies;
328 
329     SameSiteDisposition sameSiteDisposition;
330     if (!decoder.decodeEnum(sameSiteDisposition))
331         return false;
332     m_sameSiteDisposition = sameSiteDisposition;
333 
334     bool isTopSite;
335     if (!decoder.decode(isTopSite))
336         return false;
337     m_isTopSite = isTopSite;
338 
339     ResourceLoadPriority priority;
340     if (!decoder.decodeEnum(priority))
341         return false;
342     m_priority = priority;
343 
344     if (!decoder.decodeEnum(m_requester))
345         return false;
346 
347     return true;
348 }
349 
350 template&lt;class Encoder&gt;
351 void ResourceRequestBase::encodeWithoutPlatformData(Encoder&amp; encoder) const
352 {
353     ASSERT(!m_httpBody);
354     ASSERT(!m_platformRequestUpdated);
355     encodeBase(encoder);
356 }
357 
358 template&lt;class Decoder&gt;
359 bool ResourceRequestBase::decodeWithoutPlatformData(Decoder&amp; decoder)
360 {
361     return decodeBase(decoder);
362 }
363 
364 } // namespace WebCore
365 
366 #endif // ResourceRequestBase_h
<a name="11" id="anc11"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="11" type="hidden" />
</body>
</html>