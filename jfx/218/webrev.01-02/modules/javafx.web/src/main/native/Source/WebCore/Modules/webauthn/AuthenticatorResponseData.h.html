<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New modules/javafx.web/src/main/native/Source/WebCore/Modules/webauthn/AuthenticatorResponseData.h</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (C) 2018 Apple Inc. All rights reserved.
  3  *
  4  * Redistribution and use in source and binary forms, with or without
  5  * modification, are permitted provided that the following conditions
  6  * are met:
  7  * 1. Redistributions of source code must retain the above copyright
  8  *    notice, this list of conditions and the following disclaimer.
  9  * 2. Redistributions in binary form must reproduce the above copyright
 10  *    notice, this list of conditions and the following disclaimer in the
 11  *    documentation and/or other materials provided with the distribution.
 12  *
 13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. AND ITS CONTRIBUTORS ``AS IS&#39;&#39;
 14  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
 15  * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 16  * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL APPLE INC. OR ITS CONTRIBUTORS
 17  * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 18  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 19  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 20  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 21  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 22  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF
 23  * THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #pragma once
 27 
 28 #if ENABLE(WEB_AUTHN)
 29 
 30 #include &lt;JavaScriptCore/ArrayBuffer.h&gt;
 31 #include &lt;wtf/Forward.h&gt;
 32 
 33 namespace WebCore {
 34 
 35 class AuthenticatorResponse;
 36 
 37 struct AuthenticatorResponseData {
 38     bool isAuthenticatorAttestationResponse;
 39 
 40     // AuthenticatorResponse
 41     RefPtr&lt;ArrayBuffer&gt; rawId;
 42 
 43     // Extensions
 44     Optional&lt;bool&gt; appid;
 45 
 46     // AuthenticatorAttestationResponse
 47     RefPtr&lt;ArrayBuffer&gt; attestationObject;
 48 
 49     // AuthenticatorAssertionResponse
 50     RefPtr&lt;ArrayBuffer&gt; authenticatorData;
 51     RefPtr&lt;ArrayBuffer&gt; signature;
 52     RefPtr&lt;ArrayBuffer&gt; userHandle;
 53 
 54     template&lt;class Encoder&gt; void encode(Encoder&amp;) const;
 55     template&lt;class Decoder&gt; static Optional&lt;AuthenticatorResponseData&gt; decode(Decoder&amp;);
 56 };
 57 
 58 template&lt;class Encoder&gt;
 59 void AuthenticatorResponseData::encode(Encoder&amp; encoder) const
 60 {
 61     if (!rawId) {
 62         encoder &lt;&lt; true;
 63         return;
 64     }
 65     encoder &lt;&lt; false;
 66 
 67     encoder &lt;&lt; static_cast&lt;uint64_t&gt;(rawId-&gt;byteLength());
 68     encoder.encodeFixedLengthData(reinterpret_cast&lt;const uint8_t*&gt;(rawId-&gt;data()), rawId-&gt;byteLength(), 1);
 69 
 70     encoder &lt;&lt; isAuthenticatorAttestationResponse;
 71 
 72     if (isAuthenticatorAttestationResponse &amp;&amp; attestationObject) {
 73         encoder &lt;&lt; static_cast&lt;uint64_t&gt;(attestationObject-&gt;byteLength());
 74         encoder.encodeFixedLengthData(reinterpret_cast&lt;const uint8_t*&gt;(attestationObject-&gt;data()), attestationObject-&gt;byteLength(), 1);
 75         return;
 76     }
 77 
 78     if (!authenticatorData || !signature)
 79         return;
 80     encoder &lt;&lt; static_cast&lt;uint64_t&gt;(authenticatorData-&gt;byteLength());
 81     encoder.encodeFixedLengthData(reinterpret_cast&lt;const uint8_t*&gt;(authenticatorData-&gt;data()), authenticatorData-&gt;byteLength(), 1);
 82     encoder &lt;&lt; static_cast&lt;uint64_t&gt;(signature-&gt;byteLength());
 83     encoder.encodeFixedLengthData(reinterpret_cast&lt;const uint8_t*&gt;(signature-&gt;data()), signature-&gt;byteLength(), 1);
 84 
 85     // Encode AppID before user handle to avoid the userHandle flag.
 86     encoder &lt;&lt; appid;
 87 
 88     if (!userHandle) {
 89         encoder &lt;&lt; false;
 90         return;
 91     }
 92     encoder &lt;&lt; true;
 93     encoder &lt;&lt; static_cast&lt;uint64_t&gt;(userHandle-&gt;byteLength());
 94     encoder.encodeFixedLengthData(reinterpret_cast&lt;const uint8_t*&gt;(userHandle-&gt;data()), userHandle-&gt;byteLength(), 1);
 95 }
 96 
 97 template&lt;class Decoder&gt;
 98 Optional&lt;AuthenticatorResponseData&gt; AuthenticatorResponseData::decode(Decoder&amp; decoder)
 99 {
100     AuthenticatorResponseData result;
101 
102     Optional&lt;bool&gt; isEmpty;
103     decoder &gt;&gt; isEmpty;
104     if (!isEmpty)
105         return WTF::nullopt;
106     if (isEmpty.value())
107         return result;
108 
109     Optional&lt;uint64_t&gt; rawIdLength;
110     decoder &gt;&gt; rawIdLength;
111     if (!rawIdLength)
112         return WTF::nullopt;
113 
114     result.rawId = ArrayBuffer::create(rawIdLength.value(), sizeof(uint8_t));
115     if (!decoder.decodeFixedLengthData(reinterpret_cast&lt;uint8_t*&gt;(result.rawId-&gt;data()), rawIdLength.value(), 1))
116         return WTF::nullopt;
117 
118     Optional&lt;bool&gt; isAuthenticatorAttestationResponse;
119     decoder &gt;&gt; isAuthenticatorAttestationResponse;
120     if (!isAuthenticatorAttestationResponse)
121         return WTF::nullopt;
122     result.isAuthenticatorAttestationResponse = isAuthenticatorAttestationResponse.value();
123 
124     if (result.isAuthenticatorAttestationResponse) {
125         Optional&lt;uint64_t&gt; attestationObjectLength;
126         decoder &gt;&gt; attestationObjectLength;
127         if (!attestationObjectLength)
128             return WTF::nullopt;
129 
130         result.attestationObject = ArrayBuffer::create(attestationObjectLength.value(), sizeof(uint8_t));
131         if (!decoder.decodeFixedLengthData(reinterpret_cast&lt;uint8_t*&gt;(result.attestationObject-&gt;data()), attestationObjectLength.value(), 1))
132             return WTF::nullopt;
133 
134         return result;
135     }
136 
137     Optional&lt;uint64_t&gt; authenticatorDataLength;
138     decoder &gt;&gt; authenticatorDataLength;
139     if (!authenticatorDataLength)
140         return WTF::nullopt;
141 
142     result.authenticatorData = ArrayBuffer::create(authenticatorDataLength.value(), sizeof(uint8_t));
143     if (!decoder.decodeFixedLengthData(reinterpret_cast&lt;uint8_t*&gt;(result.authenticatorData-&gt;data()), authenticatorDataLength.value(), 1))
144         return WTF::nullopt;
145 
146     Optional&lt;uint64_t&gt; signatureLength;
147     decoder &gt;&gt; signatureLength;
148     if (!signatureLength)
149         return WTF::nullopt;
150 
151     result.signature = ArrayBuffer::create(signatureLength.value(), sizeof(uint8_t));
152     if (!decoder.decodeFixedLengthData(reinterpret_cast&lt;uint8_t*&gt;(result.signature-&gt;data()), signatureLength.value(), 1))
153         return WTF::nullopt;
154 
155     Optional&lt;Optional&lt;bool&gt;&gt; appid;
156     decoder &gt;&gt; appid;
157     if (!appid)
158         return WTF::nullopt;
159     result.appid = WTFMove(*appid);
160 
161     Optional&lt;bool&gt; hasUserHandle;
162     decoder &gt;&gt; hasUserHandle;
163     if (!hasUserHandle)
164         return WTF::nullopt;
165     if (!*hasUserHandle)
166         return result;
167 
168     Optional&lt;uint64_t&gt; userHandleLength;
169     decoder &gt;&gt; userHandleLength;
170     if (!userHandleLength)
171         return WTF::nullopt;
172 
173     result.userHandle = ArrayBuffer::create(userHandleLength.value(), sizeof(uint8_t));
174     if (!decoder.decodeFixedLengthData(reinterpret_cast&lt;uint8_t*&gt;(result.userHandle-&gt;data()), userHandleLength.value(), 1))
175         return WTF::nullopt;
176 
177     return result;
178 }
179 
180 } // namespace WebCore
181 
182 #endif // ENABLE(WEB_AUTHN)
    </pre>
  </body>
</html>