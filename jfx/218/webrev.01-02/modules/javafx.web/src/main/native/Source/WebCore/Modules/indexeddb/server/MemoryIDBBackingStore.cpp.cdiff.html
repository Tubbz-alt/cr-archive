<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.web/src/main/native/Source/WebCore/Modules/indexeddb/server/MemoryIDBBackingStore.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="MemoryCursor.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="MemoryIDBBackingStore.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/Modules/indexeddb/server/MemoryIDBBackingStore.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 41,17 ***</span>
  #include &quot;MemoryObjectStoreCursor.h&quot;
  
  namespace WebCore {
  namespace IDBServer {
  
<span class="line-modified">! // The IndexedDB spec states the value you can get from the key generator is 2^53</span>
<span class="line-modified">! static uint64_t maxGeneratedKeyValue = 0x20000000000000;</span>
<span class="line-removed">- </span>
<span class="line-removed">- std::unique_ptr&lt;MemoryIDBBackingStore&gt; MemoryIDBBackingStore::create(PAL::SessionID sessionID, const IDBDatabaseIdentifier&amp; identifier)</span>
<span class="line-removed">- {</span>
<span class="line-removed">-     return makeUnique&lt;MemoryIDBBackingStore&gt;(sessionID, identifier);</span>
<span class="line-removed">- }</span>
  
  MemoryIDBBackingStore::MemoryIDBBackingStore(PAL::SessionID sessionID, const IDBDatabaseIdentifier&amp; identifier)
      : m_identifier(identifier)
      , m_sessionID(sessionID)
  {
<span class="line-new-header">--- 41,12 ---</span>
  #include &quot;MemoryObjectStoreCursor.h&quot;
  
  namespace WebCore {
  namespace IDBServer {
  
<span class="line-modified">! // The IndexedDB spec states the maximum value you can get from the key generator is 2^53.</span>
<span class="line-modified">! constexpr uint64_t maxGeneratedKeyValue = 0x20000000000000;</span>
  
  MemoryIDBBackingStore::MemoryIDBBackingStore(PAL::SessionID sessionID, const IDBDatabaseIdentifier&amp; identifier)
      : m_identifier(identifier)
      , m_sessionID(sessionID)
  {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 60,11 ***</span>
  MemoryIDBBackingStore::~MemoryIDBBackingStore() = default;
  
  IDBError MemoryIDBBackingStore::getOrEstablishDatabaseInfo(IDBDatabaseInfo&amp; info)
  {
      if (!m_databaseInfo)
<span class="line-modified">!         m_databaseInfo = makeUnique&lt;IDBDatabaseInfo&gt;(m_identifier.databaseName(), 0);</span>
  
      info = *m_databaseInfo;
      return IDBError { };
  }
  
<span class="line-new-header">--- 55,11 ---</span>
  MemoryIDBBackingStore::~MemoryIDBBackingStore() = default;
  
  IDBError MemoryIDBBackingStore::getOrEstablishDatabaseInfo(IDBDatabaseInfo&amp; info)
  {
      if (!m_databaseInfo)
<span class="line-modified">!         m_databaseInfo = makeUnique&lt;IDBDatabaseInfo&gt;(m_identifier.databaseName(), 0, 0);</span>
  
      info = *m_databaseInfo;
      return IDBError { };
  }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 192,10 ***</span>
<span class="line-new-header">--- 187,13 ---</span>
  
      String oldName = objectStore-&gt;info().name();
      objectStore-&gt;rename(newName);
      transaction-&gt;objectStoreRenamed(*objectStore, oldName);
  
<span class="line-added">+     m_objectStoresByName.remove(oldName);</span>
<span class="line-added">+     m_objectStoresByName.set(newName, objectStore);</span>
<span class="line-added">+ </span>
      m_databaseInfo-&gt;renameObjectStore(objectStoreIdentifier, newName);
  
      return IDBError { };
  }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 222,34 ***</span>
  
  IDBError MemoryIDBBackingStore::createIndex(const IDBResourceIdentifier&amp; transactionIdentifier, const IDBIndexInfo&amp; info)
  {
      LOG(IndexedDB, &quot;MemoryIDBBackingStore::createIndex&quot;);
  
      auto rawTransaction = m_transactions.get(transactionIdentifier);
      ASSERT(rawTransaction);
      ASSERT(rawTransaction-&gt;isVersionChange());
  
      auto* objectStore = m_objectStoresByIdentifier.get(info.objectStoreIdentifier());
      if (!objectStore)
          return IDBError { ConstraintError };
  
<span class="line-modified">!     return objectStore-&gt;createIndex(*rawTransaction, info);</span>
  }
  
  IDBError MemoryIDBBackingStore::deleteIndex(const IDBResourceIdentifier&amp; transactionIdentifier, uint64_t objectStoreIdentifier, uint64_t indexIdentifier)
  {
      LOG(IndexedDB, &quot;MemoryIDBBackingStore::deleteIndex&quot;);
  
      auto rawTransaction = m_transactions.get(transactionIdentifier);
      ASSERT(rawTransaction);
      ASSERT(rawTransaction-&gt;isVersionChange());
  
      auto* objectStore = m_objectStoresByIdentifier.get(objectStoreIdentifier);
      if (!objectStore)
          return IDBError { ConstraintError };
  
<span class="line-modified">!     return objectStore-&gt;deleteIndex(*rawTransaction, indexIdentifier);</span>
  }
  
  IDBError MemoryIDBBackingStore::renameIndex(const IDBResourceIdentifier&amp; transactionIdentifier, uint64_t objectStoreIdentifier, uint64_t indexIdentifier, const String&amp; newName)
  {
      LOG(IndexedDB, &quot;MemoryIDBBackingStore::renameIndex&quot;);
<span class="line-new-header">--- 220,58 ---</span>
  
  IDBError MemoryIDBBackingStore::createIndex(const IDBResourceIdentifier&amp; transactionIdentifier, const IDBIndexInfo&amp; info)
  {
      LOG(IndexedDB, &quot;MemoryIDBBackingStore::createIndex&quot;);
  
<span class="line-added">+     ASSERT(m_databaseInfo);</span>
<span class="line-added">+     auto* objectStoreInfo = m_databaseInfo-&gt;infoForExistingObjectStore(info.objectStoreIdentifier());</span>
<span class="line-added">+     if (!objectStoreInfo)</span>
<span class="line-added">+         return IDBError { ConstraintError };</span>
<span class="line-added">+ </span>
      auto rawTransaction = m_transactions.get(transactionIdentifier);
      ASSERT(rawTransaction);
      ASSERT(rawTransaction-&gt;isVersionChange());
  
      auto* objectStore = m_objectStoresByIdentifier.get(info.objectStoreIdentifier());
      if (!objectStore)
          return IDBError { ConstraintError };
  
<span class="line-modified">!     auto error = objectStore-&gt;createIndex(*rawTransaction, info);</span>
<span class="line-added">+     if (error.isNull()) {</span>
<span class="line-added">+         objectStoreInfo-&gt;addExistingIndex(info);</span>
<span class="line-added">+         m_databaseInfo-&gt;setMaxIndexID(info.identifier());</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     return error;</span>
  }
  
  IDBError MemoryIDBBackingStore::deleteIndex(const IDBResourceIdentifier&amp; transactionIdentifier, uint64_t objectStoreIdentifier, uint64_t indexIdentifier)
  {
      LOG(IndexedDB, &quot;MemoryIDBBackingStore::deleteIndex&quot;);
  
<span class="line-added">+     ASSERT(m_databaseInfo);</span>
<span class="line-added">+     auto* objectStoreInfo = m_databaseInfo-&gt;infoForExistingObjectStore(objectStoreIdentifier);</span>
<span class="line-added">+     if (!objectStoreInfo)</span>
<span class="line-added">+         return IDBError { ConstraintError };</span>
<span class="line-added">+ </span>
<span class="line-added">+     auto* indexInfo = objectStoreInfo-&gt;infoForExistingIndex(indexIdentifier);</span>
<span class="line-added">+     if (!indexInfo)</span>
<span class="line-added">+         return IDBError { ConstraintError };</span>
<span class="line-added">+ </span>
      auto rawTransaction = m_transactions.get(transactionIdentifier);
      ASSERT(rawTransaction);
      ASSERT(rawTransaction-&gt;isVersionChange());
  
      auto* objectStore = m_objectStoresByIdentifier.get(objectStoreIdentifier);
      if (!objectStore)
          return IDBError { ConstraintError };
  
<span class="line-modified">!     auto error = objectStore-&gt;deleteIndex(*rawTransaction, indexIdentifier);</span>
<span class="line-added">+     if (error.isNull())</span>
<span class="line-added">+         objectStoreInfo-&gt;deleteIndex(indexIdentifier);</span>
<span class="line-added">+ </span>
<span class="line-added">+     return error;</span>
  }
  
  IDBError MemoryIDBBackingStore::renameIndex(const IDBResourceIdentifier&amp; transactionIdentifier, uint64_t objectStoreIdentifier, uint64_t indexIdentifier, const String&amp; newName)
  {
      LOG(IndexedDB, &quot;MemoryIDBBackingStore::renameIndex&quot;);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 482,10 ***</span>
<span class="line-new-header">--- 504,15 ---</span>
      RELEASE_ASSERT(objectStore);
  
      if (newKeyNumber &lt; objectStore-&gt;currentKeyGeneratorValue())
          return IDBError { };
  
<span class="line-added">+     if (newKeyNumber &gt;= (double)maxGeneratedKeyValue) {</span>
<span class="line-added">+         objectStore-&gt;setKeyGeneratorValue(maxGeneratedKeyValue + 1);</span>
<span class="line-added">+         return IDBError { };</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
      uint64_t newKeyInteger(newKeyNumber);
      if (newKeyInteger &lt;= uint64_t(newKeyNumber))
          ++newKeyInteger;
  
      ASSERT(newKeyInteger &gt; uint64_t(newKeyNumber));
</pre>
<hr />
<pre>
<span class="line-old-header">*** 593,16 ***</span>
  void MemoryIDBBackingStore::deleteBackingStore()
  {
      // The in-memory IDB backing store doesn&#39;t need to do any cleanup when it is deleted.
  }
  
<span class="line-removed">- uint64_t MemoryIDBBackingStore::databaseSize() const</span>
<span class="line-removed">- {</span>
<span class="line-removed">-     // FIXME: Implement this.</span>
<span class="line-removed">-     return 0;</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
  void MemoryIDBBackingStore::close()
  {
  }
  
  } // namespace IDBServer
<span class="line-new-header">--- 620,10 ---</span>
</pre>
<center><a href="MemoryCursor.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="MemoryIDBBackingStore.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>