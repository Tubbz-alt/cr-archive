<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WebCore/workers/service/ServiceWorkerJob.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="ServiceWorkerGlobalScope.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="ServiceWorkerJob.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/workers/service/ServiceWorkerJob.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -32,10 +32,11 @@</span>
  #include &quot;JSDOMPromiseDeferred.h&quot;
  #include &quot;MIMETypeRegistry.h&quot;
  #include &quot;ResourceError.h&quot;
  #include &quot;ResourceResponse.h&quot;
  #include &quot;ScriptExecutionContext.h&quot;
<span class="udiff-line-added">+ #include &quot;SecurityOrigin.h&quot;</span>
  #include &quot;ServiceWorkerJobData.h&quot;
  #include &quot;ServiceWorkerRegistration.h&quot;
  
  namespace WebCore {
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -50,10 +51,15 @@</span>
  ServiceWorkerJob::~ServiceWorkerJob()
  {
      ASSERT(m_creationThread.ptr() == &amp;Thread::current());
  }
  
<span class="udiff-line-added">+ RefPtr&lt;DeferredPromise&gt; ServiceWorkerJob::takePromise()</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     return WTFMove(m_promise);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  void ServiceWorkerJob::failedWithException(const Exception&amp; exception)
  {
      ASSERT(m_creationThread.ptr() == &amp;Thread::current());
      ASSERT(!m_completed);
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -105,49 +111,49 @@</span>
      options.redirect = FetchOptions::Redirect::Error;
      options.destination = FetchOptions::Destination::Serviceworker;
      m_scriptLoader-&gt;loadAsynchronously(context, WTFMove(request), WTFMove(options), ContentSecurityPolicyEnforcement::DoNotEnforce, ServiceWorkersMode::None, *this);
  }
  
<span class="udiff-line-modified-removed">- void ServiceWorkerJob::didReceiveResponse(unsigned long, const ResourceResponse&amp; response)</span>
<span class="udiff-line-modified-added">+ ResourceError ServiceWorkerJob::validateServiceWorkerResponse(const ServiceWorkerJobData&amp; jobData, const ResourceResponse&amp; response)</span>
  {
<span class="udiff-line-removed">-     ASSERT(m_creationThread.ptr() == &amp;Thread::current());</span>
<span class="udiff-line-removed">-     ASSERT(!m_completed);</span>
<span class="udiff-line-removed">-     ASSERT(m_scriptLoader);</span>
<span class="udiff-line-removed">- </span>
      // Extract a MIME type from the response&#39;s header list. If this MIME type (ignoring parameters) is not a JavaScript MIME type, then:
<span class="udiff-line-modified-removed">-     if (!MIMETypeRegistry::isSupportedJavaScriptMIMEType(response.mimeType())) {</span>
<span class="udiff-line-modified-removed">-         m_scriptLoader-&gt;cancel();</span>
<span class="udiff-line-removed">-         m_scriptLoader = nullptr;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         // Invoke Reject Job Promise with job and &quot;SecurityError&quot; DOMException.</span>
<span class="udiff-line-removed">-         Exception exception { SecurityError, &quot;MIME Type is not a JavaScript MIME type&quot;_s };</span>
<span class="udiff-line-removed">-         // Asynchronously complete these steps with a network error.</span>
<span class="udiff-line-removed">-         ResourceError error { errorDomainWebKitInternal, 0, response.url(), &quot;Unexpected MIME type&quot;_s };</span>
<span class="udiff-line-removed">-         m_client.jobFailedLoadingScript(*this, WTFMove(error), WTFMove(exception));</span>
<span class="udiff-line-removed">-         return;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-modified-added">+     if (!MIMETypeRegistry::isSupportedJavaScriptMIMEType(response.mimeType()))</span>
<span class="udiff-line-modified-added">+         return { errorDomainWebKitInternal, 0, response.url(), &quot;MIME Type is not a JavaScript MIME type&quot;_s };</span>
  
      String serviceWorkerAllowed = response.httpHeaderField(HTTPHeaderName::ServiceWorkerAllowed);
      String maxScopeString;
      if (serviceWorkerAllowed.isNull()) {
<span class="udiff-line-modified-removed">-         String path = m_jobData.scriptURL.path();</span>
<span class="udiff-line-modified-added">+         String path = jobData.scriptURL.path();</span>
          // Last part of the path is the script&#39;s filename.
          maxScopeString = path.substring(0, path.reverseFind(&#39;/&#39;) + 1);
      } else {
<span class="udiff-line-modified-removed">-         auto maxScope = URL(m_jobData.scriptURL, serviceWorkerAllowed);</span>
<span class="udiff-line-modified-removed">-         maxScopeString = maxScope.path();</span>
<span class="udiff-line-modified-added">+         auto maxScope = URL(jobData.scriptURL, serviceWorkerAllowed);</span>
<span class="udiff-line-modified-added">+         if (SecurityOrigin::create(maxScope)-&gt;isSameOriginAs(SecurityOrigin::create(jobData.scriptURL)))</span>
<span class="udiff-line-added">+             maxScopeString = maxScope.path();</span>
      }
  
<span class="udiff-line-modified-removed">-     String scopeString = m_jobData.scopeURL.path();</span>
<span class="udiff-line-modified-removed">-     if (scopeString.startsWith(maxScopeString))</span>
<span class="udiff-line-modified-added">+     String scopeString = jobData.scopeURL.path();</span>
<span class="udiff-line-modified-added">+     if (!scopeString.startsWith(maxScopeString))</span>
<span class="udiff-line-added">+         return { errorDomainWebKitInternal, 0, response.url(), &quot;Scope URL should start with the given script URL&quot;_s };</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     return { };</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void ServiceWorkerJob::didReceiveResponse(unsigned long, const ResourceResponse&amp; response)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     ASSERT(m_creationThread.ptr() == &amp;Thread::current());</span>
<span class="udiff-line-added">+     ASSERT(!m_completed);</span>
<span class="udiff-line-added">+     ASSERT(m_scriptLoader);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     auto error = validateServiceWorkerResponse(m_jobData, response);</span>
<span class="udiff-line-added">+     if (error.isNull())</span>
          return;
  
      m_scriptLoader-&gt;cancel();
      m_scriptLoader = nullptr;
  
<span class="udiff-line-modified-removed">-     Exception exception { SecurityError, &quot;Scope URL should start with the given script URL&quot;_s };</span>
<span class="udiff-line-removed">-     ResourceError error { errorDomainWebKitInternal, 0, response.url(), &quot;Scope URL should start with the given script URL&quot;_s };</span>
<span class="udiff-line-modified-added">+     Exception exception { SecurityError, error.localizedDescription() };</span>
      m_client.jobFailedLoadingScript(*this, WTFMove(error), WTFMove(exception));
  }
  
  void ServiceWorkerJob::notifyFinished()
  {
</pre>
<center><a href="ServiceWorkerGlobalScope.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="ServiceWorkerJob.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>