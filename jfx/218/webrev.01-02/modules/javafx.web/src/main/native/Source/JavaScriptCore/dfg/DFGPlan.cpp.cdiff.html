<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.web/src/main/native/Source/JavaScriptCore/dfg/DFGPlan.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="DFGPhantomInsertionPhase.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="DFGPlan.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/JavaScriptCore/dfg/DFGPlan.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (C) 2013-2019 Apple Inc. All rights reserved.</span>
   *
   * Redistribution and use in source and binary forms, with or without
   * modification, are permitted provided that the following conditions
   * are met:
   * 1. Redistributions of source code must retain the above copyright
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (C) 2013-2020 Apple Inc. All rights reserved.</span>
   *
   * Redistribution and use in source and binary forms, with or without
   * modification, are permitted provided that the following conditions
   * are met:
   * 1. Redistributions of source code must retain the above copyright
</pre>
<hr />
<pre>
<span class="line-old-header">*** 132,11 ***</span>
  }
  
  } // anonymous namespace
  
  Plan::Plan(CodeBlock* passedCodeBlock, CodeBlock* profiledDFGCodeBlock,
<span class="line-modified">!     CompilationMode mode, unsigned osrEntryBytecodeIndex,</span>
      const Operands&lt;Optional&lt;JSValue&gt;&gt;&amp; mustHandleValues)
      : m_mode(mode)
      , m_vm(&amp;passedCodeBlock-&gt;vm())
      , m_codeBlock(passedCodeBlock)
      , m_profiledDFGCodeBlock(profiledDFGCodeBlock)
<span class="line-new-header">--- 132,11 ---</span>
  }
  
  } // anonymous namespace
  
  Plan::Plan(CodeBlock* passedCodeBlock, CodeBlock* profiledDFGCodeBlock,
<span class="line-modified">!     CompilationMode mode, BytecodeIndex osrEntryBytecodeIndex,</span>
      const Operands&lt;Optional&lt;JSValue&gt;&gt;&amp; mustHandleValues)
      : m_mode(mode)
      , m_vm(&amp;passedCodeBlock-&gt;vm())
      , m_codeBlock(passedCodeBlock)
      , m_profiledDFGCodeBlock(profiledDFGCodeBlock)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 236,20 ***</span>
      }
  }
  
  Plan::CompilationPath Plan::compileInThreadImpl()
  {
<span class="line-modified">!     cleanMustHandleValuesIfNecessary();</span>
  
<span class="line-modified">!     if (verboseCompilationEnabled(m_mode) &amp;&amp; m_osrEntryBytecodeIndex != UINT_MAX) {</span>
          dataLog(&quot;\n&quot;);
<span class="line-modified">!         dataLog(&quot;Compiler must handle OSR entry from bc#&quot;, m_osrEntryBytecodeIndex, &quot; with values: &quot;, m_mustHandleValues, &quot;\n&quot;);</span>
          dataLog(&quot;\n&quot;);
      }
  
      Graph dfg(*m_vm, *this);
<span class="line-modified">!     parse(dfg);</span>
  
      m_codeBlock-&gt;setCalleeSaveRegisters(RegisterSet::dfgCalleeSaveRegisters());
  
      bool changed = false;
  
<span class="line-new-header">--- 236,27 ---</span>
      }
  }
  
  Plan::CompilationPath Plan::compileInThreadImpl()
  {
<span class="line-modified">!     {</span>
<span class="line-added">+         CompilerTimingScope timingScope(&quot;DFG&quot;, &quot;clean must handle values&quot;);</span>
<span class="line-added">+         cleanMustHandleValuesIfNecessary();</span>
<span class="line-added">+     }</span>
  
<span class="line-modified">!     if (verboseCompilationEnabled(m_mode) &amp;&amp; m_osrEntryBytecodeIndex) {</span>
          dataLog(&quot;\n&quot;);
<span class="line-modified">!         dataLog(&quot;Compiler must handle OSR entry from &quot;, m_osrEntryBytecodeIndex, &quot; with values: &quot;, m_mustHandleValues, &quot;\n&quot;);</span>
          dataLog(&quot;\n&quot;);
      }
  
      Graph dfg(*m_vm, *this);
<span class="line-modified">! </span>
<span class="line-added">+     {</span>
<span class="line-added">+         CompilerTimingScope timingScope(&quot;DFG&quot;, &quot;bytecode parser&quot;);</span>
<span class="line-added">+         parse(dfg);</span>
<span class="line-added">+     }</span>
  
      m_codeBlock-&gt;setCalleeSaveRegisters(RegisterSet::dfgCalleeSaveRegisters());
  
      bool changed = false;
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 270,11 ***</span>
  
      // By this point the DFG bytecode parser will have potentially mutated various tables
      // in the CodeBlock. This is a good time to perform an early shrink, which is more
      // powerful than a late one. It&#39;s safe to do so because we haven&#39;t generated any code
      // that references any of the tables directly, yet.
<span class="line-modified">!     m_codeBlock-&gt;shrinkToFit(CodeBlock::EarlyShrink);</span>
  
      if (validationEnabled())
          validate(dfg);
  
      if (Options::dumpGraphAfterParsing()) {
<span class="line-new-header">--- 277,14 ---</span>
  
      // By this point the DFG bytecode parser will have potentially mutated various tables
      // in the CodeBlock. This is a good time to perform an early shrink, which is more
      // powerful than a late one. It&#39;s safe to do so because we haven&#39;t generated any code
      // that references any of the tables directly, yet.
<span class="line-modified">!     {</span>
<span class="line-added">+         ConcurrentJSLocker locker(m_codeBlock-&gt;m_lock);</span>
<span class="line-added">+         m_codeBlock-&gt;shrinkToFit(locker, CodeBlock::ShrinkMode::EarlyShrink);</span>
<span class="line-added">+     }</span>
  
      if (validationEnabled())
          validate(dfg);
  
      if (Options::dumpGraphAfterParsing()) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 379,15 ***</span>
          RUN_PHASE(performStackLayout);
          RUN_PHASE(performVirtualRegisterAllocation);
          RUN_PHASE(performWatchpointCollection);
          dumpAndVerifyGraph(dfg, &quot;Graph after optimization:&quot;);
  
<span class="line-modified">!         JITCompiler dataFlowJIT(dfg);</span>
<span class="line-modified">!         if (m_codeBlock-&gt;codeType() == FunctionCode)</span>
<span class="line-modified">!             dataFlowJIT.compileFunction();</span>
<span class="line-modified">!         else</span>
<span class="line-modified">!             dataFlowJIT.compile();</span>
  
          return DFGPath;
      }
  
      case FTLMode:
<span class="line-new-header">--- 389,19 ---</span>
          RUN_PHASE(performStackLayout);
          RUN_PHASE(performVirtualRegisterAllocation);
          RUN_PHASE(performWatchpointCollection);
          dumpAndVerifyGraph(dfg, &quot;Graph after optimization:&quot;);
  
<span class="line-modified">!         {</span>
<span class="line-modified">!             CompilerTimingScope timingScope(&quot;DFG&quot;, &quot;machine code generation&quot;);</span>
<span class="line-modified">! </span>
<span class="line-modified">!             JITCompiler dataFlowJIT(dfg);</span>
<span class="line-modified">!             if (m_codeBlock-&gt;codeType() == FunctionCode)</span>
<span class="line-added">+                 dataFlowJIT.compileFunction();</span>
<span class="line-added">+             else</span>
<span class="line-added">+                 dataFlowJIT.compile();</span>
<span class="line-added">+         }</span>
  
          return DFGPath;
      }
  
      case FTLMode:
</pre>
<hr />
<pre>
<span class="line-old-header">*** 494,20 ***</span>
          FTL::lowerDFGToB3(state);
  
          if (UNLIKELY(computeCompileTimes()))
              m_timeBeforeFTL = MonotonicTime::now();
  
<span class="line-modified">!         if (Options::b3AlwaysFailsBeforeCompile()) {</span>
              FTL::fail(state);
              return FTLPath;
          }
  
          FTL::compile(state, safepointResult);
          if (safepointResult.didGetCancelled())
              return CancelPath;
  
<span class="line-modified">!         if (Options::b3AlwaysFailsBeforeLink()) {</span>
              FTL::fail(state);
              return FTLPath;
          }
  
          if (state.allocationFailed) {
<span class="line-new-header">--- 508,20 ---</span>
          FTL::lowerDFGToB3(state);
  
          if (UNLIKELY(computeCompileTimes()))
              m_timeBeforeFTL = MonotonicTime::now();
  
<span class="line-modified">!         if (UNLIKELY(Options::b3AlwaysFailsBeforeCompile())) {</span>
              FTL::fail(state);
              return FTLPath;
          }
  
          FTL::compile(state, safepointResult);
          if (safepointResult.didGetCancelled())
              return CancelPath;
  
<span class="line-modified">!         if (UNLIKELY(Options::b3AlwaysFailsBeforeLink())) {</span>
              FTL::fail(state);
              return FTLPath;
          }
  
          if (state.allocationFailed) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 601,18 ***</span>
              CODEBLOCK_LOG_EVENT(m_codeBlock, &quot;dfgFinalize&quot;, (&quot;failed&quot;));
              return CompilationFailed;
          }
  
          reallyAdd(m_codeBlock-&gt;jitCode()-&gt;dfgCommon());
  
          if (validationEnabled()) {
              TrackedReferences trackedReferences;
  
              for (WriteBarrier&lt;JSCell&gt;&amp; reference : m_codeBlock-&gt;jitCode()-&gt;dfgCommon()-&gt;weakReferences)
                  trackedReferences.add(reference.get());
<span class="line-modified">!             for (WriteBarrier&lt;Structure&gt;&amp; reference : m_codeBlock-&gt;jitCode()-&gt;dfgCommon()-&gt;weakStructureReferences)</span>
<span class="line-modified">!                 trackedReferences.add(reference.get());</span>
              for (WriteBarrier&lt;Unknown&gt;&amp; constant : m_codeBlock-&gt;constants())
                  trackedReferences.add(constant.get());
  
              for (auto* inlineCallFrame : *m_inlineCallFrames) {
                  ASSERT(inlineCallFrame-&gt;baselineCodeBlock.get());
<span class="line-new-header">--- 615,23 ---</span>
              CODEBLOCK_LOG_EVENT(m_codeBlock, &quot;dfgFinalize&quot;, (&quot;failed&quot;));
              return CompilationFailed;
          }
  
          reallyAdd(m_codeBlock-&gt;jitCode()-&gt;dfgCommon());
<span class="line-added">+         {</span>
<span class="line-added">+             ConcurrentJSLocker locker(m_codeBlock-&gt;m_lock);</span>
<span class="line-added">+             m_codeBlock-&gt;jitCode()-&gt;shrinkToFit(locker);</span>
<span class="line-added">+             m_codeBlock-&gt;shrinkToFit(locker, CodeBlock::ShrinkMode::LateShrink);</span>
<span class="line-added">+         }</span>
  
          if (validationEnabled()) {
              TrackedReferences trackedReferences;
  
              for (WriteBarrier&lt;JSCell&gt;&amp; reference : m_codeBlock-&gt;jitCode()-&gt;dfgCommon()-&gt;weakReferences)
                  trackedReferences.add(reference.get());
<span class="line-modified">!             for (StructureID structureID : m_codeBlock-&gt;jitCode()-&gt;dfgCommon()-&gt;weakStructureReferences)</span>
<span class="line-modified">!                 trackedReferences.add(m_vm-&gt;getStructure(structureID));</span>
              for (WriteBarrier&lt;Unknown&gt;&amp; constant : m_codeBlock-&gt;constants())
                  trackedReferences.add(constant.get());
  
              for (auto* inlineCallFrame : *m_inlineCallFrames) {
                  ASSERT(inlineCallFrame-&gt;baselineCodeBlock.get());
</pre>
<hr />
<pre>
<span class="line-old-header">*** 653,10 ***</span>
<span class="line-new-header">--- 672,11 ---</span>
          Optional&lt;JSValue&gt; value = m_mustHandleValues[i];
          if (value)
              visitor.appendUnbarriered(value.value());
      }
  
<span class="line-added">+     m_recordedStatuses.visitAggregate(visitor);</span>
      m_recordedStatuses.markIfCheap(visitor);
  
      visitor.appendUnbarriered(m_codeBlock);
      visitor.appendUnbarriered(m_codeBlock-&gt;alternative());
      visitor.appendUnbarriered(m_profiledDFGCodeBlock);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 691,11 ***</span>
<span class="line-new-header">--- 711,14 ---</span>
      return true;
  }
  
  void Plan::cancel()
  {
<span class="line-added">+     RELEASE_ASSERT(m_stage != Cancelled);</span>
<span class="line-added">+     ASSERT(m_vm);</span>
      m_vm = nullptr;
<span class="line-added">+ </span>
      m_codeBlock = nullptr;
      m_profiledDFGCodeBlock = nullptr;
      m_mustHandleValues.clear();
      m_compilation = nullptr;
      m_finalizer = nullptr;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 723,11 ***</span>
  
      if (!m_mustHandleValues.numberOfLocals())
          return;
  
      CodeBlock* alternative = m_codeBlock-&gt;alternative();
<span class="line-modified">!     FastBitVector liveness = alternative-&gt;livenessAnalysis().getLivenessInfoAtBytecodeOffset(alternative, m_osrEntryBytecodeIndex);</span>
  
      for (unsigned local = m_mustHandleValues.numberOfLocals(); local--;) {
          if (!liveness[local])
              m_mustHandleValues.local(local) = WTF::nullopt;
      }
<span class="line-new-header">--- 746,11 ---</span>
  
      if (!m_mustHandleValues.numberOfLocals())
          return;
  
      CodeBlock* alternative = m_codeBlock-&gt;alternative();
<span class="line-modified">!     FastBitVector liveness = alternative-&gt;livenessAnalysis().getLivenessInfoAtBytecodeIndex(alternative, m_osrEntryBytecodeIndex);</span>
  
      for (unsigned local = m_mustHandleValues.numberOfLocals(); local--;) {
          if (!liveness[local])
              m_mustHandleValues.local(local) = WTF::nullopt;
      }
</pre>
<center><a href="DFGPhantomInsertionPhase.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="DFGPlan.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>