<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New modules/javafx.web/src/main/native/Source/JavaScriptCore/inspector/remote/socket/RemoteInspectorConnectionClient.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (C) 2019 Sony Interactive Entertainment Inc.
  3  *
  4  * Redistribution and use in source and binary forms, with or without
  5  * modification, are permitted provided that the following conditions
  6  * are met:
  7  * 1. Redistributions of source code must retain the above copyright
  8  *    notice, this list of conditions and the following disclaimer.
  9  * 2. Redistributions in binary form must reproduce the above copyright
 10  *    notice, this list of conditions and the following disclaimer in the
 11  *    documentation and/or other materials provided with the distribution.
 12  *
 13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. AND ITS CONTRIBUTORS ``AS IS&#39;&#39;
 14  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
 15  * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 16  * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL APPLE INC. OR ITS CONTRIBUTORS
 17  * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 18  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 19  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 20  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 21  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 22  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF
 23  * THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #include &quot;config.h&quot;
 27 #include &quot;RemoteInspectorConnectionClient.h&quot;
 28 
 29 #if ENABLE(REMOTE_INSPECTOR)
 30 
 31 #include &quot;RemoteInspectorSocketEndpoint.h&quot;
 32 #include &lt;wtf/JSONValues.h&gt;
 33 #include &lt;wtf/RunLoop.h&gt;
 34 
 35 namespace Inspector {
 36 
 37 RemoteInspectorConnectionClient::~RemoteInspectorConnectionClient()
 38 {
 39     auto&amp; endpoint = Inspector::RemoteInspectorSocketEndpoint::singleton();
 40     endpoint.invalidateClient(*this);
 41 }
 42 
 43 Optional&lt;ConnectionID&gt; RemoteInspectorConnectionClient::connectInet(const char* serverAddr, uint16_t serverPort)
 44 {
 45     auto&amp; endpoint = Inspector::RemoteInspectorSocketEndpoint::singleton();
 46     return endpoint.connectInet(serverAddr, serverPort, *this);
 47 }
 48 
 49 Optional&lt;ConnectionID&gt; RemoteInspectorConnectionClient::createClient(PlatformSocketType socket)
 50 {
 51     auto&amp; endpoint = Inspector::RemoteInspectorSocketEndpoint::singleton();
 52     return endpoint.createClient(socket, *this);
 53 }
 54 
 55 void RemoteInspectorConnectionClient::send(ConnectionID id, const uint8_t* data, size_t size)
 56 {
 57     auto message = MessageParser::createMessage(data, size);
 58     if (message.isEmpty())
 59         return;
 60 
 61     auto&amp; endpoint = RemoteInspectorSocketEndpoint::singleton();
 62     endpoint.send(id, message.data(), message.size());
 63 }
 64 
 65 void RemoteInspectorConnectionClient::didReceive(ConnectionID clientID, Vector&lt;uint8_t&gt;&amp;&amp; data)
 66 {
 67     ASSERT(!isMainThread());
 68 
 69     LockHolder lock(m_parsersLock);
 70     auto result = m_parsers.ensure(clientID, [this, clientID] {
 71         return MessageParser([this, clientID](Vector&lt;uint8_t&gt;&amp;&amp; data) {
 72             if (auto event = RemoteInspectorConnectionClient::extractEvent(clientID, WTFMove(data))) {
 73                 RunLoop::main().dispatch([this, event = WTFMove(*event)] {
 74                     const auto&amp; methodName = event.methodName;
 75                     auto&amp; methods = dispatchMap();
 76                     if (methods.contains(methodName)) {
 77                         auto call = methods.get(methodName);
 78                         (this-&gt;*call)(event);
 79                     } else
 80                         LOG_ERROR(&quot;Unknown event: %s&quot;, methodName.utf8().data());
 81                 });
 82             }
 83         });
 84     });
 85     result.iterator-&gt;value.pushReceivedData(data.data(), data.size());
 86 }
 87 
 88 Optional&lt;RemoteInspectorConnectionClient::Event&gt; RemoteInspectorConnectionClient::extractEvent(ConnectionID clientID, Vector&lt;uint8_t&gt;&amp;&amp; data)
 89 {
 90     if (data.isEmpty())
 91         return WTF::nullopt;
 92 
 93     String jsonData = String::fromUTF8(data);
 94 
 95     RefPtr&lt;JSON::Value&gt; messageValue;
 96     if (!JSON::Value::parseJSON(jsonData, messageValue))
 97         return WTF::nullopt;
 98 
 99     RefPtr&lt;JSON::Object&gt; messageObject;
100     if (!messageValue-&gt;asObject(messageObject))
101         return WTF::nullopt;
102 
103     Event event;
104     if (!messageObject-&gt;getString(&quot;event&quot;_s, event.methodName))
105         return WTF::nullopt;
106 
107     event.clientID = clientID;
108 
109     ConnectionID connectionID;
110     if (messageObject-&gt;getInteger(&quot;connectionID&quot;_s, connectionID))
111         event.connectionID = connectionID;
112 
113     TargetID targetID;
114     if (messageObject-&gt;getInteger(&quot;targetID&quot;_s, targetID))
115         event.targetID = targetID;
116 
117     String message;
118     if (messageObject-&gt;getString(&quot;message&quot;_s, message))
119         event.message = message;
120 
121     return event;
122 }
123 
124 } // namespace Inspector
125 
126 #endif // ENABLE(REMOTE_INSPECTOR)
    </pre>
  </body>
</html>