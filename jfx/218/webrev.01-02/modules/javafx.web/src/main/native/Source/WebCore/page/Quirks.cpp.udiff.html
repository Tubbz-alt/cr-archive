<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WebCore/page/Quirks.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="ProcessWarming.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="Quirks.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/page/Quirks.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -26,15 +26,20 @@</span>
  #include &quot;config.h&quot;
  #include &quot;Quirks.h&quot;
  
  #include &quot;CustomHeaderFields.h&quot;
  #include &quot;DOMTokenList.h&quot;
<span class="udiff-line-added">+ #include &quot;DOMWindow.h&quot;</span>
  #include &quot;Document.h&quot;
  #include &quot;DocumentLoader.h&quot;
<span class="udiff-line-added">+ #include &quot;EventNames.h&quot;</span>
  #include &quot;FrameLoader.h&quot;
<span class="udiff-line-added">+ #include &quot;HTMLBodyElement.h&quot;</span>
<span class="udiff-line-added">+ #include &quot;HTMLDivElement.h&quot;</span>
  #include &quot;HTMLMetaElement.h&quot;
  #include &quot;HTMLObjectElement.h&quot;
<span class="udiff-line-added">+ #include &quot;JSEventListener.h&quot;</span>
  #include &quot;LayoutUnit.h&quot;
  #include &quot;RuntimeEnabledFeatures.h&quot;
  #include &quot;Settings.h&quot;
  #include &quot;UserAgent.h&quot;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -285,60 +290,69 @@</span>
          return true;
  
      if (!needsQuirks())
          return false;
  
<span class="udiff-line-modified-removed">-     auto* loader = m_document-&gt;loader();</span>
<span class="udiff-line-modified-removed">-     if (!loader || loader-&gt;simulatedMouseEventsDispatchPolicy() != SimulatedMouseEventsDispatchPolicy::Allow)</span>
<span class="udiff-line-modified-removed">-         return false;</span>
<span class="udiff-line-modified-added">+     auto doShouldDispatchChecks = [this] () -&gt; bool {</span>
<span class="udiff-line-modified-added">+         auto* loader = m_document-&gt;loader();</span>
<span class="udiff-line-modified-added">+         if (!loader || loader-&gt;simulatedMouseEventsDispatchPolicy() != SimulatedMouseEventsDispatchPolicy::Allow)</span>
<span class="udiff-line-added">+             return false;</span>
  
<span class="udiff-line-modified-removed">-     if (isAmazon())</span>
<span class="udiff-line-modified-removed">-         return true;</span>
<span class="udiff-line-modified-removed">-     if (isGoogleMaps())</span>
<span class="udiff-line-modified-removed">-         return true;</span>
<span class="udiff-line-modified-added">+         if (isAmazon())</span>
<span class="udiff-line-modified-added">+             return true;</span>
<span class="udiff-line-modified-added">+         if (isGoogleMaps())</span>
<span class="udiff-line-modified-added">+             return true;</span>
  
<span class="udiff-line-modified-removed">-     auto&amp; url = m_document-&gt;topDocument().url();</span>
<span class="udiff-line-modified-removed">-     auto host = url.host();</span>
<span class="udiff-line-modified-added">+         auto&amp; url = m_document-&gt;topDocument().url();</span>
<span class="udiff-line-modified-added">+         auto host = url.host().convertToASCIILowercase();</span>
  
<span class="udiff-line-modified-removed">-     if (equalLettersIgnoringASCIICase(host, &quot;wix.com&quot;) || host.endsWithIgnoringASCIICase(&quot;.wix.com&quot;)) {</span>
<span class="udiff-line-modified-removed">-         // Disable simulated mouse dispatching for template selection.</span>
<span class="udiff-line-modified-removed">-         return !url.path().startsWithIgnoringASCIICase(&quot;/website/templates/&quot;);</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-removed">-     if ((equalLettersIgnoringASCIICase(host, &quot;desmos.com&quot;) || host.endsWithIgnoringASCIICase(&quot;.desmos.com&quot;)) &amp;&amp; url.path().startsWithIgnoringASCIICase(&quot;/calculator/&quot;))</span>
<span class="udiff-line-modified-removed">-         return true;</span>
<span class="udiff-line-modified-removed">-     if (equalLettersIgnoringASCIICase(host, &quot;figma.com&quot;) || host.endsWithIgnoringASCIICase(&quot;.figma.com&quot;))</span>
<span class="udiff-line-modified-removed">-         return true;</span>
<span class="udiff-line-modified-removed">-     if (equalLettersIgnoringASCIICase(host, &quot;trello.com&quot;) || host.endsWithIgnoringASCIICase(&quot;.trello.com&quot;))</span>
<span class="udiff-line-modified-removed">-         return true;</span>
<span class="udiff-line-modified-removed">-     if (equalLettersIgnoringASCIICase(host, &quot;airtable.com&quot;) || host.endsWithIgnoringASCIICase(&quot;.airtable.com&quot;))</span>
<span class="udiff-line-modified-removed">-         return true;</span>
<span class="udiff-line-modified-removed">-     if (equalLettersIgnoringASCIICase(host, &quot;msn.com&quot;) || host.endsWithIgnoringASCIICase(&quot;.msn.com&quot;))</span>
<span class="udiff-line-modified-removed">-         return true;</span>
<span class="udiff-line-modified-removed">-     if (equalLettersIgnoringASCIICase(host, &quot;flipkart.com&quot;) || host.endsWithIgnoringASCIICase(&quot;.flipkart.com&quot;))</span>
<span class="udiff-line-modified-removed">-         return true;</span>
<span class="udiff-line-modified-removed">-     if (equalLettersIgnoringASCIICase(host, &quot;iqiyi.com&quot;) || host.endsWithIgnoringASCIICase(&quot;.iqiyi.com&quot;))</span>
<span class="udiff-line-modified-removed">-         return true;</span>
<span class="udiff-line-modified-removed">-     if (equalLettersIgnoringASCIICase(host, &quot;trailers.apple.com&quot;))</span>
<span class="udiff-line-modified-removed">-         return true;</span>
<span class="udiff-line-modified-removed">-     if (equalLettersIgnoringASCIICase(host, &quot;soundcloud.com&quot;))</span>
<span class="udiff-line-modified-removed">-         return true;</span>
<span class="udiff-line-modified-removed">-     if (equalLettersIgnoringASCIICase(host, &quot;naver.com&quot;))</span>
<span class="udiff-line-modified-removed">-         return true;</span>
<span class="udiff-line-modified-removed">-     if (host.endsWithIgnoringASCIICase(&quot;.naver.com&quot;)) {</span>
<span class="udiff-line-modified-removed">-         // Disable the quirk for tv.naver.com subdomain to be able to simulate hover on videos.</span>
<span class="udiff-line-modified-removed">-         if (equalLettersIgnoringASCIICase(host, &quot;tv.naver.com&quot;))</span>
<span class="udiff-line-modified-removed">-             return false;</span>
<span class="udiff-line-modified-removed">-         // Disable the quirk for mail.naver.com subdomain to be able to tap on mail subjects.</span>
<span class="udiff-line-modified-removed">-         if (equalLettersIgnoringASCIICase(host, &quot;mail.naver.com&quot;))</span>
<span class="udiff-line-modified-removed">-             return false;</span>
<span class="udiff-line-modified-removed">-         // Disable the quirk on the mobile site.</span>
<span class="udiff-line-modified-removed">-         // FIXME: Maybe this quirk should be disabled for &quot;m.&quot; subdomains on all sites? These are generally mobile sites that don&#39;t need mouse events.</span>
<span class="udiff-line-modified-removed">-         if (equalLettersIgnoringASCIICase(host, &quot;m.naver.com&quot;))</span>
<span class="udiff-line-modified-removed">-             return false;</span>
<span class="udiff-line-modified-removed">-         return true;</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-removed">-     return false;</span>
<span class="udiff-line-modified-added">+         if (host == &quot;wix.com&quot; || host.endsWith(&quot;.wix.com&quot;)) {</span>
<span class="udiff-line-modified-added">+             // Disable simulated mouse dispatching for template selection.</span>
<span class="udiff-line-modified-added">+             return !url.path().startsWithIgnoringASCIICase(&quot;/website/templates/&quot;);</span>
<span class="udiff-line-modified-added">+         }</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+         if ((host == &quot;desmos.com&quot; || host.endsWith(&quot;.desmos.com&quot;)) &amp;&amp; url.path().startsWithIgnoringASCIICase(&quot;/calculator/&quot;))</span>
<span class="udiff-line-modified-added">+             return true;</span>
<span class="udiff-line-modified-added">+         if (host == &quot;figma.com&quot; || host.endsWith(&quot;.figma.com&quot;))</span>
<span class="udiff-line-modified-added">+             return true;</span>
<span class="udiff-line-modified-added">+         if (host == &quot;trello.com&quot; || host.endsWith(&quot;.trello.com&quot;))</span>
<span class="udiff-line-modified-added">+             return true;</span>
<span class="udiff-line-modified-added">+         if (host == &quot;airtable.com&quot; || host.endsWith(&quot;.airtable.com&quot;))</span>
<span class="udiff-line-modified-added">+             return true;</span>
<span class="udiff-line-modified-added">+         if (host == &quot;msn.com&quot; || host.endsWith(&quot;.msn.com&quot;))</span>
<span class="udiff-line-modified-added">+             return true;</span>
<span class="udiff-line-modified-added">+         if (host == &quot;flipkart.com&quot; || host.endsWith(&quot;.flipkart.com&quot;))</span>
<span class="udiff-line-modified-added">+             return true;</span>
<span class="udiff-line-modified-added">+         if (host == &quot;iqiyi.com&quot; || host.endsWith(&quot;.iqiyi.com&quot;))</span>
<span class="udiff-line-modified-added">+             return true;</span>
<span class="udiff-line-modified-added">+         if (host == &quot;trailers.apple.com&quot;)</span>
<span class="udiff-line-modified-added">+             return true;</span>
<span class="udiff-line-modified-added">+         if (host == &quot;soundcloud.com&quot;)</span>
<span class="udiff-line-modified-added">+             return true;</span>
<span class="udiff-line-modified-added">+         if (host == &quot;naver.com&quot;)</span>
<span class="udiff-line-modified-added">+             return true;</span>
<span class="udiff-line-modified-added">+         if (host == &quot;nhl.com&quot; || host.endsWith(&quot;.nhl.com&quot;))</span>
<span class="udiff-line-modified-added">+             return true;</span>
<span class="udiff-line-modified-added">+         if (host.endsWith(&quot;.naver.com&quot;)) {</span>
<span class="udiff-line-modified-added">+             // Disable the quirk for tv.naver.com subdomain to be able to simulate hover on videos.</span>
<span class="udiff-line-modified-added">+             if (host == &quot;tv.naver.com&quot;)</span>
<span class="udiff-line-modified-added">+                 return false;</span>
<span class="udiff-line-modified-added">+             // Disable the quirk for mail.naver.com subdomain to be able to tap on mail subjects.</span>
<span class="udiff-line-modified-added">+             if (host == &quot;mail.naver.com&quot;)</span>
<span class="udiff-line-modified-added">+                 return false;</span>
<span class="udiff-line-modified-added">+             // Disable the quirk on the mobile site.</span>
<span class="udiff-line-modified-added">+             // FIXME: Maybe this quirk should be disabled for &quot;m.&quot; subdomains on all sites? These are generally mobile sites that don&#39;t need mouse events.</span>
<span class="udiff-line-modified-added">+             if (host == &quot;m.naver.com&quot;)</span>
<span class="udiff-line-modified-added">+                 return false;</span>
<span class="udiff-line-added">+             return true;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         return false;</span>
<span class="udiff-line-added">+     };</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (!m_shouldDispatchSimulatedMouseEventsQuirk)</span>
<span class="udiff-line-added">+         m_shouldDispatchSimulatedMouseEventsQuirk = doShouldDispatchChecks();</span>
<span class="udiff-line-added">+     return *m_shouldDispatchSimulatedMouseEventsQuirk;</span>
  }
  
  bool Quirks::shouldDispatchedSimulatedMouseEventsAssumeDefaultPrevented(EventTarget* target) const
  {
      if (!needsQuirks() || !shouldDispatchSimulatedMouseEvents())
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -374,10 +388,22 @@</span>
  
      auto host = m_document-&gt;topDocument().url().host();
      if (equalLettersIgnoringASCIICase(host, &quot;desmos.com&quot;) || host.endsWithIgnoringASCIICase(&quot;.desmos.com&quot;))
          return Event::IsCancelable::No;
  
<span class="udiff-line-added">+     if (equalLettersIgnoringASCIICase(host, &quot;airtable.com&quot;) || host.endsWithIgnoringASCIICase(&quot;.airtable.com&quot;)) {</span>
<span class="udiff-line-added">+         // We want to limit simulated mouse events to elements under &lt;div id=&quot;paneContainer&quot;&gt; to allow for column re-ordering and multiple cell selection.</span>
<span class="udiff-line-added">+         if (is&lt;Node&gt;(target)) {</span>
<span class="udiff-line-added">+             auto* node = downcast&lt;Node&gt;(target);</span>
<span class="udiff-line-added">+             if (auto* paneContainer = node-&gt;treeScope().getElementById(AtomString(&quot;paneContainer&quot;))) {</span>
<span class="udiff-line-added">+                 if (paneContainer-&gt;contains(node))</span>
<span class="udiff-line-added">+                     return Event::IsCancelable::Yes;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         return { };</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      return Event::IsCancelable::Yes;
  }
  
  bool Quirks::shouldMakeTouchEventNonCancelableForTarget(EventTarget* target) const
  {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -407,10 +433,13 @@</span>
  
      auto host = m_document-&gt;topDocument().url().host();
      if (equalLettersIgnoringASCIICase(host, &quot;live.com&quot;) || host.endsWithIgnoringASCIICase(&quot;.live.com&quot;))
          return true;
  
<span class="udiff-line-added">+     if (equalLettersIgnoringASCIICase(host, &quot;twitter.com&quot;) || host.endsWithIgnoringASCIICase(&quot;.twitter.com&quot;))</span>
<span class="udiff-line-added">+         return true;</span>
<span class="udiff-line-added">+ </span>
      if (host.endsWithIgnoringASCIICase(&quot;.sharepoint.com&quot;))
          return true;
  
      return false;
  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -443,50 +472,10 @@</span>
  #else
      return false;
  #endif
  }
  
<span class="udiff-line-removed">- bool Quirks::shouldLightenJapaneseBoldSansSerif() const</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">- #if USE(HIRAGINO_SANS_WORKAROUND)</span>
<span class="udiff-line-removed">-     if (!needsQuirks())</span>
<span class="udiff-line-removed">-         return false;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     // lang=&quot;ja&quot; style=&quot;font: bold sans-serif;&quot; content would naturally get HiraginoSans-W8 here, but that&#39;s visually</span>
<span class="udiff-line-removed">-     // too bold. Instead, we should pick HiraginoSans-W6 instead.</span>
<span class="udiff-line-removed">-     // FIXME: webkit.org/b/200047 Remove this quirk.</span>
<span class="udiff-line-removed">-     auto host = m_document-&gt;topDocument().url().host();</span>
<span class="udiff-line-removed">-     return equalLettersIgnoringASCIICase(host, &quot;m.yahoo.co.jp&quot;);</span>
<span class="udiff-line-removed">- #else</span>
<span class="udiff-line-removed">-     return false;</span>
<span class="udiff-line-removed">- #endif</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- bool Quirks::shouldIgnoreContentChange(const Element&amp; element) const</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">- #if PLATFORM(IOS_FAMILY)</span>
<span class="udiff-line-removed">-     if (!needsQuirks())</span>
<span class="udiff-line-removed">-         return false;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     auto* parentElement = element.parentElement();</span>
<span class="udiff-line-removed">-     if (!parentElement || !parentElement-&gt;hasClass())</span>
<span class="udiff-line-removed">-         return false;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     DOMTokenList&amp; classList = parentElement-&gt;classList();</span>
<span class="udiff-line-removed">-     if (!classList.contains(&quot;feedback&quot;) || !classList.contains(&quot;feedback-mid&quot;))</span>
<span class="udiff-line-removed">-         return false;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     if (!equalLettersIgnoringASCIICase(topPrivatelyControlledDomain(m_document-&gt;url().host().toString()), &quot;united.com&quot;))</span>
<span class="udiff-line-removed">-         return false;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     return true;</span>
<span class="udiff-line-removed">- #else</span>
<span class="udiff-line-removed">-     UNUSED_PARAM(element);</span>
<span class="udiff-line-removed">-     return false;</span>
<span class="udiff-line-removed">- #endif</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
  // FIXME(&lt;rdar://problem/50394969&gt;): Remove after desmos.com adopts inputmode=&quot;none&quot;.
  bool Quirks::needsInputModeNoneImplicitly(const HTMLElement&amp; element) const
  {
  #if PLATFORM(IOS_FAMILY)
      if (!needsQuirks())
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -556,21 +545,42 @@</span>
          return false;
  
      return equalLettersIgnoringASCIICase(m_document-&gt;url().host(), &quot;www.zillow.com&quot;);
  }
  
<span class="udiff-line-added">+ bool Quirks::shouldUseLegacySelectPopoverDismissalBehaviorInDataActivation() const</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     if (!needsQuirks())</span>
<span class="udiff-line-added">+         return false;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     auto host = m_document-&gt;url().host();</span>
<span class="udiff-line-added">+     return equalLettersIgnoringASCIICase(host, &quot;att.com&quot;) || host.endsWithIgnoringASCIICase(&quot;.att.com&quot;);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ bool Quirks::shouldIgnoreAriaForFastPathContentObservationCheck() const</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+ #if PLATFORM(IOS_FAMILY)</span>
<span class="udiff-line-added">+     if (!needsQuirks())</span>
<span class="udiff-line-added">+         return false;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     auto host = m_document-&gt;url().host();</span>
<span class="udiff-line-added">+     return equalLettersIgnoringASCIICase(host, &quot;www.ralphlauren.com&quot;);</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+     return false;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  bool Quirks::shouldOpenAsAboutBlank(const String&amp; stringToOpen) const
  {
  #if PLATFORM(IOS_FAMILY)
      if (!needsQuirks())
          return false;
  
      auto openerURL = m_document-&gt;url();
      if (!equalLettersIgnoringASCIICase(openerURL.host(), &quot;docs.google.com&quot;))
          return false;
  
<span class="udiff-line-modified-removed">-     if (!m_document-&gt;frame() || !m_document-&gt;frame()-&gt;loader().userAgentForJavaScript(openerURL).contains(&quot;Macintosh&quot;))</span>
<span class="udiff-line-modified-added">+     if (!m_document-&gt;frame() || !m_document-&gt;frame()-&gt;loader().userAgent(openerURL).contains(&quot;Macintosh&quot;))</span>
          return false;
  
      URL urlToOpen { URL { }, stringToOpen };
      if (!urlToOpen.protocolIsAbout())
          return false;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -580,6 +590,124 @@</span>
      UNUSED_PARAM(stringToOpen);
      return false;
  #endif
  }
  
<span class="udiff-line-added">+ bool Quirks::needsPreloadAutoQuirk() const</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+ #if PLATFORM(IOS_FAMILY)</span>
<span class="udiff-line-added">+     if (!needsQuirks())</span>
<span class="udiff-line-added">+         return false;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (m_needsPreloadAutoQuirk)</span>
<span class="udiff-line-added">+         return m_needsPreloadAutoQuirk.value();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     auto domain = m_document-&gt;securityOrigin().domain().convertToASCIILowercase();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     m_needsPreloadAutoQuirk = domain == &quot;vimeo.com&quot; || domain.endsWith(&quot;vimeo.com&quot;);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     return m_needsPreloadAutoQuirk.value();</span>
<span class="udiff-line-added">+ #else</span>
<span class="udiff-line-added">+     return false;</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ bool Quirks::shouldBypassBackForwardCache() const</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     if (!needsQuirks())</span>
<span class="udiff-line-added">+         return false;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     auto topURL = m_document-&gt;topDocument().url();</span>
<span class="udiff-line-added">+     auto host = topURL.host();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     // Vimeo.com used to bypass the back/forward cache by serving &quot;Cache-Control: no-store&quot; over HTTPS.</span>
<span class="udiff-line-added">+     // We started caching such content in r250437 but the vimeo.com content unfortunately is not currently compatible</span>
<span class="udiff-line-added">+     // because it changes the opacity of its body to 0 when navigating away and fails to restore the original opacity</span>
<span class="udiff-line-added">+     // when coming back from the back/forward cache (e.g. in &#39;pageshow&#39; event handler). See &lt;rdar://problem/56996057&gt;.</span>
<span class="udiff-line-added">+     if (topURL.protocolIs(&quot;https&quot;) &amp;&amp; equalLettersIgnoringASCIICase(host, &quot;vimeo.com&quot;)) {</span>
<span class="udiff-line-added">+         if (auto* documentLoader = m_document-&gt;frame() ? m_document-&gt;frame()-&gt;loader().documentLoader() : nullptr)</span>
<span class="udiff-line-added">+             return documentLoader-&gt;response().cacheControlContainsNoStore();</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     // Google Docs used to bypass the back/forward cache by serving &quot;Cache-Control: no-store&quot; over HTTPS.</span>
<span class="udiff-line-added">+     // We started caching such content in r250437 but the Google Docs index page unfortunately is not currently compatible</span>
<span class="udiff-line-added">+     // because it puts an overlay (with class &quot;docs-homescreen-freeze-el-full&quot;) over the page when navigating away and fails</span>
<span class="udiff-line-added">+     // to remove it when coming back from the back/forward cache (e.g. in &#39;pageshow&#39; event handler). See &lt;rdar://problem/57670064&gt;.</span>
<span class="udiff-line-added">+     // Note that this does not check for docs.google.com host because of hosted G Suite apps.</span>
<span class="udiff-line-added">+     static NeverDestroyed&lt;const AtomString&gt; googleDocsOverlayDivClass(&quot;docs-homescreen-freeze-el-full&quot;, AtomString::ConstructFromLiteral);</span>
<span class="udiff-line-added">+     auto* firstChildInBody = m_document-&gt;body() ? m_document-&gt;body()-&gt;firstChild() : nullptr;</span>
<span class="udiff-line-added">+     if (is&lt;HTMLDivElement&gt;(firstChildInBody)) {</span>
<span class="udiff-line-added">+         auto&amp; div = downcast&lt;HTMLDivElement&gt;(*firstChildInBody);</span>
<span class="udiff-line-added">+         if (div.hasClass() &amp;&amp; div.classNames().contains(googleDocsOverlayDivClass))</span>
<span class="udiff-line-added">+             return true;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     return false;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ bool Quirks::shouldMakeEventListenerPassive(const EventTarget&amp; eventTarget, const AtomString&amp; eventType, const EventListener&amp; eventListener)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     if (eventNames().isTouchScrollBlockingEventType(eventType)) {</span>
<span class="udiff-line-added">+         if (is&lt;DOMWindow&gt;(eventTarget)) {</span>
<span class="udiff-line-added">+             auto&amp; window = downcast&lt;DOMWindow&gt;(eventTarget);</span>
<span class="udiff-line-added">+             if (auto* document = window.document())</span>
<span class="udiff-line-added">+                 return document-&gt;settings().passiveTouchListenersAsDefaultOnDocument();</span>
<span class="udiff-line-added">+         } else if (is&lt;Node&gt;(eventTarget)) {</span>
<span class="udiff-line-added">+             auto&amp; node = downcast&lt;Node&gt;(eventTarget);</span>
<span class="udiff-line-added">+             if (is&lt;Document&gt;(node) || node.document().documentElement() == &amp;node || node.document().body() == &amp;node)</span>
<span class="udiff-line-added">+                 return node.document().settings().passiveTouchListenersAsDefaultOnDocument();</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         return false;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (eventType == eventNames().mousewheelEvent) {</span>
<span class="udiff-line-added">+         if (!is&lt;JSEventListener&gt;(eventListener))</span>
<span class="udiff-line-added">+             return false;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         // For SmoothScroll.js</span>
<span class="udiff-line-added">+         // Matches Blink intervention in https://chromium.googlesource.com/chromium/src/+/b6b13c9cfe64d52a4168d9d8d1ad9bb8f0b46a2a%5E%21/</span>
<span class="udiff-line-added">+         if (is&lt;DOMWindow&gt;(eventTarget)) {</span>
<span class="udiff-line-added">+             auto* document = downcast&lt;DOMWindow&gt;(eventTarget).document();</span>
<span class="udiff-line-added">+             if (!document || !document-&gt;quirks().needsQuirks())</span>
<span class="udiff-line-added">+                 return false;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             auto&amp; jsEventListener = downcast&lt;JSEventListener&gt;(eventListener);</span>
<span class="udiff-line-added">+             if (jsEventListener.functionName() == &quot;ssc_wheel&quot;)</span>
<span class="udiff-line-added">+                 return true;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         return false;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     return false;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ #if ENABLE(MEDIA_STREAM)</span>
<span class="udiff-line-added">+ bool Quirks::shouldEnableLegacyGetUserMedia() const</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     if (!needsQuirks())</span>
<span class="udiff-line-added">+         return false;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     return m_document-&gt;url().protocolIs(&quot;https&quot;) &amp;&amp; equalLettersIgnoringASCIICase(m_document-&gt; url().host(), &quot;www.baidu.com&quot;);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ bool Quirks::shouldDisableElementFullscreenQuirk() const</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+ #if PLATFORM(IOS_FAMILY)</span>
<span class="udiff-line-added">+     if (!needsQuirks())</span>
<span class="udiff-line-added">+         return false;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (m_shouldDisableElementFullscreenQuirk)</span>
<span class="udiff-line-added">+         return m_shouldDisableElementFullscreenQuirk.value();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     auto domain = m_document-&gt;securityOrigin().domain().convertToASCIILowercase();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     m_shouldDisableElementFullscreenQuirk = domain == &quot;nfl.com&quot; || domain.endsWith(&quot;.nfl.com&quot;);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     return m_shouldDisableElementFullscreenQuirk.value();</span>
<span class="udiff-line-added">+ #else</span>
<span class="udiff-line-added">+     return false;</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  }
</pre>
<center><a href="ProcessWarming.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="Quirks.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>