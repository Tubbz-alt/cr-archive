<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WebCore/page/scrolling/nicosia/ScrollingTreeStickyNode.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="ScrollingTreeNicosia.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="ScrollingTreeStickyNode.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/page/scrolling/nicosia/ScrollingTreeStickyNode.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,8 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (C) 2018 Igalia S.L.</span>
<span class="udiff-line-modified-added">+  * Copyright (C) 2012 Apple Inc. All rights reserved.</span>
<span class="udiff-line-added">+  * Copyright (C) 2019 Igalia S.L.</span>
   *
   * Redistribution and use in source and binary forms, with or without
   * modification, are permitted provided that the following conditions
   * are met:
   *
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -28,11 +29,19 @@</span>
  #include &quot;config.h&quot;
  #include &quot;ScrollingTreeStickyNode.h&quot;
  
  #if ENABLE(ASYNC_SCROLLING) &amp;&amp; USE(NICOSIA)
  
<span class="udiff-line-added">+ #include &quot;Logging.h&quot;</span>
<span class="udiff-line-added">+ #include &quot;NicosiaPlatformLayer.h&quot;</span>
<span class="udiff-line-added">+ #include &quot;ScrollingStateStickyNode.h&quot;</span>
  #include &quot;ScrollingTree.h&quot;
<span class="udiff-line-added">+ #include &quot;ScrollingTreeFixedNode.h&quot;</span>
<span class="udiff-line-added">+ #include &quot;ScrollingTreeFrameScrollingNode.h&quot;</span>
<span class="udiff-line-added">+ #include &quot;ScrollingTreeOverflowScrollProxyNode.h&quot;</span>
<span class="udiff-line-added">+ #include &quot;ScrollingTreeOverflowScrollingNode.h&quot;</span>
<span class="udiff-line-added">+ #include &lt;wtf/text/TextStream.h&gt;</span>
  
  namespace WebCore {
  
  Ref&lt;ScrollingTreeStickyNode&gt; ScrollingTreeStickyNode::create(ScrollingTree&amp; scrollingTree, ScrollingNodeID nodeID)
  {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -48,16 +57,94 @@</span>
  ScrollingTreeStickyNode::~ScrollingTreeStickyNode()
  {
      scrollingTree().fixedOrStickyNodeRemoved();
  }
  
<span class="udiff-line-modified-removed">- void ScrollingTreeStickyNode::commitStateBeforeChildren(const ScrollingStateNode&amp;)</span>
<span class="udiff-line-modified-added">+ void ScrollingTreeStickyNode::commitStateBeforeChildren(const ScrollingStateNode&amp; stateNode)</span>
  {
<span class="udiff-line-added">+     auto&amp; stickyStateNode = downcast&lt;ScrollingStateStickyNode&gt;(stateNode);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (stickyStateNode.hasChangedProperty(ScrollingStateNode::Layer)) {</span>
<span class="udiff-line-added">+         auto* layer = static_cast&lt;Nicosia::PlatformLayer*&gt;(stickyStateNode.layer());</span>
<span class="udiff-line-added">+         m_layer = downcast&lt;Nicosia::CompositionLayer&gt;(layer);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (stickyStateNode.hasChangedProperty(ScrollingStateStickyNode::ViewportConstraints))</span>
<span class="udiff-line-added">+         m_constraints = stickyStateNode.viewportConstraints();</span>
  }
  
  void ScrollingTreeStickyNode::applyLayerPositions()
  {
<span class="udiff-line-added">+     auto layerPosition = computeLayerPosition();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     LOG_WITH_STREAM(Scrolling, stream &lt;&lt; &quot;ScrollingTreeStickyNode &quot; &lt;&lt; scrollingNodeID() &lt;&lt; &quot; constrainingRectAtLastLayout &quot; &lt;&lt; m_constraints.constrainingRectAtLastLayout() &lt;&lt; &quot; last layer pos &quot; &lt;&lt; m_constraints.layerPositionAtLastLayout() &lt;&lt; &quot; layerPosition &quot; &lt;&lt; layerPosition);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     layerPosition -= m_constraints.alignmentOffset();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     ASSERT(m_layer);</span>
<span class="udiff-line-added">+     m_layer-&gt;updateState(</span>
<span class="udiff-line-added">+         [&amp;layerPosition](Nicosia::CompositionLayer::LayerState&amp; state)</span>
<span class="udiff-line-added">+         {</span>
<span class="udiff-line-added">+             state.position = layerPosition;</span>
<span class="udiff-line-added">+             state.delta.positionChanged = true;</span>
<span class="udiff-line-added">+         });</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void ScrollingTreeStickyNode::dumpProperties(TextStream&amp; ts, ScrollingStateTreeAsTextBehavior behavior) const</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     ts &lt;&lt; &quot;sticky node&quot;;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     ScrollingTreeNode::dumpProperties(ts, behavior);</span>
<span class="udiff-line-added">+     ts.dumpProperty(&quot;sticky constraints&quot;, m_constraints);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (behavior &amp; ScrollingStateTreeAsTextBehaviorIncludeLayerPositions) {</span>
<span class="udiff-line-added">+         FloatPoint layerTopLeft;</span>
<span class="udiff-line-added">+         ASSERT(m_layer);</span>
<span class="udiff-line-added">+         m_layer-&gt;accessCommitted(</span>
<span class="udiff-line-added">+             [this, &amp;layerTopLeft](Nicosia::CompositionLayer::LayerState&amp; state)</span>
<span class="udiff-line-added">+             {</span>
<span class="udiff-line-added">+                 layerTopLeft = state.position - toFloatSize(state.anchorPoint.xy()) * state.size + m_constraints.alignmentOffset();</span>
<span class="udiff-line-added">+             });</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         ts.dumpProperty(&quot;layer top left&quot;, layerTopLeft);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ FloatPoint ScrollingTreeStickyNode::computeLayerPosition() const</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     auto computeLayerPositionForScrollingNode = [&amp;](ScrollingTreeNode&amp; scrollingNode) {</span>
<span class="udiff-line-added">+         FloatRect constrainingRect;</span>
<span class="udiff-line-added">+         if (is&lt;ScrollingTreeFrameScrollingNode&gt;(scrollingNode)) {</span>
<span class="udiff-line-added">+             auto&amp; frameScrollingNode = downcast&lt;ScrollingTreeFrameScrollingNode&gt;(scrollingNode);</span>
<span class="udiff-line-added">+             constrainingRect = frameScrollingNode.layoutViewport();</span>
<span class="udiff-line-added">+         } else {</span>
<span class="udiff-line-added">+             auto&amp; overflowScrollingNode = downcast&lt;ScrollingTreeOverflowScrollingNode&gt;(scrollingNode);</span>
<span class="udiff-line-added">+             constrainingRect = FloatRect(overflowScrollingNode.currentScrollPosition(), m_constraints.constrainingRectAtLastLayout().size());</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         return m_constraints.layerPositionForConstrainingRect(constrainingRect);</span>
<span class="udiff-line-added">+     };</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     for (auto* ancestor = parent(); ancestor; ancestor = ancestor-&gt;parent()) {</span>
<span class="udiff-line-added">+         if (is&lt;ScrollingTreeOverflowScrollProxyNode&gt;(*ancestor)) {</span>
<span class="udiff-line-added">+             auto&amp; overflowProxyNode = downcast&lt;ScrollingTreeOverflowScrollProxyNode&gt;(*ancestor);</span>
<span class="udiff-line-added">+             auto overflowNode = scrollingTree().nodeForID(overflowProxyNode.overflowScrollingNodeID());</span>
<span class="udiff-line-added">+             if (!overflowNode)</span>
<span class="udiff-line-added">+                 break;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             return computeLayerPositionForScrollingNode(*overflowNode);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         if (is&lt;ScrollingTreeScrollingNode&gt;(*ancestor))</span>
<span class="udiff-line-added">+             return computeLayerPositionForScrollingNode(*ancestor);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         if (is&lt;ScrollingTreeFixedNode&gt;(*ancestor) || is&lt;ScrollingTreeStickyNode&gt;(*ancestor)) {</span>
<span class="udiff-line-added">+             // FIXME: Do we need scrolling tree nodes at all for nested cases?</span>
<span class="udiff-line-added">+             return m_constraints.layerPositionAtLastLayout();</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+     ASSERT_NOT_REACHED();</span>
<span class="udiff-line-added">+     return m_constraints.layerPositionAtLastLayout();</span>
  }
  
  } // namespace WebCore
  
  #endif // ENABLE(ASYNC_SCROLLING) &amp;&amp; USE(NICOSIA)
</pre>
<center><a href="ScrollingTreeNicosia.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="ScrollingTreeStickyNode.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>