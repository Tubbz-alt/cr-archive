<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.web/src/main/native/Source/WebCore/testing/js/WebCoreTestSupport.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../ServiceWorkerInternals.idl.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="WebCoreTestSupport.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/testing/js/WebCoreTestSupport.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 37,11 ***</span>
  #include &quot;LogInitialization.h&quot;
  #include &quot;MockGamepadProvider.h&quot;
  #include &quot;Page.h&quot;
  #include &quot;SWContextManager.h&quot;
  #include &quot;ServiceWorkerGlobalScope.h&quot;
<span class="line-modified">! #include &quot;WheelEventTestTrigger.h&quot;</span>
  #include &lt;JavaScriptCore/APICast.h&gt;
  #include &lt;JavaScriptCore/CallFrame.h&gt;
  #include &lt;JavaScriptCore/IdentifierInlines.h&gt;
  #include &lt;JavaScriptCore/JSValueRef.h&gt;
  #include &lt;wtf/URLParser.h&gt;
<span class="line-new-header">--- 37,11 ---</span>
  #include &quot;LogInitialization.h&quot;
  #include &quot;MockGamepadProvider.h&quot;
  #include &quot;Page.h&quot;
  #include &quot;SWContextManager.h&quot;
  #include &quot;ServiceWorkerGlobalScope.h&quot;
<span class="line-modified">! #include &quot;WheelEventTestMonitor.h&quot;</span>
  #include &lt;JavaScriptCore/APICast.h&gt;
  #include &lt;JavaScriptCore/CallFrame.h&gt;
  #include &lt;JavaScriptCore/IdentifierInlines.h&gt;
  #include &lt;JavaScriptCore/JSValueRef.h&gt;
  #include &lt;wtf/URLParser.h&gt;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 54,26 ***</span>
  using namespace JSC;
  using namespace WebCore;
  
  void injectInternalsObject(JSContextRef context)
  {
<span class="line-modified">!     ExecState* exec = toJS(context);</span>
<span class="line-modified">!     VM&amp; vm = exec-&gt;vm();</span>
      JSLockHolder lock(vm);
<span class="line-modified">!     JSDOMGlobalObject* globalObject = jsCast&lt;JSDOMGlobalObject*&gt;(exec-&gt;lexicalGlobalObject());</span>
      ScriptExecutionContext* scriptContext = globalObject-&gt;scriptExecutionContext();
      if (is&lt;Document&gt;(*scriptContext)) {
<span class="line-modified">!         globalObject-&gt;putDirect(vm, Identifier::fromString(vm, Internals::internalsId), toJS(exec, globalObject, Internals::create(downcast&lt;Document&gt;(*scriptContext))));</span>
          globalObject-&gt;exposeDollarVM(vm);
      }
  }
  
  void resetInternalsObject(JSContextRef context)
  {
<span class="line-modified">!     ExecState* exec = toJS(context);</span>
<span class="line-modified">!     JSLockHolder lock(exec);</span>
<span class="line-modified">!     JSDOMGlobalObject* globalObject = jsCast&lt;JSDOMGlobalObject*&gt;(exec-&gt;lexicalGlobalObject());</span>
      ScriptExecutionContext* scriptContext = globalObject-&gt;scriptExecutionContext();
      Page* page = downcast&lt;Document&gt;(scriptContext)-&gt;frame()-&gt;page();
      Internals::resetToConsistentState(*page);
      InternalSettings::from(page)-&gt;resetToConsistentState();
  }
<span class="line-new-header">--- 54,27 ---</span>
  using namespace JSC;
  using namespace WebCore;
  
  void injectInternalsObject(JSContextRef context)
  {
<span class="line-modified">!     JSGlobalObject* lexicalGlobalObject = toJS(context);</span>
<span class="line-modified">!     VM&amp; vm = lexicalGlobalObject-&gt;vm();</span>
      JSLockHolder lock(vm);
<span class="line-modified">!     JSDOMGlobalObject* globalObject = jsCast&lt;JSDOMGlobalObject*&gt;(lexicalGlobalObject);</span>
      ScriptExecutionContext* scriptContext = globalObject-&gt;scriptExecutionContext();
      if (is&lt;Document&gt;(*scriptContext)) {
<span class="line-modified">!         globalObject-&gt;putDirect(vm, Identifier::fromString(vm, Internals::internalsId), toJS(lexicalGlobalObject, globalObject, Internals::create(downcast&lt;Document&gt;(*scriptContext))));</span>
<span class="line-added">+         Options::useDollarVM() = true;</span>
          globalObject-&gt;exposeDollarVM(vm);
      }
  }
  
  void resetInternalsObject(JSContextRef context)
  {
<span class="line-modified">!     JSGlobalObject* lexicalGlobalObject = toJS(context);</span>
<span class="line-modified">!     JSLockHolder lock(lexicalGlobalObject);</span>
<span class="line-modified">!     JSDOMGlobalObject* globalObject = jsCast&lt;JSDOMGlobalObject*&gt;(lexicalGlobalObject);</span>
      ScriptExecutionContext* scriptContext = globalObject-&gt;scriptExecutionContext();
      Page* page = downcast&lt;Document&gt;(scriptContext)-&gt;frame()-&gt;page();
      Internals::resetToConsistentState(*page);
      InternalSettings::from(page)-&gt;resetToConsistentState();
  }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 82,34 ***</span>
  {
      Page* page = frame.page();
      if (!page)
          return;
  
<span class="line-modified">!     page-&gt;ensureTestTrigger();</span>
  }
  
  void setTestCallbackAndStartNotificationTimer(WebCore::Frame&amp; frame, JSContextRef context, JSObjectRef jsCallbackFunction)
  {
      Page* page = frame.page();
<span class="line-modified">!     if (!page || !page-&gt;expectsWheelEventTriggers())</span>
          return;
  
      JSValueProtect(context, jsCallbackFunction);
  
<span class="line-modified">!     page-&gt;ensureTestTrigger().setTestCallbackAndStartNotificationTimer([=](void) {</span>
          JSObjectCallAsFunction(context, jsCallbackFunction, nullptr, 0, nullptr, nullptr);
          JSValueUnprotect(context, jsCallbackFunction);
      });
  }
  
<span class="line-modified">! void clearWheelEventTestTrigger(WebCore::Frame&amp; frame)</span>
  {
      Page* page = frame.page();
      if (!page)
          return;
  
<span class="line-modified">!     page-&gt;clearTrigger();</span>
  }
  
  void setLogChannelToAccumulate(const String&amp; name)
  {
  #if !LOG_DISABLED
<span class="line-new-header">--- 83,34 ---</span>
  {
      Page* page = frame.page();
      if (!page)
          return;
  
<span class="line-modified">!     page-&gt;ensureWheelEventTestMonitor();</span>
  }
  
  void setTestCallbackAndStartNotificationTimer(WebCore::Frame&amp; frame, JSContextRef context, JSObjectRef jsCallbackFunction)
  {
      Page* page = frame.page();
<span class="line-modified">!     if (!page || !page-&gt;isMonitoringWheelEvents())</span>
          return;
  
      JSValueProtect(context, jsCallbackFunction);
  
<span class="line-modified">!     page-&gt;ensureWheelEventTestMonitor().setTestCallbackAndStartNotificationTimer([=](void) {</span>
          JSObjectCallAsFunction(context, jsCallbackFunction, nullptr, 0, nullptr, nullptr);
          JSValueUnprotect(context, jsCallbackFunction);
      });
  }
  
<span class="line-modified">! void clearWheelEventTestMonitor(WebCore::Frame&amp; frame)</span>
  {
      Page* page = frame.page();
      if (!page)
          return;
  
<span class="line-modified">!     page-&gt;clearWheelEventTestMonitor();</span>
  }
  
  void setLogChannelToAccumulate(const String&amp; name)
  {
  #if !LOG_DISABLED
</pre>
<hr />
<pre>
<span class="line-old-header">*** 117,10 ***</span>
<span class="line-new-header">--- 118,17 ---</span>
  #else
      UNUSED_PARAM(name);
  #endif
  }
  
<span class="line-added">+ void clearAllLogChannelsToAccumulate()</span>
<span class="line-added">+ {</span>
<span class="line-added">+ #if !LOG_DISABLED</span>
<span class="line-added">+     WebCore::clearAllLogChannelsToAccumulate();</span>
<span class="line-added">+ #endif</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
  void initializeLogChannelsIfNecessary()
  {
  #if !LOG_DISABLED || !RELEASE_LOG_DISABLED
      WebCore::initializeLogChannelsIfNecessary();
  #endif
</pre>
<center><a href="../ServiceWorkerInternals.idl.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="WebCoreTestSupport.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>