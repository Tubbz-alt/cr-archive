<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/JavaScriptCore/runtime/CodeCache.h</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="CodeCache.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="CommonIdentifiers.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/JavaScriptCore/runtime/CodeCache.h</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -23,11 +23,10 @@</span>
   * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
   */
  
  #pragma once
  
<span class="udiff-line-removed">- #include &quot;BytecodeGenerator.h&quot;</span>
  #include &quot;CachedTypes.h&quot;
  #include &quot;ExecutableInfo.h&quot;
  #include &quot;JSCInlines.h&quot;
  #include &quot;Parser.h&quot;
  #include &quot;ParserModes.h&quot;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -48,20 +47,15 @@</span>
  class DirectEvalExecutable;
  class ModuleProgramExecutable;
  class ParserError;
  class ProgramExecutable;
  class SourceCode;
<span class="udiff-line-removed">- class UnlinkedCodeBlock;</span>
<span class="udiff-line-removed">- class UnlinkedEvalCodeBlock;</span>
<span class="udiff-line-removed">- class UnlinkedFunctionExecutable;</span>
<span class="udiff-line-removed">- class UnlinkedModuleProgramCodeBlock;</span>
<span class="udiff-line-removed">- class UnlinkedProgramCodeBlock;</span>
  class VM;
  class VariableEnvironment;
  
  namespace CodeCacheInternal {
<span class="udiff-line-modified-removed">- static const bool verbose = false;</span>
<span class="udiff-line-modified-added">+ static constexpr bool verbose = false;</span>
  } // namespace CodeCacheInternal
  
  struct SourceCodeValue {
      SourceCodeValue()
      {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -177,22 +171,22 @@</span>
      std::enable_if_t&lt;!std::is_base_of&lt;UnlinkedCodeBlock, T&gt;::value || std::is_same&lt;T, UnlinkedEvalCodeBlock&gt;::value, T*&gt;
      fetchFromDisk(VM&amp;, const SourceCodeKey&amp;) { return nullptr; }
  
      // This constant factor biases cache capacity toward allowing a minimum
      // working set to enter the cache before it starts evicting.
<span class="udiff-line-modified-removed">-     static const Seconds workingSetTime;</span>
<span class="udiff-line-modified-removed">-     static const int64_t workingSetMaxBytes = 16000000;</span>
<span class="udiff-line-modified-removed">-     static const size_t workingSetMaxEntries = 2000;</span>
<span class="udiff-line-modified-added">+     static constexpr Seconds workingSetTime = 10_s;</span>
<span class="udiff-line-modified-added">+     static constexpr int64_t workingSetMaxBytes = 16000000;</span>
<span class="udiff-line-modified-added">+     static constexpr size_t workingSetMaxEntries = 2000;</span>
  
      // This constant factor biases cache capacity toward recent activity. We
      // want to adapt to changing workloads.
<span class="udiff-line-modified-removed">-     static const int64_t recencyBias = 4;</span>
<span class="udiff-line-modified-added">+     static constexpr int64_t recencyBias = 4;</span>
  
      // This constant factor treats a sampled event for one old object as if it
      // happened for many old objects. Most old objects are evicted before we can
      // sample them, so we need to extrapolate from the ones we do sample.
<span class="udiff-line-modified-removed">-     static const int64_t oldObjectSamplingMultiplier = 32;</span>
<span class="udiff-line-modified-added">+     static constexpr int64_t oldObjectSamplingMultiplier = 32;</span>
  
      size_t numberOfEntries() const { return static_cast&lt;size_t&gt;(m_map.size()); }
      bool canPruneQuickly() const { return numberOfEntries() &lt; workingSetMaxEntries; }
  
      void pruneSlowCase();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -241,83 +235,29 @@</span>
  
  template &lt;typename T&gt; struct CacheTypes { };
  
  template &lt;&gt; struct CacheTypes&lt;UnlinkedProgramCodeBlock&gt; {
      typedef JSC::ProgramNode RootNode;
<span class="udiff-line-modified-removed">-     static const SourceCodeType codeType = SourceCodeType::ProgramType;</span>
<span class="udiff-line-modified-removed">-     static const SourceParseMode parseMode = SourceParseMode::ProgramMode;</span>
<span class="udiff-line-modified-added">+     static constexpr SourceCodeType codeType = SourceCodeType::ProgramType;</span>
<span class="udiff-line-modified-added">+     static constexpr SourceParseMode parseMode = SourceParseMode::ProgramMode;</span>
  };
  
  template &lt;&gt; struct CacheTypes&lt;UnlinkedEvalCodeBlock&gt; {
      typedef JSC::EvalNode RootNode;
<span class="udiff-line-modified-removed">-     static const SourceCodeType codeType = SourceCodeType::EvalType;</span>
<span class="udiff-line-modified-removed">-     static const SourceParseMode parseMode = SourceParseMode::ProgramMode;</span>
<span class="udiff-line-modified-added">+     static constexpr SourceCodeType codeType = SourceCodeType::EvalType;</span>
<span class="udiff-line-modified-added">+     static constexpr SourceParseMode parseMode = SourceParseMode::ProgramMode;</span>
  };
  
  template &lt;&gt; struct CacheTypes&lt;UnlinkedModuleProgramCodeBlock&gt; {
      typedef JSC::ModuleProgramNode RootNode;
<span class="udiff-line-modified-removed">-     static const SourceCodeType codeType = SourceCodeType::ModuleType;</span>
<span class="udiff-line-modified-removed">-     static const SourceParseMode parseMode = SourceParseMode::ModuleEvaluateMode;</span>
<span class="udiff-line-modified-added">+     static constexpr SourceCodeType codeType = SourceCodeType::ModuleType;</span>
<span class="udiff-line-modified-added">+     static constexpr SourceParseMode parseMode = SourceParseMode::ModuleEvaluateMode;</span>
  };
  
<span class="udiff-line-modified-removed">- template &lt;class UnlinkedCodeBlockType, class ExecutableType = ScriptExecutable&gt;</span>
<span class="udiff-line-modified-removed">- UnlinkedCodeBlockType* generateUnlinkedCodeBlockImpl(VM&amp; vm, const SourceCode&amp; source, JSParserStrictMode strictMode, JSParserScriptMode scriptMode, OptionSet&lt;CodeGenerationMode&gt; codeGenerationMode, ParserError&amp; error, EvalContextType evalContextType, DerivedContextType derivedContextType, bool isArrowFunctionContext, const VariableEnvironment* variablesUnderTDZ, ExecutableType* executable = nullptr)</span>
<span class="udiff-line-modified-removed">- {</span>
<span class="udiff-line-removed">-     typedef typename CacheTypes&lt;UnlinkedCodeBlockType&gt;::RootNode RootNode;</span>
<span class="udiff-line-removed">-     std::unique_ptr&lt;RootNode&gt; rootNode = parse&lt;RootNode&gt;(</span>
<span class="udiff-line-removed">-         vm, source, Identifier(), JSParserBuiltinMode::NotBuiltin, strictMode, scriptMode, CacheTypes&lt;UnlinkedCodeBlockType&gt;::parseMode, SuperBinding::NotNeeded, error, nullptr, ConstructorKind::None, derivedContextType, evalContextType);</span>
<span class="udiff-line-removed">-     if (!rootNode)</span>
<span class="udiff-line-removed">-         return nullptr;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     unsigned lineCount = rootNode-&gt;lastLine() - rootNode-&gt;firstLine();</span>
<span class="udiff-line-removed">-     unsigned startColumn = rootNode-&gt;startColumn() + 1;</span>
<span class="udiff-line-removed">-     bool endColumnIsOnStartLine = !lineCount;</span>
<span class="udiff-line-removed">-     unsigned unlinkedEndColumn = rootNode-&gt;endColumn();</span>
<span class="udiff-line-removed">-     unsigned endColumn = unlinkedEndColumn + (endColumnIsOnStartLine ? startColumn : 1);</span>
<span class="udiff-line-removed">-     unsigned arrowContextFeature = isArrowFunctionContext ? ArrowFunctionContextFeature : 0;</span>
<span class="udiff-line-removed">-     if (executable)</span>
<span class="udiff-line-removed">-         executable-&gt;recordParse(rootNode-&gt;features() | arrowContextFeature, rootNode-&gt;hasCapturedVariables(), rootNode-&gt;lastLine(), endColumn);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     bool usesEval = rootNode-&gt;features() &amp; EvalFeature;</span>
<span class="udiff-line-removed">-     bool isStrictMode = rootNode-&gt;features() &amp; StrictModeFeature;</span>
<span class="udiff-line-removed">-     ExecutableInfo executableInfo(usesEval, isStrictMode, false, false, ConstructorKind::None, scriptMode, SuperBinding::NotNeeded, CacheTypes&lt;UnlinkedCodeBlockType&gt;::parseMode, derivedContextType, isArrowFunctionContext, false, evalContextType);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     UnlinkedCodeBlockType* unlinkedCodeBlock = UnlinkedCodeBlockType::create(vm, executableInfo, codeGenerationMode);</span>
<span class="udiff-line-removed">-     unlinkedCodeBlock-&gt;recordParse(rootNode-&gt;features(), rootNode-&gt;hasCapturedVariables(), lineCount, unlinkedEndColumn);</span>
<span class="udiff-line-removed">-     if (!source.provider()-&gt;sourceURLDirective().isNull())</span>
<span class="udiff-line-removed">-         unlinkedCodeBlock-&gt;setSourceURLDirective(source.provider()-&gt;sourceURLDirective());</span>
<span class="udiff-line-removed">-     if (!source.provider()-&gt;sourceMappingURLDirective().isNull())</span>
<span class="udiff-line-removed">-         unlinkedCodeBlock-&gt;setSourceMappingURLDirective(source.provider()-&gt;sourceMappingURLDirective());</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     error = BytecodeGenerator::generate(vm, rootNode.get(), source, unlinkedCodeBlock, codeGenerationMode, variablesUnderTDZ);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     if (error.isValid())</span>
<span class="udiff-line-removed">-         return nullptr;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     return unlinkedCodeBlock;</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- template &lt;class UnlinkedCodeBlockType, class ExecutableType&gt;</span>
<span class="udiff-line-removed">- UnlinkedCodeBlockType* generateUnlinkedCodeBlock(VM&amp; vm, ExecutableType* executable, const SourceCode&amp; source, JSParserStrictMode strictMode, JSParserScriptMode scriptMode, OptionSet&lt;CodeGenerationMode&gt; codeGenerationMode, ParserError&amp; error, EvalContextType evalContextType, const VariableEnvironment* variablesUnderTDZ)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-     return generateUnlinkedCodeBlockImpl&lt;UnlinkedCodeBlockType, ExecutableType&gt;(vm, source, strictMode, scriptMode, codeGenerationMode, error, evalContextType, executable-&gt;derivedContextType(), executable-&gt;isArrowFunctionContext(), variablesUnderTDZ, executable);</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- void generateUnlinkedCodeBlockForFunctions(VM&amp;, UnlinkedCodeBlock*, const SourceCode&amp;, OptionSet&lt;CodeGenerationMode&gt;, ParserError&amp;);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- template &lt;class UnlinkedCodeBlockType&gt;</span>
<span class="udiff-line-removed">- std::enable_if_t&lt;!std::is_same&lt;UnlinkedCodeBlockType, UnlinkedEvalCodeBlock&gt;::value, UnlinkedCodeBlockType*&gt;</span>
<span class="udiff-line-removed">- recursivelyGenerateUnlinkedCodeBlock(VM&amp; vm, const SourceCode&amp; source, JSParserStrictMode strictMode, JSParserScriptMode scriptMode, OptionSet&lt;CodeGenerationMode&gt; codeGenerationMode, ParserError&amp; error, EvalContextType evalContextType, const VariableEnvironment* variablesUnderTDZ)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-     bool isArrowFunctionContext = false;</span>
<span class="udiff-line-removed">-     UnlinkedCodeBlockType* unlinkedCodeBlock = generateUnlinkedCodeBlockImpl&lt;UnlinkedCodeBlockType&gt;(vm, source, strictMode, scriptMode, codeGenerationMode, error, evalContextType, DerivedContextType::None, isArrowFunctionContext, variablesUnderTDZ);</span>
<span class="udiff-line-removed">-     if (!unlinkedCodeBlock)</span>
<span class="udiff-line-removed">-         return nullptr;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     generateUnlinkedCodeBlockForFunctions(vm, unlinkedCodeBlock, source, codeGenerationMode, error);</span>
<span class="udiff-line-removed">-     return unlinkedCodeBlock;</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-modified-added">+ UnlinkedEvalCodeBlock* generateUnlinkedCodeBlockForDirectEval(VM&amp;, DirectEvalExecutable*, const SourceCode&amp;, JSParserStrictMode, JSParserScriptMode, OptionSet&lt;CodeGenerationMode&gt;, ParserError&amp;, EvalContextType, const VariableEnvironment* variablesUnderTDZ);</span>
<span class="udiff-line-modified-added">+ UnlinkedProgramCodeBlock* recursivelyGenerateUnlinkedCodeBlockForProgram(VM&amp;, const SourceCode&amp;, JSParserStrictMode, JSParserScriptMode, OptionSet&lt;CodeGenerationMode&gt;, ParserError&amp;, EvalContextType, const VariableEnvironment* variablesUnderTDZ);</span>
<span class="udiff-line-modified-added">+ UnlinkedModuleProgramCodeBlock* recursivelyGenerateUnlinkedCodeBlockForModuleProgram(VM&amp;, const SourceCode&amp;, JSParserStrictMode, JSParserScriptMode, OptionSet&lt;CodeGenerationMode&gt;, ParserError&amp;, EvalContextType, const VariableEnvironment* variablesUnderTDZ);</span>
  
  void writeCodeBlock(VM&amp;, const SourceCodeKey&amp;, const SourceCodeValue&amp;);
  RefPtr&lt;CachedBytecode&gt; serializeBytecode(VM&amp;, UnlinkedCodeBlock*, const SourceCode&amp;, SourceCodeType, JSParserStrictMode, JSParserScriptMode, FileSystem::PlatformFileHandle fd, BytecodeCacheError&amp;, OptionSet&lt;CodeGenerationMode&gt;);
  SourceCodeKey sourceCodeKeyForSerializedProgram(VM&amp;, const SourceCode&amp;);
  SourceCodeKey sourceCodeKeyForSerializedModule(VM&amp;, const SourceCode&amp;);
</pre>
<center><a href="CodeCache.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="CommonIdentifiers.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>