<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WebCore/Modules/applepay/ApplePaySession.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="ApplePayRequestBase.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="ApplePaySession.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/Modules/applepay/ApplePaySession.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  11  *    documentation and/or other materials provided with the distribution.
  12  *
  13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. AND ITS CONTRIBUTORS ``AS IS&#39;&#39;
  14  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
  15  * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
  16  * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL APPLE INC. OR ITS CONTRIBUTORS
  17  * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
  18  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
  19  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
  20  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
  21  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
  22  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF
  23  * THE POSSIBILITY OF SUCH DAMAGE.
  24  */
  25 
  26 #include &quot;config.h&quot;
  27 #include &quot;ApplePaySession.h&quot;
  28 
  29 #if ENABLE(APPLE_PAY)
  30 

  31 #include &quot;ApplePayLineItem.h&quot;
  32 #include &quot;ApplePayPaymentAuthorizationResult.h&quot;
  33 #include &quot;ApplePayPaymentAuthorizedEvent.h&quot;
  34 #include &quot;ApplePayPaymentMethodSelectedEvent.h&quot;
  35 #include &quot;ApplePayPaymentMethodUpdate.h&quot;
  36 #include &quot;ApplePayPaymentRequest.h&quot;
  37 #include &quot;ApplePayShippingContactSelectedEvent.h&quot;
  38 #include &quot;ApplePayShippingContactUpdate.h&quot;
  39 #include &quot;ApplePayShippingMethod.h&quot;
  40 #include &quot;ApplePayShippingMethodSelectedEvent.h&quot;
  41 #include &quot;ApplePayShippingMethodUpdate.h&quot;
  42 #include &quot;ApplePayValidateMerchantEvent.h&quot;
  43 #include &quot;CustomHeaderFields.h&quot;
  44 #include &quot;DOMWindow.h&quot;
  45 #include &quot;Document.h&quot;
  46 #include &quot;DocumentLoader.h&quot;
  47 #include &quot;EventNames.h&quot;
  48 #include &quot;Frame.h&quot;
  49 #include &quot;JSDOMPromiseDeferred.h&quot;
  50 #include &quot;LinkIconCollector.h&quot;
  51 #include &quot;LinkIconType.h&quot;
  52 #include &quot;Page.h&quot;
  53 #include &quot;PageConsoleClient.h&quot;
  54 #include &quot;PaymentAuthorizationStatus.h&quot;
  55 #include &quot;PaymentContact.h&quot;
  56 #include &quot;PaymentCoordinator.h&quot;
  57 #include &quot;PaymentMerchantSession.h&quot;
  58 #include &quot;PaymentMethod.h&quot;

  59 #include &quot;PaymentRequestValidator.h&quot;
  60 #include &quot;SecurityOrigin.h&quot;
  61 #include &quot;Settings.h&quot;
  62 #include &quot;UserGestureIndicator.h&quot;
  63 #include &lt;wtf/IsoMallocInlines.h&gt;
  64 








  65 namespace WebCore {
  66 
  67 WTF_MAKE_ISO_ALLOCATED_IMPL(ApplePaySession);
  68 
  69 // The amount follows the regular expression -?[0-9]+(\.[0-9][0-9])?.
  70 static bool validateAmount(const String&amp; amountString)
  71 {
  72     enum class State {
  73         Start,
  74         Sign,
  75         Digit,
  76         Dot,
  77         DotDigit,
  78         End,
  79     };
  80 
  81     State state = State::Start;
  82 
  83     for (unsigned i = 0; i &lt; amountString.length(); ++i) {
  84         UChar c = amountString[i];
</pre>
<hr />
<pre>
 121         case State::DotDigit:
 122             if (!isASCIIDigit(c))
 123                 return false;
 124 
 125             state = State::End;
 126             break;
 127 
 128         case State::End:
 129             return false;
 130         }
 131     }
 132 
 133     return state == State::Digit || state == State::DotDigit || state == State::End;
 134 }
 135 
 136 static ExceptionOr&lt;ApplePaySessionPaymentRequest::LineItem&gt; convertAndValidateTotal(ApplePayLineItem&amp;&amp; lineItem)
 137 {
 138     if (!validateAmount(lineItem.amount))
 139         return Exception { TypeError, makeString(&quot;\&quot;&quot; + lineItem.amount, &quot;\&quot; is not a valid amount.&quot;) };
 140 
<span class="line-modified"> 141     ApplePaySessionPaymentRequest::LineItem result;</span>
<span class="line-removed"> 142     result.amount = lineItem.amount;</span>
<span class="line-removed"> 143     result.type = lineItem.type;</span>
<span class="line-removed"> 144     result.label = lineItem.label;</span>
 145 
<span class="line-modified"> 146     return WTFMove(result);</span>




 147 }
 148 
 149 static ExceptionOr&lt;ApplePaySessionPaymentRequest::LineItem&gt; convertAndValidate(ApplePayLineItem&amp;&amp; lineItem)
 150 {
 151     ApplePaySessionPaymentRequest::LineItem result;
 152 
 153     // It is OK for pending types to not have an amount.
 154     if (lineItem.type != ApplePaySessionPaymentRequest::LineItem::Type::Pending) {
 155         if (!validateAmount(lineItem.amount))
 156             return Exception { TypeError, makeString(&quot;\&quot;&quot; + lineItem.amount, &quot;\&quot; is not a valid amount.&quot;) };
 157 
 158         result.amount = lineItem.amount;
 159     }
 160 
 161     result.type = lineItem.type;
 162     result.label = lineItem.label;
 163 
 164     return WTFMove(result);
 165 }
 166 
</pre>
<hr />
<pre>
 300 
 301     case ApplePaySession::STATUS_PIN_INCORRECT:
 302         convertedResult.status = PaymentAuthorizationStatus::PINIncorrect;
 303         break;
 304 
 305     case ApplePaySession::STATUS_PIN_LOCKOUT:
 306         convertedResult.status = PaymentAuthorizationStatus::PINLockout;
 307         break;
 308 
 309     default:
 310         return Exception { InvalidAccessError };
 311     }
 312 
 313     convertedResult.errors.appendVector(convert(result.errors));
 314 
 315     return WTFMove(convertedResult);
 316 }
 317 
 318 static ExceptionOr&lt;PaymentMethodUpdate&gt; convertAndValidate(ApplePayPaymentMethodUpdate&amp;&amp; update)
 319 {
<span class="line-removed"> 320     PaymentMethodUpdate convertedUpdate;</span>
<span class="line-removed"> 321 </span>
 322     auto convertedNewTotal = convertAndValidateTotal(WTFMove(update.newTotal));
 323     if (convertedNewTotal.hasException())
 324         return convertedNewTotal.releaseException();
<span class="line-removed"> 325     convertedUpdate.newTotalAndLineItems.total = convertedNewTotal.releaseReturnValue();</span>
<span class="line-removed"> 326 </span>
<span class="line-removed"> 327     // FIXME: Merge this validation into the validation we are doing above.</span>
<span class="line-removed"> 328     auto validatedTotal = PaymentRequestValidator::validateTotal(convertedUpdate.newTotalAndLineItems.total);</span>
<span class="line-removed"> 329     if (validatedTotal.hasException())</span>
<span class="line-removed"> 330         return validatedTotal.releaseException();</span>
 331 
 332     auto convertedNewLineItems = convertAndValidate(WTFMove(update.newLineItems));
 333     if (convertedNewLineItems.hasException())
 334         return convertedNewLineItems.releaseException();
 335 
<span class="line-modified"> 336     convertedUpdate.newTotalAndLineItems.lineItems = convertedNewLineItems.releaseReturnValue();</span>

 337 
 338     return WTFMove(convertedUpdate);
 339 }
 340 
 341 static ExceptionOr&lt;ShippingContactUpdate&gt; convertAndValidate(ApplePayShippingContactUpdate&amp;&amp; update)
 342 {
 343     ShippingContactUpdate convertedUpdate;
 344 
 345     convertedUpdate.errors = convert(update.errors);
 346 
 347     auto convertedNewShippingMethods = convertAndValidate(WTFMove(update.newShippingMethods));
 348     if (convertedNewShippingMethods.hasException())
 349         return convertedNewShippingMethods.releaseException();
 350     convertedUpdate.newShippingMethods = convertedNewShippingMethods.releaseReturnValue();
 351 
 352     auto convertedNewTotal = convertAndValidateTotal(WTFMove(update.newTotal));
 353     if (convertedNewTotal.hasException())
 354         return convertedNewTotal.releaseException();
 355     convertedUpdate.newTotalAndLineItems.total = convertedNewTotal.releaseReturnValue();
 356 
<span class="line-removed"> 357     // FIXME: Merge this validation into the validation we are doing above.</span>
<span class="line-removed"> 358     auto validatedTotal = PaymentRequestValidator::validateTotal(convertedUpdate.newTotalAndLineItems.total);</span>
<span class="line-removed"> 359     if (validatedTotal.hasException())</span>
<span class="line-removed"> 360         return validatedTotal.releaseException();</span>
<span class="line-removed"> 361 </span>
 362     auto convertedNewLineItems = convertAndValidate(WTFMove(update.newLineItems));
 363     if (convertedNewLineItems.hasException())
 364         return convertedNewLineItems.releaseException();
 365     convertedUpdate.newTotalAndLineItems.lineItems = convertedNewLineItems.releaseReturnValue();
 366 
 367     return WTFMove(convertedUpdate);
 368 }
 369 
 370 static ExceptionOr&lt;ShippingMethodUpdate&gt; convertAndValidate(ApplePayShippingMethodUpdate&amp;&amp; update)
 371 {
 372     ShippingMethodUpdate convertedUpdate;
 373 
 374     auto convertedNewTotal = convertAndValidateTotal(WTFMove(update.newTotal));
 375     if (convertedNewTotal.hasException())
 376         return convertedNewTotal.releaseException();
 377 
 378     convertedUpdate.newTotalAndLineItems.total = convertedNewTotal.releaseReturnValue();
 379 
<span class="line-removed"> 380     // FIXME: Merge this validation into the validation we are doing above.</span>
<span class="line-removed"> 381     auto validatedTotal = PaymentRequestValidator::validateTotal(convertedUpdate.newTotalAndLineItems.total);</span>
<span class="line-removed"> 382     if (validatedTotal.hasException())</span>
<span class="line-removed"> 383         return validatedTotal.releaseException();</span>
<span class="line-removed"> 384 </span>
 385     auto convertedNewLineItems = convertAndValidate(WTFMove(update.newLineItems));
 386     if (convertedNewLineItems.hasException())
 387         return convertedNewLineItems.releaseException();
 388 
 389     convertedUpdate.newTotalAndLineItems.lineItems = convertedNewLineItems.releaseReturnValue();
 390 
 391     return WTFMove(convertedUpdate);
 392 }
 393 
 394 ExceptionOr&lt;Ref&lt;ApplePaySession&gt;&gt; ApplePaySession::create(Document&amp; document, unsigned version, ApplePayPaymentRequest&amp;&amp; paymentRequest)
 395 {
 396     auto canCall = canCreateSession(document);
 397     if (canCall.hasException())
 398         return canCall.releaseException();
 399 
 400     if (!UserGestureIndicator::processingUserGesture())
 401         return Exception { InvalidAccessError, &quot;Must create a new ApplePaySession from a user gesture handler.&quot; };
 402 
 403     if (!document.page())
 404         return Exception { InvalidAccessError, &quot;Frame is detached&quot; };
</pre>
<hr />
<pre>
 529     m_state = State::Active;
 530 
 531     setPendingActivity(*this);
 532 
 533     return { };
 534 }
 535 
 536 ExceptionOr&lt;void&gt; ApplePaySession::abort()
 537 {
 538     if (!canAbort())
 539         return Exception { InvalidAccessError };
 540 
 541     m_state = State::Aborted;
 542     paymentCoordinator().abortPaymentSession();
 543 
 544     didReachFinalState();
 545 
 546     return { };
 547 }
 548 
<span class="line-modified"> 549 ExceptionOr&lt;void&gt; ApplePaySession::completeMerchantValidation(JSC::ExecState&amp; state, JSC::JSValue merchantSessionValue)</span>
 550 {
 551     if (!canCompleteMerchantValidation())
 552         return Exception { InvalidAccessError };
 553 
 554     if (!merchantSessionValue.isObject())
 555         return Exception { TypeError };
 556 
 557     auto&amp; document = *downcast&lt;Document&gt;(scriptExecutionContext());
 558     auto&amp; window = *document.domWindow();
 559 
 560     String errorMessage;
 561     auto merchantSession = PaymentMerchantSession::fromJS(state, asObject(merchantSessionValue), errorMessage);
 562     if (!merchantSession) {
 563         window.printErrorMessage(errorMessage);
 564         return Exception { InvalidAccessError };
 565     }
 566 
 567     m_merchantValidationState = MerchantValidationState::ValidationComplete;
 568     paymentCoordinator().completeMerchantValidation(*merchantSession);
 569 
</pre>
<hr />
<pre>
 795 
 796     m_state = State::ShippingContactSelected;
 797     auto event = ApplePayShippingContactSelectedEvent::create(eventNames().shippingcontactselectedEvent, version(), shippingContact);
 798     dispatchEvent(event.get());
 799 }
 800 
 801 void ApplePaySession::didSelectPaymentMethod(const PaymentMethod&amp; paymentMethod)
 802 {
 803     ASSERT(m_state == State::Active);
 804 
 805     if (!hasEventListeners(eventNames().paymentmethodselectedEvent)) {
 806         paymentCoordinator().completePaymentMethodSelection({ });
 807         return;
 808     }
 809 
 810     m_state = State::PaymentMethodSelected;
 811     auto event = ApplePayPaymentMethodSelectedEvent::create(eventNames().paymentmethodselectedEvent, paymentMethod);
 812     dispatchEvent(event.get());
 813 }
 814 
<span class="line-modified"> 815 void ApplePaySession::didCancelPaymentSession()</span>
 816 {
 817     ASSERT(canCancel());
 818 
 819     m_state = State::Canceled;
 820 
<span class="line-modified"> 821     auto event = Event::create(eventNames().cancelEvent, Event::CanBubble::No, Event::IsCancelable::No);</span>
 822     dispatchEvent(event.get());
 823 
 824     didReachFinalState();
 825 }
 826 
 827 const char* ApplePaySession::activeDOMObjectName() const
 828 {
 829     return &quot;ApplePaySession&quot;;
 830 }
 831 
<span class="line-modified"> 832 bool ApplePaySession::canSuspendForDocumentSuspension() const</span>
 833 {
 834     switch (m_state) {
 835     case State::Idle:
 836     case State::Aborted:
 837     case State::Completed:
 838     case State::Canceled:
 839         return true;
 840 
 841     case State::Active:
 842     case State::Authorized:
 843     case State::ShippingMethodSelected:
 844     case State::ShippingContactSelected:
 845     case State::PaymentMethodSelected:
 846     case State::CancelRequested:
 847         return false;
 848     }
 849 }
 850 
 851 void ApplePaySession::stop()
 852 {
 853     if (!canAbort())
 854         return;
 855 
 856     m_state = State::Aborted;
 857     paymentCoordinator().abortPaymentSession();
 858 
 859     didReachFinalState();
 860 }
 861 















 862 PaymentCoordinator&amp; ApplePaySession::paymentCoordinator() const
 863 {
 864     return downcast&lt;Document&gt;(*scriptExecutionContext()).page()-&gt;paymentCoordinator();
 865 }
 866 
 867 bool ApplePaySession::canBegin() const
 868 {
 869     switch (m_state) {
 870     case State::Idle:
 871         return true;
 872 
 873     case State::Active:
 874     case State::Aborted:
 875     case State::Authorized:
 876     case State::Completed:
 877     case State::Canceled:
 878     case State::ShippingMethodSelected:
 879     case State::ShippingContactSelected:
 880     case State::PaymentMethodSelected:
 881     case State::CancelRequested:
</pre>
</td>
<td>
<hr />
<pre>
  11  *    documentation and/or other materials provided with the distribution.
  12  *
  13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. AND ITS CONTRIBUTORS ``AS IS&#39;&#39;
  14  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
  15  * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
  16  * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL APPLE INC. OR ITS CONTRIBUTORS
  17  * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
  18  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
  19  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
  20  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
  21  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
  22  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF
  23  * THE POSSIBILITY OF SUCH DAMAGE.
  24  */
  25 
  26 #include &quot;config.h&quot;
  27 #include &quot;ApplePaySession.h&quot;
  28 
  29 #if ENABLE(APPLE_PAY)
  30 
<span class="line-added">  31 #include &quot;ApplePayCancelEvent.h&quot;</span>
  32 #include &quot;ApplePayLineItem.h&quot;
  33 #include &quot;ApplePayPaymentAuthorizationResult.h&quot;
  34 #include &quot;ApplePayPaymentAuthorizedEvent.h&quot;
  35 #include &quot;ApplePayPaymentMethodSelectedEvent.h&quot;
  36 #include &quot;ApplePayPaymentMethodUpdate.h&quot;
  37 #include &quot;ApplePayPaymentRequest.h&quot;
  38 #include &quot;ApplePayShippingContactSelectedEvent.h&quot;
  39 #include &quot;ApplePayShippingContactUpdate.h&quot;
  40 #include &quot;ApplePayShippingMethod.h&quot;
  41 #include &quot;ApplePayShippingMethodSelectedEvent.h&quot;
  42 #include &quot;ApplePayShippingMethodUpdate.h&quot;
  43 #include &quot;ApplePayValidateMerchantEvent.h&quot;
  44 #include &quot;CustomHeaderFields.h&quot;
  45 #include &quot;DOMWindow.h&quot;
  46 #include &quot;Document.h&quot;
  47 #include &quot;DocumentLoader.h&quot;
  48 #include &quot;EventNames.h&quot;
  49 #include &quot;Frame.h&quot;
  50 #include &quot;JSDOMPromiseDeferred.h&quot;
  51 #include &quot;LinkIconCollector.h&quot;
  52 #include &quot;LinkIconType.h&quot;
  53 #include &quot;Page.h&quot;
  54 #include &quot;PageConsoleClient.h&quot;
  55 #include &quot;PaymentAuthorizationStatus.h&quot;
  56 #include &quot;PaymentContact.h&quot;
  57 #include &quot;PaymentCoordinator.h&quot;
  58 #include &quot;PaymentMerchantSession.h&quot;
  59 #include &quot;PaymentMethod.h&quot;
<span class="line-added">  60 #include &quot;PaymentMethodUpdate.h&quot;</span>
  61 #include &quot;PaymentRequestValidator.h&quot;
  62 #include &quot;SecurityOrigin.h&quot;
  63 #include &quot;Settings.h&quot;
  64 #include &quot;UserGestureIndicator.h&quot;
  65 #include &lt;wtf/IsoMallocInlines.h&gt;
  66 
<span class="line-added">  67 #if USE(APPLE_INTERNAL_SDK)</span>
<span class="line-added">  68 #include &lt;WebKitAdditions/ApplePaySessionAdditions.cpp&gt;</span>
<span class="line-added">  69 #else</span>
<span class="line-added">  70 namespace WebCore {</span>
<span class="line-added">  71 static void finishConverting(PaymentMethodUpdate&amp;, ApplePayPaymentMethodUpdate&amp;&amp;) { }</span>
<span class="line-added">  72 }</span>
<span class="line-added">  73 #endif</span>
<span class="line-added">  74 </span>
  75 namespace WebCore {
  76 
  77 WTF_MAKE_ISO_ALLOCATED_IMPL(ApplePaySession);
  78 
  79 // The amount follows the regular expression -?[0-9]+(\.[0-9][0-9])?.
  80 static bool validateAmount(const String&amp; amountString)
  81 {
  82     enum class State {
  83         Start,
  84         Sign,
  85         Digit,
  86         Dot,
  87         DotDigit,
  88         End,
  89     };
  90 
  91     State state = State::Start;
  92 
  93     for (unsigned i = 0; i &lt; amountString.length(); ++i) {
  94         UChar c = amountString[i];
</pre>
<hr />
<pre>
 131         case State::DotDigit:
 132             if (!isASCIIDigit(c))
 133                 return false;
 134 
 135             state = State::End;
 136             break;
 137 
 138         case State::End:
 139             return false;
 140         }
 141     }
 142 
 143     return state == State::Digit || state == State::DotDigit || state == State::End;
 144 }
 145 
 146 static ExceptionOr&lt;ApplePaySessionPaymentRequest::LineItem&gt; convertAndValidateTotal(ApplePayLineItem&amp;&amp; lineItem)
 147 {
 148     if (!validateAmount(lineItem.amount))
 149         return Exception { TypeError, makeString(&quot;\&quot;&quot; + lineItem.amount, &quot;\&quot; is not a valid amount.&quot;) };
 150 
<span class="line-modified"> 151     ApplePaySessionPaymentRequest::LineItem total { lineItem.type, lineItem.amount, lineItem.label };</span>



 152 
<span class="line-modified"> 153     auto validatedTotal = PaymentRequestValidator::validateTotal(total);</span>
<span class="line-added"> 154     if (validatedTotal.hasException())</span>
<span class="line-added"> 155         return validatedTotal.releaseException();</span>
<span class="line-added"> 156 </span>
<span class="line-added"> 157     return WTFMove(total);</span>
 158 }
 159 
 160 static ExceptionOr&lt;ApplePaySessionPaymentRequest::LineItem&gt; convertAndValidate(ApplePayLineItem&amp;&amp; lineItem)
 161 {
 162     ApplePaySessionPaymentRequest::LineItem result;
 163 
 164     // It is OK for pending types to not have an amount.
 165     if (lineItem.type != ApplePaySessionPaymentRequest::LineItem::Type::Pending) {
 166         if (!validateAmount(lineItem.amount))
 167             return Exception { TypeError, makeString(&quot;\&quot;&quot; + lineItem.amount, &quot;\&quot; is not a valid amount.&quot;) };
 168 
 169         result.amount = lineItem.amount;
 170     }
 171 
 172     result.type = lineItem.type;
 173     result.label = lineItem.label;
 174 
 175     return WTFMove(result);
 176 }
 177 
</pre>
<hr />
<pre>
 311 
 312     case ApplePaySession::STATUS_PIN_INCORRECT:
 313         convertedResult.status = PaymentAuthorizationStatus::PINIncorrect;
 314         break;
 315 
 316     case ApplePaySession::STATUS_PIN_LOCKOUT:
 317         convertedResult.status = PaymentAuthorizationStatus::PINLockout;
 318         break;
 319 
 320     default:
 321         return Exception { InvalidAccessError };
 322     }
 323 
 324     convertedResult.errors.appendVector(convert(result.errors));
 325 
 326     return WTFMove(convertedResult);
 327 }
 328 
 329 static ExceptionOr&lt;PaymentMethodUpdate&gt; convertAndValidate(ApplePayPaymentMethodUpdate&amp;&amp; update)
 330 {


 331     auto convertedNewTotal = convertAndValidateTotal(WTFMove(update.newTotal));
 332     if (convertedNewTotal.hasException())
 333         return convertedNewTotal.releaseException();






 334 
 335     auto convertedNewLineItems = convertAndValidate(WTFMove(update.newLineItems));
 336     if (convertedNewLineItems.hasException())
 337         return convertedNewLineItems.releaseException();
 338 
<span class="line-modified"> 339     PaymentMethodUpdate convertedUpdate { convertedNewTotal.releaseReturnValue(), convertedNewLineItems.releaseReturnValue() };</span>
<span class="line-added"> 340     finishConverting(convertedUpdate, WTFMove(update));</span>
 341 
 342     return WTFMove(convertedUpdate);
 343 }
 344 
 345 static ExceptionOr&lt;ShippingContactUpdate&gt; convertAndValidate(ApplePayShippingContactUpdate&amp;&amp; update)
 346 {
 347     ShippingContactUpdate convertedUpdate;
 348 
 349     convertedUpdate.errors = convert(update.errors);
 350 
 351     auto convertedNewShippingMethods = convertAndValidate(WTFMove(update.newShippingMethods));
 352     if (convertedNewShippingMethods.hasException())
 353         return convertedNewShippingMethods.releaseException();
 354     convertedUpdate.newShippingMethods = convertedNewShippingMethods.releaseReturnValue();
 355 
 356     auto convertedNewTotal = convertAndValidateTotal(WTFMove(update.newTotal));
 357     if (convertedNewTotal.hasException())
 358         return convertedNewTotal.releaseException();
 359     convertedUpdate.newTotalAndLineItems.total = convertedNewTotal.releaseReturnValue();
 360 





 361     auto convertedNewLineItems = convertAndValidate(WTFMove(update.newLineItems));
 362     if (convertedNewLineItems.hasException())
 363         return convertedNewLineItems.releaseException();
 364     convertedUpdate.newTotalAndLineItems.lineItems = convertedNewLineItems.releaseReturnValue();
 365 
 366     return WTFMove(convertedUpdate);
 367 }
 368 
 369 static ExceptionOr&lt;ShippingMethodUpdate&gt; convertAndValidate(ApplePayShippingMethodUpdate&amp;&amp; update)
 370 {
 371     ShippingMethodUpdate convertedUpdate;
 372 
 373     auto convertedNewTotal = convertAndValidateTotal(WTFMove(update.newTotal));
 374     if (convertedNewTotal.hasException())
 375         return convertedNewTotal.releaseException();
 376 
 377     convertedUpdate.newTotalAndLineItems.total = convertedNewTotal.releaseReturnValue();
 378 





 379     auto convertedNewLineItems = convertAndValidate(WTFMove(update.newLineItems));
 380     if (convertedNewLineItems.hasException())
 381         return convertedNewLineItems.releaseException();
 382 
 383     convertedUpdate.newTotalAndLineItems.lineItems = convertedNewLineItems.releaseReturnValue();
 384 
 385     return WTFMove(convertedUpdate);
 386 }
 387 
 388 ExceptionOr&lt;Ref&lt;ApplePaySession&gt;&gt; ApplePaySession::create(Document&amp; document, unsigned version, ApplePayPaymentRequest&amp;&amp; paymentRequest)
 389 {
 390     auto canCall = canCreateSession(document);
 391     if (canCall.hasException())
 392         return canCall.releaseException();
 393 
 394     if (!UserGestureIndicator::processingUserGesture())
 395         return Exception { InvalidAccessError, &quot;Must create a new ApplePaySession from a user gesture handler.&quot; };
 396 
 397     if (!document.page())
 398         return Exception { InvalidAccessError, &quot;Frame is detached&quot; };
</pre>
<hr />
<pre>
 523     m_state = State::Active;
 524 
 525     setPendingActivity(*this);
 526 
 527     return { };
 528 }
 529 
 530 ExceptionOr&lt;void&gt; ApplePaySession::abort()
 531 {
 532     if (!canAbort())
 533         return Exception { InvalidAccessError };
 534 
 535     m_state = State::Aborted;
 536     paymentCoordinator().abortPaymentSession();
 537 
 538     didReachFinalState();
 539 
 540     return { };
 541 }
 542 
<span class="line-modified"> 543 ExceptionOr&lt;void&gt; ApplePaySession::completeMerchantValidation(JSC::JSGlobalObject&amp; state, JSC::JSValue merchantSessionValue)</span>
 544 {
 545     if (!canCompleteMerchantValidation())
 546         return Exception { InvalidAccessError };
 547 
 548     if (!merchantSessionValue.isObject())
 549         return Exception { TypeError };
 550 
 551     auto&amp; document = *downcast&lt;Document&gt;(scriptExecutionContext());
 552     auto&amp; window = *document.domWindow();
 553 
 554     String errorMessage;
 555     auto merchantSession = PaymentMerchantSession::fromJS(state, asObject(merchantSessionValue), errorMessage);
 556     if (!merchantSession) {
 557         window.printErrorMessage(errorMessage);
 558         return Exception { InvalidAccessError };
 559     }
 560 
 561     m_merchantValidationState = MerchantValidationState::ValidationComplete;
 562     paymentCoordinator().completeMerchantValidation(*merchantSession);
 563 
</pre>
<hr />
<pre>
 789 
 790     m_state = State::ShippingContactSelected;
 791     auto event = ApplePayShippingContactSelectedEvent::create(eventNames().shippingcontactselectedEvent, version(), shippingContact);
 792     dispatchEvent(event.get());
 793 }
 794 
 795 void ApplePaySession::didSelectPaymentMethod(const PaymentMethod&amp; paymentMethod)
 796 {
 797     ASSERT(m_state == State::Active);
 798 
 799     if (!hasEventListeners(eventNames().paymentmethodselectedEvent)) {
 800         paymentCoordinator().completePaymentMethodSelection({ });
 801         return;
 802     }
 803 
 804     m_state = State::PaymentMethodSelected;
 805     auto event = ApplePayPaymentMethodSelectedEvent::create(eventNames().paymentmethodselectedEvent, paymentMethod);
 806     dispatchEvent(event.get());
 807 }
 808 
<span class="line-modified"> 809 void ApplePaySession::didCancelPaymentSession(PaymentSessionError&amp;&amp; error)</span>
 810 {
 811     ASSERT(canCancel());
 812 
 813     m_state = State::Canceled;
 814 
<span class="line-modified"> 815     auto event = ApplePayCancelEvent::create(eventNames().cancelEvent, WTFMove(error));</span>
 816     dispatchEvent(event.get());
 817 
 818     didReachFinalState();
 819 }
 820 
 821 const char* ApplePaySession::activeDOMObjectName() const
 822 {
 823     return &quot;ApplePaySession&quot;;
 824 }
 825 
<span class="line-modified"> 826 bool ApplePaySession::canSuspendWithoutCanceling() const</span>
 827 {
 828     switch (m_state) {
 829     case State::Idle:
 830     case State::Aborted:
 831     case State::Completed:
 832     case State::Canceled:
 833         return true;
 834 
 835     case State::Active:
 836     case State::Authorized:
 837     case State::ShippingMethodSelected:
 838     case State::ShippingContactSelected:
 839     case State::PaymentMethodSelected:
 840     case State::CancelRequested:
 841         return false;
 842     }
 843 }
 844 
 845 void ApplePaySession::stop()
 846 {
 847     if (!canAbort())
 848         return;
 849 
 850     m_state = State::Aborted;
 851     paymentCoordinator().abortPaymentSession();
 852 
 853     didReachFinalState();
 854 }
 855 
<span class="line-added"> 856 void ApplePaySession::suspend(ReasonForSuspension reason)</span>
<span class="line-added"> 857 {</span>
<span class="line-added"> 858     if (reason != ReasonForSuspension::BackForwardCache)</span>
<span class="line-added"> 859         return;</span>
<span class="line-added"> 860 </span>
<span class="line-added"> 861     if (canSuspendWithoutCanceling())</span>
<span class="line-added"> 862         return;</span>
<span class="line-added"> 863 </span>
<span class="line-added"> 864     m_state = State::Canceled;</span>
<span class="line-added"> 865     paymentCoordinator().abortPaymentSession();</span>
<span class="line-added"> 866     queueTaskToDispatchEvent(*this, TaskSource::UserInteraction, ApplePayCancelEvent::create(eventNames().cancelEvent, { }));</span>
<span class="line-added"> 867 </span>
<span class="line-added"> 868     didReachFinalState();</span>
<span class="line-added"> 869 }</span>
<span class="line-added"> 870 </span>
 871 PaymentCoordinator&amp; ApplePaySession::paymentCoordinator() const
 872 {
 873     return downcast&lt;Document&gt;(*scriptExecutionContext()).page()-&gt;paymentCoordinator();
 874 }
 875 
 876 bool ApplePaySession::canBegin() const
 877 {
 878     switch (m_state) {
 879     case State::Idle:
 880         return true;
 881 
 882     case State::Active:
 883     case State::Aborted:
 884     case State::Authorized:
 885     case State::Completed:
 886     case State::Canceled:
 887     case State::ShippingMethodSelected:
 888     case State::ShippingContactSelected:
 889     case State::PaymentMethodSelected:
 890     case State::CancelRequested:
</pre>
</td>
</tr>
</table>
<center><a href="ApplePayRequestBase.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="ApplePaySession.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>