<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WebCore/Modules/indexeddb/IDBOpenDBRequest.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="IDBObjectStore.idl.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="IDBOpenDBRequest.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/Modules/indexeddb/IDBOpenDBRequest.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -64,35 +64,35 @@</span>
      m_requestType = requestType;
  }
  
  IDBOpenDBRequest::~IDBOpenDBRequest()
  {
<span class="udiff-line-modified-removed">-     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
  }
  
  void IDBOpenDBRequest::onError(const IDBResultData&amp; data)
  {
<span class="udiff-line-modified-removed">-     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
  
      m_domError = data.error().toDOMException();
      enqueueEvent(IDBRequestCompletionEvent::create(eventNames().errorEvent, Event::CanBubble::Yes, Event::IsCancelable::Yes, *this));
  }
  
  void IDBOpenDBRequest::versionChangeTransactionDidFinish()
  {
<span class="udiff-line-modified-removed">-     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
  
      // 3.3.7 &quot;versionchange&quot; transaction steps
      // When the transaction is finished, after firing complete/abort on the transaction, immediately set request&#39;s transaction property to null.
      m_shouldExposeTransactionToDOM = false;
  }
  
  void IDBOpenDBRequest::fireSuccessAfterVersionChangeCommit()
  {
      LOG(IndexedDB, &quot;IDBOpenDBRequest::fireSuccessAfterVersionChangeCommit() - %s&quot;, resourceIdentifier().loggingString().utf8().data());
  
<span class="udiff-line-modified-removed">-     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
      ASSERT(hasPendingActivity());
      m_transaction-&gt;addRequest(*this);
  
      auto event = IDBRequestCompletionEvent::create(eventNames().successEvent, Event::CanBubble::No, Event::IsCancelable::No, *this);
      m_openDatabaseSuccessEvent = &amp;event.get();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -102,11 +102,11 @@</span>
  
  void IDBOpenDBRequest::fireErrorAfterVersionChangeCompletion()
  {
      LOG(IndexedDB, &quot;IDBOpenDBRequest::fireErrorAfterVersionChangeCompletion() - %s&quot;, resourceIdentifier().loggingString().utf8().data());
  
<span class="udiff-line-modified-removed">-     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
      ASSERT(hasPendingActivity());
  
      IDBError idbError(AbortError);
      m_domError = DOMException::create(AbortError);
      setResultToUndefined();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -116,18 +116,15 @@</span>
  }
  
  void IDBOpenDBRequest::cancelForStop()
  {
      connectionProxy().openDBRequestCancelled({ connectionProxy(), *this });
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     if (m_transaction &amp;&amp; m_transaction-&gt;isVersionChange())</span>
<span class="udiff-line-removed">-         m_transaction-&gt;removeRequest(*this);</span>
  }
  
  void IDBOpenDBRequest::dispatchEvent(Event&amp; event)
  {
<span class="udiff-line-modified-removed">-     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
  
      auto protectedThis = makeRef(*this);
  
      IDBRequest::dispatchEvent(event);
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -137,21 +134,21 @@</span>
  
  void IDBOpenDBRequest::onSuccess(const IDBResultData&amp; resultData)
  {
      LOG(IndexedDB, &quot;IDBOpenDBRequest::onSuccess()&quot;);
  
<span class="udiff-line-modified-removed">-     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
  
      setResult(IDBDatabase::create(*scriptExecutionContext(), connectionProxy(), resultData));
      m_readyState = ReadyState::Done;
  
      enqueueEvent(IDBRequestCompletionEvent::create(eventNames().successEvent, Event::CanBubble::No, Event::IsCancelable::No, *this));
  }
  
  void IDBOpenDBRequest::onUpgradeNeeded(const IDBResultData&amp; resultData)
  {
<span class="udiff-line-modified-removed">-     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
  
      Ref&lt;IDBDatabase&gt; database = IDBDatabase::create(*scriptExecutionContext(), connectionProxy(), resultData);
      Ref&lt;IDBTransaction&gt; transaction = database-&gt;startVersionChangeTransaction(resultData.transactionInfo(), *this);
  
      ASSERT(transaction-&gt;info().mode() == IDBTransactionMode::Versionchange);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -170,11 +167,11 @@</span>
      enqueueEvent(IDBVersionChangeEvent::create(oldVersion, newVersion, eventNames().upgradeneededEvent));
  }
  
  void IDBOpenDBRequest::onDeleteDatabaseSuccess(const IDBResultData&amp; resultData)
  {
<span class="udiff-line-modified-removed">-     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
  
      uint64_t oldVersion = resultData.databaseInfo().version();
  
      LOG(IndexedDB, &quot;IDBOpenDBRequest::onDeleteDatabaseSuccess() - current version is %&quot; PRIu64, oldVersion);
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -186,11 +183,13 @@</span>
  
  void IDBOpenDBRequest::requestCompleted(const IDBResultData&amp; data)
  {
      LOG(IndexedDB, &quot;IDBOpenDBRequest::requestCompleted&quot;);
  
<span class="udiff-line-modified-removed">-     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     m_isBlocked = false;</span>
  
      // If an Open request was completed after the page has navigated, leaving this request
      // with a stopped script execution context, we need to message back to the server so it
      // doesn&#39;t hang waiting on a database connection or transaction that will never exist.
      if (m_contextStopped) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -226,14 +225,31 @@</span>
      }
  }
  
  void IDBOpenDBRequest::requestBlocked(uint64_t oldVersion, uint64_t newVersion)
  {
<span class="udiff-line-modified-removed">-     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
<span class="udiff-line-added">+     ASSERT(!m_isBlocked);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     m_isBlocked = true;</span>
  
      LOG(IndexedDB, &quot;IDBOpenDBRequest::requestBlocked&quot;);
      enqueueEvent(IDBVersionChangeEvent::create(oldVersion, newVersion, eventNames().blockedEvent));
  }
  
<span class="udiff-line-added">+ void IDBOpenDBRequest::setIsContextSuspended(bool isContextSuspended)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     m_isContextSuspended = isContextSuspended;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     // If this request is blocked, it means this request is being processed on the server.</span>
<span class="udiff-line-added">+     // The client needs to actively stop the request so it doesn&#39;t blocks the processing of subsequent requests.</span>
<span class="udiff-line-added">+     if (m_isBlocked) {</span>
<span class="udiff-line-added">+         IDBRequestData requestData(connectionProxy(), *this);</span>
<span class="udiff-line-added">+         connectionProxy().openDBRequestCancelled(requestData);</span>
<span class="udiff-line-added">+         auto result = IDBResultData::error(requestData.requestIdentifier(), IDBError { UnknownError, &quot;Blocked open request on cached page is aborted to unblock other requests&quot;_s });</span>
<span class="udiff-line-added">+         requestCompleted(result);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  } // namespace WebCore
  
  #endif // ENABLE(INDEXED_DATABASE)
</pre>
<center><a href="IDBObjectStore.idl.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="IDBOpenDBRequest.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>