<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/WebCore/Modules/applepay/ApplePaySession.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (C) 2015-2019 Apple Inc. All rights reserved.
   3  *
   4  * Redistribution and use in source and binary forms, with or without
   5  * modification, are permitted provided that the following conditions
   6  * are met:
   7  * 1. Redistributions of source code must retain the above copyright
   8  *    notice, this list of conditions and the following disclaimer.
   9  * 2. Redistributions in binary form must reproduce the above copyright
  10  *    notice, this list of conditions and the following disclaimer in the
  11  *    documentation and/or other materials provided with the distribution.
  12  *
  13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. AND ITS CONTRIBUTORS ``AS IS&#39;&#39;
  14  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
  15  * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
  16  * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL APPLE INC. OR ITS CONTRIBUTORS
  17  * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
  18  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
  19  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
  20  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
  21  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
  22  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF
  23  * THE POSSIBILITY OF SUCH DAMAGE.
  24  */
  25 
  26 #include &quot;config.h&quot;
  27 #include &quot;ApplePaySession.h&quot;
  28 
  29 #if ENABLE(APPLE_PAY)
  30 
<a name="1" id="anc1"></a><span class="line-added">  31 #include &quot;ApplePayCancelEvent.h&quot;</span>
  32 #include &quot;ApplePayLineItem.h&quot;
  33 #include &quot;ApplePayPaymentAuthorizationResult.h&quot;
  34 #include &quot;ApplePayPaymentAuthorizedEvent.h&quot;
  35 #include &quot;ApplePayPaymentMethodSelectedEvent.h&quot;
  36 #include &quot;ApplePayPaymentMethodUpdate.h&quot;
  37 #include &quot;ApplePayPaymentRequest.h&quot;
  38 #include &quot;ApplePayShippingContactSelectedEvent.h&quot;
  39 #include &quot;ApplePayShippingContactUpdate.h&quot;
  40 #include &quot;ApplePayShippingMethod.h&quot;
  41 #include &quot;ApplePayShippingMethodSelectedEvent.h&quot;
  42 #include &quot;ApplePayShippingMethodUpdate.h&quot;
  43 #include &quot;ApplePayValidateMerchantEvent.h&quot;
  44 #include &quot;CustomHeaderFields.h&quot;
  45 #include &quot;DOMWindow.h&quot;
  46 #include &quot;Document.h&quot;
  47 #include &quot;DocumentLoader.h&quot;
  48 #include &quot;EventNames.h&quot;
  49 #include &quot;Frame.h&quot;
  50 #include &quot;JSDOMPromiseDeferred.h&quot;
  51 #include &quot;LinkIconCollector.h&quot;
  52 #include &quot;LinkIconType.h&quot;
  53 #include &quot;Page.h&quot;
  54 #include &quot;PageConsoleClient.h&quot;
  55 #include &quot;PaymentAuthorizationStatus.h&quot;
  56 #include &quot;PaymentContact.h&quot;
  57 #include &quot;PaymentCoordinator.h&quot;
  58 #include &quot;PaymentMerchantSession.h&quot;
  59 #include &quot;PaymentMethod.h&quot;
<a name="2" id="anc2"></a><span class="line-added">  60 #include &quot;PaymentMethodUpdate.h&quot;</span>
  61 #include &quot;PaymentRequestValidator.h&quot;
  62 #include &quot;SecurityOrigin.h&quot;
  63 #include &quot;Settings.h&quot;
  64 #include &quot;UserGestureIndicator.h&quot;
  65 #include &lt;wtf/IsoMallocInlines.h&gt;
  66 
<a name="3" id="anc3"></a><span class="line-added">  67 #if USE(APPLE_INTERNAL_SDK)</span>
<span class="line-added">  68 #include &lt;WebKitAdditions/ApplePaySessionAdditions.cpp&gt;</span>
<span class="line-added">  69 #else</span>
<span class="line-added">  70 namespace WebCore {</span>
<span class="line-added">  71 static void finishConverting(PaymentMethodUpdate&amp;, ApplePayPaymentMethodUpdate&amp;&amp;) { }</span>
<span class="line-added">  72 }</span>
<span class="line-added">  73 #endif</span>
<span class="line-added">  74 </span>
  75 namespace WebCore {
  76 
  77 WTF_MAKE_ISO_ALLOCATED_IMPL(ApplePaySession);
  78 
  79 // The amount follows the regular expression -?[0-9]+(\.[0-9][0-9])?.
  80 static bool validateAmount(const String&amp; amountString)
  81 {
  82     enum class State {
  83         Start,
  84         Sign,
  85         Digit,
  86         Dot,
  87         DotDigit,
  88         End,
  89     };
  90 
  91     State state = State::Start;
  92 
  93     for (unsigned i = 0; i &lt; amountString.length(); ++i) {
  94         UChar c = amountString[i];
  95 
  96         switch (state) {
  97         case State::Start:
  98             if (c == &#39;-&#39;) {
  99                 state = State::Sign;
 100                 break;
 101             }
 102 
 103             if (!isASCIIDigit(c))
 104                 return false;
 105             state = State::Digit;
 106             break;
 107 
 108         case State::Sign:
 109             if (!isASCIIDigit(c))
 110                 return false;
 111             state = State::Digit;
 112             break;
 113 
 114         case State::Digit:
 115             if (c == &#39;.&#39;) {
 116                 state = State::Dot;
 117                 break;
 118             }
 119 
 120             if (!isASCIIDigit(c))
 121                 return false;
 122             break;
 123 
 124         case State::Dot:
 125             if (!isASCIIDigit(c))
 126                 return false;
 127 
 128             state = State::DotDigit;
 129             break;
 130 
 131         case State::DotDigit:
 132             if (!isASCIIDigit(c))
 133                 return false;
 134 
 135             state = State::End;
 136             break;
 137 
 138         case State::End:
 139             return false;
 140         }
 141     }
 142 
 143     return state == State::Digit || state == State::DotDigit || state == State::End;
 144 }
 145 
 146 static ExceptionOr&lt;ApplePaySessionPaymentRequest::LineItem&gt; convertAndValidateTotal(ApplePayLineItem&amp;&amp; lineItem)
 147 {
 148     if (!validateAmount(lineItem.amount))
 149         return Exception { TypeError, makeString(&quot;\&quot;&quot; + lineItem.amount, &quot;\&quot; is not a valid amount.&quot;) };
 150 
<a name="4" id="anc4"></a><span class="line-modified"> 151     ApplePaySessionPaymentRequest::LineItem total { lineItem.type, lineItem.amount, lineItem.label };</span>



 152 
<a name="5" id="anc5"></a><span class="line-modified"> 153     auto validatedTotal = PaymentRequestValidator::validateTotal(total);</span>
<span class="line-added"> 154     if (validatedTotal.hasException())</span>
<span class="line-added"> 155         return validatedTotal.releaseException();</span>
<span class="line-added"> 156 </span>
<span class="line-added"> 157     return WTFMove(total);</span>
 158 }
 159 
 160 static ExceptionOr&lt;ApplePaySessionPaymentRequest::LineItem&gt; convertAndValidate(ApplePayLineItem&amp;&amp; lineItem)
 161 {
 162     ApplePaySessionPaymentRequest::LineItem result;
 163 
 164     // It is OK for pending types to not have an amount.
 165     if (lineItem.type != ApplePaySessionPaymentRequest::LineItem::Type::Pending) {
 166         if (!validateAmount(lineItem.amount))
 167             return Exception { TypeError, makeString(&quot;\&quot;&quot; + lineItem.amount, &quot;\&quot; is not a valid amount.&quot;) };
 168 
 169         result.amount = lineItem.amount;
 170     }
 171 
 172     result.type = lineItem.type;
 173     result.label = lineItem.label;
 174 
 175     return WTFMove(result);
 176 }
 177 
 178 static ExceptionOr&lt;Vector&lt;ApplePaySessionPaymentRequest::LineItem&gt;&gt; convertAndValidate(Optional&lt;Vector&lt;ApplePayLineItem&gt;&gt;&amp;&amp; lineItems)
 179 {
 180     Vector&lt;ApplePaySessionPaymentRequest::LineItem&gt; result;
 181     if (!lineItems)
 182         return WTFMove(result);
 183 
 184     result.reserveInitialCapacity(lineItems-&gt;size());
 185 
 186     for (auto lineItem : lineItems.value()) {
 187         auto convertedLineItem = convertAndValidate(WTFMove(lineItem));
 188         if (convertedLineItem.hasException())
 189             return convertedLineItem.releaseException();
 190         result.uncheckedAppend(convertedLineItem.releaseReturnValue());
 191     }
 192 
 193     return WTFMove(result);
 194 }
 195 
 196 static ExceptionOr&lt;ApplePaySessionPaymentRequest::ShippingMethod&gt; convertAndValidate(ApplePayShippingMethod&amp;&amp; shippingMethod)
 197 {
 198     if (!validateAmount(shippingMethod.amount))
 199         return Exception { TypeError, makeString(&quot;\&quot;&quot; + shippingMethod.amount, &quot;\&quot; is not a valid amount.&quot;) };
 200 
 201     ApplePaySessionPaymentRequest::ShippingMethod result;
 202     result.amount = shippingMethod.amount;
 203     result.label = shippingMethod.label;
 204     result.detail = shippingMethod.detail;
 205     result.identifier = shippingMethod.identifier;
 206 
 207     return WTFMove(result);
 208 }
 209 
 210 static ExceptionOr&lt;Vector&lt;ApplePaySessionPaymentRequest::ShippingMethod&gt;&gt; convertAndValidate(Vector&lt;ApplePayShippingMethod&gt;&amp;&amp; shippingMethods)
 211 {
 212     Vector&lt;ApplePaySessionPaymentRequest::ShippingMethod&gt; result;
 213     result.reserveInitialCapacity(shippingMethods.size());
 214 
 215     for (auto&amp; shippingMethod : shippingMethods) {
 216         auto convertedShippingMethod = convertAndValidate(WTFMove(shippingMethod));
 217         if (convertedShippingMethod.hasException())
 218             return convertedShippingMethod.releaseException();
 219         result.uncheckedAppend(convertedShippingMethod.releaseReturnValue());
 220     }
 221 
 222     return WTFMove(result);
 223 }
 224 
 225 static ExceptionOr&lt;ApplePaySessionPaymentRequest&gt; convertAndValidate(Document&amp; document, unsigned version, ApplePayPaymentRequest&amp;&amp; paymentRequest, const PaymentCoordinator&amp; paymentCoordinator)
 226 {
 227     auto convertedRequest = convertAndValidate(document, version, paymentRequest, paymentCoordinator);
 228     if (convertedRequest.hasException())
 229         return convertedRequest.releaseException();
 230 
 231     auto result = convertedRequest.releaseReturnValue();
 232     result.setRequester(ApplePaySessionPaymentRequest::Requester::ApplePayJS);
 233     result.setCurrencyCode(paymentRequest.currencyCode);
 234 
 235     auto total = convertAndValidateTotal(WTFMove(paymentRequest.total));
 236     if (total.hasException())
 237         return total.releaseException();
 238     result.setTotal(total.releaseReturnValue());
 239 
 240     auto lineItems = convertAndValidate(WTFMove(paymentRequest.lineItems));
 241     if (lineItems.hasException())
 242         return lineItems.releaseException();
 243     result.setLineItems(lineItems.releaseReturnValue());
 244 
 245     result.setShippingType(paymentRequest.shippingType);
 246 
 247     if (paymentRequest.shippingMethods) {
 248         auto shippingMethods = convertAndValidate(WTFMove(*paymentRequest.shippingMethods));
 249         if (shippingMethods.hasException())
 250             return shippingMethods.releaseException();
 251         result.setShippingMethods(shippingMethods.releaseReturnValue());
 252     }
 253 
 254     // FIXME: Merge this validation into the validation we are doing above.
 255     auto validatedPaymentRequest = PaymentRequestValidator::validate(result);
 256     if (validatedPaymentRequest.hasException())
 257         return validatedPaymentRequest.releaseException();
 258 
 259     return WTFMove(result);
 260 }
 261 
 262 
 263 static Vector&lt;PaymentError&gt; convert(const Vector&lt;RefPtr&lt;ApplePayError&gt;&gt;&amp; errors)
 264 {
 265     Vector&lt;PaymentError&gt; convertedErrors;
 266 
 267     for (auto&amp; error : errors) {
 268         PaymentError convertedError;
 269 
 270         convertedError.code = error-&gt;code();
 271         convertedError.message = error-&gt;message();
 272         convertedError.contactField = error-&gt;contactField();
 273 
 274         convertedErrors.append(convertedError);
 275     }
 276 
 277     return convertedErrors;
 278 }
 279 
 280 static ExceptionOr&lt;PaymentAuthorizationResult&gt; convertAndValidate(ApplePayPaymentAuthorizationResult&amp;&amp; result)
 281 {
 282     PaymentAuthorizationResult convertedResult;
 283 
 284     switch (result.status) {
 285     case ApplePaySession::STATUS_SUCCESS:
 286         convertedResult.status = PaymentAuthorizationStatus::Success;
 287         break;
 288 
 289     case ApplePaySession::STATUS_FAILURE:
 290         convertedResult.status = PaymentAuthorizationStatus::Failure;
 291         break;
 292 
 293     case ApplePaySession::STATUS_INVALID_BILLING_POSTAL_ADDRESS:
 294         convertedResult.status = PaymentAuthorizationStatus::Failure;
 295         convertedResult.errors.append({ PaymentError::Code::BillingContactInvalid, { }, WTF::nullopt });
 296         break;
 297 
 298     case ApplePaySession::STATUS_INVALID_SHIPPING_POSTAL_ADDRESS:
 299         convertedResult.status = PaymentAuthorizationStatus::Failure;
 300         convertedResult.errors.append({ PaymentError::Code::ShippingContactInvalid, { }, PaymentError::ContactField::PostalAddress });
 301         break;
 302 
 303     case ApplePaySession::STATUS_INVALID_SHIPPING_CONTACT:
 304         convertedResult.status = PaymentAuthorizationStatus::Failure;
 305         convertedResult.errors.append({ PaymentError::Code::ShippingContactInvalid, { }, WTF::nullopt });
 306         break;
 307 
 308     case ApplePaySession::STATUS_PIN_REQUIRED:
 309         convertedResult.status = PaymentAuthorizationStatus::PINRequired;
 310         break;
 311 
 312     case ApplePaySession::STATUS_PIN_INCORRECT:
 313         convertedResult.status = PaymentAuthorizationStatus::PINIncorrect;
 314         break;
 315 
 316     case ApplePaySession::STATUS_PIN_LOCKOUT:
 317         convertedResult.status = PaymentAuthorizationStatus::PINLockout;
 318         break;
 319 
 320     default:
 321         return Exception { InvalidAccessError };
 322     }
 323 
 324     convertedResult.errors.appendVector(convert(result.errors));
 325 
 326     return WTFMove(convertedResult);
 327 }
 328 
 329 static ExceptionOr&lt;PaymentMethodUpdate&gt; convertAndValidate(ApplePayPaymentMethodUpdate&amp;&amp; update)
 330 {
<a name="6" id="anc6"></a>

 331     auto convertedNewTotal = convertAndValidateTotal(WTFMove(update.newTotal));
 332     if (convertedNewTotal.hasException())
 333         return convertedNewTotal.releaseException();
<a name="7" id="anc7"></a>





 334 
 335     auto convertedNewLineItems = convertAndValidate(WTFMove(update.newLineItems));
 336     if (convertedNewLineItems.hasException())
 337         return convertedNewLineItems.releaseException();
 338 
<a name="8" id="anc8"></a><span class="line-modified"> 339     PaymentMethodUpdate convertedUpdate { convertedNewTotal.releaseReturnValue(), convertedNewLineItems.releaseReturnValue() };</span>
<span class="line-added"> 340     finishConverting(convertedUpdate, WTFMove(update));</span>
 341 
 342     return WTFMove(convertedUpdate);
 343 }
 344 
 345 static ExceptionOr&lt;ShippingContactUpdate&gt; convertAndValidate(ApplePayShippingContactUpdate&amp;&amp; update)
 346 {
 347     ShippingContactUpdate convertedUpdate;
 348 
 349     convertedUpdate.errors = convert(update.errors);
 350 
 351     auto convertedNewShippingMethods = convertAndValidate(WTFMove(update.newShippingMethods));
 352     if (convertedNewShippingMethods.hasException())
 353         return convertedNewShippingMethods.releaseException();
 354     convertedUpdate.newShippingMethods = convertedNewShippingMethods.releaseReturnValue();
 355 
 356     auto convertedNewTotal = convertAndValidateTotal(WTFMove(update.newTotal));
 357     if (convertedNewTotal.hasException())
 358         return convertedNewTotal.releaseException();
 359     convertedUpdate.newTotalAndLineItems.total = convertedNewTotal.releaseReturnValue();
 360 
<a name="9" id="anc9"></a>




 361     auto convertedNewLineItems = convertAndValidate(WTFMove(update.newLineItems));
 362     if (convertedNewLineItems.hasException())
 363         return convertedNewLineItems.releaseException();
 364     convertedUpdate.newTotalAndLineItems.lineItems = convertedNewLineItems.releaseReturnValue();
 365 
 366     return WTFMove(convertedUpdate);
 367 }
 368 
 369 static ExceptionOr&lt;ShippingMethodUpdate&gt; convertAndValidate(ApplePayShippingMethodUpdate&amp;&amp; update)
 370 {
 371     ShippingMethodUpdate convertedUpdate;
 372 
 373     auto convertedNewTotal = convertAndValidateTotal(WTFMove(update.newTotal));
 374     if (convertedNewTotal.hasException())
 375         return convertedNewTotal.releaseException();
 376 
 377     convertedUpdate.newTotalAndLineItems.total = convertedNewTotal.releaseReturnValue();
 378 
<a name="10" id="anc10"></a>




 379     auto convertedNewLineItems = convertAndValidate(WTFMove(update.newLineItems));
 380     if (convertedNewLineItems.hasException())
 381         return convertedNewLineItems.releaseException();
 382 
 383     convertedUpdate.newTotalAndLineItems.lineItems = convertedNewLineItems.releaseReturnValue();
 384 
 385     return WTFMove(convertedUpdate);
 386 }
 387 
 388 ExceptionOr&lt;Ref&lt;ApplePaySession&gt;&gt; ApplePaySession::create(Document&amp; document, unsigned version, ApplePayPaymentRequest&amp;&amp; paymentRequest)
 389 {
 390     auto canCall = canCreateSession(document);
 391     if (canCall.hasException())
 392         return canCall.releaseException();
 393 
 394     if (!UserGestureIndicator::processingUserGesture())
 395         return Exception { InvalidAccessError, &quot;Must create a new ApplePaySession from a user gesture handler.&quot; };
 396 
 397     if (!document.page())
 398         return Exception { InvalidAccessError, &quot;Frame is detached&quot; };
 399 
 400     auto convertedPaymentRequest = convertAndValidate(document, version, WTFMove(paymentRequest), document.page()-&gt;paymentCoordinator());
 401     if (convertedPaymentRequest.hasException())
 402         return convertedPaymentRequest.releaseException();
 403 
 404     return adoptRef(*new ApplePaySession(document, version, convertedPaymentRequest.releaseReturnValue()));
 405 }
 406 
 407 ApplePaySession::ApplePaySession(Document&amp; document, unsigned version, ApplePaySessionPaymentRequest&amp;&amp; paymentRequest)
 408     : ActiveDOMObject { document }
 409     , m_paymentRequest { WTFMove(paymentRequest) }
 410     , m_version { version }
 411 {
 412     ASSERT(document.page()-&gt;paymentCoordinator().supportsVersion(document, version));
 413     suspendIfNeeded();
 414 }
 415 
 416 ApplePaySession::~ApplePaySession() = default;
 417 
 418 ExceptionOr&lt;bool&gt; ApplePaySession::supportsVersion(Document&amp; document, unsigned version)
 419 {
 420     if (!version)
 421         return Exception { InvalidAccessError };
 422 
 423     auto canCall = canCreateSession(document);
 424     if (canCall.hasException())
 425         return canCall.releaseException();
 426 
 427     auto* page = document.page();
 428     if (!page)
 429         return Exception { InvalidAccessError };
 430 
 431     return page-&gt;paymentCoordinator().supportsVersion(document, version);
 432 }
 433 
 434 static bool shouldDiscloseApplePayCapability(Document&amp; document)
 435 {
 436     auto* page = document.page();
 437     if (!page || page-&gt;usesEphemeralSession())
 438         return false;
 439 
 440     return document.settings().applePayCapabilityDisclosureAllowed();
 441 }
 442 
 443 ExceptionOr&lt;bool&gt; ApplePaySession::canMakePayments(Document&amp; document)
 444 {
 445     auto canCall = canCreateSession(document);
 446     if (canCall.hasException())
 447         return canCall.releaseException();
 448 
 449     auto* page = document.page();
 450     if (!page)
 451         return Exception { InvalidAccessError };
 452 
 453     return page-&gt;paymentCoordinator().canMakePayments(document);
 454 }
 455 
 456 ExceptionOr&lt;void&gt; ApplePaySession::canMakePaymentsWithActiveCard(Document&amp; document, const String&amp; merchantIdentifier, Ref&lt;DeferredPromise&gt;&amp;&amp; passedPromise)
 457 {
 458     auto canCall = canCreateSession(document);
 459     if (canCall.hasException())
 460         return canCall.releaseException();
 461 
 462     RefPtr&lt;DeferredPromise&gt; promise(WTFMove(passedPromise));
 463     if (!shouldDiscloseApplePayCapability(document)) {
 464         auto* page = document.page();
 465         if (!page)
 466             return Exception { InvalidAccessError };
 467 
 468         auto&amp; paymentCoordinator = page-&gt;paymentCoordinator();
 469         bool canMakePayments = paymentCoordinator.canMakePayments(document);
 470 
 471         RunLoop::main().dispatch([promise, canMakePayments]() mutable {
 472             promise-&gt;resolve&lt;IDLBoolean&gt;(canMakePayments);
 473         });
 474         return { };
 475     }
 476 
 477     auto* page = document.page();
 478     if (!page)
 479         return Exception { InvalidAccessError };
 480 
 481     auto&amp; paymentCoordinator = page-&gt;paymentCoordinator();
 482 
 483     paymentCoordinator.canMakePaymentsWithActiveCard(document, merchantIdentifier, [promise](bool canMakePayments) mutable {
 484         promise-&gt;resolve&lt;IDLBoolean&gt;(canMakePayments);
 485     });
 486     return { };
 487 }
 488 
 489 ExceptionOr&lt;void&gt; ApplePaySession::openPaymentSetup(Document&amp; document, const String&amp; merchantIdentifier, Ref&lt;DeferredPromise&gt;&amp;&amp; passedPromise)
 490 {
 491     auto canCall = canCreateSession(document);
 492     if (canCall.hasException())
 493         return canCall.releaseException();
 494 
 495     if (!UserGestureIndicator::processingUserGesture())
 496         return Exception { InvalidAccessError, &quot;Must call ApplePaySession.openPaymentSetup from a user gesture handler.&quot; };
 497 
 498     auto* page = document.page();
 499     if (!page)
 500         return Exception { InvalidAccessError };
 501 
 502     auto&amp; paymentCoordinator = page-&gt;paymentCoordinator();
 503 
 504     RefPtr&lt;DeferredPromise&gt; promise(WTFMove(passedPromise));
 505     paymentCoordinator.openPaymentSetup(document, merchantIdentifier, [promise](bool result) mutable {
 506         promise-&gt;resolve&lt;IDLBoolean&gt;(result);
 507     });
 508 
 509     return { };
 510 }
 511 
 512 ExceptionOr&lt;void&gt; ApplePaySession::begin(Document&amp; document)
 513 {
 514     if (!canBegin())
 515         return Exception { InvalidAccessError, &quot;Payment session is already active.&quot; };
 516 
 517     if (paymentCoordinator().hasActiveSession())
 518         return Exception { InvalidAccessError, &quot;Page already has an active payment session.&quot; };
 519 
 520     if (!paymentCoordinator().beginPaymentSession(document, *this, m_paymentRequest))
 521         return Exception { InvalidAccessError, &quot;There is already has an active payment session.&quot; };
 522 
 523     m_state = State::Active;
 524 
 525     setPendingActivity(*this);
 526 
 527     return { };
 528 }
 529 
 530 ExceptionOr&lt;void&gt; ApplePaySession::abort()
 531 {
 532     if (!canAbort())
 533         return Exception { InvalidAccessError };
 534 
 535     m_state = State::Aborted;
 536     paymentCoordinator().abortPaymentSession();
 537 
 538     didReachFinalState();
 539 
 540     return { };
 541 }
 542 
<a name="11" id="anc11"></a><span class="line-modified"> 543 ExceptionOr&lt;void&gt; ApplePaySession::completeMerchantValidation(JSC::JSGlobalObject&amp; state, JSC::JSValue merchantSessionValue)</span>
 544 {
 545     if (!canCompleteMerchantValidation())
 546         return Exception { InvalidAccessError };
 547 
 548     if (!merchantSessionValue.isObject())
 549         return Exception { TypeError };
 550 
 551     auto&amp; document = *downcast&lt;Document&gt;(scriptExecutionContext());
 552     auto&amp; window = *document.domWindow();
 553 
 554     String errorMessage;
 555     auto merchantSession = PaymentMerchantSession::fromJS(state, asObject(merchantSessionValue), errorMessage);
 556     if (!merchantSession) {
 557         window.printErrorMessage(errorMessage);
 558         return Exception { InvalidAccessError };
 559     }
 560 
 561     m_merchantValidationState = MerchantValidationState::ValidationComplete;
 562     paymentCoordinator().completeMerchantValidation(*merchantSession);
 563 
 564     return { };
 565 }
 566 
 567 ExceptionOr&lt;void&gt; ApplePaySession::completeShippingMethodSelection(ApplePayShippingMethodUpdate&amp;&amp; update)
 568 {
 569     if (!canCompleteShippingMethodSelection())
 570         return Exception { InvalidAccessError };
 571 
 572     auto convertedUpdate = convertAndValidate(WTFMove(update));
 573     if (convertedUpdate.hasException())
 574         return convertedUpdate.releaseException();
 575 
 576     m_state = State::Active;
 577     paymentCoordinator().completeShippingMethodSelection(convertedUpdate.releaseReturnValue());
 578 
 579     return { };
 580 }
 581 
 582 ExceptionOr&lt;void&gt; ApplePaySession::completeShippingContactSelection(ApplePayShippingContactUpdate&amp;&amp; update)
 583 {
 584     if (!canCompleteShippingContactSelection())
 585         return Exception { InvalidAccessError };
 586 
 587     auto convertedUpdate = convertAndValidate(WTFMove(update));
 588     if (convertedUpdate.hasException())
 589         return convertedUpdate.releaseException();
 590 
 591     m_state = State::Active;
 592     paymentCoordinator().completeShippingContactSelection(convertedUpdate.releaseReturnValue());
 593 
 594     return { };
 595 }
 596 
 597 ExceptionOr&lt;void&gt; ApplePaySession::completePaymentMethodSelection(ApplePayPaymentMethodUpdate&amp;&amp; update)
 598 {
 599     if (!canCompletePaymentMethodSelection())
 600         return Exception { InvalidAccessError };
 601 
 602     auto convertedUpdate = convertAndValidate(WTFMove(update));
 603     if (convertedUpdate.hasException())
 604         return convertedUpdate.releaseException();
 605 
 606     m_state = State::Active;
 607     paymentCoordinator().completePaymentMethodSelection(convertedUpdate.releaseReturnValue());
 608 
 609     return { };
 610 }
 611 
 612 ExceptionOr&lt;void&gt; ApplePaySession::completePayment(ApplePayPaymentAuthorizationResult&amp;&amp; result)
 613 {
 614     if (!canCompletePayment())
 615         return Exception { InvalidAccessError };
 616 
 617     auto convertedResultOrException = convertAndValidate(WTFMove(result));
 618     if (convertedResultOrException.hasException())
 619         return convertedResultOrException.releaseException();
 620 
 621     auto&amp;&amp; convertedResult = convertedResultOrException.releaseReturnValue();
 622     bool isFinalState = isFinalStateResult(convertedResult);
 623 
 624     paymentCoordinator().completePaymentSession(WTFMove(convertedResult));
 625 
 626     if (!isFinalState) {
 627         m_state = State::Active;
 628         return { };
 629     }
 630 
 631     m_state = State::Completed;
 632     unsetPendingActivity(*this);
 633 
 634     return { };
 635 }
 636 
 637 ExceptionOr&lt;void&gt; ApplePaySession::completeShippingMethodSelection(unsigned short status, ApplePayLineItem&amp;&amp; newTotal, Vector&lt;ApplePayLineItem&gt;&amp;&amp; newLineItems)
 638 {
 639     ApplePayShippingMethodUpdate update;
 640 
 641     switch (status) {
 642     case ApplePaySession::STATUS_SUCCESS:
 643         break;
 644 
 645     case ApplePaySession::STATUS_FAILURE:
 646     case ApplePaySession::STATUS_INVALID_BILLING_POSTAL_ADDRESS:
 647     case ApplePaySession::STATUS_INVALID_SHIPPING_POSTAL_ADDRESS:
 648     case ApplePaySession::STATUS_INVALID_SHIPPING_CONTACT:
 649     case ApplePaySession::STATUS_PIN_REQUIRED:
 650     case ApplePaySession::STATUS_PIN_INCORRECT:
 651     case ApplePaySession::STATUS_PIN_LOCKOUT:
 652         // This is a fatal error. Cancel the request.
 653         m_state = State::CancelRequested;
 654         paymentCoordinator().cancelPaymentSession();
 655         return { };
 656 
 657     default:
 658         return Exception { InvalidAccessError };
 659     }
 660 
 661     update.newTotal = WTFMove(newTotal);
 662     update.newLineItems = WTFMove(newLineItems);
 663 
 664     return completeShippingMethodSelection(WTFMove(update));
 665 }
 666 
 667 ExceptionOr&lt;void&gt; ApplePaySession::completeShippingContactSelection(unsigned short status, Vector&lt;ApplePayShippingMethod&gt;&amp;&amp; newShippingMethods, ApplePayLineItem&amp;&amp; newTotal, Vector&lt;ApplePayLineItem&gt;&amp;&amp; newLineItems)
 668 {
 669     ApplePayShippingContactUpdate update;
 670 
 671     Optional&lt;ApplePayError::Code&gt; errorCode;
 672     Optional&lt;ApplePayError::ContactField&gt; contactField;
 673 
 674     switch (status) {
 675     case ApplePaySession::STATUS_SUCCESS:
 676         break;
 677 
 678     case ApplePaySession::STATUS_FAILURE:
 679     case ApplePaySession::STATUS_PIN_REQUIRED:
 680     case ApplePaySession::STATUS_PIN_INCORRECT:
 681     case ApplePaySession::STATUS_PIN_LOCKOUT:
 682         errorCode = ApplePayError::Code::Unknown;
 683         break;
 684 
 685     case ApplePaySession::STATUS_INVALID_BILLING_POSTAL_ADDRESS:
 686         errorCode = ApplePayError::Code::BillingContactInvalid;
 687         break;
 688 
 689     case ApplePaySession::STATUS_INVALID_SHIPPING_POSTAL_ADDRESS:
 690         errorCode = ApplePayError::Code::ShippingContactInvalid;
 691         contactField = ApplePayError::ContactField::PostalAddress;
 692         break;
 693 
 694     case ApplePaySession::STATUS_INVALID_SHIPPING_CONTACT:
 695         errorCode = ApplePayError::Code::ShippingContactInvalid;
 696         break;
 697 
 698     default:
 699         return Exception { InvalidAccessError };
 700     }
 701 
 702     if (errorCode)
 703         update.errors = { ApplePayError::create(*errorCode, contactField, { }) };
 704 
 705     update.newShippingMethods = WTFMove(newShippingMethods);
 706     update.newTotal = WTFMove(newTotal);
 707     update.newLineItems = WTFMove(newLineItems);
 708 
 709     return completeShippingContactSelection(WTFMove(update));
 710 }
 711 
 712 ExceptionOr&lt;void&gt; ApplePaySession::completePaymentMethodSelection(ApplePayLineItem&amp;&amp; newTotal, Vector&lt;ApplePayLineItem&gt;&amp;&amp; newLineItems)
 713 {
 714     ApplePayPaymentMethodUpdate update;
 715 
 716     update.newTotal = WTFMove(newTotal);
 717     update.newLineItems = WTFMove(newLineItems);
 718 
 719     return completePaymentMethodSelection(WTFMove(update));
 720 }
 721 
 722 ExceptionOr&lt;void&gt; ApplePaySession::completePayment(unsigned short status)
 723 {
 724     ApplePayPaymentAuthorizationResult result;
 725     result.status = status;
 726 
 727     return completePayment(WTFMove(result));
 728 }
 729 
 730 unsigned ApplePaySession::version() const
 731 {
 732     return m_version;
 733 }
 734 
 735 void ApplePaySession::validateMerchant(URL&amp;&amp; validationURL)
 736 {
 737     if (m_state == State::Aborted) {
 738         // ApplePaySession::abort has been called.
 739         return;
 740     }
 741 
 742     ASSERT(m_merchantValidationState == MerchantValidationState::Idle);
 743     ASSERT(m_state == State::Active);
 744 
 745     if (validationURL.isNull()) {
 746         // Something went wrong when getting the validation URL.
 747         // FIXME: Maybe we should send an error event here instead?
 748         return;
 749     }
 750 
 751     m_merchantValidationState = MerchantValidationState::ValidatingMerchant;
 752 
 753     auto event = ApplePayValidateMerchantEvent::create(eventNames().validatemerchantEvent, WTFMove(validationURL));
 754     dispatchEvent(event.get());
 755 }
 756 
 757 void ApplePaySession::didAuthorizePayment(const Payment&amp; payment)
 758 {
 759     ASSERT(m_state == State::Active);
 760 
 761     m_state = State::Authorized;
 762 
 763     auto event = ApplePayPaymentAuthorizedEvent::create(eventNames().paymentauthorizedEvent, version(), payment);
 764     dispatchEvent(event.get());
 765 }
 766 
 767 void ApplePaySession::didSelectShippingMethod(const ApplePaySessionPaymentRequest::ShippingMethod&amp; shippingMethod)
 768 {
 769     ASSERT(m_state == State::Active);
 770 
 771     if (!hasEventListeners(eventNames().shippingmethodselectedEvent)) {
 772         paymentCoordinator().completeShippingMethodSelection({ });
 773         return;
 774     }
 775 
 776     m_state = State::ShippingMethodSelected;
 777     auto event = ApplePayShippingMethodSelectedEvent::create(eventNames().shippingmethodselectedEvent, shippingMethod);
 778     dispatchEvent(event.get());
 779 }
 780 
 781 void ApplePaySession::didSelectShippingContact(const PaymentContact&amp; shippingContact)
 782 {
 783     ASSERT(m_state == State::Active);
 784 
 785     if (!hasEventListeners(eventNames().shippingcontactselectedEvent)) {
 786         paymentCoordinator().completeShippingContactSelection({ });
 787         return;
 788     }
 789 
 790     m_state = State::ShippingContactSelected;
 791     auto event = ApplePayShippingContactSelectedEvent::create(eventNames().shippingcontactselectedEvent, version(), shippingContact);
 792     dispatchEvent(event.get());
 793 }
 794 
 795 void ApplePaySession::didSelectPaymentMethod(const PaymentMethod&amp; paymentMethod)
 796 {
 797     ASSERT(m_state == State::Active);
 798 
 799     if (!hasEventListeners(eventNames().paymentmethodselectedEvent)) {
 800         paymentCoordinator().completePaymentMethodSelection({ });
 801         return;
 802     }
 803 
 804     m_state = State::PaymentMethodSelected;
 805     auto event = ApplePayPaymentMethodSelectedEvent::create(eventNames().paymentmethodselectedEvent, paymentMethod);
 806     dispatchEvent(event.get());
 807 }
 808 
<a name="12" id="anc12"></a><span class="line-modified"> 809 void ApplePaySession::didCancelPaymentSession(PaymentSessionError&amp;&amp; error)</span>
 810 {
 811     ASSERT(canCancel());
 812 
 813     m_state = State::Canceled;
 814 
<a name="13" id="anc13"></a><span class="line-modified"> 815     auto event = ApplePayCancelEvent::create(eventNames().cancelEvent, WTFMove(error));</span>
 816     dispatchEvent(event.get());
 817 
 818     didReachFinalState();
 819 }
 820 
 821 const char* ApplePaySession::activeDOMObjectName() const
 822 {
 823     return &quot;ApplePaySession&quot;;
 824 }
 825 
<a name="14" id="anc14"></a><span class="line-modified"> 826 bool ApplePaySession::canSuspendWithoutCanceling() const</span>
 827 {
 828     switch (m_state) {
 829     case State::Idle:
 830     case State::Aborted:
 831     case State::Completed:
 832     case State::Canceled:
 833         return true;
 834 
 835     case State::Active:
 836     case State::Authorized:
 837     case State::ShippingMethodSelected:
 838     case State::ShippingContactSelected:
 839     case State::PaymentMethodSelected:
 840     case State::CancelRequested:
 841         return false;
 842     }
 843 }
 844 
 845 void ApplePaySession::stop()
 846 {
 847     if (!canAbort())
 848         return;
 849 
 850     m_state = State::Aborted;
 851     paymentCoordinator().abortPaymentSession();
 852 
 853     didReachFinalState();
 854 }
 855 
<a name="15" id="anc15"></a><span class="line-added"> 856 void ApplePaySession::suspend(ReasonForSuspension reason)</span>
<span class="line-added"> 857 {</span>
<span class="line-added"> 858     if (reason != ReasonForSuspension::BackForwardCache)</span>
<span class="line-added"> 859         return;</span>
<span class="line-added"> 860 </span>
<span class="line-added"> 861     if (canSuspendWithoutCanceling())</span>
<span class="line-added"> 862         return;</span>
<span class="line-added"> 863 </span>
<span class="line-added"> 864     m_state = State::Canceled;</span>
<span class="line-added"> 865     paymentCoordinator().abortPaymentSession();</span>
<span class="line-added"> 866     queueTaskToDispatchEvent(*this, TaskSource::UserInteraction, ApplePayCancelEvent::create(eventNames().cancelEvent, { }));</span>
<span class="line-added"> 867 </span>
<span class="line-added"> 868     didReachFinalState();</span>
<span class="line-added"> 869 }</span>
<span class="line-added"> 870 </span>
 871 PaymentCoordinator&amp; ApplePaySession::paymentCoordinator() const
 872 {
 873     return downcast&lt;Document&gt;(*scriptExecutionContext()).page()-&gt;paymentCoordinator();
 874 }
 875 
 876 bool ApplePaySession::canBegin() const
 877 {
 878     switch (m_state) {
 879     case State::Idle:
 880         return true;
 881 
 882     case State::Active:
 883     case State::Aborted:
 884     case State::Authorized:
 885     case State::Completed:
 886     case State::Canceled:
 887     case State::ShippingMethodSelected:
 888     case State::ShippingContactSelected:
 889     case State::PaymentMethodSelected:
 890     case State::CancelRequested:
 891         return false;
 892     }
 893 }
 894 
 895 bool ApplePaySession::canAbort() const
 896 {
 897     switch (m_state) {
 898     case State::Idle:
 899     case State::Aborted:
 900     case State::Completed:
 901     case State::Canceled:
 902         return false;
 903 
 904     case State::Active:
 905     case State::Authorized:
 906     case State::ShippingMethodSelected:
 907     case State::ShippingContactSelected:
 908     case State::PaymentMethodSelected:
 909     case State::CancelRequested:
 910         return true;
 911     }
 912 }
 913 
 914 bool ApplePaySession::canCancel() const
 915 {
 916     switch (m_state) {
 917     case State::Idle:
 918     case State::Aborted:
 919     case State::Completed:
 920     case State::Canceled:
 921         return false;
 922 
 923     case State::Active:
 924     case State::Authorized:
 925     case State::ShippingMethodSelected:
 926     case State::ShippingContactSelected:
 927     case State::PaymentMethodSelected:
 928     case State::CancelRequested:
 929         return true;
 930     }
 931 }
 932 
 933 bool ApplePaySession::canCompleteMerchantValidation() const
 934 {
 935     if (m_state != State::Active)
 936         return false;
 937 
 938     if (m_merchantValidationState != MerchantValidationState::ValidatingMerchant)
 939         return false;
 940 
 941     return true;
 942 }
 943 
 944 bool ApplePaySession::canCompleteShippingMethodSelection() const
 945 {
 946     switch (m_state) {
 947     case State::Idle:
 948     case State::Aborted:
 949     case State::Active:
 950     case State::Completed:
 951     case State::Canceled:
 952     case State::Authorized:
 953     case State::PaymentMethodSelected:
 954     case State::ShippingContactSelected:
 955     case State::CancelRequested:
 956         return false;
 957 
 958     case State::ShippingMethodSelected:
 959         return true;
 960     }
 961 }
 962 
 963 bool ApplePaySession::canCompleteShippingContactSelection() const
 964 {
 965     switch (m_state) {
 966     case State::Idle:
 967     case State::Aborted:
 968     case State::Active:
 969     case State::Completed:
 970     case State::Canceled:
 971     case State::Authorized:
 972     case State::PaymentMethodSelected:
 973     case State::ShippingMethodSelected:
 974     case State::CancelRequested:
 975         return false;
 976 
 977     case State::ShippingContactSelected:
 978         return true;
 979     }
 980 }
 981 
 982 bool ApplePaySession::canCompletePaymentMethodSelection() const
 983 {
 984     switch (m_state) {
 985     case State::Idle:
 986     case State::Aborted:
 987     case State::Active:
 988     case State::Completed:
 989     case State::Canceled:
 990     case State::Authorized:
 991     case State::ShippingMethodSelected:
 992     case State::ShippingContactSelected:
 993     case State::CancelRequested:
 994         return false;
 995 
 996     case State::PaymentMethodSelected:
 997         return true;
 998     }
 999 }
1000 
1001 bool ApplePaySession::canCompletePayment() const
1002 {
1003     switch (m_state) {
1004     case State::Idle:
1005     case State::Aborted:
1006     case State::Active:
1007     case State::Completed:
1008     case State::Canceled:
1009     case State::ShippingMethodSelected:
1010     case State::ShippingContactSelected:
1011     case State::PaymentMethodSelected:
1012     case State::CancelRequested:
1013         return false;
1014 
1015     case State::Authorized:
1016         return true;
1017     }
1018 }
1019 
1020 bool ApplePaySession::isFinalState() const
1021 {
1022     switch (m_state) {
1023     case State::Idle:
1024     case State::Active:
1025     case State::ShippingMethodSelected:
1026     case State::ShippingContactSelected:
1027     case State::PaymentMethodSelected:
1028     case State::Authorized:
1029     case State::CancelRequested:
1030         return false;
1031 
1032     case State::Completed:
1033     case State::Aborted:
1034     case State::Canceled:
1035         return true;
1036     }
1037 }
1038 
1039 void ApplePaySession::didReachFinalState()
1040 {
1041     ASSERT(isFinalState());
1042     unsetPendingActivity(*this);
1043 }
1044 
1045 }
1046 
1047 #endif
<a name="16" id="anc16"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="16" type="hidden" />
</body>
</html>