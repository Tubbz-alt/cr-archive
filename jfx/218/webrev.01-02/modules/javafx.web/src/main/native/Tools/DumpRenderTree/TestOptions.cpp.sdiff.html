<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Tools/DumpRenderTree/TestOptions.cpp</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="TestNetscapePlugIn/TestObject.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="TestOptions.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Tools/DumpRenderTree/TestOptions.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (C) 2016-2018 Apple Inc. All rights reserved.</span>
  3  *
  4  * Redistribution and use in source and binary forms, with or without
  5  * modification, are permitted provided that the following conditions
  6  * are met:
  7  * 1. Redistributions of source code must retain the above copyright
  8  *    notice, this list of conditions and the following disclaimer.
  9  * 2. Redistributions in binary form must reproduce the above copyright
 10  *    notice, this list of conditions and the following disclaimer in the
 11  *    documentation and/or other materials provided with the distribution.
 12  *
 13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. AND ITS CONTRIBUTORS ``AS IS&#39;&#39;
 14  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
 15  * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 16  * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL APPLE INC. OR ITS CONTRIBUTORS
 17  * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 18  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 19  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 20  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 21  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 22  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF
 23  * THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #include &quot;config.h&quot;
 27 #include &quot;TestOptions.h&quot;
 28 
 29 #include &lt;fstream&gt;


 30 
 31 static bool parseBooleanTestHeaderValue(const std::string&amp; value)
 32 {
 33     if (value == &quot;true&quot;)
 34         return true;
 35     if (value == &quot;false&quot;)
 36         return false;
 37 
 38     LOG_ERROR(&quot;Found unexpected value &#39;%s&#39; for boolean option. Expected &#39;true&#39; or &#39;false&#39;.&quot;, value.c_str());
 39     return false;
 40 }
 41 

















 42 TestOptions::TestOptions(const std::string&amp; pathOrURL, const std::string&amp; absolutePath)
 43 {
 44     const auto&amp; path = absolutePath.empty() ? pathOrURL : absolutePath;
 45     if (path.empty())
 46         return;
 47 


 48     std::string options;
 49     std::ifstream testFile(path.data());
 50     if (!testFile.good())
 51         return;
 52     getline(testFile, options);
 53     std::string beginString(&quot;webkit-test-runner [ &quot;);
 54     std::string endString(&quot; ]&quot;);
 55     size_t beginLocation = options.find(beginString);
 56     if (beginLocation == std::string::npos)
 57         return;
 58     size_t endLocation = options.find(endString, beginLocation);
 59     if (endLocation == std::string::npos) {
 60         LOG_ERROR(&quot;Could not find end of test header in %s&quot;, path.c_str());
 61         return;
 62     }
 63     std::string pairString = options.substr(beginLocation + beginString.size(), endLocation - (beginLocation + beginString.size()));
 64     size_t pairStart = 0;
 65     while (pairStart &lt; pairString.size()) {
 66         size_t pairEnd = pairString.find(&quot; &quot;, pairStart);
 67         if (pairEnd == std::string::npos)
 68             pairEnd = pairString.size();
 69         size_t equalsLocation = pairString.find(&quot;=&quot;, pairStart);
 70         if (equalsLocation == std::string::npos) {
 71             LOG_ERROR(&quot;Malformed option in test header (could not find &#39;=&#39; character) in %s&quot;, path.c_str());
 72             break;
 73         }
 74         auto key = pairString.substr(pairStart, equalsLocation - pairStart);
 75         auto value = pairString.substr(equalsLocation + 1, pairEnd - (equalsLocation + 1));
 76         if (key == &quot;enableAttachmentElement&quot;)
 77             enableAttachmentElement = parseBooleanTestHeaderValue(value);
 78         if (key == &quot;useAcceleratedDrawing&quot;)
 79             useAcceleratedDrawing = parseBooleanTestHeaderValue(value);
 80         else if (key == &quot;enableIntersectionObserver&quot;)
 81             enableIntersectionObserver = parseBooleanTestHeaderValue(value);




 82         else if (key == &quot;enableMenuItemElement&quot;)
 83             enableMenuItemElement = parseBooleanTestHeaderValue(value);
 84         else if (key == &quot;enableKeygenElement&quot;)
 85             enableKeygenElement = parseBooleanTestHeaderValue(value);
 86         else if (key == &quot;enableModernMediaControls&quot;)
 87             enableModernMediaControls = parseBooleanTestHeaderValue(value);
 88         else if (key == &quot;enablePointerLock&quot;)
 89             enablePointerLock = parseBooleanTestHeaderValue(value);
 90         else if (key == &quot;enableDragDestinationActionLoad&quot;)
 91             enableDragDestinationActionLoad = parseBooleanTestHeaderValue(value);
 92         else if (key == &quot;layerBackedWebView&quot;)
 93             layerBackedWebView = parseBooleanTestHeaderValue(value);
 94         else if (key == &quot;enableIsSecureContextAttribute&quot;)
 95             enableIsSecureContextAttribute = parseBooleanTestHeaderValue(value);
 96         else if (key == &quot;enableInspectorAdditions&quot;)
 97             enableInspectorAdditions = parseBooleanTestHeaderValue(value);
 98         else if (key == &quot;dumpJSConsoleLogInStdErr&quot;)
 99             dumpJSConsoleLogInStdErr = parseBooleanTestHeaderValue(value);
100         else if (key == &quot;allowCrossOriginSubresourcesToAskForCredentials&quot;)
101             allowCrossOriginSubresourcesToAskForCredentials = parseBooleanTestHeaderValue(value);
102         else if (key == &quot;experimental:WebAnimationsCSSIntegrationEnabled&quot;)
103             enableWebAnimationsCSSIntegration = parseBooleanTestHeaderValue(value);
104         else if (key == &quot;internal:selectionAcrossShadowBoundariesEnabled&quot;)
105             enableSelectionAcrossShadowBoundaries = parseBooleanTestHeaderValue(value);
106         else if (key == &quot;enableColorFilter&quot;)
107             enableColorFilter = parseBooleanTestHeaderValue(value);
108         else if (key == &quot;jscOptions&quot;)
109             jscOptions = value;
110         else if (key == &quot;additionalSupportedImageTypes&quot;)
111             additionalSupportedImageTypes = value;
112         else if (key == &quot;experimental:WebGPUEnabled&quot;)
113             enableWebGPU = parseBooleanTestHeaderValue(value);
114         else if (key == &quot;internal:CSSLogicalEnabled&quot;)
115             enableCSSLogical = parseBooleanTestHeaderValue(value);
116         else if (key == &quot;experimental:AdClickAttributionEnabled&quot;)
117             adClickAttributionEnabled = parseBooleanTestHeaderValue(value);
118         else if (key == &quot;experimental:ResizeObserverEnabled&quot;)
119             enableResizeObserver = parseBooleanTestHeaderValue(value);


120         else if (key == &quot;experimental:CoreMathMLEnabled&quot;)
121             enableCoreMathML = parseBooleanTestHeaderValue(value);
<span class="line-modified">122         else if (key == &quot;experimental:LazyImageLoadingEnabled&quot;)</span>
<span class="line-modified">123             enableLazyImageLoading = parseBooleanTestHeaderValue(value);</span>








124         pairStart = pairEnd + 1;
125     }
126 }
127 
128 bool TestOptions::webViewIsCompatibleWithOptions(const TestOptions&amp; other) const
129 {
130     return other.layerBackedWebView == layerBackedWebView
131         &amp;&amp; other.jscOptions == jscOptions
132         &amp;&amp; other.enableWebAnimationsCSSIntegration == enableWebAnimationsCSSIntegration;
133 }
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (C) 2016-2020 Apple Inc. All rights reserved.</span>
  3  *
  4  * Redistribution and use in source and binary forms, with or without
  5  * modification, are permitted provided that the following conditions
  6  * are met:
  7  * 1. Redistributions of source code must retain the above copyright
  8  *    notice, this list of conditions and the following disclaimer.
  9  * 2. Redistributions in binary form must reproduce the above copyright
 10  *    notice, this list of conditions and the following disclaimer in the
 11  *    documentation and/or other materials provided with the distribution.
 12  *
 13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. AND ITS CONTRIBUTORS ``AS IS&#39;&#39;
 14  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
 15  * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 16  * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL APPLE INC. OR ITS CONTRIBUTORS
 17  * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 18  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 19  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 20  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 21  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 22  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF
 23  * THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #include &quot;config.h&quot;
 27 #include &quot;TestOptions.h&quot;
 28 
 29 #include &lt;fstream&gt;
<span class="line-added"> 30 #include &lt;string&gt;</span>
<span class="line-added"> 31 #include &lt;wtf/text/WTFString.h&gt;</span>
 32 
 33 static bool parseBooleanTestHeaderValue(const std::string&amp; value)
 34 {
 35     if (value == &quot;true&quot;)
 36         return true;
 37     if (value == &quot;false&quot;)
 38         return false;
 39 
 40     LOG_ERROR(&quot;Found unexpected value &#39;%s&#39; for boolean option. Expected &#39;true&#39; or &#39;false&#39;.&quot;, value.c_str());
 41     return false;
 42 }
 43 
<span class="line-added"> 44 static bool pathContains(const std::string&amp; pathOrURL, const char* substring)</span>
<span class="line-added"> 45 {</span>
<span class="line-added"> 46     String path(pathOrURL.c_str());</span>
<span class="line-added"> 47     return path.contains(substring);</span>
<span class="line-added"> 48 }</span>
<span class="line-added"> 49 </span>
<span class="line-added"> 50 static bool shouldDumpJSConsoleLogInStdErr(const std::string&amp; pathOrURL)</span>
<span class="line-added"> 51 {</span>
<span class="line-added"> 52     return pathContains(pathOrURL, &quot;localhost:8800/beacon&quot;) || pathContains(pathOrURL, &quot;localhost:9443/beacon&quot;)</span>
<span class="line-added"> 53         || pathContains(pathOrURL, &quot;localhost:8800/cors&quot;) || pathContains(pathOrURL, &quot;localhost:9443/cors&quot;)</span>
<span class="line-added"> 54         || pathContains(pathOrURL, &quot;localhost:8800/fetch&quot;) || pathContains(pathOrURL, &quot;localhost:9443/fetch&quot;)</span>
<span class="line-added"> 55         || pathContains(pathOrURL, &quot;localhost:8800/service-workers&quot;) || pathContains(pathOrURL, &quot;localhost:9443/service-workers&quot;)</span>
<span class="line-added"> 56         || pathContains(pathOrURL, &quot;localhost:8800/xhr&quot;) || pathContains(pathOrURL, &quot;localhost:9443/xhr&quot;)</span>
<span class="line-added"> 57         || pathContains(pathOrURL, &quot;localhost:8800/webrtc&quot;) || pathContains(pathOrURL, &quot;localhost:9443/webrtc&quot;)</span>
<span class="line-added"> 58         || pathContains(pathOrURL, &quot;localhost:8800/websockets&quot;) || pathContains(pathOrURL, &quot;localhost:9443/websockets&quot;);</span>
<span class="line-added"> 59 }</span>
<span class="line-added"> 60 </span>
 61 TestOptions::TestOptions(const std::string&amp; pathOrURL, const std::string&amp; absolutePath)
 62 {
 63     const auto&amp; path = absolutePath.empty() ? pathOrURL : absolutePath;
 64     if (path.empty())
 65         return;
 66 
<span class="line-added"> 67     dumpJSConsoleLogInStdErr = shouldDumpJSConsoleLogInStdErr(pathOrURL);</span>
<span class="line-added"> 68 </span>
 69     std::string options;
 70     std::ifstream testFile(path.data());
 71     if (!testFile.good())
 72         return;
 73     getline(testFile, options);
 74     std::string beginString(&quot;webkit-test-runner [ &quot;);
 75     std::string endString(&quot; ]&quot;);
 76     size_t beginLocation = options.find(beginString);
 77     if (beginLocation == std::string::npos)
 78         return;
 79     size_t endLocation = options.find(endString, beginLocation);
 80     if (endLocation == std::string::npos) {
 81         LOG_ERROR(&quot;Could not find end of test header in %s&quot;, path.c_str());
 82         return;
 83     }
 84     std::string pairString = options.substr(beginLocation + beginString.size(), endLocation - (beginLocation + beginString.size()));
 85     size_t pairStart = 0;
 86     while (pairStart &lt; pairString.size()) {
 87         size_t pairEnd = pairString.find(&quot; &quot;, pairStart);
 88         if (pairEnd == std::string::npos)
 89             pairEnd = pairString.size();
 90         size_t equalsLocation = pairString.find(&quot;=&quot;, pairStart);
 91         if (equalsLocation == std::string::npos) {
 92             LOG_ERROR(&quot;Malformed option in test header (could not find &#39;=&#39; character) in %s&quot;, path.c_str());
 93             break;
 94         }
 95         auto key = pairString.substr(pairStart, equalsLocation - pairStart);
 96         auto value = pairString.substr(equalsLocation + 1, pairEnd - (equalsLocation + 1));
 97         if (key == &quot;enableAttachmentElement&quot;)
 98             enableAttachmentElement = parseBooleanTestHeaderValue(value);
 99         if (key == &quot;useAcceleratedDrawing&quot;)
100             useAcceleratedDrawing = parseBooleanTestHeaderValue(value);
101         else if (key == &quot;enableIntersectionObserver&quot;)
102             enableIntersectionObserver = parseBooleanTestHeaderValue(value);
<span class="line-added">103         else if (key == &quot;useEphemeralSession&quot;)</span>
<span class="line-added">104             useEphemeralSession = parseBooleanTestHeaderValue(value);</span>
<span class="line-added">105         else if (key == &quot;enableBackForwardCache&quot;)</span>
<span class="line-added">106             enableBackForwardCache = parseBooleanTestHeaderValue(value);</span>
107         else if (key == &quot;enableMenuItemElement&quot;)
108             enableMenuItemElement = parseBooleanTestHeaderValue(value);
109         else if (key == &quot;enableKeygenElement&quot;)
110             enableKeygenElement = parseBooleanTestHeaderValue(value);
111         else if (key == &quot;enableModernMediaControls&quot;)
112             enableModernMediaControls = parseBooleanTestHeaderValue(value);
113         else if (key == &quot;enablePointerLock&quot;)
114             enablePointerLock = parseBooleanTestHeaderValue(value);
115         else if (key == &quot;enableDragDestinationActionLoad&quot;)
116             enableDragDestinationActionLoad = parseBooleanTestHeaderValue(value);
117         else if (key == &quot;layerBackedWebView&quot;)
118             layerBackedWebView = parseBooleanTestHeaderValue(value);
119         else if (key == &quot;enableIsSecureContextAttribute&quot;)
120             enableIsSecureContextAttribute = parseBooleanTestHeaderValue(value);
121         else if (key == &quot;enableInspectorAdditions&quot;)
122             enableInspectorAdditions = parseBooleanTestHeaderValue(value);
123         else if (key == &quot;dumpJSConsoleLogInStdErr&quot;)
124             dumpJSConsoleLogInStdErr = parseBooleanTestHeaderValue(value);
125         else if (key == &quot;allowCrossOriginSubresourcesToAskForCredentials&quot;)
126             allowCrossOriginSubresourcesToAskForCredentials = parseBooleanTestHeaderValue(value);
127         else if (key == &quot;experimental:WebAnimationsCSSIntegrationEnabled&quot;)
128             enableWebAnimationsCSSIntegration = parseBooleanTestHeaderValue(value);
129         else if (key == &quot;internal:selectionAcrossShadowBoundariesEnabled&quot;)
130             enableSelectionAcrossShadowBoundaries = parseBooleanTestHeaderValue(value);
131         else if (key == &quot;enableColorFilter&quot;)
132             enableColorFilter = parseBooleanTestHeaderValue(value);
133         else if (key == &quot;jscOptions&quot;)
134             jscOptions = value;
135         else if (key == &quot;additionalSupportedImageTypes&quot;)
136             additionalSupportedImageTypes = value;
137         else if (key == &quot;experimental:WebGPUEnabled&quot;)
138             enableWebGPU = parseBooleanTestHeaderValue(value);
139         else if (key == &quot;internal:CSSLogicalEnabled&quot;)
140             enableCSSLogical = parseBooleanTestHeaderValue(value);
141         else if (key == &quot;experimental:AdClickAttributionEnabled&quot;)
142             adClickAttributionEnabled = parseBooleanTestHeaderValue(value);
143         else if (key == &quot;experimental:ResizeObserverEnabled&quot;)
144             enableResizeObserver = parseBooleanTestHeaderValue(value);
<span class="line-added">145         else if (key == &quot;experimental:CSSOMViewSmoothScrollingEnabled&quot;)</span>
<span class="line-added">146             enableCSSOMViewSmoothScrolling = parseBooleanTestHeaderValue(value);</span>
147         else if (key == &quot;experimental:CoreMathMLEnabled&quot;)
148             enableCoreMathML = parseBooleanTestHeaderValue(value);
<span class="line-modified">149         else if (key == &quot;experimental:RequestIdleCallbackEnabled&quot;)</span>
<span class="line-modified">150             enableRequestIdleCallback = parseBooleanTestHeaderValue(value);</span>
<span class="line-added">151         else if (key == &quot;experimental:AsyncClipboardAPIEnabled&quot;)</span>
<span class="line-added">152             enableAsyncClipboardAPI = parseBooleanTestHeaderValue(value);</span>
<span class="line-added">153         else if (key == &quot;internal:LayoutFormattingContextIntegrationEnabled&quot;)</span>
<span class="line-added">154             layoutFormattingContextIntegrationEnabled = parseBooleanTestHeaderValue(value);</span>
<span class="line-added">155         else if (key == &quot;experimental:AspectRatioOfImgFromWidthAndHeightEnabled&quot;)</span>
<span class="line-added">156             enableAspectRatioOfImgFromWidthAndHeight = parseBooleanTestHeaderValue(value);</span>
<span class="line-added">157         else if (key == &quot;allowTopNavigationToDataURLs&quot;)</span>
<span class="line-added">158             allowTopNavigationToDataURLs = parseBooleanTestHeaderValue(value);</span>
159         pairStart = pairEnd + 1;
160     }
161 }
162 
163 bool TestOptions::webViewIsCompatibleWithOptions(const TestOptions&amp; other) const
164 {
165     return other.layerBackedWebView == layerBackedWebView
166         &amp;&amp; other.jscOptions == jscOptions
167         &amp;&amp; other.enableWebAnimationsCSSIntegration == enableWebAnimationsCSSIntegration;
168 }
</pre>
</td>
</tr>
</table>
<center><a href="TestNetscapePlugIn/TestObject.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="TestOptions.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>