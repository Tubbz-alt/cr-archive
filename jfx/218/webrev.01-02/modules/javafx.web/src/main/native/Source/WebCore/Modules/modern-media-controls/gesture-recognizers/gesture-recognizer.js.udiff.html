<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WebCore/Modules/modern-media-controls/gesture-recognizers/gesture-recognizer.js</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../controls/slider.js.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../media/pip-support.js.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/Modules/modern-media-controls/gesture-recognizers/gesture-recognizer.js</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,12 +1,11 @@</span>
<span class="udiff-line-removed">- </span>
  class GestureRecognizer
  {
  
      constructor(target = null, delegate = null)
      {
<span class="udiff-line-modified-removed">-         this._targetTouches = [];</span>
<span class="udiff-line-modified-added">+         this._targetPointers = new Map;</span>
  
          this.modifierKeys = {
              alt : false,
              ctrl : false,
              meta : false,
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -51,11 +50,11 @@</span>
          this._initRecognizer();
      }
  
      get numberOfTouches()
      {
<span class="udiff-line-modified-removed">-         return this._targetTouches.length;</span>
<span class="udiff-line-modified-added">+         return this._targetPointers.size;</span>
      }
  
      get enabled()
      {
          return this._enabled;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -85,17 +84,17 @@</span>
      }
  
      locationInElement(element)
      {
          const p = new DOMPoint;
<span class="udiff-line-modified-removed">-         const touches = this._targetTouches;</span>
<span class="udiff-line-modified-removed">-         const count = touches.length;</span>
<span class="udiff-line-modified-removed">-         for (let i = 0; i &lt; count; ++i) {</span>
<span class="udiff-line-modified-removed">-             const touch = touches[i];</span>
<span class="udiff-line-modified-removed">-             p.x += touch.pageX;</span>
<span class="udiff-line-modified-removed">-             p.y += touch.pageY;</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-added">+         const count = this._targetPointers.size;</span>
<span class="udiff-line-modified-added">+         if (!count)</span>
<span class="udiff-line-modified-added">+             return p;</span>
<span class="udiff-line-modified-added">+         this._targetPointers.forEach(function (pointer) {</span>
<span class="udiff-line-modified-added">+             p.x += pointer.pageX;</span>
<span class="udiff-line-modified-added">+             p.y += pointer.pageY;</span>
<span class="udiff-line-modified-added">+         });</span>
          p.x /= count;
          p.y /= count;
  
          if (!element)
              return p;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -106,46 +105,31 @@</span>
      }
  
      locationInClient()
      {
          const p = new DOMPoint;
<span class="udiff-line-modified-removed">-         const touches = this._targetTouches;</span>
<span class="udiff-line-modified-removed">-         const count = touches.length;</span>
<span class="udiff-line-modified-removed">-         for (let i = 0; i &lt; count; ++i) {</span>
<span class="udiff-line-modified-removed">-             const touch = touches[i];</span>
<span class="udiff-line-modified-removed">-             p.x += touch.clientX;</span>
<span class="udiff-line-modified-removed">-             p.y += touch.clientY;</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-added">+         const count = this._targetPointers.size;</span>
<span class="udiff-line-modified-added">+         if (!count)</span>
<span class="udiff-line-modified-added">+             return p;</span>
<span class="udiff-line-modified-added">+         this._targetPointers.forEach(function (pointer) {</span>
<span class="udiff-line-modified-added">+             p.x += pointer.clientX;</span>
<span class="udiff-line-modified-added">+             p.y += pointer.clientY;</span>
<span class="udiff-line-modified-added">+         });</span>
          p.x /= count;
          p.y /= count;
  
          return p;
      }
  
<span class="udiff-line-removed">-     locationOfTouchInElement(touchIndex, element)</span>
<span class="udiff-line-removed">-     {</span>
<span class="udiff-line-removed">-         const touch = this._targetTouches[touchIndex];</span>
<span class="udiff-line-removed">-         if (!touch)</span>
<span class="udiff-line-removed">-             return new DOMPoint;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         const touchLocation = new DOMPoint(touch.pageX, touch.pageY);</span>
<span class="udiff-line-removed">-         if (!element)</span>
<span class="udiff-line-removed">-             return touchLocation;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         // FIXME: are WebKitPoint and DOMPoint interchangeable?</span>
<span class="udiff-line-removed">-         const wkPoint = window.webkitConvertPointFromPageToNode(element, new WebKitPoint(touchLocation.x, touchLocation.y));</span>
<span class="udiff-line-removed">-         return new DOMPoint(wkPoint.x, wkPoint.y);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
      touchesBegan(event)
      {
          if (event.currentTarget !== this._target)
              return;
  
<span class="udiff-line-modified-removed">-         window.addEventListener(GestureRecognizer.Events.TouchMove, this, true);</span>
<span class="udiff-line-modified-removed">-         window.addEventListener(GestureRecognizer.Events.TouchEnd, this, true);</span>
<span class="udiff-line-modified-removed">-         window.addEventListener(GestureRecognizer.Events.TouchCancel, this, true);</span>
<span class="udiff-line-modified-added">+         window.addEventListener(GestureRecognizer.Events.PointerMove, this, true);</span>
<span class="udiff-line-modified-added">+         window.addEventListener(GestureRecognizer.Events.PointerUp, this, true);</span>
<span class="udiff-line-modified-added">+         window.addEventListener(GestureRecognizer.Events.PointerCancel, this, true);</span>
          this.enterPossibleState();
      }
  
      touchesMoved(event)
      {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -233,20 +217,20 @@</span>
      {
          this._updateTargetTouches(event);
          this._updateKeyboardModifiers(event);
  
          switch (event.type) {
<span class="udiff-line-modified-removed">-         case GestureRecognizer.Events.TouchStart:</span>
<span class="udiff-line-modified-added">+         case GestureRecognizer.Events.PointerDown:</span>
              this.touchesBegan(event);
              break;
<span class="udiff-line-modified-removed">-         case GestureRecognizer.Events.TouchMove:</span>
<span class="udiff-line-modified-added">+         case GestureRecognizer.Events.PointerMove:</span>
              this.touchesMoved(event);
              break;
<span class="udiff-line-modified-removed">-         case GestureRecognizer.Events.TouchEnd:</span>
<span class="udiff-line-modified-added">+         case GestureRecognizer.Events.PointerUp:</span>
              this.touchesEnded(event);
              break;
<span class="udiff-line-modified-removed">-         case GestureRecognizer.Events.TouchCancel:</span>
<span class="udiff-line-modified-added">+         case GestureRecognizer.Events.PointerCancel:</span>
              this.touchesCancelled(event);
              break;
          case GestureRecognizer.Events.GestureStart:
              this.gestureBegan(event);
              break;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -273,78 +257,47 @@</span>
      {
          if (!this._target)
              return;
  
          if (this._enabled) {
<span class="udiff-line-modified-removed">-             this._target.addEventListener(GestureRecognizer.Events.TouchStart, this);</span>
<span class="udiff-line-modified-added">+             this._target.addEventListener(GestureRecognizer.Events.PointerDown, this);</span>
              if (GestureRecognizer.SupportsGestures)
                  this._target.addEventListener(GestureRecognizer.Events.GestureStart, this);
          } else {
<span class="udiff-line-modified-removed">-             this._target.removeEventListener(GestureRecognizer.Events.TouchStart, this);</span>
<span class="udiff-line-modified-added">+             this._target.removeEventListener(GestureRecognizer.Events.PointerDown, this);</span>
              if (GestureRecognizer.SupportsGestures)
                  this._target.removeEventListener(GestureRecognizer.Events.GestureStart, this);
          }
      }
  
      _removeTrackingListeners()
      {
<span class="udiff-line-modified-removed">-         window.removeEventListener(GestureRecognizer.Events.TouchMove, this, true);</span>
<span class="udiff-line-modified-removed">-         window.removeEventListener(GestureRecognizer.Events.TouchEnd, this, true);</span>
<span class="udiff-line-modified-added">+         window.removeEventListener(GestureRecognizer.Events.PointerMove, this, true);</span>
<span class="udiff-line-modified-added">+         window.removeEventListener(GestureRecognizer.Events.PointerUp, this, true);</span>
<span class="udiff-line-added">+         window.removeEventListener(GestureRecognizer.Events.PointerCancel, this, true);</span>
          this._target.removeEventListener(GestureRecognizer.Events.GestureChange, this, true);
          this._target.removeEventListener(GestureRecognizer.Events.GestureEnd, this, true);
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         this._targetPointers = new Map;</span>
      }
  
      _updateTargetTouches(event)
      {
<span class="udiff-line-modified-removed">-         if (!GestureRecognizer.SupportsTouches) {</span>
<span class="udiff-line-removed">-             if (event.type === GestureRecognizer.Events.TouchEnd)</span>
<span class="udiff-line-removed">-                 this._targetTouches = [];</span>
<span class="udiff-line-removed">-             else</span>
<span class="udiff-line-removed">-                 this._targetTouches = [event];</span>
<span class="udiff-line-removed">-             return;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         if (!(event instanceof TouchEvent))</span>
<span class="udiff-line-modified-added">+         if (!(event instanceof PointerEvent))</span>
              return;
  
<span class="udiff-line-modified-removed">-         // With a touchstart event, event.targetTouches is accurate so</span>
<span class="udiff-line-modified-removed">-         // we simply add all of those.</span>
<span class="udiff-line-removed">-         if (event.type === GestureRecognizer.Events.TouchStart) {</span>
<span class="udiff-line-removed">-             this._targetTouches = [];</span>
<span class="udiff-line-removed">-             let touches = event.targetTouches;</span>
<span class="udiff-line-removed">-             for (let i = 0, count = touches.length; i &lt; count; ++i)</span>
<span class="udiff-line-removed">-                 this._targetTouches.push(touches[i]);</span>
<span class="udiff-line-modified-added">+         if (event.type === GestureRecognizer.Events.PointerDown) {</span>
<span class="udiff-line-modified-added">+             this._targetPointers.set(event.pointerId, event);</span>
              return;
          }
  
<span class="udiff-line-modified-removed">-         // With a touchmove event, the target is window so event.targetTouches is</span>
<span class="udiff-line-modified-removed">-         // inaccurate so we add all touches that we knew about previously.</span>
<span class="udiff-line-removed">-         if (event.type === GestureRecognizer.Events.TouchMove) {</span>
<span class="udiff-line-removed">-             let targetIdentifiers = this._targetTouches.map(function(touch) {</span>
<span class="udiff-line-removed">-                 return touch.identifier;</span>
<span class="udiff-line-removed">-             });</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             this._targetTouches = [];</span>
<span class="udiff-line-removed">-             let touches = event.touches;</span>
<span class="udiff-line-removed">-             for (let i = 0, count = touches.length; i &lt; count; ++i) {</span>
<span class="udiff-line-removed">-                 let touch = touches[i];</span>
<span class="udiff-line-removed">-                 if (targetIdentifiers.indexOf(touch.identifier) !== -1)</span>
<span class="udiff-line-removed">-                     this._targetTouches.push(touch);</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-modified-added">+         if (event.type === GestureRecognizer.Events.PointerMove) {</span>
<span class="udiff-line-modified-added">+             this._targetPointers.set(event.pointerId, event);</span>
              return;
          }
  
<span class="udiff-line-modified-removed">-         // With a touchend or touchcancel event, we only keep the existing touches</span>
<span class="udiff-line-removed">-         // that are also found in event.touches.</span>
<span class="udiff-line-removed">-         let allTouches = event.touches;</span>
<span class="udiff-line-removed">-         let existingIdentifiers = [];</span>
<span class="udiff-line-removed">-         for (let i = 0, count = allTouches.length; i &lt; count; ++i)</span>
<span class="udiff-line-removed">-             existingIdentifiers.push(allTouches[i].identifier);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         this._targetTouches = this._targetTouches.filter(function(touch) {</span>
<span class="udiff-line-removed">-             return existingIdentifiers.indexOf(touch.identifier) !== -1;</span>
<span class="udiff-line-removed">-         });</span>
<span class="udiff-line-modified-added">+         this._targetPointers.delete(event.pointerId);</span>
      }
  
      _updateKeyboardModifiers(event)
      {
          this.modifierKeys.alt = event.altKey;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -367,13 +320,13 @@</span>
      Failed     : &quot;failed&quot;,
      Recognized : &quot;ended&quot;
  };
  
  GestureRecognizer.Events = {
<span class="udiff-line-modified-removed">-     TouchStart     : GestureRecognizer.SupportsTouches ? &quot;touchstart&quot; : &quot;mousedown&quot;,</span>
<span class="udiff-line-modified-removed">-     TouchMove      : GestureRecognizer.SupportsTouches ? &quot;touchmove&quot; : &quot;mousemove&quot;,</span>
<span class="udiff-line-modified-removed">-     TouchEnd       : GestureRecognizer.SupportsTouches ? &quot;touchend&quot; : &quot;mouseup&quot;,</span>
<span class="udiff-line-modified-removed">-     TouchCancel    : &quot;touchcancel&quot;,</span>
<span class="udiff-line-modified-added">+     PointerDown    : &quot;pointerdown&quot;,</span>
<span class="udiff-line-modified-added">+     PointerMove    : &quot;pointermove&quot;,</span>
<span class="udiff-line-modified-added">+     PointerUp      : &quot;pointerup&quot;,</span>
<span class="udiff-line-modified-added">+     PointerCancel  : &quot;pointercancel&quot;,</span>
      GestureStart   : &quot;gesturestart&quot;,
      GestureChange  : &quot;gesturechange&quot;,
      GestureEnd     : &quot;gestureend&quot;
  };
</pre>
<center><a href="../controls/slider.js.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../media/pip-support.js.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>