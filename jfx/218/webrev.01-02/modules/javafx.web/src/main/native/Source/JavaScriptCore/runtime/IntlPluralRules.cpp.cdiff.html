<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.web/src/main/native/Source/JavaScriptCore/runtime/IntlPluralRules.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="IntlObjectInlines.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="IntlPluralRules.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/JavaScriptCore/runtime/IntlPluralRules.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,8 ***</span>
  /*
   * Copyright (C) 2018 Andy VanWagoner (andy@vanwagoner.family)
<span class="line-modified">!  * Copyright (C) 2019 Apple Inc. All rights reserved.</span>
   *
   * Redistribution and use in source and binary forms, with or without
   * modification, are permitted provided that the following conditions
   * are met:
   * 1. Redistributions of source code must retain the above copyright
<span class="line-new-header">--- 1,8 ---</span>
  /*
   * Copyright (C) 2018 Andy VanWagoner (andy@vanwagoner.family)
<span class="line-modified">!  * Copyright (C) 2019-2020 Apple Inc. All rights reserved.</span>
   *
   * Redistribution and use in source and binary forms, with or without
   * modification, are permitted provided that the following conditions
   * are met:
   * 1. Redistributions of source code must retain the above copyright
</pre>
<hr />
<pre>
<span class="line-old-header">*** 70,25 ***</span>
  {
      return Structure::create(vm, globalObject, prototype, TypeInfo(ObjectType, StructureFlags), info());
  }
  
  IntlPluralRules::IntlPluralRules(VM&amp; vm, Structure* structure)
<span class="line-modified">!     : JSDestructibleObject(vm, structure)</span>
  {
  }
  
  void IntlPluralRules::finishCreation(VM&amp; vm)
  {
      Base::finishCreation(vm);
      ASSERT(inherits(vm, info()));
  }
  
<span class="line-removed">- void IntlPluralRules::destroy(JSCell* cell)</span>
<span class="line-removed">- {</span>
<span class="line-removed">-     static_cast&lt;IntlPluralRules*&gt;(cell)-&gt;IntlPluralRules::~IntlPluralRules();</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
  void IntlPluralRules::visitChildren(JSCell* cell, SlotVisitor&amp; visitor)
  {
      IntlPluralRules* thisObject = jsCast&lt;IntlPluralRules*&gt;(cell);
      ASSERT_GC_OBJECT_INHERITS(thisObject, info());
  
<span class="line-new-header">--- 70,20 ---</span>
  {
      return Structure::create(vm, globalObject, prototype, TypeInfo(ObjectType, StructureFlags), info());
  }
  
  IntlPluralRules::IntlPluralRules(VM&amp; vm, Structure* structure)
<span class="line-modified">!     : Base(vm, structure)</span>
  {
  }
  
  void IntlPluralRules::finishCreation(VM&amp; vm)
  {
      Base::finishCreation(vm);
      ASSERT(inherits(vm, info()));
  }
  
  void IntlPluralRules::visitChildren(JSCell* cell, SlotVisitor&amp; visitor)
  {
      IntlPluralRules* thisObject = jsCast&lt;IntlPluralRules*&gt;(cell);
      ASSERT_GC_OBJECT_INHERITS(thisObject, info());
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 101,78 ***</span>
      Vector&lt;String&gt; data;
      return data;
  }
  }
  
<span class="line-modified">! void IntlPluralRules::initializePluralRules(ExecState&amp; exec, JSValue locales, JSValue optionsValue)</span>
  {
<span class="line-modified">!     VM&amp; vm = exec.vm();</span>
      auto scope = DECLARE_THROW_SCOPE(vm);
  
      // 13.1.1 InitializePluralRules (pluralRules, locales, options)
      // https://tc39.github.io/ecma402/#sec-initializepluralrules
<span class="line-modified">!     Vector&lt;String&gt; requestedLocales = canonicalizeLocaleList(exec, locales);</span>
      RETURN_IF_EXCEPTION(scope, void());
  
      JSObject* options;
      if (optionsValue.isUndefined())
<span class="line-modified">!         options = constructEmptyObject(&amp;exec, exec.lexicalGlobalObject()-&gt;nullPrototypeObjectStructure());</span>
      else {
<span class="line-modified">!         options = optionsValue.toObject(&amp;exec);</span>
          RETURN_IF_EXCEPTION(scope, void());
      }
  
      HashMap&lt;String, String&gt; localeOpt;
<span class="line-modified">!     String localeMatcher = intlStringOption(exec, options, vm.propertyNames-&gt;localeMatcher, { &quot;lookup&quot;, &quot;best fit&quot; }, &quot;localeMatcher must be either \&quot;lookup\&quot; or \&quot;best fit\&quot;&quot;, &quot;best fit&quot;);</span>
      RETURN_IF_EXCEPTION(scope, void());
      localeOpt.add(vm.propertyNames-&gt;localeMatcher.string(), localeMatcher);
  
<span class="line-modified">!     const HashSet&lt;String&gt; availableLocales = exec.jsCallee()-&gt;globalObject(vm)-&gt;intlNumberFormatAvailableLocales();</span>
<span class="line-modified">!     HashMap&lt;String, String&gt; resolved = resolveLocale(exec, availableLocales, requestedLocales, localeOpt, nullptr, 0, IntlPRInternal::localeData);</span>
      m_locale = resolved.get(vm.propertyNames-&gt;locale.string());
      if (m_locale.isEmpty()) {
<span class="line-modified">!         throwTypeError(&amp;exec, scope, &quot;failed to initialize PluralRules due to invalid locale&quot;_s);</span>
          return;
      }
  
<span class="line-modified">!     String typeString = intlStringOption(exec, options, Identifier::fromString(vm, &quot;type&quot;), { &quot;cardinal&quot;, &quot;ordinal&quot; }, &quot;type must be \&quot;cardinal\&quot; or \&quot;ordinal\&quot;&quot;, &quot;cardinal&quot;);</span>
      RETURN_IF_EXCEPTION(scope, void());
      m_type = typeString == &quot;ordinal&quot; ? UPLURAL_TYPE_ORDINAL : UPLURAL_TYPE_CARDINAL;
  
<span class="line-modified">!     unsigned minimumIntegerDigits = intlNumberOption(exec, options, Identifier::fromString(vm, &quot;minimumIntegerDigits&quot;), 1, 21, 1);</span>
      RETURN_IF_EXCEPTION(scope, void());
      m_minimumIntegerDigits = minimumIntegerDigits;
  
      unsigned minimumFractionDigitsDefault = 0;
<span class="line-modified">!     unsigned minimumFractionDigits = intlNumberOption(exec, options, Identifier::fromString(vm, &quot;minimumFractionDigits&quot;), 0, 20, minimumFractionDigitsDefault);</span>
      RETURN_IF_EXCEPTION(scope, void());
      m_minimumFractionDigits = minimumFractionDigits;
  
      unsigned maximumFractionDigitsDefault = std::max(minimumFractionDigits, 3u);
<span class="line-modified">!     unsigned maximumFractionDigits = intlNumberOption(exec, options, Identifier::fromString(vm, &quot;maximumFractionDigits&quot;), minimumFractionDigits, 20, maximumFractionDigitsDefault);</span>
      RETURN_IF_EXCEPTION(scope, void());
      m_maximumFractionDigits = maximumFractionDigits;
  
<span class="line-modified">!     JSValue minimumSignificantDigitsValue = options-&gt;get(&amp;exec, Identifier::fromString(vm, &quot;minimumSignificantDigits&quot;));</span>
      RETURN_IF_EXCEPTION(scope, void());
  
<span class="line-modified">!     JSValue maximumSignificantDigitsValue = options-&gt;get(&amp;exec, Identifier::fromString(vm, &quot;maximumSignificantDigits&quot;));</span>
      RETURN_IF_EXCEPTION(scope, void());
  
      if (!minimumSignificantDigitsValue.isUndefined() || !maximumSignificantDigitsValue.isUndefined()) {
<span class="line-modified">!         unsigned minimumSignificantDigits = intlNumberOption(exec, options, Identifier::fromString(vm, &quot;minimumSignificantDigits&quot;), 1, 21, 1);</span>
          RETURN_IF_EXCEPTION(scope, void());
<span class="line-modified">!         unsigned maximumSignificantDigits = intlNumberOption(exec, options, Identifier::fromString(vm, &quot;maximumSignificantDigits&quot;), minimumSignificantDigits, 21, 21);</span>
          RETURN_IF_EXCEPTION(scope, void());
          m_minimumSignificantDigits = minimumSignificantDigits;
          m_maximumSignificantDigits = maximumSignificantDigits;
      }
  
      UErrorCode status = U_ZERO_ERROR;
      m_numberFormat = std::unique_ptr&lt;UNumberFormat, UNumberFormatDeleter&gt;(unum_open(UNUM_DECIMAL, nullptr, 0, m_locale.utf8().data(), nullptr, &amp;status));
      if (U_FAILURE(status)) {
<span class="line-modified">!         throwTypeError(&amp;exec, scope, &quot;failed to initialize PluralRules&quot;_s);</span>
          return;
      }
  
      if (m_minimumSignificantDigits) {
          unum_setAttribute(m_numberFormat.get(), UNUM_SIGNIFICANT_DIGITS_USED, true);
<span class="line-new-header">--- 96,78 ---</span>
      Vector&lt;String&gt; data;
      return data;
  }
  }
  
<span class="line-modified">! void IntlPluralRules::initializePluralRules(JSGlobalObject* globalObject, JSValue locales, JSValue optionsValue)</span>
  {
<span class="line-modified">!     VM&amp; vm = globalObject-&gt;vm();</span>
      auto scope = DECLARE_THROW_SCOPE(vm);
  
      // 13.1.1 InitializePluralRules (pluralRules, locales, options)
      // https://tc39.github.io/ecma402/#sec-initializepluralrules
<span class="line-modified">!     Vector&lt;String&gt; requestedLocales = canonicalizeLocaleList(globalObject, locales);</span>
      RETURN_IF_EXCEPTION(scope, void());
  
      JSObject* options;
      if (optionsValue.isUndefined())
<span class="line-modified">!         options = constructEmptyObject(vm, globalObject-&gt;nullPrototypeObjectStructure());</span>
      else {
<span class="line-modified">!         options = optionsValue.toObject(globalObject);</span>
          RETURN_IF_EXCEPTION(scope, void());
      }
  
      HashMap&lt;String, String&gt; localeOpt;
<span class="line-modified">!     String localeMatcher = intlStringOption(globalObject, options, vm.propertyNames-&gt;localeMatcher, { &quot;lookup&quot;, &quot;best fit&quot; }, &quot;localeMatcher must be either \&quot;lookup\&quot; or \&quot;best fit\&quot;&quot;, &quot;best fit&quot;);</span>
      RETURN_IF_EXCEPTION(scope, void());
      localeOpt.add(vm.propertyNames-&gt;localeMatcher.string(), localeMatcher);
  
<span class="line-modified">!     const HashSet&lt;String&gt;&amp; availableLocales = intlPluralRulesAvailableLocales();</span>
<span class="line-modified">!     HashMap&lt;String, String&gt; resolved = resolveLocale(globalObject, availableLocales, requestedLocales, localeOpt, nullptr, 0, IntlPRInternal::localeData);</span>
      m_locale = resolved.get(vm.propertyNames-&gt;locale.string());
      if (m_locale.isEmpty()) {
<span class="line-modified">!         throwTypeError(globalObject, scope, &quot;failed to initialize PluralRules due to invalid locale&quot;_s);</span>
          return;
      }
  
<span class="line-modified">!     String typeString = intlStringOption(globalObject, options, Identifier::fromString(vm, &quot;type&quot;), { &quot;cardinal&quot;, &quot;ordinal&quot; }, &quot;type must be \&quot;cardinal\&quot; or \&quot;ordinal\&quot;&quot;, &quot;cardinal&quot;);</span>
      RETURN_IF_EXCEPTION(scope, void());
      m_type = typeString == &quot;ordinal&quot; ? UPLURAL_TYPE_ORDINAL : UPLURAL_TYPE_CARDINAL;
  
<span class="line-modified">!     unsigned minimumIntegerDigits = intlNumberOption(globalObject, options, Identifier::fromString(vm, &quot;minimumIntegerDigits&quot;), 1, 21, 1);</span>
      RETURN_IF_EXCEPTION(scope, void());
      m_minimumIntegerDigits = minimumIntegerDigits;
  
      unsigned minimumFractionDigitsDefault = 0;
<span class="line-modified">!     unsigned minimumFractionDigits = intlNumberOption(globalObject, options, Identifier::fromString(vm, &quot;minimumFractionDigits&quot;), 0, 20, minimumFractionDigitsDefault);</span>
      RETURN_IF_EXCEPTION(scope, void());
      m_minimumFractionDigits = minimumFractionDigits;
  
      unsigned maximumFractionDigitsDefault = std::max(minimumFractionDigits, 3u);
<span class="line-modified">!     unsigned maximumFractionDigits = intlNumberOption(globalObject, options, Identifier::fromString(vm, &quot;maximumFractionDigits&quot;), minimumFractionDigits, 20, maximumFractionDigitsDefault);</span>
      RETURN_IF_EXCEPTION(scope, void());
      m_maximumFractionDigits = maximumFractionDigits;
  
<span class="line-modified">!     JSValue minimumSignificantDigitsValue = options-&gt;get(globalObject, Identifier::fromString(vm, &quot;minimumSignificantDigits&quot;));</span>
      RETURN_IF_EXCEPTION(scope, void());
  
<span class="line-modified">!     JSValue maximumSignificantDigitsValue = options-&gt;get(globalObject, Identifier::fromString(vm, &quot;maximumSignificantDigits&quot;));</span>
      RETURN_IF_EXCEPTION(scope, void());
  
      if (!minimumSignificantDigitsValue.isUndefined() || !maximumSignificantDigitsValue.isUndefined()) {
<span class="line-modified">!         unsigned minimumSignificantDigits = intlNumberOption(globalObject, options, Identifier::fromString(vm, &quot;minimumSignificantDigits&quot;), 1, 21, 1);</span>
          RETURN_IF_EXCEPTION(scope, void());
<span class="line-modified">!         unsigned maximumSignificantDigits = intlNumberOption(globalObject, options, Identifier::fromString(vm, &quot;maximumSignificantDigits&quot;), minimumSignificantDigits, 21, 21);</span>
          RETURN_IF_EXCEPTION(scope, void());
          m_minimumSignificantDigits = minimumSignificantDigits;
          m_maximumSignificantDigits = maximumSignificantDigits;
      }
  
      UErrorCode status = U_ZERO_ERROR;
      m_numberFormat = std::unique_ptr&lt;UNumberFormat, UNumberFormatDeleter&gt;(unum_open(UNUM_DECIMAL, nullptr, 0, m_locale.utf8().data(), nullptr, &amp;status));
      if (U_FAILURE(status)) {
<span class="line-modified">!         throwTypeError(globalObject, scope, &quot;failed to initialize PluralRules&quot;_s);</span>
          return;
      }
  
      if (m_minimumSignificantDigits) {
          unum_setAttribute(m_numberFormat.get(), UNUM_SIGNIFICANT_DIGITS_USED, true);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 185,30 ***</span>
      }
  
      status = U_ZERO_ERROR;
      m_pluralRules = std::unique_ptr&lt;UPluralRules, UPluralRulesDeleter&gt;(uplrules_openForType(m_locale.utf8().data(), m_type, &amp;status));
      if (U_FAILURE(status)) {
<span class="line-modified">!         throwTypeError(&amp;exec, scope, &quot;failed to initialize PluralRules&quot;_s);</span>
          return;
      }
  
      m_initializedPluralRules = true;
  }
  
<span class="line-modified">! JSObject* IntlPluralRules::resolvedOptions(ExecState&amp; exec)</span>
  {
<span class="line-modified">!     VM&amp; vm = exec.vm();</span>
      auto scope = DECLARE_THROW_SCOPE(vm);
  
      // 13.4.4 Intl.PluralRules.prototype.resolvedOptions ()
      // https://tc39.github.io/ecma402/#sec-intl.pluralrules.prototype.resolvedoptions
      if (UNLIKELY(!m_initializedPluralRules)) {
<span class="line-modified">!         throwTypeError(&amp;exec, scope, &quot;Intl.PluralRules.prototype.resolvedOptions called on value that&#39;s not an object initialized as a PluralRules&quot;_s);</span>
          return nullptr;
      }
  
<span class="line-modified">!     JSObject* options = constructEmptyObject(&amp;exec);</span>
      options-&gt;putDirect(vm, vm.propertyNames-&gt;locale, jsNontrivialString(vm, m_locale));
      options-&gt;putDirect(vm, Identifier::fromString(vm, &quot;type&quot;), jsNontrivialString(vm, m_type == UPLURAL_TYPE_ORDINAL ? &quot;ordinal&quot;_s : &quot;cardinal&quot;_s));
      options-&gt;putDirect(vm, Identifier::fromString(vm, &quot;minimumIntegerDigits&quot;), jsNumber(m_minimumIntegerDigits));
      options-&gt;putDirect(vm, Identifier::fromString(vm, &quot;minimumFractionDigits&quot;), jsNumber(m_minimumFractionDigits));
      options-&gt;putDirect(vm, Identifier::fromString(vm, &quot;maximumFractionDigits&quot;), jsNumber(m_maximumFractionDigits));
<span class="line-new-header">--- 180,30 ---</span>
      }
  
      status = U_ZERO_ERROR;
      m_pluralRules = std::unique_ptr&lt;UPluralRules, UPluralRulesDeleter&gt;(uplrules_openForType(m_locale.utf8().data(), m_type, &amp;status));
      if (U_FAILURE(status)) {
<span class="line-modified">!         throwTypeError(globalObject, scope, &quot;failed to initialize PluralRules&quot;_s);</span>
          return;
      }
  
      m_initializedPluralRules = true;
  }
  
<span class="line-modified">! JSObject* IntlPluralRules::resolvedOptions(JSGlobalObject* globalObject)</span>
  {
<span class="line-modified">!     VM&amp; vm = globalObject-&gt;vm();</span>
      auto scope = DECLARE_THROW_SCOPE(vm);
  
      // 13.4.4 Intl.PluralRules.prototype.resolvedOptions ()
      // https://tc39.github.io/ecma402/#sec-intl.pluralrules.prototype.resolvedoptions
      if (UNLIKELY(!m_initializedPluralRules)) {
<span class="line-modified">!         throwTypeError(globalObject, scope, &quot;Intl.PluralRules.prototype.resolvedOptions called on value that&#39;s not an object initialized as a PluralRules&quot;_s);</span>
          return nullptr;
      }
  
<span class="line-modified">!     JSObject* options = constructEmptyObject(globalObject);</span>
      options-&gt;putDirect(vm, vm.propertyNames-&gt;locale, jsNontrivialString(vm, m_locale));
      options-&gt;putDirect(vm, Identifier::fromString(vm, &quot;type&quot;), jsNontrivialString(vm, m_type == UPLURAL_TYPE_ORDINAL ? &quot;ordinal&quot;_s : &quot;cardinal&quot;_s));
      options-&gt;putDirect(vm, Identifier::fromString(vm, &quot;minimumIntegerDigits&quot;), jsNumber(m_minimumIntegerDigits));
      options-&gt;putDirect(vm, Identifier::fromString(vm, &quot;minimumFractionDigits&quot;), jsNumber(m_minimumFractionDigits));
      options-&gt;putDirect(vm, Identifier::fromString(vm, &quot;maximumFractionDigits&quot;), jsNumber(m_maximumFractionDigits));
</pre>
<hr />
<pre>
<span class="line-old-header">*** 216,14 ***</span>
          options-&gt;putDirect(vm, Identifier::fromString(vm, &quot;minimumSignificantDigits&quot;), jsNumber(m_minimumSignificantDigits.value()));
          options-&gt;putDirect(vm, Identifier::fromString(vm, &quot;maximumSignificantDigits&quot;), jsNumber(m_maximumSignificantDigits.value()));
      }
  
  #if HAVE(ICU_PLURALRULES_KEYWORDS)
<span class="line-removed">-     JSGlobalObject* globalObject = exec.jsCallee()-&gt;globalObject(vm);</span>
      JSArray* categories = JSArray::tryCreate(vm, globalObject-&gt;arrayStructureForIndexingTypeDuringAllocation(ArrayWithContiguous), 0);
      if (UNLIKELY(!categories)) {
<span class="line-modified">!         throwOutOfMemoryError(&amp;exec, scope);</span>
          return nullptr;
      }
  
      UErrorCode status = U_ZERO_ERROR;
      auto keywords = std::unique_ptr&lt;UEnumeration, UEnumerationDeleter&gt;(uplrules_getKeywords(m_pluralRules.get(), &amp;status));
<span class="line-new-header">--- 211,13 ---</span>
          options-&gt;putDirect(vm, Identifier::fromString(vm, &quot;minimumSignificantDigits&quot;), jsNumber(m_minimumSignificantDigits.value()));
          options-&gt;putDirect(vm, Identifier::fromString(vm, &quot;maximumSignificantDigits&quot;), jsNumber(m_maximumSignificantDigits.value()));
      }
  
  #if HAVE(ICU_PLURALRULES_KEYWORDS)
      JSArray* categories = JSArray::tryCreate(vm, globalObject-&gt;arrayStructureForIndexingTypeDuringAllocation(ArrayWithContiguous), 0);
      if (UNLIKELY(!categories)) {
<span class="line-modified">!         throwOutOfMemoryError(globalObject, scope);</span>
          return nullptr;
      }
  
      UErrorCode status = U_ZERO_ERROR;
      auto keywords = std::unique_ptr&lt;UEnumeration, UEnumerationDeleter&gt;(uplrules_getKeywords(m_pluralRules.get(), &amp;status));
</pre>
<hr />
<pre>
<span class="line-old-header">*** 232,60 ***</span>
  
      // Category names are always ASCII, so use char[].
      unsigned index = 0;
      while (const char* result = uenum_next(keywords.get(), &amp;resultLength, &amp;status)) {
          ASSERT(U_SUCCESS(status));
<span class="line-modified">!         categories-&gt;putDirectIndex(&amp;exec, index++, jsNontrivialString(vm, String(result, resultLength)));</span>
          RETURN_IF_EXCEPTION(scope, { });
      }
      options-&gt;putDirect(vm, Identifier::fromString(vm, &quot;pluralCategories&quot;), categories);
  #endif
  
      RELEASE_AND_RETURN(scope, options);
  }
  
<span class="line-modified">! JSValue IntlPluralRules::select(ExecState&amp; exec, double value)</span>
  {
<span class="line-modified">!     VM&amp; vm = exec.vm();</span>
      auto scope = DECLARE_THROW_SCOPE(vm);
  
      // 13.1.4 ResolvePlural (pluralRules, n)
      // https://tc39.github.io/ecma402/#sec-resolveplural
      if (!m_initializedPluralRules)
<span class="line-modified">!         return throwTypeError(&amp;exec, scope, &quot;Intl.PluralRules.prototype.select called on value that&#39;s not an object initialized as a PluralRules&quot;_s);</span>
  
      if (!std::isfinite(value))
          return jsNontrivialString(vm, &quot;other&quot;_s);
  
  #if HAVE(ICU_PLURALRULES_WITH_FORMAT)
      UErrorCode status = U_ZERO_ERROR;
      Vector&lt;UChar, 8&gt; result(8);
      auto length = uplrules_selectWithFormat(m_pluralRules.get(), value, m_numberFormat.get(), result.data(), result.size(), &amp;status);
      if (U_FAILURE(status))
<span class="line-modified">!         return throwTypeError(&amp;exec, scope, &quot;failed to select plural value&quot;_s);</span>
  #else
      UErrorCode status = U_ZERO_ERROR;
      Vector&lt;UChar, 32&gt; buffer(32);
      auto length = unum_formatDouble(m_numberFormat.get(), value, buffer.data(), buffer.size(), nullptr, &amp;status);
      if (status == U_BUFFER_OVERFLOW_ERROR) {
          buffer.grow(length);
          status = U_ZERO_ERROR;
          unum_formatDouble(m_numberFormat.get(), value, buffer.data(), length, nullptr, &amp;status);
      }
      if (U_FAILURE(status))
<span class="line-modified">!         return throwTypeError(&amp;exec, scope, &quot;failed to select plural value&quot;_s);</span>
  
      double formatted = unum_parseDouble(m_numberFormat.get(), buffer.data(), length, nullptr, &amp;status);
      if (U_FAILURE(status))
<span class="line-modified">!         return throwTypeError(&amp;exec, scope, &quot;failed to select plural value&quot;_s);</span>
  
      // Can only be &#39;zero&#39;, &#39;one&#39;, &#39;two&#39;, &#39;few&#39;, &#39;many&#39; or &#39;other&#39;
      status = U_ZERO_ERROR;
      Vector&lt;UChar, 8&gt; result(8);
      length = uplrules_select(m_pluralRules.get(), formatted, result.data(), result.size(), &amp;status);
      if (U_FAILURE(status))
<span class="line-modified">!         return throwTypeError(&amp;exec, scope, &quot;failed to select plural value&quot;_s);</span>
  #endif
  
      return jsString(vm, String(result.data(), length));
  }
  
<span class="line-new-header">--- 226,60 ---</span>
  
      // Category names are always ASCII, so use char[].
      unsigned index = 0;
      while (const char* result = uenum_next(keywords.get(), &amp;resultLength, &amp;status)) {
          ASSERT(U_SUCCESS(status));
<span class="line-modified">!         categories-&gt;putDirectIndex(globalObject, index++, jsNontrivialString(vm, String(result, resultLength)));</span>
          RETURN_IF_EXCEPTION(scope, { });
      }
      options-&gt;putDirect(vm, Identifier::fromString(vm, &quot;pluralCategories&quot;), categories);
  #endif
  
      RELEASE_AND_RETURN(scope, options);
  }
  
<span class="line-modified">! JSValue IntlPluralRules::select(JSGlobalObject* globalObject, double value)</span>
  {
<span class="line-modified">!     VM&amp; vm = globalObject-&gt;vm();</span>
      auto scope = DECLARE_THROW_SCOPE(vm);
  
      // 13.1.4 ResolvePlural (pluralRules, n)
      // https://tc39.github.io/ecma402/#sec-resolveplural
      if (!m_initializedPluralRules)
<span class="line-modified">!         return throwTypeError(globalObject, scope, &quot;Intl.PluralRules.prototype.select called on value that&#39;s not an object initialized as a PluralRules&quot;_s);</span>
  
      if (!std::isfinite(value))
          return jsNontrivialString(vm, &quot;other&quot;_s);
  
  #if HAVE(ICU_PLURALRULES_WITH_FORMAT)
      UErrorCode status = U_ZERO_ERROR;
      Vector&lt;UChar, 8&gt; result(8);
      auto length = uplrules_selectWithFormat(m_pluralRules.get(), value, m_numberFormat.get(), result.data(), result.size(), &amp;status);
      if (U_FAILURE(status))
<span class="line-modified">!         return throwTypeError(globalObject, scope, &quot;failed to select plural value&quot;_s);</span>
  #else
      UErrorCode status = U_ZERO_ERROR;
      Vector&lt;UChar, 32&gt; buffer(32);
      auto length = unum_formatDouble(m_numberFormat.get(), value, buffer.data(), buffer.size(), nullptr, &amp;status);
      if (status == U_BUFFER_OVERFLOW_ERROR) {
          buffer.grow(length);
          status = U_ZERO_ERROR;
          unum_formatDouble(m_numberFormat.get(), value, buffer.data(), length, nullptr, &amp;status);
      }
      if (U_FAILURE(status))
<span class="line-modified">!         return throwTypeError(globalObject, scope, &quot;failed to select plural value&quot;_s);</span>
  
      double formatted = unum_parseDouble(m_numberFormat.get(), buffer.data(), length, nullptr, &amp;status);
      if (U_FAILURE(status))
<span class="line-modified">!         return throwTypeError(globalObject, scope, &quot;failed to select plural value&quot;_s);</span>
  
      // Can only be &#39;zero&#39;, &#39;one&#39;, &#39;two&#39;, &#39;few&#39;, &#39;many&#39; or &#39;other&#39;
      status = U_ZERO_ERROR;
      Vector&lt;UChar, 8&gt; result(8);
      length = uplrules_select(m_pluralRules.get(), formatted, result.data(), result.size(), &amp;status);
      if (U_FAILURE(status))
<span class="line-modified">!         return throwTypeError(globalObject, scope, &quot;failed to select plural value&quot;_s);</span>
  #endif
  
      return jsString(vm, String(result.data(), length));
  }
  
</pre>
<center><a href="IntlObjectInlines.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="IntlPluralRules.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>