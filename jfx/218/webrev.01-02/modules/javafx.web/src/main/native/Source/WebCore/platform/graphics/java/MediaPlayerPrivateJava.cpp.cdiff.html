<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.web/src/main/native/Source/WebCore/platform/graphics/java/MediaPlayerPrivateJava.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="ImageBufferJava.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="MediaPlayerPrivateJava.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/platform/graphics/java/MediaPlayerPrivateJava.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 70,39 ***</span>
      #include &lt;stdio.h&gt;
      #include &lt;wtf/Threading.h&gt;
  
      const char* networkStateStr(MediaPlayer::NetworkState networkState) {
          switch (networkState) {
<span class="line-modified">!         case MediaPlayer::Empty:</span>
              return &quot;Empty&quot;;
<span class="line-modified">!         case MediaPlayer::Idle:</span>
              return &quot;Idle&quot;;
<span class="line-modified">!         case MediaPlayer::Loading:</span>
              return &quot;Loading&quot;;
<span class="line-modified">!         case MediaPlayer::Loaded:</span>
              return &quot;Loaded&quot;;
<span class="line-modified">!         case MediaPlayer::FormatError:</span>
              return &quot;FormatError&quot;;
<span class="line-modified">!         case MediaPlayer::NetworkError:</span>
              return &quot;NetworkError&quot;;
<span class="line-modified">!         case MediaPlayer::DecodeError:</span>
              return &quot;DecodeError&quot;;
          }
          return &quot;&lt;unknown network state&gt;&quot;;
      }
  
      const char* readyStateStr(MediaPlayer::ReadyState readyState) {
          switch (readyState) {
<span class="line-modified">!         case MediaPlayer::HaveNothing:</span>
              return &quot;HaveNothing&quot;;
<span class="line-modified">!         case MediaPlayer::HaveMetadata:</span>
              return &quot;HaveMetadata&quot;;
<span class="line-modified">!         case MediaPlayer::HaveCurrentData:</span>
              return &quot;HaveCurrentData&quot;;
<span class="line-modified">!         case MediaPlayer::HaveFutureData:</span>
              return &quot;HaveFutureData&quot;;
<span class="line-modified">!         case MediaPlayer::HaveEnoughData:</span>
              return &quot;HaveEnoughData&quot;;
          }
          return &quot;&lt;unknown ready state&gt;&quot;;
      }
  
<span class="line-new-header">--- 70,39 ---</span>
      #include &lt;stdio.h&gt;
      #include &lt;wtf/Threading.h&gt;
  
      const char* networkStateStr(MediaPlayer::NetworkState networkState) {
          switch (networkState) {
<span class="line-modified">!         case MediaPlayer::NetworkState::Empty:</span>
              return &quot;Empty&quot;;
<span class="line-modified">!         case MediaPlayer::NetworkState::Idle:</span>
              return &quot;Idle&quot;;
<span class="line-modified">!         case MediaPlayer::NetworkState::Loading:</span>
              return &quot;Loading&quot;;
<span class="line-modified">!         case MediaPlayer::NetworkState::Loaded:</span>
              return &quot;Loaded&quot;;
<span class="line-modified">!         case MediaPlayer::NetworkState::FormatError:</span>
              return &quot;FormatError&quot;;
<span class="line-modified">!         case MediaPlayer::NetworkState::NetworkError:</span>
              return &quot;NetworkError&quot;;
<span class="line-modified">!         case MediaPlayer::NetworkState::DecodeError:</span>
              return &quot;DecodeError&quot;;
          }
          return &quot;&lt;unknown network state&gt;&quot;;
      }
  
      const char* readyStateStr(MediaPlayer::ReadyState readyState) {
          switch (readyState) {
<span class="line-modified">!         case MediaPlayer::ReadyState::HaveNothing:</span>
              return &quot;HaveNothing&quot;;
<span class="line-modified">!         case MediaPlayer::ReadyState::HaveMetadata:</span>
              return &quot;HaveMetadata&quot;;
<span class="line-modified">!         case MediaPlayer::ReadyState::HaveCurrentData:</span>
              return &quot;HaveCurrentData&quot;;
<span class="line-modified">!         case MediaPlayer::ReadyState::HaveFutureData:</span>
              return &quot;HaveFutureData&quot;;
<span class="line-modified">!         case MediaPlayer::ReadyState::HaveEnoughData:</span>
              return &quot;HaveEnoughData&quot;;
          }
          return &quot;&lt;unknown ready state&gt;&quot;;
      }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 161,26 ***</span>
  
  #endif
  
  ////////////////////////
  
  
  
  
  void MediaPlayerPrivate::registerMediaEngine(MediaEngineRegistrar registrar)
  {
      LOG_TRACE0(&quot;&gt;&gt;registerMediaEngine\n&quot;);
      JNIEnv* env = WTF::GetJavaEnv();
      jclass playerCls = PG_GetMediaPlayerClass(env);
      if (!playerCls) {
          LOG_ERROR0(&quot;&lt;&lt;registerMediaEngine ERROR: MediaPlayer class is unavailable\n&quot;);
          return;
      }
<span class="line-modified">!     //CreateMediaEnginePlayer, MediaEngineSupportedTypes, MediaEngineSupportsType,</span>
<span class="line-modified">!     //MediaEngineGetSitesInMediaCache, MediaEngineClearMediaCache, MediaEngineClearMediaCacheForSite</span>
<span class="line-removed">-     registrar([] (MediaPlayer* player) { return std::unique_ptr&lt;MediaPlayerPrivate&gt;(new MediaPlayerPrivate(player)); },</span>
<span class="line-removed">-         MediaEngineSupportedTypes, MediaEngineSupportsType, 0, 0, 0, 0);</span>
  }
  
  void MediaPlayerPrivate::MediaEngineSupportedTypes(HashSet&lt;String, ASCIICaseInsensitiveHash&gt;&amp; types)
  {
      LOG_TRACE0(&quot;&gt;&gt;MediaEngineSupportedTypes\n&quot;);
<span class="line-new-header">--- 161,41 ---</span>
  
  #endif
  
  ////////////////////////
  
<span class="line-added">+ class MediaPlayerFactoryJava final : public MediaPlayerFactory {</span>
<span class="line-added">+ private:</span>
<span class="line-added">+     MediaPlayerEnums::MediaEngineIdentifier identifier() const final { return MediaPlayerEnums::MediaEngineIdentifier::MediaFoundation; };</span>
  
<span class="line-added">+     std::unique_ptr&lt;MediaPlayerPrivateInterface&gt; createMediaEnginePlayer(MediaPlayer* player) const final</span>
<span class="line-added">+     {</span>
<span class="line-added">+         return makeUnique&lt;MediaPlayerPrivate&gt;(player);</span>
<span class="line-added">+     }</span>
  
<span class="line-added">+     void getSupportedTypes(HashSet&lt;String, ASCIICaseInsensitiveHash&gt;&amp; types) const final</span>
<span class="line-added">+     {</span>
<span class="line-added">+         return MediaPlayerPrivate::MediaEngineSupportedTypes(types);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     MediaPlayer::SupportsType supportsTypeAndCodecs(const MediaEngineSupportParameters&amp; parameters) const final</span>
<span class="line-added">+     {</span>
<span class="line-added">+         return MediaPlayerPrivate::MediaEngineSupportsType(parameters);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ };</span>
  
  void MediaPlayerPrivate::registerMediaEngine(MediaEngineRegistrar registrar)
  {
      LOG_TRACE0(&quot;&gt;&gt;registerMediaEngine\n&quot;);
      JNIEnv* env = WTF::GetJavaEnv();
      jclass playerCls = PG_GetMediaPlayerClass(env);
      if (!playerCls) {
          LOG_ERROR0(&quot;&lt;&lt;registerMediaEngine ERROR: MediaPlayer class is unavailable\n&quot;);
          return;
      }
<span class="line-modified">! </span>
<span class="line-modified">!     registrar(makeUnique&lt;MediaPlayerFactoryJava&gt;());</span>
  }
  
  void MediaPlayerPrivate::MediaEngineSupportedTypes(HashSet&lt;String, ASCIICaseInsensitiveHash&gt;&amp; types)
  {
      LOG_TRACE0(&quot;&gt;&gt;MediaEngineSupportedTypes\n&quot;);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 198,20 ***</span>
          LOG_TRACE2(&quot;&gt;&gt;MediaEngineSupportsType, type=%s, codecs=%s\n&quot;, parameters.type.raw().utf8().data(), codecValue.utf8().data());
      }
  
      if (parameters.type.isEmpty()) {
          LOG_TRACE0(&quot;&lt;&lt;MediaEngineSupportsType: NOT supported (type is empty)\n&quot;);
<span class="line-modified">!         return MediaPlayer::IsNotSupported;</span>
      }
  
      if (GetSupportedTypes().contains(parameters.type.containerType())) {
          LOG_TRACE0(&quot;&lt;&lt;MediaEngineSupportsType: MayBeSupported/IsSupported\n&quot;);
          auto codecs = parameters.type.parameter(ContentType::codecsParameter());
<span class="line-modified">!         return codecs.isEmpty() ? MediaPlayer::MayBeSupported : MediaPlayer::IsSupported;</span>
      }
      LOG_TRACE0(&quot;&lt;&lt;MediaEngineSupportsType: NOT supported\n&quot;);
<span class="line-modified">!     return MediaPlayer::IsNotSupported;</span>
  }
  
  HashSet&lt;String, ASCIICaseInsensitiveHash&gt;&amp; MediaPlayerPrivate::GetSupportedTypes()
  {
      static HashSet&lt;String, ASCIICaseInsensitiveHash&gt; supportedTypes;
<span class="line-new-header">--- 213,20 ---</span>
          LOG_TRACE2(&quot;&gt;&gt;MediaEngineSupportsType, type=%s, codecs=%s\n&quot;, parameters.type.raw().utf8().data(), codecValue.utf8().data());
      }
  
      if (parameters.type.isEmpty()) {
          LOG_TRACE0(&quot;&lt;&lt;MediaEngineSupportsType: NOT supported (type is empty)\n&quot;);
<span class="line-modified">!         return MediaPlayer::SupportsType::IsNotSupported;</span>
      }
  
      if (GetSupportedTypes().contains(parameters.type.containerType())) {
          LOG_TRACE0(&quot;&lt;&lt;MediaEngineSupportsType: MayBeSupported/IsSupported\n&quot;);
          auto codecs = parameters.type.parameter(ContentType::codecsParameter());
<span class="line-modified">!         return codecs.isEmpty() ? MediaPlayer::SupportsType::MayBeSupported : MediaPlayer::SupportsType::IsSupported;</span>
      }
      LOG_TRACE0(&quot;&lt;&lt;MediaEngineSupportsType: NOT supported\n&quot;);
<span class="line-modified">!     return MediaPlayer::SupportsType::IsNotSupported;</span>
  }
  
  HashSet&lt;String, ASCIICaseInsensitiveHash&gt;&amp; MediaPlayerPrivate::GetSupportedTypes()
  {
      static HashSet&lt;String, ASCIICaseInsensitiveHash&gt; supportedTypes;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 245,12 ***</span>
  // *********************************************************
  // MediaPlayerPrivate
  // *********************************************************
  MediaPlayerPrivate::MediaPlayerPrivate(MediaPlayer *player)
      : m_player(player)
<span class="line-modified">!     , m_networkState(MediaPlayer::Empty)</span>
<span class="line-modified">!     , m_readyState(MediaPlayer::HaveNothing)</span>
      , m_isVisible(false)
      , m_hasVideo(false)
      , m_hasAudio(false)
      , m_paused(true)
      , m_seeking(false)
<span class="line-new-header">--- 260,12 ---</span>
  // *********************************************************
  // MediaPlayerPrivate
  // *********************************************************
  MediaPlayerPrivate::MediaPlayerPrivate(MediaPlayer *player)
      : m_player(player)
<span class="line-modified">!     , m_networkState(MediaPlayer::NetworkState::Empty)</span>
<span class="line-modified">!     , m_readyState(MediaPlayer::ReadyState::HaveNothing)</span>
      , m_isVisible(false)
      , m_hasVideo(false)
      , m_hasAudio(false)
      , m_paused(true)
      , m_seeking(false)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 284,11 ***</span>
      WTF::CheckAndClearException(env);
  }
  
  void MediaPlayerPrivate::load(const String&amp; url)
  {
<span class="line-modified">!     if (m_networkState == MediaPlayer::Loading) {</span>
          cancelLoad();
      }
  
      String userAgent;
      // MediaPlayerClient mpClient = m_player-&gt;client();
<span class="line-new-header">--- 299,11 ---</span>
      WTF::CheckAndClearException(env);
  }
  
  void MediaPlayerPrivate::load(const String&amp; url)
  {
<span class="line-modified">!     if (m_networkState == MediaPlayer::NetworkState::Loading) {</span>
          cancelLoad();
      }
  
      String userAgent;
      // MediaPlayerClient mpClient = m_player-&gt;client();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 584,13 ***</span>
  void MediaPlayerPrivate::setPreload(MediaPlayer::Preload preload)
  {
      // enum Preload { None, MetaData, Auto };
      PLOG_TRACE1(&quot;MediaPlayerPrivate setPreload, preload=%u\n&quot;, (int)preload);
      jint jPreload =
<span class="line-modified">!         (preload == MediaPlayer::None) ? com_sun_webkit_graphics_WCMediaPlayer_PRELOAD_NONE</span>
<span class="line-modified">!         : (preload == MediaPlayer::MetaData) ? com_sun_webkit_graphics_WCMediaPlayer_PRELOAD_METADATA</span>
<span class="line-modified">!         : (preload == MediaPlayer::Auto) ? com_sun_webkit_graphics_WCMediaPlayer_PRELOAD_AUTO</span>
          : -1;
      if (jPreload &lt; 0) {
          // unexpected preload value
          return;
      }
<span class="line-new-header">--- 599,13 ---</span>
  void MediaPlayerPrivate::setPreload(MediaPlayer::Preload preload)
  {
      // enum Preload { None, MetaData, Auto };
      PLOG_TRACE1(&quot;MediaPlayerPrivate setPreload, preload=%u\n&quot;, (int)preload);
      jint jPreload =
<span class="line-modified">!         (preload == MediaPlayer::Preload::None) ? com_sun_webkit_graphics_WCMediaPlayer_PRELOAD_NONE</span>
<span class="line-modified">!         : (preload == MediaPlayer::Preload::MetaData) ? com_sun_webkit_graphics_WCMediaPlayer_PRELOAD_METADATA</span>
<span class="line-modified">!         : (preload == MediaPlayer::Preload::Auto) ? com_sun_webkit_graphics_WCMediaPlayer_PRELOAD_AUTO</span>
          : -1;
      if (jPreload &lt; 0) {
          // unexpected preload value
          return;
      }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 601,11 ***</span>
  
      env-&gt;CallVoidMethod(*m_jPlayer, s_mID, jPreload);
      WTF::CheckAndClearException(env);
  }
  
<span class="line-modified">! //bool MediaPlayerPrivate::hasAvailableVideoFrame() const { return readyState() &gt;= MediaPlayer::HaveCurrentData; }</span>
  
  //bool MediaPlayerPrivate::canLoadPoster() const { return false; }
  //void MediaPlayerPrivate::setPoster(const String&amp;) { }
  
  //#if ENABLE(PLUGIN_PROXY_FOR_VIDEO)
<span class="line-new-header">--- 616,11 ---</span>
  
      env-&gt;CallVoidMethod(*m_jPlayer, s_mID, jPreload);
      WTF::CheckAndClearException(env);
  }
  
<span class="line-modified">! //bool MediaPlayerPrivate::hasAvailableVideoFrame() const { return readyState() &gt;= MediaPlayer::ReadyState::HaveCurrentData; }</span>
  
  //bool MediaPlayerPrivate::canLoadPoster() const { return false; }
  //void MediaPlayerPrivate::setPoster(const String&amp;) { }
  
  //#if ENABLE(PLUGIN_PROXY_FOR_VIDEO)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 620,11 ***</span>
  //        virtual void acceleratedRenderingStateChanged() { }
  //#endif
  
  //bool MediaPlayerPrivate::hasSingleSecurityOrigin() const { return false; }
  
<span class="line-modified">! //MediaPlayer::MovieLoadType MediaPlayerPrivate::movieLoadType() const { return MediaPlayer::Unknown; }</span>
  
  void MediaPlayerPrivate::setNetworkState(MediaPlayer::NetworkState networkState)
  {
      if (m_networkState != networkState) {
          PLOG_TRACE4(&quot;MediaPlayerPrivate NetworkState: %s (%d) =&gt; %s (%d)\n&quot;,
<span class="line-new-header">--- 635,11 ---</span>
  //        virtual void acceleratedRenderingStateChanged() { }
  //#endif
  
  //bool MediaPlayerPrivate::hasSingleSecurityOrigin() const { return false; }
  
<span class="line-modified">! //MediaPlayer::MovieLoadType MediaPlayerPrivate::movieLoadType() const { return MediaPlayer::MovieLoadType::Unknown; }</span>
  
  void MediaPlayerPrivate::setNetworkState(MediaPlayer::NetworkState networkState)
  {
      if (m_networkState != networkState) {
          PLOG_TRACE4(&quot;MediaPlayerPrivate NetworkState: %s (%d) =&gt; %s (%d)\n&quot;,
</pre>
<hr />
<pre>
<span class="line-old-header">*** 652,50 ***</span>
  
  void MediaPlayerPrivate::notifyNetworkStateChanged(int networkState)
  {
      switch (networkState) {
      case com_sun_webkit_graphics_WCMediaPlayer_NETWORK_STATE_EMPTY:
<span class="line-modified">!         setNetworkState(MediaPlayer::Empty);</span>
          break;
      case com_sun_webkit_graphics_WCMediaPlayer_NETWORK_STATE_IDLE:
<span class="line-modified">!         setNetworkState(MediaPlayer::Idle);</span>
          break;
      case com_sun_webkit_graphics_WCMediaPlayer_NETWORK_STATE_LOADING:
<span class="line-modified">!         setNetworkState(MediaPlayer::Loading);</span>
          break;
      case com_sun_webkit_graphics_WCMediaPlayer_NETWORK_STATE_LOADED:
<span class="line-modified">!         setNetworkState(MediaPlayer::Loaded);</span>
          break;
      case com_sun_webkit_graphics_WCMediaPlayer_NETWORK_STATE_FORMAT_ERROR:
<span class="line-modified">!         setNetworkState(MediaPlayer::FormatError);</span>
          break;
      case com_sun_webkit_graphics_WCMediaPlayer_NETWORK_STATE_NETWORK_ERROR:
<span class="line-modified">!         setNetworkState(MediaPlayer::NetworkError);</span>
          break;
      case com_sun_webkit_graphics_WCMediaPlayer_NETWORK_STATE_DECODE_ERROR:
<span class="line-modified">!         setNetworkState(MediaPlayer::DecodeError);</span>
          break;
      }
  }
  
  void MediaPlayerPrivate::notifyReadyStateChanged(int readyState)
  {
      switch (readyState) {
      case com_sun_webkit_graphics_WCMediaPlayer_READY_STATE_HAVE_NOTHING:
<span class="line-modified">!         setReadyState(MediaPlayer::HaveNothing);</span>
          break;
      case com_sun_webkit_graphics_WCMediaPlayer_READY_STATE_HAVE_METADATA:
<span class="line-modified">!         setReadyState(MediaPlayer::HaveMetadata);</span>
          break;
      case com_sun_webkit_graphics_WCMediaPlayer_READY_STATE_HAVE_CURRENT_DATA:
<span class="line-modified">!         setReadyState(MediaPlayer::HaveCurrentData);</span>
          break;
      case com_sun_webkit_graphics_WCMediaPlayer_READY_STATE_HAVE_FUTURE_DATA:
<span class="line-modified">!         setReadyState(MediaPlayer::HaveFutureData);</span>
          break;
      case com_sun_webkit_graphics_WCMediaPlayer_READY_STATE_HAVE_ENOUGH_DATA:
<span class="line-modified">!         setReadyState(MediaPlayer::HaveEnoughData);</span>
          break;
      }
  }
  
  void MediaPlayerPrivate::notifyPaused(bool paused)
<span class="line-new-header">--- 667,50 ---</span>
  
  void MediaPlayerPrivate::notifyNetworkStateChanged(int networkState)
  {
      switch (networkState) {
      case com_sun_webkit_graphics_WCMediaPlayer_NETWORK_STATE_EMPTY:
<span class="line-modified">!         setNetworkState(MediaPlayer::NetworkState::Empty);</span>
          break;
      case com_sun_webkit_graphics_WCMediaPlayer_NETWORK_STATE_IDLE:
<span class="line-modified">!         setNetworkState(MediaPlayer::NetworkState::Idle);</span>
          break;
      case com_sun_webkit_graphics_WCMediaPlayer_NETWORK_STATE_LOADING:
<span class="line-modified">!         setNetworkState(MediaPlayer::NetworkState::Loading);</span>
          break;
      case com_sun_webkit_graphics_WCMediaPlayer_NETWORK_STATE_LOADED:
<span class="line-modified">!         setNetworkState(MediaPlayer::NetworkState::Loaded);</span>
          break;
      case com_sun_webkit_graphics_WCMediaPlayer_NETWORK_STATE_FORMAT_ERROR:
<span class="line-modified">!         setNetworkState(MediaPlayer::NetworkState::FormatError);</span>
          break;
      case com_sun_webkit_graphics_WCMediaPlayer_NETWORK_STATE_NETWORK_ERROR:
<span class="line-modified">!         setNetworkState(MediaPlayer::NetworkState::NetworkError);</span>
          break;
      case com_sun_webkit_graphics_WCMediaPlayer_NETWORK_STATE_DECODE_ERROR:
<span class="line-modified">!         setNetworkState(MediaPlayer::NetworkState::DecodeError);</span>
          break;
      }
  }
  
  void MediaPlayerPrivate::notifyReadyStateChanged(int readyState)
  {
      switch (readyState) {
      case com_sun_webkit_graphics_WCMediaPlayer_READY_STATE_HAVE_NOTHING:
<span class="line-modified">!         setReadyState(MediaPlayer::ReadyState::HaveNothing);</span>
          break;
      case com_sun_webkit_graphics_WCMediaPlayer_READY_STATE_HAVE_METADATA:
<span class="line-modified">!         setReadyState(MediaPlayer::ReadyState::HaveMetadata);</span>
          break;
      case com_sun_webkit_graphics_WCMediaPlayer_READY_STATE_HAVE_CURRENT_DATA:
<span class="line-modified">!         setReadyState(MediaPlayer::ReadyState::HaveCurrentData);</span>
          break;
      case com_sun_webkit_graphics_WCMediaPlayer_READY_STATE_HAVE_FUTURE_DATA:
<span class="line-modified">!         setReadyState(MediaPlayer::ReadyState::HaveFutureData);</span>
          break;
      case com_sun_webkit_graphics_WCMediaPlayer_READY_STATE_HAVE_ENOUGH_DATA:
<span class="line-modified">!         setReadyState(MediaPlayer::ReadyState::HaveEnoughData);</span>
          break;
      }
  }
  
  void MediaPlayerPrivate::notifyPaused(bool paused)
</pre>
<center><a href="ImageBufferJava.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="MediaPlayerPrivateJava.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>