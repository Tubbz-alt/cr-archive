<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/WebCore/platform/graphics/FontCascadeFonts.h</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (C) 2006, 2010, 2013-2015 Apple Inc. All rights reserved.
  3  *
  4  * This library is free software; you can redistribute it and/or
  5  * modify it under the terms of the GNU Library General Public
  6  * License as published by the Free Software Foundation; either
  7  * version 2 of the License, or (at your option) any later version.
  8  *
  9  * This library is distributed in the hope that it will be useful,
 10  * but WITHOUT ANY WARRANTY; without even the implied warranty of
 11  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 12  * Library General Public License for more details.
 13  *
 14  * You should have received a copy of the GNU Library General Public License
 15  * along with this library; see the file COPYING.LIB.  If not, write to
 16  * the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
 17  * Boston, MA 02110-1301, USA.
 18  *
 19  */
 20 
 21 #ifndef FontCascadeFonts_h
 22 #define FontCascadeFonts_h
 23 
 24 #include &quot;Font.h&quot;
 25 #include &quot;FontRanges.h&quot;
 26 #include &quot;FontSelector.h&quot;
 27 #include &quot;GlyphPage.h&quot;
 28 #include &quot;WidthCache.h&quot;
 29 #include &lt;wtf/Forward.h&gt;
 30 #include &lt;wtf/MainThread.h&gt;
 31 
 32 #if PLATFORM(IOS_FAMILY)
 33 #include &quot;WebCoreThread.h&quot;
 34 #endif
 35 
 36 namespace WebCore {
 37 
 38 class FontCascadeDescription;
 39 class FontPlatformData;
 40 class FontSelector;
 41 class GraphicsContext;
 42 class IntRect;
 43 class MixedFontGlyphPage;
 44 
<a name="1" id="anc1"></a>
 45 class FontCascadeFonts : public RefCounted&lt;FontCascadeFonts&gt; {
 46     WTF_MAKE_NONCOPYABLE(FontCascadeFonts);
<a name="2" id="anc2"></a>
 47 public:
 48     static Ref&lt;FontCascadeFonts&gt; create(RefPtr&lt;FontSelector&gt;&amp;&amp; fontSelector) { return adoptRef(*new FontCascadeFonts(WTFMove(fontSelector))); }
 49     static Ref&lt;FontCascadeFonts&gt; createForPlatformFont(const FontPlatformData&amp; platformData) { return adoptRef(*new FontCascadeFonts(platformData)); }
 50 
 51     WEBCORE_EXPORT ~FontCascadeFonts();
 52 
 53     bool isForPlatformFont() const { return m_isForPlatformFont; }
 54 
 55     GlyphData glyphDataForCharacter(UChar32, const FontCascadeDescription&amp;, FontVariant);
 56 
 57     bool isFixedPitch(const FontCascadeDescription&amp;);
 58     void determinePitch(const FontCascadeDescription&amp;);
 59 
 60     bool isLoadingCustomFonts() const;
 61 
 62     FontSelector* fontSelector() { return m_fontSelector.get(); }
 63     // FIXME: It should be possible to combine fontSelectorVersion and generation.
 64     unsigned fontSelectorVersion() const { return m_fontSelectorVersion; }
 65     unsigned generation() const { return m_generation; }
 66 
 67     WidthCache&amp; widthCache() { return m_widthCache; }
 68     const WidthCache&amp; widthCache() const { return m_widthCache; }
 69 
 70     const Font&amp; primaryFont(const FontCascadeDescription&amp;);
 71     WEBCORE_EXPORT const FontRanges&amp; realizeFallbackRangesAt(const FontCascadeDescription&amp;, unsigned fallbackIndex);
 72 
 73     void pruneSystemFallbacks();
 74 
 75 private:
 76     FontCascadeFonts(RefPtr&lt;FontSelector&gt;&amp;&amp;);
 77     FontCascadeFonts(const FontPlatformData&amp;);
 78 
 79     GlyphData glyphDataForSystemFallback(UChar32, const FontCascadeDescription&amp;, FontVariant, bool systemFallbackShouldBeInvisible);
 80     GlyphData glyphDataForVariant(UChar32, const FontCascadeDescription&amp;, FontVariant, unsigned fallbackIndex = 0);
 81 
 82     Vector&lt;FontRanges, 1&gt; m_realizedFallbackRanges;
 83     unsigned m_lastRealizedFallbackIndex { 0 };
 84 
 85     class GlyphPageCacheEntry {
 86     public:
 87         GlyphData glyphDataForCharacter(UChar32);
 88 
 89         void setSingleFontPage(RefPtr&lt;GlyphPage&gt;&amp;&amp;);
 90         void setGlyphDataForCharacter(UChar32, GlyphData);
 91 
 92         bool isNull() const { return !m_singleFont &amp;&amp; !m_mixedFont; }
 93         bool isMixedFont() const { return !!m_mixedFont; }
 94 
 95     private:
 96         // Only one of these is non-null.
 97         RefPtr&lt;GlyphPage&gt; m_singleFont;
 98         std::unique_ptr&lt;MixedFontGlyphPage&gt; m_mixedFont;
 99     };
100 
101     GlyphPageCacheEntry m_cachedPageZero;
102     HashMap&lt;int, GlyphPageCacheEntry&gt; m_cachedPages;
103 
104     HashSet&lt;RefPtr&lt;Font&gt;&gt; m_systemFallbackFontSet;
105 
106     const Font* m_cachedPrimaryFont;
107     RefPtr&lt;FontSelector&gt; m_fontSelector;
108 
109     WidthCache m_widthCache;
110 
111     unsigned m_fontSelectorVersion;
112     unsigned short m_generation;
113     Pitch m_pitch { UnknownPitch };
114     bool m_isForPlatformFont { false };
115 };
116 
117 inline bool FontCascadeFonts::isFixedPitch(const FontCascadeDescription&amp; description)
118 {
119     if (m_pitch == UnknownPitch)
120         determinePitch(description);
121     return m_pitch == FixedPitch;
122 };
123 
124 inline const Font&amp; FontCascadeFonts::primaryFont(const FontCascadeDescription&amp; description)
125 {
126     ASSERT(isMainThread());
127     if (!m_cachedPrimaryFont) {
128         auto&amp; primaryRanges = realizeFallbackRangesAt(description, 0);
129         m_cachedPrimaryFont = primaryRanges.glyphDataForCharacter(&#39; &#39;, ExternalResourceDownloadPolicy::Allow).font;
130         if (!m_cachedPrimaryFont)
131             m_cachedPrimaryFont = &amp;primaryRanges.fontForFirstRange();
132         else if (m_cachedPrimaryFont-&gt;isInterstitial()) {
133             for (unsigned index = 1; ; ++index) {
134                 auto&amp; localRanges = realizeFallbackRangesAt(description, index);
135                 if (localRanges.isNull())
136                     break;
137                 auto* font = localRanges.glyphDataForCharacter(&#39; &#39;, ExternalResourceDownloadPolicy::Forbid).font;
138                 if (font &amp;&amp; !font-&gt;isInterstitial()) {
139                     m_cachedPrimaryFont = font;
140                     break;
141                 }
142             }
143         }
144     }
145     return *m_cachedPrimaryFont;
146 }
147 
148 }
149 
150 #endif
<a name="3" id="anc3"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="3" type="hidden" />
</body>
</html>