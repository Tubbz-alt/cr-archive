<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.web/src/main/native/Source/WebCore/Modules/indexeddb/server/UniqueIDBDatabaseTransaction.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="UniqueIDBDatabaseConnection.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="UniqueIDBDatabaseTransaction.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/Modules/indexeddb/server/UniqueIDBDatabaseTransaction.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 26,11 ***</span>
  #include &quot;config.h&quot;
  #include &quot;UniqueIDBDatabaseTransaction.h&quot;
  
  #if ENABLE(INDEXED_DATABASE)
  
<span class="line-removed">- #include &quot;IDBError.h&quot;</span>
  #include &quot;IDBIterateCursorData.h&quot;
  #include &quot;IDBResultData.h&quot;
  #include &quot;IDBServer.h&quot;
  #include &quot;Logging.h&quot;
  #include &quot;UniqueIDBDatabase.h&quot;
<span class="line-new-header">--- 26,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 42,30 ***</span>
  {
      return adoptRef(*new UniqueIDBDatabaseTransaction(connection, info));
  }
  
  UniqueIDBDatabaseTransaction::UniqueIDBDatabaseTransaction(UniqueIDBDatabaseConnection&amp; connection, const IDBTransactionInfo&amp; info)
<span class="line-modified">!     : m_databaseConnection(connection)</span>
      , m_transactionInfo(info)
  {
      auto database = m_databaseConnection-&gt;database();
      ASSERT(database);
  
      if (m_transactionInfo.mode() == IDBTransactionMode::Versionchange)
          m_originalDatabaseInfo = makeUnique&lt;IDBDatabaseInfo&gt;(database-&gt;info());
  
<span class="line-modified">!     if (auto* server = m_databaseConnection-&gt;server())</span>
<span class="line-removed">-         server-&gt;registerTransaction(*this);</span>
  }
  
  UniqueIDBDatabaseTransaction::~UniqueIDBDatabaseTransaction()
  {
<span class="line-modified">!     if (auto database = m_databaseConnection-&gt;database())</span>
<span class="line-removed">-         database-&gt;transactionDestroyed(*this);</span>
<span class="line-removed">- </span>
<span class="line-removed">-     if (auto* server = m_databaseConnection-&gt;server())</span>
<span class="line-removed">-         server-&gt;unregisterTransaction(*this);</span>
  }
  
  IDBDatabaseInfo* UniqueIDBDatabaseTransaction::originalDatabaseInfo() const
  {
      ASSERT(m_transactionInfo.mode() == IDBTransactionMode::Versionchange);
<span class="line-new-header">--- 41,25 ---</span>
  {
      return adoptRef(*new UniqueIDBDatabaseTransaction(connection, info));
  }
  
  UniqueIDBDatabaseTransaction::UniqueIDBDatabaseTransaction(UniqueIDBDatabaseConnection&amp; connection, const IDBTransactionInfo&amp; info)
<span class="line-modified">!     : m_databaseConnection(&amp;connection)</span>
      , m_transactionInfo(info)
  {
      auto database = m_databaseConnection-&gt;database();
      ASSERT(database);
  
      if (m_transactionInfo.mode() == IDBTransactionMode::Versionchange)
          m_originalDatabaseInfo = makeUnique&lt;IDBDatabaseInfo&gt;(database-&gt;info());
  
<span class="line-modified">!     m_databaseConnection-&gt;server()-&gt;registerTransaction(*this);</span>
  }
  
  UniqueIDBDatabaseTransaction::~UniqueIDBDatabaseTransaction()
  {
<span class="line-modified">!     m_databaseConnection-&gt;server()-&gt;unregisterTransaction(*this);</span>
  }
  
  IDBDatabaseInfo* UniqueIDBDatabaseTransaction::originalDatabaseInfo() const
  {
      ASSERT(m_transactionInfo.mode() == IDBTransactionMode::Versionchange);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 74,17 ***</span>
  
  void UniqueIDBDatabaseTransaction::abort()
  {
      LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::abort&quot;);
  
<span class="line-removed">-     RefPtr&lt;UniqueIDBDatabaseTransaction&gt; protectedThis(this);</span>
<span class="line-removed">- </span>
      auto database = m_databaseConnection-&gt;database();
      ASSERT(database);
  
<span class="line-modified">!     database-&gt;abortTransaction(*this, UniqueIDBDatabase::WaitForPendingTasks::Yes, [this, protectedThis](const IDBError&amp; error) {</span>
          LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::abort (callback)&quot;);
          m_databaseConnection-&gt;didAbortTransaction(*this, error);
      });
  }
  
  void UniqueIDBDatabaseTransaction::abortWithoutCallback()
<span class="line-new-header">--- 68,16 ---</span>
  
  void UniqueIDBDatabaseTransaction::abort()
  {
      LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::abort&quot;);
  
      auto database = m_databaseConnection-&gt;database();
      ASSERT(database);
  
<span class="line-modified">!     database-&gt;abortTransaction(*this, [this](auto&amp; error) {</span>
          LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::abort (callback)&quot;);
<span class="line-added">+ </span>
          m_databaseConnection-&gt;didAbortTransaction(*this, error);
      });
  }
  
  void UniqueIDBDatabaseTransaction::abortWithoutCallback()
</pre>
<hr />
<pre>
<span class="line-old-header">*** 106,18 ***</span>
  
  void UniqueIDBDatabaseTransaction::commit()
  {
      LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::commit&quot;);
  
<span class="line-removed">-     RefPtr&lt;UniqueIDBDatabaseTransaction&gt; protectedThis(this);</span>
<span class="line-removed">- </span>
      auto database = m_databaseConnection-&gt;database();
<span class="line-removed">-     if (!database || database-&gt;hardClosedForUserDelete())</span>
<span class="line-removed">-         return;</span>
  
<span class="line-modified">!     database-&gt;commitTransaction(*this, [this, protectedThis](const IDBError&amp; error) {</span>
          LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::commit (callback)&quot;);
          m_databaseConnection-&gt;didCommitTransaction(*this, error);
      });
  }
  
  void UniqueIDBDatabaseTransaction::createObjectStore(const IDBRequestData&amp; requestData, const IDBObjectStoreInfo&amp; info)
<span class="line-new-header">--- 99,15 ---</span>
  
  void UniqueIDBDatabaseTransaction::commit()
  {
      LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::commit&quot;);
  
      auto database = m_databaseConnection-&gt;database();
  
<span class="line-modified">!     database-&gt;commitTransaction(*this, [this](auto&amp; error) {</span>
          LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::commit (callback)&quot;);
<span class="line-added">+ </span>
          m_databaseConnection-&gt;didCommitTransaction(*this, error);
      });
  }
  
  void UniqueIDBDatabaseTransaction::createObjectStore(const IDBRequestData&amp; requestData, const IDBObjectStoreInfo&amp; info)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 125,17 ***</span>
      LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::createObjectStore&quot;);
  
      ASSERT(isVersionChange());
      ASSERT(m_transactionInfo.identifier() == requestData.transactionIdentifier());
  
<span class="line-removed">-     RefPtr&lt;UniqueIDBDatabaseTransaction&gt; protectedThis(this);</span>
<span class="line-removed">- </span>
      auto database = m_databaseConnection-&gt;database();
      ASSERT(database);
  
<span class="line-modified">!     database-&gt;createObjectStore(*this, info, [this, protectedThis, requestData](const IDBError&amp; error) {</span>
          LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::createObjectStore (callback)&quot;);
          if (error.isNull())
              m_databaseConnection-&gt;didCreateObjectStore(IDBResultData::createObjectStoreSuccess(requestData.requestIdentifier()));
          else
              m_databaseConnection-&gt;didCreateObjectStore(IDBResultData::error(requestData.requestIdentifier(), error));
      });
<span class="line-new-header">--- 115,16 ---</span>
      LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::createObjectStore&quot;);
  
      ASSERT(isVersionChange());
      ASSERT(m_transactionInfo.identifier() == requestData.transactionIdentifier());
  
      auto database = m_databaseConnection-&gt;database();
      ASSERT(database);
  
<span class="line-modified">!     database-&gt;createObjectStore(*this, info, [this, requestData](auto&amp; error) {</span>
          LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::createObjectStore (callback)&quot;);
<span class="line-added">+ </span>
          if (error.isNull())
              m_databaseConnection-&gt;didCreateObjectStore(IDBResultData::createObjectStoreSuccess(requestData.requestIdentifier()));
          else
              m_databaseConnection-&gt;didCreateObjectStore(IDBResultData::error(requestData.requestIdentifier(), error));
      });
</pre>
<hr />
<pre>
<span class="line-old-header">*** 146,17 ***</span>
      LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::deleteObjectStore&quot;);
  
      ASSERT(isVersionChange());
      ASSERT(m_transactionInfo.identifier() == requestData.transactionIdentifier());
  
<span class="line-removed">-     RefPtr&lt;UniqueIDBDatabaseTransaction&gt; protectedThis(this);</span>
<span class="line-removed">- </span>
      auto database = m_databaseConnection-&gt;database();
      ASSERT(database);
  
<span class="line-modified">!     database-&gt;deleteObjectStore(*this, objectStoreName, [this, protectedThis, requestData](const IDBError&amp; error) {</span>
          LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::deleteObjectStore (callback)&quot;);
          if (error.isNull())
              m_databaseConnection-&gt;didDeleteObjectStore(IDBResultData::deleteObjectStoreSuccess(requestData.requestIdentifier()));
          else
              m_databaseConnection-&gt;didDeleteObjectStore(IDBResultData::error(requestData.requestIdentifier(), error));
      });
<span class="line-new-header">--- 135,16 ---</span>
      LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::deleteObjectStore&quot;);
  
      ASSERT(isVersionChange());
      ASSERT(m_transactionInfo.identifier() == requestData.transactionIdentifier());
  
      auto database = m_databaseConnection-&gt;database();
      ASSERT(database);
  
<span class="line-modified">!     database-&gt;deleteObjectStore(*this, objectStoreName, [this, requestData](const IDBError&amp; error) {</span>
          LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::deleteObjectStore (callback)&quot;);
<span class="line-added">+ </span>
          if (error.isNull())
              m_databaseConnection-&gt;didDeleteObjectStore(IDBResultData::deleteObjectStoreSuccess(requestData.requestIdentifier()));
          else
              m_databaseConnection-&gt;didDeleteObjectStore(IDBResultData::error(requestData.requestIdentifier(), error));
      });
</pre>
<hr />
<pre>
<span class="line-old-header">*** 167,17 ***</span>
      LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::renameObjectStore&quot;);
  
      ASSERT(isVersionChange());
      ASSERT(m_transactionInfo.identifier() == requestData.transactionIdentifier());
  
<span class="line-removed">-     RefPtr&lt;UniqueIDBDatabaseTransaction&gt; protectedThis(this);</span>
<span class="line-removed">- </span>
      auto database = m_databaseConnection-&gt;database();
      ASSERT(database);
  
<span class="line-modified">!     database-&gt;renameObjectStore(*this, objectStoreIdentifier, newName, [this, protectedThis, requestData](const IDBError&amp; error) {</span>
          LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::renameObjectStore (callback)&quot;);
          if (error.isNull())
              m_databaseConnection-&gt;didRenameObjectStore(IDBResultData::renameObjectStoreSuccess(requestData.requestIdentifier()));
          else
              m_databaseConnection-&gt;didRenameObjectStore(IDBResultData::error(requestData.requestIdentifier(), error));
      });
<span class="line-new-header">--- 155,16 ---</span>
      LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::renameObjectStore&quot;);
  
      ASSERT(isVersionChange());
      ASSERT(m_transactionInfo.identifier() == requestData.transactionIdentifier());
  
      auto database = m_databaseConnection-&gt;database();
      ASSERT(database);
  
<span class="line-modified">!     database-&gt;renameObjectStore(*this, objectStoreIdentifier, newName, [this, requestData](auto&amp; error) {</span>
          LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::renameObjectStore (callback)&quot;);
<span class="line-added">+ </span>
          if (error.isNull())
              m_databaseConnection-&gt;didRenameObjectStore(IDBResultData::renameObjectStoreSuccess(requestData.requestIdentifier()));
          else
              m_databaseConnection-&gt;didRenameObjectStore(IDBResultData::error(requestData.requestIdentifier(), error));
      });
</pre>
<hr />
<pre>
<span class="line-old-header">*** 187,17 ***</span>
  {
      LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::clearObjectStore&quot;);
  
      ASSERT(m_transactionInfo.identifier() == requestData.transactionIdentifier());
  
<span class="line-removed">-     RefPtr&lt;UniqueIDBDatabaseTransaction&gt; protectedThis(this);</span>
<span class="line-removed">- </span>
      auto database = m_databaseConnection-&gt;database();
      ASSERT(database);
  
<span class="line-modified">!     database-&gt;clearObjectStore(*this, objectStoreIdentifier, [this, protectedThis, requestData](const IDBError&amp; error) {</span>
          LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::clearObjectStore (callback)&quot;);
          if (error.isNull())
              m_databaseConnection-&gt;didClearObjectStore(IDBResultData::clearObjectStoreSuccess(requestData.requestIdentifier()));
          else
              m_databaseConnection-&gt;didClearObjectStore(IDBResultData::error(requestData.requestIdentifier(), error));
      });
<span class="line-new-header">--- 174,16 ---</span>
  {
      LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::clearObjectStore&quot;);
  
      ASSERT(m_transactionInfo.identifier() == requestData.transactionIdentifier());
  
      auto database = m_databaseConnection-&gt;database();
      ASSERT(database);
  
<span class="line-modified">!     database-&gt;clearObjectStore(*this, objectStoreIdentifier, [this, requestData](auto&amp; error) {</span>
          LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::clearObjectStore (callback)&quot;);
<span class="line-added">+ </span>
          if (error.isNull())
              m_databaseConnection-&gt;didClearObjectStore(IDBResultData::clearObjectStoreSuccess(requestData.requestIdentifier()));
          else
              m_databaseConnection-&gt;didClearObjectStore(IDBResultData::error(requestData.requestIdentifier(), error));
      });
</pre>
<hr />
<pre>
<span class="line-old-header">*** 208,17 ***</span>
      LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::createIndex&quot;);
  
      ASSERT(isVersionChange());
      ASSERT(m_transactionInfo.identifier() == requestData.transactionIdentifier());
  
<span class="line-removed">-     RefPtr&lt;UniqueIDBDatabaseTransaction&gt; protectedThis(this);</span>
<span class="line-removed">- </span>
      auto database = m_databaseConnection-&gt;database();
      ASSERT(database);
  
<span class="line-modified">!     database-&gt;createIndex(*this, info, [this, protectedThis, requestData](const IDBError&amp; error) {</span>
          LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::createIndex (callback)&quot;);
          if (error.isNull())
              m_databaseConnection-&gt;didCreateIndex(IDBResultData::createIndexSuccess(requestData.requestIdentifier()));
          else
              m_databaseConnection-&gt;didCreateIndex(IDBResultData::error(requestData.requestIdentifier(), error));
      });
<span class="line-new-header">--- 194,16 ---</span>
      LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::createIndex&quot;);
  
      ASSERT(isVersionChange());
      ASSERT(m_transactionInfo.identifier() == requestData.transactionIdentifier());
  
      auto database = m_databaseConnection-&gt;database();
      ASSERT(database);
  
<span class="line-modified">!     database-&gt;createIndex(*this, info, [this, requestData](auto&amp; error) {</span>
          LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::createIndex (callback)&quot;);
<span class="line-added">+ </span>
          if (error.isNull())
              m_databaseConnection-&gt;didCreateIndex(IDBResultData::createIndexSuccess(requestData.requestIdentifier()));
          else
              m_databaseConnection-&gt;didCreateIndex(IDBResultData::error(requestData.requestIdentifier(), error));
      });
</pre>
<hr />
<pre>
<span class="line-old-header">*** 229,17 ***</span>
      LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::deleteIndex&quot;);
  
      ASSERT(isVersionChange());
      ASSERT(m_transactionInfo.identifier() == requestData.transactionIdentifier());
  
<span class="line-removed">-     RefPtr&lt;UniqueIDBDatabaseTransaction&gt; protectedThis(this);</span>
<span class="line-removed">- </span>
      auto database = m_databaseConnection-&gt;database();
      ASSERT(database);
  
<span class="line-modified">!     database-&gt;deleteIndex(*this, objectStoreIdentifier, indexName, [this, protectedThis, requestData](const IDBError&amp; error) {</span>
          LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::createIndex (callback)&quot;);
          if (error.isNull())
              m_databaseConnection-&gt;didDeleteIndex(IDBResultData::deleteIndexSuccess(requestData.requestIdentifier()));
          else
              m_databaseConnection-&gt;didDeleteIndex(IDBResultData::error(requestData.requestIdentifier(), error));
      });
<span class="line-new-header">--- 214,16 ---</span>
      LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::deleteIndex&quot;);
  
      ASSERT(isVersionChange());
      ASSERT(m_transactionInfo.identifier() == requestData.transactionIdentifier());
  
      auto database = m_databaseConnection-&gt;database();
      ASSERT(database);
  
<span class="line-modified">!     database-&gt;deleteIndex(*this, objectStoreIdentifier, indexName, [this, requestData](auto&amp; error) {</span>
          LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::createIndex (callback)&quot;);
<span class="line-added">+ </span>
          if (error.isNull())
              m_databaseConnection-&gt;didDeleteIndex(IDBResultData::deleteIndexSuccess(requestData.requestIdentifier()));
          else
              m_databaseConnection-&gt;didDeleteIndex(IDBResultData::error(requestData.requestIdentifier(), error));
      });
</pre>
<hr />
<pre>
<span class="line-old-header">*** 250,17 ***</span>
      LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::renameIndex&quot;);
  
      ASSERT(isVersionChange());
      ASSERT(m_transactionInfo.identifier() == requestData.transactionIdentifier());
  
<span class="line-removed">-     RefPtr&lt;UniqueIDBDatabaseTransaction&gt; protectedThis(this);</span>
<span class="line-removed">- </span>
      auto database = m_databaseConnection-&gt;database();
      ASSERT(database);
  
<span class="line-modified">!     database-&gt;renameIndex(*this, objectStoreIdentifier, indexIdentifier, newName, [this, protectedThis, requestData](const IDBError&amp; error) {</span>
          LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::renameIndex (callback)&quot;);
          if (error.isNull())
              m_databaseConnection-&gt;didRenameIndex(IDBResultData::renameIndexSuccess(requestData.requestIdentifier()));
          else
              m_databaseConnection-&gt;didRenameIndex(IDBResultData::error(requestData.requestIdentifier(), error));
      });
<span class="line-new-header">--- 234,16 ---</span>
      LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::renameIndex&quot;);
  
      ASSERT(isVersionChange());
      ASSERT(m_transactionInfo.identifier() == requestData.transactionIdentifier());
  
      auto database = m_databaseConnection-&gt;database();
      ASSERT(database);
  
<span class="line-modified">!     database-&gt;renameIndex(*this, objectStoreIdentifier, indexIdentifier, newName, [this, requestData](auto&amp; error) {</span>
          LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::renameIndex (callback)&quot;);
<span class="line-added">+ </span>
          if (error.isNull())
              m_databaseConnection-&gt;didRenameIndex(IDBResultData::renameIndexSuccess(requestData.requestIdentifier()));
          else
              m_databaseConnection-&gt;didRenameIndex(IDBResultData::error(requestData.requestIdentifier(), error));
      });
</pre>
<hr />
<pre>
<span class="line-old-header">*** 272,16 ***</span>
      LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::putOrAdd&quot;);
  
      ASSERT(!isReadOnly());
      ASSERT(m_transactionInfo.identifier() == requestData.transactionIdentifier());
  
<span class="line-removed">-     RefPtr&lt;UniqueIDBDatabaseTransaction&gt; protectedThis(this);</span>
<span class="line-removed">- </span>
      auto database = m_databaseConnection-&gt;database();
      ASSERT(database);
  
<span class="line-modified">!     database-&gt;putOrAdd(requestData, keyData, value, overwriteMode, [this, protectedThis, requestData](const IDBError&amp; error, const IDBKeyData&amp; key) {</span>
          LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::putOrAdd (callback)&quot;);
  
          if (error.isNull())
              m_databaseConnection-&gt;connectionToClient().didPutOrAdd(IDBResultData::putOrAddSuccess(requestData.requestIdentifier(), key));
          else
<span class="line-new-header">--- 255,14 ---</span>
      LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::putOrAdd&quot;);
  
      ASSERT(!isReadOnly());
      ASSERT(m_transactionInfo.identifier() == requestData.transactionIdentifier());
  
      auto database = m_databaseConnection-&gt;database();
      ASSERT(database);
  
<span class="line-modified">!     database-&gt;putOrAdd(requestData, keyData, value, overwriteMode, [this, requestData](auto&amp; error, const IDBKeyData&amp; key) {</span>
          LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::putOrAdd (callback)&quot;);
  
          if (error.isNull())
              m_databaseConnection-&gt;connectionToClient().didPutOrAdd(IDBResultData::putOrAddSuccess(requestData.requestIdentifier(), key));
          else
</pre>
<hr />
<pre>
<span class="line-old-header">*** 293,16 ***</span>
  {
      LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::getRecord&quot;);
  
      ASSERT(m_transactionInfo.identifier() == requestData.transactionIdentifier());
  
<span class="line-removed">-     RefPtr&lt;UniqueIDBDatabaseTransaction&gt; protectedThis(this);</span>
<span class="line-removed">- </span>
      auto database = m_databaseConnection-&gt;database();
      ASSERT(database);
  
<span class="line-modified">!     database-&gt;getRecord(requestData, getRecordData, [this, protectedThis, requestData](const IDBError&amp; error, const IDBGetResult&amp; result) {</span>
          LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::getRecord (callback)&quot;);
  
          if (error.isNull())
              m_databaseConnection-&gt;connectionToClient().didGetRecord(IDBResultData::getRecordSuccess(requestData.requestIdentifier(), result));
          else
<span class="line-new-header">--- 274,14 ---</span>
  {
      LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::getRecord&quot;);
  
      ASSERT(m_transactionInfo.identifier() == requestData.transactionIdentifier());
  
      auto database = m_databaseConnection-&gt;database();
      ASSERT(database);
  
<span class="line-modified">!     database-&gt;getRecord(requestData, getRecordData, [this, requestData](auto&amp; error, const IDBGetResult&amp; result) {</span>
          LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::getRecord (callback)&quot;);
  
          if (error.isNull())
              m_databaseConnection-&gt;connectionToClient().didGetRecord(IDBResultData::getRecordSuccess(requestData.requestIdentifier(), result));
          else
</pre>
<hr />
<pre>
<span class="line-old-header">*** 314,16 ***</span>
  {
      LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::getAllRecords&quot;);
  
      ASSERT(m_transactionInfo.identifier() == requestData.transactionIdentifier());
  
<span class="line-removed">-     RefPtr&lt;UniqueIDBDatabaseTransaction&gt; protectedThis(this);</span>
<span class="line-removed">- </span>
      auto database = m_databaseConnection-&gt;database();
      ASSERT(database);
  
<span class="line-modified">!     database-&gt;getAllRecords(requestData, getAllRecordsData, [this, protectedThis, requestData](const IDBError&amp; error, const IDBGetAllResult&amp; result) {</span>
          LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::getAllRecords (callback)&quot;);
  
          if (error.isNull())
              m_databaseConnection-&gt;connectionToClient().didGetAllRecords(IDBResultData::getAllRecordsSuccess(requestData.requestIdentifier(), result));
          else
<span class="line-new-header">--- 293,14 ---</span>
  {
      LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::getAllRecords&quot;);
  
      ASSERT(m_transactionInfo.identifier() == requestData.transactionIdentifier());
  
      auto database = m_databaseConnection-&gt;database();
      ASSERT(database);
  
<span class="line-modified">!     database-&gt;getAllRecords(requestData, getAllRecordsData, [this, requestData](auto&amp; error, const IDBGetAllResult&amp; result) {</span>
          LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::getAllRecords (callback)&quot;);
  
          if (error.isNull())
              m_databaseConnection-&gt;connectionToClient().didGetAllRecords(IDBResultData::getAllRecordsSuccess(requestData.requestIdentifier(), result));
          else
</pre>
<hr />
<pre>
<span class="line-old-header">*** 335,16 ***</span>
  {
      LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::getCount&quot;);
  
      ASSERT(m_transactionInfo.identifier() == requestData.transactionIdentifier());
  
<span class="line-removed">-     RefPtr&lt;UniqueIDBDatabaseTransaction&gt; protectedThis(this);</span>
<span class="line-removed">- </span>
      auto database = m_databaseConnection-&gt;database();
      ASSERT(database);
  
<span class="line-modified">!     database-&gt;getCount(requestData, keyRangeData, [this, protectedThis, requestData](const IDBError&amp; error, uint64_t count) {</span>
          LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::getCount (callback)&quot;);
  
          if (error.isNull())
              m_databaseConnection-&gt;connectionToClient().didGetCount(IDBResultData::getCountSuccess(requestData.requestIdentifier(), count));
          else
<span class="line-new-header">--- 312,14 ---</span>
  {
      LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::getCount&quot;);
  
      ASSERT(m_transactionInfo.identifier() == requestData.transactionIdentifier());
  
      auto database = m_databaseConnection-&gt;database();
      ASSERT(database);
  
<span class="line-modified">!     database-&gt;getCount(requestData, keyRangeData, [this, requestData](auto&amp; error, uint64_t count) {</span>
          LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::getCount (callback)&quot;);
  
          if (error.isNull())
              m_databaseConnection-&gt;connectionToClient().didGetCount(IDBResultData::getCountSuccess(requestData.requestIdentifier(), count));
          else
</pre>
<hr />
<pre>
<span class="line-old-header">*** 356,16 ***</span>
  {
      LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::deleteRecord&quot;);
  
      ASSERT(m_transactionInfo.identifier() == requestData.transactionIdentifier());
  
<span class="line-removed">-     RefPtr&lt;UniqueIDBDatabaseTransaction&gt; protectedThis(this);</span>
<span class="line-removed">- </span>
      auto database = m_databaseConnection-&gt;database();
      ASSERT(database);
  
<span class="line-modified">!     database-&gt;deleteRecord(requestData, keyRangeData, [this, protectedThis, requestData](const IDBError&amp; error) {</span>
          LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::deleteRecord (callback)&quot;);
  
          if (error.isNull())
              m_databaseConnection-&gt;connectionToClient().didDeleteRecord(IDBResultData::deleteRecordSuccess(requestData.requestIdentifier()));
          else
<span class="line-new-header">--- 331,14 ---</span>
  {
      LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::deleteRecord&quot;);
  
      ASSERT(m_transactionInfo.identifier() == requestData.transactionIdentifier());
  
      auto database = m_databaseConnection-&gt;database();
      ASSERT(database);
  
<span class="line-modified">!     database-&gt;deleteRecord(requestData, keyRangeData, [this, requestData](auto&amp; error) {</span>
          LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::deleteRecord (callback)&quot;);
  
          if (error.isNull())
              m_databaseConnection-&gt;connectionToClient().didDeleteRecord(IDBResultData::deleteRecordSuccess(requestData.requestIdentifier()));
          else
</pre>
<hr />
<pre>
<span class="line-old-header">*** 377,16 ***</span>
  {
      LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::openCursor&quot;);
  
      ASSERT(m_transactionInfo.identifier() == requestData.transactionIdentifier());
  
<span class="line-removed">-     RefPtr&lt;UniqueIDBDatabaseTransaction&gt; protectedThis(this);</span>
<span class="line-removed">- </span>
      auto database = m_databaseConnection-&gt;database();
      ASSERT(database);
  
<span class="line-modified">!     database-&gt;openCursor(requestData, info, [this, protectedThis, requestData](const IDBError&amp; error, const IDBGetResult&amp; result) {</span>
          LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::openCursor (callback)&quot;);
  
          if (error.isNull())
              m_databaseConnection-&gt;connectionToClient().didOpenCursor(IDBResultData::openCursorSuccess(requestData.requestIdentifier(), result));
          else
<span class="line-new-header">--- 350,14 ---</span>
  {
      LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::openCursor&quot;);
  
      ASSERT(m_transactionInfo.identifier() == requestData.transactionIdentifier());
  
      auto database = m_databaseConnection-&gt;database();
      ASSERT(database);
  
<span class="line-modified">!     database-&gt;openCursor(requestData, info, [this, requestData](auto&amp; error, const IDBGetResult&amp; result) {</span>
          LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::openCursor (callback)&quot;);
  
          if (error.isNull())
              m_databaseConnection-&gt;connectionToClient().didOpenCursor(IDBResultData::openCursorSuccess(requestData.requestIdentifier(), result));
          else
</pre>
<hr />
<pre>
<span class="line-old-header">*** 398,18 ***</span>
  {
      LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::iterateCursor&quot;);
  
      ASSERT(m_transactionInfo.identifier() == requestData.transactionIdentifier());
  
<span class="line-removed">-     RefPtr&lt;UniqueIDBDatabaseTransaction&gt; protectedThis(this);</span>
<span class="line-removed">- </span>
      auto database = m_databaseConnection-&gt;database();
      ASSERT(database);
  
<span class="line-modified">!     database-&gt;iterateCursor(requestData, data, [this, protectedThis, requestData](const IDBError&amp; error, const IDBGetResult&amp; result) {</span>
          LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::iterateCursor (callback)&quot;);
  
          if (error.isNull())
              m_databaseConnection-&gt;connectionToClient().didIterateCursor(IDBResultData::iterateCursorSuccess(requestData.requestIdentifier(), result));
          else
              m_databaseConnection-&gt;connectionToClient().didIterateCursor(IDBResultData::error(requestData.requestIdentifier(), error));
      });
<span class="line-new-header">--- 369,19 ---</span>
  {
      LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::iterateCursor&quot;);
  
      ASSERT(m_transactionInfo.identifier() == requestData.transactionIdentifier());
  
      auto database = m_databaseConnection-&gt;database();
      ASSERT(database);
  
<span class="line-modified">!     database-&gt;iterateCursor(requestData, data, [this, requestData, option = data.option](auto&amp; error, const IDBGetResult&amp; result) {</span>
          LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::iterateCursor (callback)&quot;);
  
<span class="line-added">+         if (option == IndexedDB::CursorIterateOption::DoNotReply)</span>
<span class="line-added">+             return;</span>
<span class="line-added">+ </span>
          if (error.isNull())
              m_databaseConnection-&gt;connectionToClient().didIterateCursor(IDBResultData::iterateCursorSuccess(requestData.requestIdentifier(), result));
          else
              m_databaseConnection-&gt;connectionToClient().didIterateCursor(IDBResultData::error(requestData.requestIdentifier(), error));
      });
</pre>
<center><a href="UniqueIDBDatabaseConnection.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="UniqueIDBDatabaseTransaction.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>