<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/WebCore/bindings/js/JSDOMPromiseDeferred.h</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (C) 2013 Apple Inc. All rights reserved.
  3  *
  4  * Redistribution and use in source and binary forms, with or without
  5  * modification, are permitted provided that the following conditions
  6  * are met:
  7  * 1. Redistributions of source code must retain the above copyright
  8  *    notice, this list of conditions and the following disclaimer.
  9  * 2. Redistributions in binary form must reproduce the above copyright
 10  *    notice, this list of conditions and the following disclaimer in the
 11  *    documentation and/or other materials provided with the distribution.
 12  *
 13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. AND ITS CONTRIBUTORS ``AS IS&#39;&#39;
 14  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
 15  * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 16  * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL APPLE INC. OR ITS CONTRIBUTORS
 17  * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 18  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 19  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 20  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 21  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 22  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF
 23  * THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #pragma once
 27 
<a name="1" id="anc1"></a><span class="line-added"> 28 #include &quot;EventLoop.h&quot;</span>
 29 #include &quot;ExceptionOr.h&quot;
 30 #include &quot;JSDOMConvert.h&quot;
 31 #include &quot;JSDOMGuardedObject.h&quot;
<a name="2" id="anc2"></a><span class="line-added"> 32 #include &quot;ScriptExecutionContext.h&quot;</span>
 33 #include &lt;JavaScriptCore/CatchScope.h&gt;
<a name="3" id="anc3"></a><span class="line-modified"> 34 #include &lt;JavaScriptCore/JSPromise.h&gt;</span>
 35 
 36 namespace WebCore {
 37 
 38 class JSDOMWindow;
 39 
<a name="4" id="anc4"></a><span class="line-modified"> 40 class DeferredPromise : public DOMGuarded&lt;JSC::JSPromise&gt; {</span>
 41 public:
 42     enum class Mode {
 43         ClearPromiseOnResolve,
 44         RetainPromiseOnResolve
 45     };
 46 
<a name="5" id="anc5"></a><span class="line-modified"> 47     static RefPtr&lt;DeferredPromise&gt; create(JSDOMGlobalObject&amp; globalObject, Mode mode = Mode::ClearPromiseOnResolve)</span>
 48     {
<a name="6" id="anc6"></a><span class="line-modified"> 49         JSC::VM&amp; vm = JSC::getVM(&amp;globalObject);</span>
<span class="line-modified"> 50         auto* promise = JSC::JSPromise::create(vm, globalObject.promiseStructure());</span>
<span class="line-modified"> 51         ASSERT(promise);</span>
<span class="line-modified"> 52         return adoptRef(new DeferredPromise(globalObject, *promise, mode));</span>
 53     }
 54 
<a name="7" id="anc7"></a><span class="line-modified"> 55     static Ref&lt;DeferredPromise&gt; create(JSDOMGlobalObject&amp; globalObject, JSC::JSPromise&amp; deferred, Mode mode = Mode::ClearPromiseOnResolve)</span>
 56     {
 57         return adoptRef(*new DeferredPromise(globalObject, deferred, mode));
 58     }
 59 
 60     template&lt;class IDLType&gt;
 61     void resolve(typename IDLType::ParameterType value)
 62     {
<a name="8" id="anc8"></a><span class="line-modified"> 63         if (shouldIgnoreRequestToFulfill())</span>
 64             return;
<a name="9" id="anc9"></a><span class="line-added"> 65 </span>
 66         ASSERT(deferred());
 67         ASSERT(globalObject());
<a name="10" id="anc10"></a><span class="line-modified"> 68         JSC::JSGlobalObject* lexicalGlobalObject = globalObject();</span>
<span class="line-modified"> 69         JSC::JSLockHolder locker(lexicalGlobalObject);</span>
<span class="line-modified"> 70         resolve(*lexicalGlobalObject, toJS&lt;IDLType&gt;(*lexicalGlobalObject, *globalObject(), std::forward&lt;typename IDLType::ParameterType&gt;(value)));</span>
 71     }
 72 
 73     void resolve()
 74     {
<a name="11" id="anc11"></a><span class="line-modified"> 75         if (shouldIgnoreRequestToFulfill())</span>
 76             return;
<a name="12" id="anc12"></a><span class="line-added"> 77 </span>
 78         ASSERT(deferred());
 79         ASSERT(globalObject());
<a name="13" id="anc13"></a><span class="line-modified"> 80         JSC::JSGlobalObject* lexicalGlobalObject = globalObject();</span>
<span class="line-modified"> 81         JSC::JSLockHolder locker(lexicalGlobalObject);</span>
<span class="line-modified"> 82         resolve(*lexicalGlobalObject, JSC::jsUndefined());</span>
 83     }
 84 
 85     template&lt;class IDLType&gt;
 86     void resolveWithNewlyCreated(typename IDLType::ParameterType value)
 87     {
<a name="14" id="anc14"></a><span class="line-modified"> 88         if (shouldIgnoreRequestToFulfill())</span>
 89             return;
<a name="15" id="anc15"></a><span class="line-added"> 90 </span>
 91         ASSERT(deferred());
 92         ASSERT(globalObject());
<a name="16" id="anc16"></a><span class="line-modified"> 93         JSC::JSGlobalObject* lexicalGlobalObject = globalObject();</span>
<span class="line-modified"> 94         JSC::JSLockHolder locker(lexicalGlobalObject);</span>
<span class="line-modified"> 95         resolve(*lexicalGlobalObject, toJSNewlyCreated&lt;IDLType&gt;(*lexicalGlobalObject, *globalObject(), std::forward&lt;typename IDLType::ParameterType&gt;(value)));</span>
 96     }
 97 
 98     template&lt;class IDLType&gt;
 99     void resolveCallbackValueWithNewlyCreated(const Function&lt;typename IDLType::InnerParameterType(ScriptExecutionContext&amp;)&gt;&amp; createValue)
100     {
<a name="17" id="anc17"></a><span class="line-modified">101         if (shouldIgnoreRequestToFulfill())</span>
102             return;
<a name="18" id="anc18"></a><span class="line-added">103 </span>
104         ASSERT(deferred());
105         ASSERT(globalObject());
<a name="19" id="anc19"></a><span class="line-modified">106         auto* lexicalGlobalObject = globalObject();</span>
<span class="line-modified">107         JSC::JSLockHolder locker(lexicalGlobalObject);</span>
<span class="line-modified">108         resolve(*lexicalGlobalObject, toJSNewlyCreated&lt;IDLType&gt;(*lexicalGlobalObject, *globalObject(), createValue(*globalObject()-&gt;scriptExecutionContext())));</span>
109     }
110 
111     template&lt;class IDLType&gt;
112     void reject(typename IDLType::ParameterType value)
113     {
<a name="20" id="anc20"></a><span class="line-modified">114         if (shouldIgnoreRequestToFulfill())</span>
115             return;
<a name="21" id="anc21"></a><span class="line-added">116 </span>
117         ASSERT(deferred());
118         ASSERT(globalObject());
<a name="22" id="anc22"></a><span class="line-modified">119         JSC::JSGlobalObject* lexicalGlobalObject = globalObject();</span>
<span class="line-modified">120         JSC::JSLockHolder locker(lexicalGlobalObject);</span>
<span class="line-modified">121         reject(*lexicalGlobalObject, toJS&lt;IDLType&gt;(*lexicalGlobalObject, *globalObject(), std::forward&lt;typename IDLType::ParameterType&gt;(value)));</span>
122     }
123 
124     void reject();
125     void reject(std::nullptr_t);
126     void reject(Exception);
127     WEBCORE_EXPORT void reject(ExceptionCode, const String&amp; = { });
128     void reject(const JSC::PrivateName&amp;);
129 
130     template&lt;typename Callback&gt;
131     void resolveWithCallback(Callback callback)
132     {
<a name="23" id="anc23"></a><span class="line-modified">133         if (shouldIgnoreRequestToFulfill())</span>
134             return;
<a name="24" id="anc24"></a><span class="line-added">135 </span>
136         ASSERT(deferred());
137         ASSERT(globalObject());
<a name="25" id="anc25"></a><span class="line-modified">138         JSC::JSGlobalObject* lexicalGlobalObject = globalObject();</span>
<span class="line-modified">139         JSC::JSLockHolder locker(lexicalGlobalObject);</span>
<span class="line-modified">140         resolve(*lexicalGlobalObject, callback(*globalObject()));</span>
141     }
142 
143     template&lt;typename Callback&gt;
144     void rejectWithCallback(Callback callback)
145     {
<a name="26" id="anc26"></a><span class="line-modified">146         if (shouldIgnoreRequestToFulfill())</span>
147             return;
<a name="27" id="anc27"></a><span class="line-added">148 </span>
149         ASSERT(deferred());
150         ASSERT(globalObject());
<a name="28" id="anc28"></a><span class="line-modified">151         JSC::JSGlobalObject* lexicalGlobalObject = globalObject();</span>
<span class="line-modified">152         JSC::JSLockHolder locker(lexicalGlobalObject);</span>
<span class="line-modified">153         reject(*lexicalGlobalObject, callback(*globalObject()));</span>
154     }
155 
156     JSC::JSValue promise() const;
157 
<a name="29" id="anc29"></a><span class="line-modified">158     void whenSettled(Function&lt;void()&gt;&amp;&amp;);</span>
159 
160 private:
<a name="30" id="anc30"></a><span class="line-modified">161     DeferredPromise(JSDOMGlobalObject&amp; globalObject, JSC::JSPromise&amp; deferred, Mode mode)</span>
<span class="line-modified">162         : DOMGuarded&lt;JSC::JSPromise&gt;(globalObject, deferred)</span>
163         , m_mode(mode)
164     {
165     }
166 
<a name="31" id="anc31"></a><span class="line-modified">167     bool shouldIgnoreRequestToFulfill() const { return isEmpty() || activeDOMObjectAreStopped(); }</span>
168 
<a name="32" id="anc32"></a><span class="line-modified">169     JSC::JSPromise* deferred() const { return guarded(); }</span>
170 
<a name="33" id="anc33"></a><span class="line-modified">171     enum class ResolveMode { Resolve, Reject };</span>
<span class="line-modified">172     WEBCORE_EXPORT void callFunction(JSC::JSGlobalObject&amp;, ResolveMode, JSC::JSValue resolution);</span>
<span class="line-added">173 </span>
<span class="line-added">174     void resolve(JSC::JSGlobalObject&amp; lexicalGlobalObject, JSC::JSValue resolution) { callFunction(lexicalGlobalObject, ResolveMode::Resolve, resolution); }</span>
<span class="line-added">175     void reject(JSC::JSGlobalObject&amp; lexicalGlobalObject, JSC::JSValue resolution) { callFunction(lexicalGlobalObject, ResolveMode::Reject, resolution); }</span>
176 
177     Mode m_mode;
178 };
179 
180 class DOMPromiseDeferredBase {
<a name="34" id="anc34"></a><span class="line-added">181     WTF_MAKE_FAST_ALLOCATED;</span>
182 public:
183     DOMPromiseDeferredBase(Ref&lt;DeferredPromise&gt;&amp;&amp; genericPromise)
<a name="35" id="anc35"></a><span class="line-modified">184         : m_promise(WTFMove(genericPromise))</span>
185     {
186     }
187 
188     DOMPromiseDeferredBase(DOMPromiseDeferredBase&amp;&amp; promise)
<a name="36" id="anc36"></a><span class="line-modified">189         : m_promise(WTFMove(promise.m_promise))</span>
190     {
191     }
192 
193     DOMPromiseDeferredBase(const DOMPromiseDeferredBase&amp; other)
<a name="37" id="anc37"></a><span class="line-modified">194         : m_promise(other.m_promise.copyRef())</span>
195     {
196     }
197 
198     DOMPromiseDeferredBase&amp; operator=(const DOMPromiseDeferredBase&amp; other)
199     {
<a name="38" id="anc38"></a><span class="line-modified">200         m_promise = other.m_promise.copyRef();</span>
201         return *this;
202     }
203 
204     DOMPromiseDeferredBase&amp; operator=(DOMPromiseDeferredBase&amp;&amp; other)
205     {
<a name="39" id="anc39"></a><span class="line-modified">206         m_promise = WTFMove(other.m_promise);</span>
207         return *this;
208     }
209 
210     void reject()
211     {
<a name="40" id="anc40"></a><span class="line-modified">212         m_promise-&gt;reject();</span>
213     }
214 
215     template&lt;typename... ErrorType&gt;
216     void reject(ErrorType&amp;&amp;... error)
217     {
<a name="41" id="anc41"></a><span class="line-modified">218         m_promise-&gt;reject(std::forward&lt;ErrorType&gt;(error)...);</span>
219     }
220 
221     template&lt;typename IDLType&gt;
222     void rejectType(typename IDLType::ParameterType value)
223     {
<a name="42" id="anc42"></a><span class="line-modified">224         m_promise-&gt;reject&lt;IDLType&gt;(std::forward&lt;typename IDLType::ParameterType&gt;(value));</span>
225     }
226 
<a name="43" id="anc43"></a><span class="line-modified">227     JSC::JSValue promise() const { return m_promise-&gt;promise(); };</span>
<span class="line-added">228 </span>
<span class="line-added">229     void whenSettled(Function&lt;void()&gt;&amp;&amp; function)</span>
<span class="line-added">230     {</span>
<span class="line-added">231         m_promise-&gt;whenSettled(WTFMove(function));</span>
<span class="line-added">232     }</span>
233 
234 protected:
<a name="44" id="anc44"></a><span class="line-modified">235     Ref&lt;DeferredPromise&gt; m_promise;</span>
236 };
237 
238 template&lt;typename IDLType&gt;
239 class DOMPromiseDeferred : public DOMPromiseDeferredBase {
240 public:
241     using DOMPromiseDeferredBase::DOMPromiseDeferredBase;
242     using DOMPromiseDeferredBase::operator=;
243     using DOMPromiseDeferredBase::promise;
244     using DOMPromiseDeferredBase::reject;
245 
246     void resolve(typename IDLType::ParameterType value)
247     {
<a name="45" id="anc45"></a><span class="line-modified">248         m_promise-&gt;resolve&lt;IDLType&gt;(std::forward&lt;typename IDLType::ParameterType&gt;(value));</span>
249     }
250 
251     void settle(ExceptionOr&lt;typename IDLType::ParameterType&gt;&amp;&amp; result)
252     {
253         if (result.hasException()) {
254             reject(result.releaseException());
255             return;
256         }
257         resolve(result.releaseReturnValue());
258     }
259 };
260 
261 template&lt;&gt; class DOMPromiseDeferred&lt;void&gt; : public DOMPromiseDeferredBase {
262 public:
263     using DOMPromiseDeferredBase::DOMPromiseDeferredBase;
264     using DOMPromiseDeferredBase::operator=;
265     using DOMPromiseDeferredBase::promise;
266     using DOMPromiseDeferredBase::reject;
267 
268     void resolve()
269     {
<a name="46" id="anc46"></a><span class="line-modified">270         m_promise-&gt;resolve();</span>
271     }
272 
273     void settle(ExceptionOr&lt;void&gt;&amp;&amp; result)
274     {
275         if (result.hasException()) {
276             reject(result.releaseException());
277             return;
278         }
279         resolve();
280     }
281 };
282 
283 
<a name="47" id="anc47"></a><span class="line-modified">284 Ref&lt;DeferredPromise&gt; createDeferredPromise(JSC::JSGlobalObject&amp;, JSDOMWindow&amp;);</span>
285 
286 void fulfillPromiseWithJSON(Ref&lt;DeferredPromise&gt;&amp;&amp;, const String&amp;);
287 void fulfillPromiseWithArrayBuffer(Ref&lt;DeferredPromise&gt;&amp;&amp;, ArrayBuffer*);
288 void fulfillPromiseWithArrayBuffer(Ref&lt;DeferredPromise&gt;&amp;&amp;, const void*, size_t);
<a name="48" id="anc48"></a><span class="line-modified">289 WEBCORE_EXPORT void rejectPromiseWithExceptionIfAny(JSC::JSGlobalObject&amp;, JSDOMGlobalObject&amp;, JSC::JSPromise&amp;);</span>
290 
291 enum class RejectedPromiseWithTypeErrorCause { NativeGetter, InvalidThis };
<a name="49" id="anc49"></a><span class="line-modified">292 JSC::EncodedJSValue createRejectedPromiseWithTypeError(JSC::JSGlobalObject&amp;, const String&amp;, RejectedPromiseWithTypeErrorCause);</span>
293 
<a name="50" id="anc50"></a><span class="line-modified">294 using PromiseFunction = void(JSC::JSGlobalObject&amp;, JSC::CallFrame&amp;, Ref&lt;DeferredPromise&gt;&amp;&amp;);</span>
295 
<a name="51" id="anc51"></a><span class="line-modified">296 template&lt;PromiseFunction promiseFunction&gt;</span>
<span class="line-modified">297 inline JSC::JSValue callPromiseFunction(JSC::JSGlobalObject&amp; lexicalGlobalObject, JSC::CallFrame&amp; callFrame)</span>


298 {
<a name="52" id="anc52"></a><span class="line-modified">299     JSC::VM&amp; vm = JSC::getVM(&amp;lexicalGlobalObject);</span>
300     auto scope = DECLARE_CATCH_SCOPE(vm);
301 
<a name="53" id="anc53"></a><span class="line-modified">302     auto&amp; globalObject = callerGlobalObject(lexicalGlobalObject, callFrame);</span>
<span class="line-modified">303     auto* promise = JSC::JSPromise::create(vm, globalObject.promiseStructure());</span>
<span class="line-modified">304     ASSERT(promise);</span>



305 
<a name="54" id="anc54"></a><span class="line-modified">306     promiseFunction(lexicalGlobalObject, callFrame, DeferredPromise::create(globalObject, *promise));</span>
307 
<a name="55" id="anc55"></a><span class="line-modified">308     rejectPromiseWithExceptionIfAny(lexicalGlobalObject, globalObject, *promise);</span>
<span class="line-modified">309     // FIXME: We could have error since any JS call can throw stack-overflow errors.</span>
<span class="line-modified">310     // https://bugs.webkit.org/show_bug.cgi?id=203402</span>
<span class="line-added">311     RETURN_IF_EXCEPTION(scope, JSC::jsUndefined());</span>
<span class="line-added">312     return promise;</span>
313 }
314 
<a name="56" id="anc56"></a><span class="line-modified">315 template&lt;typename PromiseFunctor&gt;</span>
<span class="line-modified">316 inline JSC::JSValue callPromiseFunction(JSC::JSGlobalObject&amp; lexicalGlobalObject, JSC::CallFrame&amp; callFrame, PromiseFunctor functor)</span>
317 {
<a name="57" id="anc57"></a><span class="line-modified">318     JSC::VM&amp; vm = JSC::getVM(&amp;lexicalGlobalObject);</span>
319     auto scope = DECLARE_CATCH_SCOPE(vm);
320 
<a name="58" id="anc58"></a><span class="line-modified">321     auto&amp; globalObject = callerGlobalObject(lexicalGlobalObject, callFrame);</span>
<span class="line-modified">322     auto* promise = JSC::JSPromise::create(vm, globalObject.promiseStructure());</span>
<span class="line-modified">323     ASSERT(promise);</span>



324 
<a name="59" id="anc59"></a><span class="line-modified">325     functor(lexicalGlobalObject, callFrame, DeferredPromise::create(globalObject, *promise));</span>
326 
<a name="60" id="anc60"></a><span class="line-modified">327     rejectPromiseWithExceptionIfAny(lexicalGlobalObject, globalObject, *promise);</span>
<span class="line-modified">328     // FIXME: We could have error since any JS call can throw stack-overflow errors.</span>
<span class="line-modified">329     // https://bugs.webkit.org/show_bug.cgi?id=203402</span>
<span class="line-added">330     RETURN_IF_EXCEPTION(scope, JSC::jsUndefined());</span>
<span class="line-added">331     return promise;</span>
332 }
333 
<a name="61" id="anc61"></a><span class="line-modified">334 using BindingPromiseFunction = JSC::EncodedJSValue(JSC::JSGlobalObject*, JSC::CallFrame*, Ref&lt;DeferredPromise&gt;&amp;&amp;);</span>
335 template&lt;BindingPromiseFunction bindingFunction&gt;
<a name="62" id="anc62"></a><span class="line-modified">336 inline void bindingPromiseFunctionAdapter(JSC::JSGlobalObject&amp; lexicalGlobalObject, JSC::CallFrame&amp; callFrame, Ref&lt;DeferredPromise&gt;&amp;&amp; promise)</span>
337 {
<a name="63" id="anc63"></a><span class="line-modified">338     bindingFunction(&amp;lexicalGlobalObject, &amp;callFrame, WTFMove(promise));</span>
339 }
340 
<a name="64" id="anc64"></a><span class="line-modified">341 template&lt;BindingPromiseFunction bindingPromiseFunction&gt;</span>
<span class="line-modified">342 inline JSC::JSValue callPromiseFunction(JSC::JSGlobalObject&amp; lexicalGlobalObject, JSC::CallFrame&amp; callFrame)</span>
343 {
<a name="65" id="anc65"></a><span class="line-modified">344     return callPromiseFunction&lt;bindingPromiseFunctionAdapter&lt;bindingPromiseFunction&gt;&gt;(lexicalGlobalObject, callFrame);</span>
345 }
346 
347 } // namespace WebCore
<a name="66" id="anc66"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="66" type="hidden" />
</body>
</html>