<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WebCore/loader/archive/mhtml/MHTMLArchive.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../appcache/ApplicationCacheStorage.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../cache/CachedCSSStyleSheet.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/loader/archive/mhtml/MHTMLArchive.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 19  * &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 20  * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 21  * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 22  * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 23  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 24  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 25  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 26  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 27  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 28  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 29  */
 30 
 31 #include &quot;config.h&quot;
 32 
 33 #if ENABLE(MHTML)
 34 
 35 #include &quot;MHTMLArchive.h&quot;
 36 
 37 #include &quot;Document.h&quot;
 38 #include &quot;Frame.h&quot;

 39 #include &quot;MHTMLParser.h&quot;
 40 #include &quot;MIMETypeRegistry.h&quot;
 41 #include &quot;Page.h&quot;
 42 #include &quot;PageSerializer.h&quot;
 43 #include &quot;QuotedPrintable.h&quot;
<span class="line-removed"> 44 #include &quot;SchemeRegistry.h&quot;</span>
 45 #include &quot;SharedBuffer.h&quot;
 46 #include &lt;time.h&gt;
 47 #include &lt;wtf/CryptographicallyRandomNumber.h&gt;
 48 #include &lt;wtf/DateMath.h&gt;
 49 #include &lt;wtf/GregorianDateTime.h&gt;
 50 #include &lt;wtf/StdLibExtras.h&gt;
 51 #include &lt;wtf/text/Base64.h&gt;
 52 #include &lt;wtf/text/StringBuilder.h&gt;
 53 
 54 #if HAVE(SYS_TIME_H)
 55 #include &lt;sys/time.h&gt;
 56 #endif
 57 
 58 namespace WebCore {
 59 
 60 const char* const quotedPrintable = &quot;quoted-printable&quot;;
 61 const char* const base64 = &quot;base64&quot;;
 62 
 63 static String generateRandomBoundary()
 64 {
</pre>
<hr />
<pre>
 92 }
 93 
 94 MHTMLArchive::MHTMLArchive()
 95 {
 96 }
 97 
 98 MHTMLArchive::~MHTMLArchive()
 99 {
100     // Because all frames know about each other we need to perform a deep clearing of the archives graph.
101     clearAllSubframeArchives();
102 }
103 
104 Ref&lt;MHTMLArchive&gt; MHTMLArchive::create()
105 {
106     return adoptRef(*new MHTMLArchive);
107 }
108 
109 RefPtr&lt;MHTMLArchive&gt; MHTMLArchive::create(const URL&amp; url, SharedBuffer&amp; data)
110 {
111     // For security reasons we only load MHTML pages from local URLs.
<span class="line-modified">112     if (!SchemeRegistry::shouldTreatURLSchemeAsLocal(url.protocol().toString()))</span>
113         return nullptr;
114 
115     MHTMLParser parser(&amp;data);
116     RefPtr&lt;MHTMLArchive&gt; mainArchive = parser.parseArchive();
117     if (!mainArchive)
118         return nullptr; // Invalid MHTML file.
119 
120     // Since MHTML is a flat format, we need to make all frames aware of all resources.
121     for (size_t i = 0; i &lt; parser.frameCount(); ++i) {
122         RefPtr&lt;MHTMLArchive&gt; archive = parser.frameAt(i);
123         for (size_t j = 1; j &lt; parser.frameCount(); ++j) {
124             if (i != j)
125                 archive-&gt;addSubframeArchive(*parser.frameAt(j));
126         }
127         for (size_t j = 0; j &lt; parser.subResourceCount(); ++j)
128             archive-&gt;addSubresource(*parser.subResourceAt(j));
129     }
130     return mainArchive;
131 }
132 
133 Ref&lt;SharedBuffer&gt; MHTMLArchive::generateMHTMLData(Page* page)
134 {
135     Vector&lt;PageSerializer::Resource&gt; resources;
136     PageSerializer pageSerializer(resources);
137     pageSerializer.serialize(*page);
138 
139     String boundary = generateRandomBoundary();
140     String endOfResourceBoundary = makeString(&quot;--&quot;, boundary, &quot;\r\n&quot;);
141 
142     GregorianDateTime now;
143     now.setToCurrentLocalTime();
<span class="line-modified">144     String dateString = makeRFC2822DateString(now.weekDay(), now.monthDay(), now.month(), now.year(), now.hour(), now.minute(), now.second(), now.utcOffset() / 60);</span>
145 
146     StringBuilder stringBuilder;
147     stringBuilder.append(&quot;From: &lt;Saved by WebKit&gt;\r\n&quot;);
148     stringBuilder.append(&quot;Subject: &quot;);
149     // We replace non ASCII characters with &#39;?&#39; characters to match IE&#39;s behavior.
150     stringBuilder.append(replaceNonPrintableCharacters(page-&gt;mainFrame().document()-&gt;title()));
151     stringBuilder.append(&quot;\r\nDate: &quot;);
152     stringBuilder.append(dateString);
153     stringBuilder.append(&quot;\r\nMIME-Version: 1.0\r\n&quot;);
154     stringBuilder.append(&quot;Content-Type: multipart/related;\r\n&quot;);
155     stringBuilder.append(&quot;\ttype=\&quot;&quot;);
156     stringBuilder.append(page-&gt;mainFrame().document()-&gt;suggestedMIMEType());
157     stringBuilder.append(&quot;\&quot;;\r\n&quot;);
158     stringBuilder.append(&quot;\tboundary=\&quot;&quot;);
159     stringBuilder.append(boundary);
160     stringBuilder.append(&quot;\&quot;\r\n\r\n&quot;);
161 
162     // We use utf8() below instead of ascii() as ascii() replaces CRLFs with ?? (we still only have put ASCII characters in it).
163     ASSERT(stringBuilder.toString().isAllASCII());
164     CString asciiString = stringBuilder.toString().utf8();
</pre>
</td>
<td>
<hr />
<pre>
 19  * &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 20  * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 21  * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 22  * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 23  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 24  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 25  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 26  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 27  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 28  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 29  */
 30 
 31 #include &quot;config.h&quot;
 32 
 33 #if ENABLE(MHTML)
 34 
 35 #include &quot;MHTMLArchive.h&quot;
 36 
 37 #include &quot;Document.h&quot;
 38 #include &quot;Frame.h&quot;
<span class="line-added"> 39 #include &quot;LegacySchemeRegistry.h&quot;</span>
 40 #include &quot;MHTMLParser.h&quot;
 41 #include &quot;MIMETypeRegistry.h&quot;
 42 #include &quot;Page.h&quot;
 43 #include &quot;PageSerializer.h&quot;
 44 #include &quot;QuotedPrintable.h&quot;

 45 #include &quot;SharedBuffer.h&quot;
 46 #include &lt;time.h&gt;
 47 #include &lt;wtf/CryptographicallyRandomNumber.h&gt;
 48 #include &lt;wtf/DateMath.h&gt;
 49 #include &lt;wtf/GregorianDateTime.h&gt;
 50 #include &lt;wtf/StdLibExtras.h&gt;
 51 #include &lt;wtf/text/Base64.h&gt;
 52 #include &lt;wtf/text/StringBuilder.h&gt;
 53 
 54 #if HAVE(SYS_TIME_H)
 55 #include &lt;sys/time.h&gt;
 56 #endif
 57 
 58 namespace WebCore {
 59 
 60 const char* const quotedPrintable = &quot;quoted-printable&quot;;
 61 const char* const base64 = &quot;base64&quot;;
 62 
 63 static String generateRandomBoundary()
 64 {
</pre>
<hr />
<pre>
 92 }
 93 
 94 MHTMLArchive::MHTMLArchive()
 95 {
 96 }
 97 
 98 MHTMLArchive::~MHTMLArchive()
 99 {
100     // Because all frames know about each other we need to perform a deep clearing of the archives graph.
101     clearAllSubframeArchives();
102 }
103 
104 Ref&lt;MHTMLArchive&gt; MHTMLArchive::create()
105 {
106     return adoptRef(*new MHTMLArchive);
107 }
108 
109 RefPtr&lt;MHTMLArchive&gt; MHTMLArchive::create(const URL&amp; url, SharedBuffer&amp; data)
110 {
111     // For security reasons we only load MHTML pages from local URLs.
<span class="line-modified">112     if (!LegacySchemeRegistry::shouldTreatURLSchemeAsLocal(url.protocol().toString()))</span>
113         return nullptr;
114 
115     MHTMLParser parser(&amp;data);
116     RefPtr&lt;MHTMLArchive&gt; mainArchive = parser.parseArchive();
117     if (!mainArchive)
118         return nullptr; // Invalid MHTML file.
119 
120     // Since MHTML is a flat format, we need to make all frames aware of all resources.
121     for (size_t i = 0; i &lt; parser.frameCount(); ++i) {
122         RefPtr&lt;MHTMLArchive&gt; archive = parser.frameAt(i);
123         for (size_t j = 1; j &lt; parser.frameCount(); ++j) {
124             if (i != j)
125                 archive-&gt;addSubframeArchive(*parser.frameAt(j));
126         }
127         for (size_t j = 0; j &lt; parser.subResourceCount(); ++j)
128             archive-&gt;addSubresource(*parser.subResourceAt(j));
129     }
130     return mainArchive;
131 }
132 
133 Ref&lt;SharedBuffer&gt; MHTMLArchive::generateMHTMLData(Page* page)
134 {
135     Vector&lt;PageSerializer::Resource&gt; resources;
136     PageSerializer pageSerializer(resources);
137     pageSerializer.serialize(*page);
138 
139     String boundary = generateRandomBoundary();
140     String endOfResourceBoundary = makeString(&quot;--&quot;, boundary, &quot;\r\n&quot;);
141 
142     GregorianDateTime now;
143     now.setToCurrentLocalTime();
<span class="line-modified">144     String dateString = makeRFC2822DateString(now.weekDay(), now.monthDay(), now.month(), now.year(), now.hour(), now.minute(), now.second(), now.utcOffsetInMinute());</span>
145 
146     StringBuilder stringBuilder;
147     stringBuilder.append(&quot;From: &lt;Saved by WebKit&gt;\r\n&quot;);
148     stringBuilder.append(&quot;Subject: &quot;);
149     // We replace non ASCII characters with &#39;?&#39; characters to match IE&#39;s behavior.
150     stringBuilder.append(replaceNonPrintableCharacters(page-&gt;mainFrame().document()-&gt;title()));
151     stringBuilder.append(&quot;\r\nDate: &quot;);
152     stringBuilder.append(dateString);
153     stringBuilder.append(&quot;\r\nMIME-Version: 1.0\r\n&quot;);
154     stringBuilder.append(&quot;Content-Type: multipart/related;\r\n&quot;);
155     stringBuilder.append(&quot;\ttype=\&quot;&quot;);
156     stringBuilder.append(page-&gt;mainFrame().document()-&gt;suggestedMIMEType());
157     stringBuilder.append(&quot;\&quot;;\r\n&quot;);
158     stringBuilder.append(&quot;\tboundary=\&quot;&quot;);
159     stringBuilder.append(boundary);
160     stringBuilder.append(&quot;\&quot;\r\n\r\n&quot;);
161 
162     // We use utf8() below instead of ascii() as ascii() replaces CRLFs with ?? (we still only have put ASCII characters in it).
163     ASSERT(stringBuilder.toString().isAllASCII());
164     CString asciiString = stringBuilder.toString().utf8();
</pre>
</td>
</tr>
</table>
<center><a href="../../appcache/ApplicationCacheStorage.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../cache/CachedCSSStyleSheet.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>