<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/JavaScriptCore/builtins/AsyncGeneratorPrototype.js</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="AsyncFunctionPrototype.js.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="BuiltinExecutableCreator.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/JavaScriptCore/builtins/AsyncGeneratorPrototype.js</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
  2  * Copyright (C) 2017 Oleksandr Skachkov &lt;gskachkov@gmail.com&gt;.

  3  *
  4  * Redistribution and use in source and binary forms, with or without
  5  * modification, are permitted provided that the following conditions
  6  * are met:
  7  * 1. Redistributions of source code must retain the above copyright
  8  *    notice, this list of conditions and the following disclaimer.
  9  * 2. Redistributions in binary form must reproduce the above copyright
 10  *    notice, this list of conditions and the following disclaimer in the
 11  *    documentation and/or other materials provided with the distribution.
 12  *
 13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. ``AS IS&#39;&#39; AND ANY
 14  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 15  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 16  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE INC. OR
 17  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 18  * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 19  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 20  * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 21  * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 22  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 23  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 @globalPrivate
 27 function asyncGeneratorQueueIsEmpty(generator)
 28 {
 29     &quot;use strict&quot;;
 30 
<span class="line-modified"> 31     return @getByIdDirectPrivate(generator, &quot;asyncGeneratorQueueLast&quot;) === null;</span>
 32 }
 33 
 34 @globalPrivate
 35 function asyncGeneratorQueueEnqueue(generator, item)
 36 {
 37     &quot;use strict&quot;;
 38 
<span class="line-modified"> 39     @assert(@getByIdDirectPrivate(item, &quot;asyncGeneratorQueueItemNext&quot;) === null &amp;&amp; @getByIdDirectPrivate(item, &quot;asyncGeneratorQueueItemPrevious&quot;) === null);</span>
 40 
<span class="line-modified"> 41     if (@getByIdDirectPrivate(generator, &quot;asyncGeneratorQueueFirst&quot;) === null) {</span>
<span class="line-modified"> 42         @assert(@getByIdDirectPrivate(generator, &quot;asyncGeneratorQueueLast&quot;) === null);</span>
 43 
<span class="line-modified"> 44         @putByIdDirectPrivate(generator, &quot;asyncGeneratorQueueFirst&quot;, item);</span>
<span class="line-modified"> 45         @putByIdDirectPrivate(generator, &quot;asyncGeneratorQueueLast&quot;, item);</span>
 46     } else {
<span class="line-modified"> 47         var last = @getByIdDirectPrivate(generator, &quot;asyncGeneratorQueueLast&quot;);</span>
<span class="line-removed"> 48         @putByIdDirectPrivate(item, &quot;asyncGeneratorQueueItemPrevious&quot;, last);</span>
 49         @putByIdDirectPrivate(last, &quot;asyncGeneratorQueueItemNext&quot;, item);
<span class="line-modified"> 50         @putByIdDirectPrivate(generator, &quot;asyncGeneratorQueueLast&quot;, item);</span>
 51     }
 52 }
 53 
 54 @globalPrivate
 55 function asyncGeneratorQueueDequeue(generator)
 56 {
 57     &quot;use strict&quot;;
 58 
<span class="line-modified"> 59     const result = @getByIdDirectPrivate(generator, &quot;asyncGeneratorQueueFirst&quot;);</span>
<span class="line-modified"> 60     if (result === null)</span>
<span class="line-modified"> 61         return null;</span>
 62 
 63     var updatedFirst = @getByIdDirectPrivate(result, &quot;asyncGeneratorQueueItemNext&quot;);
<span class="line-modified"> 64     @putByIdDirectPrivate(generator, &quot;asyncGeneratorQueueFirst&quot;, updatedFirst);</span>
 65 
 66     if (updatedFirst === null)
<span class="line-modified"> 67         @putByIdDirectPrivate(generator, &quot;asyncGeneratorQueueLast&quot;, null);</span>
 68 
 69     return result;
 70 }
 71 
<span class="line-removed"> 72 @globalPrivate</span>
<span class="line-removed"> 73 function asyncGeneratorDequeue(generator)</span>
<span class="line-removed"> 74 {</span>
<span class="line-removed"> 75     &quot;use strict&quot;;</span>
<span class="line-removed"> 76 </span>
<span class="line-removed"> 77     const queue = @getByIdDirectPrivate(generator, &quot;asyncGeneratorQueue&quot;);</span>
<span class="line-removed"> 78 </span>
<span class="line-removed"> 79     @assert(!@asyncGeneratorQueueIsEmpty(generator), &quot;Async genetator&#39;s Queue is an empty List.&quot;);</span>
<span class="line-removed"> 80     </span>
<span class="line-removed"> 81     return @asyncGeneratorQueueDequeue(generator);</span>
<span class="line-removed"> 82 }</span>
<span class="line-removed"> 83 </span>
 84 @globalPrivate
 85 function isExecutionState(generator)
 86 {
 87     &quot;use strict&quot;;
 88 
<span class="line-modified"> 89     var state = @getByIdDirectPrivate(generator, &quot;generatorState&quot;);</span>
<span class="line-modified"> 90     var reason = @getByIdDirectPrivate(generator, &quot;asyncGeneratorSuspendReason&quot;);</span>
 91     return (state &gt; 0 &amp;&amp; reason === @AsyncGeneratorSuspendReasonNone)
 92         || state === @AsyncGeneratorStateExecuting
 93         || reason === @AsyncGeneratorSuspendReasonAwait;
 94 }
 95 
 96 @globalPrivate
 97 function isSuspendYieldState(generator)
 98 {
 99     &quot;use strict&quot;;
100 
<span class="line-modified">101     var state = @getByIdDirectPrivate(generator, &quot;generatorState&quot;);</span>
<span class="line-modified">102     return (state &gt; 0 &amp;&amp; @getByIdDirectPrivate(generator, &quot;asyncGeneratorSuspendReason&quot;) === @AsyncGeneratorSuspendReasonYield)</span>
103         || state === @AsyncGeneratorStateSuspendedYield;
104 }
105 
106 @globalPrivate
107 function asyncGeneratorReject(generator, exception)
108 {
109     &quot;use strict&quot;;
110 
<span class="line-modified">111     @assert(typeof @getByIdDirectPrivate(generator, &quot;asyncGeneratorSuspendReason&quot;) === &quot;number&quot;, &quot;Generator is not an AsyncGenerator instance.&quot;);</span>
112 
<span class="line-modified">113     const { promiseCapability } = @asyncGeneratorDequeue(generator);</span>
<span class="line-modified">114     promiseCapability.@reject.@call(@undefined, exception);</span>

115 
116     return @asyncGeneratorResumeNext(generator);
117 }
118 
119 @globalPrivate
120 function asyncGeneratorResolve(generator, value, done)
121 {
122     &quot;use strict&quot;;
123 
<span class="line-modified">124     @assert(typeof @getByIdDirectPrivate(generator, &quot;asyncGeneratorSuspendReason&quot;) === &quot;number&quot;, &quot;Generator is not an AsyncGenerator instance.&quot;);</span>
125 
<span class="line-modified">126     const { promiseCapability } = @asyncGeneratorDequeue(generator);</span>
<span class="line-modified">127     promiseCapability.@resolve.@call(@undefined, { value, done });</span>

128 
129     return @asyncGeneratorResumeNext(generator);
130 }
131 
132 @globalPrivate
133 function asyncGeneratorYield(generator, value, resumeMode)
134 {
135     &quot;use strict&quot;;
136 
137     function asyncGeneratorYieldAwaited(result)
138     {
<span class="line-modified">139         @putByIdDirectPrivate(generator, &quot;asyncGeneratorSuspendReason&quot;, @AsyncGeneratorSuspendReasonYield);</span>
140         @asyncGeneratorResolve(generator, result, false);
141     }
142 
<span class="line-modified">143     @putByIdDirectPrivate(generator, &quot;asyncGeneratorSuspendReason&quot;, @AsyncGeneratorSuspendReasonAwait);</span>
144 
145     @awaitValue(generator, value, asyncGeneratorYieldAwaited);
<span class="line-removed">146 </span>
<span class="line-removed">147     return @undefined;</span>
148 }
149 
150 @globalPrivate
<span class="line-modified">151 function awaitValue(generator, value, onFullfiled)</span>
152 {
153     &quot;use strict&quot;;
154 
<span class="line-modified">155     const wrappedValue = @newPromiseCapability(@Promise);</span>
<span class="line-modified">156 </span>
<span class="line-removed">157     const onRejected = function (result) { @doAsyncGeneratorBodyCall(generator, result, @GeneratorResumeModeThrow); };</span>
<span class="line-removed">158 </span>
<span class="line-removed">159     wrappedValue.@resolve.@call(@undefined, value);</span>
<span class="line-removed">160     wrappedValue.@promise.@then(onFullfiled, onRejected);</span>
<span class="line-removed">161 </span>
<span class="line-removed">162     return wrappedValue;</span>
163 }
164 
165 @globalPrivate
166 function doAsyncGeneratorBodyCall(generator, resumeValue, resumeMode)
167 {
168     &quot;use strict&quot;;
169 
<span class="line-modified">170     let value = @undefined;</span>
<span class="line-modified">171     let state = @getByIdDirectPrivate(generator, &quot;generatorState&quot;);</span>
172 
<span class="line-modified">173     @putByIdDirectPrivate(generator, &quot;generatorState&quot;, @AsyncGeneratorStateExecuting);</span>
<span class="line-modified">174     @putByIdDirectPrivate(generator, &quot;asyncGeneratorSuspendReason&quot;, @AsyncGeneratorSuspendReasonNone);</span>
175 
176     try {
<span class="line-modified">177         value = @getByIdDirectPrivate(generator, &quot;generatorNext&quot;).@call(@getByIdDirectPrivate(generator, &quot;generatorThis&quot;), generator, state, resumeValue, resumeMode, @getByIdDirectPrivate(generator, &quot;generatorFrame&quot;));</span>
<span class="line-modified">178         if (@getByIdDirectPrivate(generator, &quot;generatorState&quot;) === @AsyncGeneratorStateExecuting)</span>
<span class="line-modified">179             @putByIdDirectPrivate(generator, &quot;generatorState&quot;, @AsyncGeneratorStateCompleted);</span>



180     } catch (error) {
<span class="line-modified">181         @putByIdDirectPrivate(generator, &quot;generatorState&quot;, @AsyncGeneratorStateCompleted);</span>
<span class="line-modified">182         @putByIdDirectPrivate(generator, &quot;asyncGeneratorSuspendReason&quot;, @AsyncGeneratorSuspendReasonNone);</span>
183 
184         return @asyncGeneratorReject(generator, error);
185     }
186 
<span class="line-modified">187     if (@getByIdDirectPrivate(generator, &quot;asyncGeneratorSuspendReason&quot;) === @AsyncGeneratorSuspendReasonAwait) {</span>
<span class="line-modified">188         const onFulfilled = function(result) { @doAsyncGeneratorBodyCall(generator, result, @GeneratorResumeModeNormal); };</span>

189 
190         @awaitValue(generator, value, onFulfilled);
<span class="line-modified">191 </span>
<span class="line-removed">192         return @undefined;</span>
193     }
194 
<span class="line-modified">195     if (@getByIdDirectPrivate(generator, &quot;asyncGeneratorSuspendReason&quot;) === @AsyncGeneratorSuspendReasonYield)</span>
196         return @asyncGeneratorYield(generator, value, resumeMode);
197 
<span class="line-modified">198     if (@getByIdDirectPrivate(generator, &quot;generatorState&quot;) === @AsyncGeneratorStateCompleted) {</span>
<span class="line-modified">199         @putByIdDirectPrivate(generator, &quot;asyncGeneratorSuspendReason&quot;, @AsyncGeneratorSuspendReasonNone);</span>

200         return @asyncGeneratorResolve(generator, value, true);
201     }
<span class="line-removed">202 </span>
<span class="line-removed">203     return @undefined;</span>
204 }
205 
206 @globalPrivate
207 function asyncGeneratorResumeNext(generator)
208 {
209     &quot;use strict&quot;;
210 
<span class="line-modified">211     @assert(typeof @getByIdDirectPrivate(generator, &quot;asyncGeneratorSuspendReason&quot;) === &quot;number&quot;, &quot;Generator is not an AsyncGenerator instance.&quot;);</span>
212 
<span class="line-modified">213     let state = @getByIdDirectPrivate(generator, &quot;generatorState&quot;);</span>
214 
215     @assert(state !== @AsyncGeneratorStateExecuting, &quot;Async generator should not be in executing state&quot;);
216 
217     if (state === @AsyncGeneratorStateAwaitingReturn)
<span class="line-modified">218         return @undefined;</span>
219 
220     if (@asyncGeneratorQueueIsEmpty(generator))
<span class="line-modified">221         return @undefined;</span>
222 
<span class="line-modified">223     const next = @getByIdDirectPrivate(generator, &quot;asyncGeneratorQueueFirst&quot;);</span>
224 
225     if (next.resumeMode !== @GeneratorResumeModeNormal) {
226         if (state === @AsyncGeneratorStateSuspendedStart) {
<span class="line-modified">227             @putByIdDirectPrivate(generator, &quot;generatorState&quot;, @AsyncGeneratorStateCompleted);</span>
228             state = @AsyncGeneratorStateCompleted;
229         }
230 
231         if (state === @AsyncGeneratorStateCompleted) {
232             if (next.resumeMode === @GeneratorResumeModeReturn) {
<span class="line-modified">233                 @putByIdDirectPrivate(generator, &quot;generatorState&quot;, @AsyncGeneratorStateAwaitingReturn);</span>
<span class="line-modified">234 </span>
<span class="line-modified">235                 const promiseCapability = @newPromiseCapability(@Promise);</span>
<span class="line-modified">236                 promiseCapability.@resolve.@call(@undefined, next.value);</span>
<span class="line-modified">237 </span>
<span class="line-modified">238                 const throwawayCapabilityPromise = promiseCapability.@promise.@then(</span>
<span class="line-modified">239                     function (result) { generator.@generatorState = @AsyncGeneratorStateCompleted; @asyncGeneratorResolve(generator, result, true); },</span>
<span class="line-modified">240                     function (error) { generator.@generatorState = @AsyncGeneratorStateCompleted; @asyncGeneratorReject(generator, error); });</span>
<span class="line-modified">241 </span>
<span class="line-modified">242                 @putByIdDirectPrivate(throwawayCapabilityPromise, &quot;promiseIsHandled&quot;, true);</span>
<span class="line-modified">243 </span>
<span class="line-removed">244                 return @undefined;</span>
245             }
246 
247             @assert(next.resumeMode === @GeneratorResumeModeThrow, &quot;Async generator has wrong mode&quot;);
248 
249             return @asyncGeneratorReject(generator, next.value);;
250         }
251     } else if (state === @AsyncGeneratorStateCompleted)
252         return @asyncGeneratorResolve(generator, @undefined, true);
253 
254     @assert(state === @AsyncGeneratorStateSuspendedStart || @isSuspendYieldState(generator), &quot;Async generator has wrong state&quot;);
255 
256     @doAsyncGeneratorBodyCall(generator, next.value, next.resumeMode);
<span class="line-removed">257 </span>
<span class="line-removed">258     return @undefined;</span>
259 }
260 
261 @globalPrivate
262 function asyncGeneratorEnqueue(generator, value, resumeMode)
263 {
264     &quot;use strict&quot;;
<span class="line-modified">265     </span>
<span class="line-modified">266     const promiseCapability = @newPromiseCapability(@Promise);</span>
<span class="line-modified">267     if (!@isObject(generator) || typeof @getByIdDirectPrivate(generator, &quot;asyncGeneratorSuspendReason&quot;) !== &#39;number&#39;) {</span>
<span class="line-modified">268         promiseCapability.@reject.@call(@undefined, @makeTypeError(&#39;|this| should be an async generator&#39;));</span>
<span class="line-modified">269         return promiseCapability.@promise;</span>
270     }
271 
<span class="line-modified">272     @asyncGeneratorQueueEnqueue(generator, {resumeMode, value, promiseCapability, @asyncGeneratorQueueItemNext: null, @asyncGeneratorQueueItemPrevious: null});</span>
273 
274     if (!@isExecutionState(generator))
275         @asyncGeneratorResumeNext(generator);
276 
<span class="line-modified">277     return promiseCapability.@promise;</span>
278 }
279 
280 function next(value)
281 {
282     &quot;use strict&quot;;
283 
284     return @asyncGeneratorEnqueue(this, value, @GeneratorResumeModeNormal);
285 }
286 
287 function return(value)
288 {
289     &quot;use strict&quot;;
290 
291     return @asyncGeneratorEnqueue(this, value, @GeneratorResumeModeReturn);
292 }
293 
294 function throw(exception)
295 {
296     &quot;use strict&quot;;
297     
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
  2  * Copyright (C) 2017 Oleksandr Skachkov &lt;gskachkov@gmail.com&gt;.
<span class="line-added">  3  * Copyright (C) 2019 Apple Inc. All rights reserved.</span>
  4  *
  5  * Redistribution and use in source and binary forms, with or without
  6  * modification, are permitted provided that the following conditions
  7  * are met:
  8  * 1. Redistributions of source code must retain the above copyright
  9  *    notice, this list of conditions and the following disclaimer.
 10  * 2. Redistributions in binary form must reproduce the above copyright
 11  *    notice, this list of conditions and the following disclaimer in the
 12  *    documentation and/or other materials provided with the distribution.
 13  *
 14  * THIS SOFTWARE IS PROVIDED BY APPLE INC. ``AS IS&#39;&#39; AND ANY
 15  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 16  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 17  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE INC. OR
 18  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 19  * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 20  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 21  * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 22  * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 23  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 24  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 25  */
 26 
 27 @globalPrivate
 28 function asyncGeneratorQueueIsEmpty(generator)
 29 {
 30     &quot;use strict&quot;;
 31 
<span class="line-modified"> 32     return @getAsyncGeneratorInternalField(generator, @asyncGeneratorFieldQueueFirst) === null;</span>
 33 }
 34 
 35 @globalPrivate
 36 function asyncGeneratorQueueEnqueue(generator, item)
 37 {
 38     &quot;use strict&quot;;
 39 
<span class="line-modified"> 40     @assert(@getByIdDirectPrivate(item, &quot;asyncGeneratorQueueItemNext&quot;) === null);</span>
 41 
<span class="line-modified"> 42     if (@getAsyncGeneratorInternalField(generator, @asyncGeneratorFieldQueueFirst) === null) {</span>
<span class="line-modified"> 43         @assert(@getAsyncGeneratorInternalField(generator, @asyncGeneratorFieldQueueLast) === null);</span>
 44 
<span class="line-modified"> 45         @putAsyncGeneratorInternalField(generator, @asyncGeneratorFieldQueueFirst, item);</span>
<span class="line-modified"> 46         @putAsyncGeneratorInternalField(generator, @asyncGeneratorFieldQueueLast, item);</span>
 47     } else {
<span class="line-modified"> 48         var last = @getAsyncGeneratorInternalField(generator, @asyncGeneratorFieldQueueLast);</span>

 49         @putByIdDirectPrivate(last, &quot;asyncGeneratorQueueItemNext&quot;, item);
<span class="line-modified"> 50         @putAsyncGeneratorInternalField(generator, @asyncGeneratorFieldQueueLast, item);</span>
 51     }
 52 }
 53 
 54 @globalPrivate
 55 function asyncGeneratorQueueDequeue(generator)
 56 {
 57     &quot;use strict&quot;;
 58 
<span class="line-modified"> 59     @assert(!@asyncGeneratorQueueIsEmpty(generator), &quot;Async genetator&#39;s Queue is an empty List.&quot;);</span>
<span class="line-modified"> 60 </span>
<span class="line-modified"> 61     var result = @getAsyncGeneratorInternalField(generator, @asyncGeneratorFieldQueueFirst);</span>
 62 
 63     var updatedFirst = @getByIdDirectPrivate(result, &quot;asyncGeneratorQueueItemNext&quot;);
<span class="line-modified"> 64     @putAsyncGeneratorInternalField(generator, @asyncGeneratorFieldQueueFirst, updatedFirst);</span>
 65 
 66     if (updatedFirst === null)
<span class="line-modified"> 67         @putAsyncGeneratorInternalField(generator, @asyncGeneratorFieldQueueLast, null);</span>
 68 
 69     return result;
 70 }
 71 












 72 @globalPrivate
 73 function isExecutionState(generator)
 74 {
 75     &quot;use strict&quot;;
 76 
<span class="line-modified"> 77     var state = @getAsyncGeneratorInternalField(generator, @generatorFieldState);</span>
<span class="line-modified"> 78     var reason = @getAsyncGeneratorInternalField(generator, @asyncGeneratorFieldSuspendReason);</span>
 79     return (state &gt; 0 &amp;&amp; reason === @AsyncGeneratorSuspendReasonNone)
 80         || state === @AsyncGeneratorStateExecuting
 81         || reason === @AsyncGeneratorSuspendReasonAwait;
 82 }
 83 
 84 @globalPrivate
 85 function isSuspendYieldState(generator)
 86 {
 87     &quot;use strict&quot;;
 88 
<span class="line-modified"> 89     var state = @getAsyncGeneratorInternalField(generator, @generatorFieldState);</span>
<span class="line-modified"> 90     return (state &gt; 0 &amp;&amp; @getAsyncGeneratorInternalField(generator, @asyncGeneratorFieldSuspendReason) === @AsyncGeneratorSuspendReasonYield)</span>
 91         || state === @AsyncGeneratorStateSuspendedYield;
 92 }
 93 
 94 @globalPrivate
 95 function asyncGeneratorReject(generator, exception)
 96 {
 97     &quot;use strict&quot;;
 98 
<span class="line-modified"> 99     @assert(@isAsyncGenerator(generator), &quot;Generator is not an AsyncGenerator instance.&quot;);</span>
100 
<span class="line-modified">101     var promise = @asyncGeneratorQueueDequeue(generator).promise;</span>
<span class="line-modified">102     @assert(@isPromise(promise));</span>
<span class="line-added">103     @rejectPromiseWithFirstResolvingFunctionCallCheck(promise, exception);</span>
104 
105     return @asyncGeneratorResumeNext(generator);
106 }
107 
108 @globalPrivate
109 function asyncGeneratorResolve(generator, value, done)
110 {
111     &quot;use strict&quot;;
112 
<span class="line-modified">113     @assert(@isAsyncGenerator(generator), &quot;Generator is not an AsyncGenerator instance.&quot;);</span>
114 
<span class="line-modified">115     var promise = @asyncGeneratorQueueDequeue(generator).promise;</span>
<span class="line-modified">116     @assert(@isPromise(promise));</span>
<span class="line-added">117     @resolvePromiseWithFirstResolvingFunctionCallCheck(promise, { value, done });</span>
118 
119     return @asyncGeneratorResumeNext(generator);
120 }
121 
122 @globalPrivate
123 function asyncGeneratorYield(generator, value, resumeMode)
124 {
125     &quot;use strict&quot;;
126 
127     function asyncGeneratorYieldAwaited(result)
128     {
<span class="line-modified">129         @putAsyncGeneratorInternalField(generator, @asyncGeneratorFieldSuspendReason, @AsyncGeneratorSuspendReasonYield);</span>
130         @asyncGeneratorResolve(generator, result, false);
131     }
132 
<span class="line-modified">133     @putAsyncGeneratorInternalField(generator, @asyncGeneratorFieldSuspendReason, @AsyncGeneratorSuspendReasonAwait);</span>
134 
135     @awaitValue(generator, value, asyncGeneratorYieldAwaited);


136 }
137 
138 @globalPrivate
<span class="line-modified">139 function awaitValue(generator, value, onFulfilled)</span>
140 {
141     &quot;use strict&quot;;
142 
<span class="line-modified">143     var onRejected = function (result) { @doAsyncGeneratorBodyCall(generator, result, @GeneratorResumeModeThrow); };</span>
<span class="line-modified">144     @resolveWithoutPromise(value, onFulfilled, onRejected);</span>






145 }
146 
147 @globalPrivate
148 function doAsyncGeneratorBodyCall(generator, resumeValue, resumeMode)
149 {
150     &quot;use strict&quot;;
151 
<span class="line-modified">152     var value = @undefined;</span>
<span class="line-modified">153     var state = @getAsyncGeneratorInternalField(generator, @generatorFieldState);</span>
154 
<span class="line-modified">155     @putAsyncGeneratorInternalField(generator, @generatorFieldState, @AsyncGeneratorStateExecuting);</span>
<span class="line-modified">156     @putAsyncGeneratorInternalField(generator, @asyncGeneratorFieldSuspendReason, @AsyncGeneratorSuspendReasonNone);</span>
157 
158     try {
<span class="line-modified">159         value = @getAsyncGeneratorInternalField(generator, @generatorFieldNext).@call(@getAsyncGeneratorInternalField(generator, @generatorFieldThis), generator, state, resumeValue, resumeMode, @getAsyncGeneratorInternalField(generator, @generatorFieldFrame));</span>
<span class="line-modified">160         state = @getAsyncGeneratorInternalField(generator, @generatorFieldState);</span>
<span class="line-modified">161         if (state === @AsyncGeneratorStateExecuting) {</span>
<span class="line-added">162             @putAsyncGeneratorInternalField(generator, @generatorFieldState, @AsyncGeneratorStateCompleted);</span>
<span class="line-added">163             state = @AsyncGeneratorStateCompleted;</span>
<span class="line-added">164         }</span>
165     } catch (error) {
<span class="line-modified">166         @putAsyncGeneratorInternalField(generator, @generatorFieldState, @AsyncGeneratorStateCompleted);</span>
<span class="line-modified">167         @putAsyncGeneratorInternalField(generator, @asyncGeneratorFieldSuspendReason, @AsyncGeneratorSuspendReasonNone);</span>
168 
169         return @asyncGeneratorReject(generator, error);
170     }
171 
<span class="line-modified">172     var reason = @getAsyncGeneratorInternalField(generator, @asyncGeneratorFieldSuspendReason);</span>
<span class="line-modified">173     if (reason === @AsyncGeneratorSuspendReasonAwait) {</span>
<span class="line-added">174         var onFulfilled = function(result) { @doAsyncGeneratorBodyCall(generator, result, @GeneratorResumeModeNormal); };</span>
175 
176         @awaitValue(generator, value, onFulfilled);
<span class="line-modified">177         return;</span>

178     }
179 
<span class="line-modified">180     if (reason === @AsyncGeneratorSuspendReasonYield)</span>
181         return @asyncGeneratorYield(generator, value, resumeMode);
182 
<span class="line-modified">183     if (state === @AsyncGeneratorStateCompleted) {</span>
<span class="line-modified">184         @assert(@getAsyncGeneratorInternalField(generator, @generatorFieldState) == @AsyncGeneratorStateCompleted);</span>
<span class="line-added">185         @putAsyncGeneratorInternalField(generator, @asyncGeneratorFieldSuspendReason, @AsyncGeneratorSuspendReasonNone);</span>
186         return @asyncGeneratorResolve(generator, value, true);
187     }


188 }
189 
190 @globalPrivate
191 function asyncGeneratorResumeNext(generator)
192 {
193     &quot;use strict&quot;;
194 
<span class="line-modified">195     @assert(@isAsyncGenerator(generator), &quot;Generator is not an AsyncGenerator instance.&quot;);</span>
196 
<span class="line-modified">197     var state = @getAsyncGeneratorInternalField(generator, @generatorFieldState);</span>
198 
199     @assert(state !== @AsyncGeneratorStateExecuting, &quot;Async generator should not be in executing state&quot;);
200 
201     if (state === @AsyncGeneratorStateAwaitingReturn)
<span class="line-modified">202         return;</span>
203 
204     if (@asyncGeneratorQueueIsEmpty(generator))
<span class="line-modified">205         return;</span>
206 
<span class="line-modified">207     var next = @getAsyncGeneratorInternalField(generator, @asyncGeneratorFieldQueueFirst);</span>
208 
209     if (next.resumeMode !== @GeneratorResumeModeNormal) {
210         if (state === @AsyncGeneratorStateSuspendedStart) {
<span class="line-modified">211             @putAsyncGeneratorInternalField(generator, @generatorFieldState, @AsyncGeneratorStateCompleted);</span>
212             state = @AsyncGeneratorStateCompleted;
213         }
214 
215         if (state === @AsyncGeneratorStateCompleted) {
216             if (next.resumeMode === @GeneratorResumeModeReturn) {
<span class="line-modified">217                 @putAsyncGeneratorInternalField(generator, @generatorFieldState, @AsyncGeneratorStateAwaitingReturn);</span>
<span class="line-modified">218                 @resolveWithoutPromise(next.value,</span>
<span class="line-modified">219                     function (result) {</span>
<span class="line-modified">220                         @putAsyncGeneratorInternalField(generator, @generatorFieldState, @AsyncGeneratorStateCompleted);</span>
<span class="line-modified">221                         @asyncGeneratorResolve(generator, result, true);</span>
<span class="line-modified">222                     },</span>
<span class="line-modified">223                     function (error) {</span>
<span class="line-modified">224                         @putAsyncGeneratorInternalField(generator, @generatorFieldState, @AsyncGeneratorStateCompleted);</span>
<span class="line-modified">225                         @asyncGeneratorReject(generator, error);</span>
<span class="line-modified">226                     });</span>
<span class="line-modified">227                 return;</span>

228             }
229 
230             @assert(next.resumeMode === @GeneratorResumeModeThrow, &quot;Async generator has wrong mode&quot;);
231 
232             return @asyncGeneratorReject(generator, next.value);;
233         }
234     } else if (state === @AsyncGeneratorStateCompleted)
235         return @asyncGeneratorResolve(generator, @undefined, true);
236 
237     @assert(state === @AsyncGeneratorStateSuspendedStart || @isSuspendYieldState(generator), &quot;Async generator has wrong state&quot;);
238 
239     @doAsyncGeneratorBodyCall(generator, next.value, next.resumeMode);


240 }
241 
242 @globalPrivate
243 function asyncGeneratorEnqueue(generator, value, resumeMode)
244 {
245     &quot;use strict&quot;;
<span class="line-modified">246 </span>
<span class="line-modified">247     var promise = @newPromise();</span>
<span class="line-modified">248     if (!@isAsyncGenerator(generator)) {</span>
<span class="line-modified">249         @rejectPromiseWithFirstResolvingFunctionCallCheck(promise, @makeTypeError(&#39;|this| should be an async generator&#39;));</span>
<span class="line-modified">250         return promise;</span>
251     }
252 
<span class="line-modified">253     @asyncGeneratorQueueEnqueue(generator, {resumeMode, value, promise, @asyncGeneratorQueueItemNext: null});</span>
254 
255     if (!@isExecutionState(generator))
256         @asyncGeneratorResumeNext(generator);
257 
<span class="line-modified">258     return promise;</span>
259 }
260 
261 function next(value)
262 {
263     &quot;use strict&quot;;
264 
265     return @asyncGeneratorEnqueue(this, value, @GeneratorResumeModeNormal);
266 }
267 
268 function return(value)
269 {
270     &quot;use strict&quot;;
271 
272     return @asyncGeneratorEnqueue(this, value, @GeneratorResumeModeReturn);
273 }
274 
275 function throw(exception)
276 {
277     &quot;use strict&quot;;
278     
</pre>
</td>
</tr>
</table>
<center><a href="AsyncFunctionPrototype.js.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="BuiltinExecutableCreator.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>