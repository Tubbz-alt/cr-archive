<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.web/src/main/native/Source/JavaScriptCore/runtime/IntlCollator.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="InternalFunction.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="IntlCollator.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/JavaScriptCore/runtime/IntlCollator.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,9 ***</span>
  /*
   * Copyright (C) 2015 Andy VanWagoner (andy@vanwagoner.family)
   * Copyright (C) 2015 Sukolsak Sakshuwong (sukolsak@gmail.com)
<span class="line-modified">!  * Copyright (C) 2016-2019 Apple Inc. All Rights Reserved.</span>
   *
   * Redistribution and use in source and binary forms, with or without
   * modification, are permitted provided that the following conditions
   * are met:
   * 1. Redistributions of source code must retain the above copyright
<span class="line-new-header">--- 1,9 ---</span>
  /*
   * Copyright (C) 2015 Andy VanWagoner (andy@vanwagoner.family)
   * Copyright (C) 2015 Sukolsak Sakshuwong (sukolsak@gmail.com)
<span class="line-modified">!  * Copyright (C) 2016-2020 Apple Inc. All Rights Reserved.</span>
   *
   * Redistribution and use in source and binary forms, with or without
   * modification, are permitted provided that the following conditions
   * are met:
   * 1. Redistributions of source code must retain the above copyright
</pre>
<hr />
<pre>
<span class="line-old-header">*** 68,25 ***</span>
  {
      return Structure::create(vm, globalObject, prototype, TypeInfo(ObjectType, StructureFlags), info());
  }
  
  IntlCollator::IntlCollator(VM&amp; vm, Structure* structure)
<span class="line-modified">!     : JSDestructibleObject(vm, structure)</span>
  {
  }
  
  void IntlCollator::finishCreation(VM&amp; vm)
  {
      Base::finishCreation(vm);
      ASSERT(inherits(vm, info()));
  }
  
<span class="line-removed">- void IntlCollator::destroy(JSCell* cell)</span>
<span class="line-removed">- {</span>
<span class="line-removed">-     static_cast&lt;IntlCollator*&gt;(cell)-&gt;IntlCollator::~IntlCollator();</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
  void IntlCollator::visitChildren(JSCell* cell, SlotVisitor&amp; visitor)
  {
      IntlCollator* thisObject = jsCast&lt;IntlCollator*&gt;(cell);
      ASSERT_GC_OBJECT_INHERITS(thisObject, info());
  
<span class="line-new-header">--- 68,20 ---</span>
  {
      return Structure::create(vm, globalObject, prototype, TypeInfo(ObjectType, StructureFlags), info());
  }
  
  IntlCollator::IntlCollator(VM&amp; vm, Structure* structure)
<span class="line-modified">!     : Base(vm, structure)</span>
  {
  }
  
  void IntlCollator::finishCreation(VM&amp; vm)
  {
      Base::finishCreation(vm);
      ASSERT(inherits(vm, info()));
  }
  
  void IntlCollator::visitChildren(JSCell* cell, SlotVisitor&amp; visitor)
  {
      IntlCollator* thisObject = jsCast&lt;IntlCollator*&gt;(cell);
      ASSERT_GC_OBJECT_INHERITS(thisObject, info());
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 171,30 ***</span>
          ASSERT_NOT_REACHED();
      }
      return keyLocaleData;
  }
  
<span class="line-modified">! void IntlCollator::initializeCollator(ExecState&amp; state, JSValue locales, JSValue optionsValue)</span>
  {
<span class="line-modified">!     VM&amp; vm = state.vm();</span>
      auto scope = DECLARE_THROW_SCOPE(vm);
  
      // 10.1.1 InitializeCollator (collator, locales, options) (ECMA-402)
      // https://tc39.github.io/ecma402/#sec-initializecollator
  
<span class="line-modified">!     auto requestedLocales = canonicalizeLocaleList(state, locales);</span>
      RETURN_IF_EXCEPTION(scope, void());
  
<span class="line-modified">!     JSObject* options;</span>
<span class="line-modified">!     if (optionsValue.isUndefined())</span>
<span class="line-modified">!         options = constructEmptyObject(&amp;state, state.lexicalGlobalObject()-&gt;nullPrototypeObjectStructure());</span>
<span class="line-removed">-     else {</span>
<span class="line-removed">-         options = optionsValue.toObject(&amp;state);</span>
          RETURN_IF_EXCEPTION(scope, void());
      }
  
<span class="line-modified">!     String usageString = intlStringOption(state, options, vm.propertyNames-&gt;usage, { &quot;sort&quot;, &quot;search&quot; }, &quot;usage must be either \&quot;sort\&quot; or \&quot;search\&quot;&quot;, &quot;sort&quot;);</span>
      RETURN_IF_EXCEPTION(scope, void());
      if (usageString == &quot;sort&quot;)
          m_usage = Usage::Sort;
      else if (usageString == &quot;search&quot;)
          m_usage = Usage::Search;
<span class="line-new-header">--- 166,28 ---</span>
          ASSERT_NOT_REACHED();
      }
      return keyLocaleData;
  }
  
<span class="line-modified">! void IntlCollator::initializeCollator(JSGlobalObject* globalObject, JSValue locales, JSValue optionsValue)</span>
  {
<span class="line-modified">!     VM&amp; vm = globalObject-&gt;vm();</span>
      auto scope = DECLARE_THROW_SCOPE(vm);
  
      // 10.1.1 InitializeCollator (collator, locales, options) (ECMA-402)
      // https://tc39.github.io/ecma402/#sec-initializecollator
  
<span class="line-modified">!     auto requestedLocales = canonicalizeLocaleList(globalObject, locales);</span>
      RETURN_IF_EXCEPTION(scope, void());
  
<span class="line-modified">!     JSValue options = optionsValue;</span>
<span class="line-modified">!     if (!optionsValue.isUndefined()) {</span>
<span class="line-modified">!         options = optionsValue.toObject(globalObject);</span>
          RETURN_IF_EXCEPTION(scope, void());
      }
  
<span class="line-modified">!     String usageString = intlStringOption(globalObject, options, vm.propertyNames-&gt;usage, { &quot;sort&quot;, &quot;search&quot; }, &quot;usage must be either \&quot;sort\&quot; or \&quot;search\&quot;&quot;, &quot;sort&quot;);</span>
      RETURN_IF_EXCEPTION(scope, void());
      if (usageString == &quot;sort&quot;)
          m_usage = Usage::Sort;
      else if (usageString == &quot;search&quot;)
          m_usage = Usage::Search;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 203,37 ***</span>
  
      auto localeData = (m_usage == Usage::Sort) ? sortLocaleData : searchLocaleData;
  
      HashMap&lt;String, String&gt; opt;
  
<span class="line-modified">!     String matcher = intlStringOption(state, options, vm.propertyNames-&gt;localeMatcher, { &quot;lookup&quot;, &quot;best fit&quot; }, &quot;localeMatcher must be either \&quot;lookup\&quot; or \&quot;best fit\&quot;&quot;, &quot;best fit&quot;);</span>
      RETURN_IF_EXCEPTION(scope, void());
      opt.add(&quot;localeMatcher&quot;_s, matcher);
  
      {
          String numericString;
          bool usesFallback;
<span class="line-modified">!         bool numeric = intlBooleanOption(state, options, vm.propertyNames-&gt;numeric, usesFallback);</span>
          RETURN_IF_EXCEPTION(scope, void());
          if (!usesFallback)
              numericString = numeric ? &quot;true&quot;_s : &quot;false&quot;_s;
          if (!numericString.isNull())
              opt.add(&quot;kn&quot;_s, numericString);
      }
      {
<span class="line-modified">!         String caseFirst = intlStringOption(state, options, vm.propertyNames-&gt;caseFirst, { &quot;upper&quot;, &quot;lower&quot;, &quot;false&quot; }, &quot;caseFirst must be either \&quot;upper\&quot;, \&quot;lower\&quot;, or \&quot;false\&quot;&quot;, nullptr);</span>
          RETURN_IF_EXCEPTION(scope, void());
          if (!caseFirst.isNull())
              opt.add(&quot;kf&quot;_s, caseFirst);
      }
  
<span class="line-modified">!     auto&amp; availableLocales = state.jsCallee()-&gt;globalObject(vm)-&gt;intlCollatorAvailableLocales();</span>
<span class="line-modified">!     auto result = resolveLocale(state, availableLocales, requestedLocales, opt, relevantCollatorExtensionKeys, WTF_ARRAY_LENGTH(relevantCollatorExtensionKeys), localeData);</span>
  
      m_locale = result.get(&quot;locale&quot;_s);
      if (m_locale.isEmpty()) {
<span class="line-modified">!         throwTypeError(&amp;state, scope, &quot;failed to initialize Collator due to invalid locale&quot;_s);</span>
          return;
      }
  
      const String&amp; collation = result.get(&quot;co&quot;_s);
      m_collation = collation.isNull() ? &quot;default&quot;_s : collation;
<span class="line-new-header">--- 196,37 ---</span>
  
      auto localeData = (m_usage == Usage::Sort) ? sortLocaleData : searchLocaleData;
  
      HashMap&lt;String, String&gt; opt;
  
<span class="line-modified">!     String matcher = intlStringOption(globalObject, options, vm.propertyNames-&gt;localeMatcher, { &quot;lookup&quot;, &quot;best fit&quot; }, &quot;localeMatcher must be either \&quot;lookup\&quot; or \&quot;best fit\&quot;&quot;, &quot;best fit&quot;);</span>
      RETURN_IF_EXCEPTION(scope, void());
      opt.add(&quot;localeMatcher&quot;_s, matcher);
  
      {
          String numericString;
          bool usesFallback;
<span class="line-modified">!         bool numeric = intlBooleanOption(globalObject, options, vm.propertyNames-&gt;numeric, usesFallback);</span>
          RETURN_IF_EXCEPTION(scope, void());
          if (!usesFallback)
              numericString = numeric ? &quot;true&quot;_s : &quot;false&quot;_s;
          if (!numericString.isNull())
              opt.add(&quot;kn&quot;_s, numericString);
      }
      {
<span class="line-modified">!         String caseFirst = intlStringOption(globalObject, options, vm.propertyNames-&gt;caseFirst, { &quot;upper&quot;, &quot;lower&quot;, &quot;false&quot; }, &quot;caseFirst must be either \&quot;upper\&quot;, \&quot;lower\&quot;, or \&quot;false\&quot;&quot;, nullptr);</span>
          RETURN_IF_EXCEPTION(scope, void());
          if (!caseFirst.isNull())
              opt.add(&quot;kf&quot;_s, caseFirst);
      }
  
<span class="line-modified">!     auto&amp; availableLocales = intlCollatorAvailableLocales();</span>
<span class="line-modified">!     auto result = resolveLocale(globalObject, availableLocales, requestedLocales, opt, relevantCollatorExtensionKeys, WTF_ARRAY_LENGTH(relevantCollatorExtensionKeys), localeData);</span>
  
      m_locale = result.get(&quot;locale&quot;_s);
      if (m_locale.isEmpty()) {
<span class="line-modified">!         throwTypeError(globalObject, scope, &quot;failed to initialize Collator due to invalid locale&quot;_s);</span>
          return;
      }
  
      const String&amp; collation = result.get(&quot;co&quot;_s);
      m_collation = collation.isNull() ? &quot;default&quot;_s : collation;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 245,11 ***</span>
      else if (caseFirst == &quot;upper&quot;)
          m_caseFirst = CaseFirst::Upper;
      else
          m_caseFirst = CaseFirst::False;
  
<span class="line-modified">!     String sensitivityString = intlStringOption(state, options, vm.propertyNames-&gt;sensitivity, { &quot;base&quot;, &quot;accent&quot;, &quot;case&quot;, &quot;variant&quot; }, &quot;sensitivity must be either \&quot;base\&quot;, \&quot;accent\&quot;, \&quot;case\&quot;, or \&quot;variant\&quot;&quot;, nullptr);</span>
      RETURN_IF_EXCEPTION(scope, void());
      if (sensitivityString == &quot;base&quot;)
          m_sensitivity = Sensitivity::Base;
      else if (sensitivityString == &quot;accent&quot;)
          m_sensitivity = Sensitivity::Accent;
<span class="line-new-header">--- 238,11 ---</span>
      else if (caseFirst == &quot;upper&quot;)
          m_caseFirst = CaseFirst::Upper;
      else
          m_caseFirst = CaseFirst::False;
  
<span class="line-modified">!     String sensitivityString = intlStringOption(globalObject, options, vm.propertyNames-&gt;sensitivity, { &quot;base&quot;, &quot;accent&quot;, &quot;case&quot;, &quot;variant&quot; }, &quot;sensitivity must be either \&quot;base\&quot;, \&quot;accent\&quot;, \&quot;case\&quot;, or \&quot;variant\&quot;&quot;, nullptr);</span>
      RETURN_IF_EXCEPTION(scope, void());
      if (sensitivityString == &quot;base&quot;)
          m_sensitivity = Sensitivity::Base;
      else if (sensitivityString == &quot;accent&quot;)
          m_sensitivity = Sensitivity::Accent;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 257,27 ***</span>
          m_sensitivity = Sensitivity::Case;
      else
          m_sensitivity = Sensitivity::Variant;
  
      bool usesFallback;
<span class="line-modified">!     bool ignorePunctuation = intlBooleanOption(state, options, vm.propertyNames-&gt;ignorePunctuation, usesFallback);</span>
      if (usesFallback)
          ignorePunctuation = false;
      RETURN_IF_EXCEPTION(scope, void());
      m_ignorePunctuation = ignorePunctuation;
  
      m_initializedCollator = true;
  }
  
<span class="line-modified">! void IntlCollator::createCollator(ExecState&amp; state)</span>
  {
<span class="line-modified">!     VM&amp; vm = state.vm();</span>
      auto scope = DECLARE_CATCH_SCOPE(vm);
      ASSERT(!m_collator);
  
      if (!m_initializedCollator) {
<span class="line-modified">!         initializeCollator(state, jsUndefined(), jsUndefined());</span>
          scope.assertNoException();
      }
  
      UErrorCode status = U_ZERO_ERROR;
      auto collator = std::unique_ptr&lt;UCollator, UCollatorDeleter&gt;(ucol_open(m_locale.utf8().data(), &amp;status));
<span class="line-new-header">--- 250,27 ---</span>
          m_sensitivity = Sensitivity::Case;
      else
          m_sensitivity = Sensitivity::Variant;
  
      bool usesFallback;
<span class="line-modified">!     bool ignorePunctuation = intlBooleanOption(globalObject, options, vm.propertyNames-&gt;ignorePunctuation, usesFallback);</span>
      if (usesFallback)
          ignorePunctuation = false;
      RETURN_IF_EXCEPTION(scope, void());
      m_ignorePunctuation = ignorePunctuation;
  
      m_initializedCollator = true;
  }
  
<span class="line-modified">! void IntlCollator::createCollator(JSGlobalObject* globalObject)</span>
  {
<span class="line-modified">!     VM&amp; vm = globalObject-&gt;vm();</span>
      auto scope = DECLARE_CATCH_SCOPE(vm);
      ASSERT(!m_collator);
  
      if (!m_initializedCollator) {
<span class="line-modified">!         initializeCollator(globalObject, jsUndefined(), jsUndefined());</span>
          scope.assertNoException();
      }
  
      UErrorCode status = U_ZERO_ERROR;
      auto collator = std::unique_ptr&lt;UCollator, UCollatorDeleter&gt;(ucol_open(m_locale.utf8().data(), &amp;status));
</pre>
<hr />
<pre>
<span class="line-old-header">*** 327,28 ***</span>
          return;
  
      m_collator = WTFMove(collator);
  }
  
<span class="line-modified">! JSValue IntlCollator::compareStrings(ExecState&amp; state, StringView x, StringView y)</span>
  {
<span class="line-modified">!     VM&amp; vm = state.vm();</span>
      auto scope = DECLARE_THROW_SCOPE(vm);
  
      // 10.3.4 CompareStrings abstract operation (ECMA-402 2.0)
      if (!m_collator) {
<span class="line-modified">!         createCollator(state);</span>
          if (!m_collator)
<span class="line-modified">!             return throwException(&amp;state, scope, createError(&amp;state, &quot;Failed to compare strings.&quot;_s));</span>
      }
  
      UErrorCode status = U_ZERO_ERROR;
<span class="line-modified">!     UCharIterator iteratorX = createIterator(x);</span>
<span class="line-modified">!     UCharIterator iteratorY = createIterator(y);</span>
<span class="line-modified">!     auto result = ucol_strcollIter(m_collator.get(), &amp;iteratorX, &amp;iteratorY, &amp;status);</span>
      if (U_FAILURE(status))
<span class="line-modified">!         return throwException(&amp;state, scope, createError(&amp;state, &quot;Failed to compare strings.&quot;_s));</span>
      return jsNumber(result);
  }
  
  ASCIILiteral IntlCollator::usageString(Usage usage)
  {
<span class="line-new-header">--- 320,43 ---</span>
          return;
  
      m_collator = WTFMove(collator);
  }
  
<span class="line-modified">! JSValue IntlCollator::compareStrings(JSGlobalObject* globalObject, StringView x, StringView y)</span>
  {
<span class="line-modified">!     VM&amp; vm = globalObject-&gt;vm();</span>
      auto scope = DECLARE_THROW_SCOPE(vm);
  
      // 10.3.4 CompareStrings abstract operation (ECMA-402 2.0)
      if (!m_collator) {
<span class="line-modified">!         createCollator(globalObject);</span>
          if (!m_collator)
<span class="line-modified">!             return throwException(globalObject, scope, createError(globalObject, &quot;Failed to compare strings.&quot;_s));</span>
      }
  
      UErrorCode status = U_ZERO_ERROR;
<span class="line-modified">!     UCollationResult result = UCOL_EQUAL;</span>
<span class="line-modified">!     if (x.is8Bit() &amp;&amp; y.is8Bit() &amp;&amp; x.isAllASCII() &amp;&amp; y.isAllASCII())</span>
<span class="line-modified">!         result = ucol_strcollUTF8(m_collator.get(), bitwise_cast&lt;const char*&gt;(x.characters8()), x.length(), bitwise_cast&lt;const char*&gt;(y.characters8()), y.length(), &amp;status);</span>
<span class="line-added">+     else {</span>
<span class="line-added">+         auto getCharacters = [&amp;] (const StringView&amp; view, Vector&lt;UChar&gt;&amp; buffer) -&gt; const UChar* {</span>
<span class="line-added">+             if (!view.is8Bit())</span>
<span class="line-added">+                 return view.characters16();</span>
<span class="line-added">+             buffer.resize(view.length());</span>
<span class="line-added">+             StringImpl::copyCharacters(buffer.data(), view.characters8(), view.length());</span>
<span class="line-added">+             return buffer.data();</span>
<span class="line-added">+         };</span>
<span class="line-added">+ </span>
<span class="line-added">+         Vector&lt;UChar&gt; xBuffer;</span>
<span class="line-added">+         Vector&lt;UChar&gt; yBuffer;</span>
<span class="line-added">+         const UChar* xCharacters = getCharacters(x, xBuffer);</span>
<span class="line-added">+         const UChar* yCharacters = getCharacters(y, yBuffer);</span>
<span class="line-added">+         result = ucol_strcoll(m_collator.get(), xCharacters, x.length(), yCharacters, y.length());</span>
<span class="line-added">+     }</span>
      if (U_FAILURE(status))
<span class="line-modified">!         return throwException(globalObject, scope, createError(globalObject, &quot;Failed to compare strings.&quot;_s));</span>
      return jsNumber(result);
  }
  
  ASCIILiteral IntlCollator::usageString(Usage usage)
  {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 390,13 ***</span>
      }
      ASSERT_NOT_REACHED();
      return ASCIILiteral::null();
  }
  
<span class="line-modified">! JSObject* IntlCollator::resolvedOptions(ExecState&amp; state)</span>
  {
<span class="line-modified">!     VM&amp; vm = state.vm();</span>
      auto scope = DECLARE_THROW_SCOPE(vm);
  
      // 10.3.5 Intl.Collator.prototype.resolvedOptions() (ECMA-402 2.0)
      // The function returns a new object whose properties and attributes are set as if
      // constructed by an object literal assigning to each of the following properties the
<span class="line-new-header">--- 398,13 ---</span>
      }
      ASSERT_NOT_REACHED();
      return ASCIILiteral::null();
  }
  
<span class="line-modified">! JSObject* IntlCollator::resolvedOptions(JSGlobalObject* globalObject)</span>
  {
<span class="line-modified">!     VM&amp; vm = globalObject-&gt;vm();</span>
      auto scope = DECLARE_THROW_SCOPE(vm);
  
      // 10.3.5 Intl.Collator.prototype.resolvedOptions() (ECMA-402 2.0)
      // The function returns a new object whose properties and attributes are set as if
      // constructed by an object literal assigning to each of the following properties the
</pre>
<hr />
<pre>
<span class="line-old-header">*** 405,15 ***</span>
      // in Table 1 whose keys are included in the %Collator%[[relevantExtensionKeys]]
      // internal slot of the standard built-in object that is the initial value of
      // Intl.Collator.
  
      if (!m_initializedCollator) {
<span class="line-modified">!         initializeCollator(state, jsUndefined(), jsUndefined());</span>
          scope.assertNoException();
      }
  
<span class="line-modified">!     JSObject* options = constructEmptyObject(&amp;state);</span>
      options-&gt;putDirect(vm, vm.propertyNames-&gt;locale, jsString(vm, m_locale));
      options-&gt;putDirect(vm, vm.propertyNames-&gt;usage, jsNontrivialString(vm, usageString(m_usage)));
      options-&gt;putDirect(vm, vm.propertyNames-&gt;sensitivity, jsNontrivialString(vm, sensitivityString(m_sensitivity)));
      options-&gt;putDirect(vm, vm.propertyNames-&gt;ignorePunctuation, jsBoolean(m_ignorePunctuation));
      options-&gt;putDirect(vm, vm.propertyNames-&gt;collation, jsString(vm, m_collation));
<span class="line-new-header">--- 413,15 ---</span>
      // in Table 1 whose keys are included in the %Collator%[[relevantExtensionKeys]]
      // internal slot of the standard built-in object that is the initial value of
      // Intl.Collator.
  
      if (!m_initializedCollator) {
<span class="line-modified">!         initializeCollator(globalObject, jsUndefined(), jsUndefined());</span>
          scope.assertNoException();
      }
  
<span class="line-modified">!     JSObject* options = constructEmptyObject(globalObject);</span>
      options-&gt;putDirect(vm, vm.propertyNames-&gt;locale, jsString(vm, m_locale));
      options-&gt;putDirect(vm, vm.propertyNames-&gt;usage, jsNontrivialString(vm, usageString(m_usage)));
      options-&gt;putDirect(vm, vm.propertyNames-&gt;sensitivity, jsNontrivialString(vm, sensitivityString(m_sensitivity)));
      options-&gt;putDirect(vm, vm.propertyNames-&gt;ignorePunctuation, jsBoolean(m_ignorePunctuation));
      options-&gt;putDirect(vm, vm.propertyNames-&gt;collation, jsString(vm, m_collation));
</pre>
<center><a href="InternalFunction.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="IntlCollator.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>