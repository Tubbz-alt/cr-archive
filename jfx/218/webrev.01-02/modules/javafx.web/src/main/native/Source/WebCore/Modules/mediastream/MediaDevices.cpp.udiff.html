<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WebCore/Modules/mediastream/MediaDevices.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="CanvasCaptureMediaStreamTrack.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="MediaDevices.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/Modules/mediastream/MediaDevices.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -35,14 +35,15 @@</span>
  #if ENABLE(MEDIA_STREAM)
  
  #include &quot;Document.h&quot;
  #include &quot;Event.h&quot;
  #include &quot;EventNames.h&quot;
<span class="udiff-line-added">+ #include &quot;JSDOMPromiseDeferred.h&quot;</span>
  #include &quot;JSMediaDeviceInfo.h&quot;
  #include &quot;MediaTrackSupportedConstraints.h&quot;
  #include &quot;RealtimeMediaSourceSettings.h&quot;
<span class="udiff-line-modified-removed">- #include &quot;RuntimeEnabledFeatures.h&quot;</span>
<span class="udiff-line-modified-added">+ #include &quot;UserGestureIndicator.h&quot;</span>
  #include &quot;UserMediaController.h&quot;
  #include &quot;UserMediaRequest.h&quot;
  #include &lt;wtf/IsoMallocInlines.h&gt;
  #include &lt;wtf/RandomNumber.h&gt;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -59,24 +60,20 @@</span>
  
      static_assert(static_cast&lt;size_t&gt;(MediaDevices::DisplayCaptureSurfaceType::Monitor) == static_cast&lt;size_t&gt;(RealtimeMediaSourceSettings::DisplaySurfaceType::Monitor), &quot;MediaDevices::DisplayCaptureSurfaceType::Monitor is not equal to RealtimeMediaSourceSettings::DisplaySurfaceType::Monitor as expected&quot;);
      static_assert(static_cast&lt;size_t&gt;(MediaDevices::DisplayCaptureSurfaceType::Window) == static_cast&lt;size_t&gt;(RealtimeMediaSourceSettings::DisplaySurfaceType::Window), &quot;MediaDevices::DisplayCaptureSurfaceType::Window is not RealtimeMediaSourceSettings::DisplaySurfaceType::Window as expected&quot;);
      static_assert(static_cast&lt;size_t&gt;(MediaDevices::DisplayCaptureSurfaceType::Application) == static_cast&lt;size_t&gt;(RealtimeMediaSourceSettings::DisplaySurfaceType::Application), &quot;MediaDevices::DisplayCaptureSurfaceType::Application is not RealtimeMediaSourceSettings::DisplaySurfaceType::Application as expected&quot;);
      static_assert(static_cast&lt;size_t&gt;(MediaDevices::DisplayCaptureSurfaceType::Browser) == static_cast&lt;size_t&gt;(RealtimeMediaSourceSettings::DisplaySurfaceType::Browser), &quot;MediaDevices::DisplayCaptureSurfaceType::Browser is not RealtimeMediaSourceSettings::DisplaySurfaceType::Browser as expected&quot;);
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     if (auto* controller = UserMediaController::from(document.page())) {</span>
<span class="udiff-line-removed">-         m_canAccessCamera = controller-&gt;canCallGetUserMedia(document, { UserMediaController::CaptureType::Camera }) == UserMediaController::GetUserMediaAccess::CanCall;</span>
<span class="udiff-line-removed">-         m_canAccessMicrophone = controller-&gt;canCallGetUserMedia(document, { UserMediaController::CaptureType::Microphone }) == UserMediaController::GetUserMediaAccess::CanCall;</span>
<span class="udiff-line-removed">-     }</span>
  }
  
  MediaDevices::~MediaDevices() = default;
  
  void MediaDevices::stop()
  {
      if (m_deviceChangeToken) {
          auto* controller = UserMediaController::from(document()-&gt;page());
<span class="udiff-line-modified-removed">-         controller-&gt;removeDeviceChangeObserver(m_deviceChangeToken);</span>
<span class="udiff-line-modified-added">+         if (controller)</span>
<span class="udiff-line-added">+             controller-&gt;removeDeviceChangeObserver(m_deviceChangeToken);</span>
      }
      m_devices.clear();
      m_scheduledEventTimer.stop();
  }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -102,47 +99,88 @@</span>
              return createMediaConstraints(trackConstraints);
          }
      );
  }
  
<span class="udiff-line-modified-removed">- void MediaDevices::getUserMedia(const StreamConstraints&amp; constraints, Promise&amp;&amp; promise) const</span>
<span class="udiff-line-modified-added">+ bool MediaDevices::computeUserGesturePriviledge(GestureAllowedRequest requestType)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     auto* currentGestureToken = UserGestureIndicator::currentUserGesture().get();</span>
<span class="udiff-line-added">+     if (m_currentGestureToken.get() != currentGestureToken) {</span>
<span class="udiff-line-added">+         m_currentGestureToken = makeWeakPtr(currentGestureToken);</span>
<span class="udiff-line-added">+         m_requestTypesForCurrentGesture = { };</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     bool isUserGesturePriviledged = m_currentGestureToken &amp;&amp; !m_requestTypesForCurrentGesture.contains(requestType);</span>
<span class="udiff-line-added">+     m_requestTypesForCurrentGesture.add(requestType);</span>
<span class="udiff-line-added">+     return isUserGesturePriviledged;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void MediaDevices::getUserMedia(const StreamConstraints&amp; constraints, Promise&amp;&amp; promise)</span>
  {
      auto* document = this-&gt;document();
<span class="udiff-line-modified-removed">-     if (!document)</span>
<span class="udiff-line-modified-added">+     if (!document || !document-&gt;isFullyActive()) {</span>
<span class="udiff-line-added">+         promise.reject(Exception { InvalidStateError, &quot;Document is not fully active&quot;_s });</span>
          return;
<span class="udiff-line-added">+     }</span>
  
      auto audioConstraints = createMediaConstraints(constraints.audio);
      auto videoConstraints = createMediaConstraints(constraints.video);
<span class="udiff-line-modified-removed">-     if (videoConstraints.isValid)</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-added">+     bool isUserGesturePriviledged = false;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (audioConstraints.isValid)</span>
<span class="udiff-line-added">+         isUserGesturePriviledged |= computeUserGesturePriviledge(GestureAllowedRequest::Microphone);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (videoConstraints.isValid) {</span>
<span class="udiff-line-added">+         isUserGesturePriviledged |= computeUserGesturePriviledge(GestureAllowedRequest::Camera);</span>
          videoConstraints.setDefaultVideoConstraints();
<span class="udiff-line-added">+     }</span>
  
<span class="udiff-line-modified-removed">-     auto request = UserMediaRequest::create(*document, { MediaStreamRequest::Type::UserMedia, WTFMove(audioConstraints), WTFMove(videoConstraints) }, WTFMove(promise));</span>
<span class="udiff-line-modified-added">+     auto request = UserMediaRequest::create(*document, { MediaStreamRequest::Type::UserMedia, WTFMove(audioConstraints), WTFMove(videoConstraints), isUserGesturePriviledged }, WTFMove(promise));</span>
      request-&gt;start();
  }
  
<span class="udiff-line-modified-removed">- void MediaDevices::getDisplayMedia(const StreamConstraints&amp; constraints, Promise&amp;&amp; promise) const</span>
<span class="udiff-line-modified-added">+ void MediaDevices::getDisplayMedia(const DisplayMediaStreamConstraints&amp; constraints, Promise&amp;&amp; promise)</span>
  {
      auto* document = this-&gt;document();
      if (!document)
          return;
  
<span class="udiff-line-modified-removed">-     if (!m_disableGetDisplayMediaUserGestureConstraint &amp;&amp; !UserGestureIndicator::processingUserGesture()) {</span>
<span class="udiff-line-modified-added">+     bool isUserGesturePriviledged = computeUserGesturePriviledge(GestureAllowedRequest::Display);</span>
<span class="udiff-line-added">+     if (!isUserGesturePriviledged) {</span>
          promise.reject(Exception { InvalidAccessError, &quot;getDisplayMedia must be called from a user gesture handler.&quot;_s });
          return;
      }
  
<span class="udiff-line-modified-removed">-     auto request = UserMediaRequest::create(*document, { MediaStreamRequest::Type::DisplayMedia, { }, createMediaConstraints(constraints.video) }, WTFMove(promise));</span>
<span class="udiff-line-modified-added">+     auto request = UserMediaRequest::create(*document, { MediaStreamRequest::Type::DisplayMedia, { }, createMediaConstraints(constraints.video), isUserGesturePriviledged }, WTFMove(promise));</span>
      request-&gt;start();
  }
  
<span class="udiff-line-added">+ static inline bool checkCameraAccess(const Document&amp; document)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     return isFeaturePolicyAllowedByDocumentAndAllOwners(FeaturePolicy::Type::Camera, document, LogFeaturePolicyFailure::No);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ static inline bool checkMicrophoneAccess(const Document&amp; document)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     return isFeaturePolicyAllowedByDocumentAndAllOwners(FeaturePolicy::Type::Microphone, document, LogFeaturePolicyFailure::No);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  void MediaDevices::refreshDevices(const Vector&lt;CaptureDevice&gt;&amp; newDevices)
  {
<span class="udiff-line-added">+     auto* document = this-&gt;document();</span>
<span class="udiff-line-added">+     if (!document)</span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     bool canAccessCamera = checkCameraAccess(*document);</span>
<span class="udiff-line-added">+     bool canAccessMicrophone = checkMicrophoneAccess(*document);</span>
<span class="udiff-line-added">+ </span>
      Vector&lt;Ref&lt;MediaDeviceInfo&gt;&gt; devices;
      for (auto&amp; newDevice : newDevices) {
<span class="udiff-line-modified-removed">-         if (!m_canAccessMicrophone &amp;&amp; newDevice.type() == CaptureDevice::DeviceType::Microphone)</span>
<span class="udiff-line-modified-added">+         if (!canAccessMicrophone &amp;&amp; newDevice.type() == CaptureDevice::DeviceType::Microphone)</span>
              continue;
<span class="udiff-line-modified-removed">-         if (!m_canAccessCamera &amp;&amp; newDevice.type() == CaptureDevice::DeviceType::Camera)</span>
<span class="udiff-line-modified-added">+         if (!canAccessCamera &amp;&amp; newDevice.type() == CaptureDevice::DeviceType::Camera)</span>
              continue;
  
          auto index = m_devices.findMatching([&amp;newDevice](auto&amp; oldDevice) {
              return oldDevice-&gt;deviceId() == newDevice.persistentId();
          });
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -166,12 +204,13 @@</span>
      auto* controller = UserMediaController::from(document-&gt;page());
      if (!controller) {
          promise.resolve({ });
          return;
      }
<span class="udiff-line-modified-removed">-     if (!m_canAccessCamera &amp;&amp; !m_canAccessMicrophone) {</span>
<span class="udiff-line-modified-removed">-         controller-&gt;logGetUserMediaDenial(*document, UserMediaController::GetUserMediaAccess::BlockedByFeaturePolicy, UserMediaController::BlockedCaller::EnumerateDevices);</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+     if (!checkCameraAccess(*document) &amp;&amp; !checkMicrophoneAccess(*document)) {</span>
<span class="udiff-line-added">+         controller-&gt;logEnumerateDevicesDenial(*document);</span>
          promise.resolve({ });
          return;
      }
  
      controller-&gt;enumerateMediaDevices(*document, [this, weakThis = makeWeakPtr(this), promise = WTFMove(promise)](const auto&amp; newDevices, const auto&amp; deviceIDHashSalt) mutable {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -217,27 +256,25 @@</span>
  const char* MediaDevices::activeDOMObjectName() const
  {
      return &quot;MediaDevices&quot;;
  }
  
<span class="udiff-line-removed">- bool MediaDevices::canSuspendForDocumentSuspension() const</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-     return true;</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
  void MediaDevices::listenForDeviceChanges()
  {
<span class="udiff-line-removed">-     if (m_listeningForDeviceChanges || (!m_canAccessCamera &amp;&amp; !m_canAccessMicrophone))</span>
<span class="udiff-line-removed">-         return;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     m_listeningForDeviceChanges = true;</span>
<span class="udiff-line-removed">- </span>
      auto* document = this-&gt;document();
      auto* controller = document ? UserMediaController::from(document-&gt;page()) : nullptr;
      if (!controller)
          return;
  
<span class="udiff-line-added">+     bool canAccessCamera = isFeaturePolicyAllowedByDocumentAndAllOwners(FeaturePolicy::Type::Camera, *document, LogFeaturePolicyFailure::No);</span>
<span class="udiff-line-added">+     bool canAccessMicrophone = isFeaturePolicyAllowedByDocumentAndAllOwners(FeaturePolicy::Type::Microphone, *document, LogFeaturePolicyFailure::No);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (m_listeningForDeviceChanges || (!canAccessCamera &amp;&amp; !canAccessMicrophone))</span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     m_listeningForDeviceChanges = true;</span>
<span class="udiff-line-added">+ </span>
      m_deviceChangeToken = controller-&gt;addDeviceChangeObserver([weakThis = makeWeakPtr(*this), this]() {
          if (!weakThis || isContextStopped() || m_scheduledEventTimer.isActive())
              return;
  
          m_scheduledEventTimer.startOneShot(Seconds(randomNumber() / 2));
</pre>
<center><a href="CanvasCaptureMediaStreamTrack.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="MediaDevices.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>