<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.web/src/main/native/Source/JavaScriptCore/heap/IsoSubspace.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="IsoCellSetInlines.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="IsoSubspace.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/JavaScriptCore/heap/IsoSubspace.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 27,28 ***</span>
  #include &quot;IsoSubspace.h&quot;
  
  #include &quot;AllocatorInlines.h&quot;
  #include &quot;BlockDirectoryInlines.h&quot;
  #include &quot;IsoAlignedMemoryAllocator.h&quot;
  #include &quot;IsoSubspaceInlines.h&quot;
  #include &quot;LocalAllocatorInlines.h&quot;
  
  namespace JSC {
  
<span class="line-modified">! IsoSubspace::IsoSubspace(CString name, Heap&amp; heap, HeapCellType* heapCellType, size_t size)</span>
      : Subspace(name, heap)
<span class="line-modified">!     , m_size(size)</span>
<span class="line-removed">-     , m_directory(&amp;heap, WTF::roundUpToMultipleOf&lt;MarkedBlock::atomSize&gt;(size))</span>
      , m_localAllocator(&amp;m_directory)
<span class="line-modified">!     , m_isoAlignedMemoryAllocator(makeUnique&lt;IsoAlignedMemoryAllocator&gt;())</span>
  {
      initialize(heapCellType, m_isoAlignedMemoryAllocator.get());
  
      auto locker = holdLock(m_space.directoryLock());
      m_directory.setSubspace(this);
      m_space.addBlockDirectory(locker, &amp;m_directory);
<span class="line-modified">!     m_alignedMemoryAllocator-&gt;registerDirectory(&amp;m_directory);</span>
      m_firstDirectory = &amp;m_directory;
  }
  
  IsoSubspace::~IsoSubspace()
  {
<span class="line-new-header">--- 27,33 ---</span>
  #include &quot;IsoSubspace.h&quot;
  
  #include &quot;AllocatorInlines.h&quot;
  #include &quot;BlockDirectoryInlines.h&quot;
  #include &quot;IsoAlignedMemoryAllocator.h&quot;
<span class="line-added">+ #include &quot;IsoCellSetInlines.h&quot;</span>
  #include &quot;IsoSubspaceInlines.h&quot;
  #include &quot;LocalAllocatorInlines.h&quot;
<span class="line-added">+ #include &quot;MarkedSpaceInlines.h&quot;</span>
  
  namespace JSC {
  
<span class="line-modified">! IsoSubspace::IsoSubspace(CString name, Heap&amp; heap, HeapCellType* heapCellType, size_t size, uint8_t numberOfLowerTierCells)</span>
      : Subspace(name, heap)
<span class="line-modified">!     , m_directory(WTF::roundUpToMultipleOf&lt;MarkedBlock::atomSize&gt;(size))</span>
      , m_localAllocator(&amp;m_directory)
<span class="line-modified">!     , m_isoAlignedMemoryAllocator(makeUnique&lt;IsoAlignedMemoryAllocator&gt;(name))</span>
  {
<span class="line-added">+     m_remainingLowerTierCellCount = numberOfLowerTierCells;</span>
<span class="line-added">+     ASSERT(WTF::roundUpToMultipleOf&lt;MarkedBlock::atomSize&gt;(size) == cellSize());</span>
<span class="line-added">+     ASSERT(numberOfLowerTierCells &lt;= MarkedBlock::maxNumberOfLowerTierCells);</span>
<span class="line-added">+     m_isIsoSubspace = true;</span>
      initialize(heapCellType, m_isoAlignedMemoryAllocator.get());
  
      auto locker = holdLock(m_space.directoryLock());
      m_directory.setSubspace(this);
      m_space.addBlockDirectory(locker, &amp;m_directory);
<span class="line-modified">!     m_alignedMemoryAllocator-&gt;registerDirectory(heap, &amp;m_directory);</span>
      m_firstDirectory = &amp;m_directory;
  }
  
  IsoSubspace::~IsoSubspace()
  {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 62,19 ***</span>
  void* IsoSubspace::allocate(VM&amp; vm, size_t size, GCDeferralContext* deferralContext, AllocationFailureMode failureMode)
  {
      return allocateNonVirtual(vm, size, deferralContext, failureMode);
  }
  
<span class="line-modified">! void IsoSubspace::didResizeBits(size_t blockIndex)</span>
  {
      m_cellSets.forEach(
          [&amp;] (IsoCellSet* set) {
              set-&gt;didResizeBits(blockIndex);
          });
  }
  
<span class="line-modified">! void IsoSubspace::didRemoveBlock(size_t blockIndex)</span>
  {
      m_cellSets.forEach(
          [&amp;] (IsoCellSet* set) {
              set-&gt;didRemoveBlock(blockIndex);
          });
<span class="line-new-header">--- 67,19 ---</span>
  void* IsoSubspace::allocate(VM&amp; vm, size_t size, GCDeferralContext* deferralContext, AllocationFailureMode failureMode)
  {
      return allocateNonVirtual(vm, size, deferralContext, failureMode);
  }
  
<span class="line-modified">! void IsoSubspace::didResizeBits(unsigned blockIndex)</span>
  {
      m_cellSets.forEach(
          [&amp;] (IsoCellSet* set) {
              set-&gt;didResizeBits(blockIndex);
          });
  }
  
<span class="line-modified">! void IsoSubspace::didRemoveBlock(unsigned blockIndex)</span>
  {
      m_cellSets.forEach(
          [&amp;] (IsoCellSet* set) {
              set-&gt;didRemoveBlock(blockIndex);
          });
</pre>
<hr />
<pre>
<span class="line-old-header">*** 86,7 ***</span>
<span class="line-new-header">--- 91,45 ---</span>
          [&amp;] (IsoCellSet* set) {
              set-&gt;sweepToFreeList(block);
          });
  }
  
<span class="line-added">+ void* IsoSubspace::tryAllocateFromLowerTier()</span>
<span class="line-added">+ {</span>
<span class="line-added">+     auto revive = [&amp;] (PreciseAllocation* allocation) {</span>
<span class="line-added">+         allocation-&gt;setIndexInSpace(m_space.m_preciseAllocations.size());</span>
<span class="line-added">+         allocation-&gt;m_hasValidCell = true;</span>
<span class="line-added">+         m_space.m_preciseAllocations.append(allocation);</span>
<span class="line-added">+         if (auto* set = m_space.preciseAllocationSet())</span>
<span class="line-added">+             set-&gt;add(allocation-&gt;cell());</span>
<span class="line-added">+         ASSERT(allocation-&gt;indexInSpace() == m_space.m_preciseAllocations.size() - 1);</span>
<span class="line-added">+         m_preciseAllocations.append(allocation);</span>
<span class="line-added">+         return allocation-&gt;cell();</span>
<span class="line-added">+     };</span>
<span class="line-added">+ </span>
<span class="line-added">+     if (!m_lowerTierFreeList.isEmpty()) {</span>
<span class="line-added">+         PreciseAllocation* allocation = m_lowerTierFreeList.begin();</span>
<span class="line-added">+         allocation-&gt;remove();</span>
<span class="line-added">+         return revive(allocation);</span>
<span class="line-added">+     }</span>
<span class="line-added">+     if (m_remainingLowerTierCellCount) {</span>
<span class="line-added">+         PreciseAllocation* allocation = PreciseAllocation::createForLowerTier(m_space.heap(), cellSize(), this, --m_remainingLowerTierCellCount);</span>
<span class="line-added">+         return revive(allocation);</span>
<span class="line-added">+     }</span>
<span class="line-added">+     return nullptr;</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ void IsoSubspace::sweepLowerTierCell(PreciseAllocation* preciseAllocation)</span>
<span class="line-added">+ {</span>
<span class="line-added">+     preciseAllocation = preciseAllocation-&gt;reuseForLowerTier();</span>
<span class="line-added">+     m_lowerTierFreeList.append(preciseAllocation);</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ void IsoSubspace::destroyLowerTierFreeList()</span>
<span class="line-added">+ {</span>
<span class="line-added">+     m_lowerTierFreeList.forEach([&amp;](PreciseAllocation* allocation) {</span>
<span class="line-added">+         allocation-&gt;destroy();</span>
<span class="line-added">+     });</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
  } // namespace JSC
  
</pre>
<center><a href="IsoCellSetInlines.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="IsoSubspace.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>