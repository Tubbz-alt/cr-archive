<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WTF/wtf/StackBounds.h</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="StackBounds.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="StackShot.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WTF/wtf/StackBounds.h</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (C) 2010-2017 Apple Inc. All Rights Reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (C) 2010-2019 Apple Inc. All Rights Reserved.</span>
   *
   * Redistribution and use in source and binary forms, with or without
   * modification, are permitted provided that the following conditions
   * are met:
   * 1. Redistributions of source code must retain the above copyright
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -32,20 +32,18 @@</span>
  
  namespace WTF {
  
  class StackBounds {
      WTF_MAKE_FAST_ALLOCATED;
<span class="udiff-line-added">+ public:</span>
  
      // This 64k number was picked because a sampling of stack usage differences
      // between consecutive entries into one of the Interpreter::execute...()
      // functions was seen to be as high as 27k. Hence, 64k is chosen as a
      // conservative availability value that is not too large but comfortably
      // exceeds 27k with some buffer for error.
<span class="udiff-line-modified-removed">-     const static size_t s_defaultAvailabilityDelta = 64 * 1024;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- public:</span>
<span class="udiff-line-removed">-     enum class StackDirection { Upward, Downward };</span>
<span class="udiff-line-modified-added">+     static constexpr size_t DefaultReservedZone = 64 * 1024;</span>
  
      static constexpr StackBounds emptyBounds() { return StackBounds(); }
  
  #if HAVE(STACK_BOUNDS_FOR_NEW_THREAD)
      // This function is only effective for newly created threads. In some platform, it returns a bogus value for the main thread.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -70,96 +68,72 @@</span>
          return m_bound;
      }
  
      size_t size() const
      {
<span class="udiff-line-modified-removed">-         if (isGrowingDownward())</span>
<span class="udiff-line-removed">-             return static_cast&lt;char*&gt;(m_origin) - static_cast&lt;char*&gt;(m_bound);</span>
<span class="udiff-line-removed">-         return static_cast&lt;char*&gt;(m_bound) - static_cast&lt;char*&gt;(m_origin);</span>
<span class="udiff-line-modified-added">+         return static_cast&lt;char*&gt;(m_origin) - static_cast&lt;char*&gt;(m_bound);</span>
      }
  
      bool isEmpty() const { return !m_origin; }
  
      bool contains(void* p) const
      {
          if (isEmpty())
              return false;
<span class="udiff-line-modified-removed">-         if (isGrowingDownward())</span>
<span class="udiff-line-removed">-             return (m_origin &gt;= p) &amp;&amp; (p &gt; m_bound);</span>
<span class="udiff-line-removed">-         return (m_bound &gt; p) &amp;&amp; (p &gt;= m_origin);</span>
<span class="udiff-line-modified-added">+         return (m_origin &gt;= p) &amp;&amp; (p &gt; m_bound);</span>
      }
  
<span class="udiff-line-modified-removed">-     void* recursionLimit(size_t minAvailableDelta = s_defaultAvailabilityDelta) const</span>
<span class="udiff-line-modified-added">+     void* recursionLimit(size_t minReservedZone = DefaultReservedZone) const</span>
      {
          checkConsistency();
<span class="udiff-line-modified-removed">-         if (isGrowingDownward())</span>
<span class="udiff-line-removed">-             return static_cast&lt;char*&gt;(m_bound) + minAvailableDelta;</span>
<span class="udiff-line-removed">-         return static_cast&lt;char*&gt;(m_bound) - minAvailableDelta;</span>
<span class="udiff-line-modified-added">+         return static_cast&lt;char*&gt;(m_bound) + minReservedZone;</span>
      }
  
      void* recursionLimit(char* startOfUserStack, size_t maxUserStack, size_t reservedZoneSize) const
      {
          checkConsistency();
          if (maxUserStack &lt; reservedZoneSize)
              reservedZoneSize = maxUserStack;
          size_t maxUserStackWithReservedZone = maxUserStack - reservedZoneSize;
  
<span class="udiff-line-modified-removed">-         if (isGrowingDownward()) {</span>
<span class="udiff-line-modified-removed">-             char* endOfStackWithReservedZone = reinterpret_cast&lt;char*&gt;(m_bound) + reservedZoneSize;</span>
<span class="udiff-line-removed">-             if (startOfUserStack &lt; endOfStackWithReservedZone)</span>
<span class="udiff-line-removed">-                 return endOfStackWithReservedZone;</span>
<span class="udiff-line-removed">-             size_t availableUserStack = startOfUserStack - endOfStackWithReservedZone;</span>
<span class="udiff-line-removed">-             if (maxUserStackWithReservedZone &gt; availableUserStack)</span>
<span class="udiff-line-removed">-                 maxUserStackWithReservedZone = availableUserStack;</span>
<span class="udiff-line-removed">-             return startOfUserStack - maxUserStackWithReservedZone;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         char* endOfStackWithReservedZone = reinterpret_cast&lt;char*&gt;(m_bound) - reservedZoneSize;</span>
<span class="udiff-line-removed">-         if (startOfUserStack &gt; endOfStackWithReservedZone)</span>
<span class="udiff-line-modified-added">+         char* endOfStackWithReservedZone = reinterpret_cast&lt;char*&gt;(m_bound) + reservedZoneSize;</span>
<span class="udiff-line-modified-added">+         if (startOfUserStack &lt; endOfStackWithReservedZone)</span>
              return endOfStackWithReservedZone;
<span class="udiff-line-modified-removed">-         size_t availableUserStack = endOfStackWithReservedZone - startOfUserStack;</span>
<span class="udiff-line-modified-added">+         size_t availableUserStack = startOfUserStack - endOfStackWithReservedZone;</span>
          if (maxUserStackWithReservedZone &gt; availableUserStack)
              maxUserStackWithReservedZone = availableUserStack;
<span class="udiff-line-modified-removed">-         return startOfUserStack + maxUserStackWithReservedZone;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     bool isGrowingDownward() const</span>
<span class="udiff-line-removed">-     {</span>
<span class="udiff-line-removed">- #if PLATFORM(JAVA)</span>
<span class="udiff-line-removed">-         //that is OK to have m_bound==0 on the main thread.</span>
<span class="udiff-line-removed">-         ASSERT(m_origin);</span>
<span class="udiff-line-removed">- #else</span>
<span class="udiff-line-removed">-         ASSERT(m_origin &amp;&amp; m_bound);</span>
<span class="udiff-line-removed">- #endif</span>
<span class="udiff-line-removed">-         return m_bound &lt;= m_origin;</span>
<span class="udiff-line-modified-added">+         return startOfUserStack - maxUserStackWithReservedZone;</span>
      }
  
  private:
      StackBounds(void* origin, void* end)
          : m_origin(origin)
          , m_bound(end)
      {
<span class="udiff-line-added">+         ASSERT(isGrowingDownwards());</span>
      }
  
      constexpr StackBounds()
          : m_origin(nullptr)
          , m_bound(nullptr)
      {
      }
  
<span class="udiff-line-modified-removed">-     static StackDirection stackDirection();</span>
<span class="udiff-line-modified-added">+     inline bool isGrowingDownwards() const</span>
<span class="udiff-line-added">+     {</span>
<span class="udiff-line-added">+         ASSERT(m_origin &amp;&amp; m_bound);</span>
<span class="udiff-line-added">+         return m_bound &lt;= m_origin;</span>
<span class="udiff-line-added">+     }</span>
  
      WTF_EXPORT_PRIVATE static StackBounds currentThreadStackBoundsInternal();
  
      void checkConsistency() const
      {
<span class="udiff-line-modified-removed">- #if !ASSERT_DISABLED</span>
<span class="udiff-line-modified-added">+ #if ASSERT_ENABLED</span>
          void* currentPosition = currentStackPointer();
          ASSERT(m_origin != m_bound);
<span class="udiff-line-modified-removed">-         ASSERT(isGrowingDownward()</span>
<span class="udiff-line-removed">-             ? (currentPosition &lt; m_origin &amp;&amp; currentPosition &gt; m_bound)</span>
<span class="udiff-line-removed">-             : (currentPosition &gt; m_origin &amp;&amp; currentPosition &lt; m_bound));</span>
<span class="udiff-line-modified-added">+         ASSERT(currentPosition &lt; m_origin &amp;&amp; currentPosition &gt; m_bound);</span>
  #endif
      }
  
      void* m_origin;
      void* m_bound;
</pre>
<center><a href="StackBounds.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="StackShot.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>