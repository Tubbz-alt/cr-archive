<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.web/src/main/native/Source/JavaScriptCore/heap/SlotVisitor.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="PackedCellPtr.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="SlotVisitor.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/JavaScriptCore/heap/SlotVisitor.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 31,10 ***</span>
<span class="line-new-header">--- 31,11 ---</span>
  #include &quot;ConservativeRoots.h&quot;
  #include &quot;GCSegmentedArrayInlines.h&quot;
  #include &quot;HeapAnalyzer.h&quot;
  #include &quot;HeapCellInlines.h&quot;
  #include &quot;HeapProfiler.h&quot;
<span class="line-added">+ #include &quot;IntegrityInlines.h&quot;</span>
  #include &quot;JSArray.h&quot;
  #include &quot;JSDestructibleObject.h&quot;
  #include &quot;JSObject.h&quot;
  #include &quot;JSString.h&quot;
  #include &quot;JSCInlines.h&quot;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 86,11 ***</span>
      , m_visitCount(0)
      , m_isInParallelMode(false)
      , m_markingVersion(MarkedSpace::initialVersion)
      , m_heap(heap)
      , m_codeName(codeName)
<span class="line-modified">! #if !ASSERT_DISABLED</span>
      , m_isCheckingForDefaultMarkViolation(false)
      , m_isDraining(false)
  #endif
  {
  }
<span class="line-new-header">--- 87,11 ---</span>
      , m_visitCount(0)
      , m_isInParallelMode(false)
      , m_markingVersion(MarkedSpace::initialVersion)
      , m_heap(heap)
      , m_codeName(codeName)
<span class="line-modified">! #if ASSERT_ENABLED</span>
      , m_isCheckingForDefaultMarkViolation(false)
      , m_isDraining(false)
  #endif
  {
  }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 206,11 ***</span>
  #endif
      };
  
      // In debug mode, we validate before marking since this makes it clearer what the problem
      // was. It&#39;s also slower, so we don&#39;t do it normally.
<span class="line-modified">!     if (!ASSERT_DISABLED &amp;&amp; isJSCellKind(heapCell-&gt;cellKind()))</span>
          validateCell(static_cast&lt;JSCell*&gt;(heapCell));
  
      if (Heap::testAndSetMarked(m_markingVersion, heapCell))
          return;
  
<span class="line-new-header">--- 207,11 ---</span>
  #endif
      };
  
      // In debug mode, we validate before marking since this makes it clearer what the problem
      // was. It&#39;s also slower, so we don&#39;t do it normally.
<span class="line-modified">!     if (ASSERT_ENABLED &amp;&amp; isJSCellKind(heapCell-&gt;cellKind()))</span>
          validateCell(static_cast&lt;JSCell*&gt;(heapCell));
  
      if (Heap::testAndSetMarked(m_markingVersion, heapCell))
          return;
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 219,10 ***</span>
<span class="line-new-header">--- 220,11 ---</span>
      case HeapCell::JSCellWithInteriorPointers: {
          // We have ample budget to perform validation here.
  
          JSCell* jsCell = static_cast&lt;JSCell*&gt;(heapCell);
          validateCell(jsCell);
<span class="line-added">+         Integrity::auditCell(vm(), jsCell);</span>
  
          jsCell-&gt;setCellState(CellState::PossiblyGrey);
  
          appendToMarkStack(jsCell);
          return;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 253,12 ***</span>
  
  #if ENABLE(GC_VALIDATION)
      validate(cell);
  #endif
  
<span class="line-modified">!     if (cell-&gt;isLargeAllocation())</span>
<span class="line-modified">!         setMarkedAndAppendToMarkStack(cell-&gt;largeAllocation(), cell, dependency);</span>
      else
          setMarkedAndAppendToMarkStack(cell-&gt;markedBlock(), cell, dependency);
  }
  
  template&lt;typename ContainerType&gt;
<span class="line-new-header">--- 255,12 ---</span>
  
  #if ENABLE(GC_VALIDATION)
      validate(cell);
  #endif
  
<span class="line-modified">!     if (cell-&gt;isPreciseAllocation())</span>
<span class="line-modified">!         setMarkedAndAppendToMarkStack(cell-&gt;preciseAllocation(), cell, dependency);</span>
      else
          setMarkedAndAppendToMarkStack(cell-&gt;markedBlock(), cell, dependency);
  }
  
  template&lt;typename ContainerType&gt;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 277,22 ***</span>
      appendToMarkStack(container, cell);
  }
  
  void SlotVisitor::appendToMarkStack(JSCell* cell)
  {
<span class="line-modified">!     if (cell-&gt;isLargeAllocation())</span>
<span class="line-modified">!         appendToMarkStack(cell-&gt;largeAllocation(), cell);</span>
      else
          appendToMarkStack(cell-&gt;markedBlock(), cell);
  }
  
  template&lt;typename ContainerType&gt;
  ALWAYS_INLINE void SlotVisitor::appendToMarkStack(ContainerType&amp; container, JSCell* cell)
  {
      ASSERT(m_heap.isMarked(cell));
  #if CPU(X86_64)
<span class="line-modified">!     if (Options::dumpZappedCellCrashData()) {</span>
          if (UNLIKELY(cell-&gt;isZapped()))
              reportZappedCellAndCrash(cell);
      }
  #endif
      ASSERT(!cell-&gt;isZapped());
<span class="line-new-header">--- 279,22 ---</span>
      appendToMarkStack(container, cell);
  }
  
  void SlotVisitor::appendToMarkStack(JSCell* cell)
  {
<span class="line-modified">!     if (cell-&gt;isPreciseAllocation())</span>
<span class="line-modified">!         appendToMarkStack(cell-&gt;preciseAllocation(), cell);</span>
      else
          appendToMarkStack(cell-&gt;markedBlock(), cell);
  }
  
  template&lt;typename ContainerType&gt;
  ALWAYS_INLINE void SlotVisitor::appendToMarkStack(ContainerType&amp; container, JSCell* cell)
  {
      ASSERT(m_heap.isMarked(cell));
  #if CPU(X86_64)
<span class="line-modified">!     if (UNLIKELY(Options::dumpZappedCellCrashData())) {</span>
          if (UNLIKELY(cell-&gt;isZapped()))
              reportZappedCellAndCrash(cell);
      }
  #endif
      ASSERT(!cell-&gt;isZapped());
</pre>
<hr />
<pre>
<span class="line-old-header">*** 393,11 ***</span>
  
      default:
          // FIXME: This could be so much better.
          // https://bugs.webkit.org/show_bug.cgi?id=162462
  #if CPU(X86_64)
<span class="line-modified">!         if (Options::dumpZappedCellCrashData()) {</span>
              Structure* structure = cell-&gt;structure(vm());
              if (LIKELY(structure)) {
                  const MethodTable* methodTable = &amp;structure-&gt;classInfo()-&gt;methodTable;
                  methodTable-&gt;visitChildren(const_cast&lt;JSCell*&gt;(cell), *this);
                  break;
<span class="line-new-header">--- 395,11 ---</span>
  
      default:
          // FIXME: This could be so much better.
          // https://bugs.webkit.org/show_bug.cgi?id=162462
  #if CPU(X86_64)
<span class="line-modified">!         if (UNLIKELY(Options::dumpZappedCellCrashData())) {</span>
              Structure* structure = cell-&gt;structure(vm());
              if (LIKELY(structure)) {
                  const MethodTable* methodTable = &amp;structure-&gt;classInfo()-&gt;methodTable;
                  methodTable-&gt;visitChildren(const_cast&lt;JSCell*&gt;(cell), *this);
                  break;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 791,12 ***</span>
      drain(timeout);
  }
  
  void SlotVisitor::didRace(const VisitRaceKey&amp; race)
  {
<span class="line-modified">!     if (Options::verboseVisitRace())</span>
<span class="line-removed">-         dataLog(toCString(&quot;GC visit race: &quot;, race, &quot;\n&quot;));</span>
  
      auto locker = holdLock(heap()-&gt;m_raceMarkStackLock);
      JSCell* cell = race.cell();
      cell-&gt;setCellState(CellState::PossiblyGrey);
      heap()-&gt;m_raceMarkStack-&gt;append(cell);
<span class="line-new-header">--- 793,11 ---</span>
      drain(timeout);
  }
  
  void SlotVisitor::didRace(const VisitRaceKey&amp; race)
  {
<span class="line-modified">!     dataLogLnIf(Options::verboseVisitRace(), toCString(&quot;GC visit race: &quot;, race));</span>
  
      auto locker = holdLock(heap()-&gt;m_raceMarkStackLock);
      JSCell* cell = race.cell();
      cell-&gt;setCellState(CellState::PossiblyGrey);
      heap()-&gt;m_raceMarkStack-&gt;append(cell);
</pre>
<center><a href="PackedCellPtr.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="SlotVisitor.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>