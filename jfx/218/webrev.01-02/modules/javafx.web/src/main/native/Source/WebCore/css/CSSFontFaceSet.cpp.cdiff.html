<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.web/src/main/native/Source/WebCore/css/CSSFontFaceSet.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="CSSFontFace.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="CSSFontFaceSource.cpp.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/css/CSSFontFaceSet.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 155,14 ***</span>
      }
  }
  
  void CSSFontFaceSet::addToFacesLookupTable(CSSFontFace&amp; face)
  {
<span class="line-modified">!     if (!face.families())</span>
          return;
  
<span class="line-modified">!     for (auto&amp; item : *face.families()) {</span>
          String familyName = CSSFontFaceSet::familyNameFromPrimitive(downcast&lt;CSSPrimitiveValue&gt;(item.get()));
          if (familyName.isEmpty())
              continue;
  
          auto addResult = m_facesLookupTable.add(familyName, Vector&lt;Ref&lt;CSSFontFace&gt;&gt;());
<span class="line-new-header">--- 155,15 ---</span>
      }
  }
  
  void CSSFontFaceSet::addToFacesLookupTable(CSSFontFace&amp; face)
  {
<span class="line-modified">!     if (!face.families() || !face.families().hasValue())</span>
          return;
<span class="line-added">+     auto families = face.families().value();</span>
  
<span class="line-modified">!     for (auto&amp; item : *families) {</span>
          String familyName = CSSFontFaceSet::familyNameFromPrimitive(downcast&lt;CSSPrimitiveValue&gt;(item.get()));
          if (familyName.isEmpty())
              continue;
  
          auto addResult = m_facesLookupTable.add(familyName, Vector&lt;Ref&lt;CSSFontFace&gt;&gt;());
</pre>
<hr />
<pre>
<span class="line-old-header">*** 235,12 ***</span>
      m_cache.clear();
  
      for (auto* client : m_clients)
          client-&gt;fontModified();
  
<span class="line-modified">!     if (face.families())</span>
<span class="line-modified">!         removeFromFacesLookupTable(face, *face.families());</span>
  
      if (face.cssConnection()) {
          ASSERT(m_constituentCSSConnections.get(face.cssConnection()) == &amp;face);
          m_constituentCSSConnections.remove(face.cssConnection());
      }
<span class="line-new-header">--- 236,12 ---</span>
      m_cache.clear();
  
      for (auto* client : m_clients)
          client-&gt;fontModified();
  
<span class="line-modified">!     if (face.families() &amp;&amp; face.families().hasValue())</span>
<span class="line-modified">!         removeFromFacesLookupTable(face, *face.families().value());</span>
  
      if (face.cssConnection()) {
          ASSERT(m_constituentCSSConnections.get(face.cssConnection()) == &amp;face);
          m_constituentCSSConnections.remove(face.cssConnection());
      }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 298,29 ***</span>
  {
      ASSERT(i &lt; faceCount());
      return m_faces[i];
  }
  
<span class="line-modified">! static FontSelectionRequest computeFontSelectionRequest(MutableStyleProperties&amp; style)</span>
  {
      RefPtr&lt;CSSValue&gt; weightValue = style.getPropertyCSSValue(CSSPropertyFontWeight).get();
<span class="line-modified">!     if (!weightValue)</span>
          weightValue = CSSValuePool::singleton().createIdentifierValue(CSSValueNormal).ptr();
  
      RefPtr&lt;CSSValue&gt; stretchValue = style.getPropertyCSSValue(CSSPropertyFontStretch).get();
<span class="line-modified">!     if (!stretchValue)</span>
          stretchValue = CSSValuePool::singleton().createIdentifierValue(CSSValueNormal).ptr();
  
      RefPtr&lt;CSSValue&gt; styleValue = style.getPropertyCSSValue(CSSPropertyFontStyle).get();
<span class="line-modified">!     if (!styleValue)</span>
          styleValue = CSSFontStyleValue::create(CSSValuePool::singleton().createIdentifierValue(CSSValueNormal));
  
<span class="line-modified">!     auto weightSelectionValue = StyleBuilderConverter::convertFontWeightFromValue(*weightValue);</span>
<span class="line-modified">!     auto stretchSelectionValue = StyleBuilderConverter::convertFontStretchFromValue(*stretchValue);</span>
<span class="line-modified">!     auto styleSelectionValue = StyleBuilderConverter::convertFontStyleFromValue(*styleValue);</span>
  
<span class="line-modified">!     return { weightSelectionValue, stretchSelectionValue, styleSelectionValue };</span>
  }
  
  static HashSet&lt;UChar32&gt; codePointsFromString(StringView stringView)
  {
      HashSet&lt;UChar32&gt; result;
<span class="line-new-header">--- 299,32 ---</span>
  {
      ASSERT(i &lt; faceCount());
      return m_faces[i];
  }
  
<span class="line-modified">! static ExceptionOr&lt;FontSelectionRequest&gt; computeFontSelectionRequest(MutableStyleProperties&amp; style)</span>
  {
      RefPtr&lt;CSSValue&gt; weightValue = style.getPropertyCSSValue(CSSPropertyFontWeight).get();
<span class="line-modified">!     if (!weightValue || weightValue-&gt;isInitialValue())</span>
          weightValue = CSSValuePool::singleton().createIdentifierValue(CSSValueNormal).ptr();
  
      RefPtr&lt;CSSValue&gt; stretchValue = style.getPropertyCSSValue(CSSPropertyFontStretch).get();
<span class="line-modified">!     if (!stretchValue || stretchValue-&gt;isInitialValue())</span>
          stretchValue = CSSValuePool::singleton().createIdentifierValue(CSSValueNormal).ptr();
  
      RefPtr&lt;CSSValue&gt; styleValue = style.getPropertyCSSValue(CSSPropertyFontStyle).get();
<span class="line-modified">!     if (!styleValue || styleValue-&gt;isInitialValue())</span>
          styleValue = CSSFontStyleValue::create(CSSValuePool::singleton().createIdentifierValue(CSSValueNormal));
  
<span class="line-modified">!     if (weightValue-&gt;isGlobalKeyword() || stretchValue-&gt;isGlobalKeyword() || styleValue-&gt;isGlobalKeyword())</span>
<span class="line-modified">!         return Exception { SyntaxError };</span>
<span class="line-modified">! </span>
<span class="line-added">+     auto weightSelectionValue = Style::BuilderConverter::convertFontWeightFromValue(*weightValue);</span>
<span class="line-added">+     auto stretchSelectionValue = Style::BuilderConverter::convertFontStretchFromValue(*stretchValue);</span>
<span class="line-added">+     auto styleSelectionValue = Style::BuilderConverter::convertFontStyleFromValue(*styleValue);</span>
  
<span class="line-modified">!     return {{ weightSelectionValue, stretchSelectionValue, styleSelectionValue }};</span>
  }
  
  static HashSet&lt;UChar32&gt; codePointsFromString(StringView stringView)
  {
      HashSet&lt;UChar32&gt; result;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 342,11 ***</span>
      auto style = MutableStyleProperties::create();
      auto parseResult = CSSParser::parseValue(style, CSSPropertyFont, font, true, HTMLStandardMode);
      if (parseResult == CSSParser::ParseResult::Error)
          return Exception { SyntaxError };
  
<span class="line-modified">!     FontSelectionRequest request = computeFontSelectionRequest(style.get());</span>
  
      auto family = style-&gt;getPropertyCSSValue(CSSPropertyFontFamily);
      if (!is&lt;CSSValueList&gt;(family))
          return Exception { SyntaxError };
      CSSValueList&amp; familyList = downcast&lt;CSSValueList&gt;(*family);
<span class="line-new-header">--- 346,14 ---</span>
      auto style = MutableStyleProperties::create();
      auto parseResult = CSSParser::parseValue(style, CSSPropertyFont, font, true, HTMLStandardMode);
      if (parseResult == CSSParser::ParseResult::Error)
          return Exception { SyntaxError };
  
<span class="line-modified">!     auto requestOrException = computeFontSelectionRequest(style.get());</span>
<span class="line-added">+     if (requestOrException.hasException())</span>
<span class="line-added">+         return requestOrException.releaseException();</span>
<span class="line-added">+     auto request = requestOrException.releaseReturnValue();</span>
  
      auto family = style-&gt;getPropertyCSSValue(CSSPropertyFontFamily);
      if (!is&lt;CSSValueList&gt;(family))
          return Exception { SyntaxError };
      CSSValueList&amp; familyList = downcast&lt;CSSValueList&gt;(*family);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 418,36 ***</span>
      face = CSSSegmentedFontFace::create();
  
      Vector&lt;std::reference_wrapper&lt;CSSFontFace&gt;, 32&gt; candidateFontFaces;
      for (int i = familyFontFaces.size() - 1; i &gt;= 0; --i) {
          CSSFontFace&amp; candidate = familyFontFaces[i];
<span class="line-modified">!         auto capabilities = candidate.fontSelectionCapabilities();</span>
          if (!isItalic(request.slope) &amp;&amp; isItalic(capabilities.slope.minimum))
              continue;
          candidateFontFaces.append(candidate);
      }
  
      auto localIterator = m_locallyInstalledFacesLookupTable.find(family);
      if (localIterator != m_locallyInstalledFacesLookupTable.end()) {
          for (auto&amp; candidate : localIterator-&gt;value) {
<span class="line-modified">!             auto capabilities = candidate-&gt;fontSelectionCapabilities();</span>
              if (!isItalic(request.slope) &amp;&amp; isItalic(capabilities.slope.minimum))
                  continue;
              candidateFontFaces.append(candidate);
          }
      }
  
      if (!candidateFontFaces.isEmpty()) {
          Vector&lt;FontSelectionCapabilities&gt; capabilities;
          capabilities.reserveInitialCapacity(candidateFontFaces.size());
<span class="line-modified">!         for (auto&amp; face : candidateFontFaces)</span>
<span class="line-modified">!             capabilities.uncheckedAppend(face.get().fontSelectionCapabilities());</span>
          FontSelectionAlgorithm fontSelectionAlgorithm(request, capabilities);
          std::stable_sort(candidateFontFaces.begin(), candidateFontFaces.end(), [&amp;fontSelectionAlgorithm](const CSSFontFace&amp; first, const CSSFontFace&amp; second) {
<span class="line-modified">!             auto firstCapabilities = first.fontSelectionCapabilities();</span>
<span class="line-modified">!             auto secondCapabilities = second.fontSelectionCapabilities();</span>
  
              auto stretchDistanceFirst = fontSelectionAlgorithm.stretchDistance(firstCapabilities).distance;
              auto stretchDistanceSecond = fontSelectionAlgorithm.stretchDistance(secondCapabilities).distance;
              if (stretchDistanceFirst &lt; stretchDistanceSecond)
                  return true;
              if (stretchDistanceFirst &gt; stretchDistanceSecond)
<span class="line-new-header">--- 425,49 ---</span>
      face = CSSSegmentedFontFace::create();
  
      Vector&lt;std::reference_wrapper&lt;CSSFontFace&gt;, 32&gt; candidateFontFaces;
      for (int i = familyFontFaces.size() - 1; i &gt;= 0; --i) {
          CSSFontFace&amp; candidate = familyFontFaces[i];
<span class="line-modified">!         auto capabilitiesWrapped = candidate.fontSelectionCapabilities();</span>
<span class="line-added">+         if (!capabilitiesWrapped.hasValue())</span>
<span class="line-added">+             continue;</span>
<span class="line-added">+         auto capabilities = capabilitiesWrapped.value();</span>
          if (!isItalic(request.slope) &amp;&amp; isItalic(capabilities.slope.minimum))
              continue;
          candidateFontFaces.append(candidate);
      }
  
      auto localIterator = m_locallyInstalledFacesLookupTable.find(family);
      if (localIterator != m_locallyInstalledFacesLookupTable.end()) {
          for (auto&amp; candidate : localIterator-&gt;value) {
<span class="line-modified">!             auto capabilitiesWrapped = candidate-&gt;fontSelectionCapabilities();</span>
<span class="line-added">+             if (!capabilitiesWrapped.hasValue())</span>
<span class="line-added">+                 continue;</span>
<span class="line-added">+             auto capabilities = capabilitiesWrapped.value();</span>
              if (!isItalic(request.slope) &amp;&amp; isItalic(capabilities.slope.minimum))
                  continue;
              candidateFontFaces.append(candidate);
          }
      }
  
      if (!candidateFontFaces.isEmpty()) {
          Vector&lt;FontSelectionCapabilities&gt; capabilities;
          capabilities.reserveInitialCapacity(candidateFontFaces.size());
<span class="line-modified">!         for (auto&amp; face : candidateFontFaces) {</span>
<span class="line-modified">!             auto fontSelectionCapabilitiesWrapped = face.get().fontSelectionCapabilities();</span>
<span class="line-added">+             ASSERT(fontSelectionCapabilitiesWrapped.hasValue());</span>
<span class="line-added">+             auto fontSelectionCapabilities = fontSelectionCapabilitiesWrapped.value();</span>
<span class="line-added">+             capabilities.uncheckedAppend(fontSelectionCapabilities);</span>
<span class="line-added">+         }</span>
          FontSelectionAlgorithm fontSelectionAlgorithm(request, capabilities);
          std::stable_sort(candidateFontFaces.begin(), candidateFontFaces.end(), [&amp;fontSelectionAlgorithm](const CSSFontFace&amp; first, const CSSFontFace&amp; second) {
<span class="line-modified">!             auto firstCapabilitiesWrapped = first.fontSelectionCapabilities();</span>
<span class="line-modified">!             auto secondCapabilitiesWrapped = second.fontSelectionCapabilities();</span>
<span class="line-added">+             ASSERT(firstCapabilitiesWrapped.hasValue() &amp;&amp; secondCapabilitiesWrapped.hasValue());</span>
  
<span class="line-added">+             auto firstCapabilities = firstCapabilitiesWrapped.value();</span>
<span class="line-added">+             auto secondCapabilities = secondCapabilitiesWrapped.value();</span>
              auto stretchDistanceFirst = fontSelectionAlgorithm.stretchDistance(firstCapabilities).distance;
              auto stretchDistanceSecond = fontSelectionAlgorithm.stretchDistance(secondCapabilities).distance;
              if (stretchDistanceFirst &lt; stretchDistanceSecond)
                  return true;
              if (stretchDistanceFirst &gt; stretchDistanceSecond)
</pre>
<center><a href="CSSFontFace.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="CSSFontFaceSource.cpp.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>