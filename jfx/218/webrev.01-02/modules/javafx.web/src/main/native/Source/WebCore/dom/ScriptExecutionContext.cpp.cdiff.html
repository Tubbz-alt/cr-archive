<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.web/src/main/native/Source/WebCore/dom/ScriptExecutionContext.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="ScriptElement.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="ScriptExecutionContext.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/dom/ScriptExecutionContext.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 35,19 ***</span>
  #include &quot;DatabaseContext.h&quot;
  #include &quot;Document.h&quot;
  #include &quot;ErrorEvent.h&quot;
  #include &quot;JSDOMExceptionHandling.h&quot;
  #include &quot;JSDOMWindow.h&quot;
  #include &quot;MessagePort.h&quot;
  #include &quot;Navigator.h&quot;
  #include &quot;Page.h&quot;
  #include &quot;PublicURLManager.h&quot;
  #include &quot;RejectedPromiseTracker.h&quot;
  #include &quot;ResourceRequest.h&quot;
  #include &quot;SWClientConnection.h&quot;
  #include &quot;SWContextManager.h&quot;
<span class="line-removed">- #include &quot;SchemeRegistry.h&quot;</span>
  #include &quot;ScriptController.h&quot;
  #include &quot;ScriptDisallowedScope.h&quot;
  #include &quot;ScriptState.h&quot;
  #include &quot;ServiceWorker.h&quot;
  #include &quot;ServiceWorkerGlobalScope.h&quot;
<span class="line-new-header">--- 35,19 ---</span>
  #include &quot;DatabaseContext.h&quot;
  #include &quot;Document.h&quot;
  #include &quot;ErrorEvent.h&quot;
  #include &quot;JSDOMExceptionHandling.h&quot;
  #include &quot;JSDOMWindow.h&quot;
<span class="line-added">+ #include &quot;LegacySchemeRegistry.h&quot;</span>
  #include &quot;MessagePort.h&quot;
  #include &quot;Navigator.h&quot;
  #include &quot;Page.h&quot;
  #include &quot;PublicURLManager.h&quot;
  #include &quot;RejectedPromiseTracker.h&quot;
  #include &quot;ResourceRequest.h&quot;
  #include &quot;SWClientConnection.h&quot;
  #include &quot;SWContextManager.h&quot;
  #include &quot;ScriptController.h&quot;
  #include &quot;ScriptDisallowedScope.h&quot;
  #include &quot;ScriptState.h&quot;
  #include &quot;ServiceWorker.h&quot;
  #include &quot;ServiceWorkerGlobalScope.h&quot;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 121,17 ***</span>
          ASSERT(allScriptExecutionContextsMap().contains(m_contextIdentifier));
          allScriptExecutionContextsMap().remove(m_contextIdentifier);
      }
  }
  
<span class="line-modified">! #if ASSERT_DISABLED</span>
  
  inline void ScriptExecutionContext::checkConsistency() const
  {
  }
  
<span class="line-modified">! #else</span>
  
  void ScriptExecutionContext::checkConsistency() const
  {
      for (auto* messagePort : m_messagePorts)
          ASSERT(messagePort-&gt;scriptExecutionContext() == this);
<span class="line-new-header">--- 121,17 ---</span>
          ASSERT(allScriptExecutionContextsMap().contains(m_contextIdentifier));
          allScriptExecutionContextsMap().remove(m_contextIdentifier);
      }
  }
  
<span class="line-modified">! #if !ASSERT_ENABLED</span>
  
  inline void ScriptExecutionContext::checkConsistency() const
  {
  }
  
<span class="line-modified">! #else // ASSERT_ENABLED</span>
  
  void ScriptExecutionContext::checkConsistency() const
  {
      for (auto* messagePort : m_messagePorts)
          ASSERT(messagePort-&gt;scriptExecutionContext() == this);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 143,34 ***</span>
          ASSERT(activeDOMObject-&gt;scriptExecutionContext() == this);
          activeDOMObject-&gt;assertSuspendIfNeededWasCalled();
      }
  }
  
<span class="line-modified">! #endif</span>
  
  ScriptExecutionContext::~ScriptExecutionContext()
  {
      checkConsistency();
  
<span class="line-modified">! #if !ASSERT_DISABLED</span>
      if (m_contextIdentifier) {
          Locker&lt;Lock&gt; locker(allScriptExecutionContextsMapLock);
          ASSERT_WITH_MESSAGE(!allScriptExecutionContextsMap().contains(m_contextIdentifier),
              &quot;A ScriptExecutionContext subclass instance implementing postTask should have already removed itself from the map&quot;);
      }
  
      m_inScriptExecutionContextDestructor = true;
<span class="line-modified">! #endif</span>
  
  #if ENABLE(SERVICE_WORKER)
      setActiveServiceWorker(nullptr);
  #endif
  
      while (auto* destructionObserver = m_destructionObservers.takeAny())
          destructionObserver-&gt;contextDestroyed();
  
<span class="line-modified">! #if !ASSERT_DISABLED</span>
      m_inScriptExecutionContextDestructor = false;
  #endif
  }
  
  void ScriptExecutionContext::processMessageWithMessagePortsSoon()
<span class="line-new-header">--- 143,34 ---</span>
          ASSERT(activeDOMObject-&gt;scriptExecutionContext() == this);
          activeDOMObject-&gt;assertSuspendIfNeededWasCalled();
      }
  }
  
<span class="line-modified">! #endif // ASSERT_ENABLED</span>
  
  ScriptExecutionContext::~ScriptExecutionContext()
  {
      checkConsistency();
  
<span class="line-modified">! #if ASSERT_ENABLED</span>
      if (m_contextIdentifier) {
          Locker&lt;Lock&gt; locker(allScriptExecutionContextsMapLock);
          ASSERT_WITH_MESSAGE(!allScriptExecutionContextsMap().contains(m_contextIdentifier),
              &quot;A ScriptExecutionContext subclass instance implementing postTask should have already removed itself from the map&quot;);
      }
  
      m_inScriptExecutionContextDestructor = true;
<span class="line-modified">! #endif // ASSERT_ENABLED</span>
  
  #if ENABLE(SERVICE_WORKER)
      setActiveServiceWorker(nullptr);
  #endif
  
      while (auto* destructionObserver = m_destructionObservers.takeAny())
          destructionObserver-&gt;contextDestroyed();
  
<span class="line-modified">! #if ASSERT_ENABLED</span>
      m_inScriptExecutionContextDestructor = false;
  #endif
  }
  
  void ScriptExecutionContext::processMessageWithMessagePortsSoon()
</pre>
<hr />
<pre>
<span class="line-old-header">*** 220,42 ***</span>
  
  void ScriptExecutionContext::didLoadResourceSynchronously()
  {
  }
  
<span class="line-removed">- bool ScriptExecutionContext::canSuspendActiveDOMObjectsForDocumentSuspension(Vector&lt;ActiveDOMObject*&gt;* unsuspendableObjects)</span>
<span class="line-removed">- {</span>
<span class="line-removed">-     checkConsistency();</span>
<span class="line-removed">- </span>
<span class="line-removed">-     bool canSuspend = true;</span>
<span class="line-removed">- </span>
<span class="line-removed">-     forEachActiveDOMObject([&amp;](auto&amp; activeDOMObject) {</span>
<span class="line-removed">-         if (!activeDOMObject.canSuspendForDocumentSuspension()) {</span>
<span class="line-removed">-             canSuspend = false;</span>
<span class="line-removed">-             if (unsuspendableObjects)</span>
<span class="line-removed">-                 unsuspendableObjects-&gt;append(&amp;activeDOMObject);</span>
<span class="line-removed">-             else</span>
<span class="line-removed">-                 return ShouldContinue::No;</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-         return ShouldContinue::Yes;</span>
<span class="line-removed">-     });</span>
<span class="line-removed">- </span>
<span class="line-removed">-     if (unsuspendableObjects) {</span>
<span class="line-removed">-         // Remove activeDOMObjects that have been destroyed while we were iterating above.</span>
<span class="line-removed">-         unsuspendableObjects-&gt;removeAllMatching([&amp;](auto* activeDOMObject) {</span>
<span class="line-removed">-             return !m_activeDOMObjects.contains(activeDOMObject);</span>
<span class="line-removed">-         });</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     return canSuspend;</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
  void ScriptExecutionContext::forEachActiveDOMObject(const Function&lt;ShouldContinue(ActiveDOMObject&amp;)&gt;&amp; apply) const
  {
      // It is not allowed to run arbitrary script or construct new ActiveDOMObjects while we are iterating over ActiveDOMObjects.
      // An ASSERT_WITH_SECURITY_IMPLICATION or RELEASE_ASSERT will fire if this happens, but it&#39;s important to code
<span class="line-modified">!     // canSuspendActiveDOMObjectsForDocumentSuspension() / suspend() / resume() / stop() functions so it will not happen!</span>
      ScriptDisallowedScope scriptDisallowedScope;
      SetForScope&lt;bool&gt; activeDOMObjectAdditionForbiddenScope(m_activeDOMObjectAdditionForbidden, true);
  
      // Make a frozen copy of the objects so we can iterate while new ones might be destroyed.
      auto possibleActiveDOMObjects = copyToVector(m_activeDOMObjects);
<span class="line-new-header">--- 220,15 ---</span>
  
  void ScriptExecutionContext::didLoadResourceSynchronously()
  {
  }
  
  void ScriptExecutionContext::forEachActiveDOMObject(const Function&lt;ShouldContinue(ActiveDOMObject&amp;)&gt;&amp; apply) const
  {
      // It is not allowed to run arbitrary script or construct new ActiveDOMObjects while we are iterating over ActiveDOMObjects.
      // An ASSERT_WITH_SECURITY_IMPLICATION or RELEASE_ASSERT will fire if this happens, but it&#39;s important to code
<span class="line-modified">!     // suspend() / resume() / stop() functions so it will not happen!</span>
      ScriptDisallowedScope scriptDisallowedScope;
      SetForScope&lt;bool&gt; activeDOMObjectAdditionForbiddenScope(m_activeDOMObjectAdditionForbidden, true);
  
      // Make a frozen copy of the objects so we can iterate while new ones might be destroyed.
      auto possibleActiveDOMObjects = copyToVector(m_activeDOMObjects);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 276,11 ***</span>
  void ScriptExecutionContext::suspendActiveDOMObjects(ReasonForSuspension why)
  {
      checkConsistency();
  
      if (m_activeDOMObjectsAreSuspended) {
<span class="line-modified">!         // A page may subsequently suspend DOM objects, say as part of entering the page cache, after the embedding</span>
          // client requested the page be suspended. We ignore such requests so long as the embedding client requested
          // the suspension first. See &lt;rdar://problem/13754896&gt; for more details.
          ASSERT(m_reasonForSuspendingActiveDOMObjects == ReasonForSuspension::PageWillBeSuspended);
          return;
      }
<span class="line-new-header">--- 249,11 ---</span>
  void ScriptExecutionContext::suspendActiveDOMObjects(ReasonForSuspension why)
  {
      checkConsistency();
  
      if (m_activeDOMObjectsAreSuspended) {
<span class="line-modified">!         // A page may subsequently suspend DOM objects, say as part of entering the back/forward cache, after the embedding</span>
          // client requested the page be suspended. We ignore such requests so long as the embedding client requested
          // the suspension first. See &lt;rdar://problem/13754896&gt; for more details.
          ASSERT(m_reasonForSuspendingActiveDOMObjects == ReasonForSuspension::PageWillBeSuspended);
          return;
      }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 299,19 ***</span>
  {
      checkConsistency();
  
      if (m_reasonForSuspendingActiveDOMObjects != why)
          return;
<span class="line-removed">-     m_activeDOMObjectsAreSuspended = false;</span>
  
      forEachActiveDOMObject([](auto&amp; activeDOMObject) {
          activeDOMObject.resume();
          return ShouldContinue::Yes;
      });
  
<span class="line-modified">!     // In case there were pending messages at the time the script execution context entered PageCache,</span>
<span class="line-modified">!     // make sure those get dispatched shortly after restoring from PageCache.</span>
      processMessageWithMessagePortsSoon();
  }
  
  void ScriptExecutionContext::stopActiveDOMObjects()
  {
<span class="line-new-header">--- 272,20 ---</span>
  {
      checkConsistency();
  
      if (m_reasonForSuspendingActiveDOMObjects != why)
          return;
  
      forEachActiveDOMObject([](auto&amp; activeDOMObject) {
          activeDOMObject.resume();
          return ShouldContinue::Yes;
      });
  
<span class="line-modified">!     m_activeDOMObjectsAreSuspended = false;</span>
<span class="line-modified">! </span>
<span class="line-added">+     // In case there were pending messages at the time the script execution context entered the BackForwardCache,</span>
<span class="line-added">+     // make sure those get dispatched shortly after restoring from the BackForwardCache.</span>
      processMessageWithMessagePortsSoon();
  }
  
  void ScriptExecutionContext::stopActiveDOMObjects()
  {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 394,11 ***</span>
      auto pendingExceptions = WTFMove(m_pendingExceptions);
      for (auto&amp; exception : *pendingExceptions)
          logExceptionToConsole(exception-&gt;m_errorMessage, exception-&gt;m_sourceURL, exception-&gt;m_lineNumber, exception-&gt;m_columnNumber, WTFMove(exception-&gt;m_callStack));
  }
  
<span class="line-modified">! void ScriptExecutionContext::reportUnhandledPromiseRejection(JSC::ExecState&amp; state, JSC::JSPromise&amp; promise, RefPtr&lt;Inspector::ScriptCallStack&gt;&amp;&amp; callStack)</span>
  {
      Page* page = nullptr;
      if (is&lt;Document&gt;(this))
          page = downcast&lt;Document&gt;(this)-&gt;page();
      // FIXME: allow Workers to mute unhandled promise rejection messages.
<span class="line-new-header">--- 368,11 ---</span>
      auto pendingExceptions = WTFMove(m_pendingExceptions);
      for (auto&amp; exception : *pendingExceptions)
          logExceptionToConsole(exception-&gt;m_errorMessage, exception-&gt;m_sourceURL, exception-&gt;m_lineNumber, exception-&gt;m_columnNumber, WTFMove(exception-&gt;m_callStack));
  }
  
<span class="line-modified">! void ScriptExecutionContext::reportUnhandledPromiseRejection(JSC::JSGlobalObject&amp; state, JSC::JSPromise&amp; promise, RefPtr&lt;Inspector::ScriptCallStack&gt;&amp;&amp; callStack)</span>
  {
      Page* page = nullptr;
      if (is&lt;Document&gt;(this))
          page = downcast&lt;Document&gt;(this)-&gt;page();
      // FIXME: allow Workers to mute unhandled promise rejection messages.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 418,11 ***</span>
      else
          message = makeUnique&lt;Inspector::ConsoleMessage&gt;(MessageSource::JS, MessageType::Log, MessageLevel::Error, errorMessage);
      addConsoleMessage(WTFMove(message));
  }
  
<span class="line-modified">! void ScriptExecutionContext::addConsoleMessage(MessageSource source, MessageLevel level, const String&amp; message, const String&amp; sourceURL, unsigned lineNumber, unsigned columnNumber, JSC::ExecState* state, unsigned long requestIdentifier)</span>
  {
      addMessage(source, level, message, sourceURL, lineNumber, columnNumber, 0, state, requestIdentifier);
  }
  
  bool ScriptExecutionContext::dispatchErrorEvent(const String&amp; errorMessage, int lineNumber, int columnNumber, const String&amp; sourceURL, JSC::Exception* exception, CachedScript* cachedScript)
<span class="line-new-header">--- 392,11 ---</span>
      else
          message = makeUnique&lt;Inspector::ConsoleMessage&gt;(MessageSource::JS, MessageType::Log, MessageLevel::Error, errorMessage);
      addConsoleMessage(WTFMove(message));
  }
  
<span class="line-modified">! void ScriptExecutionContext::addConsoleMessage(MessageSource source, MessageLevel level, const String&amp; message, const String&amp; sourceURL, unsigned lineNumber, unsigned columnNumber, JSC::JSGlobalObject* state, unsigned long requestIdentifier)</span>
  {
      addMessage(source, level, message, sourceURL, lineNumber, columnNumber, 0, state, requestIdentifier);
  }
  
  bool ScriptExecutionContext::dispatchErrorEvent(const String&amp; errorMessage, int lineNumber, int columnNumber, const String&amp; sourceURL, JSC::Exception* exception, CachedScript* cachedScript)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 533,16 ***</span>
      }
  
      return false;
  }
  
<span class="line-modified">! JSC::ExecState* ScriptExecutionContext::execState()</span>
  {
      if (is&lt;Document&gt;(*this)) {
          Document&amp; document = downcast&lt;Document&gt;(*this);
          auto* frame = document.frame();
<span class="line-modified">!         return frame ? frame-&gt;script().globalObject(mainThreadNormalWorld())-&gt;globalExec() : nullptr;</span>
      }
  
      if (is&lt;WorkerGlobalScope&gt;(*this))
          return execStateFromWorkerGlobalScope(downcast&lt;WorkerGlobalScope&gt;(*this));
  #if ENABLE(CSS_PAINTING_API)
<span class="line-new-header">--- 507,16 ---</span>
      }
  
      return false;
  }
  
<span class="line-modified">! JSC::JSGlobalObject* ScriptExecutionContext::execState()</span>
  {
      if (is&lt;Document&gt;(*this)) {
          Document&amp; document = downcast&lt;Document&gt;(*this);
          auto* frame = document.frame();
<span class="line-modified">!         return frame ? frame-&gt;script().globalObject(mainThreadNormalWorld()) : nullptr;</span>
      }
  
      if (is&lt;WorkerGlobalScope&gt;(*this))
          return execStateFromWorkerGlobalScope(downcast&lt;WorkerGlobalScope&gt;(*this));
  #if ENABLE(CSS_PAINTING_API)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 572,11 ***</span>
  }
  
  bool ScriptExecutionContext::hasServiceWorkerScheme() const
  {
      ASSERT(securityOrigin());
<span class="line-modified">!     return SchemeRegistry::isServiceWorkerContainerCustomScheme(securityOrigin()-&gt;protocol());</span>
  }
  
  #if ENABLE(SERVICE_WORKER)
  
  ServiceWorker* ScriptExecutionContext::activeServiceWorker() const
<span class="line-new-header">--- 546,11 ---</span>
  }
  
  bool ScriptExecutionContext::hasServiceWorkerScheme() const
  {
      ASSERT(securityOrigin());
<span class="line-modified">!     return LegacySchemeRegistry::isServiceWorkerContainerCustomScheme(securityOrigin()-&gt;protocol());</span>
  }
  
  #if ENABLE(SERVICE_WORKER)
  
  ServiceWorker* ScriptExecutionContext::activeServiceWorker() const
</pre>
<hr />
<pre>
<span class="line-old-header">*** 610,29 ***</span>
          navigator = downcast&lt;WorkerGlobalScope&gt;(*this).optionalNavigator();
  
      return navigator ? &amp;navigator-&gt;serviceWorker() : nullptr;
  }
  
<span class="line-modified">! bool ScriptExecutionContext::postTaskTo(const DocumentOrWorkerIdentifier&amp; contextIdentifier, WTF::Function&lt;void(ScriptExecutionContext&amp;)&gt;&amp;&amp; task)</span>
  {
<span class="line-modified">!     ASSERT(isMainThread());</span>
  
<span class="line-modified">!     bool wasPosted = false;</span>
<span class="line-removed">-     switchOn(contextIdentifier, [&amp;] (DocumentIdentifier identifier) {</span>
<span class="line-removed">-         auto* document = Document::allDocumentsMap().get(identifier);</span>
<span class="line-removed">-         if (!document)</span>
<span class="line-removed">-             return;</span>
<span class="line-removed">-         document-&gt;postTask([task = WTFMove(task)](auto&amp; scope) {</span>
<span class="line-removed">-             task(scope);</span>
<span class="line-removed">-         });</span>
<span class="line-removed">-         wasPosted= true;</span>
<span class="line-removed">-     }, [&amp;](ServiceWorkerIdentifier identifier) {</span>
<span class="line-removed">-         wasPosted = SWContextManager::singleton().postTaskToServiceWorker(identifier, [task = WTFMove(task)](auto&amp; scope) {</span>
<span class="line-removed">-             task(scope);</span>
<span class="line-removed">-         });</span>
<span class="line-removed">-     });</span>
<span class="line-removed">-     return wasPosted;</span>
  }
  
  #endif
  
  bool ScriptExecutionContext::postTaskTo(ScriptExecutionContextIdentifier identifier, Task&amp;&amp; task)
<span class="line-new-header">--- 584,20 ---</span>
          navigator = downcast&lt;WorkerGlobalScope&gt;(*this).optionalNavigator();
  
      return navigator ? &amp;navigator-&gt;serviceWorker() : nullptr;
  }
  
<span class="line-modified">! ServiceWorkerContainer* ScriptExecutionContext::ensureServiceWorkerContainer()</span>
  {
<span class="line-modified">!     NavigatorBase* navigator = nullptr;</span>
<span class="line-added">+     if (is&lt;Document&gt;(*this)) {</span>
<span class="line-added">+         if (auto* window = downcast&lt;Document&gt;(*this).domWindow())</span>
<span class="line-added">+             navigator = &amp;window-&gt;navigator();</span>
<span class="line-added">+     } else</span>
<span class="line-added">+         navigator = &amp;downcast&lt;WorkerGlobalScope&gt;(*this).navigator();</span>
  
<span class="line-modified">!     return navigator ? &amp;navigator-&gt;serviceWorker() : nullptr;</span>
  }
  
  #endif
  
  bool ScriptExecutionContext::postTaskTo(ScriptExecutionContextIdentifier identifier, Task&amp;&amp; task)
</pre>
<center><a href="ScriptElement.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="ScriptExecutionContext.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>