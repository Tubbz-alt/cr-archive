<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WebCore/bindings/js/JSIDBRequestCustom.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="JSIDBCursorWithValueCustom.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="JSImageDataCustom.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/bindings/js/JSIDBRequestCustom.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 12  *
 13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. AND ITS CONTRIBUTORS ``AS IS&#39;&#39;
 14  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
 15  * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 16  * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL APPLE INC. OR ITS CONTRIBUTORS
 17  * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 18  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 19  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 20  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 21  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 22  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF
 23  * THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #include &quot;config.h&quot;
 27 #include &quot;JSIDBRequest.h&quot;
 28 
 29 #if ENABLE(INDEXED_DATABASE)
 30 
 31 #include &quot;IDBBindingUtilities.h&quot;

 32 #include &quot;JSDOMConvertInterface.h&quot;

 33 #include &quot;JSIDBCursor.h&quot;
 34 #include &quot;JSIDBDatabase.h&quot;
 35 
 36 namespace WebCore {
 37 using namespace JSC;
 38 
<span class="line-modified"> 39 JSC::JSValue JSIDBRequest::result(JSC::ExecState&amp; state) const</span>
 40 {
<span class="line-modified"> 41     return cachedPropertyValue(state, *this, wrapped().resultWrapper(), [&amp;] {</span>
 42         auto result = wrapped().result();
 43         if (UNLIKELY(result.hasException())) {
<span class="line-modified"> 44             auto throwScope = DECLARE_THROW_SCOPE(state.vm());</span>
<span class="line-modified"> 45             propagateException(state, throwScope, result.releaseException());</span>
 46             return jsNull();
 47         }
 48 
 49         IDBRequest::Result resultValue = result.releaseReturnValue();
<span class="line-modified"> 50         return WTF::switchOn(resultValue, [&amp;state] (RefPtr&lt;IDBCursor&gt;&amp; cursor) {</span>
<span class="line-modified"> 51             auto throwScope = DECLARE_THROW_SCOPE(state.vm());</span>
<span class="line-modified"> 52             return toJS&lt;IDLInterface&lt;IDBCursor&gt;&gt;(state, *jsCast&lt;JSDOMGlobalObject*&gt;(state.lexicalGlobalObject()), throwScope, cursor.get());</span>
<span class="line-modified"> 53         }, [&amp;state] (RefPtr&lt;IDBDatabase&gt;&amp; database) {</span>
<span class="line-modified"> 54             auto throwScope = DECLARE_THROW_SCOPE(state.vm());</span>
<span class="line-modified"> 55             return toJS&lt;IDLInterface&lt;IDBDatabase&gt;&gt;(state, *jsCast&lt;JSDOMGlobalObject*&gt;(state.lexicalGlobalObject()), throwScope, database.get());</span>
<span class="line-modified"> 56         }, [&amp;state] (IDBKeyData keyData) {</span>
<span class="line-modified"> 57             return toJS&lt;IDLIDBKeyData&gt;(state, *jsCast&lt;JSDOMGlobalObject*&gt;(state.lexicalGlobalObject()), keyData);</span>
<span class="line-modified"> 58         }, [&amp;state] (Vector&lt;IDBKeyData&gt; keyDatas) {</span>
<span class="line-modified"> 59             return toJS&lt;IDLSequence&lt;IDLIDBKeyData&gt;&gt;(state, *jsCast&lt;JSDOMGlobalObject*&gt;(state.lexicalGlobalObject()), keyDatas);</span>
<span class="line-modified"> 60         }, [&amp;state] (IDBGetResult getResult) {</span>
<span class="line-modified"> 61             auto result = deserializeIDBValueWithKeyInjection(state, getResult.value(), getResult.keyData(), getResult.keyPath());</span>
 62             return result ? result.value() : jsNull();
<span class="line-modified"> 63         }, [&amp;state] (IDBGetAllResult getAllResult) {</span>
 64             auto&amp; keys = getAllResult.keys();
 65             auto&amp; values = getAllResult.values();
 66             auto&amp; keyPath = getAllResult.keyPath();
<span class="line-modified"> 67             auto scope = DECLARE_THROW_SCOPE(state.vm());</span>
 68             JSC::MarkedArgumentBuffer list;
 69             for (unsigned i = 0; i &lt; values.size(); i ++) {
<span class="line-modified"> 70                 auto result = deserializeIDBValueWithKeyInjection(state, values[i], keys[i], keyPath);</span>
 71                 if (!result)
 72                     return jsNull();
 73                 list.append(result.value());
 74                 if (UNLIKELY(list.hasOverflowed())) {
<span class="line-modified"> 75                     propagateException(state, scope, Exception(UnknownError));</span>
 76                     return jsNull();
 77                 }
 78             }
<span class="line-modified"> 79             return JSValue(JSC::constructArray(&amp;state, nullptr, state.lexicalGlobalObject(), list));</span>
 80         }, [] (uint64_t number) {
 81             return toJS&lt;IDLUnsignedLongLong&gt;(number);
 82         }, [] (IDBRequest::NullResultType other) {
 83             if (other == IDBRequest::NullResultType::Empty)
 84                 return JSC::jsNull();
 85             return JSC::jsUndefined();
 86         });
 87     });
 88 }
 89 
 90 void JSIDBRequest::visitAdditionalChildren(SlotVisitor&amp; visitor)
 91 {
 92     auto&amp; request = wrapped();
 93     request.resultWrapper().visit(visitor);
 94     request.cursorWrapper().visit(visitor);
 95 }
 96 
 97 }
 98 #endif // ENABLE(INDEXED_DATABASE)
</pre>
</td>
<td>
<hr />
<pre>
 12  *
 13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. AND ITS CONTRIBUTORS ``AS IS&#39;&#39;
 14  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
 15  * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 16  * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL APPLE INC. OR ITS CONTRIBUTORS
 17  * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 18  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 19  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 20  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 21  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 22  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF
 23  * THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #include &quot;config.h&quot;
 27 #include &quot;JSIDBRequest.h&quot;
 28 
 29 #if ENABLE(INDEXED_DATABASE)
 30 
 31 #include &quot;IDBBindingUtilities.h&quot;
<span class="line-added"> 32 #include &quot;JSDOMConvertIndexedDB.h&quot;</span>
 33 #include &quot;JSDOMConvertInterface.h&quot;
<span class="line-added"> 34 #include &quot;JSDOMConvertSequences.h&quot;</span>
 35 #include &quot;JSIDBCursor.h&quot;
 36 #include &quot;JSIDBDatabase.h&quot;
 37 
 38 namespace WebCore {
 39 using namespace JSC;
 40 
<span class="line-modified"> 41 JSC::JSValue JSIDBRequest::result(JSC::JSGlobalObject&amp; lexicalGlobalObject) const</span>
 42 {
<span class="line-modified"> 43     return cachedPropertyValue(lexicalGlobalObject, *this, wrapped().resultWrapper(), [&amp;] {</span>
 44         auto result = wrapped().result();
 45         if (UNLIKELY(result.hasException())) {
<span class="line-modified"> 46             auto throwScope = DECLARE_THROW_SCOPE(lexicalGlobalObject.vm());</span>
<span class="line-modified"> 47             propagateException(lexicalGlobalObject, throwScope, result.releaseException());</span>
 48             return jsNull();
 49         }
 50 
 51         IDBRequest::Result resultValue = result.releaseReturnValue();
<span class="line-modified"> 52         return WTF::switchOn(resultValue, [&amp;lexicalGlobalObject] (RefPtr&lt;IDBCursor&gt;&amp; cursor) {</span>
<span class="line-modified"> 53             auto throwScope = DECLARE_THROW_SCOPE(lexicalGlobalObject.vm());</span>
<span class="line-modified"> 54             return toJS&lt;IDLInterface&lt;IDBCursor&gt;&gt;(lexicalGlobalObject, *jsCast&lt;JSDOMGlobalObject*&gt;(&amp;lexicalGlobalObject), throwScope, cursor.get());</span>
<span class="line-modified"> 55         }, [&amp;lexicalGlobalObject] (RefPtr&lt;IDBDatabase&gt;&amp; database) {</span>
<span class="line-modified"> 56             auto throwScope = DECLARE_THROW_SCOPE(lexicalGlobalObject.vm());</span>
<span class="line-modified"> 57             return toJS&lt;IDLInterface&lt;IDBDatabase&gt;&gt;(lexicalGlobalObject, *jsCast&lt;JSDOMGlobalObject*&gt;(&amp;lexicalGlobalObject), throwScope, database.get());</span>
<span class="line-modified"> 58         }, [&amp;lexicalGlobalObject] (IDBKeyData keyData) {</span>
<span class="line-modified"> 59             return toJS&lt;IDLIDBKeyData&gt;(lexicalGlobalObject, *jsCast&lt;JSDOMGlobalObject*&gt;(&amp;lexicalGlobalObject), keyData);</span>
<span class="line-modified"> 60         }, [&amp;lexicalGlobalObject] (Vector&lt;IDBKeyData&gt; keyDatas) {</span>
<span class="line-modified"> 61             return toJS&lt;IDLSequence&lt;IDLIDBKeyData&gt;&gt;(lexicalGlobalObject, *jsCast&lt;JSDOMGlobalObject*&gt;(&amp;lexicalGlobalObject), keyDatas);</span>
<span class="line-modified"> 62         }, [&amp;lexicalGlobalObject] (IDBGetResult getResult) {</span>
<span class="line-modified"> 63             auto result = deserializeIDBValueWithKeyInjection(lexicalGlobalObject, getResult.value(), getResult.keyData(), getResult.keyPath());</span>
 64             return result ? result.value() : jsNull();
<span class="line-modified"> 65         }, [&amp;lexicalGlobalObject] (IDBGetAllResult getAllResult) {</span>
 66             auto&amp; keys = getAllResult.keys();
 67             auto&amp; values = getAllResult.values();
 68             auto&amp; keyPath = getAllResult.keyPath();
<span class="line-modified"> 69             auto scope = DECLARE_THROW_SCOPE(lexicalGlobalObject.vm());</span>
 70             JSC::MarkedArgumentBuffer list;
 71             for (unsigned i = 0; i &lt; values.size(); i ++) {
<span class="line-modified"> 72                 auto result = deserializeIDBValueWithKeyInjection(lexicalGlobalObject, values[i], keys[i], keyPath);</span>
 73                 if (!result)
 74                     return jsNull();
 75                 list.append(result.value());
 76                 if (UNLIKELY(list.hasOverflowed())) {
<span class="line-modified"> 77                     propagateException(lexicalGlobalObject, scope, Exception(UnknownError));</span>
 78                     return jsNull();
 79                 }
 80             }
<span class="line-modified"> 81             return JSValue(JSC::constructArray(&amp;lexicalGlobalObject, static_cast&lt;JSC::ArrayAllocationProfile*&gt;(nullptr), list));</span>
 82         }, [] (uint64_t number) {
 83             return toJS&lt;IDLUnsignedLongLong&gt;(number);
 84         }, [] (IDBRequest::NullResultType other) {
 85             if (other == IDBRequest::NullResultType::Empty)
 86                 return JSC::jsNull();
 87             return JSC::jsUndefined();
 88         });
 89     });
 90 }
 91 
 92 void JSIDBRequest::visitAdditionalChildren(SlotVisitor&amp; visitor)
 93 {
 94     auto&amp; request = wrapped();
 95     request.resultWrapper().visit(visitor);
 96     request.cursorWrapper().visit(visitor);
 97 }
 98 
 99 }
100 #endif // ENABLE(INDEXED_DATABASE)
</pre>
</td>
</tr>
</table>
<center><a href="JSIDBCursorWithValueCustom.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="JSImageDataCustom.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>