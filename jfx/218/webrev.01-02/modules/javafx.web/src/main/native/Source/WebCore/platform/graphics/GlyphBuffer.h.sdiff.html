<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WebCore/platform/graphics/GlyphBuffer.h</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="GeometryUtilities.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="Gradient.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/platform/graphics/GlyphBuffer.h</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 48 typedef jint GlyphBufferGlyph;
 49 #else
 50 typedef Glyph GlyphBufferGlyph;
 51 #endif
 52 
 53 // CG uses CGSize instead of FloatSize so that the result of advances()
 54 // can be passed directly to CGContextShowGlyphsWithAdvances in FontMac.mm
 55 #if USE(CG)
 56 struct GlyphBufferAdvance : CGSize {
 57 public:
 58     GlyphBufferAdvance() : CGSize(CGSizeZero) { }
 59     GlyphBufferAdvance(CGSize size)
 60         : CGSize(size)
 61     {
 62     }
 63     GlyphBufferAdvance(float width, float height)
 64         : CGSize(CGSizeMake(width, height))
 65     {
 66     }
 67 



 68     void setWidth(CGFloat width) { this-&gt;CGSize::width = width; }
 69     void setHeight(CGFloat height) { this-&gt;CGSize::height = height; }
 70     CGFloat width() const { return this-&gt;CGSize::width; }
 71     CGFloat height() const { return this-&gt;CGSize::height; }
 72 };























 73 #else
 74 typedef FloatSize GlyphBufferAdvance;
 75 #endif
 76 





 77 class GlyphBuffer {
 78 public:
<span class="line-modified"> 79     bool isEmpty() const { return m_font.isEmpty(); }</span>
<span class="line-modified"> 80     unsigned size() const { return m_font.size(); }</span>
 81 
 82     void clear()
 83     {
<span class="line-modified"> 84         m_font.clear();</span>
 85         m_glyphs.clear();
 86         m_advances.clear();
 87         if (m_offsetsInString)
 88             m_offsetsInString-&gt;clear();
 89     }
 90 
 91     GlyphBufferGlyph* glyphs(unsigned from) { return m_glyphs.data() + from; }
 92     GlyphBufferAdvance* advances(unsigned from) { return m_advances.data() + from; }
 93     const GlyphBufferGlyph* glyphs(unsigned from) const { return m_glyphs.data() + from; }
 94     const GlyphBufferAdvance* advances(unsigned from) const { return m_advances.data() + from; }
<span class="line-removed"> 95     size_t advancesCount() const { return m_advances.size(); }</span>
 96 
<span class="line-modified"> 97     const Font* fontAt(unsigned index) const { return m_font[index]; }</span>
 98 
 99     void setInitialAdvance(GlyphBufferAdvance initialAdvance) { m_initialAdvance = initialAdvance; }
100     const GlyphBufferAdvance&amp; initialAdvance() const { return m_initialAdvance; }
101 
102     Glyph glyphAt(unsigned index) const
103     {
104         return m_glyphs[index];
105     }
106 
107     GlyphBufferAdvance advanceAt(unsigned index) const
108     {
109         return m_advances[index];
110     }
111 
112     static const unsigned noOffset = UINT_MAX;
113     void add(Glyph glyph, const Font* font, float width, unsigned offsetInString = noOffset)
114     {
115         GlyphBufferAdvance advance;
116         advance.setWidth(width);
117         advance.setHeight(0);
118 
119         add(glyph, font, advance, offsetInString);
120     }
121 
122     void add(Glyph glyph, const Font* font, GlyphBufferAdvance advance, unsigned offsetInString)
123     {
<span class="line-modified">124         m_font.append(font);</span>
125         m_glyphs.append(glyph);
126 
127         m_advances.append(advance);
128 
129         if (offsetInString != noOffset &amp;&amp; m_offsetsInString)
130             m_offsetsInString-&gt;append(offsetInString);
131     }
132 




















133     void reverse(unsigned from, unsigned length)
134     {
135         for (unsigned i = from, end = from + length - 1; i &lt; end; ++i, --end)
136             swap(i, end);
137     }
138 
139     void expandLastAdvance(float width)
140     {
141         ASSERT(!isEmpty());
142         GlyphBufferAdvance&amp; lastAdvance = m_advances.last();
143         lastAdvance.setWidth(lastAdvance.width() + width);
144     }
145 
146     void expandLastAdvance(GlyphBufferAdvance expansion)
147     {
148         ASSERT(!isEmpty());
149         GlyphBufferAdvance&amp; lastAdvance = m_advances.last();
150         lastAdvance.setWidth(lastAdvance.width() + expansion.width());
151         lastAdvance.setHeight(lastAdvance.height() + expansion.height());
152     }
153 
154     void saveOffsetsInString()
155     {
156         m_offsetsInString.reset(new Vector&lt;unsigned, 2048&gt;());
157     }
158 
159     int offsetInString(unsigned index) const
160     {
161         ASSERT(m_offsetsInString);
162         return (*m_offsetsInString)[index];
163     }
164 
165     void shrink(unsigned truncationPoint)
166     {
<span class="line-modified">167         m_font.shrink(truncationPoint);</span>
168         m_glyphs.shrink(truncationPoint);
169         m_advances.shrink(truncationPoint);
170         if (m_offsetsInString)
171             m_offsetsInString-&gt;shrink(truncationPoint);
172     }
173 
174 private:
175     void swap(unsigned index1, unsigned index2)
176     {
<span class="line-modified">177         const Font* f = m_font[index1];</span>
<span class="line-modified">178         m_font[index1] = m_font[index2];</span>
<span class="line-modified">179         m_font[index2] = f;</span>
180 
181         GlyphBufferGlyph g = m_glyphs[index1];
182         m_glyphs[index1] = m_glyphs[index2];
183         m_glyphs[index2] = g;
184 
185         GlyphBufferAdvance s = m_advances[index1];
186         m_advances[index1] = m_advances[index2];
187         m_advances[index2] = s;
188     }
189 
<span class="line-modified">190     Vector&lt;const Font*, 2048&gt; m_font;</span>
191     Vector&lt;GlyphBufferGlyph, 2048&gt; m_glyphs;
192     Vector&lt;GlyphBufferAdvance, 2048&gt; m_advances;
193     GlyphBufferAdvance m_initialAdvance;
194     std::unique_ptr&lt;Vector&lt;unsigned, 2048&gt;&gt; m_offsetsInString;
195 };
196 
197 }
</pre>
</td>
<td>
<hr />
<pre>
 48 typedef jint GlyphBufferGlyph;
 49 #else
 50 typedef Glyph GlyphBufferGlyph;
 51 #endif
 52 
 53 // CG uses CGSize instead of FloatSize so that the result of advances()
 54 // can be passed directly to CGContextShowGlyphsWithAdvances in FontMac.mm
 55 #if USE(CG)
 56 struct GlyphBufferAdvance : CGSize {
 57 public:
 58     GlyphBufferAdvance() : CGSize(CGSizeZero) { }
 59     GlyphBufferAdvance(CGSize size)
 60         : CGSize(size)
 61     {
 62     }
 63     GlyphBufferAdvance(float width, float height)
 64         : CGSize(CGSizeMake(width, height))
 65     {
 66     }
 67 
<span class="line-added"> 68     template&lt;class Encoder&gt; void encode(Encoder&amp;) const;</span>
<span class="line-added"> 69     template&lt;class Decoder&gt; static Optional&lt;GlyphBufferAdvance&gt; decode(Decoder&amp;);</span>
<span class="line-added"> 70 </span>
 71     void setWidth(CGFloat width) { this-&gt;CGSize::width = width; }
 72     void setHeight(CGFloat height) { this-&gt;CGSize::height = height; }
 73     CGFloat width() const { return this-&gt;CGSize::width; }
 74     CGFloat height() const { return this-&gt;CGSize::height; }
 75 };
<span class="line-added"> 76 </span>
<span class="line-added"> 77 template&lt;class Encoder&gt;</span>
<span class="line-added"> 78 void GlyphBufferAdvance::encode(Encoder&amp; encoder) const</span>
<span class="line-added"> 79 {</span>
<span class="line-added"> 80     encoder &lt;&lt; width();</span>
<span class="line-added"> 81     encoder &lt;&lt; height();</span>
<span class="line-added"> 82 }</span>
<span class="line-added"> 83 </span>
<span class="line-added"> 84 template&lt;class Decoder&gt;</span>
<span class="line-added"> 85 Optional&lt;GlyphBufferAdvance&gt; GlyphBufferAdvance::decode(Decoder&amp; decoder)</span>
<span class="line-added"> 86 {</span>
<span class="line-added"> 87     Optional&lt;CGFloat&gt; width;</span>
<span class="line-added"> 88     decoder &gt;&gt; width;</span>
<span class="line-added"> 89     if (!width)</span>
<span class="line-added"> 90         return WTF::nullopt;</span>
<span class="line-added"> 91 </span>
<span class="line-added"> 92     Optional&lt;CGFloat&gt; height;</span>
<span class="line-added"> 93     decoder &gt;&gt; height;</span>
<span class="line-added"> 94     if (!height)</span>
<span class="line-added"> 95         return WTF::nullopt;</span>
<span class="line-added"> 96 </span>
<span class="line-added"> 97     return GlyphBufferAdvance(CGSizeMake(*width, *height));</span>
<span class="line-added"> 98 }</span>
 99 #else
100 typedef FloatSize GlyphBufferAdvance;
101 #endif
102 
<span class="line-added">103 inline FloatSize toFloatSize(const GlyphBufferAdvance&amp; a)</span>
<span class="line-added">104 {</span>
<span class="line-added">105     return FloatSize(a.width(), a.height());</span>
<span class="line-added">106 }</span>
<span class="line-added">107 </span>
108 class GlyphBuffer {
109 public:
<span class="line-modified">110     bool isEmpty() const { return m_fonts.isEmpty(); }</span>
<span class="line-modified">111     unsigned size() const { return m_fonts.size(); }</span>
112 
113     void clear()
114     {
<span class="line-modified">115         m_fonts.clear();</span>
116         m_glyphs.clear();
117         m_advances.clear();
118         if (m_offsetsInString)
119             m_offsetsInString-&gt;clear();
120     }
121 
122     GlyphBufferGlyph* glyphs(unsigned from) { return m_glyphs.data() + from; }
123     GlyphBufferAdvance* advances(unsigned from) { return m_advances.data() + from; }
124     const GlyphBufferGlyph* glyphs(unsigned from) const { return m_glyphs.data() + from; }
125     const GlyphBufferAdvance* advances(unsigned from) const { return m_advances.data() + from; }

126 
<span class="line-modified">127     const Font* fontAt(unsigned index) const { return m_fonts[index]; }</span>
128 
129     void setInitialAdvance(GlyphBufferAdvance initialAdvance) { m_initialAdvance = initialAdvance; }
130     const GlyphBufferAdvance&amp; initialAdvance() const { return m_initialAdvance; }
131 
132     Glyph glyphAt(unsigned index) const
133     {
134         return m_glyphs[index];
135     }
136 
137     GlyphBufferAdvance advanceAt(unsigned index) const
138     {
139         return m_advances[index];
140     }
141 
142     static const unsigned noOffset = UINT_MAX;
143     void add(Glyph glyph, const Font* font, float width, unsigned offsetInString = noOffset)
144     {
145         GlyphBufferAdvance advance;
146         advance.setWidth(width);
147         advance.setHeight(0);
148 
149         add(glyph, font, advance, offsetInString);
150     }
151 
152     void add(Glyph glyph, const Font* font, GlyphBufferAdvance advance, unsigned offsetInString)
153     {
<span class="line-modified">154         m_fonts.append(font);</span>
155         m_glyphs.append(glyph);
156 
157         m_advances.append(advance);
158 
159         if (offsetInString != noOffset &amp;&amp; m_offsetsInString)
160             m_offsetsInString-&gt;append(offsetInString);
161     }
162 
<span class="line-added">163     void remove(unsigned location, unsigned length)</span>
<span class="line-added">164     {</span>
<span class="line-added">165         m_fonts.remove(location, length);</span>
<span class="line-added">166         m_glyphs.remove(location, length);</span>
<span class="line-added">167         m_advances.remove(location, length);</span>
<span class="line-added">168         if (m_offsetsInString)</span>
<span class="line-added">169             m_offsetsInString-&gt;remove(location, length);</span>
<span class="line-added">170     }</span>
<span class="line-added">171 </span>
<span class="line-added">172     void makeHole(unsigned location, unsigned length, const Font* font)</span>
<span class="line-added">173     {</span>
<span class="line-added">174         ASSERT(location &lt;= size());</span>
<span class="line-added">175 </span>
<span class="line-added">176         m_fonts.insertVector(location, Vector&lt;const Font*&gt;(length, font));</span>
<span class="line-added">177         m_glyphs.insertVector(location, Vector&lt;GlyphBufferGlyph&gt;(length, 0xFFFF));</span>
<span class="line-added">178         m_advances.insertVector(location, Vector&lt;GlyphBufferAdvance&gt;(length, GlyphBufferAdvance(0, 0)));</span>
<span class="line-added">179         if (m_offsetsInString)</span>
<span class="line-added">180             m_offsetsInString-&gt;insertVector(location, Vector&lt;unsigned&gt;(length, 0));</span>
<span class="line-added">181     }</span>
<span class="line-added">182 </span>
183     void reverse(unsigned from, unsigned length)
184     {
185         for (unsigned i = from, end = from + length - 1; i &lt; end; ++i, --end)
186             swap(i, end);
187     }
188 
189     void expandLastAdvance(float width)
190     {
191         ASSERT(!isEmpty());
192         GlyphBufferAdvance&amp; lastAdvance = m_advances.last();
193         lastAdvance.setWidth(lastAdvance.width() + width);
194     }
195 
196     void expandLastAdvance(GlyphBufferAdvance expansion)
197     {
198         ASSERT(!isEmpty());
199         GlyphBufferAdvance&amp; lastAdvance = m_advances.last();
200         lastAdvance.setWidth(lastAdvance.width() + expansion.width());
201         lastAdvance.setHeight(lastAdvance.height() + expansion.height());
202     }
203 
204     void saveOffsetsInString()
205     {
206         m_offsetsInString.reset(new Vector&lt;unsigned, 2048&gt;());
207     }
208 
209     int offsetInString(unsigned index) const
210     {
211         ASSERT(m_offsetsInString);
212         return (*m_offsetsInString)[index];
213     }
214 
215     void shrink(unsigned truncationPoint)
216     {
<span class="line-modified">217         m_fonts.shrink(truncationPoint);</span>
218         m_glyphs.shrink(truncationPoint);
219         m_advances.shrink(truncationPoint);
220         if (m_offsetsInString)
221             m_offsetsInString-&gt;shrink(truncationPoint);
222     }
223 
224 private:
225     void swap(unsigned index1, unsigned index2)
226     {
<span class="line-modified">227         const Font* f = m_fonts[index1];</span>
<span class="line-modified">228         m_fonts[index1] = m_fonts[index2];</span>
<span class="line-modified">229         m_fonts[index2] = f;</span>
230 
231         GlyphBufferGlyph g = m_glyphs[index1];
232         m_glyphs[index1] = m_glyphs[index2];
233         m_glyphs[index2] = g;
234 
235         GlyphBufferAdvance s = m_advances[index1];
236         m_advances[index1] = m_advances[index2];
237         m_advances[index2] = s;
238     }
239 
<span class="line-modified">240     Vector&lt;const Font*, 2048&gt; m_fonts;</span>
241     Vector&lt;GlyphBufferGlyph, 2048&gt; m_glyphs;
242     Vector&lt;GlyphBufferAdvance, 2048&gt; m_advances;
243     GlyphBufferAdvance m_initialAdvance;
244     std::unique_ptr&lt;Vector&lt;unsigned, 2048&gt;&gt; m_offsetsInString;
245 };
246 
247 }
</pre>
</td>
</tr>
</table>
<center><a href="GeometryUtilities.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="Gradient.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>