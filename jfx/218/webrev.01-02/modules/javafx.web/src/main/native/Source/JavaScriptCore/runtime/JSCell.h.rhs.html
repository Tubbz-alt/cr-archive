<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/JavaScriptCore/runtime/JSCell.h</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  *  Copyright (C) 1999-2001 Harri Porten (porten@kde.org)
  3  *  Copyright (C) 2001 Peter Kelly (pmk@post.com)
<a name="1" id="anc1"></a><span class="line-modified">  4  *  Copyright (C) 2003-2019 Apple Inc. All rights reserved.</span>
  5  *
  6  *  This library is free software; you can redistribute it and/or
  7  *  modify it under the terms of the GNU Library General Public
  8  *  License as published by the Free Software Foundation; either
  9  *  version 2 of the License, or (at your option) any later version.
 10  *
 11  *  This library is distributed in the hope that it will be useful,
 12  *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 13  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 14  *  Library General Public License for more details.
 15  *
 16  *  You should have received a copy of the GNU Library General Public License
 17  *  along with this library; see the file COPYING.LIB.  If not, write to
 18  *  the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
 19  *  Boston, MA 02110-1301, USA.
 20  *
 21  */
 22 
 23 #pragma once
 24 
 25 #include &quot;CallData.h&quot;
 26 #include &quot;CellState.h&quot;
 27 #include &quot;ConstructData.h&quot;
 28 #include &quot;EnumerationMode.h&quot;
 29 #include &quot;Heap.h&quot;
 30 #include &quot;HeapCell.h&quot;
 31 #include &quot;IndexingType.h&quot;
 32 #include &quot;JSLock.h&quot;
 33 #include &quot;JSTypeInfo.h&quot;
 34 #include &quot;SlotVisitor.h&quot;
 35 #include &quot;SubspaceAccess.h&quot;
 36 #include &quot;TypedArrayType.h&quot;
 37 #include &quot;WriteBarrier.h&quot;
 38 
 39 namespace JSC {
 40 
<a name="2" id="anc2"></a><span class="line-added"> 41 class CallFrame;</span>
 42 class CompleteSubspace;
 43 class CopyVisitor;
 44 class GCDeferralContext;
<a name="3" id="anc3"></a>
 45 class Identifier;
 46 class JSArrayBufferView;
 47 class JSDestructibleObject;
 48 class JSGlobalObject;
 49 class LLIntOffsetsExtractor;
 50 class PropertyDescriptor;
 51 class PropertyName;
 52 class PropertyNameArray;
 53 class Structure;
 54 class JSCellLock;
 55 
 56 enum class GCDeferralContextArgPresense {
 57     HasArg,
 58     DoesNotHaveArg
 59 };
 60 
 61 template&lt;typename T&gt; void* allocateCell(Heap&amp;, size_t = sizeof(T));
 62 template&lt;typename T&gt; void* tryAllocateCell(Heap&amp;, size_t = sizeof(T));
 63 template&lt;typename T&gt; void* allocateCell(Heap&amp;, GCDeferralContext*, size_t = sizeof(T));
 64 template&lt;typename T&gt; void* tryAllocateCell(Heap&amp;, GCDeferralContext*, size_t = sizeof(T));
 65 
 66 #define DECLARE_EXPORT_INFO                                                  \
 67     protected:                                                               \
 68         static JS_EXPORT_PRIVATE const ::JSC::ClassInfo s_info;              \
 69     public:                                                                  \
 70         static constexpr const ::JSC::ClassInfo* info() { return &amp;s_info; }
 71 
 72 #define DECLARE_INFO                                                         \
 73     protected:                                                               \
 74         static const ::JSC::ClassInfo s_info;                                \
 75     public:                                                                  \
 76         static constexpr const ::JSC::ClassInfo* info() { return &amp;s_info; }
 77 
 78 class JSCell : public HeapCell {
 79     friend class JSValue;
 80     friend class MarkedBlock;
 81     template&lt;typename T&gt;
 82     friend void* tryAllocateCellHelper(Heap&amp;, size_t, GCDeferralContext*, AllocationFailureMode);
 83 
 84 public:
<a name="4" id="anc4"></a><span class="line-modified"> 85     static constexpr unsigned StructureFlags = 0;</span>
 86 
<a name="5" id="anc5"></a><span class="line-modified"> 87     static constexpr bool needsDestruction = false;</span>
 88 
<a name="6" id="anc6"></a><span class="line-modified"> 89     static constexpr uint8_t numberOfLowerTierCells = 8;</span>




 90 
 91     static JSCell* seenMultipleCalleeObjects() { return bitwise_cast&lt;JSCell*&gt;(static_cast&lt;uintptr_t&gt;(1)); }
 92 
 93     enum CreatingEarlyCellTag { CreatingEarlyCell };
 94     JSCell(CreatingEarlyCellTag);
 95 
<a name="7" id="anc7"></a><span class="line-added"> 96     JS_EXPORT_PRIVATE static void destroy(JSCell*);</span>
<span class="line-added"> 97 </span>
 98 protected:
 99     JSCell(VM&amp;, Structure*);
<a name="8" id="anc8"></a>
100 
101 public:
102     // Querying the type.
103     bool isString() const;
104     bool isBigInt() const;
105     bool isSymbol() const;
106     bool isObject() const;
107     bool isGetterSetter() const;
108     bool isCustomGetterSetter() const;
109     bool isProxy() const;
110     bool isFunction(VM&amp;);
111     bool isCallable(VM&amp;, CallType&amp;, CallData&amp;);
112     bool isConstructor(VM&amp;);
113     bool isConstructor(VM&amp;, ConstructType&amp;, ConstructData&amp;);
114     bool inherits(VM&amp;, const ClassInfo*) const;
115     template&lt;typename Target&gt; bool inherits(VM&amp;) const;
116     bool isAPIValueWrapper() const;
117 
118     // Each cell has a built-in lock. Currently it&#39;s simply available for use if you need it. It&#39;s
119     // a full-blown WTF::Lock. Note that this lock is currently used in JSArray and that lock&#39;s
120     // ordering with the Structure lock is that the Structure lock must be acquired first.
121 
122     // We use this abstraction to make it easier to grep for places where we lock cells.
123     // to lock a cell you can just do:
124     // auto locker = holdLock(cell-&gt;cellLocker());
125     JSCellLock&amp; cellLock() { return *reinterpret_cast&lt;JSCellLock*&gt;(this); }
126 
127     JSType type() const;
128     IndexingType indexingTypeAndMisc() const;
129     IndexingType indexingMode() const;
130     IndexingType indexingType() const;
131     StructureID structureID() const { return m_structureID; }
132     Structure* structure() const;
133     Structure* structure(VM&amp;) const;
134     void setStructure(VM&amp;, Structure*);
135     void setStructureIDDirectly(StructureID id) { m_structureID = id; }
136     void clearStructure() { m_structureID = 0; }
137 
138     TypeInfo::InlineTypeFlags inlineTypeFlags() const { return m_flags; }
139 
140     const char* className(VM&amp;) const;
141 
142     // Extracting the value.
<a name="9" id="anc9"></a><span class="line-modified">143     JS_EXPORT_PRIVATE bool getString(JSGlobalObject*, String&amp;) const;</span>
<span class="line-modified">144     JS_EXPORT_PRIVATE String getString(JSGlobalObject*) const; // null string if not a string</span>
145     JS_EXPORT_PRIVATE JSObject* getObject(); // NULL if not an object
146     const JSObject* getObject() const; // NULL if not an object
147 
148     // Returns information about how to call/construct this cell as a function/constructor. May tell
149     // you that the cell is not callable or constructor (default is that it&#39;s not either). If it
150     // says that the function is callable, and the OverridesGetCallData type flag is set, and
151     // this is an object, then typeof will return &quot;function&quot; instead of &quot;object&quot;. These methods
152     // cannot change their minds and must be thread-safe. They are sometimes called from compiler
153     // threads.
154     JS_EXPORT_PRIVATE static CallType getCallData(JSCell*, CallData&amp;);
155     JS_EXPORT_PRIVATE static ConstructType getConstructData(JSCell*, ConstructData&amp;);
156 
157     // Basic conversions.
<a name="10" id="anc10"></a><span class="line-modified">158     JS_EXPORT_PRIVATE JSValue toPrimitive(JSGlobalObject*, PreferredPrimitiveType) const;</span>
<span class="line-modified">159     bool getPrimitiveNumber(JSGlobalObject*, double&amp; number, JSValue&amp;) const;</span>
<span class="line-modified">160     bool toBoolean(JSGlobalObject*) const;</span>
161     TriState pureToBoolean() const;
<a name="11" id="anc11"></a><span class="line-modified">162     JS_EXPORT_PRIVATE double toNumber(JSGlobalObject*) const;</span>
<span class="line-modified">163     JSObject* toObject(JSGlobalObject*) const;</span>
164 
165     void dump(PrintStream&amp;) const;
166     JS_EXPORT_PRIVATE static void dumpToStream(const JSCell*, PrintStream&amp;);
167 
168     size_t estimatedSizeInBytes(VM&amp;) const;
169     JS_EXPORT_PRIVATE static size_t estimatedSize(JSCell*, VM&amp;);
170 
171     static void visitChildren(JSCell*, SlotVisitor&amp;);
172     static void visitOutputConstraints(JSCell*, SlotVisitor&amp;);
173 
174     JS_EXPORT_PRIVATE static void analyzeHeap(JSCell*, HeapAnalyzer&amp;);
175 
176     // Object operations, with the toObject operation included.
177     const ClassInfo* classInfo(VM&amp;) const;
178     const MethodTable* methodTable(VM&amp;) const;
<a name="12" id="anc12"></a><span class="line-modified">179     static bool put(JSCell*, JSGlobalObject*, PropertyName, JSValue, PutPropertySlot&amp;);</span>
<span class="line-modified">180     static bool putByIndex(JSCell*, JSGlobalObject*, unsigned propertyName, JSValue, bool shouldThrow);</span>
<span class="line-modified">181     bool putInline(JSGlobalObject*, PropertyName, JSValue, PutPropertySlot&amp;);</span>
182 
<a name="13" id="anc13"></a><span class="line-modified">183     static bool deleteProperty(JSCell*, JSGlobalObject*, PropertyName);</span>
<span class="line-modified">184     static bool deletePropertyByIndex(JSCell*, JSGlobalObject*, unsigned propertyName);</span>
185 
<a name="14" id="anc14"></a><span class="line-modified">186     static JSValue toThis(JSCell*, JSGlobalObject*, ECMAMode);</span>
187 
188     static bool canUseFastGetOwnProperty(const Structure&amp;);
189     JSValue fastGetOwnProperty(VM&amp;, Structure&amp;, PropertyName);
190 
191     // The recommended idiom for using cellState() is to switch on it or perform an == comparison on it
192     // directly. We deliberately avoid helpers for this, because we want transparency about how the various
193     // CellState values influences our various algorithms.
194     CellState cellState() const { return m_cellState; }
195 
196     void setCellState(CellState data) const { const_cast&lt;JSCell*&gt;(this)-&gt;m_cellState = data; }
197 
198     bool atomicCompareExchangeCellStateWeakRelaxed(CellState oldState, CellState newState)
199     {
200         return WTF::atomicCompareExchangeWeakRelaxed(&amp;m_cellState, oldState, newState);
201     }
202 
203     CellState atomicCompareExchangeCellStateStrong(CellState oldState, CellState newState)
204     {
205         return WTF::atomicCompareExchangeStrong(&amp;m_cellState, oldState, newState);
206     }
207 
208     static ptrdiff_t structureIDOffset()
209     {
210         return OBJECT_OFFSETOF(JSCell, m_structureID);
211     }
212 
213     static ptrdiff_t typeInfoFlagsOffset()
214     {
215         return OBJECT_OFFSETOF(JSCell, m_flags);
216     }
217 
218     static ptrdiff_t typeInfoTypeOffset()
219     {
220         return OBJECT_OFFSETOF(JSCell, m_type);
221     }
222 
223     // DO NOT store to this field. Always use a CAS loop, since some bits are flipped using CAS
224     // from other threads due to the internal lock. One exception: you don&#39;t need the CAS if the
225     // object has not escaped yet.
226     static ptrdiff_t indexingTypeAndMiscOffset()
227     {
228         return OBJECT_OFFSETOF(JSCell, m_indexingTypeAndMisc);
229     }
230 
231     static ptrdiff_t cellStateOffset()
232     {
233         return OBJECT_OFFSETOF(JSCell, m_cellState);
234     }
235 
236     static const TypedArrayType TypedArrayStorageType = NotTypedArray;
237 
238     void setPerCellBit(bool);
239     bool perCellBit() const;
240 protected:
241 
242     void finishCreation(VM&amp;);
243     void finishCreation(VM&amp;, Structure*, CreatingEarlyCellTag);
244 
245     // Dummy implementations of override-able static functions for classes to put in their MethodTable
<a name="15" id="anc15"></a><span class="line-modified">246     static JSValue defaultValue(const JSObject*, JSGlobalObject*, PreferredPrimitiveType);</span>
<span class="line-modified">247     static NO_RETURN_DUE_TO_CRASH void getOwnPropertyNames(JSObject*, JSGlobalObject*, PropertyNameArray&amp;, EnumerationMode);</span>
<span class="line-modified">248     static NO_RETURN_DUE_TO_CRASH void getOwnNonIndexPropertyNames(JSObject*, JSGlobalObject*, PropertyNameArray&amp;, EnumerationMode);</span>
<span class="line-modified">249     static NO_RETURN_DUE_TO_CRASH void getPropertyNames(JSObject*, JSGlobalObject*, PropertyNameArray&amp;, EnumerationMode);</span>
<span class="line-modified">250 </span>
<span class="line-modified">251     static uint32_t getEnumerableLength(JSGlobalObject*, JSObject*);</span>
<span class="line-modified">252     static NO_RETURN_DUE_TO_CRASH void getStructurePropertyNames(JSObject*, JSGlobalObject*, PropertyNameArray&amp;, EnumerationMode);</span>
<span class="line-modified">253     static NO_RETURN_DUE_TO_CRASH void getGenericPropertyNames(JSObject*, JSGlobalObject*, PropertyNameArray&amp;, EnumerationMode);</span>
<span class="line-modified">254     static NO_RETURN_DUE_TO_CRASH bool preventExtensions(JSObject*, JSGlobalObject*);</span>
<span class="line-modified">255     static NO_RETURN_DUE_TO_CRASH bool isExtensible(JSObject*, JSGlobalObject*);</span>
<span class="line-modified">256     static NO_RETURN_DUE_TO_CRASH bool setPrototype(JSObject*, JSGlobalObject*, JSValue, bool);</span>
<span class="line-modified">257     static NO_RETURN_DUE_TO_CRASH JSValue getPrototype(JSObject*, JSGlobalObject*);</span>
258 
259     static String className(const JSObject*, VM&amp;);
<a name="16" id="anc16"></a><span class="line-modified">260     static String toStringName(const JSObject*, JSGlobalObject*);</span>
<span class="line-modified">261     JS_EXPORT_PRIVATE static bool customHasInstance(JSObject*, JSGlobalObject*, JSValue);</span>
<span class="line-modified">262     static bool defineOwnProperty(JSObject*, JSGlobalObject*, PropertyName, const PropertyDescriptor&amp;, bool shouldThrow);</span>
<span class="line-modified">263     static bool getOwnPropertySlot(JSObject*, JSGlobalObject*, PropertyName, PropertySlot&amp;);</span>
<span class="line-modified">264     static bool getOwnPropertySlotByIndex(JSObject*, JSGlobalObject*, unsigned propertyName, PropertySlot&amp;);</span>
<span class="line-modified">265     static NO_RETURN_DUE_TO_CRASH void doPutPropertySecurityCheck(JSObject*, JSGlobalObject*, PropertyName, PutPropertySlot&amp;);</span>
266 
267 private:
268     friend class LLIntOffsetsExtractor;
269     friend class JSCellLock;
270 
<a name="17" id="anc17"></a><span class="line-modified">271     JS_EXPORT_PRIVATE JSObject* toObjectSlow(JSGlobalObject*) const;</span>
272 
273     StructureID m_structureID;
274     IndexingType m_indexingTypeAndMisc; // DO NOT store to this field. Always CAS.
275     JSType m_type;
276     TypeInfo::InlineTypeFlags m_flags;
277     CellState m_cellState;
278 };
279 
280 class JSCellLock : public JSCell {
281 public:
282     void lock();
283     bool tryLock();
284     void unlock();
285     bool isLocked() const;
286 private:
287     JS_EXPORT_PRIVATE void lockSlow();
288     JS_EXPORT_PRIVATE void unlockSlow();
289 };
290 
291 // FIXME: Refer to Subspace by reference.
292 // https://bugs.webkit.org/show_bug.cgi?id=166988
293 template&lt;typename Type&gt;
294 inline auto subspaceFor(VM&amp; vm)
295 {
296     return Type::template subspaceFor&lt;Type, SubspaceAccess::OnMainThread&gt;(vm);
297 }
298 
299 template&lt;typename Type&gt;
300 inline auto subspaceForConcurrently(VM&amp; vm)
301 {
302     return Type::template subspaceFor&lt;Type, SubspaceAccess::Concurrently&gt;(vm);
303 }
304 
305 } // namespace JSC
<a name="18" id="anc18"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="18" type="hidden" />
</body>
</html>