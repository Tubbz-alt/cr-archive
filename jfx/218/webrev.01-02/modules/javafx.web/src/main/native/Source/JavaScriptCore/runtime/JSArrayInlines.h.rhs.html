<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/JavaScriptCore/runtime/JSArrayInlines.h</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  *  Copyright (C) 2016-2019 Apple Inc. All rights reserved.</span>
  3  *
  4  *  This library is free software; you can redistribute it and/or
  5  *  modify it under the terms of the GNU Lesser General Public
  6  *  License as published by the Free Software Foundation; either
  7  *  version 2 of the License, or (at your option) any later version.
  8  *
  9  *  This library is distributed in the hope that it will be useful,
 10  *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 11  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 12  *  Lesser General Public License for more details.
 13  *
 14  *  You should have received a copy of the GNU Lesser General Public
 15  *  License along with this library; if not, write to the Free Software
 16  *  Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA
 17  *
 18  */
 19 
 20 #pragma once
 21 
 22 #include &quot;ArrayPrototype.h&quot;
<a name="2" id="anc2"></a><span class="line-added"> 23 #include &quot;ButterflyInlines.h&quot;</span>
 24 #include &quot;Error.h&quot;
 25 #include &quot;JSArray.h&quot;
 26 #include &quot;JSCellInlines.h&quot;
 27 #include &quot;Structure.h&quot;
 28 
 29 namespace JSC {
 30 
 31 inline IndexingType JSArray::mergeIndexingTypeForCopying(IndexingType other)
 32 {
 33     IndexingType type = indexingType();
 34     if (!(type &amp; IsArray &amp;&amp; other &amp; IsArray))
 35         return NonArray;
 36 
 37     if (hasAnyArrayStorage(type) || hasAnyArrayStorage(other))
 38         return NonArray;
 39 
 40     if (type == ArrayWithUndecided)
 41         return other;
 42 
 43     if (other == ArrayWithUndecided)
 44         return type;
 45 
 46     // We can memcpy an Int32 and a Contiguous into a Contiguous array since
 47     // both share the same memory layout for Int32 numbers.
 48     if ((type == ArrayWithInt32 || type == ArrayWithContiguous)
 49         &amp;&amp; (other == ArrayWithInt32 || other == ArrayWithContiguous)) {
 50         if (other == ArrayWithContiguous)
 51             return other;
 52         return type;
 53     }
 54 
 55     if (type != other)
 56         return NonArray;
 57 
 58     return type;
 59 }
 60 
 61 inline bool JSArray::canFastCopy(VM&amp; vm, JSArray* otherArray)
 62 {
 63     if (otherArray == this)
 64         return false;
 65     if (hasAnyArrayStorage(indexingType()) || hasAnyArrayStorage(otherArray-&gt;indexingType()))
 66         return false;
 67     // FIXME: We should have a watchpoint for indexed properties on Array.prototype and Object.prototype
 68     // instead of walking the prototype chain. https://bugs.webkit.org/show_bug.cgi?id=155592
 69     if (structure(vm)-&gt;holesMustForwardToPrototype(vm, this)
 70         || otherArray-&gt;structure(vm)-&gt;holesMustForwardToPrototype(vm, otherArray))
 71         return false;
 72     return true;
 73 }
 74 
 75 inline bool JSArray::canDoFastIndexedAccess(VM&amp; vm)
 76 {
 77     JSGlobalObject* globalObject = this-&gt;globalObject();
 78     if (!globalObject-&gt;arrayPrototypeChainIsSane())
 79         return false;
 80 
 81     Structure* structure = this-&gt;structure(vm);
 82     // This is the fast case. Many arrays will be an original array.
 83     if (globalObject-&gt;isOriginalArrayStructure(structure))
 84         return true;
 85 
 86     if (structure-&gt;mayInterceptIndexedAccesses())
 87         return false;
 88 
 89     if (getPrototypeDirect(vm) != globalObject-&gt;arrayPrototype())
 90         return false;
 91 
 92     return true;
 93 }
 94 
<a name="3" id="anc3"></a><span class="line-modified"> 95 ALWAYS_INLINE double toLength(JSGlobalObject* globalObject, JSObject* obj)</span>
 96 {
<a name="4" id="anc4"></a><span class="line-modified"> 97     VM&amp; vm = globalObject-&gt;vm();</span>
 98     auto scope = DECLARE_THROW_SCOPE(vm);
 99     if (LIKELY(isJSArray(obj)))
100         return jsCast&lt;JSArray*&gt;(obj)-&gt;length();
101 
<a name="5" id="anc5"></a><span class="line-modified">102     JSValue lengthValue = obj-&gt;get(globalObject, vm.propertyNames-&gt;length);</span>
103     RETURN_IF_EXCEPTION(scope, PNaN);
<a name="6" id="anc6"></a><span class="line-modified">104     RELEASE_AND_RETURN(scope, lengthValue.toLength(globalObject));</span>
105 }
106 
<a name="7" id="anc7"></a><span class="line-modified">107 ALWAYS_INLINE void JSArray::pushInline(JSGlobalObject* globalObject, JSValue value)</span>
108 {
<a name="8" id="anc8"></a><span class="line-modified">109     VM&amp; vm = globalObject-&gt;vm();</span>
110     auto scope = DECLARE_THROW_SCOPE(vm);
111 
112     ensureWritable(vm);
113 
114     Butterfly* butterfly = this-&gt;butterfly();
115 
116     switch (indexingMode()) {
117     case ArrayClass: {
118         createInitialUndecided(vm, 0);
119         FALLTHROUGH;
120     }
121 
122     case ArrayWithUndecided: {
123         convertUndecidedForValue(vm, value);
124         scope.release();
<a name="9" id="anc9"></a><span class="line-modified">125         push(globalObject, value);</span>
126         return;
127     }
128 
129     case ArrayWithInt32: {
130         if (!value.isInt32()) {
131             convertInt32ForValue(vm, value);
132             scope.release();
<a name="10" id="anc10"></a><span class="line-modified">133             push(globalObject, value);</span>
134             return;
135         }
136 
137         unsigned length = butterfly-&gt;publicLength();
138         ASSERT(length &lt;= butterfly-&gt;vectorLength());
139         if (length &lt; butterfly-&gt;vectorLength()) {
140             butterfly-&gt;contiguousInt32().at(this, length).setWithoutWriteBarrier(value);
141             butterfly-&gt;setPublicLength(length + 1);
142             return;
143         }
144 
145         if (UNLIKELY(length &gt; MAX_ARRAY_INDEX)) {
<a name="11" id="anc11"></a><span class="line-modified">146             methodTable(vm)-&gt;putByIndex(this, globalObject, length, value, true);</span>
147             if (!scope.exception())
<a name="12" id="anc12"></a><span class="line-modified">148                 throwException(globalObject, scope, createRangeError(globalObject, LengthExceededTheMaximumArrayLengthError));</span>
149             return;
150         }
151 
152         scope.release();
<a name="13" id="anc13"></a><span class="line-modified">153         putByIndexBeyondVectorLengthWithoutAttributes&lt;Int32Shape&gt;(globalObject, length, value);</span>
154         return;
155     }
156 
157     case ArrayWithContiguous: {
158         unsigned length = butterfly-&gt;publicLength();
159         ASSERT(length &lt;= butterfly-&gt;vectorLength());
160         if (length &lt; butterfly-&gt;vectorLength()) {
<a name="14" id="anc14"></a><span class="line-modified">161             butterfly-&gt;contiguous().at(this, length).setWithoutWriteBarrier(value);</span>
162             butterfly-&gt;setPublicLength(length + 1);
<a name="15" id="anc15"></a><span class="line-added">163             vm.heap.writeBarrier(this, value);</span>
164             return;
165         }
166 
167         if (UNLIKELY(length &gt; MAX_ARRAY_INDEX)) {
<a name="16" id="anc16"></a><span class="line-modified">168             methodTable(vm)-&gt;putByIndex(this, globalObject, length, value, true);</span>
169             if (!scope.exception())
<a name="17" id="anc17"></a><span class="line-modified">170                 throwException(globalObject, scope, createRangeError(globalObject, LengthExceededTheMaximumArrayLengthError));</span>
171             return;
172         }
173 
174         scope.release();
<a name="18" id="anc18"></a><span class="line-modified">175         putByIndexBeyondVectorLengthWithoutAttributes&lt;ContiguousShape&gt;(globalObject, length, value);</span>
176         return;
177     }
178 
179     case ArrayWithDouble: {
180         if (!value.isNumber()) {
181             convertDoubleToContiguous(vm);
182             scope.release();
<a name="19" id="anc19"></a><span class="line-modified">183             push(globalObject, value);</span>
184             return;
185         }
186         double valueAsDouble = value.asNumber();
187         if (valueAsDouble != valueAsDouble) {
188             convertDoubleToContiguous(vm);
189             scope.release();
<a name="20" id="anc20"></a><span class="line-modified">190             push(globalObject, value);</span>
191             return;
192         }
193 
194         unsigned length = butterfly-&gt;publicLength();
195         ASSERT(length &lt;= butterfly-&gt;vectorLength());
196         if (length &lt; butterfly-&gt;vectorLength()) {
197             butterfly-&gt;contiguousDouble().at(this, length) = valueAsDouble;
198             butterfly-&gt;setPublicLength(length + 1);
199             return;
200         }
201 
202         if (UNLIKELY(length &gt; MAX_ARRAY_INDEX)) {
<a name="21" id="anc21"></a><span class="line-modified">203             methodTable(vm)-&gt;putByIndex(this, globalObject, length, value, true);</span>
204             if (!scope.exception())
<a name="22" id="anc22"></a><span class="line-modified">205                 throwException(globalObject, scope, createRangeError(globalObject, LengthExceededTheMaximumArrayLengthError));</span>
206             return;
207         }
208 
209         scope.release();
<a name="23" id="anc23"></a><span class="line-modified">210         putByIndexBeyondVectorLengthWithoutAttributes&lt;DoubleShape&gt;(globalObject, length, value);</span>
211         return;
212     }
213 
214     case ArrayWithSlowPutArrayStorage: {
215         unsigned oldLength = length();
216         bool putResult = false;
<a name="24" id="anc24"></a><span class="line-modified">217         bool result = attemptToInterceptPutByIndexOnHole(globalObject, oldLength, value, true, putResult);</span>
218         RETURN_IF_EXCEPTION(scope, void());
219         if (result) {
220             if (oldLength &lt; 0xFFFFFFFFu) {
221                 scope.release();
<a name="25" id="anc25"></a><span class="line-modified">222                 setLength(globalObject, oldLength + 1, true);</span>
223             }
224             return;
225         }
226         FALLTHROUGH;
227     }
228 
229     case ArrayWithArrayStorage: {
230         ArrayStorage* storage = butterfly-&gt;arrayStorage();
231 
232         // Fast case - push within vector, always update m_length &amp; m_numValuesInVector.
233         unsigned length = storage-&gt;length();
234         if (length &lt; storage-&gt;vectorLength()) {
235             storage-&gt;m_vector[length].set(vm, this, value);
236             storage-&gt;setLength(length + 1);
237             ++storage-&gt;m_numValuesInVector;
238             return;
239         }
240 
241         // Pushing to an array of invalid length (2^31-1) stores the property, but throws a range error.
242         if (UNLIKELY(storage-&gt;length() &gt; MAX_ARRAY_INDEX)) {
<a name="26" id="anc26"></a><span class="line-modified">243             methodTable(vm)-&gt;putByIndex(this, globalObject, storage-&gt;length(), value, true);</span>
244             // Per ES5.1 15.4.4.7 step 6 &amp; 15.4.5.1 step 3.d.
245             if (!scope.exception())
<a name="27" id="anc27"></a><span class="line-modified">246                 throwException(globalObject, scope, createRangeError(globalObject, LengthExceededTheMaximumArrayLengthError));</span>
247             return;
248         }
249 
250         // Handled the same as putIndex.
251         scope.release();
<a name="28" id="anc28"></a><span class="line-modified">252         putByIndexBeyondVectorLengthWithArrayStorage(globalObject, storage-&gt;length(), value, true, storage);</span>
253         return;
254     }
255 
256     default:
257         RELEASE_ASSERT_NOT_REACHED();
258     }
259 }
260 
261 } // namespace JSC
<a name="29" id="anc29"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="29" type="hidden" />
</body>
</html>