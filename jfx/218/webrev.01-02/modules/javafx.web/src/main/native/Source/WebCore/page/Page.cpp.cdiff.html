<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.web/src/main/native/Source/WebCore/page/Page.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="NavigatorBase.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="Page.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/page/Page.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (C) 2006-2017 Apple Inc. All rights reserved.</span>
   * Copyright (C) 2008 Torch Mobile Inc. All rights reserved. (http://www.torchmobile.com/)
   *
   * This library is free software; you can redistribute it and/or
   * modify it under the terms of the GNU Library General Public
   * License as published by the Free Software Foundation; either
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (C) 2006-2019 Apple Inc. All rights reserved.</span>
   * Copyright (C) 2008 Torch Mobile Inc. All rights reserved. (http://www.torchmobile.com/)
   *
   * This library is free software; you can redistribute it and/or
   * modify it under the terms of the GNU Library General Public
   * License as published by the Free Software Foundation; either
</pre>
<hr />
<pre>
<span class="line-old-header">*** 21,12 ***</span>
  #include &quot;Page.h&quot;
  
  #include &quot;ActivityStateChangeObserver.h&quot;
  #include &quot;AlternativeTextClient.h&quot;
  #include &quot;ApplicationCacheStorage.h&quot;
<span class="line-removed">- #include &quot;ApplicationStateChangeListener.h&quot;</span>
  #include &quot;AuthenticatorCoordinator.h&quot;
  #include &quot;BackForwardClient.h&quot;
  #include &quot;BackForwardController.h&quot;
  #include &quot;CSSAnimationController.h&quot;
  #include &quot;CacheStorageProvider.h&quot;
  #include &quot;Chrome.h&quot;
<span class="line-new-header">--- 21,12 ---</span>
  #include &quot;Page.h&quot;
  
  #include &quot;ActivityStateChangeObserver.h&quot;
  #include &quot;AlternativeTextClient.h&quot;
  #include &quot;ApplicationCacheStorage.h&quot;
  #include &quot;AuthenticatorCoordinator.h&quot;
<span class="line-added">+ #include &quot;BackForwardCache.h&quot;</span>
  #include &quot;BackForwardClient.h&quot;
  #include &quot;BackForwardController.h&quot;
  #include &quot;CSSAnimationController.h&quot;
  #include &quot;CacheStorageProvider.h&quot;
  #include &quot;Chrome.h&quot;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 59,22 ***</span>
  #include &quot;FrameTree.h&quot;
  #include &quot;FrameView.h&quot;
  #include &quot;FullscreenManager.h&quot;
  #include &quot;HTMLElement.h&quot;
  #include &quot;HTMLMediaElement.h&quot;
  #include &quot;HistoryController.h&quot;
  #include &quot;HistoryItem.h&quot;
  #include &quot;InspectorClient.h&quot;
  #include &quot;InspectorController.h&quot;
  #include &quot;InspectorInstrumentation.h&quot;
  #include &quot;LibWebRTCProvider.h&quot;
  #include &quot;LoaderStrategy.h&quot;
  #include &quot;Logging.h&quot;
  #include &quot;LowPowerModeNotifier.h&quot;
  #include &quot;MediaCanStartListener.h&quot;
  #include &quot;Navigator.h&quot;
<span class="line-removed">- #include &quot;PageCache.h&quot;</span>
  #include &quot;PageConfiguration.h&quot;
  #include &quot;PageConsoleClient.h&quot;
  #include &quot;PageDebuggable.h&quot;
  #include &quot;PageGroup.h&quot;
  #include &quot;PageOverlayController.h&quot;
<span class="line-new-header">--- 59,25 ---</span>
  #include &quot;FrameTree.h&quot;
  #include &quot;FrameView.h&quot;
  #include &quot;FullscreenManager.h&quot;
  #include &quot;HTMLElement.h&quot;
  #include &quot;HTMLMediaElement.h&quot;
<span class="line-added">+ #include &quot;HTMLTextAreaElement.h&quot;</span>
<span class="line-added">+ #include &quot;HTMLTextFormControlElement.h&quot;</span>
  #include &quot;HistoryController.h&quot;
  #include &quot;HistoryItem.h&quot;
  #include &quot;InspectorClient.h&quot;
  #include &quot;InspectorController.h&quot;
  #include &quot;InspectorInstrumentation.h&quot;
<span class="line-added">+ #include &quot;LegacySchemeRegistry.h&quot;</span>
  #include &quot;LibWebRTCProvider.h&quot;
  #include &quot;LoaderStrategy.h&quot;
  #include &quot;Logging.h&quot;
  #include &quot;LowPowerModeNotifier.h&quot;
  #include &quot;MediaCanStartListener.h&quot;
<span class="line-added">+ #include &quot;MediaRecorderProvider.h&quot;</span>
  #include &quot;Navigator.h&quot;
  #include &quot;PageConfiguration.h&quot;
  #include &quot;PageConsoleClient.h&quot;
  #include &quot;PageDebuggable.h&quot;
  #include &quot;PageGroup.h&quot;
  #include &quot;PageOverlayController.h&quot;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 98,34 ***</span>
  #include &quot;RenderWidget.h&quot;
  #include &quot;ResizeObserver.h&quot;
  #include &quot;ResourceUsageOverlay.h&quot;
  #include &quot;RuntimeEnabledFeatures.h&quot;
  #include &quot;SVGDocumentExtensions.h&quot;
<span class="line-removed">- #include &quot;SchemeRegistry.h&quot;</span>
  #include &quot;ScriptController.h&quot;
  #include &quot;ScriptedAnimationController.h&quot;
  #include &quot;ScrollLatchingState.h&quot;
  #include &quot;ScrollingCoordinator.h&quot;
  #include &quot;Settings.h&quot;
  #include &quot;SharedBuffer.h&quot;
  #include &quot;SocketProvider.h&quot;
  #include &quot;StorageArea.h&quot;
  #include &quot;StorageNamespace.h&quot;
  #include &quot;StorageNamespaceProvider.h&quot;
  #include &quot;StyleResolver.h&quot;
  #include &quot;StyleScope.h&quot;
  #include &quot;SubframeLoader.h&quot;
  #include &quot;TextIterator.h&quot;
  #include &quot;TextResourceDecoder.h&quot;
  #include &quot;UserContentProvider.h&quot;
  #include &quot;UserInputBridge.h&quot;
  #include &quot;ValidationMessageClient.h&quot;
  #include &quot;VisitedLinkState.h&quot;
  #include &quot;VisitedLinkStore.h&quot;
  #include &quot;VoidCallback.h&quot;
  #include &quot;WheelEventDeltaFilter.h&quot;
  #include &quot;Widget.h&quot;
  #include &lt;wtf/FileSystem.h&gt;
  #include &lt;wtf/RefCountedLeakCounter.h&gt;
  #include &lt;wtf/StdLibExtras.h&gt;
  #include &lt;wtf/SystemTracing.h&gt;
  #include &lt;wtf/text/Base64.h&gt;
<span class="line-new-header">--- 101,36 ---</span>
  #include &quot;RenderWidget.h&quot;
  #include &quot;ResizeObserver.h&quot;
  #include &quot;ResourceUsageOverlay.h&quot;
  #include &quot;RuntimeEnabledFeatures.h&quot;
  #include &quot;SVGDocumentExtensions.h&quot;
  #include &quot;ScriptController.h&quot;
  #include &quot;ScriptedAnimationController.h&quot;
  #include &quot;ScrollLatchingState.h&quot;
  #include &quot;ScrollingCoordinator.h&quot;
  #include &quot;Settings.h&quot;
  #include &quot;SharedBuffer.h&quot;
  #include &quot;SocketProvider.h&quot;
  #include &quot;StorageArea.h&quot;
  #include &quot;StorageNamespace.h&quot;
  #include &quot;StorageNamespaceProvider.h&quot;
<span class="line-added">+ #include &quot;StyleAdjuster.h&quot;</span>
  #include &quot;StyleResolver.h&quot;
  #include &quot;StyleScope.h&quot;
  #include &quot;SubframeLoader.h&quot;
  #include &quot;TextIterator.h&quot;
  #include &quot;TextResourceDecoder.h&quot;
  #include &quot;UserContentProvider.h&quot;
<span class="line-added">+ #include &quot;UserContentURLPattern.h&quot;</span>
  #include &quot;UserInputBridge.h&quot;
  #include &quot;ValidationMessageClient.h&quot;
  #include &quot;VisitedLinkState.h&quot;
  #include &quot;VisitedLinkStore.h&quot;
  #include &quot;VoidCallback.h&quot;
  #include &quot;WheelEventDeltaFilter.h&quot;
  #include &quot;Widget.h&quot;
<span class="line-added">+ #include &lt;wtf/Deque.h&gt;</span>
  #include &lt;wtf/FileSystem.h&gt;
  #include &lt;wtf/RefCountedLeakCounter.h&gt;
  #include &lt;wtf/StdLibExtras.h&gt;
  #include &lt;wtf/SystemTracing.h&gt;
  #include &lt;wtf/text/Base64.h&gt;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 144,15 ***</span>
  #include &quot;MediaSessionManager.h&quot;
  #endif
  
  #if ENABLE(INDEXED_DATABASE)
  #include &quot;IDBConnectionToServer.h&quot;
<span class="line-removed">- #include &quot;InProcessIDBServer.h&quot;</span>
<span class="line-removed">- #endif</span>
<span class="line-removed">- </span>
<span class="line-removed">- #if ENABLE(DATA_INTERACTION)</span>
<span class="line-removed">- #include &quot;SelectionRect.h&quot;</span>
  #endif
  
  #if ENABLE(WEBGL)
  #include &quot;WebGLStateTracker.h&quot;
  #endif
<span class="line-new-header">--- 149,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 212,11 ***</span>
  
  Page::Page(PageConfiguration&amp;&amp; pageConfiguration)
      : m_chrome(makeUnique&lt;Chrome&gt;(*this, *pageConfiguration.chromeClient))
      , m_dragCaretController(makeUnique&lt;DragCaretController&gt;())
  #if ENABLE(DRAG_SUPPORT)
<span class="line-modified">!     , m_dragController(makeUnique&lt;DragController&gt;(*this, *pageConfiguration.dragClient))</span>
  #endif
      , m_focusController(makeUnique&lt;FocusController&gt;(*this, pageInitialActivityState()))
  #if ENABLE(CONTEXT_MENUS)
      , m_contextMenuController(makeUnique&lt;ContextMenuController&gt;(*this, *pageConfiguration.contextMenuClient))
  #endif
<span class="line-new-header">--- 212,11 ---</span>
  
  Page::Page(PageConfiguration&amp;&amp; pageConfiguration)
      : m_chrome(makeUnique&lt;Chrome&gt;(*this, *pageConfiguration.chromeClient))
      , m_dragCaretController(makeUnique&lt;DragCaretController&gt;())
  #if ENABLE(DRAG_SUPPORT)
<span class="line-modified">!     , m_dragController(makeUnique&lt;DragController&gt;(*this, WTFMove(pageConfiguration.dragClient)))</span>
  #endif
      , m_focusController(makeUnique&lt;FocusController&gt;(*this, pageInitialActivityState()))
  #if ENABLE(CONTEXT_MENUS)
      , m_contextMenuController(makeUnique&lt;ContextMenuController&gt;(*this, *pageConfiguration.contextMenuClient))
  #endif
</pre>
<hr />
<pre>
<span class="line-old-header">*** 227,31 ***</span>
  #endif
  #if ENABLE(POINTER_LOCK)
      , m_pointerLockController(makeUnique&lt;PointerLockController&gt;(*this))
  #endif
      , m_settings(Settings::create(this))
<span class="line-modified">!     , m_progress(makeUnique&lt;ProgressTracker&gt;(*pageConfiguration.progressTrackerClient))</span>
      , m_backForwardController(makeUnique&lt;BackForwardController&gt;(*this, WTFMove(pageConfiguration.backForwardClient)))
      , m_mainFrame(Frame::create(this, nullptr, pageConfiguration.loaderClientForMainFrame))
      , m_editorClient(WTFMove(pageConfiguration.editorClient))
<span class="line-modified">!     , m_plugInClient(pageConfiguration.plugInClient)</span>
      , m_validationMessageClient(WTFMove(pageConfiguration.validationMessageClient))
      , m_diagnosticLoggingClient(WTFMove(pageConfiguration.diagnosticLoggingClient))
      , m_performanceLoggingClient(WTFMove(pageConfiguration.performanceLoggingClient))
  #if ENABLE(WEBGL)
      , m_webGLStateTracker(WTFMove(pageConfiguration.webGLStateTracker))
  #endif
  #if ENABLE(SPEECH_SYNTHESIS)
      , m_speechSynthesisClient(WTFMove(pageConfiguration.speechSynthesisClient))
  #endif
      , m_libWebRTCProvider(WTFMove(pageConfiguration.libWebRTCProvider))
      , m_verticalScrollElasticity(ScrollElasticityAllowed)
      , m_horizontalScrollElasticity(ScrollElasticityAllowed)
      , m_domTimerAlignmentInterval(DOMTimer::defaultAlignmentInterval())
      , m_domTimerAlignmentIntervalIncreaseTimer(*this, &amp;Page::domTimerAlignmentIntervalIncreaseTimerFired)
      , m_activityState(pageInitialActivityState())
<span class="line-modified">!     , m_alternativeTextClient(pageConfiguration.alternativeTextClient)</span>
      , m_consoleClient(makeUnique&lt;PageConsoleClient&gt;(*this))
  #if ENABLE(REMOTE_INSPECTOR)
      , m_inspectorDebuggable(makeUnique&lt;PageDebuggable&gt;(*this))
  #endif
      , m_socketProvider(WTFMove(pageConfiguration.socketProvider))
<span class="line-new-header">--- 227,32 ---</span>
  #endif
  #if ENABLE(POINTER_LOCK)
      , m_pointerLockController(makeUnique&lt;PointerLockController&gt;(*this))
  #endif
      , m_settings(Settings::create(this))
<span class="line-modified">!     , m_progress(makeUnique&lt;ProgressTracker&gt;(WTFMove(pageConfiguration.progressTrackerClient)))</span>
      , m_backForwardController(makeUnique&lt;BackForwardController&gt;(*this, WTFMove(pageConfiguration.backForwardClient)))
      , m_mainFrame(Frame::create(this, nullptr, pageConfiguration.loaderClientForMainFrame))
      , m_editorClient(WTFMove(pageConfiguration.editorClient))
<span class="line-modified">!     , m_plugInClient(WTFMove(pageConfiguration.plugInClient))</span>
      , m_validationMessageClient(WTFMove(pageConfiguration.validationMessageClient))
      , m_diagnosticLoggingClient(WTFMove(pageConfiguration.diagnosticLoggingClient))
      , m_performanceLoggingClient(WTFMove(pageConfiguration.performanceLoggingClient))
  #if ENABLE(WEBGL)
      , m_webGLStateTracker(WTFMove(pageConfiguration.webGLStateTracker))
  #endif
  #if ENABLE(SPEECH_SYNTHESIS)
      , m_speechSynthesisClient(WTFMove(pageConfiguration.speechSynthesisClient))
  #endif
<span class="line-added">+     , m_mediaRecorderProvider((WTFMove(pageConfiguration.mediaRecorderProvider)))</span>
      , m_libWebRTCProvider(WTFMove(pageConfiguration.libWebRTCProvider))
      , m_verticalScrollElasticity(ScrollElasticityAllowed)
      , m_horizontalScrollElasticity(ScrollElasticityAllowed)
      , m_domTimerAlignmentInterval(DOMTimer::defaultAlignmentInterval())
      , m_domTimerAlignmentIntervalIncreaseTimer(*this, &amp;Page::domTimerAlignmentIntervalIncreaseTimerFired)
      , m_activityState(pageInitialActivityState())
<span class="line-modified">!     , m_alternativeTextClient(WTFMove(pageConfiguration.alternativeTextClient))</span>
      , m_consoleClient(makeUnique&lt;PageConsoleClient&gt;(*this))
  #if ENABLE(REMOTE_INSPECTOR)
      , m_inspectorDebuggable(makeUnique&lt;PageDebuggable&gt;(*this))
  #endif
      , m_socketProvider(WTFMove(pageConfiguration.socketProvider))
</pre>
<hr />
<pre>
<span class="line-old-header">*** 261,11 ***</span>
      , m_databaseProvider(*WTFMove(pageConfiguration.databaseProvider))
      , m_pluginInfoProvider(*WTFMove(pageConfiguration.pluginInfoProvider))
      , m_storageNamespaceProvider(*WTFMove(pageConfiguration.storageNamespaceProvider))
      , m_userContentProvider(*WTFMove(pageConfiguration.userContentProvider))
      , m_visitedLinkStore(*WTFMove(pageConfiguration.visitedLinkStore))
<span class="line-modified">!     , m_sessionID(PAL::SessionID::defaultSessionID())</span>
  #if ENABLE(VIDEO)
      , m_playbackControlsManagerUpdateTimer(*this, &amp;Page::playbackControlsManagerUpdateTimerFired)
  #endif
      , m_isUtilityPage(isUtilityPageChromeClient(chrome().client()))
      , m_performanceMonitor(isUtilityPage() ? nullptr : makeUnique&lt;PerformanceMonitor&gt;(*this))
<span class="line-new-header">--- 262,11 ---</span>
      , m_databaseProvider(*WTFMove(pageConfiguration.databaseProvider))
      , m_pluginInfoProvider(*WTFMove(pageConfiguration.pluginInfoProvider))
      , m_storageNamespaceProvider(*WTFMove(pageConfiguration.storageNamespaceProvider))
      , m_userContentProvider(*WTFMove(pageConfiguration.userContentProvider))
      , m_visitedLinkStore(*WTFMove(pageConfiguration.visitedLinkStore))
<span class="line-modified">!     , m_sessionID(pageConfiguration.sessionID)</span>
  #if ENABLE(VIDEO)
      , m_playbackControlsManagerUpdateTimer(*this, &amp;Page::playbackControlsManagerUpdateTimerFired)
  #endif
      , m_isUtilityPage(isUtilityPageChromeClient(chrome().client()))
      , m_performanceMonitor(isUtilityPage() ? nullptr : makeUnique&lt;PerformanceMonitor&gt;(*this))
</pre>
<hr />
<pre>
<span class="line-old-header">*** 283,10 ***</span>
<span class="line-new-header">--- 284,13 ---</span>
      , m_authenticatorCoordinator(makeUniqueRef&lt;AuthenticatorCoordinator&gt;(WTFMove(pageConfiguration.authenticatorCoordinatorClient)))
  #endif
  #if ENABLE(APPLICATION_MANIFEST)
      , m_applicationManifest(pageConfiguration.applicationManifest)
  #endif
<span class="line-added">+ #if ENABLE(DEVICE_ORIENTATION) &amp;&amp; PLATFORM(IOS_FAMILY)</span>
<span class="line-added">+     , m_deviceOrientationUpdateProvider(WTFMove(pageConfiguration.deviceOrientationUpdateProvider))</span>
<span class="line-added">+ #endif</span>
  {
      updateTimerThrottlingState();
  
      m_pluginInfoProvider-&gt;addPage(*this);
      m_userContentProvider-&gt;addPage(*this);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 320,10 ***</span>
<span class="line-new-header">--- 324,18 ---</span>
  #endif
  
  #if USE(LIBWEBRTC)
      m_libWebRTCProvider-&gt;supportsVP8(RuntimeEnabledFeatures::sharedFeatures().webRTCVP8CodecEnabled());
  #endif
<span class="line-added">+ </span>
<span class="line-added">+     m_corsDisablingPatterns.reserveInitialCapacity(pageConfiguration.corsDisablingPatterns.size());</span>
<span class="line-added">+     for (auto&amp;&amp; pattern : WTFMove(pageConfiguration.corsDisablingPatterns)) {</span>
<span class="line-added">+         UserContentURLPattern parsedPattern(WTFMove(pattern));</span>
<span class="line-added">+         if (parsedPattern.isValid())</span>
<span class="line-added">+             m_corsDisablingPatterns.uncheckedAppend(WTFMove(parsedPattern));</span>
<span class="line-added">+     }</span>
<span class="line-added">+     m_corsDisablingPatterns.shrinkToFit();</span>
  }
  
  Page::~Page()
  {
      ASSERT(!m_nestedRunLoopCount);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 347,21 ***</span>
      for (Frame* frame = &amp;mainFrame(); frame; frame = frame-&gt;tree().traverseNext()) {
          frame-&gt;willDetachPage();
          frame-&gt;detachFromPage();
      }
  
<span class="line-removed">-     if (m_plugInClient)</span>
<span class="line-removed">-         m_plugInClient-&gt;pageDestroyed();</span>
<span class="line-removed">-     if (m_alternativeTextClient)</span>
<span class="line-removed">-         m_alternativeTextClient-&gt;pageDestroyed();</span>
<span class="line-removed">- </span>
      if (m_scrollingCoordinator)
          m_scrollingCoordinator-&gt;pageDestroyed();
  
      backForward().close();
      if (!isUtilityPage())
<span class="line-modified">!         PageCache::singleton().removeAllItemsForPage(*this);</span>
  
  #ifndef NDEBUG
      pageCounter.decrement();
  #endif
  
<span class="line-new-header">--- 359,16 ---</span>
      for (Frame* frame = &amp;mainFrame(); frame; frame = frame-&gt;tree().traverseNext()) {
          frame-&gt;willDetachPage();
          frame-&gt;detachFromPage();
      }
  
      if (m_scrollingCoordinator)
          m_scrollingCoordinator-&gt;pageDestroyed();
  
      backForward().close();
      if (!isUtilityPage())
<span class="line-modified">!         BackForwardCache::singleton().removeAllItemsForPage(*this);</span>
  
  #ifndef NDEBUG
      pageCounter.decrement();
  #endif
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 382,15 ***</span>
  }
  
  uint64_t Page::renderTreeSize() const
  {
      uint64_t total = 0;
<span class="line-modified">!     for (const Frame* frame = &amp;mainFrame(); frame; frame = frame-&gt;tree().traverseNext()) {</span>
<span class="line-modified">!         if (!frame-&gt;document() || !frame-&gt;document()-&gt;renderView())</span>
<span class="line-modified">!             continue;</span>
<span class="line-modified">!         total += frame-&gt;document()-&gt;renderView()-&gt;rendererCount();</span>
<span class="line-removed">-     }</span>
      return total;
  }
  
  OptionSet&lt;DisabledAdaptations&gt; Page::disabledAdaptations() const
  {
<span class="line-new-header">--- 389,14 ---</span>
  }
  
  uint64_t Page::renderTreeSize() const
  {
      uint64_t total = 0;
<span class="line-modified">!     forEachDocument([&amp;] (Document&amp; document) {</span>
<span class="line-modified">!         if (auto* renderView = document.renderView())</span>
<span class="line-modified">!             total += renderView-&gt;rendererCount();</span>
<span class="line-modified">!     });</span>
      return total;
  }
  
  OptionSet&lt;DisabledAdaptations&gt; Page::disabledAdaptations() const
  {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 563,23 ***</span>
      m_group = m_singlePageGroup.get();
  }
  
  void Page::updateStyleAfterChangeInEnvironment()
  {
<span class="line-modified">!     for (Frame* frame = &amp;mainFrame(); frame; frame = frame-&gt;tree().traverseNext()) {</span>
<span class="line-modified">!         // If a change in the global environment has occurred, we need to</span>
<span class="line-modified">!         // make sure all the properties a recomputed, therefore we invalidate</span>
<span class="line-modified">!         // the properties cache.</span>
<span class="line-modified">!         auto* document = frame-&gt;document();</span>
<span class="line-modified">!         if (!document)</span>
<span class="line-modified">!             continue;</span>
<span class="line-removed">- </span>
<span class="line-removed">-         if (StyleResolver* styleResolver = document-&gt;styleScope().resolverIfExists())</span>
<span class="line-removed">-             styleResolver-&gt;invalidateMatchedPropertiesCache();</span>
<span class="line-removed">-         document-&gt;scheduleFullStyleRebuild();</span>
<span class="line-removed">-         document-&gt;styleScope().didChangeStyleSheetEnvironment();</span>
<span class="line-removed">-     }</span>
  }
  
  void Page::updateStyleForAllPagesAfterGlobalChangeInEnvironment()
  {
      for (auto* page : allPages())
<span class="line-new-header">--- 569,17 ---</span>
      m_group = m_singlePageGroup.get();
  }
  
  void Page::updateStyleAfterChangeInEnvironment()
  {
<span class="line-modified">!     forEachDocument([] (Document&amp; document) {</span>
<span class="line-modified">!         if (auto* styleResolver = document.styleScope().resolverIfExists())</span>
<span class="line-modified">!             styleResolver-&gt;invalidateMatchedDeclarationsCache();</span>
<span class="line-modified">!         document.scheduleFullStyleRebuild();</span>
<span class="line-modified">!         document.styleScope().didChangeStyleSheetEnvironment();</span>
<span class="line-modified">!         document.scheduleTimedRenderingUpdate();</span>
<span class="line-modified">!     });</span>
  }
  
  void Page::updateStyleForAllPagesAfterGlobalChangeInEnvironment()
  {
      for (auto* page : allPages())
</pre>
<hr />
<pre>
<span class="line-old-header">*** 587,14 ***</span>
  }
  
  void Page::setNeedsRecalcStyleInAllFrames()
  {
      // FIXME: Figure out what this function is actually trying to add in different call sites.
<span class="line-modified">!     for (Frame* frame = &amp;mainFrame(); frame; frame = frame-&gt;tree().traverseNext()) {</span>
<span class="line-modified">!         if (Document* document = frame-&gt;document())</span>
<span class="line-modified">!             document-&gt;styleScope().didChangeStyleSheetEnvironment();</span>
<span class="line-removed">-     }</span>
  }
  
  void Page::refreshPlugins(bool reload)
  {
      HashSet&lt;PluginInfoProvider*&gt; pluginInfoProviders;
<span class="line-new-header">--- 587,13 ---</span>
  }
  
  void Page::setNeedsRecalcStyleInAllFrames()
  {
      // FIXME: Figure out what this function is actually trying to add in different call sites.
<span class="line-modified">!     forEachDocument([] (Document&amp; document) {</span>
<span class="line-modified">!         document.styleScope().didChangeStyleSheetEnvironment();</span>
<span class="line-modified">!     });</span>
  }
  
  void Page::refreshPlugins(bool reload)
  {
      HashSet&lt;PluginInfoProvider*&gt; pluginInfoProviders;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 909,15 ***</span>
      return 1;
  }
  
  void Page::unmarkAllTextMatches()
  {
<span class="line-modified">!     Frame* frame = &amp;mainFrame();</span>
<span class="line-modified">!     do {</span>
<span class="line-modified">!         frame-&gt;document()-&gt;markers().removeMarkers(DocumentMarker::TextMatch);</span>
<span class="line-modified">!         frame = incrementFrame(frame, true, CanWrap::No);</span>
<span class="line-modified">!     } while (frame);</span>
  }
  
  const VisibleSelection&amp; Page::selection() const
  {
      return focusController().focusedOrMainFrame().selection().selection();
<span class="line-new-header">--- 908,48 ---</span>
      return 1;
  }
  
  void Page::unmarkAllTextMatches()
  {
<span class="line-modified">!     forEachDocument([] (Document&amp; document) {</span>
<span class="line-modified">!         document.markers().removeMarkers(DocumentMarker::TextMatch);</span>
<span class="line-modified">!     });</span>
<span class="line-modified">! }</span>
<span class="line-modified">! </span>
<span class="line-added">+ static bool isEditableTextInputElement(const Element&amp; element)</span>
<span class="line-added">+ {</span>
<span class="line-added">+     if (is&lt;HTMLTextFormControlElement&gt;(element)) {</span>
<span class="line-added">+         if (!element.isTextField() &amp;&amp; !is&lt;HTMLTextAreaElement&gt;(element))</span>
<span class="line-added">+             return false;</span>
<span class="line-added">+         return downcast&lt;HTMLTextFormControlElement&gt;(element).isInnerTextElementEditable();</span>
<span class="line-added">+     }</span>
<span class="line-added">+     return element.isRootEditableElement();</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ Vector&lt;Ref&lt;Element&gt;&gt; Page::editableElementsInRect(const FloatRect&amp; searchRectInRootViewCoordinates) const</span>
<span class="line-added">+ {</span>
<span class="line-added">+     Vector&lt;Ref&lt;Element&gt;&gt; result;</span>
<span class="line-added">+     forEachDocument([&amp;] (Document&amp; document) {</span>
<span class="line-added">+         Deque&lt;Node*&gt; nodesToSearch;</span>
<span class="line-added">+         nodesToSearch.append(&amp;document);</span>
<span class="line-added">+         while (!nodesToSearch.isEmpty()) {</span>
<span class="line-added">+             auto* node = nodesToSearch.takeFirst();</span>
<span class="line-added">+ </span>
<span class="line-added">+             // It is possible to have nested text input contexts (e.g. &lt;input type=&#39;text&#39;&gt; inside contenteditable) but</span>
<span class="line-added">+             // in this case we just take the outermost context and skip the rest.</span>
<span class="line-added">+             if (!is&lt;Element&gt;(node) || !isEditableTextInputElement(downcast&lt;Element&gt;(*node))) {</span>
<span class="line-added">+                 for (auto* child = node-&gt;firstChild(); child; child = child-&gt;nextSibling())</span>
<span class="line-added">+                     nodesToSearch.append(child);</span>
<span class="line-added">+                 continue;</span>
<span class="line-added">+             }</span>
<span class="line-added">+ </span>
<span class="line-added">+             auto&amp; element = downcast&lt;Element&gt;(*node);</span>
<span class="line-added">+             if (searchRectInRootViewCoordinates.intersects(element.clientRect()))</span>
<span class="line-added">+                 result.append(element);</span>
<span class="line-added">+         }</span>
<span class="line-added">+     });</span>
<span class="line-added">+     return result;</span>
  }
  
  const VisibleSelection&amp; Page::selection() const
  {
      return focusController().focusedOrMainFrame().selection().selection();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 967,22 ***</span>
      return *m_diagnosticLoggingClient;
  }
  
  void Page::setMediaVolume(float volume)
  {
<span class="line-modified">!     if (volume &lt; 0 || volume &gt; 1)</span>
          return;
  
      if (m_mediaVolume == volume)
          return;
  
      m_mediaVolume = volume;
<span class="line-modified">!     for (Frame* frame = &amp;mainFrame(); frame; frame = frame-&gt;tree().traverseNext()) {</span>
<span class="line-modified">!         if (!frame-&gt;document())</span>
<span class="line-modified">!             continue;</span>
<span class="line-modified">!         frame-&gt;document()-&gt;mediaVolumeDidChange();</span>
<span class="line-modified">!     }</span>
  }
  
  void Page::setZoomedOutPageScaleFactor(float scale)
  {
      if (m_zoomedOutPageScaleFactor == scale)
<span class="line-new-header">--- 999,23 ---</span>
      return *m_diagnosticLoggingClient;
  }
  
  void Page::setMediaVolume(float volume)
  {
<span class="line-modified">!     if (!(volume &gt;= 0 &amp;&amp; volume &lt;= 1))</span>
          return;
  
      if (m_mediaVolume == volume)
          return;
  
      m_mediaVolume = volume;
<span class="line-modified">! </span>
<span class="line-modified">! #if ENABLE(VIDEO)</span>
<span class="line-modified">!     forEachMediaElement([] (HTMLMediaElement&amp; element) {</span>
<span class="line-modified">!         element.mediaVolumeDidChange();</span>
<span class="line-modified">!     });</span>
<span class="line-added">+ #endif</span>
  }
  
  void Page::setZoomedOutPageScaleFactor(float scale)
  {
      if (m_zoomedOutPageScaleFactor == scale)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 995,85 ***</span>
  void Page::setPageScaleFactor(float scale, const IntPoint&amp; origin, bool inStableState)
  {
      LOG(Viewports, &quot;Page::setPageScaleFactor %.2f - inStableState %d&quot;, scale, inStableState);
  
      Document* document = mainFrame().document();
<span class="line-modified">!     FrameView* view = document-&gt;view();</span>
  
      if (scale == m_pageScaleFactor) {
<span class="line-modified">!         if (view &amp;&amp; view-&gt;scrollPosition() != origin) {</span>
<span class="line-modified">!             if (!m_settings-&gt;delegatesPageScaling())</span>
<span class="line-modified">!                 document-&gt;updateLayoutIgnorePendingStylesheets();</span>
<span class="line-modified">! </span>
<span class="line-removed">-             if (!view-&gt;delegatesScrolling())</span>
<span class="line-removed">-                 view-&gt;setScrollPosition(origin);</span>
<span class="line-removed">- #if USE(COORDINATED_GRAPHICS)</span>
<span class="line-removed">-             else</span>
<span class="line-removed">-                 view-&gt;requestScrollPositionUpdate(origin);</span>
<span class="line-removed">- #endif</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- #if ENABLE(MEDIA_CONTROLS_SCRIPT)</span>
<span class="line-removed">-         if (inStableState) {</span>
<span class="line-removed">-             for (Frame* frame = &amp;mainFrame(); frame; frame = frame-&gt;tree().traverseNext()) {</span>
<span class="line-removed">-                 if (!frame-&gt;document())</span>
<span class="line-removed">-                     continue;</span>
<span class="line-removed">-                 frame-&gt;document()-&gt;pageScaleFactorChangedAndStable();</span>
<span class="line-removed">-             }</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- #endif</span>
<span class="line-removed">-         return;</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     m_pageScaleFactor = scale;</span>
  
<span class="line-modified">!     if (!m_settings-&gt;delegatesPageScaling()) {</span>
<span class="line-modified">!         view-&gt;setNeedsLayoutAfterViewConfigurationChange();</span>
<span class="line-modified">!         view-&gt;setNeedsCompositingGeometryUpdate();</span>
  
<span class="line-modified">!         document-&gt;resolveStyle(Document::ResolveStyleType::Rebuild);</span>
  
<span class="line-modified">!         // Transform change on RenderView doesn&#39;t trigger repaint on non-composited contents.</span>
<span class="line-modified">!         mainFrame().view()-&gt;invalidateRect(IntRect(LayoutRect::infiniteRect()));</span>
<span class="line-modified">!     }</span>
  
<span class="line-modified">!     mainFrame().deviceOrPageScaleFactorChanged();</span>
  
<span class="line-modified">!     if (view &amp;&amp; view-&gt;fixedElementsLayoutRelativeToFrame())</span>
<span class="line-modified">!         view-&gt;setViewportConstrainedObjectsNeedLayout();</span>
  
<span class="line-modified">!     if (view &amp;&amp; view-&gt;scrollPosition() != origin) {</span>
<span class="line-removed">-         if (!m_settings-&gt;delegatesPageScaling() &amp;&amp; document-&gt;renderView() &amp;&amp; document-&gt;renderView()-&gt;needsLayout() &amp;&amp; view-&gt;didFirstLayout())</span>
              view-&gt;layoutContext().layout();
  
          if (!view-&gt;delegatesScrolling())
              view-&gt;setScrollPosition(origin);
  #if USE(COORDINATED_GRAPHICS)
          else
              view-&gt;requestScrollPositionUpdate(origin);
  #endif
      }
  
  #if ENABLE(MEDIA_CONTROLS_SCRIPT)
      if (inStableState) {
<span class="line-modified">!         for (Frame* frame = &amp;mainFrame(); frame; frame = frame-&gt;tree().traverseNext()) {</span>
<span class="line-modified">!             if (!frame-&gt;document())</span>
<span class="line-modified">!                 continue;</span>
<span class="line-removed">-             frame-&gt;document()-&gt;pageScaleFactorChangedAndStable();</span>
<span class="line-removed">-         }</span>
      }
  #else
      UNUSED_PARAM(inStableState);
  #endif
  }
  
  void Page::setViewScaleFactor(float scale)
  {
      if (m_viewScaleFactor == scale)
          return;
  
      m_viewScaleFactor = scale;
<span class="line-modified">!     PageCache::singleton().markPagesForDeviceOrPageScaleChanged(*this);</span>
  }
  
  void Page::setDeviceScaleFactor(float scaleFactor)
  {
      ASSERT(scaleFactor &gt; 0);
<span class="line-new-header">--- 1028,69 ---</span>
  void Page::setPageScaleFactor(float scale, const IntPoint&amp; origin, bool inStableState)
  {
      LOG(Viewports, &quot;Page::setPageScaleFactor %.2f - inStableState %d&quot;, scale, inStableState);
  
      Document* document = mainFrame().document();
<span class="line-modified">!     RefPtr&lt;FrameView&gt; view = document-&gt;view();</span>
  
      if (scale == m_pageScaleFactor) {
<span class="line-modified">!         if (view &amp;&amp; view-&gt;scrollPosition() != origin &amp;&amp; !delegatesScaling())</span>
<span class="line-modified">!             document-&gt;updateLayoutIgnorePendingStylesheets();</span>
<span class="line-modified">!     } else {</span>
<span class="line-modified">!         m_pageScaleFactor = scale;</span>
  
<span class="line-modified">!         if (view &amp;&amp; !delegatesScaling()) {</span>
<span class="line-modified">!             view-&gt;setNeedsLayoutAfterViewConfigurationChange();</span>
<span class="line-modified">!             view-&gt;setNeedsCompositingGeometryUpdate();</span>
  
<span class="line-modified">!             document-&gt;resolveStyle(Document::ResolveStyleType::Rebuild);</span>
  
<span class="line-modified">!             // Transform change on RenderView doesn&#39;t trigger repaint on non-composited contents.</span>
<span class="line-modified">!             mainFrame().view()-&gt;invalidateRect(IntRect(LayoutRect::infiniteRect()));</span>
<span class="line-modified">!         }</span>
  
<span class="line-modified">!         mainFrame().deviceOrPageScaleFactorChanged();</span>
  
<span class="line-modified">!         if (view &amp;&amp; view-&gt;fixedElementsLayoutRelativeToFrame())</span>
<span class="line-modified">!             view-&gt;setViewportConstrainedObjectsNeedLayout();</span>
  
<span class="line-modified">!         if (view &amp;&amp; view-&gt;scrollPosition() != origin &amp;&amp; !delegatesScaling() &amp;&amp; document-&gt;renderView() &amp;&amp; document-&gt;renderView()-&gt;needsLayout() &amp;&amp; view-&gt;didFirstLayout())</span>
              view-&gt;layoutContext().layout();
<span class="line-added">+     }</span>
  
<span class="line-added">+     if (view &amp;&amp; view-&gt;scrollPosition() != origin) {</span>
          if (!view-&gt;delegatesScrolling())
              view-&gt;setScrollPosition(origin);
  #if USE(COORDINATED_GRAPHICS)
          else
              view-&gt;requestScrollPositionUpdate(origin);
  #endif
      }
  
  #if ENABLE(MEDIA_CONTROLS_SCRIPT)
      if (inStableState) {
<span class="line-modified">!         forEachMediaElement([] (HTMLMediaElement&amp; element) {</span>
<span class="line-modified">!             element.pageScaleFactorChanged();</span>
<span class="line-modified">!         });</span>
      }
  #else
      UNUSED_PARAM(inStableState);
  #endif
  }
  
<span class="line-added">+ void Page::setDelegatesScaling(bool delegatesScaling)</span>
<span class="line-added">+ {</span>
<span class="line-added">+     m_delegatesScaling = delegatesScaling;</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
  void Page::setViewScaleFactor(float scale)
  {
      if (m_viewScaleFactor == scale)
          return;
  
      m_viewScaleFactor = scale;
<span class="line-modified">!     BackForwardCache::singleton().markPagesForDeviceOrPageScaleChanged(*this);</span>
  }
  
  void Page::setDeviceScaleFactor(float scaleFactor)
  {
      ASSERT(scaleFactor &gt; 0);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1085,11 ***</span>
  
      m_deviceScaleFactor = scaleFactor;
      setNeedsRecalcStyleInAllFrames();
  
      mainFrame().deviceOrPageScaleFactorChanged();
<span class="line-modified">!     PageCache::singleton().markPagesForDeviceOrPageScaleChanged(*this);</span>
  
      pageOverlayController().didChangeDeviceScaleFactor();
  }
  
  void Page::setInitialScale(float initialScale)
<span class="line-new-header">--- 1102,11 ---</span>
  
      m_deviceScaleFactor = scaleFactor;
      setNeedsRecalcStyleInAllFrames();
  
      mainFrame().deviceOrPageScaleFactorChanged();
<span class="line-modified">!     BackForwardCache::singleton().markPagesForDeviceOrPageScaleChanged(*this);</span>
  
      pageOverlayController().didChangeDeviceScaleFactor();
  }
  
  void Page::setInitialScale(float initialScale)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1101,25 ***</span>
  {
      if (m_userInterfaceLayoutDirection == userInterfaceLayoutDirection)
          return;
  
      m_userInterfaceLayoutDirection = userInterfaceLayoutDirection;
  #if ENABLE(MEDIA_CONTROLS_SCRIPT)
<span class="line-modified">!     for (Frame* frame = &amp;mainFrame(); frame; frame = frame-&gt;tree().traverseNext()) {</span>
<span class="line-modified">!         if (!frame-&gt;document())</span>
<span class="line-modified">!             continue;</span>
<span class="line-removed">-         frame-&gt;document()-&gt;userInterfaceLayoutDirectionChanged();</span>
<span class="line-removed">-     }</span>
  #endif
  }
  
  #if ENABLE(VIDEO)
  void Page::updateMediaElementRateChangeRestrictions()
  {
<span class="line-modified">!     for (auto* mediaElement : HTMLMediaElement::allMediaElements())</span>
<span class="line-modified">!         mediaElement-&gt;updateRateChangeRestrictions();</span>
  }
  #endif
  
  void Page::didStartProvisionalLoad()
  {
      if (m_performanceMonitor)
<span class="line-new-header">--- 1118,28 ---</span>
  {
      if (m_userInterfaceLayoutDirection == userInterfaceLayoutDirection)
          return;
  
      m_userInterfaceLayoutDirection = userInterfaceLayoutDirection;
<span class="line-added">+ </span>
  #if ENABLE(MEDIA_CONTROLS_SCRIPT)
<span class="line-modified">!     forEachMediaElement([] (HTMLMediaElement&amp; element) {</span>
<span class="line-modified">!         element.userInterfaceLayoutDirectionChanged();</span>
<span class="line-modified">!     });</span>
  #endif
  }
  
  #if ENABLE(VIDEO)
<span class="line-added">+ </span>
  void Page::updateMediaElementRateChangeRestrictions()
  {
<span class="line-modified">!     // FIXME: This used to call this on all media elements, seemingly by accident. But was there some advantage to that for elements in the back/forward cache?</span>
<span class="line-modified">!     forEachMediaElement([] (HTMLMediaElement&amp; element) {</span>
<span class="line-added">+         element.updateRateChangeRestrictions();</span>
<span class="line-added">+     });</span>
  }
<span class="line-added">+ </span>
  #endif
  
  void Page::didStartProvisionalLoad()
  {
      if (m_performanceMonitor)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1279,10 ***</span>
<span class="line-new-header">--- 1299,11 ---</span>
  {
      if (FrameView* view = m_mainFrame-&gt;view())
          view-&gt;updateLayoutAndStyleIfNeededRecursive();
  }
  
<span class="line-added">+ // https://html.spec.whatwg.org/multipage/webappapis.html#update-the-rendering</span>
  void Page::updateRendering()
  {
      // This function is not reentrant, e.g. a rAF callback may force repaint.
      if (m_inUpdateRendering) {
          layoutIfNeeded();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1291,71 ***</span>
  
      TraceScope traceScope(RenderingUpdateStart, RenderingUpdateEnd);
  
      SetForScope&lt;bool&gt; change(m_inUpdateRendering, true);
  
<span class="line-modified">!     Vector&lt;RefPtr&lt;Document&gt;&gt; documents;</span>
  
<span class="line-modified">!     // The requestAnimationFrame callbacks may change the frame hierarchy of the page</span>
<span class="line-modified">!     forEachDocument([&amp;documents] (Document&amp; document) {</span>
<span class="line-removed">-         documents.append(&amp;document);</span>
      });
  
<span class="line-modified">!     for (auto&amp; document : documents) {</span>
<span class="line-modified">!         DOMHighResTimeStamp timestamp = document-&gt;domWindow()-&gt;nowTimestamp();</span>
<span class="line-modified">!         document-&gt;updateAnimationsAndSendEvents(timestamp);</span>
<span class="line-modified">!         document-&gt;serviceRequestAnimationFrameCallbacks(timestamp);</span>
<span class="line-modified">!     }</span>
  
      layoutIfNeeded();
  
  #if ENABLE(INTERSECTION_OBSERVER)
<span class="line-modified">!     for (auto&amp; document : documents)</span>
<span class="line-modified">!         document-&gt;updateIntersectionObservations();</span>
  #endif
  #if ENABLE(RESIZE_OBSERVER)
<span class="line-modified">!     for (auto&amp; document : documents)</span>
<span class="line-modified">!         document-&gt;updateResizeObservations(*this);</span>
  #endif
  
      layoutIfNeeded();
  }
  
  void Page::suspendScriptedAnimations()
  {
      m_scriptedAnimationsSuspended = true;
<span class="line-modified">!     for (Frame* frame = &amp;mainFrame(); frame; frame = frame-&gt;tree().traverseNext()) {</span>
<span class="line-modified">!         if (frame-&gt;document())</span>
<span class="line-modified">!             frame-&gt;document()-&gt;suspendScriptedAnimationControllerCallbacks();</span>
<span class="line-modified">!     }</span>
  }
  
  void Page::resumeScriptedAnimations()
  {
      m_scriptedAnimationsSuspended = false;
<span class="line-modified">!     for (Frame* frame = &amp;mainFrame(); frame; frame = frame-&gt;tree().traverseNext()) {</span>
<span class="line-modified">!         if (frame-&gt;document())</span>
<span class="line-modified">!             frame-&gt;document()-&gt;resumeScriptedAnimationControllerCallbacks();</span>
<span class="line-modified">!     }</span>
  }
  
  enum class ThrottlingReasonOperation { Add, Remove };
  static void updateScriptedAnimationsThrottlingReason(Page&amp; page, ThrottlingReasonOperation operation, ScriptedAnimationController::ThrottlingReason reason)
  {
<span class="line-modified">!     for (Frame* frame = &amp;page.mainFrame(); frame; frame = frame-&gt;tree().traverseNext()) {</span>
<span class="line-modified">!         auto* document = frame-&gt;document();</span>
<span class="line-modified">!         if (!document)</span>
<span class="line-modified">!             continue;</span>
<span class="line-modified">!         auto* scriptedAnimationController = document-&gt;scriptedAnimationController();</span>
<span class="line-modified">!         if (!scriptedAnimationController)</span>
<span class="line-modified">!             continue;</span>
<span class="line-modified">! </span>
<span class="line-removed">-         if (operation == ThrottlingReasonOperation::Add)</span>
<span class="line-removed">-             scriptedAnimationController-&gt;addThrottlingReason(reason);</span>
<span class="line-removed">-         else</span>
<span class="line-removed">-             scriptedAnimationController-&gt;removeThrottlingReason(reason);</span>
<span class="line-removed">-     }</span>
  }
  
  void Page::setIsVisuallyIdleInternal(bool isVisuallyIdle)
  {
      updateScriptedAnimationsThrottlingReason(*this, isVisuallyIdle ? ThrottlingReasonOperation::Add : ThrottlingReasonOperation::Remove, ScriptedAnimationController::ThrottlingReason::VisuallyIdle);
<span class="line-new-header">--- 1312,85 ---</span>
  
      TraceScope traceScope(RenderingUpdateStart, RenderingUpdateEnd);
  
      SetForScope&lt;bool&gt; change(m_inUpdateRendering, true);
  
<span class="line-modified">!     layoutIfNeeded();</span>
<span class="line-added">+ </span>
<span class="line-added">+     // Flush autofocus candidates</span>
  
<span class="line-modified">!     forEachDocument([] (Document&amp; document) {</span>
<span class="line-modified">!         document.runResizeSteps();</span>
      });
  
<span class="line-modified">!     forEachDocument([] (Document&amp; document) {</span>
<span class="line-modified">!         document.runScrollSteps();</span>
<span class="line-modified">!     });</span>
<span class="line-modified">! </span>
<span class="line-modified">!     forEachDocument([] (Document&amp; document) {</span>
<span class="line-added">+         document.evaluateMediaQueriesAndReportChanges();</span>
<span class="line-added">+     });</span>
<span class="line-added">+ </span>
<span class="line-added">+     forEachDocument([] (Document&amp; document) {</span>
<span class="line-added">+         if (!document.domWindow())</span>
<span class="line-added">+             return;</span>
<span class="line-added">+         DOMHighResTimeStamp timestamp = document.domWindow()-&gt;nowTimestamp();</span>
<span class="line-added">+         document.updateAnimationsAndSendEvents(timestamp);</span>
<span class="line-added">+         // FIXME: Run the fullscreen steps.</span>
<span class="line-added">+         document.serviceRequestAnimationFrameCallbacks(timestamp);</span>
<span class="line-added">+     });</span>
  
      layoutIfNeeded();
  
  #if ENABLE(INTERSECTION_OBSERVER)
<span class="line-modified">!     forEachDocument([] (Document&amp; document) {</span>
<span class="line-modified">!         document.updateIntersectionObservations();</span>
<span class="line-added">+     });</span>
  #endif
<span class="line-added">+ </span>
  #if ENABLE(RESIZE_OBSERVER)
<span class="line-modified">!     forEachDocument([&amp;] (Document&amp; document) {</span>
<span class="line-modified">!         document.updateResizeObservations(*this);</span>
<span class="line-added">+     });</span>
  #endif
  
      layoutIfNeeded();
<span class="line-added">+ </span>
<span class="line-added">+     forEachDocument([] (Document&amp; document) {</span>
<span class="line-added">+         document.updateHighlightPositions();</span>
<span class="line-added">+     });</span>
  }
  
  void Page::suspendScriptedAnimations()
  {
      m_scriptedAnimationsSuspended = true;
<span class="line-modified">! </span>
<span class="line-modified">!     forEachDocument([] (Document&amp; document) {</span>
<span class="line-modified">!         document.suspendScriptedAnimationControllerCallbacks();</span>
<span class="line-modified">!     });</span>
  }
  
  void Page::resumeScriptedAnimations()
  {
      m_scriptedAnimationsSuspended = false;
<span class="line-modified">! </span>
<span class="line-modified">!     forEachDocument([] (Document&amp; document) {</span>
<span class="line-modified">!         document.resumeScriptedAnimationControllerCallbacks();</span>
<span class="line-modified">!     });</span>
  }
  
  enum class ThrottlingReasonOperation { Add, Remove };
  static void updateScriptedAnimationsThrottlingReason(Page&amp; page, ThrottlingReasonOperation operation, ScriptedAnimationController::ThrottlingReason reason)
  {
<span class="line-modified">!     page.forEachDocument([&amp;] (Document&amp; document) {</span>
<span class="line-modified">!         if (auto* controller = document.scriptedAnimationController()) {</span>
<span class="line-modified">!             if (operation == ThrottlingReasonOperation::Add)</span>
<span class="line-modified">!                 controller-&gt;addThrottlingReason(reason);</span>
<span class="line-modified">!             else</span>
<span class="line-modified">!                 controller-&gt;removeThrottlingReason(reason);</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!     });</span>
  }
  
  void Page::setIsVisuallyIdleInternal(bool isVisuallyIdle)
  {
      updateScriptedAnimationsThrottlingReason(*this, isVisuallyIdle ? ThrottlingReasonOperation::Add : ThrottlingReasonOperation::Remove, ScriptedAnimationController::ThrottlingReason::VisuallyIdle);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1363,11 ***</span>
  
  void Page::handleLowModePowerChange(bool isLowPowerModeEnabled)
  {
      updateScriptedAnimationsThrottlingReason(*this, isLowPowerModeEnabled ? ThrottlingReasonOperation::Add : ThrottlingReasonOperation::Remove, ScriptedAnimationController::ThrottlingReason::LowPowerMode);
      if (RuntimeEnabledFeatures::sharedFeatures().webAnimationsCSSIntegrationEnabled()) {
<span class="line-modified">!         forEachDocument([&amp;] (Document&amp; document) {</span>
              if (auto timeline = document.existingTimeline())
                  timeline-&gt;updateThrottlingState();
          });
      } else
          mainFrame().animation().updateThrottlingState();
<span class="line-new-header">--- 1398,11 ---</span>
  
  void Page::handleLowModePowerChange(bool isLowPowerModeEnabled)
  {
      updateScriptedAnimationsThrottlingReason(*this, isLowPowerModeEnabled ? ThrottlingReasonOperation::Add : ThrottlingReasonOperation::Remove, ScriptedAnimationController::ThrottlingReason::LowPowerMode);
      if (RuntimeEnabledFeatures::sharedFeatures().webAnimationsCSSIntegrationEnabled()) {
<span class="line-modified">!         forEachDocument([] (Document&amp; document) {</span>
              if (auto timeline = document.existingTimeline())
                  timeline-&gt;updateThrottlingState();
          });
      } else
          mainFrame().animation().updateThrottlingState();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1379,11 ***</span>
      // FIXME: Eventually we will move to a model of just being handed the sheet
      // text instead of loading the URL ourselves.
      URL url = m_settings-&gt;userStyleSheetLocation();
  
      // Allow any local file URL scheme to be loaded.
<span class="line-modified">!     if (SchemeRegistry::shouldTreatURLSchemeAsLocal(url.protocol().toStringWithoutCopying()))</span>
          m_userStyleSheetPath = url.fileSystemPath();
      else
          m_userStyleSheetPath = String();
  
      m_didLoadUserStyleSheet = false;
<span class="line-new-header">--- 1414,11 ---</span>
      // FIXME: Eventually we will move to a model of just being handed the sheet
      // text instead of loading the URL ourselves.
      URL url = m_settings-&gt;userStyleSheetLocation();
  
      // Allow any local file URL scheme to be loaded.
<span class="line-modified">!     if (LegacySchemeRegistry::shouldTreatURLSchemeAsLocal(url.protocol().toStringWithoutCopying()))</span>
          m_userStyleSheetPath = url.fileSystemPath();
      else
          m_userStyleSheetPath = String();
  
      m_didLoadUserStyleSheet = false;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1398,14 ***</span>
          Vector&lt;char&gt; styleSheetAsUTF8;
          if (base64Decode(decodeURLEscapeSequences(url.string().substring(35)), styleSheetAsUTF8, Base64IgnoreSpacesAndNewLines))
              m_userStyleSheet = String::fromUTF8(styleSheetAsUTF8.data(), styleSheetAsUTF8.size());
      }
  
<span class="line-modified">!     for (Frame* frame = &amp;mainFrame(); frame; frame = frame-&gt;tree().traverseNext()) {</span>
<span class="line-modified">!         if (frame-&gt;document())</span>
<span class="line-modified">!             frame-&gt;document()-&gt;extensionStyleSheets().updatePageUserSheet();</span>
<span class="line-removed">-     }</span>
  }
  
  const String&amp; Page::userStyleSheet() const
  {
      if (m_userStyleSheetPath.isEmpty())
<span class="line-new-header">--- 1433,13 ---</span>
          Vector&lt;char&gt; styleSheetAsUTF8;
          if (base64Decode(decodeURLEscapeSequences(url.string().substring(35)), styleSheetAsUTF8, Base64IgnoreSpacesAndNewLines))
              m_userStyleSheet = String::fromUTF8(styleSheetAsUTF8.data(), styleSheetAsUTF8.size());
      }
  
<span class="line-modified">!     forEachDocument([] (Document&amp; document) {</span>
<span class="line-modified">!         document.extensionStyleSheets().updatePageUserSheet();</span>
<span class="line-modified">!     });</span>
  }
  
  const String&amp; Page::userStyleSheet() const
  {
      if (m_userStyleSheetPath.isEmpty())
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1456,34 ***</span>
      }
  }
  
  void Page::invalidateStylesForAllLinks()
  {
<span class="line-modified">!     for (Frame* frame = &amp;m_mainFrame.get(); frame; frame = frame-&gt;tree().traverseNext()) {</span>
<span class="line-modified">!         if (!frame-&gt;document())</span>
<span class="line-modified">!             continue;</span>
<span class="line-removed">-         frame-&gt;document()-&gt;visitedLinkState().invalidateStyleForAllLinks();</span>
<span class="line-removed">-     }</span>
  }
  
  void Page::invalidateStylesForLink(SharedStringHash linkHash)
  {
<span class="line-modified">!     for (Frame* frame = &amp;m_mainFrame.get(); frame; frame = frame-&gt;tree().traverseNext()) {</span>
<span class="line-modified">!         if (!frame-&gt;document())</span>
<span class="line-modified">!             continue;</span>
<span class="line-removed">-         frame-&gt;document()-&gt;visitedLinkState().invalidateStyleForLink(linkHash);</span>
<span class="line-removed">-     }</span>
  }
  
  void Page::invalidateInjectedStyleSheetCacheInAllFrames()
  {
<span class="line-modified">!     for (Frame* frame = &amp;m_mainFrame.get(); frame; frame = frame-&gt;tree().traverseNext()) {</span>
<span class="line-modified">!         Document* document = frame-&gt;document();</span>
<span class="line-modified">!         if (!document)</span>
<span class="line-removed">-             continue;</span>
<span class="line-removed">-         document-&gt;extensionStyleSheets().invalidateInjectedStyleSheetCache();</span>
<span class="line-removed">-     }</span>
  }
  
  void Page::setDebugger(JSC::Debugger* debugger)
  {
      if (m_debugger == debugger)
<span class="line-new-header">--- 1490,27 ---</span>
      }
  }
  
  void Page::invalidateStylesForAllLinks()
  {
<span class="line-modified">!     forEachDocument([] (Document&amp; document) {</span>
<span class="line-modified">!         document.visitedLinkState().invalidateStyleForAllLinks();</span>
<span class="line-modified">!     });</span>
  }
  
  void Page::invalidateStylesForLink(SharedStringHash linkHash)
  {
<span class="line-modified">!     forEachDocument([&amp;] (Document&amp; document) {</span>
<span class="line-modified">!         document.visitedLinkState().invalidateStyleForLink(linkHash);</span>
<span class="line-modified">!     });</span>
  }
  
  void Page::invalidateInjectedStyleSheetCacheInAllFrames()
  {
<span class="line-modified">!     forEachDocument([] (Document&amp; document) {</span>
<span class="line-modified">!         document.extensionStyleSheets().invalidateInjectedStyleSheetCache();</span>
<span class="line-modified">!     });</span>
  }
  
  void Page::setDebugger(JSC::Debugger* debugger)
  {
      if (m_debugger == debugger)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1569,14 ***</span>
  
      updateDOMTimerAlignmentInterval();
  
      // When throttling is disabled, release all throttled timers.
      if (state == TimerThrottlingState::Disabled) {
<span class="line-modified">!         for (Frame* frame = &amp;mainFrame(); frame; frame = frame-&gt;tree().traverseNext()) {</span>
<span class="line-modified">!             if (auto* document = frame-&gt;document())</span>
<span class="line-modified">!                 document-&gt;didChangeTimerAlignmentInterval();</span>
<span class="line-removed">-         }</span>
      }
  }
  
  void Page::setDOMTimerAlignmentIntervalIncreaseLimit(Seconds limit)
  {
<span class="line-new-header">--- 1596,13 ---</span>
  
      updateDOMTimerAlignmentInterval();
  
      // When throttling is disabled, release all throttled timers.
      if (state == TimerThrottlingState::Disabled) {
<span class="line-modified">!         forEachDocument([] (Document&amp; document) {</span>
<span class="line-modified">!             document.didChangeTimerAlignmentInterval();</span>
<span class="line-modified">!         });</span>
      }
  }
  
  void Page::setDOMTimerAlignmentIntervalIncreaseLimit(Seconds limit)
  {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1638,15 ***</span>
      updateDOMTimerAlignmentInterval();
  }
  
  void Page::dnsPrefetchingStateChanged()
  {
<span class="line-modified">!     for (Frame* frame = &amp;mainFrame(); frame; frame = frame-&gt;tree().traverseNext()) {</span>
<span class="line-modified">!         if (!frame-&gt;document())</span>
<span class="line-modified">!             continue;</span>
<span class="line-removed">-         frame-&gt;document()-&gt;initDNSPrefetch();</span>
<span class="line-removed">-     }</span>
  }
  
  Vector&lt;Ref&lt;PluginViewBase&gt;&gt; Page::pluginViews()
  {
      Vector&lt;Ref&lt;PluginViewBase&gt;&gt; views;
<span class="line-new-header">--- 1664,13 ---</span>
      updateDOMTimerAlignmentInterval();
  }
  
  void Page::dnsPrefetchingStateChanged()
  {
<span class="line-modified">!     forEachDocument([] (Document&amp; document) {</span>
<span class="line-modified">!         document.initDNSPrefetch();</span>
<span class="line-modified">!     });</span>
  }
  
  Vector&lt;Ref&lt;PluginViewBase&gt;&gt; Page::pluginViews()
  {
      Vector&lt;Ref&lt;PluginViewBase&gt;&gt; views;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1662,37 ***</span>
      return views;
  }
  
  void Page::storageBlockingStateChanged()
  {
<span class="line-modified">!     for (Frame* frame = &amp;mainFrame(); frame; frame = frame-&gt;tree().traverseNext()) {</span>
<span class="line-modified">!         if (!frame-&gt;document())</span>
<span class="line-modified">!             continue;</span>
<span class="line-removed">-         frame-&gt;document()-&gt;storageBlockingStateDidChange();</span>
<span class="line-removed">-     }</span>
  
      // Collect the PluginViews in to a vector to ensure that action the plug-in takes
      // from below storageBlockingStateChanged does not affect their lifetime.
      for (auto&amp; view : pluginViews())
          view-&gt;storageBlockingStateChanged();
  }
  
<span class="line-removed">- void Page::enableLegacyPrivateBrowsing(bool privateBrowsingEnabled)</span>
<span class="line-removed">- {</span>
<span class="line-removed">-     // Don&#39;t allow changing the legacy private browsing state if we have set a session ID.</span>
<span class="line-removed">-     ASSERT(m_sessionID == PAL::SessionID::defaultSessionID() || m_sessionID == PAL::SessionID::legacyPrivateSessionID());</span>
<span class="line-removed">- </span>
<span class="line-removed">-     setSessionID(privateBrowsingEnabled ? PAL::SessionID::legacyPrivateSessionID() : PAL::SessionID::defaultSessionID());</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
  void Page::updateIsPlayingMedia(uint64_t sourceElementID)
  {
      MediaProducer::MediaStateFlags state = MediaProducer::IsNotPlaying;
<span class="line-modified">!     for (Frame* frame = &amp;mainFrame(); frame; frame = frame-&gt;tree().traverseNext()) {</span>
<span class="line-modified">!         if (Document* document = frame-&gt;document())</span>
<span class="line-modified">!             state |= document-&gt;mediaState();</span>
<span class="line-removed">-     }</span>
  
      if (state == m_mediaState)
          return;
  
      m_mediaState = state;
<span class="line-new-header">--- 1686,26 ---</span>
      return views;
  }
  
  void Page::storageBlockingStateChanged()
  {
<span class="line-modified">!     forEachDocument([] (Document&amp; document) {</span>
<span class="line-modified">!         document.storageBlockingStateDidChange();</span>
<span class="line-modified">!     });</span>
  
      // Collect the PluginViews in to a vector to ensure that action the plug-in takes
      // from below storageBlockingStateChanged does not affect their lifetime.
      for (auto&amp; view : pluginViews())
          view-&gt;storageBlockingStateChanged();
  }
  
  void Page::updateIsPlayingMedia(uint64_t sourceElementID)
  {
      MediaProducer::MediaStateFlags state = MediaProducer::IsNotPlaying;
<span class="line-modified">!     forEachDocument([&amp;] (Document&amp; document) {</span>
<span class="line-modified">!         state |= document.mediaState();</span>
<span class="line-modified">!     });</span>
  
      if (state == m_mediaState)
          return;
  
      m_mediaState = state;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1707,66 ***</span>
          m_playbackControlsManagerUpdateTimer.startOneShot(0_s);
  #endif
  }
  
  #if ENABLE(VIDEO)
  void Page::playbackControlsManagerUpdateTimerFired()
  {
      if (auto bestMediaElement = HTMLMediaElement::bestMediaElementForShowingPlaybackControlsManager(MediaElementSession::PlaybackControlsPurpose::ControlsManager))
          chrome().client().setUpPlaybackControlsManager(*bestMediaElement);
      else
          chrome().client().clearPlaybackControlsManager();
  }
  #endif
  
  void Page::setMuted(MediaProducer::MutedStateFlags muted)
  {
      if (m_mutedState == muted)
          return;
  
      m_mutedState = muted;
  
<span class="line-modified">!     for (Frame* frame = &amp;mainFrame(); frame; frame = frame-&gt;tree().traverseNext()) {</span>
<span class="line-modified">!         if (!frame-&gt;document())</span>
<span class="line-modified">!             continue;</span>
<span class="line-removed">-         frame-&gt;document()-&gt;pageMutedStateDidChange();</span>
<span class="line-removed">-     }</span>
  }
  
  void Page::stopMediaCapture()
  {
  #if ENABLE(MEDIA_STREAM)
<span class="line-modified">!     for (Frame* frame = &amp;mainFrame(); frame; frame = frame-&gt;tree().traverseNext()) {</span>
<span class="line-modified">!         if (!frame-&gt;document())</span>
<span class="line-modified">!             continue;</span>
<span class="line-removed">- </span>
<span class="line-removed">-         frame-&gt;document()-&gt;stopMediaCapture();</span>
<span class="line-removed">-     }</span>
  #endif
  }
  
  void Page::stopAllMediaPlayback()
  {
  #if ENABLE(VIDEO)
<span class="line-modified">!     for (Frame* frame = &amp;mainFrame(); frame; frame = frame-&gt;tree().traverseNext()) {</span>
<span class="line-modified">!         if (auto* document = frame-&gt;document())</span>
<span class="line-modified">!             document-&gt;stopAllMediaPlayback();</span>
<span class="line-removed">-     }</span>
  #endif
  }
  
  void Page::suspendAllMediaPlayback()
  {
  #if ENABLE(VIDEO)
      ASSERT(!m_mediaPlaybackIsSuspended);
      if (m_mediaPlaybackIsSuspended)
          return;
  
<span class="line-modified">!     for (Frame* frame = &amp;mainFrame(); frame; frame = frame-&gt;tree().traverseNext()) {</span>
<span class="line-modified">!         if (auto* document = frame-&gt;document())</span>
<span class="line-modified">!             document-&gt;suspendAllMediaPlayback();</span>
<span class="line-removed">-     }</span>
  
      m_mediaPlaybackIsSuspended = true;
  #endif
  }
  
<span class="line-new-header">--- 1720,61 ---</span>
          m_playbackControlsManagerUpdateTimer.startOneShot(0_s);
  #endif
  }
  
  #if ENABLE(VIDEO)
<span class="line-added">+ </span>
  void Page::playbackControlsManagerUpdateTimerFired()
  {
      if (auto bestMediaElement = HTMLMediaElement::bestMediaElementForShowingPlaybackControlsManager(MediaElementSession::PlaybackControlsPurpose::ControlsManager))
          chrome().client().setUpPlaybackControlsManager(*bestMediaElement);
      else
          chrome().client().clearPlaybackControlsManager();
  }
<span class="line-added">+ </span>
  #endif
  
  void Page::setMuted(MediaProducer::MutedStateFlags muted)
  {
      if (m_mutedState == muted)
          return;
  
      m_mutedState = muted;
  
<span class="line-modified">!     forEachDocument([] (Document&amp; document) {</span>
<span class="line-modified">!         document.pageMutedStateDidChange();</span>
<span class="line-modified">!     });</span>
  }
  
  void Page::stopMediaCapture()
  {
  #if ENABLE(MEDIA_STREAM)
<span class="line-modified">!     forEachDocument([] (Document&amp; document) {</span>
<span class="line-modified">!         document.stopMediaCapture();</span>
<span class="line-modified">!     });</span>
  #endif
  }
  
  void Page::stopAllMediaPlayback()
  {
  #if ENABLE(VIDEO)
<span class="line-modified">!     forEachDocument([] (Document&amp; document) {</span>
<span class="line-modified">!         document.stopAllMediaPlayback();</span>
<span class="line-modified">!     });</span>
  #endif
  }
  
  void Page::suspendAllMediaPlayback()
  {
  #if ENABLE(VIDEO)
      ASSERT(!m_mediaPlaybackIsSuspended);
      if (m_mediaPlaybackIsSuspended)
          return;
  
<span class="line-modified">!     forEachDocument([] (Document&amp; document) {</span>
<span class="line-modified">!         document.suspendAllMediaPlayback();</span>
<span class="line-modified">!     });</span>
  
      m_mediaPlaybackIsSuspended = true;
  #endif
  }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1776,14 ***</span>
      ASSERT(m_mediaPlaybackIsSuspended);
      if (!m_mediaPlaybackIsSuspended)
          return;
      m_mediaPlaybackIsSuspended = false;
  
<span class="line-modified">!     for (Frame* frame = &amp;mainFrame(); frame; frame = frame-&gt;tree().traverseNext()) {</span>
<span class="line-modified">!         if (auto* document = frame-&gt;document())</span>
<span class="line-modified">!             document-&gt;resumeAllMediaPlayback();</span>
<span class="line-removed">-     }</span>
  #endif
  }
  
  void Page::suspendAllMediaBuffering()
  {
<span class="line-new-header">--- 1784,13 ---</span>
      ASSERT(m_mediaPlaybackIsSuspended);
      if (!m_mediaPlaybackIsSuspended)
          return;
      m_mediaPlaybackIsSuspended = false;
  
<span class="line-modified">!     forEachDocument([] (Document&amp; document) {</span>
<span class="line-modified">!         document.resumeAllMediaPlayback();</span>
<span class="line-modified">!     });</span>
  #endif
  }
  
  void Page::suspendAllMediaBuffering()
  {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1791,32 ***</span>
      ASSERT(!m_mediaBufferingIsSuspended);
      if (m_mediaBufferingIsSuspended)
          return;
      m_mediaBufferingIsSuspended = true;
  
<span class="line-modified">!     for (Frame* frame = &amp;mainFrame(); frame; frame = frame-&gt;tree().traverseNext()) {</span>
<span class="line-modified">!         if (auto* document = frame-&gt;document())</span>
<span class="line-modified">!             document-&gt;suspendAllMediaBuffering();</span>
<span class="line-removed">-     }</span>
  #endif
  }
  
  void Page::resumeAllMediaBuffering()
  {
  #if ENABLE(VIDEO)
      if (!m_mediaBufferingIsSuspended)
          return;
      m_mediaBufferingIsSuspended = false;
  
<span class="line-modified">!     for (Frame* frame = &amp;mainFrame(); frame; frame = frame-&gt;tree().traverseNext()) {</span>
<span class="line-modified">!         if (auto* document = frame-&gt;document())</span>
<span class="line-modified">!             document-&gt;resumeAllMediaBuffering();</span>
<span class="line-removed">-     }</span>
  #endif
  }
  
  #if ENABLE(MEDIA_SESSION)
  void Page::handleMediaEvent(MediaEventType eventType)
  {
      switch (eventType) {
      case MediaEventType::PlayPause:
          MediaSessionManager::singleton().togglePlayback();
<span class="line-new-header">--- 1798,31 ---</span>
      ASSERT(!m_mediaBufferingIsSuspended);
      if (m_mediaBufferingIsSuspended)
          return;
      m_mediaBufferingIsSuspended = true;
  
<span class="line-modified">!     forEachDocument([] (Document&amp; document) {</span>
<span class="line-modified">!         document.suspendAllMediaBuffering();</span>
<span class="line-modified">!     });</span>
  #endif
  }
  
  void Page::resumeAllMediaBuffering()
  {
  #if ENABLE(VIDEO)
      if (!m_mediaBufferingIsSuspended)
          return;
      m_mediaBufferingIsSuspended = false;
  
<span class="line-modified">!     forEachDocument([] (Document&amp; document) {</span>
<span class="line-modified">!         document.resumeAllMediaBuffering();</span>
<span class="line-modified">!     });</span>
  #endif
  }
  
  #if ENABLE(MEDIA_SESSION)
<span class="line-added">+ </span>
  void Page::handleMediaEvent(MediaEventType eventType)
  {
      switch (eventType) {
      case MediaEventType::PlayPause:
          MediaSessionManager::singleton().togglePlayback();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1833,24 ***</span>
  void Page::setVolumeOfMediaElement(double volume, uint64_t elementID)
  {
      if (HTMLMediaElement* element = HTMLMediaElement::elementWithID(elementID))
          element-&gt;setVolume(volume, ASSERT_NO_EXCEPTION);
  }
  #endif
  
<span class="line-modified">! #if !ASSERT_DISABLED</span>
  void Page::checkSubframeCountConsistency() const
  {
      ASSERT(m_subframeCount &gt;= 0);
  
      int subframeCount = 0;
      for (const Frame* frame = &amp;mainFrame(); frame; frame = frame-&gt;tree().traverseNext())
          ++subframeCount;
  
      ASSERT(m_subframeCount + 1 == subframeCount);
  }
<span class="line-modified">! #endif</span>
  
  void Page::resumeAnimatingImages()
  {
      // Drawing models which cache painted content while out-of-window (WebKit2&#39;s composited drawing areas, etc.)
      // require that we repaint animated images to kickstart the animation loop.
<span class="line-new-header">--- 1839,27 ---</span>
  void Page::setVolumeOfMediaElement(double volume, uint64_t elementID)
  {
      if (HTMLMediaElement* element = HTMLMediaElement::elementWithID(elementID))
          element-&gt;setVolume(volume, ASSERT_NO_EXCEPTION);
  }
<span class="line-added">+ </span>
  #endif
  
<span class="line-modified">! #if ASSERT_ENABLED</span>
<span class="line-added">+ </span>
  void Page::checkSubframeCountConsistency() const
  {
      ASSERT(m_subframeCount &gt;= 0);
  
      int subframeCount = 0;
      for (const Frame* frame = &amp;mainFrame(); frame; frame = frame-&gt;tree().traverseNext())
          ++subframeCount;
  
      ASSERT(m_subframeCount + 1 == subframeCount);
  }
<span class="line-modified">! </span>
<span class="line-added">+ #endif // ASSERT_ENABLED</span>
  
  void Page::resumeAnimatingImages()
  {
      // Drawing models which cache painted content while out-of-window (WebKit2&#39;s composited drawing areas, etc.)
      // require that we repaint animated images to kickstart the animation loop.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1917,55 ***</span>
          state.remove({ ActivityState::IsVisible, ActivityState::IsVisibleOrOccluded });
      }
      setActivityState(state);
  }
  
<span class="line-removed">- enum class SVGAnimationsState { Paused, Resumed };</span>
<span class="line-removed">- static inline void setSVGAnimationsState(Page&amp; page, SVGAnimationsState state)</span>
<span class="line-removed">- {</span>
<span class="line-removed">-     for (Frame* frame = &amp;page.mainFrame(); frame; frame = frame-&gt;tree().traverseNext()) {</span>
<span class="line-removed">-         auto* document = frame-&gt;document();</span>
<span class="line-removed">-         if (!document)</span>
<span class="line-removed">-             continue;</span>
<span class="line-removed">- </span>
<span class="line-removed">-         if (!document-&gt;svgExtensions())</span>
<span class="line-removed">-             continue;</span>
<span class="line-removed">- </span>
<span class="line-removed">-         if (state == SVGAnimationsState::Paused)</span>
<span class="line-removed">-             document-&gt;accessSVGExtensions().pauseAnimations();</span>
<span class="line-removed">-         else</span>
<span class="line-removed">-             document-&gt;accessSVGExtensions().unpauseAnimations();</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
  void Page::setIsVisibleInternal(bool isVisible)
  {
      // FIXME: The visibility state should be stored on the top-level document.
      // https://bugs.webkit.org/show_bug.cgi?id=116769
  
      if (isVisible) {
          m_isPrerender = false;
  
          resumeScriptedAnimations();
  #if PLATFORM(IOS_FAMILY)
<span class="line-modified">!         resumeDeviceMotionAndOrientationUpdates();</span>
  #endif
  
          if (FrameView* view = mainFrame().view())
              view-&gt;show();
  
          if (m_settings-&gt;hiddenPageCSSAnimationSuspensionEnabled()) {
              if (RuntimeEnabledFeatures::sharedFeatures().webAnimationsCSSIntegrationEnabled()) {
<span class="line-modified">!                 forEachDocument([&amp;] (Document&amp; document) {</span>
                      if (auto* timeline = document.existingTimeline())
                          timeline-&gt;resumeAnimations();
                  });
              } else
                  mainFrame().animation().resumeAnimations();
          }
  
<span class="line-modified">!         setSVGAnimationsState(*this, SVGAnimationsState::Resumed);</span>
  
          resumeAnimatingImages();
  
          if (m_navigationToLogWhenVisible) {
              logNavigation(m_navigationToLogWhenVisible.value());
<span class="line-new-header">--- 1926,43 ---</span>
          state.remove({ ActivityState::IsVisible, ActivityState::IsVisibleOrOccluded });
      }
      setActivityState(state);
  }
  
  void Page::setIsVisibleInternal(bool isVisible)
  {
      // FIXME: The visibility state should be stored on the top-level document.
      // https://bugs.webkit.org/show_bug.cgi?id=116769
  
      if (isVisible) {
          m_isPrerender = false;
  
          resumeScriptedAnimations();
<span class="line-added">+ </span>
  #if PLATFORM(IOS_FAMILY)
<span class="line-modified">!         forEachDocument([] (Document&amp; document) {</span>
<span class="line-added">+             document.resumeDeviceMotionAndOrientationUpdates();</span>
<span class="line-added">+         });</span>
  #endif
  
          if (FrameView* view = mainFrame().view())
              view-&gt;show();
  
          if (m_settings-&gt;hiddenPageCSSAnimationSuspensionEnabled()) {
              if (RuntimeEnabledFeatures::sharedFeatures().webAnimationsCSSIntegrationEnabled()) {
<span class="line-modified">!                 forEachDocument([] (Document&amp; document) {</span>
                      if (auto* timeline = document.existingTimeline())
                          timeline-&gt;resumeAnimations();
                  });
              } else
                  mainFrame().animation().resumeAnimations();
          }
  
<span class="line-modified">!         forEachDocument([] (Document&amp; document) {</span>
<span class="line-added">+             if (document.svgExtensions())</span>
<span class="line-added">+                 document.accessSVGExtensions().unpauseAnimations();</span>
<span class="line-added">+         });</span>
  
          resumeAnimatingImages();
  
          if (m_navigationToLogWhenVisible) {
              logNavigation(m_navigationToLogWhenVisible.value());
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1974,36 ***</span>
      }
  
      if (!isVisible) {
          if (m_settings-&gt;hiddenPageCSSAnimationSuspensionEnabled()) {
              if (RuntimeEnabledFeatures::sharedFeatures().webAnimationsCSSIntegrationEnabled()) {
<span class="line-modified">!                 forEachDocument([&amp;] (Document&amp; document) {</span>
                      if (auto* timeline = document.existingTimeline())
                          timeline-&gt;suspendAnimations();
                  });
              } else
                  mainFrame().animation().suspendAnimations();
          }
  
<span class="line-modified">!         setSVGAnimationsState(*this, SVGAnimationsState::Paused);</span>
  
  #if PLATFORM(IOS_FAMILY)
<span class="line-modified">!         suspendDeviceMotionAndOrientationUpdates();</span>
  #endif
  
          suspendScriptedAnimations();
  
          if (FrameView* view = mainFrame().view())
              view-&gt;hide();
      }
  
<span class="line-modified">!     Vector&lt;Ref&lt;Document&gt;&gt; documents;</span>
<span class="line-modified">!     for (Frame* frame = &amp;m_mainFrame.get(); frame; frame = frame-&gt;tree().traverseNext())</span>
<span class="line-modified">!         documents.append(*frame-&gt;document());</span>
<span class="line-removed">- </span>
<span class="line-removed">-     for (auto&amp; document : documents)</span>
<span class="line-removed">-         document-&gt;visibilityStateChanged();</span>
  }
  
  void Page::setIsPrerender()
  {
      m_isPrerender = true;
<span class="line-new-header">--- 1971,38 ---</span>
      }
  
      if (!isVisible) {
          if (m_settings-&gt;hiddenPageCSSAnimationSuspensionEnabled()) {
              if (RuntimeEnabledFeatures::sharedFeatures().webAnimationsCSSIntegrationEnabled()) {
<span class="line-modified">!                 forEachDocument([] (Document&amp; document) {</span>
                      if (auto* timeline = document.existingTimeline())
                          timeline-&gt;suspendAnimations();
                  });
              } else
                  mainFrame().animation().suspendAnimations();
          }
  
<span class="line-modified">!         forEachDocument([] (Document&amp; document) {</span>
<span class="line-added">+             if (document.svgExtensions())</span>
<span class="line-added">+                 document.accessSVGExtensions().pauseAnimations();</span>
<span class="line-added">+         });</span>
  
  #if PLATFORM(IOS_FAMILY)
<span class="line-modified">!         forEachDocument([] (Document&amp; document) {</span>
<span class="line-added">+             document.suspendDeviceMotionAndOrientationUpdates();</span>
<span class="line-added">+         });</span>
  #endif
  
          suspendScriptedAnimations();
  
          if (FrameView* view = mainFrame().view())
              view-&gt;hide();
      }
  
<span class="line-modified">!     forEachDocument([] (Document&amp; document) {</span>
<span class="line-modified">!         document.visibilityStateChanged();</span>
<span class="line-modified">!     });</span>
  }
  
  void Page::setIsPrerender()
  {
      m_isPrerender = true;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2090,10 ***</span>
<span class="line-new-header">--- 2089,11 ---</span>
  
      m_unnestCallback = WTFMove(callback);
  }
  
  #if ENABLE(REMOTE_INSPECTOR)
<span class="line-added">+ </span>
  bool Page::remoteInspectionAllowed() const
  {
      return m_inspectorDebuggable-&gt;remoteDebuggingAllowed();
  }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2114,10 ***</span>
<span class="line-new-header">--- 2114,11 ---</span>
  
  void Page::remoteInspectorInformationDidChange() const
  {
      m_inspectorDebuggable-&gt;update();
  }
<span class="line-added">+ </span>
  #endif
  
  void Page::addLayoutMilestones(OptionSet&lt;LayoutMilestone&gt; milestones)
  {
      // In the future, we may want a function that replaces m_layoutMilestones instead of just adding to it.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2263,26 ***</span>
  
      m_relevantUnpaintedRenderObjects.add(object);
      m_relevantUnpaintedRegion.unite(snappedIntRect(objectPaintRect));
  }
  
<span class="line-removed">- void Page::suspendDeviceMotionAndOrientationUpdates()</span>
<span class="line-removed">- {</span>
<span class="line-removed">-     for (Frame* frame = &amp;mainFrame(); frame; frame = frame-&gt;tree().traverseNext()) {</span>
<span class="line-removed">-         if (Document* document = frame-&gt;document())</span>
<span class="line-removed">-             document-&gt;suspendDeviceMotionAndOrientationUpdates();</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
<span class="line-removed">- void Page::resumeDeviceMotionAndOrientationUpdates()</span>
<span class="line-removed">- {</span>
<span class="line-removed">-     for (Frame* frame = &amp;mainFrame(); frame; frame = frame-&gt;tree().traverseNext()) {</span>
<span class="line-removed">-         if (Document* document = frame-&gt;document())</span>
<span class="line-removed">-             document-&gt;resumeDeviceMotionAndOrientationUpdates();</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
  void Page::suspendActiveDOMObjectsAndAnimations()
  {
      for (Frame* frame = &amp;mainFrame(); frame; frame = frame-&gt;tree().traverseNext())
          frame-&gt;suspendActiveDOMObjectsAndAnimations();
  }
<span class="line-new-header">--- 2264,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2355,18 ***</span>
          }
      }
  }
  
  #if ENABLE(VIDEO_TRACK)
  void Page::captionPreferencesChanged()
  {
<span class="line-modified">!     for (Frame* frame = &amp;mainFrame(); frame; frame = frame-&gt;tree().traverseNext()) {</span>
<span class="line-modified">!         if (!frame-&gt;document())</span>
<span class="line-modified">!             continue;</span>
<span class="line-removed">-         frame-&gt;document()-&gt;captionPreferencesChanged();</span>
<span class="line-removed">-     }</span>
  }
  #endif
  
  void Page::forbidPrompts()
  {
      ++m_forbidPromptsDepth;
<span class="line-new-header">--- 2340,18 ---</span>
          }
      }
  }
  
  #if ENABLE(VIDEO_TRACK)
<span class="line-added">+ </span>
  void Page::captionPreferencesChanged()
  {
<span class="line-modified">!     forEachDocument([] (Document&amp; document) {</span>
<span class="line-modified">!         document.captionPreferencesChanged();</span>
<span class="line-modified">!     });</span>
  }
<span class="line-added">+ </span>
  #endif
  
  void Page::forbidPrompts()
  {
      ++m_forbidPromptsDepth;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2381,10 ***</span>
<span class="line-new-header">--- 2366,26 ---</span>
  bool Page::arePromptsAllowed()
  {
      return !m_forbidPromptsDepth;
  }
  
<span class="line-added">+ void Page::forbidSynchronousLoads()</span>
<span class="line-added">+ {</span>
<span class="line-added">+     ++m_forbidSynchronousLoadsDepth;</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ void Page::allowSynchronousLoads()</span>
<span class="line-added">+ {</span>
<span class="line-added">+     ASSERT(m_forbidSynchronousLoadsDepth);</span>
<span class="line-added">+     --m_forbidSynchronousLoadsDepth;</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ bool Page::areSynchronousLoadsAllowed()</span>
<span class="line-added">+ {</span>
<span class="line-added">+     return !m_forbidSynchronousLoadsDepth;</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
  void Page::logNavigation(const Navigation&amp; navigation)
  {
      String navigationDescription;
      switch (navigation.type) {
      case FrameLoadType::Standard:
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2472,13 ***</span>
<span class="line-new-header">--- 2473,16 ---</span>
  PAL::SessionID Page::sessionID() const
  {
      return m_sessionID;
  }
  
<span class="line-added">+ // This is only called by WebKitLegacy.</span>
  void Page::setSessionID(PAL::SessionID sessionID)
  {
      ASSERT(sessionID.isValid());
<span class="line-added">+     ASSERT(m_sessionID == PAL::SessionID::legacyPrivateSessionID() || m_sessionID == PAL::SessionID::defaultSessionID());</span>
<span class="line-added">+     ASSERT(sessionID == PAL::SessionID::legacyPrivateSessionID() || sessionID == PAL::SessionID::defaultSessionID());</span>
  
  #if ENABLE(INDEXED_DATABASE)
      if (sessionID != m_sessionID)
          m_idbConnectionToServer = nullptr;
  #endif
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2491,15 ***</span>
      m_sessionID = sessionID;
  
      if (!privateBrowsingStateChanged)
          return;
  
<span class="line-modified">!     for (Frame* frame = &amp;mainFrame(); frame; frame = frame-&gt;tree().traverseNext()) {</span>
<span class="line-modified">!         if (!frame-&gt;document())</span>
<span class="line-modified">!             continue;</span>
<span class="line-removed">-         frame-&gt;document()-&gt;privateBrowsingStateDidChange(m_sessionID);</span>
<span class="line-removed">-     }</span>
  
      // Collect the PluginViews in to a vector to ensure that action the plug-in takes
      // from below privateBrowsingStateChanged does not affect their lifetime.
  
      for (auto&amp; view : pluginViews())
<span class="line-new-header">--- 2495,13 ---</span>
      m_sessionID = sessionID;
  
      if (!privateBrowsingStateChanged)
          return;
  
<span class="line-modified">!     forEachDocument([&amp;] (Document&amp; document) {</span>
<span class="line-modified">!         document.privateBrowsingStateDidChange(m_sessionID);</span>
<span class="line-modified">!     });</span>
  
      // Collect the PluginViews in to a vector to ensure that action the plug-in takes
      // from below privateBrowsingStateChanged does not affect their lifetime.
  
      for (auto&amp; view : pluginViews())
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2544,66 ***</span>
  void Page::setMockMediaPlaybackTargetPickerState(const String&amp; name, MediaPlaybackTargetContext::State state)
  {
      chrome().client().setMockMediaPlaybackTargetPickerState(name, state);
  }
  
  void Page::setPlaybackTarget(uint64_t contextId, Ref&lt;MediaPlaybackTarget&gt;&amp;&amp; target)
  {
<span class="line-modified">!     for (Frame* frame = &amp;mainFrame(); frame; frame = frame-&gt;tree().traverseNext()) {</span>
<span class="line-modified">!         if (!frame-&gt;document())</span>
<span class="line-modified">!             continue;</span>
<span class="line-removed">-         frame-&gt;document()-&gt;setPlaybackTarget(contextId, target.copyRef());</span>
<span class="line-removed">-     }</span>
  }
  
  void Page::playbackTargetAvailabilityDidChange(uint64_t contextId, bool available)
  {
<span class="line-modified">!     for (Frame* frame = &amp;mainFrame(); frame; frame = frame-&gt;tree().traverseNext()) {</span>
<span class="line-modified">!         if (!frame-&gt;document())</span>
<span class="line-modified">!             continue;</span>
<span class="line-removed">-         frame-&gt;document()-&gt;playbackTargetAvailabilityDidChange(contextId, available);</span>
<span class="line-removed">-     }</span>
  }
  
  void Page::setShouldPlayToPlaybackTarget(uint64_t clientId, bool shouldPlay)
  {
<span class="line-modified">!     for (Frame* frame = &amp;mainFrame(); frame; frame = frame-&gt;tree().traverseNext()) {</span>
<span class="line-modified">!         if (!frame-&gt;document())</span>
<span class="line-modified">!             continue;</span>
<span class="line-removed">-         frame-&gt;document()-&gt;setShouldPlayToPlaybackTarget(clientId, shouldPlay);</span>
<span class="line-removed">-     }</span>
  }
  #endif
  
<span class="line-modified">! WheelEventTestTrigger&amp; Page::ensureTestTrigger()</span>
  {
<span class="line-modified">!     if (!m_testTrigger) {</span>
<span class="line-modified">!         m_testTrigger = adoptRef(new WheelEventTestTrigger());</span>
          // We need to update the scrolling coordinator so that the mainframe scrolling node can expect wheel event test triggers.
          if (auto* frameView = mainFrame().view()) {
              if (m_scrollingCoordinator)
<span class="line-modified">!                 m_scrollingCoordinator-&gt;updateExpectsWheelEventTestTriggerWithFrameView(*frameView);</span>
          }
      }
  
<span class="line-modified">!     return *m_testTrigger;</span>
  }
  
  #if ENABLE(VIDEO)
  void Page::setAllowsMediaDocumentInlinePlayback(bool flag)
  {
      if (m_allowsMediaDocumentInlinePlayback == flag)
          return;
      m_allowsMediaDocumentInlinePlayback = flag;
  
<span class="line-modified">!     Vector&lt;Ref&lt;Document&gt;&gt; documents;</span>
<span class="line-modified">!     for (Frame* frame = &amp;m_mainFrame.get(); frame; frame = frame-&gt;tree().traverseNext())</span>
<span class="line-modified">!         documents.append(*frame-&gt;document());</span>
<span class="line-removed">- </span>
<span class="line-removed">-     for (auto&amp; document : documents)</span>
<span class="line-removed">-         document-&gt;allowsMediaDocumentInlinePlaybackChanged();</span>
  }
  #endif
  
  #if ENABLE(INDEXED_DATABASE)
  IDBClient::IDBConnectionToServer&amp; Page::idbConnection()
  {
<span class="line-new-header">--- 2546,72 ---</span>
  void Page::setMockMediaPlaybackTargetPickerState(const String&amp; name, MediaPlaybackTargetContext::State state)
  {
      chrome().client().setMockMediaPlaybackTargetPickerState(name, state);
  }
  
<span class="line-added">+ void Page::mockMediaPlaybackTargetPickerDismissPopup()</span>
<span class="line-added">+ {</span>
<span class="line-added">+     chrome().client().mockMediaPlaybackTargetPickerDismissPopup();</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
  void Page::setPlaybackTarget(uint64_t contextId, Ref&lt;MediaPlaybackTarget&gt;&amp;&amp; target)
  {
<span class="line-modified">!     forEachDocument([&amp;] (Document&amp; document) {</span>
<span class="line-modified">!         document.setPlaybackTarget(contextId, target.copyRef());</span>
<span class="line-modified">!     });</span>
  }
  
  void Page::playbackTargetAvailabilityDidChange(uint64_t contextId, bool available)
  {
<span class="line-modified">!     forEachDocument([&amp;] (Document&amp; document) {</span>
<span class="line-modified">!         document.playbackTargetAvailabilityDidChange(contextId, available);</span>
<span class="line-modified">!     });</span>
  }
  
  void Page::setShouldPlayToPlaybackTarget(uint64_t clientId, bool shouldPlay)
  {
<span class="line-modified">!     forEachDocument([&amp;] (Document&amp; document) {</span>
<span class="line-modified">!         document.setShouldPlayToPlaybackTarget(clientId, shouldPlay);</span>
<span class="line-modified">!     });</span>
  }
<span class="line-added">+ </span>
<span class="line-added">+ void Page::playbackTargetPickerWasDismissed(uint64_t clientId)</span>
<span class="line-added">+ {</span>
<span class="line-added">+     forEachDocument([&amp;] (Document&amp; document) {</span>
<span class="line-added">+         document.playbackTargetPickerWasDismissed(clientId);</span>
<span class="line-added">+     });</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
  #endif
  
<span class="line-modified">! WheelEventTestMonitor&amp; Page::ensureWheelEventTestMonitor()</span>
  {
<span class="line-modified">!     if (!m_wheelEventTestMonitor) {</span>
<span class="line-modified">!         m_wheelEventTestMonitor = adoptRef(new WheelEventTestMonitor());</span>
          // We need to update the scrolling coordinator so that the mainframe scrolling node can expect wheel event test triggers.
          if (auto* frameView = mainFrame().view()) {
              if (m_scrollingCoordinator)
<span class="line-modified">!                 m_scrollingCoordinator-&gt;updateIsMonitoringWheelEventsForFrameView(*frameView);</span>
          }
      }
  
<span class="line-modified">!     return *m_wheelEventTestMonitor;</span>
  }
  
  #if ENABLE(VIDEO)
<span class="line-added">+ </span>
  void Page::setAllowsMediaDocumentInlinePlayback(bool flag)
  {
      if (m_allowsMediaDocumentInlinePlayback == flag)
          return;
      m_allowsMediaDocumentInlinePlayback = flag;
  
<span class="line-modified">!     forEachMediaElement([] (HTMLMediaElement&amp; element) {</span>
<span class="line-modified">!         element.allowsMediaDocumentInlinePlaybackChanged();</span>
<span class="line-modified">!     });</span>
  }
<span class="line-added">+ </span>
  #endif
  
  #if ENABLE(INDEXED_DATABASE)
  IDBClient::IDBConnectionToServer&amp; Page::idbConnection()
  {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2655,43 ***</span>
      m_captionUserPreferencesStyleSheet = styleSheet;
  }
  
  void Page::accessibilitySettingsDidChange()
  {
<span class="line-modified">!     for (Frame* frame = &amp;mainFrame(); frame; frame = frame-&gt;tree().traverseNext()) {</span>
<span class="line-modified">!         if (auto* document = frame-&gt;document()) {</span>
<span class="line-modified">!             document-&gt;styleScope().evaluateMediaQueriesForAccessibilitySettingsChange();</span>
<span class="line-modified">!             document-&gt;evaluateMediaQueryList();</span>
<span class="line-modified">!         }</span>
<span class="line-removed">-     }</span>
  }
  
  void Page::appearanceDidChange()
  {
<span class="line-modified">!     for (Frame* frame = &amp;mainFrame(); frame; frame = frame-&gt;tree().traverseNext()) {</span>
<span class="line-modified">!         auto* document = frame-&gt;document();</span>
<span class="line-modified">!         if (!document)</span>
<span class="line-modified">!             continue;</span>
<span class="line-modified">! </span>
<span class="line-modified">!         document-&gt;styleScope().didChangeStyleSheetEnvironment();</span>
<span class="line-removed">-         document-&gt;styleScope().evaluateMediaQueriesForAppearanceChange();</span>
<span class="line-removed">-         document-&gt;evaluateMediaQueryList();</span>
<span class="line-removed">-     }</span>
  }
  
  void Page::setUnobscuredSafeAreaInsets(const FloatBoxExtent&amp; insets)
  {
      if (m_unobscuredSafeAreaInsets == insets)
          return;
  
      m_unobscuredSafeAreaInsets = insets;
  
<span class="line-modified">!     for (Frame* frame = &amp;mainFrame(); frame; frame = frame-&gt;tree().traverseNext()) {</span>
<span class="line-modified">!         if (!frame-&gt;document())</span>
<span class="line-modified">!             continue;</span>
<span class="line-removed">-         frame-&gt;document()-&gt;constantProperties().didChangeSafeAreaInsets();</span>
<span class="line-removed">-     }</span>
  }
  
  void Page::setUseSystemAppearance(bool value)
  {
      if (m_useSystemAppearance == value)
<span class="line-new-header">--- 2663,37 ---</span>
      m_captionUserPreferencesStyleSheet = styleSheet;
  }
  
  void Page::accessibilitySettingsDidChange()
  {
<span class="line-modified">!     forEachDocument([] (auto&amp; document) {</span>
<span class="line-modified">!         document.styleScope().evaluateMediaQueriesForAccessibilitySettingsChange();</span>
<span class="line-modified">!         document.updateElementsAffectedByMediaQueries();</span>
<span class="line-modified">!         document.scheduleTimedRenderingUpdate();</span>
<span class="line-modified">!     });</span>
  }
  
  void Page::appearanceDidChange()
  {
<span class="line-modified">!     forEachDocument([] (auto&amp; document) {</span>
<span class="line-modified">!         document.styleScope().didChangeStyleSheetEnvironment();</span>
<span class="line-modified">!         document.styleScope().evaluateMediaQueriesForAppearanceChange();</span>
<span class="line-modified">!         document.updateElementsAffectedByMediaQueries();</span>
<span class="line-modified">!         document.scheduleTimedRenderingUpdate();</span>
<span class="line-modified">!     });</span>
  }
  
  void Page::setUnobscuredSafeAreaInsets(const FloatBoxExtent&amp; insets)
  {
      if (m_unobscuredSafeAreaInsets == insets)
          return;
  
      m_unobscuredSafeAreaInsets = insets;
  
<span class="line-modified">!     forEachDocument([&amp;] (Document&amp; document) {</span>
<span class="line-modified">!         document.constantProperties().didChangeSafeAreaInsets();</span>
<span class="line-modified">!     });</span>
  }
  
  void Page::setUseSystemAppearance(bool value)
  {
      if (m_useSystemAppearance == value)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2699,19 ***</span>
  
      m_useSystemAppearance = value;
  
      appearanceDidChange();
  
<span class="line-modified">!     for (auto* frame = &amp;mainFrame(); frame; frame = frame-&gt;tree().traverseNext()) {</span>
<span class="line-removed">-         auto* document = frame-&gt;document();</span>
<span class="line-removed">-         if (!document)</span>
<span class="line-removed">-             continue;</span>
<span class="line-removed">- </span>
          // System apperance change may affect stylesheet parsing. We need to reparse.
<span class="line-modified">!         document-&gt;extensionStyleSheets().clearPageUserSheet();</span>
<span class="line-modified">!         document-&gt;extensionStyleSheets().invalidateInjectedStyleSheetCache();</span>
<span class="line-modified">!     }</span>
  }
  
  void Page::effectiveAppearanceDidChange(bool useDarkAppearance, bool useElevatedUserInterfaceLevel)
  {
  #if ENABLE(DARK_MODE_CSS)
<span class="line-new-header">--- 2701,15 ---</span>
  
      m_useSystemAppearance = value;
  
      appearanceDidChange();
  
<span class="line-modified">!     forEachDocument([&amp;] (Document&amp; document) {</span>
          // System apperance change may affect stylesheet parsing. We need to reparse.
<span class="line-modified">!         document.extensionStyleSheets().clearPageUserSheet();</span>
<span class="line-modified">!         document.extensionStyleSheets().invalidateInjectedStyleSheetCache();</span>
<span class="line-modified">!     });</span>
  }
  
  void Page::effectiveAppearanceDidChange(bool useDarkAppearance, bool useElevatedUserInterfaceLevel)
  {
  #if ENABLE(DARK_MODE_CSS)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2766,66 ***</span>
  
  void Page::setFullscreenInsets(const FloatBoxExtent&amp; insets)
  {
      if (insets == m_fullscreenInsets)
          return;
      m_fullscreenInsets = insets;
  
<span class="line-modified">!     for (Frame* frame = &amp;mainFrame(); frame; frame = frame-&gt;tree().traverseNext()) {</span>
<span class="line-modified">!         if (!frame-&gt;document())</span>
<span class="line-modified">!             continue;</span>
<span class="line-removed">-         frame-&gt;document()-&gt;constantProperties().didChangeFullscreenInsets();</span>
<span class="line-removed">-     }</span>
  }
  
  void Page::setFullscreenAutoHideDuration(Seconds duration)
  {
      if (duration == m_fullscreenAutoHideDuration)
          return;
      m_fullscreenAutoHideDuration = duration;
<span class="line-modified">!     for (Frame* frame = &amp;mainFrame(); frame; frame = frame-&gt;tree().traverseNext()) {</span>
<span class="line-modified">!         if (!frame-&gt;document())</span>
<span class="line-modified">!             continue;</span>
<span class="line-modified">!         frame-&gt;document()-&gt;constantProperties().setFullscreenAutoHideDuration(duration);</span>
<span class="line-removed">-     }</span>
  }
  
  void Page::setFullscreenControlsHidden(bool hidden)
  {
  #if ENABLE(FULLSCREEN_API)
<span class="line-modified">!     for (Frame* frame = &amp;mainFrame(); frame; frame = frame-&gt;tree().traverseNext()) {</span>
<span class="line-modified">!         if (!frame-&gt;document())</span>
<span class="line-modified">!             continue;</span>
<span class="line-removed">-         frame-&gt;document()-&gt;fullscreenManager().setFullscreenControlsHidden(hidden);</span>
<span class="line-removed">-     }</span>
  #else
      UNUSED_PARAM(hidden);
  #endif
  }
  
<span class="line-removed">- #if ENABLE(DATA_INTERACTION)</span>
<span class="line-removed">- </span>
<span class="line-removed">- bool Page::hasSelectionAtPosition(const FloatPoint&amp; position) const</span>
<span class="line-removed">- {</span>
<span class="line-removed">-     auto currentSelection = m_mainFrame-&gt;selection().selection();</span>
<span class="line-removed">-     if (!currentSelection.isRange())</span>
<span class="line-removed">-         return false;</span>
<span class="line-removed">- </span>
<span class="line-removed">-     if (auto selectedRange = currentSelection.toNormalizedRange()) {</span>
<span class="line-removed">-         Vector&lt;SelectionRect&gt; selectionRects;</span>
<span class="line-removed">-         selectedRange-&gt;collectSelectionRects(selectionRects);</span>
<span class="line-removed">-         for (auto selectionRect : selectionRects) {</span>
<span class="line-removed">-             if (FloatRect(selectionRect.rect()).contains(position))</span>
<span class="line-removed">-                 return true;</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     return false;</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
<span class="line-removed">- #endif</span>
<span class="line-removed">- </span>
  void Page::disableICECandidateFiltering()
  {
      m_shouldEnableICECandidateFilteringByDefault = false;
  #if ENABLE(WEB_RTC)
      m_rtcController.disableICECandidateFilteringForAllOrigins();
<span class="line-new-header">--- 2764,41 ---</span>
  
  void Page::setFullscreenInsets(const FloatBoxExtent&amp; insets)
  {
      if (insets == m_fullscreenInsets)
          return;
<span class="line-added">+ </span>
      m_fullscreenInsets = insets;
  
<span class="line-modified">!     forEachDocument([] (Document&amp; document) {</span>
<span class="line-modified">!         document.constantProperties().didChangeFullscreenInsets();</span>
<span class="line-modified">!     });</span>
  }
  
  void Page::setFullscreenAutoHideDuration(Seconds duration)
  {
      if (duration == m_fullscreenAutoHideDuration)
          return;
<span class="line-added">+ </span>
      m_fullscreenAutoHideDuration = duration;
<span class="line-modified">! </span>
<span class="line-modified">!     forEachDocument([&amp;] (Document&amp; document) {</span>
<span class="line-modified">!         document.constantProperties().setFullscreenAutoHideDuration(duration);</span>
<span class="line-modified">!     });</span>
  }
  
  void Page::setFullscreenControlsHidden(bool hidden)
  {
  #if ENABLE(FULLSCREEN_API)
<span class="line-modified">!     forEachDocument([&amp;] (Document&amp; document) {</span>
<span class="line-modified">!         document.fullscreenManager().setFullscreenControlsHidden(hidden);</span>
<span class="line-modified">!     });</span>
  #else
      UNUSED_PARAM(hidden);
  #endif
  }
  
  void Page::disableICECandidateFiltering()
  {
      m_shouldEnableICECandidateFilteringByDefault = false;
  #if ENABLE(WEB_RTC)
      m_rtcController.disableICECandidateFilteringForAllOrigins();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2855,27 ***</span>
      if (!m_renderingUpdateScheduler)
          m_renderingUpdateScheduler = RenderingUpdateScheduler::create(*this);
      return *m_renderingUpdateScheduler;
  }
  
<span class="line-modified">! void Page::forEachDocument(const Function&lt;void(Document&amp;)&gt;&amp; functor)</span>
  {
<span class="line-modified">!     for (Frame* frame = &amp;mainFrame(); frame; frame = frame-&gt;tree().traverseNext()) {</span>
<span class="line-modified">!         if (!frame-&gt;document())</span>
              continue;
<span class="line-modified">! </span>
<span class="line-removed">-         functor(*frame-&gt;document());</span>
      }
  }
  
<span class="line-modified">! void Page::applicationWillResignActive()</span>
  {
      forEachDocument([&amp;] (Document&amp; document) {
<span class="line-modified">!         document.forEachApplicationStateChangeListener([&amp;] (ApplicationStateChangeListener&amp; listener) {</span>
<span class="line-modified">!             listener.applicationWillResignActive();</span>
<span class="line-modified">!         });</span>
      });
  }
  
  void Page::applicationDidEnterBackground()
  {
      m_libWebRTCProvider-&gt;setActive(false);
<span class="line-new-header">--- 2828,39 ---</span>
      if (!m_renderingUpdateScheduler)
          m_renderingUpdateScheduler = RenderingUpdateScheduler::create(*this);
      return *m_renderingUpdateScheduler;
  }
  
<span class="line-modified">! void Page::forEachDocument(const Function&lt;void(Document&amp;)&gt;&amp; functor) const</span>
  {
<span class="line-modified">!     Vector&lt;Ref&lt;Document&gt;&gt; documents;</span>
<span class="line-modified">!     for (auto* frame = &amp;mainFrame(); frame; frame = frame-&gt;tree().traverseNext()) {</span>
<span class="line-added">+         auto* document = frame-&gt;document();</span>
<span class="line-added">+         if (!document)</span>
              continue;
<span class="line-modified">!         documents.append(*document);</span>
      }
<span class="line-added">+     for (auto&amp; document : documents)</span>
<span class="line-added">+         functor(document);</span>
  }
  
<span class="line-modified">! void Page::forEachMediaElement(const Function&lt;void(HTMLMediaElement&amp;)&gt;&amp; functor)</span>
  {
<span class="line-added">+ #if ENABLE(VIDEO)</span>
      forEachDocument([&amp;] (Document&amp; document) {
<span class="line-modified">!         document.forEachMediaElement(functor);</span>
<span class="line-modified">!     });</span>
<span class="line-modified">! #endif</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ void Page::applicationWillResignActive()</span>
<span class="line-added">+ {</span>
<span class="line-added">+ #if ENABLE(VIDEO)</span>
<span class="line-added">+     forEachMediaElement([] (HTMLMediaElement&amp; element) {</span>
<span class="line-added">+         element.applicationWillResignActive();</span>
      });
<span class="line-added">+ #endif</span>
  }
  
  void Page::applicationDidEnterBackground()
  {
      m_libWebRTCProvider-&gt;setActive(false);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2886,15 ***</span>
      m_libWebRTCProvider-&gt;setActive(true);
  }
  
  void Page::applicationDidBecomeActive()
  {
<span class="line-modified">!     forEachDocument([&amp;] (Document&amp; document) {</span>
<span class="line-modified">!         document.forEachApplicationStateChangeListener([&amp;] (ApplicationStateChangeListener&amp; listener) {</span>
<span class="line-modified">!             listener.applicationDidBecomeActive();</span>
<span class="line-removed">-         });</span>
      });
  }
  
  #if PLATFORM(MAC)
  ScrollLatchingState* Page::latchingState()
  {
<span class="line-new-header">--- 2871,15 ---</span>
      m_libWebRTCProvider-&gt;setActive(true);
  }
  
  void Page::applicationDidBecomeActive()
  {
<span class="line-modified">! #if ENABLE(VIDEO)</span>
<span class="line-modified">!     forEachMediaElement([] (HTMLMediaElement&amp; element) {</span>
<span class="line-modified">!         element.applicationDidBecomeActive();</span>
      });
<span class="line-added">+ #endif</span>
  }
  
  #if PLATFORM(MAC)
  ScrollLatchingState* Page::latchingState()
  {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2970,11 ***</span>
          channel-&gt;state = state;
          channel-&gt;level = level;
  
  #if USE(LIBWEBRTC)
          if (channel == &amp;LogWebRTC &amp;&amp; m_mainFrame-&gt;document())
<span class="line-modified">!             libWebRTCProvider().setEnableLogging(!m_mainFrame-&gt;document()-&gt;sessionID().isEphemeral());</span>
  #endif
      }
  
      chrome().client().configureLoggingChannel(channelName, state, level);
  #else
<span class="line-new-header">--- 2955,11 ---</span>
          channel-&gt;state = state;
          channel-&gt;level = level;
  
  #if USE(LIBWEBRTC)
          if (channel == &amp;LogWebRTC &amp;&amp; m_mainFrame-&gt;document())
<span class="line-modified">!             libWebRTCProvider().setEnableLogging(!sessionID().isEphemeral());</span>
  #endif
      }
  
      chrome().client().configureLoggingChannel(channelName, state, level);
  #else
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2984,32 ***</span>
  #endif
  }
  
  void Page::didFinishLoadingImageForElement(HTMLImageElement&amp; element)
  {
      chrome().client().didFinishLoadingImageForElement(element);
  }
  
  #if ENABLE(TEXT_AUTOSIZING)
  void Page::recomputeTextAutoSizingInAllFrames()
  {
      ASSERT(settings().textAutosizingEnabled() &amp;&amp; settings().textAutosizingUsesIdempotentMode());
<span class="line-modified">!     for (auto* frame = &amp;mainFrame(); frame; frame = frame-&gt;tree().traverseNext()) {</span>
<span class="line-modified">!         if (!frame-&gt;document())</span>
<span class="line-modified">!             continue;</span>
<span class="line-modified">!         auto&amp; document = *frame-&gt;document();</span>
<span class="line-modified">!         if (!document.renderView() || !document.styleScope().resolverIfExists())</span>
<span class="line-modified">!             continue;</span>
<span class="line-modified">! </span>
<span class="line-removed">-         auto&amp; styleResolver = document.styleScope().resolver();</span>
<span class="line-removed">-         for (auto&amp; renderer : descendantsOfType&lt;RenderElement&gt;(*document.renderView())) {</span>
<span class="line-removed">-             if (auto* element = renderer.element()) {</span>
<span class="line-removed">-                 auto needsLayout = styleResolver.adjustRenderStyleForTextAutosizing(renderer.mutableStyle(), *element);</span>
<span class="line-removed">-                 if (needsLayout)</span>
<span class="line-removed">-                     renderer.setNeedsLayout();</span>
              }
          }
<span class="line-modified">!     }</span>
  }
  #endif
  
  } // namespace WebCore
<span class="line-new-header">--- 2969,38 ---</span>
  #endif
  }
  
  void Page::didFinishLoadingImageForElement(HTMLImageElement&amp; element)
  {
<span class="line-added">+     auto protectedElement = makeRef(element);</span>
<span class="line-added">+     if (auto frame = makeRefPtr(element.document().frame()))</span>
<span class="line-added">+         frame-&gt;editor().revealSelectionIfNeededAfterLoadingImageForElement(element);</span>
      chrome().client().didFinishLoadingImageForElement(element);
  }
  
  #if ENABLE(TEXT_AUTOSIZING)
<span class="line-added">+ </span>
  void Page::recomputeTextAutoSizingInAllFrames()
  {
      ASSERT(settings().textAutosizingEnabled() &amp;&amp; settings().textAutosizingUsesIdempotentMode());
<span class="line-modified">!     forEachDocument([] (Document&amp; document) {</span>
<span class="line-modified">!         if (auto* renderView = document.renderView()) {</span>
<span class="line-modified">!             for (auto&amp; renderer : descendantsOfType&lt;RenderElement&gt;(*renderView)) {</span>
<span class="line-modified">!                 if (auto* element = renderer.element()) {</span>
<span class="line-modified">!                     if (Style::Adjuster::adjustForTextAutosizing(renderer.mutableStyle(), *element))</span>
<span class="line-modified">!                         renderer.setNeedsLayout();</span>
<span class="line-modified">!                 }</span>
              }
          }
<span class="line-modified">!     });</span>
  }
<span class="line-added">+ </span>
  #endif
  
<span class="line-added">+ bool Page::shouldDisableCorsForRequestTo(const URL&amp; url) const</span>
<span class="line-added">+ {</span>
<span class="line-added">+     return WTF::anyOf(m_corsDisablingPatterns, [&amp;] (const auto&amp; pattern) {</span>
<span class="line-added">+         return pattern.matches(url);</span>
<span class="line-added">+     });</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
  } // namespace WebCore
</pre>
<center><a href="NavigatorBase.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="Page.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>