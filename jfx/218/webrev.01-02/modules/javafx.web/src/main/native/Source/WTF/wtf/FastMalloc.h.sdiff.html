<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WTF/wtf/FastMalloc.h</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="FastMalloc.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="FileSystem.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WTF/wtf/FastMalloc.h</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  5  *  modify it under the terms of the GNU Library General Public
  6  *  License as published by the Free Software Foundation; either
  7  *  version 2 of the License, or (at your option) any later version.
  8  *
  9  *  This library is distributed in the hope that it will be useful,
 10  *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 11  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 12  *  Library General Public License for more details.
 13  *
 14  *  You should have received a copy of the GNU Library General Public License
 15  *  along with this library; see the file COPYING.LIB.  If not, write to
 16  *  the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
 17  *  Boston, MA 02110-1301, USA.
 18  *
 19  */
 20 
 21 #pragma once
 22 
 23 #include &lt;new&gt;
 24 #include &lt;stdlib.h&gt;

 25 #include &lt;wtf/StdLibExtras.h&gt;
 26 
 27 namespace WTF {
 28 
 29 #if !defined(NDEBUG)
 30 WTF_EXPORT_PRIVATE void fastSetMaxSingleAllocationSize(size_t);
 31 #endif
 32 
 33 class TryMallocReturnValue {
 34 public:
 35     TryMallocReturnValue(void*);
 36     TryMallocReturnValue(TryMallocReturnValue&amp;&amp;);
 37     ~TryMallocReturnValue();
 38     template&lt;typename T&gt; bool getValue(T*&amp;) WARN_UNUSED_RETURN;
 39 private:
 40     void operator=(TryMallocReturnValue&amp;&amp;) = delete;
 41     mutable void* m_data;
 42 };
 43 
 44 WTF_EXPORT_PRIVATE bool isFastMallocEnabled();
</pre>
<hr />
<pre>
 65 WTF_EXPORT_PRIVATE size_t fastMallocSize(const void*);
 66 
 67 // FIXME: This is non-helpful; fastMallocGoodSize will be removed soon.
 68 WTF_EXPORT_PRIVATE size_t fastMallocGoodSize(size_t);
 69 
 70 WTF_EXPORT_PRIVATE void releaseFastMallocFreeMemory();
 71 WTF_EXPORT_PRIVATE void releaseFastMallocFreeMemoryForThisThread();
 72 
 73 WTF_EXPORT_PRIVATE void fastCommitAlignedMemory(void*, size_t);
 74 WTF_EXPORT_PRIVATE void fastDecommitAlignedMemory(void*, size_t);
 75 
 76 WTF_EXPORT_PRIVATE void fastEnableMiniMode();
 77 
 78 struct FastMallocStatistics {
 79     size_t reservedVMBytes;
 80     size_t committedVMBytes;
 81     size_t freeListBytes;
 82 };
 83 WTF_EXPORT_PRIVATE FastMallocStatistics fastMallocStatistics();
 84 


 85 // This defines a type which holds an unsigned integer and is the same
 86 // size as the minimally aligned memory allocation.
 87 typedef unsigned long long AllocAlignmentInteger;
 88 
 89 inline TryMallocReturnValue::TryMallocReturnValue(void* data)
 90     : m_data(data)
 91 {
 92 }
 93 
 94 inline TryMallocReturnValue::TryMallocReturnValue(TryMallocReturnValue&amp;&amp; source)
 95     : m_data(source.m_data)
 96 {
 97     source.m_data = nullptr;
 98 }
 99 
100 inline TryMallocReturnValue::~TryMallocReturnValue()
101 {
102     ASSERT(!m_data);
103 }
104 
</pre>
<hr />
<pre>
183     using propagate_on_container_swap = std::false_type;
184     using is_always_equal = std::is_empty&lt;FastAllocator&gt;;
185 #endif // defined(__GLIBCXX__) &amp;&amp; (!defined(_GLIBCXX_RELEASE) || _GLIBCXX_RELEASE &lt; 6)
186 };
187 
188 template&lt;typename T, typename U&gt; inline bool operator==(const FastAllocator&lt;T&gt;&amp;, const FastAllocator&lt;U&gt;&amp;) { return true; }
189 template&lt;typename T, typename U&gt; inline bool operator!=(const FastAllocator&lt;T&gt;&amp;, const FastAllocator&lt;U&gt;&amp;) { return false; }
190 
191 struct FastMalloc {
192     static void* malloc(size_t size) { return fastMalloc(size); }
193 
194     static void* tryMalloc(size_t size)
195     {
196         auto result = tryFastMalloc(size);
197         void* realResult;
198         if (result.getValue(realResult))
199             return realResult;
200         return nullptr;
201     }
202 











203     static void* realloc(void* p, size_t size) { return fastRealloc(p, size); }
204 
205     static void* tryRealloc(void* p, size_t size)
206     {
207         auto result = tryFastRealloc(p, size);
208         void* realResult;
209         if (result.getValue(realResult))
210             return realResult;
211         return nullptr;
212     }
213 
214     static void free(void* p) { fastFree(p); }
215 };
216 
217 template&lt;typename T&gt;
218 struct FastFree {
219     static_assert(std::is_trivially_destructible&lt;T&gt;::value, &quot;&quot;);
220 
221     void operator()(T* pointer) const
222     {
</pre>
<hr />
<pre>
282     { \
283         ::WTF::fastFree(p); \
284     } \
285     \
286     void* operator new[](size_t size) \
287     { \
288         return ::WTF::fastMalloc(size); \
289     } \
290     \
291     void operator delete[](void* p) \
292     { \
293         ::WTF::fastFree(p); \
294     } \
295     void* operator new(size_t, NotNullTag, void* location) \
296     { \
297         ASSERT(location); \
298         return location; \
299     } \
300     using webkitFastMalloced = int; \
301 


302 #define WTF_MAKE_FAST_ALLOCATED \
303 public: \
304     WTF_MAKE_FAST_ALLOCATED_IMPL \
305 private: \
306 using __thisIsHereToForceASemicolonAfterThisMacro = int
307 
308 #define WTF_MAKE_STRUCT_FAST_ALLOCATED \
309     WTF_MAKE_FAST_ALLOCATED_IMPL \
310 using __thisIsHereToForceASemicolonAfterThisMacro = int
































































</pre>
</td>
<td>
<hr />
<pre>
  5  *  modify it under the terms of the GNU Library General Public
  6  *  License as published by the Free Software Foundation; either
  7  *  version 2 of the License, or (at your option) any later version.
  8  *
  9  *  This library is distributed in the hope that it will be useful,
 10  *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 11  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 12  *  Library General Public License for more details.
 13  *
 14  *  You should have received a copy of the GNU Library General Public License
 15  *  along with this library; see the file COPYING.LIB.  If not, write to
 16  *  the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
 17  *  Boston, MA 02110-1301, USA.
 18  *
 19  */
 20 
 21 #pragma once
 22 
 23 #include &lt;new&gt;
 24 #include &lt;stdlib.h&gt;
<span class="line-added"> 25 #include &lt;wtf/DebugHeap.h&gt;</span>
 26 #include &lt;wtf/StdLibExtras.h&gt;
 27 
 28 namespace WTF {
 29 
 30 #if !defined(NDEBUG)
 31 WTF_EXPORT_PRIVATE void fastSetMaxSingleAllocationSize(size_t);
 32 #endif
 33 
 34 class TryMallocReturnValue {
 35 public:
 36     TryMallocReturnValue(void*);
 37     TryMallocReturnValue(TryMallocReturnValue&amp;&amp;);
 38     ~TryMallocReturnValue();
 39     template&lt;typename T&gt; bool getValue(T*&amp;) WARN_UNUSED_RETURN;
 40 private:
 41     void operator=(TryMallocReturnValue&amp;&amp;) = delete;
 42     mutable void* m_data;
 43 };
 44 
 45 WTF_EXPORT_PRIVATE bool isFastMallocEnabled();
</pre>
<hr />
<pre>
 66 WTF_EXPORT_PRIVATE size_t fastMallocSize(const void*);
 67 
 68 // FIXME: This is non-helpful; fastMallocGoodSize will be removed soon.
 69 WTF_EXPORT_PRIVATE size_t fastMallocGoodSize(size_t);
 70 
 71 WTF_EXPORT_PRIVATE void releaseFastMallocFreeMemory();
 72 WTF_EXPORT_PRIVATE void releaseFastMallocFreeMemoryForThisThread();
 73 
 74 WTF_EXPORT_PRIVATE void fastCommitAlignedMemory(void*, size_t);
 75 WTF_EXPORT_PRIVATE void fastDecommitAlignedMemory(void*, size_t);
 76 
 77 WTF_EXPORT_PRIVATE void fastEnableMiniMode();
 78 
 79 struct FastMallocStatistics {
 80     size_t reservedVMBytes;
 81     size_t committedVMBytes;
 82     size_t freeListBytes;
 83 };
 84 WTF_EXPORT_PRIVATE FastMallocStatistics fastMallocStatistics();
 85 
<span class="line-added"> 86 WTF_EXPORT_PRIVATE void fastMallocDumpMallocStats();</span>
<span class="line-added"> 87 </span>
 88 // This defines a type which holds an unsigned integer and is the same
 89 // size as the minimally aligned memory allocation.
 90 typedef unsigned long long AllocAlignmentInteger;
 91 
 92 inline TryMallocReturnValue::TryMallocReturnValue(void* data)
 93     : m_data(data)
 94 {
 95 }
 96 
 97 inline TryMallocReturnValue::TryMallocReturnValue(TryMallocReturnValue&amp;&amp; source)
 98     : m_data(source.m_data)
 99 {
100     source.m_data = nullptr;
101 }
102 
103 inline TryMallocReturnValue::~TryMallocReturnValue()
104 {
105     ASSERT(!m_data);
106 }
107 
</pre>
<hr />
<pre>
186     using propagate_on_container_swap = std::false_type;
187     using is_always_equal = std::is_empty&lt;FastAllocator&gt;;
188 #endif // defined(__GLIBCXX__) &amp;&amp; (!defined(_GLIBCXX_RELEASE) || _GLIBCXX_RELEASE &lt; 6)
189 };
190 
191 template&lt;typename T, typename U&gt; inline bool operator==(const FastAllocator&lt;T&gt;&amp;, const FastAllocator&lt;U&gt;&amp;) { return true; }
192 template&lt;typename T, typename U&gt; inline bool operator!=(const FastAllocator&lt;T&gt;&amp;, const FastAllocator&lt;U&gt;&amp;) { return false; }
193 
194 struct FastMalloc {
195     static void* malloc(size_t size) { return fastMalloc(size); }
196 
197     static void* tryMalloc(size_t size)
198     {
199         auto result = tryFastMalloc(size);
200         void* realResult;
201         if (result.getValue(realResult))
202             return realResult;
203         return nullptr;
204     }
205 
<span class="line-added">206     static void* zeroedMalloc(size_t size) { return fastZeroedMalloc(size); }</span>
<span class="line-added">207 </span>
<span class="line-added">208     static void* tryZeroedMalloc(size_t size)</span>
<span class="line-added">209     {</span>
<span class="line-added">210         auto result = tryFastZeroedMalloc(size);</span>
<span class="line-added">211         void* realResult;</span>
<span class="line-added">212         if (result.getValue(realResult))</span>
<span class="line-added">213             return realResult;</span>
<span class="line-added">214         return nullptr;</span>
<span class="line-added">215     }</span>
<span class="line-added">216 </span>
217     static void* realloc(void* p, size_t size) { return fastRealloc(p, size); }
218 
219     static void* tryRealloc(void* p, size_t size)
220     {
221         auto result = tryFastRealloc(p, size);
222         void* realResult;
223         if (result.getValue(realResult))
224             return realResult;
225         return nullptr;
226     }
227 
228     static void free(void* p) { fastFree(p); }
229 };
230 
231 template&lt;typename T&gt;
232 struct FastFree {
233     static_assert(std::is_trivially_destructible&lt;T&gt;::value, &quot;&quot;);
234 
235     void operator()(T* pointer) const
236     {
</pre>
<hr />
<pre>
296     { \
297         ::WTF::fastFree(p); \
298     } \
299     \
300     void* operator new[](size_t size) \
301     { \
302         return ::WTF::fastMalloc(size); \
303     } \
304     \
305     void operator delete[](void* p) \
306     { \
307         ::WTF::fastFree(p); \
308     } \
309     void* operator new(size_t, NotNullTag, void* location) \
310     { \
311         ASSERT(location); \
312         return location; \
313     } \
314     using webkitFastMalloced = int; \
315 
<span class="line-added">316 // FIXME: WTF_MAKE_FAST_ALLOCATED should take class name so that we can create malloc_zone per this macro.</span>
<span class="line-added">317 // https://bugs.webkit.org/show_bug.cgi?id=205702</span>
318 #define WTF_MAKE_FAST_ALLOCATED \
319 public: \
320     WTF_MAKE_FAST_ALLOCATED_IMPL \
321 private: \
322 using __thisIsHereToForceASemicolonAfterThisMacro = int
323 
324 #define WTF_MAKE_STRUCT_FAST_ALLOCATED \
325     WTF_MAKE_FAST_ALLOCATED_IMPL \
326 using __thisIsHereToForceASemicolonAfterThisMacro = int
<span class="line-added">327 </span>
<span class="line-added">328 #if ENABLE(MALLOC_HEAP_BREAKDOWN)</span>
<span class="line-added">329 </span>
<span class="line-added">330 #define WTF_MAKE_FAST_ALLOCATED_WITH_HEAP_IDENTIFIER_IMPL(classname) \</span>
<span class="line-added">331     void* operator new(size_t, void* p) { return p; } \</span>
<span class="line-added">332     void* operator new[](size_t, void* p) { return p; } \</span>
<span class="line-added">333     \</span>
<span class="line-added">334     void* operator new(size_t size) \</span>
<span class="line-added">335     { \</span>
<span class="line-added">336         return classname##Malloc::malloc(size); \</span>
<span class="line-added">337     } \</span>
<span class="line-added">338     \</span>
<span class="line-added">339     void operator delete(void* p) \</span>
<span class="line-added">340     { \</span>
<span class="line-added">341         classname##Malloc::free(p); \</span>
<span class="line-added">342     } \</span>
<span class="line-added">343     \</span>
<span class="line-added">344     void* operator new[](size_t size) \</span>
<span class="line-added">345     { \</span>
<span class="line-added">346         return classname##Malloc::malloc(size); \</span>
<span class="line-added">347     } \</span>
<span class="line-added">348     \</span>
<span class="line-added">349     void operator delete[](void* p) \</span>
<span class="line-added">350     { \</span>
<span class="line-added">351         classname##Malloc::free(p); \</span>
<span class="line-added">352     } \</span>
<span class="line-added">353     void* operator new(size_t, NotNullTag, void* location) \</span>
<span class="line-added">354     { \</span>
<span class="line-added">355         ASSERT(location); \</span>
<span class="line-added">356         return location; \</span>
<span class="line-added">357     } \</span>
<span class="line-added">358     using webkitFastMalloced = int; \</span>
<span class="line-added">359 </span>
<span class="line-added">360 #define WTF_MAKE_FAST_ALLOCATED_WITH_HEAP_IDENTIFIER(classname) \</span>
<span class="line-added">361 public: \</span>
<span class="line-added">362     WTF_MAKE_FAST_ALLOCATED_WITH_HEAP_IDENTIFIER_IMPL(classname) \</span>
<span class="line-added">363 private: \</span>
<span class="line-added">364     WTF_EXPORT_PRIVATE static WTF::DebugHeap&amp; debugHeap(const char*); \</span>
<span class="line-added">365 using __thisIsHereToForceASemicolonAfterThisMacro = int</span>
<span class="line-added">366 </span>
<span class="line-added">367 #define WTF_MAKE_STRUCT_FAST_ALLOCATED_WITH_HEAP_IDENTIFIER(className) \</span>
<span class="line-added">368 private: \</span>
<span class="line-added">369     WTF_EXPORT_PRIVATE static WTF::DebugHeap&amp; debugHeap(const char*); \</span>
<span class="line-added">370 public: \</span>
<span class="line-added">371     WTF_MAKE_FAST_ALLOCATED_WITH_HEAP_IDENTIFIER_IMPL(className) \</span>
<span class="line-added">372 using __thisIsHereToForceASemicolonAfterThisMacro = int</span>
<span class="line-added">373 </span>
<span class="line-added">374 #else</span>
<span class="line-added">375 </span>
<span class="line-added">376 #define WTF_MAKE_FAST_ALLOCATED_WITH_HEAP_IDENTIFIER_IMPL(classname) \</span>
<span class="line-added">377     WTF_MAKE_FAST_ALLOCATED_IMPL</span>
<span class="line-added">378 </span>
<span class="line-added">379 #define WTF_MAKE_FAST_ALLOCATED_WITH_HEAP_IDENTIFIER(classname) \</span>
<span class="line-added">380 public: \</span>
<span class="line-added">381     WTF_MAKE_FAST_ALLOCATED_WITH_HEAP_IDENTIFIER_IMPL(classname) \</span>
<span class="line-added">382 private: \</span>
<span class="line-added">383 using __thisIsHereToForceASemicolonAfterThisMacro = int</span>
<span class="line-added">384 </span>
<span class="line-added">385 #define WTF_MAKE_STRUCT_FAST_ALLOCATED_WITH_HEAP_IDENTIFIER(className) \</span>
<span class="line-added">386 public: \</span>
<span class="line-added">387     WTF_MAKE_FAST_ALLOCATED_WITH_HEAP_IDENTIFIER_IMPL(className) \</span>
<span class="line-added">388 using __thisIsHereToForceASemicolonAfterThisMacro = int</span>
<span class="line-added">389 </span>
<span class="line-added">390 #endif</span>
</pre>
</td>
</tr>
</table>
<center><a href="FastMalloc.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="FileSystem.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>