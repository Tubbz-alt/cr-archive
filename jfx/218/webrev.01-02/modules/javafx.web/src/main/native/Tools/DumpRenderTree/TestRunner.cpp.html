<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New modules/javafx.web/src/main/native/Tools/DumpRenderTree/TestRunner.cpp</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (C) 2007-2016 Apple Inc. All rights reserved.
   3  * Copyright (C) 2010 Joone Hur &lt;joone@kldp.org&gt;
   4  *
   5  * Redistribution and use in source and binary forms, with or without
   6  * modification, are permitted provided that the following conditions
   7  * are met:
   8  *
   9  * 1.  Redistributions of source code must retain the above copyright
  10  *     notice, this list of conditions and the following disclaimer.
  11  * 2.  Redistributions in binary form must reproduce the above copyright
  12  *     notice, this list of conditions and the following disclaimer in the
  13  *     documentation and/or other materials provided with the distribution.
  14  * 3.  Neither the name of Apple Inc. (&quot;Apple&quot;) nor the names of
  15  *     its contributors may be used to endorse or promote products derived
  16  *     from this software without specific prior written permission.
  17  *
  18  * THIS SOFTWARE IS PROVIDED BY APPLE AND ITS CONTRIBUTORS &quot;AS IS&quot; AND ANY
  19  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
  20  * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
  21  * DISCLAIMED. IN NO EVENT SHALL APPLE OR ITS CONTRIBUTORS BE LIABLE FOR ANY
  22  * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
  23  * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
  24  * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
  25  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
  26  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
  27  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
  28  */
  29 
  30 #include &quot;config.h&quot;
  31 #include &quot;TestRunner.h&quot;
  32 
  33 #include &quot;WebCoreTestSupport.h&quot;
  34 #include &quot;WorkQueue.h&quot;
  35 #include &quot;WorkQueueItem.h&quot;
  36 #include &lt;JavaScriptCore/APICast.h&gt;
  37 #include &lt;JavaScriptCore/ArrayBufferView.h&gt;
  38 #include &lt;JavaScriptCore/HeapInlines.h&gt;
  39 #include &lt;JavaScriptCore/JSArrayBufferView.h&gt;
  40 #include &lt;JavaScriptCore/JSCTestRunnerUtils.h&gt;
  41 #include &lt;JavaScriptCore/JSContextRef.h&gt;
  42 #include &lt;JavaScriptCore/JSGlobalObjectInlines.h&gt;
  43 #include &lt;JavaScriptCore/JSObjectRef.h&gt;
  44 #include &lt;JavaScriptCore/JSRetainPtr.h&gt;
  45 #include &lt;JavaScriptCore/TypedArrayInlines.h&gt;
  46 #include &lt;JavaScriptCore/VMInlines.h&gt;
  47 #include &lt;WebCore/LogInitialization.h&gt;
  48 #include &lt;cstring&gt;
  49 #include &lt;locale.h&gt;
  50 #include &lt;stdio.h&gt;
  51 #include &lt;wtf/Assertions.h&gt;
  52 #include &lt;wtf/LoggingAccumulator.h&gt;
  53 #include &lt;wtf/MathExtras.h&gt;
  54 #include &lt;wtf/RefPtr.h&gt;
  55 #include &lt;wtf/RunLoop.h&gt;
  56 #include &lt;wtf/StdLibExtras.h&gt;
  57 #include &lt;wtf/UniqueArray.h&gt;
  58 #include &lt;wtf/WallTime.h&gt;
  59 #include &lt;wtf/text/WTFString.h&gt;
  60 
  61 #if PLATFORM(IOS_FAMILY)
  62 #include &lt;WebCore/WebCoreThreadRun.h&gt;
  63 #include &lt;wtf/BlockPtr.h&gt;
  64 #endif
  65 
  66 #if PLATFORM(MAC) &amp;&amp; !PLATFORM(IOS_FAMILY)
  67 #include &lt;Carbon/Carbon.h&gt;
  68 #endif
  69 
  70 FILE* testResult = stdout;
  71 
  72 const unsigned TestRunner::viewWidth = 800;
  73 const unsigned TestRunner::viewHeight = 600;
  74 
  75 const unsigned TestRunner::w3cSVGViewWidth = 480;
  76 const unsigned TestRunner::w3cSVGViewHeight = 360;
  77 
  78 TestRunner::TestRunner(const std::string&amp; testURL, const std::string&amp; expectedPixelHash)
  79     : m_testURL(testURL)
  80     , m_expectedPixelHash(expectedPixelHash)
  81     , m_titleTextDirection(&quot;ltr&quot;)
  82 {
  83 }
  84 
  85 Ref&lt;TestRunner&gt; TestRunner::create(const std::string&amp; testURL, const std::string&amp; expectedPixelHash)
  86 {
  87     return adoptRef(*new TestRunner(testURL, expectedPixelHash));
  88 }
  89 
  90 // Static Functions
  91 
  92 static JSValueRef disallowIncreaseForApplicationCacheQuotaCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
  93 {
  94     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
  95     controller-&gt;setDisallowIncreaseForApplicationCacheQuota(true);
  96     return JSValueMakeUndefined(context);
  97 }
  98 
  99 static JSValueRef dumpApplicationCacheDelegateCallbacksCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 100 {
 101     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 102     controller-&gt;setDumpApplicationCacheDelegateCallbacks(true);
 103     return JSValueMakeUndefined(context);
 104 }
 105 
 106 static JSValueRef dumpAsPDFCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 107 {
 108     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 109     controller-&gt;setDumpAsPDF(true);
 110     return JSValueMakeUndefined(context);
 111 }
 112 
 113 static JSValueRef setRenderTreeDumpOptionsCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 114 {
 115     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 116 
 117     double options = JSValueToNumber(context, arguments[0], exception);
 118     ASSERT(!*exception);
 119 
 120     controller-&gt;setRenderTreeDumpOptions(static_cast&lt;unsigned&gt;(options));
 121     return JSValueMakeUndefined(context);
 122 }
 123 
 124 static JSValueRef dumpAsTextCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 125 {
 126     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 127     controller-&gt;setDumpAsText(true);
 128 
 129     // Optional paramater, describing whether it&#39;s allowed to dump pixel results in dumpAsText mode.
 130     controller-&gt;setGeneratePixelResults(argumentCount &gt; 0 ? JSValueToBoolean(context, arguments[0]) : false);
 131 
 132     return JSValueMakeUndefined(context);
 133 }
 134 
 135 static JSValueRef dumpBackForwardListCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 136 {
 137     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 138     controller-&gt;setDumpBackForwardList(true);
 139     return JSValueMakeUndefined(context);
 140 }
 141 
 142 static JSValueRef dumpChildFramesAsTextCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 143 {
 144     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 145     controller-&gt;setDumpChildFramesAsText(true);
 146     return JSValueMakeUndefined(context);
 147 }
 148 
 149 static JSValueRef dumpChildFrameScrollPositionsCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 150 {
 151     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 152     controller-&gt;setDumpChildFrameScrollPositions(true);
 153     return JSValueMakeUndefined(context);
 154 }
 155 
 156 static JSValueRef dumpDatabaseCallbacksCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 157 {
 158     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 159     controller-&gt;setDumpDatabaseCallbacks(true);
 160     return JSValueMakeUndefined(context);
 161 }
 162 
 163 static JSValueRef dumpDOMAsWebArchiveCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 164 {
 165     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 166     controller-&gt;setDumpDOMAsWebArchive(true);
 167     return JSValueMakeUndefined(context);
 168 }
 169 
 170 static JSValueRef dumpEditingCallbacksCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 171 {
 172     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 173     controller-&gt;setDumpEditingCallbacks(true);
 174     return JSValueMakeUndefined(context);
 175 }
 176 
 177 static JSValueRef dumpFrameLoadCallbacksCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 178 {
 179     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 180     controller-&gt;setDumpFrameLoadCallbacks(true);
 181     return JSValueMakeUndefined(context);
 182 }
 183 
 184 static JSValueRef dumpProgressFinishedCallbackCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 185 {
 186     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 187     controller-&gt;setDumpProgressFinishedCallback(true);
 188     return JSValueMakeUndefined(context);
 189 }
 190 
 191 static JSValueRef dumpUserGestureInFrameLoadCallbacksCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 192 {
 193     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 194     controller-&gt;setDumpUserGestureInFrameLoadCallbacks(true);
 195     return JSValueMakeUndefined(context);
 196 }
 197 
 198 static JSValueRef dumpResourceLoadCallbacksCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 199 {
 200     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 201     controller-&gt;setDumpResourceLoadCallbacks(true);
 202     return JSValueMakeUndefined(context);
 203 }
 204 
 205 static JSValueRef dumpResourceResponseMIMETypesCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 206 {
 207     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 208     controller-&gt;setDumpResourceResponseMIMETypes(true);
 209     return JSValueMakeUndefined(context);
 210 }
 211 
 212 static JSValueRef dumpSelectionRectCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 213 {
 214     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 215     controller-&gt;setDumpSelectionRect(true);
 216     return JSValueMakeUndefined(context);
 217 }
 218 
 219 static JSValueRef dumpSourceAsWebArchiveCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 220 {
 221     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 222     controller-&gt;setDumpSourceAsWebArchive(true);
 223     return JSValueMakeUndefined(context);
 224 }
 225 
 226 static JSValueRef dumpStatusCallbacksCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 227 {
 228     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 229     controller-&gt;setDumpStatusCallbacks(true);
 230     return JSValueMakeUndefined(context);
 231 }
 232 
 233 static JSValueRef dumpTitleChangesCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 234 {
 235     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 236     controller-&gt;setDumpTitleChanges(true);
 237     return JSValueMakeUndefined(context);
 238 }
 239 
 240 static JSValueRef dumpWillCacheResponseCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 241 {
 242     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 243     controller-&gt;setDumpWillCacheResponse(true);
 244     return JSValueMakeUndefined(context);
 245 }
 246 
 247 static JSValueRef pathToLocalResourceCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 248 {
 249     if (argumentCount &lt; 1)
 250         return JSValueMakeUndefined(context);
 251 
 252     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 253     auto localPath = adopt(JSValueToStringCopy(context, arguments[0], exception));
 254     ASSERT(!*exception);
 255 
 256     auto convertedPath = controller-&gt;pathToLocalResource(context, localPath.get());
 257     if (!convertedPath)
 258         return JSValueMakeUndefined(context);
 259 
 260     return JSValueMakeString(context, convertedPath.get());
 261 }
 262 
 263 static JSValueRef removeAllVisitedLinksCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 264 {
 265     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 266     controller-&gt;setDumpVisitedLinksCallback(true);
 267     controller-&gt;removeAllVisitedLinks();
 268     return JSValueMakeUndefined(context);
 269 }
 270 
 271 static JSValueRef repaintSweepHorizontallyCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 272 {
 273     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 274     controller-&gt;setTestRepaintSweepHorizontally(true);
 275     return JSValueMakeUndefined(context);
 276 }
 277 
 278 static JSValueRef setCallCloseOnWebViewsCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 279 {
 280     if (argumentCount &lt; 1)
 281         return JSValueMakeUndefined(context);
 282 
 283     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 284     controller-&gt;setCallCloseOnWebViews(JSValueToBoolean(context, arguments[0]));
 285     return JSValueMakeUndefined(context);
 286 }
 287 
 288 static JSValueRef setCanOpenWindowsCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 289 {
 290     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 291     controller-&gt;setCanOpenWindows(true);
 292     return JSValueMakeUndefined(context);
 293 }
 294 
 295 static JSValueRef setCloseRemainingWindowsWhenCompleteCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 296 {
 297     if (argumentCount &lt; 1)
 298         return JSValueMakeUndefined(context);
 299 
 300     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 301     controller-&gt;setCloseRemainingWindowsWhenComplete(JSValueToBoolean(context, arguments[0]));
 302     return JSValueMakeUndefined(context);
 303 }
 304 
 305 static JSValueRef setAudioResultCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 306 {
 307     if (argumentCount &lt; 1)
 308         return JSValueMakeUndefined(context);
 309 
 310 #if !PLATFORM(JAVA)
 311     // FIXME (123058): Use a JSC API to get buffer contents once such is exposed.
 312     JSC::VM&amp; vm = toJS(context)-&gt;vm();
 313     JSC::JSLockHolder lock(vm);
 314 
 315     JSC::JSArrayBufferView* jsBufferView = JSC::jsDynamicCast&lt;JSC::JSArrayBufferView*&gt;(vm, toJS(toJS(context), arguments[0]));
 316     ASSERT(jsBufferView);
 317     RefPtr&lt;JSC::ArrayBufferView&gt; bufferView = jsBufferView-&gt;unsharedImpl();
 318     const char* buffer = static_cast&lt;const char*&gt;(bufferView-&gt;baseAddress());
 319     std::vector&lt;char&gt; audioData(buffer, buffer + bufferView-&gt;byteLength());
 320 
 321     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 322     controller-&gt;setAudioResult(audioData);
 323     controller-&gt;setDumpAsAudio(true);
 324 #endif
 325 
 326     return JSValueMakeUndefined(context);
 327 }
 328 
 329 static JSValueRef testOnscreenCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 330 {
 331     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 332     controller-&gt;setTestOnscreen(true);
 333     return JSValueMakeUndefined(context);
 334 }
 335 
 336 static JSValueRef testRepaintCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 337 {
 338     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 339     controller-&gt;setTestRepaint(true);
 340     return JSValueMakeUndefined(context);
 341 }
 342 
 343 static JSValueRef addDisallowedURLCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 344 {
 345     // Has mac implementation
 346     if (argumentCount &lt; 1)
 347         return JSValueMakeUndefined(context);
 348 
 349     auto url = adopt(JSValueToStringCopy(context, arguments[0], exception));
 350     ASSERT(!*exception);
 351 
 352     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 353     controller-&gt;addDisallowedURL(url.get());
 354 
 355     return JSValueMakeUndefined(context);
 356 }
 357 
 358 static JSValueRef addURLToRedirectCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 359 {
 360     if (argumentCount &lt; 2)
 361         return JSValueMakeUndefined(context);
 362 
 363     auto origin = adopt(JSValueToStringCopy(context, arguments[0], exception));
 364     ASSERT(!*exception);
 365 
 366     auto destination = adopt(JSValueToStringCopy(context, arguments[1], exception));
 367     ASSERT(!*exception);
 368 
 369     size_t maxLength = JSStringGetMaximumUTF8CStringSize(origin.get());
 370     auto originBuffer = makeUniqueArray&lt;char&gt;(maxLength + 1);
 371     JSStringGetUTF8CString(origin.get(), originBuffer.get(), maxLength + 1);
 372 
 373     maxLength = JSStringGetMaximumUTF8CStringSize(destination.get());
 374     auto destinationBuffer = makeUniqueArray&lt;char&gt;(maxLength + 1);
 375     JSStringGetUTF8CString(destination.get(), destinationBuffer.get(), maxLength + 1);
 376 
 377     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 378     controller-&gt;addURLToRedirect(originBuffer.get(), destinationBuffer.get());
 379 
 380     return JSValueMakeUndefined(context);
 381 }
 382 
 383 static JSValueRef callShouldCloseOnWebViewCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 384 {
 385     // Has mac &amp; windows implementation
 386     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 387 
 388     return JSValueMakeBoolean(context, controller-&gt;callShouldCloseOnWebView());
 389 }
 390 
 391 static JSValueRef clearAllApplicationCachesCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 392 {
 393     // Has mac implementation
 394     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 395     controller-&gt;clearAllApplicationCaches();
 396 
 397     return JSValueMakeUndefined(context);
 398 }
 399 
 400 static JSValueRef clearApplicationCacheForOriginCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 401 {
 402     if (argumentCount &lt; 1)
 403         return JSValueMakeUndefined(context);
 404 
 405     auto originURL = adopt(JSValueToStringCopy(context, arguments[0], exception));
 406     ASSERT(!*exception);
 407 
 408     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 409     controller-&gt;clearApplicationCacheForOrigin(originURL.get());
 410 
 411     return JSValueMakeUndefined(context);
 412 }
 413 
 414 static JSValueRef applicationCacheDiskUsageForOriginCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 415 {
 416     if (argumentCount &lt; 1)
 417         return JSValueMakeUndefined(context);
 418 
 419     auto originURL = adopt(JSValueToStringCopy(context, arguments[0], exception));
 420     ASSERT(!*exception);
 421 
 422     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 423 
 424     return JSValueMakeNumber(context, controller-&gt;applicationCacheDiskUsageForOrigin(originURL.get()));
 425 }
 426 
 427 static JSValueRef originsWithApplicationCacheCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 428 {
 429     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 430     return controller-&gt;originsWithApplicationCache(context);
 431 }
 432 
 433 static JSValueRef clearAllDatabasesCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 434 {
 435     // Has mac &amp; windows implementation
 436     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 437     controller-&gt;clearAllDatabases();
 438 
 439     return JSValueMakeUndefined(context);
 440 }
 441 
 442 static JSValueRef clearBackForwardListCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 443 {
 444     // Has mac &amp; windows implementation
 445     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 446     controller-&gt;clearBackForwardList();
 447 
 448     return JSValueMakeUndefined(context);
 449 }
 450 
 451 static JSValueRef clearPersistentUserStyleSheetCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 452 {
 453     // Has mac &amp; windows implementation
 454     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 455     controller-&gt;clearPersistentUserStyleSheet();
 456 
 457     return JSValueMakeUndefined(context);
 458 }
 459 
 460 static JSValueRef decodeHostNameCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 461 {
 462     // Has mac implementation
 463     if (argumentCount &lt; 1)
 464         return JSValueMakeUndefined(context);
 465 
 466     auto name = adopt(JSValueToStringCopy(context, arguments[0], exception));
 467     ASSERT(!*exception);
 468 
 469     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 470     auto decodedHostName = controller-&gt;copyDecodedHostName(name.get());
 471     return JSValueMakeString(context, decodedHostName.get());
 472 }
 473 
 474 static JSValueRef dispatchPendingLoadRequestsCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 475 {
 476     // Has mac implementation, needs windows implementation
 477     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 478     controller-&gt;dispatchPendingLoadRequests();
 479 
 480     return JSValueMakeUndefined(context);
 481 }
 482 
 483 static JSValueRef displayCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 484 {
 485     // Has mac &amp; windows implementation
 486     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 487     controller-&gt;display();
 488 
 489     return JSValueMakeUndefined(context);
 490 }
 491 
 492 static JSValueRef displayAndTrackRepaintsCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 493 {
 494     // Has mac &amp; windows implementation
 495     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 496     controller-&gt;displayAndTrackRepaints();
 497 
 498     return JSValueMakeUndefined(context);
 499 }
 500 
 501 static JSValueRef encodeHostNameCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 502 {
 503     // Has mac implementation
 504     if (argumentCount &lt; 1)
 505         return JSValueMakeUndefined(context);
 506 
 507     auto name = adopt(JSValueToStringCopy(context, arguments[0], exception));
 508     ASSERT(!*exception);
 509 
 510     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 511     auto encodedHostName = controller-&gt;copyEncodedHostName(name.get());
 512     return JSValueMakeString(context, encodedHostName.get());
 513 }
 514 
 515 static JSValueRef execCommandCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 516 {
 517     // Has Mac &amp; Windows implementations.
 518     if (argumentCount &lt; 1)
 519         return JSValueMakeUndefined(context);
 520 
 521     auto name = adopt(JSValueToStringCopy(context, arguments[0], exception));
 522     ASSERT(!*exception);
 523 
 524     // Ignoring the second parameter (userInterface), as this command emulates a manual action.
 525 
 526     JSRetainPtr&lt;JSStringRef&gt; value;
 527     if (argumentCount &gt;= 3) {
 528         value = adopt(JSValueToStringCopy(context, arguments[2], exception));
 529         ASSERT(!*exception);
 530     } else
 531         value = adopt(JSStringCreateWithUTF8CString(&quot;&quot;));
 532 
 533 
 534     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 535     controller-&gt;execCommand(name.get(), value.get());
 536 
 537     return JSValueMakeUndefined(context);
 538 }
 539 
 540 static JSValueRef findStringCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 541 {
 542     // Has Mac implementation.
 543     if (argumentCount &lt; 2)
 544         return JSValueMakeUndefined(context);
 545 
 546     auto target = adopt(JSValueToStringCopy(context, arguments[0], exception));
 547     ASSERT(!*exception);
 548 
 549     JSObjectRef options = JSValueToObject(context, arguments[1], exception);
 550     ASSERT(!*exception);
 551 
 552     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 553     return JSValueMakeBoolean(context, controller-&gt;findString(context, target.get(), options));
 554 }
 555 
 556 static JSValueRef goBackCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 557 {
 558     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 559     controller-&gt;goBack();
 560 
 561     return JSValueMakeUndefined(context);
 562 }
 563 
 564 static JSValueRef isCommandEnabledCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 565 {
 566     // Has Mac implementation.
 567 
 568     if (argumentCount &lt; 1)
 569         return JSValueMakeUndefined(context);
 570 
 571     auto name = adopt(JSValueToStringCopy(context, arguments[0], exception));
 572     ASSERT(!*exception);
 573 
 574     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 575 
 576     return JSValueMakeBoolean(context, controller-&gt;isCommandEnabled(name.get()));
 577 }
 578 
 579 static JSValueRef overridePreferenceCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 580 {
 581     if (argumentCount &lt; 2)
 582         return JSValueMakeUndefined(context);
 583 
 584     auto key = adopt(JSValueToStringCopy(context, arguments[0], exception));
 585     ASSERT(!*exception);
 586     auto value = adopt(JSValueToStringCopy(context, arguments[1], exception));
 587     ASSERT(!*exception);
 588 
 589     // Should use `&lt;!-- webkit-test-runner [ enableBackForwardCache=true ] --&gt;` instead.
 590     RELEASE_ASSERT(!JSStringIsEqualToUTF8CString(key.get(), &quot;WebKitUsesBackForwardCachePreferenceKey&quot;));
 591 
 592     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 593     controller-&gt;overridePreference(key.get(), value.get());
 594 
 595     return JSValueMakeUndefined(context);
 596 }
 597 
 598 static JSValueRef keepWebHistoryCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 599 {
 600     // Has mac implementation
 601     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 602     controller-&gt;keepWebHistory();
 603 
 604     return JSValueMakeUndefined(context);
 605 }
 606 
 607 static JSValueRef notifyDoneCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 608 {
 609     // Has mac &amp; windows implementation
 610     // May be able to be made platform independant by using shared WorkQueue
 611     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 612     controller-&gt;notifyDone();
 613     return JSValueMakeUndefined(context);
 614 }
 615 
 616 static JSValueRef numberOfPendingGeolocationPermissionRequestsCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 617 {
 618     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 619     return JSValueMakeNumber(context, controller-&gt;numberOfPendingGeolocationPermissionRequests());
 620 }
 621 
 622 static JSValueRef isGeolocationProviderActiveCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 623 {
 624     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 625     return JSValueMakeBoolean(context, controller-&gt;isGeolocationProviderActive());
 626 }
 627 
 628 static JSValueRef queueBackNavigationCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 629 {
 630     // Has mac &amp; windows implementation
 631     // May be able to be made platform independant by using shared WorkQueue
 632     if (argumentCount &lt; 1)
 633         return JSValueMakeUndefined(context);
 634 
 635     double howFarBackDouble = JSValueToNumber(context, arguments[0], exception);
 636     ASSERT(!*exception);
 637 
 638     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 639     controller-&gt;queueBackNavigation(static_cast&lt;int&gt;(howFarBackDouble));
 640 
 641     return JSValueMakeUndefined(context);
 642 }
 643 
 644 static JSValueRef queueForwardNavigationCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 645 {
 646     // Has mac &amp; windows implementation
 647     // May be able to be made platform independant by using shared WorkQueue
 648     if (argumentCount &lt; 1)
 649         return JSValueMakeUndefined(context);
 650 
 651     double howFarForwardDouble = JSValueToNumber(context, arguments[0], exception);
 652     ASSERT(!*exception);
 653 
 654     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 655     controller-&gt;queueForwardNavigation(static_cast&lt;int&gt;(howFarForwardDouble));
 656 
 657     return JSValueMakeUndefined(context);
 658 }
 659 
 660 static JSValueRef queueLoadCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 661 {
 662     // Has mac &amp; windows implementation
 663     // May be able to be made platform independant by using shared WorkQueue
 664     if (argumentCount &lt; 1)
 665         return JSValueMakeUndefined(context);
 666 
 667     auto url = adopt(JSValueToStringCopy(context, arguments[0], exception));
 668     ASSERT(!*exception);
 669 
 670     JSRetainPtr&lt;JSStringRef&gt; target;
 671     if (argumentCount &gt;= 2) {
 672         target = adopt(JSValueToStringCopy(context, arguments[1], exception));
 673         ASSERT(!*exception);
 674     } else
 675         target = adopt(JSStringCreateWithUTF8CString(&quot;&quot;));
 676 
 677     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 678     controller-&gt;queueLoad(url.get(), target.get());
 679 
 680     return JSValueMakeUndefined(context);
 681 }
 682 
 683 static JSValueRef queueLoadHTMLStringCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 684 {
 685     // Has Mac &amp; Windows implementation
 686     if (argumentCount &lt; 1)
 687         return JSValueMakeUndefined(context);
 688 
 689     auto content = adopt(JSValueToStringCopy(context, arguments[0], exception));
 690     ASSERT(!*exception);
 691 
 692     JSRetainPtr&lt;JSStringRef&gt; baseURL;
 693     if (argumentCount &gt;= 2) {
 694         baseURL = adopt(JSValueToStringCopy(context, arguments[1], exception));
 695         ASSERT(!*exception);
 696     } else
 697         baseURL = adopt(JSStringCreateWithUTF8CString(&quot;&quot;));
 698 
 699     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 700 
 701     if (argumentCount &gt;= 3) {
 702         auto unreachableURL = adopt(JSValueToStringCopy(context, arguments[2], exception));
 703         ASSERT(!*exception);
 704         controller-&gt;queueLoadAlternateHTMLString(content.get(), baseURL.get(), unreachableURL.get());
 705         return JSValueMakeUndefined(context);
 706     }
 707 
 708     controller-&gt;queueLoadHTMLString(content.get(), baseURL.get());
 709     return JSValueMakeUndefined(context);
 710 }
 711 
 712 static JSValueRef queueReloadCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 713 {
 714     // Has mac &amp; windows implementation
 715     // May be able to be made platform independant by using shared WorkQueue
 716 
 717     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 718     controller-&gt;queueReload();
 719 
 720     return JSValueMakeUndefined(context);
 721 }
 722 
 723 static JSValueRef queueLoadingScriptCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 724 {
 725     // Has mac &amp; windows implementation
 726     // May be able to be made platform independant by using shared WorkQueue
 727     if (argumentCount &lt; 1)
 728         return JSValueMakeUndefined(context);
 729 
 730     auto script = adopt(JSValueToStringCopy(context, arguments[0], exception));
 731     ASSERT(!*exception);
 732 
 733     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 734     controller-&gt;queueLoadingScript(script.get());
 735 
 736     return JSValueMakeUndefined(context);
 737 }
 738 
 739 static JSValueRef queueNonLoadingScriptCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 740 {
 741     // Has mac &amp; windows implementation
 742     // May be able to be made platform independant by using shared WorkQueue
 743     if (argumentCount &lt; 1)
 744         return JSValueMakeUndefined(context);
 745 
 746     auto script = adopt(JSValueToStringCopy(context, arguments[0], exception));
 747     ASSERT(!*exception);
 748 
 749     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 750     controller-&gt;queueNonLoadingScript(script.get());
 751 
 752     return JSValueMakeUndefined(context);
 753 }
 754 
 755 static JSValueRef setAcceptsEditingCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 756 {
 757     // Has mac &amp; windows implementation
 758     if (argumentCount &lt; 1)
 759         return JSValueMakeUndefined(context);
 760 
 761     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 762     controller-&gt;setAcceptsEditing(JSValueToBoolean(context, arguments[0]));
 763 
 764     return JSValueMakeUndefined(context);
 765 }
 766 
 767 static JSValueRef setAlwaysAcceptCookiesCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 768 {
 769     // Has mac &amp; windows implementation
 770     if (argumentCount &lt; 1)
 771         return JSValueMakeUndefined(context);
 772 
 773     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 774     controller-&gt;setAlwaysAcceptCookies(JSValueToBoolean(context, arguments[0]));
 775 
 776     return JSValueMakeUndefined(context);
 777 }
 778 
 779 static JSValueRef setOnlyAcceptFirstPartyCookiesCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 780 {
 781     if (argumentCount &lt; 1)
 782         return JSValueMakeUndefined(context);
 783 
 784     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 785     controller-&gt;setOnlyAcceptFirstPartyCookies(JSValueToBoolean(context, arguments[0]));
 786 
 787     return JSValueMakeUndefined(context);
 788 }
 789 
 790 static JSValueRef setAppCacheMaximumSizeCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 791 {
 792     // Has mac implementation
 793     if (argumentCount &lt; 1)
 794         return JSValueMakeUndefined(context);
 795 
 796     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 797 
 798     double size = JSValueToNumber(context, arguments[0], NULL);
 799     if (!std::isnan(size))
 800         controller-&gt;setAppCacheMaximumSize(static_cast&lt;unsigned long long&gt;(size));
 801 
 802     return JSValueMakeUndefined(context);
 803 }
 804 
 805 static JSValueRef setAuthenticationPasswordCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 806 {
 807     // Has mac &amp; windows implementation
 808     if (argumentCount &lt; 1)
 809         return JSValueMakeUndefined(context);
 810 
 811     auto password = adopt(JSValueToStringCopy(context, arguments[0], exception));
 812     ASSERT(!*exception);
 813 
 814     size_t maxLength = JSStringGetMaximumUTF8CStringSize(password.get());
 815     char* passwordBuffer = new char[maxLength + 1];
 816     JSStringGetUTF8CString(password.get(), passwordBuffer, maxLength + 1);
 817 
 818     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 819     controller-&gt;setAuthenticationPassword(passwordBuffer);
 820     delete[] passwordBuffer;
 821 
 822     return JSValueMakeUndefined(context);
 823 }
 824 
 825 static JSValueRef setAuthenticationUsernameCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 826 {
 827     // Has mac &amp; windows implementation
 828     if (argumentCount &lt; 1)
 829         return JSValueMakeUndefined(context);
 830 
 831     auto username = adopt(JSValueToStringCopy(context, arguments[0], exception));
 832     ASSERT(!*exception);
 833 
 834     size_t maxLength = JSStringGetMaximumUTF8CStringSize(username.get());
 835     char* usernameBuffer = new char[maxLength + 1];
 836     JSStringGetUTF8CString(username.get(), usernameBuffer, maxLength + 1);
 837 
 838     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 839     controller-&gt;setAuthenticationUsername(usernameBuffer);
 840     delete[] usernameBuffer;
 841 
 842     return JSValueMakeUndefined(context);
 843 }
 844 
 845 static JSValueRef setAuthorAndUserStylesEnabledCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 846 {
 847     // Has mac &amp; windows implementation
 848     if (argumentCount &lt; 1)
 849         return JSValueMakeUndefined(context);
 850 
 851     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 852     controller-&gt;setAuthorAndUserStylesEnabled(JSValueToBoolean(context, arguments[0]));
 853 
 854     return JSValueMakeUndefined(context);
 855 }
 856 
 857 static JSValueRef setCacheModelCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 858 {
 859     // Has Mac implementation.
 860     if (argumentCount &lt; 1)
 861         return JSValueMakeUndefined(context);
 862 
 863     int cacheModel = JSValueToNumber(context, arguments[0], exception);
 864     ASSERT(!*exception);
 865 
 866     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 867     controller-&gt;setCacheModel(cacheModel);
 868 
 869     return JSValueMakeUndefined(context);
 870 }
 871 
 872 static JSValueRef setCustomPolicyDelegateCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 873 {
 874     // Has mac implementation
 875     if (argumentCount &lt; 1)
 876         return JSValueMakeUndefined(context);
 877 
 878     bool permissive = false;
 879     if (argumentCount &gt;= 2)
 880         permissive = JSValueToBoolean(context, arguments[1]);
 881 
 882     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 883     controller-&gt;setCustomPolicyDelegate(JSValueToBoolean(context, arguments[0]), permissive);
 884 
 885     return JSValueMakeUndefined(context);
 886 }
 887 
 888 static JSValueRef setDatabaseQuotaCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 889 {
 890     // Has mac implementation
 891     if (argumentCount &lt; 1)
 892         return JSValueMakeUndefined(context);
 893 
 894     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 895 
 896     double quota = JSValueToNumber(context, arguments[0], NULL);
 897     if (!std::isnan(quota))
 898         controller-&gt;setDatabaseQuota(static_cast&lt;unsigned long long&gt;(quota));
 899 
 900     return JSValueMakeUndefined(context);
 901 }
 902 
 903 static JSValueRef setDefersLoadingCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 904 {
 905     if (argumentCount &lt; 1)
 906         return JSValueMakeUndefined(context);
 907 
 908     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 909     controller-&gt;setDefersLoading(JSValueToBoolean(context, arguments[0]));
 910 
 911     return JSValueMakeUndefined(context);
 912 }
 913 
 914 static JSValueRef setUseDeferredFrameLoadingCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 915 {
 916     if (argumentCount &lt; 1)
 917         return JSValueMakeUndefined(context);
 918 
 919     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 920     controller-&gt;setUseDeferredFrameLoading(JSValueToBoolean(context, arguments[0]));
 921 
 922     return JSValueMakeUndefined(context);
 923 }
 924 
 925 static JSValueRef setDomainRelaxationForbiddenForURLSchemeCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 926 {
 927     // Has Mac and Windows implementation
 928     if (argumentCount &lt; 2)
 929         return JSValueMakeUndefined(context);
 930 
 931     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 932 
 933     bool forbidden = JSValueToBoolean(context, arguments[0]);
 934     auto scheme = adopt(JSValueToStringCopy(context, arguments[1], 0));
 935     controller-&gt;setDomainRelaxationForbiddenForURLScheme(forbidden, scheme.get());
 936 
 937     return JSValueMakeUndefined(context);
 938 }
 939 
 940 static JSValueRef setMockDeviceOrientationCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 941 {
 942     if (argumentCount &lt; 6)
 943         return JSValueMakeUndefined(context);
 944 
 945     bool canProvideAlpha = JSValueToBoolean(context, arguments[0]);
 946     double alpha = JSValueToNumber(context, arguments[1], exception);
 947     ASSERT(!*exception);
 948     bool canProvideBeta = JSValueToBoolean(context, arguments[2]);
 949     double beta = JSValueToNumber(context, arguments[3], exception);
 950     ASSERT(!*exception);
 951     bool canProvideGamma = JSValueToBoolean(context, arguments[4]);
 952     double gamma = JSValueToNumber(context, arguments[5], exception);
 953     ASSERT(!*exception);
 954 
 955     TestRunner* controller = reinterpret_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 956     controller-&gt;setMockDeviceOrientation(canProvideAlpha, alpha, canProvideBeta, beta, canProvideGamma, gamma);
 957 
 958     return JSValueMakeUndefined(context);
 959 }
 960 
 961 static JSValueRef setMockGeolocationPositionCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 962 {
 963     if (argumentCount &lt; 3)
 964         return JSValueMakeUndefined(context);
 965 
 966     double latitude = JSValueToNumber(context, arguments[0], 0);
 967     double longitude = JSValueToNumber(context, arguments[1], 0);
 968     double accuracy = JSValueToNumber(context, arguments[2], 0);
 969 
 970     bool canProvideAltitude = false;
 971     double altitude = 0.;
 972     if (argumentCount &gt; 3 &amp;&amp; !JSValueIsUndefined(context, arguments[3])) {
 973         canProvideAltitude = true;
 974         altitude = JSValueToNumber(context, arguments[3], 0);
 975     }
 976 
 977     bool canProvideAltitudeAccuracy = false;
 978     double altitudeAccuracy = 0.;
 979     if (argumentCount &gt; 4 &amp;&amp; !JSValueIsUndefined(context, arguments[4])) {
 980         canProvideAltitudeAccuracy = true;
 981         altitudeAccuracy = JSValueToNumber(context, arguments[4], 0);
 982     }
 983 
 984     bool canProvideHeading = false;
 985     double heading = 0.;
 986     if (argumentCount &gt; 5 &amp;&amp; !JSValueIsUndefined(context, arguments[5])) {
 987         canProvideHeading = true;
 988         heading = JSValueToNumber(context, arguments[5], 0);
 989     }
 990 
 991     bool canProvideSpeed = false;
 992     double speed = 0.;
 993     if (argumentCount &gt; 6 &amp;&amp; !JSValueIsUndefined(context, arguments[6])) {
 994         canProvideSpeed = true;
 995         speed = JSValueToNumber(context, arguments[6], 0);
 996     }
 997 
 998     bool canProvideFloorLevel = false;
 999     double floorLevel = 0.;
1000     if (argumentCount &gt; 7 &amp;&amp; !JSValueIsUndefined(context, arguments[7])) {
1001         canProvideFloorLevel = true;
1002         floorLevel = JSValueToNumber(context, arguments[7], 0);
1003     }
1004 
1005     TestRunner* controller = reinterpret_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1006     controller-&gt;setMockGeolocationPosition(latitude, longitude, accuracy, canProvideAltitude, altitude, canProvideAltitudeAccuracy, altitudeAccuracy, canProvideHeading, heading, canProvideSpeed, speed, canProvideFloorLevel, floorLevel);
1007 
1008     return JSValueMakeUndefined(context);
1009 }
1010 
1011 static JSValueRef setMockGeolocationPositionUnavailableErrorCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1012 {
1013     if (argumentCount != 1)
1014         return JSValueMakeUndefined(context);
1015 
1016     auto message = adopt(JSValueToStringCopy(context, arguments[0], exception));
1017     ASSERT(!*exception);
1018 
1019     TestRunner* controller = reinterpret_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1020     controller-&gt;setMockGeolocationPositionUnavailableError(message.get());
1021 
1022     return JSValueMakeUndefined(context);
1023 }
1024 
1025 static JSValueRef setNewWindowsCopyBackForwardListCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1026 {
1027     // Has mac implementation
1028     if (argumentCount &lt; 1)
1029         return JSValueMakeUndefined(context);
1030 
1031     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1032     controller-&gt;setNewWindowsCopyBackForwardList(JSValueToBoolean(context, arguments[0]));
1033 
1034     return JSValueMakeUndefined(context);
1035 }
1036 
1037 static JSValueRef setGeolocationPermissionCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1038 {
1039     // Has mac implementation
1040     if (argumentCount &lt; 1)
1041         return JSValueMakeUndefined(context);
1042 
1043     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1044     controller-&gt;setGeolocationPermission(JSValueToBoolean(context, arguments[0]));
1045 
1046     return JSValueMakeUndefined(context);
1047 }
1048 
1049 static JSValueRef setRejectsProtectionSpaceAndContinueForAuthenticationChallengesCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1050 {
1051     // Has mac &amp; windows implementation
1052     if (argumentCount &lt; 1)
1053         return JSValueMakeUndefined(context);
1054 
1055     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1056     controller-&gt;setRejectsProtectionSpaceAndContinueForAuthenticationChallenges(JSValueToBoolean(context, arguments[0]));
1057 
1058     return JSValueMakeUndefined(context);
1059 }
1060 
1061 static JSValueRef setHandlesAuthenticationChallengesCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1062 {
1063     // Has mac &amp; windows implementation
1064     if (argumentCount &lt; 1)
1065         return JSValueMakeUndefined(context);
1066 
1067     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1068     controller-&gt;setHandlesAuthenticationChallenges(JSValueToBoolean(context, arguments[0]));
1069 
1070     return JSValueMakeUndefined(context);
1071 }
1072 
1073 static JSValueRef setPOSIXLocaleCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1074 {
1075     if (argumentCount &lt; 1)
1076         return JSValueMakeUndefined(context);
1077 
1078     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1079     auto locale = adopt(JSValueToStringCopy(context, arguments[0], exception));
1080     ASSERT(!*exception);
1081     controller-&gt;setPOSIXLocale(locale.get());
1082 
1083     return JSValueMakeUndefined(context);
1084 }
1085 
1086 static JSValueRef setIconDatabaseEnabledCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1087 {
1088     // Has mac &amp; windows implementation
1089     if (argumentCount &lt; 1)
1090         return JSValueMakeUndefined(context);
1091 
1092     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1093     controller-&gt;setIconDatabaseEnabled(JSValueToBoolean(context, arguments[0]));
1094 
1095     return JSValueMakeUndefined(context);
1096 }
1097 
1098 static JSValueRef setMainFrameIsFirstResponderCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1099 {
1100     // Has mac implementation
1101     if (argumentCount &lt; 1)
1102         return JSValueMakeUndefined(context);
1103 
1104     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1105     controller-&gt;setMainFrameIsFirstResponder(JSValueToBoolean(context, arguments[0]));
1106 
1107     return JSValueMakeUndefined(context);
1108 }
1109 
1110 static JSValueRef setPersistentUserStyleSheetLocationCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1111 {
1112     // Has mac implementation
1113     if (argumentCount &lt; 1)
1114         return JSValueMakeUndefined(context);
1115 
1116     auto path = adopt(JSValueToStringCopy(context, arguments[0], exception));
1117     ASSERT(!*exception);
1118 
1119     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1120     controller-&gt;setPersistentUserStyleSheetLocation(path.get());
1121 
1122     return JSValueMakeUndefined(context);
1123 }
1124 
1125 static JSValueRef setPrivateBrowsingEnabledCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1126 {
1127     // Has mac &amp; windows implementation
1128     if (argumentCount &lt; 1)
1129         return JSValueMakeUndefined(context);
1130 
1131     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1132     controller-&gt;setPrivateBrowsingEnabled(JSValueToBoolean(context, arguments[0]));
1133 
1134     return JSValueMakeUndefined(context);
1135 }
1136 
1137 static JSValueRef setShouldSwapToEphemeralSessionOnNextNavigationCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1138 {
1139     // Has mac &amp; windows implementation
1140     if (argumentCount &lt; 1)
1141         return JSValueMakeUndefined(context);
1142 
1143     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1144     controller-&gt;setShouldSwapToEphemeralSessionOnNextNavigation(JSValueToBoolean(context, arguments[0]));
1145 
1146     return JSValueMakeUndefined(context);
1147 }
1148 
1149 static JSValueRef setShouldSwapToDefaultSessionOnNextNavigationCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1150 {
1151     // Has mac &amp; windows implementation
1152     if (argumentCount &lt; 1)
1153         return JSValueMakeUndefined(context);
1154 
1155     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1156     controller-&gt;setShouldSwapToDefaultSessionOnNextNavigation(JSValueToBoolean(context, arguments[0]));
1157 
1158     return JSValueMakeUndefined(context);
1159 }
1160 
1161 static JSValueRef setJavaScriptCanAccessClipboardCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1162 {
1163     // Has mac &amp; windows implementation
1164     if (argumentCount &lt; 1)
1165         return JSValueMakeUndefined(context);
1166 
1167     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1168     controller-&gt;setJavaScriptCanAccessClipboard(JSValueToBoolean(context, arguments[0]));
1169 
1170     return JSValueMakeUndefined(context);
1171 }
1172 
1173 static JSValueRef setXSSAuditorEnabledCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1174 {
1175     // Has mac &amp; windows implementation
1176     if (argumentCount &lt; 1)
1177         return JSValueMakeUndefined(context);
1178 
1179     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1180     controller-&gt;setXSSAuditorEnabled(JSValueToBoolean(context, arguments[0]));
1181 
1182     return JSValueMakeUndefined(context);
1183 }
1184 
1185 static JSValueRef setSpatialNavigationEnabledCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1186 {
1187     // Has mac &amp; windows implementation.
1188     if (argumentCount &lt; 1)
1189         return JSValueMakeUndefined(context);
1190 
1191     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1192     controller-&gt;setSpatialNavigationEnabled(JSValueToBoolean(context, arguments[0]));
1193 
1194     return JSValueMakeUndefined(context);
1195 }
1196 
1197 static JSValueRef setPrintingCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1198 {
1199     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1200     controller-&gt;setIsPrinting(true);
1201     return JSValueMakeUndefined(context);
1202 }
1203 
1204 static JSValueRef setAllowsAnySSLCertificateCallback(JSContextRef context, JSObjectRef, JSObjectRef, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1205 {
1206     bool allowAnyCertificate = false;
1207     if (argumentCount == 1)
1208         allowAnyCertificate = JSValueToBoolean(context, arguments[0]);
1209 
1210     TestRunner::setAllowsAnySSLCertificate(allowAnyCertificate);
1211     return JSValueMakeUndefined(context);
1212 }
1213 
1214 static JSValueRef setAllowUniversalAccessFromFileURLsCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1215 {
1216     // Has mac &amp; windows implementation
1217     if (argumentCount &lt; 1)
1218         return JSValueMakeUndefined(context);
1219 
1220     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1221     controller-&gt;setAllowUniversalAccessFromFileURLs(JSValueToBoolean(context, arguments[0]));
1222 
1223     return JSValueMakeUndefined(context);
1224 }
1225 
1226 static JSValueRef setAllowFileAccessFromFileURLsCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1227 {
1228     // Has mac &amp; windows implementation
1229     if (argumentCount &lt; 1)
1230         return JSValueMakeUndefined(context);
1231 
1232     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1233     controller-&gt;setAllowFileAccessFromFileURLs(JSValueToBoolean(context, arguments[0]));
1234 
1235     return JSValueMakeUndefined(context);
1236 }
1237 
1238 static JSValueRef setNeedsStorageAccessFromFileURLsQuirkCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1239 {
1240     // Has mac &amp; windows implementation
1241     if (argumentCount &lt; 1)
1242         return JSValueMakeUndefined(context);
1243 
1244     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1245     controller-&gt;setNeedsStorageAccessFromFileURLsQuirk(JSValueToBoolean(context, arguments[0]));
1246 
1247     return JSValueMakeUndefined(context);
1248 }
1249 
1250 static JSValueRef setTabKeyCyclesThroughElementsCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1251 {
1252     // Has mac &amp; windows implementation
1253     if (argumentCount &lt; 1)
1254         return JSValueMakeUndefined(context);
1255 
1256     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1257     controller-&gt;setTabKeyCyclesThroughElements(JSValueToBoolean(context, arguments[0]));
1258 
1259     return JSValueMakeUndefined(context);
1260 }
1261 
1262 #if PLATFORM(IOS_FAMILY)
1263 static JSValueRef setTelephoneNumberParsingEnabledCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1264 {
1265     if (argumentCount &lt; 1)
1266         return JSValueMakeUndefined(context);
1267 
1268     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1269     controller-&gt;setTelephoneNumberParsingEnabled(JSValueToBoolean(context, arguments[0]));
1270 
1271     return JSValueMakeUndefined(context);
1272 }
1273 
1274 static JSValueRef setPagePausedCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1275 {
1276     if (argumentCount &lt; 1)
1277         return JSValueMakeUndefined(context);
1278 
1279     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1280     controller-&gt;setPagePaused(JSValueToBoolean(context, arguments[0]));
1281 
1282     return JSValueMakeUndefined(context);
1283 }
1284 #endif
1285 
1286 static JSValueRef setUserStyleSheetEnabledCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1287 {
1288     // Has mac implementation
1289     if (argumentCount &lt; 1)
1290         return JSValueMakeUndefined(context);
1291 
1292     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1293     controller-&gt;setUserStyleSheetEnabled(JSValueToBoolean(context, arguments[0]));
1294 
1295     return JSValueMakeUndefined(context);
1296 }
1297 
1298 static JSValueRef setUserStyleSheetLocationCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1299 {
1300     // Has mac implementation
1301     if (argumentCount &lt; 1)
1302         return JSValueMakeUndefined(context);
1303 
1304     auto path = adopt(JSValueToStringCopy(context, arguments[0], exception));
1305     ASSERT(!*exception);
1306 
1307     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1308     controller-&gt;setUserStyleSheetLocation(path.get());
1309 
1310     return JSValueMakeUndefined(context);
1311 }
1312 
1313 static JSValueRef setValueForUserCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1314 {
1315     // Has mac implementation
1316     if (argumentCount != 2)
1317         return JSValueMakeUndefined(context);
1318 
1319     auto value = adopt(JSValueToStringCopy(context, arguments[1], exception));
1320     ASSERT(!*exception);
1321 
1322     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1323     controller-&gt;setValueForUser(context, arguments[0], value.get());
1324 
1325     return JSValueMakeUndefined(context);
1326 }
1327 
1328 static JSValueRef setWillSendRequestClearHeaderCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1329 {
1330     // Has mac &amp; windows implementation
1331     if (argumentCount &lt; 1)
1332         return JSValueMakeUndefined(context);
1333 
1334     auto header = adopt(JSValueToStringCopy(context, arguments[0], exception));
1335     ASSERT(!*exception);
1336 
1337     size_t maxLength = JSStringGetMaximumUTF8CStringSize(header.get());
1338     auto headerBuffer = makeUniqueArray&lt;char&gt;(maxLength + 1);
1339     JSStringGetUTF8CString(header.get(), headerBuffer.get(), maxLength + 1);
1340 
1341     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1342     controller-&gt;setWillSendRequestClearHeader(headerBuffer.get());
1343 
1344     return JSValueMakeUndefined(context);
1345 }
1346 
1347 static JSValueRef setWillSendRequestReturnsNullCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1348 {
1349     // Has cross-platform implementation
1350     if (argumentCount &lt; 1)
1351         return JSValueMakeUndefined(context);
1352 
1353     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1354     controller-&gt;setWillSendRequestReturnsNull(JSValueToBoolean(context, arguments[0]));
1355 
1356     return JSValueMakeUndefined(context);
1357 }
1358 
1359 static JSValueRef setWillSendRequestReturnsNullOnRedirectCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1360 {
1361     // Has cross-platform implementation
1362     if (argumentCount &lt; 1)
1363         return JSValueMakeUndefined(context);
1364 
1365     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1366     controller-&gt;setWillSendRequestReturnsNullOnRedirect(JSValueToBoolean(context, arguments[0]));
1367 
1368     return JSValueMakeUndefined(context);
1369 }
1370 
1371 static JSValueRef setWindowIsKeyCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1372 {
1373     // Has mac implementation
1374     if (argumentCount &lt; 1)
1375         return JSValueMakeUndefined(context);
1376 
1377     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1378     controller-&gt;setWindowIsKey(JSValueToBoolean(context, arguments[0]));
1379 
1380     return JSValueMakeUndefined(context);
1381 }
1382 
1383 static JSValueRef setViewSizeCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1384 {
1385     if (argumentCount &lt; 2)
1386         return JSValueMakeUndefined(context);
1387 
1388     double width = JSValueToNumber(context, arguments[0], exception);
1389     ASSERT(!*exception);
1390     double height = JSValueToNumber(context, arguments[1], exception);
1391     ASSERT(!*exception);
1392 
1393     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1394     controller-&gt;setViewSize(width, height);
1395 
1396     return JSValueMakeUndefined(context);
1397 }
1398 
1399 static JSValueRef waitUntilDoneCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1400 {
1401     // Has mac &amp; windows implementation
1402     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1403     controller-&gt;setWaitToDump(true);
1404 
1405     return JSValueMakeUndefined(context);
1406 }
1407 
1408 static JSValueRef windowCountCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1409 {
1410     // Has mac implementation
1411     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1412     int windows = controller-&gt;windowCount();
1413     return JSValueMakeNumber(context, windows);
1414 }
1415 
1416 static JSValueRef setPopupBlockingEnabledCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1417 {
1418     // Has mac &amp; windows implementation
1419     if (argumentCount &lt; 1)
1420         return JSValueMakeUndefined(context);
1421 
1422     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1423     controller-&gt;setPopupBlockingEnabled(JSValueToBoolean(context, arguments[0]));
1424 
1425     return JSValueMakeUndefined(context);
1426 }
1427 
1428 static JSValueRef setPluginsEnabledCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1429 {
1430     // Has mac &amp; windows implementation
1431     if (argumentCount &lt; 1)
1432         return JSValueMakeUndefined(context);
1433 
1434     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1435     controller-&gt;setPluginsEnabled(JSValueToBoolean(context, arguments[0]));
1436 
1437     return JSValueMakeUndefined(context);
1438 }
1439 
1440 static JSValueRef setPageVisibilityCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1441 {
1442     // Has mac &amp; windows implementation
1443     if (argumentCount &lt; 1)
1444         return JSValueMakeUndefined(context);
1445 
1446     auto visibility = adopt(JSValueToStringCopy(context, arguments[0], exception));
1447     ASSERT(!*exception);
1448 
1449     size_t maxLength = JSStringGetMaximumUTF8CStringSize(visibility.get());
1450     char* visibilityBuffer = new char[maxLength + 1];
1451     JSStringGetUTF8CString(visibility.get(), visibilityBuffer, maxLength + 1);
1452 
1453     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1454     controller-&gt;setPageVisibility(visibilityBuffer);
1455     delete[] visibilityBuffer;
1456 
1457     return JSValueMakeUndefined(context);
1458 }
1459 
1460 static JSValueRef resetPageVisibilityCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1461 {
1462     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1463     controller-&gt;resetPageVisibility();
1464     return JSValueMakeUndefined(context);
1465 }
1466 
1467 static JSValueRef setAutomaticLinkDetectionEnabledCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1468 {
1469     if (argumentCount &lt; 1)
1470         return JSValueMakeUndefined(context);
1471 
1472     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1473     controller-&gt;setAutomaticLinkDetectionEnabled(JSValueToBoolean(context, arguments[0]));
1474     return JSValueMakeUndefined(context);
1475 }
1476 
1477 static JSValueRef setStopProvisionalFrameLoadsCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1478 {
1479     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1480     controller-&gt;setStopProvisionalFrameLoads(true);
1481     return JSValueMakeUndefined(context);
1482 }
1483 
1484 static JSValueRef showWebInspectorCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1485 {
1486     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1487     controller-&gt;showWebInspector();
1488     return JSValueMakeUndefined(context);
1489 }
1490 
1491 static JSValueRef closeWebInspectorCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1492 {
1493     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1494     controller-&gt;closeWebInspector();
1495     return JSValueMakeUndefined(context);
1496 }
1497 
1498 static JSValueRef evaluateInWebInspectorCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1499 {
1500     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1501     auto script = adopt(JSValueToStringCopy(context, arguments[0], exception));
1502     ASSERT(!*exception);
1503 
1504     controller-&gt;evaluateInWebInspector(script.get());
1505     return JSValueMakeUndefined(context);
1506 }
1507 
1508 static JSValueRef evaluateScriptInIsolatedWorldCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1509 {
1510     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1511     double worldID = JSValueToNumber(context, arguments[0], exception);
1512     ASSERT(!*exception);
1513     auto script = adopt(JSValueToStringCopy(context, arguments[1], exception));
1514     ASSERT(!*exception);
1515 
1516     controller-&gt;evaluateScriptInIsolatedWorld(static_cast&lt;unsigned&gt;(worldID), JSContextGetGlobalObject(context), script.get());
1517     return JSValueMakeUndefined(context);
1518 }
1519 
1520 static JSValueRef evaluateScriptInIsolatedWorldAndReturnValueCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1521 {
1522     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1523     double worldID = JSValueToNumber(context, arguments[0], exception);
1524     ASSERT(!*exception);
1525     auto script = adopt(JSValueToStringCopy(context, arguments[1], exception));
1526     ASSERT(!*exception);
1527 
1528     controller-&gt;evaluateScriptInIsolatedWorldAndReturnValue(static_cast&lt;unsigned&gt;(worldID), JSContextGetGlobalObject(context), script.get());
1529     return JSValueMakeUndefined(context);
1530 }
1531 
1532 static JSValueRef waitForPolicyDelegateCallback(JSContextRef context, JSObjectRef, JSObjectRef thisObject, size_t, const JSValueRef[], JSValueRef*)
1533 {
1534     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1535     controller-&gt;waitForPolicyDelegate();
1536     return JSValueMakeUndefined(context);
1537 }
1538 
1539 static JSValueRef addOriginAccessWhitelistEntryCallback(JSContextRef context, JSObjectRef, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1540 {
1541     if (argumentCount != 4)
1542         return JSValueMakeUndefined(context);
1543 
1544     auto sourceOrigin = adopt(JSValueToStringCopy(context, arguments[0], exception));
1545     ASSERT(!*exception);
1546     auto destinationProtocol = adopt(JSValueToStringCopy(context, arguments[1], exception));
1547     ASSERT(!*exception);
1548     auto destinationHost = adopt(JSValueToStringCopy(context, arguments[2], exception));
1549     ASSERT(!*exception);
1550     bool allowDestinationSubdomains = JSValueToBoolean(context, arguments[3]);
1551 
1552     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1553     controller-&gt;addOriginAccessWhitelistEntry(sourceOrigin.get(), destinationProtocol.get(), destinationHost.get(), allowDestinationSubdomains);
1554     return JSValueMakeUndefined(context);
1555 }
1556 
1557 static JSValueRef removeOriginAccessWhitelistEntryCallback(JSContextRef context, JSObjectRef, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1558 {
1559     if (argumentCount != 4)
1560         return JSValueMakeUndefined(context);
1561 
1562     auto sourceOrigin = adopt(JSValueToStringCopy(context, arguments[0], exception));
1563     ASSERT(!*exception);
1564     auto destinationProtocol = adopt(JSValueToStringCopy(context, arguments[1], exception));
1565     ASSERT(!*exception);
1566     auto destinationHost = adopt(JSValueToStringCopy(context, arguments[2], exception));
1567     ASSERT(!*exception);
1568     bool allowDestinationSubdomains = JSValueToBoolean(context, arguments[3]);
1569 
1570     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1571     controller-&gt;removeOriginAccessWhitelistEntry(sourceOrigin.get(), destinationProtocol.get(), destinationHost.get(), allowDestinationSubdomains);
1572     return JSValueMakeUndefined(context);
1573 }
1574 
1575 static JSValueRef setScrollbarPolicyCallback(JSContextRef context, JSObjectRef, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1576 {
1577     if (argumentCount != 2)
1578         return JSValueMakeUndefined(context);
1579 
1580     auto orientation = adopt(JSValueToStringCopy(context, arguments[0], exception));
1581     ASSERT(!*exception);
1582     auto policy = adopt(JSValueToStringCopy(context, arguments[1], exception));
1583     ASSERT(!*exception);
1584 
1585     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1586     controller-&gt;setScrollbarPolicy(orientation.get(), policy.get());
1587     return JSValueMakeUndefined(context);
1588 }
1589 
1590 static JSValueRef addUserScriptCallback(JSContextRef context, JSObjectRef, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1591 {
1592     if (argumentCount != 3)
1593         return JSValueMakeUndefined(context);
1594 
1595     auto source = adopt(JSValueToStringCopy(context, arguments[0], exception));
1596     ASSERT(!*exception);
1597     bool runAtStart = JSValueToBoolean(context, arguments[1]);
1598     bool allFrames = JSValueToBoolean(context, arguments[2]);
1599 
1600     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1601     controller-&gt;addUserScript(source.get(), runAtStart, allFrames);
1602     return JSValueMakeUndefined(context);
1603 }
1604 
1605 static JSValueRef addUserStyleSheetCallback(JSContextRef context, JSObjectRef, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1606 {
1607     if (argumentCount != 2)
1608         return JSValueMakeUndefined(context);
1609 
1610     auto source = adopt(JSValueToStringCopy(context, arguments[0], exception));
1611     ASSERT(!*exception);
1612     bool allFrames = JSValueToBoolean(context, arguments[1]);
1613 
1614     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1615     controller-&gt;addUserStyleSheet(source.get(), allFrames);
1616     return JSValueMakeUndefined(context);
1617 }
1618 
1619 static JSValueRef setShouldPaintBrokenImageCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1620 {
1621     // Has Mac implementation
1622     if (argumentCount &lt; 1)
1623         return JSValueMakeUndefined(context);
1624 
1625     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1626     controller-&gt;setShouldPaintBrokenImage(JSValueToBoolean(context, arguments[0]));
1627 
1628     return JSValueMakeUndefined(context);
1629 }
1630 
1631 static JSValueRef apiTestNewWindowDataLoadBaseURLCallback(JSContextRef context, JSObjectRef, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1632 {
1633     if (argumentCount != 2)
1634         return JSValueMakeUndefined(context);
1635 
1636     auto utf8Data = adopt(JSValueToStringCopy(context, arguments[0], exception));
1637     ASSERT(!*exception);
1638 
1639     auto baseURL = adopt(JSValueToStringCopy(context, arguments[1], exception));
1640     ASSERT(!*exception);
1641 
1642     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1643     controller-&gt;apiTestNewWindowDataLoadBaseURL(utf8Data.get(), baseURL.get());
1644     return JSValueMakeUndefined(context);
1645 }
1646 
1647 static JSValueRef apiTestGoToCurrentBackForwardItemCallback(JSContextRef context, JSObjectRef, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1648 {
1649     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1650     controller-&gt;apiTestGoToCurrentBackForwardItem();
1651     return JSValueMakeUndefined(context);
1652 }
1653 
1654 static JSValueRef setWebViewEditableCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1655 {
1656     // Has Mac implementation
1657     if (argumentCount &lt; 1)
1658         return JSValueMakeUndefined(context);
1659 
1660     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1661     controller-&gt;setWebViewEditable(JSValueToBoolean(context, arguments[0]));
1662 
1663     return JSValueMakeUndefined(context);
1664 }
1665 
1666 static JSValueRef abortModalCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1667 {
1668     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1669     controller-&gt;abortModal();
1670     return JSValueMakeUndefined(context);
1671 }
1672 
1673 static JSValueRef authenticateSessionCallback(JSContextRef context, JSObjectRef, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1674 {
1675     // authenticateSession(url, username, password)
1676     if (argumentCount != 3)
1677         return JSValueMakeUndefined(context);
1678 
1679     auto url = adopt(JSValueToStringCopy(context, arguments[0], exception));
1680     ASSERT(!*exception);
1681     auto username = adopt(JSValueToStringCopy(context, arguments[1], exception));
1682     ASSERT(!*exception);
1683     auto password = adopt(JSValueToStringCopy(context, arguments[2], exception));
1684     ASSERT(!*exception);
1685 
1686     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1687     controller-&gt;authenticateSession(url.get(), username.get(), password.get());
1688     return JSValueMakeUndefined(context);
1689 }
1690 
1691 static JSValueRef setSerializeHTTPLoadsCallback(JSContextRef context, JSObjectRef, JSObjectRef, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1692 {
1693     bool serialize = true;
1694     if (argumentCount == 1)
1695         serialize = JSValueToBoolean(context, arguments[0]);
1696 
1697     TestRunner::setSerializeHTTPLoads(serialize);
1698     return JSValueMakeUndefined(context);
1699 }
1700 
1701 static JSValueRef setShouldStayOnPageAfterHandlingBeforeUnloadCallback(JSContextRef context, JSObjectRef, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1702 {
1703     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1704 
1705     if (argumentCount == 1)
1706         controller-&gt;setShouldStayOnPageAfterHandlingBeforeUnload(JSValueToBoolean(context, arguments[0]));
1707 
1708     return JSValueMakeUndefined(context);
1709 }
1710 
1711 static JSValueRef addChromeInputFieldCallback(JSContextRef context, JSObjectRef, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1712 {
1713     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1714     controller-&gt;addChromeInputField();
1715     // the first argument is a callback that is called once the input field has been added
1716     if (argumentCount == 1)
1717         JSObjectCallAsFunction(context, JSValueToObject(context, arguments[0], 0), thisObject, 0, 0, 0);
1718     return JSValueMakeUndefined(context);
1719 }
1720 
1721 static JSValueRef removeChromeInputFieldCallback(JSContextRef context, JSObjectRef, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1722 {
1723     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1724     controller-&gt;removeChromeInputField();
1725     // the first argument is a callback that is called once the input field has been added
1726     if (argumentCount == 1)
1727         JSObjectCallAsFunction(context, JSValueToObject(context, arguments[0], 0), thisObject, 0, 0, 0);
1728     return JSValueMakeUndefined(context);
1729 }
1730 
1731 static JSValueRef focusWebViewCallback(JSContextRef context, JSObjectRef, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1732 {
1733     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1734     controller-&gt;focusWebView();
1735     // the first argument is a callback that is called once the input field has been added
1736     if (argumentCount == 1)
1737         JSObjectCallAsFunction(context, JSValueToObject(context, arguments[0], 0), thisObject, 0, 0, 0);
1738     return JSValueMakeUndefined(context);
1739 }
1740 
1741 static JSValueRef setBackingScaleFactorCallback(JSContextRef context, JSObjectRef, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1742 {
1743     if (argumentCount != 2)
1744         return JSValueMakeUndefined(context);
1745 
1746     double backingScaleFactor = JSValueToNumber(context, arguments[0], exception);
1747     ASSERT(!*exception);
1748 
1749     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1750     controller-&gt;setBackingScaleFactor(backingScaleFactor);
1751 
1752     // The second argument is a callback that is called once the backing scale factor has been set.
1753     JSObjectCallAsFunction(context, JSValueToObject(context, arguments[1], 0), thisObject, 0, 0, 0);
1754     return JSValueMakeUndefined(context);
1755 }
1756 
1757 static JSValueRef preciseTimeCallback(JSContextRef context, JSObjectRef, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1758 {
1759     return JSValueMakeNumber(context, WallTime::now().secondsSinceEpoch().seconds());
1760 }
1761 
1762 static JSValueRef imageCountInGeneralPasteboardCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1763 {
1764     // Has mac &amp; windows implementation
1765     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1766 
1767     return JSValueMakeNumber(context, controller-&gt;imageCountInGeneralPasteboard());
1768 }
1769 
1770 static JSValueRef setSpellCheckerLoggingEnabledCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1771 {
1772     if (argumentCount &lt; 1)
1773         return JSValueMakeUndefined(context);
1774     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1775     controller-&gt;setSpellCheckerLoggingEnabled(JSValueToBoolean(context, arguments[0]));
1776     return JSValueMakeUndefined(context);
1777 }
1778 
1779 static JSValueRef setSpellCheckerResultsCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1780 {
1781     if (argumentCount &lt; 1)
1782         return JSValueMakeUndefined(context);
1783 
1784     auto* runner = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1785     runner-&gt;setSpellCheckerResults(context, JSValueToObject(context, arguments[0], nullptr));
1786     return JSValueMakeUndefined(context);
1787 }
1788 
1789 static JSValueRef setOpenPanelFilesCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1790 {
1791     if (argumentCount == 1)
1792         static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject))-&gt;setOpenPanelFiles(context, arguments[0]);
1793     return JSValueMakeUndefined(context);
1794 }
1795 
1796 #if PLATFORM(IOS_FAMILY)
1797 static JSValueRef SetOpenPanelFilesMediaIconCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1798 {
1799     if (argumentCount == 1)
1800         static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject))-&gt;setOpenPanelFilesMediaIcon(context, arguments[0]);
1801     return JSValueMakeUndefined(context);
1802 }
1803 #endif
1804 
1805 // Static Values
1806 
1807 static JSValueRef getTimeoutCallback(JSContextRef context, JSObjectRef thisObject, JSStringRef propertyName, JSValueRef* exception)
1808 {
1809     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1810     return JSValueMakeNumber(context, controller-&gt;timeout());
1811 }
1812 
1813 static JSValueRef getGlobalFlagCallback(JSContextRef context, JSObjectRef thisObject, JSStringRef propertyName, JSValueRef* exception)
1814 {
1815     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1816     return JSValueMakeBoolean(context, controller-&gt;globalFlag());
1817 }
1818 
1819 static JSValueRef getDidCancelClientRedirect(JSContextRef context, JSObjectRef thisObject, JSStringRef propertyName, JSValueRef* exception)
1820 {
1821     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1822     return JSValueMakeBoolean(context, controller-&gt;didCancelClientRedirect());
1823 }
1824 
1825 static JSValueRef getDatabaseDefaultQuotaCallback(JSContextRef context, JSObjectRef thisObject, JSStringRef propertyName, JSValueRef* exception)
1826 {
1827     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1828     return JSValueMakeNumber(context, controller-&gt;databaseDefaultQuota());
1829 }
1830 
1831 static JSValueRef getDatabaseMaxQuotaCallback(JSContextRef context, JSObjectRef thisObject, JSStringRef propertyName, JSValueRef* exception)
1832 {
1833     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1834     return JSValueMakeNumber(context, controller-&gt;databaseMaxQuota());
1835 }
1836 
1837 static JSValueRef getWebHistoryItemCountCallback(JSContextRef context, JSObjectRef thisObject, JSStringRef propertyName, JSValueRef* exception)
1838 {
1839     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1840     return JSValueMakeNumber(context, controller-&gt;webHistoryItemCount());
1841 }
1842 
1843 static JSValueRef getSecureEventInputIsEnabledCallback(JSContextRef context, JSObjectRef thisObject, JSStringRef propertyName, JSValueRef* exception)
1844 {
1845 #if PLATFORM(MAC) &amp;&amp; !PLATFORM(IOS_FAMILY)
1846     return JSValueMakeBoolean(context, IsSecureEventInputEnabled());
1847 #else
1848     return JSValueMakeBoolean(context, false);
1849 #endif
1850 }
1851 
1852 static JSValueRef getTitleTextDirectionCallback(JSContextRef context, JSObjectRef thisObject, JSStringRef propertyName, JSValueRef* exception)
1853 {
1854     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1855     auto titleDirection = adopt(JSStringCreateWithUTF8CString(controller-&gt;titleTextDirection().c_str()));
1856     return JSValueMakeString(context, titleDirection.get());
1857 }
1858 
1859 static JSValueRef getInspectorTestStubURLCallback(JSContextRef context, JSObjectRef thisObject, JSStringRef propertyName, JSValueRef* exception)
1860 {
1861     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1862     auto url = controller-&gt;inspectorTestStubURL();
1863     return JSValueMakeString(context, url.get());
1864 }
1865 
1866 static bool setGlobalFlagCallback(JSContextRef context, JSObjectRef thisObject, JSStringRef propertyName, JSValueRef value, JSValueRef* exception)
1867 {
1868     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1869     controller-&gt;setGlobalFlag(JSValueToBoolean(context, value));
1870     return true;
1871 }
1872 
1873 static bool setDatabaseDefaultQuotaCallback(JSContextRef context, JSObjectRef thisObject, JSStringRef propertyName, JSValueRef value, JSValueRef* exception)
1874 {
1875     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1876     controller-&gt;setDatabaseDefaultQuota(JSValueToNumber(context, value, exception));
1877     ASSERT(!*exception);
1878     return true;
1879 }
1880 
1881 static bool setDatabaseMaxQuotaCallback(JSContextRef context, JSObjectRef thisObject, JSStringRef propertyName, JSValueRef value, JSValueRef* exception)
1882 {
1883     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1884     controller-&gt;setDatabaseMaxQuota(JSValueToNumber(context, value, exception));
1885     ASSERT(!*exception);
1886     return true;
1887 }
1888 
1889 static JSValueRef ignoreLegacyWebNotificationPermissionRequestsCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1890 {
1891     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1892     controller-&gt;ignoreLegacyWebNotificationPermissionRequests();
1893     return JSValueMakeUndefined(context);
1894 }
1895 
1896 static JSValueRef simulateLegacyWebNotificationClickCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1897 {
1898     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1899     auto title = adopt(JSValueToStringCopy(context, arguments[0], exception));
1900     controller-&gt;simulateLegacyWebNotificationClick(title.get());
1901     return JSValueMakeUndefined(context);
1902 }
1903 
1904 static JSValueRef setTextDirectionCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1905 {
1906     if (argumentCount == 1) {
1907         auto direction = adopt(JSValueToStringCopy(context, arguments[0], exception));
1908         TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1909         controller-&gt;setTextDirection(direction.get());
1910     }
1911 
1912     return JSValueMakeUndefined(context);
1913 
1914 }
1915 
1916 static JSValueRef setHasCustomFullScreenBehaviorCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1917 {
1918     if (argumentCount == 1) {
1919         bool hasCustomBehavior = JSValueToBoolean(context, arguments[0]);
1920         TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1921         controller-&gt;setHasCustomFullScreenBehavior(hasCustomBehavior);
1922     }
1923 
1924     return JSValueMakeUndefined(context);
1925 }
1926 
1927 static JSValueRef setStorageDatabaseIdleIntervalCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1928 {
1929     if (argumentCount != 1)
1930         return JSValueMakeUndefined(context);
1931 
1932     double interval = JSValueToNumber(context, arguments[0], exception);
1933     ASSERT(!*exception);
1934 
1935     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1936     controller-&gt;setStorageDatabaseIdleInterval(interval);
1937 
1938     return JSValueMakeUndefined(context);
1939 }
1940 
1941 static JSValueRef closeIdleLocalStorageDatabasesCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1942 {
1943     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1944     controller-&gt;closeIdleLocalStorageDatabases();
1945 
1946     return JSValueMakeUndefined(context);
1947 }
1948 
1949 static JSValueRef grantWebNotificationPermissionCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1950 {
1951     if (argumentCount &lt; 1)
1952         return JSValueMakeUndefined(context);
1953 
1954     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1955 
1956     auto origin = adopt(JSValueToStringCopy(context, arguments[0], exception));
1957     ASSERT(!*exception);
1958     controller-&gt;grantWebNotificationPermission(origin.get());
1959 
1960     return JSValueMakeUndefined(context);
1961 }
1962 
1963 
1964 static JSValueRef denyWebNotificationPermissionCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1965 {
1966     if (argumentCount &lt; 1)
1967         return JSValueMakeUndefined(context);
1968 
1969     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1970 
1971     auto origin = adopt(JSValueToStringCopy(context, arguments[0], exception));
1972     ASSERT(!*exception);
1973     controller-&gt;denyWebNotificationPermission(origin.get());
1974 
1975     return JSValueMakeUndefined(context);
1976 }
1977 
1978 
1979 static JSValueRef removeAllWebNotificationPermissionsCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1980 {
1981     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1982 
1983     controller-&gt;removeAllWebNotificationPermissions();
1984 
1985     return JSValueMakeUndefined(context);
1986 }
1987 
1988 
1989 static JSValueRef simulateWebNotificationClickCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1990 {
1991     // Has Windows implementation
1992     if (argumentCount &lt; 1)
1993         return JSValueMakeUndefined(context);
1994 
1995     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1996 
1997     controller-&gt;simulateWebNotificationClick(arguments[0]);
1998 
1999     return JSValueMakeUndefined(context);
2000 }
2001 
2002 static JSValueRef forceImmediateCompletionCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
2003 {
2004     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
2005     controller-&gt;forceImmediateCompletion();
2006     return JSValueMakeUndefined(context);
2007 }
2008 
2009 static JSValueRef failNextNewCodeBlock(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
2010 {
2011     if (argumentCount &lt; 1)
2012         return JSValueMakeUndefined(context);
2013 
2014     return JSC::failNextNewCodeBlock(context);
2015 }
2016 
2017 static JSValueRef numberOfDFGCompiles(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
2018 {
2019     return JSC::numberOfDFGCompiles(context, arguments[0]);
2020 }
2021 
2022 static JSValueRef neverInlineFunction(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
2023 {
2024     if (argumentCount &lt; 1)
2025         return JSValueMakeUndefined(context);
2026 
2027     return JSC::setNeverInline(context, arguments[0]);
2028 }
2029 
2030 static JSValueRef accummulateLogsForChannel(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
2031 {
2032     if (argumentCount &lt; 1)
2033         return JSValueMakeUndefined(context);
2034 
2035     auto channel = adopt(JSValueToStringCopy(context, arguments[0], exception));
2036     ASSERT(!*exception);
2037 
2038     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
2039     controller-&gt;setAccummulateLogsForChannel(channel.get());
2040 
2041     return JSValueMakeUndefined(context);
2042 }
2043 
2044 static JSValueRef runUIScriptCallback(JSContextRef context, JSObjectRef, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
2045 {
2046     if (argumentCount &lt; 1)
2047         return JSValueMakeUndefined(context);
2048 
2049     auto script = argumentCount &gt; 0 ? adopt(JSValueToStringCopy(context, arguments[0], 0)) : JSRetainPtr&lt;JSStringRef&gt;();
2050     JSValueRef callback = argumentCount &gt; 1 ? arguments[1] : JSValueMakeUndefined(context);
2051 
2052     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
2053     controller-&gt;runUIScript(context, script.get(), callback);
2054 
2055     return JSValueMakeUndefined(context);
2056 }
2057 
2058 static void testRunnerObjectFinalize(JSObjectRef object)
2059 {
2060     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(object));
2061     controller-&gt;deref();
2062 }
2063 
2064 // Object Creation
2065 
2066 void TestRunner::makeWindowObject(JSContextRef context, JSObjectRef windowObject, JSValueRef* exception)
2067 {
2068     auto testRunnerStr = adopt(JSStringCreateWithUTF8CString(&quot;testRunner&quot;));
2069     ref();
2070 
2071     JSClassRef classRef = getJSClass();
2072     JSValueRef layoutTestContollerObject = JSObjectMake(context, classRef, this);
2073     JSClassRelease(classRef);
2074 
2075     JSObjectSetProperty(context, windowObject, testRunnerStr.get(), layoutTestContollerObject, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete, exception);
2076 }
2077 
2078 JSClassRef TestRunner::getJSClass()
2079 {
2080     static JSStaticValue* staticValues = TestRunner::staticValues();
2081     static JSStaticFunction* staticFunctions = TestRunner::staticFunctions();
2082     static JSClassDefinition classDefinition = {
2083         0, kJSClassAttributeNone, &quot;TestRunner&quot;, 0, staticValues, staticFunctions,
2084         0, testRunnerObjectFinalize, 0, 0, 0, 0, 0, 0, 0, 0, 0
2085     };
2086 
2087     return JSClassCreate(&amp;classDefinition);
2088 }
2089 
2090 // Constants
2091 
2092 static JSValueRef getRENDER_TREE_SHOW_ALL_LAYERS(JSContextRef context, JSObjectRef, JSStringRef, JSValueRef*)
2093 {
2094     return JSValueMakeNumber(context, 1);
2095 }
2096 
2097 static JSValueRef getRENDER_TREE_SHOW_LAYER_NESTING(JSContextRef context, JSObjectRef, JSStringRef, JSValueRef*)
2098 {
2099     return JSValueMakeNumber(context, 2);
2100 }
2101 
2102 static JSValueRef getRENDER_TREE_SHOW_COMPOSITED_LAYERS(JSContextRef context, JSObjectRef, JSStringRef, JSValueRef*)
2103 {
2104     return JSValueMakeNumber(context, 4);
2105 }
2106 
2107 static JSValueRef getRENDER_TREE_SHOW_OVERFLOW(JSContextRef context, JSObjectRef, JSStringRef, JSValueRef*)
2108 {
2109     return JSValueMakeNumber(context, 8);
2110 }
2111 
2112 static JSValueRef getRENDER_TREE_SHOW_SVG_GEOMETRY(JSContextRef context, JSObjectRef, JSStringRef, JSValueRef*)
2113 {
2114     return JSValueMakeNumber(context, 16);
2115 }
2116 
2117 static JSValueRef getRENDER_TREE_SHOW_LAYER_FRAGMENTS(JSContextRef context, JSObjectRef, JSStringRef, JSValueRef*)
2118 {
2119     return JSValueMakeNumber(context, 32);
2120 }
2121 
2122 JSStaticValue* TestRunner::staticValues()
2123 {
2124     static JSStaticValue staticValues[] = {
2125         { &quot;didCancelClientRedirect&quot;, getDidCancelClientRedirect, 0, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2126         { &quot;timeout&quot;, getTimeoutCallback, 0, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2127         { &quot;globalFlag&quot;, getGlobalFlagCallback, setGlobalFlagCallback, kJSPropertyAttributeNone },
2128         { &quot;webHistoryItemCount&quot;, getWebHistoryItemCountCallback, 0, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2129         { &quot;secureEventInputIsEnabled&quot;, getSecureEventInputIsEnabledCallback, 0, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2130         { &quot;titleTextDirection&quot;, getTitleTextDirectionCallback, 0, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2131         { &quot;databaseDefaultQuota&quot;, getDatabaseDefaultQuotaCallback, setDatabaseDefaultQuotaCallback, kJSPropertyAttributeNone },
2132         { &quot;databaseMaxQuota&quot;, getDatabaseMaxQuotaCallback, setDatabaseMaxQuotaCallback, kJSPropertyAttributeNone },
2133         { &quot;inspectorTestStubURL&quot;, getInspectorTestStubURLCallback, 0, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2134         { &quot;RENDER_TREE_SHOW_ALL_LAYERS&quot;, getRENDER_TREE_SHOW_ALL_LAYERS, 0, kJSPropertyAttributeDontDelete | kJSPropertyAttributeReadOnly },
2135         { &quot;RENDER_TREE_SHOW_LAYER_NESTING&quot;, getRENDER_TREE_SHOW_LAYER_NESTING, 0, kJSPropertyAttributeDontDelete | kJSPropertyAttributeReadOnly },
2136         { &quot;RENDER_TREE_SHOW_COMPOSITED_LAYERS&quot;, getRENDER_TREE_SHOW_COMPOSITED_LAYERS, 0, kJSPropertyAttributeDontDelete | kJSPropertyAttributeReadOnly },
2137         { &quot;RENDER_TREE_SHOW_OVERFLOW&quot;, getRENDER_TREE_SHOW_OVERFLOW, 0, kJSPropertyAttributeDontDelete | kJSPropertyAttributeReadOnly },
2138         { &quot;RENDER_TREE_SHOW_SVG_GEOMETRY&quot;, getRENDER_TREE_SHOW_SVG_GEOMETRY, 0, kJSPropertyAttributeDontDelete | kJSPropertyAttributeReadOnly },
2139         { &quot;RENDER_TREE_SHOW_LAYER_FRAGMENTS&quot;, getRENDER_TREE_SHOW_LAYER_FRAGMENTS, 0, kJSPropertyAttributeDontDelete | kJSPropertyAttributeReadOnly },
2140         { 0, 0, 0, 0 }
2141     };
2142     return staticValues;
2143 }
2144 
2145 JSStaticFunction* TestRunner::staticFunctions()
2146 {
2147     static JSStaticFunction staticFunctions[] = {
2148         { &quot;abortModal&quot;, abortModalCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2149         { &quot;addDisallowedURL&quot;, addDisallowedURLCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2150         { &quot;addURLToRedirect&quot;, addURLToRedirectCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2151         { &quot;addUserScript&quot;, addUserScriptCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2152         { &quot;addUserStyleSheet&quot;, addUserStyleSheetCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2153         { &quot;apiTestNewWindowDataLoadBaseURL&quot;, apiTestNewWindowDataLoadBaseURLCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2154         { &quot;apiTestGoToCurrentBackForwardItem&quot;, apiTestGoToCurrentBackForwardItemCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2155         { &quot;applicationCacheDiskUsageForOrigin&quot;, applicationCacheDiskUsageForOriginCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2156         { &quot;callShouldCloseOnWebView&quot;, callShouldCloseOnWebViewCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2157         { &quot;clearAllApplicationCaches&quot;, clearAllApplicationCachesCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2158         { &quot;clearAllDatabases&quot;, clearAllDatabasesCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2159         { &quot;clearApplicationCacheForOrigin&quot;, clearApplicationCacheForOriginCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2160         { &quot;clearBackForwardList&quot;, clearBackForwardListCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2161         { &quot;clearPersistentUserStyleSheet&quot;, clearPersistentUserStyleSheetCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2162         { &quot;closeWebInspector&quot;, closeWebInspectorCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2163         { &quot;decodeHostName&quot;, decodeHostNameCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2164         { &quot;disallowIncreaseForApplicationCacheQuota&quot;, disallowIncreaseForApplicationCacheQuotaCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2165         { &quot;dispatchPendingLoadRequests&quot;, dispatchPendingLoadRequestsCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2166         { &quot;display&quot;, displayCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2167         { &quot;displayAndTrackRepaints&quot;, displayAndTrackRepaintsCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2168         { &quot;dumpApplicationCacheDelegateCallbacks&quot;, dumpApplicationCacheDelegateCallbacksCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2169         { &quot;setRenderTreeDumpOptions&quot;, setRenderTreeDumpOptionsCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2170         { &quot;dumpAsText&quot;, dumpAsTextCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2171         { &quot;dumpBackForwardList&quot;, dumpBackForwardListCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2172         { &quot;dumpChildFrameScrollPositions&quot;, dumpChildFrameScrollPositionsCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2173         { &quot;dumpChildFramesAsText&quot;, dumpChildFramesAsTextCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2174         { &quot;dumpDOMAsWebArchive&quot;, dumpDOMAsWebArchiveCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2175         { &quot;dumpDatabaseCallbacks&quot;, dumpDatabaseCallbacksCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2176         { &quot;dumpEditingCallbacks&quot;, dumpEditingCallbacksCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2177         { &quot;dumpFrameLoadCallbacks&quot;, dumpFrameLoadCallbacksCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2178         { &quot;dumpProgressFinishedCallback&quot;, dumpProgressFinishedCallbackCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2179         { &quot;dumpUserGestureInFrameLoadCallbacks&quot;, dumpUserGestureInFrameLoadCallbacksCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2180         { &quot;dumpResourceLoadCallbacks&quot;, dumpResourceLoadCallbacksCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2181         { &quot;dumpResourceResponseMIMETypes&quot;, dumpResourceResponseMIMETypesCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2182         { &quot;dumpSelectionRect&quot;, dumpSelectionRectCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2183         { &quot;dumpSourceAsWebArchive&quot;, dumpSourceAsWebArchiveCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2184         { &quot;dumpStatusCallbacks&quot;, dumpStatusCallbacksCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2185         { &quot;dumpTitleChanges&quot;, dumpTitleChangesCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2186         { &quot;dumpWillCacheResponse&quot;, dumpWillCacheResponseCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2187         { &quot;encodeHostName&quot;, encodeHostNameCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2188         { &quot;evaluateInWebInspector&quot;, evaluateInWebInspectorCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2189         { &quot;evaluateScriptInIsolatedWorldAndReturnValue&quot;, evaluateScriptInIsolatedWorldAndReturnValueCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2190         { &quot;evaluateScriptInIsolatedWorld&quot;, evaluateScriptInIsolatedWorldCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2191         { &quot;execCommand&quot;, execCommandCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2192         { &quot;findString&quot;, findStringCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2193         { &quot;originsWithApplicationCache&quot;, originsWithApplicationCacheCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2194         { &quot;goBack&quot;, goBackCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2195         { &quot;ignoreLegacyWebNotificationPermissionRequests&quot;, ignoreLegacyWebNotificationPermissionRequestsCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2196         { &quot;isGeolocationProviderActive&quot;, isGeolocationProviderActiveCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2197         { &quot;isCommandEnabled&quot;, isCommandEnabledCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2198         { &quot;keepWebHistory&quot;, keepWebHistoryCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2199         { &quot;numberOfPendingGeolocationPermissionRequests&quot;, numberOfPendingGeolocationPermissionRequestsCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2200         { &quot;notifyDone&quot;, notifyDoneCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2201         { &quot;overridePreference&quot;, overridePreferenceCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2202         { &quot;pathToLocalResource&quot;, pathToLocalResourceCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2203         { &quot;printToPDF&quot;, dumpAsPDFCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2204         { &quot;queueBackNavigation&quot;, queueBackNavigationCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2205         { &quot;queueForwardNavigation&quot;, queueForwardNavigationCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2206         { &quot;queueLoad&quot;, queueLoadCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2207         { &quot;queueLoadHTMLString&quot;, queueLoadHTMLStringCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2208         { &quot;queueLoadingScript&quot;, queueLoadingScriptCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2209         { &quot;queueNonLoadingScript&quot;, queueNonLoadingScriptCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2210         { &quot;queueReload&quot;, queueReloadCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2211         { &quot;removeAllVisitedLinks&quot;, removeAllVisitedLinksCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2212         { &quot;removeOriginAccessWhitelistEntry&quot;, removeOriginAccessWhitelistEntryCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2213         { &quot;repaintSweepHorizontally&quot;, repaintSweepHorizontallyCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2214         { &quot;resetPageVisibility&quot;, resetPageVisibilityCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2215         { &quot;setAcceptsEditing&quot;, setAcceptsEditingCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2216         { &quot;setAllowUniversalAccessFromFileURLs&quot;, setAllowUniversalAccessFromFileURLsCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2217         { &quot;setAllowFileAccessFromFileURLs&quot;, setAllowFileAccessFromFileURLsCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2218         { &quot;setNeedsStorageAccessFromFileURLsQuirk&quot;, setNeedsStorageAccessFromFileURLsQuirkCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2219         { &quot;setAllowsAnySSLCertificate&quot;, setAllowsAnySSLCertificateCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2220         { &quot;setAlwaysAcceptCookies&quot;, setAlwaysAcceptCookiesCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2221         { &quot;setOnlyAcceptFirstPartyCookies&quot;, setOnlyAcceptFirstPartyCookiesCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2222         { &quot;setAppCacheMaximumSize&quot;, setAppCacheMaximumSizeCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2223         { &quot;setAudioResult&quot;, setAudioResultCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2224         { &quot;setAuthenticationPassword&quot;, setAuthenticationPasswordCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2225         { &quot;setAuthenticationUsername&quot;, setAuthenticationUsernameCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2226         { &quot;setAuthorAndUserStylesEnabled&quot;, setAuthorAndUserStylesEnabledCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2227         { &quot;setCacheModel&quot;, setCacheModelCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2228         { &quot;setCallCloseOnWebViews&quot;, setCallCloseOnWebViewsCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2229         { &quot;setCanOpenWindows&quot;, setCanOpenWindowsCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2230         { &quot;setCloseRemainingWindowsWhenComplete&quot;, setCloseRemainingWindowsWhenCompleteCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2231         { &quot;setCustomPolicyDelegate&quot;, setCustomPolicyDelegateCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2232         { &quot;setDatabaseQuota&quot;, setDatabaseQuotaCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2233         { &quot;setDefersLoading&quot;, setDefersLoadingCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2234         { &quot;setUseDeferredFrameLoading&quot;, setUseDeferredFrameLoadingCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2235         { &quot;setDomainRelaxationForbiddenForURLScheme&quot;, setDomainRelaxationForbiddenForURLSchemeCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2236         { &quot;setGeolocationPermission&quot;, setGeolocationPermissionCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2237         { &quot;setRejectsProtectionSpaceAndContinueForAuthenticationChallenges&quot;, setRejectsProtectionSpaceAndContinueForAuthenticationChallengesCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2238         { &quot;setHandlesAuthenticationChallenges&quot;, setHandlesAuthenticationChallengesCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2239         { &quot;setIconDatabaseEnabled&quot;, setIconDatabaseEnabledCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2240         { &quot;setAutomaticLinkDetectionEnabled&quot;, setAutomaticLinkDetectionEnabledCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2241         { &quot;setMainFrameIsFirstResponder&quot;, setMainFrameIsFirstResponderCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2242         { &quot;setMockDeviceOrientation&quot;, setMockDeviceOrientationCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2243         { &quot;setMockGeolocationPositionUnavailableError&quot;, setMockGeolocationPositionUnavailableErrorCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2244         { &quot;setMockGeolocationPosition&quot;, setMockGeolocationPositionCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2245         { &quot;setNewWindowsCopyBackForwardList&quot;, setNewWindowsCopyBackForwardListCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2246         { &quot;setPageVisibility&quot;, setPageVisibilityCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2247         { &quot;setPOSIXLocale&quot;, setPOSIXLocaleCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2248         { &quot;setPersistentUserStyleSheetLocation&quot;, setPersistentUserStyleSheetLocationCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2249         { &quot;setPopupBlockingEnabled&quot;, setPopupBlockingEnabledCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2250         { &quot;setPluginsEnabled&quot;, setPluginsEnabledCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2251         { &quot;setPrinting&quot;, setPrintingCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2252         { &quot;setPrivateBrowsingEnabled_DEPRECATED&quot;, setPrivateBrowsingEnabledCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2253         { &quot;setShouldSwapToEphemeralSessionOnNextNavigation&quot;, setShouldSwapToEphemeralSessionOnNextNavigationCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2254         { &quot;setShouldSwapToDefaultSessionOnNextNavigation&quot;, setShouldSwapToDefaultSessionOnNextNavigationCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2255         { &quot;setSerializeHTTPLoads&quot;, setSerializeHTTPLoadsCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2256         { &quot;setSpatialNavigationEnabled&quot;, setSpatialNavigationEnabledCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2257         { &quot;setStopProvisionalFrameLoads&quot;, setStopProvisionalFrameLoadsCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2258         { &quot;setTabKeyCyclesThroughElements&quot;, setTabKeyCyclesThroughElementsCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2259 #if PLATFORM(IOS_FAMILY)
2260         { &quot;setTelephoneNumberParsingEnabled&quot;, setTelephoneNumberParsingEnabledCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2261         { &quot;setPagePaused&quot;, setPagePausedCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2262 #endif
2263         { &quot;setUserStyleSheetEnabled&quot;, setUserStyleSheetEnabledCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2264         { &quot;setUserStyleSheetLocation&quot;, setUserStyleSheetLocationCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2265         { &quot;setValueForUser&quot;, setValueForUserCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2266         { &quot;setWebViewEditable&quot;, setWebViewEditableCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2267         { &quot;setWillSendRequestClearHeader&quot;, setWillSendRequestClearHeaderCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2268         { &quot;setWillSendRequestReturnsNull&quot;, setWillSendRequestReturnsNullCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2269         { &quot;setWillSendRequestReturnsNullOnRedirect&quot;, setWillSendRequestReturnsNullOnRedirectCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2270         { &quot;setWindowIsKey&quot;, setWindowIsKeyCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2271         { &quot;setViewSize&quot;, setViewSizeCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2272         { &quot;setJavaScriptCanAccessClipboard&quot;, setJavaScriptCanAccessClipboardCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2273         { &quot;setXSSAuditorEnabled&quot;, setXSSAuditorEnabledCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2274         { &quot;showWebInspector&quot;, showWebInspectorCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2275         { &quot;simulateLegacyWebNotificationClick&quot;, simulateLegacyWebNotificationClickCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2276         { &quot;testOnscreen&quot;, testOnscreenCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2277         { &quot;testRepaint&quot;, testRepaintCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2278         { &quot;waitForPolicyDelegate&quot;, waitForPolicyDelegateCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2279         { &quot;waitUntilDone&quot;, waitUntilDoneCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2280         { &quot;windowCount&quot;, windowCountCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2281         { &quot;addOriginAccessWhitelistEntry&quot;, addOriginAccessWhitelistEntryCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2282         { &quot;setScrollbarPolicy&quot;, setScrollbarPolicyCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2283         { &quot;authenticateSession&quot;, authenticateSessionCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2284         { &quot;setShouldPaintBrokenImage&quot;, setShouldPaintBrokenImageCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2285         { &quot;setTextDirection&quot;, setTextDirectionCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2286         { &quot;setShouldStayOnPageAfterHandlingBeforeUnload&quot;, setShouldStayOnPageAfterHandlingBeforeUnloadCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2287         { &quot;addChromeInputField&quot;, addChromeInputFieldCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2288         { &quot;removeChromeInputField&quot;, removeChromeInputFieldCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2289         { &quot;focusWebView&quot;, focusWebViewCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2290         { &quot;setBackingScaleFactor&quot;, setBackingScaleFactorCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2291         { &quot;preciseTime&quot;, preciseTimeCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2292         { &quot;setHasCustomFullScreenBehavior&quot;, setHasCustomFullScreenBehaviorCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2293         { &quot;setStorageDatabaseIdleInterval&quot;, setStorageDatabaseIdleIntervalCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2294         { &quot;closeIdleLocalStorageDatabases&quot;, closeIdleLocalStorageDatabasesCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2295         { &quot;grantWebNotificationPermission&quot;, grantWebNotificationPermissionCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2296         { &quot;denyWebNotificationPermission&quot;, denyWebNotificationPermissionCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2297         { &quot;removeAllWebNotificationPermissions&quot;, removeAllWebNotificationPermissionsCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2298         { &quot;simulateWebNotificationClick&quot;, simulateWebNotificationClickCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2299         { &quot;failNextNewCodeBlock&quot;, failNextNewCodeBlock, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2300         { &quot;numberOfDFGCompiles&quot;, numberOfDFGCompiles, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2301         { &quot;neverInlineFunction&quot;, neverInlineFunction, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2302         { &quot;accummulateLogsForChannel&quot;, accummulateLogsForChannel, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2303         { &quot;runUIScript&quot;, runUIScriptCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2304         { &quot;imageCountInGeneralPasteboard&quot;, imageCountInGeneralPasteboardCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2305         { &quot;setSpellCheckerLoggingEnabled&quot;, setSpellCheckerLoggingEnabledCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2306         { &quot;setSpellCheckerResults&quot;, setSpellCheckerResultsCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2307         { &quot;setOpenPanelFiles&quot;, setOpenPanelFilesCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2308 #if PLATFORM(IOS_FAMILY)
2309         { &quot;setOpenPanelFilesMediaIcon&quot;, SetOpenPanelFilesMediaIconCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2310 #endif
2311         { &quot;forceImmediateCompletion&quot;, forceImmediateCompletionCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2312         { 0, 0, 0 }
2313     };
2314 
2315     return staticFunctions;
2316 }
2317 
2318 void TestRunner::queueLoadHTMLString(JSStringRef content, JSStringRef baseURL)
2319 {
2320     DRT::WorkQueue::singleton().queue(new LoadHTMLStringItem(content, baseURL));
2321 }
2322 
2323 void TestRunner::queueLoadAlternateHTMLString(JSStringRef content, JSStringRef baseURL, JSStringRef unreachableURL)
2324 {
2325     DRT::WorkQueue::singleton().queue(new LoadHTMLStringItem(content, baseURL, unreachableURL));
2326 }
2327 
2328 void TestRunner::queueBackNavigation(int howFarBack)
2329 {
2330     DRT::WorkQueue::singleton().queue(new BackItem(howFarBack));
2331 }
2332 
2333 void TestRunner::queueForwardNavigation(int howFarForward)
2334 {
2335     DRT::WorkQueue::singleton().queue(new ForwardItem(howFarForward));
2336 }
2337 
2338 void TestRunner::queueLoadingScript(JSStringRef script)
2339 {
2340     DRT::WorkQueue::singleton().queue(new LoadingScriptItem(script));
2341 }
2342 
2343 void TestRunner::queueNonLoadingScript(JSStringRef script)
2344 {
2345     DRT::WorkQueue::singleton().queue(new NonLoadingScriptItem(script));
2346 }
2347 
2348 void TestRunner::queueReload()
2349 {
2350     DRT::WorkQueue::singleton().queue(new ReloadItem);
2351 }
2352 
2353 void TestRunner::ignoreLegacyWebNotificationPermissionRequests()
2354 {
2355     m_areLegacyWebNotificationPermissionRequestsIgnored = false;
2356 }
2357 
2358 void TestRunner::waitToDumpWatchdogTimerFired()
2359 {
2360     const char* message = &quot;FAIL: Timed out waiting for notifyDone to be called\n&quot;;
2361     fprintf(testResult, &quot;%s&quot;, message);
2362 
2363     auto accumulatedLogs = getAndResetAccumulatedLogs();
2364     if (!accumulatedLogs.isEmpty()) {
2365         const char* message = &quot;Logs accumulated during test run:\n&quot;;
2366         fprintf(testResult, &quot;%s%s\n&quot;, message, accumulatedLogs.utf8().data());
2367     }
2368 
2369     notifyDone();
2370 }
2371 
2372 void TestRunner::setGeolocationPermissionCommon(bool allow)
2373 {
2374     m_isGeolocationPermissionSet = true;
2375     m_geolocationPermission = allow;
2376 }
2377 
2378 void TestRunner::setPOSIXLocale(JSStringRef locale)
2379 {
2380     char localeBuf[32];
2381     JSStringGetUTF8CString(locale, localeBuf, sizeof(localeBuf));
2382     setlocale(LC_ALL, localeBuf);
2383 }
2384 
2385 void TestRunner::addURLToRedirect(std::string origin, std::string destination)
2386 {
2387     m_URLsToRedirect[origin] = destination;
2388 }
2389 
2390 const char* TestRunner::redirectionDestinationForURL(const char* origin)
2391 {
2392     if (!origin)
2393         return nullptr;
2394 
2395     auto iterator = m_URLsToRedirect.find(origin);
2396     if (iterator == m_URLsToRedirect.end())
2397         return nullptr;
2398 
2399     return iterator-&gt;second.data();
2400 }
2401 
2402 void TestRunner::setRenderTreeDumpOptions(unsigned options)
2403 {
2404     m_renderTreeDumpOptions = options;
2405 }
2406 
2407 void TestRunner::setShouldPaintBrokenImage(bool shouldPaintBrokenImage)
2408 {
2409     m_shouldPaintBrokenImage = shouldPaintBrokenImage;
2410 }
2411 
2412 void TestRunner::setAccummulateLogsForChannel(JSStringRef channel)
2413 {
2414     size_t maxLength = JSStringGetMaximumUTF8CStringSize(channel);
2415     auto buffer = makeUniqueArray&lt;char&gt;(maxLength + 1);
2416     JSStringGetUTF8CString(channel, buffer.get(), maxLength + 1);
2417 
2418     WebCoreTestSupport::setLogChannelToAccumulate({ buffer.get() });
2419 }
2420 
2421 typedef WTF::HashMap&lt;unsigned, JSValueRef&gt; CallbackMap;
2422 static CallbackMap&amp; callbackMap()
2423 {
2424     static CallbackMap&amp; map = *new CallbackMap;
2425     return map;
2426 }
2427 
2428 void TestRunner::cacheTestRunnerCallback(unsigned index, JSValueRef callback)
2429 {
2430     if (!callback)
2431         return;
2432 
2433     if (callbackMap().contains(index)) {
2434         fprintf(stderr, &quot;FAIL: Tried to install a second TestRunner callback for the same event (id %d)\n&quot;, index);
2435         return;
2436     }
2437 
2438     JSContextRef context = mainFrameJSContext();
2439     JSValueProtect(context, callback);
2440     callbackMap().add(index, callback);
2441 }
2442 
2443 void TestRunner::callTestRunnerCallback(unsigned index, size_t argumentCount, const JSValueRef arguments[])
2444 {
2445     if (!callbackMap().contains(index))
2446         return;
2447 
2448     JSContextRef context = mainFrameJSContext();
2449     if (JSObjectRef callback = JSValueToObject(context, callbackMap().take(index), 0)) {
2450         JSObjectCallAsFunction(context, callback, JSContextGetGlobalObject(context), argumentCount, arguments, 0);
2451         JSValueUnprotect(context, callback);
2452     }
2453 }
2454 
2455 void TestRunner::clearTestRunnerCallbacks()
2456 {
2457     JSContextRef context = mainFrameJSContext();
2458 
2459     for (auto&amp; iter : callbackMap()) {
2460         if (JSObjectRef callback = JSValueToObject(context, iter.value, 0))
2461             JSValueUnprotect(context, callback);
2462     }
2463 
2464     callbackMap().clear();
2465 }
2466 
2467 enum {
2468     FirstUIScriptCallbackID = 100
2469 };
2470 
2471 static unsigned nextUIScriptCallbackID()
2472 {
2473     static unsigned callbackID = FirstUIScriptCallbackID;
2474     return callbackID++;
2475 }
2476 
2477 void TestRunner::runUIScript(JSContextRef context, JSStringRef script, JSValueRef callback)
2478 {
2479     m_pendingUIScriptInvocationData = nullptr;
2480 
2481     unsigned callbackID = nextUIScriptCallbackID();
2482     cacheTestRunnerCallback(callbackID, callback);
2483 
2484     if (!m_UIScriptContext)
2485         m_UIScriptContext = makeUniqueWithoutFastMallocCheck&lt;WTR::UIScriptContext&gt;(*this);
2486 
2487     String scriptString(JSStringGetCharactersPtr(script), JSStringGetLength(script));
2488     m_UIScriptContext-&gt;runUIScript(scriptString, callbackID);
2489 }
2490 
2491 void TestRunner::callUIScriptCallback(unsigned callbackID, JSStringRef result)
2492 {
2493     JSRetainPtr&lt;JSStringRef&gt; protectedResult(result);
2494 #if !PLATFORM(IOS_FAMILY)
2495     RunLoop::main().dispatch([protectedThis = makeRef(*this), callbackID, protectedResult]() mutable {
2496         JSContextRef context = protectedThis-&gt;mainFrameJSContext();
2497         JSValueRef resultValue = JSValueMakeString(context, protectedResult.get());
2498         protectedThis-&gt;callTestRunnerCallback(callbackID, 1, &amp;resultValue);
2499     });
2500 #else
2501     WebThreadRun(
2502         makeBlockPtr([protectedThis = makeRef(*this), callbackID, protectedResult] {
2503             JSContextRef context = protectedThis-&gt;mainFrameJSContext();
2504             JSValueRef resultValue = JSValueMakeString(context, protectedResult.get());
2505             protectedThis-&gt;callTestRunnerCallback(callbackID, 1, &amp;resultValue);
2506         }).get()
2507     );
2508 #endif
2509 }
2510 
2511 void TestRunner::uiScriptDidComplete(const String&amp; result, unsigned callbackID)
2512 {
2513     auto stringRef = adopt(JSStringCreateWithUTF8CString(result.utf8().data()));
2514     callUIScriptCallback(callbackID, stringRef.get());
2515 }
2516 
2517 void TestRunner::setAllowsAnySSLCertificate(bool allowsAnySSLCertificate)
2518 {
2519     WebCoreTestSupport::setAllowsAnySSLCertificate(allowsAnySSLCertificate);
2520 }
2521 
2522 void TestRunner::setOpenPanelFiles(JSContextRef context, JSValueRef filesValue)
2523 {
2524     if (!JSValueIsArray(context, filesValue))
2525         return;
2526 
2527     JSObjectRef files = JSValueToObject(context, filesValue, nullptr);
2528     static auto lengthProperty = adopt(JSStringCreateWithUTF8CString(&quot;length&quot;));
2529     JSValueRef filesLengthValue = JSObjectGetProperty(context, files, lengthProperty.get(), nullptr);
2530     if (!JSValueIsNumber(context, filesLengthValue))
2531         return;
2532 
2533     m_openPanelFiles.clear();
2534     auto filesLength = static_cast&lt;size_t&gt;(JSValueToNumber(context, filesLengthValue, nullptr));
2535     for (size_t i = 0; i &lt; filesLength; ++i) {
2536         JSValueRef fileValue = JSObjectGetPropertyAtIndex(context, files, i, nullptr);
2537         if (!JSValueIsString(context, fileValue))
2538             continue;
2539 
2540         auto file = adopt(JSValueToStringCopy(context, fileValue, nullptr));
2541         size_t fileBufferSize = JSStringGetMaximumUTF8CStringSize(file.get()) + 1;
2542         auto fileBuffer = makeUniqueArray&lt;char&gt;(fileBufferSize);
2543         JSStringGetUTF8CString(file.get(), fileBuffer.get(), fileBufferSize);
2544 
2545         m_openPanelFiles.push_back(fileBuffer.get());
2546     }
2547 }
2548 
2549 #if PLATFORM(IOS_FAMILY)
2550 void TestRunner::setOpenPanelFilesMediaIcon(JSContextRef context, JSValueRef mediaIcon)
2551 {
2552     // FIXME (123058): Use a JSC API to get buffer contents once such is exposed.
2553     JSC::VM&amp; vm = toJS(context)-&gt;vm();
2554     JSC::JSLockHolder lock(vm);
2555 
2556     JSC::JSArrayBufferView* jsBufferView = JSC::jsDynamicCast&lt;JSC::JSArrayBufferView*&gt;(vm, toJS(toJS(context), mediaIcon));
2557     ASSERT(jsBufferView);
2558     RefPtr&lt;JSC::ArrayBufferView&gt; bufferView = jsBufferView-&gt;unsharedImpl();
2559     const char* buffer = static_cast&lt;const char*&gt;(bufferView-&gt;baseAddress());
2560     std::vector&lt;char&gt; mediaIconData(buffer, buffer + bufferView-&gt;byteLength());
2561 
2562     m_openPanelFilesMediaIcon = mediaIconData;
2563 }
2564 #endif
2565 
2566 void TestRunner::cleanup()
2567 {
2568     clearTestRunnerCallbacks();
2569 }
2570 
2571 void TestRunner::willNavigate()
2572 {
2573     if (m_shouldSwapToEphemeralSessionOnNextNavigation || m_shouldSwapToDefaultSessionOnNextNavigation) {
2574         ASSERT(m_shouldSwapToEphemeralSessionOnNextNavigation != m_shouldSwapToDefaultSessionOnNextNavigation);
2575         setPrivateBrowsingEnabled(m_shouldSwapToEphemeralSessionOnNextNavigation);
2576         m_shouldSwapToEphemeralSessionOnNextNavigation = false;
2577         m_shouldSwapToDefaultSessionOnNextNavigation = false;
2578     }
2579 }
    </pre>
  </body>
</html>