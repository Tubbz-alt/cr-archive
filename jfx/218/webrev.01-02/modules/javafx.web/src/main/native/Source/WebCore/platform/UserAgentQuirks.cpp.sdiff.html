<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WebCore/platform/UserAgentQuirks.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="Timer.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="UserAgentQuirks.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/platform/UserAgentQuirks.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 19  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 20  * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 21  * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 22  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 23  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #include &quot;config.h&quot;
 27 #include &quot;UserAgentQuirks.h&quot;
 28 
 29 #include &quot;PublicSuffix.h&quot;
 30 #include &lt;wtf/URL.h&gt;
 31 
 32 namespace WebCore {
 33 
 34 // When editing the quirks in this file, be sure to update
 35 // Tools/TestWebKitAPI/Tests/WebCore/UserAgentQuirks.cpp.
 36 
 37 static bool isGoogle(const URL&amp; url)
 38 {
<span class="line-modified"> 39     String baseDomain = topPrivatelyControlledDomain(url.host().toString());</span>

 40 
 41     // Our Google UA is *very* complicated to get right. Read
<span class="line-modified"> 42     // https://webkit.org/b/142074 carefully before changing. Test that Earth</span>
<span class="line-modified"> 43     // view is available in Google Maps. Test Google Calendar. Test downloading</span>
<span class="line-modified"> 44     // the Hangouts browser plugin. Test logging out and logging in to a Google</span>
<span class="line-modified"> 45     // account. Change platformVersionForUAString() to return &quot;FreeBSD amd64&quot;</span>
<span class="line-removed"> 46     // and test everything again.</span>
 47     if (baseDomain.startsWith(&quot;google.&quot;))
 48         return true;
 49     if (baseDomain == &quot;gstatic.com&quot;)
 50         return true;
<span class="line-removed"> 51     if (baseDomain == &quot;googleapis.com&quot;)</span>
<span class="line-removed"> 52         return true;</span>
 53     if (baseDomain == &quot;googleusercontent.com&quot;)
 54         return true;




 55 
 56     return false;
 57 }
 58 
 59 // Be careful with this quirk: it&#39;s an invitation for sites to use JavaScript
 60 // that works in Chrome that WebKit cannot handle. Prefer other quirks instead.
 61 static bool urlRequiresChromeBrowser(const URL&amp; url)
 62 {
<span class="line-modified"> 63     String baseDomain = topPrivatelyControlledDomain(url.host().toString());</span>

 64 
 65     // Needed for fonts on many sites to work with WebKit.
 66     // https://bugs.webkit.org/show_bug.cgi?id=147296
 67     if (baseDomain == &quot;typekit.net&quot; || baseDomain == &quot;typekit.com&quot;)
 68         return true;
 69 





























 70     return false;
 71 }
 72 
 73 static bool urlRequiresMacintoshPlatform(const URL&amp; url)
 74 {
 75     String domain = url.host().toString();
 76     String baseDomain = topPrivatelyControlledDomain(domain);
 77 
 78     // At least finance.yahoo.com displays a mobile version with WebKitGTK&#39;s standard user agent.
 79     if (baseDomain == &quot;yahoo.com&quot;)
 80         return true;
 81 
 82     // taobao.com displays a mobile version with WebKitGTK&#39;s standard user agent.
 83     if (baseDomain == &quot;taobao.com&quot;)
 84         return true;
 85 
 86     // web.whatsapp.com completely blocks users with WebKitGTK&#39;s standard user agent.
 87     if (baseDomain == &quot;whatsapp.com&quot;)
 88         return true;
 89 
 90     // paypal.com completely blocks users with WebKitGTK&#39;s standard user agent.
 91     if (baseDomain == &quot;paypal.com&quot;)
 92         return true;
 93 
 94     // chase.com displays a huge &quot;please update your browser&quot; warning with
 95     // WebKitGTK&#39;s standard user agent.
 96     if (baseDomain == &quot;chase.com&quot;)
 97         return true;
 98 
 99     // Microsoft Outlook Web App forces users with WebKitGTK&#39;s standard user
100     // agent to use the light version. Earlier versions even block users from
101     // accessing the calendar.
102     if (domain == &quot;outlook.live.com&quot;
103         || domain == &quot;mail.ntu.edu.tw&quot;
104         || domain == &quot;exchange.tu-berlin.de&quot;)
105         return true;
106 
<span class="line-removed">107     // Google Docs and Google Drive both show a scary unsupported browser</span>
<span class="line-removed">108     // warning with WebKitGTK&#39;s standard user agent.</span>
<span class="line-removed">109     if (domain == &quot;docs.google.com&quot;</span>
<span class="line-removed">110         || domain == &quot;drive.google.com&quot;)</span>
<span class="line-removed">111         return true;</span>
<span class="line-removed">112 </span>
113     // Bank of America shows an unsupported browser warning with WebKitGTK&#39;s
114     // standard user agent.
115     if (baseDomain == &quot;bankofamerica.com&quot;)
116         return true;
117 
118     return false;
119 }
120 
121 static bool urlRequiresLinuxDesktopPlatform(const URL&amp; url)
122 {
<span class="line-modified">123     // docs.google.com and drive.google.com require the macOS platform quirk.</span>
<span class="line-removed">124     return isGoogle(url)</span>
<span class="line-removed">125         &amp;&amp; url.host() != &quot;docs.google.com&quot;</span>
<span class="line-removed">126         &amp;&amp; url.host() != &quot;drive.google.com&quot;;</span>
127 }
128 
129 UserAgentQuirks UserAgentQuirks::quirksForURL(const URL&amp; url)
130 {
131     ASSERT(!url.isNull());
132 
133     UserAgentQuirks quirks;
134 
135     if (urlRequiresChromeBrowser(url))
136         quirks.add(UserAgentQuirks::NeedsChromeBrowser);


137 
138     if (urlRequiresMacintoshPlatform(url))
139         quirks.add(UserAgentQuirks::NeedsMacintoshPlatform);
140     else if (urlRequiresLinuxDesktopPlatform(url))
141         quirks.add(UserAgentQuirks::NeedsLinuxDesktopPlatform);
142 
143     return quirks;
144 }
145 
146 String UserAgentQuirks::stringForQuirk(UserAgentQuirk quirk)
147 {
148     switch (quirk) {
149     case NeedsChromeBrowser:
150         // Get versions from https://chromium.googlesource.com/chromium/src.git
<span class="line-modified">151         return &quot;Chrome/75.0.3770.141&quot;_s;</span>


152     case NeedsMacintoshPlatform:
153         return &quot;Macintosh; Intel Mac OS X 10_15&quot;_s;
154     case NeedsLinuxDesktopPlatform:
155         return &quot;X11; Linux x86_64&quot;_s;
156     case NumUserAgentQuirks:
157     default:
158         ASSERT_NOT_REACHED();
159     }
160     return &quot;&quot;_s;
161 }
162 
163 }
</pre>
</td>
<td>
<hr />
<pre>
 19  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 20  * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 21  * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 22  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 23  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #include &quot;config.h&quot;
 27 #include &quot;UserAgentQuirks.h&quot;
 28 
 29 #include &quot;PublicSuffix.h&quot;
 30 #include &lt;wtf/URL.h&gt;
 31 
 32 namespace WebCore {
 33 
 34 // When editing the quirks in this file, be sure to update
 35 // Tools/TestWebKitAPI/Tests/WebCore/UserAgentQuirks.cpp.
 36 
 37 static bool isGoogle(const URL&amp; url)
 38 {
<span class="line-modified"> 39     String domain = url.host().toString();</span>
<span class="line-added"> 40     String baseDomain = topPrivatelyControlledDomain(domain);</span>
 41 
 42     // Our Google UA is *very* complicated to get right. Read
<span class="line-modified"> 43     // https://webkit.org/b/142074 carefully before changing. Test that 3D</span>
<span class="line-modified"> 44     // view is available in Google Maps. Test Google Calendar. Test logging out</span>
<span class="line-modified"> 45     // and logging in to a Google account. Change platformVersionForUAString()</span>
<span class="line-modified"> 46     // to return &quot;FreeBSD amd64&quot; and test everything again.</span>

 47     if (baseDomain.startsWith(&quot;google.&quot;))
 48         return true;
 49     if (baseDomain == &quot;gstatic.com&quot;)
 50         return true;


 51     if (baseDomain == &quot;googleusercontent.com&quot;)
 52         return true;
<span class="line-added"> 53     // googleapis.com is in the public suffix list, which is confusing. E.g.</span>
<span class="line-added"> 54     // fonts.googleapis.com is actually a base domain.</span>
<span class="line-added"> 55     if (domain.endsWith(&quot;.googleapis.com&quot;))</span>
<span class="line-added"> 56         return true;</span>
 57 
 58     return false;
 59 }
 60 
 61 // Be careful with this quirk: it&#39;s an invitation for sites to use JavaScript
 62 // that works in Chrome that WebKit cannot handle. Prefer other quirks instead.
 63 static bool urlRequiresChromeBrowser(const URL&amp; url)
 64 {
<span class="line-modified"> 65     String domain = url.host().toString();</span>
<span class="line-added"> 66     String baseDomain = topPrivatelyControlledDomain(domain);</span>
 67 
 68     // Needed for fonts on many sites to work with WebKit.
 69     // https://bugs.webkit.org/show_bug.cgi?id=147296
 70     if (baseDomain == &quot;typekit.net&quot; || baseDomain == &quot;typekit.com&quot;)
 71         return true;
 72 
<span class="line-added"> 73     // This site completely blocks the login page with WebKitGTK&#39;s standard user</span>
<span class="line-added"> 74     // agent and ask users to use Google Chrome or Microsoft Internet Explorer.</span>
<span class="line-added"> 75     if (domain == &quot;auth.mayohr.com&quot;)</span>
<span class="line-added"> 76         return true;</span>
<span class="line-added"> 77 </span>
<span class="line-added"> 78     return false;</span>
<span class="line-added"> 79 }</span>
<span class="line-added"> 80 </span>
<span class="line-added"> 81 // Prefer using the macOS platform quirk rather than the Firefox quirk. This</span>
<span class="line-added"> 82 // quirk is good for websites that do macOS-specific things we don&#39;t want on</span>
<span class="line-added"> 83 // other platforms, and when the risk of the website doing Firefox-specific</span>
<span class="line-added"> 84 // things is relatively low.</span>
<span class="line-added"> 85 static bool urlRequiresFirefoxBrowser(const URL&amp; url)</span>
<span class="line-added"> 86 {</span>
<span class="line-added"> 87     String domain = url.host().toString();</span>
<span class="line-added"> 88 </span>
<span class="line-added"> 89     // This quirk actually has nothing to do with YouTube. It&#39;s needed to avoid</span>
<span class="line-added"> 90     // unsupported browser warnings on Google Docs. After removing this quirk,</span>
<span class="line-added"> 91     // to reproduce the warnings you will need to sign out of Google, then click</span>
<span class="line-added"> 92     // on a link to a non-public document that requires signing in. The</span>
<span class="line-added"> 93     // unsupported browser warning will be displayed after signing in.</span>
<span class="line-added"> 94     if (domain == &quot;accounts.youtube.com&quot; || domain == &quot;docs.google.com&quot;)</span>
<span class="line-added"> 95         return true;</span>
<span class="line-added"> 96 </span>
<span class="line-added"> 97     // Google Drive shows an unsupported browser warning with WebKitGTK&#39;s</span>
<span class="line-added"> 98     // standard user agent.</span>
<span class="line-added"> 99     if (domain == &quot;drive.google.com&quot;)</span>
<span class="line-added">100         return true;</span>
<span class="line-added">101 </span>
102     return false;
103 }
104 
105 static bool urlRequiresMacintoshPlatform(const URL&amp; url)
106 {
107     String domain = url.host().toString();
108     String baseDomain = topPrivatelyControlledDomain(domain);
109 
110     // At least finance.yahoo.com displays a mobile version with WebKitGTK&#39;s standard user agent.
111     if (baseDomain == &quot;yahoo.com&quot;)
112         return true;
113 
114     // taobao.com displays a mobile version with WebKitGTK&#39;s standard user agent.
115     if (baseDomain == &quot;taobao.com&quot;)
116         return true;
117 
118     // web.whatsapp.com completely blocks users with WebKitGTK&#39;s standard user agent.
119     if (baseDomain == &quot;whatsapp.com&quot;)
120         return true;
121 
122     // paypal.com completely blocks users with WebKitGTK&#39;s standard user agent.
123     if (baseDomain == &quot;paypal.com&quot;)
124         return true;
125 
126     // chase.com displays a huge &quot;please update your browser&quot; warning with
127     // WebKitGTK&#39;s standard user agent.
128     if (baseDomain == &quot;chase.com&quot;)
129         return true;
130 
131     // Microsoft Outlook Web App forces users with WebKitGTK&#39;s standard user
132     // agent to use the light version. Earlier versions even block users from
133     // accessing the calendar.
134     if (domain == &quot;outlook.live.com&quot;
135         || domain == &quot;mail.ntu.edu.tw&quot;
136         || domain == &quot;exchange.tu-berlin.de&quot;)
137         return true;
138 






139     // Bank of America shows an unsupported browser warning with WebKitGTK&#39;s
140     // standard user agent.
141     if (baseDomain == &quot;bankofamerica.com&quot;)
142         return true;
143 
144     return false;
145 }
146 
147 static bool urlRequiresLinuxDesktopPlatform(const URL&amp; url)
148 {
<span class="line-modified">149     return isGoogle(url);</span>



150 }
151 
152 UserAgentQuirks UserAgentQuirks::quirksForURL(const URL&amp; url)
153 {
154     ASSERT(!url.isNull());
155 
156     UserAgentQuirks quirks;
157 
158     if (urlRequiresChromeBrowser(url))
159         quirks.add(UserAgentQuirks::NeedsChromeBrowser);
<span class="line-added">160     else if (urlRequiresFirefoxBrowser(url))</span>
<span class="line-added">161         quirks.add(UserAgentQuirks::NeedsFirefoxBrowser);</span>
162 
163     if (urlRequiresMacintoshPlatform(url))
164         quirks.add(UserAgentQuirks::NeedsMacintoshPlatform);
165     else if (urlRequiresLinuxDesktopPlatform(url))
166         quirks.add(UserAgentQuirks::NeedsLinuxDesktopPlatform);
167 
168     return quirks;
169 }
170 
171 String UserAgentQuirks::stringForQuirk(UserAgentQuirk quirk)
172 {
173     switch (quirk) {
174     case NeedsChromeBrowser:
175         // Get versions from https://chromium.googlesource.com/chromium/src.git
<span class="line-modified">176         return &quot;Chrome/83.0.4096.4&quot;_s;</span>
<span class="line-added">177     case NeedsFirefoxBrowser:</span>
<span class="line-added">178         return &quot;; rv:76.0) Gecko/20100101 Firefox/76.0&quot;_s;</span>
179     case NeedsMacintoshPlatform:
180         return &quot;Macintosh; Intel Mac OS X 10_15&quot;_s;
181     case NeedsLinuxDesktopPlatform:
182         return &quot;X11; Linux x86_64&quot;_s;
183     case NumUserAgentQuirks:
184     default:
185         ASSERT_NOT_REACHED();
186     }
187     return &quot;&quot;_s;
188 }
189 
190 }
</pre>
</td>
</tr>
</table>
<center><a href="Timer.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="UserAgentQuirks.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>