<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.web/src/main/native/Source/WebCore/page/csp/ContentSecurityPolicy.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../animation/KeyframeAnimation.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="ContentSecurityPolicy.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/page/csp/ContentSecurityPolicy.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 43,15 ***</span>
  #include &quot;Frame.h&quot;
  #include &quot;HTMLParserIdioms.h&quot;
  #include &quot;InspectorInstrumentation.h&quot;
  #include &quot;JSExecState.h&quot;
  #include &quot;JSWindowProxy.h&quot;
  #include &quot;ParsingUtilities.h&quot;
  #include &quot;PingLoader.h&quot;
  #include &quot;ResourceRequest.h&quot;
<span class="line-removed">- #include &quot;RuntimeEnabledFeatures.h&quot;</span>
<span class="line-removed">- #include &quot;SchemeRegistry.h&quot;</span>
  #include &quot;SecurityOrigin.h&quot;
  #include &quot;SecurityPolicyViolationEvent.h&quot;
  #include &quot;Settings.h&quot;
  #include &quot;TextEncoding.h&quot;
  #include &lt;JavaScriptCore/ScriptCallStack.h&gt;
<span class="line-new-header">--- 43,14 ---</span>
  #include &quot;Frame.h&quot;
  #include &quot;HTMLParserIdioms.h&quot;
  #include &quot;InspectorInstrumentation.h&quot;
  #include &quot;JSExecState.h&quot;
  #include &quot;JSWindowProxy.h&quot;
<span class="line-added">+ #include &quot;LegacySchemeRegistry.h&quot;</span>
  #include &quot;ParsingUtilities.h&quot;
  #include &quot;PingLoader.h&quot;
  #include &quot;ResourceRequest.h&quot;
  #include &quot;SecurityOrigin.h&quot;
  #include &quot;SecurityPolicyViolationEvent.h&quot;
  #include &quot;Settings.h&quot;
  #include &quot;TextEncoding.h&quot;
  #include &lt;JavaScriptCore/ScriptCallStack.h&gt;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 463,11 ***</span>
      if (!foundHashInReportOnlyPolicies)
          allPoliciesWithDispositionAllow(ContentSecurityPolicy::Disposition::ReportOnly, handleViolatedDirective, &amp;ContentSecurityPolicyDirectiveList::violatedDirectiveForUnsafeInlineStyle);
      return foundHashInEnforcedPolicies || allPoliciesWithDispositionAllow(ContentSecurityPolicy::Disposition::Enforce, handleViolatedDirective, &amp;ContentSecurityPolicyDirectiveList::violatedDirectiveForUnsafeInlineStyle);
  }
  
<span class="line-modified">! bool ContentSecurityPolicy::allowEval(JSC::ExecState* state, bool overrideContentSecurityPolicy) const</span>
  {
      if (overrideContentSecurityPolicy)
          return true;
      bool didNotifyInspector = false;
      auto handleViolatedDirective = [&amp;] (const ContentSecurityPolicyDirective&amp; violatedDirective) {
<span class="line-new-header">--- 462,11 ---</span>
      if (!foundHashInReportOnlyPolicies)
          allPoliciesWithDispositionAllow(ContentSecurityPolicy::Disposition::ReportOnly, handleViolatedDirective, &amp;ContentSecurityPolicyDirectiveList::violatedDirectiveForUnsafeInlineStyle);
      return foundHashInEnforcedPolicies || allPoliciesWithDispositionAllow(ContentSecurityPolicy::Disposition::Enforce, handleViolatedDirective, &amp;ContentSecurityPolicyDirectiveList::violatedDirectiveForUnsafeInlineStyle);
  }
  
<span class="line-modified">! bool ContentSecurityPolicy::allowEval(JSC::JSGlobalObject* state, bool overrideContentSecurityPolicy) const</span>
  {
      if (overrideContentSecurityPolicy)
          return true;
      bool didNotifyInspector = false;
      auto handleViolatedDirective = [&amp;] (const ContentSecurityPolicyDirective&amp; violatedDirective) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 538,11 ***</span>
      return allPoliciesAllow(WTFMove(handleViolatedDirective), &amp;ContentSecurityPolicyDirectiveList::violatedDirectiveForPluginType, type, typeAttribute);
  }
  
  bool ContentSecurityPolicy::allowObjectFromSource(const URL&amp; url, RedirectResponseReceived redirectResponseReceived) const
  {
<span class="line-modified">!     if (SchemeRegistry::schemeShouldBypassContentSecurityPolicy(url.protocol().toStringWithoutCopying()))</span>
          return true;
      // As per section object-src of the Content Security Policy Level 3 spec., &lt;http://w3c.github.io/webappsec-csp&gt; (Editor&#39;s Draft, 29 February 2016),
      // &quot;If plugin content is loaded without an associated URL (perhaps an object element lacks a data attribute, but loads some default plugin based
      // on the specified type), it MUST be blocked if object-src&#39;s value is &#39;none&#39;, but will otherwise be allowed&quot;.
      String sourceURL;
<span class="line-new-header">--- 537,11 ---</span>
      return allPoliciesAllow(WTFMove(handleViolatedDirective), &amp;ContentSecurityPolicyDirectiveList::violatedDirectiveForPluginType, type, typeAttribute);
  }
  
  bool ContentSecurityPolicy::allowObjectFromSource(const URL&amp; url, RedirectResponseReceived redirectResponseReceived) const
  {
<span class="line-modified">!     if (LegacySchemeRegistry::schemeShouldBypassContentSecurityPolicy(url.protocol().toStringWithoutCopying()))</span>
          return true;
      // As per section object-src of the Content Security Policy Level 3 spec., &lt;http://w3c.github.io/webappsec-csp&gt; (Editor&#39;s Draft, 29 February 2016),
      // &quot;If plugin content is loaded without an associated URL (perhaps an object element lacks a data attribute, but loads some default plugin based
      // on the specified type), it MUST be blocked if object-src&#39;s value is &#39;none&#39;, but will otherwise be allowed&quot;.
      String sourceURL;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 554,11 ***</span>
      return allPoliciesAllow(WTFMove(handleViolatedDirective), &amp;ContentSecurityPolicyDirectiveList::violatedDirectiveForObjectSource, url, redirectResponseReceived == RedirectResponseReceived::Yes, ContentSecurityPolicySourceListDirective::ShouldAllowEmptyURLIfSourceListIsNotNone::Yes);
  }
  
  bool ContentSecurityPolicy::allowChildFrameFromSource(const URL&amp; url, RedirectResponseReceived redirectResponseReceived) const
  {
<span class="line-modified">!     if (SchemeRegistry::schemeShouldBypassContentSecurityPolicy(url.protocol().toStringWithoutCopying()))</span>
          return true;
      String sourceURL;
      TextPosition sourcePosition(WTF::OrdinalNumber::beforeFirst(), WTF::OrdinalNumber());
      auto handleViolatedDirective = [&amp;] (const ContentSecurityPolicyDirective&amp; violatedDirective) {
          const char* effectiveViolatedDirective = violatedDirective.name() == ContentSecurityPolicyDirectiveNames::frameSrc ? ContentSecurityPolicyDirectiveNames::frameSrc : ContentSecurityPolicyDirectiveNames::childSrc;
<span class="line-new-header">--- 553,11 ---</span>
      return allPoliciesAllow(WTFMove(handleViolatedDirective), &amp;ContentSecurityPolicyDirectiveList::violatedDirectiveForObjectSource, url, redirectResponseReceived == RedirectResponseReceived::Yes, ContentSecurityPolicySourceListDirective::ShouldAllowEmptyURLIfSourceListIsNotNone::Yes);
  }
  
  bool ContentSecurityPolicy::allowChildFrameFromSource(const URL&amp; url, RedirectResponseReceived redirectResponseReceived) const
  {
<span class="line-modified">!     if (LegacySchemeRegistry::schemeShouldBypassContentSecurityPolicy(url.protocol().toStringWithoutCopying()))</span>
          return true;
      String sourceURL;
      TextPosition sourcePosition(WTF::OrdinalNumber::beforeFirst(), WTF::OrdinalNumber());
      auto handleViolatedDirective = [&amp;] (const ContentSecurityPolicyDirective&amp; violatedDirective) {
          const char* effectiveViolatedDirective = violatedDirective.name() == ContentSecurityPolicyDirectiveNames::frameSrc ? ContentSecurityPolicyDirectiveNames::frameSrc : ContentSecurityPolicyDirectiveNames::childSrc;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 568,11 ***</span>
      return allPoliciesAllow(WTFMove(handleViolatedDirective), &amp;ContentSecurityPolicyDirectiveList::violatedDirectiveForFrame, url, redirectResponseReceived == RedirectResponseReceived::Yes);
  }
  
  bool ContentSecurityPolicy::allowResourceFromSource(const URL&amp; url, RedirectResponseReceived redirectResponseReceived, const char* name, ResourcePredicate resourcePredicate) const
  {
<span class="line-modified">!     if (SchemeRegistry::schemeShouldBypassContentSecurityPolicy(url.protocol().toStringWithoutCopying()))</span>
          return true;
      String sourceURL;
      TextPosition sourcePosition(WTF::OrdinalNumber::beforeFirst(), WTF::OrdinalNumber());
      auto handleViolatedDirective = [&amp;] (const ContentSecurityPolicyDirective&amp; violatedDirective) {
          String consoleMessage = consoleMessageForViolation(name, violatedDirective, url, &quot;Refused to load&quot;);
<span class="line-new-header">--- 567,11 ---</span>
      return allPoliciesAllow(WTFMove(handleViolatedDirective), &amp;ContentSecurityPolicyDirectiveList::violatedDirectiveForFrame, url, redirectResponseReceived == RedirectResponseReceived::Yes);
  }
  
  bool ContentSecurityPolicy::allowResourceFromSource(const URL&amp; url, RedirectResponseReceived redirectResponseReceived, const char* name, ResourcePredicate resourcePredicate) const
  {
<span class="line-modified">!     if (LegacySchemeRegistry::schemeShouldBypassContentSecurityPolicy(url.protocol().toStringWithoutCopying()))</span>
          return true;
      String sourceURL;
      TextPosition sourcePosition(WTF::OrdinalNumber::beforeFirst(), WTF::OrdinalNumber());
      auto handleViolatedDirective = [&amp;] (const ContentSecurityPolicyDirective&amp; violatedDirective) {
          String consoleMessage = consoleMessageForViolation(name, violatedDirective, url, &quot;Refused to load&quot;);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 618,11 ***</span>
      return allowResourceFromSource(url, redirectResponseReceived, ContentSecurityPolicyDirectiveNames::mediaSrc, &amp;ContentSecurityPolicyDirectiveList::violatedDirectiveForMedia);
  }
  
  bool ContentSecurityPolicy::allowConnectToSource(const URL&amp; url, RedirectResponseReceived redirectResponseReceived) const
  {
<span class="line-modified">!     if (SchemeRegistry::schemeShouldBypassContentSecurityPolicy(url.protocol().toStringWithoutCopying()))</span>
          return true;
      String sourceURL;
      TextPosition sourcePosition(WTF::OrdinalNumber::beforeFirst(), WTF::OrdinalNumber());
      auto handleViolatedDirective = [&amp;] (const ContentSecurityPolicyDirective&amp; violatedDirective) {
          String consoleMessage = consoleMessageForViolation(ContentSecurityPolicyDirectiveNames::connectSrc, violatedDirective, url, &quot;Refused to connect to&quot;);
<span class="line-new-header">--- 617,11 ---</span>
      return allowResourceFromSource(url, redirectResponseReceived, ContentSecurityPolicyDirectiveNames::mediaSrc, &amp;ContentSecurityPolicyDirectiveList::violatedDirectiveForMedia);
  }
  
  bool ContentSecurityPolicy::allowConnectToSource(const URL&amp; url, RedirectResponseReceived redirectResponseReceived) const
  {
<span class="line-modified">!     if (LegacySchemeRegistry::schemeShouldBypassContentSecurityPolicy(url.protocol().toStringWithoutCopying()))</span>
          return true;
      String sourceURL;
      TextPosition sourcePosition(WTF::OrdinalNumber::beforeFirst(), WTF::OrdinalNumber());
      auto handleViolatedDirective = [&amp;] (const ContentSecurityPolicyDirective&amp; violatedDirective) {
          String consoleMessage = consoleMessageForViolation(ContentSecurityPolicyDirectiveNames::connectSrc, violatedDirective, url, &quot;Refused to connect to&quot;);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 638,11 ***</span>
  
  bool ContentSecurityPolicy::allowBaseURI(const URL&amp; url, bool overrideContentSecurityPolicy) const
  {
      if (overrideContentSecurityPolicy)
          return true;
<span class="line-modified">!     if (SchemeRegistry::schemeShouldBypassContentSecurityPolicy(url.protocol().toStringWithoutCopying()))</span>
          return true;
      String sourceURL;
      TextPosition sourcePosition(WTF::OrdinalNumber::beforeFirst(), WTF::OrdinalNumber());
      auto handleViolatedDirective = [&amp;] (const ContentSecurityPolicyDirective&amp; violatedDirective) {
          String consoleMessage = consoleMessageForViolation(ContentSecurityPolicyDirectiveNames::baseURI, violatedDirective, url, &quot;Refused to change the document base URL to&quot;);
<span class="line-new-header">--- 637,11 ---</span>
  
  bool ContentSecurityPolicy::allowBaseURI(const URL&amp; url, bool overrideContentSecurityPolicy) const
  {
      if (overrideContentSecurityPolicy)
          return true;
<span class="line-modified">!     if (LegacySchemeRegistry::schemeShouldBypassContentSecurityPolicy(url.protocol().toStringWithoutCopying()))</span>
          return true;
      String sourceURL;
      TextPosition sourcePosition(WTF::OrdinalNumber::beforeFirst(), WTF::OrdinalNumber());
      auto handleViolatedDirective = [&amp;] (const ContentSecurityPolicyDirective&amp; violatedDirective) {
          String consoleMessage = consoleMessageForViolation(ContentSecurityPolicyDirectiveNames::baseURI, violatedDirective, url, &quot;Refused to change the document base URL to&quot;);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 658,28 ***</span>
      if (!url.isHierarchical() || url.protocolIs(&quot;file&quot;))
          return url.protocol().toString();
      return static_cast&lt;SecurityOriginData&gt;(*m_selfSource).securityOrigin()-&gt;canRequest(url) ? url.strippedForUseAsReferrer() : SecurityOrigin::create(url)-&gt;toString();
  }
  
<span class="line-modified">! void ContentSecurityPolicy::reportViolation(const String&amp; violatedDirective, const ContentSecurityPolicyDirective&amp; effectiveViolatedDirective, const URL&amp; blockedURL, const String&amp; consoleMessage, JSC::ExecState* state) const</span>
  {
      // FIXME: Extract source file and source position from JSC::ExecState.
      return reportViolation(violatedDirective, effectiveViolatedDirective.text(), effectiveViolatedDirective.directiveList(), blockedURL, consoleMessage, String(), TextPosition(WTF::OrdinalNumber::beforeFirst(), WTF::OrdinalNumber::beforeFirst()), state);
  }
  
<span class="line-modified">! void ContentSecurityPolicy::reportViolation(const String&amp; effectiveViolatedDirective, const String&amp; violatedDirective, const ContentSecurityPolicyDirectiveList&amp; violatedDirectiveList, const URL&amp; blockedURL, const String&amp; consoleMessage, JSC::ExecState* state) const</span>
  {
      // FIXME: Extract source file and source position from JSC::ExecState.
      return reportViolation(effectiveViolatedDirective, violatedDirective, violatedDirectiveList, blockedURL, consoleMessage, String(), TextPosition(WTF::OrdinalNumber::beforeFirst(), WTF::OrdinalNumber::beforeFirst()), state);
  }
  
<span class="line-modified">! void ContentSecurityPolicy::reportViolation(const String&amp; effectiveViolatedDirective, const ContentSecurityPolicyDirective&amp; violatedDirective, const URL&amp; blockedURL, const String&amp; consoleMessage, const String&amp; sourceURL, const TextPosition&amp; sourcePosition, JSC::ExecState* state) const</span>
  {
      return reportViolation(effectiveViolatedDirective, violatedDirective.text(), violatedDirective.directiveList(), blockedURL, consoleMessage, sourceURL, sourcePosition, state);
  }
  
<span class="line-modified">! void ContentSecurityPolicy::reportViolation(const String&amp; effectiveViolatedDirective, const String&amp; violatedDirective, const ContentSecurityPolicyDirectiveList&amp; violatedDirectiveList, const URL&amp; blockedURL, const String&amp; consoleMessage, const String&amp; sourceURL, const TextPosition&amp; sourcePosition, JSC::ExecState* state) const</span>
  {
      logToConsole(consoleMessage, sourceURL, sourcePosition.m_line, sourcePosition.m_column, state);
  
      if (!m_isReportingEnabled)
          return;
<span class="line-new-header">--- 657,28 ---</span>
      if (!url.isHierarchical() || url.protocolIs(&quot;file&quot;))
          return url.protocol().toString();
      return static_cast&lt;SecurityOriginData&gt;(*m_selfSource).securityOrigin()-&gt;canRequest(url) ? url.strippedForUseAsReferrer() : SecurityOrigin::create(url)-&gt;toString();
  }
  
<span class="line-modified">! void ContentSecurityPolicy::reportViolation(const String&amp; violatedDirective, const ContentSecurityPolicyDirective&amp; effectiveViolatedDirective, const URL&amp; blockedURL, const String&amp; consoleMessage, JSC::JSGlobalObject* state) const</span>
  {
      // FIXME: Extract source file and source position from JSC::ExecState.
      return reportViolation(violatedDirective, effectiveViolatedDirective.text(), effectiveViolatedDirective.directiveList(), blockedURL, consoleMessage, String(), TextPosition(WTF::OrdinalNumber::beforeFirst(), WTF::OrdinalNumber::beforeFirst()), state);
  }
  
<span class="line-modified">! void ContentSecurityPolicy::reportViolation(const String&amp; effectiveViolatedDirective, const String&amp; violatedDirective, const ContentSecurityPolicyDirectiveList&amp; violatedDirectiveList, const URL&amp; blockedURL, const String&amp; consoleMessage, JSC::JSGlobalObject* state) const</span>
  {
      // FIXME: Extract source file and source position from JSC::ExecState.
      return reportViolation(effectiveViolatedDirective, violatedDirective, violatedDirectiveList, blockedURL, consoleMessage, String(), TextPosition(WTF::OrdinalNumber::beforeFirst(), WTF::OrdinalNumber::beforeFirst()), state);
  }
  
<span class="line-modified">! void ContentSecurityPolicy::reportViolation(const String&amp; effectiveViolatedDirective, const ContentSecurityPolicyDirective&amp; violatedDirective, const URL&amp; blockedURL, const String&amp; consoleMessage, const String&amp; sourceURL, const TextPosition&amp; sourcePosition, JSC::JSGlobalObject* state) const</span>
  {
      return reportViolation(effectiveViolatedDirective, violatedDirective.text(), violatedDirective.directiveList(), blockedURL, consoleMessage, sourceURL, sourcePosition, state);
  }
  
<span class="line-modified">! void ContentSecurityPolicy::reportViolation(const String&amp; effectiveViolatedDirective, const String&amp; violatedDirective, const ContentSecurityPolicyDirectiveList&amp; violatedDirectiveList, const URL&amp; blockedURL, const String&amp; consoleMessage, const String&amp; sourceURL, const TextPosition&amp; sourcePosition, JSC::JSGlobalObject* state) const</span>
  {
      logToConsole(consoleMessage, sourceURL, sourcePosition.m_line, sourcePosition.m_column, state);
  
      if (!m_isReportingEnabled)
          return;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 856,11 ***</span>
  void ContentSecurityPolicy::reportMissingReportURI(const String&amp; policy) const
  {
      logToConsole(&quot;The Content Security Policy &#39;&quot; + policy + &quot;&#39; was delivered in report-only mode, but does not specify a &#39;report-uri&#39;; the policy will have no effect. Please either add a &#39;report-uri&#39; directive, or deliver the policy via the &#39;Content-Security-Policy&#39; header.&quot;);
  }
  
<span class="line-modified">! void ContentSecurityPolicy::logToConsole(const String&amp; message, const String&amp; contextURL, const WTF::OrdinalNumber&amp; contextLine, const WTF::OrdinalNumber&amp; contextColumn, JSC::ExecState* state) const</span>
  {
      if (!m_isReportingEnabled)
          return;
  
      if (m_client)
<span class="line-new-header">--- 855,11 ---</span>
  void ContentSecurityPolicy::reportMissingReportURI(const String&amp; policy) const
  {
      logToConsole(&quot;The Content Security Policy &#39;&quot; + policy + &quot;&#39; was delivered in report-only mode, but does not specify a &#39;report-uri&#39;; the policy will have no effect. Please either add a &#39;report-uri&#39; directive, or deliver the policy via the &#39;Content-Security-Policy&#39; header.&quot;);
  }
  
<span class="line-modified">! void ContentSecurityPolicy::logToConsole(const String&amp; message, const String&amp; contextURL, const WTF::OrdinalNumber&amp; contextLine, const WTF::OrdinalNumber&amp; contextColumn, JSC::JSGlobalObject* state) const</span>
  {
      if (!m_isReportingEnabled)
          return;
  
      if (m_client)
</pre>
<center><a href="../animation/KeyframeAnimation.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="ContentSecurityPolicy.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>