<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WebKitLegacy/Storage/StorageThread.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="StorageNamespaceImpl.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="StorageThread.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebKitLegacy/Storage/StorageThread.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 26 #include &quot;StorageThread.h&quot;
 27 
 28 #include &lt;wtf/AutodrainedPool.h&gt;
 29 #include &lt;wtf/HashSet.h&gt;
 30 #include &lt;wtf/MainThread.h&gt;
 31 #include &lt;wtf/NeverDestroyed.h&gt;
 32 
 33 #if PLATFORM(JAVA)
 34 #include &lt;wtf/java/JavaEnv.h&gt;
 35 #endif
 36 
 37 namespace WebCore {
 38 
 39 static HashSet&lt;StorageThread*&gt;&amp; activeStorageThreads()
 40 {
 41     ASSERT(isMainThread());
 42     static NeverDestroyed&lt;HashSet&lt;StorageThread*&gt;&gt; threads;
 43     return threads;
 44 }
 45 
<span class="line-modified"> 46 StorageThread::StorageThread()</span>

 47 {
 48     ASSERT(isMainThread());
 49 }
 50 
 51 StorageThread::~StorageThread()
 52 {
 53     ASSERT(isMainThread());
 54     ASSERT(!m_thread);
 55 }
 56 
 57 void StorageThread::start()
 58 {
 59     ASSERT(isMainThread());
 60     if (!m_thread) {
<span class="line-modified"> 61         m_thread = Thread::create(&quot;WebCore: LocalStorage&quot;, [this] {</span>
<span class="line-modified"> 62             threadEntryPoint();</span>
<span class="line-modified"> 63         });</span>







 64     }
 65     activeStorageThreads().add(this);
 66 }
 67 
 68 void StorageThread::threadEntryPoint()
 69 {
 70 #if PLATFORM(JAVA)
 71     WTF::AttachThreadAsDaemonToJavaEnv autoAttach;
 72 #endif
 73     ASSERT(!isMainThread());
 74 
 75     while (auto function = m_queue.waitForMessage()) {
 76         AutodrainedPool pool;
 77         (*function)();
 78     }
 79 }
 80 
 81 void StorageThread::dispatch(Function&lt;void ()&gt;&amp;&amp; function)
 82 {
 83     ASSERT(isMainThread());
</pre>
</td>
<td>
<hr />
<pre>
 26 #include &quot;StorageThread.h&quot;
 27 
 28 #include &lt;wtf/AutodrainedPool.h&gt;
 29 #include &lt;wtf/HashSet.h&gt;
 30 #include &lt;wtf/MainThread.h&gt;
 31 #include &lt;wtf/NeverDestroyed.h&gt;
 32 
 33 #if PLATFORM(JAVA)
 34 #include &lt;wtf/java/JavaEnv.h&gt;
 35 #endif
 36 
 37 namespace WebCore {
 38 
 39 static HashSet&lt;StorageThread*&gt;&amp; activeStorageThreads()
 40 {
 41     ASSERT(isMainThread());
 42     static NeverDestroyed&lt;HashSet&lt;StorageThread*&gt;&gt; threads;
 43     return threads;
 44 }
 45 
<span class="line-modified"> 46 StorageThread::StorageThread(Type type)</span>
<span class="line-added"> 47     : m_type(type)</span>
 48 {
 49     ASSERT(isMainThread());
 50 }
 51 
 52 StorageThread::~StorageThread()
 53 {
 54     ASSERT(isMainThread());
 55     ASSERT(!m_thread);
 56 }
 57 
 58 void StorageThread::start()
 59 {
 60     ASSERT(isMainThread());
 61     if (!m_thread) {
<span class="line-modified"> 62         if (m_type == Type::LocalStorage) {</span>
<span class="line-modified"> 63             m_thread = Thread::create(&quot;LocalStorage&quot;, [this] {</span>
<span class="line-modified"> 64                 threadEntryPoint();</span>
<span class="line-added"> 65             });</span>
<span class="line-added"> 66         } else {</span>
<span class="line-added"> 67             ASSERT(m_type == Type::IndexedDB);</span>
<span class="line-added"> 68             m_thread = Thread::create(&quot;IndexedDB&quot;, [this] {</span>
<span class="line-added"> 69                 threadEntryPoint();</span>
<span class="line-added"> 70             });</span>
<span class="line-added"> 71         }</span>
 72     }
 73     activeStorageThreads().add(this);
 74 }
 75 
 76 void StorageThread::threadEntryPoint()
 77 {
 78 #if PLATFORM(JAVA)
 79     WTF::AttachThreadAsDaemonToJavaEnv autoAttach;
 80 #endif
 81     ASSERT(!isMainThread());
 82 
 83     while (auto function = m_queue.waitForMessage()) {
 84         AutodrainedPool pool;
 85         (*function)();
 86     }
 87 }
 88 
 89 void StorageThread::dispatch(Function&lt;void ()&gt;&amp;&amp; function)
 90 {
 91     ASSERT(isMainThread());
</pre>
</td>
</tr>
</table>
<center><a href="StorageNamespaceImpl.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="StorageThread.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>