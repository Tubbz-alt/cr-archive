<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.web/src/main/native/Source/WebCore/html/track/WebVTTParser.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="VideoTrackList.idl.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="WebVTTParser.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/html/track/WebVTTParser.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,9 ***</span>
  /*
   * Copyright (C) 2011, 2013 Google Inc.  All rights reserved.
   * Copyright (C) 2013 Cable Television Labs, Inc.
<span class="line-modified">!  * Copyright (C) 2011-2014 Apple Inc.  All rights reserved.</span>
   *
   * Redistribution and use in source and binary forms, with or without
   * modification, are permitted provided that the following conditions are
   * met:
   *
<span class="line-new-header">--- 1,9 ---</span>
  /*
   * Copyright (C) 2011, 2013 Google Inc.  All rights reserved.
   * Copyright (C) 2013 Cable Television Labs, Inc.
<span class="line-modified">!  * Copyright (C) 2011-2020 Apple Inc.  All rights reserved.</span>
   *
   * Redistribution and use in source and binary forms, with or without
   * modification, are permitted provided that the following conditions are
   * met:
   *
</pre>
<hr />
<pre>
<span class="line-old-header">*** 313,11 ***</span>
  {
      // End of style block
      if (checkAndStoreStyleSheet(line))
          return checkAndRecoverCue(line);
  
<span class="line-modified">!     m_currentStyleSheet.append(line);</span>
      return Style;
  }
  
  bool WebVTTParser::checkAndCreateRegion(const String&amp; line)
  {
<span class="line-new-header">--- 313,11 ---</span>
  {
      // End of style block
      if (checkAndStoreStyleSheet(line))
          return checkAndRecoverCue(line);
  
<span class="line-modified">!     m_currentSourceStyleSheet.append(line);</span>
      return Style;
  }
  
  bool WebVTTParser::checkAndCreateRegion(const String&amp; line)
  {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 369,14 ***</span>
  bool WebVTTParser::checkAndStoreStyleSheet(const String&amp; line)
  {
      if (!line.isEmpty() &amp;&amp; !line.contains(&quot;--&gt;&quot;))
          return false;
  
<span class="line-modified">!     auto styleSheet = WTFMove(m_currentStyleSheet);</span>
  
<span class="line-modified">!     auto contents = StyleSheetContents::create();</span>
<span class="line-modified">!     if (!contents-&gt;parseString(styleSheet))</span>
          return true;
  
      auto&amp; namespaceRules = contents-&gt;namespaceRules();
      if (namespaceRules.size())
          return true;
<span class="line-new-header">--- 369,15 ---</span>
  bool WebVTTParser::checkAndStoreStyleSheet(const String&amp; line)
  {
      if (!line.isEmpty() &amp;&amp; !line.contains(&quot;--&gt;&quot;))
          return false;
  
<span class="line-modified">!     auto styleSheetText = WTFMove(m_currentSourceStyleSheet);</span>
  
<span class="line-modified">!     // WebVTTMode disallows non-data URLs.</span>
<span class="line-modified">!     auto contents = StyleSheetContents::create(CSSParserContext(WebVTTMode));</span>
<span class="line-added">+     if (!contents-&gt;parseString(styleSheetText))</span>
          return true;
  
      auto&amp; namespaceRules = contents-&gt;namespaceRules();
      if (namespaceRules.size())
          return true;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 387,24 ***</span>
  
      auto&amp; childRules = contents-&gt;childRules();
      if (!childRules.size())
          return true;
  
<span class="line-modified">!     for (auto rule : childRules) {</span>
          if (!rule-&gt;isStyleRule())
              return true;
<span class="line-modified">!         const auto&amp; styleRule = downcast&lt;StyleRule&gt;(rule.get());</span>
  
<span class="line-modified">!         const auto&amp; selectorList = styleRule-&gt;selectorList();</span>
          if (selectorList.listSize() != 1)
              return true;
          auto selector = selectorList.selectorAt(0);
<span class="line-modified">!         if (selector-&gt;selectorText() != &quot;::cue&quot;)</span>
              return true;
      }
  
<span class="line-modified">!     m_styleSheets.append(styleSheet);</span>
      return true;
  }
  
  WebVTTParser::ParseState WebVTTParser::collectCueId(const String&amp; line)
  {
<span class="line-new-header">--- 388,37 ---</span>
  
      auto&amp; childRules = contents-&gt;childRules();
      if (!childRules.size())
          return true;
  
<span class="line-modified">!     StringBuilder sanitizedStyleSheetBuilder;</span>
<span class="line-added">+ </span>
<span class="line-added">+     for (const auto&amp; rule : childRules) {</span>
          if (!rule-&gt;isStyleRule())
              return true;
<span class="line-modified">!         const auto&amp; styleRule = downcast&lt;StyleRule&gt;(*rule);</span>
  
<span class="line-modified">!         const auto&amp; selectorList = styleRule.selectorList();</span>
          if (selectorList.listSize() != 1)
              return true;
          auto selector = selectorList.selectorAt(0);
<span class="line-modified">!         auto selectorText = selector-&gt;selectorText();</span>
<span class="line-added">+ </span>
<span class="line-added">+         bool isCue = selectorText == &quot;::cue&quot; || selectorText.startsWith(&quot;::cue(&quot;);</span>
<span class="line-added">+         if (!isCue)</span>
              return true;
<span class="line-added">+ </span>
<span class="line-added">+         if (styleRule.properties().isEmpty())</span>
<span class="line-added">+             continue;</span>
<span class="line-added">+ </span>
<span class="line-added">+         sanitizedStyleSheetBuilder.append(selectorText, &quot; { &quot;, styleRule.properties().asText(), &quot;  }\n&quot;);</span>
      }
  
<span class="line-modified">!     // It would be more stylish to parse the stylesheet only once instead of serializing a sanitized version.</span>
<span class="line-added">+     if (!sanitizedStyleSheetBuilder.isEmpty())</span>
<span class="line-added">+         m_styleSheets.append(sanitizedStyleSheetBuilder.toString());</span>
<span class="line-added">+ </span>
      return true;
  }
  
  WebVTTParser::ParseState WebVTTParser::collectCueId(const String&amp; line)
  {
</pre>
<center><a href="VideoTrackList.idl.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="WebVTTParser.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>