<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.web/src/main/native/Source/WebCore/editing/VisiblePosition.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="TypingCommand.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="VisiblePosition.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/editing/VisiblePosition.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 134,11 ***</span>
          while (true) {
              if ((renderer-&gt;isReplaced() || renderer-&gt;isBR()) &amp;&amp; offset == box-&gt;caretRightmostOffset())
                  return box-&gt;isLeftToRightDirection() ? previousVisuallyDistinctCandidate(m_deepPosition) : nextVisuallyDistinctCandidate(m_deepPosition);
  
              if (!renderer-&gt;node()) {
<span class="line-modified">!                 box = box-&gt;prevLeafChild();</span>
                  if (!box)
                      return primaryDirection == TextDirection::LTR ? previousVisuallyDistinctCandidate(m_deepPosition) : nextVisuallyDistinctCandidate(m_deepPosition);
                  renderer = &amp;box-&gt;renderer();
                  offset = box-&gt;caretRightmostOffset();
                  continue;
<span class="line-new-header">--- 134,11 ---</span>
          while (true) {
              if ((renderer-&gt;isReplaced() || renderer-&gt;isBR()) &amp;&amp; offset == box-&gt;caretRightmostOffset())
                  return box-&gt;isLeftToRightDirection() ? previousVisuallyDistinctCandidate(m_deepPosition) : nextVisuallyDistinctCandidate(m_deepPosition);
  
              if (!renderer-&gt;node()) {
<span class="line-modified">!                 box = box-&gt;previousLeafOnLine();</span>
                  if (!box)
                      return primaryDirection == TextDirection::LTR ? previousVisuallyDistinctCandidate(m_deepPosition) : nextVisuallyDistinctCandidate(m_deepPosition);
                  renderer = &amp;box-&gt;renderer();
                  offset = box-&gt;caretRightmostOffset();
                  continue;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 152,11 ***</span>
              if (offset &gt; caretMinOffset &amp;&amp; offset &lt; caretMaxOffset)
                  break;
  
              if (box-&gt;isLeftToRightDirection() ? offset &lt; caretMinOffset : offset &gt; caretMaxOffset) {
                  // Overshot to the left.
<span class="line-modified">!                 InlineBox* prevBox = box-&gt;prevLeafChildIgnoringLineBreak();</span>
                  if (!prevBox) {
                      Position positionOnLeft = primaryDirection == TextDirection::LTR ? previousVisuallyDistinctCandidate(m_deepPosition) : nextVisuallyDistinctCandidate(m_deepPosition);
                      if (positionOnLeft.isNull())
                          return Position();
  
<span class="line-new-header">--- 152,11 ---</span>
              if (offset &gt; caretMinOffset &amp;&amp; offset &lt; caretMaxOffset)
                  break;
  
              if (box-&gt;isLeftToRightDirection() ? offset &lt; caretMinOffset : offset &gt; caretMaxOffset) {
                  // Overshot to the left.
<span class="line-modified">!                 InlineBox* prevBox = box-&gt;previousLeafOnLineIgnoringLineBreak();</span>
                  if (!prevBox) {
                      Position positionOnLeft = primaryDirection == TextDirection::LTR ? previousVisuallyDistinctCandidate(m_deepPosition) : nextVisuallyDistinctCandidate(m_deepPosition);
                      if (positionOnLeft.isNull())
                          return Position();
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 176,11 ***</span>
              }
  
              ASSERT(offset == box-&gt;caretLeftmostOffset());
  
              unsigned char level = box-&gt;bidiLevel();
<span class="line-modified">!             InlineBox* prevBox = box-&gt;prevLeafChild();</span>
  
              if (box-&gt;direction() == primaryDirection) {
                  if (!prevBox) {
                      InlineBox* logicalStart = nullptr;
                      if (primaryDirection == TextDirection::LTR ? box-&gt;root().getLogicalStartBoxWithNode(logicalStart) : box-&gt;root().getLogicalEndBoxWithNode(logicalStart)) {
<span class="line-new-header">--- 176,11 ---</span>
              }
  
              ASSERT(offset == box-&gt;caretLeftmostOffset());
  
              unsigned char level = box-&gt;bidiLevel();
<span class="line-modified">!             InlineBox* prevBox = box-&gt;previousLeafOnLine();</span>
  
              if (box-&gt;direction() == primaryDirection) {
                  if (!prevBox) {
                      InlineBox* logicalStart = nullptr;
                      if (primaryDirection == TextDirection::LTR ? box-&gt;root().getLogicalStartBoxWithNode(logicalStart) : box-&gt;root().getLogicalEndBoxWithNode(logicalStart)) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 195,11 ***</span>
  
                  level = prevBox-&gt;bidiLevel();
  
                  InlineBox* nextBox = box;
                  do {
<span class="line-modified">!                     nextBox = nextBox-&gt;nextLeafChild();</span>
                  } while (nextBox &amp;&amp; nextBox-&gt;bidiLevel() &gt; level);
  
                  if (nextBox &amp;&amp; nextBox-&gt;bidiLevel() == level)
                      break;
  
<span class="line-new-header">--- 195,11 ---</span>
  
                  level = prevBox-&gt;bidiLevel();
  
                  InlineBox* nextBox = box;
                  do {
<span class="line-modified">!                     nextBox = nextBox-&gt;nextLeafOnLine();</span>
                  } while (nextBox &amp;&amp; nextBox-&gt;bidiLevel() &gt; level);
  
                  if (nextBox &amp;&amp; nextBox-&gt;bidiLevel() == level)
                      break;
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 210,36 ***</span>
                      break;
                  continue;
              }
  
              while (prevBox &amp;&amp; !prevBox-&gt;renderer().node())
<span class="line-modified">!                 prevBox = prevBox-&gt;prevLeafChild();</span>
  
              if (prevBox) {
                  box = prevBox;
                  renderer = &amp;box-&gt;renderer();
                  offset = box-&gt;caretRightmostOffset();
                  if (box-&gt;bidiLevel() &gt; level) {
                      do {
<span class="line-modified">!                         prevBox = prevBox-&gt;prevLeafChild();</span>
                      } while (prevBox &amp;&amp; prevBox-&gt;bidiLevel() &gt; level);
  
                      if (!prevBox || prevBox-&gt;bidiLevel() &lt; level)
                          continue;
                  }
              } else {
                  // Trailing edge of a secondary run. Set to the leading edge of the entire run.
                  while (true) {
<span class="line-modified">!                     while (InlineBox* nextBox = box-&gt;nextLeafChild()) {</span>
                          if (nextBox-&gt;bidiLevel() &lt; level)
                              break;
                          box = nextBox;
                      }
                      if (box-&gt;bidiLevel() == level)
                          break;
                      level = box-&gt;bidiLevel();
<span class="line-modified">!                     while (InlineBox* prevBox = box-&gt;prevLeafChild()) {</span>
                          if (prevBox-&gt;bidiLevel() &lt; level)
                              break;
                          box = prevBox;
                      }
                      if (box-&gt;bidiLevel() == level)
<span class="line-new-header">--- 210,36 ---</span>
                      break;
                  continue;
              }
  
              while (prevBox &amp;&amp; !prevBox-&gt;renderer().node())
<span class="line-modified">!                 prevBox = prevBox-&gt;previousLeafOnLine();</span>
  
              if (prevBox) {
                  box = prevBox;
                  renderer = &amp;box-&gt;renderer();
                  offset = box-&gt;caretRightmostOffset();
                  if (box-&gt;bidiLevel() &gt; level) {
                      do {
<span class="line-modified">!                         prevBox = prevBox-&gt;previousLeafOnLine();</span>
                      } while (prevBox &amp;&amp; prevBox-&gt;bidiLevel() &gt; level);
  
                      if (!prevBox || prevBox-&gt;bidiLevel() &lt; level)
                          continue;
                  }
              } else {
                  // Trailing edge of a secondary run. Set to the leading edge of the entire run.
                  while (true) {
<span class="line-modified">!                     while (InlineBox* nextBox = box-&gt;nextLeafOnLine()) {</span>
                          if (nextBox-&gt;bidiLevel() &lt; level)
                              break;
                          box = nextBox;
                      }
                      if (box-&gt;bidiLevel() == level)
                          break;
                      level = box-&gt;bidiLevel();
<span class="line-modified">!                     while (InlineBox* prevBox = box-&gt;previousLeafOnLine()) {</span>
                          if (prevBox-&gt;bidiLevel() &lt; level)
                              break;
                          box = prevBox;
                      }
                      if (box-&gt;bidiLevel() == level)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 304,11 ***</span>
          while (true) {
              if ((renderer-&gt;isReplaced() || renderer-&gt;isBR()) &amp;&amp; offset == box-&gt;caretLeftmostOffset())
                  return box-&gt;isLeftToRightDirection() ? nextVisuallyDistinctCandidate(m_deepPosition) : previousVisuallyDistinctCandidate(m_deepPosition);
  
              if (!renderer-&gt;node()) {
<span class="line-modified">!                 box = box-&gt;nextLeafChild();</span>
                  if (!box)
                      return primaryDirection == TextDirection::LTR ? nextVisuallyDistinctCandidate(m_deepPosition) : previousVisuallyDistinctCandidate(m_deepPosition);
                  renderer = &amp;box-&gt;renderer();
                  offset = box-&gt;caretLeftmostOffset();
                  continue;
<span class="line-new-header">--- 304,11 ---</span>
          while (true) {
              if ((renderer-&gt;isReplaced() || renderer-&gt;isBR()) &amp;&amp; offset == box-&gt;caretLeftmostOffset())
                  return box-&gt;isLeftToRightDirection() ? nextVisuallyDistinctCandidate(m_deepPosition) : previousVisuallyDistinctCandidate(m_deepPosition);
  
              if (!renderer-&gt;node()) {
<span class="line-modified">!                 box = box-&gt;nextLeafOnLine();</span>
                  if (!box)
                      return primaryDirection == TextDirection::LTR ? nextVisuallyDistinctCandidate(m_deepPosition) : previousVisuallyDistinctCandidate(m_deepPosition);
                  renderer = &amp;box-&gt;renderer();
                  offset = box-&gt;caretLeftmostOffset();
                  continue;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 322,11 ***</span>
              if (offset &gt; caretMinOffset &amp;&amp; offset &lt; caretMaxOffset)
                  break;
  
              if (box-&gt;isLeftToRightDirection() ? offset &gt; caretMaxOffset : offset &lt; caretMinOffset) {
                  // Overshot to the right.
<span class="line-modified">!                 InlineBox* nextBox = box-&gt;nextLeafChildIgnoringLineBreak();</span>
                  if (!nextBox) {
                      Position positionOnRight = primaryDirection == TextDirection::LTR ? nextVisuallyDistinctCandidate(m_deepPosition) : previousVisuallyDistinctCandidate(m_deepPosition);
                      if (positionOnRight.isNull())
                          return Position();
  
<span class="line-new-header">--- 322,11 ---</span>
              if (offset &gt; caretMinOffset &amp;&amp; offset &lt; caretMaxOffset)
                  break;
  
              if (box-&gt;isLeftToRightDirection() ? offset &gt; caretMaxOffset : offset &lt; caretMinOffset) {
                  // Overshot to the right.
<span class="line-modified">!                 InlineBox* nextBox = box-&gt;nextLeafOnLineIgnoringLineBreak();</span>
                  if (!nextBox) {
                      Position positionOnRight = primaryDirection == TextDirection::LTR ? nextVisuallyDistinctCandidate(m_deepPosition) : previousVisuallyDistinctCandidate(m_deepPosition);
                      if (positionOnRight.isNull())
                          return Position();
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 346,11 ***</span>
              }
  
              ASSERT(offset == box-&gt;caretRightmostOffset());
  
              unsigned char level = box-&gt;bidiLevel();
<span class="line-modified">!             InlineBox* nextBox = box-&gt;nextLeafChild();</span>
  
              if (box-&gt;direction() == primaryDirection) {
                  if (!nextBox) {
                      InlineBox* logicalEnd = nullptr;
                      if (primaryDirection == TextDirection::LTR ? box-&gt;root().getLogicalEndBoxWithNode(logicalEnd) : box-&gt;root().getLogicalStartBoxWithNode(logicalEnd)) {
<span class="line-new-header">--- 346,11 ---</span>
              }
  
              ASSERT(offset == box-&gt;caretRightmostOffset());
  
              unsigned char level = box-&gt;bidiLevel();
<span class="line-modified">!             InlineBox* nextBox = box-&gt;nextLeafOnLine();</span>
  
              if (box-&gt;direction() == primaryDirection) {
                  if (!nextBox) {
                      InlineBox* logicalEnd = nullptr;
                      if (primaryDirection == TextDirection::LTR ? box-&gt;root().getLogicalEndBoxWithNode(logicalEnd) : box-&gt;root().getLogicalStartBoxWithNode(logicalEnd)) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 366,11 ***</span>
  
                  level = nextBox-&gt;bidiLevel();
  
                  InlineBox* prevBox = box;
                  do {
<span class="line-modified">!                     prevBox = prevBox-&gt;prevLeafChild();</span>
                  } while (prevBox &amp;&amp; prevBox-&gt;bidiLevel() &gt; level);
  
                  if (prevBox &amp;&amp; prevBox-&gt;bidiLevel() == level)   // For example, abc FED 123 ^ CBA
                      break;
  
<span class="line-new-header">--- 366,11 ---</span>
  
                  level = nextBox-&gt;bidiLevel();
  
                  InlineBox* prevBox = box;
                  do {
<span class="line-modified">!                     prevBox = prevBox-&gt;previousLeafOnLine();</span>
                  } while (prevBox &amp;&amp; prevBox-&gt;bidiLevel() &gt; level);
  
                  if (prevBox &amp;&amp; prevBox-&gt;bidiLevel() == level)   // For example, abc FED 123 ^ CBA
                      break;
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 382,37 ***</span>
                      break;
                  continue;
              }
  
              while (nextBox &amp;&amp; !nextBox-&gt;renderer().node())
<span class="line-modified">!                 nextBox = nextBox-&gt;nextLeafChild();</span>
  
              if (nextBox) {
                  box = nextBox;
                  renderer = &amp;box-&gt;renderer();
                  offset = box-&gt;caretLeftmostOffset();
  
                  if (box-&gt;bidiLevel() &gt; level) {
                      do {
<span class="line-modified">!                         nextBox = nextBox-&gt;nextLeafChild();</span>
                      } while (nextBox &amp;&amp; nextBox-&gt;bidiLevel() &gt; level);
  
                      if (!nextBox || nextBox-&gt;bidiLevel() &lt; level)
                          continue;
                  }
              } else {
                  // Trailing edge of a secondary run. Set to the leading edge of the entire run.
                  while (true) {
<span class="line-modified">!                     while (InlineBox* prevBox = box-&gt;prevLeafChild()) {</span>
                          if (prevBox-&gt;bidiLevel() &lt; level)
                              break;
                          box = prevBox;
                      }
                      if (box-&gt;bidiLevel() == level)
                          break;
                      level = box-&gt;bidiLevel();
<span class="line-modified">!                     while (InlineBox* nextBox = box-&gt;nextLeafChild()) {</span>
                          if (nextBox-&gt;bidiLevel() &lt; level)
                              break;
                          box = nextBox;
                      }
                      if (box-&gt;bidiLevel() == level)
<span class="line-new-header">--- 382,37 ---</span>
                      break;
                  continue;
              }
  
              while (nextBox &amp;&amp; !nextBox-&gt;renderer().node())
<span class="line-modified">!                 nextBox = nextBox-&gt;nextLeafOnLine();</span>
  
              if (nextBox) {
                  box = nextBox;
                  renderer = &amp;box-&gt;renderer();
                  offset = box-&gt;caretLeftmostOffset();
  
                  if (box-&gt;bidiLevel() &gt; level) {
                      do {
<span class="line-modified">!                         nextBox = nextBox-&gt;nextLeafOnLine();</span>
                      } while (nextBox &amp;&amp; nextBox-&gt;bidiLevel() &gt; level);
  
                      if (!nextBox || nextBox-&gt;bidiLevel() &lt; level)
                          continue;
                  }
              } else {
                  // Trailing edge of a secondary run. Set to the leading edge of the entire run.
                  while (true) {
<span class="line-modified">!                     while (InlineBox* prevBox = box-&gt;previousLeafOnLine()) {</span>
                          if (prevBox-&gt;bidiLevel() &lt; level)
                              break;
                          box = prevBox;
                      }
                      if (box-&gt;bidiLevel() == level)
                          break;
                      level = box-&gt;bidiLevel();
<span class="line-modified">!                     while (InlineBox* nextBox = box-&gt;nextLeafOnLine()) {</span>
                          if (nextBox-&gt;bidiLevel() &lt; level)
                              break;
                          box = nextBox;
                      }
                      if (box-&gt;bidiLevel() == level)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 665,10 ***</span>
<span class="line-new-header">--- 665,31 ---</span>
      RenderBlock* renderer = nullptr;
      LayoutRect localRect = localCaretRectInRendererForCaretPainting(*this, renderer);
      return absoluteBoundsForLocalCaretRect(renderer, localRect, insideFixed);
  }
  
<span class="line-added">+ FloatRect VisiblePosition::absoluteSelectionBoundsForLine() const</span>
<span class="line-added">+ {</span>
<span class="line-added">+     if (m_deepPosition.isNull())</span>
<span class="line-added">+         return { };</span>
<span class="line-added">+ </span>
<span class="line-added">+     auto* node = m_deepPosition.anchorNode();</span>
<span class="line-added">+     if (!node-&gt;renderer())</span>
<span class="line-added">+         return { };</span>
<span class="line-added">+ </span>
<span class="line-added">+     InlineBox* inlineBox = nullptr;</span>
<span class="line-added">+     int caretOffset = 0;</span>
<span class="line-added">+     getInlineBoxAndOffset(inlineBox, caretOffset);</span>
<span class="line-added">+ </span>
<span class="line-added">+     if (!inlineBox)</span>
<span class="line-added">+         return { };</span>
<span class="line-added">+ </span>
<span class="line-added">+     auto&amp; root = inlineBox-&gt;root();</span>
<span class="line-added">+     auto localRect = FloatRect { root.x(), root.selectionTop(), root.width(), root.selectionHeight() };</span>
<span class="line-added">+     return root.renderer().localToAbsoluteQuad(localRect).boundingBox();</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
  int VisiblePosition::lineDirectionPointForBlockDirectionNavigation() const
  {
      RenderObject* renderer;
      LayoutRect localRect = localCaretRect(renderer);
      if (localRect.isEmpty() || !renderer)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 786,10 ***</span>
<span class="line-new-header">--- 807,15 ---</span>
  
      VisiblePosition next = visiblePosition.next();
      return next.isNull() || !next.deepEquivalent().deprecatedNode()-&gt;isDescendantOf(node);
  }
  
<span class="line-added">+ bool areVisiblePositionsInSameTreeScope(const VisiblePosition&amp; a, const VisiblePosition&amp; b)</span>
<span class="line-added">+ {</span>
<span class="line-added">+     return areNodesConnectedInSameTreeScope(a.deepEquivalent().anchorNode(), b.deepEquivalent().anchorNode());</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
  bool VisiblePosition::equals(const VisiblePosition&amp; other) const
  {
      return m_affinity == other.m_affinity &amp;&amp; m_deepPosition.equals(other.m_deepPosition);
  }
  
</pre>
<center><a href="TypingCommand.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="VisiblePosition.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>