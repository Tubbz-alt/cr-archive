<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/JavaScriptCore/bytecode/Instruction.h</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="InstanceOfVariant.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="InstructionStream.cpp.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/JavaScriptCore/bytecode/Instruction.h</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -28,118 +28,155 @@</span>
  #include &quot;Opcode.h&quot;
  #include &quot;OpcodeSize.h&quot;
  
  namespace JSC {
  
<span class="udiff-line-modified-removed">- struct Instruction {</span>
<span class="udiff-line-modified-added">+ struct JSOpcodeTraits {</span>
<span class="udiff-line-added">+     using OpcodeID = ::JSC::OpcodeID;</span>
<span class="udiff-line-added">+     static constexpr OpcodeID numberOfBytecodesWithMetadata = static_cast&lt;OpcodeID&gt;(NUMBER_OF_BYTECODE_WITH_METADATA);</span>
<span class="udiff-line-added">+     static constexpr OpcodeID wide16 = op_wide16;</span>
<span class="udiff-line-added">+     static constexpr OpcodeID wide32 = op_wide32;</span>
<span class="udiff-line-added">+     static constexpr const unsigned* opcodeLengths = ::JSC::opcodeLengths;</span>
<span class="udiff-line-added">+     static constexpr const char* const* opcodeNames = ::JSC::opcodeNames;</span>
<span class="udiff-line-added">+ };</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ struct WasmOpcodeTraits {</span>
<span class="udiff-line-added">+     using OpcodeID = WasmOpcodeID;</span>
<span class="udiff-line-added">+     static constexpr OpcodeID numberOfBytecodesWithMetadata = static_cast&lt;OpcodeID&gt;(NUMBER_OF_WASM_WITH_METADATA);</span>
<span class="udiff-line-added">+     static constexpr OpcodeID wide16 = wasm_wide16;</span>
<span class="udiff-line-added">+     static constexpr OpcodeID wide32 = wasm_wide32;</span>
<span class="udiff-line-added">+     static constexpr const unsigned* opcodeLengths = wasmOpcodeLengths;</span>
<span class="udiff-line-added">+     static constexpr const char* const* opcodeNames = wasmOpcodeNames;</span>
<span class="udiff-line-added">+ };</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ template&lt;typename Opcode&gt;</span>
<span class="udiff-line-added">+ struct BaseInstruction {</span>
  
      struct Metadata { };
  
  protected:
<span class="udiff-line-modified-removed">-     Instruction()</span>
<span class="udiff-line-modified-added">+     BaseInstruction()</span>
      { }
  
  private:
      template&lt;OpcodeSize Width&gt;
      class Impl {
      public:
<span class="udiff-line-modified-removed">-         OpcodeID opcodeID() const { return static_cast&lt;OpcodeID&gt;(m_opcode); }</span>
<span class="udiff-line-modified-added">+         template&lt;typename Traits = JSOpcodeTraits&gt;</span>
<span class="udiff-line-added">+         typename Traits::OpcodeID opcodeID() const { return static_cast&lt;typename Traits::OpcodeID&gt;(m_opcode); }</span>
  
      private:
<span class="udiff-line-modified-removed">-         typename TypeBySize&lt;Width&gt;::unsignedType m_opcode;</span>
<span class="udiff-line-modified-added">+         typename TypeBySize&lt;OpcodeSize::Narrow&gt;::unsignedType m_opcode;</span>
      };
  
  public:
<span class="udiff-line-modified-removed">-     OpcodeID opcodeID() const</span>
<span class="udiff-line-modified-added">+     template&lt;typename Traits = JSOpcodeTraits&gt;</span>
<span class="udiff-line-added">+     typename Traits::OpcodeID opcodeID() const</span>
      {
<span class="udiff-line-modified-removed">-         if (isWide32())</span>
<span class="udiff-line-modified-removed">-             return wide32()-&gt;opcodeID();</span>
<span class="udiff-line-modified-removed">-         if (isWide16())</span>
<span class="udiff-line-modified-removed">-             return wide16()-&gt;opcodeID();</span>
<span class="udiff-line-modified-removed">-         return narrow()-&gt;opcodeID();</span>
<span class="udiff-line-modified-added">+         if (isWide32&lt;Traits&gt;())</span>
<span class="udiff-line-modified-added">+             return wide32&lt;Traits&gt;()-&gt;template opcodeID&lt;Traits&gt;();</span>
<span class="udiff-line-modified-added">+         if (isWide16&lt;Traits&gt;())</span>
<span class="udiff-line-modified-added">+             return wide16&lt;Traits&gt;()-&gt;template opcodeID&lt;Traits&gt;();</span>
<span class="udiff-line-modified-added">+         return narrow()-&gt;template opcodeID&lt;Traits&gt;();</span>
      }
  
<span class="udiff-line-added">+     template&lt;typename Traits = JSOpcodeTraits&gt;</span>
      const char* name() const
      {
<span class="udiff-line-modified-removed">-         return opcodeNames[opcodeID()];</span>
<span class="udiff-line-modified-added">+         return Traits::opcodeNames[opcodeID()];</span>
      }
  
<span class="udiff-line-added">+     template&lt;typename Traits = JSOpcodeTraits&gt;</span>
      bool isWide16() const
      {
<span class="udiff-line-modified-removed">-         return narrow()-&gt;opcodeID() == op_wide16;</span>
<span class="udiff-line-modified-added">+         return narrow()-&gt;template opcodeID&lt;Traits&gt;() == Traits::wide16;</span>
      }
  
<span class="udiff-line-added">+     template&lt;typename Traits = JSOpcodeTraits&gt;</span>
      bool isWide32() const
      {
<span class="udiff-line-modified-removed">-         return narrow()-&gt;opcodeID() == op_wide32;</span>
<span class="udiff-line-modified-added">+         return narrow()-&gt;template opcodeID&lt;Traits&gt;() == Traits::wide32;</span>
      }
  
<span class="udiff-line-added">+     template&lt;typename Traits = JSOpcodeTraits&gt;</span>
      bool hasMetadata() const
      {
<span class="udiff-line-modified-removed">-         return opcodeID() &lt; NUMBER_OF_BYTECODE_WITH_METADATA;</span>
<span class="udiff-line-modified-added">+         return opcodeID&lt;Traits&gt;() &lt; Traits::numberOfBytecodesWithMetadata;</span>
      }
  
<span class="udiff-line-added">+     template&lt;typename Traits = JSOpcodeTraits&gt;</span>
      int sizeShiftAmount() const
      {
<span class="udiff-line-modified-removed">-         if (isWide32())</span>
<span class="udiff-line-modified-added">+         if (isWide32&lt;Traits&gt;())</span>
              return 2;
<span class="udiff-line-modified-removed">-         if (isWide16())</span>
<span class="udiff-line-modified-added">+         if (isWide16&lt;Traits&gt;())</span>
              return 1;
          return 0;
      }
  
<span class="udiff-line-added">+     template&lt;typename Traits = JSOpcodeTraits&gt;</span>
      size_t size() const
      {
<span class="udiff-line-modified-removed">-         auto sizeShiftAmount = this-&gt;sizeShiftAmount();</span>
<span class="udiff-line-modified-removed">-         auto padding = sizeShiftAmount ? 1 : 0;</span>
<span class="udiff-line-modified-removed">-         auto size = 1 &lt;&lt; sizeShiftAmount;</span>
<span class="udiff-line-modified-removed">-         return opcodeLengths[opcodeID()] * size + padding;</span>
<span class="udiff-line-modified-added">+         auto sizeShiftAmount = this-&gt;sizeShiftAmount&lt;Traits&gt;();</span>
<span class="udiff-line-modified-added">+         size_t prefixSize = sizeShiftAmount ? 1 : 0;</span>
<span class="udiff-line-modified-added">+         size_t operandSize = static_cast&lt;size_t&gt;(1) &lt;&lt; sizeShiftAmount;</span>
<span class="udiff-line-modified-added">+         size_t sizeOfBytecode = 1;</span>
<span class="udiff-line-added">+         return sizeOfBytecode + (Traits::opcodeLengths[opcodeID&lt;Traits&gt;()] - 1) * operandSize + prefixSize;</span>
      }
  
<span class="udiff-line-modified-removed">-     template&lt;class T&gt;</span>
<span class="udiff-line-modified-added">+     template&lt;class T, typename Traits = JSOpcodeTraits&gt;</span>
      bool is() const
      {
<span class="udiff-line-modified-removed">-         return opcodeID() == T::opcodeID;</span>
<span class="udiff-line-modified-added">+         return opcodeID&lt;Traits&gt;() == T::opcodeID;</span>
      }
  
<span class="udiff-line-modified-removed">-     template&lt;class T&gt;</span>
<span class="udiff-line-modified-added">+     template&lt;class T, typename Traits = JSOpcodeTraits&gt;</span>
      T as() const
      {
<span class="udiff-line-modified-removed">-         ASSERT(is&lt;T&gt;());</span>
<span class="udiff-line-modified-added">+         ASSERT((is&lt;T, Traits&gt;()));</span>
          return T::decode(reinterpret_cast&lt;const uint8_t*&gt;(this));
      }
  
<span class="udiff-line-modified-removed">-     template&lt;class T&gt;</span>
<span class="udiff-line-modified-added">+     template&lt;class T, typename Traits = JSOpcodeTraits&gt;</span>
      T* cast()
      {
<span class="udiff-line-modified-removed">-         ASSERT(is&lt;T&gt;());</span>
<span class="udiff-line-modified-added">+         ASSERT((is&lt;T, Traits&gt;()));</span>
          return bitwise_cast&lt;T*&gt;(this);
      }
  
<span class="udiff-line-modified-removed">-     template&lt;class T&gt;</span>
<span class="udiff-line-modified-added">+     template&lt;class T, typename Traits = JSOpcodeTraits&gt;</span>
      const T* cast() const
      {
<span class="udiff-line-modified-removed">-         ASSERT(is&lt;T&gt;());</span>
<span class="udiff-line-modified-added">+         ASSERT((is&lt;T, Traits&gt;()));</span>
          return reinterpret_cast&lt;const T*&gt;(this);
      }
  
      const Impl&lt;OpcodeSize::Narrow&gt;* narrow() const
      {
          return reinterpret_cast&lt;const Impl&lt;OpcodeSize::Narrow&gt;*&gt;(this);
      }
  
<span class="udiff-line-added">+     template&lt;typename Traits = JSOpcodeTraits&gt;</span>
      const Impl&lt;OpcodeSize::Wide16&gt;* wide16() const
      {
  
<span class="udiff-line-modified-removed">-         ASSERT(isWide16());</span>
<span class="udiff-line-modified-added">+         ASSERT(isWide16&lt;Traits&gt;());</span>
          return reinterpret_cast&lt;const Impl&lt;OpcodeSize::Wide16&gt;*&gt;(bitwise_cast&lt;uintptr_t&gt;(this) + 1);
      }
  
<span class="udiff-line-added">+     template&lt;typename Traits = JSOpcodeTraits&gt;</span>
      const Impl&lt;OpcodeSize::Wide32&gt;* wide32() const
      {
  
<span class="udiff-line-modified-removed">-         ASSERT(isWide32());</span>
<span class="udiff-line-modified-added">+         ASSERT(isWide32&lt;Traits&gt;());</span>
          return reinterpret_cast&lt;const Impl&lt;OpcodeSize::Wide32&gt;*&gt;(bitwise_cast&lt;uintptr_t&gt;(this) + 1);
      }
  };
  
<span class="udiff-line-added">+ struct Instruction : public BaseInstruction&lt;OpcodeID&gt; {</span>
<span class="udiff-line-added">+ };</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ struct WasmInstance : public BaseInstruction&lt;WasmOpcodeID&gt; {</span>
<span class="udiff-line-added">+ };</span>
<span class="udiff-line-added">+ </span>
  } // namespace JSC
</pre>
<center><a href="InstanceOfVariant.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="InstructionStream.cpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>