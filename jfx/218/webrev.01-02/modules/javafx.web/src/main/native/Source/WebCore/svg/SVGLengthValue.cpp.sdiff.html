<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WebCore/svg/SVGLengthValue.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="SVGLengthList.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="SVGLengthValue.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/svg/SVGLengthValue.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
  2  * Copyright (C) 2004, 2005, 2006 Nikolas Zimmermann &lt;zimmermann@kde.org&gt;
  3  * Copyright (C) 2004, 2005, 2006, 2007 Rob Buis &lt;buis@kde.org&gt;
<span class="line-modified">  4  * Copyright (C) 2007 Apple Inc. All rights reserved.</span>
  5  *
  6  * This library is free software; you can redistribute it and/or
  7  * modify it under the terms of the GNU Library General Public
  8  * License as published by the Free Software Foundation; either
  9  * version 2 of the License, or (at your option) any later version.
 10  *
 11  * This library is distributed in the hope that it will be useful,
 12  * but WITHOUT ANY WARRANTY; without even the implied warranty of
 13  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 14  * Library General Public License for more details.
 15  *
 16  * You should have received a copy of the GNU Library General Public License
 17  * along with this library; see the file COPYING.LIB.  If not, write to
 18  * the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
 19  * Boston, MA 02110-1301, USA.
 20  */
 21 
 22 #include &quot;config.h&quot;
 23 #include &quot;SVGLengthValue.h&quot;
 24 
<span class="line-modified"> 25 #include &quot;CSSHelper.h&quot;</span>
 26 #include &quot;CSSPrimitiveValue.h&quot;
<span class="line-modified"> 27 #include &quot;FloatConversion.h&quot;</span>
<span class="line-removed"> 28 #include &quot;SVGNames.h&quot;</span>
 29 #include &quot;SVGParserUtilities.h&quot;
<span class="line-removed"> 30 #include &lt;wtf/MathExtras.h&gt;</span>
<span class="line-removed"> 31 #include &lt;wtf/NeverDestroyed.h&gt;</span>
 32 #include &lt;wtf/text/StringConcatenateNumbers.h&gt;
 33 #include &lt;wtf/text/TextStream.h&gt;
 34 
 35 namespace WebCore {
 36 
<span class="line-modified"> 37 // Helper functions</span>
<span class="line-removed"> 38 static inline unsigned storeUnit(SVGLengthMode mode, SVGLengthType type)</span>
 39 {
<span class="line-modified"> 40     return (mode &lt;&lt; 4) | type;</span>
<span class="line-modified"> 41 }</span>
<span class="line-modified"> 42 </span>
<span class="line-removed"> 43 static inline SVGLengthMode extractMode(unsigned unit)</span>
<span class="line-removed"> 44 {</span>
<span class="line-removed"> 45     unsigned mode = unit &gt;&gt; 4;</span>
<span class="line-removed"> 46     return static_cast&lt;SVGLengthMode&gt;(mode);</span>
<span class="line-removed"> 47 }</span>
<span class="line-removed"> 48 </span>
<span class="line-removed"> 49 static inline SVGLengthType extractType(unsigned unit)</span>
<span class="line-removed"> 50 {</span>
<span class="line-removed"> 51     return static_cast&lt;SVGLengthType&gt;(unit &amp; ((1 &lt;&lt; 4) - 1));</span>
<span class="line-removed"> 52 }</span>
<span class="line-removed"> 53 </span>
<span class="line-removed"> 54 static inline const char* lengthTypeToString(SVGLengthType type)</span>
<span class="line-removed"> 55 {</span>
<span class="line-removed"> 56     switch (type) {</span>
<span class="line-removed"> 57     case LengthTypeUnknown:</span>
<span class="line-removed"> 58     case LengthTypeNumber:</span>
 59         return &quot;&quot;;
<span class="line-modified"> 60     case LengthTypePercentage:</span>
 61         return &quot;%&quot;;
<span class="line-modified"> 62     case LengthTypeEMS:</span>
 63         return &quot;em&quot;;
<span class="line-modified"> 64     case LengthTypeEXS:</span>
 65         return &quot;ex&quot;;
<span class="line-modified"> 66     case LengthTypePX:</span>
 67         return &quot;px&quot;;
<span class="line-modified"> 68     case LengthTypeCM:</span>
 69         return &quot;cm&quot;;
<span class="line-modified"> 70     case LengthTypeMM:</span>
 71         return &quot;mm&quot;;
<span class="line-modified"> 72     case LengthTypeIN:</span>
 73         return &quot;in&quot;;
<span class="line-modified"> 74     case LengthTypePT:</span>
 75         return &quot;pt&quot;;
<span class="line-modified"> 76     case LengthTypePC:</span>
 77         return &quot;pc&quot;;
 78     }
 79 
 80     ASSERT_NOT_REACHED();
 81     return &quot;&quot;;
 82 }
 83 
<span class="line-modified"> 84 inline SVGLengthType parseLengthType(const UChar* ptr, const UChar* end)</span>
 85 {
 86     if (ptr == end)
<span class="line-modified"> 87         return LengthTypeNumber;</span>
 88 
 89     const UChar firstChar = *ptr;
 90 
 91     if (++ptr == end)
<span class="line-modified"> 92         return firstChar == &#39;%&#39; ? LengthTypePercentage : LengthTypeUnknown;</span>
 93 
 94     const UChar secondChar = *ptr;
 95 
 96     if (++ptr != end)
<span class="line-modified"> 97         return LengthTypeUnknown;</span>
 98 
 99     if (firstChar == &#39;e&#39; &amp;&amp; secondChar == &#39;m&#39;)
<span class="line-modified">100         return LengthTypeEMS;</span>
101     if (firstChar == &#39;e&#39; &amp;&amp; secondChar == &#39;x&#39;)
<span class="line-modified">102         return LengthTypeEXS;</span>
103     if (firstChar == &#39;p&#39; &amp;&amp; secondChar == &#39;x&#39;)
<span class="line-modified">104         return LengthTypePX;</span>
105     if (firstChar == &#39;c&#39; &amp;&amp; secondChar == &#39;m&#39;)
<span class="line-modified">106         return LengthTypeCM;</span>
107     if (firstChar == &#39;m&#39; &amp;&amp; secondChar == &#39;m&#39;)
<span class="line-modified">108         return LengthTypeMM;</span>
109     if (firstChar == &#39;i&#39; &amp;&amp; secondChar == &#39;n&#39;)
<span class="line-modified">110         return LengthTypeIN;</span>
111     if (firstChar == &#39;p&#39; &amp;&amp; secondChar == &#39;t&#39;)
<span class="line-modified">112         return LengthTypePT;</span>
113     if (firstChar == &#39;p&#39; &amp;&amp; secondChar == &#39;c&#39;)
<span class="line-modified">114         return LengthTypePC;</span>
115 
<span class="line-modified">116     return LengthTypeUnknown;</span>
117 }
118 
<span class="line-modified">119 SVGLengthValue::SVGLengthValue(SVGLengthMode mode, const String&amp; valueAsString)</span>
<span class="line-removed">120     : m_unit(storeUnit(mode, LengthTypeNumber))</span>
121 {
<span class="line-modified">122     setValueAsString(valueAsString);</span>



























123 }
124 
<span class="line-modified">125 SVGLengthValue::SVGLengthValue(const SVGLengthContext&amp; context, float value, SVGLengthMode mode, SVGLengthType unitType)</span>
<span class="line-removed">126     : m_unit(storeUnit(mode, unitType))</span>
127 {
<span class="line-modified">128     setValue(value, context);</span>


























129 }
130 
<span class="line-modified">131 ExceptionOr&lt;void&gt; SVGLengthValue::setValueAsString(const String&amp; valueAsString, SVGLengthMode mode)</span>

132 {
<span class="line-modified">133     m_valueInSpecifiedUnits = 0;</span>
<span class="line-removed">134     m_unit = storeUnit(mode, LengthTypeNumber);</span>
<span class="line-removed">135     return setValueAsString(valueAsString);</span>
136 }
137 
<span class="line-modified">138 bool SVGLengthValue::operator==(const SVGLengthValue&amp; other) const</span>



139 {
<span class="line-modified">140     return m_unit == other.m_unit &amp;&amp; m_valueInSpecifiedUnits == other.m_valueInSpecifiedUnits;</span>
141 }
142 
<span class="line-modified">143 bool SVGLengthValue::operator!=(const SVGLengthValue&amp; other) const</span>


144 {
<span class="line-modified">145     return !operator==(other);</span>
146 }
147 
<span class="line-modified">148 SVGLengthValue SVGLengthValue::construct(SVGLengthMode mode, const String&amp; valueAsString, SVGParsingError&amp; parseError, SVGLengthNegativeValuesMode negativeValuesMode)</span>
149 {
<span class="line-modified">150     SVGLengthValue length(mode);</span>
151 
152     if (length.setValueAsString(valueAsString).hasException())
153         parseError = ParsingAttributeFailedError;
<span class="line-modified">154     else if (negativeValuesMode == ForbidNegativeLengths &amp;&amp; length.valueInSpecifiedUnits() &lt; 0)</span>
155         parseError = NegativeValueForbiddenError;
156 
157     return length;
158 }
159 
<span class="line-modified">160 SVGLengthType SVGLengthValue::unitType() const</span>



































161 {
<span class="line-modified">162     return extractType(m_unit);</span>


163 }
164 
<span class="line-modified">165 SVGLengthMode SVGLengthValue::unitMode() const</span>
166 {
<span class="line-modified">167     return extractMode(m_unit);</span>








168 }
169 
170 float SVGLengthValue::value(const SVGLengthContext&amp; context) const
171 {
172     auto result = valueForBindings(context);
173     if (result.hasException())
174         return 0;
175     return result.releaseReturnValue();
176 }
177 
<span class="line-modified">178 ExceptionOr&lt;float&gt; SVGLengthValue::valueForBindings(const SVGLengthContext&amp; context) const</span>
179 {
<span class="line-modified">180     return context.convertValueToUserUnits(m_valueInSpecifiedUnits, extractMode(m_unit), extractType(m_unit));</span>
181 }
182 
<span class="line-modified">183 ExceptionOr&lt;void&gt; SVGLengthValue::setValue(const SVGLengthContext&amp; context, float value, SVGLengthMode mode, SVGLengthType unitType)</span>
184 {
<span class="line-modified">185     // FIXME: Seems like a bug that we change the value of m_unit even if setValue throws an exception.</span>
<span class="line-removed">186     m_unit = storeUnit(mode, unitType);</span>
<span class="line-removed">187     return setValue(value, context);</span>
188 }
189 
<span class="line-modified">190 ExceptionOr&lt;void&gt; SVGLengthValue::setValue(float value, const SVGLengthContext&amp; context)</span>
191 {
192     // 100% = 100.0 instead of 1.0 for historical reasons, this could eventually be changed
<span class="line-modified">193     if (extractType(m_unit) == LengthTypePercentage)</span>
194         value = value / 100;
195 
<span class="line-modified">196     auto convertedValue = context.convertValueFromUserUnits(value, extractMode(m_unit), extractType(m_unit));</span>
197     if (convertedValue.hasException())
198         return convertedValue.releaseException();
199     m_valueInSpecifiedUnits = convertedValue.releaseReturnValue();
200     return { };
201 }
<span class="line-removed">202 float SVGLengthValue::valueAsPercentage() const</span>
<span class="line-removed">203 {</span>
<span class="line-removed">204     // 100% = 100.0 instead of 1.0 for historical reasons, this could eventually be changed</span>
<span class="line-removed">205     if (extractType(m_unit) == LengthTypePercentage)</span>
<span class="line-removed">206         return m_valueInSpecifiedUnits / 100;</span>
207 
<span class="line-modified">208     return m_valueInSpecifiedUnits;</span>





209 }
210 
211 ExceptionOr&lt;void&gt; SVGLengthValue::setValueAsString(const String&amp; string)
212 {
213     if (string.isEmpty())
214         return { };
215 
216     float convertedNumber = 0;
217     auto upconvertedCharacters = StringView(string).upconvertedCharacters();
218     const UChar* ptr = upconvertedCharacters;
219     const UChar* end = ptr + string.length();
220 
221     if (!parseNumber(ptr, end, convertedNumber, false))
222         return Exception { SyntaxError };
223 
<span class="line-modified">224     auto type = parseLengthType(ptr, end);</span>
<span class="line-modified">225     if (type == LengthTypeUnknown)</span>
226         return Exception { SyntaxError };
227 
<span class="line-modified">228     m_unit = storeUnit(extractMode(m_unit), type);</span>
229     m_valueInSpecifiedUnits = convertedNumber;
230     return { };
231 }
232 
<span class="line-modified">233 String SVGLengthValue::valueAsString() const</span>
<span class="line-removed">234 {</span>
<span class="line-removed">235     return makeString(FormattedNumber::fixedPrecision(m_valueInSpecifiedUnits), lengthTypeToString(extractType(m_unit)));</span>
<span class="line-removed">236 }</span>
<span class="line-removed">237 </span>
<span class="line-removed">238 ExceptionOr&lt;void&gt; SVGLengthValue::newValueSpecifiedUnits(unsigned short type, float value)</span>
<span class="line-removed">239 {</span>
<span class="line-removed">240     if (type == LengthTypeUnknown || type &gt; LengthTypePC)</span>
<span class="line-removed">241         return Exception { NotSupportedError };</span>
<span class="line-removed">242 </span>
<span class="line-removed">243     m_unit = storeUnit(extractMode(m_unit), static_cast&lt;SVGLengthType&gt;(type));</span>
<span class="line-removed">244     m_valueInSpecifiedUnits = value;</span>
<span class="line-removed">245     return { };</span>
<span class="line-removed">246 }</span>
<span class="line-removed">247 </span>
<span class="line-removed">248 ExceptionOr&lt;void&gt; SVGLengthValue::convertToSpecifiedUnits(unsigned short type, const SVGLengthContext&amp; context)</span>
249 {
<span class="line-removed">250     if (type == LengthTypeUnknown || type &gt; LengthTypePC)</span>
<span class="line-removed">251         return Exception { NotSupportedError };</span>
<span class="line-removed">252 </span>
253     auto valueInUserUnits = valueForBindings(context);
254     if (valueInUserUnits.hasException())
255         return valueInUserUnits.releaseException();
256 
<span class="line-modified">257     auto originalUnitAndType = m_unit;</span>
<span class="line-modified">258     m_unit = storeUnit(extractMode(m_unit), static_cast&lt;SVGLengthType&gt;(type));</span>
<span class="line-modified">259     auto result = setValue(valueInUserUnits.releaseReturnValue(), context);</span>
<span class="line-modified">260     if (result.hasException()) {</span>
<span class="line-removed">261         m_unit = originalUnitAndType;</span>
<span class="line-removed">262         return result.releaseException();</span>
<span class="line-removed">263     }</span>
<span class="line-removed">264 </span>
<span class="line-removed">265     return { };</span>
<span class="line-removed">266 }</span>
<span class="line-removed">267 </span>
<span class="line-removed">268 SVGLengthValue SVGLengthValue::fromCSSPrimitiveValue(const CSSPrimitiveValue&amp; value)</span>
<span class="line-removed">269 {</span>
<span class="line-removed">270     SVGLengthType type;</span>
<span class="line-removed">271     switch (value.primitiveType()) {</span>
<span class="line-removed">272     case CSSPrimitiveValue::CSS_NUMBER:</span>
<span class="line-removed">273         type = LengthTypeNumber;</span>
<span class="line-removed">274         break;</span>
<span class="line-removed">275     case CSSPrimitiveValue::CSS_PERCENTAGE:</span>
<span class="line-removed">276         type = LengthTypePercentage;</span>
<span class="line-removed">277         break;</span>
<span class="line-removed">278     case CSSPrimitiveValue::CSS_EMS:</span>
<span class="line-removed">279         type = LengthTypeEMS;</span>
<span class="line-removed">280         break;</span>
<span class="line-removed">281     case CSSPrimitiveValue::CSS_EXS:</span>
<span class="line-removed">282         type = LengthTypeEXS;</span>
<span class="line-removed">283         break;</span>
<span class="line-removed">284     case CSSPrimitiveValue::CSS_PX:</span>
<span class="line-removed">285         type = LengthTypePX;</span>
<span class="line-removed">286         break;</span>
<span class="line-removed">287     case CSSPrimitiveValue::CSS_CM:</span>
<span class="line-removed">288         type = LengthTypeCM;</span>
<span class="line-removed">289         break;</span>
<span class="line-removed">290     case CSSPrimitiveValue::CSS_MM:</span>
<span class="line-removed">291         type = LengthTypeMM;</span>
<span class="line-removed">292         break;</span>
<span class="line-removed">293     case CSSPrimitiveValue::CSS_IN:</span>
<span class="line-removed">294         type = LengthTypeIN;</span>
<span class="line-removed">295         break;</span>
<span class="line-removed">296     case CSSPrimitiveValue::CSS_PT:</span>
<span class="line-removed">297         type = LengthTypePT;</span>
<span class="line-removed">298         break;</span>
<span class="line-removed">299     case CSSPrimitiveValue::CSS_PC:</span>
<span class="line-removed">300         type = LengthTypePC;</span>
<span class="line-removed">301         break;</span>
<span class="line-removed">302     case CSSPrimitiveValue::CSS_UNKNOWN:</span>
<span class="line-removed">303     default:</span>
304         return { };
<span class="line-removed">305     };</span>
306 
<span class="line-modified">307     SVGLengthValue length;</span>
<span class="line-modified">308     length.newValueSpecifiedUnits(type, value.floatValue());</span>
<span class="line-removed">309     return length;</span>
<span class="line-removed">310 }</span>
<span class="line-removed">311 </span>
<span class="line-removed">312 Ref&lt;CSSPrimitiveValue&gt; SVGLengthValue::toCSSPrimitiveValue(const SVGLengthValue&amp; length)</span>
<span class="line-removed">313 {</span>
<span class="line-removed">314     CSSPrimitiveValue::UnitType cssType = CSSPrimitiveValue::CSS_UNKNOWN;</span>
<span class="line-removed">315     switch (length.unitType()) {</span>
<span class="line-removed">316     case LengthTypeUnknown:</span>
<span class="line-removed">317         break;</span>
<span class="line-removed">318     case LengthTypeNumber:</span>
<span class="line-removed">319         cssType = CSSPrimitiveValue::CSS_NUMBER;</span>
<span class="line-removed">320         break;</span>
<span class="line-removed">321     case LengthTypePercentage:</span>
<span class="line-removed">322         cssType = CSSPrimitiveValue::CSS_PERCENTAGE;</span>
<span class="line-removed">323         break;</span>
<span class="line-removed">324     case LengthTypeEMS:</span>
<span class="line-removed">325         cssType = CSSPrimitiveValue::CSS_EMS;</span>
<span class="line-removed">326         break;</span>
<span class="line-removed">327     case LengthTypeEXS:</span>
<span class="line-removed">328         cssType = CSSPrimitiveValue::CSS_EXS;</span>
<span class="line-removed">329         break;</span>
<span class="line-removed">330     case LengthTypePX:</span>
<span class="line-removed">331         cssType = CSSPrimitiveValue::CSS_PX;</span>
<span class="line-removed">332         break;</span>
<span class="line-removed">333     case LengthTypeCM:</span>
<span class="line-removed">334         cssType = CSSPrimitiveValue::CSS_CM;</span>
<span class="line-removed">335         break;</span>
<span class="line-removed">336     case LengthTypeMM:</span>
<span class="line-removed">337         cssType = CSSPrimitiveValue::CSS_MM;</span>
<span class="line-removed">338         break;</span>
<span class="line-removed">339     case LengthTypeIN:</span>
<span class="line-removed">340         cssType = CSSPrimitiveValue::CSS_IN;</span>
<span class="line-removed">341         break;</span>
<span class="line-removed">342     case LengthTypePT:</span>
<span class="line-removed">343         cssType = CSSPrimitiveValue::CSS_PT;</span>
<span class="line-removed">344         break;</span>
<span class="line-removed">345     case LengthTypePC:</span>
<span class="line-removed">346         cssType = CSSPrimitiveValue::CSS_PC;</span>
<span class="line-removed">347         break;</span>
<span class="line-removed">348     };</span>
<span class="line-removed">349 </span>
<span class="line-removed">350     return CSSPrimitiveValue::create(length.valueInSpecifiedUnits(), cssType);</span>
<span class="line-removed">351 }</span>
<span class="line-removed">352 </span>
<span class="line-removed">353 SVGLengthMode SVGLengthValue::lengthModeForAnimatedLengthAttribute(const QualifiedName&amp; attrName)</span>
<span class="line-removed">354 {</span>
<span class="line-removed">355     using Map = HashMap&lt;QualifiedName, SVGLengthMode&gt;;</span>
<span class="line-removed">356     static NeverDestroyed&lt;Map&gt; map = [] {</span>
<span class="line-removed">357         struct Mode {</span>
<span class="line-removed">358             const QualifiedName&amp; name;</span>
<span class="line-removed">359             SVGLengthMode mode;</span>
<span class="line-removed">360         };</span>
<span class="line-removed">361         static const Mode modes[] = {</span>
<span class="line-removed">362             { SVGNames::xAttr, LengthModeWidth },</span>
<span class="line-removed">363             { SVGNames::yAttr, LengthModeHeight },</span>
<span class="line-removed">364             { SVGNames::cxAttr, LengthModeWidth },</span>
<span class="line-removed">365             { SVGNames::cyAttr, LengthModeHeight },</span>
<span class="line-removed">366             { SVGNames::dxAttr, LengthModeWidth },</span>
<span class="line-removed">367             { SVGNames::dyAttr, LengthModeHeight },</span>
<span class="line-removed">368             { SVGNames::fxAttr, LengthModeWidth },</span>
<span class="line-removed">369             { SVGNames::fyAttr, LengthModeHeight },</span>
<span class="line-removed">370             { SVGNames::widthAttr, LengthModeWidth },</span>
<span class="line-removed">371             { SVGNames::heightAttr, LengthModeHeight },</span>
<span class="line-removed">372             { SVGNames::x1Attr, LengthModeWidth },</span>
<span class="line-removed">373             { SVGNames::x2Attr, LengthModeWidth },</span>
<span class="line-removed">374             { SVGNames::y1Attr, LengthModeHeight },</span>
<span class="line-removed">375             { SVGNames::y2Attr, LengthModeHeight },</span>
<span class="line-removed">376             { SVGNames::refXAttr, LengthModeWidth },</span>
<span class="line-removed">377             { SVGNames::refYAttr, LengthModeHeight },</span>
<span class="line-removed">378             { SVGNames::markerWidthAttr, LengthModeWidth },</span>
<span class="line-removed">379             { SVGNames::markerHeightAttr, LengthModeHeight },</span>
<span class="line-removed">380             { SVGNames::textLengthAttr, LengthModeWidth },</span>
<span class="line-removed">381             { SVGNames::startOffsetAttr, LengthModeWidth },</span>
<span class="line-removed">382         };</span>
<span class="line-removed">383         Map map;</span>
<span class="line-removed">384         for (auto&amp; mode : modes)</span>
<span class="line-removed">385             map.add(mode.name, mode.mode);</span>
<span class="line-removed">386         return map;</span>
<span class="line-removed">387     }();</span>
<span class="line-removed">388 </span>
<span class="line-removed">389     auto result = map.get().find(attrName);</span>
<span class="line-removed">390     if (result == map.get().end())</span>
<span class="line-removed">391         return LengthModeOther;</span>
<span class="line-removed">392     return result-&gt;value;</span>
393 }
394 
395 TextStream&amp; operator&lt;&lt;(TextStream&amp; ts, const SVGLengthValue&amp; length)
396 {
397     ts &lt;&lt; length.valueAsString();
398     return ts;
399 }
400 
401 }
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
  2  * Copyright (C) 2004, 2005, 2006 Nikolas Zimmermann &lt;zimmermann@kde.org&gt;
  3  * Copyright (C) 2004, 2005, 2006, 2007 Rob Buis &lt;buis@kde.org&gt;
<span class="line-modified">  4  * Copyright (C) 2007-2019 Apple Inc. All rights reserved.</span>
  5  *
  6  * This library is free software; you can redistribute it and/or
  7  * modify it under the terms of the GNU Library General Public
  8  * License as published by the Free Software Foundation; either
  9  * version 2 of the License, or (at your option) any later version.
 10  *
 11  * This library is distributed in the hope that it will be useful,
 12  * but WITHOUT ANY WARRANTY; without even the implied warranty of
 13  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 14  * Library General Public License for more details.
 15  *
 16  * You should have received a copy of the GNU Library General Public License
 17  * along with this library; see the file COPYING.LIB.  If not, write to
 18  * the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
 19  * Boston, MA 02110-1301, USA.
 20  */
 21 
 22 #include &quot;config.h&quot;
 23 #include &quot;SVGLengthValue.h&quot;
 24 
<span class="line-modified"> 25 #include &quot;AnimationUtilities.h&quot;</span>
 26 #include &quot;CSSPrimitiveValue.h&quot;
<span class="line-modified"> 27 #include &quot;SVGLengthContext.h&quot;</span>

 28 #include &quot;SVGParserUtilities.h&quot;


 29 #include &lt;wtf/text/StringConcatenateNumbers.h&gt;
 30 #include &lt;wtf/text/TextStream.h&gt;
 31 
 32 namespace WebCore {
 33 
<span class="line-modified"> 34 static inline const char* lengthTypeToString(SVGLengthType lengthType)</span>

 35 {
<span class="line-modified"> 36     switch (lengthType) {</span>
<span class="line-modified"> 37     case SVGLengthType::Unknown:</span>
<span class="line-modified"> 38     case SVGLengthType::Number:</span>
















 39         return &quot;&quot;;
<span class="line-modified"> 40     case SVGLengthType::Percentage:</span>
 41         return &quot;%&quot;;
<span class="line-modified"> 42     case SVGLengthType::Ems:</span>
 43         return &quot;em&quot;;
<span class="line-modified"> 44     case SVGLengthType::Exs:</span>
 45         return &quot;ex&quot;;
<span class="line-modified"> 46     case SVGLengthType::Pixels:</span>
 47         return &quot;px&quot;;
<span class="line-modified"> 48     case SVGLengthType::Centimeters:</span>
 49         return &quot;cm&quot;;
<span class="line-modified"> 50     case SVGLengthType::Millimeters:</span>
 51         return &quot;mm&quot;;
<span class="line-modified"> 52     case SVGLengthType::Inches:</span>
 53         return &quot;in&quot;;
<span class="line-modified"> 54     case SVGLengthType::Points:</span>
 55         return &quot;pt&quot;;
<span class="line-modified"> 56     case SVGLengthType::Picas:</span>
 57         return &quot;pc&quot;;
 58     }
 59 
 60     ASSERT_NOT_REACHED();
 61     return &quot;&quot;;
 62 }
 63 
<span class="line-modified"> 64 static inline SVGLengthType parseLengthType(const UChar* ptr, const UChar* end)</span>
 65 {
 66     if (ptr == end)
<span class="line-modified"> 67         return SVGLengthType::Number;</span>
 68 
 69     const UChar firstChar = *ptr;
 70 
 71     if (++ptr == end)
<span class="line-modified"> 72         return firstChar == &#39;%&#39; ? SVGLengthType::Percentage : SVGLengthType::Unknown;</span>
 73 
 74     const UChar secondChar = *ptr;
 75 
 76     if (++ptr != end)
<span class="line-modified"> 77         return SVGLengthType::Unknown;</span>
 78 
 79     if (firstChar == &#39;e&#39; &amp;&amp; secondChar == &#39;m&#39;)
<span class="line-modified"> 80         return SVGLengthType::Ems;</span>
 81     if (firstChar == &#39;e&#39; &amp;&amp; secondChar == &#39;x&#39;)
<span class="line-modified"> 82         return SVGLengthType::Exs;</span>
 83     if (firstChar == &#39;p&#39; &amp;&amp; secondChar == &#39;x&#39;)
<span class="line-modified"> 84         return SVGLengthType::Pixels;</span>
 85     if (firstChar == &#39;c&#39; &amp;&amp; secondChar == &#39;m&#39;)
<span class="line-modified"> 86         return SVGLengthType::Centimeters;</span>
 87     if (firstChar == &#39;m&#39; &amp;&amp; secondChar == &#39;m&#39;)
<span class="line-modified"> 88         return SVGLengthType::Millimeters;</span>
 89     if (firstChar == &#39;i&#39; &amp;&amp; secondChar == &#39;n&#39;)
<span class="line-modified"> 90         return SVGLengthType::Inches;</span>
 91     if (firstChar == &#39;p&#39; &amp;&amp; secondChar == &#39;t&#39;)
<span class="line-modified"> 92         return SVGLengthType::Points;</span>
 93     if (firstChar == &#39;p&#39; &amp;&amp; secondChar == &#39;c&#39;)
<span class="line-modified"> 94         return SVGLengthType::Picas;</span>
 95 
<span class="line-modified"> 96     return SVGLengthType::Unknown;</span>
 97 }
 98 
<span class="line-modified"> 99 static inline SVGLengthType primitiveTypeToLengthType(CSSUnitType primitiveType)</span>

100 {
<span class="line-modified">101     switch (primitiveType) {</span>
<span class="line-added">102     case CSSUnitType::CSS_UNKNOWN:</span>
<span class="line-added">103         return SVGLengthType::Unknown;</span>
<span class="line-added">104     case CSSUnitType::CSS_NUMBER:</span>
<span class="line-added">105         return SVGLengthType::Number;</span>
<span class="line-added">106     case CSSUnitType::CSS_PERCENTAGE:</span>
<span class="line-added">107         return SVGLengthType::Percentage;</span>
<span class="line-added">108     case CSSUnitType::CSS_EMS:</span>
<span class="line-added">109         return SVGLengthType::Ems;</span>
<span class="line-added">110     case CSSUnitType::CSS_EXS:</span>
<span class="line-added">111         return SVGLengthType::Exs;</span>
<span class="line-added">112     case CSSUnitType::CSS_PX:</span>
<span class="line-added">113         return SVGLengthType::Pixels;</span>
<span class="line-added">114     case CSSUnitType::CSS_CM:</span>
<span class="line-added">115         return SVGLengthType::Centimeters;</span>
<span class="line-added">116     case CSSUnitType::CSS_MM:</span>
<span class="line-added">117         return SVGLengthType::Millimeters;</span>
<span class="line-added">118     case CSSUnitType::CSS_IN:</span>
<span class="line-added">119         return SVGLengthType::Inches;</span>
<span class="line-added">120     case CSSUnitType::CSS_PT:</span>
<span class="line-added">121         return SVGLengthType::Points;</span>
<span class="line-added">122     case CSSUnitType::CSS_PC:</span>
<span class="line-added">123         return SVGLengthType::Picas;</span>
<span class="line-added">124     default:</span>
<span class="line-added">125         return SVGLengthType::Unknown;</span>
<span class="line-added">126     }</span>
<span class="line-added">127 </span>
<span class="line-added">128     return SVGLengthType::Unknown;</span>
129 }
130 
<span class="line-modified">131 static inline CSSUnitType lengthTypeToPrimitiveType(SVGLengthType lengthType)</span>

132 {
<span class="line-modified">133     switch (lengthType) {</span>
<span class="line-added">134     case SVGLengthType::Unknown:</span>
<span class="line-added">135         return CSSUnitType::CSS_UNKNOWN;</span>
<span class="line-added">136     case SVGLengthType::Number:</span>
<span class="line-added">137         return CSSUnitType::CSS_NUMBER;</span>
<span class="line-added">138     case SVGLengthType::Percentage:</span>
<span class="line-added">139         return CSSUnitType::CSS_PERCENTAGE;</span>
<span class="line-added">140     case SVGLengthType::Ems:</span>
<span class="line-added">141         return CSSUnitType::CSS_EMS;</span>
<span class="line-added">142     case SVGLengthType::Exs:</span>
<span class="line-added">143         return CSSUnitType::CSS_EXS;</span>
<span class="line-added">144     case SVGLengthType::Pixels:</span>
<span class="line-added">145         return CSSUnitType::CSS_PX;</span>
<span class="line-added">146     case SVGLengthType::Centimeters:</span>
<span class="line-added">147         return CSSUnitType::CSS_CM;</span>
<span class="line-added">148     case SVGLengthType::Millimeters:</span>
<span class="line-added">149         return CSSUnitType::CSS_MM;</span>
<span class="line-added">150     case SVGLengthType::Inches:</span>
<span class="line-added">151         return CSSUnitType::CSS_IN;</span>
<span class="line-added">152     case SVGLengthType::Points:</span>
<span class="line-added">153         return CSSUnitType::CSS_PT;</span>
<span class="line-added">154     case SVGLengthType::Picas:</span>
<span class="line-added">155         return CSSUnitType::CSS_PC;</span>
<span class="line-added">156     }</span>
<span class="line-added">157 </span>
<span class="line-added">158     ASSERT_NOT_REACHED();</span>
<span class="line-added">159     return CSSUnitType::CSS_UNKNOWN;</span>
160 }
161 
<span class="line-modified">162 SVGLengthValue::SVGLengthValue(SVGLengthMode lengthMode, const String&amp; valueAsString)</span>
<span class="line-added">163     : m_lengthMode(lengthMode)</span>
164 {
<span class="line-modified">165     setValueAsString(valueAsString);</span>


166 }
167 
<span class="line-modified">168 SVGLengthValue::SVGLengthValue(float valueInSpecifiedUnits, SVGLengthType lengthType, SVGLengthMode lengthMode)</span>
<span class="line-added">169     : m_valueInSpecifiedUnits(valueInSpecifiedUnits)</span>
<span class="line-added">170     , m_lengthType(lengthType)</span>
<span class="line-added">171     , m_lengthMode(lengthMode)</span>
172 {
<span class="line-modified">173     ASSERT(m_lengthType != SVGLengthType::Unknown);</span>
174 }
175 
<span class="line-modified">176 SVGLengthValue::SVGLengthValue(const SVGLengthContext&amp; context, float value, SVGLengthType lengthType, SVGLengthMode lengthMode)</span>
<span class="line-added">177     : m_lengthType(lengthType)</span>
<span class="line-added">178     , m_lengthMode(lengthMode)</span>
179 {
<span class="line-modified">180     setValue(context, value);</span>
181 }
182 
<span class="line-modified">183 SVGLengthValue SVGLengthValue::construct(SVGLengthMode lengthMode, const String&amp; valueAsString, SVGParsingError&amp; parseError, SVGLengthNegativeValuesMode negativeValuesMode)</span>
184 {
<span class="line-modified">185     SVGLengthValue length(lengthMode);</span>
186 
187     if (length.setValueAsString(valueAsString).hasException())
188         parseError = ParsingAttributeFailedError;
<span class="line-modified">189     else if (negativeValuesMode == SVGLengthNegativeValuesMode::Forbid &amp;&amp; length.valueInSpecifiedUnits() &lt; 0)</span>
190         parseError = NegativeValueForbiddenError;
191 
192     return length;
193 }
194 
<span class="line-modified">195 SVGLengthValue SVGLengthValue::blend(const SVGLengthValue&amp; from, const SVGLengthValue&amp; to, float progress)</span>
<span class="line-added">196 {</span>
<span class="line-added">197     if ((from.isZero() &amp;&amp; to.isZero())</span>
<span class="line-added">198         || from.lengthType() == SVGLengthType::Unknown</span>
<span class="line-added">199         || to.lengthType() == SVGLengthType::Unknown</span>
<span class="line-added">200         || (!from.isZero() &amp;&amp; from.lengthType() != SVGLengthType::Percentage &amp;&amp; to.lengthType() == SVGLengthType::Percentage)</span>
<span class="line-added">201         || (!to.isZero() &amp;&amp; from.lengthType() == SVGLengthType::Percentage &amp;&amp; to.lengthType() != SVGLengthType::Percentage)</span>
<span class="line-added">202         || (!from.isZero() &amp;&amp; !to.isZero() &amp;&amp; (from.lengthType() == SVGLengthType::Ems || from.lengthType() == SVGLengthType::Exs) &amp;&amp; from.lengthType() != to.lengthType()))</span>
<span class="line-added">203         return to;</span>
<span class="line-added">204 </span>
<span class="line-added">205     if (from.lengthType() == SVGLengthType::Percentage || to.lengthType() == SVGLengthType::Percentage) {</span>
<span class="line-added">206         auto fromPercent = from.valueAsPercentage() * 100;</span>
<span class="line-added">207         auto toPercent = to.valueAsPercentage() * 100;</span>
<span class="line-added">208         return { WebCore::blend(fromPercent, toPercent, progress), SVGLengthType::Percentage };</span>
<span class="line-added">209     }</span>
<span class="line-added">210 </span>
<span class="line-added">211     if (from.lengthType() == to.lengthType() || from.isZero() || to.isZero() || from.isRelative()) {</span>
<span class="line-added">212         auto fromValue = from.valueInSpecifiedUnits();</span>
<span class="line-added">213         auto toValue = to.valueInSpecifiedUnits();</span>
<span class="line-added">214         return { WebCore::blend(fromValue, toValue, progress), to.isZero() ? from.lengthType() : to.lengthType() };</span>
<span class="line-added">215     }</span>
<span class="line-added">216 </span>
<span class="line-added">217     SVGLengthContext nonRelativeLengthContext(nullptr);</span>
<span class="line-added">218     auto fromValueInUserUnits = nonRelativeLengthContext.convertValueToUserUnits(from.valueInSpecifiedUnits(), from.lengthType(), from.lengthMode());</span>
<span class="line-added">219     if (fromValueInUserUnits.hasException())</span>
<span class="line-added">220         return { };</span>
<span class="line-added">221 </span>
<span class="line-added">222     auto fromValue = nonRelativeLengthContext.convertValueFromUserUnits(fromValueInUserUnits.releaseReturnValue(), to.lengthType(), to.lengthMode());</span>
<span class="line-added">223     if (fromValue.hasException())</span>
<span class="line-added">224         return { };</span>
<span class="line-added">225 </span>
<span class="line-added">226     float toValue = to.valueInSpecifiedUnits();</span>
<span class="line-added">227     return { WebCore::blend(fromValue.releaseReturnValue(), toValue, progress), to.lengthType() };</span>
<span class="line-added">228 }</span>
<span class="line-added">229 </span>
<span class="line-added">230 SVGLengthValue SVGLengthValue::fromCSSPrimitiveValue(const CSSPrimitiveValue&amp; value)</span>
231 {
<span class="line-modified">232     // FIXME: This needs to call value.computeLength() so it can correctly resolve non-absolute units (webkit.org/b/204826).</span>
<span class="line-added">233     SVGLengthType lengthType = primitiveTypeToLengthType(value.primitiveType());</span>
<span class="line-added">234     return lengthType == SVGLengthType::Unknown ? SVGLengthValue() : SVGLengthValue(value.floatValue(), lengthType);</span>
235 }
236 
<span class="line-modified">237 Ref&lt;CSSPrimitiveValue&gt; SVGLengthValue::toCSSPrimitiveValue(const SVGLengthValue&amp; length)</span>
238 {
<span class="line-modified">239     return CSSPrimitiveValue::create(length.valueInSpecifiedUnits(), lengthTypeToPrimitiveType(length.lengthType()));</span>
<span class="line-added">240 }</span>
<span class="line-added">241 </span>
<span class="line-added">242 ExceptionOr&lt;void&gt; SVGLengthValue::setValueAsString(const String&amp; valueAsString, SVGLengthMode lengthMode)</span>
<span class="line-added">243 {</span>
<span class="line-added">244     m_valueInSpecifiedUnits = 0;</span>
<span class="line-added">245     m_lengthMode = lengthMode;</span>
<span class="line-added">246     m_lengthType = SVGLengthType::Number;</span>
<span class="line-added">247     return setValueAsString(valueAsString);</span>
248 }
249 
250 float SVGLengthValue::value(const SVGLengthContext&amp; context) const
251 {
252     auto result = valueForBindings(context);
253     if (result.hasException())
254         return 0;
255     return result.releaseReturnValue();
256 }
257 
<span class="line-modified">258 String SVGLengthValue::valueAsString() const</span>
259 {
<span class="line-modified">260     return makeString(m_valueInSpecifiedUnits, lengthTypeToString(m_lengthType));</span>
261 }
262 
<span class="line-modified">263 ExceptionOr&lt;float&gt; SVGLengthValue::valueForBindings(const SVGLengthContext&amp; context) const</span>
264 {
<span class="line-modified">265     return context.convertValueToUserUnits(m_valueInSpecifiedUnits, m_lengthType, m_lengthMode);</span>


266 }
267 
<span class="line-modified">268 ExceptionOr&lt;void&gt; SVGLengthValue::setValue(const SVGLengthContext&amp; context, float value)</span>
269 {
270     // 100% = 100.0 instead of 1.0 for historical reasons, this could eventually be changed
<span class="line-modified">271     if (m_lengthType == SVGLengthType::Percentage)</span>
272         value = value / 100;
273 
<span class="line-modified">274     auto convertedValue = context.convertValueFromUserUnits(value, m_lengthType, m_lengthMode);</span>
275     if (convertedValue.hasException())
276         return convertedValue.releaseException();
277     m_valueInSpecifiedUnits = convertedValue.releaseReturnValue();
278     return { };
279 }





280 
<span class="line-modified">281 ExceptionOr&lt;void&gt; SVGLengthValue::setValue(const SVGLengthContext&amp; context, float value, SVGLengthType lengthType, SVGLengthMode lengthMode)</span>
<span class="line-added">282 {</span>
<span class="line-added">283     // FIXME: Seems like a bug that we change the value of m_unit even if setValue throws an exception.</span>
<span class="line-added">284     m_lengthMode = lengthMode;</span>
<span class="line-added">285     m_lengthType = lengthType;</span>
<span class="line-added">286     return setValue(context, value);</span>
287 }
288 
289 ExceptionOr&lt;void&gt; SVGLengthValue::setValueAsString(const String&amp; string)
290 {
291     if (string.isEmpty())
292         return { };
293 
294     float convertedNumber = 0;
295     auto upconvertedCharacters = StringView(string).upconvertedCharacters();
296     const UChar* ptr = upconvertedCharacters;
297     const UChar* end = ptr + string.length();
298 
299     if (!parseNumber(ptr, end, convertedNumber, false))
300         return Exception { SyntaxError };
301 
<span class="line-modified">302     auto lengthType = parseLengthType(ptr, end);</span>
<span class="line-modified">303     if (lengthType == SVGLengthType::Unknown)</span>
304         return Exception { SyntaxError };
305 
<span class="line-modified">306     m_lengthType = lengthType;</span>
307     m_valueInSpecifiedUnits = convertedNumber;
308     return { };
309 }
310 
<span class="line-modified">311 ExceptionOr&lt;void&gt; SVGLengthValue::convertToSpecifiedUnits(const SVGLengthContext&amp; context, SVGLengthType lengthType)</span>















312 {



313     auto valueInUserUnits = valueForBindings(context);
314     if (valueInUserUnits.hasException())
315         return valueInUserUnits.releaseException();
316 
<span class="line-modified">317     auto originalLengthType = m_lengthType;</span>
<span class="line-modified">318     m_lengthType = lengthType;</span>
<span class="line-modified">319     auto result = setValue(context, valueInUserUnits.releaseReturnValue());</span>
<span class="line-modified">320     if (!result.hasException())</span>











































321         return { };

322 
<span class="line-modified">323     m_lengthType = originalLengthType;</span>
<span class="line-modified">324     return result.releaseException();</span>




















































































325 }
326 
327 TextStream&amp; operator&lt;&lt;(TextStream&amp; ts, const SVGLengthValue&amp; length)
328 {
329     ts &lt;&lt; length.valueAsString();
330     return ts;
331 }
332 
333 }
</pre>
</td>
</tr>
</table>
<center><a href="SVGLengthList.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="SVGLengthValue.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>