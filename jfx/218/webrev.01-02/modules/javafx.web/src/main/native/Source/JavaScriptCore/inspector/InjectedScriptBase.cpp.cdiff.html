<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.web/src/main/native/Source/JavaScriptCore/inspector/InjectedScriptBase.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="InjectedScript.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="InjectedScriptBase.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/JavaScriptCore/inspector/InjectedScriptBase.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 35,11 ***</span>
  #include &quot;DebuggerEvalEnabler.h&quot;
  #include &quot;JSCInlines.h&quot;
  #include &quot;JSGlobalObject.h&quot;
  #include &quot;JSLock.h&quot;
  #include &quot;JSNativeStdFunction.h&quot;
<span class="line-removed">- #include &quot;NativeStdFunctionCell.h&quot;</span>
  #include &quot;ScriptFunctionCall.h&quot;
  #include &lt;wtf/JSONValues.h&gt;
  #include &lt;wtf/text/StringConcatenateNumbers.h&gt;
  
  namespace Inspector {
<span class="line-new-header">--- 35,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 60,38 ***</span>
  {
  }
  
  bool InjectedScriptBase::hasAccessToInspectedScriptState() const
  {
<span class="line-modified">!     return m_environment &amp;&amp; m_environment-&gt;canAccessInspectedScriptState(m_injectedScriptObject.scriptState());</span>
  }
  
  const Deprecated::ScriptObject&amp; InjectedScriptBase::injectedScriptObject() const
  {
      return m_injectedScriptObject;
  }
  
<span class="line-modified">! JSC::JSValue InjectedScriptBase::callFunctionWithEvalEnabled(Deprecated::ScriptFunctionCall&amp; function, bool&amp; hadException) const</span>
  {
<span class="line-modified">!     JSC::ExecState* scriptState = m_injectedScriptObject.scriptState();</span>
<span class="line-modified">!     JSC::DebuggerEvalEnabler evalEnabler(scriptState);</span>
<span class="line-modified">!     return function.call(hadException);</span>
  }
  
  Ref&lt;JSON::Value&gt; InjectedScriptBase::makeCall(Deprecated::ScriptFunctionCall&amp; function)
  {
      if (hasNoValue() || !hasAccessToInspectedScriptState())
          return JSON::Value::null();
  
<span class="line-modified">!     bool hadException = false;</span>
<span class="line-modified">!     auto resultJSValue = callFunctionWithEvalEnabled(function, hadException);</span>
<span class="line-removed">- </span>
<span class="line-removed">-     ASSERT(!hadException);</span>
<span class="line-removed">-     if (hadException)</span>
          return JSON::Value::create(&quot;Exception while making a call.&quot;);
  
<span class="line-modified">!     RefPtr&lt;JSON::Value&gt; resultJSONValue = toInspectorValue(*m_injectedScriptObject.scriptState(), resultJSValue);</span>
      if (!resultJSONValue)
          return JSON::Value::create(makeString(&quot;Object has too long reference chain (must not be longer than &quot;, JSON::Value::maxDepth, &#39;)&#39;));
  
      return resultJSONValue.releaseNonNull();
  }
<span class="line-new-header">--- 59,35 ---</span>
  {
  }
  
  bool InjectedScriptBase::hasAccessToInspectedScriptState() const
  {
<span class="line-modified">!     return m_environment &amp;&amp; m_environment-&gt;canAccessInspectedScriptState(m_injectedScriptObject.globalObject());</span>
  }
  
  const Deprecated::ScriptObject&amp; InjectedScriptBase::injectedScriptObject() const
  {
      return m_injectedScriptObject;
  }
  
<span class="line-modified">! Expected&lt;JSC::JSValue, NakedPtr&lt;JSC::Exception&gt;&gt; InjectedScriptBase::callFunctionWithEvalEnabled(Deprecated::ScriptFunctionCall&amp; function) const</span>
  {
<span class="line-modified">!     JSC::JSGlobalObject* globalObject = m_injectedScriptObject.globalObject();</span>
<span class="line-modified">!     JSC::DebuggerEvalEnabler evalEnabler(globalObject);</span>
<span class="line-modified">!     return function.call();</span>
  }
  
  Ref&lt;JSON::Value&gt; InjectedScriptBase::makeCall(Deprecated::ScriptFunctionCall&amp; function)
  {
      if (hasNoValue() || !hasAccessToInspectedScriptState())
          return JSON::Value::null();
  
<span class="line-modified">!     auto result = callFunctionWithEvalEnabled(function);</span>
<span class="line-modified">!     if (!result)</span>
          return JSON::Value::create(&quot;Exception while making a call.&quot;);
  
<span class="line-modified">!     RefPtr&lt;JSON::Value&gt; resultJSONValue = toInspectorValue(m_injectedScriptObject.globalObject(), result.value());</span>
      if (!resultJSONValue)
          return JSON::Value::create(makeString(&quot;Object has too long reference chain (must not be longer than &quot;, JSON::Value::maxDepth, &#39;)&#39;));
  
      return resultJSONValue.releaseNonNull();
  }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 106,40 ***</span>
      if (hasNoValue() || !hasAccessToInspectedScriptState()) {
          checkAsyncCallResult(JSON::Value::null(), callback);
          return;
      }
  
<span class="line-modified">!     auto* scriptState = m_injectedScriptObject.scriptState();</span>
<span class="line-modified">!     JSC::VM&amp; vm = scriptState-&gt;vm();</span>
<span class="line-removed">- </span>
<span class="line-removed">-     JSC::JSNativeStdFunction* jsFunction;</span>
  
      {
          JSC::JSLockHolder locker(vm);
  
<span class="line-modified">!         jsFunction = JSC::JSNativeStdFunction::create(vm, scriptState-&gt;lexicalGlobalObject(), 1, String(), [&amp;, callback = WTFMove(callback)] (JSC::ExecState* exec) {</span>
<span class="line-modified">!             if (!exec)</span>
                  checkAsyncCallResult(JSON::Value::create(&quot;Exception while making a call.&quot;), callback);
<span class="line-modified">!             else if (auto resultJSONValue = toInspectorValue(*exec, exec-&gt;argument(0)))</span>
                  checkAsyncCallResult(resultJSONValue, callback);
              else
                  checkAsyncCallResult(JSON::Value::create(makeString(&quot;Object has too long reference chain (must not be longer than &quot;, JSON::Value::maxDepth, &#39;)&#39;)), callback);
              return JSC::JSValue::encode(JSC::jsUndefined());
          });
      }
  
      function.appendArgument(JSC::JSValue(jsFunction));
  
<span class="line-modified">!     bool hadException = false;</span>
<span class="line-modified">!     auto resultJSValue = callFunctionWithEvalEnabled(function, hadException);</span>
<span class="line-removed">-     ASSERT_UNUSED(resultJSValue, resultJSValue.isUndefined());</span>
  
<span class="line-modified">!     ASSERT(!hadException);</span>
<span class="line-modified">!     if (hadException) {</span>
          // Since `callback` is moved above, we can&#39;t call it if there&#39;s an exception while trying to
          // execute the `JSNativeStdFunction` inside InjectedScriptSource.js.
<span class="line-modified">!         jsFunction-&gt;nativeStdFunctionCell()-&gt;function()(nullptr);</span>
      }
  }
  
  void InjectedScriptBase::checkCallResult(ErrorString&amp; errorString, RefPtr&lt;JSON::Value&gt; result, RefPtr&lt;Protocol::Runtime::RemoteObject&gt;&amp; out_resultObject, Optional&lt;bool&gt;&amp; out_wasThrown, Optional&lt;int&gt;&amp; out_savedResultIndex)
  {
<span class="line-new-header">--- 102,38 ---</span>
      if (hasNoValue() || !hasAccessToInspectedScriptState()) {
          checkAsyncCallResult(JSON::Value::null(), callback);
          return;
      }
  
<span class="line-modified">!     auto* globalObject = m_injectedScriptObject.globalObject();</span>
<span class="line-modified">!     JSC::VM&amp; vm = globalObject-&gt;vm();</span>
  
<span class="line-added">+     JSC::JSNativeStdFunction* jsFunction = nullptr;</span>
      {
          JSC::JSLockHolder locker(vm);
  
<span class="line-modified">!         jsFunction = JSC::JSNativeStdFunction::create(vm, globalObject, 1, String(), [&amp;, callback = WTFMove(callback)] (JSC::JSGlobalObject* globalObject, JSC::CallFrame* callFrame) {</span>
<span class="line-modified">!             if (!callFrame)</span>
                  checkAsyncCallResult(JSON::Value::create(&quot;Exception while making a call.&quot;), callback);
<span class="line-modified">!             else if (auto resultJSONValue = toInspectorValue(globalObject, callFrame-&gt;argument(0)))</span>
                  checkAsyncCallResult(resultJSONValue, callback);
              else
                  checkAsyncCallResult(JSON::Value::create(makeString(&quot;Object has too long reference chain (must not be longer than &quot;, JSON::Value::maxDepth, &#39;)&#39;)), callback);
              return JSC::JSValue::encode(JSC::jsUndefined());
          });
      }
  
      function.appendArgument(JSC::JSValue(jsFunction));
  
<span class="line-modified">!     auto result = callFunctionWithEvalEnabled(function);</span>
<span class="line-modified">!     ASSERT_UNUSED(result, result.value().isUndefined());</span>
  
<span class="line-modified">!     ASSERT(result);</span>
<span class="line-modified">!     if (!result) {</span>
          // Since `callback` is moved above, we can&#39;t call it if there&#39;s an exception while trying to
          // execute the `JSNativeStdFunction` inside InjectedScriptSource.js.
<span class="line-modified">!         jsFunction-&gt;function()(globalObject, nullptr);</span>
      }
  }
  
  void InjectedScriptBase::checkCallResult(ErrorString&amp; errorString, RefPtr&lt;JSON::Value&gt; result, RefPtr&lt;Protocol::Runtime::RemoteObject&gt;&amp; out_resultObject, Optional&lt;bool&gt;&amp; out_wasThrown, Optional&lt;int&gt;&amp; out_savedResultIndex)
  {
</pre>
<center><a href="InjectedScript.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="InjectedScriptBase.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>