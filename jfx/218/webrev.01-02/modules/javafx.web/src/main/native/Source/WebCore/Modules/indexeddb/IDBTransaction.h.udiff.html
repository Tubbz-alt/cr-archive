<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WebCore/Modules/indexeddb/IDBTransaction.h</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="IDBTransaction.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="IDBValue.cpp.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/Modules/indexeddb/IDBTransaction.h</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -64,16 +64,18 @@</span>
  class IDBConnectionProxy;
  class TransactionOperation;
  }
  
  class IDBTransaction final : public ThreadSafeRefCounted&lt;IDBTransaction&gt;, public EventTargetWithInlineData, public IDBActiveDOMObject {
<span class="udiff-line-modified-removed">-     WTF_MAKE_ISO_ALLOCATED(IDBTransaction);</span>
<span class="udiff-line-modified-added">+     WTF_MAKE_ISO_ALLOCATED_EXPORT(IDBTransaction, WEBCORE_EXPORT);</span>
  public:
      static Ref&lt;IDBTransaction&gt; create(IDBDatabase&amp;, const IDBTransactionInfo&amp;);
      static Ref&lt;IDBTransaction&gt; create(IDBDatabase&amp;, const IDBTransactionInfo&amp;, IDBOpenDBRequest&amp;);
  
<span class="udiff-line-modified-removed">-     ~IDBTransaction() final;</span>
<span class="udiff-line-modified-added">+     static uint64_t generateOperationID();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     WEBCORE_EXPORT ~IDBTransaction() final;</span>
  
      // IDBTransaction IDL
      Ref&lt;DOMStringList&gt; objectStoreNames() const;
      IDBTransactionMode mode() const { return m_info.mode(); }
      IDBDatabase* db();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -90,11 +92,10 @@</span>
  
      using ThreadSafeRefCounted&lt;IDBTransaction&gt;::ref;
      using ThreadSafeRefCounted&lt;IDBTransaction&gt;::deref;
  
      const char* activeDOMObjectName() const final;
<span class="udiff-line-removed">-     bool canSuspendForDocumentSuspension() const final;</span>
      bool hasPendingActivity() const final;
      void stop() final;
  
      const IDBTransactionInfo&amp; info() const { return m_info; }
      IDBDatabase&amp; database() { return m_database.get(); }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -112,22 +113,22 @@</span>
      Ref&lt;IDBObjectStore&gt; createObjectStore(const IDBObjectStoreInfo&amp;);
      void renameObjectStore(IDBObjectStore&amp;, const String&amp; newName);
      std::unique_ptr&lt;IDBIndex&gt; createIndex(IDBObjectStore&amp;, const IDBIndexInfo&amp;);
      void renameIndex(IDBIndex&amp;, const String&amp; newName);
  
<span class="udiff-line-modified-removed">-     Ref&lt;IDBRequest&gt; requestPutOrAdd(JSC::ExecState&amp;, IDBObjectStore&amp;, RefPtr&lt;IDBKey&gt;&amp;&amp;, SerializedScriptValue&amp;, IndexedDB::ObjectStoreOverwriteMode);</span>
<span class="udiff-line-modified-removed">-     Ref&lt;IDBRequest&gt; requestGetRecord(JSC::ExecState&amp;, IDBObjectStore&amp;, const IDBGetRecordData&amp;);</span>
<span class="udiff-line-modified-removed">-     Ref&lt;IDBRequest&gt; requestGetAllObjectStoreRecords(JSC::ExecState&amp;, IDBObjectStore&amp;, const IDBKeyRangeData&amp;, IndexedDB::GetAllType, Optional&lt;uint32_t&gt; count);</span>
<span class="udiff-line-modified-removed">-     Ref&lt;IDBRequest&gt; requestGetAllIndexRecords(JSC::ExecState&amp;, IDBIndex&amp;, const IDBKeyRangeData&amp;, IndexedDB::GetAllType, Optional&lt;uint32_t&gt; count);</span>
<span class="udiff-line-modified-removed">-     Ref&lt;IDBRequest&gt; requestDeleteRecord(JSC::ExecState&amp;, IDBObjectStore&amp;, const IDBKeyRangeData&amp;);</span>
<span class="udiff-line-modified-removed">-     Ref&lt;IDBRequest&gt; requestClearObjectStore(JSC::ExecState&amp;, IDBObjectStore&amp;);</span>
<span class="udiff-line-modified-removed">-     Ref&lt;IDBRequest&gt; requestCount(JSC::ExecState&amp;, IDBObjectStore&amp;, const IDBKeyRangeData&amp;);</span>
<span class="udiff-line-modified-removed">-     Ref&lt;IDBRequest&gt; requestCount(JSC::ExecState&amp;, IDBIndex&amp;, const IDBKeyRangeData&amp;);</span>
<span class="udiff-line-modified-removed">-     Ref&lt;IDBRequest&gt; requestGetValue(JSC::ExecState&amp;, IDBIndex&amp;, const IDBKeyRangeData&amp;);</span>
<span class="udiff-line-modified-removed">-     Ref&lt;IDBRequest&gt; requestGetKey(JSC::ExecState&amp;, IDBIndex&amp;, const IDBKeyRangeData&amp;);</span>
<span class="udiff-line-modified-removed">-     Ref&lt;IDBRequest&gt; requestOpenCursor(JSC::ExecState&amp;, IDBObjectStore&amp;, const IDBCursorInfo&amp;);</span>
<span class="udiff-line-modified-removed">-     Ref&lt;IDBRequest&gt; requestOpenCursor(JSC::ExecState&amp;, IDBIndex&amp;, const IDBCursorInfo&amp;);</span>
<span class="udiff-line-modified-added">+     Ref&lt;IDBRequest&gt; requestPutOrAdd(JSC::JSGlobalObject&amp;, IDBObjectStore&amp;, RefPtr&lt;IDBKey&gt;&amp;&amp;, SerializedScriptValue&amp;, IndexedDB::ObjectStoreOverwriteMode);</span>
<span class="udiff-line-modified-added">+     Ref&lt;IDBRequest&gt; requestGetRecord(JSC::JSGlobalObject&amp;, IDBObjectStore&amp;, const IDBGetRecordData&amp;);</span>
<span class="udiff-line-modified-added">+     Ref&lt;IDBRequest&gt; requestGetAllObjectStoreRecords(JSC::JSGlobalObject&amp;, IDBObjectStore&amp;, const IDBKeyRangeData&amp;, IndexedDB::GetAllType, Optional&lt;uint32_t&gt; count);</span>
<span class="udiff-line-modified-added">+     Ref&lt;IDBRequest&gt; requestGetAllIndexRecords(JSC::JSGlobalObject&amp;, IDBIndex&amp;, const IDBKeyRangeData&amp;, IndexedDB::GetAllType, Optional&lt;uint32_t&gt; count);</span>
<span class="udiff-line-modified-added">+     Ref&lt;IDBRequest&gt; requestDeleteRecord(JSC::JSGlobalObject&amp;, IDBObjectStore&amp;, const IDBKeyRangeData&amp;);</span>
<span class="udiff-line-modified-added">+     Ref&lt;IDBRequest&gt; requestClearObjectStore(JSC::JSGlobalObject&amp;, IDBObjectStore&amp;);</span>
<span class="udiff-line-modified-added">+     Ref&lt;IDBRequest&gt; requestCount(JSC::JSGlobalObject&amp;, IDBObjectStore&amp;, const IDBKeyRangeData&amp;);</span>
<span class="udiff-line-modified-added">+     Ref&lt;IDBRequest&gt; requestCount(JSC::JSGlobalObject&amp;, IDBIndex&amp;, const IDBKeyRangeData&amp;);</span>
<span class="udiff-line-modified-added">+     Ref&lt;IDBRequest&gt; requestGetValue(JSC::JSGlobalObject&amp;, IDBIndex&amp;, const IDBKeyRangeData&amp;);</span>
<span class="udiff-line-modified-added">+     Ref&lt;IDBRequest&gt; requestGetKey(JSC::JSGlobalObject&amp;, IDBIndex&amp;, const IDBKeyRangeData&amp;);</span>
<span class="udiff-line-modified-added">+     Ref&lt;IDBRequest&gt; requestOpenCursor(JSC::JSGlobalObject&amp;, IDBObjectStore&amp;, const IDBCursorInfo&amp;);</span>
<span class="udiff-line-modified-added">+     Ref&lt;IDBRequest&gt; requestOpenCursor(JSC::JSGlobalObject&amp;, IDBIndex&amp;, const IDBCursorInfo&amp;);</span>
      void iterateCursor(IDBCursor&amp;, const IDBIterateCursorData&amp;);
  
      void deleteObjectStore(const String&amp; objectStoreName);
      void deleteIndex(uint64_t objectStoreIdentifier, const String&amp; indexName);
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -164,19 +165,21 @@</span>
      void internalAbort();
      void notifyDidAbort(const IDBError&amp;);
      void finishAbortOrCommit();
      void abortInProgressOperations(const IDBError&amp;);
  
<span class="udiff-line-modified-removed">-     void scheduleOperation(Ref&lt;IDBClient::TransactionOperation&gt;&amp;&amp;);</span>
<span class="udiff-line-modified-removed">-     void pendingOperationTimerFired();</span>
<span class="udiff-line-modified-removed">-     void completedOperationTimerFired();</span>
<span class="udiff-line-modified-added">+     enum class IsWriteOperation : bool { No, Yes };</span>
<span class="udiff-line-modified-added">+     void scheduleOperation(Ref&lt;IDBClient::TransactionOperation&gt;&amp;&amp;, IsWriteOperation = IsWriteOperation::No);</span>
<span class="udiff-line-modified-added">+     void handleOperationsCompletedOnServer();</span>
<span class="udiff-line-added">+     void handlePendingOperations();</span>
<span class="udiff-line-added">+     void autoCommit();</span>
  
      void fireOnComplete();
      void fireOnAbort();
      void enqueueEvent(Ref&lt;Event&gt;&amp;&amp;);
  
<span class="udiff-line-modified-removed">-     Ref&lt;IDBRequest&gt; requestIndexRecord(JSC::ExecState&amp;, IDBIndex&amp;, IndexedDB::IndexRecordType, const IDBKeyRangeData&amp;);</span>
<span class="udiff-line-modified-added">+     Ref&lt;IDBRequest&gt; requestIndexRecord(JSC::JSGlobalObject&amp;, IDBIndex&amp;, IndexedDB::IndexRecordType, const IDBKeyRangeData&amp;);</span>
  
      void commitOnServer(IDBClient::TransactionOperation&amp;);
      void abortOnServerAndCancelRequests(IDBClient::TransactionOperation&amp;);
  
      void createObjectStoreOnServer(IDBClient::TransactionOperation&amp;, const IDBObjectStoreInfo&amp;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -213,11 +216,11 @@</span>
      void didDeleteObjectStoreOnServer(const IDBResultData&amp;);
  
      void deleteIndexOnServer(IDBClient::TransactionOperation&amp;, const uint64_t&amp; objectStoreIdentifier, const String&amp; indexName);
      void didDeleteIndexOnServer(const IDBResultData&amp;);
  
<span class="udiff-line-modified-removed">-     Ref&lt;IDBRequest&gt; doRequestOpenCursor(JSC::ExecState&amp;, Ref&lt;IDBCursor&gt;&amp;&amp;);</span>
<span class="udiff-line-modified-added">+     Ref&lt;IDBRequest&gt; doRequestOpenCursor(JSC::JSGlobalObject&amp;, Ref&lt;IDBCursor&gt;&amp;&amp;);</span>
      void openCursorOnServer(IDBClient::TransactionOperation&amp;, const IDBCursorInfo&amp;);
      void didOpenCursorOnServer(IDBRequest&amp;, const IDBResultData&amp;);
  
      void iterateCursorOnServer(IDBClient::TransactionOperation&amp;, const IDBIterateCursorData&amp;);
      void didIterateCursorOnServer(IDBRequest&amp;, const IDBResultData&amp;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -227,32 +230,27 @@</span>
      void establishOnServer();
  
      void completeNoncursorRequest(IDBRequest&amp;, const IDBResultData&amp;);
      void completeCursorRequest(IDBRequest&amp;, const IDBResultData&amp;);
  
<span class="udiff-line-modified-removed">-     void schedulePendingOperationTimer();</span>
<span class="udiff-line-removed">-     void scheduleCompletedOperationTimer();</span>
<span class="udiff-line-modified-added">+     void trySchedulePendingOperationTimer();</span>
  
      Ref&lt;IDBDatabase&gt; m_database;
      IDBTransactionInfo m_info;
  
      IndexedDB::TransactionState m_state { IndexedDB::TransactionState::Inactive };
      bool m_startedOnServer { false };
  
      IDBError m_idbError;
      RefPtr&lt;DOMException&gt; m_domError;
  
<span class="udiff-line-removed">-     Timer m_pendingOperationTimer;</span>
<span class="udiff-line-removed">-     Timer m_completedOperationTimer;</span>
<span class="udiff-line-removed">-     std::unique_ptr&lt;Timer&gt; m_activationTimer;</span>
<span class="udiff-line-removed">- </span>
      RefPtr&lt;IDBOpenDBRequest&gt; m_openDBRequest;
  
      Deque&lt;RefPtr&lt;IDBClient::TransactionOperation&gt;&gt; m_pendingTransactionOperationQueue;
      Deque&lt;IDBClient::TransactionOperation*&gt; m_transactionOperationsInProgressQueue;
<span class="udiff-line-removed">-     Deque&lt;std::pair&lt;RefPtr&lt;IDBClient::TransactionOperation&gt;, IDBResultData&gt;&gt; m_completedOnServerQueue;</span>
      Deque&lt;RefPtr&lt;IDBClient::TransactionOperation&gt;&gt; m_abortQueue;
<span class="udiff-line-added">+     HashMap&lt;RefPtr&lt;IDBClient::TransactionOperation&gt;, IDBResultData&gt; m_transactionOperationResultMap;</span>
  
      HashMap&lt;IDBResourceIdentifier, RefPtr&lt;IDBClient::TransactionOperation&gt;&gt; m_transactionOperationMap;
  
      mutable Lock m_referencedObjectStoreLock;
      HashMap&lt;String, std::unique_ptr&lt;IDBObjectStore&gt;&gt; m_referencedObjectStores;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -261,10 +259,12 @@</span>
      HashSet&lt;RefPtr&lt;IDBRequest&gt;&gt; m_openRequests;
      RefPtr&lt;IDBRequest&gt; m_currentlyCompletingRequest;
  
      bool m_contextStopped { false };
      bool m_didDispatchAbortOrCommit { false };
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     uint64_t m_lastWriteOperationID { 0 };</span>
  };
  
  class TransactionActivator {
      WTF_MAKE_NONCOPYABLE(TransactionActivator);
  public:
</pre>
<center><a href="IDBTransaction.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="IDBValue.cpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>