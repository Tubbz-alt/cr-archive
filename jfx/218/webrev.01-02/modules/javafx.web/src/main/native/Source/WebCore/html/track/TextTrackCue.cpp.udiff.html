<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WebCore/html/track/TextTrackCue.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="TextTrack.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="TextTrackCue.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/html/track/TextTrackCue.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,8 +1,8 @@</span>
  /*
   * Copyright (C) 2011, 2013 Google Inc.  All rights reserved.
<span class="udiff-line-modified-removed">-  * Copyright (C) 2011-2017 Apple Inc. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (C) 2011-2020 Apple Inc. All rights reserved.</span>
   *
   * Redistribution and use in source and binary forms, with or without
   * modification, are permitted provided that the following conditions are
   * met:
   *
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -34,40 +34,202 @@</span>
  
  #if ENABLE(VIDEO_TRACK)
  
  #include &quot;CSSPropertyNames.h&quot;
  #include &quot;CSSValueKeywords.h&quot;
<span class="udiff-line-added">+ #include &quot;DOMRect.h&quot;</span>
  #include &quot;Event.h&quot;
<span class="udiff-line-added">+ #include &quot;HTMLCollection.h&quot;</span>
<span class="udiff-line-added">+ #include &quot;HTMLDivElement.h&quot;</span>
<span class="udiff-line-added">+ #include &quot;HTMLStyleElement.h&quot;</span>
  #include &quot;Logging.h&quot;
  #include &quot;NodeTraversal.h&quot;
<span class="udiff-line-added">+ #include &quot;Page.h&quot;</span>
<span class="udiff-line-added">+ #include &quot;ScriptDisallowedScope.h&quot;</span>
  #include &quot;Text.h&quot;
  #include &quot;TextTrack.h&quot;
  #include &quot;TextTrackCueList.h&quot;
  #include &quot;VTTCue.h&quot;
  #include &quot;VTTRegionList.h&quot;
<span class="udiff-line-added">+ #include &lt;limits.h&gt;</span>
  #include &lt;wtf/HexNumber.h&gt;
  #include &lt;wtf/IsoMallocInlines.h&gt;
  #include &lt;wtf/MathExtras.h&gt;
  #include &lt;wtf/NeverDestroyed.h&gt;
<span class="udiff-line-added">+ #include &lt;wtf/OptionSet.h&gt;</span>
  #include &lt;wtf/text/StringConcatenateNumbers.h&gt;
  
  namespace WebCore {
  
  WTF_MAKE_ISO_ALLOCATED_IMPL(TextTrackCue);
<span class="udiff-line-added">+ WTF_MAKE_ISO_ALLOCATED_IMPL(TextTrackCueBox);</span>
  
  const AtomString&amp; TextTrackCue::cueShadowPseudoId()
  {
      static NeverDestroyed&lt;const AtomString&gt; cue(&quot;cue&quot;, AtomString::ConstructFromLiteral);
      return cue;
  }
  
<span class="udiff-line-added">+ const AtomString&amp; TextTrackCue::cueBoxShadowPseudoId()</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     static NeverDestroyed&lt;const AtomString&gt; trackDisplayBoxShadowPseudoId(&quot;-webkit-media-text-track-display&quot;, AtomString::ConstructFromLiteral);</span>
<span class="udiff-line-added">+     return trackDisplayBoxShadowPseudoId;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ const AtomString&amp; TextTrackCue::cueBackdropShadowPseudoId()</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     static NeverDestroyed&lt;const AtomString&gt; cueBackdropShadowPseudoId(&quot;-webkit-media-text-track-display-backdrop&quot;, AtomString::ConstructFromLiteral);</span>
<span class="udiff-line-added">+     return cueBackdropShadowPseudoId;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ static const QualifiedName&amp; cueAttributName()</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     static NeverDestroyed&lt;QualifiedName&gt; cueTag(nullAtom(), &quot;cue&quot;, nullAtom());</span>
<span class="udiff-line-added">+     return cueTag;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ static const QualifiedName&amp; cueBackgroundAttributName()</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     static NeverDestroyed&lt;QualifiedName&gt; cueBackgroundTag(nullAtom(), &quot;cuebackground&quot;, nullAtom());</span>
<span class="udiff-line-added">+     return cueBackgroundTag;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ TextTrackCueBox::TextTrackCueBox(Document&amp; document, TextTrackCue&amp; cue)</span>
<span class="udiff-line-added">+     : HTMLElement(HTMLNames::divTag, document)</span>
<span class="udiff-line-added">+     , m_cue(makeWeakPtr(cue))</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     setHasCustomStyleResolveCallbacks();</span>
<span class="udiff-line-added">+     setPseudo(TextTrackCue::cueBoxShadowPseudoId());</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ TextTrackCue* TextTrackCueBox::getCue() const</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     return m_cue.get();</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ static inline bool isLegalNode(Node&amp; node)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     return node.hasTagName(HTMLNames::brTag)</span>
<span class="udiff-line-added">+         || node.hasTagName(HTMLNames::divTag)</span>
<span class="udiff-line-added">+         || node.hasTagName(HTMLNames::imgTag)</span>
<span class="udiff-line-added">+         || node.hasTagName(HTMLNames::pTag)</span>
<span class="udiff-line-added">+         || node.hasTagName(HTMLNames::rbTag)</span>
<span class="udiff-line-added">+         || node.hasTagName(HTMLNames::rtTag)</span>
<span class="udiff-line-added">+         || node.hasTagName(HTMLNames::rtcTag)</span>
<span class="udiff-line-added">+         || node.hasTagName(HTMLNames::rubyTag)</span>
<span class="udiff-line-added">+         || node.hasTagName(HTMLNames::spanTag)</span>
<span class="udiff-line-added">+         || node.nodeType() == Node::TEXT_NODE;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ static Exception invalidNodeException(Node&amp; node)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     return Exception { InvalidNodeTypeError, makeString(&quot;Invalid node type: &quot;, node.nodeName()) };</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ static ExceptionOr&lt;void&gt; checkForInvalidNodeTypes(Node&amp; root)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     if (!isLegalNode(root))</span>
<span class="udiff-line-added">+         return invalidNodeException(root);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     for (auto* child = root.firstChild(); child; child = child-&gt;nextSibling()) {</span>
<span class="udiff-line-added">+         if (!isLegalNode(*child))</span>
<span class="udiff-line-added">+             return invalidNodeException(*child);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         if (is&lt;ContainerNode&gt;(*child)) {</span>
<span class="udiff-line-added">+             auto result = checkForInvalidNodeTypes(*child);</span>
<span class="udiff-line-added">+             if (result.hasException())</span>
<span class="udiff-line-added">+                 return result.releaseException();</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     return { };</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ enum RequiredNodes {</span>
<span class="udiff-line-added">+     Cue = 1 &lt;&lt; 0,</span>
<span class="udiff-line-added">+     CueBackground = 1 &lt;&lt; 1,</span>
<span class="udiff-line-added">+ };</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ static OptionSet&lt;RequiredNodes&gt; tagPseudoObjects(Node&amp; node)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     if (!is&lt;Element&gt;(node))</span>
<span class="udiff-line-added">+         return { };</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     OptionSet&lt;RequiredNodes&gt; nodeTypes = { };</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     auto&amp; element = downcast&lt;Element&gt;(node);</span>
<span class="udiff-line-added">+     if (element.hasAttributeWithoutSynchronization(cueAttributName())) {</span>
<span class="udiff-line-added">+         element.setPseudo(TextTrackCue::cueShadowPseudoId());</span>
<span class="udiff-line-added">+         nodeTypes = { RequiredNodes::Cue };</span>
<span class="udiff-line-added">+     } else if (element.hasAttributeWithoutSynchronization(cueBackgroundAttributName())) {</span>
<span class="udiff-line-added">+         element.setPseudo(TextTrackCue::cueBackdropShadowPseudoId());</span>
<span class="udiff-line-added">+         nodeTypes = { RequiredNodes::CueBackground };</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     for (auto* child = element.firstChild(); child; child = child-&gt;nextSibling())</span>
<span class="udiff-line-added">+         nodeTypes.add(tagPseudoObjects(*child));</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     return nodeTypes;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ static void removePseudoAttributes(Node&amp; node)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     if (!is&lt;Element&gt;(node))</span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     auto&amp; element = downcast&lt;Element&gt;(node);</span>
<span class="udiff-line-added">+     if (element.hasAttributeWithoutSynchronization(cueAttributName()) || element.hasAttributeWithoutSynchronization(cueBackgroundAttributName()))</span>
<span class="udiff-line-added">+         element.removeAttribute(HTMLNames::pseudoAttr);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     for (auto* child = element.firstChild(); child; child = child-&gt;nextSibling())</span>
<span class="udiff-line-added">+         removePseudoAttributes(*child);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ ExceptionOr&lt;Ref&lt;TextTrackCue&gt;&gt; TextTrackCue::create(ScriptExecutionContext&amp; context, double start, double end, DocumentFragment&amp; cueDocument)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     ASSERT(context.isDocument());</span>
<span class="udiff-line-added">+     ASSERT(is&lt;DocumentFragment&gt;(cueDocument));</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (!cueDocument.firstChild())</span>
<span class="udiff-line-added">+         return Exception { InvalidNodeTypeError, &quot;Empty cue fragment&quot; };</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     for (Node* node = cueDocument.firstChild(); node; node = node-&gt;nextSibling()) {</span>
<span class="udiff-line-added">+         auto result = checkForInvalidNodeTypes(*node);</span>
<span class="udiff-line-added">+         if (result.hasException())</span>
<span class="udiff-line-added">+             return result.releaseException();</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     auto fragment = DocumentFragment::create(downcast&lt;Document&gt;(context));</span>
<span class="udiff-line-added">+     for (Node* node = cueDocument.firstChild(); node; node = node-&gt;nextSibling()) {</span>
<span class="udiff-line-added">+         auto result = fragment-&gt;ensurePreInsertionValidity(*node, nullptr);</span>
<span class="udiff-line-added">+         if (result.hasException())</span>
<span class="udiff-line-added">+             return result.releaseException();</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+     cueDocument.cloneChildNodes(fragment);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     OptionSet&lt;RequiredNodes&gt; nodeTypes = { };</span>
<span class="udiff-line-added">+     for (Node* node = fragment-&gt;firstChild(); node; node = node-&gt;nextSibling())</span>
<span class="udiff-line-added">+         nodeTypes.add(tagPseudoObjects(*node));</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (!nodeTypes.contains(RequiredNodes::Cue))</span>
<span class="udiff-line-added">+         return Exception { InvalidStateError, makeString(&quot;Missing required attribute: &quot;, cueAttributName().toString()) };</span>
<span class="udiff-line-added">+     if (!nodeTypes.contains(RequiredNodes::CueBackground))</span>
<span class="udiff-line-added">+         return Exception { InvalidStateError, makeString(&quot;Missing required attribute: &quot;, cueBackgroundAttributName().toString()) };</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     return adoptRef(*new TextTrackCue(context, MediaTime::createWithDouble(start), MediaTime::createWithDouble(end), WTFMove(fragment.get())));</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ TextTrackCue::TextTrackCue(ScriptExecutionContext&amp; context, const MediaTime&amp; start, const MediaTime&amp; end, DocumentFragment&amp;&amp; cueFragment)</span>
<span class="udiff-line-added">+     : TextTrackCue(context, start, end)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     m_cueNode = &amp;cueFragment;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  TextTrackCue::TextTrackCue(ScriptExecutionContext&amp; context, const MediaTime&amp; start, const MediaTime&amp; end)
      : m_startTime(start)
      , m_endTime(end)
      , m_scriptExecutionContext(context)
<span class="udiff-line-removed">-     , m_isActive(false)</span>
<span class="udiff-line-removed">-     , m_pauseOnExit(false)</span>
  {
      ASSERT(m_scriptExecutionContext.isDocument());
  }
  
  void TextTrackCue::willChange()
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -83,10 +245,12 @@</span>
  {
      ASSERT(m_processingCueChanges);
      if (--m_processingCueChanges)
          return;
  
<span class="udiff-line-added">+     m_displayTreeNeedsUpdate = true;</span>
<span class="udiff-line-added">+ </span>
      if (m_track)
          m_track-&gt;cueDidChange(this);
  }
  
  TextTrack* TextTrackCue::track() const
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -164,15 +328,42 @@</span>
  }
  
  void TextTrackCue::setIsActive(bool active)
  {
      m_isActive = active;
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (m_isActive || !m_displayTree)</span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     // The display tree is never exposed to author scripts so it&#39;s safe to dispatch events here.</span>
<span class="udiff-line-added">+     ScriptDisallowedScope::EventAllowedScope allowedScope(*m_displayTree);</span>
<span class="udiff-line-added">+     m_displayTree-&gt;remove();</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ unsigned TextTrackCue::cueIndex() const</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     ASSERT(m_track &amp;&amp; m_track-&gt;cues());</span>
<span class="udiff-line-added">+     if (!m_track || !m_track-&gt;cues())</span>
<span class="udiff-line-added">+         return std::numeric_limits&lt;unsigned&gt;::max();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     return m_track-&gt;cues()-&gt;cueIndex(*this);</span>
  }
  
  bool TextTrackCue::isOrderedBefore(const TextTrackCue* other) const
  {
<span class="udiff-line-modified-removed">-     return startMediaTime() &lt; other-&gt;startMediaTime() || (startMediaTime() == other-&gt;startMediaTime() &amp;&amp; endMediaTime() &gt; other-&gt;endMediaTime());</span>
<span class="udiff-line-modified-added">+     // ... cues must be sorted by their start time, earliest first;</span>
<span class="udiff-line-added">+     if (startMediaTime() != other-&gt;startMediaTime())</span>
<span class="udiff-line-added">+         return startMediaTime() &lt; other-&gt;startMediaTime();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     // then, any cues with the same start time must be sorted by their end time, latest first;</span>
<span class="udiff-line-added">+     if (endMediaTime() != other-&gt;endMediaTime())</span>
<span class="udiff-line-added">+         return endMediaTime() &gt; other-&gt;endMediaTime();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     // and finally, any cues with identical end times must be sorted in the order they were last added to</span>
<span class="udiff-line-added">+     // their respective text track list of cues, oldest first (so e.g. for cues from a WebVTT file, that</span>
<span class="udiff-line-added">+     // would initially be the order in which the cues were listed in the file)</span>
<span class="udiff-line-added">+     return cueIndex() &lt; other-&gt;cueIndex();</span>
  }
  
  bool TextTrackCue::cueContentsMatch(const TextTrackCue&amp; cue) const
  {
      if (cueType() != cue.cueType())
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -223,19 +414,22 @@</span>
  
  void TextTrackCue::toJSON(JSON::Object&amp; value) const
  {
      ASCIILiteral type = &quot;Generic&quot;_s;
      switch (cueType()) {
<span class="udiff-line-modified-removed">-     case TextTrackCue::Generic:</span>
<span class="udiff-line-modified-removed">-         type = &quot;Generic&quot;_s;</span>
<span class="udiff-line-modified-added">+     case TextTrackCue::ConvertedToWebVTT:</span>
<span class="udiff-line-modified-added">+         type = &quot;ConvertedToWebVTT&quot;_s;</span>
          break;
      case TextTrackCue::WebVTT:
          type = &quot;WebVTT&quot;_s;
          break;
      case TextTrackCue::Data:
          type = &quot;Data&quot;_s;
          break;
<span class="udiff-line-added">+     case TextTrackCue::Generic:</span>
<span class="udiff-line-added">+         type = &quot;Generic&quot;_s;</span>
<span class="udiff-line-added">+         break;</span>
      }
  
      value.setString(&quot;type&quot;_s, type);
      value.setDouble(&quot;startTime&quot;_s, startTime());
      value.setDouble(&quot;endTime&quot;_s, endTime());
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -248,16 +442,117 @@</span>
      toJSON(object.get());
  
      return object-&gt;toJSONString();
  }
  
<span class="udiff-line-modified-removed">- String TextTrackCue::debugString() const</span>
<span class="udiff-line-modified-added">+ #ifndef NDEBUG</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ TextStream&amp; operator&lt;&lt;(TextStream&amp; stream, const TextTrackCue&amp; cue)</span>
  {
      String text;
<span class="udiff-line-modified-removed">-     if (isRenderable())</span>
<span class="udiff-line-modified-removed">-         text = toVTTCue(this)-&gt;text();</span>
<span class="udiff-line-modified-removed">-     return makeString(&quot;0x&quot;, hex(reinterpret_cast&lt;uintptr_t&gt;(this)), &quot; id=&quot;, id(), &quot; interval=&quot;, startTime(), &quot;--&gt;&quot;, endTime(), &quot; cue=&quot;, text, &#39;)&#39;);</span>
<span class="udiff-line-modified-added">+     if (is&lt;VTTCue&gt;(cue))</span>
<span class="udiff-line-modified-added">+         text = toVTTCue(&amp;cue)-&gt;text();</span>
<span class="udiff-line-modified-added">+     return stream &lt;&lt; &amp;cue &lt;&lt; &quot; id=&quot; &lt;&lt; cue.id() &lt;&lt; &quot; interval=&quot; &lt;&lt; cue.startTime() &lt;&lt; &quot;--&gt;&quot; &lt;&lt; cue.endTime() &lt;&lt; &quot; cue=&quot; &lt;&lt; text &lt;&lt; &#39;)&#39;;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ RefPtr&lt;DocumentFragment&gt; TextTrackCue::getCueAsHTML()</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     if (!m_cueNode)</span>
<span class="udiff-line-added">+         return nullptr;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     auto clonedFragment = DocumentFragment::create(ownerDocument());</span>
<span class="udiff-line-added">+     m_cueNode-&gt;cloneChildNodes(clonedFragment);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     for (Node* node = clonedFragment-&gt;firstChild(); node; node = node-&gt;nextSibling())</span>
<span class="udiff-line-added">+         removePseudoAttributes(*node);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     return clonedFragment;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ bool TextTrackCue::isRenderable() const</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     return m_cueNode &amp;&amp; m_cueNode-&gt;firstChild();</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ RefPtr&lt;TextTrackCueBox&gt; TextTrackCue::getDisplayTree(const IntSize&amp;, int)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     if (m_displayTree &amp;&amp; !m_displayTreeNeedsUpdate)</span>
<span class="udiff-line-added">+         return m_displayTree;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     rebuildDisplayTree();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     return m_displayTree;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void TextTrackCue::removeDisplayTree()</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     if (!m_displayTree)</span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     // The display tree is never exposed to author scripts so it&#39;s safe to dispatch events here.</span>
<span class="udiff-line-added">+     ScriptDisallowedScope::EventAllowedScope allowedScope(*m_displayTree);</span>
<span class="udiff-line-added">+     m_displayTree-&gt;remove();</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void TextTrackCue::setFontSize(int fontSize, const IntSize&amp;, bool important)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     if (fontSize == m_fontSize &amp;&amp; important == m_fontSizeIsImportant)</span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     m_displayTreeNeedsUpdate = true;</span>
<span class="udiff-line-added">+     m_fontSizeIsImportant = important;</span>
<span class="udiff-line-added">+     m_fontSize = fontSize;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void TextTrackCue::rebuildDisplayTree()</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     if (!m_cueNode)</span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     ScriptDisallowedScope::EventAllowedScope allowedScopeForReferenceTree(*m_cueNode);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (!m_displayTree) {</span>
<span class="udiff-line-added">+         m_displayTree = TextTrackCueBox::create(ownerDocument(), *this);</span>
<span class="udiff-line-added">+         m_displayTree-&gt;setPseudo(AtomString(&quot;-webkit-generic-cue-root&quot;, AtomString::ConstructFromLiteral));</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     m_displayTree-&gt;removeChildren();</span>
<span class="udiff-line-added">+     auto clonedFragment = DocumentFragment::create(ownerDocument());</span>
<span class="udiff-line-added">+     m_cueNode-&gt;cloneChildNodes(clonedFragment);</span>
<span class="udiff-line-added">+     m_displayTree-&gt;appendChild(clonedFragment);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (m_fontSize &amp;&amp; ownerDocument().page()) {</span>
<span class="udiff-line-added">+         StringBuilder builder;</span>
<span class="udiff-line-added">+         builder.append(ownerDocument().page()-&gt;captionUserPreferencesStyleSheet());</span>
<span class="udiff-line-added">+         builder.appendLiteral(&quot; ::&quot;);</span>
<span class="udiff-line-added">+         builder.append(TextTrackCue::cueShadowPseudoId());</span>
<span class="udiff-line-added">+         builder.append(&#39;{&#39;);</span>
<span class="udiff-line-added">+         builder.append(getPropertyNameString(CSSPropertyFontSize));</span>
<span class="udiff-line-added">+         builder.append(&#39;:&#39;);</span>
<span class="udiff-line-added">+         builder.append(makeString(m_fontSize, &quot;px&quot;));</span>
<span class="udiff-line-added">+         if (m_fontSizeIsImportant)</span>
<span class="udiff-line-added">+             builder.appendLiteral(&quot; !important&quot;);</span>
<span class="udiff-line-added">+         builder.appendLiteral(&quot;; }&quot;);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         auto style = HTMLStyleElement::create(HTMLNames::styleTag, ownerDocument(), false);</span>
<span class="udiff-line-added">+         style-&gt;setTextContent(builder.toString());</span>
<span class="udiff-line-added">+         m_displayTree-&gt;appendChild(style);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (track()) {</span>
<span class="udiff-line-added">+         if (const auto&amp; styleSheets = track()-&gt;styleSheets()) {</span>
<span class="udiff-line-added">+             for (const auto&amp; cssString : *styleSheets) {</span>
<span class="udiff-line-added">+                 auto style = HTMLStyleElement::create(HTMLNames::styleTag, m_displayTree-&gt;document(), false);</span>
<span class="udiff-line-added">+                 style-&gt;setTextContent(cssString);</span>
<span class="udiff-line-added">+                 m_displayTree-&gt;appendChild(style);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     m_displayTreeNeedsUpdate = false;</span>
  }
  
  } // namespace WebCore
  
  #endif
</pre>
<center><a href="TextTrack.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="TextTrackCue.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>