<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.web/src/main/native/Source/JavaScriptCore/runtime/StringConstructor.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="StrictEvalActivation.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="StringConstructor.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/JavaScriptCore/runtime/StringConstructor.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 29,12 ***</span>
  #include &quot;StringPrototype.h&quot;
  #include &lt;wtf/text/StringBuilder.h&gt;
  
  namespace JSC {
  
<span class="line-modified">! static EncodedJSValue JSC_HOST_CALL stringFromCharCode(ExecState*);</span>
<span class="line-modified">! static EncodedJSValue JSC_HOST_CALL stringFromCodePoint(ExecState*);</span>
  
  }
  
  #include &quot;StringConstructor.lut.h&quot;
  
<span class="line-new-header">--- 29,12 ---</span>
  #include &quot;StringPrototype.h&quot;
  #include &lt;wtf/text/StringBuilder.h&gt;
  
  namespace JSC {
  
<span class="line-modified">! static EncodedJSValue JSC_HOST_CALL stringFromCharCode(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">! static EncodedJSValue JSC_HOST_CALL stringFromCodePoint(JSGlobalObject*, CallFrame*);</span>
  
  }
  
  #include &quot;StringConstructor.lut.h&quot;
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 51,84 ***</span>
  */
  
  STATIC_ASSERT_IS_TRIVIALLY_DESTRUCTIBLE(StringConstructor);
  
  
<span class="line-modified">! static EncodedJSValue JSC_HOST_CALL callStringConstructor(ExecState*);</span>
<span class="line-modified">! static EncodedJSValue JSC_HOST_CALL constructWithStringConstructor(ExecState*);</span>
  
  StringConstructor::StringConstructor(VM&amp; vm, Structure* structure)
      : InternalFunction(vm, structure, callStringConstructor, constructWithStringConstructor)
  {
  }
  
  void StringConstructor::finishCreation(VM&amp; vm, StringPrototype* stringPrototype)
  {
<span class="line-modified">!     Base::finishCreation(vm, vm.propertyNames-&gt;String.string(), NameVisibility::Visible, NameAdditionMode::WithoutStructureTransition);</span>
      putDirectWithoutTransition(vm, vm.propertyNames-&gt;prototype, stringPrototype, PropertyAttribute::ReadOnly | PropertyAttribute::DontEnum | PropertyAttribute::DontDelete);
      putDirectWithoutTransition(vm, vm.propertyNames-&gt;length, jsNumber(1), PropertyAttribute::ReadOnly | PropertyAttribute::DontEnum);
  }
  
  // ------------------------------ Functions --------------------------------
  
<span class="line-modified">! static EncodedJSValue JSC_HOST_CALL stringFromCharCode(ExecState* exec)</span>
  {
<span class="line-modified">!     VM&amp; vm = exec-&gt;vm();</span>
      auto scope = DECLARE_THROW_SCOPE(vm);
  
<span class="line-modified">!     unsigned length = exec-&gt;argumentCount();</span>
      if (LIKELY(length == 1)) {
          scope.release();
<span class="line-modified">!         unsigned code = exec-&gt;uncheckedArgument(0).toUInt32(exec);</span>
          // Not checking for an exception here is ok because jsSingleCharacterString will just fetch an unused string if there&#39;s an exception.
          return JSValue::encode(jsSingleCharacterString(vm, code));
      }
  
      LChar* buf8Bit;
      auto impl8Bit = StringImpl::createUninitialized(length, buf8Bit);
      for (unsigned i = 0; i &lt; length; ++i) {
<span class="line-modified">!         UChar character = static_cast&lt;UChar&gt;(exec-&gt;uncheckedArgument(i).toUInt32(exec));</span>
          RETURN_IF_EXCEPTION(scope, encodedJSValue());
          if (UNLIKELY(!isLatin1(character))) {
              UChar* buf16Bit;
              auto impl16Bit = StringImpl::createUninitialized(length, buf16Bit);
              StringImpl::copyCharacters(buf16Bit, buf8Bit, i);
              buf16Bit[i] = character;
              ++i;
              for (; i &lt; length; ++i) {
<span class="line-modified">!                 buf16Bit[i] = static_cast&lt;UChar&gt;(exec-&gt;uncheckedArgument(i).toUInt32(exec));</span>
                  RETURN_IF_EXCEPTION(scope, encodedJSValue());
              }
              RELEASE_AND_RETURN(scope, JSValue::encode(jsString(vm, WTFMove(impl16Bit))));
          }
          buf8Bit[i] = static_cast&lt;LChar&gt;(character);
      }
      RELEASE_AND_RETURN(scope, JSValue::encode(jsString(vm, WTFMove(impl8Bit))));
  }
  
<span class="line-modified">! JSString* JSC_HOST_CALL stringFromCharCode(ExecState* exec, int32_t arg)</span>
  {
<span class="line-modified">!     return jsSingleCharacterString(exec-&gt;vm(), arg);</span>
  }
  
<span class="line-modified">! static EncodedJSValue JSC_HOST_CALL stringFromCodePoint(ExecState* exec)</span>
  {
<span class="line-modified">!     VM&amp; vm = exec-&gt;vm();</span>
      auto scope = DECLARE_THROW_SCOPE(vm);
  
<span class="line-modified">!     unsigned length = exec-&gt;argumentCount();</span>
      StringBuilder builder;
      builder.reserveCapacity(length);
  
      for (unsigned i = 0; i &lt; length; ++i) {
<span class="line-modified">!         double codePointAsDouble = exec-&gt;uncheckedArgument(i).toNumber(exec);</span>
          RETURN_IF_EXCEPTION(scope, encodedJSValue());
  
          uint32_t codePoint = static_cast&lt;uint32_t&gt;(codePointAsDouble);
  
          if (codePoint != codePointAsDouble || codePoint &gt; UCHAR_MAX_VALUE)
<span class="line-modified">!             return throwVMError(exec, scope, createRangeError(exec, &quot;Arguments contain a value that is out of range of code points&quot;_s));</span>
  
          if (U_IS_BMP(codePoint))
              builder.append(static_cast&lt;UChar&gt;(codePoint));
          else {
              builder.append(U16_LEAD(codePoint));
<span class="line-new-header">--- 51,84 ---</span>
  */
  
  STATIC_ASSERT_IS_TRIVIALLY_DESTRUCTIBLE(StringConstructor);
  
  
<span class="line-modified">! static EncodedJSValue JSC_HOST_CALL callStringConstructor(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">! static EncodedJSValue JSC_HOST_CALL constructWithStringConstructor(JSGlobalObject*, CallFrame*);</span>
  
  StringConstructor::StringConstructor(VM&amp; vm, Structure* structure)
      : InternalFunction(vm, structure, callStringConstructor, constructWithStringConstructor)
  {
  }
  
  void StringConstructor::finishCreation(VM&amp; vm, StringPrototype* stringPrototype)
  {
<span class="line-modified">!     Base::finishCreation(vm, vm.propertyNames-&gt;String.string(), NameAdditionMode::WithoutStructureTransition);</span>
      putDirectWithoutTransition(vm, vm.propertyNames-&gt;prototype, stringPrototype, PropertyAttribute::ReadOnly | PropertyAttribute::DontEnum | PropertyAttribute::DontDelete);
      putDirectWithoutTransition(vm, vm.propertyNames-&gt;length, jsNumber(1), PropertyAttribute::ReadOnly | PropertyAttribute::DontEnum);
  }
  
  // ------------------------------ Functions --------------------------------
  
<span class="line-modified">! static EncodedJSValue JSC_HOST_CALL stringFromCharCode(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
  {
<span class="line-modified">!     VM&amp; vm = globalObject-&gt;vm();</span>
      auto scope = DECLARE_THROW_SCOPE(vm);
  
<span class="line-modified">!     unsigned length = callFrame-&gt;argumentCount();</span>
      if (LIKELY(length == 1)) {
          scope.release();
<span class="line-modified">!         unsigned code = callFrame-&gt;uncheckedArgument(0).toUInt32(globalObject);</span>
          // Not checking for an exception here is ok because jsSingleCharacterString will just fetch an unused string if there&#39;s an exception.
          return JSValue::encode(jsSingleCharacterString(vm, code));
      }
  
      LChar* buf8Bit;
      auto impl8Bit = StringImpl::createUninitialized(length, buf8Bit);
      for (unsigned i = 0; i &lt; length; ++i) {
<span class="line-modified">!         UChar character = static_cast&lt;UChar&gt;(callFrame-&gt;uncheckedArgument(i).toUInt32(globalObject));</span>
          RETURN_IF_EXCEPTION(scope, encodedJSValue());
          if (UNLIKELY(!isLatin1(character))) {
              UChar* buf16Bit;
              auto impl16Bit = StringImpl::createUninitialized(length, buf16Bit);
              StringImpl::copyCharacters(buf16Bit, buf8Bit, i);
              buf16Bit[i] = character;
              ++i;
              for (; i &lt; length; ++i) {
<span class="line-modified">!                 buf16Bit[i] = static_cast&lt;UChar&gt;(callFrame-&gt;uncheckedArgument(i).toUInt32(globalObject));</span>
                  RETURN_IF_EXCEPTION(scope, encodedJSValue());
              }
              RELEASE_AND_RETURN(scope, JSValue::encode(jsString(vm, WTFMove(impl16Bit))));
          }
          buf8Bit[i] = static_cast&lt;LChar&gt;(character);
      }
      RELEASE_AND_RETURN(scope, JSValue::encode(jsString(vm, WTFMove(impl8Bit))));
  }
  
<span class="line-modified">! JSString* JSC_HOST_CALL stringFromCharCode(JSGlobalObject* globalObject, int32_t arg)</span>
  {
<span class="line-modified">!     return jsSingleCharacterString(globalObject-&gt;vm(), arg);</span>
  }
  
<span class="line-modified">! static EncodedJSValue JSC_HOST_CALL stringFromCodePoint(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
  {
<span class="line-modified">!     VM&amp; vm = globalObject-&gt;vm();</span>
      auto scope = DECLARE_THROW_SCOPE(vm);
  
<span class="line-modified">!     unsigned length = callFrame-&gt;argumentCount();</span>
      StringBuilder builder;
      builder.reserveCapacity(length);
  
      for (unsigned i = 0; i &lt; length; ++i) {
<span class="line-modified">!         double codePointAsDouble = callFrame-&gt;uncheckedArgument(i).toNumber(globalObject);</span>
          RETURN_IF_EXCEPTION(scope, encodedJSValue());
  
          uint32_t codePoint = static_cast&lt;uint32_t&gt;(codePointAsDouble);
  
          if (codePoint != codePointAsDouble || codePoint &gt; UCHAR_MAX_VALUE)
<span class="line-modified">!             return throwVMError(globalObject, scope, createRangeError(globalObject, &quot;Arguments contain a value that is out of range of code points&quot;_s));</span>
  
          if (U_IS_BMP(codePoint))
              builder.append(static_cast&lt;UChar&gt;(codePoint));
          else {
              builder.append(U16_LEAD(codePoint));
</pre>
<hr />
<pre>
<span class="line-old-header">*** 137,38 ***</span>
      }
  
      RELEASE_AND_RETURN(scope, JSValue::encode(jsString(vm, builder.toString())));
  }
  
<span class="line-modified">! static EncodedJSValue JSC_HOST_CALL constructWithStringConstructor(ExecState* exec)</span>
  {
<span class="line-modified">!     VM&amp; vm = exec-&gt;vm();</span>
<span class="line-removed">-     JSGlobalObject* globalObject = jsCast&lt;InternalFunction*&gt;(exec-&gt;jsCallee())-&gt;globalObject(vm);</span>
      auto scope = DECLARE_THROW_SCOPE(vm);
  
<span class="line-modified">!     Structure* structure = InternalFunction::createSubclassStructure(exec, exec-&gt;newTarget(), globalObject-&gt;stringObjectStructure());</span>
      RETURN_IF_EXCEPTION(scope, encodedJSValue());
  
<span class="line-modified">!     if (!exec-&gt;argumentCount())</span>
          return JSValue::encode(StringObject::create(vm, structure));
<span class="line-modified">!     JSString* str = exec-&gt;uncheckedArgument(0).toString(exec);</span>
      RETURN_IF_EXCEPTION(scope, encodedJSValue());
      return JSValue::encode(StringObject::create(vm, structure, str));
  }
  
<span class="line-modified">! JSString* stringConstructor(ExecState* exec, JSValue argument)</span>
  {
<span class="line-modified">!     VM&amp; vm = exec-&gt;vm();</span>
      if (argument.isSymbol())
          return jsNontrivialString(vm, asSymbol(argument)-&gt;descriptiveString());
<span class="line-modified">!     return argument.toString(exec);</span>
  }
  
<span class="line-modified">! static EncodedJSValue JSC_HOST_CALL callStringConstructor(ExecState* exec)</span>
  {
<span class="line-modified">!     VM&amp; vm = exec-&gt;vm();</span>
<span class="line-modified">!     if (!exec-&gt;argumentCount())</span>
          return JSValue::encode(jsEmptyString(vm));
<span class="line-modified">!     return JSValue::encode(stringConstructor(exec, exec-&gt;uncheckedArgument(0)));</span>
  }
  
  } // namespace JSC
<span class="line-new-header">--- 137,37 ---</span>
      }
  
      RELEASE_AND_RETURN(scope, JSValue::encode(jsString(vm, builder.toString())));
  }
  
<span class="line-modified">! static EncodedJSValue JSC_HOST_CALL constructWithStringConstructor(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
  {
<span class="line-modified">!     VM&amp; vm = globalObject-&gt;vm();</span>
      auto scope = DECLARE_THROW_SCOPE(vm);
  
<span class="line-modified">!     Structure* structure = InternalFunction::createSubclassStructure(globalObject, callFrame-&gt;jsCallee(), callFrame-&gt;newTarget(), globalObject-&gt;stringObjectStructure());</span>
      RETURN_IF_EXCEPTION(scope, encodedJSValue());
  
<span class="line-modified">!     if (!callFrame-&gt;argumentCount())</span>
          return JSValue::encode(StringObject::create(vm, structure));
<span class="line-modified">!     JSString* str = callFrame-&gt;uncheckedArgument(0).toString(globalObject);</span>
      RETURN_IF_EXCEPTION(scope, encodedJSValue());
      return JSValue::encode(StringObject::create(vm, structure, str));
  }
  
<span class="line-modified">! JSString* stringConstructor(JSGlobalObject* globalObject, JSValue argument)</span>
  {
<span class="line-modified">!     VM&amp; vm = globalObject-&gt;vm();</span>
      if (argument.isSymbol())
          return jsNontrivialString(vm, asSymbol(argument)-&gt;descriptiveString());
<span class="line-modified">!     return argument.toString(globalObject);</span>
  }
  
<span class="line-modified">! static EncodedJSValue JSC_HOST_CALL callStringConstructor(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
  {
<span class="line-modified">!     VM&amp; vm = globalObject-&gt;vm();</span>
<span class="line-modified">!     if (!callFrame-&gt;argumentCount())</span>
          return JSValue::encode(jsEmptyString(vm));
<span class="line-modified">!     return JSValue::encode(stringConstructor(globalObject, callFrame-&gt;uncheckedArgument(0)));</span>
  }
  
  } // namespace JSC
</pre>
<center><a href="StrictEvalActivation.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="StringConstructor.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>