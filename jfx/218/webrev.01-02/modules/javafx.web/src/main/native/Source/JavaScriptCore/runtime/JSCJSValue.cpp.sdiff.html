<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/JavaScriptCore/runtime/JSCJSValue.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="JSCInlines.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="JSCJSValue.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/JavaScriptCore/runtime/JSCJSValue.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 22 
 23 #include &quot;config.h&quot;
 24 #include &quot;JSCJSValue.h&quot;
 25 
 26 #include &quot;BooleanConstructor.h&quot;
 27 #include &quot;BooleanPrototype.h&quot;
 28 #include &quot;CustomGetterSetter.h&quot;
 29 #include &quot;Error.h&quot;
 30 #include &quot;ExceptionHelpers.h&quot;
 31 #include &quot;GetterSetter.h&quot;
 32 #include &quot;JSBigInt.h&quot;
 33 #include &quot;JSCInlines.h&quot;
 34 #include &quot;JSFunction.h&quot;
 35 #include &quot;JSGlobalObject.h&quot;
 36 #include &quot;NumberObject.h&quot;
 37 #include &lt;wtf/MathExtras.h&gt;
 38 
 39 namespace JSC {
 40 
 41 // ECMA 9.4
<span class="line-modified"> 42 double JSValue::toInteger(ExecState* exec) const</span>
 43 {
 44     if (isInt32())
 45         return asInt32();
<span class="line-modified"> 46     double d = toNumber(exec);</span>
 47     return std::isnan(d) ? 0.0 : trunc(d);
 48 }
 49 
<span class="line-modified"> 50 double JSValue::toIntegerPreserveNaN(ExecState* exec) const</span>
 51 {
 52     if (isInt32())
 53         return asInt32();
<span class="line-modified"> 54     return trunc(toNumber(exec));</span>
 55 }
 56 
<span class="line-modified"> 57 double JSValue::toLength(ExecState* exec) const</span>
 58 {
 59     // ECMA 7.1.15
 60     // http://www.ecma-international.org/ecma-262/6.0/#sec-tolength
<span class="line-modified"> 61     double d = toInteger(exec);</span>
 62     if (d &lt;= 0)
 63         return 0.0;
 64     if (std::isinf(d))
 65         return maxSafeInteger();
 66     return std::min(d, maxSafeInteger());
 67 }
 68 
<span class="line-modified"> 69 double JSValue::toNumberSlowCase(ExecState* exec) const</span>
 70 {
 71     ASSERT(!isInt32() &amp;&amp; !isDouble());
 72     if (isCell())
<span class="line-modified"> 73         return asCell()-&gt;toNumber(exec);</span>
 74     if (isTrue())
 75         return 1.0;
 76     return isUndefined() ? PNaN : 0; // null and false both convert to 0.
 77 }
 78 
 79 Optional&lt;double&gt; JSValue::toNumberFromPrimitive() const
 80 {
 81     if (isEmpty())
 82         return WTF::nullopt;
 83     if (isNumber())
 84         return asNumber();
 85     if (isBoolean())
 86         return asBoolean();
 87     if (isUndefined())
 88         return PNaN;
 89     if (isNull())
 90         return 0;
 91     return WTF::nullopt;
 92 }
 93 
<span class="line-modified"> 94 JSObject* JSValue::toObjectSlowCase(ExecState* exec, JSGlobalObject* globalObject) const</span>
 95 {
<span class="line-modified"> 96     VM&amp; vm = exec-&gt;vm();</span>
 97     auto scope = DECLARE_THROW_SCOPE(vm);
 98     ASSERT(!isCell());
 99 
100     if (isInt32() || isDouble())
<span class="line-modified">101         return constructNumber(exec, globalObject, asValue());</span>
102     if (isTrue() || isFalse())
<span class="line-modified">103         return constructBooleanFromImmediateBoolean(exec, globalObject, asValue());</span>
104 
105     ASSERT(isUndefinedOrNull());
<span class="line-modified">106     throwException(exec, scope, createNotAnObjectError(exec, *this));</span>
107     return nullptr;
108 }
109 
<span class="line-modified">110 JSValue JSValue::toThisSlowCase(ExecState* exec, ECMAMode ecmaMode) const</span>
111 {
112     ASSERT(!isCell());
113 
114     if (ecmaMode == StrictMode)
115         return *this;
116 
117     if (isInt32() || isDouble())
<span class="line-modified">118         return constructNumber(exec, exec-&gt;lexicalGlobalObject(), asValue());</span>
119     if (isTrue() || isFalse())
<span class="line-modified">120         return constructBooleanFromImmediateBoolean(exec, exec-&gt;lexicalGlobalObject(), asValue());</span>
121     ASSERT(isUndefinedOrNull());
<span class="line-modified">122     return exec-&gt;globalThisValue();</span>
123 }
124 
<span class="line-modified">125 JSObject* JSValue::synthesizePrototype(ExecState* exec) const</span>
126 {
<span class="line-modified">127     VM&amp; vm = exec-&gt;vm();</span>
128     auto scope = DECLARE_THROW_SCOPE(vm);
129 
130     if (isCell()) {
131         if (isString())
<span class="line-modified">132             return exec-&gt;lexicalGlobalObject()-&gt;stringPrototype();</span>
133         if (isBigInt())
<span class="line-modified">134             return exec-&gt;lexicalGlobalObject()-&gt;bigIntPrototype();</span>
135         ASSERT(isSymbol());
<span class="line-modified">136         return exec-&gt;lexicalGlobalObject()-&gt;symbolPrototype();</span>
137     }
138 
139     if (isNumber())
<span class="line-modified">140         return exec-&gt;lexicalGlobalObject()-&gt;numberPrototype();</span>
141     if (isBoolean())
<span class="line-modified">142         return exec-&gt;lexicalGlobalObject()-&gt;booleanPrototype();</span>
143 
144     ASSERT(isUndefinedOrNull());
<span class="line-modified">145     throwException(exec, scope, createNotAnObjectError(exec, *this));</span>
146     return nullptr;
147 }
148 
149 // ECMA 8.7.2
<span class="line-modified">150 bool JSValue::putToPrimitive(ExecState* exec, PropertyName propertyName, JSValue value, PutPropertySlot&amp; slot)</span>
151 {
<span class="line-modified">152     VM&amp; vm = exec-&gt;vm();</span>
153     auto scope = DECLARE_THROW_SCOPE(vm);
154 
155     if (Optional&lt;uint32_t&gt; index = parseIndex(propertyName))
<span class="line-modified">156         RELEASE_AND_RETURN(scope, putToPrimitiveByIndex(exec, index.value(), value, slot.isStrictMode()));</span>
157 
158     // Check if there are any setters or getters in the prototype chain
<span class="line-modified">159     JSObject* obj = synthesizePrototype(exec);</span>
160     EXCEPTION_ASSERT(!!scope.exception() == !obj);
161     if (UNLIKELY(!obj))
162         return false;
163     JSValue prototype;
164     if (propertyName != vm.propertyNames-&gt;underscoreProto) {
165         while (true) {
166             Structure* structure = obj-&gt;structure(vm);
167             if (structure-&gt;hasReadOnlyOrGetterSetterPropertiesExcludingProto() || structure-&gt;typeInfo().hasPutPropertySecurityCheck())
168                 break;
<span class="line-modified">169             prototype = obj-&gt;getPrototype(vm, exec);</span>
170             RETURN_IF_EXCEPTION(scope, false);
171 
172             if (prototype.isNull())
<span class="line-modified">173                 return typeError(exec, scope, slot.isStrictMode(), ReadonlyPropertyWriteError);</span>
174             obj = asObject(prototype);
175         }
176     }
177 
178     for (; ; obj = asObject(prototype)) {
179         Structure* structure = obj-&gt;structure(vm);
180         if (UNLIKELY(structure-&gt;typeInfo().hasPutPropertySecurityCheck())) {
<span class="line-modified">181             obj-&gt;methodTable(vm)-&gt;doPutPropertySecurityCheck(obj, exec, propertyName, slot);</span>
182             RETURN_IF_EXCEPTION(scope, false);
183         }
184         unsigned attributes;
185         PropertyOffset offset = structure-&gt;get(vm, propertyName, attributes);
186         if (offset != invalidOffset) {
187             if (attributes &amp; PropertyAttribute::ReadOnly)
<span class="line-modified">188                 return typeError(exec, scope, slot.isStrictMode(), ReadonlyPropertyWriteError);</span>
189 
190             JSValue gs = obj-&gt;getDirect(offset);
191             if (gs.isGetterSetter())
<span class="line-modified">192                 RELEASE_AND_RETURN(scope, callSetter(exec, *this, gs, value, slot.isStrictMode() ? StrictMode : NotStrictMode));</span>
193 
194             if (gs.isCustomGetterSetter())
<span class="line-modified">195                 return callCustomSetter(exec, gs, attributes &amp; PropertyAttribute::CustomAccessor, obj, slot.thisValue(), value);</span>
196 
197             // If there&#39;s an existing property on the object or one of its
198             // prototypes it should be replaced, so break here.
199             break;
200         }
201 
<span class="line-modified">202         prototype = obj-&gt;getPrototype(vm, exec);</span>
203         RETURN_IF_EXCEPTION(scope, false);
204         if (prototype.isNull())
205             break;
206     }
207 
<span class="line-modified">208     return typeError(exec, scope, slot.isStrictMode(), ReadonlyPropertyWriteError);</span>
209 }
210 
<span class="line-modified">211 bool JSValue::putToPrimitiveByIndex(ExecState* exec, unsigned propertyName, JSValue value, bool shouldThrow)</span>
212 {
<span class="line-modified">213     VM&amp; vm = exec-&gt;vm();</span>
214     auto scope = DECLARE_THROW_SCOPE(vm);
215 
216     if (propertyName &gt; MAX_ARRAY_INDEX) {
217         PutPropertySlot slot(*this, shouldThrow);
<span class="line-modified">218         return putToPrimitive(exec, Identifier::from(vm, propertyName), value, slot);</span>
219     }
220 
<span class="line-modified">221     JSObject* prototype = synthesizePrototype(exec);</span>
222     EXCEPTION_ASSERT(!!scope.exception() == !prototype);
223     if (UNLIKELY(!prototype))
224         return false;
225     bool putResult = false;
<span class="line-modified">226     bool success = prototype-&gt;attemptToInterceptPutByIndexOnHoleForPrototype(exec, *this, propertyName, value, shouldThrow, putResult);</span>
227     RETURN_IF_EXCEPTION(scope, false);
228     if (success)
229         return putResult;
230 
<span class="line-modified">231     return typeError(exec, scope, shouldThrow, ReadonlyPropertyWriteError);</span>
232 }
233 
234 void JSValue::dump(PrintStream&amp; out) const
235 {
236     dumpInContext(out, 0);
237 }
238 
239 void JSValue::dumpInContext(PrintStream&amp; out, DumpContext* context) const
240 {
241     dumpInContextAssumingStructure(
242         out, context, (!!*this &amp;&amp; isCell()) ? asCell()-&gt;structure() : nullptr);
243 }
244 
245 void JSValue::dumpInContextAssumingStructure(
246     PrintStream&amp; out, DumpContext* context, Structure* structure) const
247 {
248     if (!*this)
249         out.print(&quot;&lt;JSValue()&gt;&quot;);
250     else if (isInt32())
251         out.printf(&quot;Int32: %d&quot;, asInt32());
</pre>
<hr />
<pre>
253 #if USE(JSVALUE64)
254         out.printf(&quot;Double: %lld, %lf&quot;, (long long)reinterpretDoubleToInt64(asDouble()), asDouble());
255 #else
256         union {
257             double asDouble;
258             uint32_t asTwoInt32s[2];
259         } u;
260         u.asDouble = asDouble();
261         out.printf(&quot;Double: %08x:%08x, %lf&quot;, u.asTwoInt32s[1], u.asTwoInt32s[0], asDouble());
262 #endif
263     } else if (isCell()) {
264         if (structure-&gt;classInfo()-&gt;isSubClassOf(JSString::info())) {
265             JSString* string = asString(asCell());
266             out.print(&quot;String&quot;);
267             if (string-&gt;isRope())
268                 out.print(&quot; (rope)&quot;);
269             const StringImpl* impl = string-&gt;tryGetValueImpl();
270             if (impl) {
271                 if (impl-&gt;isAtom())
272                     out.print(&quot; (atomic)&quot;);
<span class="line-removed">273                 if (impl-&gt;isAtom())</span>
<span class="line-removed">274                     out.print(&quot; (identifier)&quot;);</span>
275                 if (impl-&gt;isSymbol())
276                     out.print(&quot; (symbol)&quot;);
277             } else
278                 out.print(&quot; (unresolved)&quot;);





279             out.print(&quot;: &quot;, impl);
280         } else if (structure-&gt;classInfo()-&gt;isSubClassOf(RegExp::info()))
281             out.print(&quot;RegExp: &quot;, *jsCast&lt;RegExp*&gt;(asCell()));
282         else if (structure-&gt;classInfo()-&gt;isSubClassOf(Symbol::info()))
283             out.print(&quot;Symbol: &quot;, RawPointer(asCell()));
284         else if (structure-&gt;classInfo()-&gt;isSubClassOf(Structure::info()))
285             out.print(&quot;Structure: &quot;, inContext(*jsCast&lt;Structure*&gt;(asCell()), context));
286         else if (structure-&gt;classInfo()-&gt;isSubClassOf(JSObject::info())) {
287             out.print(&quot;Object: &quot;, RawPointer(asCell()));
288             out.print(&quot; with butterfly &quot;, RawPointer(asObject(asCell())-&gt;butterfly()));
289             out.print(&quot; (Structure &quot;, inContext(*structure, context), &quot;)&quot;);
290         } else {
291             out.print(&quot;Cell: &quot;, RawPointer(asCell()));
292             out.print(&quot; (&quot;, inContext(*structure, context), &quot;)&quot;);
293         }
294 #if USE(JSVALUE64)
295         out.print(&quot;, StructureID: &quot;, asCell()-&gt;structureID());
296 #endif
297     } else if (isTrue())
298         out.print(&quot;True&quot;);
</pre>
<hr />
<pre>
336 #endif
337             out.print(&quot;]: &quot;, RawPointer(asCell()));
338         }
339     } else if (isTrue())
340         out.print(&quot;True&quot;);
341     else if (isFalse())
342         out.print(&quot;False&quot;);
343     else if (isNull())
344         out.print(&quot;Null&quot;);
345     else if (isUndefined())
346         out.print(&quot;Undefined&quot;);
347     else
348         out.print(&quot;INVALID&quot;);
349 }
350 
351 bool JSValue::isValidCallee()
352 {
353     return asObject(asCell())-&gt;globalObject();
354 }
355 
<span class="line-modified">356 JSString* JSValue::toStringSlowCase(ExecState* exec, bool returnEmptyStringOnError) const</span>
357 {
<span class="line-modified">358     VM&amp; vm = exec-&gt;vm();</span>
359     auto scope = DECLARE_THROW_SCOPE(vm);
360 
361     auto errorValue = [&amp;] () -&gt; JSString* {
362         if (returnEmptyStringOnError)
363             return jsEmptyString(vm);
364         return nullptr;
365     };
366 
367     ASSERT(!isString());
368     if (isInt32()) {
369         auto integer = asInt32();
370         if (static_cast&lt;unsigned&gt;(integer) &lt;= 9)
371             return vm.smallStrings.singleCharacterString(integer + &#39;0&#39;);
372         return jsNontrivialString(vm, vm.numericStrings.add(integer));
373     }
374     if (isDouble())
375         return jsString(vm, vm.numericStrings.add(asDouble()));
376     if (isTrue())
377         return vm.smallStrings.trueString();
378     if (isFalse())
379         return vm.smallStrings.falseString();
380     if (isNull())
381         return vm.smallStrings.nullString();
382     if (isUndefined())
383         return vm.smallStrings.undefinedString();
384     if (isSymbol()) {
<span class="line-modified">385         throwTypeError(exec, scope, &quot;Cannot convert a symbol to a string&quot;_s);</span>
386         return errorValue();
387     }
388     if (isBigInt()) {
389         JSBigInt* bigInt = asBigInt(*this);
390         if (auto digit = bigInt-&gt;singleDigitValueForString())
391             return vm.smallStrings.singleCharacterString(*digit + &#39;0&#39;);
<span class="line-modified">392         JSString* returnString = jsNontrivialString(vm, bigInt-&gt;toString(exec, 10));</span>
393         RETURN_IF_EXCEPTION(scope, errorValue());
394         return returnString;
395     }
396 
397     ASSERT(isCell());
<span class="line-modified">398     JSValue value = asCell()-&gt;toPrimitive(exec, PreferString);</span>
399     RETURN_IF_EXCEPTION(scope, errorValue());
400     ASSERT(!value.isObject());
<span class="line-modified">401     JSString* result = value.toString(exec);</span>
402     RETURN_IF_EXCEPTION(scope, errorValue());
403     return result;
404 }
405 
<span class="line-modified">406 String JSValue::toWTFStringSlowCase(ExecState* exec) const</span>
407 {
<span class="line-modified">408     VM&amp; vm = exec-&gt;vm();</span>

409     if (isInt32())
410         return vm.numericStrings.add(asInt32());
411     if (isDouble())
412         return vm.numericStrings.add(asDouble());
413     if (isTrue())
414         return vm.propertyNames-&gt;trueKeyword.string();
415     if (isFalse())
416         return vm.propertyNames-&gt;falseKeyword.string();
417     if (isNull())
418         return vm.propertyNames-&gt;nullKeyword.string();
419     if (isUndefined())
420         return vm.propertyNames-&gt;undefinedKeyword.string();
<span class="line-modified">421     return toString(exec)-&gt;value(exec);</span>


422 }
423 
424 } // namespace JSC
</pre>
</td>
<td>
<hr />
<pre>
 22 
 23 #include &quot;config.h&quot;
 24 #include &quot;JSCJSValue.h&quot;
 25 
 26 #include &quot;BooleanConstructor.h&quot;
 27 #include &quot;BooleanPrototype.h&quot;
 28 #include &quot;CustomGetterSetter.h&quot;
 29 #include &quot;Error.h&quot;
 30 #include &quot;ExceptionHelpers.h&quot;
 31 #include &quot;GetterSetter.h&quot;
 32 #include &quot;JSBigInt.h&quot;
 33 #include &quot;JSCInlines.h&quot;
 34 #include &quot;JSFunction.h&quot;
 35 #include &quot;JSGlobalObject.h&quot;
 36 #include &quot;NumberObject.h&quot;
 37 #include &lt;wtf/MathExtras.h&gt;
 38 
 39 namespace JSC {
 40 
 41 // ECMA 9.4
<span class="line-modified"> 42 double JSValue::toInteger(JSGlobalObject* globalObject) const</span>
 43 {
 44     if (isInt32())
 45         return asInt32();
<span class="line-modified"> 46     double d = toNumber(globalObject);</span>
 47     return std::isnan(d) ? 0.0 : trunc(d);
 48 }
 49 
<span class="line-modified"> 50 double JSValue::toIntegerPreserveNaN(JSGlobalObject* globalObject) const</span>
 51 {
 52     if (isInt32())
 53         return asInt32();
<span class="line-modified"> 54     return trunc(toNumber(globalObject));</span>
 55 }
 56 
<span class="line-modified"> 57 double JSValue::toLength(JSGlobalObject* globalObject) const</span>
 58 {
 59     // ECMA 7.1.15
 60     // http://www.ecma-international.org/ecma-262/6.0/#sec-tolength
<span class="line-modified"> 61     double d = toInteger(globalObject);</span>
 62     if (d &lt;= 0)
 63         return 0.0;
 64     if (std::isinf(d))
 65         return maxSafeInteger();
 66     return std::min(d, maxSafeInteger());
 67 }
 68 
<span class="line-modified"> 69 double JSValue::toNumberSlowCase(JSGlobalObject* globalObject) const</span>
 70 {
 71     ASSERT(!isInt32() &amp;&amp; !isDouble());
 72     if (isCell())
<span class="line-modified"> 73         return asCell()-&gt;toNumber(globalObject);</span>
 74     if (isTrue())
 75         return 1.0;
 76     return isUndefined() ? PNaN : 0; // null and false both convert to 0.
 77 }
 78 
 79 Optional&lt;double&gt; JSValue::toNumberFromPrimitive() const
 80 {
 81     if (isEmpty())
 82         return WTF::nullopt;
 83     if (isNumber())
 84         return asNumber();
 85     if (isBoolean())
 86         return asBoolean();
 87     if (isUndefined())
 88         return PNaN;
 89     if (isNull())
 90         return 0;
 91     return WTF::nullopt;
 92 }
 93 
<span class="line-modified"> 94 JSObject* JSValue::toObjectSlowCase(JSGlobalObject* globalObject) const</span>
 95 {
<span class="line-modified"> 96     VM&amp; vm = globalObject-&gt;vm();</span>
 97     auto scope = DECLARE_THROW_SCOPE(vm);
 98     ASSERT(!isCell());
 99 
100     if (isInt32() || isDouble())
<span class="line-modified">101         return constructNumber(globalObject, asValue());</span>
102     if (isTrue() || isFalse())
<span class="line-modified">103         return constructBooleanFromImmediateBoolean(globalObject, asValue());</span>
104 
105     ASSERT(isUndefinedOrNull());
<span class="line-modified">106     throwException(globalObject, scope, createNotAnObjectError(globalObject, *this));</span>
107     return nullptr;
108 }
109 
<span class="line-modified">110 JSValue JSValue::toThisSlowCase(JSGlobalObject* globalObject, ECMAMode ecmaMode) const</span>
111 {
112     ASSERT(!isCell());
113 
114     if (ecmaMode == StrictMode)
115         return *this;
116 
117     if (isInt32() || isDouble())
<span class="line-modified">118         return constructNumber(globalObject, asValue());</span>
119     if (isTrue() || isFalse())
<span class="line-modified">120         return constructBooleanFromImmediateBoolean(globalObject, asValue());</span>
121     ASSERT(isUndefinedOrNull());
<span class="line-modified">122     return globalObject-&gt;globalThis();</span>
123 }
124 
<span class="line-modified">125 JSObject* JSValue::synthesizePrototype(JSGlobalObject* globalObject) const</span>
126 {
<span class="line-modified">127     VM&amp; vm = globalObject-&gt;vm();</span>
128     auto scope = DECLARE_THROW_SCOPE(vm);
129 
130     if (isCell()) {
131         if (isString())
<span class="line-modified">132             return globalObject-&gt;stringPrototype();</span>
133         if (isBigInt())
<span class="line-modified">134             return globalObject-&gt;bigIntPrototype();</span>
135         ASSERT(isSymbol());
<span class="line-modified">136         return globalObject-&gt;symbolPrototype();</span>
137     }
138 
139     if (isNumber())
<span class="line-modified">140         return globalObject-&gt;numberPrototype();</span>
141     if (isBoolean())
<span class="line-modified">142         return globalObject-&gt;booleanPrototype();</span>
143 
144     ASSERT(isUndefinedOrNull());
<span class="line-modified">145     throwException(globalObject, scope, createNotAnObjectError(globalObject, *this));</span>
146     return nullptr;
147 }
148 
149 // ECMA 8.7.2
<span class="line-modified">150 bool JSValue::putToPrimitive(JSGlobalObject* globalObject, PropertyName propertyName, JSValue value, PutPropertySlot&amp; slot)</span>
151 {
<span class="line-modified">152     VM&amp; vm = globalObject-&gt;vm();</span>
153     auto scope = DECLARE_THROW_SCOPE(vm);
154 
155     if (Optional&lt;uint32_t&gt; index = parseIndex(propertyName))
<span class="line-modified">156         RELEASE_AND_RETURN(scope, putToPrimitiveByIndex(globalObject, index.value(), value, slot.isStrictMode()));</span>
157 
158     // Check if there are any setters or getters in the prototype chain
<span class="line-modified">159     JSObject* obj = synthesizePrototype(globalObject);</span>
160     EXCEPTION_ASSERT(!!scope.exception() == !obj);
161     if (UNLIKELY(!obj))
162         return false;
163     JSValue prototype;
164     if (propertyName != vm.propertyNames-&gt;underscoreProto) {
165         while (true) {
166             Structure* structure = obj-&gt;structure(vm);
167             if (structure-&gt;hasReadOnlyOrGetterSetterPropertiesExcludingProto() || structure-&gt;typeInfo().hasPutPropertySecurityCheck())
168                 break;
<span class="line-modified">169             prototype = obj-&gt;getPrototype(vm, globalObject);</span>
170             RETURN_IF_EXCEPTION(scope, false);
171 
172             if (prototype.isNull())
<span class="line-modified">173                 return typeError(globalObject, scope, slot.isStrictMode(), ReadonlyPropertyWriteError);</span>
174             obj = asObject(prototype);
175         }
176     }
177 
178     for (; ; obj = asObject(prototype)) {
179         Structure* structure = obj-&gt;structure(vm);
180         if (UNLIKELY(structure-&gt;typeInfo().hasPutPropertySecurityCheck())) {
<span class="line-modified">181             obj-&gt;methodTable(vm)-&gt;doPutPropertySecurityCheck(obj, globalObject, propertyName, slot);</span>
182             RETURN_IF_EXCEPTION(scope, false);
183         }
184         unsigned attributes;
185         PropertyOffset offset = structure-&gt;get(vm, propertyName, attributes);
186         if (offset != invalidOffset) {
187             if (attributes &amp; PropertyAttribute::ReadOnly)
<span class="line-modified">188                 return typeError(globalObject, scope, slot.isStrictMode(), ReadonlyPropertyWriteError);</span>
189 
190             JSValue gs = obj-&gt;getDirect(offset);
191             if (gs.isGetterSetter())
<span class="line-modified">192                 RELEASE_AND_RETURN(scope, callSetter(globalObject, *this, gs, value, slot.isStrictMode() ? StrictMode : NotStrictMode));</span>
193 
194             if (gs.isCustomGetterSetter())
<span class="line-modified">195                 return callCustomSetter(globalObject, gs, attributes &amp; PropertyAttribute::CustomAccessor, obj, slot.thisValue(), value);</span>
196 
197             // If there&#39;s an existing property on the object or one of its
198             // prototypes it should be replaced, so break here.
199             break;
200         }
201 
<span class="line-modified">202         prototype = obj-&gt;getPrototype(vm, globalObject);</span>
203         RETURN_IF_EXCEPTION(scope, false);
204         if (prototype.isNull())
205             break;
206     }
207 
<span class="line-modified">208     return typeError(globalObject, scope, slot.isStrictMode(), ReadonlyPropertyWriteError);</span>
209 }
210 
<span class="line-modified">211 bool JSValue::putToPrimitiveByIndex(JSGlobalObject* globalObject, unsigned propertyName, JSValue value, bool shouldThrow)</span>
212 {
<span class="line-modified">213     VM&amp; vm = globalObject-&gt;vm();</span>
214     auto scope = DECLARE_THROW_SCOPE(vm);
215 
216     if (propertyName &gt; MAX_ARRAY_INDEX) {
217         PutPropertySlot slot(*this, shouldThrow);
<span class="line-modified">218         return putToPrimitive(globalObject, Identifier::from(vm, propertyName), value, slot);</span>
219     }
220 
<span class="line-modified">221     JSObject* prototype = synthesizePrototype(globalObject);</span>
222     EXCEPTION_ASSERT(!!scope.exception() == !prototype);
223     if (UNLIKELY(!prototype))
224         return false;
225     bool putResult = false;
<span class="line-modified">226     bool success = prototype-&gt;attemptToInterceptPutByIndexOnHoleForPrototype(globalObject, *this, propertyName, value, shouldThrow, putResult);</span>
227     RETURN_IF_EXCEPTION(scope, false);
228     if (success)
229         return putResult;
230 
<span class="line-modified">231     return typeError(globalObject, scope, shouldThrow, ReadonlyPropertyWriteError);</span>
232 }
233 
234 void JSValue::dump(PrintStream&amp; out) const
235 {
236     dumpInContext(out, 0);
237 }
238 
239 void JSValue::dumpInContext(PrintStream&amp; out, DumpContext* context) const
240 {
241     dumpInContextAssumingStructure(
242         out, context, (!!*this &amp;&amp; isCell()) ? asCell()-&gt;structure() : nullptr);
243 }
244 
245 void JSValue::dumpInContextAssumingStructure(
246     PrintStream&amp; out, DumpContext* context, Structure* structure) const
247 {
248     if (!*this)
249         out.print(&quot;&lt;JSValue()&gt;&quot;);
250     else if (isInt32())
251         out.printf(&quot;Int32: %d&quot;, asInt32());
</pre>
<hr />
<pre>
253 #if USE(JSVALUE64)
254         out.printf(&quot;Double: %lld, %lf&quot;, (long long)reinterpretDoubleToInt64(asDouble()), asDouble());
255 #else
256         union {
257             double asDouble;
258             uint32_t asTwoInt32s[2];
259         } u;
260         u.asDouble = asDouble();
261         out.printf(&quot;Double: %08x:%08x, %lf&quot;, u.asTwoInt32s[1], u.asTwoInt32s[0], asDouble());
262 #endif
263     } else if (isCell()) {
264         if (structure-&gt;classInfo()-&gt;isSubClassOf(JSString::info())) {
265             JSString* string = asString(asCell());
266             out.print(&quot;String&quot;);
267             if (string-&gt;isRope())
268                 out.print(&quot; (rope)&quot;);
269             const StringImpl* impl = string-&gt;tryGetValueImpl();
270             if (impl) {
271                 if (impl-&gt;isAtom())
272                     out.print(&quot; (atomic)&quot;);


273                 if (impl-&gt;isSymbol())
274                     out.print(&quot; (symbol)&quot;);
275             } else
276                 out.print(&quot; (unresolved)&quot;);
<span class="line-added">277             if (string-&gt;is8Bit())</span>
<span class="line-added">278                 out.print(&quot;,8Bit:(1)&quot;);</span>
<span class="line-added">279             else</span>
<span class="line-added">280                 out.print(&quot;,8Bit:(0)&quot;);</span>
<span class="line-added">281             out.print(&quot;,length:(&quot;, string-&gt;length(), &quot;)&quot;);</span>
282             out.print(&quot;: &quot;, impl);
283         } else if (structure-&gt;classInfo()-&gt;isSubClassOf(RegExp::info()))
284             out.print(&quot;RegExp: &quot;, *jsCast&lt;RegExp*&gt;(asCell()));
285         else if (structure-&gt;classInfo()-&gt;isSubClassOf(Symbol::info()))
286             out.print(&quot;Symbol: &quot;, RawPointer(asCell()));
287         else if (structure-&gt;classInfo()-&gt;isSubClassOf(Structure::info()))
288             out.print(&quot;Structure: &quot;, inContext(*jsCast&lt;Structure*&gt;(asCell()), context));
289         else if (structure-&gt;classInfo()-&gt;isSubClassOf(JSObject::info())) {
290             out.print(&quot;Object: &quot;, RawPointer(asCell()));
291             out.print(&quot; with butterfly &quot;, RawPointer(asObject(asCell())-&gt;butterfly()));
292             out.print(&quot; (Structure &quot;, inContext(*structure, context), &quot;)&quot;);
293         } else {
294             out.print(&quot;Cell: &quot;, RawPointer(asCell()));
295             out.print(&quot; (&quot;, inContext(*structure, context), &quot;)&quot;);
296         }
297 #if USE(JSVALUE64)
298         out.print(&quot;, StructureID: &quot;, asCell()-&gt;structureID());
299 #endif
300     } else if (isTrue())
301         out.print(&quot;True&quot;);
</pre>
<hr />
<pre>
339 #endif
340             out.print(&quot;]: &quot;, RawPointer(asCell()));
341         }
342     } else if (isTrue())
343         out.print(&quot;True&quot;);
344     else if (isFalse())
345         out.print(&quot;False&quot;);
346     else if (isNull())
347         out.print(&quot;Null&quot;);
348     else if (isUndefined())
349         out.print(&quot;Undefined&quot;);
350     else
351         out.print(&quot;INVALID&quot;);
352 }
353 
354 bool JSValue::isValidCallee()
355 {
356     return asObject(asCell())-&gt;globalObject();
357 }
358 
<span class="line-modified">359 JSString* JSValue::toStringSlowCase(JSGlobalObject* globalObject, bool returnEmptyStringOnError) const</span>
360 {
<span class="line-modified">361     VM&amp; vm = globalObject-&gt;vm();</span>
362     auto scope = DECLARE_THROW_SCOPE(vm);
363 
364     auto errorValue = [&amp;] () -&gt; JSString* {
365         if (returnEmptyStringOnError)
366             return jsEmptyString(vm);
367         return nullptr;
368     };
369 
370     ASSERT(!isString());
371     if (isInt32()) {
372         auto integer = asInt32();
373         if (static_cast&lt;unsigned&gt;(integer) &lt;= 9)
374             return vm.smallStrings.singleCharacterString(integer + &#39;0&#39;);
375         return jsNontrivialString(vm, vm.numericStrings.add(integer));
376     }
377     if (isDouble())
378         return jsString(vm, vm.numericStrings.add(asDouble()));
379     if (isTrue())
380         return vm.smallStrings.trueString();
381     if (isFalse())
382         return vm.smallStrings.falseString();
383     if (isNull())
384         return vm.smallStrings.nullString();
385     if (isUndefined())
386         return vm.smallStrings.undefinedString();
387     if (isSymbol()) {
<span class="line-modified">388         throwTypeError(globalObject, scope, &quot;Cannot convert a symbol to a string&quot;_s);</span>
389         return errorValue();
390     }
391     if (isBigInt()) {
392         JSBigInt* bigInt = asBigInt(*this);
393         if (auto digit = bigInt-&gt;singleDigitValueForString())
394             return vm.smallStrings.singleCharacterString(*digit + &#39;0&#39;);
<span class="line-modified">395         JSString* returnString = jsNontrivialString(vm, bigInt-&gt;toString(globalObject, 10));</span>
396         RETURN_IF_EXCEPTION(scope, errorValue());
397         return returnString;
398     }
399 
400     ASSERT(isCell());
<span class="line-modified">401     JSValue value = asCell()-&gt;toPrimitive(globalObject, PreferString);</span>
402     RETURN_IF_EXCEPTION(scope, errorValue());
403     ASSERT(!value.isObject());
<span class="line-modified">404     JSString* result = value.toString(globalObject);</span>
405     RETURN_IF_EXCEPTION(scope, errorValue());
406     return result;
407 }
408 
<span class="line-modified">409 String JSValue::toWTFStringSlowCase(JSGlobalObject* globalObject) const</span>
410 {
<span class="line-modified">411     VM&amp; vm = globalObject-&gt;vm();</span>
<span class="line-added">412     auto scope = DECLARE_THROW_SCOPE(vm);</span>
413     if (isInt32())
414         return vm.numericStrings.add(asInt32());
415     if (isDouble())
416         return vm.numericStrings.add(asDouble());
417     if (isTrue())
418         return vm.propertyNames-&gt;trueKeyword.string();
419     if (isFalse())
420         return vm.propertyNames-&gt;falseKeyword.string();
421     if (isNull())
422         return vm.propertyNames-&gt;nullKeyword.string();
423     if (isUndefined())
424         return vm.propertyNames-&gt;undefinedKeyword.string();
<span class="line-modified">425     JSString* string = toString(globalObject);</span>
<span class="line-added">426     RETURN_IF_EXCEPTION(scope, { });</span>
<span class="line-added">427     RELEASE_AND_RETURN(scope, string-&gt;value(globalObject));</span>
428 }
429 
430 } // namespace JSC
</pre>
</td>
</tr>
</table>
<center><a href="JSCInlines.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="JSCJSValue.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>