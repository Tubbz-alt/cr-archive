<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.web/src/main/native/Source/JavaScriptCore/bytecode/ObjectPropertyConditionSet.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="ObjectPropertyCondition.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="ObjectPropertyConditionSet.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/JavaScriptCore/bytecode/ObjectPropertyConditionSet.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (C) 2015-2018 Apple Inc. All rights reserved.</span>
   *
   * Redistribution and use in source and binary forms, with or without
   * modification, are permitted provided that the following conditions
   * are met:
   * 1. Redistributions of source code must retain the above copyright
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (C) 2015-2019 Apple Inc. All rights reserved.</span>
   *
   * Redistribution and use in source and binary forms, with or without
   * modification, are permitted provided that the following conditions
   * are met:
   * 1. Redistributions of source code must retain the above copyright
</pre>
<hr />
<pre>
<span class="line-old-header">*** 60,20 ***</span>
      return result;
  }
  
  bool ObjectPropertyConditionSet::hasOneSlotBaseCondition() const
  {
<span class="line-modified">!     return (numberOfConditionsWithKind(PropertyCondition::Presence) == 1) != (numberOfConditionsWithKind(PropertyCondition::Equivalence) == 1);</span>
  }
  
  ObjectPropertyCondition ObjectPropertyConditionSet::slotBaseCondition() const
  {
      ObjectPropertyCondition result;
      unsigned numFound = 0;
      for (const ObjectPropertyCondition&amp; condition : *this) {
          if (condition.kind() == PropertyCondition::Presence
<span class="line-modified">!             || condition.kind() == PropertyCondition::Equivalence) {</span>
              result = condition;
              numFound++;
          }
      }
      RELEASE_ASSERT(numFound == 1);
<span class="line-new-header">--- 60,36 ---</span>
      return result;
  }
  
  bool ObjectPropertyConditionSet::hasOneSlotBaseCondition() const
  {
<span class="line-modified">!     bool sawBase = false;</span>
<span class="line-added">+     for (const ObjectPropertyCondition&amp; condition : *this) {</span>
<span class="line-added">+         switch (condition.kind()) {</span>
<span class="line-added">+         case PropertyCondition::Presence:</span>
<span class="line-added">+         case PropertyCondition::Equivalence:</span>
<span class="line-added">+         case PropertyCondition::CustomFunctionEquivalence:</span>
<span class="line-added">+             if (sawBase)</span>
<span class="line-added">+                 return false;</span>
<span class="line-added">+             sawBase = true;</span>
<span class="line-added">+             break;</span>
<span class="line-added">+         default:</span>
<span class="line-added">+             break;</span>
<span class="line-added">+         }</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     return sawBase;</span>
  }
  
  ObjectPropertyCondition ObjectPropertyConditionSet::slotBaseCondition() const
  {
      ObjectPropertyCondition result;
      unsigned numFound = 0;
      for (const ObjectPropertyCondition&amp; condition : *this) {
          if (condition.kind() == PropertyCondition::Presence
<span class="line-modified">!             || condition.kind() == PropertyCondition::Equivalence</span>
<span class="line-added">+             || condition.kind() == PropertyCondition::CustomFunctionEquivalence) {</span>
              result = condition;
              numFound++;
          }
      }
      RELEASE_ASSERT(numFound == 1);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 141,15 ***</span>
      return false;
  }
  
  bool ObjectPropertyConditionSet::areStillLive(VM&amp; vm) const
  {
<span class="line-modified">!     for (const ObjectPropertyCondition&amp; condition : *this) {</span>
<span class="line-modified">!         if (!condition.isStillLive(vm))</span>
<span class="line-modified">!             return false;</span>
<span class="line-modified">!     }</span>
<span class="line-modified">!     return true;</span>
  }
  
  void ObjectPropertyConditionSet::dumpInContext(PrintStream&amp; out, DumpContext* context) const
  {
      if (!isValid()) {
<span class="line-new-header">--- 157,15 ---</span>
      return false;
  }
  
  bool ObjectPropertyConditionSet::areStillLive(VM&amp; vm) const
  {
<span class="line-modified">!     bool stillLive = true;</span>
<span class="line-modified">!     forEachDependentCell([&amp;](JSCell* cell) {</span>
<span class="line-modified">!         stillLive &amp;= vm.heap.isMarked(cell);</span>
<span class="line-modified">!     });</span>
<span class="line-modified">!     return stillLive;</span>
  }
  
  void ObjectPropertyConditionSet::dumpInContext(PrintStream&amp; out, DumpContext* context) const
  {
      if (!isValid()) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 181,11 ***</span>
  }
  
  namespace {
  
  namespace ObjectPropertyConditionSetInternal {
<span class="line-modified">! static const bool verbose = false;</span>
  }
  
  ObjectPropertyCondition generateCondition(
      VM&amp; vm, JSCell* owner, JSObject* object, UniquedStringImpl* uid, PropertyCondition::Kind conditionKind)
  {
<span class="line-new-header">--- 197,11 ---</span>
  }
  
  namespace {
  
  namespace ObjectPropertyConditionSetInternal {
<span class="line-modified">! static constexpr bool verbose = false;</span>
  }
  
  ObjectPropertyCondition generateCondition(
      VM&amp; vm, JSCell* owner, JSObject* object, UniquedStringImpl* uid, PropertyCondition::Kind conditionKind)
  {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 226,10 ***</span>
<span class="line-new-header">--- 242,17 ---</span>
          if (!value)
              return ObjectPropertyCondition();
          result = ObjectPropertyCondition::equivalence(vm, owner, object, uid, value);
          break;
      }
<span class="line-added">+     case PropertyCondition::CustomFunctionEquivalence: {</span>
<span class="line-added">+         auto entry = object-&gt;findPropertyHashEntry(vm, uid);</span>
<span class="line-added">+         if (!entry)</span>
<span class="line-added">+             return ObjectPropertyCondition();</span>
<span class="line-added">+         result = ObjectPropertyCondition::customFunctionEquivalence(vm, owner, object, uid);</span>
<span class="line-added">+         break;</span>
<span class="line-added">+     }</span>
      default:
          RELEASE_ASSERT_NOT_REACHED();
          return ObjectPropertyCondition();
      }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 242,18 ***</span>
      if (ObjectPropertyConditionSetInternal::verbose)
          dataLog(&quot;New condition: &quot;, result, &quot;\n&quot;);
      return result;
  }
  
<span class="line-removed">- enum Concurrency {</span>
<span class="line-removed">-     MainThread,</span>
<span class="line-removed">-     Concurrent</span>
<span class="line-removed">- };</span>
  template&lt;typename Functor&gt;
  ObjectPropertyConditionSet generateConditions(
<span class="line-modified">!     VM&amp; vm, JSGlobalObject* globalObject, Structure* structure, JSObject* prototype, const Functor&amp; functor,</span>
<span class="line-removed">-     Concurrency concurrency = MainThread)</span>
  {
      Vector&lt;ObjectPropertyCondition&gt; conditions;
  
      for (;;) {
          if (ObjectPropertyConditionSetInternal::verbose)
<span class="line-new-header">--- 265,13 ---</span>
      if (ObjectPropertyConditionSetInternal::verbose)
          dataLog(&quot;New condition: &quot;, result, &quot;\n&quot;);
      return result;
  }
  
  template&lt;typename Functor&gt;
  ObjectPropertyConditionSet generateConditions(
<span class="line-modified">!     VM&amp; vm, JSGlobalObject* globalObject, Structure* structure, JSObject* prototype, const Functor&amp; functor)</span>
  {
      Vector&lt;ObjectPropertyCondition&gt; conditions;
  
      for (;;) {
          if (ObjectPropertyConditionSetInternal::verbose)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 289,25 ***</span>
  
          JSObject* object = jsCast&lt;JSObject*&gt;(value);
          structure = object-&gt;structure(vm);
  
          if (structure-&gt;isDictionary()) {
<span class="line-modified">!             if (concurrency == MainThread) {</span>
<span class="line-modified">!                 if (structure-&gt;hasBeenFlattenedBefore()) {</span>
<span class="line-modified">!                     if (ObjectPropertyConditionSetInternal::verbose)</span>
<span class="line-removed">-                         dataLog(&quot;Dictionary has been flattened before, so invalid.\n&quot;);</span>
<span class="line-removed">-                     return ObjectPropertyConditionSet::invalid();</span>
<span class="line-removed">-                 }</span>
<span class="line-removed">- </span>
<span class="line-removed">-                 if (ObjectPropertyConditionSetInternal::verbose)</span>
<span class="line-removed">-                     dataLog(&quot;Flattening &quot;, pointerDump(structure));</span>
<span class="line-removed">-                 structure-&gt;flattenDictionaryStructure(vm, object);</span>
<span class="line-removed">-             } else {</span>
<span class="line-removed">-                 if (ObjectPropertyConditionSetInternal::verbose)</span>
<span class="line-removed">-                     dataLog(&quot;Cannot flatten dictionary when not on main thread, so invalid.\n&quot;);</span>
<span class="line-removed">-                 return ObjectPropertyConditionSet::invalid();</span>
<span class="line-removed">-             }</span>
          }
  
          if (!functor(conditions, object)) {
              if (ObjectPropertyConditionSetInternal::verbose)
                  dataLog(&quot;Functor failed, invalid.\n&quot;);
<span class="line-new-header">--- 307,13 ---</span>
  
          JSObject* object = jsCast&lt;JSObject*&gt;(value);
          structure = object-&gt;structure(vm);
  
          if (structure-&gt;isDictionary()) {
<span class="line-modified">!             if (ObjectPropertyConditionSetInternal::verbose)</span>
<span class="line-modified">!                 dataLog(&quot;Cannot cache dictionary.\n&quot;);</span>
<span class="line-modified">!             return ObjectPropertyConditionSet::invalid();</span>
          }
  
          if (!functor(conditions, object)) {
              if (ObjectPropertyConditionSetInternal::verbose)
                  dataLog(&quot;Functor failed, invalid.\n&quot;);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 327,14 ***</span>
  }
  
  } // anonymous namespace
  
  ObjectPropertyConditionSet generateConditionsForPropertyMiss(
<span class="line-modified">!     VM&amp; vm, JSCell* owner, ExecState* exec, Structure* headStructure, UniquedStringImpl* uid)</span>
  {
      return generateConditions(
<span class="line-modified">!         vm, exec-&gt;lexicalGlobalObject(), headStructure, nullptr,</span>
          [&amp;] (Vector&lt;ObjectPropertyCondition&gt;&amp; conditions, JSObject* object) -&gt; bool {
              ObjectPropertyCondition result =
                  generateCondition(vm, owner, object, uid, PropertyCondition::Absence);
              if (!result)
                  return false;
<span class="line-new-header">--- 333,14 ---</span>
  }
  
  } // anonymous namespace
  
  ObjectPropertyConditionSet generateConditionsForPropertyMiss(
<span class="line-modified">!     VM&amp; vm, JSCell* owner, JSGlobalObject* globalObject, Structure* headStructure, UniquedStringImpl* uid)</span>
  {
      return generateConditions(
<span class="line-modified">!         vm, globalObject, headStructure, nullptr,</span>
          [&amp;] (Vector&lt;ObjectPropertyCondition&gt;&amp; conditions, JSObject* object) -&gt; bool {
              ObjectPropertyCondition result =
                  generateCondition(vm, owner, object, uid, PropertyCondition::Absence);
              if (!result)
                  return false;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 342,14 ***</span>
              return true;
          });
  }
  
  ObjectPropertyConditionSet generateConditionsForPropertySetterMiss(
<span class="line-modified">!     VM&amp; vm, JSCell* owner, ExecState* exec, Structure* headStructure, UniquedStringImpl* uid)</span>
  {
      return generateConditions(
<span class="line-modified">!         vm, exec-&gt;lexicalGlobalObject(), headStructure, nullptr,</span>
          [&amp;] (Vector&lt;ObjectPropertyCondition&gt;&amp; conditions, JSObject* object) -&gt; bool {
              ObjectPropertyCondition result =
                  generateCondition(vm, owner, object, uid, PropertyCondition::AbsenceOfSetEffect);
              if (!result)
                  return false;
<span class="line-new-header">--- 348,14 ---</span>
              return true;
          });
  }
  
  ObjectPropertyConditionSet generateConditionsForPropertySetterMiss(
<span class="line-modified">!     VM&amp; vm, JSCell* owner, JSGlobalObject* globalObject, Structure* headStructure, UniquedStringImpl* uid)</span>
  {
      return generateConditions(
<span class="line-modified">!         vm, globalObject, headStructure, nullptr,</span>
          [&amp;] (Vector&lt;ObjectPropertyCondition&gt;&amp; conditions, JSObject* object) -&gt; bool {
              ObjectPropertyCondition result =
                  generateCondition(vm, owner, object, uid, PropertyCondition::AbsenceOfSetEffect);
              if (!result)
                  return false;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 357,15 ***</span>
              return true;
          });
  }
  
  ObjectPropertyConditionSet generateConditionsForPrototypePropertyHit(
<span class="line-modified">!     VM&amp; vm, JSCell* owner, ExecState* exec, Structure* headStructure, JSObject* prototype,</span>
      UniquedStringImpl* uid)
  {
      return generateConditions(
<span class="line-modified">!         vm, exec-&gt;lexicalGlobalObject(), headStructure, prototype,</span>
          [&amp;] (Vector&lt;ObjectPropertyCondition&gt;&amp; conditions, JSObject* object) -&gt; bool {
              PropertyCondition::Kind kind =
                  object == prototype ? PropertyCondition::Presence : PropertyCondition::Absence;
              ObjectPropertyCondition result =
                  generateCondition(vm, owner, object, uid, kind);
<span class="line-new-header">--- 363,15 ---</span>
              return true;
          });
  }
  
  ObjectPropertyConditionSet generateConditionsForPrototypePropertyHit(
<span class="line-modified">!     VM&amp; vm, JSCell* owner, JSGlobalObject* globalObject, Structure* headStructure, JSObject* prototype,</span>
      UniquedStringImpl* uid)
  {
      return generateConditions(
<span class="line-modified">!         vm, globalObject, headStructure, prototype,</span>
          [&amp;] (Vector&lt;ObjectPropertyCondition&gt;&amp; conditions, JSObject* object) -&gt; bool {
              PropertyCondition::Kind kind =
                  object == prototype ? PropertyCondition::Presence : PropertyCondition::Absence;
              ObjectPropertyCondition result =
                  generateCondition(vm, owner, object, uid, kind);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 375,36 ***</span>
              return true;
          });
  }
  
  ObjectPropertyConditionSet generateConditionsForPrototypePropertyHitCustom(
<span class="line-modified">!     VM&amp; vm, JSCell* owner, ExecState* exec, Structure* headStructure, JSObject* prototype,</span>
<span class="line-modified">!     UniquedStringImpl* uid)</span>
  {
      return generateConditions(
<span class="line-modified">!         vm, exec-&gt;lexicalGlobalObject(), headStructure, prototype,</span>
          [&amp;] (Vector&lt;ObjectPropertyCondition&gt;&amp; conditions, JSObject* object) -&gt; bool {
<span class="line-modified">!             if (object == prototype)</span>
<span class="line-modified">!                 return true;</span>
<span class="line-modified">!             ObjectPropertyCondition result =</span>
<span class="line-modified">!                 generateCondition(vm, owner, object, uid, PropertyCondition::Absence);</span>
              if (!result)
                  return false;
              conditions.append(result);
              return true;
          });
  }
  
  ObjectPropertyConditionSet generateConditionsForInstanceOf(
<span class="line-modified">!     VM&amp; vm, JSCell* owner, ExecState* exec, Structure* headStructure, JSObject* prototype,</span>
      bool shouldHit)
  {
      bool didHit = false;
      if (ObjectPropertyConditionSetInternal::verbose)
          dataLog(&quot;Searching for prototype &quot;, JSValue(prototype), &quot; starting with structure &quot;, RawPointer(headStructure), &quot; with shouldHit = &quot;, shouldHit, &quot;\n&quot;);
      ObjectPropertyConditionSet result = generateConditions(
<span class="line-modified">!         vm, exec-&gt;lexicalGlobalObject(), headStructure, shouldHit ? prototype : nullptr,</span>
          [&amp;] (Vector&lt;ObjectPropertyCondition&gt;&amp; conditions, JSObject* object) -&gt; bool {
              if (ObjectPropertyConditionSetInternal::verbose)
                  dataLog(&quot;Encountered object: &quot;, RawPointer(object), &quot;\n&quot;);
              if (object == prototype) {
                  RELEASE_ASSERT(shouldHit);
<span class="line-new-header">--- 381,60 ---</span>
              return true;
          });
  }
  
  ObjectPropertyConditionSet generateConditionsForPrototypePropertyHitCustom(
<span class="line-modified">!     VM&amp; vm, JSCell* owner, JSGlobalObject* globalObject, Structure* headStructure, JSObject* prototype,</span>
<span class="line-modified">!     UniquedStringImpl* uid, unsigned attributes)</span>
  {
      return generateConditions(
<span class="line-modified">!         vm, globalObject, headStructure, prototype,</span>
          [&amp;] (Vector&lt;ObjectPropertyCondition&gt;&amp; conditions, JSObject* object) -&gt; bool {
<span class="line-modified">!             auto kind = PropertyCondition::Absence;</span>
<span class="line-modified">!             if (object == prototype) {</span>
<span class="line-modified">!                 Structure* structure = object-&gt;structure(vm);</span>
<span class="line-modified">!                 PropertyOffset offset = structure-&gt;get(vm, uid);</span>
<span class="line-added">+                 if (isValidOffset(offset)) {</span>
<span class="line-added">+                     // When we reify custom accessors, we wrap them in a JSFunction that we shove</span>
<span class="line-added">+                     // inside a GetterSetter. So, once we&#39;ve reified a custom accessor, we will</span>
<span class="line-added">+                     // no longer see it as a &quot;custom&quot; accessor/value. Hence, if our property access actually</span>
<span class="line-added">+                     // notices a custom, it must be a CustomGetterSetterType cell or something</span>
<span class="line-added">+                     // in the static property table. Custom values get reified into CustomGetterSetters.</span>
<span class="line-added">+                     JSValue value = object-&gt;getDirect(offset);</span>
<span class="line-added">+                     ASSERT_UNUSED(value, value.isCell() &amp;&amp; value.asCell()-&gt;type() == CustomGetterSetterType);</span>
<span class="line-added">+                     kind = PropertyCondition::Equivalence;</span>
<span class="line-added">+                 } else if (structure-&gt;findPropertyHashEntry(uid))</span>
<span class="line-added">+                     kind = PropertyCondition::CustomFunctionEquivalence;</span>
<span class="line-added">+                 else if (attributes &amp; PropertyAttribute::DontDelete) {</span>
<span class="line-added">+                     // This can&#39;t change, so we can blindly cache it.</span>
<span class="line-added">+                     return true;</span>
<span class="line-added">+                 } else {</span>
<span class="line-added">+                     // This means we materialized a custom out of thin air and it&#39;s not DontDelete (i.e, it can be</span>
<span class="line-added">+                     // redefined). This is curious. We don&#39;t actually need to crash here. We could blindly cache</span>
<span class="line-added">+                     // the function. Or we could blindly not cache it. However, we don&#39;t actually do this in WebKit</span>
<span class="line-added">+                     // right now, so it&#39;s reasonable to decide what to do later (or to warn people of forgetting DoneDelete.)</span>
<span class="line-added">+                     ASSERT_NOT_REACHED();</span>
<span class="line-added">+                     return false;</span>
<span class="line-added">+                 }</span>
<span class="line-added">+             }</span>
<span class="line-added">+             ObjectPropertyCondition result = generateCondition(vm, owner, object, uid, kind);</span>
              if (!result)
                  return false;
              conditions.append(result);
              return true;
          });
  }
  
  ObjectPropertyConditionSet generateConditionsForInstanceOf(
<span class="line-modified">!     VM&amp; vm, JSCell* owner, JSGlobalObject* globalObject, Structure* headStructure, JSObject* prototype,</span>
      bool shouldHit)
  {
      bool didHit = false;
      if (ObjectPropertyConditionSetInternal::verbose)
          dataLog(&quot;Searching for prototype &quot;, JSValue(prototype), &quot; starting with structure &quot;, RawPointer(headStructure), &quot; with shouldHit = &quot;, shouldHit, &quot;\n&quot;);
      ObjectPropertyConditionSet result = generateConditions(
<span class="line-modified">!         vm, globalObject, headStructure, shouldHit ? prototype : nullptr,</span>
          [&amp;] (Vector&lt;ObjectPropertyCondition&gt;&amp; conditions, JSObject* object) -&gt; bool {
              if (ObjectPropertyConditionSetInternal::verbose)
                  dataLog(&quot;Encountered object: &quot;, RawPointer(object), &quot;\n&quot;);
              if (object == prototype) {
                  RELEASE_ASSERT(shouldHit);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 438,11 ***</span>
              ObjectPropertyCondition result = generateCondition(vm, nullptr, object, uid, kind);
              if (!result)
                  return false;
              conditions.append(result);
              return true;
<span class="line-modified">!         }, Concurrent);</span>
  }
  
  ObjectPropertyConditionSet generateConditionsForPropertyMissConcurrently(
      VM&amp; vm, JSGlobalObject* globalObject, Structure* headStructure, UniquedStringImpl* uid)
  {
<span class="line-new-header">--- 468,11 ---</span>
              ObjectPropertyCondition result = generateCondition(vm, nullptr, object, uid, kind);
              if (!result)
                  return false;
              conditions.append(result);
              return true;
<span class="line-modified">!         });</span>
  }
  
  ObjectPropertyConditionSet generateConditionsForPropertyMissConcurrently(
      VM&amp; vm, JSGlobalObject* globalObject, Structure* headStructure, UniquedStringImpl* uid)
  {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 452,11 ***</span>
              ObjectPropertyCondition result = generateCondition(vm, nullptr, object, uid, PropertyCondition::Absence);
              if (!result)
                  return false;
              conditions.append(result);
              return true;
<span class="line-modified">!         }, Concurrent);</span>
  }
  
  ObjectPropertyConditionSet generateConditionsForPropertySetterMissConcurrently(
      VM&amp; vm, JSGlobalObject* globalObject, Structure* headStructure, UniquedStringImpl* uid)
  {
<span class="line-new-header">--- 482,11 ---</span>
              ObjectPropertyCondition result = generateCondition(vm, nullptr, object, uid, PropertyCondition::Absence);
              if (!result)
                  return false;
              conditions.append(result);
              return true;
<span class="line-modified">!         });</span>
  }
  
  ObjectPropertyConditionSet generateConditionsForPropertySetterMissConcurrently(
      VM&amp; vm, JSGlobalObject* globalObject, Structure* headStructure, UniquedStringImpl* uid)
  {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 467,16 ***</span>
                  generateCondition(vm, nullptr, object, uid, PropertyCondition::AbsenceOfSetEffect);
              if (!result)
                  return false;
              conditions.append(result);
              return true;
<span class="line-modified">!         }, Concurrent);</span>
  }
  
  ObjectPropertyCondition generateConditionForSelfEquivalence(
      VM&amp; vm, JSCell* owner, JSObject* object, UniquedStringImpl* uid)
  {
      return generateCondition(vm, owner, object, uid, PropertyCondition::Equivalence);
  }
  
  } // namespace JSC
  
<span class="line-new-header">--- 497,95 ---</span>
                  generateCondition(vm, nullptr, object, uid, PropertyCondition::AbsenceOfSetEffect);
              if (!result)
                  return false;
              conditions.append(result);
              return true;
<span class="line-modified">!         });</span>
  }
  
  ObjectPropertyCondition generateConditionForSelfEquivalence(
      VM&amp; vm, JSCell* owner, JSObject* object, UniquedStringImpl* uid)
  {
      return generateCondition(vm, owner, object, uid, PropertyCondition::Equivalence);
  }
  
<span class="line-added">+ // Current might be null. Structure can&#39;t be null.</span>
<span class="line-added">+ static Optional&lt;PrototypeChainCachingStatus&gt; prepareChainForCaching(JSGlobalObject* globalObject, JSCell* current, Structure* structure, JSObject* target)</span>
<span class="line-added">+ {</span>
<span class="line-added">+     ASSERT(structure);</span>
<span class="line-added">+     VM&amp; vm = globalObject-&gt;vm();</span>
<span class="line-added">+ </span>
<span class="line-added">+     bool found = false;</span>
<span class="line-added">+     bool usesPolyProto = false;</span>
<span class="line-added">+     bool flattenedDictionary = false;</span>
<span class="line-added">+ </span>
<span class="line-added">+     while (true) {</span>
<span class="line-added">+         if (structure-&gt;isDictionary()) {</span>
<span class="line-added">+             if (!current)</span>
<span class="line-added">+                 return WTF::nullopt;</span>
<span class="line-added">+ </span>
<span class="line-added">+             ASSERT(structure-&gt;isObject());</span>
<span class="line-added">+             if (structure-&gt;hasBeenFlattenedBefore())</span>
<span class="line-added">+                 return WTF::nullopt;</span>
<span class="line-added">+ </span>
<span class="line-added">+             structure-&gt;flattenDictionaryStructure(vm, asObject(current));</span>
<span class="line-added">+             flattenedDictionary = true;</span>
<span class="line-added">+         }</span>
<span class="line-added">+ </span>
<span class="line-added">+         if (!structure-&gt;propertyAccessesAreCacheable())</span>
<span class="line-added">+             return WTF::nullopt;</span>
<span class="line-added">+ </span>
<span class="line-added">+         if (structure-&gt;isProxy())</span>
<span class="line-added">+             return WTF::nullopt;</span>
<span class="line-added">+ </span>
<span class="line-added">+         if (current &amp;&amp; current == target) {</span>
<span class="line-added">+             found = true;</span>
<span class="line-added">+             break;</span>
<span class="line-added">+         }</span>
<span class="line-added">+ </span>
<span class="line-added">+         // We only have poly proto if we need to access our prototype via</span>
<span class="line-added">+         // the poly proto protocol. If the slot base is the only poly proto</span>
<span class="line-added">+         // thing in the chain, and we have a cache hit on it, then we&#39;re not</span>
<span class="line-added">+         // poly proto.</span>
<span class="line-added">+         JSValue prototype;</span>
<span class="line-added">+         if (structure-&gt;hasPolyProto()) {</span>
<span class="line-added">+             if (!current)</span>
<span class="line-added">+                 return WTF::nullopt;</span>
<span class="line-added">+             usesPolyProto = true;</span>
<span class="line-added">+             prototype = structure-&gt;prototypeForLookup(globalObject, current);</span>
<span class="line-added">+         } else</span>
<span class="line-added">+             prototype = structure-&gt;prototypeForLookup(globalObject);</span>
<span class="line-added">+ </span>
<span class="line-added">+         if (prototype.isNull())</span>
<span class="line-added">+             break;</span>
<span class="line-added">+         current = asObject(prototype);</span>
<span class="line-added">+         structure = current-&gt;structure(vm);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     if (!found &amp;&amp; !!target)</span>
<span class="line-added">+         return WTF::nullopt;</span>
<span class="line-added">+ </span>
<span class="line-added">+     PrototypeChainCachingStatus result;</span>
<span class="line-added">+     result.usesPolyProto = usesPolyProto;</span>
<span class="line-added">+     result.flattenedDictionary = flattenedDictionary;</span>
<span class="line-added">+ </span>
<span class="line-added">+     return result;</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ Optional&lt;PrototypeChainCachingStatus&gt; prepareChainForCaching(JSGlobalObject* globalObject, JSCell* base, JSObject* target)</span>
<span class="line-added">+ {</span>
<span class="line-added">+     return prepareChainForCaching(globalObject, base, base-&gt;structure(globalObject-&gt;vm()), target);</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ Optional&lt;PrototypeChainCachingStatus&gt; prepareChainForCaching(JSGlobalObject* globalObject, JSCell* base, const PropertySlot&amp; slot)</span>
<span class="line-added">+ {</span>
<span class="line-added">+     JSObject* target = slot.isUnset() ? nullptr : slot.slotBase();</span>
<span class="line-added">+     return prepareChainForCaching(globalObject, base, target);</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ Optional&lt;PrototypeChainCachingStatus&gt; prepareChainForCaching(JSGlobalObject* globalObject, Structure* baseStructure, JSObject* target)</span>
<span class="line-added">+ {</span>
<span class="line-added">+     return prepareChainForCaching(globalObject, nullptr, baseStructure, target);</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
  } // namespace JSC
  
</pre>
<center><a href="ObjectPropertyCondition.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="ObjectPropertyConditionSet.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>