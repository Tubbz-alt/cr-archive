<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/JavaScriptCore/b3/testb3_6.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="testb3_5.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="testb3_8.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/JavaScriptCore/b3/testb3_6.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
1645     root-&gt;appendNewControlValue(proc, Jump, Origin(), FrequentedBlock(dispatch));
1646 
1647     // NOTE: It&#39;s totally valid for this patchpoint to be tail-duplicated.
1648     Value* codePointerValue =
1649         dispatch-&gt;appendNew&lt;VariableValue&gt;(proc, B3::Get, Origin(), codePointer);
1650     Value* opcode = dispatch-&gt;appendNew&lt;MemoryValue&gt;(
1651         proc, Load, pointerType(), Origin(), codePointerValue);
1652     PatchpointValue* polyJump = dispatch-&gt;appendNew&lt;PatchpointValue&gt;(proc, Void, Origin());
1653     polyJump-&gt;effects = Effects();
1654     polyJump-&gt;effects.terminal = true;
1655     polyJump-&gt;appendSomeRegister(opcode);
1656     polyJump-&gt;clobber(RegisterSet::macroScratchRegisters());
1657     polyJump-&gt;numGPScratchRegisters = 2;
1658     dispatch-&gt;appendSuccessor(FrequentedBlock(addToDataPointer));
1659     dispatch-&gt;appendSuccessor(FrequentedBlock(addToCodePointer));
1660     dispatch-&gt;appendSuccessor(FrequentedBlock(addToData));
1661     dispatch-&gt;appendSuccessor(FrequentedBlock(print));
1662     dispatch-&gt;appendSuccessor(FrequentedBlock(stop));
1663 
1664     // Our &quot;opcodes&quot;.
<span class="line-modified">1665     static const intptr_t AddDP = 0;</span>
<span class="line-modified">1666     static const intptr_t AddCP = 1;</span>
<span class="line-modified">1667     static const intptr_t Add = 2;</span>
<span class="line-modified">1668     static const intptr_t Print = 3;</span>
<span class="line-modified">1669     static const intptr_t Stop = 4;</span>
1670 
1671     polyJump-&gt;setGenerator(
1672         [&amp;] (CCallHelpers&amp; jit, const StackmapGenerationParams&amp; params) {
1673             AllowMacroScratchRegisterUsage allowScratch(jit);
1674             Vector&lt;Box&lt;CCallHelpers::Label&gt;&gt; labels = params.successorLabels();
1675 
1676             MacroAssemblerCodePtr&lt;B3CompilationPtrTag&gt;* jumpTable = bitwise_cast&lt;MacroAssemblerCodePtr&lt;B3CompilationPtrTag&gt;*&gt;(
1677                 params.proc().addDataSection(sizeof(MacroAssemblerCodePtr&lt;B3CompilationPtrTag&gt;) * labels.size()));
1678 
1679             GPRReg scratch = params.gpScratch(0);
1680 
1681             jit.move(CCallHelpers::TrustedImmPtr(jumpTable), scratch);
1682             jit.load64(CCallHelpers::BaseIndex(scratch, params[0].gpr(), CCallHelpers::timesPtr()), scratch);
1683             jit.farJump(scratch, B3CompilationPtrTag);
1684 
1685             jit.addLinkTask(
1686                 [&amp;, jumpTable, labels] (LinkBuffer&amp; linkBuffer) {
1687                     for (unsigned i = labels.size(); i--;)
1688                         jumpTable[i] = linkBuffer.locationOf&lt;B3CompilationPtrTag&gt;(*labels[i]);
1689                 });
</pre>
<hr />
<pre>
1919 
1920     two-&gt;appendNew&lt;Value&gt;(
1921         proc, Return, Origin(),
1922         two-&gt;appendNew&lt;Value&gt;(
1923             proc, Sub, Origin(),
1924             two-&gt;appendNew&lt;ArgumentRegValue&gt;(proc, Origin(), GPRInfo::argumentGPR0),
1925             two-&gt;appendNew&lt;ArgumentRegValue&gt;(proc, Origin(), GPRInfo::argumentGPR1)));
1926 
1927     three-&gt;appendNew&lt;Value&gt;(
1928         proc, Return, Origin(),
1929         three-&gt;appendNew&lt;Value&gt;(
1930             proc, Mul, Origin(),
1931             three-&gt;appendNew&lt;ArgumentRegValue&gt;(proc, Origin(), GPRInfo::argumentGPR0),
1932             three-&gt;appendNew&lt;ArgumentRegValue&gt;(proc, Origin(), GPRInfo::argumentGPR1)));
1933 
1934     prepareForGeneration(proc);
1935 
1936     CCallHelpers jit;
1937     generate(proc, jit);
1938     LinkBuffer linkBuffer(jit, nullptr);
<span class="line-modified">1939     CodeLocationLabel&lt;B3CompilationPtrTag&gt; labelOne = linkBuffer.locationOf&lt;B3CompilationPtrTag&gt;(proc.entrypointLabel(0));</span>
<span class="line-modified">1940     CodeLocationLabel&lt;B3CompilationPtrTag&gt; labelTwo = linkBuffer.locationOf&lt;B3CompilationPtrTag&gt;(proc.entrypointLabel(1));</span>
<span class="line-modified">1941     CodeLocationLabel&lt;B3CompilationPtrTag&gt; labelThree = linkBuffer.locationOf&lt;B3CompilationPtrTag&gt;(proc.entrypointLabel(2));</span>
1942 
1943     MacroAssemblerCodeRef&lt;B3CompilationPtrTag&gt; codeRef = FINALIZE_CODE(linkBuffer, B3CompilationPtrTag, &quot;testb3 compilation&quot;);
1944 
1945     CHECK(invoke&lt;int&gt;(labelOne, 1, 2) == 3);
1946     CHECK(invoke&lt;int&gt;(labelTwo, 1, 2) == -1);
1947     CHECK(invoke&lt;int&gt;(labelThree, 1, 2) == 2);
1948     CHECK(invoke&lt;int&gt;(labelOne, -1, 2) == 1);
1949     CHECK(invoke&lt;int&gt;(labelTwo, -1, 2) == -3);
1950     CHECK(invoke&lt;int&gt;(labelThree, -1, 2) == -2);
1951 }
1952 
1953 void testEntrySwitchNoEntrySwitch()
1954 {
1955     Procedure proc;
1956     proc.setNumEntrypoints(3);
1957 
1958     BasicBlock* root = proc.addBlock();
1959 
1960     root-&gt;appendNew&lt;Value&gt;(
1961         proc, Return, Origin(),
1962         root-&gt;appendNew&lt;Value&gt;(
1963             proc, Add, Origin(),
1964             root-&gt;appendNew&lt;ArgumentRegValue&gt;(proc, Origin(), GPRInfo::argumentGPR0),
1965             root-&gt;appendNew&lt;ArgumentRegValue&gt;(proc, Origin(), GPRInfo::argumentGPR1)));
1966 
1967     prepareForGeneration(proc);
1968 
1969     CCallHelpers jit;
1970     generate(proc, jit);
1971     LinkBuffer linkBuffer(jit, nullptr);
<span class="line-modified">1972     CodeLocationLabel&lt;B3CompilationPtrTag&gt; labelOne = linkBuffer.locationOf&lt;B3CompilationPtrTag&gt;(proc.entrypointLabel(0));</span>
<span class="line-modified">1973     CodeLocationLabel&lt;B3CompilationPtrTag&gt; labelTwo = linkBuffer.locationOf&lt;B3CompilationPtrTag&gt;(proc.entrypointLabel(1));</span>
<span class="line-modified">1974     CodeLocationLabel&lt;B3CompilationPtrTag&gt; labelThree = linkBuffer.locationOf&lt;B3CompilationPtrTag&gt;(proc.entrypointLabel(2));</span>
1975 
1976     MacroAssemblerCodeRef&lt;B3CompilationPtrTag&gt; codeRef = FINALIZE_CODE(linkBuffer, B3CompilationPtrTag, &quot;testb3 compilation&quot;);
1977 
1978     CHECK_EQ(invoke&lt;int&gt;(labelOne, 1, 2), 3);
1979     CHECK_EQ(invoke&lt;int&gt;(labelTwo, 1, 2), 3);
1980     CHECK_EQ(invoke&lt;int&gt;(labelThree, 1, 2), 3);
1981     CHECK_EQ(invoke&lt;int&gt;(labelOne, -1, 2), 1);
1982     CHECK_EQ(invoke&lt;int&gt;(labelTwo, -1, 2), 1);
1983     CHECK_EQ(invoke&lt;int&gt;(labelThree, -1, 2), 1);
1984 }
1985 
1986 void testEntrySwitchWithCommonPaths()
1987 {
1988     Procedure proc;
1989     proc.setNumEntrypoints(3);
1990 
1991     BasicBlock* root = proc.addBlock();
1992     BasicBlock* one = proc.addBlock();
1993     BasicBlock* two = proc.addBlock();
1994     BasicBlock* three = proc.addBlock();
</pre>
<hr />
<pre>
2039     three-&gt;setSuccessors(FrequentedBlock(end));
2040 
2041     Value* phi = end-&gt;appendNew&lt;Value&gt;(proc, Phi, Int32, Origin());
2042     upsilonOne-&gt;setPhi(phi);
2043     upsilonTwo-&gt;setPhi(phi);
2044     upsilonThree-&gt;setPhi(phi);
2045 
2046     end-&gt;appendNew&lt;Value&gt;(
2047         proc, Return, Origin(),
2048         end-&gt;appendNew&lt;Value&gt;(
2049             proc, chill(Mod), Origin(),
2050             phi, end-&gt;appendNew&lt;Value&gt;(
2051                 proc, Trunc, Origin(),
2052                 end-&gt;appendNew&lt;ArgumentRegValue&gt;(proc, Origin(), GPRInfo::argumentGPR2))));
2053 
2054     prepareForGeneration(proc);
2055 
2056     CCallHelpers jit;
2057     generate(proc, jit);
2058     LinkBuffer linkBuffer(jit, nullptr);
<span class="line-modified">2059     CodeLocationLabel&lt;B3CompilationPtrTag&gt; labelOne = linkBuffer.locationOf&lt;B3CompilationPtrTag&gt;(proc.entrypointLabel(0));</span>
<span class="line-modified">2060     CodeLocationLabel&lt;B3CompilationPtrTag&gt; labelTwo = linkBuffer.locationOf&lt;B3CompilationPtrTag&gt;(proc.entrypointLabel(1));</span>
<span class="line-modified">2061     CodeLocationLabel&lt;B3CompilationPtrTag&gt; labelThree = linkBuffer.locationOf&lt;B3CompilationPtrTag&gt;(proc.entrypointLabel(2));</span>
2062 
2063     MacroAssemblerCodeRef&lt;B3CompilationPtrTag&gt; codeRef = FINALIZE_CODE(linkBuffer, B3CompilationPtrTag, &quot;testb3 compilation&quot;);
2064 
2065     CHECK_EQ(invoke&lt;int&gt;(labelOne, 1, 2, 10), 3);
2066     CHECK_EQ(invoke&lt;int&gt;(labelTwo, 1, 2, 10), -1);
2067     CHECK_EQ(invoke&lt;int&gt;(labelThree, 1, 2, 10), 2);
2068     CHECK_EQ(invoke&lt;int&gt;(labelOne, -1, 2, 10), 1);
2069     CHECK_EQ(invoke&lt;int&gt;(labelTwo, -1, 2, 10), -3);
2070     CHECK_EQ(invoke&lt;int&gt;(labelThree, -1, 2, 10), -2);
2071     CHECK_EQ(invoke&lt;int&gt;(labelOne, 1, 2, 2), 1);
2072     CHECK_EQ(invoke&lt;int&gt;(labelTwo, 1, 2, 2), -1);
2073     CHECK_EQ(invoke&lt;int&gt;(labelThree, 1, 2, 2), 0);
2074     CHECK_EQ(invoke&lt;int&gt;(labelOne, -1, 2, 2), 1);
2075     CHECK_EQ(invoke&lt;int&gt;(labelTwo, -1, 2, 2), -1);
2076     CHECK_EQ(invoke&lt;int&gt;(labelThree, -1, 2, 2), 0);
2077     CHECK_EQ(invoke&lt;int&gt;(labelOne, 1, 2, 0), 0);
2078     CHECK_EQ(invoke&lt;int&gt;(labelTwo, 1, 2, 0), 0);
2079     CHECK_EQ(invoke&lt;int&gt;(labelThree, 1, 2, 0), 0);
2080     CHECK_EQ(invoke&lt;int&gt;(labelOne, -1, 2, 0), 0);
2081     CHECK_EQ(invoke&lt;int&gt;(labelTwo, -1, 2, 0), 0);
</pre>
<hr />
<pre>
2156     three-&gt;setSuccessors(FrequentedBlock(end));
2157 
2158     Value* phi = end-&gt;appendNew&lt;Value&gt;(proc, Phi, Int32, Origin());
2159     upsilonOne-&gt;setPhi(phi);
2160     upsilonTwo-&gt;setPhi(phi);
2161     upsilonThree-&gt;setPhi(phi);
2162 
2163     end-&gt;appendNew&lt;Value&gt;(
2164         proc, Return, Origin(),
2165         end-&gt;appendNew&lt;Value&gt;(
2166             proc, chill(Mod), Origin(),
2167             phi, end-&gt;appendNew&lt;Value&gt;(
2168                 proc, Trunc, Origin(),
2169                 end-&gt;appendNew&lt;ArgumentRegValue&gt;(proc, Origin(), GPRInfo::argumentGPR2))));
2170 
2171     prepareForGeneration(proc);
2172 
2173     CCallHelpers jit;
2174     generate(proc, jit);
2175     LinkBuffer linkBuffer(jit, nullptr);
<span class="line-modified">2176     CodeLocationLabel&lt;B3CompilationPtrTag&gt; labelOne = linkBuffer.locationOf&lt;B3CompilationPtrTag&gt;(proc.entrypointLabel(0));</span>
<span class="line-modified">2177     CodeLocationLabel&lt;B3CompilationPtrTag&gt; labelTwo = linkBuffer.locationOf&lt;B3CompilationPtrTag&gt;(proc.entrypointLabel(1));</span>
<span class="line-modified">2178     CodeLocationLabel&lt;B3CompilationPtrTag&gt; labelThree = linkBuffer.locationOf&lt;B3CompilationPtrTag&gt;(proc.entrypointLabel(2));</span>
2179 
2180     MacroAssemblerCodeRef&lt;B3CompilationPtrTag&gt; codeRef = FINALIZE_CODE(linkBuffer, B3CompilationPtrTag, &quot;testb3 compilation&quot;);
2181 
2182     CHECK_EQ(invoke&lt;int&gt;(labelOne, 1, 2, 10, false), 3);
2183     CHECK_EQ(invoke&lt;int&gt;(labelTwo, 1, 2, 10, false), -1);
2184     CHECK_EQ(invoke&lt;int&gt;(labelThree, 1, 2, 10, false), 2);
2185     CHECK_EQ(invoke&lt;int&gt;(labelOne, -1, 2, 10, false), 1);
2186     CHECK_EQ(invoke&lt;int&gt;(labelTwo, -1, 2, 10, false), -3);
2187     CHECK_EQ(invoke&lt;int&gt;(labelThree, -1, 2, 10, false), -2);
2188     CHECK_EQ(invoke&lt;int&gt;(labelOne, 1, 2, 10, true), 1);
2189     CHECK_EQ(invoke&lt;int&gt;(labelTwo, 1, 2, 10, true), -3);
2190     CHECK_EQ(invoke&lt;int&gt;(labelThree, 1, 2, 10, true), -2);
2191     CHECK_EQ(invoke&lt;int&gt;(labelOne, -1, 2, 10, true), 3);
2192     CHECK_EQ(invoke&lt;int&gt;(labelTwo, -1, 2, 10, true), -1);
2193     CHECK_EQ(invoke&lt;int&gt;(labelThree, -1, 2, 10, true), 2);
2194     CHECK_EQ(invoke&lt;int&gt;(labelOne, 1, 2, 2, false), 1);
2195     CHECK_EQ(invoke&lt;int&gt;(labelTwo, 1, 2, 2, false), -1);
2196     CHECK_EQ(invoke&lt;int&gt;(labelThree, 1, 2, 2, false), 0);
2197     CHECK_EQ(invoke&lt;int&gt;(labelOne, -1, 2, 2, false), 1);
2198     CHECK_EQ(invoke&lt;int&gt;(labelTwo, -1, 2, 2, false), -1);
</pre>
<hr />
<pre>
2234         loopHeader-&gt;appendNew&lt;Const32Value&gt;(proc, Origin(), 1));
2235     loopHeader-&gt;appendNew&lt;Value&gt;(proc, EntrySwitch, Origin());
2236     loopHeader-&gt;appendSuccessor(end);
2237     loopHeader-&gt;appendSuccessor(loopFooter);
2238 
2239     loopFooter-&gt;appendNew&lt;UpsilonValue&gt;(proc, Origin(), newValue, valueInLoop);
2240     loopFooter-&gt;appendNew&lt;Value&gt;(
2241         proc, Branch, Origin(),
2242         loopFooter-&gt;appendNew&lt;Value&gt;(
2243             proc, LessThan, Origin(), newValue,
2244             loopFooter-&gt;appendNew&lt;Const32Value&gt;(proc, Origin(), 100)));
2245     loopFooter-&gt;setSuccessors(loopHeader, end);
2246 
2247     end-&gt;appendNew&lt;Value&gt;(proc, Return, Origin(), newValue);
2248 
2249     prepareForGeneration(proc);
2250 
2251     CCallHelpers jit;
2252     generate(proc, jit);
2253     LinkBuffer linkBuffer(jit, nullptr);
<span class="line-modified">2254     CodeLocationLabel&lt;B3CompilationPtrTag&gt; labelOne = linkBuffer.locationOf&lt;B3CompilationPtrTag&gt;(proc.entrypointLabel(0));</span>
<span class="line-modified">2255     CodeLocationLabel&lt;B3CompilationPtrTag&gt; labelTwo = linkBuffer.locationOf&lt;B3CompilationPtrTag&gt;(proc.entrypointLabel(1));</span>
2256 
2257     MacroAssemblerCodeRef&lt;B3CompilationPtrTag&gt; codeRef = FINALIZE_CODE(linkBuffer, B3CompilationPtrTag, &quot;testb3 compilation&quot;);
2258 
2259     CHECK(invoke&lt;int&gt;(labelOne, 0) == 1);
2260     CHECK(invoke&lt;int&gt;(labelOne, 42) == 43);
2261     CHECK(invoke&lt;int&gt;(labelOne, 1000) == 1001);
2262 
2263     CHECK(invoke&lt;int&gt;(labelTwo, 0) == 100);
2264     CHECK(invoke&lt;int&gt;(labelTwo, 42) == 100);
2265     CHECK(invoke&lt;int&gt;(labelTwo, 1000) == 1001);
2266 }
2267 
2268 void testSomeEarlyRegister()
2269 {
2270     auto run = [&amp;] (bool succeed) {
2271         Procedure proc;
2272 
2273         BasicBlock* root = proc.addBlock();
2274 
2275         PatchpointValue* patchpoint = root-&gt;appendNew&lt;PatchpointValue&gt;(proc, Int32, Origin());
</pre>
</td>
<td>
<hr />
<pre>
1645     root-&gt;appendNewControlValue(proc, Jump, Origin(), FrequentedBlock(dispatch));
1646 
1647     // NOTE: It&#39;s totally valid for this patchpoint to be tail-duplicated.
1648     Value* codePointerValue =
1649         dispatch-&gt;appendNew&lt;VariableValue&gt;(proc, B3::Get, Origin(), codePointer);
1650     Value* opcode = dispatch-&gt;appendNew&lt;MemoryValue&gt;(
1651         proc, Load, pointerType(), Origin(), codePointerValue);
1652     PatchpointValue* polyJump = dispatch-&gt;appendNew&lt;PatchpointValue&gt;(proc, Void, Origin());
1653     polyJump-&gt;effects = Effects();
1654     polyJump-&gt;effects.terminal = true;
1655     polyJump-&gt;appendSomeRegister(opcode);
1656     polyJump-&gt;clobber(RegisterSet::macroScratchRegisters());
1657     polyJump-&gt;numGPScratchRegisters = 2;
1658     dispatch-&gt;appendSuccessor(FrequentedBlock(addToDataPointer));
1659     dispatch-&gt;appendSuccessor(FrequentedBlock(addToCodePointer));
1660     dispatch-&gt;appendSuccessor(FrequentedBlock(addToData));
1661     dispatch-&gt;appendSuccessor(FrequentedBlock(print));
1662     dispatch-&gt;appendSuccessor(FrequentedBlock(stop));
1663 
1664     // Our &quot;opcodes&quot;.
<span class="line-modified">1665     static constexpr intptr_t AddDP = 0;</span>
<span class="line-modified">1666     static constexpr intptr_t AddCP = 1;</span>
<span class="line-modified">1667     static constexpr intptr_t Add = 2;</span>
<span class="line-modified">1668     static constexpr intptr_t Print = 3;</span>
<span class="line-modified">1669     static constexpr intptr_t Stop = 4;</span>
1670 
1671     polyJump-&gt;setGenerator(
1672         [&amp;] (CCallHelpers&amp; jit, const StackmapGenerationParams&amp; params) {
1673             AllowMacroScratchRegisterUsage allowScratch(jit);
1674             Vector&lt;Box&lt;CCallHelpers::Label&gt;&gt; labels = params.successorLabels();
1675 
1676             MacroAssemblerCodePtr&lt;B3CompilationPtrTag&gt;* jumpTable = bitwise_cast&lt;MacroAssemblerCodePtr&lt;B3CompilationPtrTag&gt;*&gt;(
1677                 params.proc().addDataSection(sizeof(MacroAssemblerCodePtr&lt;B3CompilationPtrTag&gt;) * labels.size()));
1678 
1679             GPRReg scratch = params.gpScratch(0);
1680 
1681             jit.move(CCallHelpers::TrustedImmPtr(jumpTable), scratch);
1682             jit.load64(CCallHelpers::BaseIndex(scratch, params[0].gpr(), CCallHelpers::timesPtr()), scratch);
1683             jit.farJump(scratch, B3CompilationPtrTag);
1684 
1685             jit.addLinkTask(
1686                 [&amp;, jumpTable, labels] (LinkBuffer&amp; linkBuffer) {
1687                     for (unsigned i = labels.size(); i--;)
1688                         jumpTable[i] = linkBuffer.locationOf&lt;B3CompilationPtrTag&gt;(*labels[i]);
1689                 });
</pre>
<hr />
<pre>
1919 
1920     two-&gt;appendNew&lt;Value&gt;(
1921         proc, Return, Origin(),
1922         two-&gt;appendNew&lt;Value&gt;(
1923             proc, Sub, Origin(),
1924             two-&gt;appendNew&lt;ArgumentRegValue&gt;(proc, Origin(), GPRInfo::argumentGPR0),
1925             two-&gt;appendNew&lt;ArgumentRegValue&gt;(proc, Origin(), GPRInfo::argumentGPR1)));
1926 
1927     three-&gt;appendNew&lt;Value&gt;(
1928         proc, Return, Origin(),
1929         three-&gt;appendNew&lt;Value&gt;(
1930             proc, Mul, Origin(),
1931             three-&gt;appendNew&lt;ArgumentRegValue&gt;(proc, Origin(), GPRInfo::argumentGPR0),
1932             three-&gt;appendNew&lt;ArgumentRegValue&gt;(proc, Origin(), GPRInfo::argumentGPR1)));
1933 
1934     prepareForGeneration(proc);
1935 
1936     CCallHelpers jit;
1937     generate(proc, jit);
1938     LinkBuffer linkBuffer(jit, nullptr);
<span class="line-modified">1939     CodeLocationLabel&lt;B3CompilationPtrTag&gt; labelOne = linkBuffer.locationOf&lt;B3CompilationPtrTag&gt;(proc.code().entrypointLabel(0));</span>
<span class="line-modified">1940     CodeLocationLabel&lt;B3CompilationPtrTag&gt; labelTwo = linkBuffer.locationOf&lt;B3CompilationPtrTag&gt;(proc.code().entrypointLabel(1));</span>
<span class="line-modified">1941     CodeLocationLabel&lt;B3CompilationPtrTag&gt; labelThree = linkBuffer.locationOf&lt;B3CompilationPtrTag&gt;(proc.code().entrypointLabel(2));</span>
1942 
1943     MacroAssemblerCodeRef&lt;B3CompilationPtrTag&gt; codeRef = FINALIZE_CODE(linkBuffer, B3CompilationPtrTag, &quot;testb3 compilation&quot;);
1944 
1945     CHECK(invoke&lt;int&gt;(labelOne, 1, 2) == 3);
1946     CHECK(invoke&lt;int&gt;(labelTwo, 1, 2) == -1);
1947     CHECK(invoke&lt;int&gt;(labelThree, 1, 2) == 2);
1948     CHECK(invoke&lt;int&gt;(labelOne, -1, 2) == 1);
1949     CHECK(invoke&lt;int&gt;(labelTwo, -1, 2) == -3);
1950     CHECK(invoke&lt;int&gt;(labelThree, -1, 2) == -2);
1951 }
1952 
1953 void testEntrySwitchNoEntrySwitch()
1954 {
1955     Procedure proc;
1956     proc.setNumEntrypoints(3);
1957 
1958     BasicBlock* root = proc.addBlock();
1959 
1960     root-&gt;appendNew&lt;Value&gt;(
1961         proc, Return, Origin(),
1962         root-&gt;appendNew&lt;Value&gt;(
1963             proc, Add, Origin(),
1964             root-&gt;appendNew&lt;ArgumentRegValue&gt;(proc, Origin(), GPRInfo::argumentGPR0),
1965             root-&gt;appendNew&lt;ArgumentRegValue&gt;(proc, Origin(), GPRInfo::argumentGPR1)));
1966 
1967     prepareForGeneration(proc);
1968 
1969     CCallHelpers jit;
1970     generate(proc, jit);
1971     LinkBuffer linkBuffer(jit, nullptr);
<span class="line-modified">1972     CodeLocationLabel&lt;B3CompilationPtrTag&gt; labelOne = linkBuffer.locationOf&lt;B3CompilationPtrTag&gt;(proc.code().entrypointLabel(0));</span>
<span class="line-modified">1973     CodeLocationLabel&lt;B3CompilationPtrTag&gt; labelTwo = linkBuffer.locationOf&lt;B3CompilationPtrTag&gt;(proc.code().entrypointLabel(1));</span>
<span class="line-modified">1974     CodeLocationLabel&lt;B3CompilationPtrTag&gt; labelThree = linkBuffer.locationOf&lt;B3CompilationPtrTag&gt;(proc.code().entrypointLabel(2));</span>
1975 
1976     MacroAssemblerCodeRef&lt;B3CompilationPtrTag&gt; codeRef = FINALIZE_CODE(linkBuffer, B3CompilationPtrTag, &quot;testb3 compilation&quot;);
1977 
1978     CHECK_EQ(invoke&lt;int&gt;(labelOne, 1, 2), 3);
1979     CHECK_EQ(invoke&lt;int&gt;(labelTwo, 1, 2), 3);
1980     CHECK_EQ(invoke&lt;int&gt;(labelThree, 1, 2), 3);
1981     CHECK_EQ(invoke&lt;int&gt;(labelOne, -1, 2), 1);
1982     CHECK_EQ(invoke&lt;int&gt;(labelTwo, -1, 2), 1);
1983     CHECK_EQ(invoke&lt;int&gt;(labelThree, -1, 2), 1);
1984 }
1985 
1986 void testEntrySwitchWithCommonPaths()
1987 {
1988     Procedure proc;
1989     proc.setNumEntrypoints(3);
1990 
1991     BasicBlock* root = proc.addBlock();
1992     BasicBlock* one = proc.addBlock();
1993     BasicBlock* two = proc.addBlock();
1994     BasicBlock* three = proc.addBlock();
</pre>
<hr />
<pre>
2039     three-&gt;setSuccessors(FrequentedBlock(end));
2040 
2041     Value* phi = end-&gt;appendNew&lt;Value&gt;(proc, Phi, Int32, Origin());
2042     upsilonOne-&gt;setPhi(phi);
2043     upsilonTwo-&gt;setPhi(phi);
2044     upsilonThree-&gt;setPhi(phi);
2045 
2046     end-&gt;appendNew&lt;Value&gt;(
2047         proc, Return, Origin(),
2048         end-&gt;appendNew&lt;Value&gt;(
2049             proc, chill(Mod), Origin(),
2050             phi, end-&gt;appendNew&lt;Value&gt;(
2051                 proc, Trunc, Origin(),
2052                 end-&gt;appendNew&lt;ArgumentRegValue&gt;(proc, Origin(), GPRInfo::argumentGPR2))));
2053 
2054     prepareForGeneration(proc);
2055 
2056     CCallHelpers jit;
2057     generate(proc, jit);
2058     LinkBuffer linkBuffer(jit, nullptr);
<span class="line-modified">2059     CodeLocationLabel&lt;B3CompilationPtrTag&gt; labelOne = linkBuffer.locationOf&lt;B3CompilationPtrTag&gt;(proc.code().entrypointLabel(0));</span>
<span class="line-modified">2060     CodeLocationLabel&lt;B3CompilationPtrTag&gt; labelTwo = linkBuffer.locationOf&lt;B3CompilationPtrTag&gt;(proc.code().entrypointLabel(1));</span>
<span class="line-modified">2061     CodeLocationLabel&lt;B3CompilationPtrTag&gt; labelThree = linkBuffer.locationOf&lt;B3CompilationPtrTag&gt;(proc.code().entrypointLabel(2));</span>
2062 
2063     MacroAssemblerCodeRef&lt;B3CompilationPtrTag&gt; codeRef = FINALIZE_CODE(linkBuffer, B3CompilationPtrTag, &quot;testb3 compilation&quot;);
2064 
2065     CHECK_EQ(invoke&lt;int&gt;(labelOne, 1, 2, 10), 3);
2066     CHECK_EQ(invoke&lt;int&gt;(labelTwo, 1, 2, 10), -1);
2067     CHECK_EQ(invoke&lt;int&gt;(labelThree, 1, 2, 10), 2);
2068     CHECK_EQ(invoke&lt;int&gt;(labelOne, -1, 2, 10), 1);
2069     CHECK_EQ(invoke&lt;int&gt;(labelTwo, -1, 2, 10), -3);
2070     CHECK_EQ(invoke&lt;int&gt;(labelThree, -1, 2, 10), -2);
2071     CHECK_EQ(invoke&lt;int&gt;(labelOne, 1, 2, 2), 1);
2072     CHECK_EQ(invoke&lt;int&gt;(labelTwo, 1, 2, 2), -1);
2073     CHECK_EQ(invoke&lt;int&gt;(labelThree, 1, 2, 2), 0);
2074     CHECK_EQ(invoke&lt;int&gt;(labelOne, -1, 2, 2), 1);
2075     CHECK_EQ(invoke&lt;int&gt;(labelTwo, -1, 2, 2), -1);
2076     CHECK_EQ(invoke&lt;int&gt;(labelThree, -1, 2, 2), 0);
2077     CHECK_EQ(invoke&lt;int&gt;(labelOne, 1, 2, 0), 0);
2078     CHECK_EQ(invoke&lt;int&gt;(labelTwo, 1, 2, 0), 0);
2079     CHECK_EQ(invoke&lt;int&gt;(labelThree, 1, 2, 0), 0);
2080     CHECK_EQ(invoke&lt;int&gt;(labelOne, -1, 2, 0), 0);
2081     CHECK_EQ(invoke&lt;int&gt;(labelTwo, -1, 2, 0), 0);
</pre>
<hr />
<pre>
2156     three-&gt;setSuccessors(FrequentedBlock(end));
2157 
2158     Value* phi = end-&gt;appendNew&lt;Value&gt;(proc, Phi, Int32, Origin());
2159     upsilonOne-&gt;setPhi(phi);
2160     upsilonTwo-&gt;setPhi(phi);
2161     upsilonThree-&gt;setPhi(phi);
2162 
2163     end-&gt;appendNew&lt;Value&gt;(
2164         proc, Return, Origin(),
2165         end-&gt;appendNew&lt;Value&gt;(
2166             proc, chill(Mod), Origin(),
2167             phi, end-&gt;appendNew&lt;Value&gt;(
2168                 proc, Trunc, Origin(),
2169                 end-&gt;appendNew&lt;ArgumentRegValue&gt;(proc, Origin(), GPRInfo::argumentGPR2))));
2170 
2171     prepareForGeneration(proc);
2172 
2173     CCallHelpers jit;
2174     generate(proc, jit);
2175     LinkBuffer linkBuffer(jit, nullptr);
<span class="line-modified">2176     CodeLocationLabel&lt;B3CompilationPtrTag&gt; labelOne = linkBuffer.locationOf&lt;B3CompilationPtrTag&gt;(proc.code().entrypointLabel(0));</span>
<span class="line-modified">2177     CodeLocationLabel&lt;B3CompilationPtrTag&gt; labelTwo = linkBuffer.locationOf&lt;B3CompilationPtrTag&gt;(proc.code().entrypointLabel(1));</span>
<span class="line-modified">2178     CodeLocationLabel&lt;B3CompilationPtrTag&gt; labelThree = linkBuffer.locationOf&lt;B3CompilationPtrTag&gt;(proc.code().entrypointLabel(2));</span>
2179 
2180     MacroAssemblerCodeRef&lt;B3CompilationPtrTag&gt; codeRef = FINALIZE_CODE(linkBuffer, B3CompilationPtrTag, &quot;testb3 compilation&quot;);
2181 
2182     CHECK_EQ(invoke&lt;int&gt;(labelOne, 1, 2, 10, false), 3);
2183     CHECK_EQ(invoke&lt;int&gt;(labelTwo, 1, 2, 10, false), -1);
2184     CHECK_EQ(invoke&lt;int&gt;(labelThree, 1, 2, 10, false), 2);
2185     CHECK_EQ(invoke&lt;int&gt;(labelOne, -1, 2, 10, false), 1);
2186     CHECK_EQ(invoke&lt;int&gt;(labelTwo, -1, 2, 10, false), -3);
2187     CHECK_EQ(invoke&lt;int&gt;(labelThree, -1, 2, 10, false), -2);
2188     CHECK_EQ(invoke&lt;int&gt;(labelOne, 1, 2, 10, true), 1);
2189     CHECK_EQ(invoke&lt;int&gt;(labelTwo, 1, 2, 10, true), -3);
2190     CHECK_EQ(invoke&lt;int&gt;(labelThree, 1, 2, 10, true), -2);
2191     CHECK_EQ(invoke&lt;int&gt;(labelOne, -1, 2, 10, true), 3);
2192     CHECK_EQ(invoke&lt;int&gt;(labelTwo, -1, 2, 10, true), -1);
2193     CHECK_EQ(invoke&lt;int&gt;(labelThree, -1, 2, 10, true), 2);
2194     CHECK_EQ(invoke&lt;int&gt;(labelOne, 1, 2, 2, false), 1);
2195     CHECK_EQ(invoke&lt;int&gt;(labelTwo, 1, 2, 2, false), -1);
2196     CHECK_EQ(invoke&lt;int&gt;(labelThree, 1, 2, 2, false), 0);
2197     CHECK_EQ(invoke&lt;int&gt;(labelOne, -1, 2, 2, false), 1);
2198     CHECK_EQ(invoke&lt;int&gt;(labelTwo, -1, 2, 2, false), -1);
</pre>
<hr />
<pre>
2234         loopHeader-&gt;appendNew&lt;Const32Value&gt;(proc, Origin(), 1));
2235     loopHeader-&gt;appendNew&lt;Value&gt;(proc, EntrySwitch, Origin());
2236     loopHeader-&gt;appendSuccessor(end);
2237     loopHeader-&gt;appendSuccessor(loopFooter);
2238 
2239     loopFooter-&gt;appendNew&lt;UpsilonValue&gt;(proc, Origin(), newValue, valueInLoop);
2240     loopFooter-&gt;appendNew&lt;Value&gt;(
2241         proc, Branch, Origin(),
2242         loopFooter-&gt;appendNew&lt;Value&gt;(
2243             proc, LessThan, Origin(), newValue,
2244             loopFooter-&gt;appendNew&lt;Const32Value&gt;(proc, Origin(), 100)));
2245     loopFooter-&gt;setSuccessors(loopHeader, end);
2246 
2247     end-&gt;appendNew&lt;Value&gt;(proc, Return, Origin(), newValue);
2248 
2249     prepareForGeneration(proc);
2250 
2251     CCallHelpers jit;
2252     generate(proc, jit);
2253     LinkBuffer linkBuffer(jit, nullptr);
<span class="line-modified">2254     CodeLocationLabel&lt;B3CompilationPtrTag&gt; labelOne = linkBuffer.locationOf&lt;B3CompilationPtrTag&gt;(proc.code().entrypointLabel(0));</span>
<span class="line-modified">2255     CodeLocationLabel&lt;B3CompilationPtrTag&gt; labelTwo = linkBuffer.locationOf&lt;B3CompilationPtrTag&gt;(proc.code().entrypointLabel(1));</span>
2256 
2257     MacroAssemblerCodeRef&lt;B3CompilationPtrTag&gt; codeRef = FINALIZE_CODE(linkBuffer, B3CompilationPtrTag, &quot;testb3 compilation&quot;);
2258 
2259     CHECK(invoke&lt;int&gt;(labelOne, 0) == 1);
2260     CHECK(invoke&lt;int&gt;(labelOne, 42) == 43);
2261     CHECK(invoke&lt;int&gt;(labelOne, 1000) == 1001);
2262 
2263     CHECK(invoke&lt;int&gt;(labelTwo, 0) == 100);
2264     CHECK(invoke&lt;int&gt;(labelTwo, 42) == 100);
2265     CHECK(invoke&lt;int&gt;(labelTwo, 1000) == 1001);
2266 }
2267 
2268 void testSomeEarlyRegister()
2269 {
2270     auto run = [&amp;] (bool succeed) {
2271         Procedure proc;
2272 
2273         BasicBlock* root = proc.addBlock();
2274 
2275         PatchpointValue* patchpoint = root-&gt;appendNew&lt;PatchpointValue&gt;(proc, Int32, Origin());
</pre>
</td>
</tr>
</table>
<center><a href="testb3_5.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="testb3_8.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>