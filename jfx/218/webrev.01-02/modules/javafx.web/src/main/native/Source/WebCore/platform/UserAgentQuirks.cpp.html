<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New modules/javafx.web/src/main/native/Source/WebCore/platform/UserAgentQuirks.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (C) 2012, 2014, 2016 Igalia S.L.
  3  *
  4  * Redistribution and use in source and binary forms, with or without
  5  * modification, are permitted provided that the following conditions
  6  * are met:
  7  * 1. Redistributions of source code must retain the above copyright
  8  *    notice, this list of conditions and the following disclaimer.
  9  * 2. Redistributions in binary form must reproduce the above copyright
 10  *    notice, this list of conditions and the following disclaimer in the
 11  *    documentation and/or other materials provided with the distribution.
 12  *
 13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. ``AS IS&#39;&#39; AND ANY
 14  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 15  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 16  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE INC. OR
 17  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 18  * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 19  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 20  * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 21  * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 22  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 23  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #include &quot;config.h&quot;
 27 #include &quot;UserAgentQuirks.h&quot;
 28 
 29 #include &quot;PublicSuffix.h&quot;
 30 #include &lt;wtf/URL.h&gt;
 31 
 32 namespace WebCore {
 33 
 34 // When editing the quirks in this file, be sure to update
 35 // Tools/TestWebKitAPI/Tests/WebCore/UserAgentQuirks.cpp.
 36 
 37 static bool isGoogle(const URL&amp; url)
 38 {
 39     String domain = url.host().toString();
 40     String baseDomain = topPrivatelyControlledDomain(domain);
 41 
 42     // Our Google UA is *very* complicated to get right. Read
 43     // https://webkit.org/b/142074 carefully before changing. Test that 3D
 44     // view is available in Google Maps. Test Google Calendar. Test logging out
 45     // and logging in to a Google account. Change platformVersionForUAString()
 46     // to return &quot;FreeBSD amd64&quot; and test everything again.
 47     if (baseDomain.startsWith(&quot;google.&quot;))
 48         return true;
 49     if (baseDomain == &quot;gstatic.com&quot;)
 50         return true;
 51     if (baseDomain == &quot;googleusercontent.com&quot;)
 52         return true;
 53     // googleapis.com is in the public suffix list, which is confusing. E.g.
 54     // fonts.googleapis.com is actually a base domain.
 55     if (domain.endsWith(&quot;.googleapis.com&quot;))
 56         return true;
 57 
 58     return false;
 59 }
 60 
 61 // Be careful with this quirk: it&#39;s an invitation for sites to use JavaScript
 62 // that works in Chrome that WebKit cannot handle. Prefer other quirks instead.
 63 static bool urlRequiresChromeBrowser(const URL&amp; url)
 64 {
 65     String domain = url.host().toString();
 66     String baseDomain = topPrivatelyControlledDomain(domain);
 67 
 68     // Needed for fonts on many sites to work with WebKit.
 69     // https://bugs.webkit.org/show_bug.cgi?id=147296
 70     if (baseDomain == &quot;typekit.net&quot; || baseDomain == &quot;typekit.com&quot;)
 71         return true;
 72 
 73     // This site completely blocks the login page with WebKitGTK&#39;s standard user
 74     // agent and ask users to use Google Chrome or Microsoft Internet Explorer.
 75     if (domain == &quot;auth.mayohr.com&quot;)
 76         return true;
 77 
 78     return false;
 79 }
 80 
 81 // Prefer using the macOS platform quirk rather than the Firefox quirk. This
 82 // quirk is good for websites that do macOS-specific things we don&#39;t want on
 83 // other platforms, and when the risk of the website doing Firefox-specific
 84 // things is relatively low.
 85 static bool urlRequiresFirefoxBrowser(const URL&amp; url)
 86 {
 87     String domain = url.host().toString();
 88 
 89     // This quirk actually has nothing to do with YouTube. It&#39;s needed to avoid
 90     // unsupported browser warnings on Google Docs. After removing this quirk,
 91     // to reproduce the warnings you will need to sign out of Google, then click
 92     // on a link to a non-public document that requires signing in. The
 93     // unsupported browser warning will be displayed after signing in.
 94     if (domain == &quot;accounts.youtube.com&quot; || domain == &quot;docs.google.com&quot;)
 95         return true;
 96 
 97     // Google Drive shows an unsupported browser warning with WebKitGTK&#39;s
 98     // standard user agent.
 99     if (domain == &quot;drive.google.com&quot;)
100         return true;
101 
102     return false;
103 }
104 
105 static bool urlRequiresMacintoshPlatform(const URL&amp; url)
106 {
107     String domain = url.host().toString();
108     String baseDomain = topPrivatelyControlledDomain(domain);
109 
110     // At least finance.yahoo.com displays a mobile version with WebKitGTK&#39;s standard user agent.
111     if (baseDomain == &quot;yahoo.com&quot;)
112         return true;
113 
114     // taobao.com displays a mobile version with WebKitGTK&#39;s standard user agent.
115     if (baseDomain == &quot;taobao.com&quot;)
116         return true;
117 
118     // web.whatsapp.com completely blocks users with WebKitGTK&#39;s standard user agent.
119     if (baseDomain == &quot;whatsapp.com&quot;)
120         return true;
121 
122     // paypal.com completely blocks users with WebKitGTK&#39;s standard user agent.
123     if (baseDomain == &quot;paypal.com&quot;)
124         return true;
125 
126     // chase.com displays a huge &quot;please update your browser&quot; warning with
127     // WebKitGTK&#39;s standard user agent.
128     if (baseDomain == &quot;chase.com&quot;)
129         return true;
130 
131     // Microsoft Outlook Web App forces users with WebKitGTK&#39;s standard user
132     // agent to use the light version. Earlier versions even block users from
133     // accessing the calendar.
134     if (domain == &quot;outlook.live.com&quot;
135         || domain == &quot;mail.ntu.edu.tw&quot;
136         || domain == &quot;exchange.tu-berlin.de&quot;)
137         return true;
138 
139     // Bank of America shows an unsupported browser warning with WebKitGTK&#39;s
140     // standard user agent.
141     if (baseDomain == &quot;bankofamerica.com&quot;)
142         return true;
143 
144     return false;
145 }
146 
147 static bool urlRequiresLinuxDesktopPlatform(const URL&amp; url)
148 {
149     return isGoogle(url);
150 }
151 
152 UserAgentQuirks UserAgentQuirks::quirksForURL(const URL&amp; url)
153 {
154     ASSERT(!url.isNull());
155 
156     UserAgentQuirks quirks;
157 
158     if (urlRequiresChromeBrowser(url))
159         quirks.add(UserAgentQuirks::NeedsChromeBrowser);
160     else if (urlRequiresFirefoxBrowser(url))
161         quirks.add(UserAgentQuirks::NeedsFirefoxBrowser);
162 
163     if (urlRequiresMacintoshPlatform(url))
164         quirks.add(UserAgentQuirks::NeedsMacintoshPlatform);
165     else if (urlRequiresLinuxDesktopPlatform(url))
166         quirks.add(UserAgentQuirks::NeedsLinuxDesktopPlatform);
167 
168     return quirks;
169 }
170 
171 String UserAgentQuirks::stringForQuirk(UserAgentQuirk quirk)
172 {
173     switch (quirk) {
174     case NeedsChromeBrowser:
175         // Get versions from https://chromium.googlesource.com/chromium/src.git
176         return &quot;Chrome/83.0.4096.4&quot;_s;
177     case NeedsFirefoxBrowser:
178         return &quot;; rv:76.0) Gecko/20100101 Firefox/76.0&quot;_s;
179     case NeedsMacintoshPlatform:
180         return &quot;Macintosh; Intel Mac OS X 10_15&quot;_s;
181     case NeedsLinuxDesktopPlatform:
182         return &quot;X11; Linux x86_64&quot;_s;
183     case NumUserAgentQuirks:
184     default:
185         ASSERT_NOT_REACHED();
186     }
187     return &quot;&quot;_s;
188 }
189 
190 }
    </pre>
  </body>
</html>