<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New modules/javafx.web/src/main/native/Source/WebKitLegacy/Storage/InProcessIDBServer.h</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (C) 2015 Apple Inc. All rights reserved.
  3  *
  4  * Redistribution and use in source and binary forms, with or without
  5  * modification, are permitted provided that the following conditions
  6  * are met:
  7  * 1. Redistributions of source code must retain the above copyright
  8  *    notice, this list of conditions and the following disclaimer.
  9  * 2. Redistributions in binary form must reproduce the above copyright
 10  *    notice, this list of conditions and the following disclaimer in the
 11  *    documentation and/or other materials provided with the distribution.
 12  *
 13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. AND ITS CONTRIBUTORS ``AS IS&#39;&#39;
 14  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
 15  * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 16  * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL APPLE INC. OR ITS CONTRIBUTORS
 17  * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 18  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 19  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 20  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 21  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 22  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF
 23  * THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #pragma once
 27 
 28 #if ENABLE(INDEXED_DATABASE)
 29 
 30 #include &lt;WebCore/IDBConnectionToClient.h&gt;
 31 #include &lt;WebCore/IDBConnectionToServer.h&gt;
 32 #include &lt;WebCore/IDBServer.h&gt;
 33 #include &lt;wtf/RefCounted.h&gt;
 34 #include &lt;wtf/RefPtr.h&gt;
 35 #include &lt;wtf/ThreadSafeRefCounted.h&gt;
 36 
 37 namespace PAL {
 38 class SessionID;
 39 }
 40 
 41 namespace WebCore {
 42 struct ClientOrigin;
 43 class StorageQuotaManager;
 44 class StorageThread;
 45 
 46 namespace IDBClient {
 47 class IDBConnectionToServer;
 48 }
 49 
 50 namespace IDBServer {
 51 class IDBServer;
 52 }
 53 } // namespace WebCore
 54 
 55 class InProcessIDBServer final : public WebCore::IDBClient::IDBConnectionToServerDelegate, public WebCore::IDBServer::IDBConnectionToClientDelegate, public ThreadSafeRefCounted&lt;InProcessIDBServer&gt; {
 56 public:
 57 
 58     WEBCORE_EXPORT static Ref&lt;InProcessIDBServer&gt; create(PAL::SessionID);
 59     WEBCORE_EXPORT static Ref&lt;InProcessIDBServer&gt; create(PAL::SessionID, const String&amp; databaseDirectoryPath);
 60 
 61     WEBCORE_EXPORT virtual ~InProcessIDBServer();
 62 
 63     WebCore::IDBClient::IDBConnectionToServer&amp; connectionToServer() const;
 64     WebCore::IDBServer::IDBConnectionToClient&amp; connectionToClient() const;
 65     WebCore::IDBServer::IDBServer&amp; server() { return *m_server; }
 66 
 67     // IDBConnectionToServer
 68     void deleteDatabase(const WebCore::IDBRequestData&amp;) final;
 69     void openDatabase(const WebCore::IDBRequestData&amp;) final;
 70     void abortTransaction(const WebCore::IDBResourceIdentifier&amp;) final;
 71     void commitTransaction(const WebCore::IDBResourceIdentifier&amp;) final;
 72     void didFinishHandlingVersionChangeTransaction(uint64_t databaseConnectionIdentifier, const WebCore::IDBResourceIdentifier&amp;) final;
 73     void createObjectStore(const WebCore::IDBRequestData&amp;, const WebCore::IDBObjectStoreInfo&amp;) final;
 74     void deleteObjectStore(const WebCore::IDBRequestData&amp;, const String&amp; objectStoreName) final;
 75     void renameObjectStore(const WebCore::IDBRequestData&amp;, uint64_t objectStoreIdentifier, const String&amp; newName) final;
 76     void clearObjectStore(const WebCore::IDBRequestData&amp;, uint64_t objectStoreIdentifier) final;
 77     void createIndex(const WebCore::IDBRequestData&amp;, const WebCore::IDBIndexInfo&amp;) final;
 78     void deleteIndex(const WebCore::IDBRequestData&amp;, uint64_t objectStoreIdentifier, const String&amp; indexName) final;
 79     void renameIndex(const WebCore::IDBRequestData&amp;, uint64_t objectStoreIdentifier, uint64_t indexIdentifier, const String&amp; newName) final;
 80     void putOrAdd(const WebCore::IDBRequestData&amp;, const WebCore::IDBKeyData&amp;, const WebCore::IDBValue&amp;, const WebCore::IndexedDB::ObjectStoreOverwriteMode) final;
 81     void getRecord(const WebCore::IDBRequestData&amp;, const WebCore::IDBGetRecordData&amp;) final;
 82     void getAllRecords(const WebCore::IDBRequestData&amp;, const WebCore::IDBGetAllRecordsData&amp;) final;
 83     void getCount(const WebCore::IDBRequestData&amp;, const WebCore::IDBKeyRangeData&amp;) final;
 84     void deleteRecord(const WebCore::IDBRequestData&amp;, const WebCore::IDBKeyRangeData&amp;) final;
 85     void openCursor(const WebCore::IDBRequestData&amp;, const WebCore::IDBCursorInfo&amp;) final;
 86     void iterateCursor(const WebCore::IDBRequestData&amp;, const WebCore::IDBIterateCursorData&amp;) final;
 87     void establishTransaction(uint64_t databaseConnectionIdentifier, const WebCore::IDBTransactionInfo&amp;) final;
 88     void databaseConnectionPendingClose(uint64_t databaseConnectionIdentifier) final;
 89     void databaseConnectionClosed(uint64_t databaseConnectionIdentifier) final;
 90     void abortOpenAndUpgradeNeeded(uint64_t databaseConnectionIdentifier, const WebCore::IDBResourceIdentifier&amp; transactionIdentifier) final;
 91     void didFireVersionChangeEvent(uint64_t databaseConnectionIdentifier, const WebCore::IDBResourceIdentifier&amp; requestIdentifier, const WebCore::IndexedDB::ConnectionClosedOnBehalfOfServer) final;
 92     void openDBRequestCancelled(const WebCore::IDBRequestData&amp;) final;
 93     void getAllDatabaseNames(const WebCore::SecurityOriginData&amp; mainFrameOrigin, const WebCore::SecurityOriginData&amp; openingOrigin, uint64_t callbackID) final;
 94 
 95     // IDBConnectionToClient
 96     WebCore::IDBConnectionIdentifier identifier() const final;
 97     void didDeleteDatabase(const WebCore::IDBResultData&amp;) final;
 98     void didOpenDatabase(const WebCore::IDBResultData&amp;) final;
 99     void didAbortTransaction(const WebCore::IDBResourceIdentifier&amp; transactionIdentifier, const WebCore::IDBError&amp;) final;
100     void didCommitTransaction(const WebCore::IDBResourceIdentifier&amp; transactionIdentifier, const WebCore::IDBError&amp;) final;
101     void didCreateObjectStore(const WebCore::IDBResultData&amp;) final;
102     void didDeleteObjectStore(const WebCore::IDBResultData&amp;) final;
103     void didRenameObjectStore(const WebCore::IDBResultData&amp;) final;
104     void didClearObjectStore(const WebCore::IDBResultData&amp;) final;
105     void didCreateIndex(const WebCore::IDBResultData&amp;) final;
106     void didDeleteIndex(const WebCore::IDBResultData&amp;) final;
107     void didRenameIndex(const WebCore::IDBResultData&amp;) final;
108     void didPutOrAdd(const WebCore::IDBResultData&amp;) final;
109     void didGetRecord(const WebCore::IDBResultData&amp;) final;
110     void didGetAllRecords(const WebCore::IDBResultData&amp;) final;
111     void didGetCount(const WebCore::IDBResultData&amp;) final;
112     void didDeleteRecord(const WebCore::IDBResultData&amp;) final;
113     void didOpenCursor(const WebCore::IDBResultData&amp;) final;
114     void didIterateCursor(const WebCore::IDBResultData&amp;) final;
115     void fireVersionChangeEvent(WebCore::IDBServer::UniqueIDBDatabaseConnection&amp;, const WebCore::IDBResourceIdentifier&amp; requestIdentifier, uint64_t requestedVersion) final;
116     void didStartTransaction(const WebCore::IDBResourceIdentifier&amp; transactionIdentifier, const WebCore::IDBError&amp;) final;
117     void didCloseFromServer(WebCore::IDBServer::UniqueIDBDatabaseConnection&amp;, const WebCore::IDBError&amp;) final;
118     void notifyOpenDBRequestBlocked(const WebCore::IDBResourceIdentifier&amp; requestIdentifier, uint64_t oldVersion, uint64_t newVersion) final;
119     void didGetAllDatabaseNames(uint64_t callbackID, const Vector&lt;String&gt;&amp; databaseNames) final;
120 
121     void closeAndDeleteDatabasesModifiedSince(WallTime);
122 
123     void dispatchTask(Function&lt;void()&gt;&amp;&amp;);
124     void dispatchTaskReply(Function&lt;void()&gt;&amp;&amp;);
125 
126     WebCore::StorageQuotaManager* quotaManager(const WebCore::ClientOrigin&amp;);
127 
128 private:
129     InProcessIDBServer(PAL::SessionID, const String&amp; databaseDirectoryPath = nullString());
130 
131     std::unique_ptr&lt;WebCore::IDBServer::IDBServer&gt; m_server;
132     RefPtr&lt;WebCore::IDBClient::IDBConnectionToServer&gt; m_connectionToServer;
133     RefPtr&lt;WebCore::IDBServer::IDBConnectionToClient&gt; m_connectionToClient;
134     std::unique_ptr&lt;WebCore::StorageThread&gt; m_thread;
135 
136     HashMap&lt;WebCore::ClientOrigin, RefPtr&lt;WebCore::StorageQuotaManager&gt;&gt; m_quotaManagers;
137 };
138 
139 #endif // ENABLE(INDEXED_DATABASE)
    </pre>
  </body>
</html>