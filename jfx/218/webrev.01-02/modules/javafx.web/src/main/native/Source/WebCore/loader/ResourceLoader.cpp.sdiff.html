<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WebCore/loader/ResourceLoader.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="ResourceLoadStatistics.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="ResourceLoader.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/loader/ResourceLoader.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 42 #include &quot;FrameLoader.h&quot;
 43 #include &quot;FrameLoaderClient.h&quot;
 44 #include &quot;InspectorInstrumentation.h&quot;
 45 #include &quot;LoaderStrategy.h&quot;
 46 #include &quot;Logging.h&quot;
 47 #include &quot;Page.h&quot;
 48 #include &quot;PlatformStrategies.h&quot;
 49 #include &quot;ProgressTracker.h&quot;
 50 #include &quot;ResourceError.h&quot;
 51 #include &quot;ResourceHandle.h&quot;
 52 #include &quot;SecurityOrigin.h&quot;
 53 #include &quot;SharedBuffer.h&quot;
 54 #include &lt;wtf/CompletionHandler.h&gt;
 55 #include &lt;wtf/Ref.h&gt;
 56 
 57 #if ENABLE(CONTENT_EXTENSIONS)
 58 #include &quot;UserContentController.h&quot;
 59 #endif
 60 
 61 #if USE(QUICK_LOOK)

 62 #include &quot;PreviewConverter.h&quot;
<span class="line-removed"> 63 #include &quot;PreviewLoader.h&quot;</span>
 64 #endif
 65 
 66 #undef RELEASE_LOG_IF_ALLOWED
 67 #define RELEASE_LOG_IF_ALLOWED(fmt, ...) RELEASE_LOG_IF(isAlwaysOnLoggingAllowed(), Network, &quot;%p - ResourceLoader::&quot; fmt, this, ##__VA_ARGS__)
 68 
 69 namespace WebCore {
 70 


 71 ResourceLoader::ResourceLoader(Frame&amp; frame, ResourceLoaderOptions options)
 72     : m_frame { &amp;frame }
 73     , m_documentLoader { frame.loader().activeDocumentLoader() }
 74     , m_defersLoading { options.defersLoadingPolicy == DefersLoadingPolicy::AllowDefersLoading &amp;&amp; frame.page()-&gt;defersLoading() }
 75     , m_options { options }
 76 {
 77 }
 78 
 79 ResourceLoader::~ResourceLoader()
 80 {
 81     ASSERT(m_reachedTerminalState);
 82 }
 83 
 84 void ResourceLoader::finishNetworkLoad()
 85 {
 86     platformStrategies()-&gt;loaderStrategy()-&gt;remove(this);
 87 
 88     if (m_handle) {
 89         ASSERT(m_handle-&gt;client() == this);
 90         m_handle-&gt;clearClient();
</pre>
<hr />
<pre>
268 #endif
269     DataURLDecoder::decode(url, scheduleContext, [this, protectedThis = makeRef(*this), url](auto decodeResult) mutable {
270         if (this-&gt;reachedTerminalState())
271             return;
272         if (!decodeResult) {
273             RELEASE_LOG_IF_ALLOWED(&quot;loadDataURL: decoding of data failed (frame = %p, frameLoader = %p, resourceID = %lu)&quot;, frame(), frameLoader(), identifier());
274             protectedThis-&gt;didFail(ResourceError(errorDomainWebKitInternal, 0, url, &quot;Data URL decoding failed&quot;));
275             return;
276         }
277         if (this-&gt;wasCancelled())
278             return;
279         auto&amp; result = decodeResult.value();
280         auto dataSize = result.data ? result.data-&gt;size() : 0;
281 
282         ResourceResponse dataResponse { url, result.mimeType, static_cast&lt;long long&gt;(dataSize), result.charset };
283         dataResponse.setHTTPStatusCode(200);
284         dataResponse.setHTTPStatusText(&quot;OK&quot;_s);
285         dataResponse.setHTTPHeaderField(HTTPHeaderName::ContentType, result.contentType);
286         dataResponse.setSource(ResourceResponse::Source::Network);
287         this-&gt;didReceiveResponse(dataResponse, [this, protectedThis = WTFMove(protectedThis), dataSize, data = result.data.releaseNonNull()]() mutable {
<span class="line-modified">288             if (!this-&gt;reachedTerminalState() &amp;&amp; dataSize)</span>
289                 this-&gt;didReceiveBuffer(WTFMove(data), dataSize, DataPayloadWholeResource);
290 
291             if (!this-&gt;reachedTerminalState()) {
292                 NetworkLoadMetrics emptyMetrics;
293                 this-&gt;didFinishLoading(emptyMetrics);
294             }
295         });
296     });
297 }
298 
299 void ResourceLoader::setDataBufferingPolicy(DataBufferingPolicy dataBufferingPolicy)
300 {
301     m_options.dataBufferingPolicy = dataBufferingPolicy;
302 
303     // Reset any already buffered data
304     if (dataBufferingPolicy == DataBufferingPolicy::DoNotBufferData)
305         m_resourceData = nullptr;
306 }
307 
308 void ResourceLoader::willSwitchToSubstituteResource()
</pre>
<hr />
<pre>
440 {
441     if (!frame || !frame-&gt;page())
442         return;
443 
444     String sourceKey;
445     switch (source) {
446     case ResourceResponse::Source::Network:
447         sourceKey = DiagnosticLoggingKeys::networkKey();
448         break;
449     case ResourceResponse::Source::DiskCache:
450         sourceKey = DiagnosticLoggingKeys::diskCacheKey();
451         break;
452     case ResourceResponse::Source::DiskCacheAfterValidation:
453         sourceKey = DiagnosticLoggingKeys::diskCacheAfterValidationKey();
454         break;
455     case ResourceResponse::Source::ServiceWorker:
456         sourceKey = DiagnosticLoggingKeys::serviceWorkerKey();
457         break;
458     case ResourceResponse::Source::MemoryCache:
459     case ResourceResponse::Source::MemoryCacheAfterValidation:

460     case ResourceResponse::Source::ApplicationCache:

461     case ResourceResponse::Source::Unknown:
462         return;
463     }
464 
465     frame-&gt;page()-&gt;diagnosticLoggingClient().logDiagnosticMessage(DiagnosticLoggingKeys::resourceResponseSourceKey(), sourceKey, ShouldSample::Yes);
466 }
467 
468 bool ResourceLoader::shouldAllowResourceToAskForCredentials() const
469 {
470     return m_canCrossOriginRequestsAskUserForCredentials || m_frame-&gt;tree().top().document()-&gt;securityOrigin().canRequest(m_request.url());
471 }
472 
473 void ResourceLoader::didBlockAuthenticationChallenge()
474 {
475     m_wasAuthenticationChallengeBlocked = true;
476     if (m_options.clientCredentialPolicy == ClientCredentialPolicy::CannotAskClientForCredentials)
477         return;
478     ASSERT(!shouldAllowResourceToAskForCredentials());
479     FrameLoader::reportAuthenticationChallengeBlocked(m_frame.get(), m_request.url(), &quot;it is a cross-origin request&quot;_s);
480 }
</pre>
</td>
<td>
<hr />
<pre>
 42 #include &quot;FrameLoader.h&quot;
 43 #include &quot;FrameLoaderClient.h&quot;
 44 #include &quot;InspectorInstrumentation.h&quot;
 45 #include &quot;LoaderStrategy.h&quot;
 46 #include &quot;Logging.h&quot;
 47 #include &quot;Page.h&quot;
 48 #include &quot;PlatformStrategies.h&quot;
 49 #include &quot;ProgressTracker.h&quot;
 50 #include &quot;ResourceError.h&quot;
 51 #include &quot;ResourceHandle.h&quot;
 52 #include &quot;SecurityOrigin.h&quot;
 53 #include &quot;SharedBuffer.h&quot;
 54 #include &lt;wtf/CompletionHandler.h&gt;
 55 #include &lt;wtf/Ref.h&gt;
 56 
 57 #if ENABLE(CONTENT_EXTENSIONS)
 58 #include &quot;UserContentController.h&quot;
 59 #endif
 60 
 61 #if USE(QUICK_LOOK)
<span class="line-added"> 62 #include &quot;LegacyPreviewLoader.h&quot;</span>
 63 #include &quot;PreviewConverter.h&quot;

 64 #endif
 65 
 66 #undef RELEASE_LOG_IF_ALLOWED
 67 #define RELEASE_LOG_IF_ALLOWED(fmt, ...) RELEASE_LOG_IF(isAlwaysOnLoggingAllowed(), Network, &quot;%p - ResourceLoader::&quot; fmt, this, ##__VA_ARGS__)
 68 
 69 namespace WebCore {
 70 
<span class="line-added"> 71 DEFINE_ALLOCATOR_WITH_HEAP_IDENTIFIER(ResourceLoader);</span>
<span class="line-added"> 72 </span>
 73 ResourceLoader::ResourceLoader(Frame&amp; frame, ResourceLoaderOptions options)
 74     : m_frame { &amp;frame }
 75     , m_documentLoader { frame.loader().activeDocumentLoader() }
 76     , m_defersLoading { options.defersLoadingPolicy == DefersLoadingPolicy::AllowDefersLoading &amp;&amp; frame.page()-&gt;defersLoading() }
 77     , m_options { options }
 78 {
 79 }
 80 
 81 ResourceLoader::~ResourceLoader()
 82 {
 83     ASSERT(m_reachedTerminalState);
 84 }
 85 
 86 void ResourceLoader::finishNetworkLoad()
 87 {
 88     platformStrategies()-&gt;loaderStrategy()-&gt;remove(this);
 89 
 90     if (m_handle) {
 91         ASSERT(m_handle-&gt;client() == this);
 92         m_handle-&gt;clearClient();
</pre>
<hr />
<pre>
270 #endif
271     DataURLDecoder::decode(url, scheduleContext, [this, protectedThis = makeRef(*this), url](auto decodeResult) mutable {
272         if (this-&gt;reachedTerminalState())
273             return;
274         if (!decodeResult) {
275             RELEASE_LOG_IF_ALLOWED(&quot;loadDataURL: decoding of data failed (frame = %p, frameLoader = %p, resourceID = %lu)&quot;, frame(), frameLoader(), identifier());
276             protectedThis-&gt;didFail(ResourceError(errorDomainWebKitInternal, 0, url, &quot;Data URL decoding failed&quot;));
277             return;
278         }
279         if (this-&gt;wasCancelled())
280             return;
281         auto&amp; result = decodeResult.value();
282         auto dataSize = result.data ? result.data-&gt;size() : 0;
283 
284         ResourceResponse dataResponse { url, result.mimeType, static_cast&lt;long long&gt;(dataSize), result.charset };
285         dataResponse.setHTTPStatusCode(200);
286         dataResponse.setHTTPStatusText(&quot;OK&quot;_s);
287         dataResponse.setHTTPHeaderField(HTTPHeaderName::ContentType, result.contentType);
288         dataResponse.setSource(ResourceResponse::Source::Network);
289         this-&gt;didReceiveResponse(dataResponse, [this, protectedThis = WTFMove(protectedThis), dataSize, data = result.data.releaseNonNull()]() mutable {
<span class="line-modified">290             if (!this-&gt;reachedTerminalState() &amp;&amp; dataSize &amp;&amp; m_request.httpMethod() != &quot;HEAD&quot;)</span>
291                 this-&gt;didReceiveBuffer(WTFMove(data), dataSize, DataPayloadWholeResource);
292 
293             if (!this-&gt;reachedTerminalState()) {
294                 NetworkLoadMetrics emptyMetrics;
295                 this-&gt;didFinishLoading(emptyMetrics);
296             }
297         });
298     });
299 }
300 
301 void ResourceLoader::setDataBufferingPolicy(DataBufferingPolicy dataBufferingPolicy)
302 {
303     m_options.dataBufferingPolicy = dataBufferingPolicy;
304 
305     // Reset any already buffered data
306     if (dataBufferingPolicy == DataBufferingPolicy::DoNotBufferData)
307         m_resourceData = nullptr;
308 }
309 
310 void ResourceLoader::willSwitchToSubstituteResource()
</pre>
<hr />
<pre>
442 {
443     if (!frame || !frame-&gt;page())
444         return;
445 
446     String sourceKey;
447     switch (source) {
448     case ResourceResponse::Source::Network:
449         sourceKey = DiagnosticLoggingKeys::networkKey();
450         break;
451     case ResourceResponse::Source::DiskCache:
452         sourceKey = DiagnosticLoggingKeys::diskCacheKey();
453         break;
454     case ResourceResponse::Source::DiskCacheAfterValidation:
455         sourceKey = DiagnosticLoggingKeys::diskCacheAfterValidationKey();
456         break;
457     case ResourceResponse::Source::ServiceWorker:
458         sourceKey = DiagnosticLoggingKeys::serviceWorkerKey();
459         break;
460     case ResourceResponse::Source::MemoryCache:
461     case ResourceResponse::Source::MemoryCacheAfterValidation:
<span class="line-added">462     case ResourceResponse::Source::DOMCache:</span>
463     case ResourceResponse::Source::ApplicationCache:
<span class="line-added">464     case ResourceResponse::Source::InspectorOverride:</span>
465     case ResourceResponse::Source::Unknown:
466         return;
467     }
468 
469     frame-&gt;page()-&gt;diagnosticLoggingClient().logDiagnosticMessage(DiagnosticLoggingKeys::resourceResponseSourceKey(), sourceKey, ShouldSample::Yes);
470 }
471 
472 bool ResourceLoader::shouldAllowResourceToAskForCredentials() const
473 {
474     return m_canCrossOriginRequestsAskUserForCredentials || m_frame-&gt;tree().top().document()-&gt;securityOrigin().canRequest(m_request.url());
475 }
476 
477 void ResourceLoader::didBlockAuthenticationChallenge()
478 {
479     m_wasAuthenticationChallengeBlocked = true;
480     if (m_options.clientCredentialPolicy == ClientCredentialPolicy::CannotAskClientForCredentials)
481         return;
482     ASSERT(!shouldAllowResourceToAskForCredentials());
483     FrameLoader::reportAuthenticationChallengeBlocked(m_frame.get(), m_request.url(), &quot;it is a cross-origin request&quot;_s);
484 }
</pre>
</td>
</tr>
</table>
<center><a href="ResourceLoadStatistics.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="ResourceLoader.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>