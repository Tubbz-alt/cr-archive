<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/JavaScriptCore/runtime/JSFunction.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  *  Copyright (C) 1999-2002 Harri Porten (porten@kde.org)
  3  *  Copyright (C) 2001 Peter Kelly (pmk@post.com)
  4  *  Copyright (C) 2003-2019 Apple Inc. All rights reserved.
  5  *  Copyright (C) 2007 Cameron Zwarich (cwzwarich@uwaterloo.ca)
  6  *  Copyright (C) 2007 Maks Orlovich
  7  *  Copyright (C) 2015 Canon Inc. All rights reserved.
  8  *
  9  *  This library is free software; you can redistribute it and/or
 10  *  modify it under the terms of the GNU Library General Public
 11  *  License as published by the Free Software Foundation; either
 12  *  version 2 of the License, or (at your option) any later version.
 13  *
 14  *  This library is distributed in the hope that it will be useful,
 15  *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 16  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 17  *  Library General Public License for more details.
 18  *
 19  *  You should have received a copy of the GNU Library General Public License
 20  *  along with this library; see the file COPYING.LIB.  If not, write to
 21  *  the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
 22  *  Boston, MA 02110-1301, USA.
 23  *
 24  */
 25 
 26 #include &quot;config.h&quot;
 27 #include &quot;JSFunction.h&quot;
 28 
 29 #include &quot;AsyncGeneratorPrototype.h&quot;
 30 #include &quot;BuiltinNames.h&quot;
 31 #include &quot;CatchScope.h&quot;
 32 #include &quot;ClonedArguments.h&quot;
 33 #include &quot;CodeBlock.h&quot;
 34 #include &quot;CommonIdentifiers.h&quot;
 35 #include &quot;CallFrame.h&quot;
 36 #include &quot;ExceptionHelpers.h&quot;
 37 #include &quot;FunctionPrototype.h&quot;
 38 #include &quot;GeneratorPrototype.h&quot;
 39 #include &quot;GetterSetter.h&quot;
 40 #include &quot;JSArray.h&quot;
 41 #include &quot;JSBoundFunction.h&quot;
 42 #include &quot;JSCInlines.h&quot;
 43 #include &quot;JSFunctionInlines.h&quot;
 44 #include &quot;JSGlobalObject.h&quot;
 45 #include &quot;Interpreter.h&quot;
 46 #include &quot;ObjectConstructor.h&quot;
 47 #include &quot;ObjectPrototype.h&quot;
 48 #include &quot;Parser.h&quot;
 49 #include &quot;PropertyNameArray.h&quot;
 50 #include &quot;StackVisitor.h&quot;
 51 #include &quot;WebAssemblyFunction.h&quot;
 52 
 53 namespace JSC {
 54 
<a name="1" id="anc1"></a><span class="line-modified"> 55 EncodedJSValue JSC_HOST_CALL callHostFunctionAsConstructor(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 56 {
<a name="2" id="anc2"></a><span class="line-modified"> 57     VM&amp; vm = globalObject-&gt;vm();</span>
 58     auto scope = DECLARE_THROW_SCOPE(vm);
<a name="3" id="anc3"></a><span class="line-modified"> 59     return throwVMError(globalObject, scope, createNotAConstructorError(globalObject, callFrame-&gt;jsCallee()));</span>
 60 }
 61 
 62 const ClassInfo JSFunction::s_info = { &quot;Function&quot;, &amp;Base::s_info, nullptr, nullptr, CREATE_METHOD_TABLE(JSFunction) };
 63 const ClassInfo JSStrictFunction::s_info = { &quot;Function&quot;, &amp;Base::s_info, nullptr, nullptr, CREATE_METHOD_TABLE(JSStrictFunction) };
 64 const ClassInfo JSSloppyFunction::s_info = { &quot;Function&quot;, &amp;Base::s_info, nullptr, nullptr, CREATE_METHOD_TABLE(JSSloppyFunction) };
 65 const ClassInfo JSArrowFunction::s_info = { &quot;Function&quot;, &amp;Base::s_info, nullptr, nullptr, CREATE_METHOD_TABLE(JSArrowFunction) };
 66 
 67 bool JSFunction::isHostFunctionNonInline() const
 68 {
 69     return isHostFunction();
 70 }
 71 
 72 Structure* JSFunction::selectStructureForNewFuncExp(JSGlobalObject* globalObject, FunctionExecutable* executable)
 73 {
 74     ASSERT(!executable-&gt;isHostFunction());
 75     bool isBuiltin = executable-&gt;isBuiltinFunction();
 76     if (executable-&gt;isArrowFunction())
 77         return globalObject-&gt;arrowFunctionStructure(isBuiltin);
 78     if (executable-&gt;isStrictMode())
 79         return globalObject-&gt;strictFunctionStructure(isBuiltin);
 80     return globalObject-&gt;sloppyFunctionStructure(isBuiltin);
 81 }
 82 
 83 JSFunction* JSFunction::create(VM&amp; vm, FunctionExecutable* executable, JSScope* scope)
 84 {
 85     return create(vm, executable, scope, selectStructureForNewFuncExp(scope-&gt;globalObject(vm), executable));
 86 }
 87 
 88 JSFunction* JSFunction::create(VM&amp; vm, FunctionExecutable* executable, JSScope* scope, Structure* structure)
 89 {
 90     JSFunction* result = createImpl(vm, executable, scope, structure);
 91     executable-&gt;notifyCreation(vm, result, &quot;Allocating a function&quot;);
 92     return result;
 93 }
 94 
 95 JSFunction* JSFunction::create(VM&amp; vm, JSGlobalObject* globalObject, int length, const String&amp; name, NativeFunction nativeFunction, Intrinsic intrinsic, NativeFunction nativeConstructor, const DOMJIT::Signature* signature)
 96 {
 97     NativeExecutable* executable = vm.getHostFunction(nativeFunction, intrinsic, nativeConstructor, signature, name);
 98     Structure* structure = globalObject-&gt;hostFunctionStructure();
<a name="4" id="anc4"></a><span class="line-modified"> 99     JSFunction* function = new (NotNull, allocateCell&lt;JSFunction&gt;(vm.heap)) JSFunction(vm, executable, globalObject, structure);</span>
100     // Can&#39;t do this during initialization because getHostFunction might do a GC allocation.
101     function-&gt;finishCreation(vm, executable, length, name);
102     return function;
103 }
104 
105 JSFunction* JSFunction::createFunctionThatMasqueradesAsUndefined(VM&amp; vm, JSGlobalObject* globalObject, int length, const String&amp; name, NativeFunction nativeFunction, Intrinsic intrinsic, NativeFunction nativeConstructor, const DOMJIT::Signature* signature)
106 {
107     NativeExecutable* executable = vm.getHostFunction(nativeFunction, intrinsic, nativeConstructor, signature, name);
108     Structure* structure = Structure::create(vm, globalObject, globalObject-&gt;objectPrototype(), TypeInfo(JSFunctionType, JSFunction::StructureFlags | MasqueradesAsUndefined), JSFunction::info());
109     globalObject-&gt;masqueradesAsUndefinedWatchpoint()-&gt;fireAll(globalObject-&gt;vm(), &quot;Allocated masquerading object&quot;);
<a name="5" id="anc5"></a><span class="line-modified">110     JSFunction* function = new (NotNull, allocateCell&lt;JSFunction&gt;(vm.heap)) JSFunction(vm, executable, globalObject, structure);</span>
111     function-&gt;finishCreation(vm, executable, length, name);
112     return function;
113 }
114 
<a name="6" id="anc6"></a><span class="line-modified">115 JSFunction::JSFunction(VM&amp; vm, NativeExecutable* executable, JSGlobalObject* globalObject, Structure* structure)</span>
116     : Base(vm, globalObject, structure)
<a name="7" id="anc7"></a><span class="line-modified">117     , m_executableOrRareData(bitwise_cast&lt;uintptr_t&gt;(executable))</span>
118 {
119     assertTypeInfoFlagInvariants();
<a name="8" id="anc8"></a><span class="line-added">120     ASSERT(structure-&gt;globalObject() == globalObject);</span>
121 }
122 
123 
124 void JSFunction::finishCreation(VM&amp; vm)
125 {
126     Base::finishCreation(vm);
127     ASSERT(jsDynamicCast&lt;JSFunction*&gt;(vm, this));
128     ASSERT(type() == JSFunctionType);
<a name="9" id="anc9"></a><span class="line-modified">129     ASSERT(methodTable(vm)-&gt;getConstructData == &amp;JSFunction::getConstructData);</span>
<span class="line-modified">130     ASSERT(methodTable(vm)-&gt;getCallData == &amp;JSFunction::getCallData);</span>


131 }
132 
<a name="10" id="anc10"></a><span class="line-modified">133 void JSFunction::finishCreation(VM&amp; vm, NativeExecutable*, int length, const String&amp; name)</span>
134 {
135     Base::finishCreation(vm);
136     ASSERT(inherits(vm, info()));
137     ASSERT(type() == JSFunctionType);
<a name="11" id="anc11"></a><span class="line-modified">138     ASSERT(methodTable(vm)-&gt;getConstructData == &amp;JSFunction::getConstructData);</span>
<span class="line-modified">139     ASSERT(methodTable(vm)-&gt;getCallData == &amp;JSFunction::getCallData);</span>
<span class="line-added">140 </span>
<span class="line-added">141     // Some NativeExecutable functions, like JSBoundFunction, decide to lazily allocate their name string / length.</span>
<span class="line-added">142     if (this-&gt;inherits&lt;JSBoundFunction&gt;(vm))</span>
<span class="line-added">143         return;</span>
<span class="line-added">144 </span>
145     if (!name.isNull())
146         putDirect(vm, vm.propertyNames-&gt;name, jsString(vm, name), PropertyAttribute::ReadOnly | PropertyAttribute::DontEnum);
147     putDirect(vm, vm.propertyNames-&gt;length, jsNumber(length), PropertyAttribute::ReadOnly | PropertyAttribute::DontEnum);
148 }
149 
150 FunctionRareData* JSFunction::allocateRareData(VM&amp; vm)
151 {
<a name="12" id="anc12"></a><span class="line-modified">152     uintptr_t executableOrRareData = m_executableOrRareData;</span>
<span class="line-modified">153     ASSERT(!(executableOrRareData &amp; rareDataTag));</span>
<span class="line-added">154     FunctionRareData* rareData = FunctionRareData::create(vm, bitwise_cast&lt;ExecutableBase*&gt;(executableOrRareData));</span>
<span class="line-added">155     executableOrRareData = bitwise_cast&lt;uintptr_t&gt;(rareData) | rareDataTag;</span>
156 
157     // A DFG compilation thread may be trying to read the rare data
158     // We want to ensure that it sees it properly allocated
159     WTF::storeStoreFence();
160 
<a name="13" id="anc13"></a><span class="line-modified">161     m_executableOrRareData = executableOrRareData;</span>
<span class="line-modified">162     vm.heap.writeBarrier(this, rareData);</span>
<span class="line-added">163 </span>
<span class="line-added">164     return rareData;</span>
165 }
166 
<a name="14" id="anc14"></a><span class="line-modified">167 JSObject* JSFunction::prototypeForConstruction(VM&amp; vm, JSGlobalObject* globalObject)</span>
168 {
169     // This code assumes getting the prototype is not effectful. That&#39;s only
170     // true when we can use the allocation profile.
171     ASSERT(canUseAllocationProfile());
172     auto scope = DECLARE_CATCH_SCOPE(vm);
<a name="15" id="anc15"></a><span class="line-modified">173     JSValue prototype = get(globalObject, vm.propertyNames-&gt;prototype);</span>
174     scope.releaseAssertNoException();
175     if (LIKELY(prototype.isObject()))
176         return asObject(prototype);
177 
<a name="16" id="anc16"></a><span class="line-modified">178     JSGlobalObject* thisGlobalObject = this-&gt;globalObject();</span>
179     if (!isHostOrBuiltinFunction()) {
180         // https://tc39.github.io/ecma262/#sec-generator-function-definitions-runtime-semantics-evaluatebody
181         if (isGeneratorWrapperParseMode(jsExecutable()-&gt;parseMode()))
<a name="17" id="anc17"></a><span class="line-modified">182             return thisGlobalObject-&gt;generatorPrototype();</span>
183 
184         // https://tc39.github.io/ecma262/#sec-asyncgenerator-definitions-evaluatebody
185         if (isAsyncGeneratorWrapperParseMode(jsExecutable()-&gt;parseMode()))
<a name="18" id="anc18"></a><span class="line-modified">186             return thisGlobalObject-&gt;asyncGeneratorPrototype();</span>
187     }
<a name="19" id="anc19"></a><span class="line-modified">188     return thisGlobalObject-&gt;objectPrototype();</span>
189 }
190 
<a name="20" id="anc20"></a><span class="line-modified">191 FunctionRareData* JSFunction::allocateAndInitializeRareData(JSGlobalObject* globalObject, size_t inlineCapacity)</span>
192 {
<a name="21" id="anc21"></a><span class="line-modified">193     uintptr_t executableOrRareData = m_executableOrRareData;</span>
<span class="line-added">194     ASSERT(!(executableOrRareData &amp; rareDataTag));</span>
195     ASSERT(canUseAllocationProfile());
<a name="22" id="anc22"></a><span class="line-modified">196     VM&amp; vm = globalObject-&gt;vm();</span>
<span class="line-modified">197     JSObject* prototype = prototypeForConstruction(vm, globalObject);</span>
<span class="line-modified">198     FunctionRareData* rareData = FunctionRareData::create(vm, bitwise_cast&lt;ExecutableBase*&gt;(executableOrRareData));</span>
<span class="line-modified">199     rareData-&gt;initializeObjectAllocationProfile(vm, this-&gt;globalObject(), prototype, inlineCapacity, this);</span>
<span class="line-added">200     executableOrRareData = bitwise_cast&lt;uintptr_t&gt;(rareData) | rareDataTag;</span>
201 
202     // A DFG compilation thread may be trying to read the rare data
203     // We want to ensure that it sees it properly allocated
204     WTF::storeStoreFence();
205 
<a name="23" id="anc23"></a><span class="line-modified">206     m_executableOrRareData = executableOrRareData;</span>
<span class="line-modified">207     vm.heap.writeBarrier(this, rareData);</span>
<span class="line-added">208 </span>
<span class="line-added">209     return rareData;</span>
210 }
211 
<a name="24" id="anc24"></a><span class="line-modified">212 FunctionRareData* JSFunction::initializeRareData(JSGlobalObject* globalObject, size_t inlineCapacity)</span>
213 {
<a name="25" id="anc25"></a><span class="line-modified">214     uintptr_t executableOrRareData = m_executableOrRareData;</span>
<span class="line-added">215     ASSERT(executableOrRareData &amp; rareDataTag);</span>
216     ASSERT(canUseAllocationProfile());
<a name="26" id="anc26"></a><span class="line-modified">217     VM&amp; vm = globalObject-&gt;vm();</span>
<span class="line-modified">218     JSObject* prototype = prototypeForConstruction(vm, globalObject);</span>
<span class="line-modified">219     FunctionRareData* rareData = bitwise_cast&lt;FunctionRareData*&gt;(executableOrRareData &amp; ~rareDataTag);</span>
<span class="line-modified">220     rareData-&gt;initializeObjectAllocationProfile(vm, this-&gt;globalObject(), prototype, inlineCapacity, this);</span>
<span class="line-added">221     return rareData;</span>
222 }
223 
224 String JSFunction::name(VM&amp; vm)
225 {
226     if (isHostFunction()) {
<a name="27" id="anc27"></a><span class="line-added">227         if (this-&gt;inherits&lt;JSBoundFunction&gt;(vm))</span>
<span class="line-added">228             return jsCast&lt;JSBoundFunction*&gt;(this)-&gt;nameString();</span>
229         NativeExecutable* executable = jsCast&lt;NativeExecutable*&gt;(this-&gt;executable());
230         return executable-&gt;name();
231     }
232     const Identifier identifier = jsExecutable()-&gt;name();
233     if (identifier == vm.propertyNames-&gt;builtinNames().starDefaultPrivateName())
234         return emptyString();
235     return identifier.string();
236 }
237 
238 String JSFunction::displayName(VM&amp; vm)
239 {
240     JSValue displayName = getDirect(vm, vm.propertyNames-&gt;displayName);
241 
242     if (displayName &amp;&amp; isJSString(displayName))
243         return asString(displayName)-&gt;tryGetValue();
244 
245     return String();
246 }
247 
248 const String JSFunction::calculatedDisplayName(VM&amp; vm)
249 {
250     const String explicitName = displayName(vm);
251 
252     if (!explicitName.isEmpty())
253         return explicitName;
254 
255     const String actualName = name(vm);
256     if (!actualName.isEmpty() || isHostOrBuiltinFunction())
257         return actualName;
258 
259     return jsExecutable()-&gt;ecmaName().string();
260 }
261 
262 const SourceCode* JSFunction::sourceCode() const
263 {
264     if (isHostOrBuiltinFunction())
265         return 0;
266     return &amp;jsExecutable()-&gt;source();
267 }
268 
269 void JSFunction::visitChildren(JSCell* cell, SlotVisitor&amp; visitor)
270 {
271     JSFunction* thisObject = jsCast&lt;JSFunction*&gt;(cell);
272     ASSERT_GC_OBJECT_INHERITS(thisObject, info());
273     Base::visitChildren(thisObject, visitor);
274 
<a name="28" id="anc28"></a><span class="line-modified">275     visitor.appendUnbarriered(bitwise_cast&lt;JSCell*&gt;(bitwise_cast&lt;uintptr_t&gt;(thisObject-&gt;m_executableOrRareData) &amp; ~rareDataTag));</span>

276 }
277 
278 CallType JSFunction::getCallData(JSCell* cell, CallData&amp; callData)
279 {
280     JSFunction* thisObject = jsCast&lt;JSFunction*&gt;(cell);
281     if (thisObject-&gt;isHostFunction()) {
282         callData.native.function = thisObject-&gt;nativeFunction();
283         return CallType::Host;
284     }
285     callData.js.functionExecutable = thisObject-&gt;jsExecutable();
286     callData.js.scope = thisObject-&gt;scope();
287     return CallType::JS;
288 }
289 
290 class RetrieveArgumentsFunctor {
291 public:
<a name="29" id="anc29"></a><span class="line-modified">292     RetrieveArgumentsFunctor(VM&amp; vm, JSFunction* functionObj)</span>
<span class="line-modified">293         : m_vm(vm)</span>
<span class="line-added">294         , m_targetCallee(functionObj)</span>
295         , m_result(jsNull())
296     {
297     }
298 
299     JSValue result() const { return m_result; }
300 
301     StackVisitor::Status operator()(StackVisitor&amp; visitor) const
302     {
303         if (!visitor-&gt;callee().isCell())
304             return StackVisitor::Continue;
305 
306         JSCell* callee = visitor-&gt;callee().asCell();
307         if (callee != m_targetCallee)
308             return StackVisitor::Continue;
309 
<a name="30" id="anc30"></a><span class="line-modified">310         m_result = JSValue(visitor-&gt;createArguments(m_vm));</span>
311         return StackVisitor::Done;
312     }
313 
314 private:
<a name="31" id="anc31"></a><span class="line-added">315     VM&amp; m_vm;</span>
316     JSObject* m_targetCallee;
317     mutable JSValue m_result;
318 };
319 
<a name="32" id="anc32"></a><span class="line-modified">320 static JSValue retrieveArguments(VM&amp; vm, CallFrame* callFrame, JSFunction* functionObj)</span>
321 {
<a name="33" id="anc33"></a><span class="line-modified">322     RetrieveArgumentsFunctor functor(vm, functionObj);</span>
<span class="line-modified">323     if (callFrame)</span>
<span class="line-added">324         callFrame-&gt;iterate(vm, functor);</span>
325     return functor.result();
326 }
327 
<a name="34" id="anc34"></a><span class="line-modified">328 EncodedJSValue JSFunction::argumentsGetter(JSGlobalObject* globalObject, EncodedJSValue thisValue, PropertyName)</span>
329 {
<a name="35" id="anc35"></a><span class="line-added">330     VM&amp; vm = globalObject-&gt;vm();</span>
331     JSFunction* thisObj = jsCast&lt;JSFunction*&gt;(JSValue::decode(thisValue));
332     ASSERT(!thisObj-&gt;isHostFunction());
333 
<a name="36" id="anc36"></a><span class="line-modified">334     return JSValue::encode(retrieveArguments(vm, vm.topCallFrame, thisObj));</span>
335 }
336 
337 class RetrieveCallerFunctionFunctor {
338 public:
339     RetrieveCallerFunctionFunctor(JSFunction* functionObj)
340         : m_targetCallee(functionObj)
341         , m_hasFoundFrame(false)
342         , m_hasSkippedToCallerFrame(false)
343         , m_result(jsNull())
344     {
345     }
346 
347     JSValue result() const { return m_result; }
348 
349     StackVisitor::Status operator()(StackVisitor&amp; visitor) const
350     {
351         if (!visitor-&gt;callee().isCell())
352             return StackVisitor::Continue;
353 
354         JSCell* callee = visitor-&gt;callee().asCell();
355 
356         if (callee &amp;&amp; callee-&gt;inherits&lt;JSBoundFunction&gt;(callee-&gt;vm()))
357             return StackVisitor::Continue;
358 
359         if (!m_hasFoundFrame &amp;&amp; (callee != m_targetCallee))
360             return StackVisitor::Continue;
361 
362         m_hasFoundFrame = true;
363         if (!m_hasSkippedToCallerFrame) {
364             m_hasSkippedToCallerFrame = true;
365             return StackVisitor::Continue;
366         }
367 
368         if (callee)
369             m_result = callee;
370         return StackVisitor::Done;
371     }
372 
373 private:
374     JSObject* m_targetCallee;
375     mutable bool m_hasFoundFrame;
376     mutable bool m_hasSkippedToCallerFrame;
377     mutable JSValue m_result;
378 };
379 
<a name="37" id="anc37"></a><span class="line-modified">380 static JSValue retrieveCallerFunction(VM&amp; vm, CallFrame* callFrame, JSFunction* functionObj)</span>
381 {
382     RetrieveCallerFunctionFunctor functor(functionObj);
<a name="38" id="anc38"></a><span class="line-modified">383     if (callFrame)</span>
<span class="line-added">384         callFrame-&gt;iterate(vm, functor);</span>
385     return functor.result();
386 }
387 
<a name="39" id="anc39"></a><span class="line-modified">388 EncodedJSValue JSFunction::callerGetter(JSGlobalObject* globalObject, EncodedJSValue thisValue, PropertyName)</span>
389 {
<a name="40" id="anc40"></a><span class="line-modified">390     VM&amp; vm = globalObject-&gt;vm();</span>
391     auto scope = DECLARE_THROW_SCOPE(vm);
392 
393     JSFunction* thisObj = jsCast&lt;JSFunction*&gt;(JSValue::decode(thisValue));
394     ASSERT(!thisObj-&gt;isHostFunction());
<a name="41" id="anc41"></a><span class="line-modified">395     JSValue caller = retrieveCallerFunction(vm, vm.topCallFrame, thisObj);</span>
396 
397     // See ES5.1 15.3.5.4 - Function.caller may not be used to retrieve a strict caller.
398     if (!caller.isObject() || !asObject(caller)-&gt;inherits&lt;JSFunction&gt;(vm)) {
399         // It isn&#39;t a JSFunction, but if it is a JSCallee from a program or eval call or an internal constructor, return null.
400         if (jsDynamicCast&lt;JSCallee*&gt;(vm, caller) || jsDynamicCast&lt;InternalFunction*&gt;(vm, caller))
401             return JSValue::encode(jsNull());
402         return JSValue::encode(caller);
403     }
404     JSFunction* function = jsCast&lt;JSFunction*&gt;(caller);
405 
406     // Firefox returns null for native code callers, so we match that behavior.
407     if (function-&gt;isHostOrBuiltinFunction())
408         return JSValue::encode(jsNull());
409     SourceParseMode parseMode = function-&gt;jsExecutable()-&gt;parseMode();
410     switch (parseMode) {
411     case SourceParseMode::GeneratorBodyMode:
412     case SourceParseMode::AsyncGeneratorBodyMode:
<a name="42" id="anc42"></a><span class="line-modified">413         return JSValue::encode(throwTypeError(globalObject, scope, &quot;Function.caller used to retrieve generator body&quot;_s));</span>
414     case SourceParseMode::AsyncFunctionBodyMode:
415     case SourceParseMode::AsyncArrowFunctionBodyMode:
<a name="43" id="anc43"></a><span class="line-modified">416         return JSValue::encode(throwTypeError(globalObject, scope, &quot;Function.caller used to retrieve async function body&quot;_s));</span>
417     case SourceParseMode::NormalFunctionMode:
418     case SourceParseMode::GeneratorWrapperFunctionMode:
419     case SourceParseMode::GetterMode:
420     case SourceParseMode::SetterMode:
421     case SourceParseMode::MethodMode:
422     case SourceParseMode::ArrowFunctionMode:
423     case SourceParseMode::AsyncFunctionMode:
424     case SourceParseMode::AsyncMethodMode:
425     case SourceParseMode::AsyncArrowFunctionMode:
426     case SourceParseMode::ProgramMode:
427     case SourceParseMode::ModuleAnalyzeMode:
428     case SourceParseMode::ModuleEvaluateMode:
429     case SourceParseMode::AsyncGeneratorWrapperFunctionMode:
430     case SourceParseMode::AsyncGeneratorWrapperMethodMode:
431     case SourceParseMode::GeneratorWrapperMethodMode:
<a name="44" id="anc44"></a><span class="line-added">432     case SourceParseMode::InstanceFieldInitializerMode:</span>
433         if (!function-&gt;jsExecutable()-&gt;isStrictMode())
434             return JSValue::encode(caller);
<a name="45" id="anc45"></a><span class="line-modified">435         return JSValue::encode(throwTypeError(globalObject, scope, &quot;Function.caller used to retrieve strict caller&quot;_s));</span>
436     }
437     RELEASE_ASSERT_NOT_REACHED();
438 }
439 
<a name="46" id="anc46"></a><span class="line-modified">440 bool JSFunction::getOwnPropertySlot(JSObject* object, JSGlobalObject* globalObject, PropertyName propertyName, PropertySlot&amp; slot)</span>
441 {
<a name="47" id="anc47"></a><span class="line-modified">442     VM&amp; vm = globalObject-&gt;vm();</span>
<span class="line-added">443     auto scope = DECLARE_THROW_SCOPE(vm);</span>
<span class="line-added">444 </span>
445     JSFunction* thisObject = jsCast&lt;JSFunction*&gt;(object);
446     if (thisObject-&gt;isHostOrBuiltinFunction()) {
<a name="48" id="anc48"></a><span class="line-modified">447         thisObject-&gt;reifyLazyPropertyForHostOrBuiltinIfNeeded(vm, globalObject, propertyName);</span>
<span class="line-modified">448         RETURN_IF_EXCEPTION(scope, false);</span>
<span class="line-added">449         RELEASE_AND_RETURN(scope, Base::getOwnPropertySlot(thisObject, globalObject, propertyName, slot));</span>
450     }
451 
452     if (propertyName == vm.propertyNames-&gt;prototype &amp;&amp; thisObject-&gt;jsExecutable()-&gt;hasPrototypeProperty() &amp;&amp; !thisObject-&gt;jsExecutable()-&gt;isClassConstructorFunction()) {
453         // NOTE: class constructors define the prototype property in bytecode using
454         // defineOwnProperty, which ends up calling into this code (see our defineOwnProperty
455         // implementation below). The bytecode will end up doing the proper definition
456         // with the property being non-writable/non-configurable. However, we must ignore
457         // the initial materialization of the property so that the defineOwnProperty call
458         // from bytecode succeeds. Otherwise, the materialization here would prevent the
459         // defineOwnProperty from being able to overwrite the property.
460         unsigned attributes;
461         PropertyOffset offset = thisObject-&gt;getDirectOffset(vm, propertyName, attributes);
462         if (!isValidOffset(offset)) {
463             JSObject* prototype = nullptr;
464             if (isGeneratorWrapperParseMode(thisObject-&gt;jsExecutable()-&gt;parseMode())) {
465                 // Unlike function instances, the object that is the value of the a GeneratorFunction&#39;s prototype
466                 // property does not have a constructor property whose value is the GeneratorFunction instance.
467                 // https://tc39.github.io/ecma262/#sec-generatorfunction-instances-prototype
<a name="49" id="anc49"></a><span class="line-modified">468                 prototype = constructEmptyObject(globalObject, thisObject-&gt;globalObject()-&gt;generatorPrototype());</span>
469             } else if (isAsyncGeneratorWrapperParseMode(thisObject-&gt;jsExecutable()-&gt;parseMode()))
<a name="50" id="anc50"></a><span class="line-modified">470                 prototype = constructEmptyObject(globalObject, thisObject-&gt;globalObject()-&gt;asyncGeneratorPrototype());</span>
471             else {
<a name="51" id="anc51"></a><span class="line-modified">472                 prototype = constructEmptyObject(globalObject);</span>
473                 prototype-&gt;putDirect(vm, vm.propertyNames-&gt;constructor, thisObject, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum));
474             }
475 
476             thisObject-&gt;putDirect(vm, vm.propertyNames-&gt;prototype, prototype, PropertyAttribute::DontDelete | PropertyAttribute::DontEnum);
477             offset = thisObject-&gt;getDirectOffset(vm, vm.propertyNames-&gt;prototype, attributes);
478             ASSERT(isValidOffset(offset));
479         }
480         slot.setValue(thisObject, attributes, thisObject-&gt;getDirect(offset), offset);
481     }
482 
483     if (propertyName == vm.propertyNames-&gt;arguments) {
484         if (!thisObject-&gt;jsExecutable()-&gt;hasCallerAndArgumentsProperties())
<a name="52" id="anc52"></a><span class="line-modified">485             RELEASE_AND_RETURN(scope, Base::getOwnPropertySlot(thisObject, globalObject, propertyName, slot));</span>
486 
487         slot.setCacheableCustom(thisObject, PropertyAttribute::ReadOnly | PropertyAttribute::DontEnum | PropertyAttribute::DontDelete, argumentsGetter);
488         return true;
489 
490     } else if (propertyName == vm.propertyNames-&gt;caller) {
491         if (!thisObject-&gt;jsExecutable()-&gt;hasCallerAndArgumentsProperties())
<a name="53" id="anc53"></a><span class="line-modified">492             RELEASE_AND_RETURN(scope, Base::getOwnPropertySlot(thisObject, globalObject, propertyName, slot));</span>
493 
494         slot.setCacheableCustom(thisObject, PropertyAttribute::ReadOnly | PropertyAttribute::DontEnum | PropertyAttribute::DontDelete, callerGetter);
495         return true;
496     }
497 
<a name="54" id="anc54"></a><span class="line-modified">498     thisObject-&gt;reifyLazyPropertyIfNeeded(vm, globalObject, propertyName);</span>
<span class="line-added">499     RETURN_IF_EXCEPTION(scope, false);</span>
500 
<a name="55" id="anc55"></a><span class="line-modified">501     RELEASE_AND_RETURN(scope, Base::getOwnPropertySlot(thisObject, globalObject, propertyName, slot));</span>
502 }
503 
<a name="56" id="anc56"></a><span class="line-modified">504 void JSFunction::getOwnNonIndexPropertyNames(JSObject* object, JSGlobalObject* globalObject, PropertyNameArray&amp; propertyNames, EnumerationMode mode)</span>
505 {
506     JSFunction* thisObject = jsCast&lt;JSFunction*&gt;(object);
<a name="57" id="anc57"></a><span class="line-modified">507     VM&amp; vm = globalObject-&gt;vm();</span>
<span class="line-added">508     auto scope = DECLARE_THROW_SCOPE(vm);</span>
<span class="line-added">509 </span>
510     if (mode.includeDontEnumProperties()) {
511         if (!thisObject-&gt;isHostOrBuiltinFunction()) {
512             // Make sure prototype has been reified.
513             PropertySlot slot(thisObject, PropertySlot::InternalMethodType::VMInquiry);
<a name="58" id="anc58"></a><span class="line-modified">514             thisObject-&gt;methodTable(vm)-&gt;getOwnPropertySlot(thisObject, globalObject, vm.propertyNames-&gt;prototype, slot);</span>
<span class="line-added">515             RETURN_IF_EXCEPTION(scope, void());</span>
516 
517             if (thisObject-&gt;jsExecutable()-&gt;hasCallerAndArgumentsProperties()) {
518                 propertyNames.add(vm.propertyNames-&gt;arguments);
519                 propertyNames.add(vm.propertyNames-&gt;caller);
520             }
521             if (!thisObject-&gt;hasReifiedLength())
522                 propertyNames.add(vm.propertyNames-&gt;length);
523             if (!thisObject-&gt;hasReifiedName())
524                 propertyNames.add(vm.propertyNames-&gt;name);
525         } else {
<a name="59" id="anc59"></a><span class="line-modified">526             if (thisObject-&gt;isBuiltinFunction() || thisObject-&gt;inherits&lt;JSBoundFunction&gt;(vm)) {</span>
<span class="line-modified">527                 if (!thisObject-&gt;hasReifiedLength())</span>
<span class="line-modified">528                     propertyNames.add(vm.propertyNames-&gt;length);</span>
<span class="line-modified">529                 if (!thisObject-&gt;hasReifiedName())</span>
<span class="line-added">530                     propertyNames.add(vm.propertyNames-&gt;name);</span>
<span class="line-added">531             }</span>
532         }
533     }
<a name="60" id="anc60"></a><span class="line-modified">534     RELEASE_AND_RETURN(scope, Base::getOwnNonIndexPropertyNames(thisObject, globalObject, propertyNames, mode));</span>
535 }
536 
<a name="61" id="anc61"></a><span class="line-modified">537 bool JSFunction::put(JSCell* cell, JSGlobalObject* globalObject, PropertyName propertyName, JSValue value, PutPropertySlot&amp; slot)</span>
538 {
<a name="62" id="anc62"></a><span class="line-modified">539     VM&amp; vm = globalObject-&gt;vm();</span>
540     auto scope = DECLARE_THROW_SCOPE(vm);
541 
542     JSFunction* thisObject = jsCast&lt;JSFunction*&gt;(cell);
543 
<a name="63" id="anc63"></a><span class="line-added">544     if (propertyName == vm.propertyNames-&gt;length || propertyName == vm.propertyNames-&gt;name) {</span>
<span class="line-added">545         FunctionRareData* rareData = thisObject-&gt;ensureRareData(vm);</span>
<span class="line-added">546         if (propertyName == vm.propertyNames-&gt;length)</span>
<span class="line-added">547             rareData-&gt;setHasModifiedLength();</span>
<span class="line-added">548         else</span>
<span class="line-added">549             rareData-&gt;setHasModifiedName();</span>
<span class="line-added">550     }</span>
<span class="line-added">551 </span>
552     if (UNLIKELY(isThisValueAltered(slot, thisObject)))
<a name="64" id="anc64"></a><span class="line-modified">553         RELEASE_AND_RETURN(scope, ordinarySetSlow(globalObject, thisObject, propertyName, value, slot.thisValue(), slot.isStrictMode()));</span>
554 
555 
556     if (thisObject-&gt;isHostOrBuiltinFunction()) {
<a name="65" id="anc65"></a><span class="line-modified">557         PropertyStatus propertyType = thisObject-&gt;reifyLazyPropertyForHostOrBuiltinIfNeeded(vm, globalObject, propertyName);</span>
<span class="line-added">558         RETURN_IF_EXCEPTION(scope, false);</span>
559         if (isLazy(propertyType))
560             slot.disableCaching();
<a name="66" id="anc66"></a><span class="line-modified">561         RELEASE_AND_RETURN(scope, Base::put(thisObject, globalObject, propertyName, value, slot));</span>
562     }
563 
564     if (propertyName == vm.propertyNames-&gt;prototype) {
565         slot.disableCaching();
566         // Make sure prototype has been reified, such that it can only be overwritten
567         // following the rules set out in ECMA-262 8.12.9.
568         PropertySlot getSlot(thisObject, PropertySlot::InternalMethodType::VMInquiry);
<a name="67" id="anc67"></a><span class="line-modified">569         thisObject-&gt;methodTable(vm)-&gt;getOwnPropertySlot(thisObject, globalObject, propertyName, getSlot);</span>
<span class="line-modified">570         RETURN_IF_EXCEPTION(scope, false);</span>
<span class="line-modified">571         if (FunctionRareData* rareData = thisObject-&gt;rareData())</span>
<span class="line-modified">572             rareData-&gt;clear(&quot;Store to prototype property of a function&quot;);</span>
<span class="line-added">573         RELEASE_AND_RETURN(scope, Base::put(thisObject, globalObject, propertyName, value, slot));</span>
574     }
575 
576     if (propertyName == vm.propertyNames-&gt;arguments || propertyName == vm.propertyNames-&gt;caller) {
577         if (!thisObject-&gt;jsExecutable()-&gt;hasCallerAndArgumentsProperties())
<a name="68" id="anc68"></a><span class="line-modified">578             RELEASE_AND_RETURN(scope, Base::put(thisObject, globalObject, propertyName, value, slot));</span>
579 
580         slot.disableCaching();
<a name="69" id="anc69"></a><span class="line-modified">581         return typeError(globalObject, scope, slot.isStrictMode(), ReadonlyPropertyWriteError);</span>
582     }
<a name="70" id="anc70"></a><span class="line-modified">583     PropertyStatus propertyType = thisObject-&gt;reifyLazyPropertyIfNeeded(vm, globalObject, propertyName);</span>
584     if (isLazy(propertyType))
585         slot.disableCaching();
<a name="71" id="anc71"></a><span class="line-modified">586     RELEASE_AND_RETURN(scope, Base::put(thisObject, globalObject, propertyName, value, slot));</span>
587 }
588 
<a name="72" id="anc72"></a><span class="line-modified">589 bool JSFunction::deleteProperty(JSCell* cell, JSGlobalObject* globalObject, PropertyName propertyName)</span>
590 {
<a name="73" id="anc73"></a><span class="line-modified">591     VM&amp; vm = globalObject-&gt;vm();</span>
<span class="line-added">592     auto scope = DECLARE_THROW_SCOPE(vm);</span>
593     JSFunction* thisObject = jsCast&lt;JSFunction*&gt;(cell);
<a name="74" id="anc74"></a><span class="line-modified">594 </span>
<span class="line-modified">595     if (propertyName == vm.propertyNames-&gt;length || propertyName == vm.propertyNames-&gt;name) {</span>
<span class="line-modified">596         FunctionRareData* rareData = thisObject-&gt;ensureRareData(vm);</span>
<span class="line-added">597         if (propertyName == vm.propertyNames-&gt;length)</span>
<span class="line-added">598             rareData-&gt;setHasModifiedLength();</span>
<span class="line-added">599         else</span>
<span class="line-added">600             rareData-&gt;setHasModifiedName();</span>
<span class="line-added">601     }</span>
<span class="line-added">602 </span>
<span class="line-added">603     if (thisObject-&gt;isHostOrBuiltinFunction()) {</span>
<span class="line-added">604         thisObject-&gt;reifyLazyPropertyForHostOrBuiltinIfNeeded(vm, globalObject, propertyName);</span>
<span class="line-added">605         RETURN_IF_EXCEPTION(scope, false);</span>
<span class="line-added">606     } else if (vm.deletePropertyMode() != VM::DeletePropertyMode::IgnoreConfigurable) {</span>
607         // For non-host functions, don&#39;t let these properties by deleted - except by DefineOwnProperty.
608         FunctionExecutable* executable = thisObject-&gt;jsExecutable();
609 
610         if ((propertyName == vm.propertyNames-&gt;caller || propertyName == vm.propertyNames-&gt;arguments) &amp;&amp; executable-&gt;hasCallerAndArgumentsProperties())
611             return false;
612 
613         if (propertyName == vm.propertyNames-&gt;prototype &amp;&amp; !executable-&gt;isArrowFunction())
614             return false;
615 
<a name="75" id="anc75"></a><span class="line-modified">616         thisObject-&gt;reifyLazyPropertyIfNeeded(vm, globalObject, propertyName);</span>
<span class="line-added">617         RETURN_IF_EXCEPTION(scope, false);</span>
618     }
619 
<a name="76" id="anc76"></a><span class="line-modified">620     RELEASE_AND_RETURN(scope, Base::deleteProperty(thisObject, globalObject, propertyName));</span>
621 }
622 
<a name="77" id="anc77"></a><span class="line-modified">623 bool JSFunction::defineOwnProperty(JSObject* object, JSGlobalObject* globalObject, PropertyName propertyName, const PropertyDescriptor&amp; descriptor, bool throwException)</span>
624 {
<a name="78" id="anc78"></a><span class="line-modified">625     VM&amp; vm = globalObject-&gt;vm();</span>
626     auto scope = DECLARE_THROW_SCOPE(vm);
627 
628     JSFunction* thisObject = jsCast&lt;JSFunction*&gt;(object);
<a name="79" id="anc79"></a><span class="line-added">629 </span>
<span class="line-added">630     if (propertyName == vm.propertyNames-&gt;length || propertyName == vm.propertyNames-&gt;name) {</span>
<span class="line-added">631         FunctionRareData* rareData = thisObject-&gt;ensureRareData(vm);</span>
<span class="line-added">632         if (propertyName == vm.propertyNames-&gt;length)</span>
<span class="line-added">633             rareData-&gt;setHasModifiedLength();</span>
<span class="line-added">634         else</span>
<span class="line-added">635             rareData-&gt;setHasModifiedName();</span>
<span class="line-added">636     }</span>
<span class="line-added">637 </span>
638     if (thisObject-&gt;isHostOrBuiltinFunction()) {
<a name="80" id="anc80"></a><span class="line-modified">639         thisObject-&gt;reifyLazyPropertyForHostOrBuiltinIfNeeded(vm, globalObject, propertyName);</span>
<span class="line-modified">640         RETURN_IF_EXCEPTION(scope, false);</span>
<span class="line-added">641         RELEASE_AND_RETURN(scope, Base::defineOwnProperty(object, globalObject, propertyName, descriptor, throwException));</span>
642     }
643 
644     if (propertyName == vm.propertyNames-&gt;prototype) {
645         // Make sure prototype has been reified, such that it can only be overwritten
646         // following the rules set out in ECMA-262 8.12.9.
647         PropertySlot slot(thisObject, PropertySlot::InternalMethodType::VMInquiry);
<a name="81" id="anc81"></a><span class="line-modified">648         thisObject-&gt;methodTable(vm)-&gt;getOwnPropertySlot(thisObject, globalObject, propertyName, slot);</span>
<span class="line-modified">649         RETURN_IF_EXCEPTION(scope, false);</span>
<span class="line-modified">650         if (FunctionRareData* rareData = thisObject-&gt;rareData())</span>
<span class="line-modified">651             rareData-&gt;clear(&quot;Store to prototype property of a function&quot;);</span>
<span class="line-added">652         RELEASE_AND_RETURN(scope, Base::defineOwnProperty(object, globalObject, propertyName, descriptor, throwException));</span>
653     }
654 
655     bool valueCheck;
656     if (propertyName == vm.propertyNames-&gt;arguments) {
657         if (!thisObject-&gt;jsExecutable()-&gt;hasCallerAndArgumentsProperties())
<a name="82" id="anc82"></a><span class="line-modified">658             RELEASE_AND_RETURN(scope, Base::defineOwnProperty(object, globalObject, propertyName, descriptor, throwException));</span>
659 
<a name="83" id="anc83"></a><span class="line-modified">660         valueCheck = !descriptor.value();</span>
<span class="line-added">661         if (!valueCheck) {</span>
<span class="line-added">662             valueCheck = sameValue(globalObject, descriptor.value(), retrieveArguments(vm, vm.topCallFrame, thisObject));</span>
<span class="line-added">663             RETURN_IF_EXCEPTION(scope, false);</span>
<span class="line-added">664         }</span>
665     } else if (propertyName == vm.propertyNames-&gt;caller) {
666         if (!thisObject-&gt;jsExecutable()-&gt;hasCallerAndArgumentsProperties())
<a name="84" id="anc84"></a><span class="line-modified">667             RELEASE_AND_RETURN(scope, Base::defineOwnProperty(object, globalObject, propertyName, descriptor, throwException));</span>
668 
<a name="85" id="anc85"></a><span class="line-modified">669         valueCheck = !descriptor.value();</span>
<span class="line-added">670         if (!valueCheck) {</span>
<span class="line-added">671             valueCheck = sameValue(globalObject, descriptor.value(), retrieveCallerFunction(vm, vm.topCallFrame, thisObject));</span>
<span class="line-added">672             RETURN_IF_EXCEPTION(scope, false);</span>
<span class="line-added">673         }</span>
674     } else {
<a name="86" id="anc86"></a><span class="line-modified">675         thisObject-&gt;reifyLazyPropertyIfNeeded(vm, globalObject, propertyName);</span>
<span class="line-modified">676         RETURN_IF_EXCEPTION(scope, false);</span>
<span class="line-added">677         RELEASE_AND_RETURN(scope, Base::defineOwnProperty(object, globalObject, propertyName, descriptor, throwException));</span>
678     }
679 
680     if (descriptor.configurablePresent() &amp;&amp; descriptor.configurable())
<a name="87" id="anc87"></a><span class="line-modified">681         return typeError(globalObject, scope, throwException, UnconfigurablePropertyChangeConfigurabilityError);</span>
682     if (descriptor.enumerablePresent() &amp;&amp; descriptor.enumerable())
<a name="88" id="anc88"></a><span class="line-modified">683         return typeError(globalObject, scope, throwException, UnconfigurablePropertyChangeEnumerabilityError);</span>
684     if (descriptor.isAccessorDescriptor())
<a name="89" id="anc89"></a><span class="line-modified">685         return typeError(globalObject, scope, throwException, UnconfigurablePropertyChangeAccessMechanismError);</span>
686     if (descriptor.writablePresent() &amp;&amp; descriptor.writable())
<a name="90" id="anc90"></a><span class="line-modified">687         return typeError(globalObject, scope, throwException, UnconfigurablePropertyChangeWritabilityError);</span>
688     if (!valueCheck)
<a name="91" id="anc91"></a><span class="line-modified">689         return typeError(globalObject, scope, throwException, ReadonlyPropertyChangeError);</span>
690     return true;
691 }
692 
693 // ECMA 13.2.2 [[Construct]]
694 ConstructType JSFunction::getConstructData(JSCell* cell, ConstructData&amp; constructData)
695 {
696     JSFunction* thisObject = jsCast&lt;JSFunction*&gt;(cell);
697 
698     if (thisObject-&gt;isHostFunction()) {
699         if (thisObject-&gt;nativeConstructor() == callHostFunctionAsConstructor)
700             return ConstructType::None;
701         constructData.native.function = thisObject-&gt;nativeConstructor();
702         return ConstructType::Host;
703     }
704 
705     FunctionExecutable* functionExecutable = thisObject-&gt;jsExecutable();
706     if (functionExecutable-&gt;constructAbility() == ConstructAbility::CannotConstruct)
707         return ConstructType::None;
708 
709     constructData.js.functionExecutable = functionExecutable;
710     constructData.js.scope = thisObject-&gt;scope();
711     return ConstructType::JS;
712 }
713 
714 String getCalculatedDisplayName(VM&amp; vm, JSObject* object)
715 {
716 #if ENABLE(WEBASSEMBLY)
717     if (jsDynamicCast&lt;JSToWasmICCallee*&gt;(vm, object))
718         return &quot;wasm-stub&quot;_s;
719 #endif
720 
721     if (!jsDynamicCast&lt;JSFunction*&gt;(vm, object) &amp;&amp; !jsDynamicCast&lt;InternalFunction*&gt;(vm, object))
722         return emptyString();
723 
724     Structure* structure = object-&gt;structure(vm);
725     unsigned attributes;
726     // This function may be called when the mutator isn&#39;t running and we are lazily generating a stack trace.
727     PropertyOffset offset = structure-&gt;getConcurrently(vm.propertyNames-&gt;displayName.impl(), attributes);
728     if (offset != invalidOffset &amp;&amp; !(attributes &amp; (PropertyAttribute::Accessor | PropertyAttribute::CustomAccessorOrValue))) {
729         JSValue displayName = object-&gt;getDirect(offset);
730         if (displayName &amp;&amp; displayName.isString())
731             return asString(displayName)-&gt;tryGetValue();
732     }
733 
734     if (auto* function = jsDynamicCast&lt;JSFunction*&gt;(vm, object)) {
735         const String actualName = function-&gt;name(vm);
736         if (!actualName.isEmpty() || function-&gt;isHostOrBuiltinFunction())
737             return actualName;
738 
739         return function-&gt;jsExecutable()-&gt;ecmaName().string();
740     }
741     if (auto* function = jsDynamicCast&lt;InternalFunction*&gt;(vm, object))
742         return function-&gt;name();
743 
744 
745     return emptyString();
746 }
747 
<a name="92" id="anc92"></a><span class="line-modified">748 void JSFunction::setFunctionName(JSGlobalObject* globalObject, JSValue value)</span>
749 {
<a name="93" id="anc93"></a><span class="line-modified">750     VM&amp; vm = globalObject-&gt;vm();</span>
751     auto scope = DECLARE_THROW_SCOPE(vm);
752 
753     // The &quot;name&quot; property may have been already been defined as part of a property list in an
754     // object literal (and therefore reified).
755     if (hasReifiedName())
756         return;
757 
758     ASSERT(!isHostFunction());
759     ASSERT(jsExecutable()-&gt;ecmaName().isNull());
760     String name;
761     if (value.isSymbol()) {
762         PrivateName privateName = asSymbol(value)-&gt;privateName();
763         SymbolImpl&amp; uid = privateName.uid();
764         if (uid.isNullSymbol())
765             name = emptyString();
766         else
767             name = makeString(&#39;[&#39;, String(&amp;uid), &#39;]&#39;);
768     } else {
<a name="94" id="anc94"></a><span class="line-modified">769         JSString* jsStr = value.toString(globalObject);</span>
770         RETURN_IF_EXCEPTION(scope, void());
<a name="95" id="anc95"></a><span class="line-modified">771         name = jsStr-&gt;value(globalObject);</span>
772         RETURN_IF_EXCEPTION(scope, void());
773     }
<a name="96" id="anc96"></a><span class="line-modified">774     reifyName(vm, globalObject, name);</span>
775 }
776 
777 void JSFunction::reifyLength(VM&amp; vm)
778 {
<a name="97" id="anc97"></a><span class="line-modified">779     FunctionRareData* rareData = this-&gt;ensureRareData(vm);</span>
780 
781     ASSERT(!hasReifiedLength());
<a name="98" id="anc98"></a><span class="line-modified">782     unsigned length = 0;</span>
<span class="line-modified">783     if (this-&gt;inherits&lt;JSBoundFunction&gt;(vm))</span>
<span class="line-added">784         length = jsCast&lt;JSBoundFunction*&gt;(this)-&gt;length(vm);</span>
<span class="line-added">785     else {</span>
<span class="line-added">786         ASSERT(!isHostFunction());</span>
<span class="line-added">787         length = jsExecutable()-&gt;parameterCount();</span>
<span class="line-added">788     }</span>
<span class="line-added">789     JSValue initialValue = jsNumber(length);</span>
790     unsigned initialAttributes = PropertyAttribute::DontEnum | PropertyAttribute::ReadOnly;
791     const Identifier&amp; identifier = vm.propertyNames-&gt;length;
792     rareData-&gt;setHasReifiedLength();
793     putDirect(vm, identifier, initialValue, initialAttributes);
794 }
795 
<a name="99" id="anc99"></a><span class="line-modified">796 void JSFunction::reifyName(VM&amp; vm, JSGlobalObject* globalObject)</span>
797 {
798     const Identifier&amp; ecmaName = jsExecutable()-&gt;ecmaName();
799     String name;
800     // https://tc39.github.io/ecma262/#sec-exports-runtime-semantics-evaluation
801     // When the ident is &quot;*default*&quot;, we need to set &quot;default&quot; for the ecma name.
802     // This &quot;*default*&quot; name is never shown to users.
803     if (ecmaName == vm.propertyNames-&gt;builtinNames().starDefaultPrivateName())
804         name = vm.propertyNames-&gt;defaultKeyword.string();
805     else
806         name = ecmaName.string();
<a name="100" id="anc100"></a><span class="line-modified">807     reifyName(vm, globalObject, name);</span>
808 }
809 
<a name="101" id="anc101"></a><span class="line-modified">810 void JSFunction::reifyName(VM&amp; vm, JSGlobalObject* globalObject, String name)</span>
811 {
<a name="102" id="anc102"></a><span class="line-modified">812     FunctionRareData* rareData = this-&gt;ensureRareData(vm);</span>
813 
814     ASSERT(!hasReifiedName());
815     ASSERT(!isHostFunction());
816     unsigned initialAttributes = PropertyAttribute::DontEnum | PropertyAttribute::ReadOnly;
817     const Identifier&amp; propID = vm.propertyNames-&gt;name;
818 
<a name="103" id="anc103"></a><span class="line-modified">819     if (globalObject-&gt;needsSiteSpecificQuirks()) {</span>
820         auto illegalCharMatcher = [] (UChar ch) -&gt; bool {
821             return ch == &#39; &#39; || ch == &#39;|&#39;;
822         };
823         if (name.find(illegalCharMatcher) != notFound)
824             name = String();
825     }
826 
827     if (jsExecutable()-&gt;isGetter())
828         name = makeString(&quot;get &quot;, name);
829     else if (jsExecutable()-&gt;isSetter())
830         name = makeString(&quot;set &quot;, name);
831 
832     rareData-&gt;setHasReifiedName();
833     putDirect(vm, propID, jsString(vm, name), initialAttributes);
834 }
835 
<a name="104" id="anc104"></a><span class="line-modified">836 JSFunction::PropertyStatus JSFunction::reifyLazyPropertyIfNeeded(VM&amp; vm, JSGlobalObject* globalObject, PropertyName propertyName)</span>
837 {
<a name="105" id="anc105"></a><span class="line-modified">838     if (isHostOrBuiltinFunction() &amp;&amp; !this-&gt;inherits&lt;JSBoundFunction&gt;(vm))</span>
839         return PropertyStatus::Eager;
<a name="106" id="anc106"></a><span class="line-modified">840     PropertyStatus lazyLength = reifyLazyLengthIfNeeded(vm, globalObject, propertyName);</span>
841     if (isLazy(lazyLength))
842         return lazyLength;
<a name="107" id="anc107"></a><span class="line-modified">843     PropertyStatus lazyName = reifyLazyNameIfNeeded(vm, globalObject, propertyName);</span>
844     if (isLazy(lazyName))
845         return lazyName;
846     return PropertyStatus::Eager;
847 }
848 
<a name="108" id="anc108"></a><span class="line-modified">849 JSFunction::PropertyStatus JSFunction::reifyLazyPropertyForHostOrBuiltinIfNeeded(VM&amp; vm, JSGlobalObject* globalObject, PropertyName propertyName)</span>
850 {
851     ASSERT(isHostOrBuiltinFunction());
<a name="109" id="anc109"></a><span class="line-modified">852     if (isBuiltinFunction() || this-&gt;inherits&lt;JSBoundFunction&gt;(vm)) {</span>
<span class="line-modified">853         PropertyStatus lazyLength = reifyLazyLengthIfNeeded(vm, globalObject, propertyName);</span>
854         if (isLazy(lazyLength))
855             return lazyLength;
856     }
<a name="110" id="anc110"></a><span class="line-modified">857     return reifyLazyBoundNameIfNeeded(vm, globalObject, propertyName);</span>
858 }
859 
<a name="111" id="anc111"></a><span class="line-modified">860 JSFunction::PropertyStatus JSFunction::reifyLazyLengthIfNeeded(VM&amp; vm, JSGlobalObject*, PropertyName propertyName)</span>
861 {
862     if (propertyName == vm.propertyNames-&gt;length) {
863         if (!hasReifiedLength()) {
864             reifyLength(vm);
865             return PropertyStatus::Reified;
866         }
867         return PropertyStatus::Lazy;
868     }
869     return PropertyStatus::Eager;
870 }
871 
<a name="112" id="anc112"></a><span class="line-modified">872 JSFunction::PropertyStatus JSFunction::reifyLazyNameIfNeeded(VM&amp; vm, JSGlobalObject* globalObject, PropertyName propertyName)</span>
873 {
874     if (propertyName == vm.propertyNames-&gt;name) {
875         if (!hasReifiedName()) {
<a name="113" id="anc113"></a><span class="line-modified">876             reifyName(vm, globalObject);</span>
877             return PropertyStatus::Reified;
878         }
879         return PropertyStatus::Lazy;
880     }
881     return PropertyStatus::Eager;
882 }
883 
<a name="114" id="anc114"></a><span class="line-modified">884 JSFunction::PropertyStatus JSFunction::reifyLazyBoundNameIfNeeded(VM&amp; vm, JSGlobalObject* globalObject, PropertyName propertyName)</span>
885 {
<a name="115" id="anc115"></a><span class="line-added">886     auto scope = DECLARE_THROW_SCOPE(vm);</span>
<span class="line-added">887 </span>
888     const Identifier&amp; nameIdent = vm.propertyNames-&gt;name;
889     if (propertyName != nameIdent)
890         return PropertyStatus::Eager;
891 
892     if (hasReifiedName())
893         return PropertyStatus::Lazy;
894 
895     if (isBuiltinFunction())
<a name="116" id="anc116"></a><span class="line-modified">896         reifyName(vm, globalObject);</span>
897     else if (this-&gt;inherits&lt;JSBoundFunction&gt;(vm)) {
<a name="117" id="anc117"></a><span class="line-modified">898         FunctionRareData* rareData = this-&gt;ensureRareData(vm);</span>
<span class="line-modified">899         JSString* nameMayBeNull = jsCast&lt;JSBoundFunction*&gt;(this)-&gt;nameMayBeNull();</span>
<span class="line-added">900         JSString* string = nullptr;</span>
<span class="line-added">901         if (nameMayBeNull) {</span>
<span class="line-added">902             string = jsString(globalObject, vm.smallStrings.boundPrefixString(), nameMayBeNull);</span>
<span class="line-added">903             RETURN_IF_EXCEPTION(scope, PropertyStatus::Lazy);</span>
<span class="line-added">904         } else</span>
<span class="line-added">905             string = jsEmptyString(vm);</span>
906         unsigned initialAttributes = PropertyAttribute::DontEnum | PropertyAttribute::ReadOnly;
907         rareData-&gt;setHasReifiedName();
<a name="118" id="anc118"></a><span class="line-modified">908         putDirect(vm, nameIdent, string, initialAttributes);</span>
909     }
910     return PropertyStatus::Reified;
911 }
912 
<a name="119" id="anc119"></a><span class="line-modified">913 #if ASSERT_ENABLED</span>
914 void JSFunction::assertTypeInfoFlagInvariants()
915 {
916     // If you change this, you&#39;ll need to update speculationFromClassInfo.
917     const ClassInfo* info = classInfo(vm());
918     if (!(inlineTypeFlags() &amp; ImplementsDefaultHasInstance))
919         RELEASE_ASSERT(info == JSBoundFunction::info());
920     else
921         RELEASE_ASSERT(info != JSBoundFunction::info());
922 }
<a name="120" id="anc120"></a><span class="line-modified">923 #endif // ASSERT_ENABLED</span>
924 
925 } // namespace JSC
<a name="121" id="anc121"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="121" type="hidden" />
</body>
</html>