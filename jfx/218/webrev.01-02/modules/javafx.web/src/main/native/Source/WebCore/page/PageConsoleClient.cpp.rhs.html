<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/WebCore/page/PageConsoleClient.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (C) 2013-2019 Apple Inc. All rights reserved.
  3  *
  4  * Redistribution and use in source and binary forms, with or without
  5  * modification, are permitted provided that the following conditions
  6  * are met:
  7  *
  8  * 1.  Redistributions of source code must retain the above copyright
  9  *     notice, this list of conditions and the following disclaimer.
 10  * 2.  Redistributions in binary form must reproduce the above copyright
 11  *     notice, this list of conditions and the following disclaimer in the
 12  *     documentation and/or other materials provided with the distribution.
 13  * 3.  Neither the name of Apple Inc. (&quot;Apple&quot;) nor the names of
 14  *     its contributors may be used to endorse or promote products derived
 15  *     from this software without specific prior written permission.
 16  *
 17  * THIS SOFTWARE IS PROVIDED BY APPLE AND ITS CONTRIBUTORS &quot;AS IS&quot; AND ANY
 18  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 19  * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 20  * DISCLAIMED. IN NO EVENT SHALL APPLE OR ITS CONTRIBUTORS BE LIABLE FOR ANY
 21  * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 22  * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 23  * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
 24  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 25  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
 26  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 27  */
 28 
 29 #include &quot;config.h&quot;
 30 #include &quot;PageConsoleClient.h&quot;
 31 
 32 #include &quot;CachedImage.h&quot;
 33 #include &quot;CanvasRenderingContext2D.h&quot;
 34 #include &quot;Chrome.h&quot;
 35 #include &quot;ChromeClient.h&quot;
 36 #include &quot;Document.h&quot;
 37 #include &quot;ElementChildIterator.h&quot;
 38 #include &quot;Frame.h&quot;
 39 #include &quot;FrameSnapshotting.h&quot;
 40 #include &quot;HTMLCanvasElement.h&quot;
 41 #include &quot;HTMLImageElement.h&quot;
 42 #include &quot;HTMLPictureElement.h&quot;
 43 #include &quot;HTMLVideoElement.h&quot;
 44 #include &quot;Image.h&quot;
 45 #include &quot;ImageBitmap.h&quot;
 46 #include &quot;ImageBitmapRenderingContext.h&quot;
 47 #include &quot;ImageBuffer.h&quot;
 48 #include &quot;ImageData.h&quot;
 49 #include &quot;InspectorController.h&quot;
 50 #include &quot;InspectorInstrumentation.h&quot;
 51 #include &quot;IntRect.h&quot;
 52 #include &quot;JSCanvasRenderingContext2D.h&quot;
 53 #include &quot;JSExecState.h&quot;
 54 #include &quot;JSHTMLCanvasElement.h&quot;
 55 #include &quot;JSImageBitmap.h&quot;
 56 #include &quot;JSImageBitmapRenderingContext.h&quot;
 57 #include &quot;JSImageData.h&quot;
 58 #include &quot;JSNode.h&quot;
<a name="1" id="anc1"></a>
 59 #include &quot;Node.h&quot;
<a name="2" id="anc2"></a>
 60 #include &quot;Page.h&quot;
 61 #include &quot;ScriptableDocumentParser.h&quot;
 62 #include &quot;Settings.h&quot;
 63 #include &lt;JavaScriptCore/ConsoleMessage.h&gt;
 64 #include &lt;JavaScriptCore/JSCInlines.h&gt;
 65 #include &lt;JavaScriptCore/ScriptArguments.h&gt;
 66 #include &lt;JavaScriptCore/ScriptCallStack.h&gt;
 67 #include &lt;JavaScriptCore/ScriptCallStackFactory.h&gt;
<a name="3" id="anc3"></a><span class="line-added"> 68 #include &lt;JavaScriptCore/StrongInlines.h&gt;</span>
 69 #include &lt;wtf/text/WTFString.h&gt;
 70 
<a name="4" id="anc4"></a><span class="line-added"> 71 #if ENABLE(OFFSCREEN_CANVAS)</span>
<span class="line-added"> 72 #include &quot;JSOffscreenCanvas.h&quot;</span>
<span class="line-added"> 73 #include &quot;OffscreenCanvas.h&quot;</span>
<span class="line-added"> 74 #endif</span>
<span class="line-added"> 75 </span>
 76 #if ENABLE(WEBGL)
 77 #include &quot;JSWebGLRenderingContext.h&quot;
 78 #include &quot;WebGLRenderingContext.h&quot;
 79 #endif
 80 
 81 #if ENABLE(WEBGL2)
 82 #include &quot;JSWebGL2RenderingContext.h&quot;
 83 #include &quot;WebGL2RenderingContext.h&quot;
 84 #endif
 85 
 86 namespace WebCore {
 87 using namespace Inspector;
 88 
 89 PageConsoleClient::PageConsoleClient(Page&amp; page)
 90     : m_page(page)
 91 {
 92 }
 93 
 94 PageConsoleClient::~PageConsoleClient() = default;
 95 
 96 static int muteCount = 0;
 97 static bool printExceptions = false;
 98 
 99 bool PageConsoleClient::shouldPrintExceptions()
100 {
101     return printExceptions;
102 }
103 
104 void PageConsoleClient::setShouldPrintExceptions(bool print)
105 {
106     printExceptions = print;
107 }
108 
109 void PageConsoleClient::mute()
110 {
111     muteCount++;
112 }
113 
114 void PageConsoleClient::unmute()
115 {
116     ASSERT(muteCount &gt; 0);
117     muteCount--;
118 }
119 
120 void PageConsoleClient::addMessage(std::unique_ptr&lt;Inspector::ConsoleMessage&gt;&amp;&amp; consoleMessage)
121 {
122     if (!m_page.usesEphemeralSession()) {
123         String message;
124         if (consoleMessage-&gt;type() == MessageType::Image) {
125             ASSERT(consoleMessage-&gt;arguments());
126             consoleMessage-&gt;arguments()-&gt;getFirstArgumentAsString(message);
127         } else
128             message = consoleMessage-&gt;message();
129         m_page.chrome().client().addMessageToConsole(consoleMessage-&gt;source(), consoleMessage-&gt;level(), message, consoleMessage-&gt;line(), consoleMessage-&gt;column(), consoleMessage-&gt;url());
130 
131         if (UNLIKELY(m_page.settings().logsPageMessagesToSystemConsoleEnabled() || shouldPrintExceptions())) {
132             if (consoleMessage-&gt;type() == MessageType::Image) {
133                 ASSERT(consoleMessage-&gt;arguments());
<a name="5" id="anc5"></a><span class="line-modified">134                 ConsoleClient::printConsoleMessageWithArguments(MessageSource::ConsoleAPI, MessageType::Log, consoleMessage-&gt;level(), consoleMessage-&gt;arguments()-&gt;globalObject(), *consoleMessage-&gt;arguments());</span>
135             } else
136                 ConsoleClient::printConsoleMessage(MessageSource::ConsoleAPI, MessageType::Log, consoleMessage-&gt;level(), consoleMessage-&gt;message(), consoleMessage-&gt;url(), consoleMessage-&gt;line(), consoleMessage-&gt;column());
137         }
138     }
139 
140     InspectorInstrumentation::addMessageToConsole(m_page, WTFMove(consoleMessage));
141 }
142 
143 void PageConsoleClient::addMessage(MessageSource source, MessageLevel level, const String&amp; message, unsigned long requestIdentifier, Document* document)
144 {
145     String url;
146     unsigned line = 0;
147     unsigned column = 0;
148     if (document)
149         document-&gt;getParserLocation(url, line, column);
150 
151     addMessage(source, level, message, url, line, column, 0, JSExecState::currentState(), requestIdentifier);
152 }
153 
154 void PageConsoleClient::addMessage(MessageSource source, MessageLevel level, const String&amp; message, Ref&lt;ScriptCallStack&gt;&amp;&amp; callStack)
155 {
156     addMessage(source, level, message, String(), 0, 0, WTFMove(callStack), 0);
157 }
158 
<a name="6" id="anc6"></a><span class="line-modified">159 void PageConsoleClient::addMessage(MessageSource source, MessageLevel level, const String&amp; messageText, const String&amp; suggestedURL, unsigned suggestedLineNumber, unsigned suggestedColumnNumber, RefPtr&lt;ScriptCallStack&gt;&amp;&amp; callStack, JSC::JSGlobalObject* lexicalGlobalObject, unsigned long requestIdentifier)</span>
160 {
161     if (muteCount &amp;&amp; source != MessageSource::ConsoleAPI)
162         return;
163 
164     std::unique_ptr&lt;Inspector::ConsoleMessage&gt; message;
165 
166     if (callStack)
167         message = makeUnique&lt;Inspector::ConsoleMessage&gt;(source, MessageType::Log, level, messageText, callStack.releaseNonNull(), requestIdentifier);
168     else
<a name="7" id="anc7"></a><span class="line-modified">169         message = makeUnique&lt;Inspector::ConsoleMessage&gt;(source, MessageType::Log, level, messageText, suggestedURL, suggestedLineNumber, suggestedColumnNumber, lexicalGlobalObject, requestIdentifier);</span>
170 
171     addMessage(WTFMove(message));
172 }
173 
174 
<a name="8" id="anc8"></a><span class="line-modified">175 void PageConsoleClient::messageWithTypeAndLevel(MessageType type, MessageLevel level, JSC::JSGlobalObject* lexicalGlobalObject, Ref&lt;Inspector::ScriptArguments&gt;&amp;&amp; arguments)</span>
176 {
177     String messageText;
178     bool gotMessage = arguments-&gt;getFirstArgumentAsString(messageText);
179 
<a name="9" id="anc9"></a><span class="line-modified">180     auto message = makeUnique&lt;Inspector::ConsoleMessage&gt;(MessageSource::ConsoleAPI, type, level, messageText, arguments.copyRef(), lexicalGlobalObject);</span>
181 
182     String url = message-&gt;url();
183     unsigned lineNumber = message-&gt;line();
184     unsigned columnNumber = message-&gt;column();
185 
186     InspectorInstrumentation::addMessageToConsole(m_page, WTFMove(message));
187 
188     if (m_page.usesEphemeralSession())
189         return;
190 
191     if (gotMessage)
192         m_page.chrome().client().addMessageToConsole(MessageSource::ConsoleAPI, level, messageText, lineNumber, columnNumber, url);
193 
194     if (m_page.settings().logsPageMessagesToSystemConsoleEnabled() || PageConsoleClient::shouldPrintExceptions())
<a name="10" id="anc10"></a><span class="line-modified">195         ConsoleClient::printConsoleMessageWithArguments(MessageSource::ConsoleAPI, type, level, lexicalGlobalObject, WTFMove(arguments));</span>
196 }
197 
<a name="11" id="anc11"></a><span class="line-modified">198 void PageConsoleClient::count(JSC::JSGlobalObject* lexicalGlobalObject, const String&amp; label)</span>
199 {
<a name="12" id="anc12"></a><span class="line-modified">200     InspectorInstrumentation::consoleCount(m_page, lexicalGlobalObject, label);</span>
201 }
202 
<a name="13" id="anc13"></a><span class="line-modified">203 void PageConsoleClient::countReset(JSC::JSGlobalObject* lexicalGlobalObject, const String&amp; label)</span>
204 {
<a name="14" id="anc14"></a><span class="line-modified">205     InspectorInstrumentation::consoleCountReset(m_page, lexicalGlobalObject, label);</span>
206 }
207 
<a name="15" id="anc15"></a><span class="line-modified">208 void PageConsoleClient::profile(JSC::JSGlobalObject* lexicalGlobalObject, const String&amp; title)</span>
209 {
210     // FIXME: &lt;https://webkit.org/b/153499&gt; Web Inspector: console.profile should use the new Sampling Profiler
<a name="16" id="anc16"></a><span class="line-modified">211     InspectorInstrumentation::startProfiling(m_page, lexicalGlobalObject, title);</span>
212 }
213 
<a name="17" id="anc17"></a><span class="line-modified">214 void PageConsoleClient::profileEnd(JSC::JSGlobalObject* lexicalGlobalObject, const String&amp; title)</span>
215 {
216     // FIXME: &lt;https://webkit.org/b/153499&gt; Web Inspector: console.profile should use the new Sampling Profiler
<a name="18" id="anc18"></a><span class="line-modified">217     InspectorInstrumentation::stopProfiling(m_page, lexicalGlobalObject, title);</span>
218 }
219 
<a name="19" id="anc19"></a><span class="line-modified">220 void PageConsoleClient::takeHeapSnapshot(JSC::JSGlobalObject*, const String&amp; title)</span>
221 {
222     InspectorInstrumentation::takeHeapSnapshot(m_page.mainFrame(), title);
223 }
224 
<a name="20" id="anc20"></a><span class="line-modified">225 void PageConsoleClient::time(JSC::JSGlobalObject* lexicalGlobalObject, const String&amp; label)</span>
226 {
<a name="21" id="anc21"></a><span class="line-modified">227     InspectorInstrumentation::startConsoleTiming(m_page.mainFrame(), lexicalGlobalObject, label);</span>
228 }
229 
<a name="22" id="anc22"></a><span class="line-modified">230 void PageConsoleClient::timeLog(JSC::JSGlobalObject* lexicalGlobalObject, const String&amp; label, Ref&lt;ScriptArguments&gt;&amp;&amp; arguments)</span>
231 {
<a name="23" id="anc23"></a><span class="line-modified">232     InspectorInstrumentation::logConsoleTiming(m_page.mainFrame(), lexicalGlobalObject, label, WTFMove(arguments));</span>
233 }
234 
<a name="24" id="anc24"></a><span class="line-modified">235 void PageConsoleClient::timeEnd(JSC::JSGlobalObject* lexicalGlobalObject, const String&amp; label)</span>
236 {
<a name="25" id="anc25"></a><span class="line-modified">237     InspectorInstrumentation::stopConsoleTiming(m_page.mainFrame(), lexicalGlobalObject, label);</span>
238 }
239 
<a name="26" id="anc26"></a><span class="line-modified">240 void PageConsoleClient::timeStamp(JSC::JSGlobalObject*, Ref&lt;ScriptArguments&gt;&amp;&amp; arguments)</span>
241 {
242     InspectorInstrumentation::consoleTimeStamp(m_page.mainFrame(), WTFMove(arguments));
243 }
244 
245 static JSC::JSObject* objectArgumentAt(ScriptArguments&amp; arguments, unsigned index)
246 {
247     return arguments.argumentCount() &gt; index ? arguments.argumentAt(index).getObject() : nullptr;
248 }
249 
250 static CanvasRenderingContext* canvasRenderingContext(JSC::VM&amp; vm, JSC::JSValue target)
251 {
252     if (auto* canvas = JSHTMLCanvasElement::toWrapped(vm, target))
253         return canvas-&gt;renderingContext();
<a name="27" id="anc27"></a><span class="line-added">254 #if ENABLE(OFFSCREEN_CANVAS)</span>
255     if (auto* canvas = JSOffscreenCanvas::toWrapped(vm, target))
256         return canvas-&gt;renderingContext();
<a name="28" id="anc28"></a><span class="line-added">257 #endif</span>
258     if (auto* context = JSCanvasRenderingContext2D::toWrapped(vm, target))
259         return context;
260     if (auto* context = JSImageBitmapRenderingContext::toWrapped(vm, target))
261         return context;
262 #if ENABLE(WEBGL)
263     if (auto* context = JSWebGLRenderingContext::toWrapped(vm, target))
264         return context;
265 #endif
266 #if ENABLE(WEBGL2)
267     if (auto* context = JSWebGL2RenderingContext::toWrapped(vm, target))
268         return context;
269 #endif
270     return nullptr;
271 }
272 
<a name="29" id="anc29"></a><span class="line-modified">273 void PageConsoleClient::record(JSC::JSGlobalObject* lexicalGlobalObject, Ref&lt;ScriptArguments&gt;&amp;&amp; arguments)</span>
274 {
<a name="30" id="anc30"></a><span class="line-added">275     if (LIKELY(!InspectorInstrumentation::hasFrontends()))</span>
<span class="line-added">276         return;</span>
<span class="line-added">277 </span>
278     if (auto* target = objectArgumentAt(arguments, 0)) {
<a name="31" id="anc31"></a><span class="line-modified">279         if (auto* context = canvasRenderingContext(lexicalGlobalObject-&gt;vm(), target))</span>
<span class="line-modified">280             InspectorInstrumentation::consoleStartRecordingCanvas(*context, *lexicalGlobalObject, objectArgumentAt(arguments, 1));</span>
281     }
282 }
283 
<a name="32" id="anc32"></a><span class="line-modified">284 void PageConsoleClient::recordEnd(JSC::JSGlobalObject* lexicalGlobalObject, Ref&lt;ScriptArguments&gt;&amp;&amp; arguments)</span>
285 {
<a name="33" id="anc33"></a><span class="line-added">286     if (LIKELY(!InspectorInstrumentation::hasFrontends()))</span>
<span class="line-added">287         return;</span>
<span class="line-added">288 </span>
289     if (auto* target = objectArgumentAt(arguments, 0)) {
<a name="34" id="anc34"></a><span class="line-modified">290         if (auto* context = canvasRenderingContext(lexicalGlobalObject-&gt;vm(), target))</span>
<span class="line-modified">291             InspectorInstrumentation::consoleStopRecordingCanvas(*context);</span>
292     }
293 }
294 
295 static Optional&lt;String&gt; snapshotCanvas(HTMLCanvasElement&amp; canvasElement, CanvasRenderingContext&amp; canvasRenderingContext)
296 {
297 #if ENABLE(WEBGL)
298     if (is&lt;WebGLRenderingContextBase&gt;(canvasRenderingContext))
299         downcast&lt;WebGLRenderingContextBase&gt;(canvasRenderingContext).setPreventBufferClearForInspector(true);
300 #endif
301 
302     auto result = canvasElement.toDataURL(&quot;image/png&quot;_s);
303 
304 #if ENABLE(WEBGL)
305     if (is&lt;WebGLRenderingContextBase&gt;(canvasRenderingContext))
306         downcast&lt;WebGLRenderingContextBase&gt;(canvasRenderingContext).setPreventBufferClearForInspector(false);
307 #endif
308 
309     if (!result.hasException())
310         return result.releaseReturnValue().string;
311 
312     return WTF::nullopt;
313 }
314 
<a name="35" id="anc35"></a><span class="line-modified">315 void PageConsoleClient::screenshot(JSC::JSGlobalObject* lexicalGlobalObject, Ref&lt;ScriptArguments&gt;&amp;&amp; arguments)</span>
316 {
<a name="36" id="anc36"></a><span class="line-modified">317     JSC::VM&amp; vm = lexicalGlobalObject-&gt;vm();</span>
318     String dataURL;
319     JSC::JSValue target;
320 
321     if (arguments-&gt;argumentCount()) {
322         auto possibleTarget = arguments-&gt;argumentAt(0);
323 
324         if (auto* node = JSNode::toWrapped(vm, possibleTarget)) {
325             target = possibleTarget;
326             if (UNLIKELY(InspectorInstrumentation::hasFrontends())) {
327                 std::unique_ptr&lt;ImageBuffer&gt; snapshot;
328 
329                 // Only try to do something special for subclasses of Node if they&#39;re detached from the DOM tree.
330                 if (!node-&gt;document().contains(node)) {
331                     auto snapshotImageElement = [&amp;snapshot] (HTMLImageElement&amp; imageElement) {
332                         if (auto* cachedImage = imageElement.cachedImage()) {
333                             auto* image = cachedImage-&gt;image();
334                             if (image &amp;&amp; image != &amp;Image::nullImage()) {
335                                 snapshot = ImageBuffer::create(image-&gt;size(), RenderingMode::Unaccelerated);
336                                 snapshot-&gt;context().drawImage(*image, FloatPoint(0, 0));
337                             }
338                         }
339                     };
340 
341                     if (is&lt;HTMLImageElement&gt;(node))
342                         snapshotImageElement(downcast&lt;HTMLImageElement&gt;(*node));
343                     else if (is&lt;HTMLPictureElement&gt;(node)) {
344                         if (auto* firstImage = childrenOfType&lt;HTMLImageElement&gt;(downcast&lt;HTMLPictureElement&gt;(*node)).first())
345                             snapshotImageElement(*firstImage);
346                     }
347 #if ENABLE(VIDEO)
348                     else if (is&lt;HTMLVideoElement&gt;(node)) {
349                         auto&amp; videoElement = downcast&lt;HTMLVideoElement&gt;(*node);
350                         unsigned videoWidth = videoElement.videoWidth();
351                         unsigned videoHeight = videoElement.videoHeight();
352                         snapshot = ImageBuffer::create(FloatSize(videoWidth, videoHeight), RenderingMode::Unaccelerated);
353                         videoElement.paintCurrentFrameInContext(snapshot-&gt;context(), FloatRect(0, 0, videoWidth, videoHeight));
354                     }
355 #endif
356                     else if (is&lt;HTMLCanvasElement&gt;(node)) {
357                         auto&amp; canvasElement = downcast&lt;HTMLCanvasElement&gt;(*node);
358                         if (auto* canvasRenderingContext = canvasElement.renderingContext()) {
359                             if (auto result = snapshotCanvas(canvasElement, *canvasRenderingContext))
360                                 dataURL = result.value();
361                         }
362                     }
363                 }
364 
365                 if (dataURL.isEmpty()) {
366                     if (!snapshot)
367                         snapshot = WebCore::snapshotNode(m_page.mainFrame(), *node);
368 
369                     if (snapshot)
370                         dataURL = snapshot-&gt;toDataURL(&quot;image/png&quot;_s, WTF::nullopt, PreserveResolution::Yes);
371                 }
372             }
373         } else if (auto* imageData = JSImageData::toWrapped(vm, possibleTarget)) {
374             target = possibleTarget;
375             if (UNLIKELY(InspectorInstrumentation::hasFrontends())) {
376                 auto sourceSize = imageData-&gt;size();
377                 if (auto imageBuffer = ImageBuffer::create(sourceSize, RenderingMode::Unaccelerated)) {
378                     IntRect sourceRect(IntPoint(), sourceSize);
379                     imageBuffer-&gt;putByteArray(*imageData-&gt;data(), AlphaPremultiplication::Unpremultiplied, sourceSize, sourceRect, IntPoint());
380                     dataURL = imageBuffer-&gt;toDataURL(&quot;image/png&quot;_s, WTF::nullopt, PreserveResolution::Yes);
381                 }
382             }
383         } else if (auto* imageBitmap = JSImageBitmap::toWrapped(vm, possibleTarget)) {
384             target = possibleTarget;
385             if (UNLIKELY(InspectorInstrumentation::hasFrontends())) {
386                 if (auto* imageBuffer = imageBitmap-&gt;buffer())
387                     dataURL = imageBuffer-&gt;toDataURL(&quot;image/png&quot;_s, WTF::nullopt, PreserveResolution::Yes);
388             }
389         } else if (auto* context = canvasRenderingContext(vm, possibleTarget)) {
390             auto&amp; canvas = context-&gt;canvasBase();
391             if (is&lt;HTMLCanvasElement&gt;(canvas)) {
392                 target = possibleTarget;
393                 if (UNLIKELY(InspectorInstrumentation::hasFrontends())) {
394                     if (auto result = snapshotCanvas(downcast&lt;HTMLCanvasElement&gt;(canvas), *context))
395                         dataURL = result.value();
396                 }
397             }
398 
399             // FIXME: &lt;https://webkit.org/b/180833&gt; Web Inspector: support OffscreenCanvas for Canvas related operations
400         } else {
401             String base64;
<a name="37" id="anc37"></a><span class="line-modified">402             if (possibleTarget.getString(lexicalGlobalObject, base64) &amp;&amp; base64.startsWithIgnoringASCIICase(&quot;data:&quot;_s) &amp;&amp; base64.length() &gt; 5) {</span>
403                 target = possibleTarget;
404                 dataURL = base64;
405             }
406         }
407     }
408 
409     if (UNLIKELY(InspectorInstrumentation::hasFrontends())) {
410         if (!target) {
411             // If no target is provided, capture an image of the viewport.
412             IntRect imageRect(IntPoint::zero(), m_page.mainFrame().view()-&gt;sizeForVisibleContent());
413             if (auto snapshot = WebCore::snapshotFrameRect(m_page.mainFrame(), imageRect, SnapshotOptionsInViewCoordinates))
414                 dataURL = snapshot-&gt;toDataURL(&quot;image/png&quot;_s, WTF::nullopt, PreserveResolution::Yes);
415         }
416 
417         if (dataURL.isEmpty()) {
418             addMessage(makeUnique&lt;Inspector::ConsoleMessage&gt;(MessageSource::ConsoleAPI, MessageType::Image, MessageLevel::Error, &quot;Could not capture screenshot&quot;_s, WTFMove(arguments)));
419             return;
420         }
421     }
422 
423     Vector&lt;JSC::Strong&lt;JSC::Unknown&gt;&gt; adjustedArguments;
424     adjustedArguments.append({ vm, target ? target : JSC::jsNontrivialString(vm, &quot;Viewport&quot;_s) });
425     for (size_t i = (!target ? 0 : 1); i &lt; arguments-&gt;argumentCount(); ++i)
426         adjustedArguments.append({ vm, arguments-&gt;argumentAt(i) });
<a name="38" id="anc38"></a><span class="line-modified">427     arguments = ScriptArguments::create(lexicalGlobalObject, WTFMove(adjustedArguments));</span>
428     addMessage(makeUnique&lt;Inspector::ConsoleMessage&gt;(MessageSource::ConsoleAPI, MessageType::Image, MessageLevel::Log, dataURL, WTFMove(arguments)));
429 }
430 
431 } // namespace WebCore
<a name="39" id="anc39"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="39" type="hidden" />
</body>
</html>