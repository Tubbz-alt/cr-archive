<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WTF/wtf/cf/LanguageCF.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../WordLock.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="RunLoopCF.cpp.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WTF/wtf/cf/LanguageCF.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -46,32 +46,43 @@</span>
      return languages;
  }
  
  static String httpStyleLanguageCode(CFStringRef language)
  {
<span class="udiff-line-modified-removed">-     SInt32 languageCode;</span>
<span class="udiff-line-modified-removed">-     SInt32 regionCode;</span>
<span class="udiff-line-modified-removed">-     SInt32 scriptCode;</span>
<span class="udiff-line-modified-removed">-     CFStringEncoding stringEncoding;</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-     // FIXME: This transformation is very wrong:</span>
<span class="udiff-line-modified-removed">-     // 1. There is no reason why CFBundle localization names would be at all related to language names as used on the Web.</span>
<span class="udiff-line-modified-removed">-     // 2. Script Manager codes cannot represent all languages that are now supported by the platform, so the conversion is lossy.</span>
<span class="udiff-line-modified-removed">-     // 3. This should probably match what is sent by the network layer as Accept-Language, but currently, that&#39;s implemented separately.</span>
<span class="udiff-line-modified-removed">-     CFBundleGetLocalizationInfoForLocalization(language, &amp;languageCode, &amp;regionCode, &amp;scriptCode, &amp;stringEncoding);</span>
<span class="udiff-line-modified-removed">-     RetainPtr&lt;CFStringRef&gt; preferredLanguageCode = adoptCF(CFBundleCopyLocalizationForLocalizationInfo(languageCode, regionCode, scriptCode, stringEncoding));</span>
<span class="udiff-line-modified-removed">-     if (preferredLanguageCode)</span>
<span class="udiff-line-modified-removed">-         language = preferredLanguageCode.get();</span>
<span class="udiff-line-modified-added">+     RetainPtr&lt;CFStringRef&gt; preferredLanguageCode;</span>
<span class="udiff-line-modified-added">+ #if !PLATFORM(JAVA)</span>
<span class="udiff-line-modified-added">+     // If we can minimize the language list to reduce fingerprinting, we can afford to be more lossless when canonicalizing the locale list.</span>
<span class="udiff-line-modified-added">+     if (canMinimizeLanguages())</span>
<span class="udiff-line-modified-added">+         preferredLanguageCode = adoptCF(CFLocaleCreateCanonicalLanguageIdentifierFromString(kCFAllocatorDefault, language));</span>
<span class="udiff-line-modified-added">+     else {</span>
<span class="udiff-line-modified-added">+ #endif</span>
<span class="udiff-line-modified-added">+         SInt32 languageCode;</span>
<span class="udiff-line-modified-added">+         SInt32 regionCode;</span>
<span class="udiff-line-modified-added">+         SInt32 scriptCode;</span>
<span class="udiff-line-modified-added">+         CFStringEncoding stringEncoding;</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+         // FIXME: This transformation is very wrong:</span>
<span class="udiff-line-added">+         // 1. There is no reason why CFBundle localization names would be at all related to language names as used on the Web.</span>
<span class="udiff-line-added">+         // 2. Script Manager codes cannot represent all languages that are now supported by the platform, so the conversion is lossy.</span>
<span class="udiff-line-added">+         // 3. This should probably match what is sent by the network layer as Accept-Language, but currently, that&#39;s implemented separately.</span>
<span class="udiff-line-added">+         CFBundleGetLocalizationInfoForLocalization(language, &amp;languageCode, &amp;regionCode, &amp;scriptCode, &amp;stringEncoding);</span>
<span class="udiff-line-added">+         preferredLanguageCode = adoptCF(CFBundleCopyLocalizationForLocalizationInfo(languageCode, regionCode, scriptCode, stringEncoding));</span>
<span class="udiff-line-added">+ #if !PLATFORM(JAVA)</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (!preferredLanguageCode)</span>
<span class="udiff-line-added">+         preferredLanguageCode = language;</span>
<span class="udiff-line-added">+     auto mutableLanguageCode = adoptCF(CFStringCreateMutableCopy(kCFAllocatorDefault, 0, preferredLanguageCode.get()));</span>
  
      // Turn a &#39;_&#39; into a &#39;-&#39; if it appears after a 2-letter language code
<span class="udiff-line-modified-removed">-     if (CFStringGetLength(language) &gt;= 3 &amp;&amp; CFStringGetCharacterAtIndex(language, 2) == &#39;_&#39;) {</span>
<span class="udiff-line-removed">-         auto mutableLanguageCode = adoptCF(CFStringCreateMutableCopy(kCFAllocatorDefault, 0, language));</span>
<span class="udiff-line-modified-added">+     if (CFStringGetLength(mutableLanguageCode.get()) &gt;= 3 &amp;&amp; CFStringGetCharacterAtIndex(mutableLanguageCode.get(), 2) == &#39;_&#39;)</span>
          CFStringReplace(mutableLanguageCode.get(), CFRangeMake(2, 1), CFSTR(&quot;-&quot;));
<span class="udiff-line-removed">-         return mutableLanguageCode.get();</span>
<span class="udiff-line-removed">-     }</span>
  
<span class="udiff-line-modified-removed">-     return language;</span>
<span class="udiff-line-modified-added">+     CFStringLowercase(mutableLanguageCode.get(), nullptr);</span>
<span class="udiff-line-added">+     return mutableLanguageCode.get();</span>
<span class="udiff-line-added">+ </span>
  }
  
  #if PLATFORM(MAC)
  static void languagePreferencesDidChange(CFNotificationCenterRef, void*, CFStringRef, const void*, CFDictionaryRef)
  {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -96,10 +107,13 @@</span>
      std::lock_guard&lt;Lock&gt; lock(preferredLanguagesMutex);
      Vector&lt;String&gt;&amp; userPreferredLanguages = preferredLanguages();
  
      if (userPreferredLanguages.isEmpty()) {
          RetainPtr&lt;CFArrayRef&gt; languages = adoptCF(CFLocaleCopyPreferredLanguages());
<span class="udiff-line-added">+ #if !PLATFORM(JAVA)</span>
<span class="udiff-line-added">+         languages = minimizedLanguagesFromLanguages(languages.get());</span>
<span class="udiff-line-added">+ #endif</span>
          CFIndex languageCount = CFArrayGetCount(languages.get());
          if (!languageCount)
              userPreferredLanguages.append(&quot;en&quot;);
          else {
              for (CFIndex i = 0; i &lt; languageCount; i++)
</pre>
<center><a href="../WordLock.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="RunLoopCF.cpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>