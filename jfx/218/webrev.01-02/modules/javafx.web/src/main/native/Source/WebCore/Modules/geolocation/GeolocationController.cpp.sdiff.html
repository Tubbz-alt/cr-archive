<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WebCore/Modules/geolocation/GeolocationController.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="GeolocationClient.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="GeolocationController.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/Modules/geolocation/GeolocationController.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 47 
 48     // NOTE: We don&#39;t have to remove ourselves from page&#39;s ActivityStateChangeObserver set, since
 49     // we are supplement of the Page, and our destructor getting called means the page is being
 50     // torn down.
 51 
 52     m_client.geolocationDestroyed();
 53 }
 54 
 55 void GeolocationController::addObserver(Geolocation&amp; observer, bool enableHighAccuracy)
 56 {
 57     // This may be called multiple times with the same observer, though removeObserver()
 58     // is called only once with each.
 59     bool wasEmpty = m_observers.isEmpty();
 60     m_observers.add(observer);
 61     if (enableHighAccuracy)
 62         m_highAccuracyObservers.add(observer);
 63 
 64     if (enableHighAccuracy)
 65         m_client.setEnableHighAccuracy(true);
 66     if (wasEmpty &amp;&amp; m_page.isVisible())
<span class="line-modified"> 67         m_client.startUpdating();</span>
 68 }
 69 
 70 void GeolocationController::removeObserver(Geolocation&amp; observer)
 71 {
 72     if (!m_observers.contains(observer))
 73         return;
 74 
 75     m_observers.remove(observer);
 76     m_highAccuracyObservers.remove(observer);
 77 
 78     if (m_observers.isEmpty())
 79         m_client.stopUpdating();
 80     else if (m_highAccuracyObservers.isEmpty())
 81         m_client.setEnableHighAccuracy(false);
 82 }
 83 





 84 void GeolocationController::requestPermission(Geolocation&amp; geolocation)
 85 {
 86     if (!m_page.isVisible()) {
 87         m_pendingPermissionRequest.add(geolocation);
 88         return;
 89     }
 90 
 91     m_client.requestPermission(geolocation);
 92 }
 93 
 94 void GeolocationController::cancelPermissionRequest(Geolocation&amp; geolocation)
 95 {
 96     if (m_pendingPermissionRequest.remove(geolocation))
 97         return;
 98 
 99     m_client.cancelPermissionRequest(geolocation);
100 }
101 
102 void GeolocationController::positionChanged(const Optional&lt;GeolocationPositionData&gt;&amp; position)
103 {
</pre>
<hr />
<pre>
117     for (auto&amp; observer : m_observers)
118         observersVector.uncheckedAppend(observer.copyRef());
119     for (auto&amp; observer : observersVector)
120         observer-&gt;setError(error);
121 }
122 
123 Optional&lt;GeolocationPositionData&gt; GeolocationController::lastPosition()
124 {
125     if (m_lastPosition)
126         return m_lastPosition.value();
127 
128     return m_client.lastPosition();
129 }
130 
131 void GeolocationController::activityStateDidChange(OptionSet&lt;ActivityState::Flag&gt; oldActivityState, OptionSet&lt;ActivityState::Flag&gt; newActivityState)
132 {
133     // Toggle GPS based on page visibility to save battery.
134     auto changed = oldActivityState ^ newActivityState;
135     if (changed &amp; ActivityState::IsVisible &amp;&amp; !m_observers.isEmpty()) {
136         if (newActivityState &amp; ActivityState::IsVisible)
<span class="line-modified">137             m_client.startUpdating();</span>
138         else
139             m_client.stopUpdating();
140     }
141 
142     if (!m_page.isVisible())
143         return;
144 
145     auto pendedPermissionRequests = WTFMove(m_pendingPermissionRequest);
146     for (auto&amp; permissionRequest : pendedPermissionRequests)
147         m_client.requestPermission(permissionRequest.get());
148 }
149 
150 const char* GeolocationController::supplementName()
151 {
152     return &quot;GeolocationController&quot;;
153 }
154 
155 void provideGeolocationTo(Page* page, GeolocationClient&amp; client)
156 {
157     ASSERT(page);
</pre>
</td>
<td>
<hr />
<pre>
 47 
 48     // NOTE: We don&#39;t have to remove ourselves from page&#39;s ActivityStateChangeObserver set, since
 49     // we are supplement of the Page, and our destructor getting called means the page is being
 50     // torn down.
 51 
 52     m_client.geolocationDestroyed();
 53 }
 54 
 55 void GeolocationController::addObserver(Geolocation&amp; observer, bool enableHighAccuracy)
 56 {
 57     // This may be called multiple times with the same observer, though removeObserver()
 58     // is called only once with each.
 59     bool wasEmpty = m_observers.isEmpty();
 60     m_observers.add(observer);
 61     if (enableHighAccuracy)
 62         m_highAccuracyObservers.add(observer);
 63 
 64     if (enableHighAccuracy)
 65         m_client.setEnableHighAccuracy(true);
 66     if (wasEmpty &amp;&amp; m_page.isVisible())
<span class="line-modified"> 67         m_client.startUpdating(observer.authorizationToken());</span>
 68 }
 69 
 70 void GeolocationController::removeObserver(Geolocation&amp; observer)
 71 {
 72     if (!m_observers.contains(observer))
 73         return;
 74 
 75     m_observers.remove(observer);
 76     m_highAccuracyObservers.remove(observer);
 77 
 78     if (m_observers.isEmpty())
 79         m_client.stopUpdating();
 80     else if (m_highAccuracyObservers.isEmpty())
 81         m_client.setEnableHighAccuracy(false);
 82 }
 83 
<span class="line-added"> 84 void GeolocationController::revokeAuthorizationToken(const String&amp; authorizationToken)</span>
<span class="line-added"> 85 {</span>
<span class="line-added"> 86     m_client.revokeAuthorizationToken(authorizationToken);</span>
<span class="line-added"> 87 }</span>
<span class="line-added"> 88 </span>
 89 void GeolocationController::requestPermission(Geolocation&amp; geolocation)
 90 {
 91     if (!m_page.isVisible()) {
 92         m_pendingPermissionRequest.add(geolocation);
 93         return;
 94     }
 95 
 96     m_client.requestPermission(geolocation);
 97 }
 98 
 99 void GeolocationController::cancelPermissionRequest(Geolocation&amp; geolocation)
100 {
101     if (m_pendingPermissionRequest.remove(geolocation))
102         return;
103 
104     m_client.cancelPermissionRequest(geolocation);
105 }
106 
107 void GeolocationController::positionChanged(const Optional&lt;GeolocationPositionData&gt;&amp; position)
108 {
</pre>
<hr />
<pre>
122     for (auto&amp; observer : m_observers)
123         observersVector.uncheckedAppend(observer.copyRef());
124     for (auto&amp; observer : observersVector)
125         observer-&gt;setError(error);
126 }
127 
128 Optional&lt;GeolocationPositionData&gt; GeolocationController::lastPosition()
129 {
130     if (m_lastPosition)
131         return m_lastPosition.value();
132 
133     return m_client.lastPosition();
134 }
135 
136 void GeolocationController::activityStateDidChange(OptionSet&lt;ActivityState::Flag&gt; oldActivityState, OptionSet&lt;ActivityState::Flag&gt; newActivityState)
137 {
138     // Toggle GPS based on page visibility to save battery.
139     auto changed = oldActivityState ^ newActivityState;
140     if (changed &amp; ActivityState::IsVisible &amp;&amp; !m_observers.isEmpty()) {
141         if (newActivityState &amp; ActivityState::IsVisible)
<span class="line-modified">142             m_client.startUpdating((*m_observers.random())-&gt;authorizationToken());</span>
143         else
144             m_client.stopUpdating();
145     }
146 
147     if (!m_page.isVisible())
148         return;
149 
150     auto pendedPermissionRequests = WTFMove(m_pendingPermissionRequest);
151     for (auto&amp; permissionRequest : pendedPermissionRequests)
152         m_client.requestPermission(permissionRequest.get());
153 }
154 
155 const char* GeolocationController::supplementName()
156 {
157     return &quot;GeolocationController&quot;;
158 }
159 
160 void provideGeolocationTo(Page* page, GeolocationClient&amp; client)
161 {
162     ASSERT(page);
</pre>
</td>
</tr>
</table>
<center><a href="GeolocationClient.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="GeolocationController.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>