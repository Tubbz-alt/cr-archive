<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/JavaScriptCore/offlineasm/mips.rb</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="instructions.rb.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="parser.rb.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/JavaScriptCore/offlineasm/mips.rb</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  26 
  27 # GPR conventions, to match the baseline JIT
  28 #
  29 # $a0 =&gt; a0, t7
  30 # $a1 =&gt; a1, t8
  31 # $a2 =&gt; a2, t9
  32 # $a3 =&gt; a3, t10
  33 # $v0 =&gt; t0, r0
  34 # $v1 =&gt; t1, r1
  35 # $t0 =&gt;            (scratch)
  36 # $t1 =&gt;            (scratch)
  37 # $t2 =&gt;         t2
  38 # $t3 =&gt;         t3
  39 # $t4 =&gt;         t4
  40 # $t5 =&gt;         t5
  41 # $t6 =&gt;         t6
  42 # $t7 =&gt;            (scratch)
  43 # $t8 =&gt;            (scratch)
  44 # $t9 =&gt;            (stores the callee of a call opcode)
  45 # $gp =&gt;            (globals)


  46 # $s4 =&gt;            (callee-save used to preserve $gp across calls)
  47 # $ra =&gt; lr
  48 # $sp =&gt; sp
  49 # $fp =&gt; cfr
  50 #
  51 # FPR conventions, to match the baseline JIT
  52 # We don&#39;t have fa2 or fa3!
  53 #  $f0 =&gt; ft0, fr
  54 #  $f2 =&gt; ft1
  55 #  $f4 =&gt; ft2
  56 #  $f6 =&gt; ft3
  57 #  $f8 =&gt; ft4
  58 # $f10 =&gt; ft5
  59 # $f12 =&gt;        fa0
  60 # $f14 =&gt;        fa1
  61 # $f16 =&gt;            (scratch)
  62 # $f18 =&gt;            (scratch)
  63 
  64 class Assembler
  65     def putStr(str)
</pre>
<hr />
<pre>
  82 
  83 class SpecialRegister &lt; NoChildren
  84     def mipsOperand
  85         @name
  86     end
  87 
  88     def dump
  89         @name
  90     end
  91 
  92     def register?
  93         true
  94     end
  95 end
  96 
  97 MIPS_TEMP_GPRS = [SpecialRegister.new(&quot;$t0&quot;), SpecialRegister.new(&quot;$t1&quot;), SpecialRegister.new(&quot;$t7&quot;), SpecialRegister.new(&quot;$t8&quot;)]
  98 MIPS_ZERO_REG = SpecialRegister.new(&quot;$zero&quot;)
  99 MIPS_GP_REG = SpecialRegister.new(&quot;$gp&quot;)
 100 MIPS_GPSAVE_REG = SpecialRegister.new(&quot;$s4&quot;)
 101 MIPS_CALL_REG = SpecialRegister.new(&quot;$t9&quot;)

 102 MIPS_TEMP_FPRS = [SpecialRegister.new(&quot;$f16&quot;)]
 103 MIPS_SCRATCH_FPR = SpecialRegister.new(&quot;$f18&quot;)
 104 
 105 def mipsMoveImmediate(value, register)
 106     if value == 0
 107         $asm.puts &quot;add #{register.mipsOperand}, $zero, $zero&quot;
 108     else
 109         $asm.puts &quot;li #{register.mipsOperand}, #{value}&quot;
 110     end
 111 end
 112 
 113 class RegisterID
 114     def mipsOperand
 115         case name
 116         when &quot;a0&quot;, &quot;t7&quot;
 117             &quot;$a0&quot;
 118         when &quot;a1&quot;, &quot;t8&quot;
 119             &quot;$a1&quot;
 120         when &quot;a2&quot;, &quot;t9&quot;
 121             &quot;$a2&quot;
 122         when &quot;a3&quot;, &quot;t10&quot;
 123             &quot;$a3&quot;
 124         when &quot;t0&quot;, &quot;r0&quot;
 125             &quot;$v0&quot;
 126         when &quot;t1&quot;, &quot;r1&quot;
 127             &quot;$v1&quot;
 128         when &quot;t2&quot;
 129             &quot;$t2&quot;
 130         when &quot;t3&quot;
 131             &quot;$t3&quot;
 132         when &quot;t4&quot;
 133             &quot;$t4&quot;
 134         when &quot;t5&quot;
 135             &quot;$t5&quot;
 136         when &quot;cfr&quot;
 137             &quot;$fp&quot;
 138         when &quot;csr0&quot;
 139             &quot;$s0&quot;


 140         when &quot;lr&quot;
 141             &quot;$ra&quot;
 142         when &quot;sp&quot;
 143             &quot;$sp&quot;
 144         else
 145             raise &quot;Bad register #{name} for MIPS at #{codeOriginString}&quot;
 146         end
 147     end
 148 end
 149 
 150 class FPRegisterID
 151     def mipsOperand
 152         case name
 153         when &quot;ft0&quot;, &quot;fr&quot;
 154             &quot;$f0&quot;
 155         when &quot;ft1&quot;
 156             &quot;$f2&quot;
 157         when &quot;ft2&quot;
 158             &quot;$f4&quot;
 159         when &quot;ft3&quot;
</pre>
<hr />
<pre>
 510 #
 511 
 512 def mipsLowerMisplacedImmediates(list)
 513     newList = []
 514     list.each {
 515         | node |
 516         if node.is_a? Instruction
 517             case node.opcode
 518             when &quot;slt&quot;, &quot;sltu&quot;, &quot;sltb&quot;, &quot;sltub&quot;
 519                 if node.operands[1].is_a? Immediate
 520                     tmp = Tmp.new(node.codeOrigin, :gpr)
 521                     newList &lt;&lt; Instruction.new(node.codeOrigin, &quot;move&quot;, [node.operands[1], tmp], node.annotation)
 522                     newList &lt;&lt; Instruction.new(node.codeOrigin, node.opcode,
 523                                                [node.operands[0], tmp, node.operands[2]],
 524                                                node.annotation)
 525                 else
 526                     newList &lt;&lt; node
 527                 end
 528             when /^(addi|subi)/
 529                 newList &lt;&lt; node.riscLowerMalformedImmediatesRecurse(newList, -0x7fff..0x7fff)
<span class="line-modified"> 530             when &quot;andi&quot;, &quot;andp&quot;, &quot;ori&quot;, &quot;orp&quot;, &quot;xori&quot;, &quot;xorp&quot;</span>
 531                 newList &lt;&lt; node.riscLowerMalformedImmediatesRecurse(newList, 0..0xffff)
 532             else
 533                 newList &lt;&lt; node
 534             end
 535         else
 536             newList &lt;&lt; node
 537         end
 538     }
 539     newList
 540 end
 541 
 542 #
 543 # Specialization of lowering of misplaced addresses.
 544 #
 545 
 546 class LocalLabelReference
 547     def register?
 548         false
 549     end
 550 end
</pre>
<hr />
<pre>
 663 class Address
 664     def mipsEmitLea(destination)
 665         if destination == base
 666             $asm.puts &quot;addiu #{destination.mipsOperand}, #{offset.value}&quot;
 667         else
 668             $asm.puts &quot;addiu #{destination.mipsOperand}, #{base.mipsOperand}, #{offset.value}&quot;
 669         end
 670     end
 671 end
 672 
 673 #
 674 # Add PIC compatible header code to all the LLInt rutins.
 675 #
 676 
 677 def mipsAddPICCode(list)
 678     myList = []
 679     list.each {
 680         | node |
 681         myList &lt;&lt; node
 682         if node.is_a? Label
<span class="line-modified"> 683             myList &lt;&lt; Instruction.new(node.codeOrigin, &quot;pichdr&quot;, [])</span>










 684         end
 685     }
 686     myList
 687 end
 688 
 689 #
 690 # Actual lowering code follows.
 691 #
 692 
 693 class Sequence
 694     def getModifiedListMIPS
 695         result = @list
 696 
 697         # Verify that we will only see instructions and labels.
 698         result.each {
 699             | node |
 700             unless node.is_a? Instruction or
 701                     node.is_a? Label or
 702                     node.is_a? LocalLabel or
 703                     node.is_a? Skip
</pre>
<hr />
<pre>
 706         }
 707 
 708         result = mipsAddPICCode(result)
 709         result = mipsLowerFarBranchOps(result)
 710         result = mipsLowerSimpleBranchOps(result)
 711         result = riscLowerSimpleBranchOps(result)
 712         result = riscLowerHardBranchOps(result)
 713         result = riscLowerShiftOps(result)
 714         result = mipsLowerBaseIndexAddresses(result)
 715         result = riscLowerMalformedAddresses(result) {
 716             | node, address |
 717             if address.is_a? Address
 718                 (-0x7fff..0x7fff).include? address.offset.value
 719             else
 720                 false
 721             end
 722         }
 723         result = riscLowerMalformedAddressesDouble(result)
 724         result = riscLowerMisplacedImmediates(result, [&quot;storeb&quot;, &quot;storei&quot;, &quot;storep&quot;])
 725         result = mipsLowerMisplacedImmediates(result)
<span class="line-modified"> 726         result = riscLowerMalformedImmediates(result, -0x7fff..0x7fff)</span>
 727         result = mipsLowerMisplacedAddresses(result)
 728         result = riscLowerMisplacedAddresses(result)
 729         result = riscLowerRegisterReuse(result)
 730         result = mipsLowerCompares(result)
 731         result = assignRegistersToTemporaries(result, :gpr, MIPS_TEMP_GPRS)
 732         result = assignRegistersToTemporaries(result, :fpr, MIPS_TEMP_FPRS)
 733 
 734         return result
 735     end
 736 end
 737 
 738 def mipsOperands(operands)
 739     operands.map{|v| v.mipsOperand}.join(&quot;, &quot;)
 740 end
 741 
 742 def mipsFlippedOperands(operands)
 743     mipsOperands([operands[-1]] + operands[0..-2])
 744 end
 745 
 746 def getMIPSOpcode(opcode, suffix)
</pre>
<hr />
<pre>
 837                         $asm.puts &quot;move #{operands[2].mipsOperand}, #{operands[1].mipsOperand}&quot;
 838                     end
 839                 else
 840                     $asm.puts &quot;addiu #{operands[2].mipsOperand}, #{operands[1].mipsOperand}, #{operands[0].mipsOperand}&quot;
 841                 end
 842             elsif operands.size == 3 and operands[0].register?
 843                 raise unless operands[1].register?
 844                 raise unless operands[2].register?
 845                 $asm.puts &quot;addu #{mipsFlippedOperands(operands)}&quot;
 846             else
 847                 if operands[0].is_a? Immediate
 848                     unless Immediate.new(nil, 0) == operands[0]
 849                         $asm.puts &quot;addiu #{operands[1].mipsOperand}, #{mipsFlippedOperands(operands)}&quot;
 850                     end
 851                 else
 852                     $asm.puts &quot;addu #{operands[1].mipsOperand}, #{operands[1].mipsOperand}, #{operands[0].mipsOperand}&quot;
 853                 end
 854             end
 855         when &quot;andi&quot;, &quot;andp&quot;
 856             emitMIPSCompact(&quot;and&quot;, &quot;and&quot;, operands)
<span class="line-modified"> 857         when &quot;ori&quot;, &quot;orp&quot;</span>
 858             emitMIPSCompact(&quot;or&quot;, &quot;orr&quot;, operands)
 859         when &quot;oris&quot;
 860             emitMIPSCompact(&quot;or&quot;, &quot;orrs&quot;, operands)
 861         when &quot;xori&quot;, &quot;xorp&quot;
 862             emitMIPSCompact(&quot;xor&quot;, &quot;eor&quot;, operands)
 863         when &quot;lshifti&quot;, &quot;lshiftp&quot;
 864             emitMIPSShiftCompact(&quot;sll&quot;, operands)
 865         when &quot;rshifti&quot;, &quot;rshiftp&quot;
 866             emitMIPSShiftCompact(&quot;sra&quot;, operands)
 867         when &quot;urshifti&quot;, &quot;urshiftp&quot;
 868             emitMIPSShiftCompact(&quot;srl&quot;, operands)
 869         when &quot;muli&quot;, &quot;mulp&quot;
 870             emitMIPS(&quot;mul&quot;, operands)
 871         when &quot;subi&quot;, &quot;subp&quot;, &quot;subis&quot;
 872             emitMIPSCompact(&quot;sub&quot;, &quot;subs&quot;, operands)
 873         when &quot;negi&quot;, &quot;negp&quot;
 874             $asm.puts &quot;negu #{operands[0].mipsOperand}, #{operands[0].mipsOperand}&quot;
 875         when &quot;noti&quot;
 876             $asm.puts &quot;nor #{operands[0].mipsOperand}, #{operands[0].mipsOperand}, $zero&quot;
 877         when &quot;loadi&quot;, &quot;loadis&quot;, &quot;loadp&quot;
</pre>
<hr />
<pre>
 889         when &quot;loadhsi&quot;
 890             $asm.puts &quot;lh #{mipsFlippedOperands(operands)}&quot;
 891         when &quot;storeh&quot;
 892             $asm.puts &quot;shv #{mipsOperands(operands)}&quot;
 893         when &quot;loadd&quot;
 894             $asm.puts &quot;ldc1 #{mipsFlippedOperands(operands)}&quot;
 895         when &quot;stored&quot;
 896             $asm.puts &quot;sdc1 #{mipsOperands(operands)}&quot;
 897         when &quot;la&quot;
 898             $asm.puts &quot;la #{operands[1].mipsOperand}, #{operands[0].asmLabel}&quot;
 899         when &quot;addd&quot;
 900             emitMIPS(&quot;add.d&quot;, operands)
 901         when &quot;divd&quot;
 902             emitMIPS(&quot;div.d&quot;, operands)
 903         when &quot;subd&quot;
 904             emitMIPS(&quot;sub.d&quot;, operands)
 905         when &quot;muld&quot;
 906             emitMIPS(&quot;mul.d&quot;, operands)
 907         when &quot;sqrtd&quot;
 908             $asm.puts &quot;sqrt.d #{mipsFlippedOperands(operands)}&quot;
<span class="line-modified"> 909         when &quot;ci2d&quot;</span>
 910             raise &quot;invalid ops of #{self.inspect} at #{codeOriginString}&quot; unless operands[1].is_a? FPRegisterID and operands[0].register?
 911             $asm.puts &quot;mtc1 #{operands[0].mipsOperand}, #{operands[1].mipsOperand}&quot;
 912             $asm.puts &quot;cvt.d.w #{operands[1].mipsOperand}, #{operands[1].mipsOperand}&quot;
 913         when &quot;bdeq&quot;
 914             emitMIPSDoubleBranch(&quot;eq&quot;, false, operands)
 915         when &quot;bdneq&quot;
 916             emitMIPSDoubleBranch(&quot;ueq&quot;, true, operands)
 917         when &quot;bdgt&quot;
 918             emitMIPSDoubleBranch(&quot;ule&quot;, true, operands)
 919         when &quot;bdgteq&quot;
 920             emitMIPSDoubleBranch(&quot;ult&quot;, true, operands)
 921         when &quot;bdlt&quot;
 922             emitMIPSDoubleBranch(&quot;olt&quot;, false, operands)
 923         when &quot;bdlteq&quot;
 924             emitMIPSDoubleBranch(&quot;ole&quot;, false, operands)
 925         when &quot;bdequn&quot;
 926             emitMIPSDoubleBranch(&quot;ueq&quot;, false, operands)
 927         when &quot;bdnequn&quot;
 928             emitMIPSDoubleBranch(&quot;eq&quot;, true, operands)
 929         when &quot;bdgtun&quot;
</pre>
<hr />
<pre>
1044             else
1045                 operands[0].mipsEmitLea(operands[1])
1046             end
1047 
1048         when &quot;smulli&quot;
1049             raise &quot;Wrong number of arguments to smull in #{self.inspect} at #{codeOriginString}&quot; unless operands.length == 4
1050             $asm.puts &quot;mult #{operands[0].mipsOperand}, #{operands[1].mipsOperand}&quot;
1051             $asm.puts &quot;mflo #{operands[2].mipsOperand}&quot;
1052             $asm.puts &quot;mfhi #{operands[3].mipsOperand}&quot;
1053         when &quot;movz&quot;
1054             $asm.puts &quot;movz #{operands[0].mipsOperand}, #{operands[1].mipsOperand}, #{operands[2].mipsOperand}&quot;
1055         when &quot;movn&quot;
1056             $asm.puts &quot;movn #{operands[0].mipsOperand}, #{operands[1].mipsOperand}, #{operands[2].mipsOperand}&quot;
1057         when &quot;setcallreg&quot;
1058             $asm.puts &quot;move #{MIPS_CALL_REG.mipsOperand}, #{operands[0].mipsOperand}&quot;
1059         when &quot;slt&quot;, &quot;sltb&quot;
1060             $asm.puts &quot;slt #{operands[0].mipsOperand}, #{operands[1].mipsOperand}, #{operands[2].mipsOperand}&quot;
1061         when &quot;sltu&quot;, &quot;sltub&quot;
1062             $asm.puts &quot;sltu #{operands[0].mipsOperand}, #{operands[1].mipsOperand}, #{operands[2].mipsOperand}&quot;
1063         when &quot;pichdr&quot;
<span class="line-modified">1064             $asm.putStr(&quot;OFFLINE_ASM_CPLOAD(#{MIPS_CALL_REG.mipsOperand})&quot;)</span>
1065         when &quot;memfence&quot;
1066             $asm.puts &quot;sync&quot;
1067         else
1068             lowerDefault
1069         end
1070     end
1071 end
</pre>
</td>
<td>
<hr />
<pre>
  26 
  27 # GPR conventions, to match the baseline JIT
  28 #
  29 # $a0 =&gt; a0, t7
  30 # $a1 =&gt; a1, t8
  31 # $a2 =&gt; a2, t9
  32 # $a3 =&gt; a3, t10
  33 # $v0 =&gt; t0, r0
  34 # $v1 =&gt; t1, r1
  35 # $t0 =&gt;            (scratch)
  36 # $t1 =&gt;            (scratch)
  37 # $t2 =&gt;         t2
  38 # $t3 =&gt;         t3
  39 # $t4 =&gt;         t4
  40 # $t5 =&gt;         t5
  41 # $t6 =&gt;         t6
  42 # $t7 =&gt;            (scratch)
  43 # $t8 =&gt;            (scratch)
  44 # $t9 =&gt;            (stores the callee of a call opcode)
  45 # $gp =&gt;            (globals)
<span class="line-added">  46 # $s0 =&gt; csr0       (callee-save, metadataTable)</span>
<span class="line-added">  47 # $s1 =&gt; csr1       (callee-save, PB)</span>
  48 # $s4 =&gt;            (callee-save used to preserve $gp across calls)
  49 # $ra =&gt; lr
  50 # $sp =&gt; sp
  51 # $fp =&gt; cfr
  52 #
  53 # FPR conventions, to match the baseline JIT
  54 # We don&#39;t have fa2 or fa3!
  55 #  $f0 =&gt; ft0, fr
  56 #  $f2 =&gt; ft1
  57 #  $f4 =&gt; ft2
  58 #  $f6 =&gt; ft3
  59 #  $f8 =&gt; ft4
  60 # $f10 =&gt; ft5
  61 # $f12 =&gt;        fa0
  62 # $f14 =&gt;        fa1
  63 # $f16 =&gt;            (scratch)
  64 # $f18 =&gt;            (scratch)
  65 
  66 class Assembler
  67     def putStr(str)
</pre>
<hr />
<pre>
  84 
  85 class SpecialRegister &lt; NoChildren
  86     def mipsOperand
  87         @name
  88     end
  89 
  90     def dump
  91         @name
  92     end
  93 
  94     def register?
  95         true
  96     end
  97 end
  98 
  99 MIPS_TEMP_GPRS = [SpecialRegister.new(&quot;$t0&quot;), SpecialRegister.new(&quot;$t1&quot;), SpecialRegister.new(&quot;$t7&quot;), SpecialRegister.new(&quot;$t8&quot;)]
 100 MIPS_ZERO_REG = SpecialRegister.new(&quot;$zero&quot;)
 101 MIPS_GP_REG = SpecialRegister.new(&quot;$gp&quot;)
 102 MIPS_GPSAVE_REG = SpecialRegister.new(&quot;$s4&quot;)
 103 MIPS_CALL_REG = SpecialRegister.new(&quot;$t9&quot;)
<span class="line-added"> 104 MIPS_RETURN_ADDRESS_REG = SpecialRegister.new(&quot;$ra&quot;)</span>
 105 MIPS_TEMP_FPRS = [SpecialRegister.new(&quot;$f16&quot;)]
 106 MIPS_SCRATCH_FPR = SpecialRegister.new(&quot;$f18&quot;)
 107 
 108 def mipsMoveImmediate(value, register)
 109     if value == 0
 110         $asm.puts &quot;add #{register.mipsOperand}, $zero, $zero&quot;
 111     else
 112         $asm.puts &quot;li #{register.mipsOperand}, #{value}&quot;
 113     end
 114 end
 115 
 116 class RegisterID
 117     def mipsOperand
 118         case name
 119         when &quot;a0&quot;, &quot;t7&quot;
 120             &quot;$a0&quot;
 121         when &quot;a1&quot;, &quot;t8&quot;
 122             &quot;$a1&quot;
 123         when &quot;a2&quot;, &quot;t9&quot;
 124             &quot;$a2&quot;
 125         when &quot;a3&quot;, &quot;t10&quot;
 126             &quot;$a3&quot;
 127         when &quot;t0&quot;, &quot;r0&quot;
 128             &quot;$v0&quot;
 129         when &quot;t1&quot;, &quot;r1&quot;
 130             &quot;$v1&quot;
 131         when &quot;t2&quot;
 132             &quot;$t2&quot;
 133         when &quot;t3&quot;
 134             &quot;$t3&quot;
 135         when &quot;t4&quot;
 136             &quot;$t4&quot;
 137         when &quot;t5&quot;
 138             &quot;$t5&quot;
 139         when &quot;cfr&quot;
 140             &quot;$fp&quot;
 141         when &quot;csr0&quot;
 142             &quot;$s0&quot;
<span class="line-added"> 143         when &quot;csr1&quot;</span>
<span class="line-added"> 144             &quot;$s1&quot;</span>
 145         when &quot;lr&quot;
 146             &quot;$ra&quot;
 147         when &quot;sp&quot;
 148             &quot;$sp&quot;
 149         else
 150             raise &quot;Bad register #{name} for MIPS at #{codeOriginString}&quot;
 151         end
 152     end
 153 end
 154 
 155 class FPRegisterID
 156     def mipsOperand
 157         case name
 158         when &quot;ft0&quot;, &quot;fr&quot;
 159             &quot;$f0&quot;
 160         when &quot;ft1&quot;
 161             &quot;$f2&quot;
 162         when &quot;ft2&quot;
 163             &quot;$f4&quot;
 164         when &quot;ft3&quot;
</pre>
<hr />
<pre>
 515 #
 516 
 517 def mipsLowerMisplacedImmediates(list)
 518     newList = []
 519     list.each {
 520         | node |
 521         if node.is_a? Instruction
 522             case node.opcode
 523             when &quot;slt&quot;, &quot;sltu&quot;, &quot;sltb&quot;, &quot;sltub&quot;
 524                 if node.operands[1].is_a? Immediate
 525                     tmp = Tmp.new(node.codeOrigin, :gpr)
 526                     newList &lt;&lt; Instruction.new(node.codeOrigin, &quot;move&quot;, [node.operands[1], tmp], node.annotation)
 527                     newList &lt;&lt; Instruction.new(node.codeOrigin, node.opcode,
 528                                                [node.operands[0], tmp, node.operands[2]],
 529                                                node.annotation)
 530                 else
 531                     newList &lt;&lt; node
 532                 end
 533             when /^(addi|subi)/
 534                 newList &lt;&lt; node.riscLowerMalformedImmediatesRecurse(newList, -0x7fff..0x7fff)
<span class="line-modified"> 535             when &quot;andi&quot;, &quot;andp&quot;, &quot;ori&quot;, &quot;orp&quot;, &quot;orh&quot;, &quot;xori&quot;, &quot;xorp&quot;</span>
 536                 newList &lt;&lt; node.riscLowerMalformedImmediatesRecurse(newList, 0..0xffff)
 537             else
 538                 newList &lt;&lt; node
 539             end
 540         else
 541             newList &lt;&lt; node
 542         end
 543     }
 544     newList
 545 end
 546 
 547 #
 548 # Specialization of lowering of misplaced addresses.
 549 #
 550 
 551 class LocalLabelReference
 552     def register?
 553         false
 554     end
 555 end
</pre>
<hr />
<pre>
 668 class Address
 669     def mipsEmitLea(destination)
 670         if destination == base
 671             $asm.puts &quot;addiu #{destination.mipsOperand}, #{offset.value}&quot;
 672         else
 673             $asm.puts &quot;addiu #{destination.mipsOperand}, #{base.mipsOperand}, #{offset.value}&quot;
 674         end
 675     end
 676 end
 677 
 678 #
 679 # Add PIC compatible header code to all the LLInt rutins.
 680 #
 681 
 682 def mipsAddPICCode(list)
 683     myList = []
 684     list.each {
 685         | node |
 686         myList &lt;&lt; node
 687         if node.is_a? Label
<span class="line-modified"> 688             # FIXME: [JSC] checkpoint_osr_exit_from_inlined_call_trampoline is a return location</span>
<span class="line-added"> 689             # and we should name it properly.</span>
<span class="line-added"> 690             # https://bugs.webkit.org/show_bug.cgi?id=208236</span>
<span class="line-added"> 691             if node.name =~ /^.*_return_location(?:_(?:wide16|wide32))?$/ or node.name.start_with?(&quot;_checkpoint_osr_exit_from_inlined_call_trampoline&quot;)</span>
<span class="line-added"> 692                 # We need to have a special case for return location labels because they are always</span>
<span class="line-added"> 693                 # reached from a `ret` instruction. In this case, we need to proper reconfigure `$gp`</span>
<span class="line-added"> 694                 # using `$ra` instead of using `$t9`.</span>
<span class="line-added"> 695                 myList &lt;&lt; Instruction.new(node.codeOrigin, &quot;pichdr&quot;, [MIPS_RETURN_ADDRESS_REG])</span>
<span class="line-added"> 696             else</span>
<span class="line-added"> 697                 myList &lt;&lt; Instruction.new(node.codeOrigin, &quot;pichdr&quot;, [MIPS_CALL_REG])</span>
<span class="line-added"> 698             end</span>
 699         end
 700     }
 701     myList
 702 end
 703 
 704 #
 705 # Actual lowering code follows.
 706 #
 707 
 708 class Sequence
 709     def getModifiedListMIPS
 710         result = @list
 711 
 712         # Verify that we will only see instructions and labels.
 713         result.each {
 714             | node |
 715             unless node.is_a? Instruction or
 716                     node.is_a? Label or
 717                     node.is_a? LocalLabel or
 718                     node.is_a? Skip
</pre>
<hr />
<pre>
 721         }
 722 
 723         result = mipsAddPICCode(result)
 724         result = mipsLowerFarBranchOps(result)
 725         result = mipsLowerSimpleBranchOps(result)
 726         result = riscLowerSimpleBranchOps(result)
 727         result = riscLowerHardBranchOps(result)
 728         result = riscLowerShiftOps(result)
 729         result = mipsLowerBaseIndexAddresses(result)
 730         result = riscLowerMalformedAddresses(result) {
 731             | node, address |
 732             if address.is_a? Address
 733                 (-0x7fff..0x7fff).include? address.offset.value
 734             else
 735                 false
 736             end
 737         }
 738         result = riscLowerMalformedAddressesDouble(result)
 739         result = riscLowerMisplacedImmediates(result, [&quot;storeb&quot;, &quot;storei&quot;, &quot;storep&quot;])
 740         result = mipsLowerMisplacedImmediates(result)
<span class="line-modified"> 741         result = riscLowerMalformedImmediates(result, -0x7fff..0x7fff, -0x7fff..0x7fff)</span>
 742         result = mipsLowerMisplacedAddresses(result)
 743         result = riscLowerMisplacedAddresses(result)
 744         result = riscLowerRegisterReuse(result)
 745         result = mipsLowerCompares(result)
 746         result = assignRegistersToTemporaries(result, :gpr, MIPS_TEMP_GPRS)
 747         result = assignRegistersToTemporaries(result, :fpr, MIPS_TEMP_FPRS)
 748 
 749         return result
 750     end
 751 end
 752 
 753 def mipsOperands(operands)
 754     operands.map{|v| v.mipsOperand}.join(&quot;, &quot;)
 755 end
 756 
 757 def mipsFlippedOperands(operands)
 758     mipsOperands([operands[-1]] + operands[0..-2])
 759 end
 760 
 761 def getMIPSOpcode(opcode, suffix)
</pre>
<hr />
<pre>
 852                         $asm.puts &quot;move #{operands[2].mipsOperand}, #{operands[1].mipsOperand}&quot;
 853                     end
 854                 else
 855                     $asm.puts &quot;addiu #{operands[2].mipsOperand}, #{operands[1].mipsOperand}, #{operands[0].mipsOperand}&quot;
 856                 end
 857             elsif operands.size == 3 and operands[0].register?
 858                 raise unless operands[1].register?
 859                 raise unless operands[2].register?
 860                 $asm.puts &quot;addu #{mipsFlippedOperands(operands)}&quot;
 861             else
 862                 if operands[0].is_a? Immediate
 863                     unless Immediate.new(nil, 0) == operands[0]
 864                         $asm.puts &quot;addiu #{operands[1].mipsOperand}, #{mipsFlippedOperands(operands)}&quot;
 865                     end
 866                 else
 867                     $asm.puts &quot;addu #{operands[1].mipsOperand}, #{operands[1].mipsOperand}, #{operands[0].mipsOperand}&quot;
 868                 end
 869             end
 870         when &quot;andi&quot;, &quot;andp&quot;
 871             emitMIPSCompact(&quot;and&quot;, &quot;and&quot;, operands)
<span class="line-modified"> 872         when &quot;ori&quot;, &quot;orp&quot;, &quot;orh&quot;</span>
 873             emitMIPSCompact(&quot;or&quot;, &quot;orr&quot;, operands)
 874         when &quot;oris&quot;
 875             emitMIPSCompact(&quot;or&quot;, &quot;orrs&quot;, operands)
 876         when &quot;xori&quot;, &quot;xorp&quot;
 877             emitMIPSCompact(&quot;xor&quot;, &quot;eor&quot;, operands)
 878         when &quot;lshifti&quot;, &quot;lshiftp&quot;
 879             emitMIPSShiftCompact(&quot;sll&quot;, operands)
 880         when &quot;rshifti&quot;, &quot;rshiftp&quot;
 881             emitMIPSShiftCompact(&quot;sra&quot;, operands)
 882         when &quot;urshifti&quot;, &quot;urshiftp&quot;
 883             emitMIPSShiftCompact(&quot;srl&quot;, operands)
 884         when &quot;muli&quot;, &quot;mulp&quot;
 885             emitMIPS(&quot;mul&quot;, operands)
 886         when &quot;subi&quot;, &quot;subp&quot;, &quot;subis&quot;
 887             emitMIPSCompact(&quot;sub&quot;, &quot;subs&quot;, operands)
 888         when &quot;negi&quot;, &quot;negp&quot;
 889             $asm.puts &quot;negu #{operands[0].mipsOperand}, #{operands[0].mipsOperand}&quot;
 890         when &quot;noti&quot;
 891             $asm.puts &quot;nor #{operands[0].mipsOperand}, #{operands[0].mipsOperand}, $zero&quot;
 892         when &quot;loadi&quot;, &quot;loadis&quot;, &quot;loadp&quot;
</pre>
<hr />
<pre>
 904         when &quot;loadhsi&quot;
 905             $asm.puts &quot;lh #{mipsFlippedOperands(operands)}&quot;
 906         when &quot;storeh&quot;
 907             $asm.puts &quot;shv #{mipsOperands(operands)}&quot;
 908         when &quot;loadd&quot;
 909             $asm.puts &quot;ldc1 #{mipsFlippedOperands(operands)}&quot;
 910         when &quot;stored&quot;
 911             $asm.puts &quot;sdc1 #{mipsOperands(operands)}&quot;
 912         when &quot;la&quot;
 913             $asm.puts &quot;la #{operands[1].mipsOperand}, #{operands[0].asmLabel}&quot;
 914         when &quot;addd&quot;
 915             emitMIPS(&quot;add.d&quot;, operands)
 916         when &quot;divd&quot;
 917             emitMIPS(&quot;div.d&quot;, operands)
 918         when &quot;subd&quot;
 919             emitMIPS(&quot;sub.d&quot;, operands)
 920         when &quot;muld&quot;
 921             emitMIPS(&quot;mul.d&quot;, operands)
 922         when &quot;sqrtd&quot;
 923             $asm.puts &quot;sqrt.d #{mipsFlippedOperands(operands)}&quot;
<span class="line-modified"> 924         when &quot;ci2ds&quot;</span>
 925             raise &quot;invalid ops of #{self.inspect} at #{codeOriginString}&quot; unless operands[1].is_a? FPRegisterID and operands[0].register?
 926             $asm.puts &quot;mtc1 #{operands[0].mipsOperand}, #{operands[1].mipsOperand}&quot;
 927             $asm.puts &quot;cvt.d.w #{operands[1].mipsOperand}, #{operands[1].mipsOperand}&quot;
 928         when &quot;bdeq&quot;
 929             emitMIPSDoubleBranch(&quot;eq&quot;, false, operands)
 930         when &quot;bdneq&quot;
 931             emitMIPSDoubleBranch(&quot;ueq&quot;, true, operands)
 932         when &quot;bdgt&quot;
 933             emitMIPSDoubleBranch(&quot;ule&quot;, true, operands)
 934         when &quot;bdgteq&quot;
 935             emitMIPSDoubleBranch(&quot;ult&quot;, true, operands)
 936         when &quot;bdlt&quot;
 937             emitMIPSDoubleBranch(&quot;olt&quot;, false, operands)
 938         when &quot;bdlteq&quot;
 939             emitMIPSDoubleBranch(&quot;ole&quot;, false, operands)
 940         when &quot;bdequn&quot;
 941             emitMIPSDoubleBranch(&quot;ueq&quot;, false, operands)
 942         when &quot;bdnequn&quot;
 943             emitMIPSDoubleBranch(&quot;eq&quot;, true, operands)
 944         when &quot;bdgtun&quot;
</pre>
<hr />
<pre>
1059             else
1060                 operands[0].mipsEmitLea(operands[1])
1061             end
1062 
1063         when &quot;smulli&quot;
1064             raise &quot;Wrong number of arguments to smull in #{self.inspect} at #{codeOriginString}&quot; unless operands.length == 4
1065             $asm.puts &quot;mult #{operands[0].mipsOperand}, #{operands[1].mipsOperand}&quot;
1066             $asm.puts &quot;mflo #{operands[2].mipsOperand}&quot;
1067             $asm.puts &quot;mfhi #{operands[3].mipsOperand}&quot;
1068         when &quot;movz&quot;
1069             $asm.puts &quot;movz #{operands[0].mipsOperand}, #{operands[1].mipsOperand}, #{operands[2].mipsOperand}&quot;
1070         when &quot;movn&quot;
1071             $asm.puts &quot;movn #{operands[0].mipsOperand}, #{operands[1].mipsOperand}, #{operands[2].mipsOperand}&quot;
1072         when &quot;setcallreg&quot;
1073             $asm.puts &quot;move #{MIPS_CALL_REG.mipsOperand}, #{operands[0].mipsOperand}&quot;
1074         when &quot;slt&quot;, &quot;sltb&quot;
1075             $asm.puts &quot;slt #{operands[0].mipsOperand}, #{operands[1].mipsOperand}, #{operands[2].mipsOperand}&quot;
1076         when &quot;sltu&quot;, &quot;sltub&quot;
1077             $asm.puts &quot;sltu #{operands[0].mipsOperand}, #{operands[1].mipsOperand}, #{operands[2].mipsOperand}&quot;
1078         when &quot;pichdr&quot;
<span class="line-modified">1079             $asm.putStr(&quot;OFFLINE_ASM_CPLOAD(#{operands[0].mipsOperand})&quot;)</span>
1080         when &quot;memfence&quot;
1081             $asm.puts &quot;sync&quot;
1082         else
1083             lowerDefault
1084         end
1085     end
1086 end
</pre>
</td>
</tr>
</table>
<center><a href="instructions.rb.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="parser.rb.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>