<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/JavaScriptCore/wasm/js/JSWebAssembly.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="JSToWasmICCallee.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="JSWebAssembly.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/JavaScriptCore/wasm/js/JSWebAssembly.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 17  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 18  * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 19  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 20  * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 21  * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 22  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 23  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #include &quot;config.h&quot;
 27 #include &quot;JSWebAssembly.h&quot;
 28 
 29 #if ENABLE(WEBASSEMBLY)
 30 
 31 #include &quot;CatchScope.h&quot;
 32 #include &quot;Exception.h&quot;
 33 #include &quot;FunctionPrototype.h&quot;
 34 #include &quot;JSCBuiltins.h&quot;
 35 #include &quot;JSCInlines.h&quot;
 36 #include &quot;JSModuleNamespaceObject.h&quot;
<span class="line-modified"> 37 #include &quot;JSPromiseDeferred.h&quot;</span>
 38 #include &quot;JSToWasm.h&quot;
 39 #include &quot;JSWebAssemblyHelpers.h&quot;
 40 #include &quot;JSWebAssemblyInstance.h&quot;
 41 #include &quot;JSWebAssemblyModule.h&quot;
 42 #include &quot;ObjectConstructor.h&quot;
 43 #include &quot;Options.h&quot;
<span class="line-modified"> 44 #include &quot;PromiseDeferredTimer.h&quot;</span>
 45 #include &quot;StrongInlines.h&quot;
 46 #include &quot;ThrowScope.h&quot;
 47 #include &quot;WasmBBQPlan.h&quot;

 48 #include &quot;WasmToJS.h&quot;
 49 #include &quot;WasmWorklist.h&quot;
 50 #include &quot;WebAssemblyInstanceConstructor.h&quot;
 51 #include &quot;WebAssemblyModuleConstructor.h&quot;
 52 
 53 using JSC::Wasm::Plan;
 54 using JSC::Wasm::BBQPlan;
 55 
 56 namespace JSC {
 57 
 58 STATIC_ASSERT_IS_TRIVIALLY_DESTRUCTIBLE(JSWebAssembly);
 59 
 60 #define DEFINE_CALLBACK_FOR_CONSTRUCTOR(capitalName, lowerName, properName, instanceType, jsName, prototypeBase, featureFlag) \
 61 static JSValue create##capitalName(VM&amp; vm, JSObject* object) \
 62 { \
 63     JSWebAssembly* webAssembly = jsCast&lt;JSWebAssembly*&gt;(object); \
 64     JSGlobalObject* globalObject = webAssembly-&gt;globalObject(vm); \
 65     return globalObject-&gt;properName##Constructor(); \
 66 }
 67 
 68 FOR_EACH_WEBASSEMBLY_CONSTRUCTOR_TYPE(DEFINE_CALLBACK_FOR_CONSTRUCTOR)
 69 
 70 #undef DEFINE_CALLBACK_FOR_CONSTRUCTOR
 71 
<span class="line-modified"> 72 static EncodedJSValue JSC_HOST_CALL webAssemblyCompileFunc(ExecState*);</span>
<span class="line-modified"> 73 static EncodedJSValue JSC_HOST_CALL webAssemblyInstantiateFunc(ExecState*);</span>
<span class="line-modified"> 74 static EncodedJSValue JSC_HOST_CALL webAssemblyValidateFunc(ExecState*);</span>
 75 
 76 }
 77 
 78 #include &quot;JSWebAssembly.lut.h&quot;
 79 
 80 namespace JSC {
 81 
 82 const ClassInfo JSWebAssembly::s_info = { &quot;WebAssembly&quot;, &amp;Base::s_info, &amp;webAssemblyTable, nullptr, CREATE_METHOD_TABLE(JSWebAssembly) };
 83 
 84 /* Source for JSWebAssembly.lut.h
 85 @begin webAssemblyTable
 86   CompileError    createWebAssemblyCompileError  DontEnum|PropertyCallback

 87   Instance        createWebAssemblyInstance      DontEnum|PropertyCallback
 88   LinkError       createWebAssemblyLinkError     DontEnum|PropertyCallback
 89   Memory          createWebAssemblyMemory        DontEnum|PropertyCallback
 90   Module          createWebAssemblyModule        DontEnum|PropertyCallback
 91   RuntimeError    createWebAssemblyRuntimeError  DontEnum|PropertyCallback
 92   Table           createWebAssemblyTable         DontEnum|PropertyCallback
 93   compile         webAssemblyCompileFunc         Function 1
 94   instantiate     webAssemblyInstantiateFunc     Function 1
 95   validate        webAssemblyValidateFunc        Function 1
 96 @end
 97 */
 98 
 99 JSWebAssembly* JSWebAssembly::create(VM&amp; vm, JSGlobalObject* globalObject, Structure* structure)
100 {
101     auto* object = new (NotNull, allocateCell&lt;JSWebAssembly&gt;(vm.heap)) JSWebAssembly(vm, structure);
102     object-&gt;finishCreation(vm, globalObject);
103     return object;
104 }
105 
106 Structure* JSWebAssembly::createStructure(VM&amp; vm, JSGlobalObject* globalObject, JSValue prototype)
107 {
108     return Structure::create(vm, globalObject, prototype, TypeInfo(ObjectType, StructureFlags), info());
109 }
110 
111 void JSWebAssembly::finishCreation(VM&amp; vm, JSGlobalObject* globalObject)
112 {
113     Base::finishCreation(vm);
114     ASSERT(inherits(vm, info()));
115     if (Options::useWebAssemblyStreamingApi()) {
116         JSC_BUILTIN_FUNCTION_WITHOUT_TRANSITION(&quot;compileStreaming&quot;, webAssemblyCompileStreamingCodeGenerator, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum));
117         JSC_BUILTIN_FUNCTION_WITHOUT_TRANSITION(&quot;instantiateStreaming&quot;, webAssemblyInstantiateStreamingCodeGenerator, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum));
118     }
119 }
120 
121 JSWebAssembly::JSWebAssembly(VM&amp; vm, Structure* structure)
122     : JSNonFinalObject(vm, structure)
123 {
124 }
125 
<span class="line-modified">126 static void reject(ExecState* exec, CatchScope&amp; catchScope, JSPromiseDeferred* promise)</span>
127 {
128     Exception* exception = catchScope.exception();
129     ASSERT(exception);
130     catchScope.clearException();
<span class="line-modified">131     promise-&gt;reject(exec, exception-&gt;value());</span>
132     CLEAR_AND_RETURN_IF_EXCEPTION(catchScope, void());
133 }
134 
<span class="line-modified">135 static void webAssemblyModuleValidateAsyncInternal(ExecState* exec, JSPromiseDeferred* promise, Vector&lt;uint8_t&gt;&amp;&amp; source)</span>
136 {
<span class="line-modified">137     VM&amp; vm = exec-&gt;vm();</span>
<span class="line-removed">138     auto* globalObject = exec-&gt;lexicalGlobalObject();</span>
139 
140     Vector&lt;Strong&lt;JSCell&gt;&gt; dependencies;
141     dependencies.append(Strong&lt;JSCell&gt;(vm, globalObject));
142 
<span class="line-modified">143     vm.promiseDeferredTimer-&gt;addPendingPromise(vm, promise, WTFMove(dependencies));</span>
144 
145     Wasm::Module::validateAsync(&amp;vm.wasmContext, WTFMove(source), createSharedTask&lt;Wasm::Module::CallbackType&gt;([promise, globalObject, &amp;vm] (Wasm::Module::ValidationResult&amp;&amp; result) mutable {
<span class="line-modified">146         vm.promiseDeferredTimer-&gt;scheduleWorkSoon(promise, [promise, globalObject, result = WTFMove(result), &amp;vm] () mutable {</span>
147             auto scope = DECLARE_CATCH_SCOPE(vm);
<span class="line-modified">148             ExecState* exec = globalObject-&gt;globalExec();</span>
<span class="line-removed">149             JSValue module = JSWebAssemblyModule::createStub(vm, exec, globalObject-&gt;webAssemblyModuleStructure(), WTFMove(result));</span>
150             if (UNLIKELY(scope.exception())) {
<span class="line-modified">151                 reject(exec, scope, promise);</span>
152                 return;
153             }
154 
<span class="line-modified">155             promise-&gt;resolve(exec, module);</span>
156             CLEAR_AND_RETURN_IF_EXCEPTION(scope, void());
157         });
158     }));
159 }
160 
<span class="line-modified">161 static EncodedJSValue JSC_HOST_CALL webAssemblyCompileFunc(ExecState* exec)</span>
162 {
<span class="line-modified">163     VM&amp; vm = exec-&gt;vm();</span>
164     auto throwScope = DECLARE_THROW_SCOPE(vm);
<span class="line-removed">165     auto* globalObject = exec-&gt;lexicalGlobalObject();</span>
166 
<span class="line-modified">167     JSPromiseDeferred* promise = JSPromiseDeferred::tryCreate(exec, globalObject);</span>
168     RETURN_IF_EXCEPTION(throwScope, encodedJSValue());
169 
170     {
171         auto catchScope = DECLARE_CATCH_SCOPE(vm);
<span class="line-modified">172         Vector&lt;uint8_t&gt; source = createSourceBufferFromValue(vm, exec, exec-&gt;argument(0));</span>
173 
174         if (UNLIKELY(catchScope.exception()))
<span class="line-modified">175             reject(exec, catchScope, promise);</span>
176         else
<span class="line-modified">177             webAssemblyModuleValidateAsyncInternal(exec, promise, WTFMove(source));</span>
178 
<span class="line-modified">179         return JSValue::encode(promise-&gt;promise());</span>
180     }
181 }
182 
183 enum class Resolve { WithInstance, WithModuleRecord, WithModuleAndInstance };
<span class="line-modified">184 static void resolve(VM&amp; vm, ExecState* exec, JSPromiseDeferred* promise, JSWebAssemblyInstance* instance, JSWebAssemblyModule* module, JSObject* importObject, Ref&lt;Wasm::CodeBlock&gt;&amp;&amp; codeBlock, Resolve resolveKind, Wasm::CreationMode creationMode)</span>
185 {
186     auto scope = DECLARE_CATCH_SCOPE(vm);
<span class="line-modified">187     instance-&gt;finalizeCreation(vm, exec, WTFMove(codeBlock), importObject, creationMode);</span>
<span class="line-modified">188     RETURN_IF_EXCEPTION(scope, reject(exec, scope, promise));</span>
189 
190     if (resolveKind == Resolve::WithInstance)
<span class="line-modified">191         promise-&gt;resolve(exec, instance);</span>
192     else if (resolveKind == Resolve::WithModuleRecord) {
193         auto* moduleRecord = instance-&gt;moduleNamespaceObject()-&gt;moduleRecord();
<span class="line-modified">194         if (Options::dumpModuleRecord())</span>
195             moduleRecord-&gt;dump();
<span class="line-modified">196         promise-&gt;resolve(exec, moduleRecord);</span>
197     } else {
<span class="line-modified">198         JSObject* result = constructEmptyObject(exec);</span>
199         result-&gt;putDirect(vm, Identifier::fromString(vm, &quot;module&quot;_s), module);
200         result-&gt;putDirect(vm, Identifier::fromString(vm, &quot;instance&quot;_s), instance);
<span class="line-modified">201         promise-&gt;resolve(exec, result);</span>
202     }
203     CLEAR_AND_RETURN_IF_EXCEPTION(scope, void());
204 }
205 
<span class="line-modified">206 void JSWebAssembly::webAssemblyModuleValidateAsync(ExecState* exec, JSPromiseDeferred* promise, Vector&lt;uint8_t&gt;&amp;&amp; source)</span>
207 {
<span class="line-modified">208     VM&amp; vm = exec-&gt;vm();</span>
209     auto catchScope = DECLARE_CATCH_SCOPE(vm);
<span class="line-modified">210     webAssemblyModuleValidateAsyncInternal(exec, promise, WTFMove(source));</span>
211     CLEAR_AND_RETURN_IF_EXCEPTION(catchScope, void());
212 }
213 
<span class="line-modified">214 static void instantiate(VM&amp; vm, ExecState* exec, JSPromiseDeferred* promise, JSWebAssemblyModule* module, JSObject* importObject, const Identifier&amp; moduleKey, Resolve resolveKind, Wasm::CreationMode creationMode)</span>
215 {
216     auto scope = DECLARE_CATCH_SCOPE(vm);
217     // In order to avoid potentially recompiling a module. We first gather all the import/memory information prior to compiling code.
<span class="line-modified">218     JSWebAssemblyInstance* instance = JSWebAssemblyInstance::create(vm, exec, moduleKey, module, importObject, exec-&gt;lexicalGlobalObject()-&gt;webAssemblyInstanceStructure(), Ref&lt;Wasm::Module&gt;(module-&gt;module()), creationMode);</span>
<span class="line-modified">219     RETURN_IF_EXCEPTION(scope, reject(exec, scope, promise));</span>
220 
221     Vector&lt;Strong&lt;JSCell&gt;&gt; dependencies;
222     // The instance keeps the module alive.
223     dependencies.append(Strong&lt;JSCell&gt;(vm, instance));
224     dependencies.append(Strong&lt;JSCell&gt;(vm, importObject));
<span class="line-modified">225     vm.promiseDeferredTimer-&gt;addPendingPromise(vm, promise, WTFMove(dependencies));</span>
226     // Note: This completion task may or may not get called immediately.
227     module-&gt;module().compileAsync(&amp;vm.wasmContext, instance-&gt;memoryMode(), createSharedTask&lt;Wasm::CodeBlock::CallbackType&gt;([promise, instance, module, importObject, resolveKind, creationMode, &amp;vm] (Ref&lt;Wasm::CodeBlock&gt;&amp;&amp; refCodeBlock) mutable {
228         RefPtr&lt;Wasm::CodeBlock&gt; codeBlock = WTFMove(refCodeBlock);
<span class="line-modified">229         vm.promiseDeferredTimer-&gt;scheduleWorkSoon(promise, [promise, instance, module, importObject, resolveKind, creationMode, &amp;vm, codeBlock = WTFMove(codeBlock)] () mutable {</span>
<span class="line-modified">230             ExecState* exec = instance-&gt;globalObject(vm)-&gt;globalExec();</span>
<span class="line-modified">231             resolve(vm, exec, promise, instance, module, importObject, codeBlock.releaseNonNull(), resolveKind, creationMode);</span>
232         });
<span class="line-modified">233     }), &amp;Wasm::createJSToWasmWrapper, &amp;Wasm::wasmToJSException);</span>
234 }
235 
<span class="line-modified">236 static void compileAndInstantiate(VM&amp; vm, ExecState* exec, JSPromiseDeferred* promise, const Identifier&amp; moduleKey, JSValue buffer, JSObject* importObject, Resolve resolveKind, Wasm::CreationMode creationMode)</span>
237 {
238     auto scope = DECLARE_CATCH_SCOPE(vm);
239 
<span class="line-removed">240     auto* globalObject = exec-&gt;lexicalGlobalObject();</span>
<span class="line-removed">241 </span>
242     JSCell* moduleKeyCell = identifierToJSValue(vm, moduleKey).asCell();
243     Vector&lt;Strong&lt;JSCell&gt;&gt; dependencies;
244     dependencies.append(Strong&lt;JSCell&gt;(vm, importObject));
245     dependencies.append(Strong&lt;JSCell&gt;(vm, moduleKeyCell));
<span class="line-modified">246     vm.promiseDeferredTimer-&gt;addPendingPromise(vm, promise, WTFMove(dependencies));</span>
247 
<span class="line-modified">248     Vector&lt;uint8_t&gt; source = createSourceBufferFromValue(vm, exec, buffer);</span>
<span class="line-modified">249     RETURN_IF_EXCEPTION(scope, reject(exec, scope, promise));</span>
250 
251     Wasm::Module::validateAsync(&amp;vm.wasmContext, WTFMove(source), createSharedTask&lt;Wasm::Module::CallbackType&gt;([promise, importObject, moduleKeyCell, globalObject, resolveKind, creationMode, &amp;vm] (Wasm::Module::ValidationResult&amp;&amp; result) mutable {
<span class="line-modified">252         vm.promiseDeferredTimer-&gt;scheduleWorkSoon(promise, [promise, importObject, moduleKeyCell, globalObject, result = WTFMove(result), resolveKind, creationMode, &amp;vm] () mutable {</span>
253             auto scope = DECLARE_CATCH_SCOPE(vm);
<span class="line-modified">254             ExecState* exec = globalObject-&gt;globalExec();</span>
<span class="line-removed">255             JSWebAssemblyModule* module = JSWebAssemblyModule::createStub(vm, exec, globalObject-&gt;webAssemblyModuleStructure(), WTFMove(result));</span>
256             if (UNLIKELY(scope.exception()))
<span class="line-modified">257                 return reject(exec, scope, promise);</span>
258 
<span class="line-modified">259             const Identifier moduleKey = JSValue(moduleKeyCell).toPropertyKey(exec);</span>
260             if (UNLIKELY(scope.exception()))
<span class="line-modified">261                 return reject(exec, scope, promise);</span>
262 
<span class="line-modified">263             instantiate(vm, exec, promise, module, importObject, moduleKey, resolveKind, creationMode);</span>
264         });
265     }));
266 }
267 
<span class="line-modified">268 JSValue JSWebAssembly::instantiate(ExecState* exec, JSPromiseDeferred* promise, const Identifier&amp; moduleKey, JSValue argument)</span>
269 {
<span class="line-modified">270     VM&amp; vm = exec-&gt;vm();</span>
<span class="line-modified">271     compileAndInstantiate(vm, exec, promise, moduleKey, argument, nullptr, Resolve::WithModuleRecord, Wasm::CreationMode::FromModuleLoader);</span>
<span class="line-modified">272     return promise-&gt;promise();</span>
273 }
274 
<span class="line-modified">275 static void webAssemblyModuleInstantinateAsyncInternal(ExecState* exec, JSPromiseDeferred* promise, Vector&lt;uint8_t&gt;&amp;&amp; source, JSObject* importObject)</span>
276 {
<span class="line-modified">277     auto* globalObject = exec-&gt;lexicalGlobalObject();</span>
<span class="line-removed">278     VM&amp; vm = exec-&gt;vm();</span>
279 
280     Vector&lt;Strong&lt;JSCell&gt;&gt; dependencies;
281     dependencies.append(Strong&lt;JSCell&gt;(vm, importObject));
282     dependencies.append(Strong&lt;JSCell&gt;(vm, globalObject));
<span class="line-modified">283     vm.promiseDeferredTimer-&gt;addPendingPromise(vm, promise, WTFMove(dependencies));</span>
284 
285     Wasm::Module::validateAsync(&amp;vm.wasmContext, WTFMove(source), createSharedTask&lt;Wasm::Module::CallbackType&gt;([promise, importObject, globalObject, &amp;vm] (Wasm::Module::ValidationResult&amp;&amp; result) mutable {
<span class="line-modified">286         vm.promiseDeferredTimer-&gt;scheduleWorkSoon(promise, [promise, importObject, globalObject, result = WTFMove(result), &amp;vm] () mutable {</span>
287             auto scope = DECLARE_CATCH_SCOPE(vm);
<span class="line-modified">288             ExecState* exec = globalObject-&gt;globalExec();</span>
<span class="line-removed">289             JSWebAssemblyModule* module = JSWebAssemblyModule::createStub(vm, exec, globalObject-&gt;webAssemblyModuleStructure(), WTFMove(result));</span>
290             if (UNLIKELY(scope.exception()))
<span class="line-modified">291                 return reject(exec, scope, promise);</span>
292 
<span class="line-modified">293             instantiate(vm, exec, promise, module, importObject, JSWebAssemblyInstance::createPrivateModuleKey(),  Resolve::WithModuleAndInstance, Wasm::CreationMode::FromJS);</span>
<span class="line-modified">294             CLEAR_AND_RETURN_IF_EXCEPTION(scope, reject(exec, scope, promise));</span>
295         });
296     }));
297 }
298 
<span class="line-modified">299 void JSWebAssembly::webAssemblyModuleInstantinateAsync(ExecState* exec, JSPromiseDeferred* promise, Vector&lt;uint8_t&gt;&amp;&amp; source, JSObject* importedObject)</span>
300 {
<span class="line-modified">301     VM&amp; vm = exec-&gt;vm();</span>
302     auto catchScope = DECLARE_CATCH_SCOPE(vm);
<span class="line-modified">303     webAssemblyModuleInstantinateAsyncInternal(exec, promise, WTFMove(source), importedObject);</span>
304     CLEAR_AND_RETURN_IF_EXCEPTION(catchScope, void());
305 }
306 
<span class="line-modified">307 static EncodedJSValue JSC_HOST_CALL webAssemblyInstantiateFunc(ExecState* exec)</span>
308 {
<span class="line-modified">309     VM&amp; vm = exec-&gt;vm();</span>
<span class="line-removed">310     auto throwScope = DECLARE_THROW_SCOPE(vm);</span>
<span class="line-removed">311     auto* globalObject = exec-&gt;lexicalGlobalObject();</span>
<span class="line-removed">312 </span>
<span class="line-removed">313     JSPromiseDeferred* promise = JSPromiseDeferred::tryCreate(exec, globalObject);</span>
<span class="line-removed">314     RETURN_IF_EXCEPTION(throwScope, encodedJSValue());</span>
315 

316     {
317         auto catchScope = DECLARE_CATCH_SCOPE(vm);
318 
<span class="line-modified">319         JSValue importArgument = exec-&gt;argument(1);</span>
320         JSObject* importObject = importArgument.getObject();
321         if (UNLIKELY(!importArgument.isUndefined() &amp;&amp; !importObject)) {
<span class="line-modified">322             promise-&gt;reject(exec, createTypeError(exec,</span>
323                 &quot;second argument to WebAssembly.instantiate must be undefined or an Object&quot;_s, defaultSourceAppender, runtimeTypeForValue(vm, importArgument)));
<span class="line-modified">324             CLEAR_AND_RETURN_IF_EXCEPTION(catchScope, JSValue::encode(promise-&gt;promise()));</span>
325         } else {
<span class="line-modified">326             JSValue firstArgument = exec-&gt;argument(0);</span>
327             if (auto* module = jsDynamicCast&lt;JSWebAssemblyModule*&gt;(vm, firstArgument))
<span class="line-modified">328                 instantiate(vm, exec, promise, module, importObject, JSWebAssemblyInstance::createPrivateModuleKey(), Resolve::WithInstance, Wasm::CreationMode::FromJS);</span>
329             else
<span class="line-modified">330                 compileAndInstantiate(vm, exec, promise, JSWebAssemblyInstance::createPrivateModuleKey(), firstArgument, importObject, Resolve::WithModuleAndInstance, Wasm::CreationMode::FromJS);</span>
331         }
332 
<span class="line-modified">333         return JSValue::encode(promise-&gt;promise());</span>
334     }
335 }
336 
<span class="line-modified">337 static EncodedJSValue JSC_HOST_CALL webAssemblyValidateFunc(ExecState* exec)</span>
338 {
<span class="line-modified">339     VM&amp; vm = exec-&gt;vm();</span>
340     auto scope = DECLARE_THROW_SCOPE(vm);
341 
<span class="line-removed">342     auto [base, byteSize] = getWasmBufferFromValue(exec, exec-&gt;argument(0));</span>
<span class="line-removed">343     RETURN_IF_EXCEPTION(scope, encodedJSValue());</span>
<span class="line-removed">344     BBQPlan plan(&amp;vm.wasmContext, BBQPlan::Validation, Plan::dontFinalize());</span>
345     // FIXME: We might want to throw an OOM exception here if we detect that something will OOM.
346     // https://bugs.webkit.org/show_bug.cgi?id=166015
<span class="line-modified">347     return JSValue::encode(jsBoolean(plan.parseAndValidateModule(base, byteSize)));</span>



348 }
349 
<span class="line-modified">350 EncodedJSValue JSC_HOST_CALL webAssemblyCompileStreamingInternal(ExecState* exec)</span>
351 {
<span class="line-modified">352     VM&amp; vm = exec-&gt;vm();</span>
<span class="line-removed">353     auto* globalObject = exec-&gt;lexicalGlobalObject();</span>
354     auto catchScope = DECLARE_CATCH_SCOPE(vm);
355 
<span class="line-modified">356     JSPromiseDeferred* promise = JSPromiseDeferred::tryCreate(exec, globalObject);</span>
357 
358     Vector&lt;Strong&lt;JSCell&gt;&gt; dependencies;
359     dependencies.append(Strong&lt;JSCell&gt;(vm, globalObject));
<span class="line-modified">360     vm.promiseDeferredTimer-&gt;addPendingPromise(vm, promise, WTFMove(dependencies));</span>
361 
362     if (globalObject-&gt;globalObjectMethodTable()-&gt;compileStreaming)
<span class="line-modified">363         globalObject-&gt;globalObjectMethodTable()-&gt;compileStreaming(globalObject, exec, promise, exec-&gt;argument(0));</span>
364     else {
365         // CompileStreaming is not supported in jsc, only in browser environment
366         ASSERT_NOT_REACHED();
367     }
368 
<span class="line-modified">369     CLEAR_AND_RETURN_IF_EXCEPTION(catchScope, JSValue::encode(promise-&gt;promise()));</span>
370 
<span class="line-modified">371     return JSValue::encode(promise-&gt;promise());</span>
372 }
373 
<span class="line-modified">374 EncodedJSValue JSC_HOST_CALL webAssemblyInstantiateStreamingInternal(ExecState* exec)</span>
375 {
<span class="line-modified">376     VM&amp; vm = exec-&gt;vm();</span>
<span class="line-removed">377     auto throwScope = DECLARE_THROW_SCOPE(vm);</span>
<span class="line-removed">378     auto* globalObject = exec-&gt;lexicalGlobalObject();</span>
379 
<span class="line-modified">380     JSPromiseDeferred* promise = JSPromiseDeferred::tryCreate(exec, globalObject);</span>
<span class="line-removed">381     RETURN_IF_EXCEPTION(throwScope, encodedJSValue());</span>
382     {
383         auto catchScope = DECLARE_CATCH_SCOPE(vm);
384 
<span class="line-modified">385         JSValue importArgument = exec-&gt;argument(1);</span>
386         JSObject* importObject = importArgument.getObject();
387         if (UNLIKELY(!importArgument.isUndefined() &amp;&amp; !importObject)) {
<span class="line-modified">388             promise-&gt;reject(exec, createTypeError(exec,</span>
389                 &quot;second argument to WebAssembly.instantiateStreaming must be undefined or an Object&quot;_s, defaultSourceAppender, runtimeTypeForValue(vm, importArgument)));
<span class="line-modified">390             CLEAR_AND_RETURN_IF_EXCEPTION(catchScope, JSValue::encode(promise-&gt;promise()));</span>
391         } else {
392             if (globalObject-&gt;globalObjectMethodTable()-&gt;instantiateStreaming) {
393                 Vector&lt;Strong&lt;JSCell&gt;&gt; dependencies;
394                 dependencies.append(Strong&lt;JSCell&gt;(vm, globalObject));
395                 dependencies.append(Strong&lt;JSCell&gt;(vm, importObject));
<span class="line-modified">396                 vm.promiseDeferredTimer-&gt;addPendingPromise(vm, promise, WTFMove(dependencies));</span>
397 
398                 // FIXME: &lt;http://webkit.org/b/184888&gt; if there&#39;s an importObject and it contains a Memory, then we can compile the module with the right memory type (fast or not) by looking at the memory&#39;s type.
<span class="line-modified">399                 globalObject-&gt;globalObjectMethodTable()-&gt;instantiateStreaming(globalObject, exec, promise, exec-&gt;argument(0), importObject);</span>
400             } else {
401                 // InstantiateStreaming is not supported in jsc, only in browser environment.
402                 ASSERT_NOT_REACHED();
403             }
404         }
<span class="line-modified">405         CLEAR_AND_RETURN_IF_EXCEPTION(catchScope, JSValue::encode(promise-&gt;promise()));</span>
406 
<span class="line-modified">407         return JSValue::encode(promise-&gt;promise());</span>
408     }
409 }
410 
411 } // namespace JSC
412 
413 #endif // ENABLE(WEBASSEMBLY)
</pre>
</td>
<td>
<hr />
<pre>
 17  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 18  * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 19  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 20  * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 21  * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 22  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 23  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #include &quot;config.h&quot;
 27 #include &quot;JSWebAssembly.h&quot;
 28 
 29 #if ENABLE(WEBASSEMBLY)
 30 
 31 #include &quot;CatchScope.h&quot;
 32 #include &quot;Exception.h&quot;
 33 #include &quot;FunctionPrototype.h&quot;
 34 #include &quot;JSCBuiltins.h&quot;
 35 #include &quot;JSCInlines.h&quot;
 36 #include &quot;JSModuleNamespaceObject.h&quot;
<span class="line-modified"> 37 #include &quot;JSPromise.h&quot;</span>
 38 #include &quot;JSToWasm.h&quot;
 39 #include &quot;JSWebAssemblyHelpers.h&quot;
 40 #include &quot;JSWebAssemblyInstance.h&quot;
 41 #include &quot;JSWebAssemblyModule.h&quot;
 42 #include &quot;ObjectConstructor.h&quot;
 43 #include &quot;Options.h&quot;
<span class="line-modified"> 44 #include &quot;PromiseTimer.h&quot;</span>
 45 #include &quot;StrongInlines.h&quot;
 46 #include &quot;ThrowScope.h&quot;
 47 #include &quot;WasmBBQPlan.h&quot;
<span class="line-added"> 48 #include &quot;WasmOperations.h&quot;</span>
 49 #include &quot;WasmToJS.h&quot;
 50 #include &quot;WasmWorklist.h&quot;
 51 #include &quot;WebAssemblyInstanceConstructor.h&quot;
 52 #include &quot;WebAssemblyModuleConstructor.h&quot;
 53 
 54 using JSC::Wasm::Plan;
 55 using JSC::Wasm::BBQPlan;
 56 
 57 namespace JSC {
 58 
 59 STATIC_ASSERT_IS_TRIVIALLY_DESTRUCTIBLE(JSWebAssembly);
 60 
 61 #define DEFINE_CALLBACK_FOR_CONSTRUCTOR(capitalName, lowerName, properName, instanceType, jsName, prototypeBase, featureFlag) \
 62 static JSValue create##capitalName(VM&amp; vm, JSObject* object) \
 63 { \
 64     JSWebAssembly* webAssembly = jsCast&lt;JSWebAssembly*&gt;(object); \
 65     JSGlobalObject* globalObject = webAssembly-&gt;globalObject(vm); \
 66     return globalObject-&gt;properName##Constructor(); \
 67 }
 68 
 69 FOR_EACH_WEBASSEMBLY_CONSTRUCTOR_TYPE(DEFINE_CALLBACK_FOR_CONSTRUCTOR)
 70 
 71 #undef DEFINE_CALLBACK_FOR_CONSTRUCTOR
 72 
<span class="line-modified"> 73 static EncodedJSValue JSC_HOST_CALL webAssemblyCompileFunc(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified"> 74 static EncodedJSValue JSC_HOST_CALL webAssemblyInstantiateFunc(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified"> 75 static EncodedJSValue JSC_HOST_CALL webAssemblyValidateFunc(JSGlobalObject*, CallFrame*);</span>
 76 
 77 }
 78 
 79 #include &quot;JSWebAssembly.lut.h&quot;
 80 
 81 namespace JSC {
 82 
 83 const ClassInfo JSWebAssembly::s_info = { &quot;WebAssembly&quot;, &amp;Base::s_info, &amp;webAssemblyTable, nullptr, CREATE_METHOD_TABLE(JSWebAssembly) };
 84 
 85 /* Source for JSWebAssembly.lut.h
 86 @begin webAssemblyTable
 87   CompileError    createWebAssemblyCompileError  DontEnum|PropertyCallback
<span class="line-added"> 88   Global          createWebAssemblyGlobal        DontEnum|PropertyCallback</span>
 89   Instance        createWebAssemblyInstance      DontEnum|PropertyCallback
 90   LinkError       createWebAssemblyLinkError     DontEnum|PropertyCallback
 91   Memory          createWebAssemblyMemory        DontEnum|PropertyCallback
 92   Module          createWebAssemblyModule        DontEnum|PropertyCallback
 93   RuntimeError    createWebAssemblyRuntimeError  DontEnum|PropertyCallback
 94   Table           createWebAssemblyTable         DontEnum|PropertyCallback
 95   compile         webAssemblyCompileFunc         Function 1
 96   instantiate     webAssemblyInstantiateFunc     Function 1
 97   validate        webAssemblyValidateFunc        Function 1
 98 @end
 99 */
100 
101 JSWebAssembly* JSWebAssembly::create(VM&amp; vm, JSGlobalObject* globalObject, Structure* structure)
102 {
103     auto* object = new (NotNull, allocateCell&lt;JSWebAssembly&gt;(vm.heap)) JSWebAssembly(vm, structure);
104     object-&gt;finishCreation(vm, globalObject);
105     return object;
106 }
107 
108 Structure* JSWebAssembly::createStructure(VM&amp; vm, JSGlobalObject* globalObject, JSValue prototype)
109 {
110     return Structure::create(vm, globalObject, prototype, TypeInfo(ObjectType, StructureFlags), info());
111 }
112 
113 void JSWebAssembly::finishCreation(VM&amp; vm, JSGlobalObject* globalObject)
114 {
115     Base::finishCreation(vm);
116     ASSERT(inherits(vm, info()));
117     if (Options::useWebAssemblyStreamingApi()) {
118         JSC_BUILTIN_FUNCTION_WITHOUT_TRANSITION(&quot;compileStreaming&quot;, webAssemblyCompileStreamingCodeGenerator, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum));
119         JSC_BUILTIN_FUNCTION_WITHOUT_TRANSITION(&quot;instantiateStreaming&quot;, webAssemblyInstantiateStreamingCodeGenerator, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum));
120     }
121 }
122 
123 JSWebAssembly::JSWebAssembly(VM&amp; vm, Structure* structure)
124     : JSNonFinalObject(vm, structure)
125 {
126 }
127 
<span class="line-modified">128 static void reject(JSGlobalObject* globalObject, CatchScope&amp; catchScope, JSPromise* promise)</span>
129 {
130     Exception* exception = catchScope.exception();
131     ASSERT(exception);
132     catchScope.clearException();
<span class="line-modified">133     promise-&gt;reject(globalObject, exception-&gt;value());</span>
134     CLEAR_AND_RETURN_IF_EXCEPTION(catchScope, void());
135 }
136 
<span class="line-modified">137 static void webAssemblyModuleValidateAsyncInternal(JSGlobalObject* globalObject, JSPromise* promise, Vector&lt;uint8_t&gt;&amp;&amp; source)</span>
138 {
<span class="line-modified">139     VM&amp; vm = globalObject-&gt;vm();</span>

140 
141     Vector&lt;Strong&lt;JSCell&gt;&gt; dependencies;
142     dependencies.append(Strong&lt;JSCell&gt;(vm, globalObject));
143 
<span class="line-modified">144     vm.promiseTimer-&gt;addPendingPromise(vm, promise, WTFMove(dependencies));</span>
145 
146     Wasm::Module::validateAsync(&amp;vm.wasmContext, WTFMove(source), createSharedTask&lt;Wasm::Module::CallbackType&gt;([promise, globalObject, &amp;vm] (Wasm::Module::ValidationResult&amp;&amp; result) mutable {
<span class="line-modified">147         vm.promiseTimer-&gt;scheduleWorkSoon(promise, [promise, globalObject, result = WTFMove(result), &amp;vm] () mutable {</span>
148             auto scope = DECLARE_CATCH_SCOPE(vm);
<span class="line-modified">149             JSValue module = JSWebAssemblyModule::createStub(vm, globalObject, globalObject-&gt;webAssemblyModuleStructure(), WTFMove(result));</span>

150             if (UNLIKELY(scope.exception())) {
<span class="line-modified">151                 reject(globalObject, scope, promise);</span>
152                 return;
153             }
154 
<span class="line-modified">155             promise-&gt;resolve(globalObject, module);</span>
156             CLEAR_AND_RETURN_IF_EXCEPTION(scope, void());
157         });
158     }));
159 }
160 
<span class="line-modified">161 static EncodedJSValue JSC_HOST_CALL webAssemblyCompileFunc(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
162 {
<span class="line-modified">163     VM&amp; vm = globalObject-&gt;vm();</span>
164     auto throwScope = DECLARE_THROW_SCOPE(vm);

165 
<span class="line-modified">166     auto* promise = JSPromise::create(vm, globalObject-&gt;promiseStructure());</span>
167     RETURN_IF_EXCEPTION(throwScope, encodedJSValue());
168 
169     {
170         auto catchScope = DECLARE_CATCH_SCOPE(vm);
<span class="line-modified">171         Vector&lt;uint8_t&gt; source = createSourceBufferFromValue(vm, globalObject, callFrame-&gt;argument(0));</span>
172 
173         if (UNLIKELY(catchScope.exception()))
<span class="line-modified">174             reject(globalObject, catchScope, promise);</span>
175         else
<span class="line-modified">176             webAssemblyModuleValidateAsyncInternal(globalObject, promise, WTFMove(source));</span>
177 
<span class="line-modified">178         return JSValue::encode(promise);</span>
179     }
180 }
181 
182 enum class Resolve { WithInstance, WithModuleRecord, WithModuleAndInstance };
<span class="line-modified">183 static void resolve(VM&amp; vm, JSGlobalObject* globalObject, JSPromise* promise, JSWebAssemblyInstance* instance, JSWebAssemblyModule* module, JSObject* importObject, Ref&lt;Wasm::CodeBlock&gt;&amp;&amp; codeBlock, Resolve resolveKind, Wasm::CreationMode creationMode)</span>
184 {
185     auto scope = DECLARE_CATCH_SCOPE(vm);
<span class="line-modified">186     instance-&gt;finalizeCreation(vm, globalObject, WTFMove(codeBlock), importObject, creationMode);</span>
<span class="line-modified">187     RETURN_IF_EXCEPTION(scope, reject(globalObject, scope, promise));</span>
188 
189     if (resolveKind == Resolve::WithInstance)
<span class="line-modified">190         promise-&gt;resolve(globalObject, instance);</span>
191     else if (resolveKind == Resolve::WithModuleRecord) {
192         auto* moduleRecord = instance-&gt;moduleNamespaceObject()-&gt;moduleRecord();
<span class="line-modified">193         if (UNLIKELY(Options::dumpModuleRecord()))</span>
194             moduleRecord-&gt;dump();
<span class="line-modified">195         promise-&gt;resolve(globalObject, moduleRecord);</span>
196     } else {
<span class="line-modified">197         JSObject* result = constructEmptyObject(globalObject);</span>
198         result-&gt;putDirect(vm, Identifier::fromString(vm, &quot;module&quot;_s), module);
199         result-&gt;putDirect(vm, Identifier::fromString(vm, &quot;instance&quot;_s), instance);
<span class="line-modified">200         promise-&gt;resolve(globalObject, result);</span>
201     }
202     CLEAR_AND_RETURN_IF_EXCEPTION(scope, void());
203 }
204 
<span class="line-modified">205 void JSWebAssembly::webAssemblyModuleValidateAsync(JSGlobalObject* globalObject, JSPromise* promise, Vector&lt;uint8_t&gt;&amp;&amp; source)</span>
206 {
<span class="line-modified">207     VM&amp; vm = globalObject-&gt;vm();</span>
208     auto catchScope = DECLARE_CATCH_SCOPE(vm);
<span class="line-modified">209     webAssemblyModuleValidateAsyncInternal(globalObject, promise, WTFMove(source));</span>
210     CLEAR_AND_RETURN_IF_EXCEPTION(catchScope, void());
211 }
212 
<span class="line-modified">213 static void instantiate(VM&amp; vm, JSGlobalObject* globalObject, JSPromise* promise, JSWebAssemblyModule* module, JSObject* importObject, const Identifier&amp; moduleKey, Resolve resolveKind, Wasm::CreationMode creationMode)</span>
214 {
215     auto scope = DECLARE_CATCH_SCOPE(vm);
216     // In order to avoid potentially recompiling a module. We first gather all the import/memory information prior to compiling code.
<span class="line-modified">217     JSWebAssemblyInstance* instance = JSWebAssemblyInstance::tryCreate(vm, globalObject, moduleKey, module, importObject, globalObject-&gt;webAssemblyInstanceStructure(), Ref&lt;Wasm::Module&gt;(module-&gt;module()), creationMode);</span>
<span class="line-modified">218     RETURN_IF_EXCEPTION(scope, reject(globalObject, scope, promise));</span>
219 
220     Vector&lt;Strong&lt;JSCell&gt;&gt; dependencies;
221     // The instance keeps the module alive.
222     dependencies.append(Strong&lt;JSCell&gt;(vm, instance));
223     dependencies.append(Strong&lt;JSCell&gt;(vm, importObject));
<span class="line-modified">224     vm.promiseTimer-&gt;addPendingPromise(vm, promise, WTFMove(dependencies));</span>
225     // Note: This completion task may or may not get called immediately.
226     module-&gt;module().compileAsync(&amp;vm.wasmContext, instance-&gt;memoryMode(), createSharedTask&lt;Wasm::CodeBlock::CallbackType&gt;([promise, instance, module, importObject, resolveKind, creationMode, &amp;vm] (Ref&lt;Wasm::CodeBlock&gt;&amp;&amp; refCodeBlock) mutable {
227         RefPtr&lt;Wasm::CodeBlock&gt; codeBlock = WTFMove(refCodeBlock);
<span class="line-modified">228         vm.promiseTimer-&gt;scheduleWorkSoon(promise, [promise, instance, module, importObject, resolveKind, creationMode, &amp;vm, codeBlock = WTFMove(codeBlock)] () mutable {</span>
<span class="line-modified">229             JSGlobalObject* globalObject = instance-&gt;globalObject();</span>
<span class="line-modified">230             resolve(vm, globalObject, promise, instance, module, importObject, codeBlock.releaseNonNull(), resolveKind, creationMode);</span>
231         });
<span class="line-modified">232     }));</span>
233 }
234 
<span class="line-modified">235 static void compileAndInstantiate(VM&amp; vm, JSGlobalObject* globalObject, JSPromise* promise, const Identifier&amp; moduleKey, JSValue buffer, JSObject* importObject, Resolve resolveKind, Wasm::CreationMode creationMode)</span>
236 {
237     auto scope = DECLARE_CATCH_SCOPE(vm);
238 


239     JSCell* moduleKeyCell = identifierToJSValue(vm, moduleKey).asCell();
240     Vector&lt;Strong&lt;JSCell&gt;&gt; dependencies;
241     dependencies.append(Strong&lt;JSCell&gt;(vm, importObject));
242     dependencies.append(Strong&lt;JSCell&gt;(vm, moduleKeyCell));
<span class="line-modified">243     vm.promiseTimer-&gt;addPendingPromise(vm, promise, WTFMove(dependencies));</span>
244 
<span class="line-modified">245     Vector&lt;uint8_t&gt; source = createSourceBufferFromValue(vm, globalObject, buffer);</span>
<span class="line-modified">246     RETURN_IF_EXCEPTION(scope, reject(globalObject, scope, promise));</span>
247 
248     Wasm::Module::validateAsync(&amp;vm.wasmContext, WTFMove(source), createSharedTask&lt;Wasm::Module::CallbackType&gt;([promise, importObject, moduleKeyCell, globalObject, resolveKind, creationMode, &amp;vm] (Wasm::Module::ValidationResult&amp;&amp; result) mutable {
<span class="line-modified">249         vm.promiseTimer-&gt;scheduleWorkSoon(promise, [promise, importObject, moduleKeyCell, globalObject, result = WTFMove(result), resolveKind, creationMode, &amp;vm] () mutable {</span>
250             auto scope = DECLARE_CATCH_SCOPE(vm);
<span class="line-modified">251             JSWebAssemblyModule* module = JSWebAssemblyModule::createStub(vm, globalObject, globalObject-&gt;webAssemblyModuleStructure(), WTFMove(result));</span>

252             if (UNLIKELY(scope.exception()))
<span class="line-modified">253                 return reject(globalObject, scope, promise);</span>
254 
<span class="line-modified">255             const Identifier moduleKey = JSValue(moduleKeyCell).toPropertyKey(globalObject);</span>
256             if (UNLIKELY(scope.exception()))
<span class="line-modified">257                 return reject(globalObject, scope, promise);</span>
258 
<span class="line-modified">259             instantiate(vm, globalObject, promise, module, importObject, moduleKey, resolveKind, creationMode);</span>
260         });
261     }));
262 }
263 
<span class="line-modified">264 JSValue JSWebAssembly::instantiate(JSGlobalObject* globalObject, JSPromise* promise, const Identifier&amp; moduleKey, JSValue argument)</span>
265 {
<span class="line-modified">266     VM&amp; vm = globalObject-&gt;vm();</span>
<span class="line-modified">267     compileAndInstantiate(vm, globalObject, promise, moduleKey, argument, nullptr, Resolve::WithModuleRecord, Wasm::CreationMode::FromModuleLoader);</span>
<span class="line-modified">268     return promise;</span>
269 }
270 
<span class="line-modified">271 static void webAssemblyModuleInstantinateAsyncInternal(JSGlobalObject* globalObject, JSPromise* promise, Vector&lt;uint8_t&gt;&amp;&amp; source, JSObject* importObject)</span>
272 {
<span class="line-modified">273     VM&amp; vm = globalObject-&gt;vm();</span>

274 
275     Vector&lt;Strong&lt;JSCell&gt;&gt; dependencies;
276     dependencies.append(Strong&lt;JSCell&gt;(vm, importObject));
277     dependencies.append(Strong&lt;JSCell&gt;(vm, globalObject));
<span class="line-modified">278     vm.promiseTimer-&gt;addPendingPromise(vm, promise, WTFMove(dependencies));</span>
279 
280     Wasm::Module::validateAsync(&amp;vm.wasmContext, WTFMove(source), createSharedTask&lt;Wasm::Module::CallbackType&gt;([promise, importObject, globalObject, &amp;vm] (Wasm::Module::ValidationResult&amp;&amp; result) mutable {
<span class="line-modified">281         vm.promiseTimer-&gt;scheduleWorkSoon(promise, [promise, importObject, globalObject, result = WTFMove(result), &amp;vm] () mutable {</span>
282             auto scope = DECLARE_CATCH_SCOPE(vm);
<span class="line-modified">283             JSWebAssemblyModule* module = JSWebAssemblyModule::createStub(vm, globalObject, globalObject-&gt;webAssemblyModuleStructure(), WTFMove(result));</span>

284             if (UNLIKELY(scope.exception()))
<span class="line-modified">285                 return reject(globalObject, scope, promise);</span>
286 
<span class="line-modified">287             instantiate(vm, globalObject, promise, module, importObject, JSWebAssemblyInstance::createPrivateModuleKey(),  Resolve::WithModuleAndInstance, Wasm::CreationMode::FromJS);</span>
<span class="line-modified">288             CLEAR_AND_RETURN_IF_EXCEPTION(scope, reject(globalObject, scope, promise));</span>
289         });
290     }));
291 }
292 
<span class="line-modified">293 void JSWebAssembly::webAssemblyModuleInstantinateAsync(JSGlobalObject* globalObject, JSPromise* promise, Vector&lt;uint8_t&gt;&amp;&amp; source, JSObject* importedObject)</span>
294 {
<span class="line-modified">295     VM&amp; vm = globalObject-&gt;vm();</span>
296     auto catchScope = DECLARE_CATCH_SCOPE(vm);
<span class="line-modified">297     webAssemblyModuleInstantinateAsyncInternal(globalObject, promise, WTFMove(source), importedObject);</span>
298     CLEAR_AND_RETURN_IF_EXCEPTION(catchScope, void());
299 }
300 
<span class="line-modified">301 static EncodedJSValue JSC_HOST_CALL webAssemblyInstantiateFunc(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
302 {
<span class="line-modified">303     VM&amp; vm = globalObject-&gt;vm();</span>





304 
<span class="line-added">305     auto* promise = JSPromise::create(vm, globalObject-&gt;promiseStructure());</span>
306     {
307         auto catchScope = DECLARE_CATCH_SCOPE(vm);
308 
<span class="line-modified">309         JSValue importArgument = callFrame-&gt;argument(1);</span>
310         JSObject* importObject = importArgument.getObject();
311         if (UNLIKELY(!importArgument.isUndefined() &amp;&amp; !importObject)) {
<span class="line-modified">312             promise-&gt;reject(globalObject, createTypeError(globalObject,</span>
313                 &quot;second argument to WebAssembly.instantiate must be undefined or an Object&quot;_s, defaultSourceAppender, runtimeTypeForValue(vm, importArgument)));
<span class="line-modified">314             CLEAR_AND_RETURN_IF_EXCEPTION(catchScope, JSValue::encode(promise));</span>
315         } else {
<span class="line-modified">316             JSValue firstArgument = callFrame-&gt;argument(0);</span>
317             if (auto* module = jsDynamicCast&lt;JSWebAssemblyModule*&gt;(vm, firstArgument))
<span class="line-modified">318                 instantiate(vm, globalObject, promise, module, importObject, JSWebAssemblyInstance::createPrivateModuleKey(), Resolve::WithInstance, Wasm::CreationMode::FromJS);</span>
319             else
<span class="line-modified">320                 compileAndInstantiate(vm, globalObject, promise, JSWebAssemblyInstance::createPrivateModuleKey(), firstArgument, importObject, Resolve::WithModuleAndInstance, Wasm::CreationMode::FromJS);</span>
321         }
322 
<span class="line-modified">323         return JSValue::encode(promise);</span>
324     }
325 }
326 
<span class="line-modified">327 static EncodedJSValue JSC_HOST_CALL webAssemblyValidateFunc(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
328 {
<span class="line-modified">329     VM&amp; vm = globalObject-&gt;vm();</span>
330     auto scope = DECLARE_THROW_SCOPE(vm);
331 



332     // FIXME: We might want to throw an OOM exception here if we detect that something will OOM.
333     // https://bugs.webkit.org/show_bug.cgi?id=166015
<span class="line-modified">334     Vector&lt;uint8_t&gt; source = createSourceBufferFromValue(vm, globalObject, callFrame-&gt;argument(0));</span>
<span class="line-added">335     RETURN_IF_EXCEPTION(scope, encodedJSValue());</span>
<span class="line-added">336     auto validationResult = Wasm::Module::validateSync(&amp;vm.wasmContext, WTFMove(source));</span>
<span class="line-added">337     return JSValue::encode(jsBoolean(validationResult.has_value()));</span>
338 }
339 
<span class="line-modified">340 EncodedJSValue JSC_HOST_CALL webAssemblyCompileStreamingInternal(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
341 {
<span class="line-modified">342     VM&amp; vm = globalObject-&gt;vm();</span>

343     auto catchScope = DECLARE_CATCH_SCOPE(vm);
344 
<span class="line-modified">345     auto* promise = JSPromise::create(vm, globalObject-&gt;promiseStructure());</span>
346 
347     Vector&lt;Strong&lt;JSCell&gt;&gt; dependencies;
348     dependencies.append(Strong&lt;JSCell&gt;(vm, globalObject));
<span class="line-modified">349     vm.promiseTimer-&gt;addPendingPromise(vm, promise, WTFMove(dependencies));</span>
350 
351     if (globalObject-&gt;globalObjectMethodTable()-&gt;compileStreaming)
<span class="line-modified">352         globalObject-&gt;globalObjectMethodTable()-&gt;compileStreaming(globalObject, promise, callFrame-&gt;argument(0));</span>
353     else {
354         // CompileStreaming is not supported in jsc, only in browser environment
355         ASSERT_NOT_REACHED();
356     }
357 
<span class="line-modified">358     CLEAR_AND_RETURN_IF_EXCEPTION(catchScope, JSValue::encode(promise));</span>
359 
<span class="line-modified">360     return JSValue::encode(promise);</span>
361 }
362 
<span class="line-modified">363 EncodedJSValue JSC_HOST_CALL webAssemblyInstantiateStreamingInternal(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
364 {
<span class="line-modified">365     VM&amp; vm = globalObject-&gt;vm();</span>


366 
<span class="line-modified">367     auto* promise = JSPromise::create(vm, globalObject-&gt;promiseStructure());</span>

368     {
369         auto catchScope = DECLARE_CATCH_SCOPE(vm);
370 
<span class="line-modified">371         JSValue importArgument = callFrame-&gt;argument(1);</span>
372         JSObject* importObject = importArgument.getObject();
373         if (UNLIKELY(!importArgument.isUndefined() &amp;&amp; !importObject)) {
<span class="line-modified">374             promise-&gt;reject(globalObject, createTypeError(globalObject,</span>
375                 &quot;second argument to WebAssembly.instantiateStreaming must be undefined or an Object&quot;_s, defaultSourceAppender, runtimeTypeForValue(vm, importArgument)));
<span class="line-modified">376             CLEAR_AND_RETURN_IF_EXCEPTION(catchScope, JSValue::encode(promise));</span>
377         } else {
378             if (globalObject-&gt;globalObjectMethodTable()-&gt;instantiateStreaming) {
379                 Vector&lt;Strong&lt;JSCell&gt;&gt; dependencies;
380                 dependencies.append(Strong&lt;JSCell&gt;(vm, globalObject));
381                 dependencies.append(Strong&lt;JSCell&gt;(vm, importObject));
<span class="line-modified">382                 vm.promiseTimer-&gt;addPendingPromise(vm, promise, WTFMove(dependencies));</span>
383 
384                 // FIXME: &lt;http://webkit.org/b/184888&gt; if there&#39;s an importObject and it contains a Memory, then we can compile the module with the right memory type (fast or not) by looking at the memory&#39;s type.
<span class="line-modified">385                 globalObject-&gt;globalObjectMethodTable()-&gt;instantiateStreaming(globalObject, promise, callFrame-&gt;argument(0), importObject);</span>
386             } else {
387                 // InstantiateStreaming is not supported in jsc, only in browser environment.
388                 ASSERT_NOT_REACHED();
389             }
390         }
<span class="line-modified">391         CLEAR_AND_RETURN_IF_EXCEPTION(catchScope, JSValue::encode(promise));</span>
392 
<span class="line-modified">393         return JSValue::encode(promise);</span>
394     }
395 }
396 
397 } // namespace JSC
398 
399 #endif // ENABLE(WEBASSEMBLY)
</pre>
</td>
</tr>
</table>
<center><a href="JSToWasmICCallee.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="JSWebAssembly.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>