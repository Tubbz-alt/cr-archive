<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New modules/javafx.web/src/main/native/Source/WebCore/css/CSSPrimitiveValue.h</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * (C) 1999-2003 Lars Knoll (knoll@kde.org)
  3  * Copyright (C) 2004, 2005, 2006, 2008 Apple Inc. All rights reserved.
  4  * Copyright (C) 2007 Alexey Proskuryakov &lt;ap@webkit.org&gt;
  5  *
  6  * This library is free software; you can redistribute it and/or
  7  * modify it under the terms of the GNU Library General Public
  8  * License as published by the Free Software Foundation; either
  9  * version 2 of the License, or (at your option) any later version.
 10  *
 11  * This library is distributed in the hope that it will be useful,
 12  * but WITHOUT ANY WARRANTY; without even the implied warranty of
 13  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 14  * Library General Public License for more details.
 15  *
 16  * You should have received a copy of the GNU Library General Public License
 17  * along with this library; see the file COPYING.LIB.  If not, write to
 18  * the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
 19  * Boston, MA 02110-1301, USA.
 20  */
 21 
 22 #pragma once
 23 
 24 #include &quot;CSSPropertyNames.h&quot;
 25 #include &quot;CSSUnits.h&quot;
 26 #include &quot;CSSValue.h&quot;
 27 #include &quot;CSSValueKeywords.h&quot;
 28 #include &quot;Color.h&quot;
 29 #include &quot;ExceptionOr.h&quot;
 30 #include &quot;LayoutUnit.h&quot;
 31 #include &lt;utility&gt;
 32 #include &lt;wtf/Forward.h&gt;
 33 #include &lt;wtf/MathExtras.h&gt;
 34 
 35 namespace WebCore {
 36 
 37 class CSSBasicShape;
 38 class CSSCalcValue;
 39 class CSSToLengthConversionData;
 40 class Counter;
 41 class DeprecatedCSSOMPrimitiveValue;
 42 class Pair;
 43 class Quad;
 44 class RGBColor;
 45 class Rect;
 46 class RenderStyle;
 47 
 48 struct CSSFontFamily;
 49 struct Length;
 50 struct LengthSize;
 51 
 52 // Max/min values for CSS, needs to slightly smaller/larger than the true max/min values to allow for rounding without overflowing.
 53 // Subtract two (rather than one) to allow for values to be converted to float and back without exceeding the LayoutUnit::max.
 54 const int maxValueForCssLength = intMaxForLayoutUnit - 2;
 55 const int minValueForCssLength = intMinForLayoutUnit + 2;
 56 
 57 // Dimension calculations are imprecise, often resulting in values of e.g.
 58 // 44.99998. We need to round if we&#39;re really close to the next integer value.
 59 template&lt;typename T&gt; inline T roundForImpreciseConversion(double value)
 60 {
 61     value += (value &lt; 0) ? -0.01 : +0.01;
 62     return ((value &gt; std::numeric_limits&lt;T&gt;::max()) || (value &lt; std::numeric_limits&lt;T&gt;::min())) ? 0 : static_cast&lt;T&gt;(value);
 63 }
 64 
 65 template&lt;&gt; inline float roundForImpreciseConversion(double value)
 66 {
 67     double ceiledValue = ceil(value);
 68     double proximityToNextInt = ceiledValue - value;
 69     if (proximityToNextInt &lt;= 0.01 &amp;&amp; value &gt; 0)
 70         return static_cast&lt;float&gt;(ceiledValue);
 71     if (proximityToNextInt &gt;= 0.99 &amp;&amp; value &lt; 0)
 72         return static_cast&lt;float&gt;(floor(value));
 73     return static_cast&lt;float&gt;(value);
 74 }
 75 
 76 class CSSPrimitiveValue final : public CSSValue {
 77 public:
 78 
 79     static bool isFontRelativeLength(CSSUnitType);
 80     static bool isLength(CSSUnitType);
 81     static bool isResolution(CSSUnitType);
 82     static bool isViewportPercentageLength(CSSUnitType type) { return type &gt;= CSSUnitType::CSS_VW &amp;&amp; type &lt;= CSSUnitType::CSS_VMAX; }
 83 
 84     // FIXME: Some of these use primitiveUnitType() and some use primitiveType(). Those that use primitiveUnitType() are broken with calc().
 85     bool isAngle() const { return unitCategory(primitiveType()) == CSSUnitCategory::Angle; }
 86     bool isAttr() const { return primitiveUnitType() == CSSUnitType::CSS_ATTR; }
 87     bool isCounter() const { return primitiveUnitType() == CSSUnitType::CSS_COUNTER; }
 88     bool isFontIndependentLength() const { return primitiveUnitType() &gt;= CSSUnitType::CSS_PX &amp;&amp; primitiveUnitType() &lt;= CSSUnitType::CSS_PC; }
 89     bool isFontRelativeLength() const { return isFontRelativeLength(primitiveUnitType()); }
 90     bool isQuirkyEms() const { return primitiveType() == CSSUnitType::CSS_QUIRKY_EMS; }
 91     bool isLength() const { return isLength(static_cast&lt;CSSUnitType&gt;(primitiveType())); }
 92     bool isNumber() const { return primitiveType() == CSSUnitType::CSS_NUMBER; }
 93     bool isPercentage() const { return primitiveType() == CSSUnitType::CSS_PERCENTAGE; }
 94     bool isPx() const { return primitiveType() == CSSUnitType::CSS_PX; }
 95     bool isRect() const { return primitiveUnitType() == CSSUnitType::CSS_RECT; }
 96     bool isPair() const { return primitiveUnitType() == CSSUnitType::CSS_PAIR; }
 97     bool isPropertyID() const { return primitiveUnitType() == CSSUnitType::CSS_PROPERTY_ID; }
 98     bool isRGBColor() const { return primitiveUnitType() == CSSUnitType::CSS_RGBCOLOR; }
 99     bool isShape() const { return primitiveUnitType() == CSSUnitType::CSS_SHAPE; }
100     bool isString() const { return primitiveUnitType() == CSSUnitType::CSS_STRING; }
101     bool isFontFamily() const { return primitiveUnitType() == CSSUnitType::CSS_FONT_FAMILY; }
102     bool isTime() const { return unitCategory(primitiveUnitType()) == CSSUnitCategory::Time; }
103     bool isFrequency() const { return unitCategory(primitiveType()) == CSSUnitCategory::Frequency; }
104     bool isURI() const { return primitiveUnitType() == CSSUnitType::CSS_URI; }
105     bool isCalculated() const { return primitiveUnitType() == CSSUnitType::CSS_CALC; }
106     bool isCalculatedPercentageWithNumber() const { return primitiveType() == CSSUnitType::CSS_CALC_PERCENTAGE_WITH_NUMBER; }
107     bool isCalculatedPercentageWithLength() const { return primitiveType() == CSSUnitType::CSS_CALC_PERCENTAGE_WITH_LENGTH; }
108     bool isDotsPerInch() const { return primitiveType() == CSSUnitType::CSS_DPI; }
109     bool isDotsPerPixel() const { return primitiveType() == CSSUnitType::CSS_DPPX; }
110     bool isDotsPerCentimeter() const { return primitiveType() == CSSUnitType::CSS_DPCM; }
111     bool isResolution() const { return unitCategory(primitiveType()) == CSSUnitCategory::Resolution; }
112     bool isViewportPercentageLength() const { return isViewportPercentageLength(primitiveUnitType()); }
113     bool isViewportPercentageWidth() const { return primitiveUnitType() == CSSUnitType::CSS_VW; }
114     bool isViewportPercentageHeight() const { return primitiveUnitType() == CSSUnitType::CSS_VH; }
115     bool isViewportPercentageMax() const { return primitiveUnitType() == CSSUnitType::CSS_VMAX; }
116     bool isViewportPercentageMin() const { return primitiveUnitType() == CSSUnitType::CSS_VMIN; }
117     bool isValueID() const { return primitiveUnitType() == CSSUnitType::CSS_VALUE_ID; }
118     bool isFlex() const { return primitiveType() == CSSUnitType::CSS_FR; }
119 
120     static Ref&lt;CSSPrimitiveValue&gt; createIdentifier(CSSValueID valueID) { return adoptRef(*new CSSPrimitiveValue(valueID)); }
121     static Ref&lt;CSSPrimitiveValue&gt; createIdentifier(CSSPropertyID propertyID) { return adoptRef(*new CSSPrimitiveValue(propertyID)); }
122 
123     static Ref&lt;CSSPrimitiveValue&gt; create(double value, CSSUnitType type) { return adoptRef(*new CSSPrimitiveValue(value, type)); }
124     static Ref&lt;CSSPrimitiveValue&gt; create(const String&amp; value, CSSUnitType type) { return adoptRef(*new CSSPrimitiveValue(value, type)); }
125     static Ref&lt;CSSPrimitiveValue&gt; create(const Length&amp; value, const RenderStyle&amp; style) { return adoptRef(*new CSSPrimitiveValue(value, style)); }
126     static Ref&lt;CSSPrimitiveValue&gt; create(const LengthSize&amp; value, const RenderStyle&amp; style) { return adoptRef(*new CSSPrimitiveValue(value, style)); }
127 
128     template&lt;typename T&gt; static Ref&lt;CSSPrimitiveValue&gt; create(T&amp;&amp;);
129 
130     // This value is used to handle quirky margins in reflow roots (body, td, and th) like WinIE.
131     // The basic idea is that a stylesheet can use the value __qem (for quirky em) instead of em.
132     // When the quirky value is used, if you&#39;re in quirks mode, the margin will collapse away
133     // inside a table cell.
134     static Ref&lt;CSSPrimitiveValue&gt; createAllowingMarginQuirk(double value, CSSUnitType);
135 
136     ~CSSPrimitiveValue();
137 
138     void cleanup();
139 
140     WEBCORE_EXPORT CSSUnitType primitiveType() const;
141     WEBCORE_EXPORT ExceptionOr&lt;void&gt; setFloatValue(CSSUnitType , double);
142     WEBCORE_EXPORT ExceptionOr&lt;float&gt; getFloatValue(CSSUnitType) const;
143     WEBCORE_EXPORT ExceptionOr&lt;void&gt; setStringValue(CSSUnitType, const String&amp;);
144     WEBCORE_EXPORT ExceptionOr&lt;String&gt; getStringValue() const;
145 
146     double computeDegrees() const;
147 
148     enum TimeUnit { Seconds, Milliseconds };
149     template&lt;typename T, TimeUnit timeUnit&gt; T computeTime() const;
150 
151     template&lt;typename T&gt; T computeLength(const CSSToLengthConversionData&amp;) const;
152     template&lt;int&gt; Length convertToLength(const CSSToLengthConversionData&amp;) const;
153 
154     bool convertingToLengthRequiresNonNullStyle(int lengthConversion) const;
155 
156     double doubleValue(CSSUnitType) const;
157     // It&#39;s usually wrong to call this; it can trigger type conversion in calc without sufficient context to resolve relative length units.
158     double doubleValue() const;
159 
160     // These return nullopt for calc, for which range checking is not done at parse time: &lt;https://www.w3.org/TR/css3-values/#calc-range&gt;.
161     Optional&lt;bool&gt; isZero() const;
162     Optional&lt;bool&gt; isPositive() const;
163     Optional&lt;bool&gt; isNegative() const;
164 
165     template&lt;typename T&gt; inline T value(CSSUnitType type) const { return clampTo&lt;T&gt;(doubleValue(type)); }
166     template&lt;typename T&gt; inline T value() const { return clampTo&lt;T&gt;(doubleValue()); }
167 
168     float floatValue(CSSUnitType type) const { return value&lt;float&gt;(type); }
169     float floatValue() const { return value&lt;float&gt;(); }
170 
171     int intValue(CSSUnitType type) const { return value&lt;int&gt;(type); }
172     int intValue() const { return value&lt;int&gt;(); }
173 
174     WEBCORE_EXPORT String stringValue() const;
175 
176     const Color&amp; color() const { ASSERT(primitiveUnitType() == CSSUnitType::CSS_RGBCOLOR); return *m_value.color; }
177     Counter* counterValue() const { return primitiveUnitType() != CSSUnitType::CSS_COUNTER ? nullptr : m_value.counter; }
178     CSSCalcValue* cssCalcValue() const { return primitiveUnitType() != CSSUnitType::CSS_CALC ? nullptr : m_value.calc; }
179     const CSSFontFamily&amp; fontFamily() const { ASSERT(primitiveUnitType() == CSSUnitType::CSS_FONT_FAMILY); return *m_value.fontFamily; }
180     Pair* pairValue() const { return primitiveUnitType() != CSSUnitType::CSS_PAIR ? nullptr : m_value.pair; }
181     CSSPropertyID propertyID() const { return primitiveUnitType() == CSSUnitType::CSS_PROPERTY_ID ? m_value.propertyID : CSSPropertyInvalid; }
182     Quad* quadValue() const { return primitiveUnitType() != CSSUnitType::CSS_QUAD ? nullptr : m_value.quad; }
183     Rect* rectValue() const { return primitiveUnitType() != CSSUnitType::CSS_RECT ? nullptr : m_value.rect; }
184     CSSBasicShape* shapeValue() const { return primitiveUnitType() != CSSUnitType::CSS_SHAPE ? nullptr : m_value.shape; }
185     CSSValueID valueID() const { return primitiveUnitType() == CSSUnitType::CSS_VALUE_ID ? m_value.valueID : CSSValueInvalid; }
186 
187     template&lt;typename T&gt; inline operator T() const; // Defined in CSSPrimitiveValueMappings.h
188 
189     String customCSSText() const;
190 
191     // FIXME-NEWPARSER: Can ditch the boolean and just use the unit type once old parser is gone.
192     bool isQuirkValue() const { return m_isQuirkValue || primitiveType() == CSSUnitType::CSS_QUIRKY_EMS; }
193 
194     bool equals(const CSSPrimitiveValue&amp;) const;
195 
196     static double conversionToCanonicalUnitsScaleFactor(CSSUnitType);
197     static String unitTypeString(CSSUnitType);
198 
199     static double computeNonCalcLengthDouble(const CSSToLengthConversionData&amp;, CSSUnitType, double value);
200     // True if computeNonCalcLengthDouble would produce identical results when resolved against both these styles.
201     static bool equalForLengthResolution(const RenderStyle&amp;, const RenderStyle&amp;);
202 
203     Ref&lt;DeprecatedCSSOMPrimitiveValue&gt; createDeprecatedCSSOMPrimitiveWrapper(CSSStyleDeclaration&amp;) const;
204 
205     void collectDirectComputationalDependencies(HashSet&lt;CSSPropertyID&gt;&amp;) const;
206     void collectDirectRootComputationalDependencies(HashSet&lt;CSSPropertyID&gt;&amp;) const;
207 
208 private:
209     friend class CSSValuePool;
210     friend LazyNeverDestroyed&lt;CSSPrimitiveValue&gt;;
211 
212     CSSPrimitiveValue(CSSValueID);
213     CSSPrimitiveValue(CSSPropertyID);
214     CSSPrimitiveValue(const Color&amp;);
215     CSSPrimitiveValue(const Length&amp;);
216     CSSPrimitiveValue(const Length&amp;, const RenderStyle&amp;);
217     CSSPrimitiveValue(const LengthSize&amp;, const RenderStyle&amp;);
218     CSSPrimitiveValue(const String&amp;, CSSUnitType);
219     CSSPrimitiveValue(double, CSSUnitType);
220 
221     CSSPrimitiveValue(StaticCSSValueTag, CSSValueID);
222     CSSPrimitiveValue(StaticCSSValueTag, const Color&amp;);
223     CSSPrimitiveValue(StaticCSSValueTag, double, CSSUnitType);
224 
225     template&lt;typename T&gt; CSSPrimitiveValue(T); // Defined in CSSPrimitiveValueMappings.h
226     template&lt;typename T&gt; CSSPrimitiveValue(RefPtr&lt;T&gt;&amp;&amp;);
227     template&lt;typename T&gt; CSSPrimitiveValue(Ref&lt;T&gt;&amp;&amp;);
228 
229     static void create(int); // compile-time guard
230     static void create(unsigned); // compile-time guard
231     template&lt;typename T&gt; operator T*(); // compile-time guard
232 
233     void init(const Length&amp;);
234     void init(const LengthSize&amp;, const RenderStyle&amp;);
235     void init(Ref&lt;CSSBasicShape&gt;&amp;&amp;);
236     void init(RefPtr&lt;CSSCalcValue&gt;&amp;&amp;);
237     void init(Ref&lt;Counter&gt;&amp;&amp;);
238     void init(Ref&lt;Pair&gt;&amp;&amp;);
239     void init(Ref&lt;Quad&gt;&amp;&amp;);
240     void init(Ref&lt;Rect&gt;&amp;&amp;);
241 
242     CSSUnitType primitiveUnitType() const { return static_cast&lt;CSSUnitType&gt;(m_primitiveUnitType); }
243     void setPrimitiveUnitType(CSSUnitType type) { m_primitiveUnitType = static_cast&lt;unsigned&gt;(type); }
244 
245     Optional&lt;double&gt; doubleValueInternal(CSSUnitType targetUnitType) const;
246 
247     double computeLengthDouble(const CSSToLengthConversionData&amp;) const;
248 
249     ALWAYS_INLINE String formatNumberForCustomCSSText() const;
250     NEVER_INLINE String formatNumberValue(StringView) const;
251 
252     union {
253         CSSPropertyID propertyID;
254         CSSValueID valueID;
255         double num;
256         StringImpl* string;
257         Counter* counter;
258         Rect* rect;
259         Quad* quad;
260         const Color* color;
261         Pair* pair;
262         CSSBasicShape* shape;
263         CSSCalcValue* calc;
264         const CSSFontFamily* fontFamily;
265     } m_value;
266 };
267 
268 inline bool CSSPrimitiveValue::isFontRelativeLength(CSSUnitType type)
269 {
270     return type == CSSUnitType::CSS_EMS
271         || type == CSSUnitType::CSS_EXS
272         || type == CSSUnitType::CSS_REMS
273         || type == CSSUnitType::CSS_CHS
274         || type == CSSUnitType::CSS_QUIRKY_EMS;
275 }
276 
277 inline bool CSSPrimitiveValue::isLength(CSSUnitType type)
278 {
279     return (type &gt;= CSSUnitType::CSS_EMS &amp;&amp; type &lt;= CSSUnitType::CSS_PC)
280         || type == CSSUnitType::CSS_REMS
281         || type == CSSUnitType::CSS_CHS
282         || type == CSSUnitType::CSS_Q
283         || isViewportPercentageLength(type)
284         || type == CSSUnitType::CSS_QUIRKY_EMS;
285 }
286 
287 inline bool CSSPrimitiveValue::isResolution(CSSUnitType type)
288 {
289     return type &gt;= CSSUnitType::CSS_DPPX &amp;&amp; type &lt;= CSSUnitType::CSS_DPCM;
290 }
291 
292 template&lt;typename T&gt; inline Ref&lt;CSSPrimitiveValue&gt; CSSPrimitiveValue::create(T&amp;&amp; value)
293 {
294     return adoptRef(*new CSSPrimitiveValue(std::forward&lt;T&gt;(value)));
295 }
296 
297 inline Ref&lt;CSSPrimitiveValue&gt; CSSPrimitiveValue::createAllowingMarginQuirk(double value, CSSUnitType type)
298 {
299     auto result = adoptRef(*new CSSPrimitiveValue(value, type));
300     result-&gt;m_isQuirkValue = true;
301     return result;
302 }
303 
304 template&lt;typename T, CSSPrimitiveValue::TimeUnit timeUnit&gt; inline T CSSPrimitiveValue::computeTime() const
305 {
306     if (timeUnit == Seconds &amp;&amp; primitiveType() == CSSUnitType::CSS_S)
307         return value&lt;T&gt;();
308     if (timeUnit == Seconds &amp;&amp; primitiveType() == CSSUnitType::CSS_MS)
309         return value&lt;T&gt;() / 1000;
310     if (timeUnit == Milliseconds &amp;&amp; primitiveType() == CSSUnitType::CSS_MS)
311         return value&lt;T&gt;();
312     if (timeUnit == Milliseconds &amp;&amp; primitiveType() == CSSUnitType::CSS_S)
313         return value&lt;T&gt;() * 1000;
314     ASSERT_NOT_REACHED();
315     return 0;
316 }
317 
318 template&lt;typename T&gt; inline CSSPrimitiveValue::CSSPrimitiveValue(RefPtr&lt;T&gt;&amp;&amp; value)
319     : CSSValue(PrimitiveClass)
320 {
321     init(WTFMove(value));
322 }
323 
324 template&lt;typename T&gt; inline CSSPrimitiveValue::CSSPrimitiveValue(Ref&lt;T&gt;&amp;&amp; value)
325     : CSSValue(PrimitiveClass)
326 {
327     init(WTFMove(value));
328 }
329 
330 } // namespace WebCore
331 
332 SPECIALIZE_TYPE_TRAITS_CSS_VALUE(CSSPrimitiveValue, isPrimitiveValue())
    </pre>
  </body>
</html>