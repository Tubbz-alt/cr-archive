<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.web/src/main/native/Source/WebCore/svg/SVGLengthValue.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="SVGLengthList.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="SVGLengthValue.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/svg/SVGLengthValue.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,9 ***</span>
  /*
   * Copyright (C) 2004, 2005, 2006 Nikolas Zimmermann &lt;zimmermann@kde.org&gt;
   * Copyright (C) 2004, 2005, 2006, 2007 Rob Buis &lt;buis@kde.org&gt;
<span class="line-modified">!  * Copyright (C) 2007 Apple Inc. All rights reserved.</span>
   *
   * This library is free software; you can redistribute it and/or
   * modify it under the terms of the GNU Library General Public
   * License as published by the Free Software Foundation; either
   * version 2 of the License, or (at your option) any later version.
<span class="line-new-header">--- 1,9 ---</span>
  /*
   * Copyright (C) 2004, 2005, 2006 Nikolas Zimmermann &lt;zimmermann@kde.org&gt;
   * Copyright (C) 2004, 2005, 2006, 2007 Rob Buis &lt;buis@kde.org&gt;
<span class="line-modified">!  * Copyright (C) 2007-2019 Apple Inc. All rights reserved.</span>
   *
   * This library is free software; you can redistribute it and/or
   * modify it under the terms of the GNU Library General Public
   * License as published by the Free Software Foundation; either
   * version 2 of the License, or (at your option) any later version.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 20,194 ***</span>
   */
  
  #include &quot;config.h&quot;
  #include &quot;SVGLengthValue.h&quot;
  
<span class="line-modified">! #include &quot;CSSHelper.h&quot;</span>
  #include &quot;CSSPrimitiveValue.h&quot;
<span class="line-modified">! #include &quot;FloatConversion.h&quot;</span>
<span class="line-removed">- #include &quot;SVGNames.h&quot;</span>
  #include &quot;SVGParserUtilities.h&quot;
<span class="line-removed">- #include &lt;wtf/MathExtras.h&gt;</span>
<span class="line-removed">- #include &lt;wtf/NeverDestroyed.h&gt;</span>
  #include &lt;wtf/text/StringConcatenateNumbers.h&gt;
  #include &lt;wtf/text/TextStream.h&gt;
  
  namespace WebCore {
  
<span class="line-modified">! // Helper functions</span>
<span class="line-removed">- static inline unsigned storeUnit(SVGLengthMode mode, SVGLengthType type)</span>
  {
<span class="line-modified">!     return (mode &lt;&lt; 4) | type;</span>
<span class="line-modified">! }</span>
<span class="line-modified">! </span>
<span class="line-removed">- static inline SVGLengthMode extractMode(unsigned unit)</span>
<span class="line-removed">- {</span>
<span class="line-removed">-     unsigned mode = unit &gt;&gt; 4;</span>
<span class="line-removed">-     return static_cast&lt;SVGLengthMode&gt;(mode);</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
<span class="line-removed">- static inline SVGLengthType extractType(unsigned unit)</span>
<span class="line-removed">- {</span>
<span class="line-removed">-     return static_cast&lt;SVGLengthType&gt;(unit &amp; ((1 &lt;&lt; 4) - 1));</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
<span class="line-removed">- static inline const char* lengthTypeToString(SVGLengthType type)</span>
<span class="line-removed">- {</span>
<span class="line-removed">-     switch (type) {</span>
<span class="line-removed">-     case LengthTypeUnknown:</span>
<span class="line-removed">-     case LengthTypeNumber:</span>
          return &quot;&quot;;
<span class="line-modified">!     case LengthTypePercentage:</span>
          return &quot;%&quot;;
<span class="line-modified">!     case LengthTypeEMS:</span>
          return &quot;em&quot;;
<span class="line-modified">!     case LengthTypeEXS:</span>
          return &quot;ex&quot;;
<span class="line-modified">!     case LengthTypePX:</span>
          return &quot;px&quot;;
<span class="line-modified">!     case LengthTypeCM:</span>
          return &quot;cm&quot;;
<span class="line-modified">!     case LengthTypeMM:</span>
          return &quot;mm&quot;;
<span class="line-modified">!     case LengthTypeIN:</span>
          return &quot;in&quot;;
<span class="line-modified">!     case LengthTypePT:</span>
          return &quot;pt&quot;;
<span class="line-modified">!     case LengthTypePC:</span>
          return &quot;pc&quot;;
      }
  
      ASSERT_NOT_REACHED();
      return &quot;&quot;;
  }
  
<span class="line-modified">! inline SVGLengthType parseLengthType(const UChar* ptr, const UChar* end)</span>
  {
      if (ptr == end)
<span class="line-modified">!         return LengthTypeNumber;</span>
  
      const UChar firstChar = *ptr;
  
      if (++ptr == end)
<span class="line-modified">!         return firstChar == &#39;%&#39; ? LengthTypePercentage : LengthTypeUnknown;</span>
  
      const UChar secondChar = *ptr;
  
      if (++ptr != end)
<span class="line-modified">!         return LengthTypeUnknown;</span>
  
      if (firstChar == &#39;e&#39; &amp;&amp; secondChar == &#39;m&#39;)
<span class="line-modified">!         return LengthTypeEMS;</span>
      if (firstChar == &#39;e&#39; &amp;&amp; secondChar == &#39;x&#39;)
<span class="line-modified">!         return LengthTypeEXS;</span>
      if (firstChar == &#39;p&#39; &amp;&amp; secondChar == &#39;x&#39;)
<span class="line-modified">!         return LengthTypePX;</span>
      if (firstChar == &#39;c&#39; &amp;&amp; secondChar == &#39;m&#39;)
<span class="line-modified">!         return LengthTypeCM;</span>
      if (firstChar == &#39;m&#39; &amp;&amp; secondChar == &#39;m&#39;)
<span class="line-modified">!         return LengthTypeMM;</span>
      if (firstChar == &#39;i&#39; &amp;&amp; secondChar == &#39;n&#39;)
<span class="line-modified">!         return LengthTypeIN;</span>
      if (firstChar == &#39;p&#39; &amp;&amp; secondChar == &#39;t&#39;)
<span class="line-modified">!         return LengthTypePT;</span>
      if (firstChar == &#39;p&#39; &amp;&amp; secondChar == &#39;c&#39;)
<span class="line-modified">!         return LengthTypePC;</span>
  
<span class="line-modified">!     return LengthTypeUnknown;</span>
  }
  
<span class="line-modified">! SVGLengthValue::SVGLengthValue(SVGLengthMode mode, const String&amp; valueAsString)</span>
<span class="line-removed">-     : m_unit(storeUnit(mode, LengthTypeNumber))</span>
  {
<span class="line-modified">!     setValueAsString(valueAsString);</span>
  }
  
<span class="line-modified">! SVGLengthValue::SVGLengthValue(const SVGLengthContext&amp; context, float value, SVGLengthMode mode, SVGLengthType unitType)</span>
<span class="line-removed">-     : m_unit(storeUnit(mode, unitType))</span>
  {
<span class="line-modified">!     setValue(value, context);</span>
  }
  
<span class="line-modified">! ExceptionOr&lt;void&gt; SVGLengthValue::setValueAsString(const String&amp; valueAsString, SVGLengthMode mode)</span>
  {
<span class="line-modified">!     m_valueInSpecifiedUnits = 0;</span>
<span class="line-removed">-     m_unit = storeUnit(mode, LengthTypeNumber);</span>
<span class="line-removed">-     return setValueAsString(valueAsString);</span>
  }
  
<span class="line-modified">! bool SVGLengthValue::operator==(const SVGLengthValue&amp; other) const</span>
  {
<span class="line-modified">!     return m_unit == other.m_unit &amp;&amp; m_valueInSpecifiedUnits == other.m_valueInSpecifiedUnits;</span>
  }
  
<span class="line-modified">! bool SVGLengthValue::operator!=(const SVGLengthValue&amp; other) const</span>
  {
<span class="line-modified">!     return !operator==(other);</span>
  }
  
<span class="line-modified">! SVGLengthValue SVGLengthValue::construct(SVGLengthMode mode, const String&amp; valueAsString, SVGParsingError&amp; parseError, SVGLengthNegativeValuesMode negativeValuesMode)</span>
  {
<span class="line-modified">!     SVGLengthValue length(mode);</span>
  
      if (length.setValueAsString(valueAsString).hasException())
          parseError = ParsingAttributeFailedError;
<span class="line-modified">!     else if (negativeValuesMode == ForbidNegativeLengths &amp;&amp; length.valueInSpecifiedUnits() &lt; 0)</span>
          parseError = NegativeValueForbiddenError;
  
      return length;
  }
  
<span class="line-modified">! SVGLengthType SVGLengthValue::unitType() const</span>
  {
<span class="line-modified">!     return extractType(m_unit);</span>
  }
  
<span class="line-modified">! SVGLengthMode SVGLengthValue::unitMode() const</span>
  {
<span class="line-modified">!     return extractMode(m_unit);</span>
  }
  
  float SVGLengthValue::value(const SVGLengthContext&amp; context) const
  {
      auto result = valueForBindings(context);
      if (result.hasException())
          return 0;
      return result.releaseReturnValue();
  }
  
<span class="line-modified">! ExceptionOr&lt;float&gt; SVGLengthValue::valueForBindings(const SVGLengthContext&amp; context) const</span>
  {
<span class="line-modified">!     return context.convertValueToUserUnits(m_valueInSpecifiedUnits, extractMode(m_unit), extractType(m_unit));</span>
  }
  
<span class="line-modified">! ExceptionOr&lt;void&gt; SVGLengthValue::setValue(const SVGLengthContext&amp; context, float value, SVGLengthMode mode, SVGLengthType unitType)</span>
  {
<span class="line-modified">!     // FIXME: Seems like a bug that we change the value of m_unit even if setValue throws an exception.</span>
<span class="line-removed">-     m_unit = storeUnit(mode, unitType);</span>
<span class="line-removed">-     return setValue(value, context);</span>
  }
  
<span class="line-modified">! ExceptionOr&lt;void&gt; SVGLengthValue::setValue(float value, const SVGLengthContext&amp; context)</span>
  {
      // 100% = 100.0 instead of 1.0 for historical reasons, this could eventually be changed
<span class="line-modified">!     if (extractType(m_unit) == LengthTypePercentage)</span>
          value = value / 100;
  
<span class="line-modified">!     auto convertedValue = context.convertValueFromUserUnits(value, extractMode(m_unit), extractType(m_unit));</span>
      if (convertedValue.hasException())
          return convertedValue.releaseException();
      m_valueInSpecifiedUnits = convertedValue.releaseReturnValue();
      return { };
  }
<span class="line-removed">- float SVGLengthValue::valueAsPercentage() const</span>
<span class="line-removed">- {</span>
<span class="line-removed">-     // 100% = 100.0 instead of 1.0 for historical reasons, this could eventually be changed</span>
<span class="line-removed">-     if (extractType(m_unit) == LengthTypePercentage)</span>
<span class="line-removed">-         return m_valueInSpecifiedUnits / 100;</span>
  
<span class="line-modified">!     return m_valueInSpecifiedUnits;</span>
  }
  
  ExceptionOr&lt;void&gt; SVGLengthValue::setValueAsString(const String&amp; string)
  {
      if (string.isEmpty())
<span class="line-new-header">--- 20,272 ---</span>
   */
  
  #include &quot;config.h&quot;
  #include &quot;SVGLengthValue.h&quot;
  
<span class="line-modified">! #include &quot;AnimationUtilities.h&quot;</span>
  #include &quot;CSSPrimitiveValue.h&quot;
<span class="line-modified">! #include &quot;SVGLengthContext.h&quot;</span>
  #include &quot;SVGParserUtilities.h&quot;
  #include &lt;wtf/text/StringConcatenateNumbers.h&gt;
  #include &lt;wtf/text/TextStream.h&gt;
  
  namespace WebCore {
  
<span class="line-modified">! static inline const char* lengthTypeToString(SVGLengthType lengthType)</span>
  {
<span class="line-modified">!     switch (lengthType) {</span>
<span class="line-modified">!     case SVGLengthType::Unknown:</span>
<span class="line-modified">!     case SVGLengthType::Number:</span>
          return &quot;&quot;;
<span class="line-modified">!     case SVGLengthType::Percentage:</span>
          return &quot;%&quot;;
<span class="line-modified">!     case SVGLengthType::Ems:</span>
          return &quot;em&quot;;
<span class="line-modified">!     case SVGLengthType::Exs:</span>
          return &quot;ex&quot;;
<span class="line-modified">!     case SVGLengthType::Pixels:</span>
          return &quot;px&quot;;
<span class="line-modified">!     case SVGLengthType::Centimeters:</span>
          return &quot;cm&quot;;
<span class="line-modified">!     case SVGLengthType::Millimeters:</span>
          return &quot;mm&quot;;
<span class="line-modified">!     case SVGLengthType::Inches:</span>
          return &quot;in&quot;;
<span class="line-modified">!     case SVGLengthType::Points:</span>
          return &quot;pt&quot;;
<span class="line-modified">!     case SVGLengthType::Picas:</span>
          return &quot;pc&quot;;
      }
  
      ASSERT_NOT_REACHED();
      return &quot;&quot;;
  }
  
<span class="line-modified">! static inline SVGLengthType parseLengthType(const UChar* ptr, const UChar* end)</span>
  {
      if (ptr == end)
<span class="line-modified">!         return SVGLengthType::Number;</span>
  
      const UChar firstChar = *ptr;
  
      if (++ptr == end)
<span class="line-modified">!         return firstChar == &#39;%&#39; ? SVGLengthType::Percentage : SVGLengthType::Unknown;</span>
  
      const UChar secondChar = *ptr;
  
      if (++ptr != end)
<span class="line-modified">!         return SVGLengthType::Unknown;</span>
  
      if (firstChar == &#39;e&#39; &amp;&amp; secondChar == &#39;m&#39;)
<span class="line-modified">!         return SVGLengthType::Ems;</span>
      if (firstChar == &#39;e&#39; &amp;&amp; secondChar == &#39;x&#39;)
<span class="line-modified">!         return SVGLengthType::Exs;</span>
      if (firstChar == &#39;p&#39; &amp;&amp; secondChar == &#39;x&#39;)
<span class="line-modified">!         return SVGLengthType::Pixels;</span>
      if (firstChar == &#39;c&#39; &amp;&amp; secondChar == &#39;m&#39;)
<span class="line-modified">!         return SVGLengthType::Centimeters;</span>
      if (firstChar == &#39;m&#39; &amp;&amp; secondChar == &#39;m&#39;)
<span class="line-modified">!         return SVGLengthType::Millimeters;</span>
      if (firstChar == &#39;i&#39; &amp;&amp; secondChar == &#39;n&#39;)
<span class="line-modified">!         return SVGLengthType::Inches;</span>
      if (firstChar == &#39;p&#39; &amp;&amp; secondChar == &#39;t&#39;)
<span class="line-modified">!         return SVGLengthType::Points;</span>
      if (firstChar == &#39;p&#39; &amp;&amp; secondChar == &#39;c&#39;)
<span class="line-modified">!         return SVGLengthType::Picas;</span>
  
<span class="line-modified">!     return SVGLengthType::Unknown;</span>
  }
  
<span class="line-modified">! static inline SVGLengthType primitiveTypeToLengthType(CSSUnitType primitiveType)</span>
  {
<span class="line-modified">!     switch (primitiveType) {</span>
<span class="line-added">+     case CSSUnitType::CSS_UNKNOWN:</span>
<span class="line-added">+         return SVGLengthType::Unknown;</span>
<span class="line-added">+     case CSSUnitType::CSS_NUMBER:</span>
<span class="line-added">+         return SVGLengthType::Number;</span>
<span class="line-added">+     case CSSUnitType::CSS_PERCENTAGE:</span>
<span class="line-added">+         return SVGLengthType::Percentage;</span>
<span class="line-added">+     case CSSUnitType::CSS_EMS:</span>
<span class="line-added">+         return SVGLengthType::Ems;</span>
<span class="line-added">+     case CSSUnitType::CSS_EXS:</span>
<span class="line-added">+         return SVGLengthType::Exs;</span>
<span class="line-added">+     case CSSUnitType::CSS_PX:</span>
<span class="line-added">+         return SVGLengthType::Pixels;</span>
<span class="line-added">+     case CSSUnitType::CSS_CM:</span>
<span class="line-added">+         return SVGLengthType::Centimeters;</span>
<span class="line-added">+     case CSSUnitType::CSS_MM:</span>
<span class="line-added">+         return SVGLengthType::Millimeters;</span>
<span class="line-added">+     case CSSUnitType::CSS_IN:</span>
<span class="line-added">+         return SVGLengthType::Inches;</span>
<span class="line-added">+     case CSSUnitType::CSS_PT:</span>
<span class="line-added">+         return SVGLengthType::Points;</span>
<span class="line-added">+     case CSSUnitType::CSS_PC:</span>
<span class="line-added">+         return SVGLengthType::Picas;</span>
<span class="line-added">+     default:</span>
<span class="line-added">+         return SVGLengthType::Unknown;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     return SVGLengthType::Unknown;</span>
  }
  
<span class="line-modified">! static inline CSSUnitType lengthTypeToPrimitiveType(SVGLengthType lengthType)</span>
  {
<span class="line-modified">!     switch (lengthType) {</span>
<span class="line-added">+     case SVGLengthType::Unknown:</span>
<span class="line-added">+         return CSSUnitType::CSS_UNKNOWN;</span>
<span class="line-added">+     case SVGLengthType::Number:</span>
<span class="line-added">+         return CSSUnitType::CSS_NUMBER;</span>
<span class="line-added">+     case SVGLengthType::Percentage:</span>
<span class="line-added">+         return CSSUnitType::CSS_PERCENTAGE;</span>
<span class="line-added">+     case SVGLengthType::Ems:</span>
<span class="line-added">+         return CSSUnitType::CSS_EMS;</span>
<span class="line-added">+     case SVGLengthType::Exs:</span>
<span class="line-added">+         return CSSUnitType::CSS_EXS;</span>
<span class="line-added">+     case SVGLengthType::Pixels:</span>
<span class="line-added">+         return CSSUnitType::CSS_PX;</span>
<span class="line-added">+     case SVGLengthType::Centimeters:</span>
<span class="line-added">+         return CSSUnitType::CSS_CM;</span>
<span class="line-added">+     case SVGLengthType::Millimeters:</span>
<span class="line-added">+         return CSSUnitType::CSS_MM;</span>
<span class="line-added">+     case SVGLengthType::Inches:</span>
<span class="line-added">+         return CSSUnitType::CSS_IN;</span>
<span class="line-added">+     case SVGLengthType::Points:</span>
<span class="line-added">+         return CSSUnitType::CSS_PT;</span>
<span class="line-added">+     case SVGLengthType::Picas:</span>
<span class="line-added">+         return CSSUnitType::CSS_PC;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     ASSERT_NOT_REACHED();</span>
<span class="line-added">+     return CSSUnitType::CSS_UNKNOWN;</span>
  }
  
<span class="line-modified">! SVGLengthValue::SVGLengthValue(SVGLengthMode lengthMode, const String&amp; valueAsString)</span>
<span class="line-added">+     : m_lengthMode(lengthMode)</span>
  {
<span class="line-modified">!     setValueAsString(valueAsString);</span>
  }
  
<span class="line-modified">! SVGLengthValue::SVGLengthValue(float valueInSpecifiedUnits, SVGLengthType lengthType, SVGLengthMode lengthMode)</span>
<span class="line-added">+     : m_valueInSpecifiedUnits(valueInSpecifiedUnits)</span>
<span class="line-added">+     , m_lengthType(lengthType)</span>
<span class="line-added">+     , m_lengthMode(lengthMode)</span>
  {
<span class="line-modified">!     ASSERT(m_lengthType != SVGLengthType::Unknown);</span>
  }
  
<span class="line-modified">! SVGLengthValue::SVGLengthValue(const SVGLengthContext&amp; context, float value, SVGLengthType lengthType, SVGLengthMode lengthMode)</span>
<span class="line-added">+     : m_lengthType(lengthType)</span>
<span class="line-added">+     , m_lengthMode(lengthMode)</span>
  {
<span class="line-modified">!     setValue(context, value);</span>
  }
  
<span class="line-modified">! SVGLengthValue SVGLengthValue::construct(SVGLengthMode lengthMode, const String&amp; valueAsString, SVGParsingError&amp; parseError, SVGLengthNegativeValuesMode negativeValuesMode)</span>
  {
<span class="line-modified">!     SVGLengthValue length(lengthMode);</span>
  
      if (length.setValueAsString(valueAsString).hasException())
          parseError = ParsingAttributeFailedError;
<span class="line-modified">!     else if (negativeValuesMode == SVGLengthNegativeValuesMode::Forbid &amp;&amp; length.valueInSpecifiedUnits() &lt; 0)</span>
          parseError = NegativeValueForbiddenError;
  
      return length;
  }
  
<span class="line-modified">! SVGLengthValue SVGLengthValue::blend(const SVGLengthValue&amp; from, const SVGLengthValue&amp; to, float progress)</span>
<span class="line-added">+ {</span>
<span class="line-added">+     if ((from.isZero() &amp;&amp; to.isZero())</span>
<span class="line-added">+         || from.lengthType() == SVGLengthType::Unknown</span>
<span class="line-added">+         || to.lengthType() == SVGLengthType::Unknown</span>
<span class="line-added">+         || (!from.isZero() &amp;&amp; from.lengthType() != SVGLengthType::Percentage &amp;&amp; to.lengthType() == SVGLengthType::Percentage)</span>
<span class="line-added">+         || (!to.isZero() &amp;&amp; from.lengthType() == SVGLengthType::Percentage &amp;&amp; to.lengthType() != SVGLengthType::Percentage)</span>
<span class="line-added">+         || (!from.isZero() &amp;&amp; !to.isZero() &amp;&amp; (from.lengthType() == SVGLengthType::Ems || from.lengthType() == SVGLengthType::Exs) &amp;&amp; from.lengthType() != to.lengthType()))</span>
<span class="line-added">+         return to;</span>
<span class="line-added">+ </span>
<span class="line-added">+     if (from.lengthType() == SVGLengthType::Percentage || to.lengthType() == SVGLengthType::Percentage) {</span>
<span class="line-added">+         auto fromPercent = from.valueAsPercentage() * 100;</span>
<span class="line-added">+         auto toPercent = to.valueAsPercentage() * 100;</span>
<span class="line-added">+         return { WebCore::blend(fromPercent, toPercent, progress), SVGLengthType::Percentage };</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     if (from.lengthType() == to.lengthType() || from.isZero() || to.isZero() || from.isRelative()) {</span>
<span class="line-added">+         auto fromValue = from.valueInSpecifiedUnits();</span>
<span class="line-added">+         auto toValue = to.valueInSpecifiedUnits();</span>
<span class="line-added">+         return { WebCore::blend(fromValue, toValue, progress), to.isZero() ? from.lengthType() : to.lengthType() };</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     SVGLengthContext nonRelativeLengthContext(nullptr);</span>
<span class="line-added">+     auto fromValueInUserUnits = nonRelativeLengthContext.convertValueToUserUnits(from.valueInSpecifiedUnits(), from.lengthType(), from.lengthMode());</span>
<span class="line-added">+     if (fromValueInUserUnits.hasException())</span>
<span class="line-added">+         return { };</span>
<span class="line-added">+ </span>
<span class="line-added">+     auto fromValue = nonRelativeLengthContext.convertValueFromUserUnits(fromValueInUserUnits.releaseReturnValue(), to.lengthType(), to.lengthMode());</span>
<span class="line-added">+     if (fromValue.hasException())</span>
<span class="line-added">+         return { };</span>
<span class="line-added">+ </span>
<span class="line-added">+     float toValue = to.valueInSpecifiedUnits();</span>
<span class="line-added">+     return { WebCore::blend(fromValue.releaseReturnValue(), toValue, progress), to.lengthType() };</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ SVGLengthValue SVGLengthValue::fromCSSPrimitiveValue(const CSSPrimitiveValue&amp; value)</span>
  {
<span class="line-modified">!     // FIXME: This needs to call value.computeLength() so it can correctly resolve non-absolute units (webkit.org/b/204826).</span>
<span class="line-added">+     SVGLengthType lengthType = primitiveTypeToLengthType(value.primitiveType());</span>
<span class="line-added">+     return lengthType == SVGLengthType::Unknown ? SVGLengthValue() : SVGLengthValue(value.floatValue(), lengthType);</span>
  }
  
<span class="line-modified">! Ref&lt;CSSPrimitiveValue&gt; SVGLengthValue::toCSSPrimitiveValue(const SVGLengthValue&amp; length)</span>
  {
<span class="line-modified">!     return CSSPrimitiveValue::create(length.valueInSpecifiedUnits(), lengthTypeToPrimitiveType(length.lengthType()));</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ ExceptionOr&lt;void&gt; SVGLengthValue::setValueAsString(const String&amp; valueAsString, SVGLengthMode lengthMode)</span>
<span class="line-added">+ {</span>
<span class="line-added">+     m_valueInSpecifiedUnits = 0;</span>
<span class="line-added">+     m_lengthMode = lengthMode;</span>
<span class="line-added">+     m_lengthType = SVGLengthType::Number;</span>
<span class="line-added">+     return setValueAsString(valueAsString);</span>
  }
  
  float SVGLengthValue::value(const SVGLengthContext&amp; context) const
  {
      auto result = valueForBindings(context);
      if (result.hasException())
          return 0;
      return result.releaseReturnValue();
  }
  
<span class="line-modified">! String SVGLengthValue::valueAsString() const</span>
  {
<span class="line-modified">!     return makeString(m_valueInSpecifiedUnits, lengthTypeToString(m_lengthType));</span>
  }
  
<span class="line-modified">! ExceptionOr&lt;float&gt; SVGLengthValue::valueForBindings(const SVGLengthContext&amp; context) const</span>
  {
<span class="line-modified">!     return context.convertValueToUserUnits(m_valueInSpecifiedUnits, m_lengthType, m_lengthMode);</span>
  }
  
<span class="line-modified">! ExceptionOr&lt;void&gt; SVGLengthValue::setValue(const SVGLengthContext&amp; context, float value)</span>
  {
      // 100% = 100.0 instead of 1.0 for historical reasons, this could eventually be changed
<span class="line-modified">!     if (m_lengthType == SVGLengthType::Percentage)</span>
          value = value / 100;
  
<span class="line-modified">!     auto convertedValue = context.convertValueFromUserUnits(value, m_lengthType, m_lengthMode);</span>
      if (convertedValue.hasException())
          return convertedValue.releaseException();
      m_valueInSpecifiedUnits = convertedValue.releaseReturnValue();
      return { };
  }
  
<span class="line-modified">! ExceptionOr&lt;void&gt; SVGLengthValue::setValue(const SVGLengthContext&amp; context, float value, SVGLengthType lengthType, SVGLengthMode lengthMode)</span>
<span class="line-added">+ {</span>
<span class="line-added">+     // FIXME: Seems like a bug that we change the value of m_unit even if setValue throws an exception.</span>
<span class="line-added">+     m_lengthMode = lengthMode;</span>
<span class="line-added">+     m_lengthType = lengthType;</span>
<span class="line-added">+     return setValue(context, value);</span>
  }
  
  ExceptionOr&lt;void&gt; SVGLengthValue::setValueAsString(const String&amp; string)
  {
      if (string.isEmpty())
</pre>
<hr />
<pre>
<span class="line-old-header">*** 219,179 ***</span>
      const UChar* end = ptr + string.length();
  
      if (!parseNumber(ptr, end, convertedNumber, false))
          return Exception { SyntaxError };
  
<span class="line-modified">!     auto type = parseLengthType(ptr, end);</span>
<span class="line-modified">!     if (type == LengthTypeUnknown)</span>
          return Exception { SyntaxError };
  
<span class="line-modified">!     m_unit = storeUnit(extractMode(m_unit), type);</span>
      m_valueInSpecifiedUnits = convertedNumber;
      return { };
  }
  
<span class="line-modified">! String SVGLengthValue::valueAsString() const</span>
<span class="line-removed">- {</span>
<span class="line-removed">-     return makeString(FormattedNumber::fixedPrecision(m_valueInSpecifiedUnits), lengthTypeToString(extractType(m_unit)));</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
<span class="line-removed">- ExceptionOr&lt;void&gt; SVGLengthValue::newValueSpecifiedUnits(unsigned short type, float value)</span>
<span class="line-removed">- {</span>
<span class="line-removed">-     if (type == LengthTypeUnknown || type &gt; LengthTypePC)</span>
<span class="line-removed">-         return Exception { NotSupportedError };</span>
<span class="line-removed">- </span>
<span class="line-removed">-     m_unit = storeUnit(extractMode(m_unit), static_cast&lt;SVGLengthType&gt;(type));</span>
<span class="line-removed">-     m_valueInSpecifiedUnits = value;</span>
<span class="line-removed">-     return { };</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
<span class="line-removed">- ExceptionOr&lt;void&gt; SVGLengthValue::convertToSpecifiedUnits(unsigned short type, const SVGLengthContext&amp; context)</span>
  {
<span class="line-removed">-     if (type == LengthTypeUnknown || type &gt; LengthTypePC)</span>
<span class="line-removed">-         return Exception { NotSupportedError };</span>
<span class="line-removed">- </span>
      auto valueInUserUnits = valueForBindings(context);
      if (valueInUserUnits.hasException())
          return valueInUserUnits.releaseException();
  
<span class="line-modified">!     auto originalUnitAndType = m_unit;</span>
<span class="line-modified">!     m_unit = storeUnit(extractMode(m_unit), static_cast&lt;SVGLengthType&gt;(type));</span>
<span class="line-modified">!     auto result = setValue(valueInUserUnits.releaseReturnValue(), context);</span>
<span class="line-modified">!     if (result.hasException()) {</span>
<span class="line-removed">-         m_unit = originalUnitAndType;</span>
<span class="line-removed">-         return result.releaseException();</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     return { };</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
<span class="line-removed">- SVGLengthValue SVGLengthValue::fromCSSPrimitiveValue(const CSSPrimitiveValue&amp; value)</span>
<span class="line-removed">- {</span>
<span class="line-removed">-     SVGLengthType type;</span>
<span class="line-removed">-     switch (value.primitiveType()) {</span>
<span class="line-removed">-     case CSSPrimitiveValue::CSS_NUMBER:</span>
<span class="line-removed">-         type = LengthTypeNumber;</span>
<span class="line-removed">-         break;</span>
<span class="line-removed">-     case CSSPrimitiveValue::CSS_PERCENTAGE:</span>
<span class="line-removed">-         type = LengthTypePercentage;</span>
<span class="line-removed">-         break;</span>
<span class="line-removed">-     case CSSPrimitiveValue::CSS_EMS:</span>
<span class="line-removed">-         type = LengthTypeEMS;</span>
<span class="line-removed">-         break;</span>
<span class="line-removed">-     case CSSPrimitiveValue::CSS_EXS:</span>
<span class="line-removed">-         type = LengthTypeEXS;</span>
<span class="line-removed">-         break;</span>
<span class="line-removed">-     case CSSPrimitiveValue::CSS_PX:</span>
<span class="line-removed">-         type = LengthTypePX;</span>
<span class="line-removed">-         break;</span>
<span class="line-removed">-     case CSSPrimitiveValue::CSS_CM:</span>
<span class="line-removed">-         type = LengthTypeCM;</span>
<span class="line-removed">-         break;</span>
<span class="line-removed">-     case CSSPrimitiveValue::CSS_MM:</span>
<span class="line-removed">-         type = LengthTypeMM;</span>
<span class="line-removed">-         break;</span>
<span class="line-removed">-     case CSSPrimitiveValue::CSS_IN:</span>
<span class="line-removed">-         type = LengthTypeIN;</span>
<span class="line-removed">-         break;</span>
<span class="line-removed">-     case CSSPrimitiveValue::CSS_PT:</span>
<span class="line-removed">-         type = LengthTypePT;</span>
<span class="line-removed">-         break;</span>
<span class="line-removed">-     case CSSPrimitiveValue::CSS_PC:</span>
<span class="line-removed">-         type = LengthTypePC;</span>
<span class="line-removed">-         break;</span>
<span class="line-removed">-     case CSSPrimitiveValue::CSS_UNKNOWN:</span>
<span class="line-removed">-     default:</span>
          return { };
<span class="line-removed">-     };</span>
  
<span class="line-modified">!     SVGLengthValue length;</span>
<span class="line-modified">!     length.newValueSpecifiedUnits(type, value.floatValue());</span>
<span class="line-removed">-     return length;</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
<span class="line-removed">- Ref&lt;CSSPrimitiveValue&gt; SVGLengthValue::toCSSPrimitiveValue(const SVGLengthValue&amp; length)</span>
<span class="line-removed">- {</span>
<span class="line-removed">-     CSSPrimitiveValue::UnitType cssType = CSSPrimitiveValue::CSS_UNKNOWN;</span>
<span class="line-removed">-     switch (length.unitType()) {</span>
<span class="line-removed">-     case LengthTypeUnknown:</span>
<span class="line-removed">-         break;</span>
<span class="line-removed">-     case LengthTypeNumber:</span>
<span class="line-removed">-         cssType = CSSPrimitiveValue::CSS_NUMBER;</span>
<span class="line-removed">-         break;</span>
<span class="line-removed">-     case LengthTypePercentage:</span>
<span class="line-removed">-         cssType = CSSPrimitiveValue::CSS_PERCENTAGE;</span>
<span class="line-removed">-         break;</span>
<span class="line-removed">-     case LengthTypeEMS:</span>
<span class="line-removed">-         cssType = CSSPrimitiveValue::CSS_EMS;</span>
<span class="line-removed">-         break;</span>
<span class="line-removed">-     case LengthTypeEXS:</span>
<span class="line-removed">-         cssType = CSSPrimitiveValue::CSS_EXS;</span>
<span class="line-removed">-         break;</span>
<span class="line-removed">-     case LengthTypePX:</span>
<span class="line-removed">-         cssType = CSSPrimitiveValue::CSS_PX;</span>
<span class="line-removed">-         break;</span>
<span class="line-removed">-     case LengthTypeCM:</span>
<span class="line-removed">-         cssType = CSSPrimitiveValue::CSS_CM;</span>
<span class="line-removed">-         break;</span>
<span class="line-removed">-     case LengthTypeMM:</span>
<span class="line-removed">-         cssType = CSSPrimitiveValue::CSS_MM;</span>
<span class="line-removed">-         break;</span>
<span class="line-removed">-     case LengthTypeIN:</span>
<span class="line-removed">-         cssType = CSSPrimitiveValue::CSS_IN;</span>
<span class="line-removed">-         break;</span>
<span class="line-removed">-     case LengthTypePT:</span>
<span class="line-removed">-         cssType = CSSPrimitiveValue::CSS_PT;</span>
<span class="line-removed">-         break;</span>
<span class="line-removed">-     case LengthTypePC:</span>
<span class="line-removed">-         cssType = CSSPrimitiveValue::CSS_PC;</span>
<span class="line-removed">-         break;</span>
<span class="line-removed">-     };</span>
<span class="line-removed">- </span>
<span class="line-removed">-     return CSSPrimitiveValue::create(length.valueInSpecifiedUnits(), cssType);</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
<span class="line-removed">- SVGLengthMode SVGLengthValue::lengthModeForAnimatedLengthAttribute(const QualifiedName&amp; attrName)</span>
<span class="line-removed">- {</span>
<span class="line-removed">-     using Map = HashMap&lt;QualifiedName, SVGLengthMode&gt;;</span>
<span class="line-removed">-     static NeverDestroyed&lt;Map&gt; map = [] {</span>
<span class="line-removed">-         struct Mode {</span>
<span class="line-removed">-             const QualifiedName&amp; name;</span>
<span class="line-removed">-             SVGLengthMode mode;</span>
<span class="line-removed">-         };</span>
<span class="line-removed">-         static const Mode modes[] = {</span>
<span class="line-removed">-             { SVGNames::xAttr, LengthModeWidth },</span>
<span class="line-removed">-             { SVGNames::yAttr, LengthModeHeight },</span>
<span class="line-removed">-             { SVGNames::cxAttr, LengthModeWidth },</span>
<span class="line-removed">-             { SVGNames::cyAttr, LengthModeHeight },</span>
<span class="line-removed">-             { SVGNames::dxAttr, LengthModeWidth },</span>
<span class="line-removed">-             { SVGNames::dyAttr, LengthModeHeight },</span>
<span class="line-removed">-             { SVGNames::fxAttr, LengthModeWidth },</span>
<span class="line-removed">-             { SVGNames::fyAttr, LengthModeHeight },</span>
<span class="line-removed">-             { SVGNames::widthAttr, LengthModeWidth },</span>
<span class="line-removed">-             { SVGNames::heightAttr, LengthModeHeight },</span>
<span class="line-removed">-             { SVGNames::x1Attr, LengthModeWidth },</span>
<span class="line-removed">-             { SVGNames::x2Attr, LengthModeWidth },</span>
<span class="line-removed">-             { SVGNames::y1Attr, LengthModeHeight },</span>
<span class="line-removed">-             { SVGNames::y2Attr, LengthModeHeight },</span>
<span class="line-removed">-             { SVGNames::refXAttr, LengthModeWidth },</span>
<span class="line-removed">-             { SVGNames::refYAttr, LengthModeHeight },</span>
<span class="line-removed">-             { SVGNames::markerWidthAttr, LengthModeWidth },</span>
<span class="line-removed">-             { SVGNames::markerHeightAttr, LengthModeHeight },</span>
<span class="line-removed">-             { SVGNames::textLengthAttr, LengthModeWidth },</span>
<span class="line-removed">-             { SVGNames::startOffsetAttr, LengthModeWidth },</span>
<span class="line-removed">-         };</span>
<span class="line-removed">-         Map map;</span>
<span class="line-removed">-         for (auto&amp; mode : modes)</span>
<span class="line-removed">-             map.add(mode.name, mode.mode);</span>
<span class="line-removed">-         return map;</span>
<span class="line-removed">-     }();</span>
<span class="line-removed">- </span>
<span class="line-removed">-     auto result = map.get().find(attrName);</span>
<span class="line-removed">-     if (result == map.get().end())</span>
<span class="line-removed">-         return LengthModeOther;</span>
<span class="line-removed">-     return result-&gt;value;</span>
  }
  
  TextStream&amp; operator&lt;&lt;(TextStream&amp; ts, const SVGLengthValue&amp; length)
  {
      ts &lt;&lt; length.valueAsString();
<span class="line-new-header">--- 297,33 ---</span>
      const UChar* end = ptr + string.length();
  
      if (!parseNumber(ptr, end, convertedNumber, false))
          return Exception { SyntaxError };
  
<span class="line-modified">!     auto lengthType = parseLengthType(ptr, end);</span>
<span class="line-modified">!     if (lengthType == SVGLengthType::Unknown)</span>
          return Exception { SyntaxError };
  
<span class="line-modified">!     m_lengthType = lengthType;</span>
      m_valueInSpecifiedUnits = convertedNumber;
      return { };
  }
  
<span class="line-modified">! ExceptionOr&lt;void&gt; SVGLengthValue::convertToSpecifiedUnits(const SVGLengthContext&amp; context, SVGLengthType lengthType)</span>
  {
      auto valueInUserUnits = valueForBindings(context);
      if (valueInUserUnits.hasException())
          return valueInUserUnits.releaseException();
  
<span class="line-modified">!     auto originalLengthType = m_lengthType;</span>
<span class="line-modified">!     m_lengthType = lengthType;</span>
<span class="line-modified">!     auto result = setValue(context, valueInUserUnits.releaseReturnValue());</span>
<span class="line-modified">!     if (!result.hasException())</span>
          return { };
  
<span class="line-modified">!     m_lengthType = originalLengthType;</span>
<span class="line-modified">!     return result.releaseException();</span>
  }
  
  TextStream&amp; operator&lt;&lt;(TextStream&amp; ts, const SVGLengthValue&amp; length)
  {
      ts &lt;&lt; length.valueAsString();
</pre>
<center><a href="SVGLengthList.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="SVGLengthValue.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>