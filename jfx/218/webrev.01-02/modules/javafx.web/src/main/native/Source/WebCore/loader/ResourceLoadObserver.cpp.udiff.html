<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WebCore/loader/ResourceLoadObserver.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="ResourceLoadNotifier.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="ResourceLoadObserver.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/loader/ResourceLoadObserver.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -23,417 +23,35 @@</span>
   * THE POSSIBILITY OF SUCH DAMAGE.
   */
  
  #include &quot;config.h&quot;
  #include &quot;ResourceLoadObserver.h&quot;
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-removed">- #include &quot;DeprecatedGlobalSettings.h&quot;</span>
<span class="udiff-line-removed">- #include &quot;Document.h&quot;</span>
<span class="udiff-line-removed">- #include &quot;Frame.h&quot;</span>
<span class="udiff-line-removed">- #include &quot;FrameLoader.h&quot;</span>
<span class="udiff-line-removed">- #include &quot;FrameLoaderClient.h&quot;</span>
<span class="udiff-line-removed">- #include &quot;HTMLFrameOwnerElement.h&quot;</span>
<span class="udiff-line-removed">- #include &quot;Logging.h&quot;</span>
<span class="udiff-line-removed">- #include &quot;Page.h&quot;</span>
<span class="udiff-line-removed">- #include &quot;RegistrableDomain.h&quot;</span>
<span class="udiff-line-removed">- #include &quot;ResourceLoadStatistics.h&quot;</span>
<span class="udiff-line-removed">- #include &quot;ResourceRequest.h&quot;</span>
<span class="udiff-line-removed">- #include &quot;ResourceResponse.h&quot;</span>
<span class="udiff-line-removed">- #include &quot;RuntimeEnabledFeatures.h&quot;</span>
<span class="udiff-line-removed">- #include &quot;ScriptExecutionContext.h&quot;</span>
<span class="udiff-line-removed">- #include &quot;SecurityOrigin.h&quot;</span>
<span class="udiff-line-removed">- #include &quot;Settings.h&quot;</span>
<span class="udiff-line-removed">- #include &lt;wtf/URL.h&gt;</span>
<span class="udiff-line-modified-added">+ #include &lt;wtf/NeverDestroyed.h&gt;</span>
  
  namespace WebCore {
  
<span class="udiff-line-modified-removed">- static const Seconds minimumNotificationInterval { 5_s };</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- ResourceLoadObserver::ResourceLoadObserver()</span>
<span class="udiff-line-removed">-     : m_notificationTimer(*this, &amp;ResourceLoadObserver::updateCentralStatisticsStore)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- ResourceLoadObserver&amp; ResourceLoadObserver::shared()</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-     static NeverDestroyed&lt;ResourceLoadObserver&gt; resourceLoadObserver;</span>
<span class="udiff-line-removed">-     return resourceLoadObserver;</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- void ResourceLoadObserver::setStatisticsUpdatedCallback(Function&lt;void(PerSessionResourceLoadData&amp;&amp;)&gt;&amp;&amp; notificationCallback)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-     ASSERT(!m_notificationCallback);</span>
<span class="udiff-line-removed">-     m_notificationCallback = WTFMove(notificationCallback);</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- void ResourceLoadObserver::setRequestStorageAccessUnderOpenerCallback(Function&lt;void(PAL::SessionID sessionID, const RegistrableDomain&amp; domainInNeedOfStorageAccess, PageIdentifier openerPageID, const RegistrableDomain&amp; openerDomain)&gt;&amp;&amp; callback)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-     ASSERT(!m_requestStorageAccessUnderOpenerCallback);</span>
<span class="udiff-line-removed">-     m_requestStorageAccessUnderOpenerCallback = WTFMove(callback);</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- void ResourceLoadObserver::setLogUserInteractionNotificationCallback(Function&lt;void(PAL::SessionID, const RegistrableDomain&amp;)&gt;&amp;&amp; callback)</span>
<span class="udiff-line-modified-added">+ static ResourceLoadObserver*&amp; sharedObserver()</span>
  {
<span class="udiff-line-modified-removed">-     ASSERT(!m_logUserInteractionNotificationCallback);</span>
<span class="udiff-line-modified-removed">-     m_logUserInteractionNotificationCallback = WTFMove(callback);</span>
<span class="udiff-line-modified-added">+     static ResourceLoadObserver* observer = nullptr;</span>
<span class="udiff-line-modified-added">+     return observer;</span>
  }
  
<span class="udiff-line-modified-removed">- static inline bool is3xxRedirect(const ResourceResponse&amp; response)</span>
<span class="udiff-line-modified-added">+ void ResourceLoadObserver::setShared(ResourceLoadObserver&amp; observer)</span>
  {
<span class="udiff-line-modified-removed">-     return response.httpStatusCode() &gt;= 300 &amp;&amp; response.httpStatusCode() &lt;= 399;</span>
<span class="udiff-line-modified-added">+     RELEASE_ASSERT(!sharedObserver());</span>
<span class="udiff-line-added">+     sharedObserver() = &amp;observer;</span>
  }
  
<span class="udiff-line-modified-removed">- bool ResourceLoadObserver::shouldLog(PAL::SessionID sessionID) const</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-     return DeprecatedGlobalSettings::resourceLoadStatisticsEnabled() &amp;&amp; !sessionID.isEphemeral() &amp;&amp; m_notificationCallback;</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- void ResourceLoadObserver::logSubresourceLoading(const Frame* frame, const ResourceRequest&amp; newRequest, const ResourceResponse&amp; redirectResponse)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-     ASSERT(frame-&gt;page());</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     if (!frame)</span>
<span class="udiff-line-removed">-         return;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     auto* page = frame-&gt;page();</span>
<span class="udiff-line-removed">-     if (!page || !shouldLog(page-&gt;sessionID()))</span>
<span class="udiff-line-removed">-         return;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     bool isRedirect = is3xxRedirect(redirectResponse);</span>
<span class="udiff-line-removed">-     const URL&amp; redirectedFromURL = redirectResponse.url();</span>
<span class="udiff-line-removed">-     const URL&amp; targetURL = newRequest.url();</span>
<span class="udiff-line-removed">-     const URL&amp; topFrameURL = frame ? frame-&gt;mainFrame().document()-&gt;url() : URL();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     auto targetHost = targetURL.host();</span>
<span class="udiff-line-removed">-     auto topFrameHost = topFrameURL.host();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     if (targetHost.isEmpty() || topFrameHost.isEmpty() || targetHost == topFrameHost || (isRedirect &amp;&amp; targetHost == redirectedFromURL.host()))</span>
<span class="udiff-line-removed">-         return;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     RegistrableDomain targetDomain { targetURL };</span>
<span class="udiff-line-removed">-     RegistrableDomain topFrameDomain { topFrameURL };</span>
<span class="udiff-line-removed">-     RegistrableDomain redirectedFromDomain { redirectedFromURL };</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     if (targetDomain == topFrameDomain || (isRedirect &amp;&amp; targetDomain == redirectedFromDomain))</span>
<span class="udiff-line-removed">-         return;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     {</span>
<span class="udiff-line-removed">-         auto&amp; targetStatistics = ensureResourceStatisticsForRegistrableDomain(page-&gt;sessionID(), targetDomain);</span>
<span class="udiff-line-removed">-         auto lastSeen = ResourceLoadStatistics::reduceTimeResolution(WallTime::now());</span>
<span class="udiff-line-removed">-         targetStatistics.lastSeen = lastSeen;</span>
<span class="udiff-line-removed">-         targetStatistics.subresourceUnderTopFrameDomains.add(topFrameDomain);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         scheduleNotificationIfNeeded();</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     if (isRedirect) {</span>
<span class="udiff-line-removed">-         auto&amp; redirectingOriginStatistics = ensureResourceStatisticsForRegistrableDomain(page-&gt;sessionID(), redirectedFromDomain);</span>
<span class="udiff-line-removed">-         redirectingOriginStatistics.subresourceUniqueRedirectsTo.add(targetDomain);</span>
<span class="udiff-line-removed">-         auto&amp; targetStatistics = ensureResourceStatisticsForRegistrableDomain(page-&gt;sessionID(), targetDomain);</span>
<span class="udiff-line-removed">-         targetStatistics.subresourceUniqueRedirectsFrom.add(redirectedFromDomain);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         scheduleNotificationIfNeeded();</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- void ResourceLoadObserver::logWebSocketLoading(const URL&amp; targetURL, const URL&amp; mainFrameURL, PAL::SessionID sessionID)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-     if (!shouldLog(sessionID))</span>
<span class="udiff-line-removed">-         return;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     auto targetHost = targetURL.host();</span>
<span class="udiff-line-removed">-     auto mainFrameHost = mainFrameURL.host();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     if (targetHost.isEmpty() || mainFrameHost.isEmpty() || targetHost == mainFrameHost)</span>
<span class="udiff-line-removed">-         return;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     RegistrableDomain targetDomain { targetURL };</span>
<span class="udiff-line-removed">-     RegistrableDomain topFrameDomain { mainFrameURL };</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     if (targetDomain == topFrameDomain)</span>
<span class="udiff-line-removed">-         return;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     auto lastSeen = ResourceLoadStatistics::reduceTimeResolution(WallTime::now());</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     auto&amp; targetStatistics = ensureResourceStatisticsForRegistrableDomain(sessionID, targetDomain);</span>
<span class="udiff-line-removed">-     targetStatistics.lastSeen = lastSeen;</span>
<span class="udiff-line-removed">-     targetStatistics.subresourceUnderTopFrameDomains.add(topFrameDomain);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     scheduleNotificationIfNeeded();</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- void ResourceLoadObserver::logUserInteractionWithReducedTimeResolution(const Document&amp; document)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-     if (!document.sessionID().isValid() || !shouldLog(document.sessionID()))</span>
<span class="udiff-line-removed">-         return;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     auto&amp; url = document.url();</span>
<span class="udiff-line-removed">-     if (url.protocolIsAbout() || url.isLocalFile() || url.isEmpty())</span>
<span class="udiff-line-removed">-         return;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     RegistrableDomain topFrameDomain { url };</span>
<span class="udiff-line-removed">-     auto newTime = ResourceLoadStatistics::reduceTimeResolution(WallTime::now());</span>
<span class="udiff-line-removed">-     auto lastReportedUserInteraction = m_lastReportedUserInteractionMap.get(topFrameDomain);</span>
<span class="udiff-line-removed">-     if (newTime == lastReportedUserInteraction)</span>
<span class="udiff-line-removed">-         return;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     m_lastReportedUserInteractionMap.set(topFrameDomain, newTime);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     auto&amp; statistics = ensureResourceStatisticsForRegistrableDomain(document.sessionID(), topFrameDomain);</span>
<span class="udiff-line-removed">-     statistics.hadUserInteraction = true;</span>
<span class="udiff-line-removed">-     statistics.lastSeen = newTime;</span>
<span class="udiff-line-removed">-     statistics.mostRecentUserInteractionTime = newTime;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- #if ENABLE(RESOURCE_LOAD_STATISTICS)</span>
<span class="udiff-line-removed">-     if (auto* frame = document.frame()) {</span>
<span class="udiff-line-removed">-         if (auto* opener = frame-&gt;loader().opener()) {</span>
<span class="udiff-line-removed">-             if (auto* openerDocument = opener-&gt;document()) {</span>
<span class="udiff-line-removed">-                 if (auto* openerFrame = openerDocument-&gt;frame()) {</span>
<span class="udiff-line-removed">-                     if (auto openerPageID = openerFrame-&gt;loader().client().pageID())</span>
<span class="udiff-line-removed">-                         requestStorageAccessUnderOpener(document.sessionID(), topFrameDomain, openerPageID.value(), *openerDocument);</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     // We notify right away in case of a user interaction instead of waiting the usual 5 seconds because we want</span>
<span class="udiff-line-removed">-     // to update cookie blocking state as quickly as possible.</span>
<span class="udiff-line-removed">-     m_logUserInteractionNotificationCallback(document.sessionID(), topFrameDomain);</span>
<span class="udiff-line-removed">- #endif</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- #if ENABLE(RESOURCE_LOAD_STATISTICS) &amp;&amp; !RELEASE_LOG_DISABLED</span>
<span class="udiff-line-removed">-     if (shouldLogUserInteraction()) {</span>
<span class="udiff-line-removed">-         auto counter = ++m_loggingCounter;</span>
<span class="udiff-line-removed">- #define LOCAL_LOG(str, ...) \</span>
<span class="udiff-line-removed">-         RELEASE_LOG(ResourceLoadStatistics, &quot;ResourceLoadObserver::logUserInteraction: counter = %&quot; PRIu64 &quot;: &quot; str, counter, ##__VA_ARGS__)</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         auto escapeForJSON = [](String s) {</span>
<span class="udiff-line-removed">-             s.replace(&#39;\\&#39;, &quot;\\\\&quot;).replace(&#39;&quot;&#39;, &quot;\\\&quot;&quot;);</span>
<span class="udiff-line-removed">-             return s;</span>
<span class="udiff-line-removed">-         };</span>
<span class="udiff-line-removed">-         auto escapedURL = escapeForJSON(url.string());</span>
<span class="udiff-line-removed">-         auto escapedDomain = escapeForJSON(topFrameDomain.string());</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         LOCAL_LOG(R&quot;({ &quot;url&quot;: &quot;%{public}s&quot;,)&quot;, escapedURL.utf8().data());</span>
<span class="udiff-line-removed">-         LOCAL_LOG(R&quot;(  &quot;domain&quot; : &quot;%{public}s&quot;,)&quot;, escapedDomain.utf8().data());</span>
<span class="udiff-line-removed">-         LOCAL_LOG(R&quot;(  &quot;until&quot; : %f })&quot;, newTime.secondsSinceEpoch().seconds());</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- #undef LOCAL_LOG</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- #endif</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- #if ENABLE(RESOURCE_LOAD_STATISTICS)</span>
<span class="udiff-line-removed">- void ResourceLoadObserver::requestStorageAccessUnderOpener(PAL::SessionID sessionID, const RegistrableDomain&amp; domainInNeedOfStorageAccess, PageIdentifier openerPageID, Document&amp; openerDocument)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-     auto openerUrl = openerDocument.url();</span>
<span class="udiff-line-removed">-     RegistrableDomain openerDomain { openerUrl };</span>
<span class="udiff-line-removed">-     if (domainInNeedOfStorageAccess != openerDomain</span>
<span class="udiff-line-removed">-         &amp;&amp; !openerDocument.hasRequestedPageSpecificStorageAccessWithUserInteraction(domainInNeedOfStorageAccess)</span>
<span class="udiff-line-removed">-         &amp;&amp; !equalIgnoringASCIICase(openerUrl.string(), WTF::blankURL())) {</span>
<span class="udiff-line-removed">-         m_requestStorageAccessUnderOpenerCallback(sessionID, domainInNeedOfStorageAccess, openerPageID, openerDomain);</span>
<span class="udiff-line-removed">-         // Remember user interaction-based requests since they don&#39;t need to be repeated.</span>
<span class="udiff-line-removed">-         openerDocument.setHasRequestedPageSpecificStorageAccessWithUserInteraction(domainInNeedOfStorageAccess);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- #endif</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- void ResourceLoadObserver::logFontLoad(const Document&amp; document, const String&amp; familyName, bool loadStatus)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">- #if ENABLE(WEB_API_STATISTICS)</span>
<span class="udiff-line-removed">-     if (!shouldLog(document.sessionID()))</span>
<span class="udiff-line-removed">-         return;</span>
<span class="udiff-line-removed">-     RegistrableDomain registrableDomain { document.url() };</span>
<span class="udiff-line-removed">-     auto&amp; statistics = ensureResourceStatisticsForRegistrableDomain(document.sessionID, registrableDomain);</span>
<span class="udiff-line-removed">-     bool shouldCallNotificationCallback = false;</span>
<span class="udiff-line-removed">-     if (!loadStatus) {</span>
<span class="udiff-line-removed">-         if (statistics.fontsFailedToLoad.add(familyName).isNewEntry)</span>
<span class="udiff-line-removed">-             shouldCallNotificationCallback = true;</span>
<span class="udiff-line-removed">-     } else {</span>
<span class="udiff-line-removed">-         if (statistics.fontsSuccessfullyLoaded.add(familyName).isNewEntry)</span>
<span class="udiff-line-removed">-             shouldCallNotificationCallback = true;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-     RegistrableDomain mainFrameRegistrableDomain { document.topDocument().url() };</span>
<span class="udiff-line-removed">-     if (statistics.topFrameRegistrableDomainsWhichAccessedWebAPIs.add(mainFrameRegistrableDomain.string()).isNewEntry)</span>
<span class="udiff-line-removed">-         shouldCallNotificationCallback = true;</span>
<span class="udiff-line-removed">-     if (shouldCallNotificationCallback)</span>
<span class="udiff-line-removed">-         scheduleNotificationIfNeeded();</span>
<span class="udiff-line-removed">- #else</span>
<span class="udiff-line-removed">-     UNUSED_PARAM(document);</span>
<span class="udiff-line-removed">-     UNUSED_PARAM(familyName);</span>
<span class="udiff-line-removed">-     UNUSED_PARAM(loadStatus);</span>
<span class="udiff-line-removed">- #endif</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- void ResourceLoadObserver::logCanvasRead(const Document&amp; document)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">- #if ENABLE(WEB_API_STATISTICS)</span>
<span class="udiff-line-removed">-     if (!shouldLog(document.sessionID()))</span>
<span class="udiff-line-removed">-         return;</span>
<span class="udiff-line-removed">-     RegistrableDomain registrableDomain { document.url() };</span>
<span class="udiff-line-removed">-     auto&amp; statistics = ensureResourceStatisticsForRegistrableDomain(document.sessionID(), registrableDomain);</span>
<span class="udiff-line-removed">-     RegistrableDomain mainFrameRegistrableDomain { document.topDocument().url() };</span>
<span class="udiff-line-removed">-     statistics.canvasActivityRecord.wasDataRead = true;</span>
<span class="udiff-line-removed">-     if (statistics.topFrameRegistrableDomainsWhichAccessedWebAPIs.add(mainFrameRegistrableDomain.string()).isNewEntry)</span>
<span class="udiff-line-removed">-         scheduleNotificationIfNeeded();</span>
<span class="udiff-line-removed">- #else</span>
<span class="udiff-line-removed">-     UNUSED_PARAM(document);</span>
<span class="udiff-line-removed">- #endif</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- void ResourceLoadObserver::logCanvasWriteOrMeasure(const Document&amp; document, const String&amp; textWritten)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">- #if ENABLE(WEB_API_STATISTICS)</span>
<span class="udiff-line-removed">-     if (!shouldLog(document.sessionID()))</span>
<span class="udiff-line-removed">-         return;</span>
<span class="udiff-line-removed">-     RegistrableDomain registrableDomain { document.url() };</span>
<span class="udiff-line-removed">-     auto&amp; statistics = ensureResourceStatisticsForRegistrableDomain(document.sessionID, registrableDomain);</span>
<span class="udiff-line-removed">-     bool shouldCallNotificationCallback = false;</span>
<span class="udiff-line-removed">-     RegistrableDomain mainFrameRegistrableDomain { document.topDocument().url() };</span>
<span class="udiff-line-removed">-     if (statistics.canvasActivityRecord.recordWrittenOrMeasuredText(textWritten))</span>
<span class="udiff-line-removed">-         shouldCallNotificationCallback = true;</span>
<span class="udiff-line-removed">-     if (statistics.topFrameRegistrableDomainsWhichAccessedWebAPIs.add(mainFrameRegistrableDomain.string()).isNewEntry)</span>
<span class="udiff-line-removed">-         shouldCallNotificationCallback = true;</span>
<span class="udiff-line-removed">-     if (shouldCallNotificationCallback)</span>
<span class="udiff-line-removed">-         scheduleNotificationIfNeeded();</span>
<span class="udiff-line-removed">- #else</span>
<span class="udiff-line-removed">-     UNUSED_PARAM(document);</span>
<span class="udiff-line-removed">-     UNUSED_PARAM(textWritten);</span>
<span class="udiff-line-removed">- #endif</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- void ResourceLoadObserver::logNavigatorAPIAccessed(const Document&amp; document, const ResourceLoadStatistics::NavigatorAPI functionName)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">- #if ENABLE(WEB_API_STATISTICS)</span>
<span class="udiff-line-removed">-     if (!shouldLog(document.sessionID()))</span>
<span class="udiff-line-removed">-         return;</span>
<span class="udiff-line-removed">-     RegistrableDomain registrableDomain { document.url() };</span>
<span class="udiff-line-removed">-     auto&amp; statistics = ensureResourceStatisticsForRegistrableDomain(document.sessionID, registrableDomain);</span>
<span class="udiff-line-removed">-     bool shouldCallNotificationCallback = false;</span>
<span class="udiff-line-removed">-     if (!statistics.navigatorFunctionsAccessed.contains(functionName)) {</span>
<span class="udiff-line-removed">-         statistics.navigatorFunctionsAccessed.add(functionName);</span>
<span class="udiff-line-removed">-         shouldCallNotificationCallback = true;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-     RegistrableDomain mainFrameRegistrableDomain { document.topDocument().url() };</span>
<span class="udiff-line-removed">-     if (statistics.topFrameRegistrableDomainsWhichAccessedWebAPIs.add(mainFrameRegistrableDomain.string()).isNewEntry)</span>
<span class="udiff-line-removed">-         shouldCallNotificationCallback = true;</span>
<span class="udiff-line-removed">-     if (shouldCallNotificationCallback)</span>
<span class="udiff-line-removed">-         scheduleNotificationIfNeeded();</span>
<span class="udiff-line-removed">- #else</span>
<span class="udiff-line-removed">-     UNUSED_PARAM(document);</span>
<span class="udiff-line-removed">-     UNUSED_PARAM(functionName);</span>
<span class="udiff-line-removed">- #endif</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- void ResourceLoadObserver::logScreenAPIAccessed(const Document&amp; document, const ResourceLoadStatistics::ScreenAPI functionName)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">- #if ENABLE(WEB_API_STATISTICS)</span>
<span class="udiff-line-removed">-     if (!shouldLog(document.sessionID()))</span>
<span class="udiff-line-removed">-         return;</span>
<span class="udiff-line-removed">-     RegistrableDomain registrableDomain { document.url() };</span>
<span class="udiff-line-removed">-     auto&amp; statistics = ensureResourceStatisticsForRegistrableDomain(document.sessionID, registrableDomain);</span>
<span class="udiff-line-removed">-     bool shouldCallNotificationCallback = false;</span>
<span class="udiff-line-removed">-     if (!statistics.screenFunctionsAccessed.contains(functionName)) {</span>
<span class="udiff-line-removed">-         statistics.screenFunctionsAccessed.add(functionName);</span>
<span class="udiff-line-removed">-         shouldCallNotificationCallback = true;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-     RegistrableDomain mainFrameRegistrableDomain { document.topDocument().url() };</span>
<span class="udiff-line-removed">-     if (statistics.topFrameRegistrableDomainsWhichAccessedWebAPIs.add(mainFrameRegistrableDomain.string()).isNewEntry)</span>
<span class="udiff-line-removed">-         shouldCallNotificationCallback = true;</span>
<span class="udiff-line-removed">-     if (shouldCallNotificationCallback)</span>
<span class="udiff-line-removed">-         scheduleNotificationIfNeeded();</span>
<span class="udiff-line-removed">- #else</span>
<span class="udiff-line-removed">-     UNUSED_PARAM(document);</span>
<span class="udiff-line-removed">-     UNUSED_PARAM(functionName);</span>
<span class="udiff-line-removed">- #endif</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- ResourceLoadStatistics&amp; ResourceLoadObserver::ensureResourceStatisticsForRegistrableDomain(PAL::SessionID sessionID, const RegistrableDomain&amp; domain)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-     auto addResult = m_perSessionResourceStatisticsMap.ensure(sessionID, [] {</span>
<span class="udiff-line-removed">-         return makeUnique&lt;HashMap&lt;RegistrableDomain, ResourceLoadStatistics&gt;&gt;();</span>
<span class="udiff-line-removed">-     });</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     auto addDomainResult = addResult.iterator-&gt;value-&gt;ensure(domain, [&amp;domain] {</span>
<span class="udiff-line-removed">-         return ResourceLoadStatistics(domain);</span>
<span class="udiff-line-removed">-     });</span>
<span class="udiff-line-removed">-     return addDomainResult.iterator-&gt;value;</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- void ResourceLoadObserver::scheduleNotificationIfNeeded()</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-     ASSERT(m_notificationCallback);</span>
<span class="udiff-line-removed">-     if (m_perSessionResourceStatisticsMap.isEmpty()) {</span>
<span class="udiff-line-removed">-         m_notificationTimer.stop();</span>
<span class="udiff-line-removed">-         return;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     if (!m_notificationTimer.isActive())</span>
<span class="udiff-line-removed">-         m_notificationTimer.startOneShot(minimumNotificationInterval);</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- void ResourceLoadObserver::updateCentralStatisticsStore()</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-     ASSERT(m_notificationCallback);</span>
<span class="udiff-line-removed">-     m_notificationTimer.stop();</span>
<span class="udiff-line-removed">-     m_notificationCallback(takeStatistics());</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- String ResourceLoadObserver::statisticsForURL(PAL::SessionID sessionID, const URL&amp; url)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-     auto* resourceStatisticsByDomain = m_perSessionResourceStatisticsMap.get(sessionID);</span>
<span class="udiff-line-removed">-     if (!resourceStatisticsByDomain)</span>
<span class="udiff-line-removed">-         return emptyString();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     auto iter = resourceStatisticsByDomain-&gt;find(RegistrableDomain { url });</span>
<span class="udiff-line-removed">-     if (iter == resourceStatisticsByDomain-&gt;end())</span>
<span class="udiff-line-removed">-         return emptyString();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     return makeString(&quot;Statistics for &quot;, url.host().toString(), &quot;:\n&quot;, iter-&gt;value.toString());</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- auto ResourceLoadObserver::takeStatistics() -&gt; PerSessionResourceLoadData</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-     PerSessionResourceLoadData perSessionStatistics;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     for (auto&amp; iter : m_perSessionResourceStatisticsMap) {</span>
<span class="udiff-line-removed">-         Vector&lt;ResourceLoadStatistics&gt; statistics;</span>
<span class="udiff-line-removed">-         statistics.reserveInitialCapacity(iter.value-&gt;size());</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         for (auto&amp; statistic : iter.value-&gt;values())</span>
<span class="udiff-line-removed">-             statistics.uncheckedAppend(WTFMove(statistic));</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         perSessionStatistics.append(std::make_pair(iter.key, WTFMove(statistics)));</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     m_perSessionResourceStatisticsMap.clear();</span>
<span class="udiff-line-removed">-     return perSessionStatistics;</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- void ResourceLoadObserver::clearState()</span>
<span class="udiff-line-modified-added">+ ResourceLoadObserver&amp; ResourceLoadObserver::shared()</span>
  {
<span class="udiff-line-modified-removed">-     m_notificationTimer.stop();</span>
<span class="udiff-line-modified-removed">-     m_perSessionResourceStatisticsMap.clear();</span>
<span class="udiff-line-modified-removed">-     m_lastReportedUserInteractionMap.clear();</span>
<span class="udiff-line-modified-added">+     static NeverDestroyed&lt;ResourceLoadObserver&gt; emptyObserver;</span>
<span class="udiff-line-modified-added">+     if (!sharedObserver())</span>
<span class="udiff-line-modified-added">+         return emptyObserver;</span>
<span class="udiff-line-added">+     return *sharedObserver();</span>
  }
  
<span class="udiff-line-modified-removed">- URL ResourceLoadObserver::nonNullOwnerURL(const Document&amp; document) const</span>
<span class="udiff-line-modified-added">+ ResourceLoadObserver* ResourceLoadObserver::sharedIfExists()</span>
  {
<span class="udiff-line-modified-removed">-     auto url = document.url();</span>
<span class="udiff-line-removed">-     auto* frame = document.frame();</span>
<span class="udiff-line-removed">-     auto host = document.url().host();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     while ((host.isNull() || host.isEmpty()) &amp;&amp; frame &amp;&amp; !frame-&gt;isMainFrame()) {</span>
<span class="udiff-line-removed">-         auto* ownerElement = frame-&gt;ownerElement();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         ASSERT(ownerElement != nullptr);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         auto&amp; doc = ownerElement-&gt;document();</span>
<span class="udiff-line-removed">-         frame = doc.frame();</span>
<span class="udiff-line-removed">-         url = doc.url();</span>
<span class="udiff-line-removed">-         host = url.host();</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     return url;</span>
<span class="udiff-line-modified-added">+     return sharedObserver();</span>
  }
  
  } // namespace WebCore
</pre>
<center><a href="ResourceLoadNotifier.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="ResourceLoadObserver.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>