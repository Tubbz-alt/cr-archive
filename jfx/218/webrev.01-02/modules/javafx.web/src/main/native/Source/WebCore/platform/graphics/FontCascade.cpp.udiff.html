<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WebCore/platform/graphics/FontCascade.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="FontCache.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="FontCascade.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/platform/graphics/FontCascade.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -39,14 +39,10 @@</span>
  #include &lt;wtf/MathExtras.h&gt;
  #include &lt;wtf/NeverDestroyed.h&gt;
  #include &lt;wtf/text/AtomStringHash.h&gt;
  #include &lt;wtf/text/StringBuilder.h&gt;
  
<span class="udiff-line-removed">- #if PLATFORM(WIN)</span>
<span class="udiff-line-removed">- #include &quot;UniscribeController.h&quot;</span>
<span class="udiff-line-removed">- #endif</span>
<span class="udiff-line-removed">- </span>
  namespace WebCore {
  
  using namespace WTF::Unicode;
  
  static bool useBackslashAsYenSignForFamily(const AtomString&amp; family)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -267,37 +263,49 @@</span>
      if (fontCascadeCache().size() &gt; maximumEntries)
          fontCascadeCache().remove(fontCascadeCache().random());
      return glyphs;
  }
  
<span class="udiff-line-added">+ bool FontCascade::isCurrent(const FontSelector&amp; fontSelector) const</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     if (!m_fonts)</span>
<span class="udiff-line-added">+         return false;</span>
<span class="udiff-line-added">+     if (m_fonts-&gt;generation() != FontCache::singleton().generation())</span>
<span class="udiff-line-added">+         return false;</span>
<span class="udiff-line-added">+     if (m_fonts-&gt;fontSelectorVersion() != fontSelector.version())</span>
<span class="udiff-line-added">+         return false;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     return true;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  void FontCascade::update(RefPtr&lt;FontSelector&gt;&amp;&amp; fontSelector) const
  {
      m_fonts = retrieveOrAddCachedFonts(m_fontDescription, WTFMove(fontSelector));
      m_useBackslashAsYenSymbol = useBackslashAsYenSignForFamily(firstFamily());
      m_enableKerning = computeEnableKerning();
      m_requiresShaping = computeRequiresShaping();
  }
  
<span class="udiff-line-modified-removed">- float FontCascade::glyphBufferForTextRun(CodePath codePathToUse, const TextRun&amp; run, unsigned from, unsigned to, GlyphBuffer&amp; glyphBuffer) const</span>
<span class="udiff-line-modified-added">+ FloatSize FontCascade::glyphBufferForTextRun(CodePath codePathToUse, const TextRun&amp; run, unsigned from, unsigned to, GlyphBuffer&amp; glyphBuffer) const</span>
  {
      if (codePathToUse != Complex)
<span class="udiff-line-modified-removed">-         return getGlyphsAndAdvancesForSimpleText(run, from, to, glyphBuffer);</span>
<span class="udiff-line-modified-added">+         return { getGlyphsAndAdvancesForSimpleText(run, from, to, glyphBuffer), 0 };</span>
      return getGlyphsAndAdvancesForComplexText(run, from, to, glyphBuffer);
  }
  
  float FontCascade::drawText(GraphicsContext&amp; context, const TextRun&amp; run, const FloatPoint&amp; point, unsigned from, Optional&lt;unsigned&gt; to, CustomFontNotReadyAction customFontNotReadyAction) const
  {
      unsigned destination = to.valueOr(run.length());
      GlyphBuffer glyphBuffer;
<span class="udiff-line-modified-removed">-     float startX = point.x() + glyphBufferForTextRun(codePath(run, from, to), run, from, destination, glyphBuffer);</span>
<span class="udiff-line-modified-added">+     FloatPoint startPoint = point + glyphBufferForTextRun(codePath(run, from, to), run, from, destination, glyphBuffer);</span>
      // We couldn&#39;t generate any glyphs for the run. Give up.
      if (glyphBuffer.isEmpty())
          return 0;
      // Draw the glyph buffer now at the starting point returned in startX.
<span class="udiff-line-modified-removed">-     FloatPoint startPoint(startX, point.y());</span>
<span class="udiff-line-modified-added">+     float oldStartX = startPoint.x();</span>
      drawGlyphBuffer(context, glyphBuffer, startPoint, customFontNotReadyAction);
<span class="udiff-line-modified-removed">-     return startPoint.x() - startX;</span>
<span class="udiff-line-modified-added">+     return startPoint.x() - oldStartX;</span>
  }
  
  void FontCascade::drawEmphasisMarks(GraphicsContext&amp; context, const TextRun&amp; run, const AtomString&amp; mark, const FloatPoint&amp; point, unsigned from, Optional&lt;unsigned&gt; to) const
  {
      if (isLoadingCustomFonts())
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -319,21 +327,20 @@</span>
      CodePath codePathToUse = codePath(run);
      if (codePathToUse != Complex &amp;&amp; (enableKerning() || requiresShaping()) &amp;&amp; (from || destination != run.length()))
          codePathToUse = Complex;
  
      GlyphBuffer glyphBuffer;
<span class="udiff-line-modified-removed">-     float startX = glyphBufferForTextRun(codePathToUse, run, from, destination, glyphBuffer);</span>
<span class="udiff-line-modified-added">+     FloatPoint startPoint = toFloatPoint(glyphBufferForTextRun(codePathToUse, run, from, destination, glyphBuffer));</span>
      // We couldn&#39;t generate any glyphs for the run. Give up.
      if (glyphBuffer.isEmpty())
          return nullptr;
  
      std::unique_ptr&lt;DisplayList::DisplayList&gt; displayList = makeUnique&lt;DisplayList::DisplayList&gt;();
      GraphicsContext recordingContext([&amp;](GraphicsContext&amp; displayListContext) {
          return makeUnique&lt;DisplayList::Recorder&gt;(displayListContext, *displayList, context.state(), FloatRect(), AffineTransform());
      });
  
<span class="udiff-line-removed">-     FloatPoint startPoint(startX, 0);</span>
      drawGlyphBuffer(recordingContext, glyphBuffer, startPoint, customFontNotReadyAction);
      return displayList;
  }
  
  float FontCascade::widthOfTextRange(const TextRun&amp; run, unsigned from, unsigned to, HashSet&lt;const Font*&gt;* fallbackFonts, float* outWidthBeforeRange, float* outWidthAfterRange) const
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -348,27 +355,17 @@</span>
      float offsetAfterRange = 0;
      float totalWidth = 0;
  
      auto codePathToUse = codePath(run);
      if (codePathToUse == Complex) {
<span class="udiff-line-removed">- #if PLATFORM(WIN)</span>
<span class="udiff-line-removed">-         UniscribeController it(this, run);</span>
<span class="udiff-line-removed">-         it.advance(from);</span>
<span class="udiff-line-removed">-         offsetBeforeRange = it.runWidthSoFar();</span>
<span class="udiff-line-removed">-         it.advance(to);</span>
<span class="udiff-line-removed">-         offsetAfterRange = it.runWidthSoFar();</span>
<span class="udiff-line-removed">-         it.advance(to);</span>
<span class="udiff-line-removed">-         totalWidth = it.runWidthSoFar();</span>
<span class="udiff-line-removed">- #else</span>
          ComplexTextController complexIterator(*this, run, false, fallbackFonts);
          complexIterator.advance(from, nullptr, IncludePartialGlyphs, fallbackFonts);
          offsetBeforeRange = complexIterator.runWidthSoFar();
          complexIterator.advance(to, nullptr, IncludePartialGlyphs, fallbackFonts);
          offsetAfterRange = complexIterator.runWidthSoFar();
          complexIterator.advance(run.length(), nullptr, IncludePartialGlyphs, fallbackFonts);
          totalWidth = complexIterator.runWidthSoFar();
<span class="udiff-line-removed">- #endif</span>
      } else {
          WidthIterator simpleIterator(this, run, fallbackFonts);
          simpleIterator.advance(from, nullptr);
          offsetBeforeRange = simpleIterator.runWidthSoFar();
          simpleIterator.advance(to, nullptr);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -428,10 +425,11 @@</span>
      ASSERT(codePath(TextRun(text)) != FontCascade::Complex);
      float* cacheEntry = m_fonts-&gt;widthCache().add(text, std::numeric_limits&lt;float&gt;::quiet_NaN());
      if (cacheEntry &amp;&amp; !std::isnan(*cacheEntry))
          return *cacheEntry;
  
<span class="udiff-line-added">+     GlyphBuffer glyphBuffer;</span>
      Vector&lt;GlyphBufferGlyph, 16&gt; glyphs;
      Vector&lt;GlyphBufferAdvance, 16&gt; advances;
      bool hasKerningOrLigatures = enableKerning() || requiresShaping();
      float runWidth = 0;
      auto&amp; font = primaryFont();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -439,20 +437,19 @@</span>
          auto glyph = glyphDataForCharacter(text[i], false).glyph;
          auto glyphWidth = font.widthForGlyph(glyph);
          runWidth += glyphWidth;
          if (!hasKerningOrLigatures)
              continue;
<span class="udiff-line-modified-removed">-         glyphs.append(glyph);</span>
<span class="udiff-line-removed">-         advances.append(FloatSize(glyphWidth, 0));</span>
<span class="udiff-line-modified-added">+         glyphBuffer.add(glyph, &amp;font, glyphWidth);</span>
      }
      if (hasKerningOrLigatures) {
<span class="udiff-line-modified-removed">-         font.applyTransforms(&amp;glyphs[0], &amp;advances[0], glyphs.size(), enableKerning(), requiresShaping());</span>
<span class="udiff-line-modified-added">+         font.applyTransforms(glyphBuffer, 0, enableKerning(), requiresShaping(), fontDescription().locale());</span>
          // This is needed only to match the result of the slow path. Same glyph widths but different floating point arithmentics can
          // produce different run width.
          float runWidthDifferenceWithTransformApplied = -runWidth;
<span class="udiff-line-modified-removed">-         for (auto&amp; advance : advances)</span>
<span class="udiff-line-modified-removed">-             runWidthDifferenceWithTransformApplied += advance.width();</span>
<span class="udiff-line-modified-added">+         for (size_t i = 0; i &lt; glyphBuffer.size(); ++i)</span>
<span class="udiff-line-modified-added">+             runWidthDifferenceWithTransformApplied += glyphBuffer.advanceAt(i).width();</span>
          runWidth += runWidthDifferenceWithTransformApplied;
      }
  
      if (cacheEntry)
          *cacheEntry = runWidth;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1395,41 +1392,39 @@</span>
          glyphBuffer.reverse(0, glyphBuffer.size());
  
      return initialAdvance;
  }
  
<span class="udiff-line-modified-removed">- #if !PLATFORM(WIN)</span>
<span class="udiff-line-removed">- float FontCascade::getGlyphsAndAdvancesForComplexText(const TextRun&amp; run, unsigned from, unsigned to, GlyphBuffer&amp; glyphBuffer, ForTextEmphasisOrNot forTextEmphasis) const</span>
<span class="udiff-line-modified-added">+ FloatSize FontCascade::getGlyphsAndAdvancesForComplexText(const TextRun&amp; run, unsigned from, unsigned to, GlyphBuffer&amp; glyphBuffer, ForTextEmphasisOrNot forTextEmphasis) const</span>
  {
<span class="udiff-line-modified-removed">-     float initialAdvance;</span>
<span class="udiff-line-modified-added">+     FloatSize initialAdvance;</span>
  
      ComplexTextController controller(*this, run, false, 0, forTextEmphasis);
      GlyphBuffer dummyGlyphBuffer;
      controller.advance(from, &amp;dummyGlyphBuffer);
      controller.advance(to, &amp;glyphBuffer);
  
      if (glyphBuffer.isEmpty())
<span class="udiff-line-modified-removed">-         return 0;</span>
<span class="udiff-line-modified-added">+         return { };</span>
  
      if (run.rtl()) {
          // Exploit the fact that the sum of the paint advances is equal to
          // the sum of the layout advances.
<span class="udiff-line-modified-removed">-         initialAdvance = controller.totalWidth();</span>
<span class="udiff-line-modified-added">+         initialAdvance = controller.totalAdvance();</span>
          for (unsigned i = 0; i &lt; dummyGlyphBuffer.size(); ++i)
<span class="udiff-line-modified-removed">-             initialAdvance -= dummyGlyphBuffer.advanceAt(i).width();</span>
<span class="udiff-line-modified-added">+             initialAdvance -= toFloatSize(dummyGlyphBuffer.advanceAt(i));</span>
          for (unsigned i = 0; i &lt; glyphBuffer.size(); ++i)
<span class="udiff-line-modified-removed">-             initialAdvance -= glyphBuffer.advanceAt(i).width();</span>
<span class="udiff-line-modified-added">+             initialAdvance -= toFloatSize(glyphBuffer.advanceAt(i));</span>
          glyphBuffer.reverse(0, glyphBuffer.size());
      } else {
<span class="udiff-line-modified-removed">-         initialAdvance = dummyGlyphBuffer.initialAdvance().width();</span>
<span class="udiff-line-modified-added">+         initialAdvance = toFloatSize(dummyGlyphBuffer.initialAdvance());</span>
          for (unsigned i = 0; i &lt; dummyGlyphBuffer.size(); ++i)
<span class="udiff-line-modified-removed">-             initialAdvance += dummyGlyphBuffer.advanceAt(i).width();</span>
<span class="udiff-line-modified-added">+             initialAdvance += toFloatSize(dummyGlyphBuffer.advanceAt(i));</span>
      }
  
      return initialAdvance;
  }
<span class="udiff-line-removed">- #endif</span>
  
  void FontCascade::drawEmphasisMarksForSimpleText(GraphicsContext&amp; context, const TextRun&amp; run, const AtomString&amp; mark, const FloatPoint&amp; point, unsigned from, unsigned to) const
  {
      GlyphBuffer glyphBuffer;
      float initialAdvance = getGlyphsAndAdvancesForSimpleText(run, from, to, glyphBuffer, ForTextEmphasis);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1450,17 +1445,11 @@</span>
  
  void FontCascade::drawGlyphBuffer(GraphicsContext&amp; context, const GlyphBuffer&amp; glyphBuffer, FloatPoint&amp; point, CustomFontNotReadyAction customFontNotReadyAction) const
  {
      // Draw each contiguous run of glyphs that use the same font data.
      const Font* fontData = glyphBuffer.fontAt(0);
<span class="udiff-line-modified-removed">- #if PLATFORM(WIN)</span>
<span class="udiff-line-removed">-     FloatPoint startPoint(point.x() + glyphBuffer.initialAdvance().width(), point.y() + glyphBuffer.initialAdvance().height());</span>
<span class="udiff-line-removed">- #else</span>
<span class="udiff-line-removed">-     // FIXME: Why do we subtract the initial advance&#39;s height but not its width???</span>
<span class="udiff-line-removed">-     // We should use the line above from Windows instead.</span>
<span class="udiff-line-removed">-     FloatPoint startPoint(point.x(), point.y() - glyphBuffer.initialAdvance().height());</span>
<span class="udiff-line-removed">- #endif</span>
<span class="udiff-line-modified-added">+     FloatPoint startPoint = point;</span>
      float nextX = startPoint.x() + glyphBuffer.advanceAt(0).width();
      float nextY = startPoint.y() + glyphBuffer.advanceAt(0).height();
      unsigned lastFrom = 0;
      unsigned nextGlyph = 1;
      while (nextGlyph &lt; glyphBuffer.size()) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1543,23 +1532,21 @@</span>
      }
  
      return it.m_runWidthSoFar;
  }
  
<span class="udiff-line-removed">- #if !PLATFORM(WIN)</span>
  float FontCascade::floatWidthForComplexText(const TextRun&amp; run, HashSet&lt;const Font*&gt;* fallbackFonts, GlyphOverflow* glyphOverflow) const
  {
      ComplexTextController controller(*this, run, true, fallbackFonts);
      if (glyphOverflow) {
          glyphOverflow-&gt;top = std::max&lt;int&gt;(glyphOverflow-&gt;top, ceilf(-controller.minGlyphBoundingBoxY()) - (glyphOverflow-&gt;computeBounds ? 0 : fontMetrics().ascent()));
          glyphOverflow-&gt;bottom = std::max&lt;int&gt;(glyphOverflow-&gt;bottom, ceilf(controller.maxGlyphBoundingBoxY()) - (glyphOverflow-&gt;computeBounds ? 0 : fontMetrics().descent()));
          glyphOverflow-&gt;left = std::max&lt;int&gt;(0, ceilf(-controller.minGlyphBoundingBoxX()));
<span class="udiff-line-modified-removed">-         glyphOverflow-&gt;right = std::max&lt;int&gt;(0, ceilf(controller.maxGlyphBoundingBoxX() - controller.totalWidth()));</span>
<span class="udiff-line-modified-added">+         glyphOverflow-&gt;right = std::max&lt;int&gt;(0, ceilf(controller.maxGlyphBoundingBoxX() - controller.totalAdvance().width()));</span>
      }
<span class="udiff-line-modified-removed">-     return controller.totalWidth();</span>
<span class="udiff-line-modified-added">+     return controller.totalAdvance().width();</span>
  }
<span class="udiff-line-removed">- #endif</span>
  
  void FontCascade::adjustSelectionRectForSimpleText(const TextRun&amp; run, LayoutRect&amp; selectionRect, unsigned from, unsigned to) const
  {
      GlyphBuffer glyphBuffer;
      WidthIterator it(this, run);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1576,26 +1563,24 @@</span>
      } else
          selectionRect.move(beforeWidth, 0);
      selectionRect.setWidth(LayoutUnit::fromFloatCeil(afterWidth - beforeWidth));
  }
  
<span class="udiff-line-removed">- #if !PLATFORM(WIN)</span>
  void FontCascade::adjustSelectionRectForComplexText(const TextRun&amp; run, LayoutRect&amp; selectionRect, unsigned from, unsigned to) const
  {
      ComplexTextController controller(*this, run);
      controller.advance(from);
      float beforeWidth = controller.runWidthSoFar();
      controller.advance(to);
      float afterWidth = controller.runWidthSoFar();
  
      if (run.rtl())
<span class="udiff-line-modified-removed">-         selectionRect.move(controller.totalWidth() - afterWidth, 0);</span>
<span class="udiff-line-modified-added">+         selectionRect.move(controller.totalAdvance().width() - afterWidth, 0);</span>
      else
          selectionRect.move(beforeWidth, 0);
      selectionRect.setWidth(LayoutUnit::fromFloatCeil(afterWidth - beforeWidth));
  }
<span class="udiff-line-removed">- #endif</span>
  
  int FontCascade::offsetForPositionForSimpleText(const TextRun&amp; run, float x, bool includePartialGlyphs) const
  {
      float delta = x;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1636,17 +1621,15 @@</span>
      }
  
      return offset;
  }
  
<span class="udiff-line-removed">- #if !PLATFORM(WIN)</span>
  int FontCascade::offsetForPositionForComplexText(const TextRun&amp; run, float x, bool includePartialGlyphs) const
  {
      ComplexTextController controller(*this, run);
      return controller.offsetForPosition(x, includePartialGlyphs);
  }
<span class="udiff-line-removed">- #endif</span>
  
  #if !PLATFORM(COCOA) &amp;&amp; !USE(HARFBUZZ)
  // FIXME: Unify this with the macOS and iOS implementation.
  const Font* FontCascade::fontForCombiningCharacterSequence(const UChar* characters, size_t length) const
  {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1662,16 +1645,16 @@</span>
  #endif
  
  void FontCascade::drawEmphasisMarksForComplexText(GraphicsContext&amp; context, const TextRun&amp; run, const AtomString&amp; mark, const FloatPoint&amp; point, unsigned from, unsigned to) const
  {
      GlyphBuffer glyphBuffer;
<span class="udiff-line-modified-removed">-     float initialAdvance = getGlyphsAndAdvancesForComplexText(run, from, to, glyphBuffer, ForTextEmphasis);</span>
<span class="udiff-line-modified-added">+     auto initialAdvance = getGlyphsAndAdvancesForComplexText(run, from, to, glyphBuffer, ForTextEmphasis);</span>
  
      if (glyphBuffer.isEmpty())
          return;
  
<span class="udiff-line-modified-removed">-     drawEmphasisMarks(context, glyphBuffer, mark, FloatPoint(point.x() + initialAdvance, point.y()));</span>
<span class="udiff-line-modified-added">+     drawEmphasisMarks(context, glyphBuffer, mark, point + initialAdvance);</span>
  }
  
  struct GlyphIterationState {
      FloatPoint startingPoint;
      FloatPoint currentPoint;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1704,27 +1687,27 @@</span>
  static void findPathIntersections(GlyphIterationState&amp; state, const PathElement&amp; element)
  {
      bool doIntersection = false;
      FloatPoint point = FloatPoint();
      switch (element.type) {
<span class="udiff-line-modified-removed">-     case PathElementMoveToPoint:</span>
<span class="udiff-line-modified-added">+     case PathElement::Type::MoveToPoint:</span>
          state.startingPoint = element.points[0];
          state.currentPoint = element.points[0];
          break;
<span class="udiff-line-modified-removed">-     case PathElementAddLineToPoint:</span>
<span class="udiff-line-modified-added">+     case PathElement::Type::AddLineToPoint:</span>
          doIntersection = true;
          point = element.points[0];
          break;
<span class="udiff-line-modified-removed">-     case PathElementAddQuadCurveToPoint:</span>
<span class="udiff-line-modified-added">+     case PathElement::Type::AddQuadCurveToPoint:</span>
          doIntersection = true;
          point = element.points[1];
          break;
<span class="udiff-line-modified-removed">-     case PathElementAddCurveToPoint:</span>
<span class="udiff-line-modified-added">+     case PathElement::Type::AddCurveToPoint:</span>
          doIntersection = true;
          point = element.points[2];
          break;
<span class="udiff-line-modified-removed">-     case PathElementCloseSubpath:</span>
<span class="udiff-line-modified-added">+     case PathElement::Type::CloseSubpath:</span>
          doIntersection = true;
          point = state.startingPoint;
          break;
      }
      if (!doIntersection)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1805,11 +1788,11 @@</span>
      glyphBuffer.saveOffsetsInString();
      float deltaX;
      if (codePath(run) != FontCascade::Complex)
          deltaX = getGlyphsAndAdvancesForSimpleText(run, 0, run.length(), glyphBuffer);
      else
<span class="udiff-line-modified-removed">-         deltaX = getGlyphsAndAdvancesForComplexText(run, 0, run.length(), glyphBuffer);</span>
<span class="udiff-line-modified-added">+         deltaX = getGlyphsAndAdvancesForComplexText(run, 0, run.length(), glyphBuffer).width();</span>
  
      if (!glyphBuffer.size())
          return DashArray();
  
      FloatPoint origin = FloatPoint(textOrigin.x() + deltaX, textOrigin.y());
</pre>
<center><a href="FontCache.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="FontCascade.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>