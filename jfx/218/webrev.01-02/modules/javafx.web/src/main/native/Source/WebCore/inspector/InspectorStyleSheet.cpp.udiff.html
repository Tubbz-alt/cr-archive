<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WebCore/inspector/InspectorStyleSheet.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="InspectorShaderProgram.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="InspectorStyleSheet.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/inspector/InspectorStyleSheet.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -39,10 +39,11 @@</span>
  #include &quot;CSSStyleSheet.h&quot;
  #include &quot;CSSSupportsRule.h&quot;
  #include &quot;ContentSecurityPolicy.h&quot;
  #include &quot;Document.h&quot;
  #include &quot;Element.h&quot;
<span class="udiff-line-added">+ #include &quot;ExtensionStyleSheets.h&quot;</span>
  #include &quot;HTMLHeadElement.h&quot;
  #include &quot;HTMLNames.h&quot;
  #include &quot;HTMLParserIdioms.h&quot;
  #include &quot;HTMLStyleElement.h&quot;
  #include &quot;InspectorCSSAgent.h&quot;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -99,15 +100,15 @@</span>
  }
  
  static void flattenSourceData(RuleSourceDataList&amp; dataList, RuleSourceDataList&amp; target)
  {
      for (auto&amp; data : dataList) {
<span class="udiff-line-modified-removed">-         if (data-&gt;type == WebCore::StyleRule::Style)</span>
<span class="udiff-line-modified-added">+         if (data-&gt;type == WebCore::StyleRuleType::Style)</span>
              target.append(data.copyRef());
<span class="udiff-line-modified-removed">-         else if (data-&gt;type == WebCore::StyleRule::Media)</span>
<span class="udiff-line-modified-added">+         else if (data-&gt;type == WebCore::StyleRuleType::Media)</span>
              flattenSourceData(data-&gt;childRules, target);
<span class="udiff-line-modified-removed">-         else if (data-&gt;type == WebCore::StyleRule::Supports)</span>
<span class="udiff-line-modified-added">+         else if (data-&gt;type == WebCore::StyleRuleType::Supports)</span>
              flattenSourceData(data-&gt;childRules, target);
      }
  }
  
  void ParsedStyleSheet::setSourceData(std::unique_ptr&lt;RuleSourceDataList&gt; sourceData)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -152,11 +153,11 @@</span>
      {
          ASSERT(m_ruleSourceDataResult);
      }
  
  private:
<span class="udiff-line-modified-removed">-     void startRuleHeader(StyleRule::Type, unsigned) override;</span>
<span class="udiff-line-modified-added">+     void startRuleHeader(StyleRuleType, unsigned) override;</span>
      void endRuleHeader(unsigned) override;
      void observeSelector(unsigned startOffset, unsigned endOffset) override;
      void startRuleBody(unsigned) override;
      void endRuleBody(unsigned) override;
      void observeProperty(unsigned startOffset, unsigned endOffset, bool isImportant, bool isParsed) override;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -172,11 +173,11 @@</span>
      RuleSourceDataList m_currentRuleDataStack;
      RefPtr&lt;CSSRuleSourceData&gt; m_currentRuleData;
      RuleSourceDataList* m_ruleSourceDataResult { nullptr };
  };
  
<span class="udiff-line-modified-removed">- void StyleSheetHandler::startRuleHeader(StyleRule::Type type, unsigned offset)</span>
<span class="udiff-line-modified-added">+ void StyleSheetHandler::startRuleHeader(StyleRuleType type, unsigned offset)</span>
  {
      // Pop off data for a previous invalid rule.
      if (m_currentRuleData)
          m_currentRuleDataStack.removeLast();
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -539,22 +540,18 @@</span>
  }
  
  Ref&lt;JSON::ArrayOf&lt;Inspector::Protocol::CSS::CSSComputedStyleProperty&gt;&gt; InspectorStyle::buildArrayForComputedStyle() const
  {
      auto result = JSON::ArrayOf&lt;Inspector::Protocol::CSS::CSSComputedStyleProperty&gt;::create();
<span class="udiff-line-modified-removed">-     Vector&lt;InspectorStyleProperty&gt; properties;</span>
<span class="udiff-line-removed">-     populateAllProperties(&amp;properties);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     for (auto&amp; property : properties) {</span>
<span class="udiff-line-modified-added">+     for (auto&amp; property : collectProperties(true)) {</span>
          const CSSPropertySourceData&amp; propertyEntry = property.sourceData;
          auto entry = Inspector::Protocol::CSS::CSSComputedStyleProperty::create()
              .setName(propertyEntry.name)
              .setValue(propertyEntry.value)
              .release();
          result-&gt;addItem(WTFMove(entry));
      }
<span class="udiff-line-removed">- </span>
      return result;
  }
  
  ExceptionOr&lt;String&gt; InspectorStyle::text() const
  {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -577,12 +574,13 @@</span>
      if (name.startsWith(&quot;--&quot;))
          return name;
      return name.convertToASCIILowercase();
  }
  
<span class="udiff-line-modified-removed">- void InspectorStyle::populateAllProperties(Vector&lt;InspectorStyleProperty&gt;* result) const</span>
<span class="udiff-line-modified-added">+ Vector&lt;InspectorStyleProperty&gt; InspectorStyle::collectProperties(bool includeAll) const</span>
  {
<span class="udiff-line-added">+     Vector&lt;InspectorStyleProperty&gt; result;</span>
      HashSet&lt;String&gt; sourcePropertyNames;
  
      auto sourceData = extractSourceData();
      auto* sourcePropertyData = sourceData ? &amp;sourceData-&gt;styleSourceData-&gt;propertyData : nullptr;
      if (sourcePropertyData) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -590,26 +588,45 @@</span>
          ASSERT(!styleDeclarationOrException.hasException());
          String styleDeclaration = styleDeclarationOrException.hasException() ? emptyString() : styleDeclarationOrException.releaseReturnValue();
          for (auto&amp; sourceData : *sourcePropertyData) {
              InspectorStyleProperty p(sourceData, true, sourceData.disabled);
              p.setRawTextFromStyleDeclaration(styleDeclaration);
<span class="udiff-line-modified-removed">-             result-&gt;append(p);</span>
<span class="udiff-line-modified-added">+             result.append(p);</span>
              sourcePropertyNames.add(lowercasePropertyName(sourceData.name));
          }
      }
  
      for (int i = 0, size = m_style-&gt;length(); i &lt; size; ++i) {
          String name = m_style-&gt;item(i);
          if (sourcePropertyNames.add(lowercasePropertyName(name)))
<span class="udiff-line-modified-removed">-             result-&gt;append(InspectorStyleProperty(CSSPropertySourceData(name, m_style-&gt;getPropertyValue(name), !m_style-&gt;getPropertyPriority(name).isEmpty(), false, true, SourceRange()), false, false));</span>
<span class="udiff-line-modified-added">+             result.append(InspectorStyleProperty(CSSPropertySourceData(name, m_style-&gt;getPropertyValue(name), !m_style-&gt;getPropertyPriority(name).isEmpty(), false, true, SourceRange()), false, false));</span>
      }
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (includeAll) {</span>
<span class="udiff-line-added">+         for (auto i = firstCSSProperty; i &lt; lastCSSProperty; ++i) {</span>
<span class="udiff-line-added">+             auto id = convertToCSSPropertyID(i);</span>
<span class="udiff-line-added">+             if (isInternalCSSProperty(id) || !isEnabledCSSProperty(id))</span>
<span class="udiff-line-added">+                 continue;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             auto name = getPropertyNameString(id);</span>
<span class="udiff-line-added">+             if (!sourcePropertyNames.add(lowercasePropertyName(name)))</span>
<span class="udiff-line-added">+                 continue;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             auto value = m_style-&gt;getPropertyValue(name);</span>
<span class="udiff-line-added">+             if (value.isEmpty())</span>
<span class="udiff-line-added">+                 continue;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             result.append(InspectorStyleProperty(CSSPropertySourceData(name, value, !m_style-&gt;getPropertyPriority(name).isEmpty(), false, true, SourceRange()), false, false));</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     return result;</span>
  }
  
  Ref&lt;Inspector::Protocol::CSS::CSSStyle&gt; InspectorStyle::styleWithProperties() const
  {
<span class="udiff-line-modified-removed">-     Vector&lt;InspectorStyleProperty&gt; properties;</span>
<span class="udiff-line-removed">-     populateAllProperties(&amp;properties);</span>
<span class="udiff-line-modified-added">+     auto properties = collectProperties(false);</span>
  
      auto propertiesObject = JSON::ArrayOf&lt;Inspector::Protocol::CSS::CSSProperty&gt;::create();
      auto shorthandEntries = ArrayOf&lt;Inspector::Protocol::CSS::ShorthandEntry&gt;::create();
      HashMap&lt;String, RefPtr&lt;Inspector::Protocol::CSS::CSSProperty&gt;&gt; propertyNameToPreviousActiveProperty;
      HashSet&lt;String&gt; foundShorthands;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1149,12 +1166,11 @@</span>
          .setSourceLine(endingLine)
          .setOrigin(m_origin)
          .setStyle(buildObjectForStyle(&amp;rule-&gt;style()))
          .release();
  
<span class="udiff-line-modified-removed">-     // &quot;sourceURL&quot; is present only for regular rules, otherwise &quot;origin&quot; should be used in the frontend.</span>
<span class="udiff-line-removed">-     if (m_origin == Inspector::Protocol::CSS::StyleSheetOrigin::Regular)</span>
<span class="udiff-line-modified-added">+     if (m_origin == Inspector::Protocol::CSS::StyleSheetOrigin::Regular || m_origin == Inspector::Protocol::CSS::StyleSheetOrigin::User)</span>
          result-&gt;setSourceURL(finalURL());
  
      if (canBind()) {
          InspectorCSSId id(ruleId(rule));
          if (!id.isEmpty())
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1386,46 +1402,53 @@</span>
      return ruleOrStyleId(&amp;rule-&gt;style());
  }
  
  bool InspectorStyleSheet::originalStyleSheetText(String* result) const
  {
<span class="udiff-line-modified-removed">-     bool success = inlineStyleSheetText(result);</span>
<span class="udiff-line-modified-removed">-     if (!success)</span>
<span class="udiff-line-modified-removed">-         success = resourceStyleSheetText(result);</span>
<span class="udiff-line-removed">-     return success;</span>
<span class="udiff-line-modified-added">+     if (!m_pageStyleSheet || m_origin == Inspector::Protocol::CSS::StyleSheetOrigin::UserAgent)</span>
<span class="udiff-line-modified-added">+         return false;</span>
<span class="udiff-line-modified-added">+     return inlineStyleSheetText(result) || resourceStyleSheetText(result) || extensionStyleSheetText(result);</span>
  }
  
  bool InspectorStyleSheet::resourceStyleSheetText(String* result) const
  {
<span class="udiff-line-modified-removed">-     if (m_origin == Inspector::Protocol::CSS::StyleSheetOrigin::User || m_origin == Inspector::Protocol::CSS::StyleSheetOrigin::UserAgent)</span>
<span class="udiff-line-removed">-         return false;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     if (!m_pageStyleSheet || !ownerDocument() || !ownerDocument()-&gt;frame())</span>
<span class="udiff-line-modified-added">+     if (!ownerDocument() || !ownerDocument()-&gt;frame())</span>
          return false;
  
      String error;
      bool base64Encoded;
      InspectorPageAgent::resourceContent(error, ownerDocument()-&gt;frame(), URL({ }, m_pageStyleSheet-&gt;href()), result, &amp;base64Encoded);
      return error.isEmpty() &amp;&amp; !base64Encoded;
  }
  
  bool InspectorStyleSheet::inlineStyleSheetText(String* result) const
  {
<span class="udiff-line-modified-removed">-     if (!m_pageStyleSheet)</span>
<span class="udiff-line-removed">-         return false;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     Node* ownerNode = m_pageStyleSheet-&gt;ownerNode();</span>
<span class="udiff-line-modified-added">+     auto* ownerNode = m_pageStyleSheet-&gt;ownerNode();</span>
      if (!is&lt;Element&gt;(ownerNode))
          return false;
<span class="udiff-line-removed">-     Element&amp; ownerElement = downcast&lt;Element&gt;(*ownerNode);</span>
  
<span class="udiff-line-added">+     auto&amp; ownerElement = downcast&lt;Element&gt;(*ownerNode);</span>
      if (!is&lt;HTMLStyleElement&gt;(ownerElement) &amp;&amp; !is&lt;SVGStyleElement&gt;(ownerElement))
          return false;
<span class="udiff-line-added">+ </span>
      *result = ownerElement.textContent();
      return true;
  }
  
<span class="udiff-line-added">+ bool InspectorStyleSheet::extensionStyleSheetText(String* result) const</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     if (!ownerDocument())</span>
<span class="udiff-line-added">+         return false;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     auto content = ownerDocument()-&gt;extensionStyleSheets().contentForInjectedStyleSheet(m_pageStyleSheet);</span>
<span class="udiff-line-added">+     if (content.isEmpty())</span>
<span class="udiff-line-added">+         return false;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     *result = content;</span>
<span class="udiff-line-added">+     return true;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  Ref&lt;JSON::ArrayOf&lt;Inspector::Protocol::CSS::CSSRule&gt;&gt; InspectorStyleSheet::buildArrayForRuleList(CSSRuleList* ruleList)
  {
      auto result = JSON::ArrayOf&lt;Inspector::Protocol::CSS::CSSRule&gt;::create();
      if (!ruleList)
          return result;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1550,11 +1573,11 @@</span>
  }
  
  Ref&lt;CSSRuleSourceData&gt; InspectorStyleSheetForInlineStyle::ruleSourceData() const
  {
      if (m_styleText.isEmpty()) {
<span class="udiff-line-modified-removed">-         auto result = CSSRuleSourceData::create(StyleRule::Style);</span>
<span class="udiff-line-modified-added">+         auto result = CSSRuleSourceData::create(StyleRuleType::Style);</span>
          result-&gt;ruleBodyRange.start = 0;
          result-&gt;ruleBodyRange.end = 0;
          return result;
      }
  
</pre>
<center><a href="InspectorShaderProgram.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="InspectorStyleSheet.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>