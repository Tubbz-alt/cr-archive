<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WebCore/loader/ContentFilter.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../layout/tableformatting/TableGrid.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="ContentFilter.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/loader/ContentFilter.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -27,10 +27,11 @@</span>
  #include &quot;ContentFilter.h&quot;
  
  #if ENABLE(CONTENT_FILTERING)
  
  #include &quot;CachedRawResource.h&quot;
<span class="udiff-line-added">+ #include &quot;ContentFilterClient.h&quot;</span>
  #include &quot;ContentFilterUnblockHandler.h&quot;
  #include &quot;DocumentLoader.h&quot;
  #include &quot;Frame.h&quot;
  #include &quot;FrameLoadRequest.h&quot;
  #include &quot;FrameLoader.h&quot;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -52,40 +53,39 @@</span>
  namespace WebCore {
  
  Vector&lt;ContentFilter::Type&gt;&amp; ContentFilter::types()
  {
      static NeverDestroyed&lt;Vector&lt;ContentFilter::Type&gt;&gt; types {
<span class="udiff-line-modified-removed">-         Vector&lt;ContentFilter::Type&gt; {</span>
<span class="udiff-line-modified-added">+         Vector&lt;ContentFilter::Type&gt;::from(</span>
  #if HAVE(PARENTAL_CONTROLS)
              type&lt;ParentalControlsContentFilter&gt;(),
  #endif
  #if HAVE(NETWORK_EXTENSION)
              type&lt;NetworkExtensionContentFilter&gt;()
  #endif
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-added">+         )</span>
      };
      return types;
  }
  
<span class="udiff-line-modified-removed">- std::unique_ptr&lt;ContentFilter&gt; ContentFilter::create(DocumentLoader&amp; documentLoader)</span>
<span class="udiff-line-modified-added">+ std::unique_ptr&lt;ContentFilter&gt; ContentFilter::create(ContentFilterClient&amp; client)</span>
  {
      Container filters;
      for (auto&amp; type : types()) {
          auto filter = type.create();
<span class="udiff-line-removed">-         ASSERT(filter);</span>
          filters.append(WTFMove(filter));
      }
  
      if (filters.isEmpty())
          return nullptr;
  
<span class="udiff-line-modified-removed">-     return makeUnique&lt;ContentFilter&gt;(WTFMove(filters), documentLoader);</span>
<span class="udiff-line-modified-added">+     return makeUnique&lt;ContentFilter&gt;(WTFMove(filters), client);</span>
  }
  
<span class="udiff-line-modified-removed">- ContentFilter::ContentFilter(Container&amp;&amp; contentFilters, DocumentLoader&amp; documentLoader)</span>
<span class="udiff-line-modified-removed">-     : m_contentFilters { WTFMove(contentFilters) }</span>
<span class="udiff-line-modified-removed">-     , m_documentLoader { documentLoader }</span>
<span class="udiff-line-modified-added">+ ContentFilter::ContentFilter(Container&amp;&amp; contentFilters, ContentFilterClient&amp; client)</span>
<span class="udiff-line-modified-added">+     : m_contentFilters(WTFMove(contentFilters))</span>
<span class="udiff-line-modified-added">+     , m_client(client)</span>
  {
      LOG(ContentFiltering, &quot;Creating ContentFilter with %zu platform content filter(s).\n&quot;, m_contentFilters.size());
      ASSERT(!m_contentFilters.isEmpty());
  }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -94,11 +94,11 @@</span>
      LOG(ContentFiltering, &quot;Destroying ContentFilter.\n&quot;);
  }
  
  bool ContentFilter::continueAfterWillSendRequest(ResourceRequest&amp; request, const ResourceResponse&amp; redirectResponse)
  {
<span class="udiff-line-modified-removed">-     Ref&lt;DocumentLoader&gt; protectedDocumentLoader { m_documentLoader };</span>
<span class="udiff-line-modified-added">+     Ref&lt;ContentFilterClient&gt; protectedClient { m_client };</span>
  
      LOG(ContentFiltering, &quot;ContentFilter received request for &lt;%s&gt; with redirect response from &lt;%s&gt;.\n&quot;, request.url().string().ascii().data(), redirectResponse.url().string().ascii().data());
  #if !LOG_DISABLED
      ResourceRequest originalRequest { request };
  #endif
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -133,11 +133,11 @@</span>
      m_mainResource = nullptr;
  }
  
  bool ContentFilter::continueAfterResponseReceived(const ResourceResponse&amp; response)
  {
<span class="udiff-line-modified-removed">-     Ref&lt;DocumentLoader&gt; protectedDocumentLoader { m_documentLoader };</span>
<span class="udiff-line-modified-added">+     Ref&lt;ContentFilterClient&gt; protectedClient { m_client };</span>
  
      if (m_state == State::Filtering) {
          LOG(ContentFiltering, &quot;ContentFilter received response from &lt;%s&gt;.\n&quot;, response.url().string().ascii().data());
          forEachContentFilterUntilBlocked([&amp;response](PlatformContentFilter&amp; contentFilter) {
              contentFilter.responseReceived(response);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -147,11 +147,11 @@</span>
      return m_state != State::Blocked;
  }
  
  bool ContentFilter::continueAfterDataReceived(const char* data, int length)
  {
<span class="udiff-line-modified-removed">-     Ref&lt;DocumentLoader&gt; protectedDocumentLoader { m_documentLoader };</span>
<span class="udiff-line-modified-added">+     Ref&lt;ContentFilterClient&gt; protectedClient { m_client };</span>
  
      if (m_state == State::Filtering) {
          LOG(ContentFiltering, &quot;ContentFilter received %d bytes of data from &lt;%s&gt;.\n&quot;, length, m_mainResource-&gt;url().string().ascii().data());
          forEachContentFilterUntilBlocked([data, length](PlatformContentFilter&amp; contentFilter) {
              contentFilter.addData(data, length);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -166,11 +166,11 @@</span>
  }
  
  bool ContentFilter::continueAfterNotifyFinished(CachedResource&amp; resource)
  {
      ASSERT_UNUSED(resource, &amp;resource == m_mainResource);
<span class="udiff-line-modified-removed">-     Ref&lt;DocumentLoader&gt; protectedDocumentLoader { m_documentLoader };</span>
<span class="udiff-line-modified-added">+     Ref&lt;ContentFilterClient&gt; protectedClient { m_client };</span>
  
      if (m_mainResource-&gt;errorOccurred())
          return true;
  
      if (m_state == State::Filtering) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -199,15 +199,15 @@</span>
          if (!contentFilter-&gt;needsMoreData()) {
              ASSERT(!contentFilter-&gt;didBlockData());
              continue;
          }
  
<span class="udiff-line-modified-removed">-         function(*contentFilter);</span>
<span class="udiff-line-modified-added">+         function(contentFilter.get());</span>
  
          if (contentFilter-&gt;didBlockData()) {
              ASSERT(!m_blockingContentFilter);
<span class="udiff-line-modified-removed">-             m_blockingContentFilter = contentFilter.get();</span>
<span class="udiff-line-modified-added">+             m_blockingContentFilter = &amp;contentFilter;</span>
              didDecide(State::Blocked);
              return;
          } else if (contentFilter-&gt;needsMoreData())
              allFiltersAllowedLoad = false;
      }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -224,32 +224,20 @@</span>
      LOG(ContentFiltering, &quot;ContentFilter decided load should be %s for main resource at &lt;%s&gt;.\n&quot;, state == State::Allowed ? &quot;allowed&quot; : &quot;blocked&quot;, m_mainResource ? m_mainResource-&gt;url().string().ascii().data() : &quot;&quot;);
      m_state = state;
      if (m_state != State::Blocked)
          return;
  
<span class="udiff-line-modified-removed">-     ContentFilterUnblockHandler unblockHandler { m_blockingContentFilter-&gt;unblockHandler() };</span>
<span class="udiff-line-modified-removed">-     unblockHandler.setUnreachableURL(m_documentLoader.documentURL());</span>
<span class="udiff-line-removed">-     auto frame { m_documentLoader.frame() };</span>
<span class="udiff-line-removed">-     String unblockRequestDeniedScript { m_blockingContentFilter-&gt;unblockRequestDeniedScript() };</span>
<span class="udiff-line-removed">-     if (!unblockRequestDeniedScript.isEmpty() &amp;&amp; frame) {</span>
<span class="udiff-line-removed">-         unblockHandler.wrapWithDecisionHandler([scriptController = makeWeakPtr(frame-&gt;script()), script = unblockRequestDeniedScript.isolatedCopy()](bool unblocked) {</span>
<span class="udiff-line-removed">-             if (!unblocked &amp;&amp; scriptController)</span>
<span class="udiff-line-removed">-                 scriptController-&gt;executeScript(script);</span>
<span class="udiff-line-removed">-         });</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-     m_documentLoader.frameLoader()-&gt;client().contentFilterDidBlockLoad(WTFMove(unblockHandler));</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     m_blockedError = m_documentLoader.frameLoader()-&gt;blockedByContentFilterError(m_documentLoader.request());</span>
<span class="udiff-line-removed">-     m_documentLoader.cancelMainResourceLoad(m_blockedError);</span>
<span class="udiff-line-modified-added">+     m_blockedError = m_client.contentFilterDidBlock(m_blockingContentFilter-&gt;unblockHandler(), m_blockingContentFilter-&gt;unblockRequestDeniedScript());</span>
<span class="udiff-line-modified-added">+     m_client.cancelMainResourceLoadForContentFilter(m_blockedError);</span>
  }
  
  void ContentFilter::deliverResourceData(CachedResource&amp; resource)
  {
      ASSERT(m_state == State::Allowed);
      ASSERT(resource.dataBufferingPolicy() == DataBufferingPolicy::BufferData);
      if (auto* resourceBuffer = resource.resourceBuffer())
<span class="udiff-line-modified-removed">-         m_documentLoader.dataReceived(resource, resourceBuffer-&gt;data(), resourceBuffer-&gt;size());</span>
<span class="udiff-line-modified-added">+         m_client.dataReceivedThroughContentFilter(resourceBuffer-&gt;data(), resourceBuffer-&gt;size());</span>
  }
  
  static const URL&amp; blockedPageURL()
  {
      static const auto blockedPageURL = makeNeverDestroyed([] () -&gt; URL {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -292,11 +280,11 @@</span>
  
      RefPtr&lt;SharedBuffer&gt; replacementData { m_blockingContentFilter-&gt;replacementData() };
      ResourceResponse response { URL(), &quot;text/html&quot;_s, static_cast&lt;long long&gt;(replacementData-&gt;size()), &quot;UTF-8&quot;_s };
      SubstituteData substituteData { WTFMove(replacementData), error.failingURL(), response, SubstituteData::SessionHistoryVisibility::Hidden };
      SetForScope&lt;bool&gt; loadingBlockedPage { m_isLoadingBlockedPage, true };
<span class="udiff-line-modified-removed">-     m_documentLoader.frameLoader()-&gt;load(FrameLoadRequest(*m_documentLoader.frame(), blockedPageURL(), ShouldOpenExternalURLsPolicy::ShouldNotAllow, substituteData));</span>
<span class="udiff-line-modified-added">+     m_client.handleProvisionalLoadFailureFromContentFilter(blockedPageURL(), substituteData);</span>
  }
  
  } // namespace WebCore
  
  #endif // ENABLE(CONTENT_FILTERING)
</pre>
<center><a href="../layout/tableformatting/TableGrid.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="ContentFilter.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>