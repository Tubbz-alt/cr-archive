<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.web/src/main/native/Source/WebCore/Modules/indexeddb/server/SQLiteIDBBackingStore.h</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="SQLiteIDBBackingStore.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="SQLiteIDBCursor.cpp.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/Modules/indexeddb/server/SQLiteIDBBackingStore.h</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 31,27 ***</span>
  #include &quot;IDBDatabaseIdentifier.h&quot;
  #include &quot;IDBDatabaseInfo.h&quot;
  #include &quot;IDBResourceIdentifier.h&quot;
  #include &quot;SQLiteIDBTransaction.h&quot;
  #include &lt;JavaScriptCore/Strong.h&gt;
  #include &lt;wtf/HashMap.h&gt;
  
  namespace WebCore {
  
  class IndexKey;
  class SQLiteDatabase;
  class SQLiteStatement;
  
  namespace IDBServer {
  
  class IDBSerializationContext;
  class SQLiteIDBCursor;
  
  class SQLiteIDBBackingStore : public IDBBackingStore {
      WTF_MAKE_FAST_ALLOCATED;
  public:
<span class="line-modified">!     SQLiteIDBBackingStore(PAL::SessionID, const IDBDatabaseIdentifier&amp;, const String&amp; databaseRootDirectory, IDBBackingStoreTemporaryFileHandler&amp;);</span>
  
      ~SQLiteIDBBackingStore() final;
  
      IDBError getOrEstablishDatabaseInfo(IDBDatabaseInfo&amp;) final;
  
<span class="line-new-header">--- 31,30 ---</span>
  #include &quot;IDBDatabaseIdentifier.h&quot;
  #include &quot;IDBDatabaseInfo.h&quot;
  #include &quot;IDBResourceIdentifier.h&quot;
  #include &quot;SQLiteIDBTransaction.h&quot;
  #include &lt;JavaScriptCore/Strong.h&gt;
<span class="line-added">+ #include &lt;pal/SessionID.h&gt;</span>
  #include &lt;wtf/HashMap.h&gt;
  
  namespace WebCore {
  
  class IndexKey;
  class SQLiteDatabase;
  class SQLiteStatement;
  
  namespace IDBServer {
  
<span class="line-added">+ enum class IsSchemaUpgraded : bool { No, Yes };</span>
<span class="line-added">+ </span>
  class IDBSerializationContext;
  class SQLiteIDBCursor;
  
  class SQLiteIDBBackingStore : public IDBBackingStore {
      WTF_MAKE_FAST_ALLOCATED;
  public:
<span class="line-modified">!     SQLiteIDBBackingStore(PAL::SessionID, const IDBDatabaseIdentifier&amp;, const String&amp; databaseRootDirectory);</span>
  
      ~SQLiteIDBBackingStore() final;
  
      IDBError getOrEstablishDatabaseInfo(IDBDatabaseInfo&amp;) final;
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 75,33 ***</span>
      IDBError generateKeyNumber(const IDBResourceIdentifier&amp; transactionIdentifier, uint64_t objectStoreIdentifier, uint64_t&amp; keyNumber) final;
      IDBError revertGeneratedKeyNumber(const IDBResourceIdentifier&amp; transactionIdentifier, uint64_t objectStoreIdentifier, uint64_t keyNumber) final;
      IDBError maybeUpdateKeyGeneratorNumber(const IDBResourceIdentifier&amp; transactionIdentifier, uint64_t objectStoreIdentifier, double newKeyNumber) final;
      IDBError openCursor(const IDBResourceIdentifier&amp; transactionIdentifier, const IDBCursorInfo&amp;, IDBGetResult&amp; outResult) final;
      IDBError iterateCursor(const IDBResourceIdentifier&amp; transactionIdentifier, const IDBResourceIdentifier&amp; cursorIdentifier, const IDBIterateCursorData&amp;, IDBGetResult&amp; outResult) final;
<span class="line-removed">-     bool prefetchCursor(const IDBResourceIdentifier&amp;, const IDBResourceIdentifier&amp;) final;</span>
  
      IDBObjectStoreInfo* infoForObjectStore(uint64_t objectStoreIdentifier) final;
      void deleteBackingStore() final;
  
      bool supportsSimultaneousTransactions() final { return false; }
      bool isEphemeral() final { return false; }
  
<span class="line-modified">!     void unregisterCursor(SQLiteIDBCursor&amp;);</span>
  
<span class="line-modified">!     IDBBackingStoreTemporaryFileHandler&amp; temporaryFileHandler() const { return m_temporaryFileHandler; }</span>
  
      IDBError getBlobRecordsForObjectStoreRecord(int64_t objectStoreRecord, Vector&lt;String&gt;&amp; blobURLs, Vector&lt;String&gt;&amp; blobFilePaths);
  
      static String databaseNameFromEncodedFilename(const String&amp;);
      static uint64_t databasesSizeForDirectory(const String&amp; directory);
  
      String databaseDirectory() const { return m_databaseDirectory; };
      static String fullDatabasePathForDirectory(const String&amp;);
      static String databaseNameFromFile(const String&amp;);
  
<span class="line-removed">-     bool hasTransaction(const IDBResourceIdentifier&amp;) const final;</span>
<span class="line-removed">- </span>
      PAL::SessionID sessionID() const { return m_sessionID; }
  
  private:
      String filenameForDatabaseName() const;
      String fullDatabasePath() const;
<span class="line-new-header">--- 78,30 ---</span>
      IDBError generateKeyNumber(const IDBResourceIdentifier&amp; transactionIdentifier, uint64_t objectStoreIdentifier, uint64_t&amp; keyNumber) final;
      IDBError revertGeneratedKeyNumber(const IDBResourceIdentifier&amp; transactionIdentifier, uint64_t objectStoreIdentifier, uint64_t keyNumber) final;
      IDBError maybeUpdateKeyGeneratorNumber(const IDBResourceIdentifier&amp; transactionIdentifier, uint64_t objectStoreIdentifier, double newKeyNumber) final;
      IDBError openCursor(const IDBResourceIdentifier&amp; transactionIdentifier, const IDBCursorInfo&amp;, IDBGetResult&amp; outResult) final;
      IDBError iterateCursor(const IDBResourceIdentifier&amp; transactionIdentifier, const IDBResourceIdentifier&amp; cursorIdentifier, const IDBIterateCursorData&amp;, IDBGetResult&amp; outResult) final;
  
      IDBObjectStoreInfo* infoForObjectStore(uint64_t objectStoreIdentifier) final;
      void deleteBackingStore() final;
  
      bool supportsSimultaneousTransactions() final { return false; }
      bool isEphemeral() final { return false; }
  
<span class="line-modified">!     bool hasTransaction(const IDBResourceIdentifier&amp;) const final;</span>
  
<span class="line-modified">!     void unregisterCursor(SQLiteIDBCursor&amp;);</span>
  
      IDBError getBlobRecordsForObjectStoreRecord(int64_t objectStoreRecord, Vector&lt;String&gt;&amp; blobURLs, Vector&lt;String&gt;&amp; blobFilePaths);
  
      static String databaseNameFromEncodedFilename(const String&amp;);
      static uint64_t databasesSizeForDirectory(const String&amp; directory);
  
      String databaseDirectory() const { return m_databaseDirectory; };
      static String fullDatabasePathForDirectory(const String&amp;);
      static String databaseNameFromFile(const String&amp;);
  
      PAL::SessionID sessionID() const { return m_sessionID; }
  
  private:
      String filenameForDatabaseName() const;
      String fullDatabasePath() const;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 110,11 ***</span>
<span class="line-new-header">--- 110,13 ---</span>
      String databaseRootDirectoryIsolatedCopy() const { return m_databaseRootDirectory.isolatedCopy(); }
  
      bool ensureValidRecordsTable();
      bool ensureValidIndexRecordsTable();
      bool ensureValidIndexRecordsIndex();
<span class="line-added">+     bool ensureValidIndexRecordsRecordIndex();</span>
      bool ensureValidBlobTables();
<span class="line-added">+     Optional&lt;IsSchemaUpgraded&gt; ensureValidObjectStoreInfoTable();</span>
      std::unique_ptr&lt;IDBDatabaseInfo&gt; createAndPopulateInitialDatabaseInfo();
      std::unique_ptr&lt;IDBDatabaseInfo&gt; extractExistingDatabaseInfo();
  
      IDBError deleteRecord(SQLiteIDBTransaction&amp;, int64_t objectStoreID, const IDBKeyData&amp;);
      IDBError uncheckedGetKeyGeneratorValue(int64_t objectStoreID, uint64_t&amp; outValue);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 133,12 ***</span>
      IDBError getAllIndexRecords(const IDBResourceIdentifier&amp; transactionIdentifier, const IDBGetAllRecordsData&amp;, IDBGetAllResult&amp; outValue);
  
      void closeSQLiteDB();
      void close() final;
  
<span class="line-removed">-     uint64_t databaseSize() const final;</span>
<span class="line-removed">- </span>
      enum class SQL : size_t {
          CreateObjectStoreInfo,
          CreateObjectStoreKeyGenerator,
          DeleteObjectStoreInfo,
          DeleteObjectStoreKeyGenerator,
<span class="line-new-header">--- 135,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 157,11 ***</span>
          DeleteIndexRecords,
          RenameIndex,
          KeyExistsInObjectStore,
          GetUnusedBlobFilenames,
          DeleteUnusedBlobs,
<span class="line-modified">!         GetObjectStoreRecordID,</span>
          DeleteBlobRecord,
          DeleteObjectStoreRecord,
          DeleteObjectStoreIndexRecord,
          AddObjectStoreRecord,
          AddBlobRecord,
<span class="line-new-header">--- 157,11 ---</span>
          DeleteIndexRecords,
          RenameIndex,
          KeyExistsInObjectStore,
          GetUnusedBlobFilenames,
          DeleteUnusedBlobs,
<span class="line-modified">!         GetObjectStoreRecord,</span>
          DeleteBlobRecord,
          DeleteObjectStoreRecord,
          DeleteObjectStoreIndexRecord,
          AddObjectStoreRecord,
          AddBlobRecord,
</pre>
<hr />
<pre>
<span class="line-old-header">*** 180,17 ***</span>
          GetValueRecordsLowerClosedUpperClosed,
          GetKeyRecordsLowerOpenUpperOpen,
          GetKeyRecordsLowerOpenUpperClosed,
          GetKeyRecordsLowerClosedUpperOpen,
          GetKeyRecordsLowerClosedUpperClosed,
<span class="line-modified">!         Count</span>
      };
  
      SQLiteStatement* cachedStatement(SQL, const char*);
      SQLiteStatement* cachedStatementForGetAllObjectStoreRecords(const IDBGetAllRecordsData&amp;);
  
<span class="line-modified">!     std::unique_ptr&lt;SQLiteStatement&gt; m_cachedStatements[static_cast&lt;int&gt;(SQL::Count)];</span>
  
      PAL::SessionID m_sessionID;
      IDBDatabaseIdentifier m_identifier;
      std::unique_ptr&lt;IDBDatabaseInfo&gt; m_databaseInfo;
      std::unique_ptr&lt;IDBDatabaseInfo&gt; m_originalDatabaseInfoBeforeVersionChange;
<span class="line-new-header">--- 180,25 ---</span>
          GetValueRecordsLowerClosedUpperClosed,
          GetKeyRecordsLowerOpenUpperOpen,
          GetKeyRecordsLowerOpenUpperClosed,
          GetKeyRecordsLowerClosedUpperOpen,
          GetKeyRecordsLowerClosedUpperClosed,
<span class="line-modified">!         CountRecordsLowerOpenUpperOpen,</span>
<span class="line-added">+         CountRecordsLowerOpenUpperClosed,</span>
<span class="line-added">+         CountRecordsLowerClosedUpperOpen,</span>
<span class="line-added">+         CountRecordsLowerClosedUpperClosed,</span>
<span class="line-added">+         CountIndexRecordsLowerOpenUpperOpen,</span>
<span class="line-added">+         CountIndexRecordsLowerOpenUpperClosed,</span>
<span class="line-added">+         CountIndexRecordsLowerClosedUpperOpen,</span>
<span class="line-added">+         CountIndexRecordsLowerClosedUpperClosed,</span>
<span class="line-added">+         Invalid,</span>
      };
  
      SQLiteStatement* cachedStatement(SQL, const char*);
      SQLiteStatement* cachedStatementForGetAllObjectStoreRecords(const IDBGetAllRecordsData&amp;);
  
<span class="line-modified">!     std::unique_ptr&lt;SQLiteStatement&gt; m_cachedStatements[static_cast&lt;int&gt;(SQL::Invalid)];</span>
  
      PAL::SessionID m_sessionID;
      IDBDatabaseIdentifier m_identifier;
      std::unique_ptr&lt;IDBDatabaseInfo&gt; m_databaseInfo;
      std::unique_ptr&lt;IDBDatabaseInfo&gt; m_originalDatabaseInfoBeforeVersionChange;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 201,12 ***</span>
      HashMap&lt;IDBResourceIdentifier, SQLiteIDBCursor*&gt; m_cursors;
  
      String m_databaseRootDirectory;
      String m_databaseDirectory;
  
<span class="line-removed">-     IDBBackingStoreTemporaryFileHandler&amp; m_temporaryFileHandler;</span>
<span class="line-removed">- </span>
      Ref&lt;IDBSerializationContext&gt; m_serializationContext;
  };
  
  } // namespace IDBServer
  } // namespace WebCore
<span class="line-new-header">--- 209,10 ---</span>
</pre>
<center><a href="SQLiteIDBBackingStore.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="SQLiteIDBCursor.cpp.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>