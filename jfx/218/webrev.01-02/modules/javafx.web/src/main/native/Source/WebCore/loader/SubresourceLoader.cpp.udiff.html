<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WebCore/loader/SubresourceLoader.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="SubresourceIntegrity.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="SubresourceLoader.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/loader/SubresourceLoader.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -62,12 +62,12 @@</span>
  #if ENABLE(CONTENT_EXTENSIONS)
  #include &quot;ResourceLoadInfo.h&quot;
  #endif
  
  #if USE(QUICK_LOOK)
<span class="udiff-line-added">+ #include &quot;LegacyPreviewLoader.h&quot;</span>
  #include &quot;PreviewConverter.h&quot;
<span class="udiff-line-removed">- #include &quot;PreviewLoader.h&quot;</span>
  #endif
  
  #undef RELEASE_LOG_IF_ALLOWED
  #undef RELEASE_LOG_ERROR_IF_ALLOWED
  #define RELEASE_LOG_IF_ALLOWED(fmt, ...) RELEASE_LOG_IF(isAlwaysOnLoggingAllowed(), ResourceLoading, &quot;%p - SubresourceLoader::&quot; fmt, this, ##__VA_ARGS__)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -193,11 +193,12 @@</span>
          return completionHandler(WTFMove(newRequest));
      }
  
      if (newRequest.requester() != ResourceRequestBase::Requester::Main) {
          tracePoint(SubresourceLoadWillStart);
<span class="udiff-line-modified-removed">-         ResourceLoadObserver::shared().logSubresourceLoading(m_frame.get(), newRequest, redirectResponse);</span>
<span class="udiff-line-modified-added">+         ResourceLoadObserver::shared().logSubresourceLoading(m_frame.get(), newRequest, redirectResponse,</span>
<span class="udiff-line-added">+             (isScriptLikeDestination(options().destination) ? ResourceLoadObserver::FetchDestinationIsScriptLike::Yes : ResourceLoadObserver::FetchDestinationIsScriptLike::No));</span>
      }
  
      auto continueWillSendRequest = [this, protectedThis = makeRef(*this), redirectResponse] (CompletionHandler&lt;void(ResourceRequest&amp;&amp;)&gt;&amp;&amp; completionHandler, ResourceRequest&amp;&amp; newRequest) mutable {
          if (newRequest.isNull() || reachedTerminalState())
              return completionHandler(WTFMove(newRequest));
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -236,11 +237,11 @@</span>
              opaqueRedirectedResponse.setType(ResourceResponse::Type::Opaqueredirect);
              opaqueRedirectedResponse.setTainting(ResourceResponse::Tainting::Opaqueredirect);
              m_resource-&gt;responseReceived(opaqueRedirectedResponse);
              if (reachedTerminalState()) {
                  RELEASE_LOG_IF_ALLOWED(&quot;willSendRequestinternal: reached terminal state (frame = %p, frameLoader = %p, resourceID = %lu)&quot;, frame(), frameLoader(), identifier());
<span class="udiff-line-modified-removed">-                 return;</span>
<span class="udiff-line-modified-added">+                 return completionHandler(WTFMove(newRequest));</span>
              }
  
              RELEASE_LOG_IF_ALLOWED(&quot;willSendRequestinternal: resource load completed (frame = %p, frameLoader = %p, resourceID = %lu)&quot;, frame(), frameLoader(), identifier());
  
              NetworkLoadMetrics emptyMetrics;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -312,22 +313,37 @@</span>
          return false;
  
      return PreviewConverter::supportsMIMEType(response.mimeType());
  }
  
<span class="udiff-line-added">+ void SubresourceLoader::didReceivePreviewResponse(const ResourceResponse&amp; response)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     ASSERT(m_state == Initialized);</span>
<span class="udiff-line-added">+     ASSERT(!response.isNull());</span>
<span class="udiff-line-added">+     ASSERT(m_resource);</span>
<span class="udiff-line-added">+     m_resource-&gt;previewResponseReceived(response);</span>
<span class="udiff-line-added">+     ResourceLoader::didReceivePreviewResponse(response);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  #endif
  
<span class="udiff-line-added">+ static bool isLocationURLFailure(const ResourceResponse&amp; response)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     auto locationString = response.httpHeaderField(HTTPHeaderName::Location);</span>
<span class="udiff-line-added">+     return !locationString.isNull() &amp;&amp; locationString.isEmpty();</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  void SubresourceLoader::didReceiveResponse(const ResourceResponse&amp; response, CompletionHandler&lt;void()&gt;&amp;&amp; policyCompletionHandler)
  {
      ASSERT(!response.isNull());
      ASSERT(m_state == Initialized);
  
      CompletionHandlerCallingScope completionHandlerCaller(WTFMove(policyCompletionHandler));
  
  #if USE(QUICK_LOOK)
      if (shouldCreatePreviewLoaderForResponse(response)) {
<span class="udiff-line-modified-removed">-         m_previewLoader = PreviewLoader::create(*this, response);</span>
<span class="udiff-line-modified-added">+         m_previewLoader = makeUnique&lt;LegacyPreviewLoader&gt;(*this, response);</span>
          if (m_previewLoader-&gt;didReceiveResponse(response))
              return;
      }
  #endif
  #if ENABLE(SERVICE_WORKER)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -340,10 +356,16 @@</span>
              return;
          }
      }
  #endif
  
<span class="udiff-line-added">+     if (auto error = validateRangeRequestedFlag(request(), response)) {</span>
<span class="udiff-line-added">+         RELEASE_LOG_IF_ALLOWED(&quot;didReceiveResponse: canceling load because receiving a range requested response for a non-range request (frame = %p, frameLoader = %p, resourceID = %lu)&quot;, frame(), frameLoader(), identifier());</span>
<span class="udiff-line-added">+         cancel(WTFMove(*error));</span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      // We want redirect responses to be processed through willSendRequestInternal. Exceptions are
      // redirection with no Location headers and fetch in manual redirect mode. Or in rare circumstances,
      // cases of too many redirects from CFNetwork (&lt;rdar://problem/30610988&gt;).
  #if !PLATFORM(COCOA)
      ASSERT(response.httpStatusCode() &lt; 300 || response.httpStatusCode() &gt;= 400 || response.httpStatusCode() == 304 || !response.httpHeaderField(HTTPHeaderName::Location) || response.type() == ResourceResponse::Type::Opaqueredirect);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -383,10 +405,26 @@</span>
          RELEASE_LOG_IF_ALLOWED(&quot;didReceiveResponse: canceling load because of cross origin access control (frame = %p, frameLoader = %p, resourceID = %lu)&quot;, frame(), frameLoader(), identifier());
          cancel(ResourceError(String(), 0, request().url(), errorDescription, ResourceError::Type::AccessControl));
          return;
      }
  
<span class="udiff-line-added">+     if (response.isRedirection()) {</span>
<span class="udiff-line-added">+         if (options().redirect == FetchOptions::Redirect::Follow &amp;&amp; isLocationURLFailure(response)) {</span>
<span class="udiff-line-added">+             // Implementing https://fetch.spec.whatwg.org/#concept-http-redirect-fetch step 3</span>
<span class="udiff-line-added">+             cancel();</span>
<span class="udiff-line-added">+             return;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         if (options().redirect == FetchOptions::Redirect::Manual) {</span>
<span class="udiff-line-added">+             ResourceResponse opaqueRedirectedResponse = response;</span>
<span class="udiff-line-added">+             opaqueRedirectedResponse.setType(ResourceResponse::Type::Opaqueredirect);</span>
<span class="udiff-line-added">+             opaqueRedirectedResponse.setTainting(ResourceResponse::Tainting::Opaqueredirect);</span>
<span class="udiff-line-added">+             m_resource-&gt;responseReceived(opaqueRedirectedResponse);</span>
<span class="udiff-line-added">+             if (!reachedTerminalState())</span>
<span class="udiff-line-added">+                 ResourceLoader::didReceiveResponse(opaqueRedirectedResponse, [completionHandlerCaller = WTFMove(completionHandlerCaller)] { });</span>
<span class="udiff-line-added">+             return;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
      m_resource-&gt;responseReceived(response);
      if (reachedTerminalState())
          return;
  
      bool isResponseMultipart = response.isMultipart();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -574,13 +612,15 @@</span>
  
      ASSERT(options().mode != FetchOptions::Mode::SameOrigin || !m_resource-&gt;isCrossOrigin());
  
      // Implementing https://fetch.spec.whatwg.org/#concept-http-redirect-fetch step 7 &amp; 8.
      if (options().mode == FetchOptions::Mode::Cors) {
<span class="udiff-line-modified-removed">-         if (m_resource-&gt;isCrossOrigin() &amp;&amp; !isValidCrossOriginRedirectionURL(newRequest.url())) {</span>
<span class="udiff-line-modified-removed">-             errorMessage = &quot;URL is either a non-HTTP URL or contains credentials.&quot;_s;</span>
<span class="udiff-line-modified-removed">-             return false;</span>
<span class="udiff-line-modified-added">+         if (m_resource-&gt;isCrossOrigin()) {</span>
<span class="udiff-line-modified-added">+             auto locationString = redirectResponse.httpHeaderField(HTTPHeaderName::Location);</span>
<span class="udiff-line-modified-added">+             errorMessage = validateCrossOriginRedirectionURL(URL(redirectResponse.url(), locationString));</span>
<span class="udiff-line-added">+             if (!errorMessage.isNull())</span>
<span class="udiff-line-added">+                 return false;</span>
          }
  
          ASSERT(m_origin);
          if (crossOriginFlag &amp;&amp; !passesAccessControlCheck(redirectResponse, options().storedCredentialsPolicy, *m_origin, errorMessage))
              return false;
</pre>
<center><a href="SubresourceIntegrity.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="SubresourceLoader.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>