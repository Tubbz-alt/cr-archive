<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WebCore/Modules/indexeddb/client/IDBConnectionToServer.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="IDBConnectionProxy.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="IDBConnectionToServer.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/Modules/indexeddb/client/IDBConnectionToServer.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 37 #include &quot;IDBResultData.h&quot;
 38 #include &quot;Logging.h&quot;
 39 #include &quot;SecurityOrigin.h&quot;
 40 #include &quot;TransactionOperation.h&quot;
 41 #include &lt;wtf/MainThread.h&gt;
 42 
 43 namespace WebCore {
 44 namespace IDBClient {
 45 
 46 Ref&lt;IDBConnectionToServer&gt; IDBConnectionToServer::create(IDBConnectionToServerDelegate&amp; delegate)
 47 {
 48     return adoptRef(*new IDBConnectionToServer(delegate));
 49 }
 50 
 51 IDBConnectionToServer::IDBConnectionToServer(IDBConnectionToServerDelegate&amp; delegate)
 52     : m_delegate(makeWeakPtr(delegate))
 53     , m_proxy(makeUnique&lt;IDBConnectionProxy&gt;(*this))
 54 {
 55 }
 56 
<span class="line-modified"> 57 uint64_t IDBConnectionToServer::identifier() const</span>
 58 {
 59     return m_delegate-&gt;identifier();
 60 }
 61 
 62 IDBConnectionProxy&amp; IDBConnectionToServer::proxy()
 63 {
 64     ASSERT(m_proxy);
 65     return *m_proxy;
 66 }
 67 
 68 void IDBConnectionToServer::callResultFunctionWithErrorLater(ResultFunction function, const IDBResourceIdentifier&amp; requestIdentifier)
 69 {
 70     callOnMainThread([this, protectedThis = makeRef(*this), function, requestIdentifier]() {
 71         (this-&gt;*function)(IDBResultData::error(requestIdentifier, IDBError::serverConnectionLostError()));
 72     });
 73 }
 74 
 75 void IDBConnectionToServer::deleteDatabase(const IDBRequestData&amp; request)
 76 {
<span class="line-modified"> 77     LOG(IndexedDB, &quot;IDBConnectionToServer::deleteDatabase - %s&quot;, request.databaseIdentifier().debugString().utf8().data());</span>
 78 
 79     if (m_serverConnectionIsValid)
 80         m_delegate-&gt;deleteDatabase(request);
 81     else
 82         callResultFunctionWithErrorLater(&amp;IDBConnectionToServer::didDeleteDatabase, request.requestIdentifier());
 83 }
 84 
 85 void IDBConnectionToServer::didDeleteDatabase(const IDBResultData&amp; resultData)
 86 {
 87     LOG(IndexedDB, &quot;IDBConnectionToServer::didDeleteDatabase&quot;);
 88     m_proxy-&gt;didDeleteDatabase(resultData);
 89 }
 90 
 91 void IDBConnectionToServer::openDatabase(const IDBRequestData&amp; request)
 92 {
<span class="line-modified"> 93     LOG(IndexedDB, &quot;IDBConnectionToServer::openDatabase - %s (%s) (%&quot; PRIu64 &quot;)&quot;, request.databaseIdentifier().debugString().utf8().data(), request.requestIdentifier().loggingString().utf8().data(), request.requestedVersion());</span>
 94 
 95     if (m_serverConnectionIsValid)
 96         m_delegate-&gt;openDatabase(request);
 97     else
 98         callResultFunctionWithErrorLater(&amp;IDBConnectionToServer::didOpenDatabase, request.requestIdentifier());
 99 }
100 
101 void IDBConnectionToServer::didOpenDatabase(const IDBResultData&amp; resultData)
102 {
103     LOG(IndexedDB, &quot;IDBConnectionToServer::didOpenDatabase&quot;);
104     m_proxy-&gt;didOpenDatabase(resultData);
105 }
106 
107 void IDBConnectionToServer::createObjectStore(const IDBRequestData&amp; requestData, const IDBObjectStoreInfo&amp; info)
108 {
109     LOG(IndexedDB, &quot;IDBConnectionToServer::createObjectStore&quot;);
110     ASSERT(isMainThread());
111 
112     if (m_serverConnectionIsValid)
113         m_delegate-&gt;createObjectStore(requestData, info);
</pre>
<hr />
<pre>
398         });
399     }
400 }
401 
402 void IDBConnectionToServer::didAbortTransaction(const IDBResourceIdentifier&amp; transactionIdentifier, const IDBError&amp; error)
403 {
404     LOG(IndexedDB, &quot;IDBConnectionToServer::didAbortTransaction&quot;);
405     ASSERT(isMainThread());
406 
407     m_proxy-&gt;didAbortTransaction(transactionIdentifier, error);
408 }
409 
410 void IDBConnectionToServer::fireVersionChangeEvent(uint64_t databaseConnectionIdentifier, const IDBResourceIdentifier&amp; requestIdentifier, uint64_t requestedVersion)
411 {
412     LOG(IndexedDB, &quot;IDBConnectionToServer::fireVersionChangeEvent&quot;);
413     ASSERT(isMainThread());
414 
415     m_proxy-&gt;fireVersionChangeEvent(databaseConnectionIdentifier, requestIdentifier, requestedVersion);
416 }
417 
<span class="line-modified">418 void IDBConnectionToServer::didFireVersionChangeEvent(uint64_t databaseConnectionIdentifier, const IDBResourceIdentifier&amp; requestIdentifier)</span>
419 {
420     LOG(IndexedDB, &quot;IDBConnectionToServer::didFireVersionChangeEvent&quot;);
421     ASSERT(isMainThread());
422 
423     if (m_serverConnectionIsValid)
<span class="line-modified">424         m_delegate-&gt;didFireVersionChangeEvent(databaseConnectionIdentifier, requestIdentifier);</span>
425 }
426 
427 void IDBConnectionToServer::didStartTransaction(const IDBResourceIdentifier&amp; transactionIdentifier, const IDBError&amp; error)
428 {
429     LOG(IndexedDB, &quot;IDBConnectionToServer::didStartTransaction&quot;);
430     ASSERT(isMainThread());
431 
432     m_proxy-&gt;didStartTransaction(transactionIdentifier, error);
433 }
434 
435 void IDBConnectionToServer::didCloseFromServer(uint64_t databaseConnectionIdentifier, const IDBError&amp; error)
436 {
437     LOG(IndexedDB, &quot;IDBConnectionToServer::didCloseFromServer&quot;);
438     ASSERT(isMainThread());
439 
440     m_proxy-&gt;didCloseFromServer(databaseConnectionIdentifier, error);
441 }
442 
<span class="line-removed">443 void IDBConnectionToServer::confirmDidCloseFromServer(uint64_t databaseConnectionIdentifier)</span>
<span class="line-removed">444 {</span>
<span class="line-removed">445     LOG(IndexedDB, &quot;IDBConnectionToServer::confirmDidCloseFromServer&quot;);</span>
<span class="line-removed">446     ASSERT(isMainThread());</span>
<span class="line-removed">447 </span>
<span class="line-removed">448     if (m_serverConnectionIsValid)</span>
<span class="line-removed">449         m_delegate-&gt;confirmDidCloseFromServer(databaseConnectionIdentifier);</span>
<span class="line-removed">450 }</span>
<span class="line-removed">451 </span>
452 void IDBConnectionToServer::connectionToServerLost(const IDBError&amp; error)
453 {
454     LOG(IndexedDB, &quot;IDBConnectionToServer::connectionToServerLost&quot;);
455     ASSERT(isMainThread());
456     ASSERT(m_serverConnectionIsValid);
457 
458     m_serverConnectionIsValid = false;
459     m_proxy-&gt;connectionToServerLost(error);
460 }
461 
462 void IDBConnectionToServer::notifyOpenDBRequestBlocked(const IDBResourceIdentifier&amp; requestIdentifier, uint64_t oldVersion, uint64_t newVersion)
463 {
464     LOG(IndexedDB, &quot;IDBConnectionToServer::didStartTransaction&quot;);
465     ASSERT(isMainThread());
466 
467     m_proxy-&gt;notifyOpenDBRequestBlocked(requestIdentifier, oldVersion, newVersion);
468 }
469 
470 void IDBConnectionToServer::openDBRequestCancelled(const IDBRequestData&amp; requestData)
471 {
</pre>
</td>
<td>
<hr />
<pre>
 37 #include &quot;IDBResultData.h&quot;
 38 #include &quot;Logging.h&quot;
 39 #include &quot;SecurityOrigin.h&quot;
 40 #include &quot;TransactionOperation.h&quot;
 41 #include &lt;wtf/MainThread.h&gt;
 42 
 43 namespace WebCore {
 44 namespace IDBClient {
 45 
 46 Ref&lt;IDBConnectionToServer&gt; IDBConnectionToServer::create(IDBConnectionToServerDelegate&amp; delegate)
 47 {
 48     return adoptRef(*new IDBConnectionToServer(delegate));
 49 }
 50 
 51 IDBConnectionToServer::IDBConnectionToServer(IDBConnectionToServerDelegate&amp; delegate)
 52     : m_delegate(makeWeakPtr(delegate))
 53     , m_proxy(makeUnique&lt;IDBConnectionProxy&gt;(*this))
 54 {
 55 }
 56 
<span class="line-modified"> 57 IDBConnectionIdentifier IDBConnectionToServer::identifier() const</span>
 58 {
 59     return m_delegate-&gt;identifier();
 60 }
 61 
 62 IDBConnectionProxy&amp; IDBConnectionToServer::proxy()
 63 {
 64     ASSERT(m_proxy);
 65     return *m_proxy;
 66 }
 67 
 68 void IDBConnectionToServer::callResultFunctionWithErrorLater(ResultFunction function, const IDBResourceIdentifier&amp; requestIdentifier)
 69 {
 70     callOnMainThread([this, protectedThis = makeRef(*this), function, requestIdentifier]() {
 71         (this-&gt;*function)(IDBResultData::error(requestIdentifier, IDBError::serverConnectionLostError()));
 72     });
 73 }
 74 
 75 void IDBConnectionToServer::deleteDatabase(const IDBRequestData&amp; request)
 76 {
<span class="line-modified"> 77     LOG(IndexedDB, &quot;IDBConnectionToServer::deleteDatabase - %s&quot;, request.databaseIdentifier().loggingString().utf8().data());</span>
 78 
 79     if (m_serverConnectionIsValid)
 80         m_delegate-&gt;deleteDatabase(request);
 81     else
 82         callResultFunctionWithErrorLater(&amp;IDBConnectionToServer::didDeleteDatabase, request.requestIdentifier());
 83 }
 84 
 85 void IDBConnectionToServer::didDeleteDatabase(const IDBResultData&amp; resultData)
 86 {
 87     LOG(IndexedDB, &quot;IDBConnectionToServer::didDeleteDatabase&quot;);
 88     m_proxy-&gt;didDeleteDatabase(resultData);
 89 }
 90 
 91 void IDBConnectionToServer::openDatabase(const IDBRequestData&amp; request)
 92 {
<span class="line-modified"> 93     LOG(IndexedDB, &quot;IDBConnectionToServer::openDatabase - %s (%s) (%&quot; PRIu64 &quot;)&quot;, request.databaseIdentifier().loggingString().utf8().data(), request.requestIdentifier().loggingString().utf8().data(), request.requestedVersion());</span>
 94 
 95     if (m_serverConnectionIsValid)
 96         m_delegate-&gt;openDatabase(request);
 97     else
 98         callResultFunctionWithErrorLater(&amp;IDBConnectionToServer::didOpenDatabase, request.requestIdentifier());
 99 }
100 
101 void IDBConnectionToServer::didOpenDatabase(const IDBResultData&amp; resultData)
102 {
103     LOG(IndexedDB, &quot;IDBConnectionToServer::didOpenDatabase&quot;);
104     m_proxy-&gt;didOpenDatabase(resultData);
105 }
106 
107 void IDBConnectionToServer::createObjectStore(const IDBRequestData&amp; requestData, const IDBObjectStoreInfo&amp; info)
108 {
109     LOG(IndexedDB, &quot;IDBConnectionToServer::createObjectStore&quot;);
110     ASSERT(isMainThread());
111 
112     if (m_serverConnectionIsValid)
113         m_delegate-&gt;createObjectStore(requestData, info);
</pre>
<hr />
<pre>
398         });
399     }
400 }
401 
402 void IDBConnectionToServer::didAbortTransaction(const IDBResourceIdentifier&amp; transactionIdentifier, const IDBError&amp; error)
403 {
404     LOG(IndexedDB, &quot;IDBConnectionToServer::didAbortTransaction&quot;);
405     ASSERT(isMainThread());
406 
407     m_proxy-&gt;didAbortTransaction(transactionIdentifier, error);
408 }
409 
410 void IDBConnectionToServer::fireVersionChangeEvent(uint64_t databaseConnectionIdentifier, const IDBResourceIdentifier&amp; requestIdentifier, uint64_t requestedVersion)
411 {
412     LOG(IndexedDB, &quot;IDBConnectionToServer::fireVersionChangeEvent&quot;);
413     ASSERT(isMainThread());
414 
415     m_proxy-&gt;fireVersionChangeEvent(databaseConnectionIdentifier, requestIdentifier, requestedVersion);
416 }
417 
<span class="line-modified">418 void IDBConnectionToServer::didFireVersionChangeEvent(uint64_t databaseConnectionIdentifier, const IDBResourceIdentifier&amp; requestIdentifier, const IndexedDB::ConnectionClosedOnBehalfOfServer connectionClosed)</span>
419 {
420     LOG(IndexedDB, &quot;IDBConnectionToServer::didFireVersionChangeEvent&quot;);
421     ASSERT(isMainThread());
422 
423     if (m_serverConnectionIsValid)
<span class="line-modified">424         m_delegate-&gt;didFireVersionChangeEvent(databaseConnectionIdentifier, requestIdentifier, connectionClosed);</span>
425 }
426 
427 void IDBConnectionToServer::didStartTransaction(const IDBResourceIdentifier&amp; transactionIdentifier, const IDBError&amp; error)
428 {
429     LOG(IndexedDB, &quot;IDBConnectionToServer::didStartTransaction&quot;);
430     ASSERT(isMainThread());
431 
432     m_proxy-&gt;didStartTransaction(transactionIdentifier, error);
433 }
434 
435 void IDBConnectionToServer::didCloseFromServer(uint64_t databaseConnectionIdentifier, const IDBError&amp; error)
436 {
437     LOG(IndexedDB, &quot;IDBConnectionToServer::didCloseFromServer&quot;);
438     ASSERT(isMainThread());
439 
440     m_proxy-&gt;didCloseFromServer(databaseConnectionIdentifier, error);
441 }
442 









443 void IDBConnectionToServer::connectionToServerLost(const IDBError&amp; error)
444 {
445     LOG(IndexedDB, &quot;IDBConnectionToServer::connectionToServerLost&quot;);
446     ASSERT(isMainThread());
447     ASSERT(m_serverConnectionIsValid);
448 
449     m_serverConnectionIsValid = false;
450     m_proxy-&gt;connectionToServerLost(error);
451 }
452 
453 void IDBConnectionToServer::notifyOpenDBRequestBlocked(const IDBResourceIdentifier&amp; requestIdentifier, uint64_t oldVersion, uint64_t newVersion)
454 {
455     LOG(IndexedDB, &quot;IDBConnectionToServer::didStartTransaction&quot;);
456     ASSERT(isMainThread());
457 
458     m_proxy-&gt;notifyOpenDBRequestBlocked(requestIdentifier, oldVersion, newVersion);
459 }
460 
461 void IDBConnectionToServer::openDBRequestCancelled(const IDBRequestData&amp; requestData)
462 {
</pre>
</td>
</tr>
</table>
<center><a href="IDBConnectionProxy.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="IDBConnectionToServer.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>