<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WebCore/bindings/js/JSLazyEventListener.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="JSImageDataCustom.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="JSLazyEventListener.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/bindings/js/JSLazyEventListener.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 63     // a setAttribute call from JavaScript, so make the line number 1 in that case.
 64     if (position == TextPosition::belowRangePosition())
 65         return { };
 66     return position;
 67 }
 68 
 69 JSLazyEventListener::JSLazyEventListener(CreationArguments&amp;&amp; arguments, const String&amp; sourceURL, const TextPosition&amp; sourcePosition)
 70     : JSEventListener(nullptr, arguments.wrapper, true, mainThreadNormalWorld())
 71     , m_functionName(arguments.attributeName.localName().string())
 72     , m_eventParameterName(eventParameterName(arguments.shouldUseSVGEventName))
 73     , m_code(arguments.attributeValue)
 74     , m_sourceURL(sourceURL)
 75     , m_sourcePosition(convertZeroToOne(sourcePosition))
 76     , m_originalNode(WTFMove(arguments.node))
 77 {
 78 #ifndef NDEBUG
 79     eventListenerCounter.increment();
 80 #endif
 81 }
 82 
<span class="line-modified"> 83 #if !ASSERT_DISABLED</span>
 84 static inline bool isCloneInShadowTreeOfSVGUseElement(Node&amp; originalNode, EventTarget&amp; eventTarget)
 85 {
 86     if (!eventTarget.isNode())
 87         return false;
 88 
 89     auto&amp; node = downcast&lt;Node&gt;(eventTarget);
 90     if (!is&lt;SVGElement&gt;(node))
 91         return false;
 92 
 93     auto&amp; element = downcast&lt;SVGElement&gt;(node);
 94     if (!element.correspondingElement())
 95         return false;
 96 
 97     ASSERT(element.isInShadowTree());
 98     return &amp;originalNode == element.correspondingElement();
 99 }
100 
101 // This is to help find the underlying cause of &lt;rdar://problem/24314027&gt;.
102 void JSLazyEventListener::checkValidityForEventTarget(EventTarget&amp; eventTarget)
103 {
</pre>
<hr />
<pre>
129     auto&amp; document = m_originalNode ? m_originalNode-&gt;document() : executionContextDocument;
130     if (!document.frame())
131         return nullptr;
132 
133     if (!document.contentSecurityPolicy()-&gt;allowInlineEventHandlers(m_sourceURL, m_sourcePosition.m_line))
134         return nullptr;
135 
136     auto&amp; script = document.frame()-&gt;script();
137     if (!script.canExecuteScripts(AboutToCreateEventListener) || script.isPaused())
138         return nullptr;
139 
140     if (!executionContextDocument.frame())
141         return nullptr;
142     auto* globalObject = toJSDOMWindow(*executionContextDocument.frame(), isolatedWorld());
143     if (!globalObject)
144         return nullptr;
145 
146     VM&amp; vm = globalObject-&gt;vm();
147     JSLockHolder lock(vm);
148     auto scope = DECLARE_CATCH_SCOPE(vm);
<span class="line-modified">149     ExecState* exec = globalObject-&gt;globalExec();</span>
150 
151     MarkedArgumentBuffer args;
152     args.append(jsNontrivialString(vm, m_eventParameterName));
<span class="line-modified">153     args.append(jsStringWithCache(exec, m_code));</span>
154     ASSERT(!args.hasOverflowed());
155 
156     // We want all errors to refer back to the line on which our attribute was
157     // declared, regardless of any newlines in our JavaScript source text.
158     int overrideLineNumber = m_sourcePosition.m_line.oneBasedInt();
159 
<span class="line-modified">160     JSObject* jsFunction = constructFunctionSkippingEvalEnabledCheck(exec,</span>
<span class="line-modified">161         exec-&gt;lexicalGlobalObject(), args, Identifier::fromString(vm, m_functionName),</span>
162         SourceOrigin { m_sourceURL, CachedScriptFetcher::create(document.charset()) },
163         m_sourceURL, m_sourcePosition, overrideLineNumber);
164     if (UNLIKELY(scope.exception())) {
<span class="line-modified">165         reportCurrentException(exec);</span>
166         scope.clearException();
167         return nullptr;
168     }
169 
170     JSFunction* listenerAsFunction = jsCast&lt;JSFunction*&gt;(jsFunction);
171 
172     if (m_originalNode) {
173         if (!wrapper()) {
174             // Ensure that &#39;node&#39; has a JavaScript wrapper to mark the event listener we&#39;re creating.
175             // FIXME: Should pass the global object associated with the node
<span class="line-modified">176             setWrapper(vm, asObject(toJS(exec, globalObject, *m_originalNode)));</span>
177         }
178 
179         // Add the event&#39;s home element to the scope
180         // (and the document, and the form - see JSHTMLElement::eventHandlerScope)
<span class="line-modified">181         listenerAsFunction-&gt;setScope(vm, jsCast&lt;JSNode*&gt;(wrapper())-&gt;pushEventHandlerScope(exec, listenerAsFunction-&gt;scope()));</span>
182     }
183 
184     return jsFunction;
185 }
186 
187 RefPtr&lt;JSLazyEventListener&gt; JSLazyEventListener::create(CreationArguments&amp;&amp; arguments)
188 {
189     if (arguments.attributeValue.isNull())
190         return nullptr;
191 
192     // FIXME: We should be able to provide source information for frameless documents too (e.g. for importing nodes from XMLHttpRequest.responseXML).
193     TextPosition position;
194     String sourceURL;
195     if (Frame* frame = arguments.document.frame()) {
196         if (!frame-&gt;script().canExecuteScripts(AboutToCreateEventListener))
197             return nullptr;
198         position = frame-&gt;script().eventHandlerPosition();
199         sourceURL = arguments.document.url().string();
200     }
201 
</pre>
</td>
<td>
<hr />
<pre>
 63     // a setAttribute call from JavaScript, so make the line number 1 in that case.
 64     if (position == TextPosition::belowRangePosition())
 65         return { };
 66     return position;
 67 }
 68 
 69 JSLazyEventListener::JSLazyEventListener(CreationArguments&amp;&amp; arguments, const String&amp; sourceURL, const TextPosition&amp; sourcePosition)
 70     : JSEventListener(nullptr, arguments.wrapper, true, mainThreadNormalWorld())
 71     , m_functionName(arguments.attributeName.localName().string())
 72     , m_eventParameterName(eventParameterName(arguments.shouldUseSVGEventName))
 73     , m_code(arguments.attributeValue)
 74     , m_sourceURL(sourceURL)
 75     , m_sourcePosition(convertZeroToOne(sourcePosition))
 76     , m_originalNode(WTFMove(arguments.node))
 77 {
 78 #ifndef NDEBUG
 79     eventListenerCounter.increment();
 80 #endif
 81 }
 82 
<span class="line-modified"> 83 #if ASSERT_ENABLED</span>
 84 static inline bool isCloneInShadowTreeOfSVGUseElement(Node&amp; originalNode, EventTarget&amp; eventTarget)
 85 {
 86     if (!eventTarget.isNode())
 87         return false;
 88 
 89     auto&amp; node = downcast&lt;Node&gt;(eventTarget);
 90     if (!is&lt;SVGElement&gt;(node))
 91         return false;
 92 
 93     auto&amp; element = downcast&lt;SVGElement&gt;(node);
 94     if (!element.correspondingElement())
 95         return false;
 96 
 97     ASSERT(element.isInShadowTree());
 98     return &amp;originalNode == element.correspondingElement();
 99 }
100 
101 // This is to help find the underlying cause of &lt;rdar://problem/24314027&gt;.
102 void JSLazyEventListener::checkValidityForEventTarget(EventTarget&amp; eventTarget)
103 {
</pre>
<hr />
<pre>
129     auto&amp; document = m_originalNode ? m_originalNode-&gt;document() : executionContextDocument;
130     if (!document.frame())
131         return nullptr;
132 
133     if (!document.contentSecurityPolicy()-&gt;allowInlineEventHandlers(m_sourceURL, m_sourcePosition.m_line))
134         return nullptr;
135 
136     auto&amp; script = document.frame()-&gt;script();
137     if (!script.canExecuteScripts(AboutToCreateEventListener) || script.isPaused())
138         return nullptr;
139 
140     if (!executionContextDocument.frame())
141         return nullptr;
142     auto* globalObject = toJSDOMWindow(*executionContextDocument.frame(), isolatedWorld());
143     if (!globalObject)
144         return nullptr;
145 
146     VM&amp; vm = globalObject-&gt;vm();
147     JSLockHolder lock(vm);
148     auto scope = DECLARE_CATCH_SCOPE(vm);
<span class="line-modified">149     JSGlobalObject* lexicalGlobalObject = globalObject;</span>
150 
151     MarkedArgumentBuffer args;
152     args.append(jsNontrivialString(vm, m_eventParameterName));
<span class="line-modified">153     args.append(jsStringWithCache(lexicalGlobalObject, m_code));</span>
154     ASSERT(!args.hasOverflowed());
155 
156     // We want all errors to refer back to the line on which our attribute was
157     // declared, regardless of any newlines in our JavaScript source text.
158     int overrideLineNumber = m_sourcePosition.m_line.oneBasedInt();
159 
<span class="line-modified">160     JSObject* jsFunction = constructFunctionSkippingEvalEnabledCheck(</span>
<span class="line-modified">161         lexicalGlobalObject, args, Identifier::fromString(vm, m_functionName),</span>
162         SourceOrigin { m_sourceURL, CachedScriptFetcher::create(document.charset()) },
163         m_sourceURL, m_sourcePosition, overrideLineNumber);
164     if (UNLIKELY(scope.exception())) {
<span class="line-modified">165         reportCurrentException(lexicalGlobalObject);</span>
166         scope.clearException();
167         return nullptr;
168     }
169 
170     JSFunction* listenerAsFunction = jsCast&lt;JSFunction*&gt;(jsFunction);
171 
172     if (m_originalNode) {
173         if (!wrapper()) {
174             // Ensure that &#39;node&#39; has a JavaScript wrapper to mark the event listener we&#39;re creating.
175             // FIXME: Should pass the global object associated with the node
<span class="line-modified">176             setWrapper(vm, asObject(toJS(lexicalGlobalObject, globalObject, *m_originalNode)));</span>
177         }
178 
179         // Add the event&#39;s home element to the scope
180         // (and the document, and the form - see JSHTMLElement::eventHandlerScope)
<span class="line-modified">181         listenerAsFunction-&gt;setScope(vm, jsCast&lt;JSNode*&gt;(wrapper())-&gt;pushEventHandlerScope(lexicalGlobalObject, listenerAsFunction-&gt;scope()));</span>
182     }
183 
184     return jsFunction;
185 }
186 
187 RefPtr&lt;JSLazyEventListener&gt; JSLazyEventListener::create(CreationArguments&amp;&amp; arguments)
188 {
189     if (arguments.attributeValue.isNull())
190         return nullptr;
191 
192     // FIXME: We should be able to provide source information for frameless documents too (e.g. for importing nodes from XMLHttpRequest.responseXML).
193     TextPosition position;
194     String sourceURL;
195     if (Frame* frame = arguments.document.frame()) {
196         if (!frame-&gt;script().canExecuteScripts(AboutToCreateEventListener))
197             return nullptr;
198         position = frame-&gt;script().eventHandlerPosition();
199         sourceURL = arguments.document.url().string();
200     }
201 
</pre>
</td>
</tr>
</table>
<center><a href="JSImageDataCustom.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="JSLazyEventListener.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>