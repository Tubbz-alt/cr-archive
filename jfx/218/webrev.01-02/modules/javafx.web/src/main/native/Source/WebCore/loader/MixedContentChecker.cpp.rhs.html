<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/WebCore/loader/MixedContentChecker.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (C) 2012 Google Inc. All rights reserved.
  3  * Copyright (C) 2013-2017 Apple Inc. All rights reserved.
  4  *
  5  * Redistribution and use in source and binary forms, with or without
  6  * modification, are permitted provided that the following conditions
  7  * are met:
  8  *
  9  * 1.  Redistributions of source code must retain the above copyright
 10  *     notice, this list of conditions and the following disclaimer.
 11  * 2.  Redistributions in binary form must reproduce the above copyright
 12  *     notice, this list of conditions and the following disclaimer in the
 13  *     documentation and/or other materials provided with the distribution.
 14  * 3.  Neither the name of Apple Inc. (&quot;Apple&quot;) nor the names of
 15  *     its contributors may be used to endorse or promote products derived
 16  *     from this software without specific prior written permission.
 17  *
 18  * THIS SOFTWARE IS PROVIDED BY APPLE AND ITS CONTRIBUTORS &quot;AS IS&quot; AND ANY
 19  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 20  * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 21  * DISCLAIMED. IN NO EVENT SHALL APPLE OR ITS CONTRIBUTORS BE LIABLE FOR ANY
 22  * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 23  * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 24  * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
 25  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 26  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
 27  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 28  */
 29 
 30 #include &quot;config.h&quot;
 31 #include &quot;MixedContentChecker.h&quot;
 32 
 33 #include &quot;ContentSecurityPolicy.h&quot;
 34 #include &quot;Document.h&quot;
 35 #include &quot;Frame.h&quot;
 36 #include &quot;FrameLoader.h&quot;
 37 #include &quot;FrameLoaderClient.h&quot;
 38 #include &quot;SecurityOrigin.h&quot;
 39 #include &quot;Settings.h&quot;
 40 #include &lt;wtf/text/CString.h&gt;
 41 #include &lt;wtf/text/WTFString.h&gt;
 42 
 43 namespace WebCore {
 44 
 45 MixedContentChecker::MixedContentChecker(Frame&amp; frame)
 46     : m_frame(frame)
 47 {
 48 }
 49 
 50 FrameLoaderClient&amp; MixedContentChecker::client() const
 51 {
 52     return m_frame.loader().client();
 53 }
 54 
 55 // static
 56 bool MixedContentChecker::isMixedContent(SecurityOrigin&amp; securityOrigin, const URL&amp; url)
 57 {
 58     if (securityOrigin.protocol() != &quot;https&quot;)
 59         return false; // We only care about HTTPS security origins.
 60 
 61     // We&#39;re in a secure context, so |url| is mixed content if it&#39;s insecure.
 62     return !SecurityOrigin::isSecure(url);
 63 }
 64 
 65 bool MixedContentChecker::canDisplayInsecureContent(SecurityOrigin&amp; securityOrigin, ContentType type, const URL&amp; url, AlwaysDisplayInNonStrictMode alwaysDisplayInNonStrictMode) const
 66 {
 67     if (!isMixedContent(securityOrigin, url))
 68         return true;
 69 
 70     if (!m_frame.document()-&gt;contentSecurityPolicy()-&gt;allowRunningOrDisplayingInsecureContent(url))
 71         return false;
 72 
 73     bool isStrictMode = m_frame.document()-&gt;isStrictMixedContentMode();
 74     if (!isStrictMode &amp;&amp; alwaysDisplayInNonStrictMode == AlwaysDisplayInNonStrictMode::Yes)
 75         return true;
 76 
 77     bool allowed = !isStrictMode &amp;&amp; (m_frame.settings().allowDisplayOfInsecureContent() || type == ContentType::ActiveCanWarn) &amp;&amp; !m_frame.document()-&gt;geolocationAccessed();
 78     logWarning(allowed, &quot;display&quot;, url);
 79 
 80     if (allowed) {
 81         m_frame.document()-&gt;setFoundMixedContent(SecurityContext::MixedContentType::Inactive);
 82         client().didDisplayInsecureContent();
 83     }
 84 
 85     return allowed;
 86 }
 87 
 88 bool MixedContentChecker::canRunInsecureContent(SecurityOrigin&amp; securityOrigin, const URL&amp; url) const
 89 {
 90     if (!isMixedContent(securityOrigin, url))
 91         return true;
 92 
 93     if (!m_frame.document()-&gt;contentSecurityPolicy()-&gt;allowRunningOrDisplayingInsecureContent(url))
 94         return false;
 95 
 96     bool allowed = !m_frame.document()-&gt;isStrictMixedContentMode() &amp;&amp; m_frame.settings().allowRunningOfInsecureContent() &amp;&amp; !m_frame.document()-&gt;geolocationAccessed() &amp;&amp; !m_frame.document()-&gt;secureCookiesAccessed();
 97     logWarning(allowed, &quot;run&quot;, url);
 98 
 99     if (allowed) {
100         m_frame.document()-&gt;setFoundMixedContent(SecurityContext::MixedContentType::Active);
101         client().didRunInsecureContent(securityOrigin, url);
102     }
103 
104     return allowed;
105 }
106 
107 void MixedContentChecker::checkFormForMixedContent(SecurityOrigin&amp; securityOrigin, const URL&amp; url) const
108 {
109     // Unconditionally allow javascript: URLs as form actions as some pages do this and it does not introduce
110     // a mixed content issue.
111     if (WTF::protocolIsJavaScript(url))
112         return;
113 
114     if (!isMixedContent(securityOrigin, url))
115         return;
116 
117     String message = makeString(&quot;The page at &quot;, m_frame.document()-&gt;url().stringCenterEllipsizedToLength(), &quot; contains a form which targets an insecure URL &quot;, url.stringCenterEllipsizedToLength(), &quot;.\n&quot;);
118     m_frame.document()-&gt;addConsoleMessage(MessageSource::Security, MessageLevel::Warning, message);
119 
120     client().didDisplayInsecureContent();
121 }
122 
<a name="1" id="anc1"></a><span class="line-added">123 Optional&lt;String&gt; MixedContentChecker::checkForMixedContentInFrameTree(const URL&amp; url)</span>
<span class="line-added">124 {</span>
<span class="line-added">125     auto* document = m_frame.document();</span>
<span class="line-added">126 </span>
<span class="line-added">127     while (document) {</span>
<span class="line-added">128         RELEASE_ASSERT_WITH_MESSAGE(document-&gt;frame(), &quot;An unparented document tried to connect to a websocket with url: %s&quot;, url.string().utf8().data());</span>
<span class="line-added">129 </span>
<span class="line-added">130         auto* frame = document-&gt;frame();</span>
<span class="line-added">131         if (isMixedContent(document-&gt;securityOrigin(), url))</span>
<span class="line-added">132             return makeString(&quot;The page at &quot;, document-&gt;url().stringCenterEllipsizedToLength(), &quot; was blocked from connecting insecurely to &quot;, url.stringCenterEllipsizedToLength(), &quot; either because the protocol is insecure or the page is embedded from an insecure page.&quot;);</span>
<span class="line-added">133 </span>
<span class="line-added">134         if (frame-&gt;isMainFrame())</span>
<span class="line-added">135             break;</span>
<span class="line-added">136 </span>
<span class="line-added">137         frame = frame-&gt;tree().parent();</span>
<span class="line-added">138         RELEASE_ASSERT_WITH_MESSAGE(frame, &quot;Should never have a parentless non main frame&quot;);</span>
<span class="line-added">139         document = frame-&gt;document();</span>
<span class="line-added">140     }</span>
<span class="line-added">141 </span>
<span class="line-added">142     return WTF::nullopt;</span>
<span class="line-added">143 }</span>
<span class="line-added">144 </span>
145 void MixedContentChecker::logWarning(bool allowed, const String&amp; action, const URL&amp; target) const
146 {
147     const char* errorString = allowed ? &quot; was allowed to &quot; : &quot; was not allowed to &quot;;
148     String message = makeString((allowed ? String() : &quot;[blocked] &quot;), &quot;The page at &quot;, m_frame.document()-&gt;url().stringCenterEllipsizedToLength(), errorString, action, &quot; insecure content from &quot;, target.stringCenterEllipsizedToLength(), &quot;.\n&quot;);
149     m_frame.document()-&gt;addConsoleMessage(MessageSource::Security, MessageLevel::Warning, message);
150 }
151 
152 } // namespace WebCore
<a name="2" id="anc2"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="2" type="hidden" />
</body>
</html>