<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New modules/javafx.web/src/main/native/Source/WebCore/platform/audio/AudioArray.h</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (C) 2010 Google Inc. All rights reserved.
  3  *
  4  * Redistribution and use in source and binary forms, with or without
  5  * modification, are permitted provided that the following conditions
  6  * are met:
  7  *
  8  * 1.  Redistributions of source code must retain the above copyright
  9  *     notice, this list of conditions and the following disclaimer.
 10  * 2.  Redistributions in binary form must reproduce the above copyright
 11  *     notice, this list of conditions and the following disclaimer in the
 12  *     documentation and/or other materials provided with the distribution.
 13  * 3.  Neither the name of Apple Inc. (&quot;Apple&quot;) nor the names of
 14  *     its contributors may be used to endorse or promote products derived
 15  *     from this software without specific prior written permission.
 16  *
 17  * THIS SOFTWARE IS PROVIDED BY APPLE AND ITS CONTRIBUTORS &quot;AS IS&quot; AND ANY
 18  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 19  * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 20  * DISCLAIMED. IN NO EVENT SHALL APPLE OR ITS CONTRIBUTORS BE LIABLE FOR ANY
 21  * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 22  * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 23  * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
 24  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 25  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
 26  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 27  */
 28 
 29 #ifndef AudioArray_h
 30 #define AudioArray_h
 31 
 32 #include &lt;string.h&gt;
 33 #include &lt;wtf/CheckedArithmetic.h&gt;
 34 #include &lt;wtf/FastMalloc.h&gt;
 35 
 36 namespace WebCore {
 37 
 38 template&lt;typename T&gt;
 39 class AudioArray {
 40     WTF_MAKE_FAST_ALLOCATED;
 41 public:
 42     AudioArray() = default;
 43     explicit AudioArray(size_t n)
 44     {
 45         allocate(n);
 46     }
 47 
 48     ~AudioArray()
 49     {
 50         fastAlignedFree(m_allocation);
 51     }
 52 
 53     // It&#39;s OK to call allocate() multiple times, but data will *not* be copied from an initial allocation
 54     // if re-allocated. Allocations are zero-initialized.
 55     void allocate(Checked&lt;size_t&gt; n)
 56     {
 57         Checked&lt;size_t&gt; initialSize = sizeof(T) * n;
 58         const size_t alignment = 16;
 59 
 60         fastAlignedFree(m_allocation);
 61 
 62         m_allocation = static_cast&lt;T*&gt;(fastAlignedMalloc(alignment, initialSize.unsafeGet()));
 63         if (!m_allocation)
 64             CRASH();
 65         m_size = n.unsafeGet();
 66         zero();
 67     }
 68 
 69     T* data() { return m_allocation; }
 70     const T* data() const { return m_allocation; }
 71     size_t size() const { return m_size; }
 72 
 73     T&amp; at(size_t i)
 74     {
 75         // Note that although it is a size_t, m_size is now guaranteed to be
 76         // no greater than max unsigned. This guarantee is enforced in allocate().
 77         ASSERT_WITH_SECURITY_IMPLICATION(i &lt; size());
 78         return data()[i];
 79     }
 80 
 81     T&amp; operator[](size_t i) { return at(i); }
 82 
 83     void zero()
 84     {
 85         // This multiplication is made safe by the check in allocate().
 86         memset(this-&gt;data(), 0, sizeof(T) * this-&gt;size());
 87     }
 88 
 89     void zeroRange(unsigned start, unsigned end)
 90     {
 91         bool isSafe = (start &lt;= end) &amp;&amp; (end &lt;= this-&gt;size());
 92         ASSERT(isSafe);
 93         if (!isSafe)
 94             return;
 95 
 96         // This expression cannot overflow because end - start cannot be
 97         // greater than m_size, which is safe due to the check in allocate().
 98         memset(this-&gt;data() + start, 0, sizeof(T) * (end - start));
 99     }
100 
101     void copyToRange(const T* sourceData, unsigned start, unsigned end)
102     {
103         bool isSafe = (start &lt;= end) &amp;&amp; (end &lt;= this-&gt;size());
104         ASSERT(isSafe);
105         if (!isSafe)
106             return;
107 
108         // This expression cannot overflow because end - start cannot be
109         // greater than m_size, which is safe due to the check in allocate().
110         memcpy(this-&gt;data() + start, sourceData, sizeof(T) * (end - start));
111     }
112 
113 private:
114     T* m_allocation { nullptr };
115     size_t m_size { 0 };
116 };
117 
118 typedef AudioArray&lt;float&gt; AudioFloatArray;
119 typedef AudioArray&lt;double&gt; AudioDoubleArray;
120 
121 } // WebCore
122 
123 #endif // AudioArray_h
    </pre>
  </body>
</html>