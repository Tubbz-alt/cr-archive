<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/JavaScriptCore/wasm/WasmCodeBlock.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="WasmCallingConvention.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="WasmCodeBlock.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/JavaScriptCore/wasm/WasmCodeBlock.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -26,56 +26,84 @@</span>
  #include &quot;config.h&quot;
  #include &quot;WasmCodeBlock.h&quot;
  
  #if ENABLE(WEBASSEMBLY)
  
<span class="udiff-line-modified-removed">- #include &quot;WasmBBQPlanInlines.h&quot;</span>
<span class="udiff-line-modified-added">+ #include &quot;WasmBBQPlan.h&quot;</span>
  #include &quot;WasmCallee.h&quot;
  #include &quot;WasmFormat.h&quot;
<span class="udiff-line-added">+ #include &quot;WasmLLIntPlan.h&quot;</span>
  #include &quot;WasmWorklist.h&quot;
  
  namespace JSC { namespace Wasm {
  
<span class="udiff-line-modified-removed">- Ref&lt;CodeBlock&gt; CodeBlock::create(Context* context, MemoryMode mode, ModuleInformation&amp; moduleInformation, CreateEmbedderWrapper&amp;&amp; createEmbedderWrapper, ThrowWasmException throwWasmException)</span>
<span class="udiff-line-modified-added">+ Ref&lt;CodeBlock&gt; CodeBlock::create(Context* context, MemoryMode mode, ModuleInformation&amp; moduleInformation, RefPtr&lt;LLIntCallees&gt; llintCallees)</span>
  {
<span class="udiff-line-modified-removed">-     auto* result = new (NotNull, fastMalloc(sizeof(CodeBlock))) CodeBlock(context, mode, moduleInformation, WTFMove(createEmbedderWrapper), throwWasmException);</span>
<span class="udiff-line-modified-added">+     auto* result = new (NotNull, fastMalloc(sizeof(CodeBlock))) CodeBlock(context, mode, moduleInformation, llintCallees);</span>
      return adoptRef(*result);
  }
  
<span class="udiff-line-modified-removed">- CodeBlock::CodeBlock(Context* context, MemoryMode mode, ModuleInformation&amp; moduleInformation, CreateEmbedderWrapper&amp;&amp; createEmbedderWrapper, ThrowWasmException throwWasmException)</span>
<span class="udiff-line-modified-added">+ CodeBlock::CodeBlock(Context* context, MemoryMode mode, ModuleInformation&amp; moduleInformation, RefPtr&lt;LLIntCallees&gt; llintCallees)</span>
      : m_calleeCount(moduleInformation.internalFunctionCount())
      , m_mode(mode)
<span class="udiff-line-added">+     , m_llintCallees(llintCallees)</span>
  {
      RefPtr&lt;CodeBlock&gt; protectedThis = this;
  
<span class="udiff-line-modified-removed">-     m_plan = adoptRef(*new BBQPlan(context, makeRef(moduleInformation), BBQPlan::FullCompile, createSharedTask&lt;Plan::CallbackType&gt;([this, protectedThis = WTFMove(protectedThis)] (Plan&amp;) {</span>
<span class="udiff-line-modified-removed">-         auto locker = holdLock(m_lock);</span>
<span class="udiff-line-modified-removed">-         if (m_plan-&gt;failed()) {</span>
<span class="udiff-line-modified-removed">-             m_errorMessage = m_plan-&gt;errorMessage();</span>
<span class="udiff-line-modified-added">+     if (Options::useWasmLLInt()) {</span>
<span class="udiff-line-modified-added">+         m_plan = adoptRef(*new LLIntPlan(context, makeRef(moduleInformation), m_llintCallees-&gt;data(), createSharedTask&lt;Plan::CallbackType&gt;([this, protectedThis = WTFMove(protectedThis)] (Plan&amp;) {</span>
<span class="udiff-line-modified-added">+             auto locker = holdLock(m_lock);</span>
<span class="udiff-line-modified-added">+             if (m_plan-&gt;failed()) {</span>
<span class="udiff-line-added">+                 m_errorMessage = m_plan-&gt;errorMessage();</span>
<span class="udiff-line-added">+                 setCompilationFinished();</span>
<span class="udiff-line-added">+                 return;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // FIXME: we should eventually collect the BBQ code.</span>
<span class="udiff-line-added">+             m_bbqCallees.resize(m_calleeCount);</span>
<span class="udiff-line-added">+             m_omgCallees.resize(m_calleeCount);</span>
<span class="udiff-line-added">+             m_wasmIndirectCallEntryPoints.resize(m_calleeCount);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             for (unsigned i = 0; i &lt; m_calleeCount; ++i)</span>
<span class="udiff-line-added">+                 m_wasmIndirectCallEntryPoints[i] = m_llintCallees-&gt;at(i)-&gt;entrypoint();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             m_wasmToWasmExitStubs = m_plan-&gt;takeWasmToWasmExitStubs();</span>
<span class="udiff-line-added">+             m_wasmToWasmCallsites = m_plan-&gt;takeWasmToWasmCallsites();</span>
<span class="udiff-line-added">+             m_embedderCallees = static_cast&lt;LLIntPlan*&gt;(m_plan.get())-&gt;takeEmbedderCallees();</span>
<span class="udiff-line-added">+ </span>
              setCompilationFinished();
<span class="udiff-line-modified-removed">-             return;</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-         // FIXME: we should eventually collect the BBQ code.</span>
<span class="udiff-line-modified-removed">-         m_callees.resize(m_calleeCount);</span>
<span class="udiff-line-modified-removed">-         m_optimizedCallees.resize(m_calleeCount);</span>
<span class="udiff-line-modified-removed">-         m_wasmIndirectCallEntryPoints.resize(m_calleeCount);</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-removed">-         m_plan-&gt;initializeCallees([&amp;] (unsigned calleeIndex, RefPtr&lt;Wasm::Callee&gt;&amp;&amp; embedderEntrypointCallee, Ref&lt;Wasm::Callee&gt;&amp;&amp; wasmEntrypointCallee) {</span>
<span class="udiff-line-removed">-             if (embedderEntrypointCallee) {</span>
<span class="udiff-line-removed">-                 auto result = m_embedderCallees.set(calleeIndex, WTFMove(embedderEntrypointCallee));</span>
<span class="udiff-line-removed">-                 ASSERT_UNUSED(result, result.isNewEntry);</span>
<span class="udiff-line-modified-added">+         })));</span>
<span class="udiff-line-modified-added">+     } else {</span>
<span class="udiff-line-modified-added">+         m_plan = adoptRef(*new BBQPlan(context, makeRef(moduleInformation), EntryPlan::FullCompile, createSharedTask&lt;Plan::CallbackType&gt;([this, protectedThis = WTFMove(protectedThis)] (Plan&amp;) {</span>
<span class="udiff-line-modified-added">+             auto locker = holdLock(m_lock);</span>
<span class="udiff-line-modified-added">+             if (m_plan-&gt;failed()) {</span>
<span class="udiff-line-modified-added">+                 m_errorMessage = m_plan-&gt;errorMessage();</span>
<span class="udiff-line-modified-added">+                 setCompilationFinished();</span>
<span class="udiff-line-modified-added">+                 return;</span>
              }
<span class="udiff-line-removed">-             m_callees[calleeIndex] = WTFMove(wasmEntrypointCallee);</span>
<span class="udiff-line-removed">-             m_wasmIndirectCallEntryPoints[calleeIndex] = m_callees[calleeIndex]-&gt;entrypoint();</span>
<span class="udiff-line-removed">-         });</span>
  
<span class="udiff-line-modified-removed">-         m_wasmToWasmExitStubs = m_plan-&gt;takeWasmToWasmExitStubs();</span>
<span class="udiff-line-modified-removed">-         m_wasmToWasmCallsites = m_plan-&gt;takeWasmToWasmCallsites();</span>
<span class="udiff-line-modified-added">+             // FIXME: we should eventually collect the BBQ code.</span>
<span class="udiff-line-modified-added">+             m_bbqCallees.resize(m_calleeCount);</span>
<span class="udiff-line-added">+             m_omgCallees.resize(m_calleeCount);</span>
<span class="udiff-line-added">+             m_wasmIndirectCallEntryPoints.resize(m_calleeCount);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             BBQPlan* bbqPlan = static_cast&lt;BBQPlan*&gt;(m_plan.get());</span>
<span class="udiff-line-added">+             bbqPlan-&gt;initializeCallees([&amp;] (unsigned calleeIndex, RefPtr&lt;EmbedderEntrypointCallee&gt;&amp;&amp; embedderEntrypointCallee, RefPtr&lt;BBQCallee&gt;&amp;&amp; wasmEntrypoint) {</span>
<span class="udiff-line-added">+                 if (embedderEntrypointCallee) {</span>
<span class="udiff-line-added">+                     auto result = m_embedderCallees.set(calleeIndex, WTFMove(embedderEntrypointCallee));</span>
<span class="udiff-line-added">+                     ASSERT_UNUSED(result, result.isNewEntry);</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+                 m_wasmIndirectCallEntryPoints[calleeIndex] = wasmEntrypoint-&gt;entrypoint();</span>
<span class="udiff-line-added">+                 m_bbqCallees[calleeIndex] = adoptRef(static_cast&lt;BBQCallee*&gt;(wasmEntrypoint.leakRef()));</span>
<span class="udiff-line-added">+             });</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             m_wasmToWasmExitStubs = m_plan-&gt;takeWasmToWasmExitStubs();</span>
<span class="udiff-line-added">+             m_wasmToWasmCallsites = m_plan-&gt;takeWasmToWasmCallsites();</span>
  
<span class="udiff-line-modified-removed">-         setCompilationFinished();</span>
<span class="udiff-line-modified-removed">-     }), WTFMove(createEmbedderWrapper), throwWasmException));</span>
<span class="udiff-line-modified-added">+             setCompilationFinished();</span>
<span class="udiff-line-modified-added">+         })));</span>
<span class="udiff-line-added">+     }</span>
      m_plan-&gt;setMode(mode);
  
      auto&amp; worklist = Wasm::ensureWorklist();
      // Note, immediately after we enqueue the plan, there is a chance the above callback will be called.
      worklist.enqueue(makeRef(*m_plan.get()));
</pre>
<center><a href="WasmCallingConvention.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="WasmCodeBlock.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>