<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/WebCore/platform/graphics/HEVCUtilities.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (C) 2018 Apple Inc. All rights reserved.
  3  *
  4  * Redistribution and use in source and binary forms, with or without
  5  * modification, are permitted provided that the following conditions
  6  * are met:
  7  * 1. Redistributions of source code must retain the above copyright
  8  *    notice, this list of conditions and the following disclaimer.
  9  * 2. Redistributions in binary form must reproduce the above copyright
 10  *    notice, this list of conditions and the following disclaimer in the
 11  *    documentation and/or other materials provided with the distribution.
 12  *
 13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. AND ITS CONTRIBUTORS ``AS IS&#39;&#39;
 14  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
 15  * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 16  * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL APPLE INC. OR ITS CONTRIBUTORS
 17  * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 18  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 19  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 20  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 21  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 22  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF
 23  * THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #include &quot;config.h&quot;
 27 #include &quot;HEVCUtilities.h&quot;
 28 
<a name="1" id="anc1"></a><span class="line-added"> 29 #include &lt;wtf/HashMap.h&gt;</span>
<span class="line-added"> 30 #include &lt;wtf/HashSet.h&gt;</span>
<span class="line-added"> 31 #include &lt;wtf/NeverDestroyed.h&gt;</span>
<span class="line-added"> 32 #include &lt;wtf/text/StringHash.h&gt;</span>
 33 #include &lt;wtf/text/StringToIntegerConversion.h&gt;
 34 
 35 namespace WebCore {
 36 
 37 Optional&lt;HEVCParameterSet&gt; parseHEVCCodecParameters(const String&amp; codecString)
 38 {
 39     // The format of the &#39;hevc&#39; codec string is specified in ISO/IEC 14496-15:2014, Annex E.3.
 40     StringView codecView(codecString);
 41     auto codecSplit = codecView.split(&#39;.&#39;);
 42     auto nextElement = codecSplit.begin();
 43     if (nextElement == codecSplit.end())
 44         return WTF::nullopt;
 45 
 46     HEVCParameterSet parameters;
 47 
 48     // Codec identifier: legal values are specified in ISO/IEC 14496-15:2014, section 8:
 49     parameters.codecName = (*nextElement).toString();
 50     if (!equal(parameters.codecName, &quot;hvc1&quot;) &amp;&amp; !equal(parameters.codecName, &quot;hev1&quot;))
 51         return WTF::nullopt;
 52 
 53     if (++nextElement == codecSplit.end())
 54         return WTF::nullopt;
 55 
 56     // First element: Optional General Profile Space parameter [&#39;A&#39;, &#39;B&#39;, &#39;C&#39;], mapping to [1, 2, 3]
 57     // and [0] for absent, then General Profile IDC as a 5-bit decimal number.
 58     auto profileSpace = *nextElement;
 59     if (!profileSpace.length())
 60         return WTF::nullopt;
 61 
 62     auto firstCharacter = profileSpace[0];
 63     bool hasProfileSpace = firstCharacter &gt;= &#39;A&#39; &amp;&amp; firstCharacter &lt;= &#39;C&#39;;
 64     if (hasProfileSpace) {
 65         parameters.generalProfileSpace = 1 + (firstCharacter - &#39;A&#39;);
 66         profileSpace = profileSpace.substring(1);
 67     }
 68 
 69     bool isValidProfileIDC = false;
 70     parameters.generalProfileIDC = toIntegralType&lt;uint8_t&gt;(profileSpace, &amp;isValidProfileIDC);
 71     if (!isValidProfileIDC)
 72         return WTF::nullopt;
 73 
 74     if (++nextElement == codecSplit.end())
 75         return WTF::nullopt;
 76 
 77     // Second element: 32 bit of General Profile Compatibility Flags, in reverse bit order,
 78     // in hex with leading zeros omitted.
 79     auto compatibilityFlags = *nextElement;
 80     bool isValidCompatibilityFlags = false;
 81     parameters.generalProfileCompatibilityFlags = toIntegralType&lt;uint32_t&gt;(compatibilityFlags, &amp;isValidCompatibilityFlags, 16);
 82     if (!isValidCompatibilityFlags)
 83         return WTF::nullopt;
 84 
 85     if (++nextElement == codecSplit.end())
 86         return WTF::nullopt;
 87 
 88     // Third element: General Tier Flag [&#39;L&#39;, &#39;H&#39;], mapping to [false, true], followed by
 89     // General Level IDC as a 8-bit decimal number.
 90     auto generalTier = *nextElement;
 91     firstCharacter = generalTier[0];
 92     if (firstCharacter != &#39;L&#39; &amp;&amp; firstCharacter != &#39;H&#39;)
 93         return WTF::nullopt;
 94 
 95     parameters.generalTierFlag = firstCharacter == &#39;H&#39;;
 96     bool isValidGeneralLevelIDC = false;
 97     parameters.generalLevelIDC = toIntegralType&lt;uint8_t&gt;(generalTier.substring(1), &amp;isValidGeneralLevelIDC);
 98     if (!isValidGeneralLevelIDC)
 99         return WTF::nullopt;
100 
101     // Optional fourth and remaning elements: a sequence of 6 1-byte constraint flags, each byte encoded
102     // in hex, and separated by a period, with trailing zero bytes omitted.
103     parameters.constraintFlags.fill(0, 6);
104     for (auto&amp; flag : parameters.constraintFlags) {
105         if (++nextElement == codecSplit.end())
106             break;
107 
108         bool isValidFlag = false;
109         flag = toIntegralType&lt;uint8_t&gt;(*nextElement, &amp;isValidFlag, 16);
110         if (!isValidFlag)
111             return WTF::nullopt;
112     }
113 
114     return parameters;
115 }
116 
<a name="2" id="anc2"></a><span class="line-added">117 static String codecStringForDoViCodecType(const String&amp; codec)</span>
<span class="line-added">118 {</span>
<span class="line-added">119     using MapType = HashMap&lt;String, String&gt;;</span>
<span class="line-added">120     static NeverDestroyed&lt;MapType&gt; types = std::initializer_list&lt;MapType::KeyValuePairType&gt;({</span>
<span class="line-added">121         { &quot;dvhe&quot;, &quot;hev1&quot; },</span>
<span class="line-added">122         { &quot;dvh1&quot;, &quot;hvc1&quot; },</span>
<span class="line-added">123         { &quot;dvav&quot;, &quot;avc3&quot; },</span>
<span class="line-added">124         { &quot;dva1&quot;, &quot;avc1&quot; }</span>
<span class="line-added">125     });</span>
<span class="line-added">126 </span>
<span class="line-added">127     auto findResults = types.get().find(codec);</span>
<span class="line-added">128     if (findResults == types.get().end())</span>
<span class="line-added">129         return nullString();</span>
<span class="line-added">130     return findResults-&gt;value;</span>
<span class="line-added">131 }</span>
<span class="line-added">132 </span>
<span class="line-added">133 static Optional&lt;unsigned short&gt; profileIDForAlphabeticDoViProfile(const String&amp; profile)</span>
<span class="line-added">134 {</span>
<span class="line-added">135     // See Table 7 of &quot;Dolby Vision Profiles and Levels Version 1.3.2&quot;</span>
<span class="line-added">136     using MapType = HashMap&lt;String, unsigned short&gt;;</span>
<span class="line-added">137     static NeverDestroyed&lt;MapType&gt; map = std::initializer_list&lt;MapType::KeyValuePairType&gt;({</span>
<span class="line-added">138         { &quot;dvhe.dtr&quot;, 4 },</span>
<span class="line-added">139         { &quot;dvhe.stn&quot;, 5 },</span>
<span class="line-added">140         { &quot;dvhe.dtb&quot;, 7 },</span>
<span class="line-added">141         { &quot;dvhe.st&quot;, 8 },</span>
<span class="line-added">142         { &quot;dvav.se&quot;, 9 }</span>
<span class="line-added">143     });</span>
<span class="line-added">144 </span>
<span class="line-added">145     auto findResults = map.get().find(profile);</span>
<span class="line-added">146     if (findResults == map.get().end())</span>
<span class="line-added">147         return WTF::nullopt;</span>
<span class="line-added">148     return findResults-&gt;value;</span>
<span class="line-added">149 }</span>
<span class="line-added">150 </span>
<span class="line-added">151 static bool isValidDoViProfileID(unsigned short profileID)</span>
<span class="line-added">152 {</span>
<span class="line-added">153     switch (profileID) {</span>
<span class="line-added">154     case 4:</span>
<span class="line-added">155     case 5:</span>
<span class="line-added">156     case 7:</span>
<span class="line-added">157     case 8:</span>
<span class="line-added">158     case 9:</span>
<span class="line-added">159         return true;</span>
<span class="line-added">160     default:</span>
<span class="line-added">161         return false;</span>
<span class="line-added">162     }</span>
<span class="line-added">163 }</span>
<span class="line-added">164 </span>
<span class="line-added">165 static Optional&lt;unsigned short&gt; maximumLevelIDForDoViProfileID(unsigned short profileID)</span>
<span class="line-added">166 {</span>
<span class="line-added">167     // See Section 4.1 of &quot;Dolby Vision Profiles and Levels Version 1.3.2&quot;</span>
<span class="line-added">168     switch (profileID) {</span>
<span class="line-added">169     case 4: return 9;</span>
<span class="line-added">170     case 5: return 13;</span>
<span class="line-added">171     case 7: return 9;</span>
<span class="line-added">172     case 8: return 13;</span>
<span class="line-added">173     case 9: return 5;</span>
<span class="line-added">174     default: return WTF::nullopt;</span>
<span class="line-added">175     }</span>
<span class="line-added">176 }</span>
<span class="line-added">177 </span>
<span class="line-added">178 static bool isValidProfileIDForCodecName(unsigned short profileID, const String&amp; codecName)</span>
<span class="line-added">179 {</span>
<span class="line-added">180     if (profileID == 9)</span>
<span class="line-added">181         return codecName == &quot;avc1&quot; || codecName == &quot;avc3&quot;;</span>
<span class="line-added">182     return codecName == &quot;hvc1&quot; || codecName == &quot;hev1&quot;;</span>
<span class="line-added">183 }</span>
<span class="line-added">184 </span>
<span class="line-added">185 Optional&lt;DoViParameterSet&gt; parseDoViCodecParameters(const String&amp; codecString)</span>
<span class="line-added">186 {</span>
<span class="line-added">187     // The format of the DoVi codec string is specified in &quot;Dolby Vision Profiles and Levels Version 1.3.2&quot;</span>
<span class="line-added">188     StringView codecView(codecString);</span>
<span class="line-added">189     auto codecSplit = codecView.split(&#39;.&#39;);</span>
<span class="line-added">190     auto nextElement = codecSplit.begin();</span>
<span class="line-added">191     if (nextElement == codecSplit.end())</span>
<span class="line-added">192         return WTF::nullopt;</span>
<span class="line-added">193 </span>
<span class="line-added">194     DoViParameterSet parameters;</span>
<span class="line-added">195 </span>
<span class="line-added">196     parameters.codecName = codecStringForDoViCodecType((*nextElement).toString());</span>
<span class="line-added">197     if (!parameters.codecName)</span>
<span class="line-added">198         return WTF::nullopt;</span>
<span class="line-added">199 </span>
<span class="line-added">200     if (++nextElement == codecSplit.end())</span>
<span class="line-added">201         return WTF::nullopt;</span>
<span class="line-added">202 </span>
<span class="line-added">203     auto profileID = *nextElement;</span>
<span class="line-added">204     if (!profileID.length())</span>
<span class="line-added">205         return WTF::nullopt;</span>
<span class="line-added">206 </span>
<span class="line-added">207     bool isIntegral = false;</span>
<span class="line-added">208     auto firstCharacter = profileID[0];</span>
<span class="line-added">209     // Profile definition can either be numeric or alpha:</span>
<span class="line-added">210     if (firstCharacter == &#39;0&#39;) {</span>
<span class="line-added">211         parameters.bitstreamProfileID = toIntegralType&lt;uint8_t&gt;(profileID, &amp;isIntegral, 10);</span>
<span class="line-added">212         if (!isIntegral)</span>
<span class="line-added">213             return WTF::nullopt;</span>
<span class="line-added">214     } else {</span>
<span class="line-added">215         auto alphanumericProfileString = codecView.left(5 + profileID.length()).toString();</span>
<span class="line-added">216         auto profileID = profileIDForAlphabeticDoViProfile(alphanumericProfileString);</span>
<span class="line-added">217         if (!profileID)</span>
<span class="line-added">218             return WTF::nullopt;</span>
<span class="line-added">219         parameters.bitstreamProfileID = profileID.value();</span>
<span class="line-added">220     }</span>
<span class="line-added">221 </span>
<span class="line-added">222     if (!isValidDoViProfileID(parameters.bitstreamProfileID))</span>
<span class="line-added">223         return WTF::nullopt;</span>
<span class="line-added">224 </span>
<span class="line-added">225     if (!isValidProfileIDForCodecName(parameters.bitstreamProfileID, parameters.codecName))</span>
<span class="line-added">226         return WTF::nullopt;</span>
<span class="line-added">227 </span>
<span class="line-added">228     if (++nextElement == codecSplit.end())</span>
<span class="line-added">229         return WTF::nullopt;</span>
<span class="line-added">230 </span>
<span class="line-added">231     auto levelID = *nextElement;</span>
<span class="line-added">232     if (!levelID.length())</span>
<span class="line-added">233         return WTF::nullopt;</span>
<span class="line-added">234 </span>
<span class="line-added">235     parameters.bitstreamLevelID = toIntegralType&lt;uint8_t&gt;(levelID, &amp;isIntegral, 10);</span>
<span class="line-added">236     if (!isIntegral)</span>
<span class="line-added">237         return WTF::nullopt;</span>
<span class="line-added">238 </span>
<span class="line-added">239     auto maximumLevelID = maximumLevelIDForDoViProfileID(parameters.bitstreamProfileID);</span>
<span class="line-added">240     if (!maximumLevelID || parameters.bitstreamLevelID &gt; maximumLevelID.value())</span>
<span class="line-added">241         return WTF::nullopt;</span>
<span class="line-added">242 </span>
<span class="line-added">243     return parameters;</span>
<span class="line-added">244 }</span>
<span class="line-added">245 </span>
246 }
<a name="3" id="anc3"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="3" type="hidden" />
</body>
</html>