<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WebCore/Modules/mediastream/RTCDataChannel.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="RTCDTMFToneChangeEvent.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="RTCDataChannel.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/Modules/mediastream/RTCDataChannel.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -27,17 +27,14 @@</span>
  #include &quot;RTCDataChannel.h&quot;
  
  #if ENABLE(WEB_RTC)
  
  #include &quot;Blob.h&quot;
<span class="udiff-line-removed">- #include &quot;Event.h&quot;</span>
  #include &quot;EventNames.h&quot;
  #include &quot;MessageEvent.h&quot;
<span class="udiff-line-removed">- #include &quot;RTCDataChannelHandler.h&quot;</span>
  #include &quot;ScriptExecutionContext.h&quot;
  #include &quot;SharedBuffer.h&quot;
<span class="udiff-line-removed">- #include &lt;JavaScriptCore/ArrayBuffer.h&gt;</span>
  #include &lt;JavaScriptCore/ArrayBufferView.h&gt;
  #include &lt;wtf/IsoMallocInlines.h&gt;
  #include &lt;wtf/NeverDestroyed.h&gt;
  
  namespace WebCore {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -54,26 +51,41 @@</span>
  {
      static NeverDestroyed&lt;AtomString&gt; arraybuffer(&quot;arraybuffer&quot;, AtomString::ConstructFromLiteral);
      return arraybuffer;
  }
  
<span class="udiff-line-modified-removed">- Ref&lt;RTCDataChannel&gt; RTCDataChannel::create(ScriptExecutionContext&amp; context, std::unique_ptr&lt;RTCDataChannelHandler&gt;&amp;&amp; handler, String&amp;&amp; label, RTCDataChannelInit&amp;&amp; options)</span>
<span class="udiff-line-modified-added">+ Ref&lt;RTCDataChannel&gt; RTCDataChannel::create(Document&amp; document, std::unique_ptr&lt;RTCDataChannelHandler&gt;&amp;&amp; handler, String&amp;&amp; label, RTCDataChannelInit&amp;&amp; options)</span>
  {
      ASSERT(handler);
<span class="udiff-line-modified-removed">-     auto channel = adoptRef(*new RTCDataChannel(context, WTFMove(handler), WTFMove(label), WTFMove(options)));</span>
<span class="udiff-line-modified-added">+     auto channel = adoptRef(*new RTCDataChannel(document, WTFMove(handler), WTFMove(label), WTFMove(options)));</span>
      channel-&gt;suspendIfNeeded();
      channel-&gt;m_handler-&gt;setClient(channel.get());
      channel-&gt;setPendingActivity(channel.get());
      return channel;
  }
  
<span class="udiff-line-modified-removed">- RTCDataChannel::RTCDataChannel(ScriptExecutionContext&amp; context, std::unique_ptr&lt;RTCDataChannelHandler&gt;&amp;&amp; handler, String&amp;&amp; label, RTCDataChannelInit&amp;&amp; options)</span>
<span class="udiff-line-modified-removed">-     : ActiveDOMObject(&amp;context)</span>
<span class="udiff-line-modified-added">+ NetworkSendQueue RTCDataChannel::createMessageQueue(Document&amp; document, RTCDataChannel&amp; channel)</span>
<span class="udiff-line-modified-added">+ {</span>
<span class="udiff-line-added">+     return { document, [&amp;channel](const String&amp; data) {</span>
<span class="udiff-line-added">+         if (!channel.m_handler-&gt;sendStringData(data))</span>
<span class="udiff-line-added">+             channel.scriptExecutionContext()-&gt;addConsoleMessage(MessageSource::JS, MessageLevel::Error, &quot;Error sending string through RTCDataChannel.&quot;_s);</span>
<span class="udiff-line-added">+     }, [&amp;channel](auto* data, size_t length) {</span>
<span class="udiff-line-added">+         if (!channel.m_handler-&gt;sendRawData(data, length))</span>
<span class="udiff-line-added">+             channel.scriptExecutionContext()-&gt;addConsoleMessage(MessageSource::JS, MessageLevel::Error, &quot;Error sending binary data through RTCDataChannel.&quot;_s);</span>
<span class="udiff-line-added">+     }, [&amp;channel](int errorCode) {</span>
<span class="udiff-line-added">+         if (auto* context = channel.scriptExecutionContext())</span>
<span class="udiff-line-added">+             context-&gt;addConsoleMessage(MessageSource::JS, MessageLevel::Error, makeString(&quot;Error &quot;, errorCode, &quot; in retrieving a blob data to be sent through RTCDataChannel.&quot;));</span>
<span class="udiff-line-added">+         return NetworkSendQueue::Continue::Yes;</span>
<span class="udiff-line-added">+     } };</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ RTCDataChannel::RTCDataChannel(Document&amp; document, std::unique_ptr&lt;RTCDataChannelHandler&gt;&amp;&amp; handler, String&amp;&amp; label, RTCDataChannelInit&amp;&amp; options)</span>
<span class="udiff-line-added">+     : ActiveDOMObject(document)</span>
      , m_handler(WTFMove(handler))
<span class="udiff-line-removed">-     , m_scheduledEventTimer(*this, &amp;RTCDataChannel::scheduledEventTimerFired)</span>
      , m_label(WTFMove(label))
      , m_options(WTFMove(options))
<span class="udiff-line-added">+     , m_messageQueue(createMessageQueue(document, *this))</span>
  {
  }
  
  size_t RTCDataChannel::bufferedAmount() const
  {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -112,59 +124,51 @@</span>
  ExceptionOr&lt;void&gt; RTCDataChannel::send(const String&amp; data)
  {
      if (m_readyState != RTCDataChannelState::Open)
          return Exception { InvalidStateError };
  
<span class="udiff-line-modified-removed">-     if (!m_handler-&gt;sendStringData(data)) {</span>
<span class="udiff-line-removed">-         // FIXME: Decide what the right exception here is.</span>
<span class="udiff-line-removed">-         return Exception { SyntaxError };</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-modified-added">+     m_messageQueue.enqueue(data);</span>
      return { };
  }
  
<span class="udiff-line-modified-removed">- ExceptionOr&lt;void&gt; RTCDataChannel::sendRawData(const char* data, size_t length)</span>
<span class="udiff-line-modified-added">+ ExceptionOr&lt;void&gt; RTCDataChannel::send(ArrayBuffer&amp; data)</span>
  {
      if (m_readyState != RTCDataChannelState::Open)
          return Exception { InvalidStateError };
  
<span class="udiff-line-modified-removed">-     if (!length)</span>
<span class="udiff-line-removed">-         return { };</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     if (!m_handler-&gt;sendRawData(data, length)) {</span>
<span class="udiff-line-removed">-         // FIXME: Decide what the right exception here is.</span>
<span class="udiff-line-removed">-         return Exception { SyntaxError };</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-modified-added">+     m_messageQueue.enqueue(data, 0, data.byteLength());</span>
      return { };
  }
  
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- ExceptionOr&lt;void&gt; RTCDataChannel::send(ArrayBuffer&amp; data)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-     return sendRawData(static_cast&lt;const char*&gt;(data.data()), data.byteLength());</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
  ExceptionOr&lt;void&gt; RTCDataChannel::send(ArrayBufferView&amp; data)
  {
<span class="udiff-line-modified-removed">-     return sendRawData(static_cast&lt;const char*&gt;(data.baseAddress()), data.byteLength());</span>
<span class="udiff-line-modified-added">+     if (m_readyState != RTCDataChannelState::Open)</span>
<span class="udiff-line-added">+         return Exception { InvalidStateError };</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     m_messageQueue.enqueue(*data.unsharedBuffer(), data.byteOffset(), data.byteLength());</span>
<span class="udiff-line-added">+     return { };</span>
  }
  
<span class="udiff-line-modified-removed">- ExceptionOr&lt;void&gt; RTCDataChannel::send(Blob&amp;)</span>
<span class="udiff-line-modified-added">+ ExceptionOr&lt;void&gt; RTCDataChannel::send(Blob&amp; blob)</span>
  {
<span class="udiff-line-modified-removed">-     // FIXME: Implement.</span>
<span class="udiff-line-modified-removed">-     return Exception { NotSupportedError };</span>
<span class="udiff-line-modified-added">+     if (m_readyState != RTCDataChannelState::Open)</span>
<span class="udiff-line-modified-added">+         return Exception { InvalidStateError };</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     m_messageQueue.enqueue(blob);</span>
<span class="udiff-line-added">+     return { };</span>
  }
  
  void RTCDataChannel::close()
  {
      if (m_stopped)
          return;
  
      m_stopped = true;
      m_readyState = RTCDataChannelState::Closed;
  
<span class="udiff-line-added">+     m_messageQueue.clear();</span>
<span class="udiff-line-added">+ </span>
      m_handler-&gt;close();
      m_handler = nullptr;
      unsetPendingActivity(*this);
  }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -187,72 +191,49 @@</span>
      }
  }
  
  void RTCDataChannel::didReceiveStringData(const String&amp; text)
  {
<span class="udiff-line-removed">-     if (m_stopped)</span>
<span class="udiff-line-removed">-         return;</span>
<span class="udiff-line-removed">- </span>
      scheduleDispatchEvent(MessageEvent::create(text));
  }
  
  void RTCDataChannel::didReceiveRawData(const char* data, size_t dataLength)
  {
<span class="udiff-line-removed">-     if (m_stopped)</span>
<span class="udiff-line-removed">-         return;</span>
<span class="udiff-line-removed">- </span>
      switch (m_binaryType) {
      case BinaryType::Blob:
<span class="udiff-line-modified-removed">-         scheduleDispatchEvent(MessageEvent::create(Blob::create(scriptExecutionContext()-&gt;sessionID(), SharedBuffer::create(data, dataLength), emptyString()), { }));</span>
<span class="udiff-line-modified-added">+         scheduleDispatchEvent(MessageEvent::create(Blob::create(SharedBuffer::create(data, dataLength), emptyString()), { }));</span>
          return;
      case BinaryType::ArrayBuffer:
          scheduleDispatchEvent(MessageEvent::create(ArrayBuffer::create(data, dataLength)));
          return;
      }
      ASSERT_NOT_REACHED();
  }
  
  void RTCDataChannel::didDetectError()
  {
<span class="udiff-line-removed">-     if (m_stopped)</span>
<span class="udiff-line-removed">-         return;</span>
<span class="udiff-line-removed">- </span>
      scheduleDispatchEvent(Event::create(eventNames().errorEvent, Event::CanBubble::No, Event::IsCancelable::No));
  }
  
  void RTCDataChannel::bufferedAmountIsDecreasing(size_t amount)
  {
<span class="udiff-line-removed">-     if (m_stopped)</span>
<span class="udiff-line-removed">-         return;</span>
<span class="udiff-line-removed">- </span>
      if (amount &lt;= m_bufferedAmountLowThreshold)
          scheduleDispatchEvent(Event::create(eventNames().bufferedamountlowEvent, Event::CanBubble::No, Event::IsCancelable::No));
  }
  
  void RTCDataChannel::stop()
  {
      close();
  }
  
  void RTCDataChannel::scheduleDispatchEvent(Ref&lt;Event&gt;&amp;&amp; event)
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-     m_scheduledEvents.append(WTFMove(event));</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     if (!m_scheduledEventTimer.isActive())</span>
<span class="udiff-line-removed">-         m_scheduledEventTimer.startOneShot(0_s);</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- void RTCDataChannel::scheduledEventTimerFired()</span>
  {
      if (m_stopped)
          return;
  
<span class="udiff-line-modified-removed">-     Vector&lt;Ref&lt;Event&gt;&gt; events;</span>
<span class="udiff-line-modified-removed">-     events.swap(m_scheduledEvents);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     for (auto&amp; event : events)</span>
<span class="udiff-line-removed">-         dispatchEvent(event);</span>
<span class="udiff-line-modified-added">+     // https://w3c.github.io/webrtc-pc/#operation</span>
<span class="udiff-line-modified-added">+     queueTaskToDispatchEvent(*this, TaskSource::Networking, WTFMove(event));</span>
  }
  
  } // namespace WebCore
  
  #endif // ENABLE(WEB_RTC)
</pre>
<center><a href="RTCDTMFToneChangeEvent.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="RTCDataChannel.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>