<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New modules/javafx.web/src/main/native/Source/WebCore/Modules/webauthn/fido/Pin.h</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 // Copyright 2019 The Chromium Authors. All rights reserved.
  2 // Copyright (C) 2019 Apple Inc. All rights reserved.
  3 //
  4 // Redistribution and use in source and binary forms, with or without
  5 // modification, are permitted provided that the following conditions are
  6 // met:
  7 //
  8 //    * Redistributions of source code must retain the above copyright
  9 // notice, this list of conditions and the following disclaimer.
 10 //    * Redistributions in binary form must reproduce the above
 11 // copyright notice, this list of conditions and the following disclaimer
 12 // in the documentation and/or other materials provided with the
 13 // distribution.
 14 //    * Neither the name of Google Inc. nor the names of its
 15 // contributors may be used to endorse or promote products derived from
 16 // this software without specific prior written permission.
 17 //
 18 // THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 19 // &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 20 // LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 21 // A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 22 // OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 23 // SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 24 // LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 25 // DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 26 // THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 27 // (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 28 // OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 29 
 30 // This file contains structures to implement the CTAP2 PIN protocol, version
 31 // one. See
 32 // https://fidoalliance.org/specs/fido-v2.0-rd-20180702/fido-client-to-authenticator-protocol-v2.0-rd-20180702.html#authenticatorClientPIN
 33 
 34 #pragma once
 35 
 36 #if ENABLE(WEB_AUTHN)
 37 
 38 #include &quot;CBORValue.h&quot;
 39 #include &quot;FidoConstants.h&quot;
 40 
 41 namespace WebCore {
 42 class CryptoKeyAES;
 43 class CryptoKeyEC;
 44 class CryptoKeyHMAC;
 45 }
 46 
 47 namespace fido {
 48 namespace pin {
 49 
 50 // Subcommand enumerates the subcommands to the main |authenticatorClientPIN|
 51 // command. See
 52 // https://fidoalliance.org/specs/fido-v2.0-rd-20180702/fido-client-to-authenticator-protocol-v2.0-rd-20180702.html#authenticatorClientPIN
 53 enum class Subcommand : uint8_t {
 54     kGetRetries = 0x01,
 55     kGetKeyAgreement = 0x02,
 56     kSetPin = 0x03,
 57     kChangePin = 0x04,
 58     kGetPinToken = 0x05,
 59 };
 60 
 61 // RequestKey enumerates the keys in the top-level CBOR map for all PIN
 62 // commands.
 63 enum class RequestKey : uint8_t {
 64     kProtocol = 1,
 65     kSubcommand = 2,
 66     kKeyAgreement = 3,
 67     kPinAuth = 4,
 68     kNewPinEnc = 5,
 69     kPinHashEnc = 6,
 70 };
 71 
 72 // ResponseKey enumerates the keys in the top-level CBOR map for all PIN
 73 // responses.
 74 enum class ResponseKey : uint8_t {
 75     kKeyAgreement = 1,
 76     kPinToken = 2,
 77     kRetries = 3,
 78 };
 79 
 80 // kProtocolVersion is the version of the PIN protocol that this code
 81 // implements.
 82 constexpr int64_t kProtocolVersion = 1;
 83 
 84 // encodeCOSEPublicKey takes a raw ECDH256 public key and returns it as a COSE structure.
 85 WEBCORE_EXPORT cbor::CBORValue::MapValue encodeCOSEPublicKey(const Vector&lt;uint8_t&gt;&amp; key);
 86 
 87 // encodeRawPublicKey takes X &amp; Y and returns them as a 0x04 || X || Y byte array.
 88 WEBCORE_EXPORT Vector&lt;uint8_t&gt; encodeRawPublicKey(const Vector&lt;uint8_t&gt;&amp; X, const Vector&lt;uint8_t&gt;&amp; Y);
 89 
 90 // validateAndConvertToUTF8 convert the input to a UTF8 CString if it is a syntactically valid PIN.
 91 WEBCORE_EXPORT Optional&lt;CString&gt; validateAndConvertToUTF8(const String&amp; pin);
 92 
 93 // kMinBytes is the minimum number of *bytes* of PIN data that a CTAP2 device
 94 // will accept. Since the PIN is UTF-8 encoded, this could be a single code
 95 // point. However, the platform is supposed to additionally enforce a 4
 96 // *character* minimum
 97 constexpr size_t kMinBytes = 4;
 98 // kMaxBytes is the maximum number of bytes of PIN data that a CTAP2 device will
 99 // accept.
100 constexpr size_t kMaxBytes = 63;
101 
102 // RetriesRequest asks an authenticator for the number of remaining PIN attempts
103 // before the device is locked.
104 struct RetriesRequest {
105 };
106 
107 // RetriesResponse reflects an authenticator&#39;s response to a |RetriesRequest|.
108 struct RetriesResponse {
109     WEBCORE_EXPORT static Optional&lt;RetriesResponse&gt; parse(const Vector&lt;uint8_t&gt;&amp;);
110 
111     // retries is the number of PIN attempts remaining before the authenticator
112     // locks.
113     uint64_t retries;
114 
115 private:
116     RetriesResponse();
117 };
118 
119 // KeyAgreementRequest asks an authenticator for an ephemeral ECDH key for
120 // encrypting PIN material in future requests.
121 struct KeyAgreementRequest {
122 };
123 
124 // KeyAgreementResponse reflects an authenticator&#39;s response to a
125 // |KeyAgreementRequest| and is also used as representation of the
126 // authenticator&#39;s ephemeral key.
127 struct KeyAgreementResponse {
128     WEBCORE_EXPORT static Optional&lt;KeyAgreementResponse&gt; parse(const Vector&lt;uint8_t&gt;&amp;);
129     WEBCORE_EXPORT static Optional&lt;KeyAgreementResponse&gt; parseFromCOSE(const cbor::CBORValue::MapValue&amp;);
130 
131     Ref&lt;WebCore::CryptoKeyEC&gt; peerKey;
132 
133 private:
134     explicit KeyAgreementResponse(Ref&lt;WebCore::CryptoKeyEC&gt;&amp;&amp;);
135 };
136 
137 // TokenRequest requests a pin-token from an authenticator. These tokens can be
138 // used to show user-verification in other operations, e.g. when getting an
139 // assertion.
140 class TokenRequest {
141     WTF_MAKE_NONCOPYABLE(TokenRequest);
142 public:
143     WEBCORE_EXPORT static Optional&lt;TokenRequest&gt; tryCreate(const CString&amp; pin, const WebCore::CryptoKeyEC&amp;);
144     TokenRequest(TokenRequest&amp;&amp;) = default;
145 
146     // sharedKey returns the shared ECDH key that was used to encrypt the PIN.
147     // This is needed to decrypt the response.
148     WEBCORE_EXPORT const WebCore::CryptoKeyAES&amp; sharedKey() const;
149 
150     friend Vector&lt;uint8_t&gt; encodeAsCBOR(const TokenRequest&amp;);
151 
152 private:
153     TokenRequest(Ref&lt;WebCore::CryptoKeyAES&gt;&amp;&amp; sharedKey, cbor::CBORValue::MapValue&amp;&amp; coseKey, Vector&lt;uint8_t&gt;&amp;&amp; pinHash);
154 
155     Ref&lt;WebCore::CryptoKeyAES&gt; m_sharedKey;
156     mutable cbor::CBORValue::MapValue m_coseKey;
157     Vector&lt;uint8_t&gt; m_pinHash; // Only the left 16 bytes are kept.
158 };
159 
160 // TokenResponse represents the response to a pin-token request. In order to
161 // decrypt a response, the shared key from the request is needed. Once a pin-
162 // token has been decrypted, it can be used to calculate the pinAuth parameters
163 // needed to show user-verification in future operations.
164 class TokenResponse {
165 public:
166     WEBCORE_EXPORT static Optional&lt;TokenResponse&gt; parse(const WebCore::CryptoKeyAES&amp; sharedKey, const Vector&lt;uint8_t&gt;&amp; inBuffer);
167 
168     // pinAuth returns a pinAuth parameter for a request that will use the given
169     // client-data hash.
170     WEBCORE_EXPORT Vector&lt;uint8_t&gt; pinAuth(const Vector&lt;uint8_t&gt;&amp; clientDataHash) const;
171 
172     WEBCORE_EXPORT const Vector&lt;uint8_t&gt;&amp; token() const;
173 
174 private:
175     explicit TokenResponse(Ref&lt;WebCore::CryptoKeyHMAC&gt;&amp;&amp;);
176 
177     Ref&lt;WebCore::CryptoKeyHMAC&gt; m_token;
178 };
179 
180 WEBCORE_EXPORT Vector&lt;uint8_t&gt; encodeAsCBOR(const RetriesRequest&amp;);
181 WEBCORE_EXPORT Vector&lt;uint8_t&gt; encodeAsCBOR(const KeyAgreementRequest&amp;);
182 WEBCORE_EXPORT Vector&lt;uint8_t&gt; encodeAsCBOR(const TokenRequest&amp;);
183 
184 } // namespace pin
185 } // namespace fido
186 
187 #endif // ENABLE(WEB_AUTHN)
    </pre>
  </body>
</html>