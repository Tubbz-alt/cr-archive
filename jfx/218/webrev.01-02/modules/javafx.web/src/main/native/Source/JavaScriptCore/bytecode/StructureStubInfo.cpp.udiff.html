<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/JavaScriptCore/bytecode/StructureStubInfo.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="StructureStubClearingWatchpoint.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="StructureStubInfo.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/JavaScriptCore/bytecode/StructureStubInfo.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (C) 2008-2019 Apple Inc. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (C) 2008-2020 Apple Inc. All rights reserved.</span>
   *
   * Redistribution and use in source and binary forms, with or without
   * modification, are permitted provided that the following conditions
   * are met:
   * 1. Redistributions of source code must retain the above copyright
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -24,83 +24,90 @@</span>
   */
  
  #include &quot;config.h&quot;
  #include &quot;StructureStubInfo.h&quot;
  
<span class="udiff-line-added">+ #include &quot;CacheableIdentifierInlines.h&quot;</span>
  #include &quot;JSObject.h&quot;
  #include &quot;JSCInlines.h&quot;
  #include &quot;PolymorphicAccess.h&quot;
  #include &quot;Repatch.h&quot;
  
  namespace JSC {
  
  #if ENABLE(JIT)
  
  namespace StructureStubInfoInternal {
<span class="udiff-line-modified-removed">- static const bool verbose = false;</span>
<span class="udiff-line-modified-added">+ static constexpr bool verbose = false;</span>
  }
  
  StructureStubInfo::StructureStubInfo(AccessType accessType)
<span class="udiff-line-modified-removed">-     : callSiteIndex(UINT_MAX)</span>
<span class="udiff-line-modified-removed">-     , accessType(accessType)</span>
<span class="udiff-line-removed">-     , cacheType(CacheType::Unset)</span>
<span class="udiff-line-modified-added">+     : accessType(accessType)</span>
<span class="udiff-line-modified-added">+     , m_cacheType(CacheType::Unset)</span>
      , countdown(1) // For a totally clear stub, we&#39;ll patch it after the first execution.
      , repatchCount(0)
      , numberOfCoolDowns(0)
      , bufferingCountdown(Options::repatchBufferingCountdown())
      , resetByGC(false)
      , tookSlowPath(false)
      , everConsidered(false)
      , prototypeIsKnownObject(false)
      , sawNonCell(false)
<span class="udiff-line-added">+     , hasConstantIdentifier(true)</span>
<span class="udiff-line-added">+     , propertyIsString(false)</span>
<span class="udiff-line-added">+     , propertyIsInt32(false)</span>
<span class="udiff-line-added">+     , propertyIsSymbol(false)</span>
  {
  }
  
  StructureStubInfo::~StructureStubInfo()
  {
  }
  
<span class="udiff-line-modified-removed">- void StructureStubInfo::initGetByIdSelf(CodeBlock* codeBlock, Structure* baseObjectStructure, PropertyOffset offset)</span>
<span class="udiff-line-modified-added">+ void StructureStubInfo::initGetByIdSelf(CodeBlock* codeBlock, Structure* baseObjectStructure, PropertyOffset offset, CacheableIdentifier identifier)</span>
  {
<span class="udiff-line-modified-removed">-     cacheType = CacheType::GetByIdSelf;</span>
<span class="udiff-line-modified-added">+     ASSERT(hasConstantIdentifier);</span>
<span class="udiff-line-added">+     setCacheType(CacheType::GetByIdSelf);</span>
<span class="udiff-line-added">+     m_getByIdSelfIdentifier = identifier;</span>
<span class="udiff-line-added">+     codeBlock-&gt;vm().heap.writeBarrier(codeBlock);</span>
  
      u.byIdSelf.baseObjectStructure.set(
          codeBlock-&gt;vm(), codeBlock, baseObjectStructure);
      u.byIdSelf.offset = offset;
  }
  
  void StructureStubInfo::initArrayLength()
  {
<span class="udiff-line-modified-removed">-     cacheType = CacheType::ArrayLength;</span>
<span class="udiff-line-modified-added">+     setCacheType(CacheType::ArrayLength);</span>
  }
  
  void StructureStubInfo::initStringLength()
  {
<span class="udiff-line-modified-removed">-     cacheType = CacheType::StringLength;</span>
<span class="udiff-line-modified-added">+     setCacheType(CacheType::StringLength);</span>
  }
  
  void StructureStubInfo::initPutByIdReplace(CodeBlock* codeBlock, Structure* baseObjectStructure, PropertyOffset offset)
  {
<span class="udiff-line-modified-removed">-     cacheType = CacheType::PutByIdReplace;</span>
<span class="udiff-line-modified-added">+     setCacheType(CacheType::PutByIdReplace);</span>
  
      u.byIdSelf.baseObjectStructure.set(
          codeBlock-&gt;vm(), codeBlock, baseObjectStructure);
      u.byIdSelf.offset = offset;
  }
  
  void StructureStubInfo::initInByIdSelf(CodeBlock* codeBlock, Structure* baseObjectStructure, PropertyOffset offset)
  {
<span class="udiff-line-modified-removed">-     cacheType = CacheType::InByIdSelf;</span>
<span class="udiff-line-modified-added">+     setCacheType(CacheType::InByIdSelf);</span>
  
      u.byIdSelf.baseObjectStructure.set(
          codeBlock-&gt;vm(), codeBlock, baseObjectStructure);
      u.byIdSelf.offset = offset;
  }
  
  void StructureStubInfo::deref()
  {
<span class="udiff-line-modified-removed">-     switch (cacheType) {</span>
<span class="udiff-line-modified-added">+     switch (m_cacheType) {</span>
      case CacheType::Stub:
          delete u.stub;
          return;
      case CacheType::Unset:
      case CacheType::GetByIdSelf:
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -114,11 +121,11 @@</span>
      RELEASE_ASSERT_NOT_REACHED();
  }
  
  void StructureStubInfo::aboutToDie()
  {
<span class="udiff-line-modified-removed">-     switch (cacheType) {</span>
<span class="udiff-line-modified-added">+     switch (m_cacheType) {</span>
      case CacheType::Stub:
          u.stub-&gt;aboutToDie();
          return;
      case CacheType::Unset:
      case CacheType::GetByIdSelf:
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -131,12 +138,14 @@</span>
  
      RELEASE_ASSERT_NOT_REACHED();
  }
  
  AccessGenerationResult StructureStubInfo::addAccessCase(
<span class="udiff-line-modified-removed">-     const GCSafeConcurrentJSLocker&amp; locker, CodeBlock* codeBlock, const Identifier&amp; ident, std::unique_ptr&lt;AccessCase&gt; accessCase)</span>
<span class="udiff-line-modified-added">+     const GCSafeConcurrentJSLocker&amp; locker, CodeBlock* codeBlock, CacheableIdentifier ident, std::unique_ptr&lt;AccessCase&gt; accessCase)</span>
  {
<span class="udiff-line-added">+     checkConsistency();</span>
<span class="udiff-line-added">+ </span>
      VM&amp; vm = codeBlock-&gt;vm();
      ASSERT(vm.heap.isDeferred());
      AccessGenerationResult result = ([&amp;] () -&gt; AccessGenerationResult {
          if (StructureStubInfoInternal::verbose)
              dataLog(&quot;Adding access case: &quot;, accessCase, &quot;\n&quot;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -144,12 +153,12 @@</span>
          if (!accessCase)
              return AccessGenerationResult::GaveUp;
  
          AccessGenerationResult result;
  
<span class="udiff-line-modified-removed">-         if (cacheType == CacheType::Stub) {</span>
<span class="udiff-line-modified-removed">-             result = u.stub-&gt;addCase(locker, vm, codeBlock, *this, ident, WTFMove(accessCase));</span>
<span class="udiff-line-modified-added">+         if (m_cacheType == CacheType::Stub) {</span>
<span class="udiff-line-modified-added">+             result = u.stub-&gt;addCase(locker, vm, codeBlock, *this, WTFMove(accessCase));</span>
  
              if (StructureStubInfoInternal::verbose)
                  dataLog(&quot;Had stub, result: &quot;, result, &quot;\n&quot;);
  
              if (result.shouldResetStubAndFireWatchpoints())
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -162,18 +171,17 @@</span>
          } else {
              std::unique_ptr&lt;PolymorphicAccess&gt; access = makeUnique&lt;PolymorphicAccess&gt;();
  
              Vector&lt;std::unique_ptr&lt;AccessCase&gt;, 2&gt; accessCases;
  
<span class="udiff-line-modified-removed">-             std::unique_ptr&lt;AccessCase&gt; previousCase =</span>
<span class="udiff-line-removed">-                 AccessCase::fromStructureStubInfo(vm, codeBlock, *this);</span>
<span class="udiff-line-modified-added">+             std::unique_ptr&lt;AccessCase&gt; previousCase = AccessCase::fromStructureStubInfo(vm, codeBlock, ident, *this);</span>
              if (previousCase)
                  accessCases.append(WTFMove(previousCase));
  
              accessCases.append(WTFMove(accessCase));
  
<span class="udiff-line-modified-removed">-             result = access-&gt;addCases(locker, vm, codeBlock, *this, ident, WTFMove(accessCases));</span>
<span class="udiff-line-modified-added">+             result = access-&gt;addCases(locker, vm, codeBlock, *this, WTFMove(accessCases));</span>
  
              if (StructureStubInfoInternal::verbose)
                  dataLog(&quot;Created stub, result: &quot;, result, &quot;\n&quot;);
  
              if (result.shouldResetStubAndFireWatchpoints())
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -182,14 +190,15 @@</span>
              if (!result.buffered()) {
                  bufferedStructures.clear();
                  return result;
              }
  
<span class="udiff-line-modified-removed">-             cacheType = CacheType::Stub;</span>
<span class="udiff-line-modified-added">+             setCacheType(CacheType::Stub);</span>
              u.stub = access.release();
          }
  
<span class="udiff-line-added">+         ASSERT(m_cacheType == CacheType::Stub);</span>
          RELEASE_ASSERT(!result.generatedSomeCode());
  
          // If we didn&#39;t buffer any cases then bail. If this made no changes then we&#39;ll just try again
          // subject to cool-down.
          if (!result.buffered()) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -208,11 +217,11 @@</span>
  
          // Forget the buffered structures so that all future attempts to cache get fully handled by the
          // PolymorphicAccess.
          bufferedStructures.clear();
  
<span class="udiff-line-modified-removed">-         result = u.stub-&gt;regenerate(locker, vm, codeBlock, *this, ident);</span>
<span class="udiff-line-modified-added">+         result = u.stub-&gt;regenerate(locker, vm, codeBlock, *this);</span>
  
          if (StructureStubInfoInternal::verbose)
              dataLog(&quot;Regeneration result: &quot;, result, &quot;\n&quot;);
  
          RELEASE_ASSERT(!result.buffered());
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -231,31 +240,34 @@</span>
  
  void StructureStubInfo::reset(CodeBlock* codeBlock)
  {
      bufferedStructures.clear();
  
<span class="udiff-line-modified-removed">-     if (cacheType == CacheType::Unset)</span>
<span class="udiff-line-modified-added">+     if (m_cacheType == CacheType::Unset)</span>
          return;
  
      if (Options::verboseOSR()) {
          // This can be called from GC destructor calls, so we don&#39;t try to do a full dump
          // of the CodeBlock.
          dataLog(&quot;Clearing structure cache (kind &quot;, static_cast&lt;int&gt;(accessType), &quot;) in &quot;, RawPointer(codeBlock), &quot;.\n&quot;);
      }
  
      switch (accessType) {
<span class="udiff-line-modified-removed">-     case AccessType::TryGet:</span>
<span class="udiff-line-modified-removed">-         resetGetByID(codeBlock, *this, GetByIDKind::Try);</span>
<span class="udiff-line-modified-added">+     case AccessType::TryGetById:</span>
<span class="udiff-line-modified-added">+         resetGetBy(codeBlock, *this, GetByKind::Try);</span>
<span class="udiff-line-added">+         break;</span>
<span class="udiff-line-added">+     case AccessType::GetById:</span>
<span class="udiff-line-added">+         resetGetBy(codeBlock, *this, GetByKind::Normal);</span>
          break;
<span class="udiff-line-modified-removed">-     case AccessType::Get:</span>
<span class="udiff-line-modified-removed">-         resetGetByID(codeBlock, *this, GetByIDKind::Normal);</span>
<span class="udiff-line-modified-added">+     case AccessType::GetByIdWithThis:</span>
<span class="udiff-line-modified-added">+         resetGetBy(codeBlock, *this, GetByKind::WithThis);</span>
          break;
<span class="udiff-line-modified-removed">-     case AccessType::GetWithThis:</span>
<span class="udiff-line-modified-removed">-         resetGetByID(codeBlock, *this, GetByIDKind::WithThis);</span>
<span class="udiff-line-modified-added">+     case AccessType::GetByIdDirect:</span>
<span class="udiff-line-modified-added">+         resetGetBy(codeBlock, *this, GetByKind::Direct);</span>
          break;
<span class="udiff-line-modified-removed">-     case AccessType::GetDirect:</span>
<span class="udiff-line-modified-removed">-         resetGetByID(codeBlock, *this, GetByIDKind::Direct);</span>
<span class="udiff-line-modified-added">+     case AccessType::GetByVal:</span>
<span class="udiff-line-modified-added">+         resetGetBy(codeBlock, *this, GetByKind::NormalByVal);</span>
          break;
      case AccessType::Put:
          resetPutByID(codeBlock, *this);
          break;
      case AccessType::In:
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -265,23 +277,45 @@</span>
          resetInstanceOf(*this);
          break;
      }
  
      deref();
<span class="udiff-line-modified-removed">-     cacheType = CacheType::Unset;</span>
<span class="udiff-line-modified-added">+     setCacheType(CacheType::Unset);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void StructureStubInfo::visitAggregate(SlotVisitor&amp; visitor)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     switch (m_cacheType) {</span>
<span class="udiff-line-added">+     case CacheType::Unset:</span>
<span class="udiff-line-added">+     case CacheType::ArrayLength:</span>
<span class="udiff-line-added">+     case CacheType::StringLength:</span>
<span class="udiff-line-added">+     case CacheType::PutByIdReplace:</span>
<span class="udiff-line-added">+     case CacheType::InByIdSelf:</span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+     case CacheType::GetByIdSelf:</span>
<span class="udiff-line-added">+         m_getByIdSelfIdentifier.visitAggregate(visitor);</span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+     case CacheType::Stub:</span>
<span class="udiff-line-added">+         u.stub-&gt;visitAggregate(visitor);</span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     RELEASE_ASSERT_NOT_REACHED();</span>
<span class="udiff-line-added">+     return;</span>
  }
  
  void StructureStubInfo::visitWeakReferences(CodeBlock* codeBlock)
  {
      VM&amp; vm = codeBlock-&gt;vm();
  
<span class="udiff-line-modified-removed">-     bufferedStructures.genericFilter(</span>
<span class="udiff-line-modified-removed">-         [&amp;] (Structure* structure) -&gt; bool {</span>
<span class="udiff-line-modified-removed">-             return vm.heap.isMarked(structure);</span>
<span class="udiff-line-modified-added">+     bufferedStructures.removeIf(</span>
<span class="udiff-line-modified-added">+         [&amp;] (auto&amp; pair) -&gt; bool {</span>
<span class="udiff-line-modified-added">+             Structure* structure = pair.first;</span>
<span class="udiff-line-added">+             return !vm.heap.isMarked(structure);</span>
          });
  
<span class="udiff-line-modified-removed">-     switch (cacheType) {</span>
<span class="udiff-line-modified-added">+     switch (m_cacheType) {</span>
      case CacheType::GetByIdSelf:
      case CacheType::PutByIdReplace:
      case CacheType::InByIdSelf:
          if (vm.heap.isMarked(u.byIdSelf.baseObjectStructure.get()))
              return;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -298,11 +332,11 @@</span>
      resetByGC = true;
  }
  
  bool StructureStubInfo::propagateTransitions(SlotVisitor&amp; visitor)
  {
<span class="udiff-line-modified-removed">-     switch (cacheType) {</span>
<span class="udiff-line-modified-added">+     switch (m_cacheType) {</span>
      case CacheType::Unset:
      case CacheType::ArrayLength:
      case CacheType::StringLength:
          return true;
      case CacheType::GetByIdSelf:
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -315,19 +349,19 @@</span>
  
      RELEASE_ASSERT_NOT_REACHED();
      return true;
  }
  
<span class="udiff-line-modified-removed">- StubInfoSummary StructureStubInfo::summary() const</span>
<span class="udiff-line-modified-added">+ StubInfoSummary StructureStubInfo::summary(VM&amp; vm) const</span>
  {
      StubInfoSummary takesSlowPath = StubInfoSummary::TakesSlowPath;
      StubInfoSummary simple = StubInfoSummary::Simple;
<span class="udiff-line-modified-removed">-     if (cacheType == CacheType::Stub) {</span>
<span class="udiff-line-modified-added">+     if (m_cacheType == CacheType::Stub) {</span>
          PolymorphicAccess* list = u.stub;
          for (unsigned i = 0; i &lt; list-&gt;size(); ++i) {
              const AccessCase&amp; access = list-&gt;at(i);
<span class="udiff-line-modified-removed">-             if (access.doesCalls()) {</span>
<span class="udiff-line-modified-added">+             if (access.doesCalls(vm)) {</span>
                  takesSlowPath = StubInfoSummary::TakesSlowPathAndMakesCalls;
                  simple = StubInfoSummary::MakesCalls;
                  break;
              }
          }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -340,23 +374,41 @@</span>
          return StubInfoSummary::NoInformation;
  
      return simple;
  }
  
<span class="udiff-line-modified-removed">- StubInfoSummary StructureStubInfo::summary(const StructureStubInfo* stubInfo)</span>
<span class="udiff-line-modified-added">+ StubInfoSummary StructureStubInfo::summary(VM&amp; vm, const StructureStubInfo* stubInfo)</span>
  {
      if (!stubInfo)
          return StubInfoSummary::NoInformation;
  
<span class="udiff-line-modified-removed">-     return stubInfo-&gt;summary();</span>
<span class="udiff-line-modified-added">+     return stubInfo-&gt;summary(vm);</span>
  }
  
  bool StructureStubInfo::containsPC(void* pc) const
  {
<span class="udiff-line-modified-removed">-     if (cacheType != CacheType::Stub)</span>
<span class="udiff-line-modified-added">+     if (m_cacheType != CacheType::Stub)</span>
          return false;
      return u.stub-&gt;containsPC(pc);
  }
  
<span class="udiff-line-added">+ void StructureStubInfo::setCacheType(CacheType newCacheType)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     if (m_cacheType == CacheType::GetByIdSelf)</span>
<span class="udiff-line-added">+         m_getByIdSelfIdentifier = nullptr;</span>
<span class="udiff-line-added">+     m_cacheType = newCacheType;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ #if ASSERT_ENABLED</span>
<span class="udiff-line-added">+ void StructureStubInfo::checkConsistency()</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     if (thisValueIsInThisGPR()) {</span>
<span class="udiff-line-added">+         // We currently use a union for both &quot;thisGPR&quot; and &quot;propertyGPR&quot;. If this were</span>
<span class="udiff-line-added">+         // not the case, we&#39;d need to take one of them out of the union.</span>
<span class="udiff-line-added">+         RELEASE_ASSERT(hasConstantIdentifier);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ #endif // ASSERT_ENABLED</span>
<span class="udiff-line-added">+ </span>
  #endif // ENABLE(JIT)
  
  } // namespace JSC
</pre>
<center><a href="StructureStubClearingWatchpoint.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="StructureStubInfo.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>