<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WebCore/dom/ShadowRoot.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="SelectorQuery.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="ShadowRoot.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/dom/ShadowRoot.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -28,11 +28,15 @@</span>
  #include &quot;config.h&quot;
  #include &quot;ShadowRoot.h&quot;
  
  #include &quot;CSSStyleSheet.h&quot;
  #include &quot;ElementTraversal.h&quot;
<span class="udiff-line-added">+ #include &quot;HTMLParserIdioms.h&quot;</span>
  #include &quot;HTMLSlotElement.h&quot;
<span class="udiff-line-added">+ #if ENABLE(PICTURE_IN_PICTURE_API)</span>
<span class="udiff-line-added">+ #include &quot;NotImplemented.h&quot;</span>
<span class="udiff-line-added">+ #endif</span>
  #include &quot;RenderElement.h&quot;
  #include &quot;RuntimeEnabledFeatures.h&quot;
  #include &quot;SlotAssignment.h&quot;
  #include &quot;StyleResolver.h&quot;
  #include &quot;StyleScope.h&quot;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -43,22 +47,25 @@</span>
  namespace WebCore {
  
  WTF_MAKE_ISO_ALLOCATED_IMPL(ShadowRoot);
  
  struct SameSizeAsShadowRoot : public DocumentFragment, public TreeScope {
<span class="udiff-line-modified-removed">-     unsigned countersAndFlags[1];</span>
<span class="udiff-line-modified-added">+     bool flags[4];</span>
<span class="udiff-line-added">+     uint8_t mode;</span>
      void* styleScope;
      void* styleSheetList;
      void* host;
      void* slotAssignment;
<span class="udiff-line-added">+     Optional&lt;HashMap&lt;AtomString, AtomString&gt;&gt; partMappings;</span>
  };
  
  COMPILE_ASSERT(sizeof(ShadowRoot) == sizeof(SameSizeAsShadowRoot), shadowroot_should_stay_small);
  
<span class="udiff-line-modified-removed">- ShadowRoot::ShadowRoot(Document&amp; document, ShadowRootMode type)</span>
<span class="udiff-line-modified-added">+ ShadowRoot::ShadowRoot(Document&amp; document, ShadowRootMode type, DelegatesFocus delegatesFocus)</span>
      : DocumentFragment(document, CreateShadowRoot)
      , TreeScope(*this, document)
<span class="udiff-line-added">+     , m_delegatesFocus(delegatesFocus == DelegatesFocus::Yes)</span>
      , m_type(type)
      , m_styleScope(makeUnique&lt;Style::Scope&gt;(*this))
  {
  }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -250,16 +257,114 @@</span>
      if (!m_slotAssignment)
          return nullptr;
      return m_slotAssignment-&gt;assignedNodesForSlot(slot, *this);
  }
  
<span class="udiff-line-added">+ static Optional&lt;std::pair&lt;AtomString, AtomString&gt;&gt; parsePartMapping(StringView mappingString)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     const auto end = mappingString.length();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     auto skipWhitespace = [&amp;](auto position) {</span>
<span class="udiff-line-added">+         while (position &lt; end &amp;&amp; isHTMLSpace(mappingString[position]))</span>
<span class="udiff-line-added">+             ++position;</span>
<span class="udiff-line-added">+         return position;</span>
<span class="udiff-line-added">+     };</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     auto collectValue = [&amp;](auto position) {</span>
<span class="udiff-line-added">+         while (position &lt; end &amp;&amp; (!isHTMLSpace(mappingString[position]) &amp;&amp; mappingString[position] != &#39;:&#39;))</span>
<span class="udiff-line-added">+             ++position;</span>
<span class="udiff-line-added">+         return position;</span>
<span class="udiff-line-added">+     };</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     size_t begin = 0;</span>
<span class="udiff-line-added">+     begin = skipWhitespace(begin);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     auto firstPartEnd = collectValue(begin);</span>
<span class="udiff-line-added">+     if (firstPartEnd == begin)</span>
<span class="udiff-line-added">+         return { };</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     auto firstPart = mappingString.substring(begin, firstPartEnd - begin).toAtomString();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     begin = skipWhitespace(firstPartEnd);</span>
<span class="udiff-line-added">+     if (begin == end)</span>
<span class="udiff-line-added">+         return std::make_pair(firstPart, firstPart);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (mappingString[begin] != &#39;:&#39;)</span>
<span class="udiff-line-added">+         return { };</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     begin = skipWhitespace(begin + 1);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     auto secondPartEnd = collectValue(begin);</span>
<span class="udiff-line-added">+     if (secondPartEnd == begin)</span>
<span class="udiff-line-added">+         return { };</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     auto secondPart = mappingString.substring(begin, secondPartEnd - begin).toAtomString();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     begin = skipWhitespace(secondPartEnd);</span>
<span class="udiff-line-added">+     if (begin != end)</span>
<span class="udiff-line-added">+         return { };</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     return std::make_pair(firstPart, secondPart);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ static ShadowRoot::PartMappings parsePartMappingsList(StringView mappingsListString)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     if (!RuntimeEnabledFeatures::sharedFeatures().cssShadowPartsEnabled())</span>
<span class="udiff-line-added">+         return { };</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     ShadowRoot::PartMappings mappings;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     const auto end = mappingsListString.length();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     size_t begin = 0;</span>
<span class="udiff-line-added">+     while (begin &lt; end) {</span>
<span class="udiff-line-added">+         size_t mappingEnd = begin;</span>
<span class="udiff-line-added">+         while (mappingEnd &lt; end &amp;&amp; mappingsListString[mappingEnd] != &#39;,&#39;)</span>
<span class="udiff-line-added">+             ++mappingEnd;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         auto result = parsePartMapping(mappingsListString.substring(begin, mappingEnd - begin));</span>
<span class="udiff-line-added">+         if (result)</span>
<span class="udiff-line-added">+             mappings.add(result-&gt;first, Vector&lt;AtomString, 1&gt;()).iterator-&gt;value.append(result-&gt;second);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         if (mappingEnd == end)</span>
<span class="udiff-line-added">+             break;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         begin = mappingEnd + 1;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     return mappings;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ const ShadowRoot::PartMappings&amp; ShadowRoot::partMappings() const</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     if (!m_partMappings) {</span>
<span class="udiff-line-added">+         auto exportpartsValue = host()-&gt;attributeWithoutSynchronization(HTMLNames::exportpartsAttr);</span>
<span class="udiff-line-added">+         m_partMappings = parsePartMappingsList(exportpartsValue);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     return *m_partMappings;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void ShadowRoot::invalidatePartMappings()</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     m_partMappings = { };</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  Vector&lt;ShadowRoot*&gt; assignedShadowRootsIfSlotted(const Node&amp; node)
  {
      Vector&lt;ShadowRoot*&gt; result;
      for (auto* slot = node.assignedSlot(); slot; slot = slot-&gt;assignedSlot()) {
          ASSERT(slot-&gt;containingShadowRoot());
          result.append(slot-&gt;containingShadowRoot());
      }
      return result;
  }
  
<span class="udiff-line-added">+ #if ENABLE(PICTURE_IN_PICTURE_API)</span>
<span class="udiff-line-added">+ HTMLVideoElement* ShadowRoot::pictureInPictureElement() const</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     notImplemented();</span>
<span class="udiff-line-added">+     return nullptr;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+ </span>
  }
</pre>
<center><a href="SelectorQuery.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="ShadowRoot.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>