<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New modules/javafx.web/src/main/native/Source/WebCore/bindings/js/WebCoreJSClientData.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (C) 2017-2019 Apple Inc. All rights reserved.
  3  *
  4  * Redistribution and use in source and binary forms, with or without
  5  * modification, are permitted provided that the following conditions
  6  * are met:
  7  * 1. Redistributions of source code must retain the above copyright
  8  *    notice, this list of conditions and the following disclaimer.
  9  * 2. Redistributions in binary form must reproduce the above copyright
 10  *    notice, this list of conditions and the following disclaimer in the
 11  *    documentation and/or other materials provided with the distribution.
 12  *
 13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. ``AS IS&#39;&#39; AND ANY
 14  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 15  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 16  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE INC. OR
 17  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 18  * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 19  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 20  * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 21  * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 22  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 23  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #include &quot;config.h&quot;
 27 #include &quot;WebCoreJSClientData.h&quot;
 28 
 29 #include &quot;DOMGCOutputConstraint.h&quot;
 30 #include &quot;JSDOMBinding.h&quot;
 31 #include &quot;JSDOMBuiltinConstructorBase.h&quot;
 32 #include &quot;JSDOMWindow.h&quot;
 33 #include &quot;JSDOMWindowProperties.h&quot;
 34 #include &quot;JSDedicatedWorkerGlobalScope.h&quot;
 35 #include &quot;JSPaintWorkletGlobalScope.h&quot;
 36 #include &quot;JSRemoteDOMWindow.h&quot;
 37 #include &quot;JSServiceWorkerGlobalScope.h&quot;
 38 #include &quot;JSWindowProxy.h&quot;
 39 #include &quot;JSWorkerGlobalScope.h&quot;
 40 #include &quot;JSWorkletGlobalScope.h&quot;
 41 #include &lt;JavaScriptCore/FastMallocAlignedMemoryAllocator.h&gt;
 42 #include &lt;JavaScriptCore/HeapInlines.h&gt;
 43 #include &lt;JavaScriptCore/IsoHeapCellType.h&gt;
 44 #include &lt;JavaScriptCore/JSDestructibleObjectHeapCellType.h&gt;
 45 #include &lt;JavaScriptCore/MarkingConstraint.h&gt;
 46 #include &lt;JavaScriptCore/SubspaceInlines.h&gt;
 47 #include &lt;JavaScriptCore/VM.h&gt;
 48 #include &quot;runtime_array.h&quot;
 49 #include &quot;runtime_method.h&quot;
 50 #include &quot;runtime_object.h&quot;
 51 #include &lt;wtf/MainThread.h&gt;
 52 
 53 namespace WebCore {
 54 using namespace JSC;
 55 
 56 JSVMClientData::JSVMClientData(VM&amp; vm)
 57     : m_builtinFunctions(vm)
 58     , m_builtinNames(vm)
 59     , m_runtimeArrayHeapCellType(JSC::IsoHeapCellType::create&lt;RuntimeArray&gt;())
 60     , m_runtimeObjectHeapCellType(JSC::IsoHeapCellType::create&lt;JSC::Bindings::RuntimeObject&gt;())
 61     , m_windowProxyHeapCellType(JSC::IsoHeapCellType::create&lt;JSWindowProxy&gt;())
 62     , m_heapCellTypeForJSDOMWindow(JSC::IsoHeapCellType::create&lt;JSDOMWindow&gt;())
 63     , m_heapCellTypeForJSDedicatedWorkerGlobalScope(JSC::IsoHeapCellType::create&lt;JSDedicatedWorkerGlobalScope&gt;())
 64     , m_heapCellTypeForJSRemoteDOMWindow(JSC::IsoHeapCellType::create&lt;JSRemoteDOMWindow&gt;())
 65     , m_heapCellTypeForJSWorkerGlobalScope(JSC::IsoHeapCellType::create&lt;JSWorkerGlobalScope&gt;())
 66 #if ENABLE(SERVICE_WORKER)
 67     , m_heapCellTypeForJSServiceWorkerGlobalScope(JSC::IsoHeapCellType::create&lt;JSServiceWorkerGlobalScope&gt;())
 68 #endif
 69 #if ENABLE(CSS_PAINTING_API)
 70     , m_heapCellTypeForJSPaintWorkletGlobalScope(JSC::IsoHeapCellType::create&lt;JSPaintWorkletGlobalScope&gt;())
 71     , m_heapCellTypeForJSWorkletGlobalScope(JSC::IsoHeapCellType::create&lt;JSWorkletGlobalScope&gt;())
 72 #endif
 73     , m_domBuiltinConstructorSpace ISO_SUBSPACE_INIT(vm.heap, vm.cellHeapCellType.get(), JSDOMBuiltinConstructorBase)
 74     , m_domConstructorSpace ISO_SUBSPACE_INIT(vm.heap, vm.cellHeapCellType.get(), JSDOMConstructorBase)
 75     , m_domWindowPropertiesSpace ISO_SUBSPACE_INIT(vm.heap, vm.cellHeapCellType.get(), JSDOMWindowProperties)
 76     , m_runtimeArraySpace ISO_SUBSPACE_INIT(vm.heap, m_runtimeArrayHeapCellType.get(), RuntimeArray)
 77     , m_runtimeMethodSpace ISO_SUBSPACE_INIT(vm.heap, vm.cellHeapCellType.get(), RuntimeMethod) // Hash:0xf70c4a85
 78     , m_runtimeObjectSpace ISO_SUBSPACE_INIT(vm.heap, m_runtimeObjectHeapCellType.get(), JSC::Bindings::RuntimeObject)
 79     , m_windowProxySpace ISO_SUBSPACE_INIT(vm.heap, m_windowProxyHeapCellType.get(), JSWindowProxy)
 80     , m_subspaceForJSDOMWindow ISO_SUBSPACE_INIT(vm.heap, m_heapCellTypeForJSDOMWindow.get(), JSDOMWindow)
 81     , m_subspaceForJSDedicatedWorkerGlobalScope ISO_SUBSPACE_INIT(vm.heap, m_heapCellTypeForJSDedicatedWorkerGlobalScope.get(), JSDedicatedWorkerGlobalScope)
 82     , m_subspaceForJSRemoteDOMWindow ISO_SUBSPACE_INIT(vm.heap, m_heapCellTypeForJSRemoteDOMWindow.get(), JSRemoteDOMWindow)
 83     , m_subspaceForJSWorkerGlobalScope ISO_SUBSPACE_INIT(vm.heap, m_heapCellTypeForJSWorkerGlobalScope.get(), JSWorkerGlobalScope)
 84 #if ENABLE(SERVICE_WORKER)
 85     , m_subspaceForJSServiceWorkerGlobalScope ISO_SUBSPACE_INIT(vm.heap, m_heapCellTypeForJSServiceWorkerGlobalScope.get(), JSServiceWorkerGlobalScope)
 86 #endif
 87 #if ENABLE(CSS_PAINTING_API)
 88     , m_subspaceForJSPaintWorkletGlobalScope ISO_SUBSPACE_INIT(vm.heap, m_heapCellTypeForJSPaintWorkletGlobalScope.get(), JSPaintWorkletGlobalScope)
 89     , m_subspaceForJSWorkletGlobalScope ISO_SUBSPACE_INIT(vm.heap, m_heapCellTypeForJSWorkletGlobalScope.get(), JSWorkletGlobalScope)
 90 #endif
 91     , m_outputConstraintSpace(&quot;WebCore Wrapper w/ Output Constraint&quot;, vm.heap, vm.destructibleObjectHeapCellType.get(), vm.fastMallocAllocator.get()) // Hash:0x7724c2e4
 92 {
 93 }
 94 
 95 JSVMClientData::~JSVMClientData()
 96 {
 97     ASSERT(m_worldSet.contains(m_normalWorld.get()));
 98     ASSERT(m_worldSet.size() == 1);
 99     ASSERT(m_normalWorld-&gt;hasOneRef());
100     m_normalWorld = nullptr;
101     ASSERT(m_worldSet.isEmpty());
102 }
103 
104 void JSVMClientData::getAllWorlds(Vector&lt;Ref&lt;DOMWrapperWorld&gt;&gt;&amp; worlds)
105 {
106     ASSERT(worlds.isEmpty());
107 
108     worlds.reserveInitialCapacity(m_worldSet.size());
109 
110     // It is necessary to order the `DOMWrapperWorld`s because certain callers expect the main world
111     // to be the first item in the list, as they use the main world as an indicator of when the page
112     // is ready to start evaluating JavaScript. For example, Web Inspector waits for the main world
113     // change to clear any injected scripts and debugger/breakpoint state.
114 
115     auto&amp; mainNormalWorld = mainThreadNormalWorld();
116 
117     // Add main normal world.
118     if (m_worldSet.contains(&amp;mainNormalWorld))
119         worlds.uncheckedAppend(mainNormalWorld);
120 
121     // Add other normal worlds.
122     for (auto* world : m_worldSet) {
123         if (world-&gt;type() != DOMWrapperWorld::Type::Normal)
124             continue;
125         if (world == &amp;mainNormalWorld)
126             continue;
127         worlds.uncheckedAppend(*world);
128     }
129 
130     // Add non-normal worlds.
131     for (auto* world : m_worldSet) {
132         if (world-&gt;type() == DOMWrapperWorld::Type::Normal)
133             continue;
134         worlds.uncheckedAppend(*world);
135     }
136 }
137 
138 void JSVMClientData::initNormalWorld(VM* vm)
139 {
140     JSVMClientData* clientData = new JSVMClientData(*vm);
141     vm-&gt;clientData = clientData; // ~VM deletes this pointer.
142 
143     vm-&gt;heap.addMarkingConstraint(makeUnique&lt;DOMGCOutputConstraint&gt;(*vm, *clientData));
144 
145     clientData-&gt;m_normalWorld = DOMWrapperWorld::create(*vm, DOMWrapperWorld::Type::Normal);
146     vm-&gt;m_typedArrayController = adoptRef(new WebCoreTypedArrayController());
147 }
148 
149 } // namespace WebCore
150 
    </pre>
  </body>
</html>