<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.web/src/main/native/Source/JavaScriptCore/inspector/agents/InspectorDebuggerAgent.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="InspectorConsoleAgent.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="InspectorDebuggerAgent.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/JavaScriptCore/inspector/agents/InspectorDebuggerAgent.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 39,10 ***</span>
<span class="line-new-header">--- 39,11 ---</span>
  #include &quot;RegularExpression.h&quot;
  #include &quot;ScriptCallStack.h&quot;
  #include &quot;ScriptCallStackFactory.h&quot;
  #include &quot;ScriptDebugServer.h&quot;
  #include &quot;ScriptObject.h&quot;
<span class="line-added">+ #include &lt;wtf/Function.h&gt;</span>
  #include &lt;wtf/JSONValues.h&gt;
  #include &lt;wtf/NeverDestroyed.h&gt;
  #include &lt;wtf/Stopwatch.h&gt;
  #include &lt;wtf/text/StringConcatenateNumbers.h&gt;
  #include &lt;wtf/text/WTFString.h&gt;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 58,50 ***</span>
  static String objectGroupForBreakpointAction(const ScriptBreakpointAction&amp; action)
  {
      return makeString(&quot;breakpoint-action-&quot;, action.identifier);
  }
  
  InspectorDebuggerAgent::InspectorDebuggerAgent(AgentContext&amp; context)
      : InspectorAgentBase(&quot;Debugger&quot;_s)
      , m_frontendDispatcher(makeUnique&lt;DebuggerFrontendDispatcher&gt;(context.frontendRouter))
      , m_backendDispatcher(DebuggerBackendDispatcher::create(context.backendDispatcher, this))
      , m_scriptDebugServer(context.environment.scriptDebugServer())
      , m_injectedScriptManager(context.injectedScriptManager)
  {
<span class="line-modified">!     // FIXME: make breakReason optional so that there was no need to init it with &quot;other&quot;.</span>
<span class="line-modified">!     clearBreakDetails();</span>
  }
  
  InspectorDebuggerAgent::~InspectorDebuggerAgent() = default;
  
  void InspectorDebuggerAgent::didCreateFrontendAndBackend(FrontendRouter*, BackendDispatcher*)
  {
  }
  
  void InspectorDebuggerAgent::willDestroyFrontendAndBackend(DisconnectReason reason)
  {
<span class="line-modified">!     disable(reason == DisconnectReason::InspectedTargetDestroyed);</span>
  }
  
  void InspectorDebuggerAgent::enable()
  {
<span class="line-removed">-     if (m_enabled)</span>
<span class="line-removed">-         return;</span>
<span class="line-removed">- </span>
      m_enabled = true;
  
      m_scriptDebugServer.addListener(this);
  
      for (auto* listener : copyToVector(m_listeners))
          listener-&gt;debuggerWasEnabled();
  }
  
  void InspectorDebuggerAgent::disable(bool isBeingDestroyed)
  {
<span class="line-removed">-     if (!m_enabled)</span>
<span class="line-removed">-         return;</span>
<span class="line-removed">- </span>
      for (auto* listener : copyToVector(m_listeners))
          listener-&gt;debuggerWasDisabled();
  
      m_scriptDebugServer.removeListener(this, isBeingDestroyed);
  
<span class="line-new-header">--- 59,60 ---</span>
  static String objectGroupForBreakpointAction(const ScriptBreakpointAction&amp; action)
  {
      return makeString(&quot;breakpoint-action-&quot;, action.identifier);
  }
  
<span class="line-added">+ static bool isWebKitInjectedScript(const String&amp; sourceURL)</span>
<span class="line-added">+ {</span>
<span class="line-added">+     return sourceURL.startsWith(&quot;__InjectedScript_&quot;) &amp;&amp; sourceURL.endsWith(&quot;.js&quot;);</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
  InspectorDebuggerAgent::InspectorDebuggerAgent(AgentContext&amp; context)
      : InspectorAgentBase(&quot;Debugger&quot;_s)
      , m_frontendDispatcher(makeUnique&lt;DebuggerFrontendDispatcher&gt;(context.frontendRouter))
      , m_backendDispatcher(DebuggerBackendDispatcher::create(context.backendDispatcher, this))
      , m_scriptDebugServer(context.environment.scriptDebugServer())
      , m_injectedScriptManager(context.injectedScriptManager)
  {
<span class="line-modified">!     // FIXME: make pauseReason optional so that there was no need to init it with &quot;other&quot;.</span>
<span class="line-modified">!     clearPauseDetails();</span>
  }
  
  InspectorDebuggerAgent::~InspectorDebuggerAgent() = default;
  
  void InspectorDebuggerAgent::didCreateFrontendAndBackend(FrontendRouter*, BackendDispatcher*)
  {
  }
  
  void InspectorDebuggerAgent::willDestroyFrontendAndBackend(DisconnectReason reason)
  {
<span class="line-modified">!     if (enabled())</span>
<span class="line-added">+         disable(reason == DisconnectReason::InspectedTargetDestroyed);</span>
  }
  
  void InspectorDebuggerAgent::enable()
  {
      m_enabled = true;
  
      m_scriptDebugServer.addListener(this);
  
      for (auto* listener : copyToVector(m_listeners))
          listener-&gt;debuggerWasEnabled();
<span class="line-added">+ </span>
<span class="line-added">+     for (auto&amp; [sourceID, script] : m_scripts) {</span>
<span class="line-added">+         Optional&lt;JSC::Debugger::BlackboxType&gt; blackboxType;</span>
<span class="line-added">+         if (isWebKitInjectedScript(script.sourceURL)) {</span>
<span class="line-added">+             if (!m_pauseForInternalScripts)</span>
<span class="line-added">+                 blackboxType = JSC::Debugger::BlackboxType::Ignored;</span>
<span class="line-added">+         } else if (shouldBlackboxURL(script.sourceURL) || shouldBlackboxURL(script.url))</span>
<span class="line-added">+             blackboxType = JSC::Debugger::BlackboxType::Deferred;</span>
<span class="line-added">+         m_scriptDebugServer.setBlackboxType(sourceID, blackboxType);</span>
<span class="line-added">+     }</span>
  }
  
  void InspectorDebuggerAgent::disable(bool isBeingDestroyed)
  {
      for (auto* listener : copyToVector(m_listeners))
          listener-&gt;debuggerWasDisabled();
  
      m_scriptDebugServer.removeListener(this, isBeingDestroyed);
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 118,12 ***</span>
      m_pauseOnMicrotasks = false;
  
      m_enabled = false;
  }
  
<span class="line-modified">! void InspectorDebuggerAgent::enable(ErrorString&amp;)</span>
  {
      enable();
  }
  
  void InspectorDebuggerAgent::disable(ErrorString&amp;)
  {
<span class="line-new-header">--- 129,17 ---</span>
      m_pauseOnMicrotasks = false;
  
      m_enabled = false;
  }
  
<span class="line-modified">! void InspectorDebuggerAgent::enable(ErrorString&amp; errorString)</span>
  {
<span class="line-added">+     if (enabled()) {</span>
<span class="line-added">+         errorString = &quot;Debugger domain already enabled&quot;_s;</span>
<span class="line-added">+         return;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
      enable();
  }
  
  void InspectorDebuggerAgent::disable(ErrorString&amp;)
  {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 167,10 ***</span>
<span class="line-new-header">--- 183,21 ---</span>
  void InspectorDebuggerAgent::setSuppressAllPauses(bool suppress)
  {
      m_scriptDebugServer.setSuppressAllPauses(suppress);
  }
  
<span class="line-added">+ void InspectorDebuggerAgent::updatePauseReasonAndData(DebuggerFrontendDispatcher::Reason reason, RefPtr&lt;JSON::Object&gt;&amp;&amp; data)</span>
<span class="line-added">+ {</span>
<span class="line-added">+     if (m_pauseReason != DebuggerFrontendDispatcher::Reason::BlackboxedScript) {</span>
<span class="line-added">+         m_preBlackboxPauseReason = m_pauseReason;</span>
<span class="line-added">+         m_preBlackboxPauseData = WTFMove(m_pauseData);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     m_pauseReason = reason;</span>
<span class="line-added">+     m_pauseData = WTFMove(data);</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
  static RefPtr&lt;JSON::Object&gt; buildAssertPauseReason(const String&amp; message)
  {
      auto reason = Protocol::Debugger::AssertPauseReason::create().release();
      if (!message.isNull())
          reason-&gt;setMessage(message);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 223,19 ***</span>
  InspectorDebuggerAgent::AsyncCallIdentifier InspectorDebuggerAgent::asyncCallIdentifier(AsyncCallType asyncCallType, int callbackId)
  {
      return std::make_pair(static_cast&lt;unsigned&gt;(asyncCallType), callbackId);
  }
  
<span class="line-modified">! void InspectorDebuggerAgent::didScheduleAsyncCall(JSC::ExecState* exec, AsyncCallType asyncCallType, int callbackId, bool singleShot)</span>
  {
      if (!m_asyncStackTraceDepth)
          return;
  
      if (!m_scriptDebugServer.breakpointsActive())
          return;
  
<span class="line-modified">!     Ref&lt;ScriptCallStack&gt; callStack = createScriptCallStack(exec, m_asyncStackTraceDepth);</span>
      ASSERT(callStack-&gt;size());
      if (!callStack-&gt;size())
          return;
  
      RefPtr&lt;AsyncStackTrace&gt; parentStackTrace;
<span class="line-new-header">--- 250,19 ---</span>
  InspectorDebuggerAgent::AsyncCallIdentifier InspectorDebuggerAgent::asyncCallIdentifier(AsyncCallType asyncCallType, int callbackId)
  {
      return std::make_pair(static_cast&lt;unsigned&gt;(asyncCallType), callbackId);
  }
  
<span class="line-modified">! void InspectorDebuggerAgent::didScheduleAsyncCall(JSC::JSGlobalObject* globalObject, AsyncCallType asyncCallType, int callbackId, bool singleShot)</span>
  {
      if (!m_asyncStackTraceDepth)
          return;
  
      if (!m_scriptDebugServer.breakpointsActive())
          return;
  
<span class="line-modified">!     Ref&lt;ScriptCallStack&gt; callStack = createScriptCallStack(globalObject, m_asyncStackTraceDepth);</span>
      ASSERT(callStack-&gt;size());
      if (!callStack-&gt;size())
          return;
  
      RefPtr&lt;AsyncStackTrace&gt; parentStackTrace;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 696,19 ***</span>
      }
  
      injectedScript.getFunctionDetails(errorString, functionId, details);
  }
  
<span class="line-modified">! void InspectorDebuggerAgent::schedulePauseOnNextStatement(DebuggerFrontendDispatcher::Reason breakReason, RefPtr&lt;JSON::Object&gt;&amp;&amp; data)</span>
  {
      if (m_javaScriptPauseScheduled)
          return;
  
      m_javaScriptPauseScheduled = true;
  
<span class="line-modified">!     m_breakReason = breakReason;</span>
<span class="line-removed">-     m_breakData = WTFMove(data);</span>
  
      JSC::JSLockHolder locker(m_scriptDebugServer.vm());
      m_scriptDebugServer.setPauseOnNextStatement(true);
  }
  
<span class="line-new-header">--- 723,18 ---</span>
      }
  
      injectedScript.getFunctionDetails(errorString, functionId, details);
  }
  
<span class="line-modified">! void InspectorDebuggerAgent::schedulePauseOnNextStatement(DebuggerFrontendDispatcher::Reason reason, RefPtr&lt;JSON::Object&gt;&amp;&amp; data)</span>
  {
      if (m_javaScriptPauseScheduled)
          return;
  
      m_javaScriptPauseScheduled = true;
  
<span class="line-modified">!     updatePauseReasonAndData(reason, WTFMove(data));</span>
  
      JSC::JSLockHolder locker(m_scriptDebugServer.vm());
      m_scriptDebugServer.setPauseOnNextStatement(true);
  }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 717,11 ***</span>
      if (!m_javaScriptPauseScheduled)
          return;
  
      m_javaScriptPauseScheduled = false;
  
<span class="line-modified">!     clearBreakDetails();</span>
      m_scriptDebugServer.setPauseOnNextStatement(false);
      m_enablePauseWhenIdle = false;
  }
  
  void InspectorDebuggerAgent::pause(ErrorString&amp;)
<span class="line-new-header">--- 743,11 ---</span>
      if (!m_javaScriptPauseScheduled)
          return;
  
      m_javaScriptPauseScheduled = false;
  
<span class="line-modified">!     clearPauseDetails();</span>
      m_scriptDebugServer.setPauseOnNextStatement(false);
      m_enablePauseWhenIdle = false;
  }
  
  void InspectorDebuggerAgent::pause(ErrorString&amp;)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 729,11 ***</span>
      schedulePauseOnNextStatement(DebuggerFrontendDispatcher::Reason::PauseOnNextStatement, nullptr);
  }
  
  void InspectorDebuggerAgent::resume(ErrorString&amp; errorString)
  {
<span class="line-modified">!     if (!m_pausedScriptState &amp;&amp; !m_javaScriptPauseScheduled) {</span>
          errorString = &quot;Must be paused or waiting to pause&quot;_s;
          return;
      }
  
      cancelPauseOnNextStatement();
<span class="line-new-header">--- 755,11 ---</span>
      schedulePauseOnNextStatement(DebuggerFrontendDispatcher::Reason::PauseOnNextStatement, nullptr);
  }
  
  void InspectorDebuggerAgent::resume(ErrorString&amp; errorString)
  {
<span class="line-modified">!     if (!m_pausedGlobalObject &amp;&amp; !m_javaScriptPauseScheduled) {</span>
          errorString = &quot;Must be paused or waiting to pause&quot;_s;
          return;
      }
  
      cancelPauseOnNextStatement();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 804,10 ***</span>
<span class="line-new-header">--- 830,15 ---</span>
          ErrorString ignored;
          pause(ignored);
      }
  }
  
<span class="line-added">+ void InspectorDebuggerAgent::setPauseOnDebuggerStatements(ErrorString&amp;, bool enabled)</span>
<span class="line-added">+ {</span>
<span class="line-added">+     m_scriptDebugServer.setPauseOnDebuggerStatements(enabled);</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
  void InspectorDebuggerAgent::setPauseOnExceptions(ErrorString&amp; errorString, const String&amp; stringPauseState)
  {
      JSC::Debugger::PauseOnExceptionsState pauseState;
      if (stringPauseState == &quot;none&quot;)
          pauseState = JSC::Debugger::DontPauseOnExceptions;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 862,10 ***</span>
<span class="line-new-header">--- 893,55 ---</span>
          unmuteConsole();
          m_scriptDebugServer.setPauseOnExceptionsState(pauseState);
      }
  }
  
<span class="line-added">+ void InspectorDebuggerAgent::setShouldBlackboxURL(ErrorString&amp; errorString, const String&amp; url, bool shouldBlackbox, const bool* optionalCaseSensitive, const bool* optionalIsRegex)</span>
<span class="line-added">+ {</span>
<span class="line-added">+     if (url.isEmpty()) {</span>
<span class="line-added">+         errorString = &quot;URL must not be empty&quot;_s;</span>
<span class="line-added">+         return;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     bool caseSensitive = optionalCaseSensitive &amp;&amp; *optionalCaseSensitive;</span>
<span class="line-added">+     bool isRegex = optionalIsRegex &amp;&amp; *optionalIsRegex;</span>
<span class="line-added">+ </span>
<span class="line-added">+     if (!caseSensitive &amp;&amp; !isRegex &amp;&amp; isWebKitInjectedScript(url)) {</span>
<span class="line-added">+         errorString = &quot;Blackboxing of internal scripts is controlled by &#39;Debugger.setPauseForInternalScripts&#39;&quot;_s;</span>
<span class="line-added">+         return;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     BlackboxConfig config { url, caseSensitive, isRegex };</span>
<span class="line-added">+     if (shouldBlackbox)</span>
<span class="line-added">+         m_blackboxedURLs.appendIfNotContains(config);</span>
<span class="line-added">+     else</span>
<span class="line-added">+         m_blackboxedURLs.removeAll(config);</span>
<span class="line-added">+ </span>
<span class="line-added">+     for (auto&amp; [sourceID, script] : m_scripts) {</span>
<span class="line-added">+         if (isWebKitInjectedScript(script.sourceURL))</span>
<span class="line-added">+             continue;</span>
<span class="line-added">+ </span>
<span class="line-added">+         Optional&lt;JSC::Debugger::BlackboxType&gt; blackboxType;</span>
<span class="line-added">+         if (shouldBlackboxURL(script.sourceURL) || shouldBlackboxURL(script.url))</span>
<span class="line-added">+             blackboxType = JSC::Debugger::BlackboxType::Deferred;</span>
<span class="line-added">+         m_scriptDebugServer.setBlackboxType(sourceID, blackboxType);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ bool InspectorDebuggerAgent::shouldBlackboxURL(const String&amp; url) const</span>
<span class="line-added">+ {</span>
<span class="line-added">+     if (!url.isEmpty()) {</span>
<span class="line-added">+         for (const auto&amp; blackboxConfig : m_blackboxedURLs) {</span>
<span class="line-added">+             auto searchStringType = blackboxConfig.isRegex ? ContentSearchUtilities::SearchStringType::Regex : ContentSearchUtilities::SearchStringType::ExactString;</span>
<span class="line-added">+             auto regex = ContentSearchUtilities::createRegularExpressionForSearchString(blackboxConfig.url, blackboxConfig.caseSensitive, searchStringType);</span>
<span class="line-added">+             if (regex.match(url) != -1)</span>
<span class="line-added">+                 return true;</span>
<span class="line-added">+         }</span>
<span class="line-added">+     }</span>
<span class="line-added">+     return false;</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
  void InspectorDebuggerAgent::scriptExecutionBlockedByCSP(const String&amp; directiveText)
  {
      if (m_scriptDebugServer.pauseOnExceptionsState() != JSC::Debugger::DontPauseOnExceptions)
          breakProgram(DebuggerFrontendDispatcher::Reason::CSPViolation, buildCSPViolationPauseReason(directiveText));
  }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 889,17 ***</span>
      if (shouldPause == m_pauseForInternalScripts)
          return;
  
      m_pauseForInternalScripts = shouldPause;
  
<span class="line-modified">!     if (m_pauseForInternalScripts)</span>
<span class="line-modified">!         m_scriptDebugServer.clearBlacklist();</span>
<span class="line-modified">! }</span>
<span class="line-modified">! </span>
<span class="line-modified">! static bool isWebKitInjectedScript(const String&amp; sourceURL)</span>
<span class="line-modified">! {</span>
<span class="line-removed">-     return sourceURL.startsWith(&quot;__InjectedScript_&quot;) &amp;&amp; sourceURL.endsWith(&quot;.js&quot;);</span>
  }
  
  void InspectorDebuggerAgent::didParseSource(JSC::SourceID sourceID, const Script&amp; script)
  {
      String scriptIDStr = String::number(sourceID);
<span class="line-new-header">--- 965,16 ---</span>
      if (shouldPause == m_pauseForInternalScripts)
          return;
  
      m_pauseForInternalScripts = shouldPause;
  
<span class="line-modified">!     auto blackboxType = !m_pauseForInternalScripts ? Optional&lt;JSC::Debugger::BlackboxType&gt;(JSC::Debugger::BlackboxType::Ignored) : WTF::nullopt;</span>
<span class="line-modified">!     for (auto&amp; [sourceID, script] : m_scripts) {</span>
<span class="line-modified">!         if (!isWebKitInjectedScript(script.sourceURL))</span>
<span class="line-modified">!             continue;</span>
<span class="line-modified">!         m_scriptDebugServer.setBlackboxType(sourceID, blackboxType);</span>
<span class="line-modified">!     }</span>
  }
  
  void InspectorDebuggerAgent::didParseSource(JSC::SourceID sourceID, const Script&amp; script)
  {
      String scriptIDStr = String::number(sourceID);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 914,12 ***</span>
  
      m_frontendDispatcher-&gt;scriptParsed(scriptIDStr, script.url, script.startLine, script.startColumn, script.endLine, script.endColumn, isContentScript, sourceURLParam, sourceMapURLParam, isModule ? &amp;isModule : nullptr);
  
      m_scripts.set(sourceID, script);
  
<span class="line-modified">!     if (hasSourceURL &amp;&amp; isWebKitInjectedScript(sourceURL) &amp;&amp; !m_pauseForInternalScripts)</span>
<span class="line-modified">!         m_scriptDebugServer.addToBlacklist(sourceID);</span>
  
      String scriptURLForBreakpoints = hasSourceURL ? script.sourceURL : script.url;
      if (scriptURLForBreakpoints.isEmpty())
          return;
  
<span class="line-new-header">--- 989,15 ---</span>
  
      m_frontendDispatcher-&gt;scriptParsed(scriptIDStr, script.url, script.startLine, script.startColumn, script.endLine, script.endColumn, isContentScript, sourceURLParam, sourceMapURLParam, isModule ? &amp;isModule : nullptr);
  
      m_scripts.set(sourceID, script);
  
<span class="line-modified">!     if (isWebKitInjectedScript(sourceURL)) {</span>
<span class="line-modified">!         if (!m_pauseForInternalScripts)</span>
<span class="line-added">+             m_scriptDebugServer.setBlackboxType(sourceID, JSC::Debugger::BlackboxType::Ignored);</span>
<span class="line-added">+     } else if (shouldBlackboxURL(sourceURL) || shouldBlackboxURL(script.url))</span>
<span class="line-added">+         m_scriptDebugServer.setBlackboxType(sourceID, JSC::Debugger::BlackboxType::Deferred);</span>
  
      String scriptURLForBreakpoints = hasSourceURL ? script.sourceURL : script.url;
      if (scriptURLForBreakpoints.isEmpty())
          return;
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 985,37 ***</span>
  
      if (m_pauseOnMicrotasks)
          cancelPauseOnNextStatement();
  }
  
<span class="line-modified">! void InspectorDebuggerAgent::didPause(JSC::ExecState&amp; scriptState, JSC::JSValue callFrames, JSC::JSValue exceptionOrCaughtValue)</span>
  {
<span class="line-modified">!     ASSERT(!m_pausedScriptState);</span>
<span class="line-modified">!     m_pausedScriptState = &amp;scriptState;</span>
<span class="line-modified">!     m_currentCallStack = { scriptState.vm(), callFrames };</span>
  
<span class="line-modified">!     InjectedScript injectedScript = m_injectedScriptManager.injectedScriptFor(&amp;scriptState);</span>
  
      // If a high level pause pause reason is not already set, try to infer a reason from the debugger.
<span class="line-modified">!     if (m_breakReason == DebuggerFrontendDispatcher::Reason::Other) {</span>
          switch (m_scriptDebugServer.reasonForPause()) {
          case JSC::Debugger::PausedForBreakpoint: {
<span class="line-modified">!             JSC::BreakpointID debuggerBreakpointId = m_scriptDebugServer.pausingBreakpointID();</span>
<span class="line-modified">!             if (debuggerBreakpointId != m_continueToLocationBreakpointID) {</span>
<span class="line-modified">!                 m_breakReason = DebuggerFrontendDispatcher::Reason::Breakpoint;</span>
<span class="line-removed">-                 m_breakData = buildBreakpointPauseReason(debuggerBreakpointId);</span>
<span class="line-removed">-             }</span>
              break;
          }
          case JSC::Debugger::PausedForDebuggerStatement:
<span class="line-modified">!             m_breakReason = DebuggerFrontendDispatcher::Reason::DebuggerStatement;</span>
<span class="line-removed">-             m_breakData = nullptr;</span>
              break;
          case JSC::Debugger::PausedForException:
<span class="line-modified">!             m_breakReason = DebuggerFrontendDispatcher::Reason::Exception;</span>
<span class="line-modified">!             m_breakData = buildExceptionPauseReason(exceptionOrCaughtValue, injectedScript);</span>
              break;
          case JSC::Debugger::PausedAtStatement:
          case JSC::Debugger::PausedAtExpression:
          case JSC::Debugger::PausedBeforeReturn:
          case JSC::Debugger::PausedAtEndOfProgram:
              // Pause was just stepping. Nothing to report.
<span class="line-new-header">--- 1063,43 ---</span>
  
      if (m_pauseOnMicrotasks)
          cancelPauseOnNextStatement();
  }
  
<span class="line-modified">! void InspectorDebuggerAgent::didPause(JSC::JSGlobalObject* globalObject, JSC::JSValue callFrames, JSC::JSValue exceptionOrCaughtValue)</span>
  {
<span class="line-modified">!     ASSERT(!m_pausedGlobalObject);</span>
<span class="line-modified">!     m_pausedGlobalObject = globalObject;</span>
<span class="line-modified">!     m_currentCallStack = { globalObject-&gt;vm(), callFrames };</span>
  
<span class="line-modified">!     InjectedScript injectedScript = m_injectedScriptManager.injectedScriptFor(globalObject);</span>
  
      // If a high level pause pause reason is not already set, try to infer a reason from the debugger.
<span class="line-modified">!     if (m_pauseReason == DebuggerFrontendDispatcher::Reason::Other) {</span>
          switch (m_scriptDebugServer.reasonForPause()) {
          case JSC::Debugger::PausedForBreakpoint: {
<span class="line-modified">!             auto debuggerBreakpointId = m_scriptDebugServer.pausingBreakpointID();</span>
<span class="line-modified">!             if (debuggerBreakpointId != m_continueToLocationBreakpointID)</span>
<span class="line-modified">!                 updatePauseReasonAndData(DebuggerFrontendDispatcher::Reason::Breakpoint, buildBreakpointPauseReason(debuggerBreakpointId));</span>
              break;
          }
          case JSC::Debugger::PausedForDebuggerStatement:
<span class="line-modified">!             updatePauseReasonAndData(DebuggerFrontendDispatcher::Reason::DebuggerStatement, nullptr);</span>
              break;
          case JSC::Debugger::PausedForException:
<span class="line-modified">!             updatePauseReasonAndData(DebuggerFrontendDispatcher::Reason::Exception, buildExceptionPauseReason(exceptionOrCaughtValue, injectedScript));</span>
<span class="line-modified">!             break;</span>
<span class="line-added">+         case JSC::Debugger::PausedAfterBlackboxedScript: {</span>
<span class="line-added">+             // There should be no break data, as we would&#39;ve already continued past the breakpoint.</span>
<span class="line-added">+             ASSERT(!m_pauseData);</span>
<span class="line-added">+ </span>
<span class="line-added">+             // Don&#39;t call `updatePauseReasonAndData` so as to not override `m_preBlackboxPauseData`.</span>
<span class="line-added">+             if (m_pauseReason != DebuggerFrontendDispatcher::Reason::BlackboxedScript)</span>
<span class="line-added">+                 m_preBlackboxPauseReason = m_pauseReason;</span>
<span class="line-added">+             m_pauseReason = DebuggerFrontendDispatcher::Reason::BlackboxedScript;</span>
              break;
<span class="line-added">+         }</span>
          case JSC::Debugger::PausedAtStatement:
          case JSC::Debugger::PausedAtExpression:
          case JSC::Debugger::PausedBeforeReturn:
          case JSC::Debugger::PausedAtEndOfProgram:
              // Pause was just stepping. Nothing to report.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1024,10 ***</span>
<span class="line-new-header">--- 1108,28 ---</span>
              ASSERT_NOT_REACHED();
              break;
          }
      }
  
<span class="line-added">+     if (m_scriptDebugServer.reasonForPause() == JSC::Debugger::PausedAfterBlackboxedScript) {</span>
<span class="line-added">+         // Ensure that `m_preBlackboxPauseReason` is populated with the most recent data.</span>
<span class="line-added">+         updatePauseReasonAndData(m_pauseReason, nullptr);</span>
<span class="line-added">+ </span>
<span class="line-added">+         RefPtr&lt;JSON::Object&gt; data;</span>
<span class="line-added">+         if (auto debuggerBreakpointId = m_scriptDebugServer.pausingBreakpointID()) {</span>
<span class="line-added">+             ASSERT(debuggerBreakpointId != m_continueToLocationBreakpointID);</span>
<span class="line-added">+             data = JSON::Object::create();</span>
<span class="line-added">+             data-&gt;setString(&quot;originalReason&quot;_s, Protocol::InspectorHelpers::getEnumConstantValue(DebuggerFrontendDispatcher::Reason::Breakpoint));</span>
<span class="line-added">+             data-&gt;setValue(&quot;originalData&quot;_s, buildBreakpointPauseReason(debuggerBreakpointId));</span>
<span class="line-added">+         } else if (m_preBlackboxPauseData) {</span>
<span class="line-added">+             data = JSON::Object::create();</span>
<span class="line-added">+             data-&gt;setString(&quot;originalReason&quot;_s, Protocol::InspectorHelpers::getEnumConstantValue(m_preBlackboxPauseReason));</span>
<span class="line-added">+             data-&gt;setValue(&quot;originalData&quot;_s, m_preBlackboxPauseData);</span>
<span class="line-added">+         }</span>
<span class="line-added">+         updatePauseReasonAndData(DebuggerFrontendDispatcher::Reason::BlackboxedScript, WTFMove(data));</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
      // Set $exception to the exception or caught value.
      if (exceptionOrCaughtValue &amp;&amp; !injectedScript.hasNoValue()) {
          injectedScript.setExceptionValue(exceptionOrCaughtValue);
          m_hasExceptionValue = true;
      }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1040,11 ***</span>
          auto it = m_pendingAsyncCalls.find(m_currentAsyncCallIdentifier.value());
          if (it != m_pendingAsyncCalls.end())
              asyncStackTrace = it-&gt;value-&gt;buildInspectorObject();
      }
  
<span class="line-modified">!     m_frontendDispatcher-&gt;paused(currentCallFrames(injectedScript), m_breakReason, m_breakData, asyncStackTrace);</span>
  
      m_javaScriptPauseScheduled = false;
  
      if (m_continueToLocationBreakpointID != JSC::noBreakpointID) {
          m_scriptDebugServer.removeBreakpoint(m_continueToLocationBreakpointID);
<span class="line-new-header">--- 1142,11 ---</span>
          auto it = m_pendingAsyncCalls.find(m_currentAsyncCallIdentifier.value());
          if (it != m_pendingAsyncCalls.end())
              asyncStackTrace = it-&gt;value-&gt;buildInspectorObject();
      }
  
<span class="line-modified">!     m_frontendDispatcher-&gt;paused(currentCallFrames(injectedScript), m_pauseReason, m_pauseData, asyncStackTrace);</span>
  
      m_javaScriptPauseScheduled = false;
  
      if (m_continueToLocationBreakpointID != JSC::noBreakpointID) {
          m_scriptDebugServer.removeBreakpoint(m_continueToLocationBreakpointID);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1061,13 ***</span>
  void InspectorDebuggerAgent::breakpointActionSound(int breakpointActionIdentifier)
  {
      m_frontendDispatcher-&gt;playBreakpointActionSound(breakpointActionIdentifier);
  }
  
<span class="line-modified">! void InspectorDebuggerAgent::breakpointActionProbe(JSC::ExecState&amp; scriptState, const ScriptBreakpointAction&amp; action, unsigned batchId, unsigned sampleId, JSC::JSValue sample)</span>
  {
<span class="line-modified">!     InjectedScript injectedScript = m_injectedScriptManager.injectedScriptFor(&amp;scriptState);</span>
      auto payload = injectedScript.wrapObject(sample, objectGroupForBreakpointAction(action), true);
      auto result = Protocol::Debugger::ProbeSample::create()
          .setProbeId(action.identifier)
          .setBatchId(batchId)
          .setSampleId(sampleId)
<span class="line-new-header">--- 1163,13 ---</span>
  void InspectorDebuggerAgent::breakpointActionSound(int breakpointActionIdentifier)
  {
      m_frontendDispatcher-&gt;playBreakpointActionSound(breakpointActionIdentifier);
  }
  
<span class="line-modified">! void InspectorDebuggerAgent::breakpointActionProbe(JSC::JSGlobalObject* globalObject, const ScriptBreakpointAction&amp; action, unsigned batchId, unsigned sampleId, JSC::JSValue sample)</span>
  {
<span class="line-modified">!     InjectedScript injectedScript = m_injectedScriptManager.injectedScriptFor(globalObject);</span>
      auto payload = injectedScript.wrapObject(sample, objectGroupForBreakpointAction(action), true);
      auto result = Protocol::Debugger::ProbeSample::create()
          .setProbeId(action.identifier)
          .setBatchId(batchId)
          .setSampleId(sampleId)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1082,24 ***</span>
      if (m_didPauseStopwatch) {
          m_didPauseStopwatch = false;
          m_injectedScriptManager.inspectorEnvironment().executionStopwatch()-&gt;start();
      }
  
<span class="line-modified">!     m_pausedScriptState = nullptr;</span>
      m_currentCallStack = { };
      m_injectedScriptManager.releaseObjectGroup(InspectorDebuggerAgent::backtraceObjectGroup);
<span class="line-modified">!     clearBreakDetails();</span>
      clearExceptionValue();
  
      if (m_conditionToDispatchResumed == ShouldDispatchResumed::WhenContinued)
          m_frontendDispatcher-&gt;resumed();
  }
  
<span class="line-modified">! void InspectorDebuggerAgent::breakProgram(DebuggerFrontendDispatcher::Reason breakReason, RefPtr&lt;JSON::Object&gt;&amp;&amp; data)</span>
  {
<span class="line-modified">!     m_breakReason = breakReason;</span>
<span class="line-modified">!     m_breakData = WTFMove(data);</span>
      m_scriptDebugServer.breakProgram();
  }
  
  void InspectorDebuggerAgent::clearInspectorBreakpointState()
  {
<span class="line-new-header">--- 1184,24 ---</span>
      if (m_didPauseStopwatch) {
          m_didPauseStopwatch = false;
          m_injectedScriptManager.inspectorEnvironment().executionStopwatch()-&gt;start();
      }
  
<span class="line-modified">!     m_pausedGlobalObject = nullptr;</span>
      m_currentCallStack = { };
      m_injectedScriptManager.releaseObjectGroup(InspectorDebuggerAgent::backtraceObjectGroup);
<span class="line-modified">!     clearPauseDetails();</span>
      clearExceptionValue();
  
      if (m_conditionToDispatchResumed == ShouldDispatchResumed::WhenContinued)
          m_frontendDispatcher-&gt;resumed();
  }
  
<span class="line-modified">! void InspectorDebuggerAgent::breakProgram(DebuggerFrontendDispatcher::Reason reason, RefPtr&lt;JSON::Object&gt;&amp;&amp; data)</span>
  {
<span class="line-modified">!     updatePauseReasonAndData(reason, WTFMove(data));</span>
<span class="line-modified">! </span>
      m_scriptDebugServer.breakProgram();
  }
  
  void InspectorDebuggerAgent::clearInspectorBreakpointState()
  {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1116,20 ***</span>
  {
      {
          JSC::JSLockHolder holder(m_scriptDebugServer.vm());
          m_scriptDebugServer.clearBreakpointActions();
          m_scriptDebugServer.clearBreakpoints();
<span class="line-modified">!         m_scriptDebugServer.clearBlacklist();</span>
      }
  
<span class="line-modified">!     m_pausedScriptState = nullptr;</span>
      m_currentCallStack = { };
      m_scripts.clear();
      m_breakpointIdentifierToDebugServerBreakpointIDs.clear();
      m_debuggerBreakpointIdentifierToInspectorBreakpointIdentifier.clear();
      m_continueToLocationBreakpointID = JSC::noBreakpointID;
<span class="line-modified">!     clearBreakDetails();</span>
      m_javaScriptPauseScheduled = false;
      m_hasExceptionValue = false;
  
      if (isPaused()) {
          m_scriptDebugServer.continueProgram();
<span class="line-new-header">--- 1218,20 ---</span>
  {
      {
          JSC::JSLockHolder holder(m_scriptDebugServer.vm());
          m_scriptDebugServer.clearBreakpointActions();
          m_scriptDebugServer.clearBreakpoints();
<span class="line-modified">!         m_scriptDebugServer.clearBlackbox();</span>
      }
  
<span class="line-modified">!     m_pausedGlobalObject = nullptr;</span>
      m_currentCallStack = { };
      m_scripts.clear();
      m_breakpointIdentifierToDebugServerBreakpointIDs.clear();
      m_debuggerBreakpointIdentifierToInspectorBreakpointIdentifier.clear();
      m_continueToLocationBreakpointID = JSC::noBreakpointID;
<span class="line-modified">!     clearPauseDetails();</span>
      m_javaScriptPauseScheduled = false;
      m_hasExceptionValue = false;
  
      if (isPaused()) {
          m_scriptDebugServer.continueProgram();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1148,22 ***</span>
      m_frontendDispatcher-&gt;globalObjectCleared();
  }
  
  bool InspectorDebuggerAgent::assertPaused(ErrorString&amp; errorString)
  {
<span class="line-modified">!     if (!m_pausedScriptState) {</span>
          errorString = &quot;Must be paused&quot;_s;
          return false;
      }
  
      return true;
  }
  
<span class="line-modified">! void InspectorDebuggerAgent::clearBreakDetails()</span>
  {
<span class="line-modified">!     m_breakReason = DebuggerFrontendDispatcher::Reason::Other;</span>
<span class="line-removed">-     m_breakData = nullptr;</span>
  }
  
  void InspectorDebuggerAgent::clearExceptionValue()
  {
      if (m_hasExceptionValue) {
<span class="line-new-header">--- 1250,21 ---</span>
      m_frontendDispatcher-&gt;globalObjectCleared();
  }
  
  bool InspectorDebuggerAgent::assertPaused(ErrorString&amp; errorString)
  {
<span class="line-modified">!     if (!m_pausedGlobalObject) {</span>
          errorString = &quot;Must be paused&quot;_s;
          return false;
      }
  
      return true;
  }
  
<span class="line-modified">! void InspectorDebuggerAgent::clearPauseDetails()</span>
  {
<span class="line-modified">!     updatePauseReasonAndData(DebuggerFrontendDispatcher::Reason::Other, nullptr);</span>
  }
  
  void InspectorDebuggerAgent::clearExceptionValue()
  {
      if (m_hasExceptionValue) {
</pre>
<center><a href="InspectorConsoleAgent.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="InspectorDebuggerAgent.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>