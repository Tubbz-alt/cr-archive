<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/WebCore/css/CSSVariableReferenceValue.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 // Copyright 2015 The Chromium Authors. All rights reserved.
  2 // Copyright (C) 2016 Apple Inc. All rights reserved.
  3 //
  4 // Redistribution and use in source and binary forms, with or without
  5 // modification, are permitted provided that the following conditions are
  6 // met:
  7 //
  8 //    * Redistributions of source code must retain the above copyright
  9 // notice, this list of conditions and the following disclaimer.
 10 //    * Redistributions in binary form must reproduce the above
 11 // copyright notice, this list of conditions and the following disclaimer
 12 // in the documentation and/or other materials provided with the
 13 // distribution.
 14 //    * Neither the name of Google Inc. nor the names of its
 15 // contributors may be used to endorse or promote products derived from
 16 // this software without specific prior written permission.
 17 //
 18 // THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 19 // &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 20 // LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 21 // A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 22 // OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 23 // SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 24 // LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 25 // DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 26 // THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 27 // (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 28 // OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 29 
 30 #include &quot;config.h&quot;
 31 #include &quot;CSSVariableReferenceValue.h&quot;
 32 
 33 #include &quot;RenderStyle.h&quot;
<a name="1" id="anc1"></a><span class="line-added"> 34 #include &quot;StyleBuilder.h&quot;</span>
 35 #include &quot;StyleResolver.h&quot;
 36 
 37 namespace WebCore {
 38 
 39 String CSSVariableReferenceValue::customCSSText() const
 40 {
 41     if (!m_serialized) {
 42         m_serialized = true;
 43         m_stringValue = m_data-&gt;tokenRange().serialize();
 44     }
 45     return m_stringValue;
 46 }
 47 
<a name="2" id="anc2"></a><span class="line-modified"> 48 static bool resolveTokenRange(CSSParserTokenRange, Vector&lt;CSSParserToken&gt;&amp;, Style::BuilderState&amp;);</span>
 49 
<a name="3" id="anc3"></a><span class="line-modified"> 50 static bool resolveVariableFallback(CSSParserTokenRange range, Vector&lt;CSSParserToken&gt;&amp; result, Style::BuilderState&amp; builderState)</span>
 51 {
 52     if (range.atEnd())
 53         return false;
 54     ASSERT(range.peek().type() == CommaToken);
 55     range.consume();
<a name="4" id="anc4"></a><span class="line-modified"> 56     return resolveTokenRange(range, result, builderState);</span>
 57 }
 58 
<a name="5" id="anc5"></a><span class="line-modified"> 59 static bool resolveVariableReference(CSSParserTokenRange range, Vector&lt;CSSParserToken&gt;&amp; result, Style::BuilderState&amp; builderState)</span>
 60 {
<a name="6" id="anc6"></a><span class="line-modified"> 61     auto&amp; registeredProperties = builderState.document().getCSSRegisteredCustomPropertySet();</span>
<span class="line-modified"> 62     auto&amp; style = builderState.style();</span>
 63 
 64     range.consumeWhitespace();
 65     ASSERT(range.peek().type() == IdentToken);
 66     String variableName = range.consumeIncludingWhitespace().value().toString();
 67     ASSERT(range.atEnd() || (range.peek().type() == CommaToken));
 68 
 69     // Apply this variable first, in case it is still unresolved
<a name="7" id="anc7"></a><span class="line-modified"> 70     builderState.builder().applyCustomProperty(variableName);</span>
 71 
 72     // Apply fallback to detect cycles
 73     Vector&lt;CSSParserToken&gt; fallbackResult;
<a name="8" id="anc8"></a><span class="line-modified"> 74     bool fallbackReturn = resolveVariableFallback(CSSParserTokenRange(range), fallbackResult, builderState);</span>
 75 
 76     auto* property = style.getCustomProperty(variableName);
 77 
 78     if (!property || property-&gt;isUnset()) {
 79         auto* registered = registeredProperties.get(variableName);
 80         if (registered &amp;&amp; registered-&gt;initialValue())
 81             property = registered-&gt;initialValue();
 82     }
 83 
 84     if (!property || property-&gt;isInvalid()) {
 85         if (fallbackReturn)
 86             result.appendVector(fallbackResult);
 87         return fallbackReturn;
 88     }
 89 
 90     ASSERT(property-&gt;isResolved());
 91     result.appendVector(property-&gt;tokens());
 92 
 93     return true;
 94 }
 95 
<a name="9" id="anc9"></a><span class="line-modified"> 96 static bool resolveTokenRange(CSSParserTokenRange range, Vector&lt;CSSParserToken&gt;&amp; result, Style::BuilderState&amp; builderState)</span>
 97 {
 98     bool success = true;
 99     while (!range.atEnd()) {
100         if (range.peek().functionId() == CSSValueVar || range.peek().functionId() == CSSValueEnv)
<a name="10" id="anc10"></a><span class="line-modified">101             success &amp;= resolveVariableReference(range.consumeBlock(), result, builderState);</span>
102         else
103             result.append(range.consume());
104     }
105     return success;
106 }
107 
<a name="11" id="anc11"></a><span class="line-modified">108 RefPtr&lt;CSSVariableData&gt; CSSVariableReferenceValue::resolveVariableReferences(Style::BuilderState&amp; builderState) const</span>
109 {
110     Vector&lt;CSSParserToken&gt; resolvedTokens;
111     CSSParserTokenRange range = m_data-&gt;tokenRange();
112 
<a name="12" id="anc12"></a><span class="line-modified">113     if (!resolveTokenRange(range, resolvedTokens, builderState))</span>
114         return nullptr;
115 
116     return CSSVariableData::create(resolvedTokens);
117 }
118 
119 } // namespace WebCore
<a name="13" id="anc13"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="13" type="hidden" />
</body>
</html>