<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WebCore/loader/DocumentLoader.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="CrossOriginPreflightChecker.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="DocumentLoader.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/loader/DocumentLoader.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (C) 2006-2018 Apple Inc. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (C) 2006-2020 Apple Inc. All rights reserved.</span>
   * Copyright (C) 2011 Google Inc. All rights reserved.
   *
   * Redistribution and use in source and binary forms, with or without
   * modification, are permitted provided that the following conditions
   * are met:
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -57,10 +57,11 @@</span>
  #include &quot;HTTPHeaderNames.h&quot;
  #include &quot;HistoryItem.h&quot;
  #include &quot;HistoryController.h&quot;
  #include &quot;IconLoader.h&quot;
  #include &quot;InspectorInstrumentation.h&quot;
<span class="udiff-line-added">+ #include &quot;LegacySchemeRegistry.h&quot;</span>
  #include &quot;LinkIconCollector.h&quot;
  #include &quot;LinkIconType.h&quot;
  #include &quot;LoaderStrategy.h&quot;
  #include &quot;Logging.h&quot;
  #include &quot;MemoryCache.h&quot;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -72,11 +73,10 @@</span>
  #include &quot;ProgressTracker.h&quot;
  #include &quot;ResourceHandle.h&quot;
  #include &quot;ResourceLoadObserver.h&quot;
  #include &quot;RuntimeEnabledFeatures.h&quot;
  #include &quot;SWClientConnection.h&quot;
<span class="udiff-line-removed">- #include &quot;SchemeRegistry.h&quot;</span>
  #include &quot;ScriptableDocumentParser.h&quot;
  #include &quot;SecurityPolicy.h&quot;
  #include &quot;ServiceWorker.h&quot;
  #include &quot;ServiceWorkerClientData.h&quot;
  #include &quot;ServiceWorkerProvider.h&quot;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -100,10 +100,12 @@</span>
  #include &quot;ArchiveFactory.h&quot;
  #endif
  
  #if ENABLE(CONTENT_FILTERING)
  #include &quot;ContentFilter.h&quot;
<span class="udiff-line-added">+ #include &quot;FrameLoadRequest.h&quot;</span>
<span class="udiff-line-added">+ #include &quot;ScriptController.h&quot;</span>
  #endif
  
  #if USE(QUICK_LOOK)
  #include &quot;PreviewConverter.h&quot;
  #include &quot;QuickLook.h&quot;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -123,64 +125,23 @@</span>
  {
      for (auto&amp; loader : copyToVector(loaders.values()))
          loader-&gt;setDefersLoading(defers);
  }
  
<span class="udiff-line-modified-removed">- static bool shouldPendingCachedResourceLoadPreventPageCache(CachedResource&amp; cachedResource)</span>
<span class="udiff-line-modified-added">+ static HashMap&lt;DocumentIdentifier, DocumentLoader*&gt;&amp; temporaryIdentifierToLoaderMap()</span>
  {
<span class="udiff-line-modified-removed">-     if (!cachedResource.isLoading())</span>
<span class="udiff-line-modified-removed">-         return false;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     switch (cachedResource.type()) {</span>
<span class="udiff-line-removed">-     case CachedResource::Type::ImageResource:</span>
<span class="udiff-line-removed">-     case CachedResource::Type::Icon:</span>
<span class="udiff-line-removed">-     case CachedResource::Type::Beacon:</span>
<span class="udiff-line-removed">-     case CachedResource::Type::Ping:</span>
<span class="udiff-line-removed">-     case CachedResource::Type::LinkPrefetch:</span>
<span class="udiff-line-removed">-         return false;</span>
<span class="udiff-line-removed">-     case CachedResource::Type::MainResource:</span>
<span class="udiff-line-removed">-     case CachedResource::Type::CSSStyleSheet:</span>
<span class="udiff-line-removed">-     case CachedResource::Type::Script:</span>
<span class="udiff-line-removed">-     case CachedResource::Type::FontResource:</span>
<span class="udiff-line-removed">- #if ENABLE(SVG_FONTS)</span>
<span class="udiff-line-removed">-     case CachedResource::Type::SVGFontResource:</span>
<span class="udiff-line-removed">- #endif</span>
<span class="udiff-line-removed">-     case CachedResource::Type::MediaResource:</span>
<span class="udiff-line-removed">-     case CachedResource::Type::RawResource:</span>
<span class="udiff-line-removed">-     case CachedResource::Type::SVGDocumentResource:</span>
<span class="udiff-line-removed">- #if ENABLE(XSLT)</span>
<span class="udiff-line-removed">-     case CachedResource::Type::XSLStyleSheet:</span>
<span class="udiff-line-removed">- #endif</span>
<span class="udiff-line-removed">- #if ENABLE(VIDEO_TRACK)</span>
<span class="udiff-line-removed">-     case CachedResource::Type::TextTrackResource:</span>
<span class="udiff-line-removed">- #endif</span>
<span class="udiff-line-removed">- #if ENABLE(APPLICATION_MANIFEST)</span>
<span class="udiff-line-removed">-     case CachedResource::Type::ApplicationManifest:</span>
<span class="udiff-line-removed">- #endif</span>
<span class="udiff-line-removed">-         break;</span>
<span class="udiff-line-removed">-     };</span>
<span class="udiff-line-removed">-     return !cachedResource.areAllClientsXMLHttpRequests();</span>
<span class="udiff-line-modified-added">+     static NeverDestroyed&lt;HashMap&lt;DocumentIdentifier, DocumentLoader*&gt;&gt; map;</span>
<span class="udiff-line-modified-added">+     return map.get();</span>
  }
  
<span class="udiff-line-modified-removed">- static bool areAllLoadersPageCacheAcceptable(const ResourceLoaderMap&amp; loaders)</span>
<span class="udiff-line-modified-added">+ DocumentLoader* DocumentLoader::fromTemporaryDocumentIdentifier(DocumentIdentifier identifier)</span>
  {
<span class="udiff-line-modified-removed">-     for (auto&amp; loader : copyToVector(loaders.values())) {</span>
<span class="udiff-line-removed">-         if (!loader-&gt;frameLoader() || !loader-&gt;frameLoader()-&gt;frame().page())</span>
<span class="udiff-line-removed">-             return false;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         CachedResource* cachedResource = MemoryCache::singleton().resourceForRequest(loader-&gt;request(), loader-&gt;frameLoader()-&gt;frame().page()-&gt;sessionID());</span>
<span class="udiff-line-removed">-         if (!cachedResource)</span>
<span class="udiff-line-removed">-             return false;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         // Only image and XHR loads do not prevent the page from entering the PageCache.</span>
<span class="udiff-line-removed">-         // All non-image loads will prevent the page from entering the PageCache.</span>
<span class="udiff-line-removed">-         if (shouldPendingCachedResourceLoadPreventPageCache(*cachedResource))</span>
<span class="udiff-line-removed">-             return false;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-     return true;</span>
<span class="udiff-line-modified-added">+     return temporaryIdentifierToLoaderMap().get(identifier);</span>
  }
  
<span class="udiff-line-added">+ DEFINE_ALLOCATOR_WITH_HEAP_IDENTIFIER(DocumentLoader);</span>
<span class="udiff-line-added">+ </span>
  DocumentLoader::DocumentLoader(const ResourceRequest&amp; request, const SubstituteData&amp; substituteData)
      : FrameDestructionObserver(nullptr)
      , m_cachedResourceLoader(CachedResourceLoader::create(this))
      , m_originalRequest(request)
      , m_substituteData(substituteData)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -213,10 +174,17 @@</span>
      ASSERT_WITH_MESSAGE(!m_waitingForContentPolicy, &quot;The content policy callback should never outlive its DocumentLoader.&quot;);
      ASSERT_WITH_MESSAGE(!m_waitingForNavigationPolicy, &quot;The navigation policy callback should never outlive its DocumentLoader.&quot;);
  
      m_cachedResourceLoader-&gt;clearDocumentLoader();
      clearMainResource();
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ #if ENABLE(SERVICE_WORKER)</span>
<span class="udiff-line-added">+     if (m_temporaryServiceWorkerClient) {</span>
<span class="udiff-line-added">+         ASSERT(temporaryIdentifierToLoaderMap().contains(*m_temporaryServiceWorkerClient));</span>
<span class="udiff-line-added">+         temporaryIdentifierToLoaderMap().remove(*m_temporaryServiceWorkerClient);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ #endif</span>
  }
  
  RefPtr&lt;SharedBuffer&gt; DocumentLoader::mainResourceData() const
  {
      if (m_substituteData.isValid())
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -257,12 +225,16 @@</span>
      // source is committed, except in the unreachable URL case. It
      // would be a WebFoundation bug if it sent a redirect callback after commit.
      ASSERT(!m_committed);
  
      m_request = req;
<span class="udiff-line-modified-removed">-     if (shouldNotifyAboutProvisionalURLChange)</span>
<span class="udiff-line-modified-added">+     if (shouldNotifyAboutProvisionalURLChange) {</span>
<span class="udiff-line-added">+         // Logging for &lt;rdar://problem/54830233&gt;.</span>
<span class="udiff-line-added">+         if (!frameLoader()-&gt;provisionalDocumentLoader())</span>
<span class="udiff-line-added">+             RELEASE_LOG_IF_ALLOWED(&quot;DocumentLoader::setRequest: With no provisional document loader (frame = %p, main = %d)&quot;, m_frame, m_frame ? m_frame-&gt;isMainFrame() : false);</span>
          frameLoader()-&gt;client().dispatchDidChangeProvisionalURL();
<span class="udiff-line-added">+     }</span>
  }
  
  void DocumentLoader::setMainDocumentError(const ResourceError&amp; error)
  {
      if (!error.isNull())
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -312,17 +284,10 @@</span>
      // In some rare cases, calling FrameLoader::stopLoading could cause isLoading() to return false.
      // (This can happen when there&#39;s a single XMLHttpRequest currently loading and stopLoading causes it
      // to stop loading. Because of this, we need to save it so we don&#39;t return early.
      bool loading = isLoading();
  
<span class="udiff-line-removed">-     // We may want to audit the existing subresource loaders when we are on a page which has completed</span>
<span class="udiff-line-removed">-     // loading but there are subresource loads during cancellation. This must be done before the</span>
<span class="udiff-line-removed">-     // frame-&gt;stopLoading() call, which may evict the CachedResources, which we rely on to check</span>
<span class="udiff-line-removed">-     // the type of the resource loads.</span>
<span class="udiff-line-removed">-     if (loading &amp;&amp; m_committed &amp;&amp; !mainResourceLoader() &amp;&amp; !m_subresourceLoaders.isEmpty())</span>
<span class="udiff-line-removed">-         m_subresourceLoadersArePageCacheAcceptable = areAllLoadersPageCacheAcceptable(m_subresourceLoaders);</span>
<span class="udiff-line-removed">- </span>
      if (m_committed) {
          // Attempt to stop the frame if the document loader is loading, or if it is done loading but
          // still  parsing. Failure to do so can cause a world leak.
          Document* doc = m_frame-&gt;document();
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -527,27 +492,35 @@</span>
          m_dataLoadTimer.schedule(*scheduledPairs);
  #endif
  }
  
  #if ENABLE(SERVICE_WORKER)
<span class="udiff-line-added">+ bool DocumentLoader::setControllingServiceWorkerRegistration(ServiceWorkerRegistrationData&amp;&amp; data)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     if (!m_loadingMainResource)</span>
<span class="udiff-line-added">+         return false;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     ASSERT(!m_gotFirstByte);</span>
<span class="udiff-line-added">+     m_serviceWorkerRegistrationData = WTFMove(data);</span>
<span class="udiff-line-added">+     return true;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  void DocumentLoader::matchRegistration(const URL&amp; url, SWClientConnection::RegistrationCallback&amp;&amp; callback)
  {
<span class="udiff-line-modified-removed">-     auto shouldTryLoadingThroughServiceWorker = !frameLoader()-&gt;isReloadingFromOrigin() &amp;&amp; m_frame-&gt;page() &amp;&amp; RuntimeEnabledFeatures::sharedFeatures().serviceWorkerEnabled() &amp;&amp; SchemeRegistry::canServiceWorkersHandleURLScheme(url.protocol().toStringWithoutCopying());</span>
<span class="udiff-line-modified-added">+     auto shouldTryLoadingThroughServiceWorker = !frameLoader()-&gt;isReloadingFromOrigin() &amp;&amp; m_frame-&gt;page() &amp;&amp; RuntimeEnabledFeatures::sharedFeatures().serviceWorkerEnabled() &amp;&amp; LegacySchemeRegistry::canServiceWorkersHandleURLScheme(url.protocol().toStringWithoutCopying());</span>
      if (!shouldTryLoadingThroughServiceWorker) {
          callback(WTF::nullopt);
          return;
      }
  
      auto origin = (!m_frame-&gt;isMainFrame() &amp;&amp; m_frame-&gt;document()) ? m_frame-&gt;document()-&gt;topOrigin().data() : SecurityOriginData::fromURL(url);
<span class="udiff-line-modified-removed">-     auto sessionID = m_frame-&gt;page()-&gt;sessionID();</span>
<span class="udiff-line-removed">-     auto&amp; provider = ServiceWorkerProvider::singleton();</span>
<span class="udiff-line-removed">-     if (!provider.mayHaveServiceWorkerRegisteredForOrigin(sessionID, origin)) {</span>
<span class="udiff-line-modified-added">+     if (!ServiceWorkerProvider::singleton().serviceWorkerConnection().mayHaveServiceWorkerRegisteredForOrigin(origin)) {</span>
          callback(WTF::nullopt);
          return;
      }
  
<span class="udiff-line-modified-removed">-     auto&amp; connection = ServiceWorkerProvider::singleton().serviceWorkerConnectionForSession(sessionID);</span>
<span class="udiff-line-modified-added">+     auto&amp; connection = ServiceWorkerProvider::singleton().serviceWorkerConnection();</span>
      connection.matchRegistration(WTFMove(origin), url, WTFMove(callback));
  }
  
  static inline bool areRegistrationsEqual(const Optional&lt;ServiceWorkerRegistrationData&gt;&amp; a, const Optional&lt;ServiceWorkerRegistrationData&gt;&amp; b)
  {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -561,42 +534,38 @@</span>
  
  void DocumentLoader::redirectReceived(CachedResource&amp; resource, ResourceRequest&amp;&amp; request, const ResourceResponse&amp; redirectResponse, CompletionHandler&lt;void(ResourceRequest&amp;&amp;)&gt;&amp;&amp; completionHandler)
  {
      ASSERT_UNUSED(resource, &amp;resource == m_mainResource);
  #if ENABLE(SERVICE_WORKER)
<span class="udiff-line-modified-removed">-     bool isRedirectionFromServiceWorker = redirectResponse.source() == ResourceResponse::Source::ServiceWorker;</span>
<span class="udiff-line-modified-removed">-     willSendRequest(WTFMove(request), redirectResponse, [isRedirectionFromServiceWorker, completionHandler = WTFMove(completionHandler), protectedThis = makeRef(*this), this] (auto&amp;&amp; request) mutable {</span>
<span class="udiff-line-modified-added">+     if (m_serviceWorkerRegistrationData) {</span>
<span class="udiff-line-modified-added">+         m_serviceWorkerRegistrationData = { };</span>
<span class="udiff-line-added">+         unregisterTemporaryServiceWorkerClient();</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+     willSendRequest(WTFMove(request), redirectResponse, [completionHandler = WTFMove(completionHandler), protectedThis = makeRef(*this), this] (auto&amp;&amp; request) mutable {</span>
          ASSERT(!m_substituteData.isValid());
          if (request.isNull() || !m_mainDocumentError.isNull() || !m_frame) {
              completionHandler({ });
              return;
          }
  
<span class="udiff-line-modified-removed">-         auto url = request.url();</span>
<span class="udiff-line-modified-removed">-         this-&gt;matchRegistration(url, [request = WTFMove(request), isRedirectionFromServiceWorker, completionHandler = WTFMove(completionHandler), protectedThis = WTFMove(protectedThis), this] (auto&amp;&amp; registrationData) mutable {</span>
<span class="udiff-line-modified-removed">-             if (!m_mainDocumentError.isNull() || !m_frame) {</span>
<span class="udiff-line-modified-removed">-                 completionHandler({ });</span>
<span class="udiff-line-modified-removed">-                 return;</span>
<span class="udiff-line-modified-removed">-             }</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-             if (!registrationData &amp;&amp; this-&gt;tryLoadingRedirectRequestFromApplicationCache(request)) {</span>
<span class="udiff-line-modified-removed">-                 completionHandler({ });</span>
<span class="udiff-line-modified-removed">-                 return;</span>
<span class="udiff-line-modified-removed">-             }</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-removed">-             bool shouldContinueLoad = areRegistrationsEqual(m_serviceWorkerRegistrationData, registrationData)</span>
<span class="udiff-line-removed">-                 &amp;&amp; isRedirectionFromServiceWorker == !!registrationData;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             if (shouldContinueLoad) {</span>
<span class="udiff-line-modified-added">+         if (m_applicationCacheHost-&gt;canLoadMainResource(request)) {</span>
<span class="udiff-line-modified-added">+             auto url = request.url();</span>
<span class="udiff-line-modified-added">+             // Let&#39;s check service worker registration to see whether loading from network or not.</span>
<span class="udiff-line-modified-added">+             this-&gt;matchRegistration(url, [request = WTFMove(request), completionHandler = WTFMove(completionHandler), protectedThis = WTFMove(protectedThis), this](auto&amp;&amp; registrationData) mutable {</span>
<span class="udiff-line-modified-added">+                 if (!m_mainDocumentError.isNull() || !m_frame) {</span>
<span class="udiff-line-modified-added">+                     completionHandler({ });</span>
<span class="udiff-line-modified-added">+                     return;</span>
<span class="udiff-line-modified-added">+                 }</span>
<span class="udiff-line-modified-added">+                 if (!registrationData &amp;&amp; this-&gt;tryLoadingRedirectRequestFromApplicationCache(request)) {</span>
<span class="udiff-line-modified-added">+                     completionHandler({ });</span>
<span class="udiff-line-modified-added">+                     return;</span>
<span class="udiff-line-modified-added">+                 }</span>
                  completionHandler(WTFMove(request));
<span class="udiff-line-modified-removed">-                 return;</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             this-&gt;restartLoadingDueToServiceWorkerRegistrationChange(WTFMove(request), WTFMove(registrationData));</span>
<span class="udiff-line-removed">-             completionHandler({ });</span>
<span class="udiff-line-modified-added">+             });</span>
              return;
<span class="udiff-line-modified-removed">-         });</span>
<span class="udiff-line-modified-added">+         }</span>
<span class="udiff-line-added">+         completionHandler(WTFMove(request));</span>
      });
  #else
      willSendRequest(WTFMove(request), redirectResponse, WTFMove(completionHandler));
  #endif
  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -607,10 +576,14 @@</span>
      // fact that this &quot;callback&quot; is sent when starting every load, and the state of callback
      // deferrals plays less of a part in this function in preventing the bad behavior deferring
      // callbacks is meant to prevent.
      ASSERT(!newRequest.isNull());
  
<span class="udiff-line-added">+     // Logging for &lt;rdar://problem/54830233&gt;.</span>
<span class="udiff-line-added">+     if (!frameLoader() || !frameLoader()-&gt;provisionalDocumentLoader())</span>
<span class="udiff-line-added">+         RELEASE_LOG_IF_ALLOWED(&quot;willSendRequest: With no provisional document loader (frame = %p, main = %d)&quot;, m_frame, m_frame ? m_frame-&gt;isMainFrame() : false);</span>
<span class="udiff-line-added">+ </span>
      bool didReceiveRedirectResponse = !redirectResponse.isNull();
      if (!frameLoader()-&gt;checkIfFormActionAllowedByCSP(newRequest.url(), didReceiveRedirectResponse)) {
          RELEASE_LOG_IF_ALLOWED(&quot;willSendRequest: canceling - form action not allowed by CSP (frame = %p, main = %d)&quot;, m_frame, m_frame-&gt;isMainFrame());
          cancelMainResourceLoad(frameLoader()-&gt;cancelledError(newRequest));
          return completionHandler(WTFMove(newRequest));
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -755,24 +728,10 @@</span>
  
      handleSubstituteDataLoadNow();
      return true;
  }
  
<span class="udiff-line-removed">- #if ENABLE(SERVICE_WORKER)</span>
<span class="udiff-line-removed">- void DocumentLoader::restartLoadingDueToServiceWorkerRegistrationChange(ResourceRequest&amp;&amp; request, Optional&lt;ServiceWorkerRegistrationData&gt;&amp;&amp; registrationData)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-     clearMainResource();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     ASSERT(!isCommitted());</span>
<span class="udiff-line-removed">-     m_serviceWorkerRegistrationData = WTFMove(registrationData);</span>
<span class="udiff-line-removed">-     loadMainResource(WTFMove(request));</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     if (m_mainResource)</span>
<span class="udiff-line-removed">-         frameLoader()-&gt;client().dispatchDidReceiveServerRedirectForProvisionalLoad();</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- #endif</span>
<span class="udiff-line-removed">- </span>
  void DocumentLoader::stopLoadingAfterXFrameOptionsOrContentSecurityPolicyDenied(unsigned long identifier, const ResourceResponse&amp; response)
  {
      Ref&lt;DocumentLoader&gt; protectedThis { *this };
      InspectorInstrumentation::continueAfterXFrameOptionsDenied(*m_frame, identifier, *this, response);
      m_frame-&gt;document()-&gt;enforceSandboxFlags(SandboxOrigin);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -785,15 +744,29 @@</span>
  }
  
  void DocumentLoader::responseReceived(CachedResource&amp; resource, const ResourceResponse&amp; response, CompletionHandler&lt;void()&gt;&amp;&amp; completionHandler)
  {
      ASSERT_UNUSED(resource, m_mainResource == &amp;resource);
<span class="udiff-line-added">+ #if ENABLE(SERVICE_WORKER)</span>
<span class="udiff-line-added">+     if (RuntimeEnabledFeatures::sharedFeatures().serviceWorkerEnabled() &amp;&amp; response.source() == ResourceResponse::Source::MemoryCache) {</span>
<span class="udiff-line-added">+         matchRegistration(response.url(), [this, protectedThis = makeRef(*this), response, completionHandler = WTFMove(completionHandler)](auto&amp;&amp; registrationData) mutable {</span>
<span class="udiff-line-added">+             if (!m_mainDocumentError.isNull() || !m_frame) {</span>
<span class="udiff-line-added">+                 completionHandler();</span>
<span class="udiff-line-added">+                 return;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             m_serviceWorkerRegistrationData = WTFMove(registrationData);</span>
<span class="udiff-line-added">+             responseReceived(response, WTFMove(completionHandler));</span>
<span class="udiff-line-added">+         });</span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ #endif</span>
      responseReceived(response, WTFMove(completionHandler));
  }
  
  void DocumentLoader::responseReceived(const ResourceResponse&amp; response, CompletionHandler&lt;void()&gt;&amp;&amp; completionHandler)
  {
<span class="udiff-line-added">+     ASSERT(response.certificateInfo());</span>
      CompletionHandlerCallingScope completionHandlerCaller(WTFMove(completionHandler));
  
  #if ENABLE(CONTENT_FILTERING)
      if (m_contentFilter &amp;&amp; !m_contentFilter-&gt;continueAfterResponseReceived(response))
          return;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -880,12 +853,12 @@</span>
      RefPtr&lt;SubresourceLoader&gt; mainResourceLoader = this-&gt;mainResourceLoader();
      if (mainResourceLoader)
          mainResourceLoader-&gt;markInAsyncResponsePolicyCheck();
      auto requestIdentifier = PolicyCheckIdentifier::create();
      frameLoader()-&gt;checkContentPolicy(m_response, requestIdentifier, [this, protectedThis = makeRef(*this), mainResourceLoader = WTFMove(mainResourceLoader),
<span class="udiff-line-modified-removed">-         completionHandler = completionHandlerCaller.release(), requestIdentifier] (PolicyAction policy, PolicyCheckIdentifier responseIdentifeir) mutable {</span>
<span class="udiff-line-modified-removed">-         RELEASE_ASSERT(responseIdentifeir.isValidFor(requestIdentifier));</span>
<span class="udiff-line-modified-added">+         completionHandler = completionHandlerCaller.release(), requestIdentifier] (PolicyAction policy, PolicyCheckIdentifier responseIdentifier) mutable {</span>
<span class="udiff-line-modified-added">+         RELEASE_ASSERT(responseIdentifier.isValidFor(requestIdentifier));</span>
          continueAfterContentPolicy(policy);
          if (mainResourceLoader)
              mainResourceLoader-&gt;didReceiveResponsePolicy();
          if (completionHandler)
              completionHandler();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -921,11 +894,11 @@</span>
  #endif
  
      if (m_substituteData.isValid())
          return false;
  
<span class="udiff-line-modified-removed">-     if (!SchemeRegistry::shouldTreatURLSchemeAsLocal(m_request.url().protocol().toStringWithoutCopying()))</span>
<span class="udiff-line-modified-added">+     if (!LegacySchemeRegistry::shouldTreatURLSchemeAsLocal(m_request.url().protocol().toStringWithoutCopying()))</span>
          return true;
  
      if (!frame() || (frame()-&gt;isMainFrame() &amp;&amp; m_allowsWebArchiveForMainFrame))
          return false;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -933,20 +906,45 @@</span>
      if (frame()-&gt;mainFrame().loader().alwaysAllowLocalWebarchive())
          return false;
      return true;
  }
  
<span class="udiff-line-added">+ // Prevent data URIs from loading as the main frame unless the result of user action.</span>
<span class="udiff-line-added">+ bool DocumentLoader::disallowDataRequest() const</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     if (!m_response.url().protocolIsData())</span>
<span class="udiff-line-added">+         return false;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (!frame() || !frame()-&gt;isMainFrame() || m_allowsDataURLsForMainFrame || frame()-&gt;settings().allowTopNavigationToDataURLs())</span>
<span class="udiff-line-added">+         return false;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (auto* currentDocument = frame()-&gt;document()) {</span>
<span class="udiff-line-added">+         unsigned long identifier = m_identifierForLoadWithoutResourceLoader ? m_identifierForLoadWithoutResourceLoader : m_mainResource-&gt;identifier();</span>
<span class="udiff-line-added">+         ASSERT(identifier);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         currentDocument-&gt;addConsoleMessage(MessageSource::Security, MessageLevel::Error, makeString(&quot;Not allowed to navigate top frame to data URL &#39;&quot;, m_response.url().stringCenterEllipsizedToLength(), &quot;&#39;.&quot;), identifier);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+     RELEASE_LOG_IF_ALLOWED(&quot;continueAfterContentPolicy: cannot show URL (frame = %p, main = %d)&quot;, m_frame, m_frame-&gt;isMainFrame());</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     return true;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  void DocumentLoader::continueAfterContentPolicy(PolicyAction policy)
  {
      ASSERT(m_waitingForContentPolicy);
      m_waitingForContentPolicy = false;
      if (isStopping())
          return;
  
<span class="udiff-line-added">+     if (!m_frame) {</span>
<span class="udiff-line-added">+         RELEASE_LOG_IF_ALLOWED(&quot;continueAfterContentPolicy: Policy action %i received by DocumentLoader with null frame&quot;, (int)policy);</span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      switch (policy) {
      case PolicyAction::Use: {
<span class="udiff-line-modified-removed">-         if (!frameLoader()-&gt;client().canShowMIMEType(m_response.mimeType()) || disallowWebArchive()) {</span>
<span class="udiff-line-modified-added">+         if (!frameLoader()-&gt;client().canShowMIMEType(m_response.mimeType()) || disallowWebArchive() || disallowDataRequest()) {</span>
              frameLoader()-&gt;policyChecker().cannotShowMIMEType(m_response);
              // Check reachedTerminalState since the load may have already been canceled inside of _handleUnimplementablePolicyWithErrorCode::.
              stopLoadingForPolicyChange();
              return;
          }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -966,19 +964,15 @@</span>
  
          // When starting the request, we didn&#39;t know that it would result in download and not navigation. Now we know that main document URL didn&#39;t change.
          // Download may use this knowledge for purposes unrelated to cookies, notably for setting file quarantine data.
          frameLoader()-&gt;setOriginalURLForDownloadRequest(m_request);
  
<span class="udiff-line-removed">-         PAL::SessionID sessionID = PAL::SessionID::defaultSessionID();</span>
<span class="udiff-line-removed">-         if (frame() &amp;&amp; frame()-&gt;page())</span>
<span class="udiff-line-removed">-             sessionID = frame()-&gt;page()-&gt;sessionID();</span>
<span class="udiff-line-removed">- </span>
          if (m_request.url().protocolIsData()) {
              // We decode data URL internally, there is no resource load to convert.
              frameLoader()-&gt;client().startDownload(m_request);
          } else
<span class="udiff-line-modified-removed">-             frameLoader()-&gt;client().convertMainResourceLoadToDownload(this, sessionID, m_request, m_response);</span>
<span class="udiff-line-modified-added">+             frameLoader()-&gt;client().convertMainResourceLoadToDownload(this, m_request, m_response);</span>
  
          // The main resource might be loading from the memory cache, or its loader might have gone missing.
          if (mainResourceLoader()) {
              static_cast&lt;ResourceLoader*&gt;(mainResourceLoader())-&gt;didFail(interruptedForPolicyChangeError());
              return;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -989,11 +983,11 @@</span>
          stopLoadingForPolicyChange();
          return;
      }
      case PolicyAction::StopAllLoads:
          ASSERT_NOT_REACHED();
<span class="udiff-line-modified-removed">- #if ASSERT_DISABLED</span>
<span class="udiff-line-modified-added">+ #if !ASSERT_ENABLED</span>
          FALLTHROUGH;
  #endif
      case PolicyAction::Ignore:
          if (ResourceLoader* mainResourceLoader = this-&gt;mainResourceLoader())
              InspectorInstrumentation::continueWithPolicyIgnore(*m_frame, mainResourceLoader-&gt;identifier(), *this, m_response);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1061,15 +1055,14 @@</span>
      error.setType(ResourceError::Type::Cancellation);
      cancelMainResourceLoad(error);
  }
  
  #if ENABLE(SERVICE_WORKER)
<span class="udiff-line-modified-removed">- static inline bool isLocalURL(const URL&amp; url)</span>
<span class="udiff-line-modified-added">+ // https://w3c.github.io/ServiceWorker/#control-and-use-window-client</span>
<span class="udiff-line-added">+ static inline bool shouldUseActiveServiceWorkerFromParent(const Document&amp; document, const Document&amp; parent)</span>
  {
<span class="udiff-line-modified-removed">-     // https://fetch.spec.whatwg.org/#is-local</span>
<span class="udiff-line-removed">-     auto protocol = url.protocol().toStringWithoutCopying();</span>
<span class="udiff-line-removed">-     return equalLettersIgnoringASCIICase(protocol, &quot;data&quot;) || equalLettersIgnoringASCIICase(protocol, &quot;blob&quot;) || equalLettersIgnoringASCIICase(protocol, &quot;about&quot;);</span>
<span class="udiff-line-modified-added">+     return !document.url().protocolIsInHTTPFamily() &amp;&amp; !document.securityOrigin().isUnique() &amp;&amp; parent.securityOrigin().canAccess(document.securityOrigin());</span>
  }
  #endif
  
  void DocumentLoader::commitData(const char* bytes, size_t length)
  {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1096,17 +1089,17 @@</span>
  #if ENABLE(SERVICE_WORKER)
          if (RuntimeEnabledFeatures::sharedFeatures().serviceWorkerEnabled()) {
              if (m_serviceWorkerRegistrationData &amp;&amp; m_serviceWorkerRegistrationData-&gt;activeWorker) {
                  m_frame-&gt;document()-&gt;setActiveServiceWorker(ServiceWorker::getOrCreate(*m_frame-&gt;document(), WTFMove(m_serviceWorkerRegistrationData-&gt;activeWorker.value())));
                  m_serviceWorkerRegistrationData = { };
<span class="udiff-line-modified-removed">-             } else if (isLocalURL(m_frame-&gt;document()-&gt;url())) {</span>
<span class="udiff-line-modified-removed">-                 if (auto* parent = m_frame-&gt;document()-&gt;parentDocument())</span>
<span class="udiff-line-modified-added">+             } else if (auto* parent = m_frame-&gt;document()-&gt;parentDocument()) {</span>
<span class="udiff-line-modified-added">+                 if (shouldUseActiveServiceWorkerFromParent(*m_frame-&gt;document(), *parent))</span>
                      m_frame-&gt;document()-&gt;setActiveServiceWorker(parent-&gt;activeServiceWorker());
              }
  
<span class="udiff-line-modified-removed">-             if (m_frame-&gt;document()-&gt;activeServiceWorker() || SchemeRegistry::canServiceWorkersHandleURLScheme(m_frame-&gt;document()-&gt;url().protocol().toStringWithoutCopying()))</span>
<span class="udiff-line-modified-removed">-                 m_frame-&gt;document()-&gt;setServiceWorkerConnection(ServiceWorkerProvider::singleton().existingServiceWorkerConnectionForSession(m_frame-&gt;page()-&gt;sessionID()));</span>
<span class="udiff-line-modified-added">+             if (m_frame-&gt;document()-&gt;activeServiceWorker() || LegacySchemeRegistry::canServiceWorkersHandleURLScheme(m_frame-&gt;document()-&gt;url().protocol().toStringWithoutCopying()))</span>
<span class="udiff-line-modified-added">+                 m_frame-&gt;document()-&gt;setServiceWorkerConnection(&amp;ServiceWorkerProvider::singleton().serviceWorkerConnection());</span>
  
              // We currently unregister the temporary service worker client since we now registered the real document.
              // FIXME: We should make the real document use the temporary client identifier.
              unregisterTemporaryServiceWorkerClient();
          }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1216,11 +1209,11 @@</span>
  void DocumentLoader::checkLoadComplete()
  {
      if (!m_frame || isLoading())
          return;
  
<span class="udiff-line-modified-removed">-     ASSERT(this == frameLoader()-&gt;activeDocumentLoader());</span>
<span class="udiff-line-modified-added">+     // ASSERT(this == frameLoader()-&gt;activeDocumentLoader());</span>
      m_frame-&gt;document()-&gt;domWindow()-&gt;finishedLoading();
  }
  
  void DocumentLoader::applyPoliciesToSettings()
  {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1245,11 +1238,11 @@</span>
      ASSERT(!m_frame);
      observeFrame(&amp;frame);
      m_writer.setFrame(frame);
      attachToFrame();
  
<span class="udiff-line-modified-removed">- #ifndef NDEBUG</span>
<span class="udiff-line-modified-added">+ #if ASSERT_ENABLED</span>
      m_hasEverBeenAttached = true;
  #endif
  
      applyPoliciesToSettings();
  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1259,11 +1252,11 @@</span>
      ASSERT(m_frame);
  }
  
  void DocumentLoader::detachFromFrame()
  {
<span class="udiff-line-modified-removed">- #ifndef NDEBUG</span>
<span class="udiff-line-modified-added">+ #if ASSERT_ENABLED</span>
      if (m_hasEverBeenAttached)
          ASSERT_WITH_MESSAGE(m_frame, &quot;detachFromFrame() is being called on a DocumentLoader twice without an attachToFrame() inbetween&quot;);
      else
          ASSERT_WITH_MESSAGE(m_frame, &quot;detachFromFrame() is being called on a DocumentLoader that has never attached to any Frame&quot;);
  #endif
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1298,11 +1291,16 @@</span>
  
  void DocumentLoader::clearMainResourceLoader()
  {
      m_loadingMainResource = false;
  
<span class="udiff-line-modified-removed">-     if (this == frameLoader()-&gt;activeDocumentLoader())</span>
<span class="udiff-line-modified-added">+     auto* frameLoader = this-&gt;frameLoader();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (!frameLoader)</span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (this == frameLoader-&gt;activeDocumentLoader())</span>
          checkLoadComplete();
  }
  
  #if ENABLE(APPLICATION_MANIFEST)
  uint64_t DocumentLoader::loadApplicationManifest()
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1542,18 +1540,18 @@</span>
              loader-&gt;didFail(loader-&gt;cannotShowURLError());
          }
      }
  }
  
<span class="udiff-line-modified-removed">- #ifndef NDEBUG</span>
<span class="udiff-line-modified-added">+ #if ASSERT_ENABLED</span>
  
  bool DocumentLoader::isSubstituteLoadPending(ResourceLoader* loader) const
  {
      return m_pendingSubstituteResources.contains(loader);
  }
  
<span class="udiff-line-modified-removed">- #endif</span>
<span class="udiff-line-modified-added">+ #endif // ASSERT_ENABLED</span>
  
  void DocumentLoader::cancelPendingSubstituteLoad(ResourceLoader* loader)
  {
      if (m_pendingSubstituteResources.isEmpty())
          return;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1716,23 +1714,23 @@</span>
  
      // Application Cache loaders are handled by their ApplicationCacheGroup directly.
      if (loader-&gt;options().applicationCacheMode == ApplicationCacheMode::Bypass)
          return;
  
<span class="udiff-line-modified-removed">- #if !ASSERT_DISABLED</span>
<span class="udiff-line-modified-added">+ #if ASSERT_ENABLED</span>
      if (document()) {
<span class="udiff-line-modified-removed">-         switch (document()-&gt;pageCacheState()) {</span>
<span class="udiff-line-modified-removed">-         case Document::NotInPageCache:</span>
<span class="udiff-line-modified-added">+         switch (document()-&gt;backForwardCacheState()) {</span>
<span class="udiff-line-modified-added">+         case Document::NotInBackForwardCache:</span>
              break;
<span class="udiff-line-modified-removed">-         case Document::AboutToEnterPageCache: {</span>
<span class="udiff-line-modified-removed">-             // A page about to enter PageCache should only be able to start ping loads.</span>
<span class="udiff-line-modified-added">+         case Document::AboutToEnterBackForwardCache: {</span>
<span class="udiff-line-modified-added">+             // A page about to enter the BackForwardCache should only be able to start ping loads.</span>
              auto* cachedResource = MemoryCache::singleton().resourceForRequest(loader-&gt;request(), loader-&gt;frameLoader()-&gt;frame().page()-&gt;sessionID());
              ASSERT(cachedResource &amp;&amp; CachedResource::shouldUsePingLoad(cachedResource-&gt;type()));
              break;
          }
<span class="udiff-line-modified-removed">-         case Document::InPageCache:</span>
<span class="udiff-line-modified-removed">-             // A page in the PageCache should not be able to start loads.</span>
<span class="udiff-line-modified-added">+         case Document::InBackForwardCache:</span>
<span class="udiff-line-modified-added">+             // A page in the BackForwardCache should not be able to start loads.</span>
              ASSERT_NOT_REACHED();
              break;
          }
      }
  #endif
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1773,11 +1771,11 @@</span>
      return isLoadingMultipartContent() &amp;&amp; frameLoader()-&gt;isReplacing();
  }
  
  bool DocumentLoader::maybeLoadEmpty()
  {
<span class="udiff-line-modified-removed">-     bool shouldLoadEmpty = !m_substituteData.isValid() &amp;&amp; (m_request.url().isEmpty() || SchemeRegistry::shouldLoadURLSchemeAsEmptyDocument(m_request.url().protocol().toStringWithoutCopying()));</span>
<span class="udiff-line-modified-added">+     bool shouldLoadEmpty = !m_substituteData.isValid() &amp;&amp; (m_request.url().isEmpty() || LegacySchemeRegistry::shouldLoadURLSchemeAsEmptyDocument(m_request.url().protocol().toStringWithoutCopying()));</span>
      if (!shouldLoadEmpty &amp;&amp; !frameLoader()-&gt;client().representationExistsForURLScheme(m_request.url().protocol().toStringWithoutCopying()))
          return false;
  
      if (m_request.url().isEmpty() &amp;&amp; !frameLoader()-&gt;stateMachine().creatingInitialEmptyDocument()) {
          m_request.setURL(WTF::blankURL());
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1818,10 +1816,11 @@</span>
      ASSERT(timing().startTime());
      ASSERT(timing().fetchStart());
  
      willSendRequest(ResourceRequest(m_request), ResourceResponse(), [this, protectedThis = WTFMove(protectedThis)] (ResourceRequest&amp;&amp; request) mutable {
          m_request = request;
<span class="udiff-line-added">+         // FIXME: Implement local URL interception by getting the service worker of the parent.</span>
  
          // willSendRequest() may lead to our Frame being detached or cancelling the load via nulling the ResourceRequest.
          if (!m_frame || m_request.isNull()) {
              RELEASE_LOG_IF_ALLOWED(&quot;startLoadingMainResource: Load canceled after willSendRequest (frame = %p, main = %d)&quot;, m_frame, m_frame ? m_frame-&gt;isMainFrame() : false);
              return;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1832,86 +1831,57 @@</span>
          request.makeUnconditional();
  
          RELEASE_LOG_IF_ALLOWED(&quot;startLoadingMainResource: Starting load (frame = %p, main = %d)&quot;, m_frame, m_frame-&gt;isMainFrame());
  
  #if ENABLE(SERVICE_WORKER)
<span class="udiff-line-modified-removed">-         // FIXME: Implement local URL interception by getting the service worker of the parent.</span>
<span class="udiff-line-modified-removed">-         auto url = request.url();</span>
<span class="udiff-line-modified-removed">-         matchRegistration(url, [request = WTFMove(request), protectedThis = WTFMove(protectedThis), this] (auto&amp;&amp; registrationData) mutable {</span>
<span class="udiff-line-modified-removed">-             if (!m_mainDocumentError.isNull() || !m_frame) {</span>
<span class="udiff-line-modified-removed">-                 RELEASE_LOG_IF_ALLOWED(&quot;startLoadingMainResource callback: Load canceled because of main document error (frame = %p, main = %d)&quot;, m_frame, m_frame ? m_frame-&gt;isMainFrame() : false);</span>
<span class="udiff-line-modified-removed">-                 return;</span>
<span class="udiff-line-modified-removed">-             }</span>
<span class="udiff-line-modified-added">+         if (m_applicationCacheHost-&gt;canLoadMainResource(request) || m_substituteData.isValid()) {</span>
<span class="udiff-line-modified-added">+             auto url = request.url();</span>
<span class="udiff-line-modified-added">+             matchRegistration(url, [request = WTFMove(request), protectedThis = WTFMove(protectedThis), this] (auto&amp;&amp; registrationData) mutable {</span>
<span class="udiff-line-modified-added">+                 if (!m_mainDocumentError.isNull() || !m_frame) {</span>
<span class="udiff-line-modified-added">+                     RELEASE_LOG_IF_ALLOWED(&quot;startLoadingMainResource callback: Load canceled because of main document error (frame = %p, main = %d)&quot;, m_frame, m_frame ? m_frame-&gt;isMainFrame() : false);</span>
<span class="udiff-line-modified-added">+                     return;</span>
<span class="udiff-line-modified-added">+                 }</span>
  
<span class="udiff-line-modified-removed">-             m_serviceWorkerRegistrationData = WTFMove(registrationData);</span>
<span class="udiff-line-modified-added">+                 m_serviceWorkerRegistrationData = WTFMove(registrationData);</span>
<span class="udiff-line-added">+                 // Prefer existing substitute data (from WKWebView.loadData etc) over service worker fetch.</span>
<span class="udiff-line-added">+                 if (this-&gt;tryLoadingSubstituteData()) {</span>
<span class="udiff-line-added">+                     RELEASE_LOG_IF_ALLOWED(&quot;startLoadingMainResource callback: Load canceled because of substitute data (frame = %p, main = %d)&quot;, m_frame, m_frame ? m_frame-&gt;isMainFrame() : false);</span>
<span class="udiff-line-added">+                     return;</span>
<span class="udiff-line-added">+                 }</span>
  
<span class="udiff-line-modified-removed">-             // Prefer existing substitute data (from WKWebView.loadData etc) over service worker fetch.</span>
<span class="udiff-line-modified-removed">-             if (this-&gt;tryLoadingSubstituteData()) {</span>
<span class="udiff-line-modified-removed">-                 RELEASE_LOG_IF_ALLOWED(&quot;startLoadingMainResource callback: Load canceled because of substitute data (frame = %p, main = %d)&quot;, m_frame, m_frame ? m_frame-&gt;isMainFrame() : false);</span>
<span class="udiff-line-modified-removed">-                 return;</span>
<span class="udiff-line-modified-removed">-             }</span>
<span class="udiff-line-modified-removed">-             // Try app cache only if there is no service worker.</span>
<span class="udiff-line-modified-removed">-             if (!m_serviceWorkerRegistrationData &amp;&amp; this-&gt;tryLoadingRequestFromApplicationCache()) {</span>
<span class="udiff-line-modified-removed">-                 RELEASE_LOG_IF_ALLOWED(&quot;startLoadingMainResource callback: Loaded from Application Cache (frame = %p, main = %d)&quot;, m_frame, m_frame-&gt;isMainFrame());</span>
<span class="udiff-line-removed">-                 return;</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             this-&gt;loadMainResource(WTFMove(request));</span>
<span class="udiff-line-removed">-         });</span>
<span class="udiff-line-modified-added">+                 if (!m_serviceWorkerRegistrationData &amp;&amp; this-&gt;tryLoadingRequestFromApplicationCache()) {</span>
<span class="udiff-line-modified-added">+                     RELEASE_LOG_IF_ALLOWED(&quot;startLoadingMainResource callback: Loaded from Application Cache (frame = %p, main = %d)&quot;, m_frame, m_frame-&gt;isMainFrame());</span>
<span class="udiff-line-modified-added">+                     return;</span>
<span class="udiff-line-modified-added">+                 }</span>
<span class="udiff-line-modified-added">+                 this-&gt;loadMainResource(WTFMove(request));</span>
<span class="udiff-line-modified-added">+             });</span>
<span class="udiff-line-modified-added">+             return;</span>
<span class="udiff-line-modified-added">+         }</span>
  #else
          if (tryLoadingRequestFromApplicationCache()) {
              RELEASE_LOG_IF_ALLOWED(&quot;startLoadingMainResource: Loaded from Application Cache (frame = %p, main = %d)&quot;, m_frame, m_frame-&gt;isMainFrame());
              return;
          }
<span class="udiff-line-removed">-         loadMainResource(WTFMove(request));</span>
  #endif
<span class="udiff-line-added">+         loadMainResource(WTFMove(request));</span>
      });
  }
  
<span class="udiff-line-removed">- void DocumentLoader::registerTemporaryServiceWorkerClient(const URL&amp; url)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">- #if ENABLE(SERVICE_WORKER)</span>
<span class="udiff-line-removed">-     ASSERT(!m_temporaryServiceWorkerClient);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     if (!m_serviceWorkerRegistrationData)</span>
<span class="udiff-line-removed">-         return;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     m_temporaryServiceWorkerClient = TemporaryServiceWorkerClient {</span>
<span class="udiff-line-removed">-         DocumentIdentifier::generate(),</span>
<span class="udiff-line-removed">-         m_frame-&gt;page()-&gt;sessionID()</span>
<span class="udiff-line-removed">-     };</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     auto&amp; serviceWorkerConnection = ServiceWorkerProvider::singleton().serviceWorkerConnectionForSession(m_temporaryServiceWorkerClient-&gt;sessionID);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     // FIXME: Compute ServiceWorkerClientFrameType appropriately.</span>
<span class="udiff-line-removed">-     ServiceWorkerClientData data { { serviceWorkerConnection.serverConnectionIdentifier(), m_temporaryServiceWorkerClient-&gt;documentIdentifier }, ServiceWorkerClientType::Window, ServiceWorkerClientFrameType::None, url };</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     RefPtr&lt;SecurityOrigin&gt; topOrigin;</span>
<span class="udiff-line-removed">-     if (m_frame-&gt;isMainFrame())</span>
<span class="udiff-line-removed">-         topOrigin = SecurityOrigin::create(url);</span>
<span class="udiff-line-removed">-     else</span>
<span class="udiff-line-removed">-         topOrigin = &amp;m_frame-&gt;mainFrame().document()-&gt;topOrigin();</span>
<span class="udiff-line-removed">-     serviceWorkerConnection.registerServiceWorkerClient(*topOrigin, WTFMove(data), m_serviceWorkerRegistrationData-&gt;identifier, m_frame-&gt;loader().userAgent(url));</span>
<span class="udiff-line-removed">- #else</span>
<span class="udiff-line-removed">-     UNUSED_PARAM(url);</span>
<span class="udiff-line-removed">- #endif</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
  void DocumentLoader::unregisterTemporaryServiceWorkerClient()
  {
  #if ENABLE(SERVICE_WORKER)
<span class="udiff-line-modified-removed">-     if (!m_temporaryServiceWorkerClient)</span>
<span class="udiff-line-modified-added">+     if (!m_temporaryServiceWorkerClient || !RuntimeEnabledFeatures::sharedFeatures().serviceWorkerEnabled())</span>
          return;
  
<span class="udiff-line-modified-removed">-     auto&amp; serviceWorkerConnection = ServiceWorkerProvider::singleton().serviceWorkerConnectionForSession(m_temporaryServiceWorkerClient-&gt;sessionID);</span>
<span class="udiff-line-modified-removed">-     serviceWorkerConnection.unregisterServiceWorkerClient(m_temporaryServiceWorkerClient-&gt;documentIdentifier);</span>
<span class="udiff-line-removed">-     m_temporaryServiceWorkerClient = WTF::nullopt;</span>
<span class="udiff-line-modified-added">+     auto&amp; serviceWorkerConnection = ServiceWorkerProvider::singleton().serviceWorkerConnection();</span>
<span class="udiff-line-modified-added">+     serviceWorkerConnection.unregisterServiceWorkerClient(*m_temporaryServiceWorkerClient);</span>
  #endif
  }
  
  void DocumentLoader::loadMainResource(ResourceRequest&amp;&amp; request)
  {
<span class="udiff-line-modified-removed">-     static NeverDestroyed&lt;ResourceLoaderOptions&gt; mainResourceLoadOptions(</span>
<span class="udiff-line-modified-added">+     ResourceLoaderOptions mainResourceLoadOptions(</span>
          SendCallbackPolicy::SendCallbacks,
          ContentSniffingPolicy::SniffContent,
          DataBufferingPolicy::BufferData,
          StoredCredentialsPolicy::Use,
          ClientCredentialPolicy::MayAskClientForCredentials,
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1920,29 +1890,29 @@</span>
          FetchOptions::Mode::Navigate,
          CertificateInfoPolicy::IncludeCertificateInfo,
          ContentSecurityPolicyImposition::SkipPolicyCheck,
          DefersLoadingPolicy::AllowDefersLoading,
          CachingPolicy::AllowCaching);
<span class="udiff-line-added">+ #if ENABLE(SERVICE_WORKER)</span>
<span class="udiff-line-added">+     if (!m_temporaryServiceWorkerClient) {</span>
<span class="udiff-line-added">+         // The main navigation load will trigger the registration of the temp client.</span>
<span class="udiff-line-added">+         m_temporaryServiceWorkerClient = DocumentIdentifier::generate();</span>
<span class="udiff-line-added">+         ASSERT(!temporaryIdentifierToLoaderMap().contains(*m_temporaryServiceWorkerClient));</span>
<span class="udiff-line-added">+         temporaryIdentifierToLoaderMap().add(*m_temporaryServiceWorkerClient, this);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+     mainResourceLoadOptions.clientIdentifier = m_temporaryServiceWorkerClient;</span>
<span class="udiff-line-added">+ #endif</span>
      CachedResourceRequest mainResourceRequest(WTFMove(request), mainResourceLoadOptions);
      if (!m_frame-&gt;isMainFrame() &amp;&amp; m_frame-&gt;document()) {
          // If we are loading the main resource of a subframe, use the cache partition of the main document.
          mainResourceRequest.setDomainForCachePartition(*m_frame-&gt;document());
      } else {
          auto origin = SecurityOrigin::create(mainResourceRequest.resourceRequest().url());
          origin-&gt;setStorageBlockingPolicy(frameLoader()-&gt;frame().settings().storageBlockingPolicy());
          mainResourceRequest.setDomainForCachePartition(origin-&gt;domainForCachePartition());
      }
  
<span class="udiff-line-removed">- #if ENABLE(SERVICE_WORKER)</span>
<span class="udiff-line-removed">-     mainResourceRequest.setNavigationServiceWorkerRegistrationData(m_serviceWorkerRegistrationData);</span>
<span class="udiff-line-removed">-     if (mainResourceRequest.options().serviceWorkersMode != ServiceWorkersMode::None) {</span>
<span class="udiff-line-removed">-         // As per step 12 of https://w3c.github.io/ServiceWorker/#on-fetch-request-algorithm, the active service worker should be controlling the document.</span>
<span class="udiff-line-removed">-         // Since we did not yet create the document, we register a temporary service worker client instead.</span>
<span class="udiff-line-removed">-         registerTemporaryServiceWorkerClient(mainResourceRequest.resourceRequest().url());</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- #endif</span>
<span class="udiff-line-removed">- </span>
      m_mainResource = m_cachedResourceLoader-&gt;requestMainResource(WTFMove(mainResourceRequest)).value_or(nullptr);
  
      if (!m_mainResource) {
          // The frame may have gone away if this load was cancelled synchronously and this was the last pending load.
          // This is because we may have fired the load event in a parent frame.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2202,11 +2172,17 @@</span>
      return !m_frame || m_frame-&gt;isAlwaysOnLoggingAllowed();
  }
  
  #if USE(QUICK_LOOK)
  
<span class="udiff-line-modified-removed">- void DocumentLoader::setPreviewConverter(std::unique_ptr&lt;PreviewConverter&gt;&amp;&amp; previewConverter)</span>
<span class="udiff-line-modified-added">+ void DocumentLoader::previewResponseReceived(CachedResource&amp; resource, const ResourceResponse&amp; response)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     ASSERT_UNUSED(resource, m_mainResource == &amp;resource);</span>
<span class="udiff-line-added">+     m_response = response;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void DocumentLoader::setPreviewConverter(RefPtr&lt;PreviewConverter&gt;&amp;&amp; previewConverter)</span>
  {
      m_previewConverter = WTFMove(previewConverter);
  }
  
  PreviewConverter* DocumentLoader::previewConverter() const
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2229,6 +2205,36 @@</span>
  void DocumentLoader::enqueueSecurityPolicyViolationEvent(SecurityPolicyViolationEvent::Init&amp;&amp; eventInit)
  {
      m_frame-&gt;document()-&gt;enqueueSecurityPolicyViolationEvent(WTFMove(eventInit));
  }
  
<span class="udiff-line-added">+ #if ENABLE(CONTENT_FILTERING)</span>
<span class="udiff-line-added">+ void DocumentLoader::dataReceivedThroughContentFilter(const char* data, int size)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     dataReceived(data, size);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void DocumentLoader::cancelMainResourceLoadForContentFilter(const ResourceError&amp; error)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     cancelMainResourceLoad(error);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void DocumentLoader::handleProvisionalLoadFailureFromContentFilter(const URL&amp; blockedPageURL, SubstituteData&amp; substituteData)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     frameLoader()-&gt;load(FrameLoadRequest(*frame(), blockedPageURL, ShouldOpenExternalURLsPolicy::ShouldNotAllow, substituteData));</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ ResourceError DocumentLoader::contentFilterDidBlock(ContentFilterUnblockHandler unblockHandler, WTF::String&amp;&amp; unblockRequestDeniedScript)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     unblockHandler.setUnreachableURL(documentURL());</span>
<span class="udiff-line-added">+     if (!unblockRequestDeniedScript.isEmpty() &amp;&amp; frame()) {</span>
<span class="udiff-line-added">+         unblockHandler.wrapWithDecisionHandler([scriptController = makeWeakPtr(frame()-&gt;script()), script = unblockRequestDeniedScript.isolatedCopy()](bool unblocked) {</span>
<span class="udiff-line-added">+             if (!unblocked &amp;&amp; scriptController)</span>
<span class="udiff-line-added">+                 scriptController-&gt;executeScriptIgnoringException(script);</span>
<span class="udiff-line-added">+         });</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+     frameLoader()-&gt;client().contentFilterDidBlockLoad(WTFMove(unblockHandler));</span>
<span class="udiff-line-added">+     return frameLoader()-&gt;blockedByContentFilterError(request());</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ #endif // ENABLE(CONTENT_FILTERING)</span>
<span class="udiff-line-added">+ </span>
  } // namespace WebCore
</pre>
<center><a href="CrossOriginPreflightChecker.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="DocumentLoader.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>