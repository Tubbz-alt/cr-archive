<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.web/src/main/native/Source/WebCore/worklets/WorkletScriptController.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="WorkletGlobalScope.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../xml/DOMParser.cpp.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/worklets/WorkletScriptController.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 39,11 ***</span>
  #include &lt;JavaScriptCore/Completion.h&gt;
  #include &lt;JavaScriptCore/Exception.h&gt;
  #include &lt;JavaScriptCore/ExceptionHelpers.h&gt;
  #include &lt;JavaScriptCore/GCActivityCallback.h&gt;
  #include &lt;JavaScriptCore/JSLock.h&gt;
<span class="line-modified">! #include &lt;JavaScriptCore/PromiseDeferredTimer.h&gt;</span>
  #include &lt;JavaScriptCore/StrongInlines.h&gt;
  
  namespace WebCore {
  using namespace JSC;
  
<span class="line-new-header">--- 39,11 ---</span>
  #include &lt;JavaScriptCore/Completion.h&gt;
  #include &lt;JavaScriptCore/Exception.h&gt;
  #include &lt;JavaScriptCore/ExceptionHelpers.h&gt;
  #include &lt;JavaScriptCore/GCActivityCallback.h&gt;
  #include &lt;JavaScriptCore/JSLock.h&gt;
<span class="line-modified">! #include &lt;JavaScriptCore/PromiseTimer.h&gt;</span>
  #include &lt;JavaScriptCore/StrongInlines.h&gt;
  
  namespace WebCore {
  using namespace JSC;
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 160,11 ***</span>
  
      NakedPtr&lt;JSC::Exception&gt; exception;
      evaluate(sourceCode, exception, returnedExceptionMessage);
      if (exception) {
          JSLockHolder lock(vm());
<span class="line-modified">!         reportException(m_workletGlobalScopeWrapper-&gt;globalExec(), exception);</span>
      }
  }
  
  // Important: The caller of this function must verify that the returned exception message does not violate CORS if it is going to be passed back to JS.
  void WorkletScriptController::evaluate(const ScriptSourceCode&amp; sourceCode, NakedPtr&lt;JSC::Exception&gt;&amp; returnedException, String* returnedExceptionMessage)
<span class="line-new-header">--- 160,11 ---</span>
  
      NakedPtr&lt;JSC::Exception&gt; exception;
      evaluate(sourceCode, exception, returnedExceptionMessage);
      if (exception) {
          JSLockHolder lock(vm());
<span class="line-modified">!         reportException(m_workletGlobalScopeWrapper-&gt;globalObject(), exception);</span>
      }
  }
  
  // Important: The caller of this function must verify that the returned exception message does not violate CORS if it is going to be passed back to JS.
  void WorkletScriptController::evaluate(const ScriptSourceCode&amp; sourceCode, NakedPtr&lt;JSC::Exception&gt;&amp; returnedException, String* returnedExceptionMessage)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 172,29 ***</span>
      if (isExecutionForbidden())
          return;
  
      initScriptIfNeeded();
  
<span class="line-modified">!     auto&amp; state = *m_workletGlobalScopeWrapper-&gt;globalExec();</span>
<span class="line-modified">!     VM&amp; vm = state.vm();</span>
      JSLockHolder lock { vm };
  
<span class="line-modified">!     JSExecState::profiledEvaluate(&amp;state, JSC::ProfilingReason::Other, sourceCode.jsSourceCode(), m_workletGlobalScopeWrapper-&gt;globalThis(), returnedException);</span>
  
      if (returnedException &amp;&amp; returnedExceptionMessage) {
          // This FIXME is from WorkerScriptController.
          // FIXME: It&#39;s not great that this can run arbitrary code to string-ify the value of the exception.
          // Do we need to do anything to handle that properly, if it, say, raises another exception?
<span class="line-modified">!         *returnedExceptionMessage = returnedException-&gt;value().toWTFString(&amp;state);</span>
      }
  }
  
  void WorkletScriptController::setException(JSC::Exception* exception)
  {
<span class="line-modified">!     auto* exec = m_workletGlobalScopeWrapper-&gt;globalExec();</span>
<span class="line-modified">!     VM&amp; vm = exec-&gt;vm();</span>
      auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified">!     throwException(exec, scope, exception);</span>
  }
  
  } // namespace WebCore
  #endif
<span class="line-new-header">--- 172,29 ---</span>
      if (isExecutionForbidden())
          return;
  
      initScriptIfNeeded();
  
<span class="line-modified">!     auto&amp; globalObject = *m_workletGlobalScopeWrapper-&gt;globalObject();</span>
<span class="line-modified">!     VM&amp; vm = globalObject.vm();</span>
      JSLockHolder lock { vm };
  
<span class="line-modified">!     JSExecState::profiledEvaluate(&amp;globalObject, JSC::ProfilingReason::Other, sourceCode.jsSourceCode(), m_workletGlobalScopeWrapper-&gt;globalThis(), returnedException);</span>
  
      if (returnedException &amp;&amp; returnedExceptionMessage) {
          // This FIXME is from WorkerScriptController.
          // FIXME: It&#39;s not great that this can run arbitrary code to string-ify the value of the exception.
          // Do we need to do anything to handle that properly, if it, say, raises another exception?
<span class="line-modified">!         *returnedExceptionMessage = returnedException-&gt;value().toWTFString(&amp;globalObject);</span>
      }
  }
  
  void WorkletScriptController::setException(JSC::Exception* exception)
  {
<span class="line-modified">!     auto* lexicalGlobalObject = m_workletGlobalScopeWrapper-&gt;globalObject();</span>
<span class="line-modified">!     VM&amp; vm = lexicalGlobalObject-&gt;vm();</span>
      auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified">!     throwException(lexicalGlobalObject, scope, exception);</span>
  }
  
  } // namespace WebCore
  #endif
</pre>
<center><a href="WorkletGlobalScope.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../xml/DOMParser.cpp.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>