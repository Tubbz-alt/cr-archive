<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WebCore/page/scrolling/nicosia/ScrollingTreeFixedNode.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="ScrollingStateNodeNicosia.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="ScrollingTreeFixedNode.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/page/scrolling/nicosia/ScrollingTreeFixedNode.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,8 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (C) 2018 Igalia S.L.</span>
<span class="udiff-line-modified-added">+  * Copyright (C) 2012 Apple Inc. All rights reserved.</span>
<span class="udiff-line-added">+  * Copyright (C) 2019 Igalia S.L.</span>
   *
   * Redistribution and use in source and binary forms, with or without
   * modification, are permitted provided that the following conditions
   * are met:
   *
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -28,11 +29,17 @@</span>
  #include &quot;config.h&quot;
  #include &quot;ScrollingTreeFixedNode.h&quot;
  
  #if ENABLE(ASYNC_SCROLLING) &amp;&amp; USE(NICOSIA)
  
<span class="udiff-line-added">+ #include &quot;Logging.h&quot;</span>
<span class="udiff-line-added">+ #include &quot;NicosiaPlatformLayer.h&quot;</span>
<span class="udiff-line-added">+ #include &quot;ScrollingStateFixedNode.h&quot;</span>
  #include &quot;ScrollingTree.h&quot;
<span class="udiff-line-added">+ #include &quot;ScrollingTreeFrameScrollingNode.h&quot;</span>
<span class="udiff-line-added">+ #include &quot;ScrollingTreeOverflowScrollingNode.h&quot;</span>
<span class="udiff-line-added">+ #include &lt;wtf/text/TextStream.h&gt;</span>
  
  namespace WebCore {
  
  Ref&lt;ScrollingTreeFixedNode&gt; ScrollingTreeFixedNode::create(ScrollingTree&amp; scrollingTree, ScrollingNodeID nodeID)
  {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -48,16 +55,78 @@</span>
  ScrollingTreeFixedNode::~ScrollingTreeFixedNode()
  {
      scrollingTree().fixedOrStickyNodeRemoved();
  }
  
<span class="udiff-line-modified-removed">- void ScrollingTreeFixedNode::commitStateBeforeChildren(const ScrollingStateNode&amp;)</span>
<span class="udiff-line-modified-added">+ void ScrollingTreeFixedNode::commitStateBeforeChildren(const ScrollingStateNode&amp; stateNode)</span>
  {
<span class="udiff-line-added">+     auto&amp; fixedStateNode = downcast&lt;ScrollingStateFixedNode&gt;(stateNode);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (fixedStateNode.hasChangedProperty(ScrollingStateNode::Layer)) {</span>
<span class="udiff-line-added">+         auto* layer = static_cast&lt;Nicosia::PlatformLayer*&gt;(fixedStateNode.layer());</span>
<span class="udiff-line-added">+         m_layer = downcast&lt;Nicosia::CompositionLayer&gt;(layer);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (fixedStateNode.hasChangedProperty(ScrollingStateFixedNode::ViewportConstraints))</span>
<span class="udiff-line-added">+         m_constraints = fixedStateNode.viewportConstraints();</span>
  }
  
  void ScrollingTreeFixedNode::applyLayerPositions()
  {
<span class="udiff-line-added">+     auto computeLayerPosition = [&amp;] {</span>
<span class="udiff-line-added">+         FloatSize overflowScrollDelta;</span>
<span class="udiff-line-added">+         // FIXME: This code is wrong in complex cases where the fixed element is inside a positioned node as</span>
<span class="udiff-line-added">+         //        the scroll container order does not match the scrolling tree ancestor order.</span>
<span class="udiff-line-added">+         for (auto* node = parent(); node; node = node-&gt;parent()) {</span>
<span class="udiff-line-added">+             if (is&lt;ScrollingTreeFrameScrollingNode&gt;(*node)) {</span>
<span class="udiff-line-added">+                 // Fixed nodes are positioned relative to the containing frame scrolling node.</span>
<span class="udiff-line-added">+                 // We bail out after finding one.</span>
<span class="udiff-line-added">+                 auto layoutViewport = downcast&lt;ScrollingTreeFrameScrollingNode&gt;(*node).layoutViewport();</span>
<span class="udiff-line-added">+                 return m_constraints.layerPositionForViewportRect(layoutViewport) - overflowScrollDelta;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             if (is&lt;ScrollingTreeOverflowScrollingNode&gt;(*node)) {</span>
<span class="udiff-line-added">+                 // To keep the layer still during async scrolling we adjust by how much the position has changed since layout.</span>
<span class="udiff-line-added">+                 auto&amp; overflowNode = downcast&lt;ScrollingTreeOverflowScrollingNode&gt;(*node);</span>
<span class="udiff-line-added">+                 auto localDelta = overflowNode.lastCommittedScrollPosition() - overflowNode.currentScrollPosition();</span>
<span class="udiff-line-added">+                 overflowScrollDelta += localDelta;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         ASSERT_NOT_REACHED();</span>
<span class="udiff-line-added">+         return FloatPoint();</span>
<span class="udiff-line-added">+     };</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     auto layerPosition = computeLayerPosition();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     LOG_WITH_STREAM(Scrolling, stream &lt;&lt; &quot;ScrollingTreeFixedNode &quot; &lt;&lt; scrollingNodeID() &lt;&lt; &quot; relatedNodeScrollPositionDidChange: viewportRectAtLastLayout &quot; &lt;&lt; m_constraints.viewportRectAtLastLayout() &lt;&lt; &quot; last layer pos &quot; &lt;&lt; m_constraints.layerPositionAtLastLayout() &lt;&lt; &quot; layerPosition &quot; &lt;&lt; layerPosition);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     ASSERT(m_layer);</span>
<span class="udiff-line-added">+     m_layer-&gt;updateState(</span>
<span class="udiff-line-added">+         [&amp;layerPosition](Nicosia::CompositionLayer::LayerState&amp; state)</span>
<span class="udiff-line-added">+         {</span>
<span class="udiff-line-added">+             state.position = layerPosition;</span>
<span class="udiff-line-added">+             state.delta.positionChanged = true;</span>
<span class="udiff-line-added">+         });</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void ScrollingTreeFixedNode::dumpProperties(TextStream&amp; ts, ScrollingStateTreeAsTextBehavior behavior) const</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     ts &lt;&lt; &quot;fixed node&quot;;</span>
<span class="udiff-line-added">+     ScrollingTreeNode::dumpProperties(ts, behavior);</span>
<span class="udiff-line-added">+     ts.dumpProperty(&quot;fixed constraints&quot;, m_constraints);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (behavior &amp; ScrollingStateTreeAsTextBehaviorIncludeLayerPositions) {</span>
<span class="udiff-line-added">+         FloatPoint layerTopLeft;</span>
<span class="udiff-line-added">+         ASSERT(m_layer);</span>
<span class="udiff-line-added">+         m_layer-&gt;accessCommitted(</span>
<span class="udiff-line-added">+             [this, &amp;layerTopLeft](Nicosia::CompositionLayer::LayerState&amp; state)</span>
<span class="udiff-line-added">+             {</span>
<span class="udiff-line-added">+                 layerTopLeft = state.position - toFloatSize(state.anchorPoint.xy()) * state.size + m_constraints.alignmentOffset();</span>
<span class="udiff-line-added">+             });</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         ts.dumpProperty(&quot;layer top left&quot;, layerTopLeft);</span>
<span class="udiff-line-added">+     }</span>
  }
  
  } // namespace WebCore
  
  #endif // ENABLE(ASYNC_SCROLLING) &amp;&amp; USE(NICOSIA)
</pre>
<center><a href="ScrollingStateNodeNicosia.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="ScrollingTreeFixedNode.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>