<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WebCore/html/track/VTTCue.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="TrackListBase.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="VTTCue.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/html/track/VTTCue.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,8 +1,8 @@</span>
  /*
   * Copyright (C) 2011, 2013 Google Inc.  All rights reserved.
<span class="udiff-line-modified-removed">-  * Copyright (C) 2011-2017 Apple Inc. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (C) 2011-2019 Apple Inc. All rights reserved.</span>
   *
   * Redistribution and use in source and binary forms, with or without
   * modification, are permitted provided that the following conditions are
   * met:
   *
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -45,10 +45,11 @@</span>
  #include &quot;NodeTraversal.h&quot;
  #include &quot;RenderVTTCue.h&quot;
  #include &quot;ScriptDisallowedScope.h&quot;
  #include &quot;Text.h&quot;
  #include &quot;TextTrack.h&quot;
<span class="udiff-line-added">+ #include &quot;TextTrackCueGeneric.h&quot;</span>
  #include &quot;TextTrackCueList.h&quot;
  #include &quot;VTTRegionList.h&quot;
  #include &quot;VTTScanner.h&quot;
  #include &quot;WebVTTElement.h&quot;
  #include &quot;WebVTTParser.h&quot;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -57,17 +58,17 @@</span>
  #include &lt;wtf/text/StringBuilder.h&gt;
  #include &lt;wtf/text/StringConcatenateNumbers.h&gt;
  
  namespace WebCore {
  
<span class="udiff-line-removed">- WTF_MAKE_ISO_ALLOCATED_IMPL(VTTCueBox);</span>
  WTF_MAKE_ISO_ALLOCATED_IMPL(VTTCue);
<span class="udiff-line-added">+ WTF_MAKE_ISO_ALLOCATED_IMPL(VTTCueBox);</span>
  
  // This constant should correspond with the percentage returned by CaptionUserPreferences::captionFontSizeScaleAndImportance.
<span class="udiff-line-modified-removed">- const static double DEFAULTCAPTIONFONTSIZEPERCENTAGE = 5;</span>
<span class="udiff-line-modified-added">+ static constexpr double DEFAULTCAPTIONFONTSIZEPERCENTAGE = 5;</span>
  
<span class="udiff-line-modified-removed">- static const int undefinedPosition = -1;</span>
<span class="udiff-line-modified-added">+ static constexpr int undefinedPosition = -1;</span>
  
  static const CSSValueID displayWritingModeMap[] = {
      CSSValueHorizontalTb, CSSValueVerticalRl, CSSValueVerticalLr
  };
  COMPILE_ASSERT(WTF_ARRAY_LENGTH(displayWritingModeMap) == VTTCue::NumberOfWritingDirections, displayWritingModeMap_has_wrong_size);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -124,35 +125,23 @@</span>
      return verticallr;
  }
  
  // ----------------------------
  
<span class="udiff-line-removed">- Ref&lt;VTTCueBox&gt; VTTCueBox::create(Document&amp; document, VTTCue&amp; cue)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-     VTTCueBox&amp; cueBox = *new VTTCueBox(document, cue);</span>
<span class="udiff-line-removed">-     cueBox.setPseudo(VTTCueBox::vttCueBoxShadowPseudoId());</span>
<span class="udiff-line-removed">-     return adoptRef(cueBox);</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
  VTTCueBox::VTTCueBox(Document&amp; document, VTTCue&amp; cue)
<span class="udiff-line-modified-removed">-     : HTMLElement(divTag, document)</span>
<span class="udiff-line-removed">-     , m_cue(makeWeakPtr(cue))</span>
<span class="udiff-line-modified-added">+     : TextTrackCueBox(document, cue)</span>
  {
<span class="udiff-line-removed">-     setPseudo(vttCueBoxShadowPseudoId());</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- VTTCue* VTTCueBox::getCue() const</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-     return m_cue.get();</span>
  }
  
  void VTTCueBox::applyCSSProperties(const IntSize&amp; videoSize)
  {
<span class="udiff-line-modified-removed">-     if (!m_cue)</span>
<span class="udiff-line-modified-added">+     auto textTrackCue = getCue();</span>
<span class="udiff-line-added">+     if (!textTrackCue)</span>
          return;
  
<span class="udiff-line-modified-removed">-     auto cue = makeRef(*m_cue);</span>
<span class="udiff-line-modified-added">+     ASSERT(is&lt;VTTCue&gt;(textTrackCue) || is&lt;TextTrackCueGeneric&gt;(textTrackCue));</span>
<span class="udiff-line-added">+     auto cue = makeRef(*toVTTCue(textTrackCue));</span>
  
      // FIXME: Apply all the initial CSS positioning properties. http://wkb.ug/79916
      if (!cue-&gt;regionId().isEmpty()) {
          setInlineStyleProperty(CSSPropertyPosition, CSSValueRelative);
          return;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -173,17 +162,19 @@</span>
      setInlineStyleProperty(CSSPropertyWritingMode, cue-&gt;getCSSWritingMode(), false);
  
      auto position = cue-&gt;getCSSPosition();
  
      // the &#39;top&#39; property must be set to top,
<span class="udiff-line-modified-removed">-     setInlineStyleProperty(CSSPropertyTop, position.second, CSSPrimitiveValue::CSS_PERCENTAGE);</span>
<span class="udiff-line-modified-added">+     setInlineStyleProperty(CSSPropertyTop, position.second, CSSUnitType::CSS_PERCENTAGE);</span>
  
      // the &#39;left&#39; property must be set to left
      if (cue-&gt;vertical() == horizontalKeyword())
<span class="udiff-line-modified-removed">-         setInlineStyleProperty(CSSPropertyLeft, position.first, CSSPrimitiveValue::CSS_PERCENTAGE);</span>
<span class="udiff-line-modified-removed">-     else if (cue-&gt;vertical() == verticalGrowingRightKeyword())</span>
<span class="udiff-line-modified-removed">-         setInlineStyleProperty(CSSPropertyLeft, makeString(&quot;calc(-&quot;, FormattedNumber::fixedWidth(videoSize.width(), 2), &quot;px - &quot;, FormattedNumber::fixedWidth(cue-&gt;getCSSSize(), 2), &quot;px)&quot;));</span>
<span class="udiff-line-modified-added">+         setInlineStyleProperty(CSSPropertyLeft, position.first, CSSUnitType::CSS_PERCENTAGE);</span>
<span class="udiff-line-modified-added">+     else if (cue-&gt;vertical() == verticalGrowingRightKeyword()) {</span>
<span class="udiff-line-modified-added">+         // FIXME: Why use calc to do the math instead of doing the subtraction here?</span>
<span class="udiff-line-added">+         setInlineStyleProperty(CSSPropertyLeft, makeString(&quot;calc(-&quot;, videoSize.width(), &quot;px - &quot;, cue-&gt;getCSSSize(), &quot;px)&quot;));</span>
<span class="udiff-line-added">+     }</span>
  
      double authorFontSize = std::min(videoSize.width(), videoSize.height()) * DEFAULTCAPTIONFONTSIZEPERCENTAGE / 100.0;
      double multiplier = 1.0;
      if (authorFontSize)
          multiplier = m_fontSizeFromCaptionUserPrefs / authorFontSize;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -197,23 +188,23 @@</span>
          maxSize = 100.0 - textPosition;
  
      double newCueSize = std::min(cue-&gt;getCSSSize() * multiplier, 100.0);
      // the &#39;width&#39; property must be set to width, and the &#39;height&#39; property  must be set to height
      if (cue-&gt;vertical() == horizontalKeyword()) {
<span class="udiff-line-modified-removed">-         setInlineStyleProperty(CSSPropertyWidth, newCueSize, CSSPrimitiveValue::CSS_PERCENTAGE);</span>
<span class="udiff-line-modified-added">+         setInlineStyleProperty(CSSPropertyWidth, newCueSize, CSSUnitType::CSS_PERCENTAGE);</span>
          setInlineStyleProperty(CSSPropertyHeight, CSSValueAuto);
          setInlineStyleProperty(CSSPropertyMinWidth, &quot;min-content&quot;);
<span class="udiff-line-modified-removed">-         setInlineStyleProperty(CSSPropertyMaxWidth, maxSize, CSSPrimitiveValue::CSS_PERCENTAGE);</span>
<span class="udiff-line-modified-added">+         setInlineStyleProperty(CSSPropertyMaxWidth, maxSize, CSSUnitType::CSS_PERCENTAGE);</span>
          if ((alignment == CSSValueMiddle || alignment == CSSValueCenter) &amp;&amp; multiplier != 1.0)
<span class="udiff-line-modified-removed">-             setInlineStyleProperty(CSSPropertyLeft, static_cast&lt;double&gt;(position.first - (newCueSize - cue-&gt;getCSSSize()) / 2), CSSPrimitiveValue::CSS_PERCENTAGE);</span>
<span class="udiff-line-modified-added">+             setInlineStyleProperty(CSSPropertyLeft, static_cast&lt;double&gt;(position.first - (newCueSize - cue-&gt;getCSSSize()) / 2), CSSUnitType::CSS_PERCENTAGE);</span>
      } else {
          setInlineStyleProperty(CSSPropertyWidth, CSSValueAuto);
<span class="udiff-line-modified-removed">-         setInlineStyleProperty(CSSPropertyHeight, newCueSize, CSSPrimitiveValue::CSS_PERCENTAGE);</span>
<span class="udiff-line-modified-added">+         setInlineStyleProperty(CSSPropertyHeight, newCueSize, CSSUnitType::CSS_PERCENTAGE);</span>
          setInlineStyleProperty(CSSPropertyMinHeight, &quot;min-content&quot;);
<span class="udiff-line-modified-removed">-         setInlineStyleProperty(CSSPropertyMaxHeight, maxSize, CSSPrimitiveValue::CSS_PERCENTAGE);</span>
<span class="udiff-line-modified-added">+         setInlineStyleProperty(CSSPropertyMaxHeight, maxSize, CSSUnitType::CSS_PERCENTAGE);</span>
          if ((alignment == CSSValueMiddle || alignment == CSSValueCenter) &amp;&amp; multiplier != 1.0)
<span class="udiff-line-modified-removed">-             setInlineStyleProperty(CSSPropertyTop, static_cast&lt;double&gt;(position.second - (newCueSize - cue-&gt;getCSSSize()) / 2), CSSPrimitiveValue::CSS_PERCENTAGE);</span>
<span class="udiff-line-modified-added">+             setInlineStyleProperty(CSSPropertyTop, static_cast&lt;double&gt;(position.second - (newCueSize - cue-&gt;getCSSSize()) / 2), CSSUnitType::CSS_PERCENTAGE);</span>
      }
  
      // The &#39;text-align&#39; property on the (root) List of WebVTT Node Objects must
      // be set to the value in the second cell of the row of the table below
      // whose first cell is the value of the corresponding cue&#39;s text track cue
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -229,40 +220,27 @@</span>
          // across the width of the video&#39;s rendering area, and the point y%
          // along the height of the bounding box of the boxes in boxes is y%
          // of the way across the height of the video&#39;s rendering area, while
          // maintaining the relative positions of the boxes in boxes to each
          // other.
<span class="udiff-line-modified-removed">-         setInlineStyleProperty(CSSPropertyTransform,</span>
<span class="udiff-line-removed">-             makeString(&quot;translate(&quot;, FormattedNumber::fixedWidth(-position.first, 2), &quot;%, &quot;, FormattedNumber::fixedWidth(-position.second, 2), &quot;%)&quot;));</span>
<span class="udiff-line-modified-added">+         setInlineStyleProperty(CSSPropertyTransform, makeString(&quot;translate(&quot;, -position.first, &quot;%, &quot;, -position.second, &quot;%)&quot;));</span>
  
          setInlineStyleProperty(CSSPropertyWhiteSpace, CSSValuePre);
      }
  
      // Make sure shadow or stroke is not clipped.
      setInlineStyleProperty(CSSPropertyOverflow, CSSValueVisible);
      cue-&gt;element().setInlineStyleProperty(CSSPropertyOverflow, CSSValueVisible);
  }
  
<span class="udiff-line-removed">- const AtomString&amp; VTTCueBox::vttCueBoxShadowPseudoId()</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-     static NeverDestroyed&lt;const AtomString&gt; trackDisplayBoxShadowPseudoId(&quot;-webkit-media-text-track-display&quot;, AtomString::ConstructFromLiteral);</span>
<span class="udiff-line-removed">-     return trackDisplayBoxShadowPseudoId;</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
  RenderPtr&lt;RenderElement&gt; VTTCueBox::createElementRenderer(RenderStyle&amp;&amp; style, const RenderTreePosition&amp;)
  {
      return createRenderer&lt;RenderVTTCue&gt;(*this, WTFMove(style));
  }
  
  // ----------------------------
  
<span class="udiff-line-removed">- const AtomString&amp; VTTCue::cueBackdropShadowPseudoId()</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-     static NeverDestroyed&lt;const AtomString&gt; cueBackdropShadowPseudoId(&quot;-webkit-media-text-track-display-backdrop&quot;, AtomString::ConstructFromLiteral);</span>
<span class="udiff-line-removed">-     return cueBackdropShadowPseudoId;</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
  Ref&lt;VTTCue&gt; VTTCue::create(ScriptExecutionContext&amp; context, const WebVTTCueData&amp; data)
  {
      return adoptRef(*new VTTCue(context, data));
  }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -865,15 +843,15 @@</span>
  
      markFutureAndPastNodes(referenceTree.get(), startMediaTime(), movieTime);
      m_cueHighlightBox-&gt;appendChild(*referenceTree);
  }
  
<span class="udiff-line-modified-removed">- VTTCueBox&amp; VTTCue::getDisplayTree(const IntSize&amp; videoSize, int fontSize)</span>
<span class="udiff-line-modified-added">+ RefPtr&lt;TextTrackCueBox&gt; VTTCue::getDisplayTree(const IntSize&amp; videoSize, int fontSize)</span>
  {
      Ref&lt;VTTCueBox&gt; displayTree = displayTreeInternal();
      if (!m_displayTreeShouldChange || !track()-&gt;isRendered())
<span class="udiff-line-modified-removed">-         return displayTree.get();</span>
<span class="udiff-line-modified-added">+         return displayTree;</span>
  
      // 10.1 - 10.10
      calculateDisplayParameters();
  
      // 10.11. Apply the terms of the CSS specifications to nodes within the
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -915,32 +893,42 @@</span>
              style-&gt;setTextContent(cssString);
              displayTree-&gt;appendChild(style);
          }
      }
  
<span class="udiff-line-added">+     if (m_fontSize)</span>
<span class="udiff-line-added">+         displayTree-&gt;setInlineStyleProperty(CSSPropertyFontSize, m_fontSize, CSSUnitType::CSS_PX, m_fontSizeIsImportant);</span>
<span class="udiff-line-added">+ </span>
      m_displayTreeShouldChange = false;
  
<span class="udiff-line-added">+     if (track()) {</span>
<span class="udiff-line-added">+         if (auto* regions = track()-&gt;regions()) {</span>
<span class="udiff-line-added">+             if (auto region = regions-&gt;getRegionById(m_regionId))</span>
<span class="udiff-line-added">+                 region-&gt;cueStyleChanged();</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      // 10.15. Let cue&#39;s text track cue display state have the CSS boxes in
      // boxes.
<span class="udiff-line-modified-removed">-     return displayTree.get();</span>
<span class="udiff-line-modified-added">+     return displayTree;</span>
  }
  
  void VTTCue::removeDisplayTree()
  {
<span class="udiff-line-added">+     if (!hasDisplayTree())</span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+ </span>
      // The region needs to be informed about the cue removal.
      if (m_notifyRegion &amp;&amp; track()) {
          if (VTTRegionList* regions = track()-&gt;regions()) {
              if (RefPtr&lt;VTTRegion&gt; region = regions-&gt;getRegionById(m_regionId)) {
                  if (hasDisplayTree())
                      region-&gt;willRemoveTextTrackCueBox(m_displayTree.get());
              }
          }
      }
  
<span class="udiff-line-removed">-     if (!hasDisplayTree())</span>
<span class="udiff-line-removed">-         return;</span>
<span class="udiff-line-removed">- </span>
      // The display tree is never exposed to author scripts so it&#39;s safe to dispatch events here.
      ScriptDisallowedScope::EventAllowedScope allowedScope(displayTreeInternal());
      displayTreeInternal().remove();
  }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1246,25 +1234,26 @@</span>
      return TextTrackCue::doesExtendCue(cue);
  }
  
  void VTTCue::setFontSize(int fontSize, const IntSize&amp;, bool important)
  {
<span class="udiff-line-modified-removed">-     if (!hasDisplayTree() || !fontSize)</span>
<span class="udiff-line-modified-added">+     if (fontSize == m_fontSize &amp;&amp; important == m_fontSizeIsImportant)</span>
          return;
  
      m_displayTreeShouldChange = true;
<span class="udiff-line-modified-removed">-     displayTreeInternal().setInlineStyleProperty(CSSPropertyFontSize, fontSize, CSSPrimitiveValue::CSS_PX, important);</span>
<span class="udiff-line-modified-added">+     m_fontSizeIsImportant = important;</span>
<span class="udiff-line-added">+     m_fontSize = fontSize;</span>
  }
  
  VTTCue* toVTTCue(TextTrackCue* cue)
  {
      return const_cast&lt;VTTCue*&gt;(toVTTCue(const_cast&lt;const TextTrackCue*&gt;(cue)));
  }
  
  const VTTCue* toVTTCue(const TextTrackCue* cue)
  {
<span class="udiff-line-modified-removed">-     ASSERT_WITH_SECURITY_IMPLICATION(cue-&gt;isRenderable());</span>
<span class="udiff-line-modified-added">+     RELEASE_ASSERT_WITH_SECURITY_IMPLICATION(is&lt;VTTCue&gt;(cue) || is&lt;TextTrackCueGeneric&gt;(cue));</span>
      return static_cast&lt;const VTTCue*&gt;(cue);
  }
  
  String VTTCue::toJSONString() const
  {
</pre>
<center><a href="TrackListBase.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="VTTCue.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>