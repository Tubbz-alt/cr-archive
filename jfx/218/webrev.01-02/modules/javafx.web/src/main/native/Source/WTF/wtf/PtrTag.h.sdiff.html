<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WTF/wtf/PtrTag.h</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="PtrTag.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="RAMSize.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WTF/wtf/PtrTag.h</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 86 
 87 struct PtrTagLookup {
 88     const char* (*tagForPtr)(const void*);
 89     const char* (*ptrTagName)(PtrTag);
 90     PtrTagLookup* next { nullptr };
 91 };
 92 
 93 #if CPU(ARM64E)
 94 
 95 enum class PtrTagAction {
 96     ReleaseAssert,
 97     DebugAssert,
 98     NoAssert,
 99 };
100 
101 constexpr PtrTag AnyPtrTag = static_cast&lt;PtrTag&gt;(-1); // Only used for assertion messages.
102 
103 WTF_EXPORT_PRIVATE void registerPtrTagLookup(PtrTagLookup*);
104 WTF_EXPORT_PRIVATE void reportBadTag(const void*, PtrTag expectedTag);
105 
<span class="line-modified">106 #if ASSERT_DISABLED</span>
<span class="line-removed">107 constexpr bool enablePtrTagDebugAssert = false;</span>
<span class="line-removed">108 #else</span>
109 constexpr bool enablePtrTagDebugAssert = true;


110 #endif
111 
112 #define WTF_PTRTAG_ASSERT(action, ptr, expectedTag, assertion) \
113     do { \
114         if (action == PtrTagAction::ReleaseAssert \
115             || (WTF::enablePtrTagDebugAssert &amp;&amp; action == PtrTagAction::DebugAssert)) { \
116             bool passed = (assertion); \
117             if (UNLIKELY(!passed)) { \
118                 reportBadTag(reinterpret_cast&lt;const void*&gt;(ptr), expectedTag); \
119             } \
120             RELEASE_ASSERT(passed &amp;&amp; #assertion); \
121         } \
122     } while (false)
123 
124 
125 template&lt;typename T&gt;
126 inline T* tagArrayPtr(std::nullptr_t ptr, size_t length)
127 {
128     ASSERT(!length);
129     return ptrauth_sign_unauthenticated(static_cast&lt;T*&gt;(ptr), ptrauth_key_process_dependent_data, length);
</pre>
<hr />
<pre>
246 {
247     if (oldTag == newTag || (oldTag == NoPtrTag &amp;&amp; newTag == NoPtrTag))
248         return ptr;
249     if (newTag == NoPtrTag)
250         return untagCodePtrImpl&lt;tagAction&gt;(ptr, oldTag);
251     if (oldTag == NoPtrTag)
252         return tagCodePtrImpl&lt;tagAction&gt;(ptr, newTag);
253     if (oldTag == CFunctionPtrTag)
254         return ptrauth_auth_and_resign(ptr, ptrauth_key_function_pointer, 0, ptrauth_key_process_dependent_code, newTag);
255     if (newTag == CFunctionPtrTag)
256         return ptrauth_auth_and_resign(ptr, ptrauth_key_process_dependent_code, oldTag, ptrauth_key_function_pointer, 0);
257     return ptrauth_auth_and_resign(ptr, ptrauth_key_process_dependent_code, oldTag, ptrauth_key_process_dependent_code, newTag);
258 }
259 
260 template&lt;PtrTagAction tagAction, typename PtrType&gt;
261 inline PtrType retagCodePtrImpl(PtrType ptr, PtrTag oldTag, PtrTag newTag)
262 {
263     if (!ptr)
264         return nullptr;
265     PtrTagAction untagAction = (tagAction == PtrTagAction::NoAssert) ? PtrTagAction::NoAssert : PtrTagAction::ReleaseAssert;
<span class="line-modified">266     WTF_PTRTAG_ASSERT(untagAction, ptr, oldTag, removeCodePtrTag(ptr) == untagCodePtrImpl&lt;PtrTagAction::NoAssert&gt;(ptr, oldTag));</span>
267     PtrType result = retagCodePtrImplHelper&lt;tagAction&gt;(ptr, oldTag, newTag);
268     WTF_PTRTAG_ASSERT(tagAction, ptr, newTag, result == tagCodePtrImpl&lt;PtrTagAction::NoAssert&gt;(removeCodePtrTag(ptr), newTag));
269     return result;
270 }
271 
272 template&lt;typename T, typename PtrType, typename = std::enable_if_t&lt;std::is_pointer&lt;PtrType&gt;::value &amp;&amp; !std::is_same&lt;T, PtrType&gt;::value&gt;&gt;
273 inline T retagCodePtr(PtrType ptr, PtrTag oldTag, PtrTag newTag)
274 {
275     return bitwise_cast&lt;T&gt;(retagCodePtrImpl&lt;PtrTagAction::DebugAssert&gt;(ptr, oldTag, newTag));
276 }
277 
278 template&lt;typename T, PtrTag oldTag, PtrTag newTag, typename PtrType, typename = std::enable_if_t&lt;std::is_pointer&lt;PtrType&gt;::value&gt;&gt;
279 inline T retagCodePtr(PtrType ptr)
280 {
281     return bitwise_cast&lt;T&gt;(retagCodePtrImpl&lt;PtrTagAction::DebugAssert&gt;(ptr, oldTag, newTag));
282 }
283 
284 template&lt;typename PtrType, typename = std::enable_if_t&lt;std::is_pointer&lt;PtrType&gt;::value&gt;&gt;
285 inline PtrType retagCodePtr(PtrType ptr, PtrTag oldTag, PtrTag newTag)
286 {
287     return retagCodePtrImpl&lt;PtrTagAction::DebugAssert&gt;(ptr, oldTag, newTag);
288 }
289 
290 template&lt;PtrTag oldTag, PtrTag newTag, typename PtrType, typename = std::enable_if_t&lt;std::is_pointer&lt;PtrType&gt;::value&gt;&gt;
291 inline PtrType retagCodePtr(PtrType ptr) { return retagCodePtr(ptr, oldTag, newTag); }
292 
293 template&lt;PtrTagAction tagAction, typename PtrType&gt;
294 inline PtrType tagCFunctionPtrImpl(PtrType ptr, PtrTag tag)
295 {
296     if (!ptr)
297         return nullptr;
<span class="line-modified">298     WTF_PTRTAG_ASSERT(tagAction, ptr, CFunctionPtrTag, removeCodePtrTag(ptr) == untagCodePtrImpl&lt;PtrTagAction::NoAssert&gt;(ptr, CFunctionPtrTag));</span>
299     return retagCodePtrImpl&lt;tagAction&gt;(ptr, CFunctionPtrTag, tag);
300 }
301 
302 template&lt;typename T, typename PtrType, typename = std::enable_if_t&lt;std::is_pointer&lt;PtrType&gt;::value &amp;&amp; !std::is_same&lt;T, PtrType&gt;::value&gt;&gt;
303 inline T tagCFunctionPtr(PtrType ptr, PtrTag tag)
304 {
305     return bitwise_cast&lt;T&gt;(tagCFunctionPtrImpl&lt;PtrTagAction::DebugAssert&gt;(ptr, tag));
306 }
307 
308 template&lt;typename T, PtrTag tag, typename PtrType, typename = std::enable_if_t&lt;std::is_pointer&lt;PtrType&gt;::value&gt;&gt;
309 inline T tagCFunctionPtr(PtrType ptr)
310 {
311     return bitwise_cast&lt;T&gt;(tagCFunctionPtrImpl&lt;PtrTagAction::DebugAssert&gt;(ptr, tag));
312 }
313 
314 template&lt;typename PtrType, typename = std::enable_if_t&lt;std::is_pointer&lt;PtrType&gt;::value&gt;&gt;
315 inline PtrType tagCFunctionPtr(PtrType ptr, PtrTag tag)
316 {
317     return tagCFunctionPtrImpl&lt;PtrTagAction::DebugAssert&gt;(ptr, tag);
318 }
319 
320 template&lt;PtrTag tag, typename PtrType, typename = std::enable_if_t&lt;std::is_pointer&lt;PtrType&gt;::value&gt;&gt;
321 inline PtrType tagCFunctionPtr(PtrType ptr) { return tagCFunctionPtr(ptr, tag); }
322 
323 template&lt;PtrTagAction tagAction, typename PtrType&gt;
324 inline PtrType untagCFunctionPtrImpl(PtrType ptr, PtrTag tag)
325 {
326     if (!ptr)
327         return nullptr;
<span class="line-modified">328     WTF_PTRTAG_ASSERT(tagAction, ptr, tag, removeCodePtrTag(ptr) == untagCodePtrImpl&lt;PtrTagAction::NoAssert&gt;(ptr, tag));</span>
329     return retagCodePtrImpl&lt;tagAction&gt;(ptr, tag, CFunctionPtrTag);
330 }
331 
332 template&lt;typename T, typename PtrType, typename = std::enable_if_t&lt;std::is_pointer&lt;PtrType&gt;::value &amp;&amp; !std::is_same&lt;T, PtrType&gt;::value&gt;&gt;
333 inline T untagCFunctionPtr(PtrType ptr, PtrTag tag)
334 {
335     return bitwise_cast&lt;T&gt;(untagCFunctionPtrImpl&lt;PtrTagAction::DebugAssert&gt;(ptr, tag));
336 }
337 
338 template&lt;typename T, PtrTag tag, typename PtrType, typename = std::enable_if_t&lt;std::is_pointer&lt;PtrType&gt;::value&gt;&gt;
339 inline T untagCFunctionPtr(PtrType ptr)
340 {
341     return bitwise_cast&lt;T&gt;(untagCFunctionPtrImpl&lt;PtrTagAction::DebugAssert&gt;(ptr, tag));
342 }
343 
344 template&lt;typename T, PtrTag tag, PtrTagAction tagAction, typename PtrType, typename = std::enable_if_t&lt;std::is_pointer&lt;PtrType&gt;::value&gt;&gt;
345 inline T untagCFunctionPtr(PtrType ptr)
346 {
347     return bitwise_cast&lt;T&gt;(untagCFunctionPtrImpl&lt;tagAction&gt;(ptr, tag));
348 }
</pre>
<hr />
<pre>
350 template&lt;typename PtrType, typename = std::enable_if_t&lt;std::is_pointer&lt;PtrType&gt;::value&gt;&gt;
351 inline PtrType untagCFunctionPtr(PtrType ptr, PtrTag tag)
352 {
353     return untagCFunctionPtrImpl&lt;PtrTagAction::DebugAssert&gt;(ptr, tag);
354 }
355 
356 template&lt;PtrTag tag, typename PtrType, typename = std::enable_if_t&lt;std::is_pointer&lt;PtrType&gt;::value&gt;&gt;
357 inline PtrType untagCFunctionPtr(PtrType ptr) { return untagCFunctionPtr(ptr, tag); }
358 
359 template &lt;typename IntType&gt;
360 inline IntType tagInt(IntType ptrInt, PtrTag tag)
361 {
362     static_assert(sizeof(IntType) == sizeof(uintptr_t), &quot;&quot;);
363     return bitwise_cast&lt;IntType&gt;(ptrauth_sign_unauthenticated(bitwise_cast&lt;void*&gt;(ptrInt), ptrauth_key_process_dependent_data, tag));
364 }
365 
366 template&lt;typename PtrType&gt;
367 void assertIsCFunctionPtr(PtrType value)
368 {
369     void* ptr = bitwise_cast&lt;void*&gt;(value);
<span class="line-modified">370     WTF_PTRTAG_ASSERT(PtrTagAction::ReleaseAssert, ptr, CFunctionPtrTag, untagCodePtrImpl&lt;PtrTagAction::NoAssert&gt;(ptr, CFunctionPtrTag) == removeCodePtrTag(ptr));</span>
371 }
372 
373 template&lt;typename PtrType&gt;
374 void assertIsNullOrCFunctionPtr(PtrType ptr)
375 {
376     if (ptr)
377         assertIsCFunctionPtr(ptr);
378 }
379 
380 template&lt;typename PtrType&gt;
381 void assertIsNotTagged(PtrType value)
382 {
383     void* ptr = bitwise_cast&lt;void*&gt;(value);
384     WTF_PTRTAG_ASSERT(PtrTagAction::ReleaseAssert, ptr, NoPtrTag, ptr == removeCodePtrTag(ptr));
385 }
386 
387 template&lt;typename PtrType&gt;
388 void assertIsTagged(PtrType value)
389 {
390     void* ptr = bitwise_cast&lt;void*&gt;(value);
391     WTF_PTRTAG_ASSERT(PtrTagAction::ReleaseAssert, ptr, AnyPtrTag, ptr != removeCodePtrTag(ptr));
392 }
393 
394 template&lt;typename PtrType&gt;
395 void assertIsNullOrTagged(PtrType ptr)
396 {
397     if (ptr)
398         assertIsTagged(ptr);
399 }
400 
401 template&lt;typename PtrType&gt;
402 bool isTaggedWith(PtrType value, PtrTag tag)
403 {
404     void* ptr = bitwise_cast&lt;void*&gt;(value);
405     if (tag == NoPtrTag)
406         return ptr == removeCodePtrTag(ptr);
<span class="line-modified">407     return untagCodePtrImpl&lt;PtrTagAction::NoAssert&gt;(ptr, tag) == removeCodePtrTag(ptr);</span>
408 }
409 
410 template&lt;typename PtrType&gt;
411 void assertIsTaggedWith(PtrType value, PtrTag tag)
412 {
413     WTF_PTRTAG_ASSERT(PtrTagAction::ReleaseAssert, value, tag, isTaggedWith(value, tag));
414 }
415 
416 template&lt;typename PtrType&gt;
417 void assertIsNullOrTaggedWith(PtrType ptr, PtrTag tag)
418 {
419     if (ptr)
420         assertIsTaggedWith(ptr, tag);
421 }
422 
423 inline bool usesPointerTagging() { return true; }
424 
425 // vtbl function pointers need to sign with ptrauth_key_process_independent_code
426 // because they reside in library code shared by multiple processes.
427 // The second argument to __ptrauth() being 1 means to use the address of the pointer
</pre>
</td>
<td>
<hr />
<pre>
 86 
 87 struct PtrTagLookup {
 88     const char* (*tagForPtr)(const void*);
 89     const char* (*ptrTagName)(PtrTag);
 90     PtrTagLookup* next { nullptr };
 91 };
 92 
 93 #if CPU(ARM64E)
 94 
 95 enum class PtrTagAction {
 96     ReleaseAssert,
 97     DebugAssert,
 98     NoAssert,
 99 };
100 
101 constexpr PtrTag AnyPtrTag = static_cast&lt;PtrTag&gt;(-1); // Only used for assertion messages.
102 
103 WTF_EXPORT_PRIVATE void registerPtrTagLookup(PtrTagLookup*);
104 WTF_EXPORT_PRIVATE void reportBadTag(const void*, PtrTag expectedTag);
105 
<span class="line-modified">106 #if ASSERT_ENABLED</span>


107 constexpr bool enablePtrTagDebugAssert = true;
<span class="line-added">108 #else</span>
<span class="line-added">109 constexpr bool enablePtrTagDebugAssert = false;</span>
110 #endif
111 
112 #define WTF_PTRTAG_ASSERT(action, ptr, expectedTag, assertion) \
113     do { \
114         if (action == PtrTagAction::ReleaseAssert \
115             || (WTF::enablePtrTagDebugAssert &amp;&amp; action == PtrTagAction::DebugAssert)) { \
116             bool passed = (assertion); \
117             if (UNLIKELY(!passed)) { \
118                 reportBadTag(reinterpret_cast&lt;const void*&gt;(ptr), expectedTag); \
119             } \
120             RELEASE_ASSERT(passed &amp;&amp; #assertion); \
121         } \
122     } while (false)
123 
124 
125 template&lt;typename T&gt;
126 inline T* tagArrayPtr(std::nullptr_t ptr, size_t length)
127 {
128     ASSERT(!length);
129     return ptrauth_sign_unauthenticated(static_cast&lt;T*&gt;(ptr), ptrauth_key_process_dependent_data, length);
</pre>
<hr />
<pre>
246 {
247     if (oldTag == newTag || (oldTag == NoPtrTag &amp;&amp; newTag == NoPtrTag))
248         return ptr;
249     if (newTag == NoPtrTag)
250         return untagCodePtrImpl&lt;tagAction&gt;(ptr, oldTag);
251     if (oldTag == NoPtrTag)
252         return tagCodePtrImpl&lt;tagAction&gt;(ptr, newTag);
253     if (oldTag == CFunctionPtrTag)
254         return ptrauth_auth_and_resign(ptr, ptrauth_key_function_pointer, 0, ptrauth_key_process_dependent_code, newTag);
255     if (newTag == CFunctionPtrTag)
256         return ptrauth_auth_and_resign(ptr, ptrauth_key_process_dependent_code, oldTag, ptrauth_key_function_pointer, 0);
257     return ptrauth_auth_and_resign(ptr, ptrauth_key_process_dependent_code, oldTag, ptrauth_key_process_dependent_code, newTag);
258 }
259 
260 template&lt;PtrTagAction tagAction, typename PtrType&gt;
261 inline PtrType retagCodePtrImpl(PtrType ptr, PtrTag oldTag, PtrTag newTag)
262 {
263     if (!ptr)
264         return nullptr;
265     PtrTagAction untagAction = (tagAction == PtrTagAction::NoAssert) ? PtrTagAction::NoAssert : PtrTagAction::ReleaseAssert;
<span class="line-modified">266     WTF_PTRTAG_ASSERT(untagAction, ptr, oldTag, ptr == tagCodePtrImpl&lt;PtrTagAction::NoAssert&gt;(removeCodePtrTag(ptr), oldTag));</span>
267     PtrType result = retagCodePtrImplHelper&lt;tagAction&gt;(ptr, oldTag, newTag);
268     WTF_PTRTAG_ASSERT(tagAction, ptr, newTag, result == tagCodePtrImpl&lt;PtrTagAction::NoAssert&gt;(removeCodePtrTag(ptr), newTag));
269     return result;
270 }
271 
272 template&lt;typename T, typename PtrType, typename = std::enable_if_t&lt;std::is_pointer&lt;PtrType&gt;::value &amp;&amp; !std::is_same&lt;T, PtrType&gt;::value&gt;&gt;
273 inline T retagCodePtr(PtrType ptr, PtrTag oldTag, PtrTag newTag)
274 {
275     return bitwise_cast&lt;T&gt;(retagCodePtrImpl&lt;PtrTagAction::DebugAssert&gt;(ptr, oldTag, newTag));
276 }
277 
278 template&lt;typename T, PtrTag oldTag, PtrTag newTag, typename PtrType, typename = std::enable_if_t&lt;std::is_pointer&lt;PtrType&gt;::value&gt;&gt;
279 inline T retagCodePtr(PtrType ptr)
280 {
281     return bitwise_cast&lt;T&gt;(retagCodePtrImpl&lt;PtrTagAction::DebugAssert&gt;(ptr, oldTag, newTag));
282 }
283 
284 template&lt;typename PtrType, typename = std::enable_if_t&lt;std::is_pointer&lt;PtrType&gt;::value&gt;&gt;
285 inline PtrType retagCodePtr(PtrType ptr, PtrTag oldTag, PtrTag newTag)
286 {
287     return retagCodePtrImpl&lt;PtrTagAction::DebugAssert&gt;(ptr, oldTag, newTag);
288 }
289 
290 template&lt;PtrTag oldTag, PtrTag newTag, typename PtrType, typename = std::enable_if_t&lt;std::is_pointer&lt;PtrType&gt;::value&gt;&gt;
291 inline PtrType retagCodePtr(PtrType ptr) { return retagCodePtr(ptr, oldTag, newTag); }
292 
293 template&lt;PtrTagAction tagAction, typename PtrType&gt;
294 inline PtrType tagCFunctionPtrImpl(PtrType ptr, PtrTag tag)
295 {
296     if (!ptr)
297         return nullptr;
<span class="line-modified">298     WTF_PTRTAG_ASSERT(tagAction, ptr, CFunctionPtrTag, ptr == tagCodePtrImpl&lt;PtrTagAction::NoAssert&gt;(removeCodePtrTag(ptr), CFunctionPtrTag));</span>
299     return retagCodePtrImpl&lt;tagAction&gt;(ptr, CFunctionPtrTag, tag);
300 }
301 
302 template&lt;typename T, typename PtrType, typename = std::enable_if_t&lt;std::is_pointer&lt;PtrType&gt;::value &amp;&amp; !std::is_same&lt;T, PtrType&gt;::value&gt;&gt;
303 inline T tagCFunctionPtr(PtrType ptr, PtrTag tag)
304 {
305     return bitwise_cast&lt;T&gt;(tagCFunctionPtrImpl&lt;PtrTagAction::DebugAssert&gt;(ptr, tag));
306 }
307 
308 template&lt;typename T, PtrTag tag, typename PtrType, typename = std::enable_if_t&lt;std::is_pointer&lt;PtrType&gt;::value&gt;&gt;
309 inline T tagCFunctionPtr(PtrType ptr)
310 {
311     return bitwise_cast&lt;T&gt;(tagCFunctionPtrImpl&lt;PtrTagAction::DebugAssert&gt;(ptr, tag));
312 }
313 
314 template&lt;typename PtrType, typename = std::enable_if_t&lt;std::is_pointer&lt;PtrType&gt;::value&gt;&gt;
315 inline PtrType tagCFunctionPtr(PtrType ptr, PtrTag tag)
316 {
317     return tagCFunctionPtrImpl&lt;PtrTagAction::DebugAssert&gt;(ptr, tag);
318 }
319 
320 template&lt;PtrTag tag, typename PtrType, typename = std::enable_if_t&lt;std::is_pointer&lt;PtrType&gt;::value&gt;&gt;
321 inline PtrType tagCFunctionPtr(PtrType ptr) { return tagCFunctionPtr(ptr, tag); }
322 
323 template&lt;PtrTagAction tagAction, typename PtrType&gt;
324 inline PtrType untagCFunctionPtrImpl(PtrType ptr, PtrTag tag)
325 {
326     if (!ptr)
327         return nullptr;
<span class="line-modified">328     WTF_PTRTAG_ASSERT(tagAction, ptr, tag, ptr == tagCodePtrImpl&lt;PtrTagAction::NoAssert&gt;(removeCodePtrTag(ptr), tag));</span>
329     return retagCodePtrImpl&lt;tagAction&gt;(ptr, tag, CFunctionPtrTag);
330 }
331 
332 template&lt;typename T, typename PtrType, typename = std::enable_if_t&lt;std::is_pointer&lt;PtrType&gt;::value &amp;&amp; !std::is_same&lt;T, PtrType&gt;::value&gt;&gt;
333 inline T untagCFunctionPtr(PtrType ptr, PtrTag tag)
334 {
335     return bitwise_cast&lt;T&gt;(untagCFunctionPtrImpl&lt;PtrTagAction::DebugAssert&gt;(ptr, tag));
336 }
337 
338 template&lt;typename T, PtrTag tag, typename PtrType, typename = std::enable_if_t&lt;std::is_pointer&lt;PtrType&gt;::value&gt;&gt;
339 inline T untagCFunctionPtr(PtrType ptr)
340 {
341     return bitwise_cast&lt;T&gt;(untagCFunctionPtrImpl&lt;PtrTagAction::DebugAssert&gt;(ptr, tag));
342 }
343 
344 template&lt;typename T, PtrTag tag, PtrTagAction tagAction, typename PtrType, typename = std::enable_if_t&lt;std::is_pointer&lt;PtrType&gt;::value&gt;&gt;
345 inline T untagCFunctionPtr(PtrType ptr)
346 {
347     return bitwise_cast&lt;T&gt;(untagCFunctionPtrImpl&lt;tagAction&gt;(ptr, tag));
348 }
</pre>
<hr />
<pre>
350 template&lt;typename PtrType, typename = std::enable_if_t&lt;std::is_pointer&lt;PtrType&gt;::value&gt;&gt;
351 inline PtrType untagCFunctionPtr(PtrType ptr, PtrTag tag)
352 {
353     return untagCFunctionPtrImpl&lt;PtrTagAction::DebugAssert&gt;(ptr, tag);
354 }
355 
356 template&lt;PtrTag tag, typename PtrType, typename = std::enable_if_t&lt;std::is_pointer&lt;PtrType&gt;::value&gt;&gt;
357 inline PtrType untagCFunctionPtr(PtrType ptr) { return untagCFunctionPtr(ptr, tag); }
358 
359 template &lt;typename IntType&gt;
360 inline IntType tagInt(IntType ptrInt, PtrTag tag)
361 {
362     static_assert(sizeof(IntType) == sizeof(uintptr_t), &quot;&quot;);
363     return bitwise_cast&lt;IntType&gt;(ptrauth_sign_unauthenticated(bitwise_cast&lt;void*&gt;(ptrInt), ptrauth_key_process_dependent_data, tag));
364 }
365 
366 template&lt;typename PtrType&gt;
367 void assertIsCFunctionPtr(PtrType value)
368 {
369     void* ptr = bitwise_cast&lt;void*&gt;(value);
<span class="line-modified">370     WTF_PTRTAG_ASSERT(PtrTagAction::ReleaseAssert, ptr, CFunctionPtrTag, ptr == tagCodePtrImpl&lt;PtrTagAction::NoAssert&gt;(removeCodePtrTag(ptr), CFunctionPtrTag));</span>
371 }
372 
373 template&lt;typename PtrType&gt;
374 void assertIsNullOrCFunctionPtr(PtrType ptr)
375 {
376     if (ptr)
377         assertIsCFunctionPtr(ptr);
378 }
379 
380 template&lt;typename PtrType&gt;
381 void assertIsNotTagged(PtrType value)
382 {
383     void* ptr = bitwise_cast&lt;void*&gt;(value);
384     WTF_PTRTAG_ASSERT(PtrTagAction::ReleaseAssert, ptr, NoPtrTag, ptr == removeCodePtrTag(ptr));
385 }
386 
387 template&lt;typename PtrType&gt;
388 void assertIsTagged(PtrType value)
389 {
390     void* ptr = bitwise_cast&lt;void*&gt;(value);
391     WTF_PTRTAG_ASSERT(PtrTagAction::ReleaseAssert, ptr, AnyPtrTag, ptr != removeCodePtrTag(ptr));
392 }
393 
394 template&lt;typename PtrType&gt;
395 void assertIsNullOrTagged(PtrType ptr)
396 {
397     if (ptr)
398         assertIsTagged(ptr);
399 }
400 
401 template&lt;typename PtrType&gt;
402 bool isTaggedWith(PtrType value, PtrTag tag)
403 {
404     void* ptr = bitwise_cast&lt;void*&gt;(value);
405     if (tag == NoPtrTag)
406         return ptr == removeCodePtrTag(ptr);
<span class="line-modified">407     return ptr == tagCodePtrImpl&lt;PtrTagAction::NoAssert&gt;(removeCodePtrTag(ptr), tag);</span>
408 }
409 
410 template&lt;typename PtrType&gt;
411 void assertIsTaggedWith(PtrType value, PtrTag tag)
412 {
413     WTF_PTRTAG_ASSERT(PtrTagAction::ReleaseAssert, value, tag, isTaggedWith(value, tag));
414 }
415 
416 template&lt;typename PtrType&gt;
417 void assertIsNullOrTaggedWith(PtrType ptr, PtrTag tag)
418 {
419     if (ptr)
420         assertIsTaggedWith(ptr, tag);
421 }
422 
423 inline bool usesPointerTagging() { return true; }
424 
425 // vtbl function pointers need to sign with ptrauth_key_process_independent_code
426 // because they reside in library code shared by multiple processes.
427 // The second argument to __ptrauth() being 1 means to use the address of the pointer
</pre>
</td>
</tr>
</table>
<center><a href="PtrTag.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="RAMSize.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>