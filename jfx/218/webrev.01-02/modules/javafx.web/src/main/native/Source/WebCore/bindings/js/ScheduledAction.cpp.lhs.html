<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/WebCore/bindings/js/ScheduledAction.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  *  Copyright (C) 2000 Harri Porten (porten@kde.org)
  3  *  Copyright (C) 2006 Jon Shier (jshier@iastate.edu)
  4  *  Copyright (C) 2003-2017 Apple Inc. All rights reseved.
  5  *  Copyright (C) 2006 Alexey Proskuryakov (ap@webkit.org)
  6  *  Copyright (C) 2009 Google Inc. All rights reseved.
  7  *
  8  *  This library is free software; you can redistribute it and/or
  9  *  modify it under the terms of the GNU Lesser General Public
 10  *  License as published by the Free Software Foundation; either
 11  *  version 2 of the License, or (at your option) any later version.
 12  *
 13  *  This library is distributed in the hope that it will be useful,
 14  *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 15  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 16  *  Lesser General Public License for more details.
 17  *
 18  *  You should have received a copy of the GNU Lesser General Public
 19  *  License along with this library; if not, write to the Free Software
 20  *  Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301
 21  *  USA
 22  */
 23 
 24 #include &quot;config.h&quot;
 25 #include &quot;ScheduledAction.h&quot;
 26 
 27 #include &quot;ContentSecurityPolicy.h&quot;
 28 #include &quot;DOMWindow.h&quot;
 29 #include &quot;DOMWrapperWorld.h&quot;
 30 #include &quot;Document.h&quot;
 31 #include &quot;Frame.h&quot;
 32 #include &quot;FrameLoader.h&quot;
 33 #include &quot;JSDOMExceptionHandling.h&quot;
 34 #include &quot;JSDOMWindow.h&quot;
 35 #include &quot;JSExecState.h&quot;
 36 #include &quot;JSExecStateInstrumentation.h&quot;
 37 #include &quot;JSWorkerGlobalScope.h&quot;
 38 #include &quot;ScriptController.h&quot;
 39 #include &quot;ScriptExecutionContext.h&quot;
 40 #include &quot;ScriptSourceCode.h&quot;
 41 #include &quot;WorkerGlobalScope.h&quot;
 42 #include &quot;WorkerThread.h&quot;
 43 #include &lt;JavaScriptCore/JSLock.h&gt;
 44 
 45 namespace WebCore {
 46 using namespace JSC;
 47 
 48 std::unique_ptr&lt;ScheduledAction&gt; ScheduledAction::create(DOMWrapperWorld&amp; isolatedWorld, JSC::Strong&lt;JSC::Unknown&gt;&amp;&amp; function)
 49 {
 50     return std::unique_ptr&lt;ScheduledAction&gt;(new ScheduledAction(isolatedWorld, WTFMove(function)));
 51 }
 52 
 53 std::unique_ptr&lt;ScheduledAction&gt; ScheduledAction::create(DOMWrapperWorld&amp; isolatedWorld, String&amp;&amp; code)
 54 {
 55     return std::unique_ptr&lt;ScheduledAction&gt;(new ScheduledAction(isolatedWorld, WTFMove(code)));
 56 }
 57 
 58 ScheduledAction::ScheduledAction(DOMWrapperWorld&amp; isolatedWorld, JSC::Strong&lt;JSC::Unknown&gt;&amp;&amp; function)
 59     : m_isolatedWorld(isolatedWorld)
 60     , m_function(WTFMove(function))
 61 {
 62 }
 63 
 64 ScheduledAction::ScheduledAction(DOMWrapperWorld&amp; isolatedWorld, String&amp;&amp; code)
 65     : m_isolatedWorld(isolatedWorld)
 66     , m_function(isolatedWorld.vm())
 67     , m_code(WTFMove(code))
 68 {
 69 }
 70 
 71 ScheduledAction::~ScheduledAction() = default;
 72 
 73 void ScheduledAction::addArguments(Vector&lt;JSC::Strong&lt;JSC::Unknown&gt;&gt;&amp;&amp; arguments)
 74 {
 75     m_arguments = WTFMove(arguments);
 76 }
 77 
 78 auto ScheduledAction::type() const -&gt; Type
 79 {
 80     return m_function ? Type::Function : Type::Code;
 81 }
 82 
 83 void ScheduledAction::execute(ScriptExecutionContext&amp; context)
 84 {
 85     if (is&lt;Document&gt;(context))
 86         execute(downcast&lt;Document&gt;(context));
 87     else
 88         execute(downcast&lt;WorkerGlobalScope&gt;(context));
 89 }
 90 
 91 void ScheduledAction::executeFunctionInContext(JSGlobalObject* globalObject, JSValue thisValue, ScriptExecutionContext&amp; context)
 92 {
 93     ASSERT(m_function);
 94     VM&amp; vm = context.vm();
 95     JSLockHolder lock(vm);
 96     auto scope = DECLARE_THROW_SCOPE(vm);
 97 
 98     CallData callData;
 99     CallType callType = getCallData(vm, m_function.get(), callData);
100     if (callType == CallType::None)
101         return;
102 
<a name="1" id="anc1"></a><span class="line-modified">103     ExecState* exec = globalObject-&gt;globalExec();</span>
104 
105     MarkedArgumentBuffer arguments;
106     for (auto&amp; argument : m_arguments)
107         arguments.append(argument.get());
108     if (UNLIKELY(arguments.hasOverflowed())) {
<a name="2" id="anc2"></a><span class="line-modified">109         throwOutOfMemoryError(exec, scope);</span>
110         NakedPtr&lt;JSC::Exception&gt; exception = scope.exception();
<a name="3" id="anc3"></a><span class="line-modified">111         reportException(exec, exception);</span>
112         return;
113     }
114 
<a name="4" id="anc4"></a><span class="line-modified">115     InspectorInstrumentationCookie cookie = JSExecState::instrumentFunctionCall(&amp;context, callType, callData);</span>
116 
117     NakedPtr&lt;JSC::Exception&gt; exception;
<a name="5" id="anc5"></a><span class="line-modified">118     JSExecState::profiledCall(exec, JSC::ProfilingReason::Other, m_function.get(), callType, callData, thisValue, arguments, exception);</span>
119 
<a name="6" id="anc6"></a><span class="line-modified">120     InspectorInstrumentation::didCallFunction(cookie, &amp;context);</span>
121 
122     if (exception)
<a name="7" id="anc7"></a><span class="line-modified">123         reportException(exec, exception);</span>
124 }
125 
126 void ScheduledAction::execute(Document&amp; document)
127 {
128     JSDOMWindow* window = toJSDOMWindow(document.frame(), m_isolatedWorld);
129     if (!window)
130         return;
131 
132     RefPtr&lt;Frame&gt; frame = window-&gt;wrapped().frame();
133     if (!frame || !frame-&gt;script().canExecuteScripts(AboutToExecuteScript))
134         return;
135 
136     if (m_function)
137         executeFunctionInContext(window, window-&gt;proxy(), document);
138     else
<a name="8" id="anc8"></a><span class="line-modified">139         frame-&gt;script().executeScriptInWorld(m_isolatedWorld, m_code);</span>
140 }
141 
142 void ScheduledAction::execute(WorkerGlobalScope&amp; workerGlobalScope)
143 {
144     // In a Worker, the execution should always happen on a worker thread.
145     ASSERT(workerGlobalScope.thread().thread() == &amp;Thread::current());
146 
147     WorkerScriptController* scriptController = workerGlobalScope.script();
148 
149     if (m_function) {
150         JSWorkerGlobalScope* contextWrapper = scriptController-&gt;workerGlobalScopeWrapper();
151         executeFunctionInContext(contextWrapper, contextWrapper, workerGlobalScope);
152     } else {
153         ScriptSourceCode code(m_code, URL(workerGlobalScope.url()));
154         scriptController-&gt;evaluate(code);
155     }
156 }
157 
158 } // namespace WebCore
<a name="9" id="anc9"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="9" type="hidden" />
</body>
</html>