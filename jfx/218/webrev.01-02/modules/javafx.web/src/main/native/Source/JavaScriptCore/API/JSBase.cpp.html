<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New modules/javafx.web/src/main/native/Source/JavaScriptCore/API/JSBase.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (C) 2006, 2007, 2013, 2016 Apple Inc. All rights reserved.
  3  *
  4  * Redistribution and use in source and binary forms, with or without
  5  * modification, are permitted provided that the following conditions
  6  * are met:
  7  * 1. Redistributions of source code must retain the above copyright
  8  *    notice, this list of conditions and the following disclaimer.
  9  * 2. Redistributions in binary form must reproduce the above copyright
 10  *    notice, this list of conditions and the following disclaimer in the
 11  *    documentation and/or other materials provided with the distribution.
 12  *
 13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. ``AS IS&#39;&#39; AND ANY
 14  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 15  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 16  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE INC. OR
 17  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 18  * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 19  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 20  * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 21  * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 22  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 23  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #include &quot;config.h&quot;
 27 #include &quot;JSBase.h&quot;
 28 #include &quot;JSBaseInternal.h&quot;
 29 #include &quot;JSBasePrivate.h&quot;
 30 
 31 #include &quot;APICast.h&quot;
 32 #include &quot;CallFrame.h&quot;
 33 #include &quot;Completion.h&quot;
 34 #include &quot;Exception.h&quot;
 35 #include &quot;GCActivityCallback.h&quot;
 36 #include &quot;Identifier.h&quot;
 37 #include &quot;InitializeThreading.h&quot;
 38 #include &quot;JSGlobalObject.h&quot;
 39 #include &quot;JSLock.h&quot;
 40 #include &quot;JSObject.h&quot;
 41 #include &quot;ObjectConstructor.h&quot;
 42 #include &quot;OpaqueJSString.h&quot;
 43 #include &quot;JSCInlines.h&quot;
 44 #include &quot;SourceCode.h&quot;
 45 #include &lt;wtf/text/StringHash.h&gt;
 46 
 47 #if ENABLE(REMOTE_INSPECTOR)
 48 #include &quot;JSGlobalObjectInspectorController.h&quot;
 49 #endif
 50 
 51 using namespace JSC;
 52 
 53 JSValueRef JSEvaluateScriptInternal(const JSLockHolder&amp;, JSContextRef ctx, JSObjectRef thisObject, const SourceCode&amp; source, JSValueRef* exception)
 54 {
 55     JSObject* jsThisObject = toJS(thisObject);
 56 
 57     // evaluate sets &quot;this&quot; to the global object if it is NULL
 58     JSGlobalObject* globalObject = toJS(ctx);
 59     NakedPtr&lt;Exception&gt; evaluationException;
 60     JSValue returnValue = profiledEvaluate(globalObject, ProfilingReason::API, source, jsThisObject, evaluationException);
 61 
 62     if (evaluationException) {
 63         if (exception)
 64             *exception = toRef(globalObject, evaluationException-&gt;value());
 65 #if ENABLE(REMOTE_INSPECTOR)
 66         // FIXME: If we have a debugger attached we could learn about ParseError exceptions through
 67         // ScriptDebugServer::sourceParsed and this path could produce a duplicate warning. The
 68         // Debugger path is currently ignored by inspector.
 69         // NOTE: If we don&#39;t have a debugger, this SourceCode will be forever lost to the inspector.
 70         // We could stash it in the inspector in case an inspector is ever opened.
 71         globalObject-&gt;inspectorController().reportAPIException(globalObject, evaluationException);
 72 #endif
 73         return nullptr;
 74     }
 75 
 76     if (returnValue)
 77         return toRef(globalObject, returnValue);
 78 
 79     // happens, for example, when the only statement is an empty (&#39;;&#39;) statement
 80     return toRef(globalObject, jsUndefined());
 81 }
 82 
 83 JSValueRef JSEvaluateScript(JSContextRef ctx, JSStringRef script, JSObjectRef thisObject, JSStringRef sourceURL, int startingLineNumber, JSValueRef* exception)
 84 {
 85     if (!ctx) {
 86         ASSERT_NOT_REACHED();
 87         return nullptr;
 88     }
 89     JSGlobalObject* globalObject = toJS(ctx);
 90     VM&amp; vm = globalObject-&gt;vm();
 91     JSLockHolder locker(vm);
 92 
 93     startingLineNumber = std::max(1, startingLineNumber);
 94 
 95     auto sourceURLString = sourceURL ? sourceURL-&gt;string() : String();
 96     SourceCode source = makeSource(script-&gt;string(), SourceOrigin { sourceURLString }, URL({ }, sourceURLString), TextPosition(OrdinalNumber::fromOneBasedInt(startingLineNumber), OrdinalNumber()));
 97 
 98     return JSEvaluateScriptInternal(locker, ctx, thisObject, source, exception);
 99 }
100 
101 bool JSCheckScriptSyntax(JSContextRef ctx, JSStringRef script, JSStringRef sourceURL, int startingLineNumber, JSValueRef* exception)
102 {
103     if (!ctx) {
104         ASSERT_NOT_REACHED();
105         return false;
106     }
107     JSGlobalObject* globalObject = toJS(ctx);
108     VM&amp; vm = globalObject-&gt;vm();
109     JSLockHolder locker(vm);
110 
111     startingLineNumber = std::max(1, startingLineNumber);
112 
113     auto sourceURLString = sourceURL ? sourceURL-&gt;string() : String();
114     SourceCode source = makeSource(script-&gt;string(), SourceOrigin { sourceURLString }, URL({ }, sourceURLString), TextPosition(OrdinalNumber::fromOneBasedInt(startingLineNumber), OrdinalNumber()));
115 
116     JSValue syntaxException;
117     bool isValidSyntax = checkSyntax(globalObject, source, &amp;syntaxException);
118 
119     if (!isValidSyntax) {
120         if (exception)
121             *exception = toRef(globalObject, syntaxException);
122 #if ENABLE(REMOTE_INSPECTOR)
123         Exception* exception = Exception::create(vm, syntaxException);
124         globalObject-&gt;inspectorController().reportAPIException(globalObject, exception);
125 #endif
126         return false;
127     }
128 
129     return true;
130 }
131 
132 void JSGarbageCollect(JSContextRef ctx)
133 {
134     // We used to recommend passing NULL as an argument here, which caused the only heap to be collected.
135     // As there is no longer a shared heap, the previously recommended usage became a no-op (but the GC
136     // will happen when the context group is destroyed).
137     // Because the function argument was originally ignored, some clients may pass their released context here,
138     // in which case there is a risk of crashing if another thread performs GC on the same heap in between.
139     if (!ctx)
140         return;
141 
142     JSGlobalObject* globalObject = toJS(ctx);
143     VM&amp; vm = globalObject-&gt;vm();
144     JSLockHolder locker(vm);
145 
146     vm.heap.reportAbandonedObjectGraph();
147 }
148 
149 void JSReportExtraMemoryCost(JSContextRef ctx, size_t size)
150 {
151     if (!ctx) {
152         ASSERT_NOT_REACHED();
153         return;
154     }
155     JSGlobalObject* globalObject = toJS(ctx);
156     VM&amp; vm = globalObject-&gt;vm();
157     JSLockHolder locker(vm);
158 
159     vm.heap.deprecatedReportExtraMemory(size);
160 }
161 
162 extern &quot;C&quot; JS_EXPORT void JSSynchronousGarbageCollectForDebugging(JSContextRef);
163 extern &quot;C&quot; JS_EXPORT void JSSynchronousEdenCollectForDebugging(JSContextRef);
164 
165 void JSSynchronousGarbageCollectForDebugging(JSContextRef ctx)
166 {
167     if (!ctx)
168         return;
169 
170     JSGlobalObject* globalObject = toJS(ctx);
171     VM&amp; vm = globalObject-&gt;vm();
172     JSLockHolder locker(vm);
173     vm.heap.collectNow(Sync, CollectionScope::Full);
174 }
175 
176 void JSSynchronousEdenCollectForDebugging(JSContextRef ctx)
177 {
178     if (!ctx)
179         return;
180 
181     JSGlobalObject* globalObject = toJS(ctx);
182     VM&amp; vm = globalObject-&gt;vm();
183     JSLockHolder locker(vm);
184     vm.heap.collectSync(CollectionScope::Eden);
185 }
186 
187 void JSDisableGCTimer(void)
188 {
189     GCActivityCallback::s_shouldCreateGCTimer = false;
190 }
191 
192 JSObjectRef JSGetMemoryUsageStatistics(JSContextRef ctx)
193 {
194     if (!ctx) {
195         ASSERT_NOT_REACHED();
196         return 0;
197     }
198 
199     JSGlobalObject* globalObject = toJS(ctx);
200     VM&amp; vm = globalObject-&gt;vm();
201     JSLockHolder locker(vm);
202 
203     JSObject* object = constructEmptyObject(globalObject);
204     object-&gt;putDirect(vm, Identifier::fromString(vm, &quot;heapSize&quot;), jsNumber(vm.heap.size()));
205     object-&gt;putDirect(vm, Identifier::fromString(vm, &quot;heapCapacity&quot;), jsNumber(vm.heap.capacity()));
206     object-&gt;putDirect(vm, Identifier::fromString(vm, &quot;extraMemorySize&quot;), jsNumber(vm.heap.extraMemorySize()));
207     object-&gt;putDirect(vm, Identifier::fromString(vm, &quot;objectCount&quot;), jsNumber(vm.heap.objectCount()));
208     object-&gt;putDirect(vm, Identifier::fromString(vm, &quot;protectedObjectCount&quot;), jsNumber(vm.heap.protectedObjectCount()));
209     object-&gt;putDirect(vm, Identifier::fromString(vm, &quot;globalObjectCount&quot;), jsNumber(vm.heap.globalObjectCount()));
210     object-&gt;putDirect(vm, Identifier::fromString(vm, &quot;protectedGlobalObjectCount&quot;), jsNumber(vm.heap.protectedGlobalObjectCount()));
211 
212     return toRef(object);
213 }
214 
215 #if PLATFORM(IOS_FAMILY) &amp;&amp; TARGET_OS_IOS
216 // FIXME: Expose symbols to tell dyld where to find JavaScriptCore on older versions of
217 // iOS (&lt; 7.0). We should remove these symbols once we no longer need to support such
218 // versions of iOS. See &lt;rdar://problem/13696872&gt; for more details.
219 JS_EXPORT extern const char iosInstallName43 __asm(&quot;$ld$install_name$os4.3$/System/Library/PrivateFrameworks/JavaScriptCore.framework/JavaScriptCore&quot;);
220 JS_EXPORT extern const char iosInstallName50 __asm(&quot;$ld$install_name$os5.0$/System/Library/PrivateFrameworks/JavaScriptCore.framework/JavaScriptCore&quot;);
221 JS_EXPORT extern const char iosInstallName51 __asm(&quot;$ld$install_name$os5.1$/System/Library/PrivateFrameworks/JavaScriptCore.framework/JavaScriptCore&quot;);
222 JS_EXPORT extern const char iosInstallName60 __asm(&quot;$ld$install_name$os6.0$/System/Library/PrivateFrameworks/JavaScriptCore.framework/JavaScriptCore&quot;);
223 JS_EXPORT extern const char iosInstallName61 __asm(&quot;$ld$install_name$os6.1$/System/Library/PrivateFrameworks/JavaScriptCore.framework/JavaScriptCore&quot;);
224 
225 const char iosInstallName43 = 0;
226 const char iosInstallName50 = 0;
227 const char iosInstallName51 = 0;
228 const char iosInstallName60 = 0;
229 const char iosInstallName61 = 0;
230 #endif
    </pre>
  </body>
</html>