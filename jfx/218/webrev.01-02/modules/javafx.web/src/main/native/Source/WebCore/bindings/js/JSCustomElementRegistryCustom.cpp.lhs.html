<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/WebCore/bindings/js/JSCustomElementRegistryCustom.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (C) 2015-2019 Apple Inc. All rights reserved.
  3  *
  4  * Redistribution and use in source and binary forms, with or without
  5  * modification, are permitted provided that the following conditions
  6  * are met:
  7  * 1. Redistributions of source code must retain the above copyright
  8  *    notice, this list of conditions and the following disclaimer.
  9  * 2. Redistributions in binary form must reproduce the above copyright
 10  *    notice, this list of conditions and the following disclaimer in the
 11  *    documentation and/or other materials provided with the distribution.
 12  *
 13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. ``AS IS&#39;&#39; AND ANY
 14  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 15  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 16  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE INC. OR
 17  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 18  * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 19  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 20  * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 21  * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 22  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 23  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #include &quot;config.h&quot;
 27 #include &quot;JSCustomElementRegistry.h&quot;
 28 
 29 #include &quot;CustomElementRegistry.h&quot;
 30 #include &quot;Document.h&quot;
 31 #include &quot;HTMLNames.h&quot;
 32 #include &quot;JSCustomElementInterface.h&quot;
 33 #include &quot;JSDOMBinding.h&quot;
 34 #include &quot;JSDOMConvertSequences.h&quot;
 35 #include &quot;JSDOMConvertStrings.h&quot;
 36 #include &quot;JSDOMPromiseDeferred.h&quot;
 37 #include &lt;wtf/SetForScope.h&gt;
 38 
 39 
 40 namespace WebCore {
 41 using namespace JSC;
 42 
<a name="1" id="anc1"></a><span class="line-modified"> 43 static JSObject* getCustomElementCallback(ExecState&amp; state, JSObject&amp; prototype, const Identifier&amp; id)</span>
 44 {
<a name="2" id="anc2"></a><span class="line-modified"> 45     VM&amp; vm = state.vm();</span>
 46     auto scope = DECLARE_THROW_SCOPE(vm);
 47 
<a name="3" id="anc3"></a><span class="line-modified"> 48     JSValue callback = prototype.get(&amp;state, id);</span>
 49     RETURN_IF_EXCEPTION(scope, nullptr);
 50     if (callback.isUndefined())
 51         return nullptr;
 52     if (!callback.isFunction(vm)) {
<a name="4" id="anc4"></a><span class="line-modified"> 53         throwTypeError(&amp;state, scope, &quot;A custom element callback must be a function&quot;_s);</span>
 54         return nullptr;
 55     }
 56     return callback.getObject();
 57 }
 58 
<a name="5" id="anc5"></a><span class="line-modified"> 59 static bool validateCustomElementNameAndThrowIfNeeded(ExecState&amp; state, const AtomString&amp; name)</span>
 60 {
<a name="6" id="anc6"></a><span class="line-modified"> 61     auto scope = DECLARE_THROW_SCOPE(state.vm());</span>
 62     switch (Document::validateCustomElementName(name)) {
 63     case CustomElementNameValidationStatus::Valid:
 64         return true;
 65     case CustomElementNameValidationStatus::FirstCharacterIsNotLowercaseASCIILetter:
<a name="7" id="anc7"></a><span class="line-modified"> 66         throwDOMSyntaxError(state, scope, &quot;Custom element name must have a lowercase ASCII letter as its first character&quot;_s);</span>
 67         return false;
 68     case CustomElementNameValidationStatus::ContainsUppercaseASCIILetter:
<a name="8" id="anc8"></a><span class="line-modified"> 69         throwDOMSyntaxError(state, scope, &quot;Custom element name cannot contain an uppercase ASCII letter&quot;_s);</span>
 70         return false;
 71     case CustomElementNameValidationStatus::ContainsNoHyphen:
<a name="9" id="anc9"></a><span class="line-modified"> 72         throwDOMSyntaxError(state, scope, &quot;Custom element name must contain a hyphen&quot;_s);</span>
 73         return false;
 74     case CustomElementNameValidationStatus::ContainsDisallowedCharacter:
<a name="10" id="anc10"></a><span class="line-modified"> 75         throwDOMSyntaxError(state, scope, &quot;Custom element name contains a character that is not allowed&quot;_s);</span>
 76         return false;
 77     case CustomElementNameValidationStatus::ConflictsWithStandardElementName:
<a name="11" id="anc11"></a><span class="line-modified"> 78         throwDOMSyntaxError(state, scope, &quot;Custom element name cannot be same as one of the standard elements&quot;_s);</span>
 79         return false;
 80     }
 81     ASSERT_NOT_REACHED();
 82     return false;
 83 }
 84 
 85 // https://html.spec.whatwg.org/#dom-customelementregistry-define
<a name="12" id="anc12"></a><span class="line-modified"> 86 JSValue JSCustomElementRegistry::define(ExecState&amp; state)</span>
 87 {
<a name="13" id="anc13"></a><span class="line-modified"> 88     VM&amp; vm = state.vm();</span>
 89     auto scope = DECLARE_THROW_SCOPE(vm);
 90 
<a name="14" id="anc14"></a><span class="line-modified"> 91     if (UNLIKELY(state.argumentCount() &lt; 2))</span>
<span class="line-modified"> 92         return throwException(&amp;state, scope, createNotEnoughArgumentsError(&amp;state));</span>
 93 
<a name="15" id="anc15"></a><span class="line-modified"> 94     AtomString localName(state.uncheckedArgument(0).toString(&amp;state)-&gt;toAtomString(&amp;state));</span>
 95     RETURN_IF_EXCEPTION(scope, JSValue());
 96 
<a name="16" id="anc16"></a><span class="line-modified"> 97     JSValue constructorValue = state.uncheckedArgument(1);</span>
 98     if (!constructorValue.isConstructor(vm))
<a name="17" id="anc17"></a><span class="line-modified"> 99         return throwTypeError(&amp;state, scope, &quot;The second argument must be a constructor&quot;_s);</span>
100     JSObject* constructor = constructorValue.getObject();
101 
<a name="18" id="anc18"></a><span class="line-modified">102     if (!validateCustomElementNameAndThrowIfNeeded(state, localName))</span>
103         return jsUndefined();
104 
105     CustomElementRegistry&amp; registry = wrapped();
106 
107     if (registry.elementDefinitionIsRunning()) {
<a name="19" id="anc19"></a><span class="line-modified">108         throwNotSupportedError(state, scope, &quot;Cannot define a custom element while defining another custom element&quot;_s);</span>
109         return jsUndefined();
110     }
111     SetForScope&lt;bool&gt; change(registry.elementDefinitionIsRunning(), true);
112 
113     if (registry.findInterface(localName)) {
<a name="20" id="anc20"></a><span class="line-modified">114         throwNotSupportedError(state, scope, &quot;Cannot define multiple custom elements with the same tag name&quot;_s);</span>
115         return jsUndefined();
116     }
117 
118     if (registry.containsConstructor(constructor)) {
<a name="21" id="anc21"></a><span class="line-modified">119         throwNotSupportedError(state, scope, &quot;Cannot define multiple custom elements with the same class&quot;_s);</span>
120         return jsUndefined();
121     }
122 
<a name="22" id="anc22"></a><span class="line-modified">123     JSValue prototypeValue = constructor-&gt;get(&amp;state, vm.propertyNames-&gt;prototype);</span>
124     RETURN_IF_EXCEPTION(scope, JSValue());
125     if (!prototypeValue.isObject())
<a name="23" id="anc23"></a><span class="line-modified">126         return throwTypeError(&amp;state, scope, &quot;Custom element constructor&#39;s prototype must be an object&quot;_s);</span>
127     JSObject&amp; prototypeObject = *asObject(prototypeValue);
128 
129     QualifiedName name(nullAtom(), localName, HTMLNames::xhtmlNamespaceURI);
130     auto elementInterface = JSCustomElementInterface::create(name, constructor, globalObject());
131 
<a name="24" id="anc24"></a><span class="line-modified">132     auto* connectedCallback = getCustomElementCallback(state, prototypeObject, Identifier::fromString(vm, &quot;connectedCallback&quot;));</span>
133     if (connectedCallback)
134         elementInterface-&gt;setConnectedCallback(connectedCallback);
135     RETURN_IF_EXCEPTION(scope, JSValue());
136 
<a name="25" id="anc25"></a><span class="line-modified">137     auto* disconnectedCallback = getCustomElementCallback(state, prototypeObject, Identifier::fromString(vm, &quot;disconnectedCallback&quot;));</span>
138     if (disconnectedCallback)
139         elementInterface-&gt;setDisconnectedCallback(disconnectedCallback);
140     RETURN_IF_EXCEPTION(scope, JSValue());
141 
<a name="26" id="anc26"></a><span class="line-modified">142     auto* adoptedCallback = getCustomElementCallback(state, prototypeObject, Identifier::fromString(vm, &quot;adoptedCallback&quot;));</span>
143     if (adoptedCallback)
144         elementInterface-&gt;setAdoptedCallback(adoptedCallback);
145     RETURN_IF_EXCEPTION(scope, JSValue());
146 
<a name="27" id="anc27"></a><span class="line-modified">147     auto* attributeChangedCallback = getCustomElementCallback(state, prototypeObject, Identifier::fromString(vm, &quot;attributeChangedCallback&quot;));</span>
148     RETURN_IF_EXCEPTION(scope, JSValue());
149     if (attributeChangedCallback) {
<a name="28" id="anc28"></a><span class="line-modified">150         auto observedAttributesValue = constructor-&gt;get(&amp;state, Identifier::fromString(vm, &quot;observedAttributes&quot;));</span>
151         RETURN_IF_EXCEPTION(scope, JSValue());
152         if (!observedAttributesValue.isUndefined()) {
<a name="29" id="anc29"></a><span class="line-modified">153             auto observedAttributes = convert&lt;IDLSequence&lt;IDLDOMString&gt;&gt;(state, observedAttributesValue);</span>
154             RETURN_IF_EXCEPTION(scope, JSValue());
155             elementInterface-&gt;setAttributeChangedCallback(attributeChangedCallback, observedAttributes);
156         }
157     }
158 
159     auto addToGlobalObjectWithPrivateName = [&amp;] (JSObject* objectToAdd) {
160         if (objectToAdd) {
161             PrivateName uniquePrivateName;
162             globalObject()-&gt;putDirect(vm, uniquePrivateName, objectToAdd);
163         }
164     };
165 
166     addToGlobalObjectWithPrivateName(constructor);
167     addToGlobalObjectWithPrivateName(connectedCallback);
168     addToGlobalObjectWithPrivateName(disconnectedCallback);
169     addToGlobalObjectWithPrivateName(adoptedCallback);
170     addToGlobalObjectWithPrivateName(attributeChangedCallback);
171 
172     registry.addElementDefinition(WTFMove(elementInterface));
173 
174     return jsUndefined();
175 }
176 
177 // https://html.spec.whatwg.org/#dom-customelementregistry-whendefined
<a name="30" id="anc30"></a><span class="line-modified">178 static JSValue whenDefinedPromise(ExecState&amp; state, JSDOMGlobalObject&amp; globalObject, CustomElementRegistry&amp; registry, JSPromiseDeferred&amp; promiseDeferred)</span>
179 {
<a name="31" id="anc31"></a><span class="line-modified">180     auto scope = DECLARE_THROW_SCOPE(state.vm());</span>
181 
<a name="32" id="anc32"></a><span class="line-modified">182     if (UNLIKELY(state.argumentCount() &lt; 1))</span>
<span class="line-modified">183         return throwException(&amp;state, scope, createNotEnoughArgumentsError(&amp;state));</span>
184 
<a name="33" id="anc33"></a><span class="line-modified">185     AtomString localName(state.uncheckedArgument(0).toString(&amp;state)-&gt;toAtomString(&amp;state));</span>
186     RETURN_IF_EXCEPTION(scope, JSValue());
187 
<a name="34" id="anc34"></a><span class="line-modified">188     if (!validateCustomElementNameAndThrowIfNeeded(state, localName)) {</span>
189         EXCEPTION_ASSERT(scope.exception());
190         return jsUndefined();
191     }
192 
193     if (registry.findInterface(localName)) {
<a name="35" id="anc35"></a><span class="line-modified">194         DeferredPromise::create(globalObject, promiseDeferred)-&gt;resolve();</span>
<span class="line-modified">195         return promiseDeferred.promise();</span>
196     }
197 
198     auto result = registry.promiseMap().ensure(localName, [&amp;] {
<a name="36" id="anc36"></a><span class="line-modified">199         return DeferredPromise::create(globalObject, promiseDeferred);</span>
200     });
201 
202     return result.iterator-&gt;value-&gt;promise();
203 }
204 
<a name="37" id="anc37"></a><span class="line-modified">205 JSValue JSCustomElementRegistry::whenDefined(ExecState&amp; state)</span>
206 {
<a name="38" id="anc38"></a><span class="line-modified">207     auto scope = DECLARE_CATCH_SCOPE(state.vm());</span>
208 
209     ASSERT(globalObject());
<a name="39" id="anc39"></a><span class="line-modified">210     auto promiseDeferred = JSPromiseDeferred::tryCreate(&amp;state, globalObject());</span>
<span class="line-modified">211     RELEASE_ASSERT(promiseDeferred);</span>
<span class="line-removed">212     JSValue promise = whenDefinedPromise(state, *globalObject(), wrapped(), *promiseDeferred);</span>
213 
214     if (UNLIKELY(scope.exception())) {
<a name="40" id="anc40"></a><span class="line-modified">215         rejectPromiseWithExceptionIfAny(state, *globalObject(), *promiseDeferred);</span>
216         scope.assertNoException();
<a name="41" id="anc41"></a><span class="line-modified">217         return promiseDeferred-&gt;promise();</span>
218     }
219 
220     return promise;
221 }
222 
223 }
<a name="42" id="anc42"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="42" type="hidden" />
</body>
</html>