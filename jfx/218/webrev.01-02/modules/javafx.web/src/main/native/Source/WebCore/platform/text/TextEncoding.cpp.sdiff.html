<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WebCore/platform/text/TextEncoding.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="BidiResolver.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="TextEncodingRegistry.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/platform/text/TextEncoding.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 18  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE INC. OR
 19  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 20  * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 21  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 22  * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 23  * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 24  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 25  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 26  */
 27 
 28 #include &quot;config.h&quot;
 29 #include &quot;TextEncoding.h&quot;
 30 
 31 #include &quot;DecodeEscapeSequences.h&quot;
 32 #include &quot;TextCodec.h&quot;
 33 #include &quot;TextEncodingRegistry.h&quot;
 34 #include &lt;wtf/NeverDestroyed.h&gt;
 35 #include &lt;wtf/StdLibExtras.h&gt;
 36 #include &lt;wtf/text/StringView.h&gt;
 37 




 38 namespace WebCore {
 39 
 40 static const TextEncoding&amp; UTF7Encoding()
 41 {
 42     static NeverDestroyed&lt;TextEncoding&gt; globalUTF7Encoding(&quot;UTF-7&quot;);
 43     return globalUTF7Encoding;
 44 }
 45 
 46 TextEncoding::TextEncoding(const char* name)
<span class="line-modified"> 47     : m_name(atomicCanonicalTextEncodingName(name))</span>
 48     , m_backslashAsCurrencySymbol(backslashAsCurrencySymbol())
 49 {
 50     // Aliases are valid, but not &quot;replacement&quot; itself.
 51     if (equalLettersIgnoringASCIICase(name, &quot;replacement&quot;))
 52         m_name = nullptr;
 53 }
 54 
 55 TextEncoding::TextEncoding(const String&amp; name)
<span class="line-modified"> 56     : m_name(atomicCanonicalTextEncodingName(name))</span>
 57     , m_backslashAsCurrencySymbol(backslashAsCurrencySymbol())
 58 {
 59     // Aliases are valid, but not &quot;replacement&quot; itself.
 60     if (equalLettersIgnoringASCIICase(name, &quot;replacement&quot;))
 61         m_name = nullptr;
 62 }
 63 
 64 String TextEncoding::decode(const char* data, size_t length, bool stopOnError, bool&amp; sawError) const
 65 {
 66     if (!m_name)
 67         return String();
 68 
 69     return newTextCodec(*this)-&gt;decode(data, length, true, stopOnError, sawError);
 70 }
 71 
 72 Vector&lt;uint8_t&gt; TextEncoding::encode(StringView string, UnencodableHandling handling) const
 73 {
 74     if (!m_name || string.isEmpty())
 75         return { };
 76 
 77     // FIXME: What&#39;s the right place to do normalization?
 78     // It&#39;s a little strange to do it inside the encode function.
 79     // Perhaps normalization should be an explicit step done before calling encode.

 80     auto normalizedString = normalizedNFC(string);
 81     return newTextCodec(*this)-&gt;encode(normalizedString.view, handling);




 82 }
 83 
 84 const char* TextEncoding::domName() const
 85 {
 86     if (noExtendedTextEncodingNameUsed())
 87         return m_name;
 88 
 89     // We treat EUC-KR as windows-949 (its superset), but need to expose
 90     // the name &#39;EUC-KR&#39; because the name &#39;windows-949&#39; is not recognized by
 91     // most Korean web servers even though they do use the encoding
 92     // &#39;windows-949&#39; with the name &#39;EUC-KR&#39;.
 93     // FIXME: This is not thread-safe. At the moment, this function is
 94     // only accessed in a single thread, but eventually has to be made
 95     // thread-safe along with usesVisualOrdering().
<span class="line-modified"> 96     static const char* const a = atomicCanonicalTextEncodingName(&quot;windows-949&quot;);</span>
 97     if (m_name == a)
 98         return &quot;EUC-KR&quot;;
 99     return m_name;
100 }
101 
102 bool TextEncoding::usesVisualOrdering() const
103 {
104     if (noExtendedTextEncodingNameUsed())
105         return false;
106 
<span class="line-modified">107     static const char* const a = atomicCanonicalTextEncodingName(&quot;ISO-8859-8&quot;);</span>
108     return m_name == a;
109 }
110 
111 bool TextEncoding::isJapanese() const
112 {
113     return isJapaneseEncoding(m_name);
114 }
115 
116 UChar TextEncoding::backslashAsCurrencySymbol() const
117 {
118     return shouldShowBackslashAsCurrencySymbolIn(m_name) ? 0x00A5 : &#39;\\&#39;;
119 }
120 
121 bool TextEncoding::isNonByteBasedEncoding() const
122 {
123     return *this == UTF16LittleEndianEncoding() || *this == UTF16BigEndianEncoding();
124 }
125 
126 bool TextEncoding::isUTF7Encoding() const
127 {
</pre>
</td>
<td>
<hr />
<pre>
 18  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE INC. OR
 19  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 20  * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 21  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 22  * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 23  * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 24  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 25  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 26  */
 27 
 28 #include &quot;config.h&quot;
 29 #include &quot;TextEncoding.h&quot;
 30 
 31 #include &quot;DecodeEscapeSequences.h&quot;
 32 #include &quot;TextCodec.h&quot;
 33 #include &quot;TextEncodingRegistry.h&quot;
 34 #include &lt;wtf/NeverDestroyed.h&gt;
 35 #include &lt;wtf/StdLibExtras.h&gt;
 36 #include &lt;wtf/text/StringView.h&gt;
 37 
<span class="line-added"> 38 #if USE(JAVA_UNICODE)</span>
<span class="line-added"> 39 #include &quot;TextNormalizerJava.h&quot;</span>
<span class="line-added"> 40 #endif</span>
<span class="line-added"> 41 </span>
 42 namespace WebCore {
 43 
 44 static const TextEncoding&amp; UTF7Encoding()
 45 {
 46     static NeverDestroyed&lt;TextEncoding&gt; globalUTF7Encoding(&quot;UTF-7&quot;);
 47     return globalUTF7Encoding;
 48 }
 49 
 50 TextEncoding::TextEncoding(const char* name)
<span class="line-modified"> 51     : m_name(atomCanonicalTextEncodingName(name))</span>
 52     , m_backslashAsCurrencySymbol(backslashAsCurrencySymbol())
 53 {
 54     // Aliases are valid, but not &quot;replacement&quot; itself.
 55     if (equalLettersIgnoringASCIICase(name, &quot;replacement&quot;))
 56         m_name = nullptr;
 57 }
 58 
 59 TextEncoding::TextEncoding(const String&amp; name)
<span class="line-modified"> 60     : m_name(atomCanonicalTextEncodingName(name))</span>
 61     , m_backslashAsCurrencySymbol(backslashAsCurrencySymbol())
 62 {
 63     // Aliases are valid, but not &quot;replacement&quot; itself.
 64     if (equalLettersIgnoringASCIICase(name, &quot;replacement&quot;))
 65         m_name = nullptr;
 66 }
 67 
 68 String TextEncoding::decode(const char* data, size_t length, bool stopOnError, bool&amp; sawError) const
 69 {
 70     if (!m_name)
 71         return String();
 72 
 73     return newTextCodec(*this)-&gt;decode(data, length, true, stopOnError, sawError);
 74 }
 75 
 76 Vector&lt;uint8_t&gt; TextEncoding::encode(StringView string, UnencodableHandling handling) const
 77 {
 78     if (!m_name || string.isEmpty())
 79         return { };
 80 
 81     // FIXME: What&#39;s the right place to do normalization?
 82     // It&#39;s a little strange to do it inside the encode function.
 83     // Perhaps normalization should be an explicit step done before calling encode.
<span class="line-added"> 84 #if !USE(JAVA_UNICODE)</span>
 85     auto normalizedString = normalizedNFC(string);
 86     return newTextCodec(*this)-&gt;encode(normalizedString.view, handling);
<span class="line-added"> 87 #else</span>
<span class="line-added"> 88     String normalized = TextNormalizer::normalize(text.upconvertedCharacters(), text.length(), TextNormalizer::NFC);</span>
<span class="line-added"> 89     return newTextCodec(*this)-&gt;encode(StringView { normalized.characters16(), normalized.length() }, handling);</span>
<span class="line-added"> 90 #endif</span>
 91 }
 92 
 93 const char* TextEncoding::domName() const
 94 {
 95     if (noExtendedTextEncodingNameUsed())
 96         return m_name;
 97 
 98     // We treat EUC-KR as windows-949 (its superset), but need to expose
 99     // the name &#39;EUC-KR&#39; because the name &#39;windows-949&#39; is not recognized by
100     // most Korean web servers even though they do use the encoding
101     // &#39;windows-949&#39; with the name &#39;EUC-KR&#39;.
102     // FIXME: This is not thread-safe. At the moment, this function is
103     // only accessed in a single thread, but eventually has to be made
104     // thread-safe along with usesVisualOrdering().
<span class="line-modified">105     static const char* const a = atomCanonicalTextEncodingName(&quot;windows-949&quot;);</span>
106     if (m_name == a)
107         return &quot;EUC-KR&quot;;
108     return m_name;
109 }
110 
111 bool TextEncoding::usesVisualOrdering() const
112 {
113     if (noExtendedTextEncodingNameUsed())
114         return false;
115 
<span class="line-modified">116     static const char* const a = atomCanonicalTextEncodingName(&quot;ISO-8859-8&quot;);</span>
117     return m_name == a;
118 }
119 
120 bool TextEncoding::isJapanese() const
121 {
122     return isJapaneseEncoding(m_name);
123 }
124 
125 UChar TextEncoding::backslashAsCurrencySymbol() const
126 {
127     return shouldShowBackslashAsCurrencySymbolIn(m_name) ? 0x00A5 : &#39;\\&#39;;
128 }
129 
130 bool TextEncoding::isNonByteBasedEncoding() const
131 {
132     return *this == UTF16LittleEndianEncoding() || *this == UTF16BigEndianEncoding();
133 }
134 
135 bool TextEncoding::isUTF7Encoding() const
136 {
</pre>
</td>
</tr>
</table>
<center><a href="BidiResolver.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="TextEncodingRegistry.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>