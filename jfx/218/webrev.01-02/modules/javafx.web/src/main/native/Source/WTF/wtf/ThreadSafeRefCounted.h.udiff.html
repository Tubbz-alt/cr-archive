<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WTF/wtf/ThreadSafeRefCounted.h</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="SystemTracing.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="ThreadSpecific.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WTF/wtf/ThreadSafeRefCounted.h</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -30,23 +30,43 @@</span>
  #include &lt;wtf/MainThread.h&gt;
  #include &lt;wtf/Noncopyable.h&gt;
  
  namespace WTF {
  
<span class="udiff-line-added">+ #if defined(NDEBUG) &amp;&amp; !ENABLE(SECURITY_ASSERTIONS)</span>
<span class="udiff-line-added">+ #define CHECK_THREAD_SAFE_REF_COUNTED_LIFECYCLE 0</span>
<span class="udiff-line-added">+ #else</span>
<span class="udiff-line-added">+ #define CHECK_THREAD_SAFE_REF_COUNTED_LIFECYCLE 1</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+ </span>
  class ThreadSafeRefCountedBase {
      WTF_MAKE_NONCOPYABLE(ThreadSafeRefCountedBase);
      WTF_MAKE_FAST_ALLOCATED;
  public:
      ThreadSafeRefCountedBase() = default;
  
<span class="udiff-line-added">+ #if CHECK_THREAD_SAFE_REF_COUNTED_LIFECYCLE</span>
<span class="udiff-line-added">+     ~ThreadSafeRefCountedBase()</span>
<span class="udiff-line-added">+     {</span>
<span class="udiff-line-added">+         // When this ThreadSafeRefCounted object is a part of another object, derefBase() is never called on this object.</span>
<span class="udiff-line-added">+         m_deletionHasBegun = true;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+ </span>
      void ref() const
      {
<span class="udiff-line-added">+ #if CHECK_THREAD_SAFE_REF_COUNTED_LIFECYCLE</span>
<span class="udiff-line-added">+         ASSERT_WITH_SECURITY_IMPLICATION(!m_deletionHasBegun);</span>
<span class="udiff-line-added">+ #endif</span>
          ++m_refCount;
      }
  
      bool hasOneRef() const
      {
<span class="udiff-line-added">+ #if CHECK_THREAD_SAFE_REF_COUNTED_LIFECYCLE</span>
<span class="udiff-line-added">+         ASSERT(!m_deletionHasBegun);</span>
<span class="udiff-line-added">+ #endif</span>
          return refCount() == 1;
      }
  
      unsigned refCount() const
      {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -55,15 +75,35 @@</span>
  
  protected:
      // Returns whether the pointer should be freed or not.
      bool derefBase() const
      {
<span class="udiff-line-modified-removed">-         return !--m_refCount;</span>
<span class="udiff-line-modified-added">+         ASSERT(m_refCount);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ #if CHECK_THREAD_SAFE_REF_COUNTED_LIFECYCLE</span>
<span class="udiff-line-added">+         ASSERT_WITH_SECURITY_IMPLICATION(!m_deletionHasBegun);</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         if (UNLIKELY(!--m_refCount)) {</span>
<span class="udiff-line-added">+             // Setting m_refCount to 1 here prevents double delete within the destructor but not from another thread</span>
<span class="udiff-line-added">+             // since such a thread could have ref&#39;ed this object long after it had been deleted. See webkit.org/b/201576.</span>
<span class="udiff-line-added">+             m_refCount = 1;</span>
<span class="udiff-line-added">+ #if CHECK_THREAD_SAFE_REF_COUNTED_LIFECYCLE</span>
<span class="udiff-line-added">+             m_deletionHasBegun = true;</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+             return true;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         return false;</span>
      }
  
  private:
      mutable std::atomic&lt;unsigned&gt; m_refCount { 1 };
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ #if CHECK_THREAD_SAFE_REF_COUNTED_LIFECYCLE</span>
<span class="udiff-line-added">+     mutable std::atomic&lt;bool&gt; m_deletionHasBegun { false };</span>
<span class="udiff-line-added">+ #endif</span>
  };
  
  enum class DestructionThread { Any, Main, MainRunLoop };
  
  template&lt;class T, DestructionThread destructionThread = DestructionThread::Any&gt; class ThreadSafeRefCounted : public ThreadSafeRefCountedBase {
</pre>
<center><a href="SystemTracing.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="ThreadSpecific.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>