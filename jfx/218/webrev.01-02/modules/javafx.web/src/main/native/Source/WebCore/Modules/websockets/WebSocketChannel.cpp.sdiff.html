<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WebCore/Modules/websockets/WebSocketChannel.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="WebSocket.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="WebSocketDeflater.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/Modules/websockets/WebSocketChannel.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
187     LOG(Network, &quot;WebSocketChannel %p bufferedAmount()&quot;, this);
188     ASSERT(m_handle);
189     ASSERT(!m_suspended);
190     return m_handle-&gt;bufferedAmount();
191 }
192 
193 void WebSocketChannel::close(int code, const String&amp; reason)
194 {
195     LOG(Network, &quot;WebSocketChannel %p close() code=%d reason=&#39;%s&#39;&quot;, this, code, reason.utf8().data());
196     ASSERT(!m_suspended);
197     if (!m_handle)
198         return;
199     Ref&lt;WebSocketChannel&gt; protectedThis(*this); // An attempt to send closing handshake may fail, which will get the channel closed and dereferenced.
200     startClosingHandshake(code, reason);
201     if (m_closing &amp;&amp; !m_closingTimer.isActive())
202         m_closingTimer.startOneShot(TCPMaximumSegmentLifetime * 2);
203 }
204 
205 void WebSocketChannel::fail(const String&amp; reason)
206 {
<span class="line-modified">207     LOG(Network, &quot;WebSocketChannel %p fail() reason=&#39;%s&#39;&quot;, this, reason.utf8().data());</span>
208     ASSERT(!m_suspended);
209     if (m_document) {
210         InspectorInstrumentation::didReceiveWebSocketFrameError(m_document.get(), m_identifier, reason);
211 
212         String consoleMessage;
213         if (m_handshake)
214             consoleMessage = makeString(&quot;WebSocket connection to &#39;&quot;, m_handshake-&gt;url().stringCenterEllipsizedToLength(), &quot;&#39; failed: &quot;, reason);
215         else
216             consoleMessage = makeString(&quot;WebSocket connection failed: &quot;, reason);
217 
218         m_document-&gt;addConsoleMessage(MessageSource::Network, MessageLevel::Error, consoleMessage);
219     }
220 
221     // Hybi-10 specification explicitly states we must not continue to handle incoming data
222     // once the WebSocket connection is failed (section 7.1.7).
223     Ref&lt;WebSocketChannel&gt; protectedThis(*this); // The client can close the channel, potentially removing the last reference.
224     m_shouldDiscardReceivedData = true;
225     if (!m_buffer.isEmpty())
226         skipBuffer(m_buffer.size()); // Save memory.
227     m_deflateFramer.didFail();
</pre>
<hr />
<pre>
347 void WebSocketChannel::didUpdateBufferedAmount(SocketStreamHandle&amp;, size_t bufferedAmount)
348 {
349     if (m_client)
350         m_client-&gt;didUpdateBufferedAmount(bufferedAmount);
351 }
352 
353 void WebSocketChannel::didFailSocketStream(SocketStreamHandle&amp; handle, const SocketStreamError&amp; error)
354 {
355     LOG(Network, &quot;WebSocketChannel %p didFailSocketStream()&quot;, this);
356     ASSERT(&amp;handle == m_handle || !m_handle);
357     if (m_document) {
358         String message;
359         if (error.isNull())
360             message = &quot;WebSocket network error&quot;_s;
361         else if (error.localizedDescription().isNull())
362             message = makeString(&quot;WebSocket network error: error code &quot;, error.errorCode());
363         else
364             message = &quot;WebSocket network error: &quot; + error.localizedDescription();
365         InspectorInstrumentation::didReceiveWebSocketFrameError(m_document.get(), m_identifier, message);
366         m_document-&gt;addConsoleMessage(MessageSource::Network, MessageLevel::Error, message);

367     }
368     m_shouldDiscardReceivedData = true;
369     if (m_client)
370         m_client-&gt;didReceiveMessageError();
371     handle.disconnect();
372 }
373 
374 void WebSocketChannel::didStartLoading()
375 {
376     LOG(Network, &quot;WebSocketChannel %p didStartLoading()&quot;, this);
377     ASSERT(m_blobLoader);
378     ASSERT(m_blobLoaderStatus == BlobLoaderStarted);
379 }
380 
381 void WebSocketChannel::didReceiveData()
382 {
383     LOG(Network, &quot;WebSocketChannel %p didReceiveData()&quot;, this);
384     ASSERT(m_blobLoader);
385     ASSERT(m_blobLoaderStatus == BlobLoaderStarted);
386 }
</pre>
</td>
<td>
<hr />
<pre>
187     LOG(Network, &quot;WebSocketChannel %p bufferedAmount()&quot;, this);
188     ASSERT(m_handle);
189     ASSERT(!m_suspended);
190     return m_handle-&gt;bufferedAmount();
191 }
192 
193 void WebSocketChannel::close(int code, const String&amp; reason)
194 {
195     LOG(Network, &quot;WebSocketChannel %p close() code=%d reason=&#39;%s&#39;&quot;, this, code, reason.utf8().data());
196     ASSERT(!m_suspended);
197     if (!m_handle)
198         return;
199     Ref&lt;WebSocketChannel&gt; protectedThis(*this); // An attempt to send closing handshake may fail, which will get the channel closed and dereferenced.
200     startClosingHandshake(code, reason);
201     if (m_closing &amp;&amp; !m_closingTimer.isActive())
202         m_closingTimer.startOneShot(TCPMaximumSegmentLifetime * 2);
203 }
204 
205 void WebSocketChannel::fail(const String&amp; reason)
206 {
<span class="line-modified">207     RELEASE_LOG(Network, &quot;WebSocketChannel %p fail() reason=&#39;%s&#39;&quot;, this, reason.utf8().data());</span>
208     ASSERT(!m_suspended);
209     if (m_document) {
210         InspectorInstrumentation::didReceiveWebSocketFrameError(m_document.get(), m_identifier, reason);
211 
212         String consoleMessage;
213         if (m_handshake)
214             consoleMessage = makeString(&quot;WebSocket connection to &#39;&quot;, m_handshake-&gt;url().stringCenterEllipsizedToLength(), &quot;&#39; failed: &quot;, reason);
215         else
216             consoleMessage = makeString(&quot;WebSocket connection failed: &quot;, reason);
217 
218         m_document-&gt;addConsoleMessage(MessageSource::Network, MessageLevel::Error, consoleMessage);
219     }
220 
221     // Hybi-10 specification explicitly states we must not continue to handle incoming data
222     // once the WebSocket connection is failed (section 7.1.7).
223     Ref&lt;WebSocketChannel&gt; protectedThis(*this); // The client can close the channel, potentially removing the last reference.
224     m_shouldDiscardReceivedData = true;
225     if (!m_buffer.isEmpty())
226         skipBuffer(m_buffer.size()); // Save memory.
227     m_deflateFramer.didFail();
</pre>
<hr />
<pre>
347 void WebSocketChannel::didUpdateBufferedAmount(SocketStreamHandle&amp;, size_t bufferedAmount)
348 {
349     if (m_client)
350         m_client-&gt;didUpdateBufferedAmount(bufferedAmount);
351 }
352 
353 void WebSocketChannel::didFailSocketStream(SocketStreamHandle&amp; handle, const SocketStreamError&amp; error)
354 {
355     LOG(Network, &quot;WebSocketChannel %p didFailSocketStream()&quot;, this);
356     ASSERT(&amp;handle == m_handle || !m_handle);
357     if (m_document) {
358         String message;
359         if (error.isNull())
360             message = &quot;WebSocket network error&quot;_s;
361         else if (error.localizedDescription().isNull())
362             message = makeString(&quot;WebSocket network error: error code &quot;, error.errorCode());
363         else
364             message = &quot;WebSocket network error: &quot; + error.localizedDescription();
365         InspectorInstrumentation::didReceiveWebSocketFrameError(m_document.get(), m_identifier, message);
366         m_document-&gt;addConsoleMessage(MessageSource::Network, MessageLevel::Error, message);
<span class="line-added">367         LOG_ERROR(&quot;%s&quot;, message.utf8().data());</span>
368     }
369     m_shouldDiscardReceivedData = true;
370     if (m_client)
371         m_client-&gt;didReceiveMessageError();
372     handle.disconnect();
373 }
374 
375 void WebSocketChannel::didStartLoading()
376 {
377     LOG(Network, &quot;WebSocketChannel %p didStartLoading()&quot;, this);
378     ASSERT(m_blobLoader);
379     ASSERT(m_blobLoaderStatus == BlobLoaderStarted);
380 }
381 
382 void WebSocketChannel::didReceiveData()
383 {
384     LOG(Network, &quot;WebSocketChannel %p didReceiveData()&quot;, this);
385     ASSERT(m_blobLoader);
386     ASSERT(m_blobLoaderStatus == BlobLoaderStarted);
387 }
</pre>
</td>
</tr>
</table>
<center><a href="WebSocket.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="WebSocketDeflater.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>