<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WebCore/css/CSSFontFace.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="CSSFilterImageValue.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="CSSFontFace.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/css/CSSFontFace.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -33,23 +33,26 @@</span>
  #include &quot;CSSFontStyleRangeValue.h&quot;
  #include &quot;CSSPrimitiveValueMappings.h&quot;
  #include &quot;CSSUnicodeRangeValue.h&quot;
  #include &quot;CSSValue.h&quot;
  #include &quot;CSSValueList.h&quot;
<span class="udiff-line-added">+ #include &quot;CachedFont.h&quot;</span>
  #include &quot;Document.h&quot;
  #include &quot;Font.h&quot;
  #include &quot;FontCache.h&quot;
  #include &quot;FontDescription.h&quot;
  #include &quot;FontFace.h&quot;
<span class="udiff-line-removed">- #include &quot;FontVariantBuilder.h&quot;</span>
  #include &quot;Settings.h&quot;
<span class="udiff-line-added">+ #include &quot;SharedBuffer.h&quot;</span>
  #include &quot;StyleBuilderConverter.h&quot;
  #include &quot;StyleProperties.h&quot;
  #include &quot;StyleRule.h&quot;
  
  namespace WebCore {
  
<span class="udiff-line-added">+ DEFINE_ALLOCATOR_WITH_HEAP_IDENTIFIER(CSSFontFace);</span>
<span class="udiff-line-added">+ </span>
  template&lt;typename T&gt; void iterateClients(HashSet&lt;CSSFontFace::Client*&gt;&amp; clients, T callback)
  {
      Vector&lt;Ref&lt;CSSFontFace::Client&gt;&gt; clientsCopy;
      clientsCopy.reserveInitialCapacity(clients.size());
      for (auto* client : clients)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -87,11 +90,11 @@</span>
      }
      fontFace.sourcesPopulated();
  }
  
  CSSFontFace::CSSFontFace(CSSFontSelector* fontSelector, StyleRuleFontFace* cssConnection, FontFace* wrapper, bool isLocalFallback)
<span class="udiff-line-modified-removed">-     : m_fontSelector(fontSelector)</span>
<span class="udiff-line-modified-added">+     : m_fontSelector(makeWeakPtr(fontSelector))</span>
      , m_cssConnection(cssConnection)
      , m_wrapper(makeWeakPtr(wrapper))
      , m_isLocalFallback(isLocalFallback)
      , m_mayBePurged(!wrapper)
      , m_timeoutTimer(*this, &amp;CSSFontFace::timeoutFired)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -136,18 +139,18 @@</span>
              return { normalWeightValue(), normalWeightValue() };
          ASSERT(valueList.item(0)-&gt;isPrimitiveValue());
          ASSERT(valueList.item(1)-&gt;isPrimitiveValue());
          auto&amp; value0 = downcast&lt;CSSPrimitiveValue&gt;(*valueList.item(0));
          auto&amp; value1 = downcast&lt;CSSPrimitiveValue&gt;(*valueList.item(1));
<span class="udiff-line-modified-removed">-         auto result0 = StyleBuilderConverter::convertFontWeightFromValue(value0);</span>
<span class="udiff-line-modified-removed">-         auto result1 = StyleBuilderConverter::convertFontWeightFromValue(value1);</span>
<span class="udiff-line-modified-added">+         auto result0 = Style::BuilderConverter::convertFontWeightFromValue(value0);</span>
<span class="udiff-line-modified-added">+         auto result1 = Style::BuilderConverter::convertFontWeightFromValue(value1);</span>
          return { result0, result1 };
      }
  
      ASSERT(is&lt;CSSPrimitiveValue&gt;(value));
      auto&amp; primitiveValue = downcast&lt;CSSPrimitiveValue&gt;(value);
<span class="udiff-line-modified-removed">-     FontSelectionValue result = StyleBuilderConverter::convertFontWeightFromValue(primitiveValue);</span>
<span class="udiff-line-modified-added">+     FontSelectionValue result = Style::BuilderConverter::convertFontWeightFromValue(primitiveValue);</span>
      return { result, result };
  }
  
  void CSSFontFace::setWeight(CSSValue&amp; weight)
  {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -174,18 +177,18 @@</span>
              return { normalStretchValue(), normalStretchValue() };
          ASSERT(valueList.item(0)-&gt;isPrimitiveValue());
          ASSERT(valueList.item(1)-&gt;isPrimitiveValue());
          auto&amp; value0 = downcast&lt;CSSPrimitiveValue&gt;(*valueList.item(0));
          auto&amp; value1 = downcast&lt;CSSPrimitiveValue&gt;(*valueList.item(1));
<span class="udiff-line-modified-removed">-         auto result0 = StyleBuilderConverter::convertFontStretchFromValue(value0);</span>
<span class="udiff-line-modified-removed">-         auto result1 = StyleBuilderConverter::convertFontStretchFromValue(value1);</span>
<span class="udiff-line-modified-added">+         auto result0 = Style::BuilderConverter::convertFontStretchFromValue(value0);</span>
<span class="udiff-line-modified-added">+         auto result1 = Style::BuilderConverter::convertFontStretchFromValue(value1);</span>
          return { result0, result1 };
      }
  
      ASSERT(is&lt;CSSPrimitiveValue&gt;(value));
      const auto&amp; primitiveValue = downcast&lt;CSSPrimitiveValue&gt;(value);
<span class="udiff-line-modified-removed">-     FontSelectionValue result = StyleBuilderConverter::convertFontStretchFromValue(primitiveValue);</span>
<span class="udiff-line-modified-added">+     FontSelectionValue result = Style::BuilderConverter::convertFontStretchFromValue(primitiveValue);</span>
      return { result, result };
  }
  
  void CSSFontFace::setStretch(CSSValue&amp; style)
  {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -204,11 +207,11 @@</span>
  }
  
  static FontSelectionRange calculateItalicRange(CSSValue&amp; value)
  {
      if (value.isFontStyleValue()) {
<span class="udiff-line-modified-removed">-         auto result = StyleBuilderConverter::convertFontStyleFromValue(value);</span>
<span class="udiff-line-modified-added">+         auto result = Style::BuilderConverter::convertFontStyleFromValue(value);</span>
          return { result.valueOr(normalItalicValue()), result.valueOr(normalItalicValue()) };
      }
  
      ASSERT(value.isFontStyleRangeValue());
      auto&amp; rangeValue = downcast&lt;CSSFontStyleRangeValue&gt;(value);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -222,18 +225,18 @@</span>
      }
      ASSERT(valueID == CSSValueOblique);
      auto length = rangeValue.obliqueValues-&gt;length();
      if (length == 1) {
          auto&amp; primitiveValue = downcast&lt;CSSPrimitiveValue&gt;(*rangeValue.obliqueValues-&gt;item(0));
<span class="udiff-line-modified-removed">-         FontSelectionValue result(primitiveValue.value&lt;float&gt;(CSSPrimitiveValue::CSS_DEG));</span>
<span class="udiff-line-modified-added">+         FontSelectionValue result(primitiveValue.value&lt;float&gt;(CSSUnitType::CSS_DEG));</span>
          return { result, result };
      }
      ASSERT(length == 2);
      auto&amp; primitiveValue1 = downcast&lt;CSSPrimitiveValue&gt;(*rangeValue.obliqueValues-&gt;item(0));
      auto&amp; primitiveValue2 = downcast&lt;CSSPrimitiveValue&gt;(*rangeValue.obliqueValues-&gt;item(1));
<span class="udiff-line-modified-removed">-     FontSelectionValue result1(primitiveValue1.value&lt;float&gt;(CSSPrimitiveValue::CSS_DEG));</span>
<span class="udiff-line-modified-removed">-     FontSelectionValue result2(primitiveValue2.value&lt;float&gt;(CSSPrimitiveValue::CSS_DEG));</span>
<span class="udiff-line-modified-added">+     FontSelectionValue result1(primitiveValue1.value&lt;float&gt;(CSSUnitType::CSS_DEG));</span>
<span class="udiff-line-modified-added">+     FontSelectionValue result2(primitiveValue2.value&lt;float&gt;(CSSUnitType::CSS_DEG));</span>
      return { result1, result2 };
  }
  
  void CSSFontFace::setStyle(CSSValue&amp; style)
  {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -276,151 +279,10 @@</span>
      });
  
      return true;
  }
  
<span class="udiff-line-removed">- bool CSSFontFace::setVariantLigatures(CSSValue&amp; variantLigatures)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-     auto ligatures = extractFontVariantLigatures(variantLigatures);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     if (m_variantSettings.commonLigatures == ligatures.commonLigatures</span>
<span class="udiff-line-removed">-         &amp;&amp; m_variantSettings.discretionaryLigatures == ligatures.discretionaryLigatures</span>
<span class="udiff-line-removed">-         &amp;&amp; m_variantSettings.historicalLigatures == ligatures.historicalLigatures</span>
<span class="udiff-line-removed">-         &amp;&amp; m_variantSettings.contextualAlternates == ligatures.contextualAlternates)</span>
<span class="udiff-line-removed">-         return true;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     m_variantSettings.commonLigatures = ligatures.commonLigatures;</span>
<span class="udiff-line-removed">-     m_variantSettings.discretionaryLigatures = ligatures.discretionaryLigatures;</span>
<span class="udiff-line-removed">-     m_variantSettings.historicalLigatures = ligatures.historicalLigatures;</span>
<span class="udiff-line-removed">-     m_variantSettings.contextualAlternates = ligatures.contextualAlternates;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     if (m_cssConnection)</span>
<span class="udiff-line-removed">-         m_cssConnection-&gt;mutableProperties().setProperty(CSSPropertyFontVariantLigatures, &amp;variantLigatures);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     iterateClients(m_clients, [&amp;](Client&amp; client) {</span>
<span class="udiff-line-removed">-         client.fontPropertyChanged(*this);</span>
<span class="udiff-line-removed">-     });</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     return true;</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- bool CSSFontFace::setVariantPosition(CSSValue&amp; variantPosition)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-     if (!is&lt;CSSPrimitiveValue&gt;(variantPosition))</span>
<span class="udiff-line-removed">-         return false;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     FontVariantPosition position = downcast&lt;CSSPrimitiveValue&gt;(variantPosition);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     if (m_variantSettings.position == position)</span>
<span class="udiff-line-removed">-         return true;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     m_variantSettings.position = position;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     if (m_cssConnection)</span>
<span class="udiff-line-removed">-         m_cssConnection-&gt;mutableProperties().setProperty(CSSPropertyFontVariantPosition, &amp;variantPosition);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     iterateClients(m_clients, [&amp;](Client&amp; client) {</span>
<span class="udiff-line-removed">-         client.fontPropertyChanged(*this);</span>
<span class="udiff-line-removed">-     });</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     return true;</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- bool CSSFontFace::setVariantCaps(CSSValue&amp; variantCaps)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-     if (!is&lt;CSSPrimitiveValue&gt;(variantCaps))</span>
<span class="udiff-line-removed">-         return false;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     FontVariantCaps caps = downcast&lt;CSSPrimitiveValue&gt;(variantCaps);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     if (m_variantSettings.caps == caps)</span>
<span class="udiff-line-removed">-         return true;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     m_variantSettings.caps = caps;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     if (m_cssConnection)</span>
<span class="udiff-line-removed">-         m_cssConnection-&gt;mutableProperties().setProperty(CSSPropertyFontVariantCaps, &amp;variantCaps);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     iterateClients(m_clients, [&amp;](Client&amp; client) {</span>
<span class="udiff-line-removed">-         client.fontPropertyChanged(*this);</span>
<span class="udiff-line-removed">-     });</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     return true;</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- bool CSSFontFace::setVariantNumeric(CSSValue&amp; variantNumeric)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-     auto numeric = extractFontVariantNumeric(variantNumeric);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     if (m_variantSettings.numericFigure == numeric.figure</span>
<span class="udiff-line-removed">-         &amp;&amp; m_variantSettings.numericSpacing == numeric.spacing</span>
<span class="udiff-line-removed">-         &amp;&amp; m_variantSettings.numericFraction == numeric.fraction</span>
<span class="udiff-line-removed">-         &amp;&amp; m_variantSettings.numericOrdinal == numeric.ordinal</span>
<span class="udiff-line-removed">-         &amp;&amp; m_variantSettings.numericSlashedZero == numeric.slashedZero)</span>
<span class="udiff-line-removed">-         return true;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     m_variantSettings.numericFigure = numeric.figure;</span>
<span class="udiff-line-removed">-     m_variantSettings.numericSpacing = numeric.spacing;</span>
<span class="udiff-line-removed">-     m_variantSettings.numericFraction = numeric.fraction;</span>
<span class="udiff-line-removed">-     m_variantSettings.numericOrdinal = numeric.ordinal;</span>
<span class="udiff-line-removed">-     m_variantSettings.numericSlashedZero = numeric.slashedZero;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     if (m_cssConnection)</span>
<span class="udiff-line-removed">-         m_cssConnection-&gt;mutableProperties().setProperty(CSSPropertyFontVariantNumeric, &amp;variantNumeric);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     iterateClients(m_clients, [&amp;](Client&amp; client) {</span>
<span class="udiff-line-removed">-         client.fontPropertyChanged(*this);</span>
<span class="udiff-line-removed">-     });</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     return true;</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- bool CSSFontFace::setVariantAlternates(CSSValue&amp; variantAlternates)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-     if (!is&lt;CSSPrimitiveValue&gt;(variantAlternates))</span>
<span class="udiff-line-removed">-         return false;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     FontVariantAlternates alternates = downcast&lt;CSSPrimitiveValue&gt;(variantAlternates);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     if (m_variantSettings.alternates == alternates)</span>
<span class="udiff-line-removed">-         return true;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     m_variantSettings.alternates = alternates;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     if (m_cssConnection)</span>
<span class="udiff-line-removed">-         m_cssConnection-&gt;mutableProperties().setProperty(CSSPropertyFontVariantAlternates, &amp;variantAlternates);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     iterateClients(m_clients, [&amp;](Client&amp; client) {</span>
<span class="udiff-line-removed">-         client.fontPropertyChanged(*this);</span>
<span class="udiff-line-removed">-     });</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     return true;</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- bool CSSFontFace::setVariantEastAsian(CSSValue&amp; variantEastAsian)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-     auto eastAsian = extractFontVariantEastAsian(variantEastAsian);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     if (m_variantSettings.eastAsianVariant == eastAsian.variant</span>
<span class="udiff-line-removed">-         &amp;&amp; m_variantSettings.eastAsianWidth == eastAsian.width</span>
<span class="udiff-line-removed">-         &amp;&amp; m_variantSettings.eastAsianRuby == eastAsian.ruby)</span>
<span class="udiff-line-removed">-         return true;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     m_variantSettings.eastAsianVariant = eastAsian.variant;</span>
<span class="udiff-line-removed">-     m_variantSettings.eastAsianWidth = eastAsian.width;</span>
<span class="udiff-line-removed">-     m_variantSettings.eastAsianRuby = eastAsian.ruby;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     if (m_cssConnection)</span>
<span class="udiff-line-removed">-         m_cssConnection-&gt;mutableProperties().setProperty(CSSPropertyFontVariantEastAsian, &amp;variantEastAsian);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     iterateClients(m_clients, [&amp;](Client&amp; client) {</span>
<span class="udiff-line-removed">-         client.fontPropertyChanged(*this);</span>
<span class="udiff-line-removed">-     });</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     return true;</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
  void CSSFontFace::setFeatureSettings(CSSValue&amp; featureSettings)
  {
      // Can only call this with a primitive value of normal, or a value list containing font feature values.
      ASSERT(is&lt;CSSPrimitiveValue&gt;(featureSettings) || is&lt;CSSValueList&gt;(featureSettings));
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -482,12 +344,12 @@</span>
      // Let&#39;s not pump the state machine until we&#39;ve got all our sources. font() and load() are smart enough to act correctly
      // when a source is failed or succeeded before we have asked it to load.
      if (m_sourcesPopulated)
          pump(ExternalResourceDownloadPolicy::Forbid);
  
<span class="udiff-line-modified-removed">-     ASSERT(m_fontSelector);</span>
<span class="udiff-line-modified-removed">-     m_fontSelector-&gt;fontLoaded();</span>
<span class="udiff-line-modified-added">+     if (m_fontSelector)</span>
<span class="udiff-line-modified-added">+         m_fontSelector-&gt;fontLoaded();</span>
  
      iterateClients(m_clients, [&amp;](Client&amp; client) {
          client.fontLoaded(*this);
      });
  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -585,22 +447,20 @@</span>
  
      // We should never add sources in the middle of loading.
      ASSERT(!m_sourcesPopulated);
  }
  
<span class="udiff-line-modified-removed">- AllowUserInstalledFonts CSSFontFace::allowUserInstalledFonts() const</span>
<span class="udiff-line-modified-added">+ Document* CSSFontFace::document() const</span>
  {
<span class="udiff-line-modified-removed">-     if (m_fontSelector &amp;&amp; m_fontSelector-&gt;document())</span>
<span class="udiff-line-removed">-         return m_fontSelector-&gt;document()-&gt;settings().shouldAllowUserInstalledFonts() ? AllowUserInstalledFonts::Yes : AllowUserInstalledFonts::No;</span>
<span class="udiff-line-removed">-     return AllowUserInstalledFonts::Yes;</span>
<span class="udiff-line-modified-added">+     return m_fontSelector ? m_fontSelector-&gt;document() : nullptr;</span>
  }
  
<span class="udiff-line-modified-removed">- bool CSSFontFace::shouldAllowDesignSystemUIFonts() const</span>
<span class="udiff-line-modified-added">+ AllowUserInstalledFonts CSSFontFace::allowUserInstalledFonts() const</span>
  {
      if (m_fontSelector &amp;&amp; m_fontSelector-&gt;document())
<span class="udiff-line-modified-removed">-         return m_fontSelector-&gt;document()-&gt;settings().shouldAllowDesignSystemUIFonts();</span>
<span class="udiff-line-modified-removed">-     return false;</span>
<span class="udiff-line-modified-added">+         return m_fontSelector-&gt;document()-&gt;settings().shouldAllowUserInstalledFonts() ? AllowUserInstalledFonts::Yes : AllowUserInstalledFonts::No;</span>
<span class="udiff-line-modified-added">+     return AllowUserInstalledFonts::Yes;</span>
  }
  
  static Settings::FontLoadTimingOverride fontLoadTimingOverride(CSSFontSelector* fontSelector)
  {
      auto overrideValue = Settings::FontLoadTimingOverride::None;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -735,11 +595,11 @@</span>
              // first call to CSSFontFace::font() and the FontRanges object sees a consistent view of the
              // CSSFontFace. This means we eagerly create some internal font objects when they may not be needed,
              // but it seems that this behavior is a requirement of the design of FontRanges. FIXME: Perhaps rethink
              // this design.
              if (policy == ExternalResourceDownloadPolicy::Allow || !source-&gt;requiresExternalResource()) {
<span class="udiff-line-modified-removed">-                 if (m_status == Status::Pending)</span>
<span class="udiff-line-modified-added">+                 if (policy == ExternalResourceDownloadPolicy::Allow &amp;&amp; m_status == Status::Pending)</span>
                      setStatus(Status::Loading);
                  source-&gt;load(m_fontSelector.get());
              }
          }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -747,22 +607,22 @@</span>
          case CSSFontFaceSource::Status::Pending:
              ASSERT(policy == ExternalResourceDownloadPolicy::Forbid);
              return i;
          case CSSFontFaceSource::Status::Loading:
              ASSERT(m_status == Status::Pending || m_status == Status::Loading || m_status == Status::TimedOut || m_status == Status::Failure);
<span class="udiff-line-modified-removed">-             if (m_status == Status::Pending)</span>
<span class="udiff-line-modified-added">+             if (policy == ExternalResourceDownloadPolicy::Allow &amp;&amp; m_status == Status::Pending)</span>
                  setStatus(Status::Loading);
              return i;
          case CSSFontFaceSource::Status::Success:
              ASSERT(m_status == Status::Pending || m_status == Status::Loading || m_status == Status::TimedOut || m_status == Status::Success || m_status == Status::Failure);
              if (m_status == Status::Pending)
                  setStatus(Status::Loading);
              if (m_status == Status::Loading || m_status == Status::TimedOut)
                  setStatus(Status::Success);
              return i;
          case CSSFontFaceSource::Status::Failure:
<span class="udiff-line-modified-removed">-             if (m_status == Status::Pending)</span>
<span class="udiff-line-modified-added">+             if (policy == ExternalResourceDownloadPolicy::Allow &amp;&amp; m_status == Status::Pending)</span>
                  setStatus(Status::Loading);
              break;
          }
      }
      if (m_sources.isEmpty() &amp;&amp; m_status == Status::Pending)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -818,12 +678,15 @@</span>
          case CSSFontFaceSource::Status::Loading: {
              Font::Visibility visibility = WebCore::visibility(status(), fontLoadTiming());
              return Font::create(FontCache::singleton().lastResortFallbackFont(fontDescription)-&gt;platformData(), Font::Origin::Local, Font::Interstitial::Yes, visibility);
          }
          case CSSFontFaceSource::Status::Success:
<span class="udiff-line-modified-removed">-             if (RefPtr&lt;Font&gt; result = source-&gt;font(fontDescription, syntheticBold, syntheticItalic, m_featureSettings, m_variantSettings, m_fontSelectionCapabilities))</span>
<span class="udiff-line-modified-added">+             if (auto result = source-&gt;font(fontDescription, syntheticBold, syntheticItalic, m_featureSettings, m_fontSelectionCapabilities)) {</span>
<span class="udiff-line-added">+                 auto* cachedFont = source-&gt;cachedFont();</span>
<span class="udiff-line-added">+                 result-&gt;setFontFaceData(cachedFont ? cachedFont-&gt;resourceBuffer() : nullptr);</span>
                  return result;
<span class="udiff-line-added">+             }</span>
              break;
          case CSSFontFaceSource::Status::Failure:
              break;
          }
      }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -852,6 +715,24 @@</span>
      }
      return false;
  }
  #endif
  
<span class="udiff-line-added">+ void CSSFontFace::setErrorState()</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     switch (m_status) {</span>
<span class="udiff-line-added">+     case Status::Pending:</span>
<span class="udiff-line-added">+         setStatus(Status::Loading);</span>
<span class="udiff-line-added">+         break;</span>
<span class="udiff-line-added">+     case Status::Success:</span>
<span class="udiff-line-added">+         ASSERT_NOT_REACHED();</span>
<span class="udiff-line-added">+         break;</span>
<span class="udiff-line-added">+     case Status::Failure:</span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+     default:</span>
<span class="udiff-line-added">+         break;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     setStatus(Status::Failure);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  }
</pre>
<center><a href="CSSFilterImageValue.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="CSSFontFace.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>