<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New modules/javafx.web/src/main/native/Source/WebCore/loader/ResourceLoadStatistics.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (C) 2016-2018 Apple Inc.  All rights reserved.
  3  *
  4  * Redistribution and use in source and binary forms, with or without
  5  * modification, are permitted provided that the following conditions
  6  * are met:
  7  * 1. Redistributions of source code must retain the above copyright
  8  *    notice, this list of conditions and the following disclaimer.
  9  * 2. Redistributions in binary form must reproduce the above copyright
 10  *    notice, this list of conditions and the following disclaimer in the
 11  *    documentation and/or other materials provided with the distribution.
 12  *
 13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. ``AS IS&#39;&#39; AND ANY
 14  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 15  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 16  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE INC. OR
 17  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 18  * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 19  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 20  * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 21  * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 22  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 23  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #include &quot;config.h&quot;
 27 #include &quot;ResourceLoadStatistics.h&quot;
 28 
 29 #include &quot;KeyedCoding.h&quot;
 30 #include &quot;PublicSuffix.h&quot;
 31 #include &lt;wtf/MainThread.h&gt;
 32 #include &lt;wtf/text/ASCIILiteral.h&gt;
 33 #include &lt;wtf/text/StringBuilder.h&gt;
 34 #include &lt;wtf/text/StringHash.h&gt;
 35 
 36 namespace WebCore {
 37 
 38 static Seconds timestampResolution { 5_s };
 39 
 40 typedef WTF::HashMap&lt;RegistrableDomain, unsigned, RegistrableDomain::RegistrableDomainHash, HashTraits&lt;RegistrableDomain&gt;, HashTraits&lt;unsigned&gt;&gt;::KeyValuePairType ResourceLoadStatisticsValue;
 41 
 42 static void encodeHashSet(KeyedEncoder&amp; encoder, const String&amp; label,  const String&amp; key, const HashSet&lt;RegistrableDomain&gt;&amp; hashSet)
 43 {
 44     if (hashSet.isEmpty())
 45         return;
 46 
 47     encoder.encodeObjects(label, hashSet.begin(), hashSet.end(), [&amp;key](KeyedEncoder&amp; encoderInner, const RegistrableDomain&amp; domain) {
 48         encoderInner.encodeString(key, domain.string());
 49     });
 50 }
 51 
 52 template&lt;typename T&gt;
 53 static void encodeOptionSet(KeyedEncoder&amp; encoder, const String&amp; label, const OptionSet&lt;T&gt;&amp; optionSet)
 54 {
 55     if (optionSet.isEmpty())
 56         return;
 57 
 58     uint64_t optionSetBitMask = optionSet.toRaw();
 59     encoder.encodeUInt64(label, optionSetBitMask);
 60 }
 61 
 62 #if ENABLE(WEB_API_STATISTICS)
 63 static void encodeFontHashSet(KeyedEncoder&amp; encoder, const String&amp; label, const HashSet&lt;String&gt;&amp; hashSet)
 64 {
 65     encodeHashSet(encoder, label, &quot;font&quot;, hashSet);
 66 }
 67 
 68 static void encodeCanvasActivityRecord(KeyedEncoder&amp; encoder, const String&amp; label, const CanvasActivityRecord&amp; canvasActivityRecord)
 69 {
 70     encoder.encodeObject(label, canvasActivityRecord, [] (KeyedEncoder&amp; encoderInner, const CanvasActivityRecord&amp; canvasActivityRecord) {
 71         encoderInner.encodeBool(&quot;wasDataRead&quot;, canvasActivityRecord.wasDataRead);
 72         encoderInner.encodeObjects(&quot;textWritten&quot;, canvasActivityRecord.textWritten.begin(), canvasActivityRecord.textWritten.end(), [] (KeyedEncoder&amp; encoderInner2, const String&amp; text) {
 73             encoderInner2.encodeString(&quot;text&quot;, text);
 74         });
 75     });
 76 }
 77 #endif
 78 
 79 void ResourceLoadStatistics::encode(KeyedEncoder&amp; encoder) const
 80 {
 81     encoder.encodeString(&quot;PrevalentResourceDomain&quot;_s, registrableDomain.string());
 82 
 83     encoder.encodeDouble(&quot;lastSeen&quot;_s, lastSeen.secondsSinceEpoch().value());
 84 
 85     // User interaction
 86     encoder.encodeBool(&quot;hadUserInteraction&quot;_s, hadUserInteraction);
 87     encoder.encodeDouble(&quot;mostRecentUserInteraction&quot;_s, mostRecentUserInteractionTime.secondsSinceEpoch().value());
 88     encoder.encodeBool(&quot;grandfathered&quot;_s, grandfathered);
 89 
 90     // Storage access
 91     encodeHashSet(encoder, &quot;storageAccessUnderTopFrameDomains&quot;_s, &quot;domain&quot;_s, storageAccessUnderTopFrameDomains);
 92 
 93     // Top frame stats
 94     encodeHashSet(encoder, &quot;topFrameUniqueRedirectsTo&quot;_s, &quot;domain&quot;_s, topFrameUniqueRedirectsTo);
 95     encodeHashSet(encoder, &quot;topFrameUniqueRedirectsFrom&quot;_s, &quot;domain&quot;_s, topFrameUniqueRedirectsFrom);
 96     encodeHashSet(encoder, &quot;topFrameLinkDecorationsFrom&quot;_s, &quot;domain&quot;, topFrameLinkDecorationsFrom);
 97     encoder.encodeBool(&quot;gotLinkDecorationFromPrevalentResource&quot;_s, gotLinkDecorationFromPrevalentResource);
 98     encodeHashSet(encoder, &quot;topFrameLoadedThirdPartyScripts&quot;_s, &quot;domain&quot;, topFrameLoadedThirdPartyScripts);
 99 
100     // Subframe stats
101     encodeHashSet(encoder, &quot;subframeUnderTopFrameDomains&quot;_s, &quot;domain&quot;_s, subframeUnderTopFrameDomains);
102 
103     // Subresource stats
104     encodeHashSet(encoder, &quot;subresourceUnderTopFrameDomains&quot;_s, &quot;domain&quot;_s, subresourceUnderTopFrameDomains);
105     encodeHashSet(encoder, &quot;subresourceUniqueRedirectsTo&quot;_s, &quot;domain&quot;_s, subresourceUniqueRedirectsTo);
106     encodeHashSet(encoder, &quot;subresourceUniqueRedirectsFrom&quot;_s, &quot;domain&quot;_s, subresourceUniqueRedirectsFrom);
107 
108     // Prevalent Resource
109     encoder.encodeBool(&quot;isPrevalentResource&quot;_s, isPrevalentResource);
110     encoder.encodeBool(&quot;isVeryPrevalentResource&quot;_s, isVeryPrevalentResource);
111     encoder.encodeUInt32(&quot;dataRecordsRemoved&quot;_s, dataRecordsRemoved);
112 
113     encoder.encodeUInt32(&quot;timesAccessedAsFirstPartyDueToUserInteraction&quot;_s, timesAccessedAsFirstPartyDueToUserInteraction);
114     encoder.encodeUInt32(&quot;timesAccessedAsFirstPartyDueToStorageAccessAPI&quot;_s, timesAccessedAsFirstPartyDueToStorageAccessAPI);
115 
116 #if ENABLE(WEB_API_STATISTICS)
117     encodeFontHashSet(encoder, &quot;fontsFailedToLoad&quot;, fontsFailedToLoad);
118     encodeFontHashSet(encoder, &quot;fontsSuccessfullyLoaded&quot;, fontsSuccessfullyLoaded);
119     encodeHashCountedSet(encoder, &quot;topFrameRegistrableDomainsWhichAccessedWebAPIs&quot;, topFrameRegistrableDomainsWhichAccessedWebAPIs);
120     encodeCanvasActivityRecord(encoder, &quot;canvasActivityRecord&quot;, canvasActivityRecord);
121     encodeOptionSet(encoder, &quot;navigatorFunctionsAccessedBitMask&quot;, navigatorFunctionsAccessed);
122     encodeOptionSet(encoder, &quot;screenFunctionsAccessedBitMask&quot;, screenFunctionsAccessed);
123 #endif
124 }
125 
126 static void decodeHashCountedSet(KeyedDecoder&amp; decoder, const String&amp; label, HashCountedSet&lt;RegistrableDomain&gt;&amp; hashCountedSet)
127 {
128     Vector&lt;String&gt; ignore;
129     decoder.decodeObjects(label, ignore, [&amp;hashCountedSet](KeyedDecoder&amp; decoderInner, String&amp; domain) {
130         if (!decoderInner.decodeString(&quot;origin&quot;, domain))
131             return false;
132 
133         unsigned count;
134         if (!decoderInner.decodeUInt32(&quot;count&quot;, count))
135             return false;
136 
137         hashCountedSet.add(RegistrableDomain::uncheckedCreateFromRegistrableDomainString(domain), count);
138         return true;
139     });
140 }
141 
142 static void decodeHashSet(KeyedDecoder&amp; decoder, const String&amp; label, const String&amp; key, HashSet&lt;RegistrableDomain&gt;&amp; hashSet)
143 {
144     Vector&lt;String&gt; ignore;
145     decoder.decodeObjects(label, ignore, [&amp;hashSet, &amp;key](KeyedDecoder&amp; decoderInner, String&amp; domain) {
146         if (!decoderInner.decodeString(key, domain))
147             return false;
148 
149         hashSet.add(RegistrableDomain::uncheckedCreateFromRegistrableDomainString(domain));
150         return true;
151     });
152 }
153 
154 template&lt;typename T&gt;
155 static void decodeOptionSet(KeyedDecoder&amp; decoder, const String&amp; label, OptionSet&lt;T&gt;&amp; optionSet)
156 {
157     uint64_t optionSetBitMask = 0;
158     decoder.decodeUInt64(label, optionSetBitMask);
159     optionSet = OptionSet&lt;T&gt;::fromRaw(optionSetBitMask);
160 }
161 
162 #if ENABLE(WEB_API_STATISTICS)
163 static void decodeFontHashSet(KeyedDecoder&amp; decoder, const String&amp; label, HashSet&lt;String&gt;&amp; hashSet)
164 {
165     decodeHashSet(decoder, label, &quot;font&quot;, hashSet);
166 }
167 
168 static void decodeCanvasActivityRecord(KeyedDecoder&amp; decoder, const String&amp; label, CanvasActivityRecord&amp; canvasActivityRecord)
169 {
170     decoder.decodeObject(label, canvasActivityRecord, [] (KeyedDecoder&amp; decoderInner, CanvasActivityRecord&amp; canvasActivityRecord) {
171         if (!decoderInner.decodeBool(&quot;wasDataRead&quot;, canvasActivityRecord.wasDataRead))
172             return false;
173         Vector&lt;String&gt; ignore;
174         decoderInner.decodeObjects(&quot;textWritten&quot;, ignore, [&amp;canvasActivityRecord] (KeyedDecoder&amp; decoderInner2, String&amp; text) {
175             if (!decoderInner2.decodeString(&quot;text&quot;, text))
176                 return false;
177             canvasActivityRecord.textWritten.add(text);
178             return true;
179         });
180         return true;
181     });
182 }
183 #endif
184 
185 bool ResourceLoadStatistics::decode(KeyedDecoder&amp; decoder, unsigned modelVersion)
186 {
187     String registrableDomainAsString;
188     if (modelVersion &gt;= 15) {
189         if (!decoder.decodeString(&quot;PrevalentResourceDomain&quot;, registrableDomainAsString))
190             return false;
191     } else {
192         if (!decoder.decodeString(&quot;PrevalentResourceOrigin&quot;, registrableDomainAsString))
193             return false;
194     }
195     registrableDomain = RegistrableDomain::uncheckedCreateFromRegistrableDomainString(registrableDomainAsString);
196 
197     // User interaction
198     if (!decoder.decodeBool(&quot;hadUserInteraction&quot;, hadUserInteraction))
199         return false;
200 
201     // Storage access
202     if (modelVersion &gt;= 15)
203         decodeHashSet(decoder, &quot;storageAccessUnderTopFrameDomains&quot;, &quot;domain&quot;, storageAccessUnderTopFrameDomains);
204     else
205         decodeHashSet(decoder, &quot;storageAccessUnderTopFrameOrigins&quot;, &quot;origin&quot;, storageAccessUnderTopFrameDomains);
206 
207     // Top frame stats
208     if (modelVersion &gt;= 15) {
209         decodeHashSet(decoder, &quot;topFrameUniqueRedirectsTo&quot;, &quot;domain&quot;, topFrameUniqueRedirectsTo);
210         decodeHashSet(decoder, &quot;topFrameUniqueRedirectsFrom&quot;, &quot;domain&quot;, topFrameUniqueRedirectsFrom);
211     } else if (modelVersion &gt;= 11) {
212         HashCountedSet&lt;RegistrableDomain&gt; topFrameUniqueRedirectsToCounted;
213         decodeHashCountedSet(decoder, &quot;topFrameUniqueRedirectsTo&quot;, topFrameUniqueRedirectsToCounted);
214         for (auto&amp; domain : topFrameUniqueRedirectsToCounted.values())
215             topFrameUniqueRedirectsTo.add(domain);
216 
217         HashCountedSet&lt;RegistrableDomain&gt; topFrameUniqueRedirectsFromCounted;
218         decodeHashCountedSet(decoder, &quot;topFrameUniqueRedirectsFrom&quot;, topFrameUniqueRedirectsFromCounted);
219         for (auto&amp; domain : topFrameUniqueRedirectsFromCounted.values())
220             topFrameUniqueRedirectsFrom.add(domain);
221     }
222 
223     if (modelVersion &gt;= 16) {
224         decodeHashSet(decoder, &quot;topFrameLinkDecorationsFrom&quot;, &quot;domain&quot;, topFrameLinkDecorationsFrom);
225         if (!decoder.decodeBool(&quot;gotLinkDecorationFromPrevalentResource&quot;, gotLinkDecorationFromPrevalentResource))
226             return false;
227     }
228 
229     if (modelVersion &gt;= 17) {
230         HashCountedSet&lt;RegistrableDomain&gt; topFrameLoadedThirdPartyScriptsCounted;
231         decodeHashCountedSet(decoder, &quot;topFrameLoadedThirdPartyScripts&quot;, topFrameLoadedThirdPartyScriptsCounted);
232         for (auto&amp; domain : topFrameLoadedThirdPartyScriptsCounted.values())
233             topFrameLoadedThirdPartyScripts.add(domain);
234     }
235 
236     // Subframe stats
237     if (modelVersion &gt;= 15)
238         decodeHashSet(decoder, &quot;subframeUnderTopFrameDomains&quot;, &quot;domain&quot;, subframeUnderTopFrameDomains);
239     else if (modelVersion &gt;= 14) {
240         HashCountedSet&lt;RegistrableDomain&gt; subframeUnderTopFrameDomainsCounted;
241         decodeHashCountedSet(decoder, &quot;subframeUnderTopFrameOrigins&quot;, subframeUnderTopFrameDomainsCounted);
242         for (auto&amp; domain : subframeUnderTopFrameDomainsCounted.values())
243             subframeUnderTopFrameDomains.add(domain);
244     }
245 
246     // Subresource stats
247     if (modelVersion &gt;= 15) {
248         decodeHashSet(decoder, &quot;subresourceUnderTopFrameDomains&quot;, &quot;domain&quot;, subresourceUnderTopFrameDomains);
249         decodeHashSet(decoder, &quot;subresourceUniqueRedirectsTo&quot;, &quot;domain&quot;, subresourceUniqueRedirectsTo);
250         decodeHashSet(decoder, &quot;subresourceUniqueRedirectsFrom&quot;, &quot;domain&quot;, subresourceUniqueRedirectsFrom);
251     } else {
252         HashCountedSet&lt;RegistrableDomain&gt; subresourceUnderTopFrameDomainsCounted;
253         decodeHashCountedSet(decoder, &quot;subresourceUnderTopFrameOrigins&quot;, subresourceUnderTopFrameDomainsCounted);
254         for (auto&amp; domain : subresourceUnderTopFrameDomainsCounted.values())
255             subresourceUnderTopFrameDomains.add(domain);
256 
257         HashCountedSet&lt;RegistrableDomain&gt; subresourceUniqueRedirectsToCounted;
258         decodeHashCountedSet(decoder, &quot;subresourceUniqueRedirectsTo&quot;, subresourceUniqueRedirectsToCounted);
259         for (auto&amp; domain : subresourceUniqueRedirectsToCounted.values())
260             subresourceUniqueRedirectsTo.add(domain);
261         if (modelVersion &gt;= 11) {
262             HashCountedSet&lt;RegistrableDomain&gt; subresourceUniqueRedirectsFromCounted;
263             decodeHashCountedSet(decoder, &quot;subresourceUniqueRedirectsFrom&quot;, subresourceUniqueRedirectsFromCounted);
264             for (auto&amp; domain : subresourceUniqueRedirectsFromCounted.values())
265                 subresourceUniqueRedirectsFrom.add(domain);
266         }
267     }
268 
269 
270     // Prevalent Resource
271     if (!decoder.decodeBool(&quot;isPrevalentResource&quot;, isPrevalentResource))
272         return false;
273 
274     if (modelVersion &gt;= 12) {
275         if (!decoder.decodeBool(&quot;isVeryPrevalentResource&quot;, isVeryPrevalentResource))
276             return false;
277     }
278 
279     // Trigger re-classification based on model 14.
280     if (modelVersion &lt; 14) {
281         isPrevalentResource = false;
282         isVeryPrevalentResource = false;
283     }
284 
285     if (!decoder.decodeUInt32(&quot;dataRecordsRemoved&quot;, dataRecordsRemoved))
286         return false;
287 
288     double mostRecentUserInteractionTimeAsDouble;
289     if (!decoder.decodeDouble(&quot;mostRecentUserInteraction&quot;, mostRecentUserInteractionTimeAsDouble))
290         return false;
291     mostRecentUserInteractionTime = WallTime::fromRawSeconds(mostRecentUserInteractionTimeAsDouble);
292 
293     if (!decoder.decodeBool(&quot;grandfathered&quot;, grandfathered))
294         return false;
295 
296     double lastSeenTimeAsDouble;
297     if (!decoder.decodeDouble(&quot;lastSeen&quot;, lastSeenTimeAsDouble))
298         return false;
299     lastSeen = WallTime::fromRawSeconds(lastSeenTimeAsDouble);
300 
301     if (modelVersion &gt;= 11) {
302         if (!decoder.decodeUInt32(&quot;timesAccessedAsFirstPartyDueToUserInteraction&quot;, timesAccessedAsFirstPartyDueToUserInteraction))
303             timesAccessedAsFirstPartyDueToUserInteraction = 0;
304         if (!decoder.decodeUInt32(&quot;timesAccessedAsFirstPartyDueToStorageAccessAPI&quot;, timesAccessedAsFirstPartyDueToStorageAccessAPI))
305             timesAccessedAsFirstPartyDueToStorageAccessAPI = 0;
306     }
307 
308 #if ENABLE(WEB_API_STATISTICS)
309     if (modelVersion &gt;= 13) {
310         decodeFontHashSet(decoder, &quot;fontsFailedToLoad&quot;, fontsFailedToLoad);
311         decodeFontHashSet(decoder, &quot;fontsSuccessfullyLoaded&quot;, fontsSuccessfullyLoaded);
312         decodeHashCountedSet(decoder, &quot;topFrameRegistrableDomainsWhichAccessedWebAPIs&quot;, topFrameRegistrableDomainsWhichAccessedWebAPIs);
313         decodeCanvasActivityRecord(decoder, &quot;canvasActivityRecord&quot;, canvasActivityRecord);
314         decodeOptionSet(decoder, &quot;navigatorFunctionsAccessedBitMask&quot;, navigatorFunctionsAccessed);
315         decodeOptionSet(decoder, &quot;screenFunctionsAccessedBitMask&quot;, screenFunctionsAccessed);
316     }
317 #endif
318 
319     return true;
320 }
321 
322 static void appendBoolean(StringBuilder&amp; builder, const String&amp; label, bool flag)
323 {
324     builder.appendLiteral(&quot;    &quot;);
325     builder.append(label);
326     builder.appendLiteral(&quot;: &quot;);
327     builder.append(flag ? &quot;Yes&quot; : &quot;No&quot;);
328 }
329 
330 static void appendHashSet(StringBuilder&amp; builder, const String&amp; label, const HashSet&lt;RegistrableDomain&gt;&amp; hashSet)
331 {
332     if (hashSet.isEmpty())
333         return;
334 
335     builder.appendLiteral(&quot;    &quot;);
336     builder.append(label);
337     builder.appendLiteral(&quot;:\n&quot;);
338 
339     for (auto&amp; entry : hashSet) {
340         builder.appendLiteral(&quot;        &quot;);
341         builder.append(entry.string());
342         builder.append(&#39;\n&#39;);
343     }
344 }
345 
346 #if ENABLE(WEB_API_STATISTICS)
347 static ASCIILiteral navigatorAPIEnumToString(ResourceLoadStatistics::NavigatorAPI navigatorEnum)
348 {
349     switch (navigatorEnum) {
350     case ResourceLoadStatistics::NavigatorAPI::JavaEnabled:
351         return &quot;javaEnabled&quot;_s;
352     case ResourceLoadStatistics::NavigatorAPI::MimeTypes:
353         return &quot;mimeTypes&quot;_s;
354     case ResourceLoadStatistics::NavigatorAPI::CookieEnabled:
355         return &quot;cookieEnabled&quot;_s;
356     case ResourceLoadStatistics::NavigatorAPI::Plugins:
357         return &quot;plugins&quot;_s;
358     case ResourceLoadStatistics::NavigatorAPI::UserAgent:
359         return &quot;userAgent&quot;_s;
360     case ResourceLoadStatistics::NavigatorAPI::AppVersion:
361         return &quot;appVersion&quot;_s;
362     }
363     ASSERT_NOT_REACHED();
364     return &quot;Invalid navigator API&quot;_s;
365 }
366 
367 static ASCIILiteral screenAPIEnumToString(ResourceLoadStatistics::ScreenAPI screenEnum)
368 {
369     switch (screenEnum) {
370     case ResourceLoadStatistics::ScreenAPI::Height:
371         return &quot;height&quot;_s;
372     case ResourceLoadStatistics::ScreenAPI::Width:
373         return &quot;width&quot;_s;
374     case ResourceLoadStatistics::ScreenAPI::ColorDepth:
375         return &quot;colorDepth&quot;_s;
376     case ResourceLoadStatistics::ScreenAPI::PixelDepth:
377         return &quot;pixelDepth&quot;_s;
378     case ResourceLoadStatistics::ScreenAPI::AvailLeft:
379         return &quot;availLeft&quot;_s;
380     case ResourceLoadStatistics::ScreenAPI::AvailTop:
381         return &quot;availTop&quot;_s;
382     case ResourceLoadStatistics::ScreenAPI::AvailHeight:
383         return &quot;availHeight&quot;_s;
384     case ResourceLoadStatistics::ScreenAPI::AvailWidth:
385         return &quot;availWidth&quot;_s;
386     }
387     ASSERT_NOT_REACHED();
388     return &quot;Invalid screen API&quot;_s;
389 }
390 
391 static void appendNavigatorAPIOptionSet(StringBuilder&amp; builder, const OptionSet&lt;ResourceLoadStatistics::NavigatorAPI&gt;&amp; optionSet)
392 {
393     if (optionSet.isEmpty())
394         return;
395     builder.appendLiteral(&quot;    navigatorFunctionsAccessed:\n&quot;);
396     for (auto navigatorAPI : optionSet) {
397         builder.appendLiteral(&quot;        &quot;);
398         builder.append(navigatorAPIEnumToString(navigatorAPI).characters());
399         builder.append(&#39;\n&#39;);
400     }
401 }
402 
403 static void appendScreenAPIOptionSet(StringBuilder&amp; builder, const OptionSet&lt;ResourceLoadStatistics::ScreenAPI&gt;&amp; optionSet)
404 {
405     if (optionSet.isEmpty())
406         return;
407     builder.appendLiteral(&quot;    screenFunctionsAccessed:\n&quot;);
408     for (auto screenAPI : optionSet) {
409         builder.appendLiteral(&quot;        &quot;);
410         builder.append(screenAPIEnumToString(screenAPI).characters());
411         builder.append(&#39;\n&#39;);
412     }
413 }
414 #endif
415 
416 static bool hasHadRecentUserInteraction(WTF::Seconds interactionTimeSeconds)
417 {
418     return interactionTimeSeconds &gt; Seconds(0) &amp;&amp; WallTime::now().secondsSinceEpoch() - interactionTimeSeconds &lt; 24_h;
419 }
420 
421 String ResourceLoadStatistics::toString() const
422 {
423     StringBuilder builder;
424     builder.appendLiteral(&quot;Registrable domain: &quot;);
425     builder.append(registrableDomain.string());
426     builder.append(&#39;\n&#39;);
427 
428     // User interaction
429     appendBoolean(builder, &quot;hadUserInteraction&quot;, hadUserInteraction);
430     builder.append(&#39;\n&#39;);
431     builder.appendLiteral(&quot;    mostRecentUserInteraction: &quot;);
432     if (hasHadRecentUserInteraction(mostRecentUserInteractionTime.secondsSinceEpoch()))
433         builder.appendLiteral(&quot;within 24 hours&quot;);
434     else
435         builder.appendLiteral(&quot;-1&quot;);
436     builder.append(&#39;\n&#39;);
437     appendBoolean(builder, &quot;grandfathered&quot;, grandfathered);
438     builder.append(&#39;\n&#39;);
439 
440     // Storage access
441     appendHashSet(builder, &quot;storageAccessUnderTopFrameDomains&quot;, storageAccessUnderTopFrameDomains);
442 
443     // Top frame stats
444     appendHashSet(builder, &quot;topFrameUniqueRedirectsTo&quot;, topFrameUniqueRedirectsTo);
445     appendHashSet(builder, &quot;topFrameUniqueRedirectsFrom&quot;, topFrameUniqueRedirectsFrom);
446     appendHashSet(builder, &quot;topFrameLinkDecorationsFrom&quot;, topFrameLinkDecorationsFrom);
447     appendBoolean(builder, &quot;gotLinkDecorationFromPrevalentResource&quot;, gotLinkDecorationFromPrevalentResource);
448     builder.append(&#39;\n&#39;);
449     appendHashSet(builder, &quot;topFrameLoadedThirdPartyScripts&quot;, topFrameLoadedThirdPartyScripts);
450 
451     // Subframe stats
452     appendHashSet(builder, &quot;subframeUnderTopFrameDomains&quot;, subframeUnderTopFrameDomains);
453 
454     // Subresource stats
455     appendHashSet(builder, &quot;subresourceUnderTopFrameDomains&quot;, subresourceUnderTopFrameDomains);
456     appendHashSet(builder, &quot;subresourceUniqueRedirectsTo&quot;, subresourceUniqueRedirectsTo);
457     appendHashSet(builder, &quot;subresourceUniqueRedirectsFrom&quot;, subresourceUniqueRedirectsFrom);
458 
459     // Prevalent Resource
460     appendBoolean(builder, &quot;isPrevalentResource&quot;, isPrevalentResource);
461     builder.append(&#39;\n&#39;);
462     appendBoolean(builder, &quot;isVeryPrevalentResource&quot;, isVeryPrevalentResource);
463     builder.append(&#39;\n&#39;);
464     builder.appendLiteral(&quot;    dataRecordsRemoved: &quot;);
465     builder.appendNumber(dataRecordsRemoved);
466     builder.append(&#39;\n&#39;);
467 
468 #if ENABLE(WEB_API_STATISTICS)
469     appendHashSet(builder, &quot;fontsFailedToLoad&quot;, fontsFailedToLoad);
470     appendHashSet(builder, &quot;fontsSuccessfullyLoaded&quot;, fontsSuccessfullyLoaded);
471     appendHashCountedSet(builder, &quot;topFrameRegistrableDomainsWhichAccessedWebAPIs&quot;, topFrameRegistrableDomainsWhichAccessedWebAPIs);
472     appendNavigatorAPIOptionSet(builder, navigatorFunctionsAccessed);
473     appendScreenAPIOptionSet(builder, screenFunctionsAccessed);
474     appendHashSet(builder, &quot;canvasTextWritten&quot;, canvasActivityRecord.textWritten);
475     appendBoolean(builder, &quot;canvasReadData&quot;, canvasActivityRecord.wasDataRead);
476     builder.append(&#39;\n&#39;);
477     builder.append(&#39;\n&#39;);
478 #endif
479 
480     return builder.toString();
481 }
482 
483 template &lt;typename T&gt;
484 static void mergeHashCountedSet(HashCountedSet&lt;T&gt;&amp; to, const HashCountedSet&lt;T&gt;&amp; from)
485 {
486     for (auto&amp; entry : from)
487         to.add(entry.key, entry.value);
488 }
489 
490 template &lt;typename T&gt;
491 static void mergeHashSet(HashSet&lt;T&gt;&amp; to, const HashSet&lt;T&gt;&amp; from)
492 {
493     for (auto&amp; entry : from)
494         to.add(entry);
495 }
496 
497 void ResourceLoadStatistics::merge(const ResourceLoadStatistics&amp; other)
498 {
499     ASSERT(other.registrableDomain == registrableDomain);
500 
501     if (lastSeen &lt; other.lastSeen)
502         lastSeen = other.lastSeen;
503 
504     if (!other.hadUserInteraction) {
505         // If user interaction has been reset do so here too.
506         // Else, do nothing.
507         if (!other.mostRecentUserInteractionTime) {
508             hadUserInteraction = false;
509             mostRecentUserInteractionTime = { };
510         }
511     } else {
512         hadUserInteraction = true;
513         if (mostRecentUserInteractionTime &lt; other.mostRecentUserInteractionTime)
514             mostRecentUserInteractionTime = other.mostRecentUserInteractionTime;
515     }
516     grandfathered |= other.grandfathered;
517 
518     // Storage access
519     mergeHashSet(storageAccessUnderTopFrameDomains, other.storageAccessUnderTopFrameDomains);
520 
521     // Top frame stats
522     mergeHashSet(topFrameUniqueRedirectsTo, other.topFrameUniqueRedirectsTo);
523     mergeHashSet(topFrameUniqueRedirectsFrom, other.topFrameUniqueRedirectsFrom);
524     mergeHashSet(topFrameLinkDecorationsFrom, other.topFrameLinkDecorationsFrom);
525     gotLinkDecorationFromPrevalentResource |= other.gotLinkDecorationFromPrevalentResource;
526     mergeHashSet(topFrameLoadedThirdPartyScripts, other.topFrameLoadedThirdPartyScripts);
527 
528     // Subframe stats
529     mergeHashSet(subframeUnderTopFrameDomains, other.subframeUnderTopFrameDomains);
530 
531     // Subresource stats
532     mergeHashSet(subresourceUnderTopFrameDomains, other.subresourceUnderTopFrameDomains);
533     mergeHashSet(subresourceUniqueRedirectsTo, other.subresourceUniqueRedirectsTo);
534     mergeHashSet(subresourceUniqueRedirectsFrom, other.subresourceUniqueRedirectsFrom);
535 
536     // Prevalent resource stats
537     isPrevalentResource |= other.isPrevalentResource;
538     isVeryPrevalentResource |= other.isVeryPrevalentResource;
539     dataRecordsRemoved = std::max(dataRecordsRemoved, other.dataRecordsRemoved);
540 
541 #if ENABLE(WEB_API_STATISTICS)
542     mergeHashSet(fontsFailedToLoad, other.fontsFailedToLoad);
543     mergeHashSet(fontsSuccessfullyLoaded, other.fontsSuccessfullyLoaded);
544     mergeHashSet(topFrameRegistrableDomainsWhichAccessedWebAPIs, other.topFrameRegistrableDomainsWhichAccessedWebAPIs);
545     canvasActivityRecord.mergeWith(other.canvasActivityRecord);
546     navigatorFunctionsAccessed.add(other.navigatorFunctionsAccessed);
547     screenFunctionsAccessed.add(other.screenFunctionsAccessed);
548 #endif
549 }
550 
551 WallTime ResourceLoadStatistics::reduceTimeResolution(WallTime time)
552 {
553     return WallTime::fromRawSeconds(std::floor(time.secondsSinceEpoch() / timestampResolution) * timestampResolution.seconds());
554 }
555 
556 }
    </pre>
  </body>
</html>