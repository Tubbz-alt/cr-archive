<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.web/src/main/native/Source/WebCore/workers/service/server/SWServerRegistration.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="SWServerJobQueue.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="SWServerRegistration.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/workers/service/server/SWServerRegistration.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 26,11 ***</span>
<span class="line-new-header">--- 26,13 ---</span>
  #include &quot;config.h&quot;
  #include &quot;SWServerRegistration.h&quot;
  
  #if ENABLE(SERVICE_WORKER)
  
<span class="line-added">+ #include &quot;Logging.h&quot;</span>
  #include &quot;SWServer.h&quot;
<span class="line-added">+ #include &quot;SWServerToContextConnection.h&quot;</span>
  #include &quot;SWServerWorker.h&quot;
  #include &quot;ServiceWorkerTypes.h&quot;
  #include &quot;ServiceWorkerUpdateViaCache.h&quot;
  
  namespace WebCore {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 46,10 ***</span>
<span class="line-new-header">--- 48,11 ---</span>
      , m_updateViaCache(updateViaCache)
      , m_scopeURL(scopeURL)
      , m_scriptURL(scriptURL)
      , m_server(server)
      , m_creationTime(MonotonicTime::now())
<span class="line-added">+     , m_softUpdateTimer { *this, &amp;SWServerRegistration::softUpdate }</span>
  {
      m_scopeURL.removeFragmentIdentifier();
  }
  
  SWServerRegistration::~SWServerRegistration()
</pre>
<hr />
<pre>
<span class="line-old-header">*** 257,11 ***</span>
          updateWorkerState(*waitingWorker, ServiceWorkerState::Redundant);
      if (activeWorker)
          updateWorkerState(*activeWorker, ServiceWorkerState::Redundant);
  
      // Remove scope to registration map[scopeString].
<span class="line-modified">!     m_server.removeRegistration(key());</span>
  }
  
  // https://w3c.github.io/ServiceWorker/#try-activate-algorithm
  void SWServerRegistration::tryActivate()
  {
<span class="line-new-header">--- 260,11 ---</span>
          updateWorkerState(*waitingWorker, ServiceWorkerState::Redundant);
      if (activeWorker)
          updateWorkerState(*activeWorker, ServiceWorkerState::Redundant);
  
      // Remove scope to registration map[scopeString].
<span class="line-modified">!     m_server.removeRegistration(identifier());</span>
  }
  
  // https://w3c.github.io/ServiceWorker/#try-activate-algorithm
  void SWServerRegistration::tryActivate()
  {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 331,15 ***</span>
  // https://w3c.github.io/ServiceWorker/#on-client-unload-algorithm
  void SWServerRegistration::handleClientUnload()
  {
      if (hasClientsUsingRegistration())
          return;
<span class="line-modified">!     if (isUninstalling() &amp;&amp; tryClear())</span>
          return;
      tryActivate();
  }
  
  void SWServerRegistration::controlClient(ServiceWorkerClientIdentifier identifier)
  {
      ASSERT(activeWorker());
  
      addClientUsingRegistration(identifier);
<span class="line-new-header">--- 334,20 ---</span>
  // https://w3c.github.io/ServiceWorker/#on-client-unload-algorithm
  void SWServerRegistration::handleClientUnload()
  {
      if (hasClientsUsingRegistration())
          return;
<span class="line-modified">!     if (isUnregistered() &amp;&amp; tryClear())</span>
          return;
      tryActivate();
  }
  
<span class="line-added">+ bool SWServerRegistration::isUnregistered() const</span>
<span class="line-added">+ {</span>
<span class="line-added">+     return m_server.getRegistration(key()) != this;</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
  void SWServerRegistration::controlClient(ServiceWorkerClientIdentifier identifier)
  {
      ASSERT(activeWorker());
  
      addClientUsingRegistration(identifier);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 347,21 ***</span>
      HashSet&lt;DocumentIdentifier&gt; identifiers;
      identifiers.add(identifier.contextIdentifier);
      m_server.connection(identifier.serverConnectionIdentifier)-&gt;notifyClientsOfControllerChange(identifiers, activeWorker()-&gt;data());
  }
  
<span class="line-modified">! void SWServerRegistration::setIsUninstalling(bool value)</span>
  {
<span class="line-modified">!     if (m_uninstalling == value)</span>
<span class="line-modified">!         return;</span>
  
<span class="line-modified">!     m_uninstalling = value;</span>
  
<span class="line-modified">!     if (!m_uninstalling &amp;&amp; activeWorker()) {</span>
<span class="line-modified">!         // Registration with active worker has been resurrected, we need to check if any ready promises were waiting for this.</span>
<span class="line-modified">!         m_server.resolveRegistrationReadyRequests(*this);</span>
<span class="line-modified">!     }</span>
  }
  
  } // namespace WebCore
  
  #endif // ENABLE(SERVICE_WORKER)
<span class="line-new-header">--- 355,32 ---</span>
      HashSet&lt;DocumentIdentifier&gt; identifiers;
      identifiers.add(identifier.contextIdentifier);
      m_server.connection(identifier.serverConnectionIdentifier)-&gt;notifyClientsOfControllerChange(identifiers, activeWorker()-&gt;data());
  }
  
<span class="line-modified">! bool SWServerRegistration::shouldSoftUpdate(const FetchOptions&amp; options) const</span>
  {
<span class="line-modified">!     if (options.mode == FetchOptions::Mode::Navigate)</span>
<span class="line-modified">!         return true;</span>
  
<span class="line-modified">!     return WebCore::isNonSubresourceRequest(options.destination) &amp;&amp; isStale();</span>
<span class="line-added">+ }</span>
  
<span class="line-modified">! void SWServerRegistration::softUpdate()</span>
<span class="line-modified">! {</span>
<span class="line-modified">!     m_server.softUpdate(*this);</span>
<span class="line-modified">! }</span>
<span class="line-added">+ </span>
<span class="line-added">+ void SWServerRegistration::scheduleSoftUpdate()</span>
<span class="line-added">+ {</span>
<span class="line-added">+     // To avoid scheduling many updates during a single page load, we do soft updates on a 1 second delay and keep delaying</span>
<span class="line-added">+     // as long as soft update requests keep coming. This seems to match Chrome&#39;s behavior.</span>
<span class="line-added">+     if (m_softUpdateTimer.isActive())</span>
<span class="line-added">+         return;</span>
<span class="line-added">+ </span>
<span class="line-added">+     RELEASE_LOG(ServiceWorker, &quot;SWServerRegistration::softUpdateIfNeeded&quot;);</span>
<span class="line-added">+     m_softUpdateTimer.startOneShot(softUpdateDelay);</span>
  }
  
  } // namespace WebCore
  
  #endif // ENABLE(SERVICE_WORKER)
</pre>
<center><a href="SWServerJobQueue.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="SWServerRegistration.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>