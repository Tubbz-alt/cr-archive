<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.graphics/src/main/java/com/sun/prism/impl/shape/OpenPiscesRasterizer.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="NativePiscesRasterizer.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../j2d/print/J2DPrinter.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.graphics/src/main/java/com/sun/prism/impl/shape/OpenPiscesRasterizer.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2010, 2014, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package com.sun.prism.impl.shape;
 27 
 28 import com.sun.javafx.geom.RectBounds;
 29 import com.sun.javafx.geom.Path2D;
 30 import com.sun.javafx.geom.Rectangle;
 31 import com.sun.javafx.geom.Shape;
 32 import com.sun.javafx.geom.transform.BaseTransform;

 33 import com.sun.openpisces.AlphaConsumer;
 34 import com.sun.openpisces.Renderer;
 35 import com.sun.prism.BasicStroke;
 36 import com.sun.prism.impl.PrismSettings;
 37 import java.nio.ByteBuffer;
 38 
 39 public class OpenPiscesRasterizer implements ShapeRasterizer {
 40     private static MaskData emptyData = MaskData.create(new byte[1], 0, 0, 1, 1);
 41 
 42     private static Consumer savedConsumer;
 43 
 44     @Override
 45     public MaskData getMaskData(Shape shape,
 46                                 BasicStroke stroke,
 47                                 RectBounds xformBounds,
 48                                 BaseTransform xform,
 49                                 boolean close, boolean antialiasedShape)
 50     {
 51         if (stroke != null &amp;&amp; stroke.getType() != BasicStroke.TYPE_CENTERED) {
 52             // RT-27427
</pre>
<hr />
<pre>
 59             stroke = null;
 60         }
 61         if (xformBounds == null) {
 62             if (stroke != null) {
 63                 // Note that all places that pass null for xformbounds also
 64                 // pass null for stroke so that the following is not typically
 65                 // executed, but just here as a safety net.
 66                 shape = stroke.createStrokedShape(shape);
 67                 stroke = null;
 68             }
 69 
 70             xformBounds = new RectBounds();
 71             //TODO: Need to verify that this is a safe cast ... (RT-27427)
 72             xformBounds = (RectBounds) xform.transform(shape.getBounds(), xformBounds);
 73         }
 74         Rectangle rclip = new Rectangle(xformBounds);
 75         if (rclip.isEmpty()) {
 76             return emptyData;
 77         }
 78         Renderer renderer = null;
<span class="line-modified"> 79         if (shape instanceof Path2D) {</span>
<span class="line-modified"> 80             renderer = OpenPiscesPrismUtils.setupRenderer((Path2D) shape, stroke, xform, rclip,</span>
<span class="line-modified"> 81                     antialiasedShape);</span>
<span class="line-modified"> 82         }</span>
<span class="line-modified"> 83         if (renderer == null) {</span>
<span class="line-modified"> 84             renderer = OpenPiscesPrismUtils.setupRenderer(shape, stroke, xform, rclip,</span>
<span class="line-modified"> 85                     antialiasedShape);</span>
<span class="line-modified"> 86         }</span>
<span class="line-modified"> 87         int outpix_xmin = renderer.getOutpixMinX();</span>
<span class="line-modified"> 88         int outpix_ymin = renderer.getOutpixMinY();</span>
<span class="line-modified"> 89         int outpix_xmax = renderer.getOutpixMaxX();</span>
<span class="line-modified"> 90         int outpix_ymax = renderer.getOutpixMaxY();</span>
<span class="line-modified"> 91         int w = outpix_xmax - outpix_xmin;</span>
<span class="line-modified"> 92         int h = outpix_ymax - outpix_ymin;</span>
<span class="line-modified"> 93         if (w &lt;= 0 || h &lt;= 0) {</span>
<span class="line-modified"> 94             return emptyData;</span>
<span class="line-modified"> 95         }</span>

 96 
<span class="line-modified"> 97         Consumer consumer = savedConsumer;</span>
<span class="line-modified"> 98         if (consumer == null || w * h &gt; consumer.getAlphaLength()) {</span>
<span class="line-modified"> 99             int csize = (w * h + 0xfff) &amp; (~0xfff);</span>
<span class="line-modified">100             savedConsumer = consumer = new Consumer(csize);</span>
<span class="line-modified">101             if (PrismSettings.verbose) {</span>
102                 System.out.println(&quot;new alphas&quot;);

103             }










104         }
<span class="line-removed">105         consumer.setBoundsNoClone(outpix_xmin, outpix_ymin, w, h);</span>
<span class="line-removed">106         renderer.produceAlphas(consumer);</span>
<span class="line-removed">107         return consumer.getMaskData();</span>
108     }
109 
110     private static class Consumer implements AlphaConsumer {
111         static byte savedAlphaMap[];
112         int x, y, width, height;
113         byte alphas[];
114         byte alphaMap[];
115         ByteBuffer alphabuffer;
116         MaskData maskdata = new MaskData();
117 
118         public Consumer(int alphalen) {
119             this.alphas = new byte[alphalen];
120             alphabuffer = ByteBuffer.wrap(alphas);
121         }
122 
123         public void setBoundsNoClone(int x, int y, int w, int h) {
124             this.x = x;
125             this.y = y;
126             this.width = w;
127             this.height = h;
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2010, 2020, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package com.sun.prism.impl.shape;
 27 
 28 import com.sun.javafx.geom.RectBounds;
 29 import com.sun.javafx.geom.Path2D;
 30 import com.sun.javafx.geom.Rectangle;
 31 import com.sun.javafx.geom.Shape;
 32 import com.sun.javafx.geom.transform.BaseTransform;
<span class="line-added"> 33 import com.sun.javafx.util.Logging;</span>
 34 import com.sun.openpisces.AlphaConsumer;
 35 import com.sun.openpisces.Renderer;
 36 import com.sun.prism.BasicStroke;
 37 import com.sun.prism.impl.PrismSettings;
 38 import java.nio.ByteBuffer;
 39 
 40 public class OpenPiscesRasterizer implements ShapeRasterizer {
 41     private static MaskData emptyData = MaskData.create(new byte[1], 0, 0, 1, 1);
 42 
 43     private static Consumer savedConsumer;
 44 
 45     @Override
 46     public MaskData getMaskData(Shape shape,
 47                                 BasicStroke stroke,
 48                                 RectBounds xformBounds,
 49                                 BaseTransform xform,
 50                                 boolean close, boolean antialiasedShape)
 51     {
 52         if (stroke != null &amp;&amp; stroke.getType() != BasicStroke.TYPE_CENTERED) {
 53             // RT-27427
</pre>
<hr />
<pre>
 60             stroke = null;
 61         }
 62         if (xformBounds == null) {
 63             if (stroke != null) {
 64                 // Note that all places that pass null for xformbounds also
 65                 // pass null for stroke so that the following is not typically
 66                 // executed, but just here as a safety net.
 67                 shape = stroke.createStrokedShape(shape);
 68                 stroke = null;
 69             }
 70 
 71             xformBounds = new RectBounds();
 72             //TODO: Need to verify that this is a safe cast ... (RT-27427)
 73             xformBounds = (RectBounds) xform.transform(shape.getBounds(), xformBounds);
 74         }
 75         Rectangle rclip = new Rectangle(xformBounds);
 76         if (rclip.isEmpty()) {
 77             return emptyData;
 78         }
 79         Renderer renderer = null;
<span class="line-modified"> 80         try {</span>
<span class="line-modified"> 81             if (shape instanceof Path2D) {</span>
<span class="line-modified"> 82                 renderer = OpenPiscesPrismUtils.setupRenderer((Path2D) shape,</span>
<span class="line-modified"> 83                         stroke, xform, rclip, antialiasedShape);</span>
<span class="line-modified"> 84             }</span>
<span class="line-modified"> 85             if (renderer == null) {</span>
<span class="line-modified"> 86                 renderer = OpenPiscesPrismUtils.setupRenderer(shape,</span>
<span class="line-modified"> 87                         stroke, xform, rclip, antialiasedShape);</span>
<span class="line-modified"> 88             }</span>
<span class="line-modified"> 89             int outpix_xmin = renderer.getOutpixMinX();</span>
<span class="line-modified"> 90             int outpix_ymin = renderer.getOutpixMinY();</span>
<span class="line-modified"> 91             int outpix_xmax = renderer.getOutpixMaxX();</span>
<span class="line-modified"> 92             int outpix_ymax = renderer.getOutpixMaxY();</span>
<span class="line-modified"> 93             int w = outpix_xmax - outpix_xmin;</span>
<span class="line-modified"> 94             int h = outpix_ymax - outpix_ymin;</span>
<span class="line-modified"> 95             if (w &lt;= 0 || h &lt;= 0) {</span>
<span class="line-modified"> 96                 return emptyData;</span>
<span class="line-added"> 97             }</span>
 98 
<span class="line-modified"> 99             Consumer consumer = savedConsumer;</span>
<span class="line-modified">100             if (consumer == null || w * h &gt; consumer.getAlphaLength()) {</span>
<span class="line-modified">101                 int csize = (w * h + 0xfff) &amp; (~0xfff);</span>
<span class="line-modified">102                 savedConsumer = consumer = new Consumer(csize);</span>
<span class="line-modified">103                 if (PrismSettings.verbose) {</span>
104                 System.out.println(&quot;new alphas&quot;);
<span class="line-added">105                 }</span>
106             }
<span class="line-added">107             consumer.setBoundsNoClone(outpix_xmin, outpix_ymin, w, h);</span>
<span class="line-added">108             renderer.produceAlphas(consumer);</span>
<span class="line-added">109             return consumer.getMaskData();</span>
<span class="line-added">110         } catch (Throwable ex) {</span>
<span class="line-added">111             if (PrismSettings.verbose) {</span>
<span class="line-added">112                 ex.printStackTrace();</span>
<span class="line-added">113             }</span>
<span class="line-added">114             Logging.getJavaFXLogger().warning(&quot;Cannot rasterize Shape: &quot;</span>
<span class="line-added">115                     + ex.toString());</span>
<span class="line-added">116             return emptyData;</span>
117         }



118     }
119 
120     private static class Consumer implements AlphaConsumer {
121         static byte savedAlphaMap[];
122         int x, y, width, height;
123         byte alphas[];
124         byte alphaMap[];
125         ByteBuffer alphabuffer;
126         MaskData maskdata = new MaskData();
127 
128         public Consumer(int alphalen) {
129             this.alphas = new byte[alphalen];
130             alphabuffer = ByteBuffer.wrap(alphas);
131         }
132 
133         public void setBoundsNoClone(int x, int y, int w, int h) {
134             this.x = x;
135             this.y = y;
136             this.width = w;
137             this.height = h;
</pre>
</td>
</tr>
</table>
<center><a href="NativePiscesRasterizer.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../j2d/print/J2DPrinter.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>