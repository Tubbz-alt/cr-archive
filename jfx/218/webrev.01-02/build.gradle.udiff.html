<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff build.gradle</title>
    <link rel="stylesheet" href="style.css" />
  </head>
<body>
<center>&lt; prev <a href="index.html" target="_top">index</a> <a href="build.properties.udiff.html" target="_top">next &gt;</a></center>    <h2>build.gradle</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1247,21 +1247,29 @@</span>
      logger.warn(&quot;*****************************************************************&quot;);
  }
  
  // Look for stub runtime in bundled sdk, standalone sdk, or boot JDK
  
<span class="udiff-line-added">+ // Allows automatic provisioning of webkit+media shared libraries</span>
<span class="udiff-line-added">+ // from official OpenJFX releases, downloaded from MavenCentral</span>
<span class="udiff-line-added">+ defineProperty(&quot;STUB_RUNTIME_OPENJFX&quot;, &quot;&quot;)</span>
<span class="udiff-line-added">+ ext.IS_STUB_RUNTIME_OPENJFX = !STUB_RUNTIME_OPENJFX.isBlank()</span>
<span class="udiff-line-added">+ </span>
  def String cachedBundledRuntime = cygpath(&quot;$projectDir&quot;) + &quot;/../caches/modular-sdk&quot;
  def String cachedStandaloneRuntime = cygpath(&quot;$projectDir&quot;) + &quot;/../caches/sdk&quot;
  def String jdkStubRuntime = cygpath(&quot;$JDK_HOME&quot;)
<span class="udiff-line-added">+ def String openjfxStubRuntime = cygpath(&quot;$projectDir&quot;) + &quot;/buildSrc/build/openjfxStub&quot;</span>
  
  def defaultStubRuntime = &quot;&quot;
  if (file(cachedBundledRuntime).exists()) {
      defaultStubRuntime = cachedBundledRuntime
  } else if (file(cachedStandaloneRuntime).exists()) {
      defaultStubRuntime = cachedStandaloneRuntime
  } else if (BUILD_CLOSED) {
      defaultStubRuntime = cachedBundledRuntime
<span class="udiff-line-added">+ } else if (IS_STUB_RUNTIME_OPENJFX) {</span>
<span class="udiff-line-added">+     defaultStubRuntime = openjfxStubRuntime</span>
  } else {
      defaultStubRuntime = jdkStubRuntime
  }
  
  defineProperty(&quot;STUB_RUNTIME&quot;, defaultStubRuntime)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2564,12 +2572,22 @@</span>
      project.ext.moduleRuntime = true
      project.ext.moduleName = &quot;javafx.swing&quot;
  
      sourceSets {
          main
<span class="udiff-line-modified-removed">-         //shims // no test shims needed</span>
<span class="udiff-line-modified-removed">-         test</span>
<span class="udiff-line-modified-added">+         shims {</span>
<span class="udiff-line-modified-added">+             java {</span>
<span class="udiff-line-added">+                 compileClasspath += sourceSets.main.output</span>
<span class="udiff-line-added">+                 runtimeClasspath += sourceSets.main.output</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         test {</span>
<span class="udiff-line-added">+             java {</span>
<span class="udiff-line-added">+                 compileClasspath += sourceSets.shims.output</span>
<span class="udiff-line-added">+                 runtimeClasspath += sourceSets.shims.output</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
      }
  
      project.ext.moduleSourcePath = defaultModuleSourcePath
      project.ext.moduleSourcePathShim = defaultModuleSourcePathShim
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2860,19 +2878,11 @@</span>
                          args(&quot;OUTPUT_DIR=${nativeOutputDir}&quot;, &quot;BUILD_TYPE=${buildType}&quot;, &quot;BASE_NAME=fxplugins&quot;,
                               IS_64 ? &quot;ARCH=x64&quot; : &quot;ARCH=x32&quot;,
                               &quot;CC=${mediaProperties.compiler}&quot;, &quot;AR=${mediaProperties.ar}&quot;, &quot;LINKER=${mediaProperties.linker}&quot;)
  
                          if (t.name == &quot;win&quot;) {
<span class="udiff-line-modified-removed">-                             Map winEnv = new HashMap(WINDOWS_NATIVE_COMPILE_ENVIRONMENT)</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-                             String sdkDir = System.getenv(&quot;BASECLASSES_SDK_DIR&quot;);</span>
<span class="udiff-line-removed">-                             if (sdkDir == null) {</span>
<span class="udiff-line-removed">-                                 sdkDir = &quot;C:/Program Files/Microsoft SDKs/Windows/v7.1&quot; // Default value</span>
<span class="udiff-line-removed">-                                 winEnv[&quot;BASECLASSES_SDK_DIR&quot;] = sdkDir</span>
<span class="udiff-line-removed">-                             }</span>
<span class="udiff-line-removed">-                             environment(winEnv)</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-modified-added">+                             environment(WINDOWS_NATIVE_COMPILE_ENVIRONMENT)</span>
                              args(&quot;RESOURCE=${nativeOutputDir}/${buildType}/${WIN.media.fxpluginsRcFile}&quot;)
                          }
                      }
                  }
              }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3379,20 +3389,25 @@</span>
  
      compileJava.dependsOn(copyWrappers);
  
      test {
          doFirst {
<span class="udiff-line-modified-removed">-             if (!IS_COMPILE_WEBKIT) {</span>
<span class="udiff-line-modified-removed">-                 println &quot;*****************************************************&quot;</span>
<span class="udiff-line-modified-added">+             if (IS_STUB_RUNTIME_OPENJFX) {</span>
<span class="udiff-line-modified-added">+                 println &quot;********************************************************&quot;</span>
<span class="udiff-line-added">+                 println &quot;WARNING: running web tests with officially built webkit.&quot;</span>
<span class="udiff-line-added">+                 println &quot;The webkit native library may not be compatible with the&quot;</span>
<span class="udiff-line-added">+                 println &quot;source tree you are using.&quot;</span>
<span class="udiff-line-added">+                 println &quot;If tests fail, try compiling webkit instead.&quot;</span>
<span class="udiff-line-added">+                 println &quot;See WEBKIT-MEDIA-STUBS.md&quot;</span>
<span class="udiff-line-added">+                 println &quot;********************************************************&quot;</span>
<span class="udiff-line-added">+             } else if (!IS_COMPILE_WEBKIT) {</span>
<span class="udiff-line-added">+                 println &quot;******************************************************&quot;</span>
                  println &quot;WARNING: running web tests without building webkit.&quot;
                  println &quot;The webkit native library will be copied from the JDK,&quot;
                  println &quot;which might lead to failures in some web tests.&quot;
<span class="udiff-line-modified-removed">-                 println &quot;To avoid these failures, you should either build&quot;</span>
<span class="udiff-line-modified-removed">-                 println &quot;webkit locally, copy the native webkit library from a&quot;</span>
<span class="udiff-line-removed">-                 println &quot;recent build, or skip execution of web test cases with&quot;</span>
<span class="udiff-line-removed">-                 println &quot;&#39;-x :web:test&#39;&quot;</span>
<span class="udiff-line-removed">-                 println &quot;*****************************************************&quot;</span>
<span class="udiff-line-modified-added">+                 println &quot;See WEBKIT-MEDIA-STUBS.md&quot;</span>
<span class="udiff-line-modified-added">+                 println &quot;******************************************************&quot;</span>
              }
          }
          // Run web tests in headless mode
          systemProperty &#39;glass.platform&#39;, &#39;Monocle&#39;
          systemProperty &#39;monocle.platform&#39;, &#39;Headless&#39;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3428,10 +3443,13 @@</span>
                  }
  
                  exec {
                      workingDir(&quot;$webkitOutputDir&quot;)
                      def cmakeArgs = &quot;-DENABLE_TOOLS=1&quot;
<span class="udiff-line-added">+                     if (IS_STATIC_BUILD) {</span>
<span class="udiff-line-added">+                         cmakeArgs = &quot; $cmakeArgs -DSTATIC_BUILD=1 -DUSE_THIN_ARCHIVES=OFF&quot;;</span>
<span class="udiff-line-added">+                     }</span>
                      cmakeArgs = &quot; $cmakeArgs -DCMAKE_C_COMPILER=&#39;${webkitProperties.compiler}&#39;&quot;
                      if (t.name == &quot;win&quot;) {
                          // To enable ninja build on Windows
                          environment(WINDOWS_NATIVE_COMPILE_ENVIRONMENT)
                      } else if (t.name == &quot;mac&quot;) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3444,10 +3462,13 @@</span>
                              cmakeArgs = &quot;$cmakeArgs -DCMAKE_SYSTEM_PROCESSOR=i586&quot;
                          }
                          // TODO: Use cflags and ldflags from all platforms
                          def cFlags = webkitProperties.ccFlags?.join(&#39; &#39;) ?: &#39;&#39;
                          def lFlags = webkitProperties.linkFlags?.join(&#39; &#39;) ?: &#39;&#39;
<span class="udiff-line-added">+                         if (IS_STATIC_BUILD) {</span>
<span class="udiff-line-added">+                             cFlags = &quot; $cFlags -DSTATIC_BUILD=1&quot;;</span>
<span class="udiff-line-added">+                         }</span>
                          // -shared flag should be omitted while creating executable.
                          def exeFlags = webkitProperties.linkFlags?.join(&#39; &#39;)?.replace(&#39;-shared&#39;, &#39;&#39;) ?: &#39;&#39;
                          cmakeArgs = &quot;$cmakeArgs -DCMAKE_C_FLAGS=&#39;${cFlags}&#39; -DCMAKE_CXX_FLAGS=&#39;${cFlags}&#39;&quot;
                          cmakeArgs = &quot;$cmakeArgs -DCMAKE_SHARED_LINKER_FLAGS=&#39;${lFlags}&#39; -DCMAKE_EXE_LINKER_FLAGS=&#39;${exeFlags}&#39;&quot;
                      } else if (t.name.startsWith(&quot;arm&quot;)) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3570,10 +3591,11 @@</span>
          testapp3
          testapp4
          testapp5
          testapp6
          testscriptapp1
<span class="udiff-line-added">+         testscriptapp2</span>
      }
  
      def nonModSrcSets = [
          sourceSets.test,
          sourceSets.testapp1
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3583,11 +3605,12 @@</span>
          sourceSets.testapp2,
          sourceSets.testapp3,
          sourceSets.testapp4,
          sourceSets.testapp5,
          sourceSets.testapp6,
<span class="udiff-line-modified-removed">-         sourceSets.testscriptapp1</span>
<span class="udiff-line-modified-added">+         sourceSets.testscriptapp1,</span>
<span class="udiff-line-added">+         sourceSets.testscriptapp2</span>
      ]
  
      project.ext.buildModule = false
      project.ext.moduleRuntime = false
      project.ext.moduleName = &quot;systemTests&quot;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3683,11 +3706,11 @@</span>
          dependsOn(createTestapp1Jar1)
          dependsOn(createTestapp1Jar2)
      }
      test.dependsOn(createTestApps);
  
<span class="udiff-line-modified-removed">-     def modtestapps = [ &quot;testapp2&quot;, &quot;testapp3&quot;, &quot;testapp4&quot;, &quot;testapp5&quot;, &quot;testapp6&quot;, &quot;testscriptapp1&quot; ]</span>
<span class="udiff-line-modified-added">+     def modtestapps = [ &quot;testapp2&quot;, &quot;testapp3&quot;, &quot;testapp4&quot;, &quot;testapp5&quot;, &quot;testapp6&quot;, &quot;testscriptapp1&quot;, &quot;testscriptapp2&quot; ]</span>
      modtestapps.each { testapp -&gt;
          def testappCapital = testapp.capitalize()
          def copyTestAppTask = task(&quot;copy${testappCapital}&quot;, type: Copy) {
              from project.sourceSets.&quot;${testapp}&quot;.java.outputDir
              from project.sourceSets.&quot;${testapp}&quot;.output.resourcesDir
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -4319,10 +4342,40 @@</span>
          zipsTask.dependsOn(zipJmodsTask)
      }
  }
  
  
<span class="udiff-line-added">+ /******************************************************************************</span>
<span class="udiff-line-added">+  *                                                                            *</span>
<span class="udiff-line-added">+  *                             OpenJFX Stubs                                  *</span>
<span class="udiff-line-added">+  *                                                                            *</span>
<span class="udiff-line-added">+  *****************************************************************************/</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ configurations {</span>
<span class="udiff-line-added">+     openjfxStubs</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ if (IS_STUB_RUNTIME_OPENJFX) {</span>
<span class="udiff-line-added">+     def String platform = IS_MAC ? &quot;mac&quot; : IS_WINDOWS ? &quot;win&quot; : IS_LINUX ? &quot;linux&quot; : &quot;&quot;</span>
<span class="udiff-line-added">+     dependencies {</span>
<span class="udiff-line-added">+         openjfxStubs &quot;org.openjfx:javafx-media:$STUB_RUNTIME_OPENJFX:$platform@jar&quot;</span>
<span class="udiff-line-added">+         openjfxStubs &quot;org.openjfx:javafx-web:$STUB_RUNTIME_OPENJFX:$platform@jar&quot;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ // Extract binary libraries from OpenJFX artifacts for use as stubs</span>
<span class="udiff-line-added">+ task prepOpenJfxStubs(type: Copy) {</span>
<span class="udiff-line-added">+     enabled = IS_STUB_RUNTIME_OPENJFX</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     from configurations.openjfxStubs.files.collect { zipTree(it) }</span>
<span class="udiff-line-added">+     include(&quot;*.dll&quot;)</span>
<span class="udiff-line-added">+     include(&quot;*.dylib&quot;)</span>
<span class="udiff-line-added">+     include(&quot;*.so&quot;)</span>
<span class="udiff-line-added">+     into IS_WINDOWS ? file(&quot;$openjfxStubRuntime/bin&quot;) : file(&quot;$openjfxStubRuntime/lib&quot;)</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ </span>
  /******************************************************************************
   *                                                                            *
   *                               Modules                                      *
   *                                                                            *
   *****************************************************************************/
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -4913,11 +4966,11 @@</span>
                      from (&quot;$winsdklib&quot;);
                  }
              }
          }
  
<span class="udiff-line-modified-removed">-         def buildModuleMediaTask = task(&quot;buildModuleMedia$t.capital&quot;, type: Copy, dependsOn: mediaProject.assemble) {</span>
<span class="udiff-line-modified-added">+         def buildModuleMediaTask = task(&quot;buildModuleMedia$t.capital&quot;, type: Copy, dependsOn: [mediaProject.assemble, prepOpenJfxStubs]) {</span>
              group = &quot;Basic&quot;
              description = &quot;copies javafx.media native libraries&quot;
  
              into &quot;${mediaProject.buildDir}/${moduleNativeDirName}&quot;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -4950,11 +5003,11 @@</span>
                      from (&quot;$MEDIA_STUB/${library(&quot;glib-lite&quot;)}&quot;)
                  }
              }
          }
  
<span class="udiff-line-modified-removed">-         def buildModuleWeb = task(&quot;buildModuleWeb$t.capital&quot;, type: Copy, dependsOn: webProject.assemble) {</span>
<span class="udiff-line-modified-added">+         def buildModuleWeb = task(&quot;buildModuleWeb$t.capital&quot;, type: Copy, dependsOn: [webProject.assemble, prepOpenJfxStubs]) {</span>
              group = &quot;Basic&quot;
              description = &quot;copies javafx.web native libraries&quot;
  
              into &quot;${webProject.buildDir}/${moduleNativeDirName}&quot;
  
</pre>
<center>&lt; prev <a href="index.html" target="_top">index</a> <a href="build.properties.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>