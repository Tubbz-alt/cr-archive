<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New tests/system/src/test/java/test/com/sun/javafx/image/impl/ImageRaceTest.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2014, 2020, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package test.com.sun.javafx.image.impl;
 27 
 28 import com.sun.javafx.image.impl.ByteArgb;
 29 import com.sun.javafx.image.impl.ByteBgr;
 30 import com.sun.javafx.image.impl.ByteBgra;
 31 import com.sun.javafx.image.impl.ByteBgraPre;
 32 import com.sun.javafx.image.impl.ByteGray;
 33 import com.sun.javafx.image.impl.ByteGrayAlpha;
 34 import com.sun.javafx.image.impl.ByteGrayAlphaPre;
 35 import com.sun.javafx.image.impl.ByteRgb;
 36 import com.sun.javafx.image.impl.ByteRgba;
 37 import com.sun.javafx.image.impl.IntArgb;
 38 import com.sun.javafx.image.impl.IntArgbPre;
 39 import java.util.ArrayList;
 40 import java.util.List;
 41 import org.junit.Test;
 42 import static test.util.Util.TIMEOUT;
 43 
 44 public class ImageRaceTest {
 45     static boolean verbose;
 46     static List&lt;Initializer&gt; initalizers = new ArrayList&lt;&gt;();
 47     static volatile boolean ready = false;
 48 
 49     static interface InitProc {
 50         public Object get();
 51     }
 52 
 53     static class Initializer extends Thread {
 54         private final InitProc init;
 55         private volatile boolean running;
 56 
 57         public Initializer(String classname, InitProc r) {
 58             super(classname+&quot; Initializer&quot;);
 59             this.init = r;
 60         }
 61 
 62         public boolean isRunning() { return running; }
 63 
 64         @Override
 65         public void run() {
 66             if (verbose) System.err.println(getName()+&quot; started&quot;);
 67             running = true;
 68             while (!ready) { yield(); }
 69             init.get();
 70             if (verbose) System.err.println(getName()+&quot; done&quot;);
 71         }
 72     }
 73 
 74     void forkAndJoinInitializers() {
 75         long limit = System.currentTimeMillis() + TIMEOUT;
 76         for (Initializer i : initalizers) {
 77             i.start();
 78             while (!i.isRunning() &amp;&amp; System.currentTimeMillis() &lt; limit) {
 79                 Thread.yield();
 80             }
 81             if (!i.isRunning()) {
 82                 throw new RuntimeException(&quot;Initializer &quot;+i+&quot; never started&quot;);
 83             }
 84         }
 85 
 86         if (verbose) System.err.println(&quot;\n[main] signal the threads to proceed\n&quot;);
 87         try {
 88             Thread.sleep(100);
 89         } catch (InterruptedException ex) {}
 90         ready = true;
 91 
 92         limit = System.currentTimeMillis() + TIMEOUT;
 93         try {
 94             for (Initializer i : initalizers) {
 95                 long now = System.currentTimeMillis();
 96                 if (now &lt; limit) {
 97                     i.join(limit - now);
 98                 }
 99                 if (i.isAlive()) {
100                     throw new RuntimeException(&quot;Initializer &quot;+i+&quot; never finished&quot;);
101                 }
102             }
103         } catch (InterruptedException ex) {}
104     }
105 
106     static void init(String[] args) {
107         boolean getters, setters, converters;
108         if (args.length == 0) {
109             getters = setters = converters = true;
110         } else {
111             getters = setters = converters = false;
112             for (String arg : args) {
113                 if (arg.equalsIgnoreCase(&quot;getters&quot;)) {
114                     getters = true;
115                 } else if (arg.equalsIgnoreCase(&quot;setters&quot;)) {
116                     setters = true;
117                 } else if (arg.equalsIgnoreCase(&quot;converters&quot;)) {
118                     converters = true;
119                 } else if (arg.equalsIgnoreCase(&quot;-verbose&quot;)) {
120                     verbose = true;
121                 } else {
122                     System.err.println(&quot;Unrecognized argument: &quot;+arg);
123                     System.exit(-1);
124                 }
125             }
126         }
127         if (getters) {
128             initalizers.add(new Initializer(&quot;ByteArgb.getter&quot;,         () -&gt; { return ByteArgb.getter; } ));
129             initalizers.add(new Initializer(&quot;ByteBgr.getter&quot;,          () -&gt; { return ByteBgr.getter; } ));
130             initalizers.add(new Initializer(&quot;ByteBgra.getter&quot;,         () -&gt; { return ByteBgra.getter; } ));
131             initalizers.add(new Initializer(&quot;ByteBgraPre.getter&quot;,      () -&gt; { return ByteBgraPre.getter; } ));
132             initalizers.add(new Initializer(&quot;ByteGray.getter&quot;,         () -&gt; { return ByteGray.getter; } ));
133             initalizers.add(new Initializer(&quot;ByteGrayAlpha.getter&quot;,    () -&gt; { return ByteGrayAlpha.getter; } ));
134             initalizers.add(new Initializer(&quot;ByteGrayAlphaPre.getter&quot;, () -&gt; { return ByteGrayAlphaPre.getter; } ));
135 //            initalizers.add(new Initializer(&quot;ByteIndexed.getter&quot;,    /* Has no .getter */ ));
136             initalizers.add(new Initializer(&quot;ByteRgb.getter&quot;,          () -&gt; { return ByteRgb.getter; } ));
137             initalizers.add(new Initializer(&quot;ByteRgba.getter&quot;,         () -&gt; { return ByteRgba.getter; } ));
138             initalizers.add(new Initializer(&quot;IntArgb.getter&quot;,          () -&gt; { return IntArgb.getter; } ));
139             initalizers.add(new Initializer(&quot;IntArgbPre.getter&quot;,       () -&gt; { return IntArgbPre.getter; } ));
140         }
141         if (setters) {
142             initalizers.add(new Initializer(&quot;ByteArgb.setter&quot;,         () -&gt; { return ByteArgb.setter; } ));
143             initalizers.add(new Initializer(&quot;ByteBgr.setter&quot;,          () -&gt; { return ByteBgr.setter; } ));
144             initalizers.add(new Initializer(&quot;ByteBgra.setter&quot;,         () -&gt; { return ByteBgra.setter; } ));
145             initalizers.add(new Initializer(&quot;ByteBgraPre.setter&quot;,      () -&gt; { return ByteBgraPre.setter; } ));
146             initalizers.add(new Initializer(&quot;ByteGray.setter&quot;,         () -&gt; { return ByteGray.setter; } ));
147             initalizers.add(new Initializer(&quot;ByteGrayAlpha.setter&quot;,    () -&gt; { return ByteGrayAlpha.setter; } ));
148             initalizers.add(new Initializer(&quot;ByteGrayAlphaPre.setter&quot;, () -&gt; { return ByteGrayAlphaPre.setter; } ));
149 //            initalizers.add(new Initializer(&quot;ByteIndexed.setter&quot;,    /* Has no .setter */ ));
150 //            initalizers.add(new Initializer(&quot;ByteRgb.setter&quot;,          /* Has no .setter */ ));
151             initalizers.add(new Initializer(&quot;ByteRgba.setter&quot;,         () -&gt; { return ByteRgba.setter; } ));
152             initalizers.add(new Initializer(&quot;IntArgb.setter&quot;,          () -&gt; { return IntArgb.setter; } ));
153             initalizers.add(new Initializer(&quot;IntArgbPre.setter&quot;,       () -&gt; { return IntArgbPre.setter; } ));
154         }
155         if (converters) {
156             initalizers.add(new Initializer(&quot;ByteBgr.ToByteArgb&quot;, () -&gt;
157                                     { return ByteBgr.ToByteArgbConverter(); } ));
158             initalizers.add(new Initializer(&quot;ByteBgr.ToByteBgr&quot;, () -&gt;
159                                     { return ByteBgr.ToByteBgrConverter(); } ));
160             initalizers.add(new Initializer(&quot;ByteBgr.ToByteBgra&quot;, () -&gt;
161                                     { return ByteBgr.ToByteBgraConverter(); } ));
162             initalizers.add(new Initializer(&quot;ByteBgr.ToByteBgraPre&quot;, () -&gt;
163                                     { return ByteBgr.ToByteBgraPreConverter(); } ));
164             initalizers.add(new Initializer(&quot;ByteBgr.ToIntArgb&quot;, () -&gt;
165                                     { return ByteBgr.ToIntArgbConverter(); } ));
166             initalizers.add(new Initializer(&quot;ByteBgr.ToIntArgbPre&quot;, () -&gt;
167                                     { return ByteBgr.ToIntArgbPreConverter(); } ));
168             initalizers.add(new Initializer(&quot;ByteBgra.ToByteBgra&quot;, () -&gt;
169                                     { return ByteBgra.ToByteBgraConverter(); } ));
170             initalizers.add(new Initializer(&quot;ByteBgra.ToByteBgraPre&quot;, () -&gt;
171                                     { return ByteBgra.ToByteBgraPreConverter(); } ));
172             initalizers.add(new Initializer(&quot;ByteBgra.ToIntArgb&quot;,  () -&gt;
173                                     { return ByteBgra.ToIntArgbConverter(); } ));
174             initalizers.add(new Initializer(&quot;ByteBgra.ToIntArgbPre&quot;,  () -&gt;
175                                     { return ByteBgra.ToIntArgbPreConverter(); } ));
176             initalizers.add(new Initializer(&quot;ByteBgraPre.ToByteBgra&quot;, () -&gt;
177                                     { return ByteBgraPre.ToByteBgraConverter(); } ));
178             initalizers.add(new Initializer(&quot;ByteBgraPre.ToByteBgraPre&quot;, () -&gt;
179                                     { return ByteBgraPre.ToByteBgraPreConverter(); } ));
180             initalizers.add(new Initializer(&quot;ByteBgraPre.ToIntArgb&quot;, () -&gt;
181                                     { return ByteBgraPre.ToIntArgbConverter(); } ));
182             initalizers.add(new Initializer(&quot;ByteBgraPre.ToIntArgbPre&quot;, () -&gt;
183                                     { return ByteBgraPre.ToIntArgbPreConverter(); } ));
184             initalizers.add(new Initializer(&quot;ByteGray.ToByteBgr&quot;, () -&gt;
185                                     { return ByteGray.ToByteBgrConverter(); } ));
186             initalizers.add(new Initializer(&quot;ByteGray.ToByteBgra&quot;, () -&gt;
187                                     { return ByteGray.ToByteBgraConverter(); } ));
188             initalizers.add(new Initializer(&quot;ByteGray.ToByteBgraPre&quot;, () -&gt;
189                                     { return ByteGray.ToByteBgraPreConverter(); } ));
190             initalizers.add(new Initializer(&quot;ByteGray.ToByteGray&quot;, () -&gt;
191                                     { return ByteGray.ToByteGrayConverter(); } ));
192             initalizers.add(new Initializer(&quot;ByteGray.ToIntArgb&quot;, () -&gt;
193                                     { return ByteGray.ToIntArgbConverter(); } ));
194             initalizers.add(new Initializer(&quot;ByteGray.ToIntArgbPre&quot;, () -&gt;
195                                     { return ByteGray.ToIntArgbPreConverter(); } ));
196             initalizers.add(new Initializer(&quot;ByteGrayAlpha.ToByteBgra&quot;, () -&gt;
197                                     { return ByteGrayAlpha.ToByteBgraConverter(); } ));
198             initalizers.add(new Initializer(&quot;ByteGrayAlpha.ToByteGrayAlphaPre&quot;, () -&gt;
199                                     { return ByteGrayAlpha.ToByteGrayAlphaPreConverter(); } ));
200             initalizers.add(new Initializer(&quot;ByteGrayAlphaPre.ToByteBgraPre&quot;, () -&gt;
201                                     { return ByteGrayAlphaPre.ToByteBgraPreConverter(); } ));
202             initalizers.add(new Initializer(&quot;ByteRgb.ToByteArgb&quot;, () -&gt;
203                                     { return ByteRgb.ToByteArgbConverter(); } ));
204             initalizers.add(new Initializer(&quot;ByteRgb.ToByteBgr&quot;, () -&gt;
205                                     { return ByteRgb.ToByteBgrConverter(); } ));
206             initalizers.add(new Initializer(&quot;ByteRgb.ToByteBgra&quot;, () -&gt;
207                                     { return ByteRgb.ToByteBgraConverter(); } ));
208             initalizers.add(new Initializer(&quot;ByteRgb.ToByteBgraPre&quot;, () -&gt;
209                                     { return ByteRgb.ToByteBgraPreConverter(); } ));
210             initalizers.add(new Initializer(&quot;ByteRgb.ToIntArgb&quot;, () -&gt;
211                                     { return ByteRgb.ToIntArgbConverter(); } ));
212             initalizers.add(new Initializer(&quot;ByteRgb.ToIntArgbPre&quot;, () -&gt;
213                                     { return ByteRgb.ToIntArgbPreConverter(); } ));
214             initalizers.add(new Initializer(&quot;ByteRgba.ToByteBgra&quot;, () -&gt;
215                                     { return ByteRgba.ToByteBgraConverter(); } ));
216             initalizers.add(new Initializer(&quot;ByteRgba.ToByteRgba&quot;, () -&gt;
217                                     { return ByteRgba.ToByteRgbaConverter(); } ));
218             initalizers.add(new Initializer(&quot;IntArgb.ToByteBgra&quot;, () -&gt;
219                                     { return IntArgb.ToByteBgraConverter(); } ));
220             initalizers.add(new Initializer(&quot;IntArgb.ToByteBgraPre&quot;, () -&gt;
221                                     { return IntArgb.ToByteBgraPreConverter(); } ));
222             initalizers.add(new Initializer(&quot;IntArgb.ToIntArgb&quot;, () -&gt;
223                                     { return IntArgb.ToIntArgbConverter(); } ));
224             initalizers.add(new Initializer(&quot;IntArgb.ToIntArgbPre&quot;, () -&gt;
225                                     { return IntArgb.ToIntArgbPreConverter(); } ));
226             initalizers.add(new Initializer(&quot;IntArgbPre.ToByteBgra&quot;, () -&gt;
227                                     { return IntArgbPre.ToByteBgraConverter(); } ));
228             initalizers.add(new Initializer(&quot;IntArgbPre.ToByteBgraPre&quot;, () -&gt;
229                                     { return IntArgbPre.ToByteBgraPreConverter(); } ));
230             initalizers.add(new Initializer(&quot;IntArgbPre.ToIntArgb&quot;, () -&gt;
231                                     { return IntArgbPre.ToIntArgbConverter(); } ));
232             initalizers.add(new Initializer(&quot;IntArgbPre.ToIntArgbPre&quot;, () -&gt;
233                                     { return IntArgbPre.ToIntArgbPreConverter(); } ));
234         }
235     }
236 
237     @Test
238     public void testImageInitializationRaceCondition() {
239         init(new String[0]);
240         forkAndJoinInitializers();
241     }
242 }
    </pre>
  </body>
</html>