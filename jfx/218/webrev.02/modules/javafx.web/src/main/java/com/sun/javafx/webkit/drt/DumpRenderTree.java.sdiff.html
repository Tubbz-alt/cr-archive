<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/java/com/sun/javafx/webkit/drt/DumpRenderTree.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../../../../javafx.swt/src/main/java/javafx/embed/swt/FXCanvas.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="UIClientImpl.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/java/com/sun/javafx/webkit/drt/DumpRenderTree.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 28 import com.sun.javafx.application.PlatformImpl;
 29 import com.sun.javafx.logging.PlatformLogger;
 30 import com.sun.javafx.logging.PlatformLogger.Level;
 31 import com.sun.webkit.*;
 32 import com.sun.webkit.graphics.*;
 33 
 34 import static com.sun.webkit.network.URLs.newURL;
 35 import java.io.BufferedReader;
 36 import java.io.BufferedWriter;
 37 import java.io.File;
 38 import java.io.InputStreamReader;
 39 import java.io.OutputStreamWriter;
 40 import java.io.PrintWriter;
 41 import java.io.UnsupportedEncodingException;
 42 import java.net.MalformedURLException;
 43 import java.net.URL;
 44 import java.nio.ByteBuffer;
 45 import java.util.Date;
 46 import java.util.Map;
 47 import java.util.List;


 48 import java.util.concurrent.CountDownLatch;
 49 import javafx.scene.web.WebEngine;
 50 
 51 public final class DumpRenderTree {
 52     private final static PlatformLogger log = PlatformLogger.getLogger(&quot;DumpRenderTree&quot;);
 53     private final static long PID = (new Date()).getTime() &amp; 0xFFFF;
 54     private final static String fileSep = System.getProperty(&quot;file.separator&quot;);
 55     private static boolean forceDumpAsText = false;
 56 
 57     final static PrintWriter out;
 58     static {
 59         try {
 60             out = new PrintWriter(new BufferedWriter(new OutputStreamWriter(
 61                     System.out, &quot;UTF-8&quot;)), true);
 62         } catch (UnsupportedEncodingException ex) {
 63             throw new RuntimeException(ex);
 64         }
 65     }
 66     static volatile DumpRenderTree drt;
 67 
 68     private final WebPage webPage;
 69     private final UIClientImpl uiClient;
 70     private EventSender eventSender;
 71 
 72     private CountDownLatch latch;

 73     private String testPath;
 74     private boolean loaded;
 75     private boolean waiting;
 76     private boolean complete;
 77 















 78     static class ThemeClientImplStub extends ThemeClient {
 79         @Override
 80         protected RenderTheme createRenderTheme() {
 81             return new RenderThemeStub();
 82         }
 83 
 84         @Override
 85         protected ScrollBarTheme createScrollBarTheme() {
 86             return new ScrollBarThemeStub();
 87         }
 88     };
 89 
 90     static class RenderThemeStub extends RenderTheme {
 91         @Override
 92         protected Ref createWidget(long id, int widgetIndex, int state, int w, int h, int bgColor, ByteBuffer extParams) {
 93             return null;
 94         }
 95 
 96         @Override
 97         public void drawWidget(WCGraphicsContext g, Ref widget, int x, int y) {
</pre>
<hr />
<pre>
136     private DumpRenderTree() {
137         uiClient = new UIClientImpl();
138         webPage = new WebPage(new WebPageClientImpl(), uiClient, null, null,
139                               new ThemeClientImplStub(), false);
140         uiClient.setWebPage(webPage);
141 
142         webPage.setBounds(0, 0, 800, 600);
143         webPage.setDeveloperExtrasEnabled(true);
144         webPage.addLoadListenerClient(new DRTLoadListener());
145 
146     }
147 
148     private String getTestPath(String testString) {
149         int t = testString.indexOf(&quot;&#39;&quot;);
150         String pixelsHash = &quot;&quot;;
151         if ((t &gt; 0) &amp;&amp; (t &lt; testString.length() - 1)) {
152             pixelsHash = testString.substring(t + 1);
153             testString = testString.substring(0, t);
154         }
155         this.testPath = testString;
<span class="line-modified">156         init(testString, pixelsHash);</span>
157         return testString;
158     }
159 
160     protected String getTestURL() {
161         return testPath;
162     }
163 
164 /*
165     private static boolean isDebug()
166     {
167         return log.isLoggable(Level.FINE);
168     }
169 */
170 
171     private static void mlog(String msg) {
172         if (log.isLoggable(Level.FINE)) {
173             log.fine(&quot;PID:&quot; + Long.toHexString(PID)
174                     + &quot; TID:&quot; + Thread.currentThread().getId()
175                         + &quot;(&quot; + Thread.currentThread().getName() + &quot;) &quot;
176                     + msg);
177         }
178     }
179 
180     private static void initPlatform() throws Exception {
181         // initialize default toolkit
182         final CountDownLatch latch = new CountDownLatch(1);
183         PlatformImpl.startup(() -&gt; {
<span class="line-modified">184             new WebEngine();    // initialize Webkit classes</span>





185             System.loadLibrary(&quot;DumpRenderTreeJava&quot;);


186             drt = new DumpRenderTree();
187             PageCache.setCapacity(1);
188             latch.countDown();
189         });
190         // wait for libraries to load
191         latch.await();
192     }
193 
194     boolean complete() { return this.complete; }
195 
196     private void resetToConsistentStateBeforeTesting(final TestOptions options) {



197         // Assign default values for all supported TestOptions
198         webPage.overridePreference(&quot;experimental:CSSCustomPropertiesAndValuesEnabled&quot;, &quot;false&quot;);
199         webPage.overridePreference(&quot;enableColorFilter&quot;, &quot;false&quot;);
200         webPage.overridePreference(&quot;enableIntersectionObserver&quot;, &quot;false&quot;);
201         // Enable features based on TestOption
202         for (Map.Entry&lt;String, String&gt; option : options.getOptions().entrySet()) {
203             webPage.overridePreference(option.getKey(), option.getValue());
204         }
<span class="line-removed">205         // Reset native objects associated with WebPage</span>
<span class="line-removed">206         webPage.resetToConsistentStateBeforeTesting();</span>
207     }
208 
209     private void reset(final TestOptions options) {
210         mlog(&quot;reset&quot;);
211         // newly create EventSender for each test
212         eventSender = new EventSender(webPage);
213         resetToConsistentStateBeforeTesting(options);
214         // Clear frame name
215         webPage.reset(webPage.getMainFrame());
216         // Reset zoom factors
217         webPage.setZoomFactor(1.0f, true);
218         webPage.setZoomFactor(1.0f, false);
219         // Reset DRT internal states
220         complete = false;
221         loaded = false;
222         waiting = false;
223     }
224 
225     // called on FX thread
226     private void run(final String testString, final CountDownLatch latch) {
</pre>
<hr />
<pre>
228         String file = getTestPath(testString);
229         mlog(&quot;{runTest: &quot; + file);
230         long mainFrame = webPage.getMainFrame();
231         try {
232             new URL(file);
233         } catch (MalformedURLException ex) {
234             file = &quot;file:///&quot; + file;
235         }
236         // parse test options from the html test header
237         final TestOptions options = new TestOptions(file);
238         reset(options);
239         webPage.open(mainFrame, file);
240         mlog(&quot;}runTest&quot;);
241     }
242 
243     private void runTest(final String testString) throws Exception {
244         final CountDownLatch l = new CountDownLatch(1);
245         Invoker.getInvoker().invokeOnEventThread(() -&gt; {
246             run(testString, l);
247         });




248         // wait until test is finished
249         l.await();



250         Invoker.getInvoker().invokeOnEventThread(() -&gt; {
251             mlog(&quot;dispose&quot;);
252             webPage.stop();
253             dispose();

254         });

255     }
256 
257     // called from native
258     private static void waitUntilDone() {
259         mlog(&quot;waitUntilDone&quot;);
260         drt.setWaiting(true); // TODO: handle timeout
261     }
262 
263     // called from native
264     private static void notifyDone() {
265         mlog(&quot;notifyDone&quot;);
266         drt.setWaiting(false);
267     }
268 
269     private static void overridePreference(String key, String value) {
270         mlog(&quot;overridePreference&quot;);
271         drt.webPage.overridePreference(key, value);
272     }
273 
274     private synchronized void setLoaded(boolean loaded) {
</pre>
<hr />
<pre>
317         if (waiting || !loaded || complete) {
318             return;
319         }
320         mlog(&quot;dump&quot;);
321         dump(webPage.getMainFrame());
322 
323         mlog(&quot;done&quot;);
324         out.print(&quot;#EOF&quot; + &#39;\n&#39;);
325         // TODO: dump pixels here
326         out.print(&quot;#EOF&quot; + &#39;\n&#39;);
327         out.flush();
328 
329         System.err.print(&quot;#EOF&quot; + &#39;\n&#39;);
330         System.err.flush();
331 
332         complete = true;
333         // notify main thread that test is finished
334         this.latch.countDown();
335     }
336 
<span class="line-modified">337     private static native void init(String testPath, String pixelsHash);</span>

338     private static native void didClearWindowObject(long pContext,
339             long pWindowObject, EventSender eventSender);
340     private static native void dispose();
341 
342     private static native boolean dumpAsText();
343     private static native boolean dumpChildFramesAsText();
344     private static native boolean dumpBackForwardList();
345     protected static native boolean shouldStayOnPageAfterHandlingBeforeUnload();
346     protected static native String[] openPanelFiles();
347 
348     private final class DRTLoadListener implements LoadListenerClient {
349         @Override
350         public void dispatchLoadEvent(long frame, int state,
351                                       String url, String contentType,
352                                       double progress, int errorCode)
353         {
354             mlog(&quot;dispatchLoadEvent: ENTER&quot;);
355             if (frame == webPage.getMainFrame()) {
356                 mlog(&quot;dispatchLoadEvent: STATE = &quot; + state);
357                 switch (state) {
</pre>
</td>
<td>
<hr />
<pre>
 28 import com.sun.javafx.application.PlatformImpl;
 29 import com.sun.javafx.logging.PlatformLogger;
 30 import com.sun.javafx.logging.PlatformLogger.Level;
 31 import com.sun.webkit.*;
 32 import com.sun.webkit.graphics.*;
 33 
 34 import static com.sun.webkit.network.URLs.newURL;
 35 import java.io.BufferedReader;
 36 import java.io.BufferedWriter;
 37 import java.io.File;
 38 import java.io.InputStreamReader;
 39 import java.io.OutputStreamWriter;
 40 import java.io.PrintWriter;
 41 import java.io.UnsupportedEncodingException;
 42 import java.net.MalformedURLException;
 43 import java.net.URL;
 44 import java.nio.ByteBuffer;
 45 import java.util.Date;
 46 import java.util.Map;
 47 import java.util.List;
<span class="line-added"> 48 import java.util.Timer;</span>
<span class="line-added"> 49 import java.util.TimerTask;</span>
 50 import java.util.concurrent.CountDownLatch;
 51 import javafx.scene.web.WebEngine;
 52 
 53 public final class DumpRenderTree {
 54     private final static PlatformLogger log = PlatformLogger.getLogger(&quot;DumpRenderTree&quot;);
 55     private final static long PID = (new Date()).getTime() &amp; 0xFFFF;
 56     private final static String fileSep = System.getProperty(&quot;file.separator&quot;);
 57     private static boolean forceDumpAsText = false;
 58 
 59     final static PrintWriter out;
 60     static {
 61         try {
 62             out = new PrintWriter(new BufferedWriter(new OutputStreamWriter(
 63                     System.out, &quot;UTF-8&quot;)), true);
 64         } catch (UnsupportedEncodingException ex) {
 65             throw new RuntimeException(ex);
 66         }
 67     }
 68     static volatile DumpRenderTree drt;
 69 
 70     private final WebPage webPage;
 71     private final UIClientImpl uiClient;
 72     private EventSender eventSender;
 73 
 74     private CountDownLatch latch;
<span class="line-added"> 75     private Timer timer;</span>
 76     private String testPath;
 77     private boolean loaded;
 78     private boolean waiting;
 79     private boolean complete;
 80 
<span class="line-added"> 81     static class RenderUpdateHelper extends TimerTask {</span>
<span class="line-added"> 82         private WebPage webPage;</span>
<span class="line-added"> 83 </span>
<span class="line-added"> 84         public RenderUpdateHelper(WebPage webPage) {</span>
<span class="line-added"> 85             this.webPage = webPage;</span>
<span class="line-added"> 86         }</span>
<span class="line-added"> 87 </span>
<span class="line-added"> 88         @Override</span>
<span class="line-added"> 89         public void run() {</span>
<span class="line-added"> 90             Invoker.getInvoker().invokeOnEventThread(() -&gt; {</span>
<span class="line-added"> 91                     webPage.forceRepaint();</span>
<span class="line-added"> 92             });</span>
<span class="line-added"> 93         }</span>
<span class="line-added"> 94     };</span>
<span class="line-added"> 95 </span>
 96     static class ThemeClientImplStub extends ThemeClient {
 97         @Override
 98         protected RenderTheme createRenderTheme() {
 99             return new RenderThemeStub();
100         }
101 
102         @Override
103         protected ScrollBarTheme createScrollBarTheme() {
104             return new ScrollBarThemeStub();
105         }
106     };
107 
108     static class RenderThemeStub extends RenderTheme {
109         @Override
110         protected Ref createWidget(long id, int widgetIndex, int state, int w, int h, int bgColor, ByteBuffer extParams) {
111             return null;
112         }
113 
114         @Override
115         public void drawWidget(WCGraphicsContext g, Ref widget, int x, int y) {
</pre>
<hr />
<pre>
154     private DumpRenderTree() {
155         uiClient = new UIClientImpl();
156         webPage = new WebPage(new WebPageClientImpl(), uiClient, null, null,
157                               new ThemeClientImplStub(), false);
158         uiClient.setWebPage(webPage);
159 
160         webPage.setBounds(0, 0, 800, 600);
161         webPage.setDeveloperExtrasEnabled(true);
162         webPage.addLoadListenerClient(new DRTLoadListener());
163 
164     }
165 
166     private String getTestPath(String testString) {
167         int t = testString.indexOf(&quot;&#39;&quot;);
168         String pixelsHash = &quot;&quot;;
169         if ((t &gt; 0) &amp;&amp; (t &lt; testString.length() - 1)) {
170             pixelsHash = testString.substring(t + 1);
171             testString = testString.substring(0, t);
172         }
173         this.testPath = testString;
<span class="line-modified">174         initTest(testString, pixelsHash);</span>
175         return testString;
176     }
177 
178     protected String getTestURL() {
179         return testPath;
180     }
181 
182 /*
183     private static boolean isDebug()
184     {
185         return log.isLoggable(Level.FINE);
186     }
187 */
188 
189     private static void mlog(String msg) {
190         if (log.isLoggable(Level.FINE)) {
191             log.fine(&quot;PID:&quot; + Long.toHexString(PID)
192                     + &quot; TID:&quot; + Thread.currentThread().getId()
193                         + &quot;(&quot; + Thread.currentThread().getName() + &quot;) &quot;
194                     + msg);
195         }
196     }
197 
198     private static void initPlatform() throws Exception {
199         // initialize default toolkit
200         final CountDownLatch latch = new CountDownLatch(1);
201         PlatformImpl.startup(() -&gt; {
<span class="line-modified">202             // initialize Webkit classes</span>
<span class="line-added">203             try {</span>
<span class="line-added">204                 Class.forName(WebEngine.class.getName());</span>
<span class="line-added">205                 Class.forName(WebPage.class.getName());</span>
<span class="line-added">206             } catch (Exception e) {}</span>
<span class="line-added">207 </span>
208             System.loadLibrary(&quot;DumpRenderTreeJava&quot;);
<span class="line-added">209             initDRT();</span>
<span class="line-added">210             new WebEngine();</span>
211             drt = new DumpRenderTree();
212             PageCache.setCapacity(1);
213             latch.countDown();
214         });
215         // wait for libraries to load
216         latch.await();
217     }
218 
219     boolean complete() { return this.complete; }
220 
221     private void resetToConsistentStateBeforeTesting(final TestOptions options) {
<span class="line-added">222         // Reset native objects associated with WebPage</span>
<span class="line-added">223         webPage.resetToConsistentStateBeforeTesting();</span>
<span class="line-added">224 </span>
225         // Assign default values for all supported TestOptions
226         webPage.overridePreference(&quot;experimental:CSSCustomPropertiesAndValuesEnabled&quot;, &quot;false&quot;);
227         webPage.overridePreference(&quot;enableColorFilter&quot;, &quot;false&quot;);
228         webPage.overridePreference(&quot;enableIntersectionObserver&quot;, &quot;false&quot;);
229         // Enable features based on TestOption
230         for (Map.Entry&lt;String, String&gt; option : options.getOptions().entrySet()) {
231             webPage.overridePreference(option.getKey(), option.getValue());
232         }


233     }
234 
235     private void reset(final TestOptions options) {
236         mlog(&quot;reset&quot;);
237         // newly create EventSender for each test
238         eventSender = new EventSender(webPage);
239         resetToConsistentStateBeforeTesting(options);
240         // Clear frame name
241         webPage.reset(webPage.getMainFrame());
242         // Reset zoom factors
243         webPage.setZoomFactor(1.0f, true);
244         webPage.setZoomFactor(1.0f, false);
245         // Reset DRT internal states
246         complete = false;
247         loaded = false;
248         waiting = false;
249     }
250 
251     // called on FX thread
252     private void run(final String testString, final CountDownLatch latch) {
</pre>
<hr />
<pre>
254         String file = getTestPath(testString);
255         mlog(&quot;{runTest: &quot; + file);
256         long mainFrame = webPage.getMainFrame();
257         try {
258             new URL(file);
259         } catch (MalformedURLException ex) {
260             file = &quot;file:///&quot; + file;
261         }
262         // parse test options from the html test header
263         final TestOptions options = new TestOptions(file);
264         reset(options);
265         webPage.open(mainFrame, file);
266         mlog(&quot;}runTest&quot;);
267     }
268 
269     private void runTest(final String testString) throws Exception {
270         final CountDownLatch l = new CountDownLatch(1);
271         Invoker.getInvoker().invokeOnEventThread(() -&gt; {
272             run(testString, l);
273         });
<span class="line-added">274 </span>
<span class="line-added">275         timer = new Timer();</span>
<span class="line-added">276         TimerTask task = new RenderUpdateHelper(webPage);</span>
<span class="line-added">277         timer.schedule(task, 1000/60, 1000/60);</span>
278         // wait until test is finished
279         l.await();
<span class="line-added">280         task.cancel();</span>
<span class="line-added">281         timer.cancel();</span>
<span class="line-added">282         final CountDownLatch latchForEvents = new CountDownLatch(1);</span>
283         Invoker.getInvoker().invokeOnEventThread(() -&gt; {
284             mlog(&quot;dispose&quot;);
285             webPage.stop();
286             dispose();
<span class="line-added">287             latchForEvents.countDown();</span>
288         });
<span class="line-added">289         latchForEvents.await();</span>
290     }
291 
292     // called from native
293     private static void waitUntilDone() {
294         mlog(&quot;waitUntilDone&quot;);
295         drt.setWaiting(true); // TODO: handle timeout
296     }
297 
298     // called from native
299     private static void notifyDone() {
300         mlog(&quot;notifyDone&quot;);
301         drt.setWaiting(false);
302     }
303 
304     private static void overridePreference(String key, String value) {
305         mlog(&quot;overridePreference&quot;);
306         drt.webPage.overridePreference(key, value);
307     }
308 
309     private synchronized void setLoaded(boolean loaded) {
</pre>
<hr />
<pre>
352         if (waiting || !loaded || complete) {
353             return;
354         }
355         mlog(&quot;dump&quot;);
356         dump(webPage.getMainFrame());
357 
358         mlog(&quot;done&quot;);
359         out.print(&quot;#EOF&quot; + &#39;\n&#39;);
360         // TODO: dump pixels here
361         out.print(&quot;#EOF&quot; + &#39;\n&#39;);
362         out.flush();
363 
364         System.err.print(&quot;#EOF&quot; + &#39;\n&#39;);
365         System.err.flush();
366 
367         complete = true;
368         // notify main thread that test is finished
369         this.latch.countDown();
370     }
371 
<span class="line-modified">372     private static native void initDRT();</span>
<span class="line-added">373     private static native void initTest(String testPath, String pixelsHash);</span>
374     private static native void didClearWindowObject(long pContext,
375             long pWindowObject, EventSender eventSender);
376     private static native void dispose();
377 
378     private static native boolean dumpAsText();
379     private static native boolean dumpChildFramesAsText();
380     private static native boolean dumpBackForwardList();
381     protected static native boolean shouldStayOnPageAfterHandlingBeforeUnload();
382     protected static native String[] openPanelFiles();
383 
384     private final class DRTLoadListener implements LoadListenerClient {
385         @Override
386         public void dispatchLoadEvent(long frame, int state,
387                                       String url, String contentType,
388                                       double progress, int errorCode)
389         {
390             mlog(&quot;dispatchLoadEvent: ENTER&quot;);
391             if (frame == webPage.getMainFrame()) {
392                 mlog(&quot;dispatchLoadEvent: STATE = &quot; + state);
393                 switch (state) {
</pre>
</td>
</tr>
</table>
<center><a href="../../../../../../../../../javafx.swt/src/main/java/javafx/embed/swt/FXCanvas.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="UIClientImpl.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>