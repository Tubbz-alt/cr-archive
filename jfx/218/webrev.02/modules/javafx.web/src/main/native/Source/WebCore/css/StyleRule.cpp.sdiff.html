<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WebCore/css/StyleRule.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="StyleProperties.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="StyleRule.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/css/StyleRule.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 28 #include &quot;CSSKeyframeRule.h&quot;
 29 #include &quot;CSSKeyframesRule.h&quot;
 30 #include &quot;CSSMediaRule.h&quot;
 31 #include &quot;CSSNamespaceRule.h&quot;
 32 #include &quot;CSSPageRule.h&quot;
 33 #include &quot;CSSStyleRule.h&quot;
 34 #include &quot;CSSSupportsRule.h&quot;
 35 #include &quot;MediaList.h&quot;
 36 #include &quot;StyleProperties.h&quot;
 37 #include &quot;StyleRuleImport.h&quot;
 38 #include &quot;WebKitCSSViewportRule.h&quot;
 39 
 40 namespace WebCore {
 41 
 42 struct SameSizeAsStyleRuleBase : public WTF::RefCountedBase {
 43     unsigned bitfields : 5;
 44 };
 45 
 46 COMPILE_ASSERT(sizeof(StyleRuleBase) == sizeof(SameSizeAsStyleRuleBase), StyleRuleBase_should_stay_small);
 47 



 48 Ref&lt;CSSRule&gt; StyleRuleBase::createCSSOMWrapper(CSSStyleSheet* parentSheet) const
 49 {
 50     return createCSSOMWrapper(parentSheet, nullptr);
 51 }
 52 
 53 Ref&lt;CSSRule&gt; StyleRuleBase::createCSSOMWrapper(CSSRule* parentRule) const
 54 {
 55     return createCSSOMWrapper(nullptr, parentRule);
 56 }
 57 
 58 void StyleRuleBase::destroy()
 59 {
 60     switch (type()) {
<span class="line-modified"> 61     case Style:</span>
 62         delete downcast&lt;StyleRule&gt;(this);
 63         return;
<span class="line-modified"> 64     case Page:</span>
 65         delete downcast&lt;StyleRulePage&gt;(this);
 66         return;
<span class="line-modified"> 67     case FontFace:</span>
 68         delete downcast&lt;StyleRuleFontFace&gt;(this);
 69         return;
<span class="line-modified"> 70     case Media:</span>
 71         delete downcast&lt;StyleRuleMedia&gt;(this);
 72         return;
<span class="line-modified"> 73     case Supports:</span>
 74         delete downcast&lt;StyleRuleSupports&gt;(this);
 75         return;
<span class="line-modified"> 76     case Import:</span>
 77         delete downcast&lt;StyleRuleImport&gt;(this);
 78         return;
<span class="line-modified"> 79     case Keyframes:</span>
 80         delete downcast&lt;StyleRuleKeyframes&gt;(this);
 81         return;
 82 #if ENABLE(CSS_DEVICE_ADAPTATION)
<span class="line-modified"> 83     case Viewport:</span>
 84         delete downcast&lt;StyleRuleViewport&gt;(this);
 85         return;
 86 #endif
<span class="line-modified"> 87     case Namespace:</span>
 88         delete downcast&lt;StyleRuleNamespace&gt;(this);
 89         return;
<span class="line-modified"> 90     case Keyframe:</span>
 91         delete downcast&lt;StyleRuleKeyframe&gt;(this);
 92         return;
<span class="line-modified"> 93     case Charset:</span>
 94         delete downcast&lt;StyleRuleCharset&gt;(this);
 95         return;
<span class="line-modified"> 96     case Unknown:</span>
 97         ASSERT_NOT_REACHED();
 98         return;
 99     }
100     ASSERT_NOT_REACHED();
101 }
102 
103 Ref&lt;StyleRuleBase&gt; StyleRuleBase::copy() const
104 {
105     switch (type()) {
<span class="line-modified">106     case Style:</span>
107         return downcast&lt;StyleRule&gt;(*this).copy();
<span class="line-modified">108     case Page:</span>
109         return downcast&lt;StyleRulePage&gt;(*this).copy();
<span class="line-modified">110     case FontFace:</span>
111         return downcast&lt;StyleRuleFontFace&gt;(*this).copy();
<span class="line-modified">112     case Media:</span>
113         return downcast&lt;StyleRuleMedia&gt;(*this).copy();
<span class="line-modified">114     case Supports:</span>
115         return downcast&lt;StyleRuleSupports&gt;(*this).copy();
<span class="line-modified">116     case Keyframes:</span>
117         return downcast&lt;StyleRuleKeyframes&gt;(*this).copy();
118 #if ENABLE(CSS_DEVICE_ADAPTATION)
<span class="line-modified">119     case Viewport:</span>
120         return downcast&lt;StyleRuleViewport&gt;(*this).copy();
121 #endif
<span class="line-modified">122     case Import:</span>
<span class="line-modified">123     case Namespace:</span>
124         // FIXME: Copy import and namespace rules.
125         break;
<span class="line-modified">126     case Unknown:</span>
<span class="line-modified">127     case Charset:</span>
<span class="line-modified">128     case Keyframe:</span>
129         break;
130     }
131     CRASH();
132 }
133 
134 Ref&lt;CSSRule&gt; StyleRuleBase::createCSSOMWrapper(CSSStyleSheet* parentSheet, CSSRule* parentRule) const
135 {
136     RefPtr&lt;CSSRule&gt; rule;
137     StyleRuleBase&amp; self = const_cast&lt;StyleRuleBase&amp;&gt;(*this);
138     switch (type()) {
<span class="line-modified">139     case Style:</span>
140         rule = CSSStyleRule::create(downcast&lt;StyleRule&gt;(self), parentSheet);
141         break;
<span class="line-modified">142     case Page:</span>
143         rule = CSSPageRule::create(downcast&lt;StyleRulePage&gt;(self), parentSheet);
144         break;
<span class="line-modified">145     case FontFace:</span>
146         rule = CSSFontFaceRule::create(downcast&lt;StyleRuleFontFace&gt;(self), parentSheet);
147         break;
<span class="line-modified">148     case Media:</span>
149         rule = CSSMediaRule::create(downcast&lt;StyleRuleMedia&gt;(self), parentSheet);
150         break;
<span class="line-modified">151     case Supports:</span>
152         rule = CSSSupportsRule::create(downcast&lt;StyleRuleSupports&gt;(self), parentSheet);
153         break;
<span class="line-modified">154     case Import:</span>
155         rule = CSSImportRule::create(downcast&lt;StyleRuleImport&gt;(self), parentSheet);
156         break;
<span class="line-modified">157     case Keyframes:</span>
158         rule = CSSKeyframesRule::create(downcast&lt;StyleRuleKeyframes&gt;(self), parentSheet);
159         break;
160 #if ENABLE(CSS_DEVICE_ADAPTATION)
<span class="line-modified">161     case Viewport:</span>
162         rule = WebKitCSSViewportRule::create(downcast&lt;StyleRuleViewport&gt;(self), parentSheet);
163         break;
164 #endif
<span class="line-modified">165     case Namespace:</span>
166         rule = CSSNamespaceRule::create(downcast&lt;StyleRuleNamespace&gt;(self), parentSheet);
167         break;
<span class="line-modified">168     case Unknown:</span>
<span class="line-modified">169     case Charset:</span>
<span class="line-modified">170     case Keyframe:</span>
171         ASSERT_NOT_REACHED();
172         break;
173     }
174     ASSERT(rule);
175 
176     if (parentRule)
177         rule-&gt;setParentRule(parentRule);
178     return rule.releaseNonNull();
179 }
180 
181 unsigned StyleRule::averageSizeInBytes()
182 {
183     return sizeof(StyleRule) + sizeof(CSSSelector) + StyleProperties::averageSizeInBytes();
184 }
185 
186 StyleRule::StyleRule(Ref&lt;StylePropertiesBase&gt;&amp;&amp; properties, bool hasDocumentSecurityOrigin, CSSSelectorList&amp;&amp; selectors)
<span class="line-modified">187     : StyleRuleBase(Style, hasDocumentSecurityOrigin)</span>
188     , m_properties(WTFMove(properties))
189     , m_selectorList(WTFMove(selectors))
190 {
191 }
192 
193 StyleRule::StyleRule(const StyleRule&amp; o)
194     : StyleRuleBase(o)
195     , m_properties(o.properties().mutableCopy())
196     , m_selectorList(o.m_selectorList)
197 {
198 }
199 
200 StyleRule::~StyleRule() = default;
201 
202 const StyleProperties&amp; StyleRule::properties() const
203 {
204     if (m_properties-&gt;type() == DeferredPropertiesType)
205         m_properties = downcast&lt;DeferredStyleProperties&gt;(m_properties.get()).parseDeferredProperties();
206     return downcast&lt;StyleProperties&gt;(m_properties.get());
207 }
</pre>
<hr />
<pre>
233     for (const CSSSelector* selector = selectorList().first(); selector; selector = CSSSelectorList::next(selector)) {
234         Vector&lt;const CSSSelector*, 8&gt; componentsInThisSelector;
235         for (const CSSSelector* component = selector; component; component = component-&gt;tagHistory())
236             componentsInThisSelector.append(component);
237 
238         if (componentsInThisSelector.size() + componentsSinceLastSplit.size() &gt; maxCount &amp;&amp; !componentsSinceLastSplit.isEmpty()) {
239             rules.append(createForSplitting(componentsSinceLastSplit, const_cast&lt;StyleProperties&amp;&gt;(properties()), hasDocumentSecurityOrigin()));
240             componentsSinceLastSplit.clear();
241         }
242 
243         componentsSinceLastSplit.appendVector(componentsInThisSelector);
244     }
245 
246     if (!componentsSinceLastSplit.isEmpty())
247         rules.append(createForSplitting(componentsSinceLastSplit, const_cast&lt;StyleProperties&amp;&gt;(properties()), hasDocumentSecurityOrigin()));
248 
249     return rules;
250 }
251 
252 StyleRulePage::StyleRulePage(Ref&lt;StyleProperties&gt;&amp;&amp; properties, CSSSelectorList&amp;&amp; selectors)
<span class="line-modified">253     : StyleRuleBase(Page)</span>
254     , m_properties(WTFMove(properties))
255     , m_selectorList(WTFMove(selectors))
256 {
257 }
258 
259 StyleRulePage::StyleRulePage(const StyleRulePage&amp; o)
260     : StyleRuleBase(o)
261     , m_properties(o.m_properties-&gt;mutableCopy())
262     , m_selectorList(o.m_selectorList)
263 {
264 }
265 
266 StyleRulePage::~StyleRulePage() = default;
267 
268 MutableStyleProperties&amp; StyleRulePage::mutableProperties()
269 {
270     if (!is&lt;MutableStyleProperties&gt;(m_properties.get()))
271         m_properties = m_properties-&gt;mutableCopy();
272     return downcast&lt;MutableStyleProperties&gt;(m_properties.get());
273 }
274 
275 StyleRuleFontFace::StyleRuleFontFace(Ref&lt;StyleProperties&gt;&amp;&amp; properties)
<span class="line-modified">276     : StyleRuleBase(FontFace)</span>
277     , m_properties(WTFMove(properties))
278 {
279 }
280 
281 StyleRuleFontFace::StyleRuleFontFace(const StyleRuleFontFace&amp; o)
282     : StyleRuleBase(o)
283     , m_properties(o.m_properties-&gt;mutableCopy())
284 {
285 }
286 
287 StyleRuleFontFace::~StyleRuleFontFace() = default;
288 
289 MutableStyleProperties&amp; StyleRuleFontFace::mutableProperties()
290 {
291     if (!is&lt;MutableStyleProperties&gt;(m_properties.get()))
292         m_properties = m_properties-&gt;mutableCopy();
293     return downcast&lt;MutableStyleProperties&gt;(m_properties.get());
294 }
295 
296 DeferredStyleGroupRuleList::DeferredStyleGroupRuleList(const CSSParserTokenRange&amp; range, CSSDeferredParser&amp; parser)
297     : m_parser(parser)
298 {
299     size_t length = range.end() - range.begin();
300     m_tokens.reserveCapacity(length);
301     m_tokens.append(range.begin(), length);
302 }
303 
304 void DeferredStyleGroupRuleList::parseDeferredRules(Vector&lt;RefPtr&lt;StyleRuleBase&gt;&gt;&amp; childRules)
305 {
306     m_parser-&gt;parseRuleList(m_tokens, childRules);
307 }
308 
309 void DeferredStyleGroupRuleList::parseDeferredKeyframes(StyleRuleKeyframes&amp; keyframesRule)
310 {
311     m_parser-&gt;parseKeyframeList(m_tokens, keyframesRule);
312 }
313 
<span class="line-modified">314 StyleRuleGroup::StyleRuleGroup(Type type, Vector&lt;RefPtr&lt;StyleRuleBase&gt;&gt;&amp; adoptRule)</span>
315     : StyleRuleBase(type)
316 {
317     m_childRules.swap(adoptRule);
318 }
319 
<span class="line-modified">320 StyleRuleGroup::StyleRuleGroup(Type type, std::unique_ptr&lt;DeferredStyleGroupRuleList&gt;&amp;&amp; deferredRules)</span>
321     : StyleRuleBase(type)
322     , m_deferredRules(WTFMove(deferredRules))
323 {
324 }
325 
326 StyleRuleGroup::StyleRuleGroup(const StyleRuleGroup&amp; o)
327     : StyleRuleBase(o)
328 {
329     m_childRules.reserveInitialCapacity(o.childRules().size());
330     for (auto&amp; childRule : o.childRules())
331         m_childRules.uncheckedAppend(childRule-&gt;copy());
332 }
333 
334 const Vector&lt;RefPtr&lt;StyleRuleBase&gt;&gt;&amp; StyleRuleGroup::childRules() const
335 {
336     parseDeferredRulesIfNeeded();
337     return m_childRules;
338 }
339 
340 void StyleRuleGroup::wrapperInsertRule(unsigned index, Ref&lt;StyleRuleBase&gt;&amp;&amp; rule)
</pre>
<hr />
<pre>
342     parseDeferredRulesIfNeeded();
343     m_childRules.insert(index, WTFMove(rule));
344 }
345 
346 void StyleRuleGroup::wrapperRemoveRule(unsigned index)
347 {
348     parseDeferredRulesIfNeeded();
349     m_childRules.remove(index);
350 }
351 
352 void StyleRuleGroup::parseDeferredRulesIfNeeded() const
353 {
354     if (!m_deferredRules)
355         return;
356 
357     m_deferredRules-&gt;parseDeferredRules(m_childRules);
358     m_deferredRules = nullptr;
359 }
360 
361 StyleRuleMedia::StyleRuleMedia(Ref&lt;MediaQuerySet&gt;&amp;&amp; media, Vector&lt;RefPtr&lt;StyleRuleBase&gt;&gt;&amp; adoptRules)
<span class="line-modified">362     : StyleRuleGroup(Media, adoptRules)</span>
363     , m_mediaQueries(WTFMove(media))
364 {
365 }
366 
367 StyleRuleMedia::StyleRuleMedia(Ref&lt;MediaQuerySet&gt;&amp;&amp; media, std::unique_ptr&lt;DeferredStyleGroupRuleList&gt;&amp;&amp; deferredRules)
<span class="line-modified">368     : StyleRuleGroup(Media, WTFMove(deferredRules))</span>
369     , m_mediaQueries(WTFMove(media))
370 {
371 }
372 
373 StyleRuleMedia::StyleRuleMedia(const StyleRuleMedia&amp; o)
374     : StyleRuleGroup(o)
375 {
376     if (o.m_mediaQueries)
377         m_mediaQueries = o.m_mediaQueries-&gt;copy();
378 }
379 
380 
381 StyleRuleSupports::StyleRuleSupports(const String&amp; conditionText, bool conditionIsSupported, Vector&lt;RefPtr&lt;StyleRuleBase&gt;&gt;&amp; adoptRules)
<span class="line-modified">382     : StyleRuleGroup(Supports, adoptRules)</span>
383     , m_conditionText(conditionText)
384     , m_conditionIsSupported(conditionIsSupported)
385 {
386 }
387 
388 StyleRuleSupports::StyleRuleSupports(const String&amp; conditionText, bool conditionIsSupported,  std::unique_ptr&lt;DeferredStyleGroupRuleList&gt;&amp;&amp; deferredRules)
<span class="line-modified">389     : StyleRuleGroup(Supports, WTFMove(deferredRules))</span>
390     , m_conditionText(conditionText)
391     , m_conditionIsSupported(conditionIsSupported)
392 {
393 }
394 
395 StyleRuleSupports::StyleRuleSupports(const StyleRuleSupports&amp; o)
396     : StyleRuleGroup(o)
397     , m_conditionText(o.m_conditionText)
398     , m_conditionIsSupported(o.m_conditionIsSupported)
399 {
400 }
401 
402 #if ENABLE(CSS_DEVICE_ADAPTATION)
403 StyleRuleViewport::StyleRuleViewport(Ref&lt;StyleProperties&gt;&amp;&amp; properties)
<span class="line-modified">404     : StyleRuleBase(Viewport)</span>
405     , m_properties(WTFMove(properties))
406 {
407 }
408 
409 StyleRuleViewport::StyleRuleViewport(const StyleRuleViewport&amp; o)
410     : StyleRuleBase(o)
411     , m_properties(o.m_properties-&gt;mutableCopy())
412 {
413 }
414 
415 StyleRuleViewport::~StyleRuleViewport() = default;
416 
417 MutableStyleProperties&amp; StyleRuleViewport::mutableProperties()
418 {
419     if (!m_properties-&gt;isMutable())
420         m_properties = m_properties-&gt;mutableCopy();
421     return static_cast&lt;MutableStyleProperties&amp;&gt;(m_properties.get());
422 }
423 #endif // ENABLE(CSS_DEVICE_ADAPTATION)
424 
425 StyleRuleCharset::StyleRuleCharset()
<span class="line-modified">426     : StyleRuleBase(Charset)</span>
427 {
428 }
429 
430 StyleRuleCharset::StyleRuleCharset(const StyleRuleCharset&amp; o)
431     : StyleRuleBase(o)
432 {
433 }
434 
435 StyleRuleCharset::~StyleRuleCharset() = default;
436 
437 StyleRuleNamespace::StyleRuleNamespace(AtomString prefix, AtomString uri)
<span class="line-modified">438     : StyleRuleBase(Namespace)</span>
439     , m_prefix(prefix)
440     , m_uri(uri)
441 {
442 }
443 
444 StyleRuleNamespace::StyleRuleNamespace(const StyleRuleNamespace&amp; o)
445     : StyleRuleBase(o)
446     , m_prefix(o.m_prefix)
447     , m_uri(o.m_uri)
448 {
449 }
450 
451 StyleRuleNamespace::~StyleRuleNamespace() = default;
452 
453 } // namespace WebCore
</pre>
</td>
<td>
<hr />
<pre>
 28 #include &quot;CSSKeyframeRule.h&quot;
 29 #include &quot;CSSKeyframesRule.h&quot;
 30 #include &quot;CSSMediaRule.h&quot;
 31 #include &quot;CSSNamespaceRule.h&quot;
 32 #include &quot;CSSPageRule.h&quot;
 33 #include &quot;CSSStyleRule.h&quot;
 34 #include &quot;CSSSupportsRule.h&quot;
 35 #include &quot;MediaList.h&quot;
 36 #include &quot;StyleProperties.h&quot;
 37 #include &quot;StyleRuleImport.h&quot;
 38 #include &quot;WebKitCSSViewportRule.h&quot;
 39 
 40 namespace WebCore {
 41 
 42 struct SameSizeAsStyleRuleBase : public WTF::RefCountedBase {
 43     unsigned bitfields : 5;
 44 };
 45 
 46 COMPILE_ASSERT(sizeof(StyleRuleBase) == sizeof(SameSizeAsStyleRuleBase), StyleRuleBase_should_stay_small);
 47 
<span class="line-added"> 48 DEFINE_ALLOCATOR_WITH_HEAP_IDENTIFIER(StyleRuleBase);</span>
<span class="line-added"> 49 DEFINE_ALLOCATOR_WITH_HEAP_IDENTIFIER(StyleRule);</span>
<span class="line-added"> 50 </span>
 51 Ref&lt;CSSRule&gt; StyleRuleBase::createCSSOMWrapper(CSSStyleSheet* parentSheet) const
 52 {
 53     return createCSSOMWrapper(parentSheet, nullptr);
 54 }
 55 
 56 Ref&lt;CSSRule&gt; StyleRuleBase::createCSSOMWrapper(CSSRule* parentRule) const
 57 {
 58     return createCSSOMWrapper(nullptr, parentRule);
 59 }
 60 
 61 void StyleRuleBase::destroy()
 62 {
 63     switch (type()) {
<span class="line-modified"> 64     case StyleRuleType::Style:</span>
 65         delete downcast&lt;StyleRule&gt;(this);
 66         return;
<span class="line-modified"> 67     case StyleRuleType::Page:</span>
 68         delete downcast&lt;StyleRulePage&gt;(this);
 69         return;
<span class="line-modified"> 70     case StyleRuleType::FontFace:</span>
 71         delete downcast&lt;StyleRuleFontFace&gt;(this);
 72         return;
<span class="line-modified"> 73     case StyleRuleType::Media:</span>
 74         delete downcast&lt;StyleRuleMedia&gt;(this);
 75         return;
<span class="line-modified"> 76     case StyleRuleType::Supports:</span>
 77         delete downcast&lt;StyleRuleSupports&gt;(this);
 78         return;
<span class="line-modified"> 79     case StyleRuleType::Import:</span>
 80         delete downcast&lt;StyleRuleImport&gt;(this);
 81         return;
<span class="line-modified"> 82     case StyleRuleType::Keyframes:</span>
 83         delete downcast&lt;StyleRuleKeyframes&gt;(this);
 84         return;
 85 #if ENABLE(CSS_DEVICE_ADAPTATION)
<span class="line-modified"> 86     case StyleRuleType::Viewport:</span>
 87         delete downcast&lt;StyleRuleViewport&gt;(this);
 88         return;
 89 #endif
<span class="line-modified"> 90     case StyleRuleType::Namespace:</span>
 91         delete downcast&lt;StyleRuleNamespace&gt;(this);
 92         return;
<span class="line-modified"> 93     case StyleRuleType::Keyframe:</span>
 94         delete downcast&lt;StyleRuleKeyframe&gt;(this);
 95         return;
<span class="line-modified"> 96     case StyleRuleType::Charset:</span>
 97         delete downcast&lt;StyleRuleCharset&gt;(this);
 98         return;
<span class="line-modified"> 99     case StyleRuleType::Unknown:</span>
100         ASSERT_NOT_REACHED();
101         return;
102     }
103     ASSERT_NOT_REACHED();
104 }
105 
106 Ref&lt;StyleRuleBase&gt; StyleRuleBase::copy() const
107 {
108     switch (type()) {
<span class="line-modified">109     case StyleRuleType::Style:</span>
110         return downcast&lt;StyleRule&gt;(*this).copy();
<span class="line-modified">111     case StyleRuleType::Page:</span>
112         return downcast&lt;StyleRulePage&gt;(*this).copy();
<span class="line-modified">113     case StyleRuleType::FontFace:</span>
114         return downcast&lt;StyleRuleFontFace&gt;(*this).copy();
<span class="line-modified">115     case StyleRuleType::Media:</span>
116         return downcast&lt;StyleRuleMedia&gt;(*this).copy();
<span class="line-modified">117     case StyleRuleType::Supports:</span>
118         return downcast&lt;StyleRuleSupports&gt;(*this).copy();
<span class="line-modified">119     case StyleRuleType::Keyframes:</span>
120         return downcast&lt;StyleRuleKeyframes&gt;(*this).copy();
121 #if ENABLE(CSS_DEVICE_ADAPTATION)
<span class="line-modified">122     case StyleRuleType::Viewport:</span>
123         return downcast&lt;StyleRuleViewport&gt;(*this).copy();
124 #endif
<span class="line-modified">125     case StyleRuleType::Import:</span>
<span class="line-modified">126     case StyleRuleType::Namespace:</span>
127         // FIXME: Copy import and namespace rules.
128         break;
<span class="line-modified">129     case StyleRuleType::Unknown:</span>
<span class="line-modified">130     case StyleRuleType::Charset:</span>
<span class="line-modified">131     case StyleRuleType::Keyframe:</span>
132         break;
133     }
134     CRASH();
135 }
136 
137 Ref&lt;CSSRule&gt; StyleRuleBase::createCSSOMWrapper(CSSStyleSheet* parentSheet, CSSRule* parentRule) const
138 {
139     RefPtr&lt;CSSRule&gt; rule;
140     StyleRuleBase&amp; self = const_cast&lt;StyleRuleBase&amp;&gt;(*this);
141     switch (type()) {
<span class="line-modified">142     case StyleRuleType::Style:</span>
143         rule = CSSStyleRule::create(downcast&lt;StyleRule&gt;(self), parentSheet);
144         break;
<span class="line-modified">145     case StyleRuleType::Page:</span>
146         rule = CSSPageRule::create(downcast&lt;StyleRulePage&gt;(self), parentSheet);
147         break;
<span class="line-modified">148     case StyleRuleType::FontFace:</span>
149         rule = CSSFontFaceRule::create(downcast&lt;StyleRuleFontFace&gt;(self), parentSheet);
150         break;
<span class="line-modified">151     case StyleRuleType::Media:</span>
152         rule = CSSMediaRule::create(downcast&lt;StyleRuleMedia&gt;(self), parentSheet);
153         break;
<span class="line-modified">154     case StyleRuleType::Supports:</span>
155         rule = CSSSupportsRule::create(downcast&lt;StyleRuleSupports&gt;(self), parentSheet);
156         break;
<span class="line-modified">157     case StyleRuleType::Import:</span>
158         rule = CSSImportRule::create(downcast&lt;StyleRuleImport&gt;(self), parentSheet);
159         break;
<span class="line-modified">160     case StyleRuleType::Keyframes:</span>
161         rule = CSSKeyframesRule::create(downcast&lt;StyleRuleKeyframes&gt;(self), parentSheet);
162         break;
163 #if ENABLE(CSS_DEVICE_ADAPTATION)
<span class="line-modified">164     case StyleRuleType::Viewport:</span>
165         rule = WebKitCSSViewportRule::create(downcast&lt;StyleRuleViewport&gt;(self), parentSheet);
166         break;
167 #endif
<span class="line-modified">168     case StyleRuleType::Namespace:</span>
169         rule = CSSNamespaceRule::create(downcast&lt;StyleRuleNamespace&gt;(self), parentSheet);
170         break;
<span class="line-modified">171     case StyleRuleType::Unknown:</span>
<span class="line-modified">172     case StyleRuleType::Charset:</span>
<span class="line-modified">173     case StyleRuleType::Keyframe:</span>
174         ASSERT_NOT_REACHED();
175         break;
176     }
177     ASSERT(rule);
178 
179     if (parentRule)
180         rule-&gt;setParentRule(parentRule);
181     return rule.releaseNonNull();
182 }
183 
184 unsigned StyleRule::averageSizeInBytes()
185 {
186     return sizeof(StyleRule) + sizeof(CSSSelector) + StyleProperties::averageSizeInBytes();
187 }
188 
189 StyleRule::StyleRule(Ref&lt;StylePropertiesBase&gt;&amp;&amp; properties, bool hasDocumentSecurityOrigin, CSSSelectorList&amp;&amp; selectors)
<span class="line-modified">190     : StyleRuleBase(StyleRuleType::Style, hasDocumentSecurityOrigin)</span>
191     , m_properties(WTFMove(properties))
192     , m_selectorList(WTFMove(selectors))
193 {
194 }
195 
196 StyleRule::StyleRule(const StyleRule&amp; o)
197     : StyleRuleBase(o)
198     , m_properties(o.properties().mutableCopy())
199     , m_selectorList(o.m_selectorList)
200 {
201 }
202 
203 StyleRule::~StyleRule() = default;
204 
205 const StyleProperties&amp; StyleRule::properties() const
206 {
207     if (m_properties-&gt;type() == DeferredPropertiesType)
208         m_properties = downcast&lt;DeferredStyleProperties&gt;(m_properties.get()).parseDeferredProperties();
209     return downcast&lt;StyleProperties&gt;(m_properties.get());
210 }
</pre>
<hr />
<pre>
236     for (const CSSSelector* selector = selectorList().first(); selector; selector = CSSSelectorList::next(selector)) {
237         Vector&lt;const CSSSelector*, 8&gt; componentsInThisSelector;
238         for (const CSSSelector* component = selector; component; component = component-&gt;tagHistory())
239             componentsInThisSelector.append(component);
240 
241         if (componentsInThisSelector.size() + componentsSinceLastSplit.size() &gt; maxCount &amp;&amp; !componentsSinceLastSplit.isEmpty()) {
242             rules.append(createForSplitting(componentsSinceLastSplit, const_cast&lt;StyleProperties&amp;&gt;(properties()), hasDocumentSecurityOrigin()));
243             componentsSinceLastSplit.clear();
244         }
245 
246         componentsSinceLastSplit.appendVector(componentsInThisSelector);
247     }
248 
249     if (!componentsSinceLastSplit.isEmpty())
250         rules.append(createForSplitting(componentsSinceLastSplit, const_cast&lt;StyleProperties&amp;&gt;(properties()), hasDocumentSecurityOrigin()));
251 
252     return rules;
253 }
254 
255 StyleRulePage::StyleRulePage(Ref&lt;StyleProperties&gt;&amp;&amp; properties, CSSSelectorList&amp;&amp; selectors)
<span class="line-modified">256     : StyleRuleBase(StyleRuleType::Page)</span>
257     , m_properties(WTFMove(properties))
258     , m_selectorList(WTFMove(selectors))
259 {
260 }
261 
262 StyleRulePage::StyleRulePage(const StyleRulePage&amp; o)
263     : StyleRuleBase(o)
264     , m_properties(o.m_properties-&gt;mutableCopy())
265     , m_selectorList(o.m_selectorList)
266 {
267 }
268 
269 StyleRulePage::~StyleRulePage() = default;
270 
271 MutableStyleProperties&amp; StyleRulePage::mutableProperties()
272 {
273     if (!is&lt;MutableStyleProperties&gt;(m_properties.get()))
274         m_properties = m_properties-&gt;mutableCopy();
275     return downcast&lt;MutableStyleProperties&gt;(m_properties.get());
276 }
277 
278 StyleRuleFontFace::StyleRuleFontFace(Ref&lt;StyleProperties&gt;&amp;&amp; properties)
<span class="line-modified">279     : StyleRuleBase(StyleRuleType::FontFace)</span>
280     , m_properties(WTFMove(properties))
281 {
282 }
283 
284 StyleRuleFontFace::StyleRuleFontFace(const StyleRuleFontFace&amp; o)
285     : StyleRuleBase(o)
286     , m_properties(o.m_properties-&gt;mutableCopy())
287 {
288 }
289 
290 StyleRuleFontFace::~StyleRuleFontFace() = default;
291 
292 MutableStyleProperties&amp; StyleRuleFontFace::mutableProperties()
293 {
294     if (!is&lt;MutableStyleProperties&gt;(m_properties.get()))
295         m_properties = m_properties-&gt;mutableCopy();
296     return downcast&lt;MutableStyleProperties&gt;(m_properties.get());
297 }
298 
299 DeferredStyleGroupRuleList::DeferredStyleGroupRuleList(const CSSParserTokenRange&amp; range, CSSDeferredParser&amp; parser)
300     : m_parser(parser)
301 {
302     size_t length = range.end() - range.begin();
303     m_tokens.reserveCapacity(length);
304     m_tokens.append(range.begin(), length);
305 }
306 
307 void DeferredStyleGroupRuleList::parseDeferredRules(Vector&lt;RefPtr&lt;StyleRuleBase&gt;&gt;&amp; childRules)
308 {
309     m_parser-&gt;parseRuleList(m_tokens, childRules);
310 }
311 
312 void DeferredStyleGroupRuleList::parseDeferredKeyframes(StyleRuleKeyframes&amp; keyframesRule)
313 {
314     m_parser-&gt;parseKeyframeList(m_tokens, keyframesRule);
315 }
316 
<span class="line-modified">317 StyleRuleGroup::StyleRuleGroup(StyleRuleType type, Vector&lt;RefPtr&lt;StyleRuleBase&gt;&gt;&amp; adoptRule)</span>
318     : StyleRuleBase(type)
319 {
320     m_childRules.swap(adoptRule);
321 }
322 
<span class="line-modified">323 StyleRuleGroup::StyleRuleGroup(StyleRuleType type, std::unique_ptr&lt;DeferredStyleGroupRuleList&gt;&amp;&amp; deferredRules)</span>
324     : StyleRuleBase(type)
325     , m_deferredRules(WTFMove(deferredRules))
326 {
327 }
328 
329 StyleRuleGroup::StyleRuleGroup(const StyleRuleGroup&amp; o)
330     : StyleRuleBase(o)
331 {
332     m_childRules.reserveInitialCapacity(o.childRules().size());
333     for (auto&amp; childRule : o.childRules())
334         m_childRules.uncheckedAppend(childRule-&gt;copy());
335 }
336 
337 const Vector&lt;RefPtr&lt;StyleRuleBase&gt;&gt;&amp; StyleRuleGroup::childRules() const
338 {
339     parseDeferredRulesIfNeeded();
340     return m_childRules;
341 }
342 
343 void StyleRuleGroup::wrapperInsertRule(unsigned index, Ref&lt;StyleRuleBase&gt;&amp;&amp; rule)
</pre>
<hr />
<pre>
345     parseDeferredRulesIfNeeded();
346     m_childRules.insert(index, WTFMove(rule));
347 }
348 
349 void StyleRuleGroup::wrapperRemoveRule(unsigned index)
350 {
351     parseDeferredRulesIfNeeded();
352     m_childRules.remove(index);
353 }
354 
355 void StyleRuleGroup::parseDeferredRulesIfNeeded() const
356 {
357     if (!m_deferredRules)
358         return;
359 
360     m_deferredRules-&gt;parseDeferredRules(m_childRules);
361     m_deferredRules = nullptr;
362 }
363 
364 StyleRuleMedia::StyleRuleMedia(Ref&lt;MediaQuerySet&gt;&amp;&amp; media, Vector&lt;RefPtr&lt;StyleRuleBase&gt;&gt;&amp; adoptRules)
<span class="line-modified">365     : StyleRuleGroup(StyleRuleType::Media, adoptRules)</span>
366     , m_mediaQueries(WTFMove(media))
367 {
368 }
369 
370 StyleRuleMedia::StyleRuleMedia(Ref&lt;MediaQuerySet&gt;&amp;&amp; media, std::unique_ptr&lt;DeferredStyleGroupRuleList&gt;&amp;&amp; deferredRules)
<span class="line-modified">371     : StyleRuleGroup(StyleRuleType::Media, WTFMove(deferredRules))</span>
372     , m_mediaQueries(WTFMove(media))
373 {
374 }
375 
376 StyleRuleMedia::StyleRuleMedia(const StyleRuleMedia&amp; o)
377     : StyleRuleGroup(o)
378 {
379     if (o.m_mediaQueries)
380         m_mediaQueries = o.m_mediaQueries-&gt;copy();
381 }
382 
383 
384 StyleRuleSupports::StyleRuleSupports(const String&amp; conditionText, bool conditionIsSupported, Vector&lt;RefPtr&lt;StyleRuleBase&gt;&gt;&amp; adoptRules)
<span class="line-modified">385     : StyleRuleGroup(StyleRuleType::Supports, adoptRules)</span>
386     , m_conditionText(conditionText)
387     , m_conditionIsSupported(conditionIsSupported)
388 {
389 }
390 
391 StyleRuleSupports::StyleRuleSupports(const String&amp; conditionText, bool conditionIsSupported,  std::unique_ptr&lt;DeferredStyleGroupRuleList&gt;&amp;&amp; deferredRules)
<span class="line-modified">392     : StyleRuleGroup(StyleRuleType::Supports, WTFMove(deferredRules))</span>
393     , m_conditionText(conditionText)
394     , m_conditionIsSupported(conditionIsSupported)
395 {
396 }
397 
398 StyleRuleSupports::StyleRuleSupports(const StyleRuleSupports&amp; o)
399     : StyleRuleGroup(o)
400     , m_conditionText(o.m_conditionText)
401     , m_conditionIsSupported(o.m_conditionIsSupported)
402 {
403 }
404 
405 #if ENABLE(CSS_DEVICE_ADAPTATION)
406 StyleRuleViewport::StyleRuleViewport(Ref&lt;StyleProperties&gt;&amp;&amp; properties)
<span class="line-modified">407     : StyleRuleBase(StyleRuleType::Viewport)</span>
408     , m_properties(WTFMove(properties))
409 {
410 }
411 
412 StyleRuleViewport::StyleRuleViewport(const StyleRuleViewport&amp; o)
413     : StyleRuleBase(o)
414     , m_properties(o.m_properties-&gt;mutableCopy())
415 {
416 }
417 
418 StyleRuleViewport::~StyleRuleViewport() = default;
419 
420 MutableStyleProperties&amp; StyleRuleViewport::mutableProperties()
421 {
422     if (!m_properties-&gt;isMutable())
423         m_properties = m_properties-&gt;mutableCopy();
424     return static_cast&lt;MutableStyleProperties&amp;&gt;(m_properties.get());
425 }
426 #endif // ENABLE(CSS_DEVICE_ADAPTATION)
427 
428 StyleRuleCharset::StyleRuleCharset()
<span class="line-modified">429     : StyleRuleBase(StyleRuleType::Charset)</span>
430 {
431 }
432 
433 StyleRuleCharset::StyleRuleCharset(const StyleRuleCharset&amp; o)
434     : StyleRuleBase(o)
435 {
436 }
437 
438 StyleRuleCharset::~StyleRuleCharset() = default;
439 
440 StyleRuleNamespace::StyleRuleNamespace(AtomString prefix, AtomString uri)
<span class="line-modified">441     : StyleRuleBase(StyleRuleType::Namespace)</span>
442     , m_prefix(prefix)
443     , m_uri(uri)
444 {
445 }
446 
447 StyleRuleNamespace::StyleRuleNamespace(const StyleRuleNamespace&amp; o)
448     : StyleRuleBase(o)
449     , m_prefix(o.m_prefix)
450     , m_uri(o.m_uri)
451 {
452 }
453 
454 StyleRuleNamespace::~StyleRuleNamespace() = default;
455 
456 } // namespace WebCore
</pre>
</td>
</tr>
</table>
<center><a href="StyleProperties.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="StyleRule.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>