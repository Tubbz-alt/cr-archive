<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WebCore/inspector/agents/page/PageRuntimeAgent.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="PageNetworkAgent.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="PageRuntimeAgent.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/inspector/agents/page/PageRuntimeAgent.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -30,33 +30,35 @@</span>
   */
  
  #include &quot;config.h&quot;
  #include &quot;PageRuntimeAgent.h&quot;
  
<span class="udiff-line-modified-removed">- #include &quot;Chrome.h&quot;</span>
<span class="udiff-line-removed">- #include &quot;ChromeClient.h&quot;</span>
<span class="udiff-line-modified-added">+ #include &quot;DOMWrapperWorld.h&quot;</span>
  #include &quot;Document.h&quot;
  #include &quot;Frame.h&quot;
  #include &quot;InspectorPageAgent.h&quot;
  #include &quot;InstrumentingAgents.h&quot;
  #include &quot;JSDOMWindowBase.h&quot;
  #include &quot;Page.h&quot;
  #include &quot;PageConsoleClient.h&quot;
  #include &quot;ScriptController.h&quot;
  #include &quot;ScriptState.h&quot;
  #include &quot;SecurityOrigin.h&quot;
<span class="udiff-line-modified-removed">- #include &quot;UserGestureIndicator.h&quot;</span>
<span class="udiff-line-modified-added">+ #include &quot;UserGestureEmulationScope.h&quot;</span>
  #include &lt;JavaScriptCore/InjectedScript.h&gt;
  #include &lt;JavaScriptCore/InjectedScriptManager.h&gt;
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-removed">- using Inspector::Protocol::Runtime::ExecutionContextDescription;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-modified-added">+ #include &lt;JavaScriptCore/InspectorProtocolObjects.h&gt;</span>
  
  namespace WebCore {
  
  using namespace Inspector;
  
<span class="udiff-line-added">+ static bool asBool(const bool* b)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     return b &amp;&amp; *b;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  PageRuntimeAgent::PageRuntimeAgent(PageAgentContext&amp; context)
      : InspectorRuntimeAgent(context)
      , m_frontendDispatcher(makeUnique&lt;Inspector::RuntimeFrontendDispatcher&gt;(context.frontendRouter))
      , m_backendDispatcher(Inspector::RuntimeBackendDispatcher::create(context.backendDispatcher, this))
      , m_instrumentingAgents(context.instrumentingAgents)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -66,42 +68,50 @@</span>
  
  PageRuntimeAgent::~PageRuntimeAgent() = default;
  
  void PageRuntimeAgent::enable(ErrorString&amp; errorString)
  {
<span class="udiff-line-modified-removed">-     bool enabled = m_instrumentingAgents.pageRuntimeAgent() == this;</span>
<span class="udiff-line-modified-added">+     if (m_instrumentingAgents.pageRuntimeAgent() == this)</span>
<span class="udiff-line-added">+         return;</span>
  
      InspectorRuntimeAgent::enable(errorString);
<span class="udiff-line-added">+     if (!errorString.isEmpty())</span>
<span class="udiff-line-added">+         return;</span>
  
<span class="udiff-line-modified-removed">-     m_instrumentingAgents.setPageRuntimeAgent(this);</span>
<span class="udiff-line-modified-added">+     // Report initial contexts before enabling instrumentation as the reporting</span>
<span class="udiff-line-added">+     // can force creation of script state which could result in duplicate notifications.</span>
<span class="udiff-line-added">+     reportExecutionContextCreation();</span>
  
<span class="udiff-line-modified-removed">-     if (!enabled)</span>
<span class="udiff-line-removed">-         reportExecutionContextCreation();</span>
<span class="udiff-line-modified-added">+     m_instrumentingAgents.setPageRuntimeAgent(this);</span>
  }
  
  void PageRuntimeAgent::disable(ErrorString&amp; errorString)
  {
      m_instrumentingAgents.setPageRuntimeAgent(nullptr);
  
      InspectorRuntimeAgent::disable(errorString);
  }
  
<span class="udiff-line-modified-removed">- void PageRuntimeAgent::didCreateMainWorldContext(Frame&amp; frame)</span>
<span class="udiff-line-modified-added">+ void PageRuntimeAgent::frameNavigated(Frame&amp; frame)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     // Ensure execution context is created for the frame even if it doesn&#39;t have scripts.</span>
<span class="udiff-line-added">+     mainWorldExecState(&amp;frame);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void PageRuntimeAgent::didClearWindowObjectInWorld(Frame&amp; frame, DOMWrapperWorld&amp; world)</span>
  {
      auto* pageAgent = m_instrumentingAgents.inspectorPageAgent();
      if (!pageAgent)
          return;
  
<span class="udiff-line-modified-removed">-     auto frameId = pageAgent-&gt;frameId(&amp;frame);</span>
<span class="udiff-line-removed">-     auto* scriptState = mainWorldExecState(&amp;frame);</span>
<span class="udiff-line-removed">-     notifyContextCreated(frameId, scriptState, nullptr, true);</span>
<span class="udiff-line-modified-added">+     notifyContextCreated(pageAgent-&gt;frameId(&amp;frame), frame.script().globalObject(world), world);</span>
  }
  
  InjectedScript PageRuntimeAgent::injectedScriptForEval(ErrorString&amp; errorString, const int* executionContextId)
  {
      if (!executionContextId) {
<span class="udiff-line-modified-removed">-         JSC::ExecState* scriptState = mainWorldExecState(&amp;m_inspectedPage.mainFrame());</span>
<span class="udiff-line-modified-added">+         JSC::JSGlobalObject* scriptState = mainWorldExecState(&amp;m_inspectedPage.mainFrame());</span>
          InjectedScript result = injectedScriptManager().injectedScriptFor(scriptState);
          if (result.hasNoValue())
              errorString = &quot;Internal error: main world execution context not found&quot;_s;
          return result;
      }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -126,64 +136,72 @@</span>
  {
      auto* pageAgent = m_instrumentingAgents.inspectorPageAgent();
      if (!pageAgent)
          return;
  
<span class="udiff-line-modified-removed">-     Vector&lt;std::pair&lt;JSC::ExecState*, SecurityOrigin*&gt;&gt; isolatedContexts;</span>
<span class="udiff-line-removed">-     for (Frame* frame = &amp;m_inspectedPage.mainFrame(); frame; frame = frame-&gt;tree().traverseNext()) {</span>
<span class="udiff-line-modified-added">+     for (auto* frame = &amp;m_inspectedPage.mainFrame(); frame; frame = frame-&gt;tree().traverseNext()) {</span>
          if (!frame-&gt;script().canExecuteScripts(NotAboutToExecuteScript))
              continue;
  
<span class="udiff-line-modified-removed">-         String frameId = pageAgent-&gt;frameId(frame);</span>
<span class="udiff-line-modified-added">+         auto frameId = pageAgent-&gt;frameId(frame);</span>
  
<span class="udiff-line-modified-removed">-         JSC::ExecState* scriptState = mainWorldExecState(frame);</span>
<span class="udiff-line-modified-removed">-         notifyContextCreated(frameId, scriptState, nullptr, true);</span>
<span class="udiff-line-modified-removed">-         frame-&gt;script().collectIsolatedContexts(isolatedContexts);</span>
<span class="udiff-line-modified-removed">-         if (isolatedContexts.isEmpty())</span>
<span class="udiff-line-modified-removed">-             continue;</span>
<span class="udiff-line-modified-removed">-         for (auto&amp; context : isolatedContexts)</span>
<span class="udiff-line-modified-removed">-             notifyContextCreated(frameId, context.first, context.second, false);</span>
<span class="udiff-line-modified-removed">-         isolatedContexts.clear();</span>
<span class="udiff-line-modified-added">+         // Always send the main world first.</span>
<span class="udiff-line-modified-added">+         auto* mainGlobalObject = mainWorldExecState(frame);</span>
<span class="udiff-line-modified-added">+         notifyContextCreated(frameId, mainGlobalObject, mainThreadNormalWorld());</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+         for (auto&amp; jsWindowProxy : frame-&gt;windowProxy().jsWindowProxiesAsVector()) {</span>
<span class="udiff-line-modified-added">+             auto* globalObject = jsWindowProxy-&gt;window();</span>
<span class="udiff-line-modified-added">+             if (globalObject == mainGlobalObject)</span>
<span class="udiff-line-modified-added">+                 continue;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             auto&amp; securityOrigin = downcast&lt;DOMWindow&gt;(jsWindowProxy-&gt;wrapped()).document()-&gt;securityOrigin();</span>
<span class="udiff-line-added">+             notifyContextCreated(frameId, globalObject, jsWindowProxy-&gt;world(), &amp;securityOrigin);</span>
<span class="udiff-line-added">+         }</span>
      }
  }
  
<span class="udiff-line-modified-removed">- void PageRuntimeAgent::notifyContextCreated(const String&amp; frameId, JSC::ExecState* scriptState, SecurityOrigin* securityOrigin, bool isPageContext)</span>
<span class="udiff-line-modified-added">+ static Inspector::Protocol::Runtime::ExecutionContextType toProtocol(DOMWrapperWorld::Type type)</span>
  {
<span class="udiff-line-modified-removed">-     ASSERT(securityOrigin || isPageContext);</span>
<span class="udiff-line-modified-added">+     switch (type) {</span>
<span class="udiff-line-added">+     case DOMWrapperWorld::Type::Normal:</span>
<span class="udiff-line-added">+         return Inspector::Protocol::Runtime::ExecutionContextType::Normal;</span>
<span class="udiff-line-added">+     case DOMWrapperWorld::Type::User:</span>
<span class="udiff-line-added">+         return Inspector::Protocol::Runtime::ExecutionContextType::User;</span>
<span class="udiff-line-added">+     case DOMWrapperWorld::Type::Internal:</span>
<span class="udiff-line-added">+         return Inspector::Protocol::Runtime::ExecutionContextType::Internal;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     ASSERT_NOT_REACHED();</span>
<span class="udiff-line-added">+     return Inspector::Protocol::Runtime::ExecutionContextType::Internal;</span>
<span class="udiff-line-added">+ }</span>
  
<span class="udiff-line-modified-removed">-     InjectedScript result = injectedScriptManager().injectedScriptFor(scriptState);</span>
<span class="udiff-line-modified-removed">-     if (result.hasNoValue())</span>
<span class="udiff-line-modified-added">+ void PageRuntimeAgent::notifyContextCreated(const String&amp; frameId, JSC::JSGlobalObject* globalObject, const DOMWrapperWorld&amp; world, SecurityOrigin* securityOrigin)</span>
<span class="udiff-line-modified-added">+ {</span>
<span class="udiff-line-added">+     auto injectedScript = injectedScriptManager().injectedScriptFor(globalObject);</span>
<span class="udiff-line-added">+     if (injectedScript.hasNoValue())</span>
          return;
  
<span class="udiff-line-modified-removed">-     int executionContextId = injectedScriptManager().injectedScriptIdFor(scriptState);</span>
<span class="udiff-line-modified-removed">-     String name = securityOrigin ? securityOrigin-&gt;toRawString() : String();</span>
<span class="udiff-line-modified-removed">-     m_frontendDispatcher-&gt;executionContextCreated(ExecutionContextDescription::create()</span>
<span class="udiff-line-modified-removed">-         .setId(executionContextId)</span>
<span class="udiff-line-modified-removed">-         .setIsPageContext(isPageContext)</span>
<span class="udiff-line-modified-added">+     auto name = world.name();</span>
<span class="udiff-line-modified-added">+     if (name.isEmpty() &amp;&amp; securityOrigin)</span>
<span class="udiff-line-modified-added">+         name = securityOrigin-&gt;toRawString();</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+     m_frontendDispatcher-&gt;executionContextCreated(Inspector::Protocol::Runtime::ExecutionContextDescription::create()</span>
<span class="udiff-line-added">+         .setId(injectedScriptManager().injectedScriptIdFor(globalObject))</span>
<span class="udiff-line-added">+         .setType(toProtocol(world.type()))</span>
          .setName(name)
          .setFrameId(frameId)
          .release());
  }
  
  void PageRuntimeAgent::evaluate(ErrorString&amp; errorString, const String&amp; expression, const String* objectGroup, const bool* includeCommandLineAPI, const bool* doNotPauseOnExceptionsAndMuteConsole, const int* executionContextId, const bool* returnByValue, const bool* generatePreview, const bool* saveResult, const bool* emulateUserGesture, RefPtr&lt;Inspector::Protocol::Runtime::RemoteObject&gt;&amp; result, Optional&lt;bool&gt;&amp; wasThrown, Optional&lt;int&gt;&amp; savedResultIndex)
  {
<span class="udiff-line-modified-removed">-     auto&amp; pageChromeClient = m_inspectedPage.chrome().client();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     auto shouldEmulateUserGesture = emulateUserGesture &amp;&amp; *emulateUserGesture;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     Optional&lt;ProcessingUserGestureState&gt; userGestureState = shouldEmulateUserGesture ? Optional&lt;ProcessingUserGestureState&gt;(ProcessingUserGesture) : WTF::nullopt;</span>
<span class="udiff-line-removed">-     UserGestureIndicator gestureIndicator(userGestureState);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     bool userWasInteracting = false;</span>
<span class="udiff-line-removed">-     if (shouldEmulateUserGesture) {</span>
<span class="udiff-line-removed">-         userWasInteracting = pageChromeClient.userIsInteracting();</span>
<span class="udiff-line-removed">-         if (!userWasInteracting)</span>
<span class="udiff-line-removed">-             pageChromeClient.setUserIsInteracting(true);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-modified-added">+     UserGestureEmulationScope userGestureScope(m_inspectedPage, asBool(emulateUserGesture));</span>
      InspectorRuntimeAgent::evaluate(errorString, expression, objectGroup, includeCommandLineAPI, doNotPauseOnExceptionsAndMuteConsole, executionContextId, returnByValue, generatePreview, saveResult, emulateUserGesture, result, wasThrown, savedResultIndex);
<span class="udiff-line-added">+ }</span>
  
<span class="udiff-line-modified-removed">-     if (shouldEmulateUserGesture &amp;&amp; !userWasInteracting &amp;&amp; pageChromeClient.userIsInteracting())</span>
<span class="udiff-line-modified-removed">-         pageChromeClient.setUserIsInteracting(false);</span>
<span class="udiff-line-modified-added">+ void PageRuntimeAgent::callFunctionOn(ErrorString&amp; errorString, const String&amp; objectId, const String&amp; expression, const JSON::Array* optionalArguments, const bool* doNotPauseOnExceptionsAndMuteConsole, const bool* returnByValue, const bool* generatePreview, const bool* emulateUserGesture, RefPtr&lt;Inspector::Protocol::Runtime::RemoteObject&gt;&amp; result, Optional&lt;bool&gt;&amp; wasThrown)</span>
<span class="udiff-line-modified-added">+ {</span>
<span class="udiff-line-added">+     UserGestureEmulationScope userGestureScope(m_inspectedPage, asBool(emulateUserGesture));</span>
<span class="udiff-line-added">+     InspectorRuntimeAgent::callFunctionOn(errorString, objectId, expression, optionalArguments, doNotPauseOnExceptionsAndMuteConsole, returnByValue, generatePreview, emulateUserGesture, result, wasThrown);</span>
  }
  
  } // namespace WebCore
</pre>
<center><a href="PageNetworkAgent.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="PageRuntimeAgent.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>