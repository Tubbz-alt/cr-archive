<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/JavaScriptCore/dfg/DFGSlowPathGenerator.h</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (C) 2012-2018 Apple Inc. All rights reserved.
  3  *
  4  * Redistribution and use in source and binary forms, with or without
  5  * modification, are permitted provided that the following conditions
  6  * are met:
  7  * 1. Redistributions of source code must retain the above copyright
  8  *    notice, this list of conditions and the following disclaimer.
  9  * 2. Redistributions in binary form must reproduce the above copyright
 10  *    notice, this list of conditions and the following disclaimer in the
 11  *    documentation and/or other materials provided with the distribution.
 12  *
 13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. ``AS IS&#39;&#39; AND ANY
 14  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 15  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 16  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE INC. OR
 17  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 18  * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 19  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 20  * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 21  * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 22  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 23  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #pragma once
 27 
 28 #if ENABLE(DFG_JIT)
 29 
 30 #include &quot;DFGSilentRegisterSavePlan.h&quot;
 31 #include &quot;DFGSpeculativeJIT.h&quot;
 32 #include &lt;wtf/FastMalloc.h&gt;
 33 #include &lt;wtf/FunctionTraits.h&gt;
 34 
 35 namespace JSC { namespace DFG {
 36 
 37 class SlowPathGenerator {
 38     WTF_MAKE_FAST_ALLOCATED;
 39 public:
 40     SlowPathGenerator(SpeculativeJIT* jit)
 41         : m_currentNode(jit-&gt;m_currentNode)
 42         , m_streamIndex(jit-&gt;m_stream-&gt;size())
 43         , m_origin(jit-&gt;m_origin)
 44     {
 45     }
 46     virtual ~SlowPathGenerator() { }
 47     void generate(SpeculativeJIT* jit)
 48     {
 49         m_label = jit-&gt;m_jit.label();
 50         jit-&gt;m_currentNode = m_currentNode;
 51         jit-&gt;m_outOfLineStreamIndex = m_streamIndex;
 52         jit-&gt;m_origin = m_origin;
 53         generateInternal(jit);
 54         jit-&gt;m_outOfLineStreamIndex = WTF::nullopt;
<a name="1" id="anc1"></a><span class="line-modified"> 55         if (ASSERT_ENABLED)</span>
 56             jit-&gt;m_jit.abortWithReason(DFGSlowPathGeneratorFellThrough);
 57     }
 58     MacroAssembler::Label label() const { return m_label; }
 59     virtual MacroAssembler::Call call() const
 60     {
 61         RELEASE_ASSERT_NOT_REACHED(); // By default slow path generators don&#39;t have a call.
 62         return MacroAssembler::Call();
 63     }
 64 
 65     const NodeOrigin&amp; origin() const  { return m_origin; }
 66 
 67 protected:
 68     virtual void generateInternal(SpeculativeJIT*) = 0;
 69     Node* m_currentNode;
 70     MacroAssembler::Label m_label;
 71     unsigned m_streamIndex;
 72     NodeOrigin m_origin;
 73 };
 74 
 75 template&lt;typename JumpType&gt;
 76 class JumpingSlowPathGenerator : public SlowPathGenerator {
 77 public:
 78     JumpingSlowPathGenerator(JumpType from, SpeculativeJIT* jit)
 79         : SlowPathGenerator(jit)
 80         , m_from(from)
 81         , m_to(jit-&gt;m_jit.label())
 82     {
 83     }
 84 
 85 protected:
 86     void linkFrom(SpeculativeJIT* jit)
 87     {
 88         m_from.link(&amp;jit-&gt;m_jit);
 89     }
 90 
 91     void jumpTo(SpeculativeJIT* jit)
 92     {
 93         jit-&gt;m_jit.jump().linkTo(m_to, &amp;jit-&gt;m_jit);
 94     }
 95 
 96     JumpType m_from;
 97     MacroAssembler::Label m_to;
 98 };
 99 
100 enum class ExceptionCheckRequirement : uint8_t {
101     CheckNeeded,
102     CheckNotNeeded
103 };
104 
<a name="2" id="anc2"></a><span class="line-modified">105 template&lt;typename JumpType, typename ResultType&gt;</span>
106 class CallSlowPathGenerator : public JumpingSlowPathGenerator&lt;JumpType&gt; {
107 public:
108     CallSlowPathGenerator(
<a name="3" id="anc3"></a><span class="line-modified">109         JumpType from, SpeculativeJIT* jit,</span>
110         SpillRegistersMode spillMode, ExceptionCheckRequirement requirement, ResultType result)
111         : JumpingSlowPathGenerator&lt;JumpType&gt;(from, jit)
112         , m_spillMode(spillMode)
113         , m_exceptionCheckRequirement(requirement)
114         , m_result(result)
<a name="4" id="anc4"></a>
115     {
116         if (m_spillMode == NeedToSpill)
117             jit-&gt;silentSpillAllRegistersImpl(false, m_plans, extractResult(result));
118     }
119 
120     MacroAssembler::Call call() const override
121     {
122         return m_call;
123     }
124 
125 protected:
126     void setUp(SpeculativeJIT* jit)
127     {
128         this-&gt;linkFrom(jit);
129         if (m_spillMode == NeedToSpill) {
130             for (unsigned i = 0; i &lt; m_plans.size(); ++i)
131                 jit-&gt;silentSpill(m_plans[i]);
132         }
133     }
134 
135     void recordCall(MacroAssembler::Call call)
136     {
137         m_call = call;
138     }
139 
140     void tearDown(SpeculativeJIT* jit)
141     {
142         if (m_spillMode == NeedToSpill) {
143             for (unsigned i = m_plans.size(); i--;)
144                 jit-&gt;silentFill(m_plans[i]);
145         }
146         if (m_exceptionCheckRequirement == ExceptionCheckRequirement::CheckNeeded)
147             jit-&gt;m_jit.exceptionCheck();
148         this-&gt;jumpTo(jit);
149     }
150 
151     MacroAssembler::Call m_call;
152     SpillRegistersMode m_spillMode;
153     ExceptionCheckRequirement m_exceptionCheckRequirement;
154     ResultType m_result;
<a name="5" id="anc5"></a>
155     Vector&lt;SilentRegisterSavePlan, 2&gt; m_plans;
156 };
157 
158 template&lt;typename JumpType, typename FunctionType, typename ResultType, typename... Arguments&gt;
159 class CallResultAndArgumentsSlowPathGenerator
<a name="6" id="anc6"></a><span class="line-modified">160     : public CallSlowPathGenerator&lt;JumpType, ResultType&gt; {</span>
161 public:
162     CallResultAndArgumentsSlowPathGenerator(
163         JumpType from, SpeculativeJIT* jit, FunctionType function,
164         SpillRegistersMode spillMode, ExceptionCheckRequirement requirement, ResultType result, Arguments... arguments)
<a name="7" id="anc7"></a><span class="line-modified">165         : CallSlowPathGenerator&lt;JumpType, ResultType&gt;(from, jit, spillMode, requirement, result)</span>
<span class="line-modified">166         , m_function(function)</span>
167         , m_arguments(std::forward&lt;Arguments&gt;(arguments)...)
168     {
169     }
170 
171 protected:
172     template&lt;size_t... ArgumentsIndex&gt;
173     void unpackAndGenerate(SpeculativeJIT* jit, std::index_sequence&lt;ArgumentsIndex...&gt;)
174     {
175         this-&gt;setUp(jit);
<a name="8" id="anc8"></a><span class="line-modified">176         if constexpr (std::is_same&lt;ResultType, NoResultTag&gt;::value)</span>
<span class="line-added">177             this-&gt;recordCall(jit-&gt;callOperation(this-&gt;m_function, std::get&lt;ArgumentsIndex&gt;(m_arguments)...));</span>
<span class="line-added">178         else</span>
<span class="line-added">179             this-&gt;recordCall(jit-&gt;callOperation(this-&gt;m_function, extractResult(this-&gt;m_result), std::get&lt;ArgumentsIndex&gt;(m_arguments)...));</span>
180         this-&gt;tearDown(jit);
181     }
182 
183     void generateInternal(SpeculativeJIT* jit) override
184     {
185         unpackAndGenerate(jit, std::make_index_sequence&lt;std::tuple_size&lt;std::tuple&lt;Arguments...&gt;&gt;::value&gt;());
186     }
187 
<a name="9" id="anc9"></a><span class="line-added">188     FunctionType m_function;</span>
189     std::tuple&lt;Arguments...&gt; m_arguments;
190 };
191 
192 template&lt;typename JumpType, typename FunctionType, typename ResultType, typename... Arguments&gt;
193 inline std::unique_ptr&lt;SlowPathGenerator&gt; slowPathCall(
194     JumpType from, SpeculativeJIT* jit, FunctionType function,
195     SpillRegistersMode spillMode, ExceptionCheckRequirement requirement,
196     ResultType result, Arguments... arguments)
197 {
198     return makeUnique&lt;CallResultAndArgumentsSlowPathGenerator&lt;JumpType, FunctionType, ResultType, Arguments...&gt;&gt;(
199         from, jit, function, spillMode, requirement, result, arguments...);
200 }
201 
202 template&lt;typename JumpType, typename FunctionType, typename ResultType, typename... Arguments&gt;
203 inline std::unique_ptr&lt;SlowPathGenerator&gt; slowPathCall(
204     JumpType from, SpeculativeJIT* jit, FunctionType function,
205     ResultType result, Arguments... arguments)
206 {
207     return slowPathCall(
208         from, jit, function, NeedToSpill, ExceptionCheckRequirement::CheckNeeded, result, arguments...);
209 }
210 
211 template&lt;typename JumpType, typename DestinationType, typename SourceType, unsigned numberOfAssignments&gt;
212 class AssigningSlowPathGenerator : public JumpingSlowPathGenerator&lt;JumpType&gt; {
213 public:
214     AssigningSlowPathGenerator(
215         JumpType from, SpeculativeJIT* jit,
216         DestinationType destination[numberOfAssignments],
217         SourceType source[numberOfAssignments])
218         : JumpingSlowPathGenerator&lt;JumpType&gt;(from, jit)
219     {
220         for (unsigned i = numberOfAssignments; i--;) {
221             m_destination[i] = destination[i];
222             m_source[i] = source[i];
223         }
224     }
225 
226 protected:
227     void generateInternal(SpeculativeJIT* jit) override
228     {
229         this-&gt;linkFrom(jit);
230         for (unsigned i = numberOfAssignments; i--;)
231             jit-&gt;m_jit.move(m_source[i], m_destination[i]);
232         this-&gt;jumpTo(jit);
233     }
234 
235 private:
236     DestinationType m_destination[numberOfAssignments];
237     SourceType m_source[numberOfAssignments];
238 };
239 
240 template&lt;typename JumpType, typename DestinationType, typename SourceType, unsigned numberOfAssignments&gt;
241 inline std::unique_ptr&lt;SlowPathGenerator&gt; slowPathMove(
242     JumpType from, SpeculativeJIT* jit, SourceType source[numberOfAssignments], DestinationType destination[numberOfAssignments])
243 {
244     return makeUnique&lt;AssigningSlowPathGenerator&lt;JumpType, DestinationType, SourceType, numberOfAssignments&gt;&gt;(
245         from, jit, destination, source);
246 }
247 
248 template&lt;typename JumpType, typename DestinationType, typename SourceType&gt;
249 inline std::unique_ptr&lt;SlowPathGenerator&gt; slowPathMove(
250     JumpType from, SpeculativeJIT* jit, SourceType source, DestinationType destination)
251 {
252     SourceType sourceArray[1] = { source };
253     DestinationType destinationArray[1] = { destination };
254     return makeUnique&lt;AssigningSlowPathGenerator&lt;JumpType, DestinationType, SourceType, 1&gt;&gt;(
255         from, jit, destinationArray, sourceArray);
256 }
257 
258 template&lt;typename JumpType, typename DestinationType, typename SourceType&gt;
259 inline std::unique_ptr&lt;SlowPathGenerator&gt; slowPathMove(
260     JumpType from, SpeculativeJIT* jit, SourceType source1, DestinationType destination1, SourceType source2, DestinationType destination2)
261 {
262     SourceType sourceArray[2] = { source1, source2 };
263     DestinationType destinationArray[2] = { destination1, destination2 };
264     return makeUnique&lt;AssigningSlowPathGenerator&lt;JumpType, DestinationType, SourceType, 2&gt;&gt;(
265         from, jit, destinationArray, sourceArray);
266 }
267 
268 } } // namespace JSC::DFG
269 
270 #endif // ENABLD(DFG_JIT)
<a name="10" id="anc10"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="10" type="hidden" />
</body>
</html>