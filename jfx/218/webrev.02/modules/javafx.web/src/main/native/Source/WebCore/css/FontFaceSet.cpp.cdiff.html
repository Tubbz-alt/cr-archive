<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.web/src/main/native/Source/WebCore/css/FontFaceSet.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="FontFace.idl.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="FontFaceSet.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/css/FontFaceSet.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 24,14 ***</span>
<span class="line-new-header">--- 24,17 ---</span>
   */
  
  #include &quot;config.h&quot;
  #include &quot;FontFaceSet.h&quot;
  
<span class="line-added">+ #include &quot;DOMPromiseProxy.h&quot;</span>
  #include &quot;Document.h&quot;
<span class="line-added">+ #include &quot;EventLoop.h&quot;</span>
  #include &quot;FontFace.h&quot;
  #include &quot;FrameLoader.h&quot;
  #include &quot;JSDOMBinding.h&quot;
<span class="line-added">+ #include &quot;JSDOMPromiseDeferred.h&quot;</span>
  #include &quot;JSFontFace.h&quot;
  #include &quot;JSFontFaceSet.h&quot;
  #include &lt;wtf/IsoMallocInlines.h&gt;
  
  namespace WebCore {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 53,27 ***</span>
  }
  
  FontFaceSet::FontFaceSet(Document&amp; document, const Vector&lt;RefPtr&lt;FontFace&gt;&gt;&amp; initialFaces)
      : ActiveDOMObject(document)
      , m_backing(CSSFontFaceSet::create())
<span class="line-modified">!     , m_readyPromise(*this, &amp;FontFaceSet::readyPromiseResolve)</span>
  {
      m_backing-&gt;addClient(*this);
      for (auto&amp; face : initialFaces)
          add(*face);
  }
  
  FontFaceSet::FontFaceSet(Document&amp; document, CSSFontFaceSet&amp; backing)
      : ActiveDOMObject(document)
      , m_backing(backing)
<span class="line-modified">!     , m_readyPromise(*this, &amp;FontFaceSet::readyPromiseResolve)</span>
  {
      if (document.frame())
<span class="line-modified">!         m_isFirstLayoutDone = document.frame()-&gt;loader().stateMachine().firstLayoutDone();</span>
  
<span class="line-modified">!     if (m_isFirstLayoutDone &amp;&amp; !backing.hasActiveFontFaces())</span>
<span class="line-modified">!         m_readyPromise.resolve(*this);</span>
  
      m_backing-&gt;addClient(*this);
  }
  
  FontFaceSet::~FontFaceSet()
<span class="line-new-header">--- 56,27 ---</span>
  }
  
  FontFaceSet::FontFaceSet(Document&amp; document, const Vector&lt;RefPtr&lt;FontFace&gt;&gt;&amp; initialFaces)
      : ActiveDOMObject(document)
      , m_backing(CSSFontFaceSet::create())
<span class="line-modified">!     , m_readyPromise(makeUniqueRef&lt;ReadyPromise&gt;(*this, &amp;FontFaceSet::readyPromiseResolve))</span>
  {
      m_backing-&gt;addClient(*this);
      for (auto&amp; face : initialFaces)
          add(*face);
  }
  
  FontFaceSet::FontFaceSet(Document&amp; document, CSSFontFaceSet&amp; backing)
      : ActiveDOMObject(document)
      , m_backing(backing)
<span class="line-modified">!     , m_readyPromise(makeUniqueRef&lt;ReadyPromise&gt;(*this, &amp;FontFaceSet::readyPromiseResolve))</span>
  {
      if (document.frame())
<span class="line-modified">!         m_isDocumentLoaded = document.loadEventFinished() &amp;&amp; !document.processingLoadEvent();</span>
  
<span class="line-modified">!     if (m_isDocumentLoaded &amp;&amp; !backing.hasActiveFontFaces())</span>
<span class="line-modified">!         m_readyPromise-&gt;resolve(*this);</span>
  
      m_backing-&gt;addClient(*this);
  }
  
  FontFaceSet::~FontFaceSet()
</pre>
<hr />
<pre>
<span class="line-old-header">*** 92,11 ***</span>
          return nullptr;
      return m_target-&gt;backing()[m_index++].wrapper();
  }
  
  FontFaceSet::PendingPromise::PendingPromise(LoadPromise&amp;&amp; promise)
<span class="line-modified">!     : promise(WTFMove(promise))</span>
  {
  }
  
  FontFaceSet::PendingPromise::~PendingPromise() = default;
  
<span class="line-new-header">--- 95,11 ---</span>
          return nullptr;
      return m_target-&gt;backing()[m_index++].wrapper();
  }
  
  FontFaceSet::PendingPromise::PendingPromise(LoadPromise&amp;&amp; promise)
<span class="line-modified">!     : promise(makeUniqueRef&lt;LoadPromise&gt;(WTFMove(promise)))</span>
  {
  }
  
  FontFaceSet::PendingPromise::~PendingPromise() = default;
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 166,11 ***</span>
          ASSERT(face.get().existingWrapper());
          m_pendingPromises.add(face.get().existingWrapper(), Vector&lt;Ref&lt;PendingPromise&gt;&gt;()).iterator-&gt;value.append(pendingPromise.copyRef());
      }
  
      if (!waiting)
<span class="line-modified">!         pendingPromise-&gt;promise.resolve(pendingPromise-&gt;faces);</span>
  }
  
  ExceptionOr&lt;bool&gt; FontFaceSet::check(const String&amp; family, const String&amp; text)
  {
      return m_backing-&gt;check(family, text);
<span class="line-new-header">--- 169,11 ---</span>
          ASSERT(face.get().existingWrapper());
          m_pendingPromises.add(face.get().existingWrapper(), Vector&lt;Ref&lt;PendingPromise&gt;&gt;()).iterator-&gt;value.append(pendingPromise.copyRef());
      }
  
      if (!waiting)
<span class="line-modified">!         pendingPromise-&gt;promise-&gt;resolve(pendingPromise-&gt;faces);</span>
  }
  
  ExceptionOr&lt;bool&gt; FontFaceSet::check(const String&amp; family, const String&amp; text)
  {
      return m_backing-&gt;check(family, text);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 186,58 ***</span>
      }
      ASSERT_NOT_REACHED();
      return LoadStatus::Loaded;
  }
  
<span class="line-removed">- bool FontFaceSet::canSuspendForDocumentSuspension() const</span>
<span class="line-removed">- {</span>
<span class="line-removed">-     return m_backing-&gt;status() == CSSFontFaceSet::Status::Loaded;</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
  void FontFaceSet::startedLoading()
  {
      // FIXME: Fire a &quot;loading&quot; event asynchronously.
  }
  
<span class="line-modified">! void FontFaceSet::didFirstLayout()</span>
  {
<span class="line-modified">!     m_isFirstLayoutDone = true;</span>
<span class="line-modified">!     if (!m_backing-&gt;hasActiveFontFaces() &amp;&amp; !m_readyPromise.isFulfilled())</span>
<span class="line-modified">!         m_readyPromise.resolve(*this);</span>
  }
  
  void FontFaceSet::completedLoading()
  {
<span class="line-modified">!     if (m_isFirstLayoutDone &amp;&amp; !m_readyPromise.isFulfilled())</span>
<span class="line-modified">!         m_readyPromise.resolve(*this);</span>
  }
  
  void FontFaceSet::faceFinished(CSSFontFace&amp; face, CSSFontFace::Status newStatus)
  {
      if (!face.existingWrapper())
          return;
  
<span class="line-modified">!     auto iterator = m_pendingPromises.find(face.existingWrapper());</span>
<span class="line-modified">!     if (iterator == m_pendingPromises.end())</span>
          return;
  
<span class="line-modified">!     for (auto&amp; pendingPromise : iterator-&gt;value) {</span>
          if (pendingPromise-&gt;hasReachedTerminalState)
              continue;
          if (newStatus == CSSFontFace::Status::Success) {
              if (pendingPromise-&gt;hasOneRef()) {
<span class="line-modified">!                 pendingPromise-&gt;promise.resolve(pendingPromise-&gt;faces);</span>
                  pendingPromise-&gt;hasReachedTerminalState = true;
              }
          } else {
              ASSERT(newStatus == CSSFontFace::Status::Failure);
<span class="line-modified">!             pendingPromise-&gt;promise.reject(NetworkError);</span>
              pendingPromise-&gt;hasReachedTerminalState = true;
          }
      }
<span class="line-removed">- </span>
<span class="line-removed">-     m_pendingPromises.remove(iterator);</span>
  }
  
  FontFaceSet&amp; FontFaceSet::readyPromiseResolve()
  {
      return *this;
<span class="line-new-header">--- 189,51 ---</span>
      }
      ASSERT_NOT_REACHED();
      return LoadStatus::Loaded;
  }
  
  void FontFaceSet::startedLoading()
  {
      // FIXME: Fire a &quot;loading&quot; event asynchronously.
  }
  
<span class="line-modified">! void FontFaceSet::documentDidFinishLoading()</span>
  {
<span class="line-modified">!     m_isDocumentLoaded = true;</span>
<span class="line-modified">!     if (!m_backing-&gt;hasActiveFontFaces() &amp;&amp; !m_readyPromise-&gt;isFulfilled())</span>
<span class="line-modified">!         m_readyPromise-&gt;resolve(*this);</span>
  }
  
  void FontFaceSet::completedLoading()
  {
<span class="line-modified">!     if (m_isDocumentLoaded &amp;&amp; !m_readyPromise-&gt;isFulfilled())</span>
<span class="line-modified">!         m_readyPromise-&gt;resolve(*this);</span>
  }
  
  void FontFaceSet::faceFinished(CSSFontFace&amp; face, CSSFontFace::Status newStatus)
  {
      if (!face.existingWrapper())
          return;
  
<span class="line-modified">!     auto pendingPromises = m_pendingPromises.take(face.existingWrapper());</span>
<span class="line-modified">!     if (pendingPromises.isEmpty())</span>
          return;
  
<span class="line-modified">!     for (auto&amp; pendingPromise : pendingPromises) {</span>
          if (pendingPromise-&gt;hasReachedTerminalState)
              continue;
          if (newStatus == CSSFontFace::Status::Success) {
              if (pendingPromise-&gt;hasOneRef()) {
<span class="line-modified">!                 pendingPromise-&gt;promise-&gt;resolve(pendingPromise-&gt;faces);</span>
                  pendingPromise-&gt;hasReachedTerminalState = true;
              }
          } else {
              ASSERT(newStatus == CSSFontFace::Status::Failure);
<span class="line-modified">!             pendingPromise-&gt;promise-&gt;reject(NetworkError);</span>
              pendingPromise-&gt;hasReachedTerminalState = true;
          }
      }
  }
  
  FontFaceSet&amp; FontFaceSet::readyPromiseResolve()
  {
      return *this;
</pre>
<center><a href="FontFace.idl.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="FontFaceSet.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>