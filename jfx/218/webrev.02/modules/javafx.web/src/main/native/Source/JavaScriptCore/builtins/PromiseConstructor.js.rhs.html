<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/JavaScriptCore/builtins/PromiseConstructor.js</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (C) 2015 Yusuke Suzuki &lt;utatane.tea@gmail.com&gt;.
  3  *
  4  * Redistribution and use in source and binary forms, with or without
  5  * modification, are permitted provided that the following conditions
  6  * are met:
  7  * 1. Redistributions of source code must retain the above copyright
  8  *    notice, this list of conditions and the following disclaimer.
  9  * 2. Redistributions in binary form must reproduce the above copyright
 10  *    notice, this list of conditions and the following disclaimer in the
 11  *    documentation and/or other materials provided with the distribution.
 12  *
 13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. ``AS IS&#39;&#39; AND ANY
 14  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 15  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 16  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE INC. OR
 17  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 18  * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 19  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 20  * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 21  * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 22  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 23  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 function all(iterable)
 27 {
 28     &quot;use strict&quot;;
 29 
 30     if (!@isObject(this))
 31         @throwTypeError(&quot;|this| is not an object&quot;);
 32 
 33     var promiseCapability = @newPromiseCapability(this);
 34 
 35     var values = [];
 36     var index = 0;
 37     var remainingElementsCount = 1;
 38 
 39     function newResolveElement(index)
 40     {
 41         var alreadyCalled = false;
<a name="1" id="anc1"></a><span class="line-modified"> 42         return function (argument)</span>
 43         {
 44             if (alreadyCalled)
 45                 return @undefined;
 46             alreadyCalled = true;
 47 
 48             @putByValDirect(values, index, argument);
 49 
 50             --remainingElementsCount;
 51             if (remainingElementsCount === 0)
 52                 return promiseCapability.@resolve.@call(@undefined, values);
 53 
 54             return @undefined;
 55         }
 56     }
 57 
 58     try {
 59         var promiseResolve = this.resolve;
 60         if (typeof promiseResolve !== &quot;function&quot;)
 61             @throwTypeError(&quot;Promise resolve is not a function&quot;);
 62 
 63         for (var value of iterable) {
 64             @putByValDirect(values, index, @undefined);
 65             var nextPromise = promiseResolve.@call(this, value);
 66             var resolveElement = newResolveElement(index);
 67             ++remainingElementsCount;
 68             nextPromise.then(resolveElement, promiseCapability.@reject);
 69             ++index;
 70         }
 71 
 72         --remainingElementsCount;
 73         if (remainingElementsCount === 0)
 74             promiseCapability.@resolve.@call(@undefined, values);
 75     } catch (error) {
 76         promiseCapability.@reject.@call(@undefined, error);
 77     }
 78 
 79     return promiseCapability.@promise;
 80 }
 81 
 82 function allSettled(iterable)
 83 {
 84     &quot;use strict&quot;;
 85 
 86     if (!@isObject(this))
 87         @throwTypeError(&quot;|this| is not an object&quot;);
 88 
 89     var promiseCapability = @newPromiseCapability(this);
 90 
 91     var values = [];
 92     var remainingElementsCount = 1;
 93     var index = 0;
 94 
 95     function newResolveRejectElements(index)
 96     {
 97         var alreadyCalled = false;
 98 
<a name="2" id="anc2"></a><span class="line-modified"> 99         return [</span>
<span class="line-modified">100             function (value) {</span>
<span class="line-modified">101                 if (alreadyCalled)</span>
<span class="line-modified">102                     return @undefined;</span>
<span class="line-modified">103                 alreadyCalled = true;</span>





104 
<a name="3" id="anc3"></a><span class="line-modified">105                 var obj = {</span>
<span class="line-added">106                     status: &quot;fulfilled&quot;,</span>
<span class="line-added">107                     value</span>
<span class="line-added">108                 };</span>
109 
<a name="4" id="anc4"></a><span class="line-modified">110                 @putByValDirect(values, index, obj);</span>


111 
<a name="5" id="anc5"></a><span class="line-modified">112                 --remainingElementsCount;</span>
<span class="line-modified">113                 if (remainingElementsCount === 0)</span>
<span class="line-added">114                     return promiseCapability.@resolve.@call(@undefined, values);</span>
115 
<a name="6" id="anc6"></a>


116                 return @undefined;
<a name="7" id="anc7"></a><span class="line-modified">117             },</span>
118 
<a name="8" id="anc8"></a><span class="line-modified">119             function (reason) {</span>
<span class="line-modified">120                 if (alreadyCalled)</span>
<span class="line-modified">121                     return @undefined;</span>
<span class="line-modified">122                 alreadyCalled = true;</span>
123 
<a name="9" id="anc9"></a><span class="line-modified">124                 var obj = {</span>
<span class="line-added">125                     status: &quot;rejected&quot;,</span>
<span class="line-added">126                     reason</span>
<span class="line-added">127                 };</span>
128 
<a name="10" id="anc10"></a><span class="line-modified">129                 @putByValDirect(values, index, obj);</span>


130 
<a name="11" id="anc11"></a><span class="line-modified">131                 --remainingElementsCount;</span>
<span class="line-modified">132                 if (remainingElementsCount === 0)</span>
<span class="line-added">133                     return promiseCapability.@resolve.@call(@undefined, values);</span>
134 
<a name="12" id="anc12"></a><span class="line-modified">135                 return @undefined;</span>
<span class="line-added">136             }</span>
<span class="line-added">137         ];</span>
138     }
139 
140     try {
141         var promiseResolve = this.resolve;
142         if (typeof promiseResolve !== &quot;function&quot;)
143             @throwTypeError(&quot;Promise resolve is not a function&quot;);
144 
145         for (var value of iterable) {
146             @putByValDirect(values, index, @undefined);
147             var nextPromise = promiseResolve.@call(this, value);
148             var [resolveElement, rejectElement] = newResolveRejectElements(index);
149             ++remainingElementsCount;
150             nextPromise.then(resolveElement, rejectElement);
151             ++index;
152         }
153 
154         --remainingElementsCount;
155         if (remainingElementsCount === 0)
156             promiseCapability.@resolve.@call(@undefined, values);
157     } catch (error) {
158         promiseCapability.@reject.@call(@undefined, error);
159     }
160 
161     return promiseCapability.@promise;
162 }
163 
164 function race(iterable)
165 {
166     &quot;use strict&quot;;
167 
168     if (!@isObject(this))
169         @throwTypeError(&quot;|this| is not an object&quot;);
170 
171     var promiseCapability = @newPromiseCapability(this);
172 
173     try {
174         var promiseResolve = this.resolve;
175         if (typeof promiseResolve !== &quot;function&quot;)
176             @throwTypeError(&quot;Promise resolve is not a function&quot;);
177 
178         for (var value of iterable) {
179             var nextPromise = promiseResolve.@call(this, value);
180             nextPromise.then(promiseCapability.@resolve, promiseCapability.@reject);
181         }
182     } catch (error) {
183         promiseCapability.@reject.@call(@undefined, error);
184     }
185 
186     return promiseCapability.@promise;
187 }
188 
189 function reject(reason)
190 {
191     &quot;use strict&quot;;
192 
193     if (!@isObject(this))
194         @throwTypeError(&quot;|this| is not an object&quot;);
195 
<a name="13" id="anc13"></a><span class="line-modified">196     if (this === @Promise) {</span>
<span class="line-modified">197         var promise = @newPromise();</span>
<span class="line-modified">198         @rejectPromiseWithFirstResolvingFunctionCallCheck(promise, reason);</span>
<span class="line-added">199         return promise;</span>
<span class="line-added">200     }</span>
201 
<a name="14" id="anc14"></a><span class="line-modified">202     return @promiseRejectSlow(this, reason);</span>
203 }
204 
205 function resolve(value)
206 {
207     &quot;use strict&quot;;
208 
209     if (!@isObject(this))
210         @throwTypeError(&quot;|this| is not an object&quot;);
211 
212     if (@isPromise(value)) {
213         var valueConstructor = value.constructor;
214         if (valueConstructor === this)
215             return value;
216     }
217 
<a name="15" id="anc15"></a><span class="line-modified">218     if (this === @Promise) {</span>
<span class="line-added">219         var promise = @newPromise();</span>
<span class="line-added">220         @resolvePromiseWithFirstResolvingFunctionCallCheck(promise, value);</span>
<span class="line-added">221         return promise;</span>
<span class="line-added">222     }</span>
223 
<a name="16" id="anc16"></a><span class="line-modified">224     return @promiseResolveSlow(this, value);</span>
<span class="line-added">225 }</span>
226 
<a name="17" id="anc17"></a><span class="line-modified">227 @nakedConstructor</span>
<span class="line-added">228 function Promise(executor)</span>
<span class="line-added">229 {</span>
<span class="line-added">230     &quot;use strict&quot;;</span>
<span class="line-added">231 </span>
<span class="line-added">232     if (typeof executor !== &quot;function&quot;)</span>
<span class="line-added">233         @throwTypeError(&quot;Promise constructor takes a function argument&quot;);</span>
<span class="line-added">234 </span>
<span class="line-added">235     var promise = @createPromise(this, /* isInternalPromise */ false);</span>
<span class="line-added">236     var capturedPromise = promise;</span>
<span class="line-added">237 </span>
<span class="line-added">238     try {</span>
<span class="line-added">239         executor(</span>
<span class="line-added">240             function (resolution) {</span>
<span class="line-added">241                 return @resolvePromiseWithFirstResolvingFunctionCallCheck(capturedPromise, resolution);</span>
<span class="line-added">242             },</span>
<span class="line-added">243             function (reason) {</span>
<span class="line-added">244                 return @rejectPromiseWithFirstResolvingFunctionCallCheck(capturedPromise, reason);</span>
<span class="line-added">245             });</span>
<span class="line-added">246     } catch (error) {</span>
<span class="line-added">247         @rejectPromiseWithFirstResolvingFunctionCallCheck(promise, error);</span>
<span class="line-added">248     }</span>
<span class="line-added">249 </span>
<span class="line-added">250     return promise;</span>
<span class="line-added">251 }</span>
<span class="line-added">252 </span>
<span class="line-added">253 @nakedConstructor</span>
<span class="line-added">254 function InternalPromise(executor)</span>
<span class="line-added">255 {</span>
<span class="line-added">256     &quot;use strict&quot;;</span>
<span class="line-added">257 </span>
<span class="line-added">258     if (typeof executor !== &quot;function&quot;)</span>
<span class="line-added">259         @throwTypeError(&quot;InternalPromise constructor takes a function argument&quot;);</span>
<span class="line-added">260 </span>
<span class="line-added">261     var promise = @createPromise(this, /* isInternalPromise */ true);</span>
<span class="line-added">262     var capturedPromise = promise;</span>
<span class="line-added">263 </span>
<span class="line-added">264     try {</span>
<span class="line-added">265         executor(</span>
<span class="line-added">266             function (resolution) {</span>
<span class="line-added">267                 return @resolvePromiseWithFirstResolvingFunctionCallCheck(capturedPromise, resolution);</span>
<span class="line-added">268             },</span>
<span class="line-added">269             function (reason) {</span>
<span class="line-added">270                 return @rejectPromiseWithFirstResolvingFunctionCallCheck(capturedPromise, reason);</span>
<span class="line-added">271             });</span>
<span class="line-added">272     } catch (error) {</span>
<span class="line-added">273         @rejectPromiseWithFirstResolvingFunctionCallCheck(promise, error);</span>
<span class="line-added">274     }</span>
<span class="line-added">275 </span>
<span class="line-added">276     return promise;</span>
277 }
<a name="18" id="anc18"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="18" type="hidden" />
</body>
</html>