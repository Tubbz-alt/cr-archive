<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New modules/javafx.web/src/main/native/Source/JavaScriptCore/bytecode/BytecodeUseDef.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (C) 2013-2019 Apple Inc. All rights reserved.
  3  *
  4  * Redistribution and use in source and binary forms, with or without
  5  * modification, are permitted provided that the following conditions
  6  * are met:
  7  * 1. Redistributions of source code must retain the above copyright
  8  *    notice, this list of conditions and the following disclaimer.
  9  * 2. Redistributions in binary form must reproduce the above copyright
 10  *    notice, this list of conditions and the following disclaimer in the
 11  *    documentation and/or other materials provided with the distribution.
 12  *
 13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. AND ITS CONTRIBUTORS ``AS IS&#39;&#39;
 14  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
 15  * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 16  * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL APPLE INC. OR ITS CONTRIBUTORS
 17  * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 18  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 19  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 20  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 21  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 22  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF
 23  * THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #include &quot;config.h&quot;
 27 #include &quot;BytecodeUseDef.h&quot;
 28 
 29 namespace JSC {
 30 
 31 #define CALL_FUNCTOR(__arg) \
 32     functor(__bytecode.m_##__arg);
 33 
 34 #define USES_OR_DEFS(__opcode, ...) \
 35     case __opcode::opcodeID: { \
 36         auto __bytecode = instruction-&gt;as&lt;__opcode&gt;(); \
 37         WTF_LAZY_FOR_EACH_TERM(CALL_FUNCTOR, __VA_ARGS__) \
 38         return; \
 39     }
 40 
 41 #define USES USES_OR_DEFS
 42 #define DEFS USES_OR_DEFS
 43 
 44 void computeUsesForBytecodeIndexImpl(VirtualRegister scopeRegister, const Instruction* instruction, const Function&lt;void(VirtualRegister)&gt;&amp; functor)
 45 {
 46     OpcodeID opcodeID = instruction-&gt;opcodeID();
 47 
 48     auto handleNewArrayLike = [&amp;](auto op) {
 49         int base = op.m_argv.offset();
 50         for (int i = 0; i &lt; static_cast&lt;int&gt;(op.m_argc); i++)
 51             functor(VirtualRegister { base - i });
 52     };
 53 
 54     auto handleOpCallLike = [&amp;](auto op) {
 55         functor(op.m_callee);
 56         int lastArg = -static_cast&lt;int&gt;(op.m_argv) + CallFrame::thisArgumentOffset();
 57         for (int i = 0; i &lt; static_cast&lt;int&gt;(op.m_argc); i++)
 58             functor(VirtualRegister { lastArg + i });
 59         if (opcodeID == op_call_eval)
 60             functor(scopeRegister);
 61         return;
 62     };
 63 
 64     switch (opcodeID) {
 65     case op_wide16:
 66     case op_wide32:
 67         RELEASE_ASSERT_NOT_REACHED();
 68 
 69     // No uses.
 70     case op_new_regexp:
 71     case op_debug:
 72     case op_jneq_ptr:
 73     case op_loop_hint:
 74     case op_jmp:
 75     case op_new_object:
 76     case op_new_promise:
 77     case op_new_generator:
 78     case op_enter:
 79     case op_argument_count:
 80     case op_catch:
 81     case op_profile_control_flow:
 82     case op_create_direct_arguments:
 83     case op_create_cloned_arguments:
 84     case op_create_arguments_butterfly:
 85     case op_get_rest_length:
 86     case op_check_traps:
 87     case op_get_argument:
 88     case op_nop:
 89     case op_unreachable:
 90     case op_super_sampler_begin:
 91     case op_super_sampler_end:
 92         return;
 93 
 94     USES(OpGetScope, dst)
 95     USES(OpToThis, srcDst)
 96     USES(OpCheckTdz, targetVirtualRegister)
 97     USES(OpIdentityWithProfile, srcDst)
 98     USES(OpProfileType, targetVirtualRegister);
 99     USES(OpThrow, value)
100     USES(OpThrowStaticError, message)
101     USES(OpEnd, value)
102     USES(OpRet, value)
103     USES(OpJtrue, condition)
104     USES(OpJfalse, condition)
105     USES(OpJeqNull, value)
106     USES(OpJneqNull, value)
107     USES(OpJundefinedOrNull, value)
108     USES(OpJnundefinedOrNull, value)
109     USES(OpDec, srcDst)
110     USES(OpInc, srcDst)
111     USES(OpLogShadowChickenPrologue, scope)
112 
113     USES(OpJless, lhs, rhs)
114     USES(OpJlesseq, lhs, rhs)
115     USES(OpJgreater, lhs, rhs)
116     USES(OpJgreatereq, lhs, rhs)
117     USES(OpJnless, lhs, rhs)
118     USES(OpJnlesseq, lhs, rhs)
119     USES(OpJngreater, lhs, rhs)
120     USES(OpJngreatereq, lhs, rhs)
121     USES(OpJeq, lhs, rhs)
122     USES(OpJneq, lhs, rhs)
123     USES(OpJstricteq, lhs, rhs)
124     USES(OpJnstricteq, lhs, rhs)
125     USES(OpJbelow, lhs, rhs)
126     USES(OpJbeloweq, lhs, rhs)
127     USES(OpSetFunctionName, function, name)
128     USES(OpLogShadowChickenTail, thisValue, scope)
129 
130     USES(OpPutByVal, base, property, value)
131     USES(OpPutByValDirect, base, property, value)
132 
133     USES(OpPutById, base, value)
134     USES(OpPutToScope, scope, value)
135     USES(OpPutToArguments, arguments, value)
136 
137     USES(OpPutByIdWithThis, base, thisValue, value)
138 
139     USES(OpPutByValWithThis, base, thisValue, property, value)
140 
141     USES(OpPutGetterById, base, accessor)
142     USES(OpPutSetterById, base, accessor)
143 
144     USES(OpPutGetterSetterById, base, getter, setter)
145 
146     USES(OpPutGetterByVal, base, property, accessor)
147     USES(OpPutSetterByVal, base, property, accessor)
148 
149     USES(OpDefineDataProperty, base, property, value, attributes)
150 
151     USES(OpDefineAccessorProperty, base, property, getter, setter, attributes)
152 
153     USES(OpSpread, argument)
154     USES(OpGetPropertyEnumerator, base)
155     USES(OpGetEnumerableLength, base)
156     USES(OpNewFuncExp, scope)
157     USES(OpNewGeneratorFuncExp, scope)
158     USES(OpNewAsyncFuncExp, scope)
159     USES(OpToIndexString, index)
160     USES(OpCreateLexicalEnvironment, scope, symbolTable, initialValue)
161     USES(OpCreateGeneratorFrameEnvironment, scope, symbolTable, initialValue)
162     USES(OpResolveScope, scope)
163     USES(OpResolveScopeForHoistingFuncDeclInEval, scope)
164     USES(OpGetFromScope, scope)
165     USES(OpToPrimitive, src)
166     USES(OpToPropertyKey, src)
167     USES(OpTryGetById, base)
168     USES(OpGetById, base)
169     USES(OpGetByIdDirect, base)
170     USES(OpInById, base)
171     USES(OpTypeof, value)
172     USES(OpIsEmpty, operand)
173     USES(OpIsUndefined, operand)
174     USES(OpIsUndefinedOrNull, operand)
175     USES(OpIsBoolean, operand)
176     USES(OpIsNumber, operand)
177     USES(OpIsObject, operand)
178     USES(OpIsObjectOrNull, operand)
179     USES(OpIsCellWithType, operand)
180     USES(OpIsFunction, operand)
181     USES(OpToNumber, operand)
182     USES(OpToNumeric, operand)
183     USES(OpToString, operand)
184     USES(OpToObject, operand)
185     USES(OpNegate, operand)
186     USES(OpBitnot, operand)
187     USES(OpEqNull, operand)
188     USES(OpNeqNull, operand)
189     USES(OpNot, operand)
190     USES(OpUnsigned, operand)
191     USES(OpMov, src)
192     USES(OpNewArrayWithSize, length)
193     USES(OpCreateThis, callee)
194     USES(OpCreatePromise, callee)
195     USES(OpCreateGenerator, callee)
196     USES(OpCreateAsyncGenerator, callee)
197     USES(OpDelById, base)
198     USES(OpNewFunc, scope)
199     USES(OpNewAsyncGeneratorFunc, scope)
200     USES(OpNewAsyncGeneratorFuncExp, scope)
201     USES(OpNewGeneratorFunc, scope)
202     USES(OpNewAsyncFunc, scope)
203     USES(OpGetParentScope, scope)
204     USES(OpCreateScopedArguments, scope)
205     USES(OpCreateRest, arraySize)
206     USES(OpGetFromArguments, arguments)
207     USES(OpNewArrayBuffer, immutableButterfly)
208 
209     USES(OpHasGenericProperty, base, property)
210     USES(OpHasIndexedProperty, base, property)
211     USES(OpEnumeratorStructurePname, enumerator, index)
212     USES(OpEnumeratorGenericPname, enumerator, index)
213     USES(OpGetByVal, base, property)
214     USES(OpInByVal, base, property)
215     USES(OpOverridesHasInstance, constructor, hasInstanceValue)
216     USES(OpInstanceof, value, prototype)
217     USES(OpAdd, lhs, rhs)
218     USES(OpMul, lhs, rhs)
219     USES(OpDiv, lhs, rhs)
220     USES(OpMod, lhs, rhs)
221     USES(OpSub, lhs, rhs)
222     USES(OpPow, lhs, rhs)
223     USES(OpLshift, lhs, rhs)
224     USES(OpRshift, lhs, rhs)
225     USES(OpUrshift, lhs, rhs)
226     USES(OpBitand, lhs, rhs)
227     USES(OpBitxor, lhs, rhs)
228     USES(OpBitor, lhs, rhs)
229     USES(OpLess, lhs, rhs)
230     USES(OpLesseq, lhs, rhs)
231     USES(OpGreater, lhs, rhs)
232     USES(OpGreatereq, lhs, rhs)
233     USES(OpBelow, lhs, rhs)
234     USES(OpBeloweq, lhs, rhs)
235     USES(OpNstricteq, lhs, rhs)
236     USES(OpStricteq, lhs, rhs)
237     USES(OpNeq, lhs, rhs)
238     USES(OpEq, lhs, rhs)
239     USES(OpPushWithScope, currentScope, newScope)
240     USES(OpGetByIdWithThis, base, thisValue)
241     USES(OpDelByVal, base, property)
242     USES(OpTailCallForwardArguments, callee, thisValue)
243 
244     USES(OpGetByValWithThis, base, thisValue, property)
245     USES(OpInstanceofCustom, value, constructor, hasInstanceValue)
246     USES(OpHasStructureProperty, base, property, enumerator)
247     USES(OpConstructVarargs, callee, thisValue, arguments)
248     USES(OpCallVarargs, callee, thisValue, arguments)
249     USES(OpTailCallVarargs, callee, thisValue, arguments)
250 
251     USES(OpGetDirectPname, base, property, index, enumerator)
252 
253     USES(OpSwitchString, scrutinee)
254     USES(OpSwitchChar, scrutinee)
255     USES(OpSwitchImm, scrutinee)
256 
257     USES(OpGetInternalField, base)
258     USES(OpPutInternalField, base, value)
259 
260     USES(OpYield, generator, argument)
261 
262     case op_new_array_with_spread:
263         handleNewArrayLike(instruction-&gt;as&lt;OpNewArrayWithSpread&gt;());
264         return;
265     case op_new_array:
266         handleNewArrayLike(instruction-&gt;as&lt;OpNewArray&gt;());
267         return;
268 
269     case op_strcat: {
270         auto bytecode = instruction-&gt;as&lt;OpStrcat&gt;();
271         int base = bytecode.m_src.offset();
272         for (int i = 0; i &lt; bytecode.m_count; i++)
273             functor(VirtualRegister { base - i });
274         return;
275     }
276 
277     case op_construct:
278         handleOpCallLike(instruction-&gt;as&lt;OpConstruct&gt;());
279         return;
280     case op_call_eval:
281         handleOpCallLike(instruction-&gt;as&lt;OpCallEval&gt;());
282         return;
283     case op_call:
284         handleOpCallLike(instruction-&gt;as&lt;OpCall&gt;());
285         return;
286     case op_tail_call:
287         handleOpCallLike(instruction-&gt;as&lt;OpTailCall&gt;());
288         return;
289 
290     default:
291         RELEASE_ASSERT_NOT_REACHED();
292         break;
293     }
294 }
295 
296 void computeDefsForBytecodeIndexImpl(unsigned numVars, const Instruction* instruction, const Function&lt;void(VirtualRegister)&gt;&amp; functor)
297 {
298     switch (instruction-&gt;opcodeID()) {
299     case op_wide16:
300     case op_wide32:
301         RELEASE_ASSERT_NOT_REACHED();
302 
303     // These don&#39;t define anything.
304     case op_put_to_scope:
305     case op_end:
306     case op_throw:
307     case op_throw_static_error:
308     case op_check_tdz:
309     case op_debug:
310     case op_ret:
311     case op_jmp:
312     case op_jtrue:
313     case op_jfalse:
314     case op_jeq_null:
315     case op_jneq_null:
316     case op_jundefined_or_null:
317     case op_jnundefined_or_null:
318     case op_jneq_ptr:
319     case op_jless:
320     case op_jlesseq:
321     case op_jgreater:
322     case op_jgreatereq:
323     case op_jnless:
324     case op_jnlesseq:
325     case op_jngreater:
326     case op_jngreatereq:
327     case op_jeq:
328     case op_jneq:
329     case op_jstricteq:
330     case op_jnstricteq:
331     case op_jbelow:
332     case op_jbeloweq:
333     case op_loop_hint:
334     case op_switch_imm:
335     case op_switch_char:
336     case op_switch_string:
337     case op_put_by_id:
338     case op_put_by_id_with_this:
339     case op_put_by_val_with_this:
340     case op_put_getter_by_id:
341     case op_put_setter_by_id:
342     case op_put_getter_setter_by_id:
343     case op_put_getter_by_val:
344     case op_put_setter_by_val:
345     case op_put_by_val:
346     case op_put_by_val_direct:
347     case op_put_internal_field:
348     case op_define_data_property:
349     case op_define_accessor_property:
350     case op_profile_type:
351     case op_profile_control_flow:
352     case op_put_to_arguments:
353     case op_set_function_name:
354     case op_check_traps:
355     case op_log_shadow_chicken_prologue:
356     case op_log_shadow_chicken_tail:
357     case op_yield:
358     case op_nop:
359     case op_unreachable:
360     case op_super_sampler_begin:
361     case op_super_sampler_end:
362 #define LLINT_HELPER_OPCODES(opcode, length) case opcode:
363         FOR_EACH_LLINT_OPCODE_EXTENSION(LLINT_HELPER_OPCODES);
364 #undef LLINT_HELPER_OPCODES
365         return;
366     // These all have a single destination for the first argument.
367     DEFS(OpArgumentCount, dst)
368     DEFS(OpToIndexString, dst)
369     DEFS(OpGetEnumerableLength, dst)
370     DEFS(OpHasIndexedProperty, dst)
371     DEFS(OpHasStructureProperty, dst)
372     DEFS(OpHasGenericProperty, dst)
373     DEFS(OpGetDirectPname, dst)
374     DEFS(OpGetPropertyEnumerator, dst)
375     DEFS(OpEnumeratorStructurePname, dst)
376     DEFS(OpEnumeratorGenericPname, dst)
377     DEFS(OpGetParentScope, dst)
378     DEFS(OpPushWithScope, dst)
379     DEFS(OpCreateLexicalEnvironment, dst)
380     DEFS(OpCreateGeneratorFrameEnvironment, dst)
381     DEFS(OpResolveScope, dst)
382     DEFS(OpResolveScopeForHoistingFuncDeclInEval, dst)
383     DEFS(OpStrcat, dst)
384     DEFS(OpToPrimitive, dst)
385     DEFS(OpToPropertyKey, dst)
386     DEFS(OpCreateThis, dst)
387     DEFS(OpCreatePromise, dst)
388     DEFS(OpCreateGenerator, dst)
389     DEFS(OpCreateAsyncGenerator, dst)
390     DEFS(OpNewArray, dst)
391     DEFS(OpNewArrayWithSpread, dst)
392     DEFS(OpSpread, dst)
393     DEFS(OpNewArrayBuffer, dst)
394     DEFS(OpNewArrayWithSize, dst)
395     DEFS(OpNewRegexp, dst)
396     DEFS(OpNewFunc, dst)
397     DEFS(OpNewFuncExp, dst)
398     DEFS(OpNewGeneratorFunc, dst)
399     DEFS(OpNewGeneratorFuncExp, dst)
400     DEFS(OpNewAsyncGeneratorFunc, dst)
401     DEFS(OpNewAsyncGeneratorFuncExp, dst)
402     DEFS(OpNewAsyncFunc, dst)
403     DEFS(OpNewAsyncFuncExp, dst)
404     DEFS(OpCallVarargs, dst)
405     DEFS(OpTailCallVarargs, dst)
406     DEFS(OpTailCallForwardArguments, dst)
407     DEFS(OpConstructVarargs, dst)
408     DEFS(OpGetFromScope, dst)
409     DEFS(OpCall, dst)
410     DEFS(OpTailCall, dst)
411     DEFS(OpCallEval, dst)
412     DEFS(OpConstruct, dst)
413     DEFS(OpTryGetById, dst)
414     DEFS(OpGetById, dst)
415     DEFS(OpGetByIdDirect, dst)
416     DEFS(OpGetByIdWithThis, dst)
417     DEFS(OpGetByValWithThis, dst)
418     DEFS(OpOverridesHasInstance, dst)
419     DEFS(OpInstanceof, dst)
420     DEFS(OpInstanceofCustom, dst)
421     DEFS(OpGetByVal, dst)
422     DEFS(OpTypeof, dst)
423     DEFS(OpIdentityWithProfile, srcDst)
424     DEFS(OpIsEmpty, dst)
425     DEFS(OpIsUndefined, dst)
426     USES(OpIsUndefinedOrNull, dst)
427     DEFS(OpIsBoolean, dst)
428     DEFS(OpIsNumber, dst)
429     DEFS(OpIsObject, dst)
430     DEFS(OpIsObjectOrNull, dst)
431     DEFS(OpIsCellWithType, dst)
432     DEFS(OpIsFunction, dst)
433     DEFS(OpInById, dst)
434     DEFS(OpInByVal, dst)
435     DEFS(OpToNumber, dst)
436     DEFS(OpToNumeric, dst)
437     DEFS(OpToString, dst)
438     DEFS(OpToObject, dst)
439     DEFS(OpNegate, dst)
440     DEFS(OpAdd, dst)
441     DEFS(OpMul, dst)
442     DEFS(OpDiv, dst)
443     DEFS(OpMod, dst)
444     DEFS(OpSub, dst)
445     DEFS(OpPow, dst)
446     DEFS(OpLshift, dst)
447     DEFS(OpRshift, dst)
448     DEFS(OpUrshift, dst)
449     DEFS(OpBitand, dst)
450     DEFS(OpBitxor, dst)
451     DEFS(OpBitor, dst)
452     DEFS(OpBitnot, dst)
453     DEFS(OpInc, srcDst)
454     DEFS(OpDec, srcDst)
455     DEFS(OpEq, dst)
456     DEFS(OpNeq, dst)
457     DEFS(OpStricteq, dst)
458     DEFS(OpNstricteq, dst)
459     DEFS(OpLess, dst)
460     DEFS(OpLesseq, dst)
461     DEFS(OpGreater, dst)
462     DEFS(OpGreatereq, dst)
463     DEFS(OpBelow, dst)
464     DEFS(OpBeloweq, dst)
465     DEFS(OpNeqNull, dst)
466     DEFS(OpEqNull, dst)
467     DEFS(OpNot, dst)
468     DEFS(OpMov, dst)
469     DEFS(OpNewObject, dst)
470     DEFS(OpNewPromise, dst)
471     DEFS(OpNewGenerator, dst)
472     DEFS(OpToThis, srcDst)
473     DEFS(OpGetScope, dst)
474     DEFS(OpCreateDirectArguments, dst)
475     DEFS(OpCreateScopedArguments, dst)
476     DEFS(OpCreateClonedArguments, dst)
477     DEFS(OpCreateArgumentsButterfly, dst)
478     DEFS(OpDelById, dst)
479     DEFS(OpDelByVal, dst)
480     DEFS(OpUnsigned, dst)
481     DEFS(OpGetFromArguments, dst)
482     DEFS(OpGetArgument, dst)
483     DEFS(OpCreateRest, dst)
484     DEFS(OpGetRestLength, dst)
485     DEFS(OpGetInternalField, dst)
486 
487     DEFS(OpCatch, exception, thrownValue)
488 
489     case op_enter: {
490         for (unsigned i = numVars; i--;)
491             functor(virtualRegisterForLocal(i));
492         return;
493     }
494     }
495 }
496 
497 #undef CALL_FUNCTOR
498 #undef USES_OR_DEFS
499 #undef USES
500 #undef DEFS
501 } // namespace JSC
    </pre>
  </body>
</html>