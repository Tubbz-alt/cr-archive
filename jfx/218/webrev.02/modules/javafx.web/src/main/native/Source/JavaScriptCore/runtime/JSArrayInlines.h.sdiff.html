<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/JavaScriptCore/runtime/JSArrayInlines.h</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="JSArrayBufferViewInlines.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="JSAsyncFunction.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/JavaScriptCore/runtime/JSArrayInlines.h</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  *  Copyright (C) 2016 Apple Inc. All rights reserved.</span>
  3  *
  4  *  This library is free software; you can redistribute it and/or
  5  *  modify it under the terms of the GNU Lesser General Public
  6  *  License as published by the Free Software Foundation; either
  7  *  version 2 of the License, or (at your option) any later version.
  8  *
  9  *  This library is distributed in the hope that it will be useful,
 10  *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 11  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 12  *  Lesser General Public License for more details.
 13  *
 14  *  You should have received a copy of the GNU Lesser General Public
 15  *  License along with this library; if not, write to the Free Software
 16  *  Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA
 17  *
 18  */
 19 
 20 #pragma once
 21 
 22 #include &quot;ArrayPrototype.h&quot;

 23 #include &quot;Error.h&quot;
 24 #include &quot;JSArray.h&quot;
 25 #include &quot;JSCellInlines.h&quot;
 26 #include &quot;Structure.h&quot;
 27 
 28 namespace JSC {
 29 
 30 inline IndexingType JSArray::mergeIndexingTypeForCopying(IndexingType other)
 31 {
 32     IndexingType type = indexingType();
 33     if (!(type &amp; IsArray &amp;&amp; other &amp; IsArray))
 34         return NonArray;
 35 
 36     if (hasAnyArrayStorage(type) || hasAnyArrayStorage(other))
 37         return NonArray;
 38 
 39     if (type == ArrayWithUndecided)
 40         return other;
 41 
 42     if (other == ArrayWithUndecided)
</pre>
<hr />
<pre>
 74 inline bool JSArray::canDoFastIndexedAccess(VM&amp; vm)
 75 {
 76     JSGlobalObject* globalObject = this-&gt;globalObject();
 77     if (!globalObject-&gt;arrayPrototypeChainIsSane())
 78         return false;
 79 
 80     Structure* structure = this-&gt;structure(vm);
 81     // This is the fast case. Many arrays will be an original array.
 82     if (globalObject-&gt;isOriginalArrayStructure(structure))
 83         return true;
 84 
 85     if (structure-&gt;mayInterceptIndexedAccesses())
 86         return false;
 87 
 88     if (getPrototypeDirect(vm) != globalObject-&gt;arrayPrototype())
 89         return false;
 90 
 91     return true;
 92 }
 93 
<span class="line-modified"> 94 ALWAYS_INLINE double toLength(ExecState* exec, JSObject* obj)</span>
 95 {
<span class="line-modified"> 96     VM&amp; vm = exec-&gt;vm();</span>
 97     auto scope = DECLARE_THROW_SCOPE(vm);
 98     if (LIKELY(isJSArray(obj)))
 99         return jsCast&lt;JSArray*&gt;(obj)-&gt;length();
100 
<span class="line-modified">101     JSValue lengthValue = obj-&gt;get(exec, vm.propertyNames-&gt;length);</span>
102     RETURN_IF_EXCEPTION(scope, PNaN);
<span class="line-modified">103     RELEASE_AND_RETURN(scope, lengthValue.toLength(exec));</span>
104 }
105 
<span class="line-modified">106 ALWAYS_INLINE void JSArray::pushInline(ExecState* exec, JSValue value)</span>
107 {
<span class="line-modified">108     VM&amp; vm = exec-&gt;vm();</span>
109     auto scope = DECLARE_THROW_SCOPE(vm);
110 
111     ensureWritable(vm);
112 
113     Butterfly* butterfly = this-&gt;butterfly();
114 
115     switch (indexingMode()) {
116     case ArrayClass: {
117         createInitialUndecided(vm, 0);
118         FALLTHROUGH;
119     }
120 
121     case ArrayWithUndecided: {
122         convertUndecidedForValue(vm, value);
123         scope.release();
<span class="line-modified">124         push(exec, value);</span>
125         return;
126     }
127 
128     case ArrayWithInt32: {
129         if (!value.isInt32()) {
130             convertInt32ForValue(vm, value);
131             scope.release();
<span class="line-modified">132             push(exec, value);</span>
133             return;
134         }
135 
136         unsigned length = butterfly-&gt;publicLength();
137         ASSERT(length &lt;= butterfly-&gt;vectorLength());
138         if (length &lt; butterfly-&gt;vectorLength()) {
139             butterfly-&gt;contiguousInt32().at(this, length).setWithoutWriteBarrier(value);
140             butterfly-&gt;setPublicLength(length + 1);
141             return;
142         }
143 
144         if (UNLIKELY(length &gt; MAX_ARRAY_INDEX)) {
<span class="line-modified">145             methodTable(vm)-&gt;putByIndex(this, exec, length, value, true);</span>
146             if (!scope.exception())
<span class="line-modified">147                 throwException(exec, scope, createRangeError(exec, LengthExceededTheMaximumArrayLengthError));</span>
148             return;
149         }
150 
151         scope.release();
<span class="line-modified">152         putByIndexBeyondVectorLengthWithoutAttributes&lt;Int32Shape&gt;(exec, length, value);</span>
153         return;
154     }
155 
156     case ArrayWithContiguous: {
157         unsigned length = butterfly-&gt;publicLength();
158         ASSERT(length &lt;= butterfly-&gt;vectorLength());
159         if (length &lt; butterfly-&gt;vectorLength()) {
<span class="line-modified">160             butterfly-&gt;contiguous().at(this, length).set(vm, this, value);</span>
161             butterfly-&gt;setPublicLength(length + 1);

162             return;
163         }
164 
165         if (UNLIKELY(length &gt; MAX_ARRAY_INDEX)) {
<span class="line-modified">166             methodTable(vm)-&gt;putByIndex(this, exec, length, value, true);</span>
167             if (!scope.exception())
<span class="line-modified">168                 throwException(exec, scope, createRangeError(exec, LengthExceededTheMaximumArrayLengthError));</span>
169             return;
170         }
171 
172         scope.release();
<span class="line-modified">173         putByIndexBeyondVectorLengthWithoutAttributes&lt;ContiguousShape&gt;(exec, length, value);</span>
174         return;
175     }
176 
177     case ArrayWithDouble: {
178         if (!value.isNumber()) {
179             convertDoubleToContiguous(vm);
180             scope.release();
<span class="line-modified">181             push(exec, value);</span>
182             return;
183         }
184         double valueAsDouble = value.asNumber();
185         if (valueAsDouble != valueAsDouble) {
186             convertDoubleToContiguous(vm);
187             scope.release();
<span class="line-modified">188             push(exec, value);</span>
189             return;
190         }
191 
192         unsigned length = butterfly-&gt;publicLength();
193         ASSERT(length &lt;= butterfly-&gt;vectorLength());
194         if (length &lt; butterfly-&gt;vectorLength()) {
195             butterfly-&gt;contiguousDouble().at(this, length) = valueAsDouble;
196             butterfly-&gt;setPublicLength(length + 1);
197             return;
198         }
199 
200         if (UNLIKELY(length &gt; MAX_ARRAY_INDEX)) {
<span class="line-modified">201             methodTable(vm)-&gt;putByIndex(this, exec, length, value, true);</span>
202             if (!scope.exception())
<span class="line-modified">203                 throwException(exec, scope, createRangeError(exec, LengthExceededTheMaximumArrayLengthError));</span>
204             return;
205         }
206 
207         scope.release();
<span class="line-modified">208         putByIndexBeyondVectorLengthWithoutAttributes&lt;DoubleShape&gt;(exec, length, value);</span>
209         return;
210     }
211 
212     case ArrayWithSlowPutArrayStorage: {
213         unsigned oldLength = length();
214         bool putResult = false;
<span class="line-modified">215         bool result = attemptToInterceptPutByIndexOnHole(exec, oldLength, value, true, putResult);</span>
216         RETURN_IF_EXCEPTION(scope, void());
217         if (result) {
218             if (oldLength &lt; 0xFFFFFFFFu) {
219                 scope.release();
<span class="line-modified">220                 setLength(exec, oldLength + 1, true);</span>
221             }
222             return;
223         }
224         FALLTHROUGH;
225     }
226 
227     case ArrayWithArrayStorage: {
228         ArrayStorage* storage = butterfly-&gt;arrayStorage();
229 
230         // Fast case - push within vector, always update m_length &amp; m_numValuesInVector.
231         unsigned length = storage-&gt;length();
232         if (length &lt; storage-&gt;vectorLength()) {
233             storage-&gt;m_vector[length].set(vm, this, value);
234             storage-&gt;setLength(length + 1);
235             ++storage-&gt;m_numValuesInVector;
236             return;
237         }
238 
239         // Pushing to an array of invalid length (2^31-1) stores the property, but throws a range error.
240         if (UNLIKELY(storage-&gt;length() &gt; MAX_ARRAY_INDEX)) {
<span class="line-modified">241             methodTable(vm)-&gt;putByIndex(this, exec, storage-&gt;length(), value, true);</span>
242             // Per ES5.1 15.4.4.7 step 6 &amp; 15.4.5.1 step 3.d.
243             if (!scope.exception())
<span class="line-modified">244                 throwException(exec, scope, createRangeError(exec, LengthExceededTheMaximumArrayLengthError));</span>
245             return;
246         }
247 
248         // Handled the same as putIndex.
249         scope.release();
<span class="line-modified">250         putByIndexBeyondVectorLengthWithArrayStorage(exec, storage-&gt;length(), value, true, storage);</span>
251         return;
252     }
253 
254     default:
255         RELEASE_ASSERT_NOT_REACHED();
256     }
257 }
258 
259 } // namespace JSC
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  *  Copyright (C) 2016-2019 Apple Inc. All rights reserved.</span>
  3  *
  4  *  This library is free software; you can redistribute it and/or
  5  *  modify it under the terms of the GNU Lesser General Public
  6  *  License as published by the Free Software Foundation; either
  7  *  version 2 of the License, or (at your option) any later version.
  8  *
  9  *  This library is distributed in the hope that it will be useful,
 10  *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 11  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 12  *  Lesser General Public License for more details.
 13  *
 14  *  You should have received a copy of the GNU Lesser General Public
 15  *  License along with this library; if not, write to the Free Software
 16  *  Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA
 17  *
 18  */
 19 
 20 #pragma once
 21 
 22 #include &quot;ArrayPrototype.h&quot;
<span class="line-added"> 23 #include &quot;ButterflyInlines.h&quot;</span>
 24 #include &quot;Error.h&quot;
 25 #include &quot;JSArray.h&quot;
 26 #include &quot;JSCellInlines.h&quot;
 27 #include &quot;Structure.h&quot;
 28 
 29 namespace JSC {
 30 
 31 inline IndexingType JSArray::mergeIndexingTypeForCopying(IndexingType other)
 32 {
 33     IndexingType type = indexingType();
 34     if (!(type &amp; IsArray &amp;&amp; other &amp; IsArray))
 35         return NonArray;
 36 
 37     if (hasAnyArrayStorage(type) || hasAnyArrayStorage(other))
 38         return NonArray;
 39 
 40     if (type == ArrayWithUndecided)
 41         return other;
 42 
 43     if (other == ArrayWithUndecided)
</pre>
<hr />
<pre>
 75 inline bool JSArray::canDoFastIndexedAccess(VM&amp; vm)
 76 {
 77     JSGlobalObject* globalObject = this-&gt;globalObject();
 78     if (!globalObject-&gt;arrayPrototypeChainIsSane())
 79         return false;
 80 
 81     Structure* structure = this-&gt;structure(vm);
 82     // This is the fast case. Many arrays will be an original array.
 83     if (globalObject-&gt;isOriginalArrayStructure(structure))
 84         return true;
 85 
 86     if (structure-&gt;mayInterceptIndexedAccesses())
 87         return false;
 88 
 89     if (getPrototypeDirect(vm) != globalObject-&gt;arrayPrototype())
 90         return false;
 91 
 92     return true;
 93 }
 94 
<span class="line-modified"> 95 ALWAYS_INLINE double toLength(JSGlobalObject* globalObject, JSObject* obj)</span>
 96 {
<span class="line-modified"> 97     VM&amp; vm = globalObject-&gt;vm();</span>
 98     auto scope = DECLARE_THROW_SCOPE(vm);
 99     if (LIKELY(isJSArray(obj)))
100         return jsCast&lt;JSArray*&gt;(obj)-&gt;length();
101 
<span class="line-modified">102     JSValue lengthValue = obj-&gt;get(globalObject, vm.propertyNames-&gt;length);</span>
103     RETURN_IF_EXCEPTION(scope, PNaN);
<span class="line-modified">104     RELEASE_AND_RETURN(scope, lengthValue.toLength(globalObject));</span>
105 }
106 
<span class="line-modified">107 ALWAYS_INLINE void JSArray::pushInline(JSGlobalObject* globalObject, JSValue value)</span>
108 {
<span class="line-modified">109     VM&amp; vm = globalObject-&gt;vm();</span>
110     auto scope = DECLARE_THROW_SCOPE(vm);
111 
112     ensureWritable(vm);
113 
114     Butterfly* butterfly = this-&gt;butterfly();
115 
116     switch (indexingMode()) {
117     case ArrayClass: {
118         createInitialUndecided(vm, 0);
119         FALLTHROUGH;
120     }
121 
122     case ArrayWithUndecided: {
123         convertUndecidedForValue(vm, value);
124         scope.release();
<span class="line-modified">125         push(globalObject, value);</span>
126         return;
127     }
128 
129     case ArrayWithInt32: {
130         if (!value.isInt32()) {
131             convertInt32ForValue(vm, value);
132             scope.release();
<span class="line-modified">133             push(globalObject, value);</span>
134             return;
135         }
136 
137         unsigned length = butterfly-&gt;publicLength();
138         ASSERT(length &lt;= butterfly-&gt;vectorLength());
139         if (length &lt; butterfly-&gt;vectorLength()) {
140             butterfly-&gt;contiguousInt32().at(this, length).setWithoutWriteBarrier(value);
141             butterfly-&gt;setPublicLength(length + 1);
142             return;
143         }
144 
145         if (UNLIKELY(length &gt; MAX_ARRAY_INDEX)) {
<span class="line-modified">146             methodTable(vm)-&gt;putByIndex(this, globalObject, length, value, true);</span>
147             if (!scope.exception())
<span class="line-modified">148                 throwException(globalObject, scope, createRangeError(globalObject, LengthExceededTheMaximumArrayLengthError));</span>
149             return;
150         }
151 
152         scope.release();
<span class="line-modified">153         putByIndexBeyondVectorLengthWithoutAttributes&lt;Int32Shape&gt;(globalObject, length, value);</span>
154         return;
155     }
156 
157     case ArrayWithContiguous: {
158         unsigned length = butterfly-&gt;publicLength();
159         ASSERT(length &lt;= butterfly-&gt;vectorLength());
160         if (length &lt; butterfly-&gt;vectorLength()) {
<span class="line-modified">161             butterfly-&gt;contiguous().at(this, length).setWithoutWriteBarrier(value);</span>
162             butterfly-&gt;setPublicLength(length + 1);
<span class="line-added">163             vm.heap.writeBarrier(this, value);</span>
164             return;
165         }
166 
167         if (UNLIKELY(length &gt; MAX_ARRAY_INDEX)) {
<span class="line-modified">168             methodTable(vm)-&gt;putByIndex(this, globalObject, length, value, true);</span>
169             if (!scope.exception())
<span class="line-modified">170                 throwException(globalObject, scope, createRangeError(globalObject, LengthExceededTheMaximumArrayLengthError));</span>
171             return;
172         }
173 
174         scope.release();
<span class="line-modified">175         putByIndexBeyondVectorLengthWithoutAttributes&lt;ContiguousShape&gt;(globalObject, length, value);</span>
176         return;
177     }
178 
179     case ArrayWithDouble: {
180         if (!value.isNumber()) {
181             convertDoubleToContiguous(vm);
182             scope.release();
<span class="line-modified">183             push(globalObject, value);</span>
184             return;
185         }
186         double valueAsDouble = value.asNumber();
187         if (valueAsDouble != valueAsDouble) {
188             convertDoubleToContiguous(vm);
189             scope.release();
<span class="line-modified">190             push(globalObject, value);</span>
191             return;
192         }
193 
194         unsigned length = butterfly-&gt;publicLength();
195         ASSERT(length &lt;= butterfly-&gt;vectorLength());
196         if (length &lt; butterfly-&gt;vectorLength()) {
197             butterfly-&gt;contiguousDouble().at(this, length) = valueAsDouble;
198             butterfly-&gt;setPublicLength(length + 1);
199             return;
200         }
201 
202         if (UNLIKELY(length &gt; MAX_ARRAY_INDEX)) {
<span class="line-modified">203             methodTable(vm)-&gt;putByIndex(this, globalObject, length, value, true);</span>
204             if (!scope.exception())
<span class="line-modified">205                 throwException(globalObject, scope, createRangeError(globalObject, LengthExceededTheMaximumArrayLengthError));</span>
206             return;
207         }
208 
209         scope.release();
<span class="line-modified">210         putByIndexBeyondVectorLengthWithoutAttributes&lt;DoubleShape&gt;(globalObject, length, value);</span>
211         return;
212     }
213 
214     case ArrayWithSlowPutArrayStorage: {
215         unsigned oldLength = length();
216         bool putResult = false;
<span class="line-modified">217         bool result = attemptToInterceptPutByIndexOnHole(globalObject, oldLength, value, true, putResult);</span>
218         RETURN_IF_EXCEPTION(scope, void());
219         if (result) {
220             if (oldLength &lt; 0xFFFFFFFFu) {
221                 scope.release();
<span class="line-modified">222                 setLength(globalObject, oldLength + 1, true);</span>
223             }
224             return;
225         }
226         FALLTHROUGH;
227     }
228 
229     case ArrayWithArrayStorage: {
230         ArrayStorage* storage = butterfly-&gt;arrayStorage();
231 
232         // Fast case - push within vector, always update m_length &amp; m_numValuesInVector.
233         unsigned length = storage-&gt;length();
234         if (length &lt; storage-&gt;vectorLength()) {
235             storage-&gt;m_vector[length].set(vm, this, value);
236             storage-&gt;setLength(length + 1);
237             ++storage-&gt;m_numValuesInVector;
238             return;
239         }
240 
241         // Pushing to an array of invalid length (2^31-1) stores the property, but throws a range error.
242         if (UNLIKELY(storage-&gt;length() &gt; MAX_ARRAY_INDEX)) {
<span class="line-modified">243             methodTable(vm)-&gt;putByIndex(this, globalObject, storage-&gt;length(), value, true);</span>
244             // Per ES5.1 15.4.4.7 step 6 &amp; 15.4.5.1 step 3.d.
245             if (!scope.exception())
<span class="line-modified">246                 throwException(globalObject, scope, createRangeError(globalObject, LengthExceededTheMaximumArrayLengthError));</span>
247             return;
248         }
249 
250         // Handled the same as putIndex.
251         scope.release();
<span class="line-modified">252         putByIndexBeyondVectorLengthWithArrayStorage(globalObject, storage-&gt;length(), value, true, storage);</span>
253         return;
254     }
255 
256     default:
257         RELEASE_ASSERT_NOT_REACHED();
258     }
259 }
260 
261 } // namespace JSC
</pre>
</td>
</tr>
</table>
<center><a href="JSArrayBufferViewInlines.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="JSAsyncFunction.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>