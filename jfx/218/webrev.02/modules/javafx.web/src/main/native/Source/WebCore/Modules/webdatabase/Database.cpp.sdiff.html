<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WebCore/Modules/webdatabase/Database.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../webauthn/fido/U2fResponseConverter.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="DatabaseContext.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/Modules/webdatabase/Database.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 35 #include &quot;DatabaseAuthorizer.h&quot;
 36 #include &quot;DatabaseCallback.h&quot;
 37 #include &quot;DatabaseContext.h&quot;
 38 #include &quot;DatabaseManager.h&quot;
 39 #include &quot;DatabaseTask.h&quot;
 40 #include &quot;DatabaseThread.h&quot;
 41 #include &quot;DatabaseTracker.h&quot;
 42 #include &quot;Document.h&quot;
 43 #include &quot;JSDOMWindow.h&quot;
 44 #include &quot;Logging.h&quot;
 45 #include &quot;SQLError.h&quot;
 46 #include &quot;SQLTransaction.h&quot;
 47 #include &quot;SQLTransactionCallback.h&quot;
 48 #include &quot;SQLTransactionErrorCallback.h&quot;
 49 #include &quot;SQLiteDatabaseTracker.h&quot;
 50 #include &quot;SQLiteStatement.h&quot;
 51 #include &quot;SQLiteTransaction.h&quot;
 52 #include &quot;ScriptExecutionContext.h&quot;
 53 #include &quot;SecurityOrigin.h&quot;
 54 #include &quot;VoidCallback.h&quot;

 55 #include &lt;wtf/NeverDestroyed.h&gt;
 56 #include &lt;wtf/RefPtr.h&gt;
 57 #include &lt;wtf/StdLibExtras.h&gt;
 58 #include &lt;wtf/text/CString.h&gt;
 59 
 60 namespace WebCore {
 61 
 62 // Registering &quot;opened&quot; databases with the DatabaseTracker
 63 // =======================================================
 64 // The DatabaseTracker maintains a list of databases that have been
 65 // &quot;opened&quot; so that the client can call interrupt or delete on every database
 66 // associated with a DatabaseContext.
 67 //
 68 // We will only call DatabaseTracker::addOpenDatabase() to add the database
 69 // to the tracker as opened when we&#39;ve succeeded in opening the database,
 70 // and will set m_opened to true. Similarly, we only call
 71 // DatabaseTracker::removeOpenDatabase() to remove the database from the
 72 // tracker when we set m_opened to false in closeDatabase(). This sets up
 73 // a simple symmetry between open and close operations, and a direct
 74 // correlation to adding and removing databases from the tracker&#39;s list,
</pre>
<hr />
<pre>
667     return m_databaseAuthorizer-&gt;lastActionWasInsert();
668 }
669 
670 void Database::resetDeletes()
671 {
672     m_databaseAuthorizer-&gt;resetDeletes();
673 }
674 
675 bool Database::hadDeletes()
676 {
677     return m_databaseAuthorizer-&gt;hadDeletes();
678 }
679 
680 void Database::resetAuthorizer()
681 {
682     m_databaseAuthorizer-&gt;reset();
683 }
684 
685 void Database::runTransaction(RefPtr&lt;SQLTransactionCallback&gt;&amp;&amp; callback, RefPtr&lt;SQLTransactionErrorCallback&gt;&amp;&amp; errorCallback, RefPtr&lt;VoidCallback&gt;&amp;&amp; successCallback, RefPtr&lt;SQLTransactionWrapper&gt;&amp;&amp; wrapper, bool readOnly)
686 {

687     LockHolder locker(m_transactionInProgressMutex);
688     if (!m_isTransactionQueueEnabled) {
689         if (errorCallback) {
<span class="line-modified">690             callOnMainThread([errorCallback = makeRef(*errorCallback)]() {</span>
691                 errorCallback-&gt;handleEvent(SQLError::create(SQLError::UNKNOWN_ERR, &quot;database has been closed&quot;));
692             });
693         }
694         return;
695     }
696 
697     m_transactionQueue.append(SQLTransaction::create(*this, WTFMove(callback), WTFMove(successCallback), errorCallback.copyRef(), WTFMove(wrapper), readOnly));
698     if (!m_transactionInProgress)
699         scheduleTransaction();
700 }
701 
702 void Database::scheduleTransactionCallback(SQLTransaction* transaction)
703 {
<span class="line-modified">704     callOnMainThread([transaction = makeRefPtr(transaction)] {</span>
<span class="line-modified">705         transaction-&gt;performPendingCallback();</span>


706     });
707 }
708 
709 Vector&lt;String&gt; Database::performGetTableNames()
710 {
711     disableAuthorizer();
712 
713     SQLiteStatement statement(sqliteDatabase(), &quot;SELECT name FROM sqlite_master WHERE type=&#39;table&#39;;&quot;);
714     if (statement.prepare() != SQLITE_OK) {
715         LOG_ERROR(&quot;Unable to retrieve list of tables for database %s&quot;, databaseDebugName().ascii().data());
716         enableAuthorizer();
717         return Vector&lt;String&gt;();
718     }
719 
720     Vector&lt;String&gt; tableNames;
721     int result;
722     while ((result = statement.step()) == SQLITE_ROW) {
723         String name = statement.getColumnText(0);
724         if (name != unqualifiedInfoTableName)
725             tableNames.append(name);
</pre>
</td>
<td>
<hr />
<pre>
 35 #include &quot;DatabaseAuthorizer.h&quot;
 36 #include &quot;DatabaseCallback.h&quot;
 37 #include &quot;DatabaseContext.h&quot;
 38 #include &quot;DatabaseManager.h&quot;
 39 #include &quot;DatabaseTask.h&quot;
 40 #include &quot;DatabaseThread.h&quot;
 41 #include &quot;DatabaseTracker.h&quot;
 42 #include &quot;Document.h&quot;
 43 #include &quot;JSDOMWindow.h&quot;
 44 #include &quot;Logging.h&quot;
 45 #include &quot;SQLError.h&quot;
 46 #include &quot;SQLTransaction.h&quot;
 47 #include &quot;SQLTransactionCallback.h&quot;
 48 #include &quot;SQLTransactionErrorCallback.h&quot;
 49 #include &quot;SQLiteDatabaseTracker.h&quot;
 50 #include &quot;SQLiteStatement.h&quot;
 51 #include &quot;SQLiteTransaction.h&quot;
 52 #include &quot;ScriptExecutionContext.h&quot;
 53 #include &quot;SecurityOrigin.h&quot;
 54 #include &quot;VoidCallback.h&quot;
<span class="line-added"> 55 #include &quot;WindowEventLoop.h&quot;</span>
 56 #include &lt;wtf/NeverDestroyed.h&gt;
 57 #include &lt;wtf/RefPtr.h&gt;
 58 #include &lt;wtf/StdLibExtras.h&gt;
 59 #include &lt;wtf/text/CString.h&gt;
 60 
 61 namespace WebCore {
 62 
 63 // Registering &quot;opened&quot; databases with the DatabaseTracker
 64 // =======================================================
 65 // The DatabaseTracker maintains a list of databases that have been
 66 // &quot;opened&quot; so that the client can call interrupt or delete on every database
 67 // associated with a DatabaseContext.
 68 //
 69 // We will only call DatabaseTracker::addOpenDatabase() to add the database
 70 // to the tracker as opened when we&#39;ve succeeded in opening the database,
 71 // and will set m_opened to true. Similarly, we only call
 72 // DatabaseTracker::removeOpenDatabase() to remove the database from the
 73 // tracker when we set m_opened to false in closeDatabase(). This sets up
 74 // a simple symmetry between open and close operations, and a direct
 75 // correlation to adding and removing databases from the tracker&#39;s list,
</pre>
<hr />
<pre>
668     return m_databaseAuthorizer-&gt;lastActionWasInsert();
669 }
670 
671 void Database::resetDeletes()
672 {
673     m_databaseAuthorizer-&gt;resetDeletes();
674 }
675 
676 bool Database::hadDeletes()
677 {
678     return m_databaseAuthorizer-&gt;hadDeletes();
679 }
680 
681 void Database::resetAuthorizer()
682 {
683     m_databaseAuthorizer-&gt;reset();
684 }
685 
686 void Database::runTransaction(RefPtr&lt;SQLTransactionCallback&gt;&amp;&amp; callback, RefPtr&lt;SQLTransactionErrorCallback&gt;&amp;&amp; errorCallback, RefPtr&lt;VoidCallback&gt;&amp;&amp; successCallback, RefPtr&lt;SQLTransactionWrapper&gt;&amp;&amp; wrapper, bool readOnly)
687 {
<span class="line-added">688     ASSERT(isMainThread());</span>
689     LockHolder locker(m_transactionInProgressMutex);
690     if (!m_isTransactionQueueEnabled) {
691         if (errorCallback) {
<span class="line-modified">692             m_document-&gt;eventLoop().queueTask(TaskSource::Networking, [errorCallback = makeRef(*errorCallback)]() {</span>
693                 errorCallback-&gt;handleEvent(SQLError::create(SQLError::UNKNOWN_ERR, &quot;database has been closed&quot;));
694             });
695         }
696         return;
697     }
698 
699     m_transactionQueue.append(SQLTransaction::create(*this, WTFMove(callback), WTFMove(successCallback), errorCallback.copyRef(), WTFMove(wrapper), readOnly));
700     if (!m_transactionInProgress)
701         scheduleTransaction();
702 }
703 
704 void Database::scheduleTransactionCallback(SQLTransaction* transaction)
705 {
<span class="line-modified">706     callOnMainThread([this, protectedThis = makeRef(*this), transaction = makeRefPtr(transaction)] {</span>
<span class="line-modified">707         m_document-&gt;eventLoop().queueTask(TaskSource::Networking, [transaction = transaction.copyRef()] {</span>
<span class="line-added">708             transaction-&gt;performPendingCallback();</span>
<span class="line-added">709         });</span>
710     });
711 }
712 
713 Vector&lt;String&gt; Database::performGetTableNames()
714 {
715     disableAuthorizer();
716 
717     SQLiteStatement statement(sqliteDatabase(), &quot;SELECT name FROM sqlite_master WHERE type=&#39;table&#39;;&quot;);
718     if (statement.prepare() != SQLITE_OK) {
719         LOG_ERROR(&quot;Unable to retrieve list of tables for database %s&quot;, databaseDebugName().ascii().data());
720         enableAuthorizer();
721         return Vector&lt;String&gt;();
722     }
723 
724     Vector&lt;String&gt; tableNames;
725     int result;
726     while ((result = statement.step()) == SQLITE_ROW) {
727         String name = statement.getColumnText(0);
728         if (name != unqualifiedInfoTableName)
729             tableNames.append(name);
</pre>
</td>
</tr>
</table>
<center><a href="../webauthn/fido/U2fResponseConverter.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="DatabaseContext.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>