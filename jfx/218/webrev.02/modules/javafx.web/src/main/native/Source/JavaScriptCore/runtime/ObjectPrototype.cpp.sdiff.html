<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/JavaScriptCore/runtime/ObjectPrototype.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="ObjectPropertyChangeAdaptiveWatchpoint.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="ObjectPrototype.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/JavaScriptCore/runtime/ObjectPrototype.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 16  *  License along with this library; if not, write to the Free Software
 17  *  Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA
 18  *
 19  */
 20 
 21 #include &quot;config.h&quot;
 22 #include &quot;ObjectPrototype.h&quot;
 23 
 24 #include &quot;Error.h&quot;
 25 #include &quot;GetterSetter.h&quot;
 26 #include &quot;HasOwnPropertyCache.h&quot;
 27 #include &quot;JSFunction.h&quot;
 28 #include &quot;JSString.h&quot;
 29 #include &quot;JSCInlines.h&quot;
 30 #include &quot;PropertySlot.h&quot;
 31 #include &quot;StructureInlines.h&quot;
 32 #include &quot;StructureRareDataInlines.h&quot;
 33 
 34 namespace JSC {
 35 
<span class="line-modified"> 36 static EncodedJSValue JSC_HOST_CALL objectProtoFuncValueOf(ExecState*);</span>
<span class="line-modified"> 37 static EncodedJSValue JSC_HOST_CALL objectProtoFuncHasOwnProperty(ExecState*);</span>
<span class="line-modified"> 38 static EncodedJSValue JSC_HOST_CALL objectProtoFuncIsPrototypeOf(ExecState*);</span>
<span class="line-modified"> 39 static EncodedJSValue JSC_HOST_CALL objectProtoFuncDefineGetter(ExecState*);</span>
<span class="line-modified"> 40 static EncodedJSValue JSC_HOST_CALL objectProtoFuncDefineSetter(ExecState*);</span>
<span class="line-modified"> 41 static EncodedJSValue JSC_HOST_CALL objectProtoFuncLookupGetter(ExecState*);</span>
<span class="line-modified"> 42 static EncodedJSValue JSC_HOST_CALL objectProtoFuncLookupSetter(ExecState*);</span>
<span class="line-modified"> 43 static EncodedJSValue JSC_HOST_CALL objectProtoFuncPropertyIsEnumerable(ExecState*);</span>
<span class="line-modified"> 44 static EncodedJSValue JSC_HOST_CALL objectProtoFuncToLocaleString(ExecState*);</span>
 45 
 46 STATIC_ASSERT_IS_TRIVIALLY_DESTRUCTIBLE(ObjectPrototype);
 47 
 48 const ClassInfo ObjectPrototype::s_info = { &quot;Object&quot;, &amp;JSNonFinalObject::s_info, nullptr, nullptr, CREATE_METHOD_TABLE(ObjectPrototype) };
 49 
 50 ObjectPrototype::ObjectPrototype(VM&amp; vm, Structure* stucture)
 51     : JSNonFinalObject(vm, stucture)
 52 {
 53 }
 54 
 55 void ObjectPrototype::finishCreation(VM&amp; vm, JSGlobalObject* globalObject)
 56 {
 57     Base::finishCreation(vm);
 58     ASSERT(inherits(vm, info()));
 59 
 60     JSC_NATIVE_FUNCTION_WITHOUT_TRANSITION(vm.propertyNames-&gt;toString, objectProtoFuncToString, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum), 0);
 61     JSC_NATIVE_FUNCTION_WITHOUT_TRANSITION(vm.propertyNames-&gt;toLocaleString, objectProtoFuncToLocaleString, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum), 0);
 62     JSC_NATIVE_FUNCTION_WITHOUT_TRANSITION(vm.propertyNames-&gt;valueOf, objectProtoFuncValueOf, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum), 0);
 63     JSC_NATIVE_INTRINSIC_FUNCTION_WITHOUT_TRANSITION(vm.propertyNames-&gt;hasOwnProperty, objectProtoFuncHasOwnProperty, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum), 1, HasOwnPropertyIntrinsic);
 64     JSC_NATIVE_FUNCTION_WITHOUT_TRANSITION(vm.propertyNames-&gt;propertyIsEnumerable, objectProtoFuncPropertyIsEnumerable, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum), 1);
 65     JSC_NATIVE_FUNCTION_WITHOUT_TRANSITION(vm.propertyNames-&gt;isPrototypeOf, objectProtoFuncIsPrototypeOf, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum), 1);
 66     JSC_NATIVE_FUNCTION_WITHOUT_TRANSITION(vm.propertyNames-&gt;__defineGetter__, objectProtoFuncDefineGetter, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum), 2);
 67     JSC_NATIVE_FUNCTION_WITHOUT_TRANSITION(vm.propertyNames-&gt;__defineSetter__, objectProtoFuncDefineSetter, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum), 2);
 68     JSC_NATIVE_FUNCTION_WITHOUT_TRANSITION(vm.propertyNames-&gt;__lookupGetter__, objectProtoFuncLookupGetter, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum), 1);
 69     JSC_NATIVE_FUNCTION_WITHOUT_TRANSITION(vm.propertyNames-&gt;__lookupSetter__, objectProtoFuncLookupSetter, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum), 1);
 70 }
 71 
 72 ObjectPrototype* ObjectPrototype::create(VM&amp; vm, JSGlobalObject* globalObject, Structure* structure)
 73 {
 74     ObjectPrototype* prototype = new (NotNull, allocateCell&lt;ObjectPrototype&gt;(vm.heap)) ObjectPrototype(vm, structure);
 75     prototype-&gt;finishCreation(vm, globalObject);
 76     return prototype;
 77 }
 78 
 79 // ------------------------------ Functions --------------------------------
 80 
<span class="line-modified"> 81 EncodedJSValue JSC_HOST_CALL objectProtoFuncValueOf(ExecState* exec)</span>
 82 {
<span class="line-modified"> 83     JSValue thisValue = exec-&gt;thisValue().toThis(exec, StrictMode);</span>
<span class="line-modified"> 84     JSObject* valueObj = thisValue.toObject(exec);</span>
 85     if (UNLIKELY(!valueObj))
 86         return encodedJSValue();
 87     return JSValue::encode(valueObj);
 88 }
 89 
<span class="line-modified"> 90 EncodedJSValue JSC_HOST_CALL objectProtoFuncHasOwnProperty(ExecState* exec)</span>
 91 {
<span class="line-modified"> 92     VM&amp; vm = exec-&gt;vm();</span>
 93     auto scope = DECLARE_THROW_SCOPE(vm);
 94 
<span class="line-modified"> 95     JSValue thisValue = exec-&gt;thisValue().toThis(exec, StrictMode);</span>
<span class="line-modified"> 96     auto propertyName = exec-&gt;argument(0).toPropertyKey(exec);</span>
 97     RETURN_IF_EXCEPTION(scope, encodedJSValue());
<span class="line-modified"> 98     JSObject* thisObject = thisValue.toObject(exec);</span>
 99     EXCEPTION_ASSERT(!!scope.exception() == !thisObject);
100     if (UNLIKELY(!thisObject))
101         return encodedJSValue();
102 
103     Structure* structure = thisObject-&gt;structure(vm);
104     HasOwnPropertyCache* hasOwnPropertyCache = vm.ensureHasOwnPropertyCache();
105     if (Optional&lt;bool&gt; result = hasOwnPropertyCache-&gt;get(structure, propertyName)) {
<span class="line-modified">106         ASSERT(*result == thisObject-&gt;hasOwnProperty(exec, propertyName));</span>
107         scope.assertNoException();
108         return JSValue::encode(jsBoolean(*result));
109     }
110 
111     PropertySlot slot(thisObject, PropertySlot::InternalMethodType::GetOwnProperty);
<span class="line-modified">112     bool result = thisObject-&gt;hasOwnProperty(exec, propertyName, slot);</span>
113     RETURN_IF_EXCEPTION(scope, encodedJSValue());
114 
115     hasOwnPropertyCache-&gt;tryAdd(vm, slot, thisObject, propertyName, result);
116     return JSValue::encode(jsBoolean(result));
117 }
118 
<span class="line-modified">119 EncodedJSValue JSC_HOST_CALL objectProtoFuncIsPrototypeOf(ExecState* exec)</span>
120 {
<span class="line-modified">121     VM&amp; vm = exec-&gt;vm();</span>
122     auto scope = DECLARE_THROW_SCOPE(vm);
123 
<span class="line-modified">124     JSValue thisValue = exec-&gt;thisValue().toThis(exec, StrictMode);</span>
<span class="line-modified">125     JSObject* thisObj = thisValue.toObject(exec);</span>



126     EXCEPTION_ASSERT(!!scope.exception() == !thisObj);
127     if (UNLIKELY(!thisObj))
128         return encodedJSValue();
129 
<span class="line-modified">130     if (!exec-&gt;argument(0).isObject())</span>
<span class="line-removed">131         return JSValue::encode(jsBoolean(false));</span>
<span class="line-removed">132 </span>
<span class="line-removed">133     JSValue v = asObject(exec-&gt;argument(0))-&gt;getPrototype(vm, exec);</span>
134     RETURN_IF_EXCEPTION(scope, encodedJSValue());
135 
136     while (true) {
137         if (!v.isObject())
138             return JSValue::encode(jsBoolean(false));
139         if (v == thisObj)
140             return JSValue::encode(jsBoolean(true));
<span class="line-modified">141         v = asObject(v)-&gt;getPrototype(vm, exec);</span>
142         RETURN_IF_EXCEPTION(scope, encodedJSValue());
143     }
144 }
145 
<span class="line-modified">146 EncodedJSValue JSC_HOST_CALL objectProtoFuncDefineGetter(ExecState* exec)</span>
147 {
<span class="line-modified">148     VM&amp; vm = exec-&gt;vm();</span>
149     auto scope = DECLARE_THROW_SCOPE(vm);
150 
<span class="line-modified">151     JSObject* thisObject = exec-&gt;thisValue().toThis(exec, StrictMode).toObject(exec);</span>
152     RETURN_IF_EXCEPTION(scope, encodedJSValue());
153 
<span class="line-modified">154     JSValue get = exec-&gt;argument(1);</span>
155     CallData callData;
156     if (getCallData(vm, get, callData) == CallType::None)
<span class="line-modified">157         return throwVMTypeError(exec, scope, &quot;invalid getter usage&quot;_s);</span>
158 
<span class="line-modified">159     auto propertyName = exec-&gt;argument(0).toPropertyKey(exec);</span>
160     RETURN_IF_EXCEPTION(scope, encodedJSValue());
161 
162     PropertyDescriptor descriptor;
163     descriptor.setGetter(get);
164     descriptor.setEnumerable(true);
165     descriptor.setConfigurable(true);
166 
167     bool shouldThrow = true;
168     scope.release();
<span class="line-modified">169     thisObject-&gt;methodTable(vm)-&gt;defineOwnProperty(thisObject, exec, propertyName, descriptor, shouldThrow);</span>
170 
171     return JSValue::encode(jsUndefined());
172 }
173 
<span class="line-modified">174 EncodedJSValue JSC_HOST_CALL objectProtoFuncDefineSetter(ExecState* exec)</span>
175 {
<span class="line-modified">176     VM&amp; vm = exec-&gt;vm();</span>
177     auto scope = DECLARE_THROW_SCOPE(vm);
178 
<span class="line-modified">179     JSObject* thisObject = exec-&gt;thisValue().toThis(exec, StrictMode).toObject(exec);</span>
180     RETURN_IF_EXCEPTION(scope, encodedJSValue());
181 
<span class="line-modified">182     JSValue set = exec-&gt;argument(1);</span>
183     CallData callData;
184     if (getCallData(vm, set, callData) == CallType::None)
<span class="line-modified">185         return throwVMTypeError(exec, scope, &quot;invalid setter usage&quot;_s);</span>
186 
<span class="line-modified">187     auto propertyName = exec-&gt;argument(0).toPropertyKey(exec);</span>
188     RETURN_IF_EXCEPTION(scope, encodedJSValue());
189 
190     PropertyDescriptor descriptor;
191     descriptor.setSetter(set);
192     descriptor.setEnumerable(true);
193     descriptor.setConfigurable(true);
194 
195     bool shouldThrow = true;
196     scope.release();
<span class="line-modified">197     thisObject-&gt;methodTable(vm)-&gt;defineOwnProperty(thisObject, exec, propertyName, descriptor, shouldThrow);</span>
198 
199     return JSValue::encode(jsUndefined());
200 }
201 
<span class="line-modified">202 EncodedJSValue JSC_HOST_CALL objectProtoFuncLookupGetter(ExecState* exec)</span>
203 {
<span class="line-modified">204     VM&amp; vm = exec-&gt;vm();</span>
205     auto scope = DECLARE_THROW_SCOPE(vm);
206 
<span class="line-modified">207     JSObject* thisObject = exec-&gt;thisValue().toThis(exec, StrictMode).toObject(exec);</span>
208     RETURN_IF_EXCEPTION(scope, encodedJSValue());
209 
<span class="line-modified">210     auto propertyName = exec-&gt;argument(0).toPropertyKey(exec);</span>
211     RETURN_IF_EXCEPTION(scope, encodedJSValue());
212 
213     PropertySlot slot(thisObject, PropertySlot::InternalMethodType::GetOwnProperty);
<span class="line-modified">214     bool hasProperty = thisObject-&gt;getPropertySlot(exec, propertyName, slot);</span>
215     EXCEPTION_ASSERT(!scope.exception() || !hasProperty);
216     if (hasProperty) {
217         if (slot.isAccessor()) {
218             GetterSetter* getterSetter = slot.getterSetter();
219             return getterSetter-&gt;isGetterNull() ? JSValue::encode(jsUndefined()) : JSValue::encode(getterSetter-&gt;getter());
220         }
221         if (slot.attributes() &amp; PropertyAttribute::CustomAccessor) {
222             PropertyDescriptor descriptor;
223             ASSERT(slot.slotBase());
<span class="line-modified">224             if (slot.slotBase()-&gt;getOwnPropertyDescriptor(exec, propertyName, descriptor))</span>
225                 return descriptor.getterPresent() ? JSValue::encode(descriptor.getter()) : JSValue::encode(jsUndefined());
226         }
227     }
228 
229     return JSValue::encode(jsUndefined());
230 }
231 
<span class="line-modified">232 EncodedJSValue JSC_HOST_CALL objectProtoFuncLookupSetter(ExecState* exec)</span>
233 {
<span class="line-modified">234     VM&amp; vm = exec-&gt;vm();</span>
235     auto scope = DECLARE_THROW_SCOPE(vm);
236 
<span class="line-modified">237     JSObject* thisObject = exec-&gt;thisValue().toThis(exec, StrictMode).toObject(exec);</span>
238     RETURN_IF_EXCEPTION(scope, encodedJSValue());
239 
<span class="line-modified">240     auto propertyName = exec-&gt;argument(0).toPropertyKey(exec);</span>
241     RETURN_IF_EXCEPTION(scope, encodedJSValue());
242 
243     PropertySlot slot(thisObject, PropertySlot::InternalMethodType::GetOwnProperty);
<span class="line-modified">244     bool hasProperty = thisObject-&gt;getPropertySlot(exec, propertyName, slot);</span>
245     EXCEPTION_ASSERT(!scope.exception() || !hasProperty);
246     if (hasProperty) {
247         if (slot.isAccessor()) {
248             GetterSetter* getterSetter = slot.getterSetter();
249             return getterSetter-&gt;isSetterNull() ? JSValue::encode(jsUndefined()) : JSValue::encode(getterSetter-&gt;setter());
250         }
251         if (slot.attributes() &amp; PropertyAttribute::CustomAccessor) {
252             PropertyDescriptor descriptor;
253             ASSERT(slot.slotBase());
<span class="line-modified">254             if (slot.slotBase()-&gt;getOwnPropertyDescriptor(exec, propertyName, descriptor))</span>
255                 return descriptor.setterPresent() ? JSValue::encode(descriptor.setter()) : JSValue::encode(jsUndefined());
256         }
257     }
258 
259     return JSValue::encode(jsUndefined());
260 }
261 
<span class="line-modified">262 EncodedJSValue JSC_HOST_CALL objectProtoFuncPropertyIsEnumerable(ExecState* exec)</span>
263 {
<span class="line-modified">264     VM&amp; vm = exec-&gt;vm();</span>
265     auto scope = DECLARE_THROW_SCOPE(vm);
266 
<span class="line-modified">267     auto propertyName = exec-&gt;argument(0).toPropertyKey(exec);</span>
268     RETURN_IF_EXCEPTION(scope, encodedJSValue());
269 
<span class="line-modified">270     JSObject* thisObject = exec-&gt;thisValue().toThis(exec, StrictMode).toObject(exec);</span>
271     RETURN_IF_EXCEPTION(scope, encodedJSValue());
272 
273     scope.release();
274     PropertyDescriptor descriptor;
<span class="line-modified">275     bool enumerable = thisObject-&gt;getOwnPropertyDescriptor(exec, propertyName, descriptor) &amp;&amp; descriptor.enumerable();</span>
276     return JSValue::encode(jsBoolean(enumerable));
277 }
278 
279 // 15.2.4.3 Object.prototype.toLocaleString()
<span class="line-modified">280 EncodedJSValue JSC_HOST_CALL objectProtoFuncToLocaleString(ExecState* exec)</span>
281 {
<span class="line-modified">282     VM&amp; vm = exec-&gt;vm();</span>
283     auto scope = DECLARE_THROW_SCOPE(vm);
284 
285     // 1. Let V be the this value.
<span class="line-modified">286     JSValue thisValue = exec-&gt;thisValue();</span>
287 
288     // 2. Invoke(V, &quot;toString&quot;)
289 
290     // Let O be the result of calling ToObject passing the this value as the argument.
<span class="line-modified">291     JSObject* object = thisValue.toThis(exec, StrictMode).toObject(exec);</span>
292     RETURN_IF_EXCEPTION(scope, encodedJSValue());
293 
294     // Let toString be the O.[[Get]](&quot;toString&quot;, V)
295     PropertySlot slot(thisValue, PropertySlot::InternalMethodType::Get);
<span class="line-modified">296     bool hasProperty = object-&gt;getPropertySlot(exec, vm.propertyNames-&gt;toString, slot);</span>
297     EXCEPTION_ASSERT(!scope.exception() || !hasProperty);
<span class="line-modified">298     JSValue toString = hasProperty ? slot.getValue(exec, vm.propertyNames-&gt;toString) : jsUndefined();</span>
299     RETURN_IF_EXCEPTION(scope, encodedJSValue());
300 
301     // If IsCallable(toString) is false, throw a TypeError exception.
302     CallData callData;
303     CallType callType = getCallData(vm, toString, callData);
304     if (callType == CallType::None)
<span class="line-modified">305         return throwVMTypeError(exec, scope);</span>
306 
307     // Return the result of calling the [[Call]] internal method of toString passing the this value and no arguments.
<span class="line-modified">308     RELEASE_AND_RETURN(scope, JSValue::encode(call(exec, toString, callType, callData, thisValue, *vm.emptyList)));</span>
309 }
310 
<span class="line-modified">311 EncodedJSValue JSC_HOST_CALL objectProtoFuncToString(ExecState* exec)</span>
312 {
<span class="line-modified">313     VM&amp; vm = exec-&gt;vm();</span>
314     auto scope = DECLARE_THROW_SCOPE(vm);
315 
<span class="line-modified">316     JSValue thisValue = exec-&gt;thisValue().toThis(exec, StrictMode);</span>
317     if (thisValue.isUndefinedOrNull())
318         return JSValue::encode(thisValue.isUndefined() ? vm.smallStrings.undefinedObjectString() : vm.smallStrings.nullObjectString());
<span class="line-modified">319     JSObject* thisObject = thisValue.toObject(exec);</span>
320     EXCEPTION_ASSERT(!!scope.exception() == !thisObject);
321     if (!thisObject)
322         return JSValue::encode(jsUndefined());
323 
324     auto result = thisObject-&gt;structure(vm)-&gt;objectToStringValue();
325     if (result)
326         return JSValue::encode(result);
327 
328     PropertyName toStringTagSymbol = vm.propertyNames-&gt;toStringTagSymbol;
<span class="line-modified">329     RELEASE_AND_RETURN(scope, JSValue::encode(thisObject-&gt;getPropertySlot(exec, toStringTagSymbol, [&amp;] (bool found, PropertySlot&amp; toStringTagSlot) -&gt; JSValue {</span>
330         if (found) {
<span class="line-modified">331             JSValue stringTag = toStringTagSlot.getValue(exec, toStringTagSymbol);</span>
332             RETURN_IF_EXCEPTION(scope, { });
333             if (stringTag.isString()) {
<span class="line-modified">334                 JSString* result = jsString(exec, vm.smallStrings.objectStringStart(), asString(stringTag), vm.smallStrings.singleCharacterString(&#39;]&#39;));</span>
335                 RETURN_IF_EXCEPTION(scope, { });
<span class="line-modified">336                 thisObject-&gt;structure(vm)-&gt;setObjectToStringValue(exec, vm, result, toStringTagSlot);</span>
337                 return result;
338             }
339         }
340 
<span class="line-modified">341         String tag = thisObject-&gt;methodTable(vm)-&gt;toStringName(thisObject, exec);</span>
342         RETURN_IF_EXCEPTION(scope, { });
343         String newString = tryMakeString(&quot;[object &quot;, WTFMove(tag), &quot;]&quot;);
344         if (!newString)
<span class="line-modified">345             return throwOutOfMemoryError(exec, scope);</span>
346 
347         auto result = jsNontrivialString(vm, newString);
<span class="line-modified">348         thisObject-&gt;structure(vm)-&gt;setObjectToStringValue(exec, vm, result, toStringTagSlot);</span>
349         return result;
350     })));
351 }
352 
353 } // namespace JSC
</pre>
</td>
<td>
<hr />
<pre>
 16  *  License along with this library; if not, write to the Free Software
 17  *  Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA
 18  *
 19  */
 20 
 21 #include &quot;config.h&quot;
 22 #include &quot;ObjectPrototype.h&quot;
 23 
 24 #include &quot;Error.h&quot;
 25 #include &quot;GetterSetter.h&quot;
 26 #include &quot;HasOwnPropertyCache.h&quot;
 27 #include &quot;JSFunction.h&quot;
 28 #include &quot;JSString.h&quot;
 29 #include &quot;JSCInlines.h&quot;
 30 #include &quot;PropertySlot.h&quot;
 31 #include &quot;StructureInlines.h&quot;
 32 #include &quot;StructureRareDataInlines.h&quot;
 33 
 34 namespace JSC {
 35 
<span class="line-modified"> 36 static EncodedJSValue JSC_HOST_CALL objectProtoFuncValueOf(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified"> 37 static EncodedJSValue JSC_HOST_CALL objectProtoFuncHasOwnProperty(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified"> 38 static EncodedJSValue JSC_HOST_CALL objectProtoFuncIsPrototypeOf(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified"> 39 static EncodedJSValue JSC_HOST_CALL objectProtoFuncDefineGetter(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified"> 40 static EncodedJSValue JSC_HOST_CALL objectProtoFuncDefineSetter(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified"> 41 static EncodedJSValue JSC_HOST_CALL objectProtoFuncLookupGetter(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified"> 42 static EncodedJSValue JSC_HOST_CALL objectProtoFuncLookupSetter(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified"> 43 static EncodedJSValue JSC_HOST_CALL objectProtoFuncPropertyIsEnumerable(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified"> 44 static EncodedJSValue JSC_HOST_CALL objectProtoFuncToLocaleString(JSGlobalObject*, CallFrame*);</span>
 45 
 46 STATIC_ASSERT_IS_TRIVIALLY_DESTRUCTIBLE(ObjectPrototype);
 47 
 48 const ClassInfo ObjectPrototype::s_info = { &quot;Object&quot;, &amp;JSNonFinalObject::s_info, nullptr, nullptr, CREATE_METHOD_TABLE(ObjectPrototype) };
 49 
 50 ObjectPrototype::ObjectPrototype(VM&amp; vm, Structure* stucture)
 51     : JSNonFinalObject(vm, stucture)
 52 {
 53 }
 54 
 55 void ObjectPrototype::finishCreation(VM&amp; vm, JSGlobalObject* globalObject)
 56 {
 57     Base::finishCreation(vm);
 58     ASSERT(inherits(vm, info()));
 59 
 60     JSC_NATIVE_FUNCTION_WITHOUT_TRANSITION(vm.propertyNames-&gt;toString, objectProtoFuncToString, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum), 0);
 61     JSC_NATIVE_FUNCTION_WITHOUT_TRANSITION(vm.propertyNames-&gt;toLocaleString, objectProtoFuncToLocaleString, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum), 0);
 62     JSC_NATIVE_FUNCTION_WITHOUT_TRANSITION(vm.propertyNames-&gt;valueOf, objectProtoFuncValueOf, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum), 0);
 63     JSC_NATIVE_INTRINSIC_FUNCTION_WITHOUT_TRANSITION(vm.propertyNames-&gt;hasOwnProperty, objectProtoFuncHasOwnProperty, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum), 1, HasOwnPropertyIntrinsic);
 64     JSC_NATIVE_FUNCTION_WITHOUT_TRANSITION(vm.propertyNames-&gt;propertyIsEnumerable, objectProtoFuncPropertyIsEnumerable, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum), 1);
 65     JSC_NATIVE_FUNCTION_WITHOUT_TRANSITION(vm.propertyNames-&gt;isPrototypeOf, objectProtoFuncIsPrototypeOf, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum), 1);
 66     JSC_NATIVE_FUNCTION_WITHOUT_TRANSITION(vm.propertyNames-&gt;__defineGetter__, objectProtoFuncDefineGetter, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum), 2);
 67     JSC_NATIVE_FUNCTION_WITHOUT_TRANSITION(vm.propertyNames-&gt;__defineSetter__, objectProtoFuncDefineSetter, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum), 2);
 68     JSC_NATIVE_FUNCTION_WITHOUT_TRANSITION(vm.propertyNames-&gt;__lookupGetter__, objectProtoFuncLookupGetter, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum), 1);
 69     JSC_NATIVE_FUNCTION_WITHOUT_TRANSITION(vm.propertyNames-&gt;__lookupSetter__, objectProtoFuncLookupSetter, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum), 1);
 70 }
 71 
 72 ObjectPrototype* ObjectPrototype::create(VM&amp; vm, JSGlobalObject* globalObject, Structure* structure)
 73 {
 74     ObjectPrototype* prototype = new (NotNull, allocateCell&lt;ObjectPrototype&gt;(vm.heap)) ObjectPrototype(vm, structure);
 75     prototype-&gt;finishCreation(vm, globalObject);
 76     return prototype;
 77 }
 78 
 79 // ------------------------------ Functions --------------------------------
 80 
<span class="line-modified"> 81 EncodedJSValue JSC_HOST_CALL objectProtoFuncValueOf(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 82 {
<span class="line-modified"> 83     JSValue thisValue = callFrame-&gt;thisValue().toThis(globalObject, StrictMode);</span>
<span class="line-modified"> 84     JSObject* valueObj = thisValue.toObject(globalObject);</span>
 85     if (UNLIKELY(!valueObj))
 86         return encodedJSValue();
 87     return JSValue::encode(valueObj);
 88 }
 89 
<span class="line-modified"> 90 EncodedJSValue JSC_HOST_CALL objectProtoFuncHasOwnProperty(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 91 {
<span class="line-modified"> 92     VM&amp; vm = globalObject-&gt;vm();</span>
 93     auto scope = DECLARE_THROW_SCOPE(vm);
 94 
<span class="line-modified"> 95     JSValue thisValue = callFrame-&gt;thisValue().toThis(globalObject, StrictMode);</span>
<span class="line-modified"> 96     auto propertyName = callFrame-&gt;argument(0).toPropertyKey(globalObject);</span>
 97     RETURN_IF_EXCEPTION(scope, encodedJSValue());
<span class="line-modified"> 98     JSObject* thisObject = thisValue.toObject(globalObject);</span>
 99     EXCEPTION_ASSERT(!!scope.exception() == !thisObject);
100     if (UNLIKELY(!thisObject))
101         return encodedJSValue();
102 
103     Structure* structure = thisObject-&gt;structure(vm);
104     HasOwnPropertyCache* hasOwnPropertyCache = vm.ensureHasOwnPropertyCache();
105     if (Optional&lt;bool&gt; result = hasOwnPropertyCache-&gt;get(structure, propertyName)) {
<span class="line-modified">106         ASSERT(*result == thisObject-&gt;hasOwnProperty(globalObject, propertyName));</span>
107         scope.assertNoException();
108         return JSValue::encode(jsBoolean(*result));
109     }
110 
111     PropertySlot slot(thisObject, PropertySlot::InternalMethodType::GetOwnProperty);
<span class="line-modified">112     bool result = thisObject-&gt;hasOwnProperty(globalObject, propertyName, slot);</span>
113     RETURN_IF_EXCEPTION(scope, encodedJSValue());
114 
115     hasOwnPropertyCache-&gt;tryAdd(vm, slot, thisObject, propertyName, result);
116     return JSValue::encode(jsBoolean(result));
117 }
118 
<span class="line-modified">119 EncodedJSValue JSC_HOST_CALL objectProtoFuncIsPrototypeOf(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
120 {
<span class="line-modified">121     VM&amp; vm = globalObject-&gt;vm();</span>
122     auto scope = DECLARE_THROW_SCOPE(vm);
123 
<span class="line-modified">124     if (!callFrame-&gt;argument(0).isObject())</span>
<span class="line-modified">125         return JSValue::encode(jsBoolean(false));</span>
<span class="line-added">126 </span>
<span class="line-added">127     JSValue thisValue = callFrame-&gt;thisValue().toThis(globalObject, StrictMode);</span>
<span class="line-added">128     JSObject* thisObj = thisValue.toObject(globalObject);</span>
129     EXCEPTION_ASSERT(!!scope.exception() == !thisObj);
130     if (UNLIKELY(!thisObj))
131         return encodedJSValue();
132 
<span class="line-modified">133     JSValue v = asObject(callFrame-&gt;argument(0))-&gt;getPrototype(vm, globalObject);</span>



134     RETURN_IF_EXCEPTION(scope, encodedJSValue());
135 
136     while (true) {
137         if (!v.isObject())
138             return JSValue::encode(jsBoolean(false));
139         if (v == thisObj)
140             return JSValue::encode(jsBoolean(true));
<span class="line-modified">141         v = asObject(v)-&gt;getPrototype(vm, globalObject);</span>
142         RETURN_IF_EXCEPTION(scope, encodedJSValue());
143     }
144 }
145 
<span class="line-modified">146 EncodedJSValue JSC_HOST_CALL objectProtoFuncDefineGetter(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
147 {
<span class="line-modified">148     VM&amp; vm = globalObject-&gt;vm();</span>
149     auto scope = DECLARE_THROW_SCOPE(vm);
150 
<span class="line-modified">151     JSObject* thisObject = callFrame-&gt;thisValue().toThis(globalObject, StrictMode).toObject(globalObject);</span>
152     RETURN_IF_EXCEPTION(scope, encodedJSValue());
153 
<span class="line-modified">154     JSValue get = callFrame-&gt;argument(1);</span>
155     CallData callData;
156     if (getCallData(vm, get, callData) == CallType::None)
<span class="line-modified">157         return throwVMTypeError(globalObject, scope, &quot;invalid getter usage&quot;_s);</span>
158 
<span class="line-modified">159     auto propertyName = callFrame-&gt;argument(0).toPropertyKey(globalObject);</span>
160     RETURN_IF_EXCEPTION(scope, encodedJSValue());
161 
162     PropertyDescriptor descriptor;
163     descriptor.setGetter(get);
164     descriptor.setEnumerable(true);
165     descriptor.setConfigurable(true);
166 
167     bool shouldThrow = true;
168     scope.release();
<span class="line-modified">169     thisObject-&gt;methodTable(vm)-&gt;defineOwnProperty(thisObject, globalObject, propertyName, descriptor, shouldThrow);</span>
170 
171     return JSValue::encode(jsUndefined());
172 }
173 
<span class="line-modified">174 EncodedJSValue JSC_HOST_CALL objectProtoFuncDefineSetter(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
175 {
<span class="line-modified">176     VM&amp; vm = globalObject-&gt;vm();</span>
177     auto scope = DECLARE_THROW_SCOPE(vm);
178 
<span class="line-modified">179     JSObject* thisObject = callFrame-&gt;thisValue().toThis(globalObject, StrictMode).toObject(globalObject);</span>
180     RETURN_IF_EXCEPTION(scope, encodedJSValue());
181 
<span class="line-modified">182     JSValue set = callFrame-&gt;argument(1);</span>
183     CallData callData;
184     if (getCallData(vm, set, callData) == CallType::None)
<span class="line-modified">185         return throwVMTypeError(globalObject, scope, &quot;invalid setter usage&quot;_s);</span>
186 
<span class="line-modified">187     auto propertyName = callFrame-&gt;argument(0).toPropertyKey(globalObject);</span>
188     RETURN_IF_EXCEPTION(scope, encodedJSValue());
189 
190     PropertyDescriptor descriptor;
191     descriptor.setSetter(set);
192     descriptor.setEnumerable(true);
193     descriptor.setConfigurable(true);
194 
195     bool shouldThrow = true;
196     scope.release();
<span class="line-modified">197     thisObject-&gt;methodTable(vm)-&gt;defineOwnProperty(thisObject, globalObject, propertyName, descriptor, shouldThrow);</span>
198 
199     return JSValue::encode(jsUndefined());
200 }
201 
<span class="line-modified">202 EncodedJSValue JSC_HOST_CALL objectProtoFuncLookupGetter(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
203 {
<span class="line-modified">204     VM&amp; vm = globalObject-&gt;vm();</span>
205     auto scope = DECLARE_THROW_SCOPE(vm);
206 
<span class="line-modified">207     JSObject* thisObject = callFrame-&gt;thisValue().toThis(globalObject, StrictMode).toObject(globalObject);</span>
208     RETURN_IF_EXCEPTION(scope, encodedJSValue());
209 
<span class="line-modified">210     auto propertyName = callFrame-&gt;argument(0).toPropertyKey(globalObject);</span>
211     RETURN_IF_EXCEPTION(scope, encodedJSValue());
212 
213     PropertySlot slot(thisObject, PropertySlot::InternalMethodType::GetOwnProperty);
<span class="line-modified">214     bool hasProperty = thisObject-&gt;getPropertySlot(globalObject, propertyName, slot);</span>
215     EXCEPTION_ASSERT(!scope.exception() || !hasProperty);
216     if (hasProperty) {
217         if (slot.isAccessor()) {
218             GetterSetter* getterSetter = slot.getterSetter();
219             return getterSetter-&gt;isGetterNull() ? JSValue::encode(jsUndefined()) : JSValue::encode(getterSetter-&gt;getter());
220         }
221         if (slot.attributes() &amp; PropertyAttribute::CustomAccessor) {
222             PropertyDescriptor descriptor;
223             ASSERT(slot.slotBase());
<span class="line-modified">224             if (slot.slotBase()-&gt;getOwnPropertyDescriptor(globalObject, propertyName, descriptor))</span>
225                 return descriptor.getterPresent() ? JSValue::encode(descriptor.getter()) : JSValue::encode(jsUndefined());
226         }
227     }
228 
229     return JSValue::encode(jsUndefined());
230 }
231 
<span class="line-modified">232 EncodedJSValue JSC_HOST_CALL objectProtoFuncLookupSetter(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
233 {
<span class="line-modified">234     VM&amp; vm = globalObject-&gt;vm();</span>
235     auto scope = DECLARE_THROW_SCOPE(vm);
236 
<span class="line-modified">237     JSObject* thisObject = callFrame-&gt;thisValue().toThis(globalObject, StrictMode).toObject(globalObject);</span>
238     RETURN_IF_EXCEPTION(scope, encodedJSValue());
239 
<span class="line-modified">240     auto propertyName = callFrame-&gt;argument(0).toPropertyKey(globalObject);</span>
241     RETURN_IF_EXCEPTION(scope, encodedJSValue());
242 
243     PropertySlot slot(thisObject, PropertySlot::InternalMethodType::GetOwnProperty);
<span class="line-modified">244     bool hasProperty = thisObject-&gt;getPropertySlot(globalObject, propertyName, slot);</span>
245     EXCEPTION_ASSERT(!scope.exception() || !hasProperty);
246     if (hasProperty) {
247         if (slot.isAccessor()) {
248             GetterSetter* getterSetter = slot.getterSetter();
249             return getterSetter-&gt;isSetterNull() ? JSValue::encode(jsUndefined()) : JSValue::encode(getterSetter-&gt;setter());
250         }
251         if (slot.attributes() &amp; PropertyAttribute::CustomAccessor) {
252             PropertyDescriptor descriptor;
253             ASSERT(slot.slotBase());
<span class="line-modified">254             if (slot.slotBase()-&gt;getOwnPropertyDescriptor(globalObject, propertyName, descriptor))</span>
255                 return descriptor.setterPresent() ? JSValue::encode(descriptor.setter()) : JSValue::encode(jsUndefined());
256         }
257     }
258 
259     return JSValue::encode(jsUndefined());
260 }
261 
<span class="line-modified">262 EncodedJSValue JSC_HOST_CALL objectProtoFuncPropertyIsEnumerable(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
263 {
<span class="line-modified">264     VM&amp; vm = globalObject-&gt;vm();</span>
265     auto scope = DECLARE_THROW_SCOPE(vm);
266 
<span class="line-modified">267     auto propertyName = callFrame-&gt;argument(0).toPropertyKey(globalObject);</span>
268     RETURN_IF_EXCEPTION(scope, encodedJSValue());
269 
<span class="line-modified">270     JSObject* thisObject = callFrame-&gt;thisValue().toThis(globalObject, StrictMode).toObject(globalObject);</span>
271     RETURN_IF_EXCEPTION(scope, encodedJSValue());
272 
273     scope.release();
274     PropertyDescriptor descriptor;
<span class="line-modified">275     bool enumerable = thisObject-&gt;getOwnPropertyDescriptor(globalObject, propertyName, descriptor) &amp;&amp; descriptor.enumerable();</span>
276     return JSValue::encode(jsBoolean(enumerable));
277 }
278 
279 // 15.2.4.3 Object.prototype.toLocaleString()
<span class="line-modified">280 EncodedJSValue JSC_HOST_CALL objectProtoFuncToLocaleString(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
281 {
<span class="line-modified">282     VM&amp; vm = globalObject-&gt;vm();</span>
283     auto scope = DECLARE_THROW_SCOPE(vm);
284 
285     // 1. Let V be the this value.
<span class="line-modified">286     JSValue thisValue = callFrame-&gt;thisValue();</span>
287 
288     // 2. Invoke(V, &quot;toString&quot;)
289 
290     // Let O be the result of calling ToObject passing the this value as the argument.
<span class="line-modified">291     JSObject* object = thisValue.toThis(globalObject, StrictMode).toObject(globalObject);</span>
292     RETURN_IF_EXCEPTION(scope, encodedJSValue());
293 
294     // Let toString be the O.[[Get]](&quot;toString&quot;, V)
295     PropertySlot slot(thisValue, PropertySlot::InternalMethodType::Get);
<span class="line-modified">296     bool hasProperty = object-&gt;getPropertySlot(globalObject, vm.propertyNames-&gt;toString, slot);</span>
297     EXCEPTION_ASSERT(!scope.exception() || !hasProperty);
<span class="line-modified">298     JSValue toString = hasProperty ? slot.getValue(globalObject, vm.propertyNames-&gt;toString) : jsUndefined();</span>
299     RETURN_IF_EXCEPTION(scope, encodedJSValue());
300 
301     // If IsCallable(toString) is false, throw a TypeError exception.
302     CallData callData;
303     CallType callType = getCallData(vm, toString, callData);
304     if (callType == CallType::None)
<span class="line-modified">305         return throwVMTypeError(globalObject, scope);</span>
306 
307     // Return the result of calling the [[Call]] internal method of toString passing the this value and no arguments.
<span class="line-modified">308     RELEASE_AND_RETURN(scope, JSValue::encode(call(globalObject, toString, callType, callData, thisValue, *vm.emptyList)));</span>
309 }
310 
<span class="line-modified">311 EncodedJSValue JSC_HOST_CALL objectProtoFuncToString(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
312 {
<span class="line-modified">313     VM&amp; vm = globalObject-&gt;vm();</span>
314     auto scope = DECLARE_THROW_SCOPE(vm);
315 
<span class="line-modified">316     JSValue thisValue = callFrame-&gt;thisValue().toThis(globalObject, StrictMode);</span>
317     if (thisValue.isUndefinedOrNull())
318         return JSValue::encode(thisValue.isUndefined() ? vm.smallStrings.undefinedObjectString() : vm.smallStrings.nullObjectString());
<span class="line-modified">319     JSObject* thisObject = thisValue.toObject(globalObject);</span>
320     EXCEPTION_ASSERT(!!scope.exception() == !thisObject);
321     if (!thisObject)
322         return JSValue::encode(jsUndefined());
323 
324     auto result = thisObject-&gt;structure(vm)-&gt;objectToStringValue();
325     if (result)
326         return JSValue::encode(result);
327 
328     PropertyName toStringTagSymbol = vm.propertyNames-&gt;toStringTagSymbol;
<span class="line-modified">329     RELEASE_AND_RETURN(scope, JSValue::encode(thisObject-&gt;getPropertySlot(globalObject, toStringTagSymbol, [&amp;] (bool found, PropertySlot&amp; toStringTagSlot) -&gt; JSValue {</span>
330         if (found) {
<span class="line-modified">331             JSValue stringTag = toStringTagSlot.getValue(globalObject, toStringTagSymbol);</span>
332             RETURN_IF_EXCEPTION(scope, { });
333             if (stringTag.isString()) {
<span class="line-modified">334                 JSString* result = jsString(globalObject, vm.smallStrings.objectStringStart(), asString(stringTag), vm.smallStrings.singleCharacterString(&#39;]&#39;));</span>
335                 RETURN_IF_EXCEPTION(scope, { });
<span class="line-modified">336                 thisObject-&gt;structure(vm)-&gt;setObjectToStringValue(globalObject, vm, result, toStringTagSlot);</span>
337                 return result;
338             }
339         }
340 
<span class="line-modified">341         String tag = thisObject-&gt;methodTable(vm)-&gt;toStringName(thisObject, globalObject);</span>
342         RETURN_IF_EXCEPTION(scope, { });
343         String newString = tryMakeString(&quot;[object &quot;, WTFMove(tag), &quot;]&quot;);
344         if (!newString)
<span class="line-modified">345             return throwOutOfMemoryError(globalObject, scope);</span>
346 
347         auto result = jsNontrivialString(vm, newString);
<span class="line-modified">348         thisObject-&gt;structure(vm)-&gt;setObjectToStringValue(globalObject, vm, result, toStringTagSlot);</span>
349         return result;
350     })));
351 }
352 
353 } // namespace JSC
</pre>
</td>
</tr>
</table>
<center><a href="ObjectPropertyChangeAdaptiveWatchpoint.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="ObjectPrototype.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>