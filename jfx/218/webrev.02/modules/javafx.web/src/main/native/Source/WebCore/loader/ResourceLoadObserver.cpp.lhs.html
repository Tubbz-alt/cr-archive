<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/WebCore/loader/ResourceLoadObserver.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (C) 2016-2019 Apple Inc. All rights reserved.
  3  *
  4  * Redistribution and use in source and binary forms, with or without
  5  * modification, are permitted provided that the following conditions
  6  * are met:
  7  * 1. Redistributions of source code must retain the above copyright
  8  *    notice, this list of conditions and the following disclaimer.
  9  * 2. Redistributions in binary form must reproduce the above copyright
 10  *    notice, this list of conditions and the following disclaimer in the
 11  *    documentation and/or other materials provided with the distribution.
 12  *
 13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. AND ITS CONTRIBUTORS ``AS IS&#39;&#39;
 14  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
 15  * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 16  * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL APPLE INC. OR ITS CONTRIBUTORS
 17  * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 18  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 19  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 20  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 21  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 22  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF
 23  * THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #include &quot;config.h&quot;
 27 #include &quot;ResourceLoadObserver.h&quot;
<a name="1" id="anc1"></a><span class="line-modified"> 28 </span>
<span class="line-removed"> 29 #include &quot;DeprecatedGlobalSettings.h&quot;</span>
<span class="line-removed"> 30 #include &quot;Document.h&quot;</span>
<span class="line-removed"> 31 #include &quot;Frame.h&quot;</span>
<span class="line-removed"> 32 #include &quot;FrameLoader.h&quot;</span>
<span class="line-removed"> 33 #include &quot;FrameLoaderClient.h&quot;</span>
<span class="line-removed"> 34 #include &quot;HTMLFrameOwnerElement.h&quot;</span>
<span class="line-removed"> 35 #include &quot;Logging.h&quot;</span>
<span class="line-removed"> 36 #include &quot;Page.h&quot;</span>
<span class="line-removed"> 37 #include &quot;RegistrableDomain.h&quot;</span>
<span class="line-removed"> 38 #include &quot;ResourceLoadStatistics.h&quot;</span>
<span class="line-removed"> 39 #include &quot;ResourceRequest.h&quot;</span>
<span class="line-removed"> 40 #include &quot;ResourceResponse.h&quot;</span>
<span class="line-removed"> 41 #include &quot;RuntimeEnabledFeatures.h&quot;</span>
<span class="line-removed"> 42 #include &quot;ScriptExecutionContext.h&quot;</span>
<span class="line-removed"> 43 #include &quot;SecurityOrigin.h&quot;</span>
<span class="line-removed"> 44 #include &quot;Settings.h&quot;</span>
<span class="line-removed"> 45 #include &lt;wtf/URL.h&gt;</span>
 46 
 47 namespace WebCore {
 48 
<a name="2" id="anc2"></a><span class="line-modified"> 49 static const Seconds minimumNotificationInterval { 5_s };</span>
<span class="line-removed"> 50 </span>
<span class="line-removed"> 51 ResourceLoadObserver::ResourceLoadObserver()</span>
<span class="line-removed"> 52     : m_notificationTimer(*this, &amp;ResourceLoadObserver::updateCentralStatisticsStore)</span>
<span class="line-removed"> 53 {</span>
<span class="line-removed"> 54 }</span>
<span class="line-removed"> 55 </span>
<span class="line-removed"> 56 ResourceLoadObserver&amp; ResourceLoadObserver::shared()</span>
<span class="line-removed"> 57 {</span>
<span class="line-removed"> 58     static NeverDestroyed&lt;ResourceLoadObserver&gt; resourceLoadObserver;</span>
<span class="line-removed"> 59     return resourceLoadObserver;</span>
<span class="line-removed"> 60 }</span>
<span class="line-removed"> 61 </span>
<span class="line-removed"> 62 void ResourceLoadObserver::setStatisticsUpdatedCallback(Function&lt;void(PerSessionResourceLoadData&amp;&amp;)&gt;&amp;&amp; notificationCallback)</span>
<span class="line-removed"> 63 {</span>
<span class="line-removed"> 64     ASSERT(!m_notificationCallback);</span>
<span class="line-removed"> 65     m_notificationCallback = WTFMove(notificationCallback);</span>
<span class="line-removed"> 66 }</span>
<span class="line-removed"> 67 </span>
<span class="line-removed"> 68 void ResourceLoadObserver::setRequestStorageAccessUnderOpenerCallback(Function&lt;void(PAL::SessionID sessionID, const RegistrableDomain&amp; domainInNeedOfStorageAccess, PageIdentifier openerPageID, const RegistrableDomain&amp; openerDomain)&gt;&amp;&amp; callback)</span>
<span class="line-removed"> 69 {</span>
<span class="line-removed"> 70     ASSERT(!m_requestStorageAccessUnderOpenerCallback);</span>
<span class="line-removed"> 71     m_requestStorageAccessUnderOpenerCallback = WTFMove(callback);</span>
<span class="line-removed"> 72 }</span>
<span class="line-removed"> 73 </span>
<span class="line-removed"> 74 void ResourceLoadObserver::setLogUserInteractionNotificationCallback(Function&lt;void(PAL::SessionID, const RegistrableDomain&amp;)&gt;&amp;&amp; callback)</span>
 75 {
<a name="3" id="anc3"></a><span class="line-modified"> 76     ASSERT(!m_logUserInteractionNotificationCallback);</span>
<span class="line-modified"> 77     m_logUserInteractionNotificationCallback = WTFMove(callback);</span>
 78 }
 79 
<a name="4" id="anc4"></a><span class="line-modified"> 80 static inline bool is3xxRedirect(const ResourceResponse&amp; response)</span>
 81 {
<a name="5" id="anc5"></a><span class="line-modified"> 82     return response.httpStatusCode() &gt;= 300 &amp;&amp; response.httpStatusCode() &lt;= 399;</span>

 83 }
 84 
<a name="6" id="anc6"></a><span class="line-modified"> 85 bool ResourceLoadObserver::shouldLog(PAL::SessionID sessionID) const</span>
<span class="line-removed"> 86 {</span>
<span class="line-removed"> 87     return DeprecatedGlobalSettings::resourceLoadStatisticsEnabled() &amp;&amp; !sessionID.isEphemeral() &amp;&amp; m_notificationCallback;</span>
<span class="line-removed"> 88 }</span>
<span class="line-removed"> 89 </span>
<span class="line-removed"> 90 void ResourceLoadObserver::logSubresourceLoading(const Frame* frame, const ResourceRequest&amp; newRequest, const ResourceResponse&amp; redirectResponse)</span>
<span class="line-removed"> 91 {</span>
<span class="line-removed"> 92     ASSERT(frame-&gt;page());</span>
<span class="line-removed"> 93 </span>
<span class="line-removed"> 94     if (!frame)</span>
<span class="line-removed"> 95         return;</span>
<span class="line-removed"> 96 </span>
<span class="line-removed"> 97     auto* page = frame-&gt;page();</span>
<span class="line-removed"> 98     if (!page || !shouldLog(page-&gt;sessionID()))</span>
<span class="line-removed"> 99         return;</span>
<span class="line-removed">100 </span>
<span class="line-removed">101     bool isRedirect = is3xxRedirect(redirectResponse);</span>
<span class="line-removed">102     const URL&amp; redirectedFromURL = redirectResponse.url();</span>
<span class="line-removed">103     const URL&amp; targetURL = newRequest.url();</span>
<span class="line-removed">104     const URL&amp; topFrameURL = frame ? frame-&gt;mainFrame().document()-&gt;url() : URL();</span>
<span class="line-removed">105 </span>
<span class="line-removed">106     auto targetHost = targetURL.host();</span>
<span class="line-removed">107     auto topFrameHost = topFrameURL.host();</span>
<span class="line-removed">108 </span>
<span class="line-removed">109     if (targetHost.isEmpty() || topFrameHost.isEmpty() || targetHost == topFrameHost || (isRedirect &amp;&amp; targetHost == redirectedFromURL.host()))</span>
<span class="line-removed">110         return;</span>
<span class="line-removed">111 </span>
<span class="line-removed">112     RegistrableDomain targetDomain { targetURL };</span>
<span class="line-removed">113     RegistrableDomain topFrameDomain { topFrameURL };</span>
<span class="line-removed">114     RegistrableDomain redirectedFromDomain { redirectedFromURL };</span>
<span class="line-removed">115 </span>
<span class="line-removed">116     if (targetDomain == topFrameDomain || (isRedirect &amp;&amp; targetDomain == redirectedFromDomain))</span>
<span class="line-removed">117         return;</span>
<span class="line-removed">118 </span>
<span class="line-removed">119     {</span>
<span class="line-removed">120         auto&amp; targetStatistics = ensureResourceStatisticsForRegistrableDomain(page-&gt;sessionID(), targetDomain);</span>
<span class="line-removed">121         auto lastSeen = ResourceLoadStatistics::reduceTimeResolution(WallTime::now());</span>
<span class="line-removed">122         targetStatistics.lastSeen = lastSeen;</span>
<span class="line-removed">123         targetStatistics.subresourceUnderTopFrameDomains.add(topFrameDomain);</span>
<span class="line-removed">124 </span>
<span class="line-removed">125         scheduleNotificationIfNeeded();</span>
<span class="line-removed">126     }</span>
<span class="line-removed">127 </span>
<span class="line-removed">128     if (isRedirect) {</span>
<span class="line-removed">129         auto&amp; redirectingOriginStatistics = ensureResourceStatisticsForRegistrableDomain(page-&gt;sessionID(), redirectedFromDomain);</span>
<span class="line-removed">130         redirectingOriginStatistics.subresourceUniqueRedirectsTo.add(targetDomain);</span>
<span class="line-removed">131         auto&amp; targetStatistics = ensureResourceStatisticsForRegistrableDomain(page-&gt;sessionID(), targetDomain);</span>
<span class="line-removed">132         targetStatistics.subresourceUniqueRedirectsFrom.add(redirectedFromDomain);</span>
<span class="line-removed">133 </span>
<span class="line-removed">134         scheduleNotificationIfNeeded();</span>
<span class="line-removed">135     }</span>
<span class="line-removed">136 }</span>
<span class="line-removed">137 </span>
<span class="line-removed">138 void ResourceLoadObserver::logWebSocketLoading(const URL&amp; targetURL, const URL&amp; mainFrameURL, PAL::SessionID sessionID)</span>
<span class="line-removed">139 {</span>
<span class="line-removed">140     if (!shouldLog(sessionID))</span>
<span class="line-removed">141         return;</span>
<span class="line-removed">142 </span>
<span class="line-removed">143     auto targetHost = targetURL.host();</span>
<span class="line-removed">144     auto mainFrameHost = mainFrameURL.host();</span>
<span class="line-removed">145 </span>
<span class="line-removed">146     if (targetHost.isEmpty() || mainFrameHost.isEmpty() || targetHost == mainFrameHost)</span>
<span class="line-removed">147         return;</span>
<span class="line-removed">148 </span>
<span class="line-removed">149     RegistrableDomain targetDomain { targetURL };</span>
<span class="line-removed">150     RegistrableDomain topFrameDomain { mainFrameURL };</span>
<span class="line-removed">151 </span>
<span class="line-removed">152     if (targetDomain == topFrameDomain)</span>
<span class="line-removed">153         return;</span>
<span class="line-removed">154 </span>
<span class="line-removed">155     auto lastSeen = ResourceLoadStatistics::reduceTimeResolution(WallTime::now());</span>
<span class="line-removed">156 </span>
<span class="line-removed">157     auto&amp; targetStatistics = ensureResourceStatisticsForRegistrableDomain(sessionID, targetDomain);</span>
<span class="line-removed">158     targetStatistics.lastSeen = lastSeen;</span>
<span class="line-removed">159     targetStatistics.subresourceUnderTopFrameDomains.add(topFrameDomain);</span>
<span class="line-removed">160 </span>
<span class="line-removed">161     scheduleNotificationIfNeeded();</span>
<span class="line-removed">162 }</span>
<span class="line-removed">163 </span>
<span class="line-removed">164 void ResourceLoadObserver::logUserInteractionWithReducedTimeResolution(const Document&amp; document)</span>
<span class="line-removed">165 {</span>
<span class="line-removed">166     if (!document.sessionID().isValid() || !shouldLog(document.sessionID()))</span>
<span class="line-removed">167         return;</span>
<span class="line-removed">168 </span>
<span class="line-removed">169     auto&amp; url = document.url();</span>
<span class="line-removed">170     if (url.protocolIsAbout() || url.isLocalFile() || url.isEmpty())</span>
<span class="line-removed">171         return;</span>
<span class="line-removed">172 </span>
<span class="line-removed">173     RegistrableDomain topFrameDomain { url };</span>
<span class="line-removed">174     auto newTime = ResourceLoadStatistics::reduceTimeResolution(WallTime::now());</span>
<span class="line-removed">175     auto lastReportedUserInteraction = m_lastReportedUserInteractionMap.get(topFrameDomain);</span>
<span class="line-removed">176     if (newTime == lastReportedUserInteraction)</span>
<span class="line-removed">177         return;</span>
<span class="line-removed">178 </span>
<span class="line-removed">179     m_lastReportedUserInteractionMap.set(topFrameDomain, newTime);</span>
<span class="line-removed">180 </span>
<span class="line-removed">181     auto&amp; statistics = ensureResourceStatisticsForRegistrableDomain(document.sessionID(), topFrameDomain);</span>
<span class="line-removed">182     statistics.hadUserInteraction = true;</span>
<span class="line-removed">183     statistics.lastSeen = newTime;</span>
<span class="line-removed">184     statistics.mostRecentUserInteractionTime = newTime;</span>
<span class="line-removed">185 </span>
<span class="line-removed">186 #if ENABLE(RESOURCE_LOAD_STATISTICS)</span>
<span class="line-removed">187     if (auto* frame = document.frame()) {</span>
<span class="line-removed">188         if (auto* opener = frame-&gt;loader().opener()) {</span>
<span class="line-removed">189             if (auto* openerDocument = opener-&gt;document()) {</span>
<span class="line-removed">190                 if (auto* openerFrame = openerDocument-&gt;frame()) {</span>
<span class="line-removed">191                     if (auto openerPageID = openerFrame-&gt;loader().client().pageID())</span>
<span class="line-removed">192                         requestStorageAccessUnderOpener(document.sessionID(), topFrameDomain, openerPageID.value(), *openerDocument);</span>
<span class="line-removed">193                 }</span>
<span class="line-removed">194             }</span>
<span class="line-removed">195         }</span>
<span class="line-removed">196     }</span>
<span class="line-removed">197 </span>
<span class="line-removed">198     // We notify right away in case of a user interaction instead of waiting the usual 5 seconds because we want</span>
<span class="line-removed">199     // to update cookie blocking state as quickly as possible.</span>
<span class="line-removed">200     m_logUserInteractionNotificationCallback(document.sessionID(), topFrameDomain);</span>
<span class="line-removed">201 #endif</span>
<span class="line-removed">202 </span>
<span class="line-removed">203 #if ENABLE(RESOURCE_LOAD_STATISTICS) &amp;&amp; !RELEASE_LOG_DISABLED</span>
<span class="line-removed">204     if (shouldLogUserInteraction()) {</span>
<span class="line-removed">205         auto counter = ++m_loggingCounter;</span>
<span class="line-removed">206 #define LOCAL_LOG(str, ...) \</span>
<span class="line-removed">207         RELEASE_LOG(ResourceLoadStatistics, &quot;ResourceLoadObserver::logUserInteraction: counter = %&quot; PRIu64 &quot;: &quot; str, counter, ##__VA_ARGS__)</span>
<span class="line-removed">208 </span>
<span class="line-removed">209         auto escapeForJSON = [](String s) {</span>
<span class="line-removed">210             s.replace(&#39;\\&#39;, &quot;\\\\&quot;).replace(&#39;&quot;&#39;, &quot;\\\&quot;&quot;);</span>
<span class="line-removed">211             return s;</span>
<span class="line-removed">212         };</span>
<span class="line-removed">213         auto escapedURL = escapeForJSON(url.string());</span>
<span class="line-removed">214         auto escapedDomain = escapeForJSON(topFrameDomain.string());</span>
<span class="line-removed">215 </span>
<span class="line-removed">216         LOCAL_LOG(R&quot;({ &quot;url&quot;: &quot;%{public}s&quot;,)&quot;, escapedURL.utf8().data());</span>
<span class="line-removed">217         LOCAL_LOG(R&quot;(  &quot;domain&quot; : &quot;%{public}s&quot;,)&quot;, escapedDomain.utf8().data());</span>
<span class="line-removed">218         LOCAL_LOG(R&quot;(  &quot;until&quot; : %f })&quot;, newTime.secondsSinceEpoch().seconds());</span>
<span class="line-removed">219 </span>
<span class="line-removed">220 #undef LOCAL_LOG</span>
<span class="line-removed">221     }</span>
<span class="line-removed">222 #endif</span>
<span class="line-removed">223 }</span>
<span class="line-removed">224 </span>
<span class="line-removed">225 #if ENABLE(RESOURCE_LOAD_STATISTICS)</span>
<span class="line-removed">226 void ResourceLoadObserver::requestStorageAccessUnderOpener(PAL::SessionID sessionID, const RegistrableDomain&amp; domainInNeedOfStorageAccess, PageIdentifier openerPageID, Document&amp; openerDocument)</span>
<span class="line-removed">227 {</span>
<span class="line-removed">228     auto openerUrl = openerDocument.url();</span>
<span class="line-removed">229     RegistrableDomain openerDomain { openerUrl };</span>
<span class="line-removed">230     if (domainInNeedOfStorageAccess != openerDomain</span>
<span class="line-removed">231         &amp;&amp; !openerDocument.hasRequestedPageSpecificStorageAccessWithUserInteraction(domainInNeedOfStorageAccess)</span>
<span class="line-removed">232         &amp;&amp; !equalIgnoringASCIICase(openerUrl.string(), WTF::blankURL())) {</span>
<span class="line-removed">233         m_requestStorageAccessUnderOpenerCallback(sessionID, domainInNeedOfStorageAccess, openerPageID, openerDomain);</span>
<span class="line-removed">234         // Remember user interaction-based requests since they don&#39;t need to be repeated.</span>
<span class="line-removed">235         openerDocument.setHasRequestedPageSpecificStorageAccessWithUserInteraction(domainInNeedOfStorageAccess);</span>
<span class="line-removed">236     }</span>
<span class="line-removed">237 }</span>
<span class="line-removed">238 #endif</span>
<span class="line-removed">239 </span>
<span class="line-removed">240 void ResourceLoadObserver::logFontLoad(const Document&amp; document, const String&amp; familyName, bool loadStatus)</span>
<span class="line-removed">241 {</span>
<span class="line-removed">242 #if ENABLE(WEB_API_STATISTICS)</span>
<span class="line-removed">243     if (!shouldLog(document.sessionID()))</span>
<span class="line-removed">244         return;</span>
<span class="line-removed">245     RegistrableDomain registrableDomain { document.url() };</span>
<span class="line-removed">246     auto&amp; statistics = ensureResourceStatisticsForRegistrableDomain(document.sessionID, registrableDomain);</span>
<span class="line-removed">247     bool shouldCallNotificationCallback = false;</span>
<span class="line-removed">248     if (!loadStatus) {</span>
<span class="line-removed">249         if (statistics.fontsFailedToLoad.add(familyName).isNewEntry)</span>
<span class="line-removed">250             shouldCallNotificationCallback = true;</span>
<span class="line-removed">251     } else {</span>
<span class="line-removed">252         if (statistics.fontsSuccessfullyLoaded.add(familyName).isNewEntry)</span>
<span class="line-removed">253             shouldCallNotificationCallback = true;</span>
<span class="line-removed">254     }</span>
<span class="line-removed">255     RegistrableDomain mainFrameRegistrableDomain { document.topDocument().url() };</span>
<span class="line-removed">256     if (statistics.topFrameRegistrableDomainsWhichAccessedWebAPIs.add(mainFrameRegistrableDomain.string()).isNewEntry)</span>
<span class="line-removed">257         shouldCallNotificationCallback = true;</span>
<span class="line-removed">258     if (shouldCallNotificationCallback)</span>
<span class="line-removed">259         scheduleNotificationIfNeeded();</span>
<span class="line-removed">260 #else</span>
<span class="line-removed">261     UNUSED_PARAM(document);</span>
<span class="line-removed">262     UNUSED_PARAM(familyName);</span>
<span class="line-removed">263     UNUSED_PARAM(loadStatus);</span>
<span class="line-removed">264 #endif</span>
<span class="line-removed">265 }</span>
<span class="line-removed">266 </span>
<span class="line-removed">267 void ResourceLoadObserver::logCanvasRead(const Document&amp; document)</span>
<span class="line-removed">268 {</span>
<span class="line-removed">269 #if ENABLE(WEB_API_STATISTICS)</span>
<span class="line-removed">270     if (!shouldLog(document.sessionID()))</span>
<span class="line-removed">271         return;</span>
<span class="line-removed">272     RegistrableDomain registrableDomain { document.url() };</span>
<span class="line-removed">273     auto&amp; statistics = ensureResourceStatisticsForRegistrableDomain(document.sessionID(), registrableDomain);</span>
<span class="line-removed">274     RegistrableDomain mainFrameRegistrableDomain { document.topDocument().url() };</span>
<span class="line-removed">275     statistics.canvasActivityRecord.wasDataRead = true;</span>
<span class="line-removed">276     if (statistics.topFrameRegistrableDomainsWhichAccessedWebAPIs.add(mainFrameRegistrableDomain.string()).isNewEntry)</span>
<span class="line-removed">277         scheduleNotificationIfNeeded();</span>
<span class="line-removed">278 #else</span>
<span class="line-removed">279     UNUSED_PARAM(document);</span>
<span class="line-removed">280 #endif</span>
<span class="line-removed">281 }</span>
<span class="line-removed">282 </span>
<span class="line-removed">283 void ResourceLoadObserver::logCanvasWriteOrMeasure(const Document&amp; document, const String&amp; textWritten)</span>
<span class="line-removed">284 {</span>
<span class="line-removed">285 #if ENABLE(WEB_API_STATISTICS)</span>
<span class="line-removed">286     if (!shouldLog(document.sessionID()))</span>
<span class="line-removed">287         return;</span>
<span class="line-removed">288     RegistrableDomain registrableDomain { document.url() };</span>
<span class="line-removed">289     auto&amp; statistics = ensureResourceStatisticsForRegistrableDomain(document.sessionID, registrableDomain);</span>
<span class="line-removed">290     bool shouldCallNotificationCallback = false;</span>
<span class="line-removed">291     RegistrableDomain mainFrameRegistrableDomain { document.topDocument().url() };</span>
<span class="line-removed">292     if (statistics.canvasActivityRecord.recordWrittenOrMeasuredText(textWritten))</span>
<span class="line-removed">293         shouldCallNotificationCallback = true;</span>
<span class="line-removed">294     if (statistics.topFrameRegistrableDomainsWhichAccessedWebAPIs.add(mainFrameRegistrableDomain.string()).isNewEntry)</span>
<span class="line-removed">295         shouldCallNotificationCallback = true;</span>
<span class="line-removed">296     if (shouldCallNotificationCallback)</span>
<span class="line-removed">297         scheduleNotificationIfNeeded();</span>
<span class="line-removed">298 #else</span>
<span class="line-removed">299     UNUSED_PARAM(document);</span>
<span class="line-removed">300     UNUSED_PARAM(textWritten);</span>
<span class="line-removed">301 #endif</span>
<span class="line-removed">302 }</span>
<span class="line-removed">303 </span>
<span class="line-removed">304 void ResourceLoadObserver::logNavigatorAPIAccessed(const Document&amp; document, const ResourceLoadStatistics::NavigatorAPI functionName)</span>
<span class="line-removed">305 {</span>
<span class="line-removed">306 #if ENABLE(WEB_API_STATISTICS)</span>
<span class="line-removed">307     if (!shouldLog(document.sessionID()))</span>
<span class="line-removed">308         return;</span>
<span class="line-removed">309     RegistrableDomain registrableDomain { document.url() };</span>
<span class="line-removed">310     auto&amp; statistics = ensureResourceStatisticsForRegistrableDomain(document.sessionID, registrableDomain);</span>
<span class="line-removed">311     bool shouldCallNotificationCallback = false;</span>
<span class="line-removed">312     if (!statistics.navigatorFunctionsAccessed.contains(functionName)) {</span>
<span class="line-removed">313         statistics.navigatorFunctionsAccessed.add(functionName);</span>
<span class="line-removed">314         shouldCallNotificationCallback = true;</span>
<span class="line-removed">315     }</span>
<span class="line-removed">316     RegistrableDomain mainFrameRegistrableDomain { document.topDocument().url() };</span>
<span class="line-removed">317     if (statistics.topFrameRegistrableDomainsWhichAccessedWebAPIs.add(mainFrameRegistrableDomain.string()).isNewEntry)</span>
<span class="line-removed">318         shouldCallNotificationCallback = true;</span>
<span class="line-removed">319     if (shouldCallNotificationCallback)</span>
<span class="line-removed">320         scheduleNotificationIfNeeded();</span>
<span class="line-removed">321 #else</span>
<span class="line-removed">322     UNUSED_PARAM(document);</span>
<span class="line-removed">323     UNUSED_PARAM(functionName);</span>
<span class="line-removed">324 #endif</span>
<span class="line-removed">325 }</span>
<span class="line-removed">326 </span>
<span class="line-removed">327 void ResourceLoadObserver::logScreenAPIAccessed(const Document&amp; document, const ResourceLoadStatistics::ScreenAPI functionName)</span>
<span class="line-removed">328 {</span>
<span class="line-removed">329 #if ENABLE(WEB_API_STATISTICS)</span>
<span class="line-removed">330     if (!shouldLog(document.sessionID()))</span>
<span class="line-removed">331         return;</span>
<span class="line-removed">332     RegistrableDomain registrableDomain { document.url() };</span>
<span class="line-removed">333     auto&amp; statistics = ensureResourceStatisticsForRegistrableDomain(document.sessionID, registrableDomain);</span>
<span class="line-removed">334     bool shouldCallNotificationCallback = false;</span>
<span class="line-removed">335     if (!statistics.screenFunctionsAccessed.contains(functionName)) {</span>
<span class="line-removed">336         statistics.screenFunctionsAccessed.add(functionName);</span>
<span class="line-removed">337         shouldCallNotificationCallback = true;</span>
<span class="line-removed">338     }</span>
<span class="line-removed">339     RegistrableDomain mainFrameRegistrableDomain { document.topDocument().url() };</span>
<span class="line-removed">340     if (statistics.topFrameRegistrableDomainsWhichAccessedWebAPIs.add(mainFrameRegistrableDomain.string()).isNewEntry)</span>
<span class="line-removed">341         shouldCallNotificationCallback = true;</span>
<span class="line-removed">342     if (shouldCallNotificationCallback)</span>
<span class="line-removed">343         scheduleNotificationIfNeeded();</span>
<span class="line-removed">344 #else</span>
<span class="line-removed">345     UNUSED_PARAM(document);</span>
<span class="line-removed">346     UNUSED_PARAM(functionName);</span>
<span class="line-removed">347 #endif</span>
<span class="line-removed">348 }</span>
<span class="line-removed">349 </span>
<span class="line-removed">350 ResourceLoadStatistics&amp; ResourceLoadObserver::ensureResourceStatisticsForRegistrableDomain(PAL::SessionID sessionID, const RegistrableDomain&amp; domain)</span>
<span class="line-removed">351 {</span>
<span class="line-removed">352     auto addResult = m_perSessionResourceStatisticsMap.ensure(sessionID, [] {</span>
<span class="line-removed">353         return makeUnique&lt;HashMap&lt;RegistrableDomain, ResourceLoadStatistics&gt;&gt;();</span>
<span class="line-removed">354     });</span>
<span class="line-removed">355 </span>
<span class="line-removed">356     auto addDomainResult = addResult.iterator-&gt;value-&gt;ensure(domain, [&amp;domain] {</span>
<span class="line-removed">357         return ResourceLoadStatistics(domain);</span>
<span class="line-removed">358     });</span>
<span class="line-removed">359     return addDomainResult.iterator-&gt;value;</span>
<span class="line-removed">360 }</span>
<span class="line-removed">361 </span>
<span class="line-removed">362 void ResourceLoadObserver::scheduleNotificationIfNeeded()</span>
<span class="line-removed">363 {</span>
<span class="line-removed">364     ASSERT(m_notificationCallback);</span>
<span class="line-removed">365     if (m_perSessionResourceStatisticsMap.isEmpty()) {</span>
<span class="line-removed">366         m_notificationTimer.stop();</span>
<span class="line-removed">367         return;</span>
<span class="line-removed">368     }</span>
<span class="line-removed">369 </span>
<span class="line-removed">370     if (!m_notificationTimer.isActive())</span>
<span class="line-removed">371         m_notificationTimer.startOneShot(minimumNotificationInterval);</span>
<span class="line-removed">372 }</span>
<span class="line-removed">373 </span>
<span class="line-removed">374 void ResourceLoadObserver::updateCentralStatisticsStore()</span>
<span class="line-removed">375 {</span>
<span class="line-removed">376     ASSERT(m_notificationCallback);</span>
<span class="line-removed">377     m_notificationTimer.stop();</span>
<span class="line-removed">378     m_notificationCallback(takeStatistics());</span>
<span class="line-removed">379 }</span>
<span class="line-removed">380 </span>
<span class="line-removed">381 String ResourceLoadObserver::statisticsForURL(PAL::SessionID sessionID, const URL&amp; url)</span>
<span class="line-removed">382 {</span>
<span class="line-removed">383     auto* resourceStatisticsByDomain = m_perSessionResourceStatisticsMap.get(sessionID);</span>
<span class="line-removed">384     if (!resourceStatisticsByDomain)</span>
<span class="line-removed">385         return emptyString();</span>
<span class="line-removed">386 </span>
<span class="line-removed">387     auto iter = resourceStatisticsByDomain-&gt;find(RegistrableDomain { url });</span>
<span class="line-removed">388     if (iter == resourceStatisticsByDomain-&gt;end())</span>
<span class="line-removed">389         return emptyString();</span>
<span class="line-removed">390 </span>
<span class="line-removed">391     return makeString(&quot;Statistics for &quot;, url.host().toString(), &quot;:\n&quot;, iter-&gt;value.toString());</span>
<span class="line-removed">392 }</span>
<span class="line-removed">393 </span>
<span class="line-removed">394 auto ResourceLoadObserver::takeStatistics() -&gt; PerSessionResourceLoadData</span>
<span class="line-removed">395 {</span>
<span class="line-removed">396     PerSessionResourceLoadData perSessionStatistics;</span>
<span class="line-removed">397 </span>
<span class="line-removed">398     for (auto&amp; iter : m_perSessionResourceStatisticsMap) {</span>
<span class="line-removed">399         Vector&lt;ResourceLoadStatistics&gt; statistics;</span>
<span class="line-removed">400         statistics.reserveInitialCapacity(iter.value-&gt;size());</span>
<span class="line-removed">401 </span>
<span class="line-removed">402         for (auto&amp; statistic : iter.value-&gt;values())</span>
<span class="line-removed">403             statistics.uncheckedAppend(WTFMove(statistic));</span>
<span class="line-removed">404 </span>
<span class="line-removed">405         perSessionStatistics.append(std::make_pair(iter.key, WTFMove(statistics)));</span>
<span class="line-removed">406     }</span>
<span class="line-removed">407 </span>
<span class="line-removed">408     m_perSessionResourceStatisticsMap.clear();</span>
<span class="line-removed">409     return perSessionStatistics;</span>
<span class="line-removed">410 }</span>
<span class="line-removed">411 </span>
<span class="line-removed">412 void ResourceLoadObserver::clearState()</span>
413 {
<a name="7" id="anc7"></a><span class="line-modified">414     m_notificationTimer.stop();</span>
<span class="line-modified">415     m_perSessionResourceStatisticsMap.clear();</span>
<span class="line-modified">416     m_lastReportedUserInteractionMap.clear();</span>

417 }
418 
<a name="8" id="anc8"></a><span class="line-modified">419 URL ResourceLoadObserver::nonNullOwnerURL(const Document&amp; document) const</span>
420 {
<a name="9" id="anc9"></a><span class="line-modified">421     auto url = document.url();</span>
<span class="line-removed">422     auto* frame = document.frame();</span>
<span class="line-removed">423     auto host = document.url().host();</span>
<span class="line-removed">424 </span>
<span class="line-removed">425     while ((host.isNull() || host.isEmpty()) &amp;&amp; frame &amp;&amp; !frame-&gt;isMainFrame()) {</span>
<span class="line-removed">426         auto* ownerElement = frame-&gt;ownerElement();</span>
<span class="line-removed">427 </span>
<span class="line-removed">428         ASSERT(ownerElement != nullptr);</span>
<span class="line-removed">429 </span>
<span class="line-removed">430         auto&amp; doc = ownerElement-&gt;document();</span>
<span class="line-removed">431         frame = doc.frame();</span>
<span class="line-removed">432         url = doc.url();</span>
<span class="line-removed">433         host = url.host();</span>
<span class="line-removed">434     }</span>
<span class="line-removed">435 </span>
<span class="line-removed">436     return url;</span>
437 }
438 
439 } // namespace WebCore
<a name="10" id="anc10"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="10" type="hidden" />
</body>
</html>