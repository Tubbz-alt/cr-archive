<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/WebCore/css/CSSPrimitiveValue.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * (C) 1999-2003 Lars Knoll (knoll@kde.org)
   3  * Copyright (C) 2004, 2005, 2006, 2007, 2008, 2012, 2013 Apple Inc. All rights reserved.
   4  *
   5  * This library is free software; you can redistribute it and/or
   6  * modify it under the terms of the GNU Library General Public
   7  * License as published by the Free Software Foundation; either
   8  * version 2 of the License, or (at your option) any later version.
   9  *
  10  * This library is distributed in the hope that it will be useful,
  11  * but WITHOUT ANY WARRANTY; without even the implied warranty of
  12  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
  13  * Library General Public License for more details.
  14  *
  15  * You should have received a copy of the GNU Library General Public License
  16  * along with this library; see the file COPYING.LIB.  If not, write to
  17  * the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
  18  * Boston, MA 02110-1301, USA.
  19  */
  20 
  21 #include &quot;config.h&quot;
  22 #include &quot;CSSPrimitiveValue.h&quot;
  23 
  24 #include &quot;CSSBasicShapes.h&quot;
  25 #include &quot;CSSCalculationValue.h&quot;
  26 #include &quot;CSSFontFamily.h&quot;
  27 #include &quot;CSSHelper.h&quot;
  28 #include &quot;CSSMarkup.h&quot;
  29 #include &quot;CSSPrimitiveValueMappings.h&quot;
  30 #include &quot;CSSPropertyNames.h&quot;
  31 #include &quot;CSSToLengthConversionData.h&quot;
  32 #include &quot;CSSValueKeywords.h&quot;
  33 #include &quot;CalculationValue.h&quot;
  34 #include &quot;Color.h&quot;
  35 #include &quot;Counter.h&quot;
  36 #include &quot;DeprecatedCSSOMPrimitiveValue.h&quot;
  37 #include &quot;FontCascade.h&quot;
  38 #include &quot;Node.h&quot;
  39 #include &quot;Pair.h&quot;
<a name="1" id="anc1"></a>
  40 #include &quot;Rect.h&quot;
  41 #include &quot;RenderStyle.h&quot;
  42 #include &lt;wtf/NeverDestroyed.h&gt;
  43 #include &lt;wtf/StdLibExtras.h&gt;
  44 #include &lt;wtf/text/StringBuilder.h&gt;
  45 #include &lt;wtf/text/StringConcatenateNumbers.h&gt;
  46 
  47 namespace WebCore {
  48 
<a name="2" id="anc2"></a><span class="line-modified">  49 static inline bool isValidCSSUnitTypeForDoubleConversion(CSSUnitType unitType)</span>
  50 {
  51     switch (unitType) {
<a name="3" id="anc3"></a><span class="line-modified">  52     case CSSUnitType::CSS_CALC:</span>
<span class="line-modified">  53     case CSSUnitType::CSS_CALC_PERCENTAGE_WITH_LENGTH:</span>
<span class="line-modified">  54     case CSSUnitType::CSS_CALC_PERCENTAGE_WITH_NUMBER:</span>
<span class="line-modified">  55     case CSSUnitType::CSS_CHS:</span>
<span class="line-modified">  56     case CSSUnitType::CSS_CM:</span>
<span class="line-modified">  57     case CSSUnitType::CSS_DEG:</span>
<span class="line-modified">  58     case CSSUnitType::CSS_DIMENSION:</span>
<span class="line-modified">  59     case CSSUnitType::CSS_EMS:</span>
<span class="line-modified">  60     case CSSUnitType::CSS_EXS:</span>
<span class="line-modified">  61     case CSSUnitType::CSS_FR:</span>
<span class="line-modified">  62     case CSSUnitType::CSS_GRAD:</span>
<span class="line-modified">  63     case CSSUnitType::CSS_HZ:</span>
<span class="line-modified">  64     case CSSUnitType::CSS_IN:</span>
<span class="line-modified">  65     case CSSUnitType::CSS_KHZ:</span>
<span class="line-modified">  66     case CSSUnitType::CSS_MM:</span>
<span class="line-modified">  67     case CSSUnitType::CSS_MS:</span>
<span class="line-modified">  68     case CSSUnitType::CSS_NUMBER:</span>
<span class="line-modified">  69     case CSSUnitType::CSS_PC:</span>
<span class="line-modified">  70     case CSSUnitType::CSS_PERCENTAGE:</span>
<span class="line-modified">  71     case CSSUnitType::CSS_PT:</span>
<span class="line-modified">  72     case CSSUnitType::CSS_PX:</span>
<span class="line-modified">  73     case CSSUnitType::CSS_Q:</span>
<span class="line-modified">  74     case CSSUnitType::CSS_QUIRKY_EMS:</span>
<span class="line-modified">  75     case CSSUnitType::CSS_RAD:</span>
<span class="line-modified">  76     case CSSUnitType::CSS_REMS:</span>
<span class="line-modified">  77     case CSSUnitType::CSS_S:</span>
<span class="line-modified">  78     case CSSUnitType::CSS_TURN:</span>
<span class="line-modified">  79     case CSSUnitType::CSS_VH:</span>
<span class="line-modified">  80     case CSSUnitType::CSS_VMAX:</span>
<span class="line-modified">  81     case CSSUnitType::CSS_VMIN:</span>
<span class="line-added">  82     case CSSUnitType::CSS_VW:</span>
<span class="line-added">  83     case CSSUnitType::CSS_DPCM:</span>
<span class="line-added">  84     case CSSUnitType::CSS_DPI:</span>
<span class="line-added">  85     case CSSUnitType::CSS_DPPX:</span>
  86         return true;
<a name="4" id="anc4"></a><span class="line-modified">  87     case CSSUnitType::CSS_ATTR:</span>
<span class="line-modified">  88     case CSSUnitType::CSS_COUNTER:</span>
<span class="line-modified">  89     case CSSUnitType::CSS_COUNTER_NAME:</span>
<span class="line-modified">  90     case CSSUnitType::CSS_FONT_FAMILY:</span>
<span class="line-modified">  91     case CSSUnitType::CSS_IDENT:</span>
<span class="line-modified">  92     case CSSUnitType::CSS_PAIR:</span>
<span class="line-modified">  93     case CSSUnitType::CSS_PROPERTY_ID:</span>
<span class="line-modified">  94     case CSSUnitType::CSS_QUAD:</span>
<span class="line-modified">  95     case CSSUnitType::CSS_RECT:</span>
<span class="line-modified">  96     case CSSUnitType::CSS_RGBCOLOR:</span>
<span class="line-modified">  97     case CSSUnitType::CSS_SHAPE:</span>
<span class="line-modified">  98     case CSSUnitType::CSS_STRING:</span>
<span class="line-modified">  99     case CSSUnitType::CSS_UNICODE_RANGE:</span>
<span class="line-modified"> 100     case CSSUnitType::CSS_UNKNOWN:</span>
<span class="line-modified"> 101     case CSSUnitType::CSS_URI:</span>
<span class="line-modified"> 102     case CSSUnitType::CSS_VALUE_ID:</span>








 103         return false;
 104     }
 105 
 106     ASSERT_NOT_REACHED();
 107     return false;
 108 }
 109 
<a name="5" id="anc5"></a><span class="line-modified"> 110 #if ASSERT_ENABLED</span>
 111 
<a name="6" id="anc6"></a><span class="line-modified"> 112 static inline bool isStringType(CSSUnitType type)</span>
 113 {
 114     switch (type) {
<a name="7" id="anc7"></a><span class="line-modified"> 115     case CSSUnitType::CSS_STRING:</span>
<span class="line-modified"> 116     case CSSUnitType::CSS_URI:</span>
<span class="line-modified"> 117     case CSSUnitType::CSS_ATTR:</span>
<span class="line-modified"> 118     case CSSUnitType::CSS_COUNTER_NAME:</span>
<span class="line-modified"> 119     case CSSUnitType::CSS_DIMENSION:</span>
 120         return true;
<a name="8" id="anc8"></a><span class="line-modified"> 121     case CSSUnitType::CSS_CALC:</span>
<span class="line-modified"> 122     case CSSUnitType::CSS_CALC_PERCENTAGE_WITH_LENGTH:</span>
<span class="line-modified"> 123     case CSSUnitType::CSS_CALC_PERCENTAGE_WITH_NUMBER:</span>
<span class="line-modified"> 124     case CSSUnitType::CSS_CHS:</span>
<span class="line-modified"> 125     case CSSUnitType::CSS_CM:</span>
<span class="line-modified"> 126     case CSSUnitType::CSS_COUNTER:</span>
<span class="line-modified"> 127     case CSSUnitType::CSS_DEG:</span>
<span class="line-modified"> 128     case CSSUnitType::CSS_DPCM:</span>
<span class="line-modified"> 129     case CSSUnitType::CSS_DPI:</span>
<span class="line-modified"> 130     case CSSUnitType::CSS_DPPX:</span>
<span class="line-modified"> 131     case CSSUnitType::CSS_EMS:</span>
<span class="line-modified"> 132     case CSSUnitType::CSS_EXS:</span>
<span class="line-modified"> 133     case CSSUnitType::CSS_FONT_FAMILY:</span>
<span class="line-modified"> 134     case CSSUnitType::CSS_FR:</span>
<span class="line-modified"> 135     case CSSUnitType::CSS_GRAD:</span>
<span class="line-modified"> 136     case CSSUnitType::CSS_HZ:</span>
<span class="line-modified"> 137     case CSSUnitType::CSS_IDENT:</span>
<span class="line-modified"> 138     case CSSUnitType::CSS_IN:</span>
<span class="line-modified"> 139     case CSSUnitType::CSS_KHZ:</span>
<span class="line-modified"> 140     case CSSUnitType::CSS_MM:</span>
<span class="line-modified"> 141     case CSSUnitType::CSS_MS:</span>
<span class="line-modified"> 142     case CSSUnitType::CSS_NUMBER:</span>
<span class="line-modified"> 143     case CSSUnitType::CSS_PAIR:</span>
<span class="line-modified"> 144     case CSSUnitType::CSS_PC:</span>
<span class="line-modified"> 145     case CSSUnitType::CSS_PERCENTAGE:</span>
<span class="line-modified"> 146     case CSSUnitType::CSS_PROPERTY_ID:</span>
<span class="line-modified"> 147     case CSSUnitType::CSS_PT:</span>
<span class="line-modified"> 148     case CSSUnitType::CSS_PX:</span>
<span class="line-modified"> 149     case CSSUnitType::CSS_Q:</span>
<span class="line-modified"> 150     case CSSUnitType::CSS_QUAD:</span>
<span class="line-modified"> 151     case CSSUnitType::CSS_QUIRKY_EMS:</span>
<span class="line-modified"> 152     case CSSUnitType::CSS_RAD:</span>
<span class="line-modified"> 153     case CSSUnitType::CSS_RECT:</span>
<span class="line-modified"> 154     case CSSUnitType::CSS_REMS:</span>
<span class="line-modified"> 155     case CSSUnitType::CSS_RGBCOLOR:</span>
<span class="line-modified"> 156     case CSSUnitType::CSS_S:</span>
<span class="line-modified"> 157     case CSSUnitType::CSS_SHAPE:</span>
<span class="line-modified"> 158     case CSSUnitType::CSS_TURN:</span>
<span class="line-modified"> 159     case CSSUnitType::CSS_UNICODE_RANGE:</span>
<span class="line-modified"> 160     case CSSUnitType::CSS_UNKNOWN:</span>
<span class="line-modified"> 161     case CSSUnitType::CSS_VALUE_ID:</span>
<span class="line-modified"> 162     case CSSUnitType::CSS_VH:</span>
<span class="line-modified"> 163     case CSSUnitType::CSS_VMAX:</span>
<span class="line-modified"> 164     case CSSUnitType::CSS_VMIN:</span>
<span class="line-added"> 165     case CSSUnitType::CSS_VW:</span>
 166         return false;
 167     }
 168 
 169     ASSERT_NOT_REACHED();
 170     return false;
 171 }
 172 
<a name="9" id="anc9"></a><span class="line-modified"> 173 #endif // ASSERT_ENABLED</span>






































 174 
 175 typedef HashMap&lt;const CSSPrimitiveValue*, String&gt; CSSTextCache;
 176 static CSSTextCache&amp; cssTextCache()
 177 {
 178     static NeverDestroyed&lt;CSSTextCache&gt; cache;
 179     return cache;
 180 }
 181 
<a name="10" id="anc10"></a><span class="line-modified"> 182 CSSUnitType CSSPrimitiveValue::primitiveType() const</span>
 183 {
<a name="11" id="anc11"></a><span class="line-modified"> 184     if (primitiveUnitType() == CSSUnitType::CSS_PROPERTY_ID || primitiveUnitType() == CSSUnitType::CSS_VALUE_ID)</span>
<span class="line-modified"> 185         return CSSUnitType::CSS_IDENT;</span>
 186 
<a name="12" id="anc12"></a><span class="line-modified"> 187     // Web-exposed content expects font family values to have CSSUnitType::CSS_STRING primitive type</span>
<span class="line-modified"> 188     // so we need to map our internal CSSUnitType::CSS_FONT_FAMILY type here.</span>
<span class="line-modified"> 189     if (primitiveUnitType() == CSSUnitType::CSS_FONT_FAMILY)</span>
<span class="line-modified"> 190         return CSSUnitType::CSS_STRING;</span>
 191 
<a name="13" id="anc13"></a><span class="line-modified"> 192     if (primitiveUnitType() != CSSUnitType::CSS_CALC)</span>
<span class="line-modified"> 193         return primitiveUnitType();</span>
 194 
 195     switch (m_value.calc-&gt;category()) {
 196     case CalculationCategory::Number:
<a name="14" id="anc14"></a><span class="line-modified"> 197         return CSSUnitType::CSS_NUMBER;</span>


 198     case CalculationCategory::Percent:
<a name="15" id="anc15"></a><span class="line-modified"> 199         return CSSUnitType::CSS_PERCENTAGE;</span>
 200     case CalculationCategory::PercentNumber:
<a name="16" id="anc16"></a><span class="line-modified"> 201         return CSSUnitType::CSS_CALC_PERCENTAGE_WITH_NUMBER;</span>
 202     case CalculationCategory::PercentLength:
<a name="17" id="anc17"></a><span class="line-modified"> 203         return CSSUnitType::CSS_CALC_PERCENTAGE_WITH_LENGTH;</span>
<span class="line-added"> 204     case CalculationCategory::Length:</span>
 205     case CalculationCategory::Angle:
 206     case CalculationCategory::Time:
 207     case CalculationCategory::Frequency:
 208         return m_value.calc-&gt;primitiveType();
 209     case CalculationCategory::Other:
<a name="18" id="anc18"></a><span class="line-modified"> 210         return CSSUnitType::CSS_UNKNOWN;</span>
 211     }
<a name="19" id="anc19"></a><span class="line-modified"> 212     return CSSUnitType::CSS_UNKNOWN;</span>
 213 }
 214 
 215 static const AtomString&amp; propertyName(CSSPropertyID propertyID)
 216 {
 217     ASSERT_ARG(propertyID, (propertyID &gt;= firstCSSProperty &amp;&amp; propertyID &lt; firstCSSProperty + numCSSProperties));
 218 
 219     return getPropertyNameAtomString(propertyID);
 220 }
 221 
 222 static const AtomString&amp; valueName(CSSValueID valueID)
 223 {
 224     ASSERT_ARG(valueID, (valueID &gt;= firstCSSValueKeyword &amp;&amp; valueID &lt;= lastCSSValueKeyword));
 225 
 226     return getValueNameAtomString(valueID);
 227 }
 228 
 229 CSSPrimitiveValue::CSSPrimitiveValue(CSSValueID valueID)
 230     : CSSValue(PrimitiveClass)
 231 {
<a name="20" id="anc20"></a><span class="line-modified"> 232     setPrimitiveUnitType(CSSUnitType::CSS_VALUE_ID);</span>
 233     m_value.valueID = valueID;
 234 }
 235 
 236 CSSPrimitiveValue::CSSPrimitiveValue(CSSPropertyID propertyID)
 237     : CSSValue(PrimitiveClass)
 238 {
<a name="21" id="anc21"></a><span class="line-modified"> 239     setPrimitiveUnitType(CSSUnitType::CSS_PROPERTY_ID);</span>
 240     m_value.propertyID = propertyID;
 241 }
 242 
<a name="22" id="anc22"></a><span class="line-modified"> 243 CSSPrimitiveValue::CSSPrimitiveValue(double num, CSSUnitType type)</span>
 244     : CSSValue(PrimitiveClass)
 245 {
<a name="23" id="anc23"></a><span class="line-modified"> 246     setPrimitiveUnitType(type);</span>
 247     ASSERT(std::isfinite(num));
 248     m_value.num = num;
 249 }
 250 
<a name="24" id="anc24"></a><span class="line-modified"> 251 CSSPrimitiveValue::CSSPrimitiveValue(const String&amp; string, CSSUnitType type)</span>
 252     : CSSValue(PrimitiveClass)
 253 {
 254     ASSERT(isStringType(type));
<a name="25" id="anc25"></a><span class="line-modified"> 255     setPrimitiveUnitType(type);</span>
 256     if ((m_value.string = string.impl()))
 257         m_value.string-&gt;ref();
 258 }
 259 
 260 CSSPrimitiveValue::CSSPrimitiveValue(const Color&amp; color)
 261     : CSSValue(PrimitiveClass)
 262 {
<a name="26" id="anc26"></a><span class="line-modified"> 263     setPrimitiveUnitType(CSSUnitType::CSS_RGBCOLOR);</span>
 264     m_value.color = new Color(color);
 265 }
 266 
 267 CSSPrimitiveValue::CSSPrimitiveValue(const Length&amp; length)
 268     : CSSValue(PrimitiveClass)
 269 {
 270     init(length);
 271 }
 272 
 273 CSSPrimitiveValue::CSSPrimitiveValue(const Length&amp; length, const RenderStyle&amp; style)
 274     : CSSValue(PrimitiveClass)
 275 {
 276     switch (length.type()) {
 277     case Auto:
 278     case Intrinsic:
 279     case MinIntrinsic:
 280     case MinContent:
 281     case MaxContent:
 282     case FillAvailable:
 283     case FitContent:
 284     case Percent:
 285         init(length);
 286         return;
 287     case Fixed:
<a name="27" id="anc27"></a><span class="line-modified"> 288         setPrimitiveUnitType(CSSUnitType::CSS_PX);</span>
 289         m_value.num = adjustFloatForAbsoluteZoom(length.value(), style);
 290         return;
 291     case Calculated: {
 292         init(CSSCalcValue::create(length.calculationValue(), style));
 293         return;
 294     }
 295     case Relative:
 296     case Undefined:
 297         ASSERT_NOT_REACHED();
 298         return;
 299     }
 300     ASSERT_NOT_REACHED();
 301 }
 302 
 303 CSSPrimitiveValue::CSSPrimitiveValue(const LengthSize&amp; lengthSize, const RenderStyle&amp; style)
 304     : CSSValue(PrimitiveClass)
 305 {
 306     init(lengthSize, style);
 307 }
 308 
<a name="28" id="anc28"></a><span class="line-added"> 309 CSSPrimitiveValue::CSSPrimitiveValue(StaticCSSValueTag, CSSValueID valueID)</span>
<span class="line-added"> 310     : CSSPrimitiveValue(valueID)</span>
<span class="line-added"> 311 {</span>
<span class="line-added"> 312     makeStatic();</span>
<span class="line-added"> 313 }</span>
<span class="line-added"> 314 </span>
<span class="line-added"> 315 CSSPrimitiveValue::CSSPrimitiveValue(StaticCSSValueTag, const Color&amp; color)</span>
<span class="line-added"> 316     : CSSPrimitiveValue(color)</span>
<span class="line-added"> 317 {</span>
<span class="line-added"> 318     makeStatic();</span>
<span class="line-added"> 319 }</span>
<span class="line-added"> 320 </span>
<span class="line-added"> 321 CSSPrimitiveValue::CSSPrimitiveValue(StaticCSSValueTag, double num, CSSUnitType type)</span>
<span class="line-added"> 322     : CSSPrimitiveValue(num, type)</span>
<span class="line-added"> 323 {</span>
<span class="line-added"> 324     makeStatic();</span>
<span class="line-added"> 325 }</span>
<span class="line-added"> 326 </span>
 327 void CSSPrimitiveValue::init(const Length&amp; length)
 328 {
 329     switch (length.type()) {
 330     case Auto:
<a name="29" id="anc29"></a><span class="line-modified"> 331         setPrimitiveUnitType(CSSUnitType::CSS_VALUE_ID);</span>
 332         m_value.valueID = CSSValueAuto;
 333         return;
 334     case WebCore::Fixed:
<a name="30" id="anc30"></a><span class="line-modified"> 335         setPrimitiveUnitType(CSSUnitType::CSS_PX);</span>
 336         m_value.num = length.value();
 337         return;
 338     case Intrinsic:
<a name="31" id="anc31"></a><span class="line-modified"> 339         setPrimitiveUnitType(CSSUnitType::CSS_VALUE_ID);</span>
 340         m_value.valueID = CSSValueIntrinsic;
 341         return;
 342     case MinIntrinsic:
<a name="32" id="anc32"></a><span class="line-modified"> 343         setPrimitiveUnitType(CSSUnitType::CSS_VALUE_ID);</span>
 344         m_value.valueID = CSSValueMinIntrinsic;
 345         return;
 346     case MinContent:
<a name="33" id="anc33"></a><span class="line-modified"> 347         setPrimitiveUnitType(CSSUnitType::CSS_VALUE_ID);</span>
 348         m_value.valueID = CSSValueMinContent;
 349         return;
 350     case MaxContent:
<a name="34" id="anc34"></a><span class="line-modified"> 351         setPrimitiveUnitType(CSSUnitType::CSS_VALUE_ID);</span>
 352         m_value.valueID = CSSValueMaxContent;
 353         return;
 354     case FillAvailable:
<a name="35" id="anc35"></a><span class="line-modified"> 355         setPrimitiveUnitType(CSSUnitType::CSS_VALUE_ID);</span>
 356         m_value.valueID = CSSValueWebkitFillAvailable;
 357         return;
 358     case FitContent:
<a name="36" id="anc36"></a><span class="line-modified"> 359         setPrimitiveUnitType(CSSUnitType::CSS_VALUE_ID);</span>
 360         m_value.valueID = CSSValueFitContent;
 361         return;
 362     case Percent:
<a name="37" id="anc37"></a><span class="line-modified"> 363         setPrimitiveUnitType(CSSUnitType::CSS_PERCENTAGE);</span>
 364         ASSERT(std::isfinite(length.percent()));
 365         m_value.num = length.percent();
 366         return;
 367     case Calculated:
 368     case Relative:
 369     case Undefined:
 370         ASSERT_NOT_REACHED();
 371         return;
 372     }
 373     ASSERT_NOT_REACHED();
 374 }
 375 
 376 void CSSPrimitiveValue::init(const LengthSize&amp; lengthSize, const RenderStyle&amp; style)
 377 {
<a name="38" id="anc38"></a><span class="line-modified"> 378     setPrimitiveUnitType(CSSUnitType::CSS_PAIR);</span>
 379     m_hasCachedCSSText = false;
 380     m_value.pair = &amp;Pair::create(create(lengthSize.width, style), create(lengthSize.height, style)).leakRef();
 381 }
 382 
 383 void CSSPrimitiveValue::init(Ref&lt;Counter&gt;&amp;&amp; counter)
 384 {
<a name="39" id="anc39"></a><span class="line-modified"> 385     setPrimitiveUnitType(CSSUnitType::CSS_COUNTER);</span>
 386     m_hasCachedCSSText = false;
 387     m_value.counter = &amp;counter.leakRef();
 388 }
 389 
 390 void CSSPrimitiveValue::init(Ref&lt;Rect&gt;&amp;&amp; r)
 391 {
<a name="40" id="anc40"></a><span class="line-modified"> 392     setPrimitiveUnitType(CSSUnitType::CSS_RECT);</span>
 393     m_hasCachedCSSText = false;
 394     m_value.rect = &amp;r.leakRef();
 395 }
 396 
 397 void CSSPrimitiveValue::init(Ref&lt;Quad&gt;&amp;&amp; quad)
 398 {
<a name="41" id="anc41"></a><span class="line-modified"> 399     setPrimitiveUnitType(CSSUnitType::CSS_QUAD);</span>
 400     m_hasCachedCSSText = false;
 401     m_value.quad = &amp;quad.leakRef();
 402 }
 403 
 404 void CSSPrimitiveValue::init(Ref&lt;Pair&gt;&amp;&amp; p)
 405 {
<a name="42" id="anc42"></a><span class="line-modified"> 406     setPrimitiveUnitType(CSSUnitType::CSS_PAIR);</span>
 407     m_hasCachedCSSText = false;
 408     m_value.pair = &amp;p.leakRef();
 409 }
 410 
 411 void CSSPrimitiveValue::init(Ref&lt;CSSBasicShape&gt;&amp;&amp; shape)
 412 {
<a name="43" id="anc43"></a><span class="line-modified"> 413     setPrimitiveUnitType(CSSUnitType::CSS_SHAPE);</span>
 414     m_hasCachedCSSText = false;
 415     m_value.shape = &amp;shape.leakRef();
 416 }
 417 
 418 void CSSPrimitiveValue::init(RefPtr&lt;CSSCalcValue&gt;&amp;&amp; c)
 419 {
<a name="44" id="anc44"></a><span class="line-modified"> 420     setPrimitiveUnitType(CSSUnitType::CSS_CALC);</span>
 421     m_hasCachedCSSText = false;
 422     m_value.calc = c.leakRef();
 423 }
 424 
 425 CSSPrimitiveValue::~CSSPrimitiveValue()
 426 {
 427     cleanup();
 428 }
 429 
 430 void CSSPrimitiveValue::cleanup()
 431 {
<a name="45" id="anc45"></a><span class="line-modified"> 432     auto type = primitiveUnitType();</span>
 433     switch (type) {
<a name="46" id="anc46"></a><span class="line-modified"> 434     case CSSUnitType::CSS_STRING:</span>
<span class="line-modified"> 435     case CSSUnitType::CSS_URI:</span>
<span class="line-modified"> 436     case CSSUnitType::CSS_ATTR:</span>
<span class="line-modified"> 437     case CSSUnitType::CSS_COUNTER_NAME:</span>
 438         if (m_value.string)
 439             m_value.string-&gt;deref();
 440         break;
<a name="47" id="anc47"></a><span class="line-modified"> 441     case CSSUnitType::CSS_DIMENSION:</span>
<span class="line-modified"> 442     case CSSUnitType::CSS_COUNTER:</span>
 443         m_value.counter-&gt;deref();
 444         break;
<a name="48" id="anc48"></a><span class="line-modified"> 445     case CSSUnitType::CSS_RECT:</span>
 446         m_value.rect-&gt;deref();
 447         break;
<a name="49" id="anc49"></a><span class="line-modified"> 448     case CSSUnitType::CSS_QUAD:</span>
 449         m_value.quad-&gt;deref();
 450         break;
<a name="50" id="anc50"></a><span class="line-modified"> 451     case CSSUnitType::CSS_PAIR:</span>
 452         m_value.pair-&gt;deref();
 453         break;
<a name="51" id="anc51"></a><span class="line-modified"> 454     case CSSUnitType::CSS_CALC:</span>
 455         m_value.calc-&gt;deref();
 456         break;
<a name="52" id="anc52"></a><span class="line-modified"> 457     case CSSUnitType::CSS_CALC_PERCENTAGE_WITH_NUMBER:</span>
<span class="line-modified"> 458     case CSSUnitType::CSS_CALC_PERCENTAGE_WITH_LENGTH:</span>
 459         ASSERT_NOT_REACHED();
 460         break;
<a name="53" id="anc53"></a><span class="line-modified"> 461     case CSSUnitType::CSS_SHAPE:</span>
 462         m_value.shape-&gt;deref();
 463         break;
<a name="54" id="anc54"></a><span class="line-modified"> 464     case CSSUnitType::CSS_FONT_FAMILY:</span>
 465         ASSERT(m_value.fontFamily);
 466         delete m_value.fontFamily;
 467         m_value.fontFamily = nullptr;
 468         break;
<a name="55" id="anc55"></a><span class="line-modified"> 469     case CSSUnitType::CSS_RGBCOLOR:</span>
 470         ASSERT(m_value.color);
 471         delete m_value.color;
 472         m_value.color = nullptr;
 473         break;
<a name="56" id="anc56"></a><span class="line-modified"> 474     case CSSUnitType::CSS_NUMBER:</span>
<span class="line-modified"> 475     case CSSUnitType::CSS_PERCENTAGE:</span>
<span class="line-modified"> 476     case CSSUnitType::CSS_EMS:</span>
<span class="line-modified"> 477     case CSSUnitType::CSS_QUIRKY_EMS:</span>
<span class="line-modified"> 478     case CSSUnitType::CSS_EXS:</span>
<span class="line-modified"> 479     case CSSUnitType::CSS_REMS:</span>
<span class="line-modified"> 480     case CSSUnitType::CSS_CHS:</span>
<span class="line-modified"> 481     case CSSUnitType::CSS_PX:</span>
<span class="line-modified"> 482     case CSSUnitType::CSS_CM:</span>
<span class="line-modified"> 483     case CSSUnitType::CSS_MM:</span>
<span class="line-modified"> 484     case CSSUnitType::CSS_IN:</span>
<span class="line-modified"> 485     case CSSUnitType::CSS_PT:</span>
<span class="line-modified"> 486     case CSSUnitType::CSS_PC:</span>
<span class="line-modified"> 487     case CSSUnitType::CSS_DEG:</span>
<span class="line-modified"> 488     case CSSUnitType::CSS_RAD:</span>
<span class="line-modified"> 489     case CSSUnitType::CSS_GRAD:</span>
<span class="line-modified"> 490     case CSSUnitType::CSS_MS:</span>
<span class="line-modified"> 491     case CSSUnitType::CSS_S:</span>
<span class="line-modified"> 492     case CSSUnitType::CSS_HZ:</span>
<span class="line-modified"> 493     case CSSUnitType::CSS_KHZ:</span>
<span class="line-modified"> 494     case CSSUnitType::CSS_TURN:</span>
<span class="line-modified"> 495     case CSSUnitType::CSS_VW:</span>
<span class="line-modified"> 496     case CSSUnitType::CSS_VH:</span>
<span class="line-modified"> 497     case CSSUnitType::CSS_VMIN:</span>
<span class="line-modified"> 498     case CSSUnitType::CSS_VMAX:</span>
<span class="line-modified"> 499     case CSSUnitType::CSS_DPPX:</span>
<span class="line-modified"> 500     case CSSUnitType::CSS_DPI:</span>
<span class="line-modified"> 501     case CSSUnitType::CSS_DPCM:</span>
<span class="line-modified"> 502     case CSSUnitType::CSS_FR:</span>
<span class="line-modified"> 503     case CSSUnitType::CSS_Q:</span>
<span class="line-modified"> 504     case CSSUnitType::CSS_IDENT:</span>
<span class="line-modified"> 505     case CSSUnitType::CSS_UNKNOWN:</span>
<span class="line-modified"> 506     case CSSUnitType::CSS_UNICODE_RANGE:</span>
<span class="line-modified"> 507     case CSSUnitType::CSS_PROPERTY_ID:</span>
<span class="line-added"> 508     case CSSUnitType::CSS_VALUE_ID:</span>
 509         ASSERT(!isStringType(type));
 510         break;
 511     }
<a name="57" id="anc57"></a><span class="line-modified"> 512     setPrimitiveUnitType(CSSUnitType::CSS_UNKNOWN);</span>
 513     if (m_hasCachedCSSText) {
 514         cssTextCache().remove(this);
 515         m_hasCachedCSSText = false;
 516     }
 517 }
 518 
 519 double CSSPrimitiveValue::computeDegrees() const
 520 {
 521     switch (primitiveType()) {
<a name="58" id="anc58"></a><span class="line-modified"> 522     case CSSUnitType::CSS_DEG:</span>
 523         return doubleValue();
<a name="59" id="anc59"></a><span class="line-modified"> 524     case CSSUnitType::CSS_RAD:</span>
 525         return rad2deg(doubleValue());
<a name="60" id="anc60"></a><span class="line-modified"> 526     case CSSUnitType::CSS_GRAD:</span>
 527         return grad2deg(doubleValue());
<a name="61" id="anc61"></a><span class="line-modified"> 528     case CSSUnitType::CSS_TURN:</span>
 529         return turn2deg(doubleValue());
 530     default:
 531         ASSERT_NOT_REACHED();
 532         return 0;
 533     }
 534 }
 535 
 536 template&lt;&gt; int CSSPrimitiveValue::computeLength(const CSSToLengthConversionData&amp; conversionData) const
 537 {
 538     return roundForImpreciseConversion&lt;int&gt;(computeLengthDouble(conversionData));
 539 }
 540 
 541 template&lt;&gt; unsigned CSSPrimitiveValue::computeLength(const CSSToLengthConversionData&amp; conversionData) const
 542 {
 543     return roundForImpreciseConversion&lt;unsigned&gt;(computeLengthDouble(conversionData));
 544 }
 545 
 546 template&lt;&gt; Length CSSPrimitiveValue::computeLength(const CSSToLengthConversionData&amp; conversionData) const
 547 {
 548     return Length(clampTo&lt;float&gt;(computeLengthDouble(conversionData), minValueForCssLength, maxValueForCssLength), Fixed);
 549 }
 550 
 551 template&lt;&gt; short CSSPrimitiveValue::computeLength(const CSSToLengthConversionData&amp; conversionData) const
 552 {
 553     return roundForImpreciseConversion&lt;short&gt;(computeLengthDouble(conversionData));
 554 }
 555 
 556 template&lt;&gt; unsigned short CSSPrimitiveValue::computeLength(const CSSToLengthConversionData&amp; conversionData) const
 557 {
 558     return roundForImpreciseConversion&lt;unsigned short&gt;(computeLengthDouble(conversionData));
 559 }
 560 
 561 template&lt;&gt; float CSSPrimitiveValue::computeLength(const CSSToLengthConversionData&amp; conversionData) const
 562 {
 563     return static_cast&lt;float&gt;(computeLengthDouble(conversionData));
 564 }
 565 
 566 template&lt;&gt; double CSSPrimitiveValue::computeLength(const CSSToLengthConversionData&amp; conversionData) const
 567 {
 568     return computeLengthDouble(conversionData);
 569 }
 570 
<a name="62" id="anc62"></a><span class="line-added"> 571 template&lt;&gt; LayoutUnit CSSPrimitiveValue::computeLength(const CSSToLengthConversionData&amp; conversionData) const</span>
<span class="line-added"> 572 {</span>
<span class="line-added"> 573     return LayoutUnit(computeLengthDouble(conversionData));</span>
<span class="line-added"> 574 }</span>
<span class="line-added"> 575 </span>
 576 double CSSPrimitiveValue::computeLengthDouble(const CSSToLengthConversionData&amp; conversionData) const
 577 {
<a name="63" id="anc63"></a><span class="line-modified"> 578     if (primitiveUnitType() == CSSUnitType::CSS_CALC) {</span>
 579         // The multiplier and factor is applied to each value in the calc expression individually
 580         return m_value.calc-&gt;computeLengthPx(conversionData);
<a name="64" id="anc64"></a><span class="line-added"> 581     }</span>
 582 
<a name="65" id="anc65"></a><span class="line-modified"> 583     return computeNonCalcLengthDouble(conversionData, primitiveType(), m_value.num);</span>
 584 }
 585 
<a name="66" id="anc66"></a><span class="line-modified"> 586 static constexpr double mmPerInch = 25.4;</span>
<span class="line-added"> 587 static constexpr double cmPerInch = 2.54;</span>
<span class="line-added"> 588 static constexpr double QPerInch = 25.4 * 4.0;</span>
<span class="line-added"> 589 </span>
<span class="line-added"> 590 double CSSPrimitiveValue::computeNonCalcLengthDouble(const CSSToLengthConversionData&amp; conversionData, CSSUnitType primitiveType, double value)</span>
 591 {
 592     double factor;
 593     bool applyZoom = true;
 594 
 595     switch (primitiveType) {
<a name="67" id="anc67"></a><span class="line-modified"> 596     case CSSUnitType::CSS_EMS:</span>
<span class="line-modified"> 597     case CSSUnitType::CSS_QUIRKY_EMS:</span>
 598         ASSERT(conversionData.style());
 599         factor = conversionData.computingFontSize() ? conversionData.style()-&gt;fontDescription().specifiedSize() : conversionData.style()-&gt;fontDescription().computedSize();
 600         break;
<a name="68" id="anc68"></a><span class="line-modified"> 601     case CSSUnitType::CSS_EXS:</span>
 602         ASSERT(conversionData.style());
 603         // FIXME: We have a bug right now where the zoom will be applied twice to EX units.
 604         // We really need to compute EX using fontMetrics for the original specifiedSize and not use
 605         // our actual constructed rendering font.
 606         if (conversionData.style()-&gt;fontMetrics().hasXHeight())
 607             factor = conversionData.style()-&gt;fontMetrics().xHeight();
 608         else
 609             factor = (conversionData.computingFontSize() ? conversionData.style()-&gt;fontDescription().specifiedSize() : conversionData.style()-&gt;fontDescription().computedSize()) / 2.0;
 610         break;
<a name="69" id="anc69"></a><span class="line-modified"> 611     case CSSUnitType::CSS_REMS:</span>
 612         if (conversionData.rootStyle())
 613             factor = conversionData.computingFontSize() ? conversionData.rootStyle()-&gt;fontDescription().specifiedSize() : conversionData.rootStyle()-&gt;fontDescription().computedSize();
 614         else
 615             factor = 1.0;
 616         break;
<a name="70" id="anc70"></a><span class="line-modified"> 617     case CSSUnitType::CSS_CHS:</span>
 618         ASSERT(conversionData.style());
 619         factor = conversionData.style()-&gt;fontMetrics().zeroWidth();
 620         break;
<a name="71" id="anc71"></a><span class="line-modified"> 621     case CSSUnitType::CSS_PX:</span>
 622         factor = 1.0;
 623         break;
<a name="72" id="anc72"></a><span class="line-modified"> 624     case CSSUnitType::CSS_CM:</span>
<span class="line-modified"> 625         factor = cssPixelsPerInch / cmPerInch;</span>
<span class="line-added"> 626         break;</span>
<span class="line-added"> 627     case CSSUnitType::CSS_MM:</span>
<span class="line-added"> 628         factor = cssPixelsPerInch / mmPerInch;</span>
 629         break;
<a name="73" id="anc73"></a><span class="line-modified"> 630     case CSSUnitType::CSS_Q:</span>
<span class="line-modified"> 631         factor = cssPixelsPerInch / QPerInch;</span>
 632         break;
<a name="74" id="anc74"></a><span class="line-modified"> 633     case CSSUnitType::CSS_IN:</span>
 634         factor = cssPixelsPerInch;
 635         break;
<a name="75" id="anc75"></a><span class="line-modified"> 636     case CSSUnitType::CSS_PT:</span>
 637         factor = cssPixelsPerInch / 72.0;
 638         break;
<a name="76" id="anc76"></a><span class="line-modified"> 639     case CSSUnitType::CSS_PC:</span>
 640         // 1 pc == 12 pt
 641         factor = cssPixelsPerInch * 12.0 / 72.0;
 642         break;
<a name="77" id="anc77"></a><span class="line-modified"> 643     case CSSUnitType::CSS_CALC_PERCENTAGE_WITH_LENGTH:</span>
<span class="line-modified"> 644     case CSSUnitType::CSS_CALC_PERCENTAGE_WITH_NUMBER:</span>
 645         ASSERT_NOT_REACHED();
 646         return -1.0;
<a name="78" id="anc78"></a><span class="line-modified"> 647     case CSSUnitType::CSS_VH:</span>
 648         factor = conversionData.viewportHeightFactor();
 649         applyZoom = false;
 650         break;
<a name="79" id="anc79"></a><span class="line-modified"> 651     case CSSUnitType::CSS_VW:</span>
 652         factor = conversionData.viewportWidthFactor();
 653         applyZoom = false;
 654         break;
<a name="80" id="anc80"></a><span class="line-modified"> 655     case CSSUnitType::CSS_VMAX:</span>
 656         factor = conversionData.viewportMaxFactor();
 657         applyZoom = false;
 658         break;
<a name="81" id="anc81"></a><span class="line-modified"> 659     case CSSUnitType::CSS_VMIN:</span>
 660         factor = conversionData.viewportMinFactor();
 661         applyZoom = false;
 662         break;
 663     default:
 664         ASSERT_NOT_REACHED();
 665         return -1.0;
 666     }
 667 
 668     // We do not apply the zoom factor when we are computing the value of the font-size property. The zooming
 669     // for font sizes is much more complicated, since we have to worry about enforcing the minimum font size preference
 670     // as well as enforcing the implicit &quot;smart minimum.&quot;
 671     double result = value * factor;
 672     if (conversionData.computingFontSize() || isFontRelativeLength(primitiveType))
 673         return result;
 674 
 675     if (applyZoom)
 676         result *= conversionData.zoom();
 677 
 678     return result;
 679 }
 680 
<a name="82" id="anc82"></a><span class="line-modified"> 681 bool CSSPrimitiveValue::equalForLengthResolution(const RenderStyle&amp; styleA, const RenderStyle&amp; styleB)</span>
<span class="line-added"> 682 {</span>
<span class="line-added"> 683     // These properties affect results of computeNonCalcLengthDouble above.</span>
<span class="line-added"> 684     if (styleA.fontDescription().computedSize() != styleB.fontDescription().computedSize())</span>
<span class="line-added"> 685         return false;</span>
<span class="line-added"> 686     if (styleA.fontDescription().specifiedSize() != styleB.fontDescription().specifiedSize())</span>
<span class="line-added"> 687         return false;</span>
<span class="line-added"> 688 </span>
<span class="line-added"> 689     if (styleA.fontMetrics().xHeight() != styleB.fontMetrics().xHeight())</span>
<span class="line-added"> 690         return false;</span>
<span class="line-added"> 691     if (styleA.fontMetrics().zeroWidth() != styleB.fontMetrics().zeroWidth())</span>
<span class="line-added"> 692         return false;</span>
<span class="line-added"> 693 </span>
<span class="line-added"> 694     if (styleA.zoom() != styleB.zoom())</span>
<span class="line-added"> 695         return false;</span>
<span class="line-added"> 696 </span>
<span class="line-added"> 697     return true;</span>
<span class="line-added"> 698 }</span>
<span class="line-added"> 699 </span>
<span class="line-added"> 700 ExceptionOr&lt;void&gt; CSSPrimitiveValue::setFloatValue(CSSUnitType, double)</span>
 701 {
 702     // Keeping values immutable makes optimizations easier and allows sharing of the primitive value objects.
 703     // No other engine supports mutating style through this API. Computed style is always read-only anyway.
 704     // Supporting setter would require making primitive value copy-on-write and taking care of style invalidation.
 705     return Exception { NoModificationAllowedError };
 706 }
 707 
<a name="83" id="anc83"></a><span class="line-modified"> 708 double CSSPrimitiveValue::conversionToCanonicalUnitsScaleFactor(CSSUnitType unitType)</span>
 709 {
 710     double factor = 1.0;
 711     // FIXME: the switch can be replaced by an array of scale factors.
 712     switch (unitType) {
 713     // These are &quot;canonical&quot; units in their respective categories.
<a name="84" id="anc84"></a><span class="line-modified"> 714     case CSSUnitType::CSS_PX:</span>
<span class="line-modified"> 715     case CSSUnitType::CSS_DEG:</span>
<span class="line-modified"> 716     case CSSUnitType::CSS_MS:</span>
<span class="line-modified"> 717     case CSSUnitType::CSS_HZ:</span>
<span class="line-added"> 718     case CSSUnitType::CSS_DPPX:</span>
<span class="line-added"> 719         break;</span>
<span class="line-added"> 720     case CSSUnitType::CSS_CM:</span>
<span class="line-added"> 721         factor = cssPixelsPerInch / cmPerInch;</span>
 722         break;
<a name="85" id="anc85"></a><span class="line-modified"> 723     case CSSUnitType::CSS_DPCM:</span>
<span class="line-modified"> 724         factor = cmPerInch / cssPixelsPerInch; // (2.54 cm/in)</span>
 725         break;
<a name="86" id="anc86"></a><span class="line-modified"> 726     case CSSUnitType::CSS_MM:</span>
<span class="line-modified"> 727         factor = cssPixelsPerInch / mmPerInch;</span>
 728         break;
<a name="87" id="anc87"></a><span class="line-modified"> 729     case CSSUnitType::CSS_Q:</span>
<span class="line-modified"> 730         factor = cssPixelsPerInch / QPerInch;</span>
 731         break;
<a name="88" id="anc88"></a><span class="line-modified"> 732     case CSSUnitType::CSS_IN:</span>
 733         factor = cssPixelsPerInch;
 734         break;
<a name="89" id="anc89"></a><span class="line-modified"> 735     case CSSUnitType::CSS_DPI:</span>
 736         factor = 1 / cssPixelsPerInch;
 737         break;
<a name="90" id="anc90"></a><span class="line-modified"> 738     case CSSUnitType::CSS_PT:</span>
 739         factor = cssPixelsPerInch / 72.0;
 740         break;
<a name="91" id="anc91"></a><span class="line-modified"> 741     case CSSUnitType::CSS_PC:</span>
 742         factor = cssPixelsPerInch * 12.0 / 72.0; // 1 pc == 12 pt
 743         break;
<a name="92" id="anc92"></a><span class="line-modified"> 744     case CSSUnitType::CSS_RAD:</span>
 745         factor = 180 / piDouble;
 746         break;
<a name="93" id="anc93"></a><span class="line-modified"> 747     case CSSUnitType::CSS_GRAD:</span>
 748         factor = 0.9;
 749         break;
<a name="94" id="anc94"></a><span class="line-modified"> 750     case CSSUnitType::CSS_TURN:</span>
 751         factor = 360;
 752         break;
<a name="95" id="anc95"></a><span class="line-modified"> 753     case CSSUnitType::CSS_S:</span>
<span class="line-modified"> 754     case CSSUnitType::CSS_KHZ:</span>
 755         factor = 1000;
 756         break;
 757     default:
 758         break;
 759     }
 760 
 761     return factor;
 762 }
 763 
<a name="96" id="anc96"></a><span class="line-modified"> 764 ExceptionOr&lt;float&gt; CSSPrimitiveValue::getFloatValue(CSSUnitType unitType) const</span>
 765 {
<a name="97" id="anc97"></a><span class="line-modified"> 766     auto result = doubleValueInternal(unitType);</span>
 767     if (!result)
 768         return Exception { InvalidAccessError };
 769     return clampTo&lt;float&gt;(result.value());
 770 }
 771 
<a name="98" id="anc98"></a><span class="line-modified"> 772 double CSSPrimitiveValue::doubleValue(CSSUnitType unitType) const</span>
 773 {
 774     return doubleValueInternal(unitType).valueOr(0);
 775 }
 776 
 777 double CSSPrimitiveValue::doubleValue() const
 778 {
<a name="99" id="anc99"></a><span class="line-modified"> 779     return primitiveUnitType() != CSSUnitType::CSS_CALC ? m_value.num : m_value.calc-&gt;doubleValue();</span>
 780 }
 781 
<a name="100" id="anc100"></a><span class="line-added"> 782 Optional&lt;bool&gt; CSSPrimitiveValue::isZero() const</span>
<span class="line-added"> 783 {</span>
<span class="line-added"> 784     if (primitiveUnitType() == CSSUnitType::CSS_CALC)</span>
<span class="line-added"> 785         return WTF::nullopt;</span>
<span class="line-added"> 786     return !m_value.num;</span>
<span class="line-added"> 787 }</span>
 788 
<a name="101" id="anc101"></a><span class="line-modified"> 789 Optional&lt;bool&gt; CSSPrimitiveValue::isPositive() const</span>
 790 {
<a name="102" id="anc102"></a><span class="line-modified"> 791     if (primitiveUnitType() == CSSUnitType::CSS_CALC)</span>
<span class="line-modified"> 792         return WTF::nullopt;</span>
<span class="line-modified"> 793     return m_value.num &gt; 0;</span>
<span class="line-modified"> 794 }</span>
<span class="line-modified"> 795 </span>
<span class="line-modified"> 796 Optional&lt;bool&gt; CSSPrimitiveValue::isNegative() const</span>
<span class="line-modified"> 797 {</span>
<span class="line-modified"> 798     if (primitiveUnitType() == CSSUnitType::CSS_CALC)</span>
<span class="line-modified"> 799         return WTF::nullopt;</span>
<span class="line-modified"> 800     return m_value.num &lt; 0;</span>












 801 }
 802 
<a name="103" id="anc103"></a><span class="line-modified"> 803 Optional&lt;double&gt; CSSPrimitiveValue::doubleValueInternal(CSSUnitType requestedUnitType) const</span>
 804 {
<a name="104" id="anc104"></a><span class="line-modified"> 805     if (!isValidCSSUnitTypeForDoubleConversion(primitiveUnitType()) || !isValidCSSUnitTypeForDoubleConversion(requestedUnitType))</span>
 806         return WTF::nullopt;
 807 
<a name="105" id="anc105"></a><span class="line-modified"> 808     CSSUnitType sourceUnitType = primitiveType();</span>
<span class="line-modified"> 809     if (requestedUnitType == sourceUnitType || requestedUnitType == CSSUnitType::CSS_DIMENSION)</span>
 810         return doubleValue();
 811 
<a name="106" id="anc106"></a><span class="line-modified"> 812     CSSUnitCategory sourceCategory = unitCategory(sourceUnitType);</span>
<span class="line-modified"> 813     ASSERT(sourceCategory != CSSUnitCategory::Other);</span>
 814 
<a name="107" id="anc107"></a><span class="line-modified"> 815     CSSUnitType targetUnitType = requestedUnitType;</span>
<span class="line-modified"> 816     CSSUnitCategory targetCategory = unitCategory(targetUnitType);</span>
<span class="line-modified"> 817     ASSERT(targetCategory != CSSUnitCategory::Other);</span>
 818 
<a name="108" id="anc108"></a><span class="line-modified"> 819     // Cannot convert between unrelated unit categories if one of them is not CSSUnitCategory::Number.</span>
<span class="line-modified"> 820     if (sourceCategory != targetCategory &amp;&amp; sourceCategory != CSSUnitCategory::Number &amp;&amp; targetCategory != CSSUnitCategory::Number)</span>
 821         return WTF::nullopt;
 822 
<a name="109" id="anc109"></a><span class="line-modified"> 823     if (targetCategory == CSSUnitCategory::Number) {</span>
<span class="line-modified"> 824         // We interpret conversion to CSSUnitType::CSS_NUMBER as conversion to a canonical unit in this value&#39;s category.</span>
 825         targetUnitType = canonicalUnitTypeForCategory(sourceCategory);
<a name="110" id="anc110"></a><span class="line-modified"> 826         if (targetUnitType == CSSUnitType::CSS_UNKNOWN)</span>
 827             return WTF::nullopt;
 828     }
 829 
<a name="111" id="anc111"></a><span class="line-modified"> 830     if (sourceUnitType == CSSUnitType::CSS_NUMBER) {</span>
<span class="line-modified"> 831         // We interpret conversion from CSSUnitType::CSS_NUMBER in the same way as CSSParser::validUnit() while using non-strict mode.</span>
 832         sourceUnitType = canonicalUnitTypeForCategory(targetCategory);
<a name="112" id="anc112"></a><span class="line-modified"> 833         if (sourceUnitType == CSSUnitType::CSS_UNKNOWN)</span>
 834             return WTF::nullopt;
 835     }
 836 
 837     double convertedValue = doubleValue();
 838 
<a name="113" id="anc113"></a><span class="line-modified"> 839     // First convert the value from primitiveUnitType() to canonical type.</span>
 840     double factor = conversionToCanonicalUnitsScaleFactor(sourceUnitType);
 841     convertedValue *= factor;
 842 
 843     // Now convert from canonical type to the target unitType.
 844     factor = conversionToCanonicalUnitsScaleFactor(targetUnitType);
 845     convertedValue /= factor;
 846 
 847     return convertedValue;
 848 }
 849 
<a name="114" id="anc114"></a><span class="line-modified"> 850 ExceptionOr&lt;void&gt; CSSPrimitiveValue::setStringValue(CSSUnitType, const String&amp;)</span>
 851 {
 852     // Keeping values immutable makes optimizations easier and allows sharing of the primitive value objects.
 853     // No other engine supports mutating style through this API. Computed style is always read-only anyway.
 854     // Supporting setter would require making primitive value copy-on-write and taking care of style invalidation.
 855     return Exception { NoModificationAllowedError };
 856 }
 857 
 858 ExceptionOr&lt;String&gt; CSSPrimitiveValue::getStringValue() const
 859 {
<a name="115" id="anc115"></a><span class="line-modified"> 860     switch (primitiveUnitType()) {</span>
<span class="line-modified"> 861     case CSSUnitType::CSS_STRING:</span>
<span class="line-modified"> 862     case CSSUnitType::CSS_ATTR:</span>
<span class="line-modified"> 863     case CSSUnitType::CSS_URI:</span>
 864         return m_value.string;
<a name="116" id="anc116"></a><span class="line-modified"> 865     case CSSUnitType::CSS_FONT_FAMILY:</span>
 866         return String { m_value.fontFamily-&gt;familyName };
<a name="117" id="anc117"></a><span class="line-modified"> 867     case CSSUnitType::CSS_VALUE_ID:</span>
 868         return String { valueName(m_value.valueID).string() };
<a name="118" id="anc118"></a><span class="line-modified"> 869     case CSSUnitType::CSS_PROPERTY_ID:</span>
 870         return String { propertyName(m_value.propertyID).string() };
 871     default:
 872         return Exception { InvalidAccessError };
 873     }
 874 }
 875 
 876 String CSSPrimitiveValue::stringValue() const
 877 {
<a name="119" id="anc119"></a><span class="line-modified"> 878     switch (primitiveUnitType()) {</span>
<span class="line-modified"> 879     case CSSUnitType::CSS_STRING:</span>
<span class="line-modified"> 880     case CSSUnitType::CSS_ATTR:</span>
<span class="line-modified"> 881     case CSSUnitType::CSS_URI:</span>
 882         return m_value.string;
<a name="120" id="anc120"></a><span class="line-modified"> 883     case CSSUnitType::CSS_FONT_FAMILY:</span>
 884         return m_value.fontFamily-&gt;familyName;
<a name="121" id="anc121"></a><span class="line-modified"> 885     case CSSUnitType::CSS_VALUE_ID:</span>
 886         return valueName(m_value.valueID);
<a name="122" id="anc122"></a><span class="line-modified"> 887     case CSSUnitType::CSS_PROPERTY_ID:</span>
 888         return propertyName(m_value.propertyID);
 889     default:
 890         return String();
 891     }
 892 }
 893 
<a name="123" id="anc123"></a><span class="line-modified"> 894 NEVER_INLINE String CSSPrimitiveValue::formatNumberValue(StringView suffix) const</span>














 895 {
<a name="124" id="anc124"></a><span class="line-modified"> 896     return makeString(m_value.num, suffix);</span>




 897 }
 898 
<a name="125" id="anc125"></a><span class="line-modified"> 899 String CSSPrimitiveValue::unitTypeString(CSSUnitType unitType)</span>
 900 {
<a name="126" id="anc126"></a><span class="line-modified"> 901     switch (unitType) {</span>
<span class="line-added"> 902         case CSSUnitType::CSS_PERCENTAGE: return &quot;%&quot;;</span>
<span class="line-added"> 903         case CSSUnitType::CSS_EMS: return &quot;em&quot;;</span>
<span class="line-added"> 904         case CSSUnitType::CSS_EXS: return &quot;ex&quot;;</span>
<span class="line-added"> 905         case CSSUnitType::CSS_PX: return &quot;px&quot;;</span>
<span class="line-added"> 906         case CSSUnitType::CSS_CM: return &quot;cm&quot;;</span>
<span class="line-added"> 907         case CSSUnitType::CSS_MM: return &quot;mm&quot;;</span>
<span class="line-added"> 908         case CSSUnitType::CSS_IN: return &quot;in&quot;;</span>
<span class="line-added"> 909         case CSSUnitType::CSS_PT: return &quot;pt&quot;;</span>
<span class="line-added"> 910         case CSSUnitType::CSS_PC: return &quot;pc&quot;;</span>
<span class="line-added"> 911         case CSSUnitType::CSS_DEG: return &quot;deg&quot;;</span>
<span class="line-added"> 912         case CSSUnitType::CSS_RAD: return &quot;rad&quot;;</span>
<span class="line-added"> 913         case CSSUnitType::CSS_GRAD: return &quot;grad&quot;;</span>
<span class="line-added"> 914         case CSSUnitType::CSS_MS: return &quot;ms&quot;;</span>
<span class="line-added"> 915         case CSSUnitType::CSS_S: return &quot;s&quot;;</span>
<span class="line-added"> 916         case CSSUnitType::CSS_HZ: return &quot;hz&quot;;</span>
<span class="line-added"> 917         case CSSUnitType::CSS_KHZ: return &quot;khz&quot;;</span>
<span class="line-added"> 918         case CSSUnitType::CSS_VW: return &quot;vw&quot;;</span>
<span class="line-added"> 919         case CSSUnitType::CSS_VH: return &quot;vh&quot;;</span>
<span class="line-added"> 920         case CSSUnitType::CSS_VMIN: return &quot;vmin&quot;;</span>
<span class="line-added"> 921         case CSSUnitType::CSS_VMAX: return &quot;vmax&quot;;</span>
<span class="line-added"> 922         case CSSUnitType::CSS_DPPX: return &quot;dppx&quot;;</span>
<span class="line-added"> 923         case CSSUnitType::CSS_DPI: return &quot;dpi&quot;;</span>
<span class="line-added"> 924         case CSSUnitType::CSS_DPCM: return &quot;dpcm&quot;;</span>
<span class="line-added"> 925         case CSSUnitType::CSS_FR: return &quot;fr&quot;;</span>
<span class="line-added"> 926         case CSSUnitType::CSS_Q: return &quot;q&quot;;</span>
<span class="line-added"> 927         case CSSUnitType::CSS_TURN: return &quot;turn&quot;;</span>
<span class="line-added"> 928         case CSSUnitType::CSS_REMS: return &quot;rem&quot;;</span>
<span class="line-added"> 929         case CSSUnitType::CSS_CHS: return &quot;ch&quot;;</span>
<span class="line-added"> 930 </span>
<span class="line-added"> 931         case CSSUnitType::CSS_UNKNOWN:</span>
<span class="line-added"> 932         case CSSUnitType::CSS_NUMBER:</span>
<span class="line-added"> 933         case CSSUnitType::CSS_DIMENSION:</span>
<span class="line-added"> 934         case CSSUnitType::CSS_STRING:</span>
<span class="line-added"> 935         case CSSUnitType::CSS_URI:</span>
<span class="line-added"> 936         case CSSUnitType::CSS_IDENT:</span>
<span class="line-added"> 937         case CSSUnitType::CSS_ATTR:</span>
<span class="line-added"> 938         case CSSUnitType::CSS_COUNTER:</span>
<span class="line-added"> 939         case CSSUnitType::CSS_RECT:</span>
<span class="line-added"> 940         case CSSUnitType::CSS_RGBCOLOR:</span>
<span class="line-added"> 941         case CSSUnitType::CSS_PAIR:</span>
<span class="line-added"> 942         case CSSUnitType::CSS_UNICODE_RANGE:</span>
<span class="line-added"> 943         case CSSUnitType::CSS_COUNTER_NAME:</span>
<span class="line-added"> 944         case CSSUnitType::CSS_SHAPE:</span>
<span class="line-added"> 945         case CSSUnitType::CSS_QUAD:</span>
<span class="line-added"> 946         case CSSUnitType::CSS_CALC:</span>
<span class="line-added"> 947         case CSSUnitType::CSS_CALC_PERCENTAGE_WITH_NUMBER:</span>
<span class="line-added"> 948         case CSSUnitType::CSS_CALC_PERCENTAGE_WITH_LENGTH:</span>
<span class="line-added"> 949         case CSSUnitType::CSS_FONT_FAMILY:</span>
<span class="line-added"> 950         case CSSUnitType::CSS_PROPERTY_ID:</span>
<span class="line-added"> 951         case CSSUnitType::CSS_VALUE_ID:</span>
<span class="line-added"> 952         case CSSUnitType::CSS_QUIRKY_EMS:</span>
<span class="line-added"> 953             return emptyString();</span>
<span class="line-added"> 954     }</span>
<span class="line-added"> 955     return emptyString();</span>
 956 }
 957 
 958 ALWAYS_INLINE String CSSPrimitiveValue::formatNumberForCustomCSSText() const
 959 {
<a name="127" id="anc127"></a><span class="line-modified"> 960     switch (primitiveUnitType()) {</span>
<span class="line-modified"> 961     case CSSUnitType::CSS_UNKNOWN:</span>
 962         return String();
<a name="128" id="anc128"></a><span class="line-modified"> 963     case CSSUnitType::CSS_NUMBER:</span>
 964         return formatNumberValue(&quot;&quot;);
<a name="129" id="anc129"></a><span class="line-modified"> 965     case CSSUnitType::CSS_PERCENTAGE:</span>
 966         return formatNumberValue(&quot;%&quot;);
<a name="130" id="anc130"></a><span class="line-modified"> 967     case CSSUnitType::CSS_EMS:</span>
<span class="line-modified"> 968     case CSSUnitType::CSS_QUIRKY_EMS:</span>
 969         return formatNumberValue(&quot;em&quot;);
<a name="131" id="anc131"></a><span class="line-modified"> 970     case CSSUnitType::CSS_EXS:</span>
 971         return formatNumberValue(&quot;ex&quot;);
<a name="132" id="anc132"></a><span class="line-modified"> 972     case CSSUnitType::CSS_REMS:</span>
 973         return formatNumberValue(&quot;rem&quot;);
<a name="133" id="anc133"></a><span class="line-modified"> 974     case CSSUnitType::CSS_CHS:</span>
 975         return formatNumberValue(&quot;ch&quot;);
<a name="134" id="anc134"></a><span class="line-modified"> 976     case CSSUnitType::CSS_PX:</span>
 977         return formatNumberValue(&quot;px&quot;);
<a name="135" id="anc135"></a><span class="line-modified"> 978     case CSSUnitType::CSS_CM:</span>
 979         return formatNumberValue(&quot;cm&quot;);
<a name="136" id="anc136"></a><span class="line-modified"> 980     case CSSUnitType::CSS_DPPX:</span>

 981         return formatNumberValue(&quot;dppx&quot;);
<a name="137" id="anc137"></a><span class="line-modified"> 982     case CSSUnitType::CSS_DPI:</span>
 983         return formatNumberValue(&quot;dpi&quot;);
<a name="138" id="anc138"></a><span class="line-modified"> 984     case CSSUnitType::CSS_DPCM:</span>
 985         return formatNumberValue(&quot;dpcm&quot;);
<a name="139" id="anc139"></a><span class="line-modified"> 986     case CSSUnitType::CSS_MM:</span>

 987         return formatNumberValue(&quot;mm&quot;);
<a name="140" id="anc140"></a><span class="line-modified"> 988     case CSSUnitType::CSS_IN:</span>
 989         return formatNumberValue(&quot;in&quot;);
<a name="141" id="anc141"></a><span class="line-modified"> 990     case CSSUnitType::CSS_PT:</span>
 991         return formatNumberValue(&quot;pt&quot;);
<a name="142" id="anc142"></a><span class="line-modified"> 992     case CSSUnitType::CSS_PC:</span>
 993         return formatNumberValue(&quot;pc&quot;);
<a name="143" id="anc143"></a><span class="line-modified"> 994     case CSSUnitType::CSS_DEG:</span>
 995         return formatNumberValue(&quot;deg&quot;);
<a name="144" id="anc144"></a><span class="line-modified"> 996     case CSSUnitType::CSS_RAD:</span>
 997         return formatNumberValue(&quot;rad&quot;);
<a name="145" id="anc145"></a><span class="line-modified"> 998     case CSSUnitType::CSS_GRAD:</span>
 999         return formatNumberValue(&quot;grad&quot;);
<a name="146" id="anc146"></a><span class="line-modified">1000     case CSSUnitType::CSS_MS:</span>
1001         return formatNumberValue(&quot;ms&quot;);
<a name="147" id="anc147"></a><span class="line-modified">1002     case CSSUnitType::CSS_S:</span>
1003         return formatNumberValue(&quot;s&quot;);
<a name="148" id="anc148"></a><span class="line-modified">1004     case CSSUnitType::CSS_HZ:</span>
1005         return formatNumberValue(&quot;hz&quot;);
<a name="149" id="anc149"></a><span class="line-modified">1006     case CSSUnitType::CSS_KHZ:</span>
1007         return formatNumberValue(&quot;khz&quot;);
<a name="150" id="anc150"></a><span class="line-modified">1008     case CSSUnitType::CSS_TURN:</span>
1009         return formatNumberValue(&quot;turn&quot;);
<a name="151" id="anc151"></a><span class="line-modified">1010     case CSSUnitType::CSS_FR:</span>
1011         return formatNumberValue(&quot;fr&quot;);
<a name="152" id="anc152"></a><span class="line-modified">1012     case CSSUnitType::CSS_Q:</span>
<span class="line-modified">1013         return formatNumberValue(&quot;q&quot;);</span>
<span class="line-added">1014     case CSSUnitType::CSS_DIMENSION:</span>
<span class="line-added">1015         // FIXME: We currently don&#39;t handle CSSUnitType::CSS_DIMENSION properly as we don&#39;t store</span>
1016         // the actual dimension, just the numeric value as a string.
<a name="153" id="anc153"></a><span class="line-modified">1017     case CSSUnitType::CSS_STRING:</span>
1018         // FIME-NEWPARSER: Once we have CSSCustomIdentValue hooked up, this can just be
1019         // serializeString, since custom identifiers won&#39;t be the same value as strings
1020         // any longer.
1021         return serializeAsStringOrCustomIdent(m_value.string);
<a name="154" id="anc154"></a><span class="line-modified">1022     case CSSUnitType::CSS_FONT_FAMILY:</span>
1023         return serializeFontFamily(m_value.fontFamily-&gt;familyName);
<a name="155" id="anc155"></a><span class="line-modified">1024     case CSSUnitType::CSS_URI:</span>
1025         return serializeURL(m_value.string);
<a name="156" id="anc156"></a><span class="line-modified">1026     case CSSUnitType::CSS_VALUE_ID:</span>
1027         return valueName(m_value.valueID);
<a name="157" id="anc157"></a><span class="line-modified">1028     case CSSUnitType::CSS_PROPERTY_ID:</span>
1029         return propertyName(m_value.propertyID);
<a name="158" id="anc158"></a><span class="line-modified">1030     case CSSUnitType::CSS_ATTR:</span>
1031         return &quot;attr(&quot; + String(m_value.string) + &#39;)&#39;;
<a name="159" id="anc159"></a><span class="line-modified">1032     case CSSUnitType::CSS_COUNTER_NAME:</span>
1033         return &quot;counter(&quot; + String(m_value.string) + &#39;)&#39;;
<a name="160" id="anc160"></a><span class="line-modified">1034     case CSSUnitType::CSS_COUNTER: {</span>
1035         StringBuilder result;
1036         String separator = m_value.counter-&gt;separator();
1037         if (separator.isEmpty())
1038             result.appendLiteral(&quot;counter(&quot;);
1039         else
1040             result.appendLiteral(&quot;counters(&quot;);
1041 
1042         result.append(m_value.counter-&gt;identifier());
1043         if (!separator.isEmpty()) {
1044             result.appendLiteral(&quot;, &quot;);
1045             serializeString(separator, result);
1046         }
1047         String listStyle = m_value.counter-&gt;listStyle();
1048         if (!listStyle.isEmpty())
1049             result.append(&quot;, &quot;, listStyle);
1050         result.append(&#39;)&#39;);
1051 
1052         return result.toString();
1053     }
<a name="161" id="anc161"></a><span class="line-modified">1054     case CSSUnitType::CSS_RECT:</span>
1055         return rectValue()-&gt;cssText();
<a name="162" id="anc162"></a><span class="line-modified">1056     case CSSUnitType::CSS_QUAD:</span>
1057         return quadValue()-&gt;cssText();
<a name="163" id="anc163"></a><span class="line-modified">1058     case CSSUnitType::CSS_RGBCOLOR:</span>
1059         return color().cssText();
<a name="164" id="anc164"></a><span class="line-modified">1060     case CSSUnitType::CSS_PAIR:</span>
1061         return pairValue()-&gt;cssText();
<a name="165" id="anc165"></a><span class="line-modified">1062     case CSSUnitType::CSS_CALC:</span>
1063         return m_value.calc-&gt;cssText();
<a name="166" id="anc166"></a><span class="line-modified">1064     case CSSUnitType::CSS_SHAPE:</span>
1065         return m_value.shape-&gt;cssText();
<a name="167" id="anc167"></a><span class="line-modified">1066     case CSSUnitType::CSS_VW:</span>
1067         return formatNumberValue(&quot;vw&quot;);
<a name="168" id="anc168"></a><span class="line-modified">1068     case CSSUnitType::CSS_VH:</span>
1069         return formatNumberValue(&quot;vh&quot;);
<a name="169" id="anc169"></a><span class="line-modified">1070     case CSSUnitType::CSS_VMIN:</span>
1071         return formatNumberValue(&quot;vmin&quot;);
<a name="170" id="anc170"></a><span class="line-modified">1072     case CSSUnitType::CSS_VMAX:</span>
1073         return formatNumberValue(&quot;vmax&quot;);
<a name="171" id="anc171"></a><span class="line-added">1074     case CSSUnitType::CSS_IDENT:</span>
<span class="line-added">1075     case CSSUnitType::CSS_UNICODE_RANGE:</span>
<span class="line-added">1076     case CSSUnitType::CSS_CALC_PERCENTAGE_WITH_NUMBER:</span>
<span class="line-added">1077     case CSSUnitType::CSS_CALC_PERCENTAGE_WITH_LENGTH:</span>
<span class="line-added">1078         ASSERT_NOT_REACHED();</span>
1079     }
1080     return String();
1081 }
1082 
1083 String CSSPrimitiveValue::customCSSText() const
1084 {
1085     // FIXME: return the original value instead of a generated one (e.g. color
1086     // name if it was specified) - check what spec says about this
1087 
1088     CSSTextCache&amp; cssTextCache = WebCore::cssTextCache();
1089 
1090     if (m_hasCachedCSSText) {
1091         ASSERT(cssTextCache.contains(this));
1092         return cssTextCache.get(this);
1093     }
1094 
1095     String text = formatNumberForCustomCSSText();
1096 
1097     ASSERT(!cssTextCache.contains(this));
1098     m_hasCachedCSSText = true;
1099     cssTextCache.set(this, text);
1100     return text;
1101 }
1102 
1103 bool CSSPrimitiveValue::equals(const CSSPrimitiveValue&amp; other) const
1104 {
<a name="172" id="anc172"></a><span class="line-modified">1105     if (primitiveUnitType() != other.primitiveUnitType())</span>
1106         return false;
1107 
<a name="173" id="anc173"></a><span class="line-modified">1108     switch (primitiveUnitType()) {</span>
<span class="line-modified">1109     case CSSUnitType::CSS_UNKNOWN:</span>
1110         return false;
<a name="174" id="anc174"></a><span class="line-modified">1111     case CSSUnitType::CSS_NUMBER:</span>
<span class="line-modified">1112     case CSSUnitType::CSS_PERCENTAGE:</span>
<span class="line-modified">1113     case CSSUnitType::CSS_EMS:</span>
<span class="line-modified">1114     case CSSUnitType::CSS_QUIRKY_EMS:</span>
<span class="line-modified">1115     case CSSUnitType::CSS_EXS:</span>
<span class="line-modified">1116     case CSSUnitType::CSS_REMS:</span>
<span class="line-modified">1117     case CSSUnitType::CSS_CHS:</span>
<span class="line-modified">1118     case CSSUnitType::CSS_PX:</span>
<span class="line-modified">1119     case CSSUnitType::CSS_CM:</span>
<span class="line-modified">1120     case CSSUnitType::CSS_DPPX:</span>
<span class="line-modified">1121     case CSSUnitType::CSS_DPI:</span>
<span class="line-modified">1122     case CSSUnitType::CSS_DPCM:</span>
<span class="line-modified">1123     case CSSUnitType::CSS_MM:</span>
<span class="line-modified">1124     case CSSUnitType::CSS_IN:</span>
<span class="line-modified">1125     case CSSUnitType::CSS_PT:</span>
<span class="line-modified">1126     case CSSUnitType::CSS_PC:</span>
<span class="line-modified">1127     case CSSUnitType::CSS_DEG:</span>
<span class="line-modified">1128     case CSSUnitType::CSS_RAD:</span>
<span class="line-modified">1129     case CSSUnitType::CSS_GRAD:</span>
<span class="line-modified">1130     case CSSUnitType::CSS_MS:</span>
<span class="line-modified">1131     case CSSUnitType::CSS_S:</span>
<span class="line-modified">1132     case CSSUnitType::CSS_HZ:</span>
<span class="line-modified">1133     case CSSUnitType::CSS_KHZ:</span>
<span class="line-modified">1134     case CSSUnitType::CSS_TURN:</span>
<span class="line-modified">1135     case CSSUnitType::CSS_VW:</span>
<span class="line-modified">1136     case CSSUnitType::CSS_VH:</span>
<span class="line-modified">1137     case CSSUnitType::CSS_VMIN:</span>
<span class="line-modified">1138     case CSSUnitType::CSS_VMAX:</span>
<span class="line-modified">1139     case CSSUnitType::CSS_FR:</span>
<span class="line-added">1140     case CSSUnitType::CSS_Q:</span>
1141         return m_value.num == other.m_value.num;
<a name="175" id="anc175"></a><span class="line-modified">1142     case CSSUnitType::CSS_PROPERTY_ID:</span>
1143         return propertyName(m_value.propertyID) == propertyName(other.m_value.propertyID);
<a name="176" id="anc176"></a><span class="line-modified">1144     case CSSUnitType::CSS_VALUE_ID:</span>
1145         return valueName(m_value.valueID) == valueName(other.m_value.valueID);
<a name="177" id="anc177"></a><span class="line-modified">1146     case CSSUnitType::CSS_DIMENSION:</span>
<span class="line-modified">1147     case CSSUnitType::CSS_STRING:</span>
<span class="line-modified">1148     case CSSUnitType::CSS_URI:</span>
<span class="line-modified">1149     case CSSUnitType::CSS_ATTR:</span>
<span class="line-modified">1150     case CSSUnitType::CSS_COUNTER_NAME:</span>
1151         return equal(m_value.string, other.m_value.string);
<a name="178" id="anc178"></a><span class="line-modified">1152     case CSSUnitType::CSS_COUNTER:</span>
1153         return m_value.counter &amp;&amp; other.m_value.counter &amp;&amp; m_value.counter-&gt;equals(*other.m_value.counter);
<a name="179" id="anc179"></a><span class="line-modified">1154     case CSSUnitType::CSS_RECT:</span>
1155         return m_value.rect &amp;&amp; other.m_value.rect &amp;&amp; m_value.rect-&gt;equals(*other.m_value.rect);
<a name="180" id="anc180"></a><span class="line-modified">1156     case CSSUnitType::CSS_QUAD:</span>
1157         return m_value.quad &amp;&amp; other.m_value.quad &amp;&amp; m_value.quad-&gt;equals(*other.m_value.quad);
<a name="181" id="anc181"></a><span class="line-modified">1158     case CSSUnitType::CSS_RGBCOLOR:</span>
1159         return color() == other.color();
<a name="182" id="anc182"></a><span class="line-modified">1160     case CSSUnitType::CSS_PAIR:</span>
1161         return m_value.pair &amp;&amp; other.m_value.pair &amp;&amp; m_value.pair-&gt;equals(*other.m_value.pair);
<a name="183" id="anc183"></a><span class="line-modified">1162     case CSSUnitType::CSS_CALC:</span>
1163         return m_value.calc &amp;&amp; other.m_value.calc &amp;&amp; m_value.calc-&gt;equals(*other.m_value.calc);
<a name="184" id="anc184"></a><span class="line-modified">1164     case CSSUnitType::CSS_SHAPE:</span>
1165         return m_value.shape &amp;&amp; other.m_value.shape &amp;&amp; m_value.shape-&gt;equals(*other.m_value.shape);
<a name="185" id="anc185"></a><span class="line-modified">1166     case CSSUnitType::CSS_FONT_FAMILY:</span>
1167         return fontFamily() == other.fontFamily();
<a name="186" id="anc186"></a><span class="line-added">1168     case CSSUnitType::CSS_IDENT:</span>
<span class="line-added">1169     case CSSUnitType::CSS_UNICODE_RANGE:</span>
<span class="line-added">1170     case CSSUnitType::CSS_CALC_PERCENTAGE_WITH_NUMBER:</span>
<span class="line-added">1171     case CSSUnitType::CSS_CALC_PERCENTAGE_WITH_LENGTH:</span>
<span class="line-added">1172         // FIXME: seems like these should be handled.</span>
<span class="line-added">1173         ASSERT_NOT_REACHED();</span>
<span class="line-added">1174         break;</span>
1175     }
1176     return false;
1177 }
1178 
1179 Ref&lt;DeprecatedCSSOMPrimitiveValue&gt; CSSPrimitiveValue::createDeprecatedCSSOMPrimitiveWrapper(CSSStyleDeclaration&amp; styleDeclaration) const
1180 {
1181     return DeprecatedCSSOMPrimitiveValue::create(*this, styleDeclaration);
1182 }
1183 
1184 // https://drafts.css-houdini.org/css-properties-values-api/#dependency-cycles-via-relative-units
1185 void CSSPrimitiveValue::collectDirectComputationalDependencies(HashSet&lt;CSSPropertyID&gt;&amp; values) const
1186 {
<a name="187" id="anc187"></a><span class="line-modified">1187     switch (primitiveUnitType()) {</span>
<span class="line-modified">1188     case CSSUnitType::CSS_EMS:</span>
<span class="line-modified">1189     case CSSUnitType::CSS_QUIRKY_EMS:</span>
<span class="line-modified">1190     case CSSUnitType::CSS_EXS:</span>
<span class="line-modified">1191     case CSSUnitType::CSS_CHS:</span>
1192         values.add(CSSPropertyFontSize);
1193         break;
<a name="188" id="anc188"></a><span class="line-modified">1194     case CSSUnitType::CSS_CALC:</span>
1195         m_value.calc-&gt;collectDirectComputationalDependencies(values);
1196         break;
<a name="189" id="anc189"></a><span class="line-added">1197     default:</span>
<span class="line-added">1198         break;</span>
1199     }
1200 }
1201 
1202 void CSSPrimitiveValue::collectDirectRootComputationalDependencies(HashSet&lt;CSSPropertyID&gt;&amp; values) const
1203 {
<a name="190" id="anc190"></a><span class="line-modified">1204     switch (primitiveUnitType()) {</span>
<span class="line-modified">1205     case CSSUnitType::CSS_REMS:</span>
1206         values.add(CSSPropertyFontSize);
1207         break;
<a name="191" id="anc191"></a><span class="line-modified">1208     case CSSUnitType::CSS_CALC:</span>
1209         m_value.calc-&gt;collectDirectRootComputationalDependencies(values);
1210         break;
<a name="192" id="anc192"></a><span class="line-added">1211     default:</span>
<span class="line-added">1212         break;</span>
1213     }
1214 }
1215 
1216 } // namespace WebCore
<a name="193" id="anc193"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="193" type="hidden" />
</body>
</html>