<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/WebCore/bridge/jni/jsc/JNIUtilityPrivate.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (C) 2003, 2010 Apple, Inc.  All rights reserved.
  3  * Copyright 2009, The Android Open Source Project
  4  *
  5  * Redistribution and use in source and binary forms, with or without
  6  * modification, are permitted provided that the following conditions
  7  * are met:
  8  *  * Redistributions of source code must retain the above copyright
  9  *    notice, this list of conditions and the following disclaimer.
 10  *  * Redistributions in binary form must reproduce the above copyright
 11  *    notice, this list of conditions and the following disclaimer in the
 12  *    documentation and/or other materials provided with the distribution.
 13  *
 14  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS ``AS IS&#39;&#39; AND ANY
 15  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 16  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 17  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT OWNER OR
 18  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 19  * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 20  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 21  * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 22  * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 23  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 24  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 25  */
 26 
 27 #include &quot;config.h&quot;
 28 #include &quot;JNIUtilityPrivate.h&quot;
 29 
 30 #if ENABLE(JAVA_BRIDGE)
 31 
 32 #include &quot;jni_jsobject.h&quot;
 33 #include &quot;runtime_array.h&quot;
 34 #include &quot;runtime_object.h&quot;
 35 #include &quot;runtime_root.h&quot;
 36 #include &lt;JavaScriptCore/JSArray.h&gt;
 37 #include &lt;JavaScriptCore/JSLock.h&gt;
 38 
 39 #include &quot;JavaArrayJSC.h&quot;
 40 #include &quot;JavaInstanceJSC.h&quot;
 41 #include &quot;JavaRuntimeObject.h&quot;
 42 
 43 #include &quot;JSNode.h&quot;
 44 #include &quot;Node.h&quot;
 45 
 46 #include &quot;com_sun_webkit_dom_JSObject.h&quot;
 47 #define JSOBJECT_CLASSNAME &quot;com/sun/webkit/dom/JSObject&quot;
 48 
 49 namespace JSC {
 50 
 51 namespace Bindings {
 52 
<a name="1" id="anc1"></a><span class="line-modified"> 53 static jchar toJCharValue(const JSValue&amp; value, ExecState* exec)</span>
 54 {
 55     // If JS type is string and target Java type is char, then
 56     // return the first unicode character.
 57     if (value.isString()) {
<a name="2" id="anc2"></a><span class="line-modified"> 58         String stringValue = value.toString(exec)-&gt;value(exec);</span>
 59         return (jchar)stringValue[0];
 60     }
<a name="3" id="anc3"></a><span class="line-modified"> 61     return (jchar)value.toNumber(exec);</span>
 62 }
 63 
 64 jobject convertUndefinedToJObject()
 65 {
 66     static JGObject jgoUndefined;
 67     if (!jgoUndefined) {
 68         JNIEnv* env = getJNIEnv();
 69         jclass clazz = env-&gt;FindClass(JSOBJECT_CLASSNAME);
 70         jgoUndefined = JLObject(env-&gt;GetStaticObjectField(
 71             clazz,
 72             env-&gt;GetStaticFieldID(clazz, &quot;UNDEFINED&quot;, &quot;Ljava/lang/String;&quot;)));
 73     }
 74     return jgoUndefined;
 75 }
 76 
<a name="4" id="anc4"></a><span class="line-modified"> 77 jvalue convertValueToJValue(ExecState* exec, RootObject* rootObject, JSValue value, JavaType javaType, const char* javaClassName)</span>
 78 {
<a name="5" id="anc5"></a><span class="line-modified"> 79     JSLockHolder lock(exec);</span>
 80 
<a name="6" id="anc6"></a><span class="line-modified"> 81     VM&amp; vm = exec-&gt;vm();</span>
 82 
 83     jvalue result;
 84     memset(&amp;result, 0, sizeof(jvalue));
 85 
 86     switch (javaType) {
 87     case JavaTypeArray:
 88     case JavaTypeObject:
 89         {
 90             // FIXME: JavaJSObject::convertValueToJObject functionality is almost exactly the same,
 91             // these functions should use common code.
 92 
 93             if (value.isObject()) {
 94                 JSObject* object = asObject(value);
 95                 if (object-&gt;inherits(vm, JavaRuntimeObject::info())) {
 96                     // Unwrap a Java instance.
 97                     JavaRuntimeObject* runtimeObject = static_cast&lt;JavaRuntimeObject*&gt;(object);
 98                     JavaInstance* instance = runtimeObject-&gt;getInternalJavaInstance();
 99                     if (instance) {
100                         // Since instance-&gt;javaInstance() is WeakGlobalRef, creating a localref to safeguard javaInstance() from GC
101                         JLObject jlinstance(instance-&gt;javaInstance(), true);
102                         if (!jlinstance) {
103                             LOG_ERROR(&quot;Could not get javaInstance for %p in JNIUtilityPrivate::convertValueToJValue&quot;, (jobject)jlinstance);
104                             return result;
105                         }
106                         result.l = instance-&gt;javaInstance();
107                     }
108                 } else if (object-&gt;classInfo(vm) == RuntimeArray::info()) {
109                     // Input is a JavaScript Array that was originally created from a Java Array
110                     RuntimeArray* imp = static_cast&lt;RuntimeArray*&gt;(object);
111                     JavaArray* array = static_cast&lt;JavaArray*&gt;(imp-&gt;getConcreteArray());
112 
113                     // Since array-&gt;javaArray() is WeakGlobalRef, creating a localref to safeguard javaInstance() from GC
114                     JLObject jlinstancearray(array-&gt;javaArray(), true);
115                     if (!jlinstancearray) {
116                         LOG_ERROR(&quot;Could not get javaArrayInstance for %p in JNIUtilityPrivate::convertValueToJValue&quot;, (jobject)jlinstancearray);
117                         return result;
118                     }
119                     result.l = array-&gt;javaArray();
120                 } else if ((!result.l &amp;&amp; (!strcmp(javaClassName, &quot;java.lang.Object&quot;)))
121                            || (!strcmp(javaClassName, &quot;netscape.javascript.JSObject&quot;))) {
122                     // Wrap objects in JSObject instances.
123                     JNIEnv* env = getJNIEnv();
124                     if (object-&gt;inherits(vm, WebCore::JSNode::info())) {
125                         WebCore::JSNode* jsnode = static_cast&lt;WebCore::JSNode*&gt;(object);
126                         static JGClass nodeImplClass = env-&gt;FindClass(&quot;com/sun/webkit/dom/NodeImpl&quot;);
127                         static jmethodID getImplID = env-&gt;GetStaticMethodID(nodeImplClass, &quot;getCachedImpl&quot;,
128                                                                      &quot;(J)Lorg/w3c/dom/Node;&quot;);
129                         WebCore::Node *peer = &amp;jsnode-&gt;wrapped();
130                         peer-&gt;ref(); //deref is in NodeImpl disposer
131                         result.l = env-&gt;CallStaticObjectMethod(
132                             nodeImplClass,
133                             getImplID,
134                             ptr_to_jlong(peer));
135                     } else {
136                         static JGClass jsObjectClass = env-&gt;FindClass(JSOBJECT_CLASSNAME);
137                         static jmethodID constructorID = env-&gt;GetMethodID(jsObjectClass, &quot;&lt;init&gt;&quot;, &quot;(JI)V&quot;);
138                         if (constructorID) {
139                             rootObject-&gt;gcProtect(object);
140                             jlong nativeHandle = ptr_to_jlong(object);
141                             result.l = env-&gt;NewObject(jsObjectClass, constructorID,
142                                 nativeHandle,
143                                 com_sun_webkit_dom_JSObject_JS_CONTEXT_OBJECT);
144                         }
145                     }
146                 }
147             }
148 
149             // Create an appropriate Java object if target type is java.lang.Object or other wrapper Objects {Integer, Double, Boolean}.
150             if (!result.l) {
151                 if (value.isString() &amp;&amp; !strcmp(javaClassName, &quot;java.lang.Object&quot;)) {
<a name="7" id="anc7"></a><span class="line-modified">152                     String stringValue = asString(value)-&gt;value(exec);</span>
153                     JNIEnv* env = getJNIEnv();
154                     jobject javaString = stringValue.toJavaString(env).releaseLocal();
155                     result.l = javaString;
156                 } else if (value.isString() &amp;&amp; !strcmp(javaClassName, &quot;java.lang.Character&quot;)) {
157                     JNIEnv* env = getJNIEnv();
158                     static JGClass clazz(env-&gt;FindClass(&quot;java/lang/Character&quot;));
159                     jmethodID meth = env-&gt;GetStaticMethodID(clazz, &quot;valueOf&quot;, &quot;(C)Ljava/lang/Character;&quot;);
<a name="8" id="anc8"></a><span class="line-modified">160                     jchar charValue = toJCharValue(value, exec);</span>
161                     jobject javaChar = env-&gt;CallStaticObjectMethod(clazz, meth, charValue);
162                     result.l = javaChar;
163                 } else if (value.isNumber()) {
164                     JNIEnv* env = getJNIEnv();
165                     if (value.isInt32() &amp;&amp; (!strcmp(javaClassName, &quot;java.lang.Number&quot;) || !strcmp(javaClassName, &quot;java.lang.Integer&quot;) || !strcmp(javaClassName, &quot;java.lang.Object&quot;))) {
166                         static JGClass clazz(env-&gt;FindClass(&quot;java/lang/Integer&quot;));
167                         jmethodID meth = env-&gt;GetStaticMethodID(clazz, &quot;valueOf&quot;, &quot;(I)Ljava/lang/Integer;&quot;);
168                         result.l = env-&gt;CallStaticObjectMethod(clazz, meth, (jint) value.asInt32());
169                     } else if (!strcmp(javaClassName, &quot;java.lang.Number&quot;) || !strcmp(javaClassName, &quot;java.lang.Double&quot;) || !strcmp(javaClassName, &quot;java.lang.Object&quot;)) {
170                         jdouble doubleValue = (jdouble) value.asNumber();
171                         static JGClass clazz = env-&gt;FindClass(&quot;java/lang/Double&quot;);
172                         jmethodID meth = env-&gt;GetStaticMethodID(clazz, &quot;valueOf&quot;, &quot;(D)Ljava/lang/Double;&quot;);
173                         jobject javaDouble = env-&gt;CallStaticObjectMethod(clazz, meth, doubleValue);
174                         result.l = javaDouble;
175                     }
176                 } else if (value.isBoolean() &amp;&amp; (!strcmp(javaClassName, &quot;java.lang.Boolean&quot;) || !strcmp(javaClassName, &quot;java.lang.Object&quot;))) {
177                     bool boolValue = value.asBoolean();
178                     JNIEnv* env = getJNIEnv();
179                     static JGClass clazz(env-&gt;FindClass(&quot;java/lang/Boolean&quot;));
180                     jmethodID meth = env-&gt;GetStaticMethodID(clazz, &quot;valueOf&quot;, &quot;(Z)Ljava/lang/Boolean;&quot;);
181                     jobject javaBoolean = env-&gt;CallStaticObjectMethod(clazz, meth, boolValue);
182                     result.l = javaBoolean;
183                 } else if (value.isUndefined()) {
184                     result.l = convertUndefinedToJObject();
185                 }
186             }
187 
188             // Convert value to a string if the target type is a java.lang.String, and we&#39;re not
189             // converting from a null.
190             if (!result.l &amp;&amp; !strcmp(javaClassName, &quot;java.lang.String&quot;)) {
191                 if (!value.isNull()) {
<a name="9" id="anc9"></a><span class="line-modified">192                     String stringValue = value.toString(exec)-&gt;value(exec);</span>
193                     JNIEnv* env = getJNIEnv();
194                     jobject javaString = stringValue.toJavaString(env).releaseLocal();
195                     result.l = javaString;
196                 }
197             }
198         }
199         break;
200 
201     case JavaTypeBoolean:
202         {
<a name="10" id="anc10"></a><span class="line-modified">203             result.z = (jboolean)value.toNumber(exec);</span>
204         }
205         break;
206 
207     case JavaTypeByte:
208         {
<a name="11" id="anc11"></a><span class="line-modified">209             result.b = (jbyte)value.toNumber(exec);</span>
210         }
211         break;
212 
213     case JavaTypeChar:
214         {
<a name="12" id="anc12"></a><span class="line-modified">215             result.c = toJCharValue(value, exec);</span>
216         }
217         break;
218 
219     case JavaTypeShort:
220         {
<a name="13" id="anc13"></a><span class="line-modified">221             result.s = (jshort)value.toNumber(exec);</span>
222         }
223         break;
224 
225     case JavaTypeInt:
226         {
<a name="14" id="anc14"></a><span class="line-modified">227             result.i = (jint)value.toNumber(exec);</span>
228         }
229         break;
230 
231     case JavaTypeLong:
232         {
<a name="15" id="anc15"></a><span class="line-modified">233             result.j = (jlong)value.toNumber(exec);</span>
234         }
235         break;
236 
237     case JavaTypeFloat:
238         {
<a name="16" id="anc16"></a><span class="line-modified">239             result.f = (jfloat)value.toNumber(exec);</span>
240         }
241         break;
242 
243     case JavaTypeDouble:
244         {
<a name="17" id="anc17"></a><span class="line-modified">245             result.d = (jdouble)value.toNumber(exec);</span>
246         }
247         break;
248 
249     case JavaTypeInvalid:
250     case JavaTypeVoid:
251         break;
252     }
253     return result;
254 }
255 
256 jobject jvalueToJObject(jvalue value, JavaType jtype) {
257     JNIEnv* env = getJNIEnv();
258     jmethodID meth;
259     switch (jtype) {
260     case JavaTypeObject:
261     case JavaTypeArray:
262         return value.l;
263     case JavaTypeBoolean: {
264       static JGClass clsZ(env-&gt;FindClass(&quot;java/lang/Boolean&quot;));
265       meth = env-&gt;GetStaticMethodID(clsZ, &quot;valueOf&quot;, &quot;(Z)Ljava/lang/Boolean;&quot;);
266       return env-&gt;CallStaticObjectMethod(clsZ, meth, value.z);
267     }
268     case JavaTypeChar: {
269       static JGClass clsC(env-&gt;FindClass(&quot;java/lang/Character&quot;));
270       meth = env-&gt;GetStaticMethodID(clsC, &quot;valueOf&quot;,
271                                     &quot;(C)Ljava/lang/Character;&quot;);
272       return env-&gt;CallStaticObjectMethod(clsC, meth, value.c);
273     }
274     case JavaTypeByte: {
275       static JGClass clsB(env-&gt;FindClass(&quot;java/lang/Byte&quot;));
276       meth = env-&gt;GetStaticMethodID(clsB, &quot;valueOf&quot;, &quot;(B)Ljava/lang/Byte;&quot;);
277       return env-&gt;CallStaticObjectMethod(clsB, meth, value.b);
278     }
279     case JavaTypeShort: {
280       static JGClass clsS(env-&gt;FindClass(&quot;java/lang/Short&quot;));
281       meth = env-&gt;GetStaticMethodID(clsS, &quot;valueOf&quot;, &quot;(S)Ljava/lang/Short;&quot;);
282       return env-&gt;CallStaticObjectMethod(clsS, meth, value.s);
283     }
284     case JavaTypeInt: {
285       static JGClass clsI(env-&gt;FindClass(&quot;java/lang/Integer&quot;));
286       meth = env-&gt;GetStaticMethodID(clsI, &quot;valueOf&quot;, &quot;(I)Ljava/lang/Integer;&quot;);
287       return env-&gt;CallStaticObjectMethod(clsI, meth, value.i);
288     }
289     case JavaTypeLong: {
290       static JGClass clsJ(env-&gt;FindClass(&quot;java/lang/Long&quot;));
291       meth = env-&gt;GetStaticMethodID(clsJ, &quot;valueOf&quot;, &quot;(J)Ljava/lang/Long;&quot;);
292       return env-&gt;CallStaticObjectMethod(clsJ, meth, value.j);
293     }
294     case JavaTypeFloat: {
295       static JGClass clsF(env-&gt;FindClass(&quot;java/lang/Float&quot;));
296       meth = env-&gt;GetStaticMethodID(clsF, &quot;valueOf&quot;, &quot;(F)Ljava/lang/Float;&quot;);
297       return env-&gt;CallStaticObjectMethod(clsF, meth, value.f);
298     }
299     case JavaTypeDouble: {
300       static JGClass clsD(env-&gt;FindClass(&quot;java/lang/Double&quot;));
301       meth = env-&gt;GetStaticMethodID(clsD, &quot;valueOf&quot;, &quot;(D)Ljava/lang/Double;&quot;);
302       return env-&gt;CallStaticObjectMethod(clsD, meth, value.d);
303     }
304     default:
305         abort();
306     }
307 }
308 
309 jthrowable dispatchJNICall(int count, RootObject*, jobject obj, bool isStatic, JavaType returnType, jmethodID methodId, jobject* args, jvalue&amp; result, jobject accessControlContext) {
310 
311     // Since obj is WeakGlobalRef, creating a localref to safeguard instance() from GC
312     JLObject jlinstance(obj, true);
313 
314     if (!jlinstance) {
315         LOG_ERROR(&quot;Could not get javaInstance for %p in JNIUtilityPrivate::dispatchJNICall&quot;, (jobject)jlinstance);
316         return NULL;
317     }
318 
319     JNIEnv* env = getJNIEnv();
320     jclass objClass = env-&gt;GetObjectClass(obj);
321     jobject rmethod = env-&gt;ToReflectedMethod(objClass, methodId, isStatic);
322     jclass utilityCls = env-&gt;FindClass(&quot;com/sun/webkit/Utilities&quot;);
323     jclass objectCls = env-&gt;FindClass(&quot;java/lang/Object&quot;);
324     jobjectArray argsArray = env-&gt;NewObjectArray(count, objectCls, NULL);
325     for (int i = 0;  i &lt; count; i++)
326       env-&gt;SetObjectArrayElement(argsArray, i, args[i]);
327     jmethodID invokeMethod =
328         env-&gt;GetStaticMethodID(utilityCls, &quot;fwkInvokeWithContext&quot;,
329                                &quot;(Ljava/lang/reflect/Method;Ljava/lang/Object;[Ljava/lang/Object;Ljava/security/AccessControlContext;)Ljava/lang/Object;&quot;);
330     jobject r = env-&gt;CallStaticObjectMethod(utilityCls, invokeMethod,
331                                             rmethod, obj, argsArray,
332                                             accessControlContext);
333 
334     jthrowable ex = env-&gt;ExceptionOccurred();
335     env-&gt;ExceptionClear();
336 
337     switch (returnType) {
338     case JavaTypeVoid:
339         {
340         }
341         break;
342     case JavaTypeArray:
343     case JavaTypeObject:
344     // Since we can&#39;t convert java.lang.Character to any JS primitive, we have
345     // to treat it as JS foreign object.
346     case JavaTypeChar:
347         result.l = r;
348         break;
349 
350     case JavaTypeBoolean:
351         result.z = callJNIMethod&lt;jboolean&gt;(r, &quot;booleanValue&quot;, &quot;()Z&quot;);
352         break;
353 
354     case JavaTypeByte:
355         result.b = callJNIMethod&lt;jbyte&gt;(r, &quot;byteValue&quot;, &quot;()B&quot;);
356         break;
357 
358     case JavaTypeShort:
359         result.s = callJNIMethod&lt;jshort&gt;(r, &quot;shortValue&quot;, &quot;()S&quot;);
360         break;
361 
362     case JavaTypeInt:
363         result.i = callJNIMethod&lt;jint&gt;(r, &quot;intValue&quot;, &quot;()I&quot;);
364         break;
365 
366     case JavaTypeLong:
367         result.j = callJNIMethod&lt;jlong&gt;(r, &quot;longValue&quot;, &quot;()J&quot;);
368         break;
369 
370     case JavaTypeFloat:
371         result.f = callJNIMethod&lt;jfloat&gt;(r, &quot;floatValue&quot;, &quot;()F&quot;);
372         break;
373 
374     case JavaTypeDouble:
375         result.d = callJNIMethod&lt;jdouble&gt;(r, &quot;doubleValue&quot;, &quot;()D&quot;);
376         break;
377 
378     case JavaTypeInvalid:
379         /* Nothing to do */
380         break;
381     }
382     return ex;
383 }
384 
385 } // end of namespace Bindings
386 
387 } // end of namespace JSC
388 
389 #endif // ENABLE(JAVA_BRIDGE)
<a name="18" id="anc18"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="18" type="hidden" />
</body>
</html>