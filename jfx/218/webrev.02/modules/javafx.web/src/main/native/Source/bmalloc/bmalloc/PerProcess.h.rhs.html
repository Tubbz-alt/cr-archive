<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/bmalloc/bmalloc/PerProcess.h</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (C) 2014-2018 Apple Inc. All rights reserved.
  3  *
  4  * Redistribution and use in source and binary forms, with or without
  5  * modification, are permitted provided that the following conditions
  6  * are met:
  7  * 1. Redistributions of source code must retain the above copyright
  8  *    notice, this list of conditions and the following disclaimer.
  9  * 2. Redistributions in binary form must reproduce the above copyright
 10  *    notice, this list of conditions and the following disclaimer in the
 11  *    documentation and/or other materials provided with the distribution.
 12  *
 13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. ``AS IS&#39;&#39; AND ANY
 14  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 15  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 16  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE INC. OR
 17  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 18  * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 19  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 20  * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 21  * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 22  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 23  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #pragma once
 27 
 28 #include &quot;BInline.h&quot;
 29 #include &quot;Mutex.h&quot;
 30 #include &quot;Sizes.h&quot;
 31 
 32 namespace bmalloc {
 33 
 34 // Usage:
 35 //     Object* object = PerProcess&lt;Object&gt;::get();
 36 //     x = object-&gt;field-&gt;field;
 37 //
 38 // Object will be instantiated only once, even in the face of concurrency.
 39 //
 40 // NOTE: If you observe global side-effects of the Object constructor, be
 41 // sure to lock the Object mutex. For example:
 42 //
 43 // Object() : m_field(...) { globalFlag = true }
 44 //
 45 // Object* object = PerProcess&lt;Object&gt;::get();
 46 // x = object-&gt;m_field; // OK
 47 // if (globalFlag) { ... } // Undefined behavior.
 48 //
<a name="1" id="anc1"></a><span class="line-modified"> 49 // LockHolder lock(PerProcess&lt;Object&gt;::mutex());</span>
 50 // Object* object = PerProcess&lt;Object&gt;::get(lock);
 51 // if (globalFlag) { ... } // OK.
 52 
 53 struct PerProcessData {
 54     const char* disambiguator;
 55     void* memory;
 56     size_t size;
 57     size_t alignment;
 58     Mutex mutex;
 59     bool isInitialized;
 60     PerProcessData* next;
 61 };
 62 
 63 constexpr unsigned stringHash(const char* string)
 64 {
 65     unsigned result = 5381;
 66     while (char c = *string++)
 67         result = result * 33 + c;
 68     return result;
 69 }
 70 
 71 BEXPORT PerProcessData* getPerProcessData(unsigned disambiguatorHash, const char* disambiguator, size_t size, size_t alignment);
 72 
 73 template&lt;typename T&gt;
 74 class PerProcess {
 75 public:
 76     static T* get()
 77     {
 78         T* object = getFastCase();
 79         if (!object)
 80             return getSlowCase();
 81         return object;
 82     }
 83 
 84     static T* getFastCase()
 85     {
 86         return s_object.load(std::memory_order_relaxed);
 87     }
 88 
 89     static Mutex&amp; mutex()
 90     {
 91         if (!s_data)
 92             coalesce();
 93         return s_data-&gt;mutex;
 94     }
 95 
 96 private:
 97     static void coalesce()
 98     {
 99         if (s_data)
100             return;
101 
102         const char* disambiguator = __PRETTY_FUNCTION__;
103         s_data = getPerProcessData(stringHash(disambiguator), disambiguator, sizeof(T), std::alignment_of&lt;T&gt;::value);
104     }
105 
106     BNO_INLINE static T* getSlowCase()
107     {
<a name="2" id="anc2"></a><span class="line-modified">108         LockHolder lock(mutex());</span>
109         if (!s_object.load()) {
110             if (s_data-&gt;isInitialized)
111                 s_object.store(static_cast&lt;T*&gt;(s_data-&gt;memory));
112             else {
113                 T* t = new (s_data-&gt;memory) T(lock);
114                 s_object.store(t);
115                 s_data-&gt;isInitialized = true;
116             }
117         }
118         return s_object.load();
119     }
120 
121     static std::atomic&lt;T*&gt; s_object;
122     static PerProcessData* s_data;
123 };
124 
125 template&lt;typename T&gt;
126 std::atomic&lt;T*&gt; PerProcess&lt;T&gt;::s_object { nullptr };
127 
128 template&lt;typename T&gt;
129 PerProcessData* PerProcess&lt;T&gt;::s_data { nullptr };
130 
131 } // namespace bmalloc
<a name="3" id="anc3"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="3" type="hidden" />
</body>
</html>