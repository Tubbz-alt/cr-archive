<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New modules/javafx.web/src/main/native/Source/JavaScriptCore/runtime/RegExpMatchesArray.h</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  *  Copyright (C) 2008-2019 Apple Inc. All Rights Reserved.
  3  *
  4  *  This library is free software; you can redistribute it and/or
  5  *  modify it under the terms of the GNU Lesser General Public
  6  *  License as published by the Free Software Foundation; either
  7  *  version 2 of the License, or (at your option) any later version.
  8  *
  9  *  This library is distributed in the hope that it will be useful,
 10  *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 11  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 12  *  Lesser General Public License for more details.
 13  *
 14  *  You should have received a copy of the GNU Lesser General Public
 15  *  License along with this library; if not, write to the Free Software
 16  *  Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA
 17  *
 18  */
 19 
 20 #pragma once
 21 
 22 #include &quot;ButterflyInlines.h&quot;
 23 #include &quot;GCDeferralContextInlines.h&quot;
 24 #include &quot;JSArray.h&quot;
 25 #include &quot;JSCInlines.h&quot;
 26 #include &quot;JSGlobalObject.h&quot;
 27 #include &quot;ObjectConstructor.h&quot;
 28 #include &quot;RegExpInlines.h&quot;
 29 #include &quot;RegExpObject.h&quot;
 30 
 31 namespace JSC {
 32 
 33 static const PropertyOffset RegExpMatchesArrayIndexPropertyOffset = 100;
 34 static const PropertyOffset RegExpMatchesArrayInputPropertyOffset = 101;
 35 static const PropertyOffset RegExpMatchesArrayGroupsPropertyOffset = 102;
 36 
 37 ALWAYS_INLINE JSArray* tryCreateUninitializedRegExpMatchesArray(ObjectInitializationScope&amp; scope, GCDeferralContext* deferralContext, Structure* structure, unsigned initialLength)
 38 {
 39     VM&amp; vm = scope.vm();
 40     unsigned vectorLength = initialLength;
 41     if (vectorLength &gt; MAX_STORAGE_VECTOR_LENGTH)
 42         return 0;
 43 
 44     const bool hasIndexingHeader = true;
 45     Butterfly* butterfly = Butterfly::tryCreateUninitialized(vm, nullptr, 0, structure-&gt;outOfLineCapacity(), hasIndexingHeader, vectorLength * sizeof(EncodedJSValue), deferralContext);
 46     if (UNLIKELY(!butterfly))
 47         return nullptr;
 48 
 49     butterfly-&gt;setVectorLength(vectorLength);
 50     butterfly-&gt;setPublicLength(initialLength);
 51 
 52     for (unsigned i = initialLength; i &lt; vectorLength; ++i)
 53         butterfly-&gt;contiguous().atUnsafe(i).clear();
 54 
 55     JSArray* result = JSArray::createWithButterfly(vm, deferralContext, structure, butterfly);
 56 
 57     const bool createUninitialized = true;
 58     scope.notifyAllocated(result, createUninitialized);
 59     return result;
 60 }
 61 
 62 ALWAYS_INLINE JSArray* createRegExpMatchesArray(
 63     VM&amp; vm, JSGlobalObject* globalObject, JSString* input, const String&amp; inputValue,
 64     RegExp* regExp, unsigned startOffset, MatchResult&amp; result)
 65 {
 66     if (validateDFGDoesGC)
 67         RELEASE_ASSERT(vm.heap.expectDoesGC());
 68 
 69     Vector&lt;int, 32&gt; subpatternResults;
 70     int position = regExp-&gt;matchInline(vm, inputValue, startOffset, subpatternResults);
 71     if (position == -1) {
 72         result = MatchResult::failed();
 73         return nullptr;
 74     }
 75 
 76     result.start = position;
 77     result.end = subpatternResults[1];
 78 
 79     JSArray* array;
 80 
 81     // FIXME: This should handle array allocation errors gracefully.
 82     // https://bugs.webkit.org/show_bug.cgi?id=155144
 83 
 84     unsigned numSubpatterns = regExp-&gt;numSubpatterns();
 85     bool hasNamedCaptures = regExp-&gt;hasNamedCaptures();
 86     JSObject* groups = hasNamedCaptures ? constructEmptyObject(vm, globalObject-&gt;nullPrototypeObjectStructure()) : nullptr;
 87     Structure* matchStructure = globalObject-&gt;regExpMatchesArrayStructure();
 88 
 89     auto setProperties = [&amp;] () {
 90         array-&gt;putDirect(vm, RegExpMatchesArrayIndexPropertyOffset, jsNumber(result.start));
 91         array-&gt;putDirect(vm, RegExpMatchesArrayInputPropertyOffset, input);
 92         array-&gt;putDirect(vm, RegExpMatchesArrayGroupsPropertyOffset, hasNamedCaptures ? groups : jsUndefined());
 93 
 94         ASSERT(!array-&gt;butterfly()-&gt;indexingHeader()-&gt;preCapacity(matchStructure));
 95         auto capacity = matchStructure-&gt;outOfLineCapacity();
 96         auto size = matchStructure-&gt;outOfLineSize();
 97         gcSafeZeroMemory(static_cast&lt;JSValue*&gt;(array-&gt;butterfly()-&gt;base(0, capacity)), (capacity - size) * sizeof(JSValue));
 98     };
 99 
100     if (UNLIKELY(globalObject-&gt;isHavingABadTime())) {
101         GCDeferralContext deferralContext(vm.heap);
102         ObjectInitializationScope scope(vm);
103         array = JSArray::tryCreateUninitializedRestricted(scope, &amp;deferralContext, matchStructure, numSubpatterns + 1);
104 
105         // FIXME: we should probably throw an out of memory error here, but
106         // when making this change we should check that all clients of this
107         // function will correctly handle an exception being thrown from here.
108         // https://bugs.webkit.org/show_bug.cgi?id=169786
109         RELEASE_ASSERT(array);
110 
111         setProperties();
112 
113         array-&gt;initializeIndexWithoutBarrier(scope, 0, jsSubstringOfResolved(vm, &amp;deferralContext, input, result.start, result.end - result.start));
114 
115         for (unsigned i = 1; i &lt;= numSubpatterns; ++i) {
116             int start = subpatternResults[2 * i];
117             JSValue value;
118             if (start &gt;= 0)
119                 value = jsSubstringOfResolved(vm, &amp;deferralContext, input, start, subpatternResults[2 * i + 1] - start);
120             else
121                 value = jsUndefined();
122             array-&gt;initializeIndexWithoutBarrier(scope, i, value);
123         }
124     } else {
125         GCDeferralContext deferralContext(vm.heap);
126         ObjectInitializationScope scope(vm);
127         array = tryCreateUninitializedRegExpMatchesArray(scope, &amp;deferralContext, matchStructure, numSubpatterns + 1);
128 
129         // FIXME: we should probably throw an out of memory error here, but
130         // when making this change we should check that all clients of this
131         // function will correctly handle an exception being thrown from here.
132         // https://bugs.webkit.org/show_bug.cgi?id=169786
133         RELEASE_ASSERT(array);
134 
135         setProperties();
136 
137         array-&gt;initializeIndexWithoutBarrier(scope, 0, jsSubstringOfResolved(vm, &amp;deferralContext, input, result.start, result.end - result.start), ArrayWithContiguous);
138 
139         for (unsigned i = 1; i &lt;= numSubpatterns; ++i) {
140             int start = subpatternResults[2 * i];
141             JSValue value;
142             if (start &gt;= 0)
143                 value = jsSubstringOfResolved(vm, &amp;deferralContext, input, start, subpatternResults[2 * i + 1] - start);
144             else
145                 value = jsUndefined();
146             array-&gt;initializeIndexWithoutBarrier(scope, i, value, ArrayWithContiguous);
147         }
148     }
149 
150     // Now the object is safe to scan by GC.
151 
152     // We initialize the groups object late as it could allocate, which with the current API could cause
153     // allocations.
154     if (hasNamedCaptures) {
155         for (unsigned i = 1; i &lt;= numSubpatterns; ++i) {
156             String groupName = regExp-&gt;getCaptureGroupName(i);
157             if (!groupName.isEmpty())
158                 groups-&gt;putDirect(vm, Identifier::fromString(vm, groupName), array-&gt;getIndexQuickly(i));
159         }
160     }
161     return array;
162 }
163 
164 inline JSArray* createRegExpMatchesArray(JSGlobalObject* globalObject, JSString* string, RegExp* regExp, unsigned startOffset)
165 {
166     VM&amp; vm = getVM(globalObject);
167     auto scope = DECLARE_THROW_SCOPE(vm);
168 
169     MatchResult ignoredResult;
170     String input = string-&gt;value(globalObject);
171     RETURN_IF_EXCEPTION(scope, { });
172 
173     RELEASE_AND_RETURN(scope, createRegExpMatchesArray(vm, globalObject, string, input, regExp, startOffset, ignoredResult));
174 }
175 JSArray* createEmptyRegExpMatchesArray(JSGlobalObject*, JSString*, RegExp*);
176 Structure* createRegExpMatchesArrayStructure(VM&amp;, JSGlobalObject*);
177 Structure* createRegExpMatchesArraySlowPutStructure(VM&amp;, JSGlobalObject*);
178 
179 } // namespace JSC
    </pre>
  </body>
</html>