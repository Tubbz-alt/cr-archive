<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WebCore/style/StyleInvalidator.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="StyleInvalidationFunctions.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="StyleInvalidator.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/style/StyleInvalidator.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -29,14 +29,20 @@</span>
  #include &quot;CSSSelectorList.h&quot;
  #include &quot;Document.h&quot;
  #include &quot;ElementIterator.h&quot;
  #include &quot;ElementRuleCollector.h&quot;
  #include &quot;HTMLSlotElement.h&quot;
<span class="udiff-line-added">+ #include &quot;RuleSet.h&quot;</span>
<span class="udiff-line-added">+ #include &quot;RuntimeEnabledFeatures.h&quot;</span>
  #include &quot;SelectorFilter.h&quot;
  #include &quot;ShadowRoot.h&quot;
<span class="udiff-line-added">+ #include &quot;StyleResolver.h&quot;</span>
  #include &quot;StyleRuleImport.h&quot;
<span class="udiff-line-added">+ #include &quot;StyleScope.h&quot;</span>
<span class="udiff-line-added">+ #include &quot;StyleScopeRuleSets.h&quot;</span>
  #include &quot;StyleSheetContents.h&quot;
<span class="udiff-line-added">+ #include &lt;wtf/SetForScope.h&gt;</span>
  
  namespace WebCore {
  namespace Style {
  
  static bool shouldDirtyAllStyle(const Vector&lt;RefPtr&lt;StyleRuleBase&gt;&gt;&amp; rules)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -76,39 +82,54 @@</span>
      }
      return false;
  }
  
  Invalidator::Invalidator(const Vector&lt;StyleSheetContents*&gt;&amp; sheets, const MediaQueryEvaluator&amp; mediaQueryEvaluator)
<span class="udiff-line-modified-removed">-     : m_ownedRuleSet(makeUnique&lt;RuleSet&gt;())</span>
<span class="udiff-line-modified-removed">-     , m_ruleSet(*m_ownedRuleSet)</span>
<span class="udiff-line-modified-added">+     : m_ownedRuleSet(RuleSet::create())</span>
<span class="udiff-line-modified-added">+     , m_ruleSets({ m_ownedRuleSet })</span>
      , m_dirtiesAllStyle(shouldDirtyAllStyle(sheets))
  {
      if (m_dirtiesAllStyle)
          return;
  
      m_ownedRuleSet-&gt;disableAutoShrinkToFit();
      for (auto&amp; sheet : sheets)
          m_ownedRuleSet-&gt;addRulesFromSheet(*sheet, mediaQueryEvaluator);
  
<span class="udiff-line-modified-removed">-     m_hasShadowPseudoElementRulesInAuthorSheet = m_ruleSet.hasShadowPseudoElementRules();</span>
<span class="udiff-line-modified-added">+     m_ruleInformation = collectRuleInformation();</span>
  }
  
<span class="udiff-line-modified-removed">- Invalidator::Invalidator(const RuleSet&amp; ruleSet)</span>
<span class="udiff-line-modified-removed">-     : m_ruleSet(ruleSet)</span>
<span class="udiff-line-modified-removed">-     , m_hasShadowPseudoElementRulesInAuthorSheet(ruleSet.hasShadowPseudoElementRules())</span>
<span class="udiff-line-modified-added">+ Invalidator::Invalidator(const InvalidationRuleSetVector&amp; ruleSets)</span>
<span class="udiff-line-modified-added">+     : m_ruleSets(ruleSets)</span>
<span class="udiff-line-modified-added">+     , m_ruleInformation(collectRuleInformation())</span>
  {
<span class="udiff-line-added">+     ASSERT(m_ruleSets.size());</span>
  }
  
<span class="udiff-line-modified-removed">- Invalidator::CheckDescendants Invalidator::invalidateIfNeeded(Element&amp; element, const SelectorFilter* filter)</span>
<span class="udiff-line-modified-added">+ Invalidator::~Invalidator() = default;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ Invalidator::RuleInformation Invalidator::collectRuleInformation()</span>
  {
<span class="udiff-line-modified-removed">-     if (m_hasShadowPseudoElementRulesInAuthorSheet) {</span>
<span class="udiff-line-modified-removed">-         // FIXME: This could do actual rule matching too.</span>
<span class="udiff-line-modified-removed">-         if (element.shadowRoot())</span>
<span class="udiff-line-modified-removed">-             element.invalidateStyleForSubtreeInternal();</span>
<span class="udiff-line-modified-added">+     RuleInformation information;</span>
<span class="udiff-line-modified-added">+     for (auto&amp; ruleSet : m_ruleSets) {</span>
<span class="udiff-line-modified-added">+         if (!ruleSet-&gt;slottedPseudoElementRules().isEmpty())</span>
<span class="udiff-line-modified-added">+             information.hasSlottedPseudoElementRules = true;</span>
<span class="udiff-line-added">+         if (!ruleSet-&gt;hostPseudoClassRules().isEmpty())</span>
<span class="udiff-line-added">+             information.hasHostPseudoClassRules = true;</span>
<span class="udiff-line-added">+         if (ruleSet-&gt;hasShadowPseudoElementRules())</span>
<span class="udiff-line-added">+             information.hasShadowPseudoElementRules = true;</span>
<span class="udiff-line-added">+         if (!ruleSet-&gt;partPseudoElementRules().isEmpty())</span>
<span class="udiff-line-added">+             information.hasPartPseudoElementRules = true;</span>
      }
<span class="udiff-line-added">+     return information;</span>
<span class="udiff-line-added">+ }</span>
  
<span class="udiff-line-modified-removed">-     bool shouldCheckForSlots = !m_ruleSet.slottedPseudoElementRules().isEmpty() &amp;&amp; !m_didInvalidateHostChildren;</span>
<span class="udiff-line-modified-added">+ Invalidator::CheckDescendants Invalidator::invalidateIfNeeded(Element&amp; element, const SelectorFilter* filter)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     invalidateInShadowTreeIfNeeded(element);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     bool shouldCheckForSlots = m_ruleInformation.hasSlottedPseudoElementRules &amp;&amp; !m_didInvalidateHostChildren;</span>
      if (shouldCheckForSlots &amp;&amp; is&lt;HTMLSlotElement&gt;(element)) {
          auto* containingShadowRoot = element.containingShadowRoot();
          if (containingShadowRoot &amp;&amp; containingShadowRoot-&gt;host()) {
              for (auto&amp; possiblySlotted : childrenOfType&lt;Element&gt;(*containingShadowRoot-&gt;host()))
                  possiblySlotted.invalidateStyleInternal();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -117,16 +138,20 @@</span>
          m_didInvalidateHostChildren = true;
      }
  
      switch (element.styleValidity()) {
      case Style::Validity::Valid: {
<span class="udiff-line-modified-removed">-         ElementRuleCollector ruleCollector(element, m_ruleSet, filter);</span>
<span class="udiff-line-modified-removed">-         ruleCollector.setMode(SelectorChecker::Mode::CollectingRulesIgnoringVirtualPseudoElements);</span>
<span class="udiff-line-modified-removed">-         ruleCollector.matchAuthorRules(false);</span>
<span class="udiff-line-modified-added">+         for (auto&amp; ruleSet : m_ruleSets) {</span>
<span class="udiff-line-modified-added">+             ElementRuleCollector ruleCollector(element, *ruleSet, filter);</span>
<span class="udiff-line-modified-added">+             ruleCollector.setMode(SelectorChecker::Mode::CollectingRulesIgnoringVirtualPseudoElements);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             if (ruleCollector.matchesAnyAuthorRules()) {</span>
<span class="udiff-line-added">+                 element.invalidateStyleInternal();</span>
<span class="udiff-line-added">+                 break;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
  
<span class="udiff-line-removed">-         if (ruleCollector.hasMatchedRules())</span>
<span class="udiff-line-removed">-             element.invalidateStyleInternal();</span>
          return CheckDescendants::Yes;
      }
      case Style::Validity::ElementInvalid:
          return CheckDescendants::Yes;
      case Style::Validity::SubtreeInvalid:
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -186,15 +211,30 @@</span>
  
      SelectorFilter filter;
      invalidateStyleForTree(*documentElement, &amp;filter);
  }
  
<span class="udiff-line-added">+ void Invalidator::invalidateStyle(Scope&amp; scope)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     if (m_dirtiesAllStyle) {</span>
<span class="udiff-line-added">+         invalidateAllStyle(scope);</span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (auto* shadowRoot = scope.shadowRoot()) {</span>
<span class="udiff-line-added">+         invalidateStyle(*shadowRoot);</span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     invalidateStyle(scope.document());</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  void Invalidator::invalidateStyle(ShadowRoot&amp; shadowRoot)
  {
      ASSERT(!m_dirtiesAllStyle);
  
<span class="udiff-line-modified-removed">-     if (!m_ruleSet.hostPseudoClassRules().isEmpty() &amp;&amp; shadowRoot.host())</span>
<span class="udiff-line-modified-added">+     if (m_ruleInformation.hasHostPseudoClassRules &amp;&amp; shadowRoot.host())</span>
          shadowRoot.host()-&gt;invalidateStyleInternal();
  
      for (auto&amp; child : childrenOfType&lt;Element&gt;(shadowRoot)) {
          SelectorFilter filter;
          invalidateStyleForTree(child, &amp;filter);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -255,12 +295,92 @@</span>
              invalidateStyleForDescendants(*sibling, &amp;filter);
          }
          break;
      }
      case MatchElement::Host:
<span class="udiff-line-modified-removed">-         // FIXME: Handle this here as well.</span>
<span class="udiff-line-modified-added">+         invalidateInShadowTreeIfNeeded(element);</span>
          break;
      }
  }
  
<span class="udiff-line-added">+ void Invalidator::invalidateShadowParts(ShadowRoot&amp; shadowRoot)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     if (!RuntimeEnabledFeatures::sharedFeatures().cssShadowPartsEnabled())</span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (shadowRoot.mode() == ShadowRootMode::UserAgent)</span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     for (auto&amp; descendant : descendantsOfType&lt;Element&gt;(shadowRoot)) {</span>
<span class="udiff-line-added">+         // FIXME: We could only invalidate part names that actually show up in rules.</span>
<span class="udiff-line-added">+         if (!descendant.partNames().isEmpty())</span>
<span class="udiff-line-added">+             descendant.invalidateStyleInternal();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         auto* nestedShadowRoot = descendant.shadowRoot();</span>
<span class="udiff-line-added">+         if (nestedShadowRoot &amp;&amp; !nestedShadowRoot-&gt;partMappings().isEmpty())</span>
<span class="udiff-line-added">+             invalidateShadowParts(*nestedShadowRoot);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void Invalidator::invalidateInShadowTreeIfNeeded(Element&amp; element)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     auto* shadowRoot = element.shadowRoot();</span>
<span class="udiff-line-added">+     if (!shadowRoot)</span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     // FIXME: This could do actual rule matching too.</span>
<span class="udiff-line-added">+     if (m_ruleInformation.hasShadowPseudoElementRules)</span>
<span class="udiff-line-added">+         element.invalidateStyleForSubtreeInternal();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     // FIXME: More fine-grained invalidation for ::part()</span>
<span class="udiff-line-added">+     if (m_ruleInformation.hasPartPseudoElementRules)</span>
<span class="udiff-line-added">+         invalidateShadowParts(*shadowRoot);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void Invalidator::addToMatchElementRuleSets(Invalidator::MatchElementRuleSets&amp; matchElementRuleSets, const InvalidationRuleSet&amp; invalidationRuleSet)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     matchElementRuleSets.ensure(invalidationRuleSet.matchElement, [] {</span>
<span class="udiff-line-added">+         return InvalidationRuleSetVector { };</span>
<span class="udiff-line-added">+     }).iterator-&gt;value.append(invalidationRuleSet.ruleSet.copyRef());</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void Invalidator::invalidateWithMatchElementRuleSets(Element&amp; element, const MatchElementRuleSets&amp; matchElementRuleSets)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     SetForScope&lt;bool&gt; isInvalidating(element.styleResolver().ruleSets().isInvalidatingStyleWithRuleSets(), true);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     for (auto&amp; matchElementAndRuleSet : matchElementRuleSets) {</span>
<span class="udiff-line-added">+         Invalidator invalidator(matchElementAndRuleSet.value);</span>
<span class="udiff-line-added">+         invalidator.invalidateStyleWithMatchElement(element, matchElementAndRuleSet.key);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void Invalidator::invalidateAllStyle(Scope&amp; scope)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     if (auto* shadowRoot = scope.shadowRoot()) {</span>
<span class="udiff-line-added">+         for (auto&amp; shadowChild : childrenOfType&lt;Element&gt;(*shadowRoot))</span>
<span class="udiff-line-added">+             shadowChild.invalidateStyleForSubtreeInternal();</span>
<span class="udiff-line-added">+         invalidateHostAndSlottedStyleIfNeeded(*shadowRoot);</span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     scope.document().scheduleFullStyleRebuild();</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void Invalidator::invalidateHostAndSlottedStyleIfNeeded(ShadowRoot&amp; shadowRoot)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     auto&amp; host = *shadowRoot.host();</span>
<span class="udiff-line-added">+     auto* resolver = shadowRoot.styleScope().resolverIfExists();</span>
<span class="udiff-line-added">+     if (!resolver)</span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+     auto&amp; authorStyle = resolver-&gt;ruleSets().authorStyle();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (!authorStyle.hostPseudoClassRules().isEmpty())</span>
<span class="udiff-line-added">+         host.invalidateStyleInternal();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (!authorStyle.slottedPseudoElementRules().isEmpty()) {</span>
<span class="udiff-line-added">+         for (auto&amp; shadowChild : childrenOfType&lt;Element&gt;(host))</span>
<span class="udiff-line-added">+             shadowChild.invalidateStyleInternal();</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  }
  }
</pre>
<center><a href="StyleInvalidationFunctions.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="StyleInvalidator.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>