<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WebCore/css/CSSValuePool.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="CSSValueKeywords.in.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="CSSValuePool.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/css/CSSValuePool.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -28,45 +28,62 @@</span>
  
  #include &quot;CSSParser.h&quot;
  #include &quot;CSSPrimitiveValueMappings.h&quot;
  #include &quot;CSSValueKeywords.h&quot;
  #include &quot;CSSValueList.h&quot;
<span class="udiff-line-added">+ #include &lt;wtf/text/StringConcatenateNumbers.h&gt;</span>
  
  namespace WebCore {
  
<span class="udiff-line-modified-removed">- CSSValuePool&amp; CSSValuePool::singleton()</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-     static NeverDestroyed&lt;CSSValuePool&gt; pool;</span>
<span class="udiff-line-removed">-     return pool;</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-modified-added">+ LazyNeverDestroyed&lt;StaticCSSValuePool&gt; staticCSSValuePool;</span>
  
<span class="udiff-line-modified-removed">- CSSValuePool::CSSValuePool()</span>
<span class="udiff-line-modified-added">+ StaticCSSValuePool::StaticCSSValuePool()</span>
  {
<span class="udiff-line-modified-removed">-     m_inheritedValue.construct();</span>
<span class="udiff-line-modified-removed">-     m_implicitInitialValue.construct(true);</span>
<span class="udiff-line-modified-removed">-     m_explicitInitialValue.construct(false);</span>
<span class="udiff-line-modified-removed">-     m_unsetValue.construct();</span>
<span class="udiff-line-modified-removed">-     m_revertValue.construct();</span>
<span class="udiff-line-modified-added">+     m_inheritedValue.construct(CSSValue::StaticCSSValue);</span>
<span class="udiff-line-modified-added">+     m_implicitInitialValue.construct(CSSValue::StaticCSSValue, true);</span>
<span class="udiff-line-modified-added">+     m_explicitInitialValue.construct(CSSValue::StaticCSSValue, false);</span>
<span class="udiff-line-modified-added">+     m_unsetValue.construct(CSSValue::StaticCSSValue);</span>
<span class="udiff-line-modified-added">+     m_revertValue.construct(CSSValue::StaticCSSValue);</span>
  
<span class="udiff-line-modified-removed">-     m_transparentColor.construct(Color(Color::transparent));</span>
<span class="udiff-line-modified-removed">-     m_whiteColor.construct(Color(Color::white));</span>
<span class="udiff-line-modified-removed">-     m_blackColor.construct(Color(Color::black));</span>
<span class="udiff-line-modified-added">+     m_transparentColor.construct(CSSValue::StaticCSSValue, Color(Color::transparent));</span>
<span class="udiff-line-modified-added">+     m_whiteColor.construct(CSSValue::StaticCSSValue, Color(Color::white));</span>
<span class="udiff-line-modified-added">+     m_blackColor.construct(CSSValue::StaticCSSValue, Color(Color::black));</span>
  
      for (unsigned i = firstCSSValueKeyword; i &lt;= lastCSSValueKeyword; ++i)
<span class="udiff-line-modified-removed">-         m_identifierValues[i].construct(static_cast&lt;CSSValueID&gt;(i));</span>
<span class="udiff-line-modified-added">+         m_identifierValues[i].construct(CSSValue::StaticCSSValue, static_cast&lt;CSSValueID&gt;(i));</span>
  
      for (unsigned i = 0; i &lt; (maximumCacheableIntegerValue + 1); ++i) {
<span class="udiff-line-modified-removed">-         m_pixelValues[i].construct(i, CSSPrimitiveValue::CSS_PX);</span>
<span class="udiff-line-modified-removed">-         m_percentValues[i].construct(i, CSSPrimitiveValue::CSS_PERCENTAGE);</span>
<span class="udiff-line-modified-removed">-         m_numberValues[i].construct(i, CSSPrimitiveValue::CSS_NUMBER);</span>
<span class="udiff-line-modified-added">+         m_pixelValues[i].construct(CSSValue::StaticCSSValue, i, CSSUnitType::CSS_PX);</span>
<span class="udiff-line-modified-added">+         m_percentValues[i].construct(CSSValue::StaticCSSValue, i, CSSUnitType::CSS_PERCENTAGE);</span>
<span class="udiff-line-modified-added">+         m_numberValues[i].construct(CSSValue::StaticCSSValue, i, CSSUnitType::CSS_NUMBER);</span>
      }
  }
  
<span class="udiff-line-added">+ void StaticCSSValuePool::init()</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     static std::once_flag onceKey;</span>
<span class="udiff-line-added">+     std::call_once(onceKey, []() {</span>
<span class="udiff-line-added">+         staticCSSValuePool.construct();</span>
<span class="udiff-line-added">+     });</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ CSSValuePool::CSSValuePool()</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     StaticCSSValuePool::init();</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ CSSValuePool&amp; CSSValuePool::singleton()</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     ASSERT(isMainThread());</span>
<span class="udiff-line-added">+     static NeverDestroyed&lt;CSSValuePool&gt; pool;</span>
<span class="udiff-line-added">+     return pool;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  Ref&lt;CSSPrimitiveValue&gt; CSSValuePool::createIdentifierValue(CSSValueID ident)
  {
      RELEASE_ASSERT(ident &gt;= firstCSSValueKeyword &amp;&amp; ident &lt;= lastCSSValueKeyword);
<span class="udiff-line-modified-removed">-     return m_identifierValues[ident].get();</span>
<span class="udiff-line-modified-added">+     return staticCSSValuePool-&gt;m_identifierValues[ident].get();</span>
  }
  
  Ref&lt;CSSPrimitiveValue&gt; CSSValuePool::createIdentifierValue(CSSPropertyID ident)
  {
      return CSSPrimitiveValue::createIdentifier(ident);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -74,16 +91,16 @@</span>
  
  Ref&lt;CSSPrimitiveValue&gt; CSSValuePool::createColorValue(const Color&amp; color)
  {
      // These are the empty and deleted values of the hash table.
      if (color == Color::transparent)
<span class="udiff-line-modified-removed">-         return m_transparentColor.get();</span>
<span class="udiff-line-modified-added">+         return staticCSSValuePool-&gt;m_transparentColor.get();</span>
      if (color == Color::white)
<span class="udiff-line-modified-removed">-         return m_whiteColor.get();</span>
<span class="udiff-line-modified-added">+         return staticCSSValuePool-&gt;m_whiteColor.get();</span>
      // Just because it is common.
      if (color == Color::black)
<span class="udiff-line-modified-removed">-         return m_blackColor.get();</span>
<span class="udiff-line-modified-added">+         return staticCSSValuePool-&gt;m_blackColor.get();</span>
  
      // Remove one entry at random if the cache grows too large.
      // FIXME: Use TinyLRUCache instead?
      const int maximumColorCacheSize = 512;
      if (m_colorValueCache.size() &gt;= maximumColorCacheSize)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -92,28 +109,28 @@</span>
      return *m_colorValueCache.ensure(color, [&amp;color] {
          return CSSPrimitiveValue::create(color);
      }).iterator-&gt;value;
  }
  
<span class="udiff-line-modified-removed">- Ref&lt;CSSPrimitiveValue&gt; CSSValuePool::createValue(double value, CSSPrimitiveValue::UnitType type)</span>
<span class="udiff-line-modified-added">+ Ref&lt;CSSPrimitiveValue&gt; CSSValuePool::createValue(double value, CSSUnitType type)</span>
  {
      ASSERT(std::isfinite(value));
  
<span class="udiff-line-modified-removed">-     if (value &lt; 0 || value &gt; maximumCacheableIntegerValue)</span>
<span class="udiff-line-modified-added">+     if (value &lt; 0 || value &gt; StaticCSSValuePool::maximumCacheableIntegerValue)</span>
          return CSSPrimitiveValue::create(value, type);
  
      int intValue = static_cast&lt;int&gt;(value);
      if (value != intValue)
          return CSSPrimitiveValue::create(value, type);
  
      switch (type) {
<span class="udiff-line-modified-removed">-     case CSSPrimitiveValue::CSS_PX:</span>
<span class="udiff-line-modified-removed">-         return m_pixelValues[intValue].get();</span>
<span class="udiff-line-modified-removed">-     case CSSPrimitiveValue::CSS_PERCENTAGE:</span>
<span class="udiff-line-modified-removed">-         return m_percentValues[intValue].get();</span>
<span class="udiff-line-modified-removed">-     case CSSPrimitiveValue::CSS_NUMBER:</span>
<span class="udiff-line-modified-removed">-         return m_numberValues[intValue].get();</span>
<span class="udiff-line-modified-added">+     case CSSUnitType::CSS_PX:</span>
<span class="udiff-line-modified-added">+         return staticCSSValuePool-&gt;m_pixelValues[intValue].get();</span>
<span class="udiff-line-modified-added">+     case CSSUnitType::CSS_PERCENTAGE:</span>
<span class="udiff-line-modified-added">+         return staticCSSValuePool-&gt;m_percentValues[intValue].get();</span>
<span class="udiff-line-modified-added">+     case CSSUnitType::CSS_NUMBER:</span>
<span class="udiff-line-modified-added">+         return staticCSSValuePool-&gt;m_numberValues[intValue].get();</span>
      default:
          return CSSPrimitiveValue::create(value, type);
      }
  }
  
</pre>
<center><a href="CSSValueKeywords.in.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="CSSValuePool.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>