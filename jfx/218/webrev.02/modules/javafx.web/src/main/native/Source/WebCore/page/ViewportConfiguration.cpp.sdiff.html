<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WebCore/page/ViewportConfiguration.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="UserContentURLPattern.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="ViewportConfiguration.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/page/ViewportConfiguration.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 21  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 22  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF
 23  * THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #include &quot;config.h&quot;
 27 #include &quot;ViewportConfiguration.h&quot;
 28 
 29 #include &quot;Logging.h&quot;
 30 #include &lt;wtf/Assertions.h&gt;
 31 #include &lt;wtf/MathExtras.h&gt;
 32 #include &lt;wtf/text/CString.h&gt;
 33 #include &lt;wtf/text/TextStream.h&gt;
 34 
 35 #if PLATFORM(IOS_FAMILY)
 36 #include &quot;PlatformScreen.h&quot;
 37 #endif
 38 
 39 namespace WebCore {
 40 
<span class="line-modified"> 41 #if !ASSERT_DISABLED</span>
 42 static bool constraintsAreAllRelative(const ViewportConfiguration::Parameters&amp; configuration)
 43 {
 44     return !configuration.widthIsSet &amp;&amp; !configuration.heightIsSet &amp;&amp; !configuration.initialScaleIsSet;
 45 }
<span class="line-modified"> 46 #endif</span>
 47 
 48 static float platformDeviceWidthOverride()
 49 {
 50 #if PLATFORM(WATCHOS)
 51     return 320;
 52 #else
 53     return 0;
 54 #endif
 55 }
 56 
 57 static bool shouldOverrideShrinkToFitArgument()
 58 {
 59 #if PLATFORM(WATCHOS)
 60     return true;
 61 #else
 62     return false;
 63 #endif
 64 }
 65 
 66 static bool needsUpdateAfterChangingDisabledAdaptations(const OptionSet&lt;DisabledAdaptations&gt;&amp; oldDisabledAdaptations, const OptionSet&lt;DisabledAdaptations&gt;&amp; newDisabledAdaptations)
</pre>
<hr />
<pre>
249     auto clampToMinimumAndMaximumScales = [&amp;] (double initialScale) {
250         return clampTo&lt;double&gt;(initialScale, shouldIgnoreScalingConstraints ? m_defaultConfiguration.minimumScale : m_configuration.minimumScale, m_configuration.maximumScale);
251     };
252 
253     if (layoutSizeIsExplicitlyScaled()) {
254         if (m_configuration.initialScaleIsSet)
255             return clampToMinimumAndMaximumScales(m_configuration.initialScale);
256 
257         if (m_configuration.width &gt; 0)
258             return clampToMinimumAndMaximumScales(m_viewLayoutSize.width() / m_configuration.width);
259     }
260 
261     // If the document has specified its own initial scale, use it regardless.
262     // This is guaranteed to be sanity checked already, so no need for MIN/MAX.
263     if (m_configuration.initialScaleIsSet &amp;&amp; !shouldIgnoreScalingConstraints)
264         return m_configuration.initialScale;
265 
266     // If not, it is up to us to determine the initial scale.
267     // We want a scale small enough to fit the document width-wise.
268     double initialScale = 0;
<span class="line-modified">269     if (width &gt; 0 &amp;&amp; !shouldIgnoreVerticalScalingConstraints())</span>
<span class="line-modified">270         initialScale = m_viewLayoutSize.width() / width;</span>





271 
272     // Prevent the initial scale from shrinking to a height smaller than our view&#39;s minimum height.
273     if (height &gt; 0 &amp;&amp; height * initialScale &lt; m_viewLayoutSize.height() &amp;&amp; !shouldIgnoreHorizontalScalingConstraints())
274         initialScale = m_viewLayoutSize.height() / height;
275 
276     return clampToMinimumAndMaximumScales(initialScale);
277 }
278 
279 double ViewportConfiguration::initialScale() const
280 {
281     return initialScaleFromSize(m_contentSize.width() &gt; 0 ? m_contentSize.width() : layoutWidth(), m_contentSize.height() &gt; 0 ? m_contentSize.height() : layoutHeight(), shouldIgnoreScalingConstraints());
282 }
283 
284 double ViewportConfiguration::initialScaleIgnoringContentSize() const
285 {
286     return initialScaleFromSize(layoutWidth(), layoutHeight(), shouldIgnoreScalingConstraintsRegardlessOfContentSize());
287 }
288 
289 double ViewportConfiguration::minimumScale() const
290 {
</pre>
<hr />
<pre>
611 
612     if (shouldIgnoreMinimumEffectiveDeviceWidth())
613         return false;
614 
615     updateMinimumLayoutSize();
616     updateConfiguration();
617     return true;
618 }
619 
620 bool ViewportConfiguration::setIsKnownToLayOutWiderThanViewport(bool value)
621 {
622     if (m_isKnownToLayOutWiderThanViewport == value)
623         return false;
624 
625     m_isKnownToLayOutWiderThanViewport = value;
626     updateMinimumLayoutSize();
627     updateConfiguration();
628     return true;
629 }
630 
<span class="line-modified">631 #ifndef NDEBUG</span>
632 
633 TextStream&amp; operator&lt;&lt;(TextStream&amp; ts, const ViewportConfiguration::Parameters&amp; parameters)
634 {
635     ts.startGroup();
636     ts &lt;&lt; &quot;width &quot; &lt;&lt; parameters.width &lt;&lt; &quot;, set: &quot; &lt;&lt; (parameters.widthIsSet ? &quot;true&quot; : &quot;false&quot;);
637     ts.endGroup();
638 
639     ts.startGroup();
640     ts &lt;&lt; &quot;height &quot; &lt;&lt; parameters.height &lt;&lt; &quot;, set: &quot; &lt;&lt; (parameters.heightIsSet ? &quot;true&quot; : &quot;false&quot;);
641     ts.endGroup();
642 
643     ts.startGroup();
644     ts &lt;&lt; &quot;initialScale &quot; &lt;&lt; parameters.initialScale &lt;&lt; &quot;, set: &quot; &lt;&lt; (parameters.initialScaleIsSet ? &quot;true&quot; : &quot;false&quot;);
645     ts.endGroup();
646 
647     ts.dumpProperty(&quot;initialScaleIgnoringLayoutScaleFactor&quot;, parameters.initialScaleIgnoringLayoutScaleFactor);
648     ts.dumpProperty(&quot;minimumScale&quot;, parameters.minimumScale);
649     ts.dumpProperty(&quot;maximumScale&quot;, parameters.maximumScale);
650     ts.dumpProperty(&quot;allowsUserScaling&quot;, parameters.allowsUserScaling);
651     ts.dumpProperty(&quot;allowsShrinkToFit&quot;, parameters.allowsShrinkToFit);
</pre>
</td>
<td>
<hr />
<pre>
 21  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 22  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF
 23  * THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #include &quot;config.h&quot;
 27 #include &quot;ViewportConfiguration.h&quot;
 28 
 29 #include &quot;Logging.h&quot;
 30 #include &lt;wtf/Assertions.h&gt;
 31 #include &lt;wtf/MathExtras.h&gt;
 32 #include &lt;wtf/text/CString.h&gt;
 33 #include &lt;wtf/text/TextStream.h&gt;
 34 
 35 #if PLATFORM(IOS_FAMILY)
 36 #include &quot;PlatformScreen.h&quot;
 37 #endif
 38 
 39 namespace WebCore {
 40 
<span class="line-modified"> 41 #if ASSERT_ENABLED</span>
 42 static bool constraintsAreAllRelative(const ViewportConfiguration::Parameters&amp; configuration)
 43 {
 44     return !configuration.widthIsSet &amp;&amp; !configuration.heightIsSet &amp;&amp; !configuration.initialScaleIsSet;
 45 }
<span class="line-modified"> 46 #endif // ASSERT_ENABLED</span>
 47 
 48 static float platformDeviceWidthOverride()
 49 {
 50 #if PLATFORM(WATCHOS)
 51     return 320;
 52 #else
 53     return 0;
 54 #endif
 55 }
 56 
 57 static bool shouldOverrideShrinkToFitArgument()
 58 {
 59 #if PLATFORM(WATCHOS)
 60     return true;
 61 #else
 62     return false;
 63 #endif
 64 }
 65 
 66 static bool needsUpdateAfterChangingDisabledAdaptations(const OptionSet&lt;DisabledAdaptations&gt;&amp; oldDisabledAdaptations, const OptionSet&lt;DisabledAdaptations&gt;&amp; newDisabledAdaptations)
</pre>
<hr />
<pre>
249     auto clampToMinimumAndMaximumScales = [&amp;] (double initialScale) {
250         return clampTo&lt;double&gt;(initialScale, shouldIgnoreScalingConstraints ? m_defaultConfiguration.minimumScale : m_configuration.minimumScale, m_configuration.maximumScale);
251     };
252 
253     if (layoutSizeIsExplicitlyScaled()) {
254         if (m_configuration.initialScaleIsSet)
255             return clampToMinimumAndMaximumScales(m_configuration.initialScale);
256 
257         if (m_configuration.width &gt; 0)
258             return clampToMinimumAndMaximumScales(m_viewLayoutSize.width() / m_configuration.width);
259     }
260 
261     // If the document has specified its own initial scale, use it regardless.
262     // This is guaranteed to be sanity checked already, so no need for MIN/MAX.
263     if (m_configuration.initialScaleIsSet &amp;&amp; !shouldIgnoreScalingConstraints)
264         return m_configuration.initialScale;
265 
266     // If not, it is up to us to determine the initial scale.
267     // We want a scale small enough to fit the document width-wise.
268     double initialScale = 0;
<span class="line-modified">269     if (!shouldIgnoreVerticalScalingConstraints()) {</span>
<span class="line-modified">270         static const double maximumContentWidthBeforePreferringExplicitWidthToAvoidExcessiveScaling = 1920;</span>
<span class="line-added">271         if (width &gt; maximumContentWidthBeforePreferringExplicitWidthToAvoidExcessiveScaling &amp;&amp; m_configuration.widthIsSet &amp;&amp; 0 &lt; m_configuration.width &amp;&amp; m_configuration.width &lt; width)</span>
<span class="line-added">272             initialScale = m_viewLayoutSize.width() / m_configuration.width;</span>
<span class="line-added">273         else if (width &gt; 0)</span>
<span class="line-added">274             initialScale = m_viewLayoutSize.width() / width;</span>
<span class="line-added">275     }</span>
276 
277     // Prevent the initial scale from shrinking to a height smaller than our view&#39;s minimum height.
278     if (height &gt; 0 &amp;&amp; height * initialScale &lt; m_viewLayoutSize.height() &amp;&amp; !shouldIgnoreHorizontalScalingConstraints())
279         initialScale = m_viewLayoutSize.height() / height;
280 
281     return clampToMinimumAndMaximumScales(initialScale);
282 }
283 
284 double ViewportConfiguration::initialScale() const
285 {
286     return initialScaleFromSize(m_contentSize.width() &gt; 0 ? m_contentSize.width() : layoutWidth(), m_contentSize.height() &gt; 0 ? m_contentSize.height() : layoutHeight(), shouldIgnoreScalingConstraints());
287 }
288 
289 double ViewportConfiguration::initialScaleIgnoringContentSize() const
290 {
291     return initialScaleFromSize(layoutWidth(), layoutHeight(), shouldIgnoreScalingConstraintsRegardlessOfContentSize());
292 }
293 
294 double ViewportConfiguration::minimumScale() const
295 {
</pre>
<hr />
<pre>
616 
617     if (shouldIgnoreMinimumEffectiveDeviceWidth())
618         return false;
619 
620     updateMinimumLayoutSize();
621     updateConfiguration();
622     return true;
623 }
624 
625 bool ViewportConfiguration::setIsKnownToLayOutWiderThanViewport(bool value)
626 {
627     if (m_isKnownToLayOutWiderThanViewport == value)
628         return false;
629 
630     m_isKnownToLayOutWiderThanViewport = value;
631     updateMinimumLayoutSize();
632     updateConfiguration();
633     return true;
634 }
635 
<span class="line-modified">636 #if !LOG_DISABLED</span>
637 
638 TextStream&amp; operator&lt;&lt;(TextStream&amp; ts, const ViewportConfiguration::Parameters&amp; parameters)
639 {
640     ts.startGroup();
641     ts &lt;&lt; &quot;width &quot; &lt;&lt; parameters.width &lt;&lt; &quot;, set: &quot; &lt;&lt; (parameters.widthIsSet ? &quot;true&quot; : &quot;false&quot;);
642     ts.endGroup();
643 
644     ts.startGroup();
645     ts &lt;&lt; &quot;height &quot; &lt;&lt; parameters.height &lt;&lt; &quot;, set: &quot; &lt;&lt; (parameters.heightIsSet ? &quot;true&quot; : &quot;false&quot;);
646     ts.endGroup();
647 
648     ts.startGroup();
649     ts &lt;&lt; &quot;initialScale &quot; &lt;&lt; parameters.initialScale &lt;&lt; &quot;, set: &quot; &lt;&lt; (parameters.initialScaleIsSet ? &quot;true&quot; : &quot;false&quot;);
650     ts.endGroup();
651 
652     ts.dumpProperty(&quot;initialScaleIgnoringLayoutScaleFactor&quot;, parameters.initialScaleIgnoringLayoutScaleFactor);
653     ts.dumpProperty(&quot;minimumScale&quot;, parameters.minimumScale);
654     ts.dumpProperty(&quot;maximumScale&quot;, parameters.maximumScale);
655     ts.dumpProperty(&quot;allowsUserScaling&quot;, parameters.allowsUserScaling);
656     ts.dumpProperty(&quot;allowsShrinkToFit&quot;, parameters.allowsShrinkToFit);
</pre>
</td>
</tr>
</table>
<center><a href="UserContentURLPattern.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="ViewportConfiguration.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>