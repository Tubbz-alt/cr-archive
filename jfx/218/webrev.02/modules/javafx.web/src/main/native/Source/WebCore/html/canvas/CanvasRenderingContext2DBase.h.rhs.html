<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/WebCore/html/canvas/CanvasRenderingContext2DBase.h</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (C) 2006, 2007, 2009, 2010, 2011, 2012, 2017 Apple Inc. All rights reserved.
  3  *
  4  * Redistribution and use in source and binary forms, with or without
  5  * modification, are permitted provided that the following conditions
  6  * are met:
  7  * 1. Redistributions of source code must retain the above copyright
  8  *    notice, this list of conditions and the following disclaimer.
  9  * 2. Redistributions in binary form must reproduce the above copyright
 10  *    notice, this list of conditions and the following disclaimer in the
 11  *    documentation and/or other materials provided with the distribution.
 12  *
 13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. ``AS IS&#39;&#39; AND ANY
 14  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 15  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 16  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE INC. OR
 17  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 18  * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 19  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 20  * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 21  * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 22  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 23  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #pragma once
 27 
 28 #include &quot;AffineTransform.h&quot;
 29 #include &quot;CanvasDirection.h&quot;
 30 #include &quot;CanvasFillRule.h&quot;
 31 #include &quot;CanvasLineCap.h&quot;
 32 #include &quot;CanvasLineJoin.h&quot;
 33 #include &quot;CanvasPath.h&quot;
 34 #include &quot;CanvasRenderingContext.h&quot;
 35 #include &quot;CanvasStyle.h&quot;
 36 #include &quot;CanvasTextAlign.h&quot;
 37 #include &quot;CanvasTextBaseline.h&quot;
 38 #include &quot;Color.h&quot;
 39 #include &quot;FloatSize.h&quot;
 40 #include &quot;FontCascade.h&quot;
 41 #include &quot;FontSelectorClient.h&quot;
 42 #include &quot;GraphicsContext.h&quot;
 43 #include &quot;GraphicsTypes.h&quot;
 44 #include &quot;ImageBuffer.h&quot;
 45 #include &quot;ImageSmoothingQuality.h&quot;
 46 #include &quot;Path.h&quot;
 47 #include &quot;PlatformLayer.h&quot;
 48 #include &lt;wtf/Vector.h&gt;
 49 #include &lt;wtf/text/WTFString.h&gt;
 50 
 51 namespace WebCore {
 52 
 53 class TypedOMCSSImageValue;
 54 class CachedImage;
 55 class CanvasBase;
 56 class CanvasGradient;
 57 class CanvasPattern;
 58 class DOMMatrix;
 59 class FloatRect;
 60 class GraphicsContext;
 61 class HTMLImageElement;
 62 class HTMLVideoElement;
 63 class ImageBitmap;
 64 class ImageData;
<a name="1" id="anc1"></a><span class="line-added"> 65 class OffscreenCanvas;</span>
 66 class Path2D;
 67 class RenderStyle;
 68 class RenderObject;
 69 class TextMetrics;
 70 
 71 struct DOMMatrix2DInit;
 72 
<a name="2" id="anc2"></a><span class="line-modified"> 73 using CanvasImageSource = Variant&lt;RefPtr&lt;HTMLImageElement&gt;, RefPtr&lt;HTMLCanvasElement&gt;, RefPtr&lt;ImageBitmap&gt;</span>
<span class="line-modified"> 74 #if ENABLE(CSS_TYPED_OM)</span>
<span class="line-modified"> 75     , RefPtr&lt;TypedOMCSSImageValue&gt;</span>
<span class="line-modified"> 76 #endif</span>
<span class="line-modified"> 77 #if ENABLE(OFFSCREEN_CANVAS)</span>
<span class="line-modified"> 78     , RefPtr&lt;OffscreenCanvas&gt;</span>
<span class="line-added"> 79 #endif</span>
<span class="line-added"> 80 #if ENABLE(VIDEO)</span>
<span class="line-added"> 81     , RefPtr&lt;HTMLVideoElement&gt;</span>
 82 #endif
<a name="3" id="anc3"></a><span class="line-added"> 83     &gt;;</span>
 84 
 85 class CanvasRenderingContext2DBase : public CanvasRenderingContext, public CanvasPath {
 86     WTF_MAKE_ISO_ALLOCATED(CanvasRenderingContext2DBase);
 87 public:
 88     CanvasRenderingContext2DBase(CanvasBase&amp;, bool usesCSSCompatibilityParseMode);
 89     virtual ~CanvasRenderingContext2DBase();
 90 
 91     float lineWidth() const;
 92     void setLineWidth(float);
 93 
 94     CanvasLineCap lineCap() const;
 95     void setLineCap(CanvasLineCap);
 96     void setLineCap(const String&amp;);
 97 
 98     CanvasLineJoin lineJoin() const;
 99     void setLineJoin(CanvasLineJoin);
100     void setLineJoin(const String&amp;);
101 
102     float miterLimit() const;
103     void setMiterLimit(float);
104 
105     const Vector&lt;float&gt;&amp; getLineDash() const;
106     void setLineDash(const Vector&lt;float&gt;&amp;);
107     const Vector&lt;float&gt;&amp; webkitLineDash() const { return getLineDash(); }
108     void setWebkitLineDash(const Vector&lt;float&gt;&amp;);
109 
110     float lineDashOffset() const;
111     void setLineDashOffset(float);
112 
113     float shadowOffsetX() const;
114     void setShadowOffsetX(float);
115 
116     float shadowOffsetY() const;
117     void setShadowOffsetY(float);
118 
119     float shadowBlur() const;
120     void setShadowBlur(float);
121 
122     String shadowColor() const;
123     void setShadowColor(const String&amp;);
124 
125     float globalAlpha() const;
126     void setGlobalAlpha(float);
127 
128     String globalCompositeOperation() const;
129     void setGlobalCompositeOperation(const String&amp;);
130 
131     void save() { ++m_unrealizedSaveCount; }
132     void restore();
133 
134     void scale(float sx, float sy);
135     void rotate(float angleInRadians);
136     void translate(float tx, float ty);
137     void transform(float m11, float m12, float m21, float m22, float dx, float dy);
138 
139     Ref&lt;DOMMatrix&gt; getTransform() const;
140     void setTransform(float m11, float m12, float m21, float m22, float dx, float dy);
141     ExceptionOr&lt;void&gt; setTransform(DOMMatrix2DInit&amp;&amp;);
142     void resetTransform();
143 
144     void setStrokeColor(const String&amp; color, Optional&lt;float&gt; alpha = WTF::nullopt);
145     void setStrokeColor(float grayLevel, float alpha = 1.0);
146     void setStrokeColor(float r, float g, float b, float a);
147     void setStrokeColor(float c, float m, float y, float k, float a);
148 
149     void setFillColor(const String&amp; color, Optional&lt;float&gt; alpha = WTF::nullopt);
150     void setFillColor(float grayLevel, float alpha = 1.0f);
151     void setFillColor(float r, float g, float b, float a);
152     void setFillColor(float c, float m, float y, float k, float a);
153 
154     void beginPath();
155 
156     void fill(CanvasFillRule = CanvasFillRule::Nonzero);
157     void stroke();
158     void clip(CanvasFillRule = CanvasFillRule::Nonzero);
159 
160     void fill(Path2D&amp;, CanvasFillRule = CanvasFillRule::Nonzero);
161     void stroke(Path2D&amp;);
162     void clip(Path2D&amp;, CanvasFillRule = CanvasFillRule::Nonzero);
163 
164     bool isPointInPath(float x, float y, CanvasFillRule = CanvasFillRule::Nonzero);
165     bool isPointInStroke(float x, float y);
166 
167     bool isPointInPath(Path2D&amp;, float x, float y, CanvasFillRule = CanvasFillRule::Nonzero);
168     bool isPointInStroke(Path2D&amp;, float x, float y);
169 
170     void clearRect(float x, float y, float width, float height);
171     void fillRect(float x, float y, float width, float height);
172     void strokeRect(float x, float y, float width, float height);
173 
174     void setShadow(float width, float height, float blur, const String&amp; color = String(), Optional&lt;float&gt; alpha = WTF::nullopt);
175     void setShadow(float width, float height, float blur, float grayLevel, float alpha = 1.0);
176     void setShadow(float width, float height, float blur, float r, float g, float b, float a);
177     void setShadow(float width, float height, float blur, float c, float m, float y, float k, float a);
178 
179     void clearShadow();
180 
181     ExceptionOr&lt;void&gt; drawImage(CanvasImageSource&amp;&amp;, float dx, float dy);
182     ExceptionOr&lt;void&gt; drawImage(CanvasImageSource&amp;&amp;, float dx, float dy, float dw, float dh);
183     ExceptionOr&lt;void&gt; drawImage(CanvasImageSource&amp;&amp;, float sx, float sy, float sw, float sh, float dx, float dy, float dw, float dh);
184 
185     void drawImageFromRect(HTMLImageElement&amp;, float sx = 0, float sy = 0, float sw = 0, float sh = 0, float dx = 0, float dy = 0, float dw = 0, float dh = 0, const String&amp; compositeOperation = emptyString());
186 
<a name="4" id="anc4"></a><span class="line-modified">187     using StyleVariant = Variant&lt;String, RefPtr&lt;CanvasGradient&gt;, RefPtr&lt;CanvasPattern&gt;&gt;;</span>
<span class="line-modified">188     StyleVariant strokeStyle() const;</span>
<span class="line-modified">189     void setStrokeStyle(StyleVariant&amp;&amp;);</span>
<span class="line-modified">190     StyleVariant fillStyle() const;</span>
<span class="line-modified">191     void setFillStyle(StyleVariant&amp;&amp;);</span>
192 
193     ExceptionOr&lt;Ref&lt;CanvasGradient&gt;&gt; createLinearGradient(float x0, float y0, float x1, float y1);
194     ExceptionOr&lt;Ref&lt;CanvasGradient&gt;&gt; createRadialGradient(float x0, float y0, float r0, float x1, float y1, float r1);
195     ExceptionOr&lt;RefPtr&lt;CanvasPattern&gt;&gt; createPattern(CanvasImageSource&amp;&amp;, const String&amp; repetition);
196 
197     RefPtr&lt;ImageData&gt; createImageData(ImageData&amp;) const;
198     ExceptionOr&lt;RefPtr&lt;ImageData&gt;&gt; createImageData(float width, float height) const;
199     ExceptionOr&lt;RefPtr&lt;ImageData&gt;&gt; getImageData(float sx, float sy, float sw, float sh) const;
200     void putImageData(ImageData&amp;, float dx, float dy);
201     void putImageData(ImageData&amp;, float dx, float dy, float dirtyX, float dirtyY, float dirtyWidth, float dirtyHeight);
202 
203     float webkitBackingStorePixelRatio() const { return 1; }
204 
205     void reset();
206 
207     LineCap getLineCap() const { return state().lineCap; }
208     LineJoin getLineJoin() const { return state().lineJoin; }
209 
210     bool imageSmoothingEnabled() const;
211     void setImageSmoothingEnabled(bool);
212 
213     ImageSmoothingQuality imageSmoothingQuality() const;
214     void setImageSmoothingQuality(ImageSmoothingQuality);
215 
216     void setPath(Path2D&amp;);
217     Ref&lt;Path2D&gt; getPath() const;
218 
219     bool usesDisplayListDrawing() const { return m_usesDisplayListDrawing; };
220     void setUsesDisplayListDrawing(bool flag) { m_usesDisplayListDrawing = flag; };
221 
222     bool tracksDisplayListReplay() const { return m_tracksDisplayListReplay; }
223     void setTracksDisplayListReplay(bool);
224 
225     String displayListAsText(DisplayList::AsTextFlags) const;
226     String replayDisplayListAsText(DisplayList::AsTextFlags) const;
227 
228     using Direction = CanvasDirection;
229 
230     class FontProxy : public FontSelectorClient {
231     public:
232         FontProxy() = default;
233         virtual ~FontProxy();
234         FontProxy(const FontProxy&amp;);
235         FontProxy&amp; operator=(const FontProxy&amp;);
236 
237         bool realized() const { return m_font.fontSelector(); }
238         void initialize(FontSelector&amp;, const RenderStyle&amp;);
239         const FontMetrics&amp; fontMetrics() const;
240         const FontCascadeDescription&amp; fontDescription() const;
241         float width(const TextRun&amp;, GlyphOverflow* = 0) const;
242         void drawBidiText(GraphicsContext&amp;, const TextRun&amp;, const FloatPoint&amp;, FontCascade::CustomFontNotReadyAction) const;
243 
244     private:
245         void update(FontSelector&amp;);
246         void fontsNeedUpdate(FontSelector&amp;) override;
247 
248         FontCascade m_font;
249     };
250 
251     struct State final {
252         State();
253 
254         State(const State&amp;);
255         State&amp; operator=(const State&amp;);
256 
257         String unparsedStrokeColor;
258         String unparsedFillColor;
259         CanvasStyle strokeStyle;
260         CanvasStyle fillStyle;
261         float lineWidth;
262         LineCap lineCap;
263         LineJoin lineJoin;
264         float miterLimit;
265         FloatSize shadowOffset;
266         float shadowBlur;
267         Color shadowColor;
268         float globalAlpha;
269         CompositeOperator globalComposite;
270         BlendMode globalBlend;
271         AffineTransform transform;
272         bool hasInvertibleTransform;
273         Vector&lt;float&gt; lineDash;
274         float lineDashOffset;
275         bool imageSmoothingEnabled;
276         ImageSmoothingQuality imageSmoothingQuality;
277 
278         // Text state.
279         TextAlign textAlign;
280         TextBaseline textBaseline;
281         Direction direction;
282 
283         String unparsedFont;
284         FontProxy font;
285     };
286 
287     const State&amp; state() const { return m_stateStack.last(); }
288     const Vector&lt;State, 1&gt;&amp; stateStack();
289 
290 protected:
291     static const int DefaultFontSize;
292     static const char* const DefaultFontFamily;
293     static const char* const DefaultFont;
294 
295     enum CanvasDidDrawOption {
296         CanvasDidDrawApplyNone = 0,
297         CanvasDidDrawApplyTransform = 1,
298         CanvasDidDrawApplyShadow = 1 &lt;&lt; 1,
299         CanvasDidDrawApplyClip = 1 &lt;&lt; 2,
300         CanvasDidDrawApplyAll = 0xffffffff
301     };
302 
303     bool isFullCanvasCompositeMode(CompositeOperator);
304 
305     State&amp; modifiableState() { ASSERT(!m_unrealizedSaveCount || m_stateStack.size() &gt;= MaxSaveCount); return m_stateStack.last(); }
306 
307     void applyLineDash() const;
308     void setShadow(const FloatSize&amp; offset, float blur, const Color&amp;);
309     void applyShadow();
310     bool shouldDrawShadows() const;
311 
312     void didDraw(const FloatRect&amp;, unsigned options = CanvasDidDrawApplyAll);
313     void didDrawEntireCanvas();
314 
315     void paintRenderingResultsToCanvas() override;
316 
317     GraphicsContext* drawingContext() const;
318 
319     void unwindStateStack();
320     void realizeSaves();
321     void realizeSavesLoop();
322 
323     void applyStrokePattern();
324     void applyFillPattern();
325 
326     void setStrokeStyle(CanvasStyle);
327     void setFillStyle(CanvasStyle);
328 
329     ExceptionOr&lt;RefPtr&lt;CanvasPattern&gt;&gt; createPattern(HTMLImageElement&amp;, bool repeatX, bool repeatY);
330     ExceptionOr&lt;RefPtr&lt;CanvasPattern&gt;&gt; createPattern(CanvasBase&amp;, bool repeatX, bool repeatY);
331 #if ENABLE(VIDEO)
332     ExceptionOr&lt;RefPtr&lt;CanvasPattern&gt;&gt; createPattern(HTMLVideoElement&amp;, bool repeatX, bool repeatY);
333 #endif
334     ExceptionOr&lt;RefPtr&lt;CanvasPattern&gt;&gt; createPattern(ImageBitmap&amp;, bool repeatX, bool repeatY);
335 #if ENABLE(CSS_TYPED_OM)
336     ExceptionOr&lt;RefPtr&lt;CanvasPattern&gt;&gt; createPattern(TypedOMCSSImageValue&amp;, bool repeatX, bool repeatY);
337 #endif
338 
339     ExceptionOr&lt;void&gt; drawImage(HTMLImageElement&amp;, const FloatRect&amp; srcRect, const FloatRect&amp; dstRect);
340     ExceptionOr&lt;void&gt; drawImage(HTMLImageElement&amp;, const FloatRect&amp; srcRect, const FloatRect&amp; dstRect, const CompositeOperator&amp;, const BlendMode&amp;);
<a name="5" id="anc5"></a><span class="line-modified">341     ExceptionOr&lt;void&gt; drawImage(CanvasBase&amp;, const FloatRect&amp; srcRect, const FloatRect&amp; dstRect);</span>
342     ExceptionOr&lt;void&gt; drawImage(Document&amp;, CachedImage*, const RenderObject*, const FloatRect&amp; imageRect, const FloatRect&amp; srcRect, const FloatRect&amp; dstRect, const CompositeOperator&amp;, const BlendMode&amp;);
343 #if ENABLE(VIDEO)
344     ExceptionOr&lt;void&gt; drawImage(HTMLVideoElement&amp;, const FloatRect&amp; srcRect, const FloatRect&amp; dstRect);
345 #endif
346 #if ENABLE(CSS_TYPED_OM)
347     ExceptionOr&lt;void&gt; drawImage(TypedOMCSSImageValue&amp;, const FloatRect&amp; srcRect, const FloatRect&amp; dstRect);
348 #endif
349     ExceptionOr&lt;void&gt; drawImage(ImageBitmap&amp;, const FloatRect&amp; srcRect, const FloatRect&amp; dstRect);
350 
351     void beginCompositeLayer();
352     void endCompositeLayer();
353 
354     void fillInternal(const Path&amp;, CanvasFillRule);
355     void strokeInternal(const Path&amp;);
356     void clipInternal(const Path&amp;, CanvasFillRule);
357 
358     bool isPointInPathInternal(const Path&amp;, float x, float y, CanvasFillRule);
359     bool isPointInStrokeInternal(const Path&amp;, float x, float y);
360 
361     void clearCanvas();
362     Path transformAreaToDevice(const Path&amp;) const;
363     Path transformAreaToDevice(const FloatRect&amp;) const;
364     bool rectContainsCanvas(const FloatRect&amp;) const;
365 
366     template&lt;class T&gt; IntRect calculateCompositingBufferRect(const T&amp;, IntSize*);
367     std::unique_ptr&lt;ImageBuffer&gt; createCompositingBuffer(const IntRect&amp;);
368     void compositeBuffer(ImageBuffer&amp;, const IntRect&amp;, CompositeOperator);
369 
370     void inflateStrokeRect(FloatRect&amp;) const;
371 
372     template&lt;class T&gt; void fullCanvasCompositedDrawImage(T&amp;, const FloatRect&amp;, const FloatRect&amp;, CompositeOperator);
373 
374     ExceptionOr&lt;RefPtr&lt;ImageData&gt;&gt; getImageData(ImageBuffer::CoordinateSystem, float sx, float sy, float sw, float sh) const;
375     void putImageData(ImageData&amp;, ImageBuffer::CoordinateSystem, float dx, float dy, float dirtyX, float dirtyY, float dirtyWidth, float dirtyHeight);
376 
377     bool isAccelerated() const override;
378 
379     bool hasInvertibleTransform() const override { return state().hasInvertibleTransform; }
380 
381 #if ENABLE(ACCELERATED_2D_CANVAS)
382     PlatformLayer* platformLayer() const override;
383 #endif
384 
385     static const unsigned MaxSaveCount = 1024 * 16;
386     Vector&lt;State, 1&gt; m_stateStack;
387     unsigned m_unrealizedSaveCount { 0 };
388     bool m_usesCSSCompatibilityParseMode;
389     bool m_usesDisplayListDrawing { false };
390     bool m_tracksDisplayListReplay { false };
391     mutable std::unique_ptr&lt;struct DisplayListDrawingContext&gt; m_recordingContext;
392 };
393 
394 } // namespace WebCore
395 
<a name="6" id="anc6"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="6" type="hidden" />
</body>
</html>