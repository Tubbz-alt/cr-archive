<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WebCore/page/CaptionUserPreferencesMediaAF.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="CacheStorageProvider.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="Chrome.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/page/CaptionUserPreferencesMediaAF.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
334 }
335 
336 static void appendCSS(StringBuilder&amp; builder, CSSPropertyID id, const String&amp; value, bool important)
337 {
338     builder.append(getPropertyNameString(id));
339     builder.append(&#39;:&#39;);
340     builder.append(value);
341     if (important)
342         builder.appendLiteral(&quot; !important&quot;);
343     builder.append(&#39;;&#39;);
344 }
345 
346 String CaptionUserPreferencesMediaAF::windowRoundedCornerRadiusCSS() const
347 {
348     MACaptionAppearanceBehavior behavior;
349     CGFloat radius = MACaptionAppearanceGetWindowRoundedCornerRadius(kMACaptionAppearanceDomainUser, &amp;behavior);
350     if (!radius)
351         return emptyString();
352 
353     StringBuilder builder;
<span class="line-modified">354     appendCSS(builder, CSSPropertyBorderRadius, makeString(FormattedNumber::fixedWidth(radius, 2), &quot;px&quot;), behavior == kMACaptionAppearanceBehaviorUseValue);</span>
355     return builder.toString();
356 }
357 
358 String CaptionUserPreferencesMediaAF::colorPropertyCSS(CSSPropertyID id, const Color&amp; color, bool important) const
359 {
360     StringBuilder builder;
361     appendCSS(builder, id, color.serialized(), important);
362     return builder.toString();
363 }
364 
365 bool CaptionUserPreferencesMediaAF::captionStrokeWidthForFont(float fontSize, const String&amp; language, float&amp; strokeWidth, bool&amp; important) const
366 {
367     if (!canLoad_MediaAccessibility_MACaptionAppearanceCopyFontDescriptorWithStrokeForStyle())
368         return false;
369 
370     MACaptionAppearanceBehavior behavior;
371     auto trackLanguage = language.createCFString();
372     CGFloat strokeWidthPt;
373 
374     auto fontDescriptor = adoptCF(MACaptionAppearanceCopyFontDescriptorWithStrokeForStyle(kMACaptionAppearanceDomainUser, &amp;behavior, kMACaptionAppearanceFontStyleDefault, trackLanguage.get(), fontSize, &amp;strokeWidthPt));
</pre>
<hr />
<pre>
570         captionsOverrideStyleSheet.appendLiteral(&quot; ::&quot;);
571         captionsOverrideStyleSheet.append(TextTrackCue::cueShadowPseudoId());
572         captionsOverrideStyleSheet.append(&#39;{&#39;);
573 
574         if (!background.isEmpty())
575             captionsOverrideStyleSheet.append(background);
576         if (!captionsColor.isEmpty())
577             captionsOverrideStyleSheet.append(captionsColor);
578         if (!edgeStyle.isEmpty())
579             captionsOverrideStyleSheet.append(edgeStyle);
580         if (!fontName.isEmpty())
581             captionsOverrideStyleSheet.append(fontName);
582 
583         captionsOverrideStyleSheet.append(&#39;}&#39;);
584     }
585 
586     String windowColor = captionsWindowCSS();
587     String windowCornerRadius = windowRoundedCornerRadiusCSS();
588     if (!windowColor.isEmpty() || !windowCornerRadius.isEmpty()) {
589         captionsOverrideStyleSheet.appendLiteral(&quot; ::&quot;);
<span class="line-modified">590         captionsOverrideStyleSheet.append(VTTCue::cueBackdropShadowPseudoId());</span>
591         captionsOverrideStyleSheet.append(&#39;{&#39;);
592 
593         if (!windowColor.isEmpty())
594             captionsOverrideStyleSheet.append(windowColor);
595         if (!windowCornerRadius.isEmpty()) {
596             captionsOverrideStyleSheet.append(windowCornerRadius);
597         }
598 
599         captionsOverrideStyleSheet.append(&#39;}&#39;);
600     }
601 #endif // HAVE(MEDIA_ACCESSIBILITY_FRAMEWORK)
602 
603     LOG(Media, &quot;CaptionUserPreferencesMediaAF::captionsStyleSheetOverrideSetting style to:\n%s&quot;, captionsOverrideStyleSheet.toString().utf8().data());
604 
605     return captionsOverrideStyleSheet.toString();
606 }
607 
608 static String languageIdentifier(const String&amp; languageCode)
609 {
610     if (languageCode.isEmpty())
</pre>
<hr />
<pre>
824     // Tracks not in the user&#39;s preferred language sort first by language ...
825     if (codePointCompare(aLanguageDisplayName, bLanguageDisplayName))
826         return codePointCompare(aLanguageDisplayName, bLanguageDisplayName) &lt; 0;
827 
828     // ... but when tracks have the same language, main program content sorts next highest ...
829     bool aIsMainContent = a-&gt;isMainProgramContent();
830     bool bIsMainContent = b-&gt;isMainProgramContent();
831     if ((aIsMainContent || bIsMainContent) &amp;&amp; (aIsMainContent != bIsMainContent))
832         return aIsMainContent;
833 
834     // ... and main program trakcs sort higher than CC tracks ...
835     bool aIsCC = a-&gt;isClosedCaptions();
836     bool bIsCC = b-&gt;isClosedCaptions();
837     if ((aIsCC || bIsCC) &amp;&amp; (aIsCC != bIsCC)) {
838         if (aIsCC)
839             return aIsMainContent;
840         return bIsMainContent;
841     }
842 
843     // ... and tracks of the same type and language sort by the menu item text.
<span class="line-modified">844     return codePointCompare(trackDisplayName(a.get()), trackDisplayName(b.get())) &lt; 0;</span>





845 }
846 
847 Vector&lt;RefPtr&lt;AudioTrack&gt;&gt; CaptionUserPreferencesMediaAF::sortedTrackListForMenu(AudioTrackList* trackList)
848 {
849     ASSERT(trackList);
850 
851     Vector&lt;RefPtr&lt;AudioTrack&gt;&gt; tracksForMenu;
852 
853     for (unsigned i = 0, length = trackList-&gt;length(); i &lt; length; ++i) {
854         AudioTrack* track = trackList-&gt;item(i);
855         String language = displayNameForLanguageLocale(track-&gt;validBCP47Language());
856         tracksForMenu.append(track);
857     }
858 
859     std::sort(tracksForMenu.begin(), tracksForMenu.end(), [](auto&amp; a, auto&amp; b) {
<span class="line-modified">860         return codePointCompare(trackDisplayName(a.get()), trackDisplayName(b.get())) &lt; 0;</span>




861     });
862 
863     return tracksForMenu;
864 }
865 
866 Vector&lt;RefPtr&lt;TextTrack&gt;&gt; CaptionUserPreferencesMediaAF::sortedTrackListForMenu(TextTrackList* trackList)
867 {
868     ASSERT(trackList);
869 
870     Vector&lt;RefPtr&lt;TextTrack&gt;&gt; tracksForMenu;
871     HashSet&lt;String&gt; languagesIncluded;
872     CaptionDisplayMode displayMode = captionDisplayMode();
873     bool prefersAccessibilityTracks = userPrefersCaptions();
874     bool filterTrackList = shouldFilterTrackMenu();
875 
876     for (unsigned i = 0, length = trackList-&gt;length(); i &lt; length; ++i) {
877         TextTrack* track = trackList-&gt;item(i);
878         String language = displayNameForLanguageLocale(track-&gt;validBCP47Language());
879 
880         if (displayMode == Manual) {
</pre>
</td>
<td>
<hr />
<pre>
334 }
335 
336 static void appendCSS(StringBuilder&amp; builder, CSSPropertyID id, const String&amp; value, bool important)
337 {
338     builder.append(getPropertyNameString(id));
339     builder.append(&#39;:&#39;);
340     builder.append(value);
341     if (important)
342         builder.appendLiteral(&quot; !important&quot;);
343     builder.append(&#39;;&#39;);
344 }
345 
346 String CaptionUserPreferencesMediaAF::windowRoundedCornerRadiusCSS() const
347 {
348     MACaptionAppearanceBehavior behavior;
349     CGFloat radius = MACaptionAppearanceGetWindowRoundedCornerRadius(kMACaptionAppearanceDomainUser, &amp;behavior);
350     if (!radius)
351         return emptyString();
352 
353     StringBuilder builder;
<span class="line-modified">354     appendCSS(builder, CSSPropertyBorderRadius, makeString(radius, &quot;px&quot;), behavior == kMACaptionAppearanceBehaviorUseValue);</span>
355     return builder.toString();
356 }
357 
358 String CaptionUserPreferencesMediaAF::colorPropertyCSS(CSSPropertyID id, const Color&amp; color, bool important) const
359 {
360     StringBuilder builder;
361     appendCSS(builder, id, color.serialized(), important);
362     return builder.toString();
363 }
364 
365 bool CaptionUserPreferencesMediaAF::captionStrokeWidthForFont(float fontSize, const String&amp; language, float&amp; strokeWidth, bool&amp; important) const
366 {
367     if (!canLoad_MediaAccessibility_MACaptionAppearanceCopyFontDescriptorWithStrokeForStyle())
368         return false;
369 
370     MACaptionAppearanceBehavior behavior;
371     auto trackLanguage = language.createCFString();
372     CGFloat strokeWidthPt;
373 
374     auto fontDescriptor = adoptCF(MACaptionAppearanceCopyFontDescriptorWithStrokeForStyle(kMACaptionAppearanceDomainUser, &amp;behavior, kMACaptionAppearanceFontStyleDefault, trackLanguage.get(), fontSize, &amp;strokeWidthPt));
</pre>
<hr />
<pre>
570         captionsOverrideStyleSheet.appendLiteral(&quot; ::&quot;);
571         captionsOverrideStyleSheet.append(TextTrackCue::cueShadowPseudoId());
572         captionsOverrideStyleSheet.append(&#39;{&#39;);
573 
574         if (!background.isEmpty())
575             captionsOverrideStyleSheet.append(background);
576         if (!captionsColor.isEmpty())
577             captionsOverrideStyleSheet.append(captionsColor);
578         if (!edgeStyle.isEmpty())
579             captionsOverrideStyleSheet.append(edgeStyle);
580         if (!fontName.isEmpty())
581             captionsOverrideStyleSheet.append(fontName);
582 
583         captionsOverrideStyleSheet.append(&#39;}&#39;);
584     }
585 
586     String windowColor = captionsWindowCSS();
587     String windowCornerRadius = windowRoundedCornerRadiusCSS();
588     if (!windowColor.isEmpty() || !windowCornerRadius.isEmpty()) {
589         captionsOverrideStyleSheet.appendLiteral(&quot; ::&quot;);
<span class="line-modified">590         captionsOverrideStyleSheet.append(TextTrackCue::cueBackdropShadowPseudoId());</span>
591         captionsOverrideStyleSheet.append(&#39;{&#39;);
592 
593         if (!windowColor.isEmpty())
594             captionsOverrideStyleSheet.append(windowColor);
595         if (!windowCornerRadius.isEmpty()) {
596             captionsOverrideStyleSheet.append(windowCornerRadius);
597         }
598 
599         captionsOverrideStyleSheet.append(&#39;}&#39;);
600     }
601 #endif // HAVE(MEDIA_ACCESSIBILITY_FRAMEWORK)
602 
603     LOG(Media, &quot;CaptionUserPreferencesMediaAF::captionsStyleSheetOverrideSetting style to:\n%s&quot;, captionsOverrideStyleSheet.toString().utf8().data());
604 
605     return captionsOverrideStyleSheet.toString();
606 }
607 
608 static String languageIdentifier(const String&amp; languageCode)
609 {
610     if (languageCode.isEmpty())
</pre>
<hr />
<pre>
824     // Tracks not in the user&#39;s preferred language sort first by language ...
825     if (codePointCompare(aLanguageDisplayName, bLanguageDisplayName))
826         return codePointCompare(aLanguageDisplayName, bLanguageDisplayName) &lt; 0;
827 
828     // ... but when tracks have the same language, main program content sorts next highest ...
829     bool aIsMainContent = a-&gt;isMainProgramContent();
830     bool bIsMainContent = b-&gt;isMainProgramContent();
831     if ((aIsMainContent || bIsMainContent) &amp;&amp; (aIsMainContent != bIsMainContent))
832         return aIsMainContent;
833 
834     // ... and main program trakcs sort higher than CC tracks ...
835     bool aIsCC = a-&gt;isClosedCaptions();
836     bool bIsCC = b-&gt;isClosedCaptions();
837     if ((aIsCC || bIsCC) &amp;&amp; (aIsCC != bIsCC)) {
838         if (aIsCC)
839             return aIsMainContent;
840         return bIsMainContent;
841     }
842 
843     // ... and tracks of the same type and language sort by the menu item text.
<span class="line-modified">844     auto trackDisplayComparison = codePointCompare(trackDisplayName(a.get()), trackDisplayName(b.get()));</span>
<span class="line-added">845     if (trackDisplayComparison)</span>
<span class="line-added">846         return trackDisplayComparison &lt; 0;</span>
<span class="line-added">847 </span>
<span class="line-added">848     // ... and if the menu item text is the same, compare the unique IDs</span>
<span class="line-added">849     return a-&gt;uniqueId() &lt; b-&gt;uniqueId();</span>
850 }
851 
852 Vector&lt;RefPtr&lt;AudioTrack&gt;&gt; CaptionUserPreferencesMediaAF::sortedTrackListForMenu(AudioTrackList* trackList)
853 {
854     ASSERT(trackList);
855 
856     Vector&lt;RefPtr&lt;AudioTrack&gt;&gt; tracksForMenu;
857 
858     for (unsigned i = 0, length = trackList-&gt;length(); i &lt; length; ++i) {
859         AudioTrack* track = trackList-&gt;item(i);
860         String language = displayNameForLanguageLocale(track-&gt;validBCP47Language());
861         tracksForMenu.append(track);
862     }
863 
864     std::sort(tracksForMenu.begin(), tracksForMenu.end(), [](auto&amp; a, auto&amp; b) {
<span class="line-modified">865         auto trackDisplayComparison = codePointCompare(trackDisplayName(a.get()), trackDisplayName(b.get()));</span>
<span class="line-added">866         if (trackDisplayComparison)</span>
<span class="line-added">867             return trackDisplayComparison &lt; 0;</span>
<span class="line-added">868 </span>
<span class="line-added">869         return a-&gt;uniqueId() &lt; b-&gt;uniqueId();</span>
870     });
871 
872     return tracksForMenu;
873 }
874 
875 Vector&lt;RefPtr&lt;TextTrack&gt;&gt; CaptionUserPreferencesMediaAF::sortedTrackListForMenu(TextTrackList* trackList)
876 {
877     ASSERT(trackList);
878 
879     Vector&lt;RefPtr&lt;TextTrack&gt;&gt; tracksForMenu;
880     HashSet&lt;String&gt; languagesIncluded;
881     CaptionDisplayMode displayMode = captionDisplayMode();
882     bool prefersAccessibilityTracks = userPrefersCaptions();
883     bool filterTrackList = shouldFilterTrackMenu();
884 
885     for (unsigned i = 0, length = trackList-&gt;length(); i &lt; length; ++i) {
886         TextTrack* track = trackList-&gt;item(i);
887         String language = displayNameForLanguageLocale(track-&gt;validBCP47Language());
888 
889         if (displayMode == Manual) {
</pre>
</td>
</tr>
</table>
<center><a href="CacheStorageProvider.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="Chrome.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>