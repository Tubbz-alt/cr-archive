<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.web/src/main/native/Source/WebCore/Modules/fetch/FetchHeaders.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="FetchBodySource.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="FetchHeaders.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/Modules/fetch/FetchHeaders.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 31,10 ***</span>
<span class="line-new-header">--- 31,16 ---</span>
  
  #include &quot;HTTPParsers.h&quot;
  
  namespace WebCore {
  
<span class="line-added">+ // https://fetch.spec.whatwg.org/#concept-headers-remove-privileged-no-cors-request-headers</span>
<span class="line-added">+ static void removePrivilegedNoCORSRequestHeaders(HTTPHeaderMap&amp; headers)</span>
<span class="line-added">+ {</span>
<span class="line-added">+     headers.remove(HTTPHeaderName::Range);</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
  static ExceptionOr&lt;bool&gt; canWriteHeader(const String&amp; name, const String&amp; value, const String&amp; combinedValue, FetchHeaders::Guard guard)
  {
      if (!isValidHTTPToken(name))
          return Exception { TypeError, makeString(&quot;Invalid header name: &#39;&quot;, name, &quot;&#39;&quot;) };
      if (!isValidHTTPHeaderValue(value))
</pre>
<hr />
<pre>
<span class="line-old-header">*** 60,10 ***</span>
<span class="line-new-header">--- 66,14 ---</span>
      if (canWriteResult.hasException())
          return canWriteResult.releaseException();
      if (!canWriteResult.releaseReturnValue())
          return { };
      headers.set(name, combinedValue);
<span class="line-added">+ </span>
<span class="line-added">+     if (guard == FetchHeaders::Guard::RequestNoCors)</span>
<span class="line-added">+         removePrivilegedNoCORSRequestHeaders(headers);</span>
<span class="line-added">+ </span>
      return { };
  }
  
  static ExceptionOr&lt;void&gt; appendToHeaderMap(const HTTPHeaderMap::HTTPHeaderMapConstIterator::KeyValue&amp; header, HTTPHeaderMap&amp; headers, FetchHeaders::Guard guard)
  {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 74,10 ***</span>
<span class="line-new-header">--- 84,14 ---</span>
          return { };
      if (header.keyAsHTTPHeaderName)
          headers.add(header.keyAsHTTPHeaderName.value(), header.value);
      else
          headers.add(header.key, header.value);
<span class="line-added">+ </span>
<span class="line-added">+     if (guard == FetchHeaders::Guard::RequestNoCors)</span>
<span class="line-added">+         removePrivilegedNoCORSRequestHeaders(headers);</span>
<span class="line-added">+ </span>
      return { };
  }
  
  // https://fetch.spec.whatwg.org/#concept-headers-fill
  static ExceptionOr&lt;void&gt; fillHeaderMap(HTTPHeaderMap&amp; headers, const FetchHeaders::Init&amp; headersInit, FetchHeaders::Guard guard)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 135,18 ***</span>
  ExceptionOr&lt;void&gt; FetchHeaders::append(const String&amp; name, const String&amp; value)
  {
      return appendToHeaderMap(name, value, m_headers, m_guard);
  }
  
  ExceptionOr&lt;void&gt; FetchHeaders::remove(const String&amp; name)
  {
<span class="line-modified">!     auto canWriteResult = canWriteHeader(name, { }, { }, m_guard);</span>
<span class="line-modified">!     if (canWriteResult.hasException())</span>
<span class="line-modified">!         return canWriteResult.releaseException();</span>
<span class="line-modified">!     if (!canWriteResult.releaseReturnValue())</span>
          return { };
      m_headers.remove(name);
      return { };
  }
  
  ExceptionOr&lt;String&gt; FetchHeaders::get(const String&amp; name) const
  {
<span class="line-new-header">--- 149,29 ---</span>
  ExceptionOr&lt;void&gt; FetchHeaders::append(const String&amp; name, const String&amp; value)
  {
      return appendToHeaderMap(name, value, m_headers, m_guard);
  }
  
<span class="line-added">+ // https://fetch.spec.whatwg.org/#dom-headers-delete</span>
  ExceptionOr&lt;void&gt; FetchHeaders::remove(const String&amp; name)
  {
<span class="line-modified">!     if (!isValidHTTPToken(name))</span>
<span class="line-modified">!         return Exception { TypeError, makeString(&quot;Invalid header name: &#39;&quot;, name, &quot;&#39;&quot;) };</span>
<span class="line-modified">!     if (m_guard == FetchHeaders::Guard::Immutable)</span>
<span class="line-modified">!         return Exception { TypeError, &quot;Headers object&#39;s guard is &#39;immutable&#39;&quot;_s };</span>
<span class="line-added">+     if (m_guard == FetchHeaders::Guard::Request &amp;&amp; isForbiddenHeaderName(name))</span>
<span class="line-added">+         return { };</span>
<span class="line-added">+     if (m_guard == FetchHeaders::Guard::RequestNoCors &amp;&amp; !isNoCORSSafelistedRequestHeaderName(name) &amp;&amp; !isPriviledgedNoCORSRequestHeaderName(name))</span>
          return { };
<span class="line-added">+     if (m_guard == FetchHeaders::Guard::Response &amp;&amp; isForbiddenResponseHeaderName(name))</span>
<span class="line-added">+         return { };</span>
<span class="line-added">+ </span>
      m_headers.remove(name);
<span class="line-added">+ </span>
<span class="line-added">+     if (m_guard == FetchHeaders::Guard::RequestNoCors)</span>
<span class="line-added">+         removePrivilegedNoCORSRequestHeaders(m_headers);</span>
<span class="line-added">+ </span>
      return { };
  }
  
  ExceptionOr&lt;String&gt; FetchHeaders::get(const String&amp; name) const
  {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 168,11 ***</span>
<span class="line-new-header">--- 193,16 ---</span>
      auto canWriteResult = canWriteHeader(name, normalizedValue, normalizedValue, m_guard);
      if (canWriteResult.hasException())
          return canWriteResult.releaseException();
      if (!canWriteResult.releaseReturnValue())
          return { };
<span class="line-added">+ </span>
      m_headers.set(name, normalizedValue);
<span class="line-added">+ </span>
<span class="line-added">+     if (m_guard == FetchHeaders::Guard::RequestNoCors)</span>
<span class="line-added">+         removePrivilegedNoCORSRequestHeaders(m_headers);</span>
<span class="line-added">+ </span>
      return { };
  }
  
  void FetchHeaders::filterAndFill(const HTTPHeaderMap&amp; headers, Guard guard)
  {
</pre>
<center><a href="FetchBodySource.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="FetchHeaders.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>