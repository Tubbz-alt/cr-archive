<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WebCore/Modules/mediastream/PeerConnectionBackend.h</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="PeerConnectionBackend.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="RTCDTMFSender.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/Modules/mediastream/PeerConnectionBackend.h</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 16  *    may be used to endorse or promote products derived from this
 17  *    software without specific prior written permission.
 18  *
 19  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 20  * &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 21  * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 22  * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 23  * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 24  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 25  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 26  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 27  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 28  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 29  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 30  */
 31 
 32 #pragma once
 33 
 34 #if ENABLE(WEB_RTC)
 35 
<span class="line-modified"> 36 #include &quot;JSDOMPromiseDeferred.h&quot;</span>
 37 #include &quot;LibWebRTCProvider.h&quot;
 38 #include &quot;RTCRtpSendParameters.h&quot;
 39 #include &quot;RTCSessionDescription.h&quot;
 40 #include &quot;RTCSignalingState.h&quot;
 41 #include &lt;wtf/LoggerHelper.h&gt;
 42 #include &lt;wtf/WeakPtr.h&gt;
 43 
 44 namespace WebCore {
 45 

 46 class Document;
 47 class MediaStream;
 48 class MediaStreamTrack;
 49 class PeerConnectionBackend;
 50 class RTCCertificate;
 51 class RTCDataChannelHandler;
 52 class RTCIceCandidate;
 53 class RTCPeerConnection;
 54 class RTCRtpReceiver;
 55 class RTCRtpSender;
 56 class RTCRtpTransceiver;
 57 class RTCSessionDescription;
 58 class RTCStatsReport;

 59 
 60 struct MediaEndpointConfiguration;
 61 struct RTCAnswerOptions;
 62 struct RTCDataChannelInit;
 63 struct RTCOfferOptions;
 64 struct RTCRtpTransceiverInit;
 65 


 66 namespace PeerConnection {
 67 using SessionDescriptionPromise = DOMPromiseDeferred&lt;IDLDictionary&lt;RTCSessionDescription::Init&gt;&gt;;
 68 using StatsPromise = DOMPromiseDeferred&lt;IDLInterface&lt;RTCStatsReport&gt;&gt;;
 69 }
 70 
 71 using CreatePeerConnectionBackend = std::unique_ptr&lt;PeerConnectionBackend&gt; (*)(RTCPeerConnection&amp;);
 72 
 73 class PeerConnectionBackend
 74     : public CanMakeWeakPtr&lt;PeerConnectionBackend&gt;
 75 #if !RELEASE_LOG_DISABLED
 76     , private LoggerHelper
 77 #endif
 78 {
 79 public:
 80     WEBCORE_EXPORT static CreatePeerConnectionBackend create;
 81 
 82     static Optional&lt;RTCRtpCapabilities&gt; receiverCapabilities(ScriptExecutionContext&amp;, const String&amp; kind);
 83     static Optional&lt;RTCRtpCapabilities&gt; senderCapabilities(ScriptExecutionContext&amp;, const String&amp; kind);
 84 
 85     explicit PeerConnectionBackend(RTCPeerConnection&amp;);
<span class="line-modified"> 86     virtual ~PeerConnectionBackend() = default;</span>
 87 
 88     void createOffer(RTCOfferOptions&amp;&amp;, PeerConnection::SessionDescriptionPromise&amp;&amp;);
 89     void createAnswer(RTCAnswerOptions&amp;&amp;, PeerConnection::SessionDescriptionPromise&amp;&amp;);
 90     void setLocalDescription(RTCSessionDescription&amp;, DOMPromiseDeferred&lt;void&gt;&amp;&amp;);
 91     void setRemoteDescription(RTCSessionDescription&amp;, DOMPromiseDeferred&lt;void&gt;&amp;&amp;);
 92     void addIceCandidate(RTCIceCandidate*, DOMPromiseDeferred&lt;void&gt;&amp;&amp;);
 93 
 94     virtual std::unique_ptr&lt;RTCDataChannelHandler&gt; createDataChannelHandler(const String&amp;, const RTCDataChannelInit&amp;) = 0;
 95 
 96     void stop();
 97 


 98     virtual RefPtr&lt;RTCSessionDescription&gt; localDescription() const = 0;
 99     virtual RefPtr&lt;RTCSessionDescription&gt; currentLocalDescription() const = 0;
100     virtual RefPtr&lt;RTCSessionDescription&gt; pendingLocalDescription() const = 0;
101 
102     virtual RefPtr&lt;RTCSessionDescription&gt; remoteDescription() const = 0;
103     virtual RefPtr&lt;RTCSessionDescription&gt; currentRemoteDescription() const = 0;
104     virtual RefPtr&lt;RTCSessionDescription&gt; pendingRemoteDescription() const = 0;
105 
106     virtual bool setConfiguration(MediaEndpointConfiguration&amp;&amp;) = 0;
107 
108     virtual void getStats(Ref&lt;DeferredPromise&gt;&amp;&amp;) = 0;
109     virtual void getStats(RTCRtpSender&amp;, Ref&lt;DeferredPromise&gt;&amp;&amp;) = 0;
110     virtual void getStats(RTCRtpReceiver&amp;, Ref&lt;DeferredPromise&gt;&amp;&amp;) = 0;
111 
112     virtual ExceptionOr&lt;Ref&lt;RTCRtpSender&gt;&gt; addTrack(MediaStreamTrack&amp;, Vector&lt;String&gt;&amp;&amp;);
113     virtual void removeTrack(RTCRtpSender&amp;) { }
114 
115     virtual ExceptionOr&lt;Ref&lt;RTCRtpTransceiver&gt;&gt; addTransceiver(const String&amp;, const RTCRtpTransceiverInit&amp;);
116     virtual ExceptionOr&lt;Ref&lt;RTCRtpTransceiver&gt;&gt; addTransceiver(Ref&lt;MediaStreamTrack&gt;&amp;&amp;, const RTCRtpTransceiverInit&amp;);
117 
</pre>
<hr />
<pre>
155             return CertificateInformation { Type::ECDSAP256 };
156         }
157 
158         explicit CertificateInformation(Type type)
159             : type(type)
160         {
161         }
162 
163         Type type;
164         Optional&lt;double&gt; expires;
165 
166         Optional&lt;RSA&gt; rsaParameters;
167     };
168     static void generateCertificate(Document&amp;, const CertificateInformation&amp;, DOMPromiseDeferred&lt;IDLInterface&lt;RTCCertificate&gt;&gt;&amp;&amp;);
169 
170     virtual void collectTransceivers() { };
171 
172     ScriptExecutionContext* context() const;
173     RTCRtpTransceiver* transceiverFromSender(const RTCRtpSender&amp;);
174 



175 protected:
176     void fireICECandidateEvent(RefPtr&lt;RTCIceCandidate&gt;&amp;&amp;, String&amp;&amp; url);
177     void doneGatheringCandidates();
178 
179     void updateSignalingState(RTCSignalingState);
180 
181     void createOfferSucceeded(String&amp;&amp;);
182     void createOfferFailed(Exception&amp;&amp;);
183 
184     void createAnswerSucceeded(String&amp;&amp;);
185     void createAnswerFailed(Exception&amp;&amp;);
186 
187     void setLocalDescriptionSucceeded();
188     void setLocalDescriptionFailed(Exception&amp;&amp;);
189 
190     void setRemoteDescriptionSucceeded();
191     void setRemoteDescriptionFailed(Exception&amp;&amp;);
192 
193     void addIceCandidateSucceeded();
194     void addIceCandidateFailed(Exception&amp;&amp;);
195 
196     String filterSDP(String&amp;&amp;) const;
197 
198     struct PendingTrackEvent {
199         Ref&lt;RTCRtpReceiver&gt; receiver;
200         Ref&lt;MediaStreamTrack&gt; track;
201         Vector&lt;RefPtr&lt;MediaStream&gt;&gt; streams;
202         RefPtr&lt;RTCRtpTransceiver&gt; transceiver;
203     };
204     void addPendingTrackEvent(PendingTrackEvent&amp;&amp;);
205 
206 private:
207     virtual void doCreateOffer(RTCOfferOptions&amp;&amp;) = 0;
208     virtual void doCreateAnswer(RTCAnswerOptions&amp;&amp;) = 0;
209     virtual void doSetLocalDescription(RTCSessionDescription&amp;) = 0;
210     virtual void doSetRemoteDescription(RTCSessionDescription&amp;) = 0;
211     virtual void doAddIceCandidate(RTCIceCandidate&amp;) = 0;
<span class="line-modified">212     virtual void endOfIceCandidates(DOMPromiseDeferred&lt;void&gt;&amp;&amp; promise) { promise.resolve(); }</span>
213     virtual void doStop() = 0;
214 
215     void registerMDNSName(const String&amp; ipAddress);
216 
217 protected:
218     RTCPeerConnection&amp; m_peerConnection;
219 
220 private:
<span class="line-modified">221     Optional&lt;PeerConnection::SessionDescriptionPromise&gt; m_offerAnswerPromise;</span>
<span class="line-modified">222     Optional&lt;DOMPromiseDeferred&lt;void&gt;&gt; m_setDescriptionPromise;</span>
<span class="line-modified">223     Optional&lt;DOMPromiseDeferred&lt;void&gt;&gt; m_addIceCandidatePromise;</span>
224 
225     bool m_shouldFilterICECandidates { true };
226     struct PendingICECandidate {
227         // Fields described in https://www.w3.org/TR/webrtc/#idl-def-rtcicecandidateinit.
228         String sdp;
229         String mid;
230         unsigned short sdpMLineIndex;
231         String serverURL;
232     };
233     Vector&lt;PendingICECandidate&gt; m_pendingICECandidates;
234 
235     Vector&lt;PendingTrackEvent&gt; m_pendingTrackEvents;
236 
237 #if !RELEASE_LOG_DISABLED
238     Ref&lt;const Logger&gt; m_logger;
239     const void* m_logIdentifier;
240 #endif
241     bool m_negotiationNeeded { false };
242     bool m_finishedGatheringCandidates { false };
243     uint64_t m_waitingForMDNSRegistration { 0 };
</pre>
</td>
<td>
<hr />
<pre>
 16  *    may be used to endorse or promote products derived from this
 17  *    software without specific prior written permission.
 18  *
 19  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 20  * &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 21  * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 22  * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 23  * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 24  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 25  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 26  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 27  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 28  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 29  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 30  */
 31 
 32 #pragma once
 33 
 34 #if ENABLE(WEB_RTC)
 35 
<span class="line-modified"> 36 #include &quot;IDLTypes.h&quot;</span>
 37 #include &quot;LibWebRTCProvider.h&quot;
 38 #include &quot;RTCRtpSendParameters.h&quot;
 39 #include &quot;RTCSessionDescription.h&quot;
 40 #include &quot;RTCSignalingState.h&quot;
 41 #include &lt;wtf/LoggerHelper.h&gt;
 42 #include &lt;wtf/WeakPtr.h&gt;
 43 
 44 namespace WebCore {
 45 
<span class="line-added"> 46 class DeferredPromise;</span>
 47 class Document;
 48 class MediaStream;
 49 class MediaStreamTrack;
 50 class PeerConnectionBackend;
 51 class RTCCertificate;
 52 class RTCDataChannelHandler;
 53 class RTCIceCandidate;
 54 class RTCPeerConnection;
 55 class RTCRtpReceiver;
 56 class RTCRtpSender;
 57 class RTCRtpTransceiver;
 58 class RTCSessionDescription;
 59 class RTCStatsReport;
<span class="line-added"> 60 class ScriptExecutionContext;</span>
 61 
 62 struct MediaEndpointConfiguration;
 63 struct RTCAnswerOptions;
 64 struct RTCDataChannelInit;
 65 struct RTCOfferOptions;
 66 struct RTCRtpTransceiverInit;
 67 
<span class="line-added"> 68 template&lt;typename IDLType&gt; class DOMPromiseDeferred;</span>
<span class="line-added"> 69 </span>
 70 namespace PeerConnection {
 71 using SessionDescriptionPromise = DOMPromiseDeferred&lt;IDLDictionary&lt;RTCSessionDescription::Init&gt;&gt;;
 72 using StatsPromise = DOMPromiseDeferred&lt;IDLInterface&lt;RTCStatsReport&gt;&gt;;
 73 }
 74 
 75 using CreatePeerConnectionBackend = std::unique_ptr&lt;PeerConnectionBackend&gt; (*)(RTCPeerConnection&amp;);
 76 
 77 class PeerConnectionBackend
 78     : public CanMakeWeakPtr&lt;PeerConnectionBackend&gt;
 79 #if !RELEASE_LOG_DISABLED
 80     , private LoggerHelper
 81 #endif
 82 {
 83 public:
 84     WEBCORE_EXPORT static CreatePeerConnectionBackend create;
 85 
 86     static Optional&lt;RTCRtpCapabilities&gt; receiverCapabilities(ScriptExecutionContext&amp;, const String&amp; kind);
 87     static Optional&lt;RTCRtpCapabilities&gt; senderCapabilities(ScriptExecutionContext&amp;, const String&amp; kind);
 88 
 89     explicit PeerConnectionBackend(RTCPeerConnection&amp;);
<span class="line-modified"> 90     virtual ~PeerConnectionBackend();</span>
 91 
 92     void createOffer(RTCOfferOptions&amp;&amp;, PeerConnection::SessionDescriptionPromise&amp;&amp;);
 93     void createAnswer(RTCAnswerOptions&amp;&amp;, PeerConnection::SessionDescriptionPromise&amp;&amp;);
 94     void setLocalDescription(RTCSessionDescription&amp;, DOMPromiseDeferred&lt;void&gt;&amp;&amp;);
 95     void setRemoteDescription(RTCSessionDescription&amp;, DOMPromiseDeferred&lt;void&gt;&amp;&amp;);
 96     void addIceCandidate(RTCIceCandidate*, DOMPromiseDeferred&lt;void&gt;&amp;&amp;);
 97 
 98     virtual std::unique_ptr&lt;RTCDataChannelHandler&gt; createDataChannelHandler(const String&amp;, const RTCDataChannelInit&amp;) = 0;
 99 
100     void stop();
101 
<span class="line-added">102     virtual void close() = 0;</span>
<span class="line-added">103 </span>
104     virtual RefPtr&lt;RTCSessionDescription&gt; localDescription() const = 0;
105     virtual RefPtr&lt;RTCSessionDescription&gt; currentLocalDescription() const = 0;
106     virtual RefPtr&lt;RTCSessionDescription&gt; pendingLocalDescription() const = 0;
107 
108     virtual RefPtr&lt;RTCSessionDescription&gt; remoteDescription() const = 0;
109     virtual RefPtr&lt;RTCSessionDescription&gt; currentRemoteDescription() const = 0;
110     virtual RefPtr&lt;RTCSessionDescription&gt; pendingRemoteDescription() const = 0;
111 
112     virtual bool setConfiguration(MediaEndpointConfiguration&amp;&amp;) = 0;
113 
114     virtual void getStats(Ref&lt;DeferredPromise&gt;&amp;&amp;) = 0;
115     virtual void getStats(RTCRtpSender&amp;, Ref&lt;DeferredPromise&gt;&amp;&amp;) = 0;
116     virtual void getStats(RTCRtpReceiver&amp;, Ref&lt;DeferredPromise&gt;&amp;&amp;) = 0;
117 
118     virtual ExceptionOr&lt;Ref&lt;RTCRtpSender&gt;&gt; addTrack(MediaStreamTrack&amp;, Vector&lt;String&gt;&amp;&amp;);
119     virtual void removeTrack(RTCRtpSender&amp;) { }
120 
121     virtual ExceptionOr&lt;Ref&lt;RTCRtpTransceiver&gt;&gt; addTransceiver(const String&amp;, const RTCRtpTransceiverInit&amp;);
122     virtual ExceptionOr&lt;Ref&lt;RTCRtpTransceiver&gt;&gt; addTransceiver(Ref&lt;MediaStreamTrack&gt;&amp;&amp;, const RTCRtpTransceiverInit&amp;);
123 
</pre>
<hr />
<pre>
161             return CertificateInformation { Type::ECDSAP256 };
162         }
163 
164         explicit CertificateInformation(Type type)
165             : type(type)
166         {
167         }
168 
169         Type type;
170         Optional&lt;double&gt; expires;
171 
172         Optional&lt;RSA&gt; rsaParameters;
173     };
174     static void generateCertificate(Document&amp;, const CertificateInformation&amp;, DOMPromiseDeferred&lt;IDLInterface&lt;RTCCertificate&gt;&gt;&amp;&amp;);
175 
176     virtual void collectTransceivers() { };
177 
178     ScriptExecutionContext* context() const;
179     RTCRtpTransceiver* transceiverFromSender(const RTCRtpSender&amp;);
180 
<span class="line-added">181     virtual void suspend() { }</span>
<span class="line-added">182     virtual void resume() { }</span>
<span class="line-added">183 </span>
184 protected:
185     void fireICECandidateEvent(RefPtr&lt;RTCIceCandidate&gt;&amp;&amp;, String&amp;&amp; url);
186     void doneGatheringCandidates();
187 
188     void updateSignalingState(RTCSignalingState);
189 
190     void createOfferSucceeded(String&amp;&amp;);
191     void createOfferFailed(Exception&amp;&amp;);
192 
193     void createAnswerSucceeded(String&amp;&amp;);
194     void createAnswerFailed(Exception&amp;&amp;);
195 
196     void setLocalDescriptionSucceeded();
197     void setLocalDescriptionFailed(Exception&amp;&amp;);
198 
199     void setRemoteDescriptionSucceeded();
200     void setRemoteDescriptionFailed(Exception&amp;&amp;);
201 
202     void addIceCandidateSucceeded();
203     void addIceCandidateFailed(Exception&amp;&amp;);
204 
205     String filterSDP(String&amp;&amp;) const;
206 
207     struct PendingTrackEvent {
208         Ref&lt;RTCRtpReceiver&gt; receiver;
209         Ref&lt;MediaStreamTrack&gt; track;
210         Vector&lt;RefPtr&lt;MediaStream&gt;&gt; streams;
211         RefPtr&lt;RTCRtpTransceiver&gt; transceiver;
212     };
213     void addPendingTrackEvent(PendingTrackEvent&amp;&amp;);
214 
215 private:
216     virtual void doCreateOffer(RTCOfferOptions&amp;&amp;) = 0;
217     virtual void doCreateAnswer(RTCAnswerOptions&amp;&amp;) = 0;
218     virtual void doSetLocalDescription(RTCSessionDescription&amp;) = 0;
219     virtual void doSetRemoteDescription(RTCSessionDescription&amp;) = 0;
220     virtual void doAddIceCandidate(RTCIceCandidate&amp;) = 0;
<span class="line-modified">221     virtual void endOfIceCandidates(DOMPromiseDeferred&lt;void&gt;&amp;&amp;);</span>
222     virtual void doStop() = 0;
223 
224     void registerMDNSName(const String&amp; ipAddress);
225 
226 protected:
227     RTCPeerConnection&amp; m_peerConnection;
228 
229 private:
<span class="line-modified">230     std::unique_ptr&lt;PeerConnection::SessionDescriptionPromise&gt; m_offerAnswerPromise;</span>
<span class="line-modified">231     std::unique_ptr&lt;DOMPromiseDeferred&lt;void&gt;&gt; m_setDescriptionPromise;</span>
<span class="line-modified">232     std::unique_ptr&lt;DOMPromiseDeferred&lt;void&gt;&gt; m_addIceCandidatePromise;</span>
233 
234     bool m_shouldFilterICECandidates { true };
235     struct PendingICECandidate {
236         // Fields described in https://www.w3.org/TR/webrtc/#idl-def-rtcicecandidateinit.
237         String sdp;
238         String mid;
239         unsigned short sdpMLineIndex;
240         String serverURL;
241     };
242     Vector&lt;PendingICECandidate&gt; m_pendingICECandidates;
243 
244     Vector&lt;PendingTrackEvent&gt; m_pendingTrackEvents;
245 
246 #if !RELEASE_LOG_DISABLED
247     Ref&lt;const Logger&gt; m_logger;
248     const void* m_logIdentifier;
249 #endif
250     bool m_negotiationNeeded { false };
251     bool m_finishedGatheringCandidates { false };
252     uint64_t m_waitingForMDNSRegistration { 0 };
</pre>
</td>
</tr>
</table>
<center><a href="PeerConnectionBackend.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="RTCDTMFSender.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>