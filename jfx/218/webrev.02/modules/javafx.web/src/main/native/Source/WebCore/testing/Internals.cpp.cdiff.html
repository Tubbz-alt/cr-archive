<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.web/src/main/native/Source/WebCore/testing/Internals.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="InternalSettings.idl.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="Internals.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/testing/Internals.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 26,21 ***</span>
  
  #include &quot;config.h&quot;
  #include &quot;Internals.h&quot;
  
  #include &quot;AXObjectCache.h&quot;
<span class="line-removed">- #include &quot;ActiveDOMCallbackMicrotask.h&quot;</span>
  #include &quot;ActivityState.h&quot;
  #include &quot;AnimationTimeline.h&quot;
  #include &quot;ApplicationCacheStorage.h&quot;
  #include &quot;AudioSession.h&quot;
  #include &quot;Autofill.h&quot;
  #include &quot;BackForwardController.h&quot;
  #include &quot;BitmapImage.h&quot;
  #include &quot;CSSAnimationController.h&quot;
  #include &quot;CSSKeyframesRule.h&quot;
  #include &quot;CSSMediaRule.h&quot;
  #include &quot;CSSStyleRule.h&quot;
  #include &quot;CSSSupportsRule.h&quot;
  #include &quot;CacheStorageConnection.h&quot;
  #include &quot;CacheStorageProvider.h&quot;
  #include &quot;CachedImage.h&quot;
<span class="line-new-header">--- 26,22 ---</span>
  
  #include &quot;config.h&quot;
  #include &quot;Internals.h&quot;
  
  #include &quot;AXObjectCache.h&quot;
  #include &quot;ActivityState.h&quot;
  #include &quot;AnimationTimeline.h&quot;
  #include &quot;ApplicationCacheStorage.h&quot;
  #include &quot;AudioSession.h&quot;
  #include &quot;Autofill.h&quot;
<span class="line-added">+ #include &quot;BackForwardCache.h&quot;</span>
  #include &quot;BackForwardController.h&quot;
  #include &quot;BitmapImage.h&quot;
  #include &quot;CSSAnimationController.h&quot;
  #include &quot;CSSKeyframesRule.h&quot;
  #include &quot;CSSMediaRule.h&quot;
<span class="line-added">+ #include &quot;CSSPropertyParser.h&quot;</span>
  #include &quot;CSSStyleRule.h&quot;
  #include &quot;CSSSupportsRule.h&quot;
  #include &quot;CacheStorageConnection.h&quot;
  #include &quot;CacheStorageProvider.h&quot;
  #include &quot;CachedImage.h&quot;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 67,19 ***</span>
<span class="line-new-header">--- 68,21 ---</span>
  #include &quot;DocumentTimeline.h&quot;
  #include &quot;Editor.h&quot;
  #include &quot;Element.h&quot;
  #include &quot;EventHandler.h&quot;
  #include &quot;EventListener.h&quot;
<span class="line-added">+ #include &quot;EventLoop.h&quot;</span>
  #include &quot;EventNames.h&quot;
  #include &quot;ExtendableEvent.h&quot;
  #include &quot;ExtensionStyleSheets.h&quot;
  #include &quot;FetchResponse.h&quot;
  #include &quot;File.h&quot;
  #include &quot;FontCache.h&quot;
  #include &quot;FormController.h&quot;
  #include &quot;Frame.h&quot;
  #include &quot;FrameLoader.h&quot;
<span class="line-added">+ #include &quot;FrameLoaderClient.h&quot;</span>
  #include &quot;FrameView.h&quot;
  #include &quot;FullscreenManager.h&quot;
  #include &quot;GCObservation.h&quot;
  #include &quot;GridPosition.h&quot;
  #include &quot;HEVCUtilities.h&quot;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 99,34 ***</span>
  #include &quot;HistoryController.h&quot;
  #include &quot;HistoryItem.h&quot;
  #include &quot;HitTestResult.h&quot;
  #include &quot;InspectorClient.h&quot;
  #include &quot;InspectorController.h&quot;
  #include &quot;InspectorFrontendClientLocal.h&quot;
  #include &quot;InspectorOverlay.h&quot;
  #include &quot;InstrumentingAgents.h&quot;
  #include &quot;IntRect.h&quot;
  #include &quot;InternalSettings.h&quot;
  #include &quot;JSImageData.h&quot;
  #include &quot;LibWebRTCProvider.h&quot;
  #include &quot;LoaderStrategy.h&quot;
  #include &quot;MallocStatistics.h&quot;
  #include &quot;MediaDevices.h&quot;
  #include &quot;MediaEngineConfigurationFactory.h&quot;
  #include &quot;MediaPlayer.h&quot;
  #include &quot;MediaProducer.h&quot;
  #include &quot;MediaResourceLoader.h&quot;
  #include &quot;MediaStreamTrack.h&quot;
  #include &quot;MemoryCache.h&quot;
  #include &quot;MemoryInfo.h&quot;
  #include &quot;MockLibWebRTCPeerConnection.h&quot;
  #include &quot;MockPageOverlay.h&quot;
  #include &quot;MockPageOverlayClient.h&quot;
  #include &quot;NavigatorMediaDevices.h&quot;
  #include &quot;NetworkLoadInformation.h&quot;
  #include &quot;Page.h&quot;
<span class="line-removed">- #include &quot;PageCache.h&quot;</span>
  #include &quot;PageOverlay.h&quot;
  #include &quot;PathUtilities.h&quot;
  #include &quot;PlatformKeyboardEvent.h&quot;
  #include &quot;PlatformMediaSessionManager.h&quot;
  #include &quot;PlatformScreen.h&quot;
<span class="line-new-header">--- 102,42 ---</span>
  #include &quot;HistoryController.h&quot;
  #include &quot;HistoryItem.h&quot;
  #include &quot;HitTestResult.h&quot;
  #include &quot;InspectorClient.h&quot;
  #include &quot;InspectorController.h&quot;
<span class="line-added">+ #include &quot;InspectorDebuggableType.h&quot;</span>
  #include &quot;InspectorFrontendClientLocal.h&quot;
  #include &quot;InspectorOverlay.h&quot;
  #include &quot;InstrumentingAgents.h&quot;
  #include &quot;IntRect.h&quot;
  #include &quot;InternalSettings.h&quot;
<span class="line-added">+ #include &quot;InternalsMapLike.h&quot;</span>
<span class="line-added">+ #include &quot;InternalsSetLike.h&quot;</span>
<span class="line-added">+ #include &quot;JSDOMPromiseDeferred.h&quot;</span>
  #include &quot;JSImageData.h&quot;
<span class="line-added">+ #include &quot;LegacySchemeRegistry.h&quot;</span>
  #include &quot;LibWebRTCProvider.h&quot;
  #include &quot;LoaderStrategy.h&quot;
<span class="line-added">+ #include &quot;Location.h&quot;</span>
<span class="line-added">+ #include &quot;MIMETypeRegistry.h&quot;</span>
  #include &quot;MallocStatistics.h&quot;
  #include &quot;MediaDevices.h&quot;
  #include &quot;MediaEngineConfigurationFactory.h&quot;
  #include &quot;MediaPlayer.h&quot;
  #include &quot;MediaProducer.h&quot;
<span class="line-added">+ #include &quot;MediaRecorderProvider.h&quot;</span>
  #include &quot;MediaResourceLoader.h&quot;
  #include &quot;MediaStreamTrack.h&quot;
  #include &quot;MemoryCache.h&quot;
  #include &quot;MemoryInfo.h&quot;
<span class="line-added">+ #include &quot;MockAudioDestinationCocoa.h&quot;</span>
  #include &quot;MockLibWebRTCPeerConnection.h&quot;
  #include &quot;MockPageOverlay.h&quot;
  #include &quot;MockPageOverlayClient.h&quot;
  #include &quot;NavigatorMediaDevices.h&quot;
  #include &quot;NetworkLoadInformation.h&quot;
  #include &quot;Page.h&quot;
  #include &quot;PageOverlay.h&quot;
  #include &quot;PathUtilities.h&quot;
  #include &quot;PlatformKeyboardEvent.h&quot;
  #include &quot;PlatformMediaSessionManager.h&quot;
  #include &quot;PlatformScreen.h&quot;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 138,21 ***</span>
  #include &quot;ReadableStream.h&quot;
  #include &quot;RenderEmbeddedObject.h&quot;
  #include &quot;RenderLayerBacking.h&quot;
  #include &quot;RenderLayerCompositor.h&quot;
  #include &quot;RenderMenuList.h&quot;
  #include &quot;RenderTreeAsText.h&quot;
  #include &quot;RenderView.h&quot;
  #include &quot;RenderedDocumentMarker.h&quot;
  #include &quot;ResourceLoadObserver.h&quot;
  #include &quot;RuntimeEnabledFeatures.h&quot;
  #include &quot;SMILTimeContainer.h&quot;
  #include &quot;SVGDocumentExtensions.h&quot;
  #include &quot;SVGPathStringBuilder.h&quot;
  #include &quot;SVGSVGElement.h&quot;
  #include &quot;SWClientConnection.h&quot;
<span class="line-modified">! #include &quot;SchemeRegistry.h&quot;</span>
  #include &quot;ScriptedAnimationController.h&quot;
  #include &quot;ScrollingCoordinator.h&quot;
  #include &quot;ScrollingMomentumCalculator.h&quot;
  #include &quot;SecurityOrigin.h&quot;
  #include &quot;SerializedScriptValue.h&quot;
<span class="line-new-header">--- 149,22 ---</span>
  #include &quot;ReadableStream.h&quot;
  #include &quot;RenderEmbeddedObject.h&quot;
  #include &quot;RenderLayerBacking.h&quot;
  #include &quot;RenderLayerCompositor.h&quot;
  #include &quot;RenderMenuList.h&quot;
<span class="line-added">+ #include &quot;RenderTheme.h&quot;</span>
  #include &quot;RenderTreeAsText.h&quot;
  #include &quot;RenderView.h&quot;
  #include &quot;RenderedDocumentMarker.h&quot;
  #include &quot;ResourceLoadObserver.h&quot;
  #include &quot;RuntimeEnabledFeatures.h&quot;
  #include &quot;SMILTimeContainer.h&quot;
  #include &quot;SVGDocumentExtensions.h&quot;
  #include &quot;SVGPathStringBuilder.h&quot;
  #include &quot;SVGSVGElement.h&quot;
  #include &quot;SWClientConnection.h&quot;
<span class="line-modified">! #include &quot;ScriptController.h&quot;</span>
  #include &quot;ScriptedAnimationController.h&quot;
  #include &quot;ScrollingCoordinator.h&quot;
  #include &quot;ScrollingMomentumCalculator.h&quot;
  #include &quot;SecurityOrigin.h&quot;
  #include &quot;SerializedScriptValue.h&quot;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 162,11 ***</span>
<span class="line-new-header">--- 174,14 ---</span>
  #include &quot;Settings.h&quot;
  #include &quot;ShadowRoot.h&quot;
  #include &quot;SourceBuffer.h&quot;
  #include &quot;SpellChecker.h&quot;
  #include &quot;StaticNodeList.h&quot;
<span class="line-added">+ #include &quot;StorageNamespace.h&quot;</span>
<span class="line-added">+ #include &quot;StorageNamespaceProvider.h&quot;</span>
  #include &quot;StringCallback.h&quot;
<span class="line-added">+ #include &quot;StyleResolver.h&quot;</span>
  #include &quot;StyleRule.h&quot;
  #include &quot;StyleScope.h&quot;
  #include &quot;StyleSheetContents.h&quot;
  #include &quot;TextIterator.h&quot;
  #include &quot;TreeScope.h&quot;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 189,10 ***</span>
<span class="line-new-header">--- 204,11 ---</span>
  #include &lt;wtf/HexNumber.h&gt;
  #include &lt;wtf/JSONValues.h&gt;
  #include &lt;wtf/Language.h&gt;
  #include &lt;wtf/MemoryPressureHandler.h&gt;
  #include &lt;wtf/MonotonicTime.h&gt;
<span class="line-added">+ #include &lt;wtf/ProcessID.h&gt;</span>
  #include &lt;wtf/URLHelpers.h&gt;
  #include &lt;wtf/text/StringBuilder.h&gt;
  #include &lt;wtf/text/StringConcatenateNumbers.h&gt;
  
  #if USE(CG)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 277,12 ***</span>
  #include &quot;IDBRequest.h&quot;
  #include &quot;IDBTransaction.h&quot;
  #endif
  
  #if USE(QUICK_LOOK)
  #include &quot;MockPreviewLoaderClient.h&quot;
<span class="line-removed">- #include &quot;PreviewLoader.h&quot;</span>
  #endif
  
  #if ENABLE(APPLE_PAY)
  #include &quot;MockPaymentCoordinator.h&quot;
  #include &quot;PaymentCoordinator.h&quot;
<span class="line-new-header">--- 293,12 ---</span>
  #include &quot;IDBRequest.h&quot;
  #include &quot;IDBTransaction.h&quot;
  #endif
  
  #if USE(QUICK_LOOK)
<span class="line-added">+ #include &quot;LegacyPreviewLoader.h&quot;</span>
  #include &quot;MockPreviewLoaderClient.h&quot;
  #endif
  
  #if ENABLE(APPLE_PAY)
  #include &quot;MockPaymentCoordinator.h&quot;
  #include &quot;PaymentCoordinator.h&quot;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 291,11 ***</span>
  #if PLATFORM(MAC) &amp;&amp; USE(LIBWEBRTC)
  #include &lt;webrtc/sdk/WebKit/VideoProcessingSoftLink.h&gt;
  #endif
  
  #if PLATFORM(MAC)
<span class="line-modified">! #include &quot;GraphicsContext3DManager.h&quot;</span>
  #endif
  
  using JSC::CallData;
  using JSC::CallType;
  using JSC::CodeBlock;
<span class="line-new-header">--- 307,16 ---</span>
  #if PLATFORM(MAC) &amp;&amp; USE(LIBWEBRTC)
  #include &lt;webrtc/sdk/WebKit/VideoProcessingSoftLink.h&gt;
  #endif
  
  #if PLATFORM(MAC)
<span class="line-modified">! #include &quot;GraphicsContextGLOpenGLManager.h&quot;</span>
<span class="line-added">+ #endif</span>
<span class="line-added">+ </span>
<span class="line-added">+ #if PLATFORM(COCOA)</span>
<span class="line-added">+ #include &quot;SystemBattery.h&quot;</span>
<span class="line-added">+ #include &lt;wtf/spi/darwin/SandboxSPI.h&gt;</span>
  #endif
  
  using JSC::CallData;
  using JSC::CallType;
  using JSC::CodeBlock;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 325,11 ***</span>
      void attachWindow(DockSide) final { }
      void detachWindow() final { }
      void closeWindow() final;
      void reopen() final { }
      void bringToFront() final { }
<span class="line-modified">!     String localizedStringsURL() final { return String(); }</span>
      void inspectedURLChanged(const String&amp;) final { }
      void showCertificate(const CertificateInfo&amp;) final { }
      void setAttachedWindowHeight(unsigned) final { }
      void setAttachedWindowWidth(unsigned) final { }
      void setSheetRect(const FloatRect&amp;) final { }
<span class="line-new-header">--- 346,16 ---</span>
      void attachWindow(DockSide) final { }
      void detachWindow() final { }
      void closeWindow() final;
      void reopen() final { }
      void bringToFront() final { }
<span class="line-modified">!     String localizedStringsURL() const final { return String(); }</span>
<span class="line-added">+     DebuggableType debuggableType() const final { return DebuggableType::Page; }</span>
<span class="line-added">+     String targetPlatformName() const { return &quot;Unknown&quot;_s; }</span>
<span class="line-added">+     String targetBuildVersion() const { return &quot;Unknown&quot;_s; }</span>
<span class="line-added">+     String targetProductVersion() const { return &quot;Unknown&quot;_s; }</span>
<span class="line-added">+     bool targetIsSimulator() const { return false; }</span>
      void inspectedURLChanged(const String&amp;) final { }
      void showCertificate(const CertificateInfo&amp;) final { }
      void setAttachedWindowHeight(unsigned) final { }
      void setAttachedWindowWidth(unsigned) final { }
      void setSheetRect(const FloatRect&amp;) final { }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 483,11 ***</span>
<span class="line-new-header">--- 509,13 ---</span>
      page.applicationCacheStorage().setDefaultOriginQuota(ApplicationCacheStorage::noQuota());
  #if ENABLE(VIDEO)
      PlatformMediaSessionManager::sharedManager().resetRestrictions();
      PlatformMediaSessionManager::sharedManager().setWillIgnoreSystemInterruptions(true);
  #endif
<span class="line-added">+ #if ENABLE(VIDEO) || ENABLE(WEB_AUDIO)</span>
      PlatformMediaSessionManager::sharedManager().setIsPlayingToAutomotiveHeadUnit(false);
<span class="line-added">+ #endif</span>
  #if ENABLE(ACCESSIBILITY)
      AXObjectCache::setEnhancedUserInterfaceAccessibility(false);
      AXObjectCache::disableAccessibility();
  #endif
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 505,21 ***</span>
      page.setShowAllPlugins(false);
      page.setLowPowerModeEnabledOverrideForTesting(WTF::nullopt);
  
  #if USE(QUICK_LOOK)
      MockPreviewLoaderClient::singleton().setPassword(&quot;&quot;);
<span class="line-modified">!     PreviewLoader::setClientForTesting(nullptr);</span>
  #endif
  
      printContextForTesting() = nullptr;
  
  #if USE(LIBWEBRTC)
      auto&amp; rtcProvider = page.libWebRTCProvider();
      WebCore::useRealRTCPeerConnectionFactory(rtcProvider);
      rtcProvider.disableNonLocalhostConnections();
      RuntimeEnabledFeatures::sharedFeatures().setWebRTCVP8CodecEnabled(true);
      page.settings().setWebRTCEncryptionEnabled(true);
  #endif
  
      page.settings().setStorageAccessAPIEnabled(false);
      page.setFullscreenAutoHideDuration(0_s);
      page.setFullscreenInsets({ });
<span class="line-new-header">--- 533,22 ---</span>
      page.setShowAllPlugins(false);
      page.setLowPowerModeEnabledOverrideForTesting(WTF::nullopt);
  
  #if USE(QUICK_LOOK)
      MockPreviewLoaderClient::singleton().setPassword(&quot;&quot;);
<span class="line-modified">!     LegacyPreviewLoader::setClientForTesting(nullptr);</span>
  #endif
  
      printContextForTesting() = nullptr;
  
  #if USE(LIBWEBRTC)
      auto&amp; rtcProvider = page.libWebRTCProvider();
      WebCore::useRealRTCPeerConnectionFactory(rtcProvider);
      rtcProvider.disableNonLocalhostConnections();
      RuntimeEnabledFeatures::sharedFeatures().setWebRTCVP8CodecEnabled(true);
      page.settings().setWebRTCEncryptionEnabled(true);
<span class="line-added">+     rtcProvider.setUseGPUProcess(false);</span>
  #endif
  
      page.settings().setStorageAccessAPIEnabled(false);
      page.setFullscreenAutoHideDuration(0_s);
      page.setFullscreenInsets({ });
</pre>
<hr />
<pre>
<span class="line-old-header">*** 527,11 ***</span>
<span class="line-new-header">--- 556,16 ---</span>
  
      MediaEngineConfigurationFactory::disableMock();
  
  #if ENABLE(MEDIA_STREAM)
      RuntimeEnabledFeatures::sharedFeatures().setInterruptAudioOnPageVisibilityChangeEnabled(false);
<span class="line-added">+     WebCore::MediaRecorder::setCustomPrivateRecorderCreator(nullptr);</span>
<span class="line-added">+     page.mediaRecorderProvider().setUseGPUProcess(true);</span>
  #endif
<span class="line-added">+ </span>
<span class="line-added">+     HTMLCanvasElement::setMaxPixelMemoryForTesting(0); // This means use the default value.</span>
<span class="line-added">+     DOMWindow::overrideTransientActivationDurationForTesting(WTF::nullopt);</span>
  }
  
  Internals::Internals(Document&amp; document)
      : ContextDestructionObserver(&amp;document)
  #if ENABLE(MEDIA_STREAM)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 542,11 ***</span>
      if (document.page())
          document.page()-&gt;group().captionPreferences().setTestingMode(true);
  #endif
  
  #if ENABLE(MEDIA_STREAM)
<span class="line-removed">-     setMockMediaCaptureDevicesEnabled(true);</span>
      setMediaCaptureRequiresSecureConnection(false);
  #endif
  
  #if ENABLE(WIRELESS_PLAYBACK_TARGET)
      if (document.page())
<span class="line-new-header">--- 576,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 568,10 ***</span>
<span class="line-new-header">--- 601,14 ---</span>
      if (frame &amp;&amp; frame-&gt;page() &amp;&amp; frame-&gt;isMainFrame()) {
          auto mockPaymentCoordinator = new MockPaymentCoordinator(*frame-&gt;page());
          frame-&gt;page()-&gt;setPaymentCoordinator(makeUnique&lt;PaymentCoordinator&gt;(*mockPaymentCoordinator));
      }
  #endif
<span class="line-added">+ </span>
<span class="line-added">+ #if PLATFORM(COCOA) &amp;&amp;  ENABLE(WEB_AUDIO)</span>
<span class="line-added">+     AudioDestinationCocoa::createOverride = nullptr;</span>
<span class="line-added">+ #endif</span>
  }
  
  Document* Internals::contextDocument() const
  {
      return downcast&lt;Document&gt;(scriptExecutionContext());
</pre>
<hr />
<pre>
<span class="line-old-header">*** 702,10 ***</span>
<span class="line-new-header">--- 739,14 ---</span>
          return &quot;Memory cache&quot;;
      case ResourceResponse::Source::MemoryCacheAfterValidation:
          return &quot;Memory cache after validation&quot;;
      case ResourceResponse::Source::ApplicationCache:
          return &quot;Application cache&quot;;
<span class="line-added">+     case ResourceResponse::Source::DOMCache:</span>
<span class="line-added">+         return &quot;DOM cache&quot;;</span>
<span class="line-added">+     case ResourceResponse::Source::InspectorOverride:</span>
<span class="line-added">+         return &quot;Inspector override&quot;;</span>
      }
      ASSERT_NOT_REACHED();
      return &quot;Error&quot;;
  }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 909,18 ***</span>
  void Internals::setGridMaxTracksLimit(unsigned maxTrackLimit)
  {
      GridPosition::setMaxPositionForTesting(maxTrackLimit);
  }
  
<span class="line-modified">! void Internals::clearPageCache()</span>
  {
<span class="line-modified">!     PageCache::singleton().pruneToSizeNow(0, PruningReason::None);</span>
  }
  
<span class="line-modified">! unsigned Internals::pageCacheSize() const</span>
  {
<span class="line-modified">!     return PageCache::singleton().pageCount();</span>
  }
  
  void Internals::disableTileSizeUpdateDelay()
  {
      Document* document = contextDocument();
<span class="line-new-header">--- 950,24 ---</span>
  void Internals::setGridMaxTracksLimit(unsigned maxTrackLimit)
  {
      GridPosition::setMaxPositionForTesting(maxTrackLimit);
  }
  
<span class="line-modified">! void Internals::clearBackForwardCache()</span>
  {
<span class="line-modified">!     BackForwardCache::singleton().pruneToSizeNow(0, PruningReason::None);</span>
  }
  
<span class="line-modified">! unsigned Internals::backForwardCacheSize() const</span>
  {
<span class="line-modified">!     return BackForwardCache::singleton().pageCount();</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ void Internals::preventDocumentFromEnteringBackForwardCache()</span>
<span class="line-added">+ {</span>
<span class="line-added">+     if (auto* document = contextDocument())</span>
<span class="line-added">+         document-&gt;preventEnteringBackForwardCacheForTesting();</span>
  }
  
  void Internals::disableTileSizeUpdateDelay()
  {
      Document* document = contextDocument();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1378,10 ***</span>
<span class="line-new-header">--- 1425,16 ---</span>
      }
  
      return String();
  }
  
<span class="line-added">+ void Internals::setCanShowPlaceholder(Element&amp; element, bool canShowPlaceholder)</span>
<span class="line-added">+ {</span>
<span class="line-added">+     if (is&lt;HTMLTextFormControlElement&gt;(element))</span>
<span class="line-added">+         downcast&lt;HTMLTextFormControlElement&gt;(element).setCanShowPlaceholder(canShowPlaceholder);</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
  void Internals::selectColorInColorChooser(HTMLInputElement&amp; element, const String&amp; colorValue)
  {
      element.selectColor(colorValue);
  }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1437,11 ***</span>
      connection.emulatePlatformEvent(action);
  }
  
  void Internals::useMockRTCPeerConnectionFactory(const String&amp; testCase)
  {
<span class="line-removed">-     ASSERT(RuntimeEnabledFeatures::sharedFeatures().webRTCUnifiedPlanEnabled());</span>
      if (!LibWebRTCProvider::webRTCAvailable())
          return;
  
  #if USE(LIBWEBRTC)
      Document* document = contextDocument();
<span class="line-new-header">--- 1490,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1506,23 ***</span>
  #if USE(LIBWEBRTC)
      if (auto* page = contextDocument()-&gt;page())
          page-&gt;settings().setWebRTCEncryptionEnabled(value);
  #endif
  }
  #endif
  
<span class="line-modified">! #if ENABLE(MEDIA_STREAM)</span>
<span class="line-removed">- void Internals::setShouldInterruptAudioOnPageVisibilityChange(bool shouldInterrupt)</span>
  {
<span class="line-modified">!     RuntimeEnabledFeatures::sharedFeatures().setInterruptAudioOnPageVisibilityChangeEnabled(shouldInterrupt);</span>
  }
  
<span class="line-modified">! void Internals::setMockMediaCaptureDevicesEnabled(bool enabled)</span>
  {
<span class="line-modified">!     Document* document = contextDocument();</span>
<span class="line-removed">-     if (auto* page = document-&gt;page())</span>
<span class="line-removed">-         page-&gt;settings().setMockCaptureDevicesEnabled(enabled);</span>
  }
  
  void Internals::setMediaCaptureRequiresSecureConnection(bool enabled)
  {
      Document* document = contextDocument();
<span class="line-new-header">--- 1558,38 ---</span>
  #if USE(LIBWEBRTC)
      if (auto* page = contextDocument()-&gt;page())
          page-&gt;settings().setWebRTCEncryptionEnabled(value);
  #endif
  }
<span class="line-added">+ </span>
<span class="line-added">+ void Internals::setUseDTLS10(bool useDTLS10)</span>
<span class="line-added">+ {</span>
<span class="line-added">+ #if USE(LIBWEBRTC)</span>
<span class="line-added">+     auto* document = contextDocument();</span>
<span class="line-added">+     if (!document || !document-&gt;page())</span>
<span class="line-added">+         return;</span>
<span class="line-added">+     document-&gt;page()-&gt;libWebRTCProvider().setUseDTLS10(useDTLS10);</span>
  #endif
<span class="line-added">+ }</span>
  
<span class="line-modified">! void Internals::setUseGPUProcessForWebRTC(bool useGPUProcess)</span>
  {
<span class="line-modified">! #if USE(LIBWEBRTC)</span>
<span class="line-added">+     auto* document = contextDocument();</span>
<span class="line-added">+     if (!document || !document-&gt;page())</span>
<span class="line-added">+         return;</span>
<span class="line-added">+ </span>
<span class="line-added">+     document-&gt;page()-&gt;libWebRTCProvider().setUseGPUProcess(useGPUProcess);</span>
<span class="line-added">+     document-&gt;page()-&gt;mediaRecorderProvider().setUseGPUProcess(useGPUProcess);</span>
<span class="line-added">+ #endif</span>
  }
<span class="line-added">+ #endif</span>
  
<span class="line-modified">! #if ENABLE(MEDIA_STREAM)</span>
<span class="line-added">+ void Internals::setShouldInterruptAudioOnPageVisibilityChange(bool shouldInterrupt)</span>
  {
<span class="line-modified">!     RuntimeEnabledFeatures::sharedFeatures().setInterruptAudioOnPageVisibilityChangeEnabled(shouldInterrupt);</span>
  }
  
  void Internals::setMediaCaptureRequiresSecureConnection(bool enabled)
  {
      Document* document = contextDocument();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1635,23 ***</span>
          return Exception { SyntaxError };
  
      contextDocument()-&gt;markers().updateRectsForInvalidatedMarkersOfType(markerType);
      auto rects = contextDocument()-&gt;markers().renderedRectsForMarkers(markerType);
  
      StringBuilder rectString;
      rectString.appendLiteral(&quot;marker rects: &quot;);
<span class="line-modified">!     for (const auto&amp; rect : rects) {</span>
<span class="line-modified">!         rectString.append(&#39;(&#39;);</span>
<span class="line-removed">-         rectString.appendFixedPrecisionNumber(rect.x());</span>
<span class="line-removed">-         rectString.appendLiteral(&quot;, &quot;);</span>
<span class="line-removed">-         rectString.appendFixedPrecisionNumber(rect.y());</span>
<span class="line-removed">-         rectString.appendLiteral(&quot;, &quot;);</span>
<span class="line-removed">-         rectString.appendFixedPrecisionNumber(rect.width());</span>
<span class="line-removed">-         rectString.appendLiteral(&quot;, &quot;);</span>
<span class="line-removed">-         rectString.appendFixedPrecisionNumber(rect.height());</span>
<span class="line-removed">-         rectString.appendLiteral(&quot;) &quot;);</span>
<span class="line-removed">-     }</span>
      return rectString.toString();
  }
  
  void Internals::addTextMatchMarker(const Range&amp; range, bool isActive)
  {
<span class="line-new-header">--- 1702,15 ---</span>
          return Exception { SyntaxError };
  
      contextDocument()-&gt;markers().updateRectsForInvalidatedMarkersOfType(markerType);
      auto rects = contextDocument()-&gt;markers().renderedRectsForMarkers(markerType);
  
<span class="line-added">+     // FIXME: Using fixed precision here for width because of test results that contain numbers with specific precision. Would be nice to update the test results and move to default formatting.</span>
      StringBuilder rectString;
      rectString.appendLiteral(&quot;marker rects: &quot;);
<span class="line-modified">!     for (const auto&amp; rect : rects)</span>
<span class="line-modified">!         rectString.append(&#39;(&#39;, rect.x(), &quot;, &quot;, rect.y(), &quot;, &quot;, FormattedNumber::fixedPrecision(rect.width()), &quot;, &quot;, rect.height(), &quot;) &quot;);</span>
      return rectString.toString();
  }
  
  void Internals::addTextMatchMarker(const Range&amp; range, bool isActive)
  {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1715,10 ***</span>
<span class="line-new-header">--- 1774,14 ---</span>
      Document* document = contextDocument();
      if (!document || !document-&gt;view())
          return Exception { InvalidAccessError };
  
      element.scrollTo({ x, y }, ScrollClamping::Unclamped);
<span class="line-added">+ </span>
<span class="line-added">+     auto&amp; frameView = *document-&gt;view();</span>
<span class="line-added">+     frameView.setViewportConstrainedObjectsNeedLayout();</span>
<span class="line-added">+ </span>
      return { };
  }
  
  ExceptionOr&lt;Ref&lt;DOMRect&gt;&gt; Internals::layoutViewportRect()
  {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1828,10 ***</span>
<span class="line-new-header">--- 1891,11 ---</span>
      ViewportArguments arguments = document-&gt;page()-&gt;viewportArguments();
      ViewportAttributes attributes = computeViewportAttributes(arguments, defaultLayoutWidthForNonMobilePages, deviceWidth, deviceHeight, devicePixelRatio, IntSize(availableWidth, availableHeight));
      restrictMinimumScaleFactorToViewportSize(attributes, IntSize(availableWidth, availableHeight), devicePixelRatio);
      restrictScaleFactorToInitialScaleIfNotUserScalable(attributes);
  
<span class="line-added">+     // FIXME: Using fixed precision here because of test results that contain numbers with specific precision. Would be nice to update the test results and move to default formatting.</span>
      return makeString(&quot;viewport size &quot;, FormattedNumber::fixedPrecision(attributes.layoutSize.width()), &#39;x&#39;, FormattedNumber::fixedPrecision(attributes.layoutSize.height()), &quot; scale &quot;, FormattedNumber::fixedPrecision(attributes.initialScale), &quot; with limits [&quot;, FormattedNumber::fixedPrecision(attributes.minimumScale), &quot;, &quot;, FormattedNumber::fixedPrecision(attributes.maximumScale), &quot;] and userScalable &quot;, (attributes.userScalable ? &quot;true&quot; : &quot;false&quot;));
  }
  
  ExceptionOr&lt;bool&gt; Internals::wasLastChangeUserEdit(Element&amp; textField)
  {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2155,20 ***</span>
  };
  
  String Internals::parserMetaData(JSC::JSValue code)
  {
      JSC::VM&amp; vm = contextDocument()-&gt;vm();
<span class="line-modified">!     JSC::ExecState* exec = vm.topCallFrame;</span>
      ScriptExecutable* executable;
  
      if (!code || code.isNull() || code.isUndefined()) {
          GetCallerCodeBlockFunctor iter;
<span class="line-modified">!         exec-&gt;iterate(iter);</span>
          CodeBlock* codeBlock = iter.codeBlock();
          executable = codeBlock-&gt;ownerExecutable();
      } else if (code.isFunction(vm)) {
<span class="line-modified">!         JSFunction* funcObj = JSC::jsCast&lt;JSFunction*&gt;(code.toObject(exec));</span>
          executable = funcObj-&gt;jsExecutable();
      } else
          return String();
  
      unsigned startLine = executable-&gt;firstLine();
<span class="line-new-header">--- 2219,21 ---</span>
  };
  
  String Internals::parserMetaData(JSC::JSValue code)
  {
      JSC::VM&amp; vm = contextDocument()-&gt;vm();
<span class="line-modified">!     JSC::CallFrame* callFrame = vm.topCallFrame;</span>
<span class="line-added">+     JSC::JSGlobalObject* globalObject = callFrame-&gt;lexicalGlobalObject(vm);</span>
      ScriptExecutable* executable;
  
      if (!code || code.isNull() || code.isUndefined()) {
          GetCallerCodeBlockFunctor iter;
<span class="line-modified">!         callFrame-&gt;iterate(vm, iter);</span>
          CodeBlock* codeBlock = iter.codeBlock();
          executable = codeBlock-&gt;ownerExecutable();
      } else if (code.isFunction(vm)) {
<span class="line-modified">!         JSFunction* funcObj = JSC::jsCast&lt;JSFunction*&gt;(code.toObject(globalObject));</span>
          executable = funcObj-&gt;jsExecutable();
      } else
          return String();
  
      unsigned startLine = executable-&gt;firstLine();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2427,11 ***</span>
<span class="line-new-header">--- 2492,15 ---</span>
  }
  
  #if ENABLE(INDEXED_DATABASE)
  unsigned Internals::numberOfIDBTransactions() const
  {
<span class="line-added">+ #if ENABLE(INDEXED_DATABASE)</span>
      return IDBTransaction::numberOfIDBTransactions;
<span class="line-added">+ #else</span>
<span class="line-added">+     return 0;</span>
<span class="line-added">+ #endif</span>
  }
  #endif
  
  unsigned Internals::numberOfLiveNodes() const
  {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2466,10 ***</span>
<span class="line-new-header">--- 2535,36 ---</span>
  bool Internals::isDocumentAlive(uint64_t documentIdentifier) const
  {
      return Document::allDocumentsMap().contains(makeObjectIdentifier&lt;DocumentIdentifierType&gt;(documentIdentifier));
  }
  
<span class="line-added">+ uint64_t Internals::storageAreaMapCount() const</span>
<span class="line-added">+ {</span>
<span class="line-added">+     auto* page = contextDocument() ? contextDocument()-&gt;page() : nullptr;</span>
<span class="line-added">+     if (!page)</span>
<span class="line-added">+         return 0;</span>
<span class="line-added">+ </span>
<span class="line-added">+     return page-&gt;storageNamespaceProvider().localStorageNamespace(page-&gt;sessionID()).storageAreaMapCountForTesting();</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ uint64_t Internals::elementIdentifier(Element&amp; element) const</span>
<span class="line-added">+ {</span>
<span class="line-added">+     return element.document().identifierForElement(element).toUInt64();</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ uint64_t Internals::frameIdentifier(const Document&amp; document) const</span>
<span class="line-added">+ {</span>
<span class="line-added">+     if (auto* page = document.page())</span>
<span class="line-added">+         return page-&gt;mainFrame().loader().client().frameID().valueOr(FrameIdentifier { }).toUInt64();</span>
<span class="line-added">+     return 0;</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ uint64_t Internals::pageIdentifier(const Document&amp; document) const</span>
<span class="line-added">+ {</span>
<span class="line-added">+     return document.pageID().valueOr(PageIdentifier { }).toUInt64();</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
  bool Internals::isAnyWorkletGlobalScopeAlive() const
  {
  #if ENABLE(CSS_PAINTING_API)
      return !WorkletGlobalScope::allWorkletGlobalScopesSet().isEmpty();
  #else
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2478,11 ***</span>
  }
  
  String Internals::serviceWorkerClientIdentifier(const Document&amp; document) const
  {
  #if ENABLE(SERVICE_WORKER)
<span class="line-modified">!     return ServiceWorkerClientIdentifier { ServiceWorkerProvider::singleton().serviceWorkerConnectionForSession(document.sessionID()).serverConnectionIdentifier(), document.identifier() }.toString();</span>
  #else
      UNUSED_PARAM(document);
      return String();
  #endif
  }
<span class="line-new-header">--- 2573,11 ---</span>
  }
  
  String Internals::serviceWorkerClientIdentifier(const Document&amp; document) const
  {
  #if ENABLE(SERVICE_WORKER)
<span class="line-modified">!     return ServiceWorkerClientIdentifier { ServiceWorkerProvider::singleton().serviceWorkerConnection().serverConnectionIdentifier(), document.identifier() }.toString();</span>
  #else
      UNUSED_PARAM(document);
      return String();
  #endif
  }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2569,10 ***</span>
<span class="line-new-header">--- 2664,12 ---</span>
          layerTreeFlags |= LayerTreeFlagsIncludeBackingStoreAttached;
      if (flags &amp; Internals::LAYER_TREE_INCLUDES_ROOT_LAYER_PROPERTIES)
          layerTreeFlags |= LayerTreeFlagsIncludeRootLayerProperties;
      if (flags &amp; Internals::LAYER_TREE_INCLUDES_EVENT_REGION)
          layerTreeFlags |= LayerTreeFlagsIncludeEventRegion;
<span class="line-added">+     if (flags &amp; Internals::LAYER_TREE_INCLUDES_DEEP_COLOR)</span>
<span class="line-added">+         layerTreeFlags |= LayerTreeFlagsIncludeDeepColor;</span>
  
      return layerTreeFlags;
  }
  
  // FIXME: Remove the document argument. It is almost always the same as
</pre>
<hr />
<pre>
<span class="line-old-header">*** 3119,16 ***</span>
      document-&gt;page()-&gt;applicationCacheStorage().storeUpdatedQuotaForOrigin(&amp;document-&gt;securityOrigin(), quota);
  }
  
  void Internals::registerURLSchemeAsBypassingContentSecurityPolicy(const String&amp; scheme)
  {
<span class="line-modified">!     SchemeRegistry::registerURLSchemeAsBypassingContentSecurityPolicy(scheme);</span>
  }
  
  void Internals::removeURLSchemeRegisteredAsBypassingContentSecurityPolicy(const String&amp; scheme)
  {
<span class="line-modified">!     SchemeRegistry::removeURLSchemeRegisteredAsBypassingContentSecurityPolicy(scheme);</span>
  }
  
  void Internals::registerDefaultPortForProtocol(unsigned short port, const String&amp; protocol)
  {
      registerDefaultPortForProtocolForTesting(port, protocol);
<span class="line-new-header">--- 3216,16 ---</span>
      document-&gt;page()-&gt;applicationCacheStorage().storeUpdatedQuotaForOrigin(&amp;document-&gt;securityOrigin(), quota);
  }
  
  void Internals::registerURLSchemeAsBypassingContentSecurityPolicy(const String&amp; scheme)
  {
<span class="line-modified">!     LegacySchemeRegistry::registerURLSchemeAsBypassingContentSecurityPolicy(scheme);</span>
  }
  
  void Internals::removeURLSchemeRegisteredAsBypassingContentSecurityPolicy(const String&amp; scheme)
  {
<span class="line-modified">!     LegacySchemeRegistry::removeURLSchemeRegisteredAsBypassingContentSecurityPolicy(scheme);</span>
  }
  
  void Internals::registerDefaultPortForProtocol(unsigned short port, const String&amp; protocol)
  {
      registerDefaultPortForProtocolForTesting(port, protocol);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 3370,28 ***</span>
  
  #if !PLATFORM(IOS_FAMILY)
      Cursor cursor = document-&gt;frame()-&gt;eventHandler().currentMouseCursor();
  
      StringBuilder result;
<span class="line-modified">!     result.appendLiteral(&quot;type=&quot;);</span>
<span class="line-removed">-     result.append(cursorTypeToString(cursor.type()));</span>
<span class="line-removed">-     result.appendLiteral(&quot; hotSpot=&quot;);</span>
<span class="line-removed">-     result.appendNumber(cursor.hotSpot().x());</span>
<span class="line-removed">-     result.append(&#39;,&#39;);</span>
<span class="line-removed">-     result.appendNumber(cursor.hotSpot().y());</span>
      if (cursor.image()) {
          FloatSize size = cursor.image()-&gt;size();
<span class="line-modified">!         result.appendLiteral(&quot; image=&quot;);</span>
<span class="line-removed">-         result.appendFixedPrecisionNumber(size.width());</span>
<span class="line-removed">-         result.append(&#39;x&#39;);</span>
<span class="line-removed">-         result.appendFixedPrecisionNumber(size.height());</span>
      }
  #if ENABLE(MOUSE_CURSOR_SCALE)
<span class="line-modified">!     if (cursor.imageScaleFactor() != 1) {</span>
<span class="line-modified">!         result.appendLiteral(&quot; scale=&quot;);</span>
<span class="line-removed">-         result.appendFixedPrecisionNumber(cursor.imageScaleFactor(), 8);</span>
<span class="line-removed">-     }</span>
  #endif
      return result.toString();
  #else
      return &quot;FAIL: Cursor details not available on this platform.&quot;_str;
  #endif
<span class="line-new-header">--- 3467,18 ---</span>
  
  #if !PLATFORM(IOS_FAMILY)
      Cursor cursor = document-&gt;frame()-&gt;eventHandler().currentMouseCursor();
  
      StringBuilder result;
<span class="line-modified">!     result.append(&quot;type=&quot;, cursorTypeToString(cursor.type()), &quot; hotSpot=&quot;, cursor.hotSpot().x(), &#39;,&#39;, cursor.hotSpot().y());</span>
      if (cursor.image()) {
          FloatSize size = cursor.image()-&gt;size();
<span class="line-modified">!         result.append(&quot; image=&quot;, size.width(), &#39;x&#39;, size.height());</span>
      }
  #if ENABLE(MOUSE_CURSOR_SCALE)
<span class="line-modified">!     if (cursor.imageScaleFactor() != 1)</span>
<span class="line-modified">!         result.append(&quot; scale=&quot;, cursor.imageScaleFactor());</span>
  #endif
      return result.toString();
  #else
      return &quot;FAIL: Cursor details not available on this platform.&quot;_str;
  #endif
</pre>
<hr />
<pre>
<span class="line-old-header">*** 3410,11 ***</span>
      return SerializedScriptValue::adopt(WTFMove(bytes));
  }
  
  bool Internals::isFromCurrentWorld(JSC::JSValue value) const
  {
<span class="line-modified">!     return isWorldCompatible(*contextDocument()-&gt;vm().topCallFrame, value);</span>
  }
  
  void Internals::setUsesOverlayScrollbars(bool enabled)
  {
      WebCore::DeprecatedGlobalSettings::setUsesOverlayScrollbars(enabled);
<span class="line-new-header">--- 3497,20 ---</span>
      return SerializedScriptValue::adopt(WTFMove(bytes));
  }
  
  bool Internals::isFromCurrentWorld(JSC::JSValue value) const
  {
<span class="line-modified">!     JSC::VM&amp; vm = contextDocument()-&gt;vm();</span>
<span class="line-added">+     return isWorldCompatible(*vm.topCallFrame-&gt;lexicalGlobalObject(vm), value);</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ JSC::JSValue Internals::evaluateInWorldIgnoringException(const String&amp; name, const String&amp; source)</span>
<span class="line-added">+ {</span>
<span class="line-added">+     auto* document = contextDocument();</span>
<span class="line-added">+     auto&amp; scriptController = document-&gt;frame()-&gt;script();</span>
<span class="line-added">+     auto world = ScriptController::createWorld(name);</span>
<span class="line-added">+     return scriptController.executeScriptInWorldIgnoringException(world, source);</span>
  }
  
  void Internals::setUsesOverlayScrollbars(bool enabled)
  {
      WebCore::DeprecatedGlobalSettings::setUsesOverlayScrollbars(enabled);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 4017,11 ***</span>
  }
  
  #endif // ENABLE(MEDIA_SESSION)
  
  #if ENABLE(WEB_AUDIO)
<span class="line-removed">- </span>
  void Internals::setAudioContextRestrictions(AudioContext&amp; context, StringView restrictionsString)
  {
      AudioContext::BehaviorRestrictions restrictions = context.behaviorRestrictions();
      context.removeBehaviorRestriction(restrictions);
  
<span class="line-new-header">--- 4113,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 4036,10 ***</span>
<span class="line-new-header">--- 4131,16 ---</span>
              restrictions |= AudioContext::RequirePageConsentForAudioStartRestriction;
      }
      context.addBehaviorRestriction(restrictions);
  }
  
<span class="line-added">+ void Internals::useMockAudioDestinationCocoa()</span>
<span class="line-added">+ {</span>
<span class="line-added">+ #if PLATFORM(COCOA)</span>
<span class="line-added">+     AudioDestinationCocoa::createOverride = MockAudioDestinationCocoa::create;</span>
<span class="line-added">+ #endif</span>
<span class="line-added">+ }</span>
  #endif
  
  void Internals::simulateSystemSleep() const
  {
  #if ENABLE(VIDEO)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 4109,10 ***</span>
<span class="line-new-header">--- 4210,18 ---</span>
  
      page-&gt;setMockMediaPlaybackTargetPickerState(deviceName, state);
      return { };
  }
  
<span class="line-added">+ void Internals::mockMediaPlaybackTargetPickerDismissPopup()</span>
<span class="line-added">+ {</span>
<span class="line-added">+     auto* page = contextDocument()-&gt;frame()-&gt;page();</span>
<span class="line-added">+     ASSERT(page);</span>
<span class="line-added">+ </span>
<span class="line-added">+     page-&gt;mockMediaPlaybackTargetPickerDismissPopup();</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
  #endif
  
  ExceptionOr&lt;Ref&lt;MockPageOverlay&gt;&gt; Internals::installMockPageOverlay(PageOverlayType type)
  {
      Document* document = contextDocument();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 4233,24 ***</span>
  
      URL url = document-&gt;completeURL(path);
      if (!url.isLocalFile())
          return nullptr;
  
<span class="line-modified">!     return File::create(document-&gt;sessionID(), url.fileSystemPath());</span>
  }
  
  void Internals::queueMicroTask(int testNumber)
  {
      Document* document = contextDocument();
      if (!document)
          return;
  
<span class="line-modified">!     auto microtask = makeUnique&lt;ActiveDOMCallbackMicrotask&gt;(MicrotaskQueue::mainThreadQueue(), *document, [document, testNumber]() {</span>
          document-&gt;addConsoleMessage(MessageSource::JS, MessageLevel::Debug, makeString(&quot;MicroTask #&quot;, testNumber, &quot; has run.&quot;));
      });
<span class="line-removed">- </span>
<span class="line-removed">-     MicrotaskQueue::mainThreadQueue().append(WTFMove(microtask));</span>
  }
  
  #if ENABLE(CONTENT_FILTERING)
  
  MockContentFilterSettings&amp; Internals::mockContentFilterSettings()
<span class="line-new-header">--- 4342,24 ---</span>
  
      URL url = document-&gt;completeURL(path);
      if (!url.isLocalFile())
          return nullptr;
  
<span class="line-modified">!     return File::create(url.fileSystemPath());</span>
  }
  
  void Internals::queueMicroTask(int testNumber)
  {
      Document* document = contextDocument();
      if (!document)
          return;
  
<span class="line-modified">!     ScriptExecutionContext* context = document;</span>
<span class="line-added">+     auto&amp; eventLoop = context-&gt;eventLoop();</span>
<span class="line-added">+     eventLoop.queueMicrotask([document = makeRef(*document), testNumber]() {</span>
          document-&gt;addConsoleMessage(MessageSource::JS, MessageLevel::Debug, makeString(&quot;MicroTask #&quot;, testNumber, &quot; has run.&quot;));
      });
  }
  
  #if ENABLE(CONTENT_FILTERING)
  
  MockContentFilterSettings&amp; Internals::mockContentFilterSettings()
</pre>
<hr />
<pre>
<span class="line-old-header">*** 4347,23 ***</span>
          rects.append(FloatRect(rectComponents[i], rectComponents[i + 1], rectComponents[i + 2], rectComponents[i + 3]));
  
      SVGPathStringBuilder builder;
      PathUtilities::pathWithShrinkWrappedRects(rects, radius).apply([&amp;builder](const PathElement&amp; element) {
          switch (element.type) {
<span class="line-modified">!         case PathElementMoveToPoint:</span>
              builder.moveTo(element.points[0], false, AbsoluteCoordinates);
              return;
<span class="line-modified">!         case PathElementAddLineToPoint:</span>
              builder.lineTo(element.points[0], AbsoluteCoordinates);
              return;
<span class="line-modified">!         case PathElementAddQuadCurveToPoint:</span>
              builder.curveToQuadratic(element.points[0], element.points[1], AbsoluteCoordinates);
              return;
<span class="line-modified">!         case PathElementAddCurveToPoint:</span>
              builder.curveToCubic(element.points[0], element.points[1], element.points[2], AbsoluteCoordinates);
              return;
<span class="line-modified">!         case PathElementCloseSubpath:</span>
              builder.closePath();
              return;
          }
          ASSERT_NOT_REACHED();
      });
<span class="line-new-header">--- 4456,23 ---</span>
          rects.append(FloatRect(rectComponents[i], rectComponents[i + 1], rectComponents[i + 2], rectComponents[i + 3]));
  
      SVGPathStringBuilder builder;
      PathUtilities::pathWithShrinkWrappedRects(rects, radius).apply([&amp;builder](const PathElement&amp; element) {
          switch (element.type) {
<span class="line-modified">!         case PathElement::Type::MoveToPoint:</span>
              builder.moveTo(element.points[0], false, AbsoluteCoordinates);
              return;
<span class="line-modified">!         case PathElement::Type::AddLineToPoint:</span>
              builder.lineTo(element.points[0], AbsoluteCoordinates);
              return;
<span class="line-modified">!         case PathElement::Type::AddQuadCurveToPoint:</span>
              builder.curveToQuadratic(element.points[0], element.points[1], AbsoluteCoordinates);
              return;
<span class="line-modified">!         case PathElement::Type::AddCurveToPoint:</span>
              builder.curveToCubic(element.points[0], element.points[1], element.points[2], AbsoluteCoordinates);
              return;
<span class="line-modified">!         case PathElement::Type::CloseSubpath:</span>
              builder.closePath();
              return;
          }
          ASSERT_NOT_REACHED();
      });
</pre>
<hr />
<pre>
<span class="line-old-header">*** 4403,25 ***</span>
      page-&gt;setShowAllPlugins(show);
  }
  
  #if ENABLE(STREAMS_API)
  
<span class="line-modified">! bool Internals::isReadableStreamDisturbed(JSC::ExecState&amp; state, JSValue stream)</span>
  {
<span class="line-modified">!     return ReadableStream::isDisturbed(state, stream);</span>
  }
  
<span class="line-modified">! JSValue Internals::cloneArrayBuffer(JSC::ExecState&amp; state, JSValue buffer, JSValue srcByteOffset, JSValue srcLength)</span>
  {
<span class="line-modified">!     JSC::VM&amp; vm = state.vm();</span>
<span class="line-removed">-     JSGlobalObject* globalObject = vm.vmEntryGlobalObject(&amp;state);</span>
      JSVMClientData* clientData = static_cast&lt;JSVMClientData*&gt;(vm.clientData);
      const Identifier&amp; privateName = clientData-&gt;builtinNames().cloneArrayBufferPrivateName();
      JSValue value;
      PropertySlot propertySlot(value, PropertySlot::InternalMethodType::Get);
<span class="line-modified">!     globalObject-&gt;methodTable(vm)-&gt;getOwnPropertySlot(globalObject, &amp;state, privateName, propertySlot);</span>
<span class="line-modified">!     value = propertySlot.getValue(&amp;state, privateName);</span>
      ASSERT(value.isFunction(vm));
  
      JSObject* function = value.getObject();
      CallData callData;
      CallType callType = JSC::getCallData(vm, function, callData);
<span class="line-new-header">--- 4512,24 ---</span>
      page-&gt;setShowAllPlugins(show);
  }
  
  #if ENABLE(STREAMS_API)
  
<span class="line-modified">! bool Internals::isReadableStreamDisturbed(JSC::JSGlobalObject&amp; lexicalGlobalObject, JSValue stream)</span>
  {
<span class="line-modified">!     return ReadableStream::isDisturbed(lexicalGlobalObject, stream);</span>
  }
  
<span class="line-modified">! JSValue Internals::cloneArrayBuffer(JSC::JSGlobalObject&amp; lexicalGlobalObject, JSValue buffer, JSValue srcByteOffset, JSValue srcLength)</span>
  {
<span class="line-modified">!     JSC::VM&amp; vm = lexicalGlobalObject.vm();</span>
      JSVMClientData* clientData = static_cast&lt;JSVMClientData*&gt;(vm.clientData);
      const Identifier&amp; privateName = clientData-&gt;builtinNames().cloneArrayBufferPrivateName();
      JSValue value;
      PropertySlot propertySlot(value, PropertySlot::InternalMethodType::Get);
<span class="line-modified">!     lexicalGlobalObject.methodTable(vm)-&gt;getOwnPropertySlot(&amp;lexicalGlobalObject, &amp;lexicalGlobalObject, privateName, propertySlot);</span>
<span class="line-modified">!     value = propertySlot.getValue(&amp;lexicalGlobalObject, privateName);</span>
      ASSERT(value.isFunction(vm));
  
      JSObject* function = value.getObject();
      CallData callData;
      CallType callType = JSC::getCallData(vm, function, callData);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 4430,22 ***</span>
      arguments.append(buffer);
      arguments.append(srcByteOffset);
      arguments.append(srcLength);
      ASSERT(!arguments.hasOverflowed());
  
<span class="line-modified">!     return JSC::call(&amp;state, function, callType, callData, JSC::jsUndefined(), arguments);</span>
  }
  
  #endif
  
  String Internals::resourceLoadStatisticsForURL(const DOMURL&amp; url)
  {
<span class="line-modified">!     auto* document = contextDocument();</span>
<span class="line-removed">-     if (!document)</span>
<span class="line-removed">-         return emptyString();</span>
<span class="line-removed">- </span>
<span class="line-removed">-     return ResourceLoadObserver::shared().statisticsForURL(document-&gt;sessionID(), url.href());</span>
  }
  
  void Internals::setResourceLoadStatisticsEnabled(bool enable)
  {
      DeprecatedGlobalSettings::setResourceLoadStatisticsEnabled(enable);
<span class="line-new-header">--- 4538,18 ---</span>
      arguments.append(buffer);
      arguments.append(srcByteOffset);
      arguments.append(srcLength);
      ASSERT(!arguments.hasOverflowed());
  
<span class="line-modified">!     return JSC::call(&amp;lexicalGlobalObject, function, callType, callData, JSC::jsUndefined(), arguments);</span>
  }
  
  #endif
  
  String Internals::resourceLoadStatisticsForURL(const DOMURL&amp; url)
  {
<span class="line-modified">!     return ResourceLoadObserver::shared().statisticsForURL(url.href());</span>
  }
  
  void Internals::setResourceLoadStatisticsEnabled(bool enable)
  {
      DeprecatedGlobalSettings::setResourceLoadStatisticsEnabled(enable);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 4596,10 ***</span>
<span class="line-new-header">--- 4700,63 ---</span>
      document-&gt;postTask([callback = WTFMove(callback)](ScriptExecutionContext&amp;) {
          callback-&gt;handleEvent();
      });
  }
  
<span class="line-added">+ static Optional&lt;TaskSource&gt; taskSourceFromString(const String&amp; taskSourceName)</span>
<span class="line-added">+ {</span>
<span class="line-added">+     if (taskSourceName == &quot;DOMManipulation&quot;)</span>
<span class="line-added">+         return TaskSource::DOMManipulation;</span>
<span class="line-added">+     return WTF::nullopt;</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ ExceptionOr&lt;void&gt; Internals::queueTask(ScriptExecutionContext&amp; context, const String&amp; taskSourceName, RefPtr&lt;VoidCallback&gt;&amp;&amp; callback)</span>
<span class="line-added">+ {</span>
<span class="line-added">+     auto source = taskSourceFromString(taskSourceName);</span>
<span class="line-added">+     if (!source)</span>
<span class="line-added">+         return Exception { NotSupportedError };</span>
<span class="line-added">+ </span>
<span class="line-added">+     context.eventLoop().queueTask(*source, [callback = WTFMove(callback)] {</span>
<span class="line-added">+         callback-&gt;handleEvent();</span>
<span class="line-added">+     });</span>
<span class="line-added">+ </span>
<span class="line-added">+     return { };</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ ExceptionOr&lt;void&gt; Internals::queueTaskToQueueMicrotask(Document&amp; document, const String&amp; taskSourceName, RefPtr&lt;VoidCallback&gt;&amp;&amp; callback)</span>
<span class="line-added">+ {</span>
<span class="line-added">+     auto source = taskSourceFromString(taskSourceName);</span>
<span class="line-added">+     if (!source)</span>
<span class="line-added">+         return Exception { NotSupportedError };</span>
<span class="line-added">+ </span>
<span class="line-added">+     ScriptExecutionContext&amp; context = document; // This avoids unnecessarily exporting Document::eventLoop.</span>
<span class="line-added">+     context.eventLoop().queueTask(*source, [movedCallback = WTFMove(callback), protectedDocument = makeRef(document)]() mutable {</span>
<span class="line-added">+         ScriptExecutionContext&amp; context = protectedDocument.get();</span>
<span class="line-added">+         context.eventLoop().queueMicrotask([callback = WTFMove(movedCallback)] {</span>
<span class="line-added">+             callback-&gt;handleEvent();</span>
<span class="line-added">+         });</span>
<span class="line-added">+     });</span>
<span class="line-added">+ </span>
<span class="line-added">+     return { };</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ ExceptionOr&lt;bool&gt; Internals::hasSameEventLoopAs(WindowProxy&amp; proxy)</span>
<span class="line-added">+ {</span>
<span class="line-added">+     RefPtr&lt;ScriptExecutionContext&gt; context = contextDocument();</span>
<span class="line-added">+     if (!context || !proxy.frame())</span>
<span class="line-added">+         return Exception { InvalidStateError };</span>
<span class="line-added">+ </span>
<span class="line-added">+     auto&amp; proxyFrame = *proxy.frame();</span>
<span class="line-added">+     if (!is&lt;Frame&gt;(proxyFrame))</span>
<span class="line-added">+         return false;</span>
<span class="line-added">+     RefPtr&lt;ScriptExecutionContext&gt; proxyContext = downcast&lt;Frame&gt;(proxyFrame).document();</span>
<span class="line-added">+     if (!proxyContext)</span>
<span class="line-added">+         return Exception { InvalidStateError };</span>
<span class="line-added">+ </span>
<span class="line-added">+     return context-&gt;eventLoop().hasSameEventLoopAs(proxyContext-&gt;eventLoop());</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
  Vector&lt;String&gt; Internals::accessKeyModifiers() const
  {
      Vector&lt;String&gt; accessKeyModifierStrings;
  
      for (auto modifier : EventHandler::accessKeyModifiers()) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 4630,11 ***</span>
  
  void Internals::setQuickLookPassword(const String&amp; password)
  {
  #if PLATFORM(IOS_FAMILY) &amp;&amp; USE(QUICK_LOOK)
      auto&amp; quickLookHandleClient = MockPreviewLoaderClient::singleton();
<span class="line-modified">!     PreviewLoader::setClientForTesting(&amp;quickLookHandleClient);</span>
      quickLookHandleClient.setPassword(password);
  #else
      UNUSED_PARAM(password);
  #endif
  }
<span class="line-new-header">--- 4787,11 ---</span>
  
  void Internals::setQuickLookPassword(const String&amp; password)
  {
  #if PLATFORM(IOS_FAMILY) &amp;&amp; USE(QUICK_LOOK)
      auto&amp; quickLookHandleClient = MockPreviewLoaderClient::singleton();
<span class="line-modified">!     LegacyPreviewLoader::setClientForTesting(&amp;quickLookHandleClient);</span>
      quickLookHandleClient.setPassword(password);
  #else
      UNUSED_PARAM(password);
  #endif
  }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 4738,11 ***</span>
      m_track-&gt;source().addObserver(*this);
  }
  
  void Internals::grabNextMediaStreamTrackFrame(TrackFramePromise&amp;&amp; promise)
  {
<span class="line-modified">!     m_nextTrackFramePromise = WTFMove(promise);</span>
  }
  
  void Internals::videoSampleAvailable(MediaSample&amp; sample)
  {
      m_trackVideoSampleCount++;
<span class="line-new-header">--- 4895,11 ---</span>
      m_track-&gt;source().addObserver(*this);
  }
  
  void Internals::grabNextMediaStreamTrackFrame(TrackFramePromise&amp;&amp; promise)
  {
<span class="line-modified">!     m_nextTrackFramePromise = WTF::makeUnique&lt;TrackFramePromise&gt;(promise);</span>
  }
  
  void Internals::videoSampleAvailable(MediaSample&amp; sample)
  {
      m_trackVideoSampleCount++;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 4760,11 ***</span>
      auto imageData = ImageData::create(rgba.releaseNonNull(), videoSettings.width(), videoSettings.height());
      if (!imageData.hasException())
          m_nextTrackFramePromise-&gt;resolve(imageData.releaseReturnValue().releaseNonNull());
      else
          m_nextTrackFramePromise-&gt;reject(imageData.exception().code());
<span class="line-modified">!     m_nextTrackFramePromise = WTF::nullopt;</span>
  }
  
  void Internals::delayMediaStreamTrackSamples(MediaStreamTrack&amp; track, float delay)
  {
      track.source().delaySamples(Seconds { delay });
<span class="line-new-header">--- 4917,11 ---</span>
      auto imageData = ImageData::create(rgba.releaseNonNull(), videoSettings.width(), videoSettings.height());
      if (!imageData.hasException())
          m_nextTrackFramePromise-&gt;resolve(imageData.releaseReturnValue().releaseNonNull());
      else
          m_nextTrackFramePromise-&gt;reject(imageData.exception().code());
<span class="line-modified">!     m_nextTrackFramePromise = nullptr;</span>
  }
  
  void Internals::delayMediaStreamTrackSamples(MediaStreamTrack&amp; track, float delay)
  {
      track.source().delaySamples(Seconds { delay });
</pre>
<hr />
<pre>
<span class="line-old-header">*** 4793,21 ***</span>
  void Internals::setMediaStreamSourceInterrupted(MediaStreamTrack&amp; track, bool interrupted)
  {
      track.source().setInterruptedForTesting(interrupted);
  }
  
<span class="line-modified">! void Internals::setDisableGetDisplayMediaUserGestureConstraint(bool value)</span>
  {
<span class="line-modified">!     Document* document = contextDocument();</span>
<span class="line-removed">-     if (!document || !document-&gt;domWindow())</span>
<span class="line-removed">-         return;</span>
<span class="line-removed">- </span>
<span class="line-removed">-     if (auto* mediaDevices = NavigatorMediaDevices::mediaDevices(document-&gt;domWindow()-&gt;navigator()))</span>
<span class="line-removed">-         mediaDevices-&gt;setDisableGetDisplayMediaUserGestureConstraint(value);</span>
  }
  #endif
  
  String Internals::audioSessionCategory() const
  {
  #if USE(AUDIO_SESSION)
      switch (AudioSession::sharedSession().category()) {
      case AudioSession::AmbientSound:
<span class="line-new-header">--- 4950,25 ---</span>
  void Internals::setMediaStreamSourceInterrupted(MediaStreamTrack&amp; track, bool interrupted)
  {
      track.source().setInterruptedForTesting(interrupted);
  }
  
<span class="line-modified">! bool Internals::isMockRealtimeMediaSourceCenterEnabled()</span>
  {
<span class="line-modified">!     return MockRealtimeMediaSourceCenter::mockRealtimeMediaSourceCenterEnabled();</span>
  }
  #endif
  
<span class="line-added">+ bool Internals::supportsAudioSession() const</span>
<span class="line-added">+ {</span>
<span class="line-added">+ #if USE(AUDIO_SESSION)</span>
<span class="line-added">+     return true;</span>
<span class="line-added">+ #else</span>
<span class="line-added">+     return false;</span>
<span class="line-added">+ #endif</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
  String Internals::audioSessionCategory() const
  {
  #if USE(AUDIO_SESSION)
      switch (AudioSession::sharedSession().category()) {
      case AudioSession::AmbientSound:
</pre>
<hr />
<pre>
<span class="line-old-header">*** 4849,11 ***</span>
  {
  #if ENABLE(SERVICE_WORKER)
      if (!contextDocument())
          return;
  
<span class="line-modified">!     auto&amp; connection = ServiceWorkerProvider::singleton().serviceWorkerConnectionForSession(contextDocument()-&gt;sessionID());</span>
      connection.storeRegistrationsOnDiskForTesting([promise = WTFMove(promise)]() mutable {
          promise.resolve();
      });
  #else
      promise.resolve();
<span class="line-new-header">--- 5010,11 ---</span>
  {
  #if ENABLE(SERVICE_WORKER)
      if (!contextDocument())
          return;
  
<span class="line-modified">!     auto&amp; connection = ServiceWorkerProvider::singleton().serviceWorkerConnection();</span>
      connection.storeRegistrationsOnDiskForTesting([promise = WTFMove(promise)]() mutable {
          promise.resolve();
      });
  #else
      promise.resolve();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 4866,11 ***</span>
      if (!document)
          return;
  
      if (!m_cacheStorageConnection) {
          if (auto* page = contextDocument()-&gt;page())
<span class="line-modified">!             m_cacheStorageConnection = page-&gt;cacheStorageProvider().createCacheStorageConnection(page-&gt;sessionID());</span>
          if (!m_cacheStorageConnection)
              return;
      }
      m_cacheStorageConnection-&gt;clearMemoryRepresentation(ClientOrigin { document-&gt;topOrigin().data(), document-&gt;securityOrigin().data() }, [promise = WTFMove(promise)] (auto &amp;&amp; result) mutable {
          ASSERT_UNUSED(result, !result);
<span class="line-new-header">--- 5027,11 ---</span>
      if (!document)
          return;
  
      if (!m_cacheStorageConnection) {
          if (auto* page = contextDocument()-&gt;page())
<span class="line-modified">!             m_cacheStorageConnection = page-&gt;cacheStorageProvider().createCacheStorageConnection();</span>
          if (!m_cacheStorageConnection)
              return;
      }
      m_cacheStorageConnection-&gt;clearMemoryRepresentation(ClientOrigin { document-&gt;topOrigin().data(), document-&gt;securityOrigin().data() }, [promise = WTFMove(promise)] (auto &amp;&amp; result) mutable {
          ASSERT_UNUSED(result, !result);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 4884,11 ***</span>
      if (!document)
          return;
  
      if (!m_cacheStorageConnection) {
          if (auto* page = contextDocument()-&gt;page())
<span class="line-modified">!             m_cacheStorageConnection = page-&gt;cacheStorageProvider().createCacheStorageConnection(page-&gt;sessionID());</span>
          if (!m_cacheStorageConnection)
              return;
      }
      m_cacheStorageConnection-&gt;engineRepresentation([promise = WTFMove(promise)](const String&amp; result) mutable {
          promise.resolve(result);
<span class="line-new-header">--- 5045,11 ---</span>
      if (!document)
          return;
  
      if (!m_cacheStorageConnection) {
          if (auto* page = contextDocument()-&gt;page())
<span class="line-modified">!             m_cacheStorageConnection = page-&gt;cacheStorageProvider().createCacheStorageConnection();</span>
          if (!m_cacheStorageConnection)
              return;
      }
      m_cacheStorageConnection-&gt;engineRepresentation([promise = WTFMove(promise)](const String&amp; result) mutable {
          promise.resolve(result);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 4901,11 ***</span>
      if (!document)
          return;
  
      if (!m_cacheStorageConnection) {
          if (auto* page = contextDocument()-&gt;page())
<span class="line-modified">!             m_cacheStorageConnection = page-&gt;cacheStorageProvider().createCacheStorageConnection(page-&gt;sessionID());</span>
          if (!m_cacheStorageConnection)
              return;
      }
  
      m_cacheStorageConnection-&gt;updateQuotaBasedOnSpaceUsage(ClientOrigin { document-&gt;topOrigin().data(), document-&gt;securityOrigin().data() });
<span class="line-new-header">--- 5062,11 ---</span>
      if (!document)
          return;
  
      if (!m_cacheStorageConnection) {
          if (auto* page = contextDocument()-&gt;page())
<span class="line-modified">!             m_cacheStorageConnection = page-&gt;cacheStorageProvider().createCacheStorageConnection();</span>
          if (!m_cacheStorageConnection)
              return;
      }
  
      m_cacheStorageConnection-&gt;updateQuotaBasedOnSpaceUsage(ClientOrigin { document-&gt;topOrigin().data(), document-&gt;securityOrigin().data() });
</pre>
<hr />
<pre>
<span class="line-old-header">*** 4935,29 ***</span>
      if (!contextDocument())
          return;
  
      URL parsedURL = contextDocument()-&gt;completeURL(clientURL);
  
<span class="line-modified">!     return ServiceWorkerProvider::singleton().serviceWorkerConnectionForSession(contextDocument()-&gt;sessionID()).matchRegistration(SecurityOriginData { contextDocument()-&gt;topOrigin().data() }, parsedURL, [promise = WTFMove(promise)] (auto&amp;&amp; result) mutable {</span>
          promise.resolve(!!result);
      });
  }
  
  void Internals::terminateServiceWorker(ServiceWorker&amp; worker)
  {
      if (!contextDocument())
          return;
  
<span class="line-modified">!     ServiceWorkerProvider::singleton().serviceWorkerConnectionForSession(contextDocument()-&gt;sessionID()).syncTerminateWorker(worker.identifier());</span>
  }
  
<span class="line-modified">! bool Internals::hasServiceWorkerConnection()</span>
  {
<span class="line-modified">!     if (!contextDocument())</span>
<span class="line-modified">!         return false;</span>
<span class="line-modified">! </span>
<span class="line-removed">-     return ServiceWorkerProvider::singleton().existingServiceWorkerConnectionForSession(contextDocument()-&gt;sessionID());</span>
  }
  #endif
  
  #if ENABLE(APPLE_PAY)
  MockPaymentCoordinator&amp; Internals::mockPaymentCoordinator(Document&amp; document)
<span class="line-new-header">--- 5096,28 ---</span>
      if (!contextDocument())
          return;
  
      URL parsedURL = contextDocument()-&gt;completeURL(clientURL);
  
<span class="line-modified">!     return ServiceWorkerProvider::singleton().serviceWorkerConnection().matchRegistration(SecurityOriginData { contextDocument()-&gt;topOrigin().data() }, parsedURL, [promise = WTFMove(promise)] (auto&amp;&amp; result) mutable {</span>
          promise.resolve(!!result);
      });
  }
  
  void Internals::terminateServiceWorker(ServiceWorker&amp; worker)
  {
      if (!contextDocument())
          return;
  
<span class="line-modified">!     ServiceWorkerProvider::singleton().serviceWorkerConnection().syncTerminateWorker(worker.identifier());</span>
  }
  
<span class="line-modified">! void Internals::isServiceWorkerRunning(ServiceWorker&amp; worker, DOMPromiseDeferred&lt;IDLBoolean&gt;&amp;&amp; promise)</span>
  {
<span class="line-modified">!     return ServiceWorkerProvider::singleton().serviceWorkerConnection().isServiceWorkerRunning(worker.identifier(), [promise = WTFMove(promise)](bool result) mutable {</span>
<span class="line-modified">!         promise.resolve(result);</span>
<span class="line-modified">!     });</span>
  }
  #endif
  
  #if ENABLE(APPLE_PAY)
  MockPaymentCoordinator&amp; Internals::mockPaymentCoordinator(Document&amp; document)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 5078,10 ***</span>
<span class="line-new-header">--- 5238,15 ---</span>
  Optional&lt;HEVCParameterSet&gt; Internals::parseHEVCCodecParameters(const String&amp; codecString)
  {
      return WebCore::parseHEVCCodecParameters(codecString);
  }
  
<span class="line-added">+ Optional&lt;DoViParameterSet&gt; Internals::parseDoViCodecParameters(const String&amp; codecString)</span>
<span class="line-added">+ {</span>
<span class="line-added">+     return WebCore::parseDoViCodecParameters(codecString);</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
  auto Internals::getCookies() const -&gt; Vector&lt;CookieData&gt;
  {
      auto* document = contextDocument();
      if (!document)
          return { };
</pre>
<hr />
<pre>
<span class="line-old-header">*** 5105,16 ***</span>
<span class="line-new-header">--- 5270,20 ---</span>
      localFrame-&gt;loader().setAlwaysAllowLocalWebarchive(alwaysAllowLocalWebarchive);
  }
  
  void Internals::processWillSuspend()
  {
<span class="line-added">+ #if ENABLE(VIDEO) || ENABLE(WEB_AUDIO)</span>
      PlatformMediaSessionManager::sharedManager().processWillSuspend();
<span class="line-added">+ #endif</span>
  }
  
  void Internals::processDidResume()
  {
<span class="line-added">+ #if ENABLE(VIDEO) || ENABLE(WEB_AUDIO)</span>
      PlatformMediaSessionManager::sharedManager().processDidResume();
<span class="line-added">+ #endif</span>
  }
  
  void Internals::testDictionaryLogging()
  {
      auto* document = contextDocument();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 5138,13 ***</span>
<span class="line-new-header">--- 5307,36 ---</span>
  void Internals::setXHRMaximumIntervalForUserGestureForwarding(XMLHttpRequest&amp; request, double interval)
  {
      request.setMaximumIntervalForUserGestureForwarding(interval);
  }
  
<span class="line-added">+ void Internals::setTransientActivationDuration(double seconds)</span>
<span class="line-added">+ {</span>
<span class="line-added">+     DOMWindow::overrideTransientActivationDurationForTesting(Seconds { seconds });</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
  void Internals::setIsPlayingToAutomotiveHeadUnit(bool isPlaying)
  {
<span class="line-added">+ #if ENABLE(VIDEO) || ENABLE(WEB_AUDIO)</span>
      PlatformMediaSessionManager::sharedManager().setIsPlayingToAutomotiveHeadUnit(isPlaying);
<span class="line-added">+ #endif</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ String Internals::highlightPseudoElementColor(const String&amp; highlightName, Element&amp; element)</span>
<span class="line-added">+ {</span>
<span class="line-added">+     element.document().updateStyleIfNeeded();</span>
<span class="line-added">+ </span>
<span class="line-added">+     auto&amp; styleResolver = element.document().styleScope().resolver();</span>
<span class="line-added">+     auto* parentStyle = element.computedStyle();</span>
<span class="line-added">+     if (!parentStyle)</span>
<span class="line-added">+         return { };</span>
<span class="line-added">+ </span>
<span class="line-added">+     auto style = styleResolver.pseudoStyleForElement(element, { PseudoId::Highlight, highlightName }, *parentStyle);</span>
<span class="line-added">+     if (!style)</span>
<span class="line-added">+         return { };</span>
<span class="line-added">+ </span>
<span class="line-added">+     return style-&gt;color().cssText();</span>
  }
  
  Internals::TextIndicatorInfo::TextIndicatorInfo()
  {
  }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 5163,10 ***</span>
      return indicator-&gt;data();
  }
  
  void Internals::addPrefetchLoadEventListener(HTMLLinkElement&amp; link, RefPtr&lt;EventListener&gt;&amp;&amp; listener)
  {
<span class="line-modified">!     if (RuntimeEnabledFeatures::sharedFeatures().linkPrefetchEnabled() &amp;&amp; equalLettersIgnoringASCIICase(link.rel(), &quot;prefetch&quot;))</span>
          link.addEventListener(eventNames().loadEvent, listener.releaseNonNull(), false);
  }
  
  } // namespace WebCore
<span class="line-new-header">--- 5355,125 ---</span>
      return indicator-&gt;data();
  }
  
  void Internals::addPrefetchLoadEventListener(HTMLLinkElement&amp; link, RefPtr&lt;EventListener&gt;&amp;&amp; listener)
  {
<span class="line-modified">!     if (RuntimeEnabledFeatures::sharedFeatures().linkPrefetchEnabled() &amp;&amp; equalLettersIgnoringASCIICase(link.rel(), &quot;prefetch&quot;)) {</span>
<span class="line-added">+         link.allowPrefetchLoadAndErrorForTesting();</span>
          link.addEventListener(eventNames().loadEvent, listener.releaseNonNull(), false);
<span class="line-added">+     }</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ #if ENABLE(WEB_AUTHN)</span>
<span class="line-added">+ void Internals::setMockWebAuthenticationConfiguration(const MockWebAuthenticationConfiguration&amp; configuration)</span>
<span class="line-added">+ {</span>
<span class="line-added">+     auto* document = contextDocument();</span>
<span class="line-added">+     if (!document)</span>
<span class="line-added">+         return;</span>
<span class="line-added">+     auto* page = document-&gt;page();</span>
<span class="line-added">+     if (!page)</span>
<span class="line-added">+         return;</span>
<span class="line-added">+     page-&gt;chrome().client().setMockWebAuthenticationConfiguration(configuration);</span>
<span class="line-added">+ }</span>
<span class="line-added">+ #endif</span>
<span class="line-added">+ </span>
<span class="line-added">+ #if ENABLE(PICTURE_IN_PICTURE_API)</span>
<span class="line-added">+ void Internals::setPictureInPictureAPITestEnabled(HTMLVideoElement&amp; videoElement, bool enabled)</span>
<span class="line-added">+ {</span>
<span class="line-added">+     videoElement.setPictureInPictureAPITestEnabled(enabled);</span>
<span class="line-added">+ }</span>
<span class="line-added">+ #endif</span>
<span class="line-added">+ </span>
<span class="line-added">+ void Internals::setMaxCanvasPixelMemory(unsigned size)</span>
<span class="line-added">+ {</span>
<span class="line-added">+     HTMLCanvasElement::setMaxPixelMemoryForTesting(size);</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ int Internals::processIdentifier() const</span>
<span class="line-added">+ {</span>
<span class="line-added">+     return getCurrentProcessID();</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ Ref&lt;InternalsMapLike&gt; Internals::createInternalsMapLike()</span>
<span class="line-added">+ {</span>
<span class="line-added">+     return InternalsMapLike::create();</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ Ref&lt;InternalsSetLike&gt; Internals::createInternalsSetLike()</span>
<span class="line-added">+ {</span>
<span class="line-added">+     return InternalsSetLike::create();</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ bool Internals::hasSandboxMachLookupAccessToGlobalName(const String&amp; process, const String&amp; service)</span>
<span class="line-added">+ {</span>
<span class="line-added">+ #if PLATFORM(COCOA)</span>
<span class="line-added">+     pid_t pid;</span>
<span class="line-added">+     if (process == &quot;com.apple.WebKit.WebContent&quot;)</span>
<span class="line-added">+         pid = getpid();</span>
<span class="line-added">+     else</span>
<span class="line-added">+         RELEASE_ASSERT_NOT_REACHED();</span>
<span class="line-added">+ </span>
<span class="line-added">+     return !sandbox_check(pid, &quot;mach-lookup&quot;, static_cast&lt;enum sandbox_filter_type&gt;(SANDBOX_FILTER_GLOBAL_NAME | SANDBOX_CHECK_NO_REPORT), service.utf8().data());</span>
<span class="line-added">+ #else</span>
<span class="line-added">+     UNUSED_PARAM(process);</span>
<span class="line-added">+     UNUSED_PARAM(service);</span>
<span class="line-added">+     return false;</span>
<span class="line-added">+ #endif</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ bool Internals::hasSandboxMachLookupAccessToXPCServiceName(const String&amp; process, const String&amp; service)</span>
<span class="line-added">+ {</span>
<span class="line-added">+ #if PLATFORM(COCOA)</span>
<span class="line-added">+     pid_t pid;</span>
<span class="line-added">+     if (process == &quot;com.apple.WebKit.WebContent&quot;)</span>
<span class="line-added">+         pid = getpid();</span>
<span class="line-added">+     else</span>
<span class="line-added">+         RELEASE_ASSERT_NOT_REACHED();</span>
<span class="line-added">+ </span>
<span class="line-added">+     return !sandbox_check(pid, &quot;mach-lookup&quot;, static_cast&lt;enum sandbox_filter_type&gt;(SANDBOX_FILTER_XPC_SERVICE_NAME | SANDBOX_CHECK_NO_REPORT), service.utf8().data());</span>
<span class="line-added">+ #else</span>
<span class="line-added">+     UNUSED_PARAM(process);</span>
<span class="line-added">+     UNUSED_PARAM(service);</span>
<span class="line-added">+     return false;</span>
<span class="line-added">+ #endif</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ String Internals::windowLocationHost(DOMWindow&amp; window)</span>
<span class="line-added">+ {</span>
<span class="line-added">+     return window.location().host();</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ String Internals::systemColorForCSSValue(const String&amp; cssValue, bool useDarkModeAppearance, bool useElevatedUserInterfaceLevel)</span>
<span class="line-added">+ {</span>
<span class="line-added">+     CSSValueID id = cssValueKeywordID(cssValue);</span>
<span class="line-added">+     RELEASE_ASSERT(StyleColor::isSystemColor(id));</span>
<span class="line-added">+ </span>
<span class="line-added">+     OptionSet&lt;StyleColor::Options&gt; options;</span>
<span class="line-added">+     if (useDarkModeAppearance)</span>
<span class="line-added">+         options.add(StyleColor::Options::UseDarkAppearance);</span>
<span class="line-added">+     if (useElevatedUserInterfaceLevel)</span>
<span class="line-added">+         options.add(StyleColor::Options::UseElevatedUserInterfaceLevel);</span>
<span class="line-added">+ </span>
<span class="line-added">+     return RenderTheme::singleton().systemColor(id, options).cssText();</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ bool Internals::systemHasBattery() const</span>
<span class="line-added">+ {</span>
<span class="line-added">+ #if PLATFORM(COCOA)</span>
<span class="line-added">+     return WebCore::systemHasBattery();</span>
<span class="line-added">+ #else</span>
<span class="line-added">+     return false;</span>
<span class="line-added">+ #endif</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ String Internals::mediaMIMETypeForExtension(const String&amp; extension)</span>
<span class="line-added">+ {</span>
<span class="line-added">+     return MIMETypeRegistry::getMediaMIMETypeForExtension(extension);</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ String Internals::focusRingColor()</span>
<span class="line-added">+ {</span>
<span class="line-added">+     OptionSet&lt;StyleColor::Options&gt; options;</span>
<span class="line-added">+     return RenderTheme::singleton().focusRingColor(options).cssText();</span>
  }
  
  } // namespace WebCore
</pre>
<center><a href="InternalSettings.idl.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="Internals.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>