<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New modules/javafx.web/src/main/native/Source/WebCore/bindings/js/JSDOMGlobalObject.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (C) 2008-2018 Apple Inc. All Rights Reserved.
  3  *
  4  * Redistribution and use in source and binary forms, with or without
  5  * modification, are permitted provided that the following conditions
  6  * are met:
  7  * 1. Redistributions of source code must retain the above copyright
  8  *    notice, this list of conditions and the following disclaimer.
  9  * 2. Redistributions in binary form must reproduce the above copyright
 10  *    notice, this list of conditions and the following disclaimer in the
 11  *    documentation and/or other materials provided with the distribution.
 12  *
 13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. ``AS IS&#39;&#39; AND ANY
 14  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 15  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 16  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE INC. OR
 17  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 18  * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 19  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 20  * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 21  * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 22  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 23  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 24  *
 25  */
 26 
 27 #include &quot;config.h&quot;
 28 #include &quot;JSDOMGlobalObject.h&quot;
 29 
 30 #include &quot;DOMWindow.h&quot;
 31 #include &quot;Document.h&quot;
 32 #include &quot;JSDOMPromiseDeferred.h&quot;
 33 #include &quot;JSDOMWindow.h&quot;
 34 #include &quot;JSEventListener.h&quot;
 35 #include &quot;JSMediaStream.h&quot;
 36 #include &quot;JSMediaStreamTrack.h&quot;
 37 #include &quot;JSRTCIceCandidate.h&quot;
 38 #include &quot;JSRTCSessionDescription.h&quot;
 39 #include &quot;JSReadableStream.h&quot;
 40 #include &quot;JSRemoteDOMWindow.h&quot;
 41 #include &quot;JSWorkerGlobalScope.h&quot;
 42 #include &quot;JSWorkletGlobalScope.h&quot;
 43 #include &quot;RejectedPromiseTracker.h&quot;
 44 #include &quot;RuntimeEnabledFeatures.h&quot;
 45 #include &quot;StructuredClone.h&quot;
 46 #include &quot;WebCoreJSClientData.h&quot;
 47 #include &quot;WorkerGlobalScope.h&quot;
 48 #include &lt;JavaScriptCore/BuiltinNames.h&gt;
 49 #include &lt;JavaScriptCore/CodeBlock.h&gt;
 50 #include &lt;JavaScriptCore/JSInternalPromise.h&gt;
 51 #include &lt;JavaScriptCore/StructureInlines.h&gt;
 52 
 53 namespace WebCore {
 54 using namespace JSC;
 55 
 56 EncodedJSValue JSC_HOST_CALL makeThisTypeErrorForBuiltins(JSGlobalObject*, CallFrame*);
 57 EncodedJSValue JSC_HOST_CALL makeGetterTypeErrorForBuiltins(JSGlobalObject*, CallFrame*);
 58 EncodedJSValue JSC_HOST_CALL isReadableByteStreamAPIEnabled(JSGlobalObject*, CallFrame*);
 59 
 60 const ClassInfo JSDOMGlobalObject::s_info = { &quot;DOMGlobalObject&quot;, &amp;JSGlobalObject::s_info, nullptr, nullptr, CREATE_METHOD_TABLE(JSDOMGlobalObject) };
 61 
 62 JSDOMGlobalObject::JSDOMGlobalObject(VM&amp; vm, Structure* structure, Ref&lt;DOMWrapperWorld&gt;&amp;&amp; world, const GlobalObjectMethodTable* globalObjectMethodTable)
 63     : JSGlobalObject(vm, structure, globalObjectMethodTable)
 64     , m_world(WTFMove(world))
 65     , m_worldIsNormal(m_world-&gt;isNormal())
 66     , m_builtinInternalFunctions(vm)
 67 {
 68 }
 69 
 70 JSDOMGlobalObject::~JSDOMGlobalObject() = default;
 71 
 72 void JSDOMGlobalObject::destroy(JSCell* cell)
 73 {
 74     static_cast&lt;JSDOMGlobalObject*&gt;(cell)-&gt;JSDOMGlobalObject::~JSDOMGlobalObject();
 75 }
 76 
 77 EncodedJSValue JSC_HOST_CALL makeThisTypeErrorForBuiltins(JSGlobalObject* globalObject, CallFrame* callFrame)
 78 {
 79     ASSERT(callFrame);
 80     ASSERT(callFrame-&gt;argumentCount() == 2);
 81     VM&amp; vm = globalObject-&gt;vm();
 82     auto scope = DECLARE_CATCH_SCOPE(vm);
 83 
 84     auto interfaceName = callFrame-&gt;uncheckedArgument(0).getString(globalObject);
 85     scope.assertNoException();
 86     auto functionName = callFrame-&gt;uncheckedArgument(1).getString(globalObject);
 87     scope.assertNoException();
 88     return JSValue::encode(createTypeError(globalObject, makeThisTypeErrorMessage(interfaceName.utf8().data(), functionName.utf8().data())));
 89 }
 90 
 91 EncodedJSValue JSC_HOST_CALL makeGetterTypeErrorForBuiltins(JSGlobalObject* globalObject, CallFrame* callFrame)
 92 {
 93     ASSERT(callFrame);
 94     ASSERT(callFrame-&gt;argumentCount() == 2);
 95     VM&amp; vm = globalObject-&gt;vm();
 96     auto scope = DECLARE_CATCH_SCOPE(vm);
 97 
 98     auto interfaceName = callFrame-&gt;uncheckedArgument(0).getString(globalObject);
 99     scope.assertNoException();
100     auto attributeName = callFrame-&gt;uncheckedArgument(1).getString(globalObject);
101     scope.assertNoException();
102 
103     auto error = static_cast&lt;ErrorInstance*&gt;(createTypeError(globalObject, makeGetterTypeErrorMessage(interfaceName.utf8().data(), attributeName.utf8().data())));
104     error-&gt;setNativeGetterTypeError();
105     return JSValue::encode(error);
106 }
107 
108 #if ENABLE(STREAMS_API)
109 EncodedJSValue JSC_HOST_CALL isReadableByteStreamAPIEnabled(JSGlobalObject*, CallFrame*)
110 {
111     return JSValue::encode(jsBoolean(RuntimeEnabledFeatures::sharedFeatures().readableByteStreamAPIEnabled()));
112 }
113 #endif
114 
115 void JSDOMGlobalObject::addBuiltinGlobals(VM&amp; vm)
116 {
117     m_builtinInternalFunctions.initialize(*this);
118 
119     JSVMClientData&amp; clientData = *static_cast&lt;JSVMClientData*&gt;(vm.clientData);
120     JSDOMGlobalObject::GlobalPropertyInfo staticGlobals[] = {
121         JSDOMGlobalObject::GlobalPropertyInfo(clientData.builtinNames().makeThisTypeErrorPrivateName(),
122             JSFunction::create(vm, this, 2, String(), makeThisTypeErrorForBuiltins), PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
123         JSDOMGlobalObject::GlobalPropertyInfo(clientData.builtinNames().makeGetterTypeErrorPrivateName(),
124             JSFunction::create(vm, this, 2, String(), makeGetterTypeErrorForBuiltins), PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
125         JSDOMGlobalObject::GlobalPropertyInfo(clientData.builtinNames().cloneArrayBufferPrivateName(),
126             JSFunction::create(vm, this, 3, String(), cloneArrayBuffer), PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
127         JSDOMGlobalObject::GlobalPropertyInfo(clientData.builtinNames().structuredCloneArrayBufferPrivateName(),
128             JSFunction::create(vm, this, 1, String(), structuredCloneArrayBuffer), PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
129         JSDOMGlobalObject::GlobalPropertyInfo(clientData.builtinNames().structuredCloneArrayBufferViewPrivateName(),
130             JSFunction::create(vm, this, 1, String(), structuredCloneArrayBufferView), PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
131         JSDOMGlobalObject::GlobalPropertyInfo(vm.propertyNames-&gt;builtinNames().ArrayBufferPrivateName(), arrayBufferConstructor(), PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
132 #if ENABLE(STREAMS_API)
133         JSDOMGlobalObject::GlobalPropertyInfo(clientData.builtinNames().streamClosedPrivateName(), jsNumber(1), PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
134         JSDOMGlobalObject::GlobalPropertyInfo(clientData.builtinNames().streamClosingPrivateName(), jsNumber(2), PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
135         JSDOMGlobalObject::GlobalPropertyInfo(clientData.builtinNames().streamErroredPrivateName(), jsNumber(3), PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
136         JSDOMGlobalObject::GlobalPropertyInfo(clientData.builtinNames().streamReadablePrivateName(), jsNumber(4), PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
137         JSDOMGlobalObject::GlobalPropertyInfo(clientData.builtinNames().streamWaitingPrivateName(), jsNumber(5), PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
138         JSDOMGlobalObject::GlobalPropertyInfo(clientData.builtinNames().streamWritablePrivateName(), jsNumber(6), PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
139         JSDOMGlobalObject::GlobalPropertyInfo(clientData.builtinNames().readableByteStreamAPIEnabledPrivateName(), JSFunction::create(vm, this, 0, String(), isReadableByteStreamAPIEnabled), PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
140 #endif
141     };
142     addStaticGlobals(staticGlobals, WTF_ARRAY_LENGTH(staticGlobals));
143 }
144 
145 void JSDOMGlobalObject::finishCreation(VM&amp; vm)
146 {
147     Base::finishCreation(vm);
148     ASSERT(inherits(vm, info()));
149 
150     addBuiltinGlobals(vm);
151 
152     RELEASE_ASSERT(classInfo(vm));
153 }
154 
155 void JSDOMGlobalObject::finishCreation(VM&amp; vm, JSObject* thisValue)
156 {
157     Base::finishCreation(vm, thisValue);
158     ASSERT(inherits(vm, info()));
159 
160     addBuiltinGlobals(vm);
161 
162     RELEASE_ASSERT(classInfo(vm));
163 }
164 
165 ScriptExecutionContext* JSDOMGlobalObject::scriptExecutionContext() const
166 {
167     if (inherits&lt;JSDOMWindowBase&gt;(vm()))
168         return jsCast&lt;const JSDOMWindowBase*&gt;(this)-&gt;scriptExecutionContext();
169     if (inherits&lt;JSRemoteDOMWindowBase&gt;(vm()))
170         return nullptr;
171     if (inherits&lt;JSWorkerGlobalScopeBase&gt;(vm()))
172         return jsCast&lt;const JSWorkerGlobalScopeBase*&gt;(this)-&gt;scriptExecutionContext();
173 #if ENABLE(CSS_PAINTING_API)
174     if (inherits&lt;JSWorkletGlobalScopeBase&gt;(vm()))
175         return jsCast&lt;const JSWorkletGlobalScopeBase*&gt;(this)-&gt;scriptExecutionContext();
176 #endif
177     dataLog(&quot;Unexpected global object: &quot;, JSValue(this), &quot;\n&quot;);
178     RELEASE_ASSERT_NOT_REACHED();
179     return nullptr;
180 }
181 
182 void JSDOMGlobalObject::visitChildren(JSCell* cell, SlotVisitor&amp; visitor)
183 {
184     JSDOMGlobalObject* thisObject = jsCast&lt;JSDOMGlobalObject*&gt;(cell);
185     ASSERT_GC_OBJECT_INHERITS(thisObject, info());
186     Base::visitChildren(thisObject, visitor);
187 
188     {
189         auto locker = holdLock(thisObject-&gt;m_gcLock);
190 
191         for (auto&amp; structure : thisObject-&gt;structures(locker).values())
192             visitor.append(structure);
193 
194         for (auto&amp; constructor : thisObject-&gt;constructors(locker).values())
195             visitor.append(constructor);
196 
197         for (auto&amp; guarded : thisObject-&gt;guardedObjects(locker))
198             guarded-&gt;visitAggregate(visitor);
199     }
200 
201     thisObject-&gt;m_builtinInternalFunctions.visit(visitor);
202 }
203 
204 void JSDOMGlobalObject::setCurrentEvent(Event* currentEvent)
205 {
206     m_currentEvent = currentEvent;
207 }
208 
209 Event* JSDOMGlobalObject::currentEvent() const
210 {
211     return m_currentEvent;
212 }
213 
214 void JSDOMGlobalObject::promiseRejectionTracker(JSGlobalObject* jsGlobalObject, JSPromise* promise, JSPromiseRejectionOperation operation)
215 {
216     // https://html.spec.whatwg.org/multipage/webappapis.html#the-hostpromiserejectiontracker-implementation
217 
218     auto&amp; globalObject = *JSC::jsCast&lt;JSDOMGlobalObject*&gt;(jsGlobalObject);
219     auto* context = globalObject.scriptExecutionContext();
220     if (!context)
221         return;
222 
223     // FIXME: If script has muted errors (cross origin), terminate these steps.
224     // &lt;https://webkit.org/b/171415&gt; Implement the `muted-errors` property of Scripts to avoid onerror/onunhandledrejection for cross-origin scripts
225 
226     switch (operation) {
227     case JSPromiseRejectionOperation::Reject:
228         context-&gt;ensureRejectedPromiseTracker().promiseRejected(globalObject, *promise);
229         break;
230     case JSPromiseRejectionOperation::Handle:
231         context-&gt;ensureRejectedPromiseTracker().promiseHandled(globalObject, *promise);
232         break;
233     }
234 }
235 
236 JSDOMGlobalObject&amp; callerGlobalObject(JSGlobalObject&amp; lexicalGlobalObject, CallFrame&amp; callFrame)
237 {
238     class GetCallerGlobalObjectFunctor {
239     public:
240         GetCallerGlobalObjectFunctor() = default;
241 
242         StackVisitor::Status operator()(StackVisitor&amp; visitor) const
243         {
244             if (!m_hasSkippedFirstFrame) {
245                 m_hasSkippedFirstFrame = true;
246                 return StackVisitor::Continue;
247             }
248 
249             if (auto* codeBlock = visitor-&gt;codeBlock())
250                 m_globalObject = codeBlock-&gt;globalObject();
251             else {
252                 ASSERT(visitor-&gt;callee().rawPtr());
253                 // FIXME: Callee is not an object if the caller is Web Assembly.
254                 // Figure out what to do here. We can probably get the global object
255                 // from the top-most Wasm Instance. https://bugs.webkit.org/show_bug.cgi?id=165721
256                 if (visitor-&gt;callee().isCell() &amp;&amp; visitor-&gt;callee().asCell()-&gt;isObject())
257                     m_globalObject = jsCast&lt;JSObject*&gt;(visitor-&gt;callee().asCell())-&gt;globalObject();
258             }
259             return StackVisitor::Done;
260         }
261 
262         JSGlobalObject* globalObject() const { return m_globalObject; }
263 
264     private:
265         mutable bool m_hasSkippedFirstFrame { false };
266         mutable JSGlobalObject* m_globalObject { nullptr };
267     };
268 
269     GetCallerGlobalObjectFunctor iter;
270     callFrame.iterate(lexicalGlobalObject.vm(), iter);
271     if (iter.globalObject())
272         return *jsCast&lt;JSDOMGlobalObject*&gt;(iter.globalObject());
273 
274     // If we cannot find JSGlobalObject in caller frames, we just return the current lexicalGlobalObject.
275     return *jsCast&lt;JSDOMGlobalObject*&gt;(&amp;lexicalGlobalObject);
276 }
277 
278 JSDOMGlobalObject* toJSDOMGlobalObject(ScriptExecutionContext&amp; context, DOMWrapperWorld&amp; world)
279 {
280     if (is&lt;Document&gt;(context))
281         return toJSDOMWindow(downcast&lt;Document&gt;(context).frame(), world);
282 
283     if (is&lt;WorkerGlobalScope&gt;(context))
284         return downcast&lt;WorkerGlobalScope&gt;(context).script()-&gt;workerGlobalScopeWrapper();
285 
286     ASSERT_NOT_REACHED();
287     return nullptr;
288 }
289 
290 } // namespace WebCore
    </pre>
  </body>
</html>