<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WebCore/loader/HistoryController.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="HTTPHeaderField.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="ImageLoader.cpp.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/loader/HistoryController.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -29,10 +29,11 @@</span>
   */
  
  #include &quot;config.h&quot;
  #include &quot;HistoryController.h&quot;
  
<span class="udiff-line-added">+ #include &quot;BackForwardCache.h&quot;</span>
  #include &quot;BackForwardController.h&quot;
  #include &quot;CachedPage.h&quot;
  #include &quot;Document.h&quot;
  #include &quot;DocumentLoader.h&quot;
  #include &quot;Frame.h&quot;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -42,11 +43,10 @@</span>
  #include &quot;FrameTree.h&quot;
  #include &quot;FrameView.h&quot;
  #include &quot;HistoryItem.h&quot;
  #include &quot;Logging.h&quot;
  #include &quot;Page.h&quot;
<span class="udiff-line-removed">- #include &quot;PageCache.h&quot;</span>
  #include &quot;ScrollingCoordinator.h&quot;
  #include &quot;SerializedScriptValue.h&quot;
  #include &quot;SharedStringHash.h&quot;
  #include &quot;ShouldTreatAsContinuingLoad.h&quot;
  #include &quot;VisitedLinkStore.h&quot;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -72,11 +72,11 @@</span>
  {
      FrameView* frameView = m_frame.view();
      if (!item || !frameView)
          return;
  
<span class="udiff-line-modified-removed">-     if (m_frame.document()-&gt;pageCacheState() != Document::NotInPageCache)</span>
<span class="udiff-line-modified-added">+     if (m_frame.document()-&gt;backForwardCacheState() != Document::NotInBackForwardCache)</span>
          item-&gt;setScrollPosition(frameView-&gt;cachedScrollPosition());
      else
          item-&gt;setScrollPosition(frameView-&gt;scrollPosition());
  
  #if PLATFORM(IOS_FAMILY)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -135,13 +135,13 @@</span>
          return;
  
      auto view = makeRefPtr(m_frame.view());
  
      // FIXME: There is some scrolling related work that needs to happen whenever a page goes into the
<span class="udiff-line-modified-removed">-     // page cache and similar work that needs to occur when it comes out. This is where we do the work</span>
<span class="udiff-line-modified-added">+     // back/forward cache and similar work that needs to occur when it comes out. This is where we do the work</span>
      // that needs to happen when we exit, and the work that needs to happen when we enter is in
<span class="udiff-line-modified-removed">-     // Document::setIsInPageCache(bool). It would be nice if there was more symmetry in these spots.</span>
<span class="udiff-line-modified-added">+     // Document::setIsInBackForwardCache(bool). It would be nice if there was more symmetry in these spots.</span>
      // https://bugs.webkit.org/show_bug.cgi?id=98698
      if (view) {
          Page* page = m_frame.page();
          if (page &amp;&amp; m_frame.isMainFrame()) {
              if (ScrollingCoordinator* scrollingCoordinator = page-&gt;scrollingCoordinator())
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -259,22 +259,22 @@</span>
  void HistoryController::invalidateCurrentItemCachedPage()
  {
      if (!currentItem())
          return;
  
<span class="udiff-line-modified-removed">-     // When we are pre-commit, the currentItem is where any page cache data resides.</span>
<span class="udiff-line-modified-removed">-     std::unique_ptr&lt;CachedPage&gt; cachedPage = PageCache::singleton().take(*currentItem(), m_frame.page());</span>
<span class="udiff-line-modified-added">+     // When we are pre-commit, the currentItem is where any back/forward cache data resides.</span>
<span class="udiff-line-modified-added">+     std::unique_ptr&lt;CachedPage&gt; cachedPage = BackForwardCache::singleton().take(*currentItem(), m_frame.page());</span>
      if (!cachedPage)
          return;
  
      // FIXME: This is a grotesque hack to fix &lt;rdar://problem/4059059&gt; Crash in RenderFlow::detach
      // Somehow the PageState object is not properly updated, and is holding onto a stale document.
      // Both Xcode and FileMaker see this crash, Safari does not.
  
      ASSERT(cachedPage-&gt;document() == m_frame.document());
      if (cachedPage-&gt;document() == m_frame.document()) {
<span class="udiff-line-modified-removed">-         cachedPage-&gt;document()-&gt;setPageCacheState(Document::NotInPageCache);</span>
<span class="udiff-line-modified-added">+         cachedPage-&gt;document()-&gt;setBackForwardCacheState(Document::NotInBackForwardCache);</span>
          cachedPage-&gt;clear();
      }
  }
  
  bool HistoryController::shouldStopLoadingForHistoryItem(HistoryItem&amp; targetItem) const
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -353,11 +353,11 @@</span>
  void HistoryController::updateForReload()
  {
      LOG(History, &quot;HistoryController %p updateForReload: Updating History for reload in frame %p (main frame %d) %s&quot;, this, &amp;m_frame, m_frame.isMainFrame(), m_frame.loader().documentLoader() ? m_frame.loader().documentLoader()-&gt;url().string().utf8().data() : &quot;&quot;);
  
      if (m_currentItem) {
<span class="udiff-line-modified-removed">-         PageCache::singleton().remove(*m_currentItem);</span>
<span class="udiff-line-modified-added">+         BackForwardCache::singleton().remove(*m_currentItem);</span>
  
          if (m_frame.loader().loadType() == FrameLoadType::Reload || m_frame.loader().loadType() == FrameLoadType::ReloadFromOrigin)
              saveScrollPositionAndViewStateToItem(m_currentItem.get());
  
          // Rebuild the history item tree when reloading as trying to re-associate everything is too error-prone.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -379,18 +379,18 @@</span>
  {
      LOG(History, &quot;HistoryController %p updateForStandardLoad: Updating History for standard load in frame %p (main frame %d) %s&quot;, this, &amp;m_frame, m_frame.isMainFrame(), m_frame.loader().documentLoader()-&gt;url().string().ascii().data());
  
      FrameLoader&amp; frameLoader = m_frame.loader();
  
<span class="udiff-line-modified-removed">-     bool needPrivacy = m_frame.page() ? m_frame.page()-&gt;usesEphemeralSession() : true;</span>
<span class="udiff-line-modified-added">+     bool usesEphemeralSession = m_frame.page() ? m_frame.page()-&gt;usesEphemeralSession() : true;</span>
      const URL&amp; historyURL = frameLoader.documentLoader()-&gt;urlForHistory();
  
      if (!frameLoader.documentLoader()-&gt;isClientRedirect()) {
          if (!historyURL.isEmpty()) {
              if (updateType != UpdateAllExceptBackForwardList)
                  updateBackForwardListClippedAtTarget(true);
<span class="udiff-line-modified-removed">-             if (!needPrivacy) {</span>
<span class="udiff-line-modified-added">+             if (!usesEphemeralSession) {</span>
                  frameLoader.client().updateGlobalHistory();
                  frameLoader.documentLoader()-&gt;setDidCreateGlobalHistoryEntry(true);
                  if (frameLoader.documentLoader()-&gt;unreachableURL().isEmpty())
                      frameLoader.client().updateGlobalHistoryRedirectLinks();
              }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -398,11 +398,11 @@</span>
      } else {
          // The client redirect replaces the current history item.
          updateCurrentItem();
      }
  
<span class="udiff-line-modified-removed">-     if (!historyURL.isEmpty() &amp;&amp; !needPrivacy) {</span>
<span class="udiff-line-modified-added">+     if (!historyURL.isEmpty() &amp;&amp; !usesEphemeralSession) {</span>
          if (Page* page = m_frame.page())
              addVisitedLink(*page, historyURL);
  
          if (!frameLoader.documentLoader()-&gt;didCreateGlobalHistoryEntry() &amp;&amp; frameLoader.documentLoader()-&gt;unreachableURL().isEmpty() &amp;&amp; !m_frame.document()-&gt;url().isEmpty())
              frameLoader.client().updateGlobalHistoryRedirectLinks();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -411,18 +411,18 @@</span>
  
  void HistoryController::updateForRedirectWithLockedBackForwardList()
  {
      LOG(History, &quot;HistoryController %p updateForRedirectWithLockedBackForwardList: Updating History for redirect load in frame %p (main frame %d) %s&quot;, this, &amp;m_frame, m_frame.isMainFrame(), m_frame.loader().documentLoader() ? m_frame.loader().documentLoader()-&gt;url().string().utf8().data() : &quot;&quot;);
  
<span class="udiff-line-modified-removed">-     bool needPrivacy = m_frame.page() ? m_frame.page()-&gt;usesEphemeralSession() : true;</span>
<span class="udiff-line-modified-added">+     bool usesEphemeralSession = m_frame.page() ? m_frame.page()-&gt;usesEphemeralSession() : true;</span>
      const URL&amp; historyURL = m_frame.loader().documentLoader()-&gt;urlForHistory();
  
      if (m_frame.loader().documentLoader()-&gt;isClientRedirect()) {
          if (!m_currentItem &amp;&amp; !m_frame.tree().parent()) {
              if (!historyURL.isEmpty()) {
                  updateBackForwardListClippedAtTarget(true);
<span class="udiff-line-modified-removed">-                 if (!needPrivacy) {</span>
<span class="udiff-line-modified-added">+                 if (!usesEphemeralSession) {</span>
                      m_frame.loader().client().updateGlobalHistory();
                      m_frame.loader().documentLoader()-&gt;setDidCreateGlobalHistoryEntry(true);
                      if (m_frame.loader().documentLoader()-&gt;unreachableURL().isEmpty())
                          m_frame.loader().client().updateGlobalHistoryRedirectLinks();
                  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -434,11 +434,11 @@</span>
          Frame* parentFrame = m_frame.tree().parent();
          if (parentFrame &amp;&amp; parentFrame-&gt;loader().history().currentItem())
              parentFrame-&gt;loader().history().currentItem()-&gt;setChildItem(createItem());
      }
  
<span class="udiff-line-modified-removed">-     if (!historyURL.isEmpty() &amp;&amp; !needPrivacy) {</span>
<span class="udiff-line-modified-added">+     if (!historyURL.isEmpty() &amp;&amp; !usesEphemeralSession) {</span>
          if (Page* page = m_frame.page())
              addVisitedLink(*page, historyURL);
  
          if (!m_frame.loader().documentLoader()-&gt;didCreateGlobalHistoryEntry() &amp;&amp; m_frame.loader().documentLoader()-&gt;unreachableURL().isEmpty())
              m_frame.loader().client().updateGlobalHistoryRedirectLinks();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -454,14 +454,14 @@</span>
      if (m_currentItem) {
          m_currentItem-&gt;clearDocumentState();
          m_currentItem-&gt;clearScrollPosition();
      }
  
<span class="udiff-line-modified-removed">-     bool needPrivacy = m_frame.page() ? m_frame.page()-&gt;usesEphemeralSession() : true;</span>
<span class="udiff-line-modified-added">+     bool usesEphemeralSession = m_frame.page() ? m_frame.page()-&gt;usesEphemeralSession() : true;</span>
      const URL&amp; historyURL = m_frame.loader().documentLoader()-&gt;urlForHistory();
  
<span class="udiff-line-modified-removed">-     if (!historyURL.isEmpty() &amp;&amp; !needPrivacy) {</span>
<span class="udiff-line-modified-added">+     if (!historyURL.isEmpty() &amp;&amp; !usesEphemeralSession) {</span>
          if (Page* page = m_frame.page())
              addVisitedLink(*page, historyURL);
      }
  }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -549,19 +549,20 @@</span>
  
      Page* page = m_frame.page();
      if (!page)
          return;
  
<span class="udiff-line-modified-removed">-     if (page-&gt;usesEphemeralSession())</span>
<span class="udiff-line-modified-removed">-         return;</span>
<span class="udiff-line-modified-added">+     bool usesEphemeralSession = page-&gt;usesEphemeralSession();</span>
<span class="udiff-line-modified-added">+     if (!usesEphemeralSession)</span>
<span class="udiff-line-added">+         addVisitedLink(*page, m_frame.document()-&gt;url());</span>
  
<span class="udiff-line-removed">-     addVisitedLink(*page, m_frame.document()-&gt;url());</span>
      m_frame.mainFrame().loader().history().recursiveUpdateForSameDocumentNavigation();
  
      if (m_currentItem) {
          m_currentItem-&gt;setURL(m_frame.document()-&gt;url());
<span class="udiff-line-modified-removed">-         m_frame.loader().client().updateGlobalHistory();</span>
<span class="udiff-line-modified-added">+         if (!usesEphemeralSession)</span>
<span class="udiff-line-added">+             m_frame.loader().client().updateGlobalHistory();</span>
      }
  }
  
  void HistoryController::recursiveUpdateForSameDocumentNavigation()
  {
</pre>
<center><a href="HTTPHeaderField.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="ImageLoader.cpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>