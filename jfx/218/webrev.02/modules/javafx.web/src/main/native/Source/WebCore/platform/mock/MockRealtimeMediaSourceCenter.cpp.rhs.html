<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/WebCore/platform/mock/MockRealtimeMediaSourceCenter.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (C) 2013 Google Inc. All rights reserved.
  3  * Copyright (C) 2013-2018 Apple Inc.  All rights reserved.
  4  * Copyright (C) 2013 Nokia Corporation and/or its subsidiary(-ies).
  5  *
  6  * Redistribution and use in source and binary forms, with or without
  7  * modification, are permitted provided that the following conditions
  8  * are met:
  9  * 1. Redistributions of source code must retain the above copyright
 10  *    notice, this list of conditions and the following disclaimer.
 11  * 2. Redistributions in binary form must reproduce the above copyright
 12  *    notice, this list of conditions and the following disclaimer in the
 13  *    documentation and/or other materials provided with the distribution.
 14  *
 15  * THIS SOFTWARE IS PROVIDED BY APPLE INC. ``AS IS&#39;&#39; AND ANY
 16  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 17  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 18  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE INC. OR
 19  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 20  * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 21  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 22  * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 23  * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 24  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 25  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 26  */
 27 
 28 #include &quot;config.h&quot;
 29 #include &quot;MockRealtimeMediaSourceCenter.h&quot;
 30 
 31 #if ENABLE(MEDIA_STREAM)
 32 
 33 #include &quot;CaptureDevice.h&quot;
 34 #include &quot;Logging.h&quot;
 35 #include &quot;MediaConstraints.h&quot;
 36 #include &quot;MockRealtimeAudioSource.h&quot;
 37 #include &quot;MockRealtimeVideoSource.h&quot;
 38 #include &quot;NotImplemented.h&quot;
 39 #include &quot;RealtimeMediaSourceSettings.h&quot;
 40 #include &lt;math.h&gt;
 41 #include &lt;wtf/NeverDestroyed.h&gt;
 42 #include &lt;wtf/text/StringView.h&gt;
 43 
<a name="1" id="anc1"></a><span class="line-added"> 44 #if PLATFORM(COCOA)</span>
<span class="line-added"> 45 #include &quot;CoreAudioCaptureSource.h&quot;</span>
<span class="line-added"> 46 #endif</span>
<span class="line-added"> 47 </span>
 48 namespace WebCore {
 49 
 50 static inline Vector&lt;MockMediaDevice&gt; defaultDevices()
 51 {
 52     return Vector&lt;MockMediaDevice&gt; {
 53         MockMediaDevice { &quot;239c24b0-2b15-11e3-8224-0800200c9a66&quot;_s, &quot;Mock audio device 1&quot;_s, MockMicrophoneProperties { 44100 } },
 54         MockMediaDevice { &quot;239c24b1-2b15-11e3-8224-0800200c9a66&quot;_s, &quot;Mock audio device 2&quot;_s, MockMicrophoneProperties { 48000 } },
 55 
 56         MockMediaDevice { &quot;239c24b2-2b15-11e3-8224-0800200c9a66&quot;_s, &quot;Mock video device 1&quot;_s,
 57             MockCameraProperties {
 58                 30,
 59                 RealtimeMediaSourceSettings::VideoFacingMode::User, {
 60                     { { 1280, 720 }, { { 30, 30}, { 27.5, 27.5}, { 25, 25}, { 22.5, 22.5}, { 20, 20}, { 17.5, 17.5}, { 15, 15}, { 12.5, 12.5}, { 10, 10}, { 7.5, 7.5}, { 5, 5} } },
 61                     { { 640, 480 },  { { 30, 30}, { 27.5, 27.5}, { 25, 25}, { 22.5, 22.5}, { 20, 20}, { 17.5, 17.5}, { 15, 15}, { 12.5, 12.5}, { 10, 10}, { 7.5, 7.5}, { 5, 5} } },
 62                     { { 112, 112 },  { { 30, 30}, { 27.5, 27.5}, { 25, 25}, { 22.5, 22.5}, { 20, 20}, { 17.5, 17.5}, { 15, 15}, { 12.5, 12.5}, { 10, 10}, { 7.5, 7.5}, { 5, 5} } },
 63                 },
 64                 Color::black,
 65             } },
 66 
 67         MockMediaDevice { &quot;239c24b3-2b15-11e3-8224-0800200c9a66&quot;_s, &quot;Mock video device 2&quot;_s,
 68             MockCameraProperties {
 69                 15,
 70                 RealtimeMediaSourceSettings::VideoFacingMode::Environment, {
 71                     { { 3840, 2160 }, { { 2, 30 } } },
 72                     { { 1920, 1080 }, { { 2, 30 } } },
 73                     { { 1280, 720 },  { { 3, 120 } } },
 74                     { { 960, 540 },   { { 3, 60 } } },
 75                     { { 640, 480 },   { { 2, 30 } } },
 76                     { { 352, 288 },   { { 2, 30 } } },
 77                     { { 320, 240 },   { { 2, 30 } } },
 78                     { { 160, 120 },   { { 2, 30 } } },
 79                 },
 80                 Color::darkGray,
 81             } },
 82 
 83         MockMediaDevice { &quot;SCREEN-1&quot;_s, &quot;Mock screen device 1&quot;_s, MockDisplayProperties { CaptureDevice::DeviceType::Screen, Color::lightGray, { 3840, 2160 } } },
 84         MockMediaDevice { &quot;SCREEN-2&quot;_s, &quot;Mock screen device 2&quot;_s, MockDisplayProperties { CaptureDevice::DeviceType::Screen, Color::yellow, { 1920, 1080 } } },
 85 
<a name="2" id="anc2"></a><span class="line-modified"> 86         MockMediaDevice { &quot;WINDOW-2&quot;_s, &quot;Mock window 1&quot;_s, MockDisplayProperties { CaptureDevice::DeviceType::Screen, SimpleColor { 0xfff1b5 }, { 640, 480 } } },</span>
<span class="line-modified"> 87         MockMediaDevice { &quot;WINDOW-2&quot;_s, &quot;Mock window 2&quot;_s, MockDisplayProperties { CaptureDevice::DeviceType::Screen, SimpleColor { 0xffd0b5 }, { 1280, 600 } } },</span>
 88     };
 89 }
 90 
 91 class MockRealtimeVideoSourceFactory : public VideoCaptureFactory {
 92 public:
 93     CaptureSourceOrError createVideoCaptureSource(const CaptureDevice&amp; device, String&amp;&amp; hashSalt, const MediaConstraints* constraints) final
 94     {
 95         ASSERT(device.type() == CaptureDevice::DeviceType::Camera);
 96         if (!MockRealtimeMediaSourceCenter::captureDeviceWithPersistentID(CaptureDevice::DeviceType::Camera, device.persistentId()))
<a name="3" id="anc3"></a><span class="line-modified"> 97             return { &quot;Unable to find mock camera device with given persistentID&quot;_s };</span>
 98 
 99         return MockRealtimeVideoSource::create(String { device.persistentId() }, String { device.label() }, WTFMove(hashSalt), constraints);
100     }
101 
102 private:
103 #if PLATFORM(IOS_FAMILY)
104     void setVideoCapturePageState(bool interrupted, bool pageMuted) final
105     {
106         if (activeSource())
107             activeSource()-&gt;setInterrupted(interrupted, pageMuted);
108     }
109 #endif
110     CaptureDeviceManager&amp; videoCaptureDeviceManager() final { return MockRealtimeMediaSourceCenter::singleton().videoCaptureDeviceManager(); }
111 };
112 
113 class MockRealtimeDisplaySourceFactory : public DisplayCaptureFactory {
114 public:
115     CaptureSourceOrError createDisplayCaptureSource(const CaptureDevice&amp; device, const MediaConstraints* constraints) final
116     {
117         if (!MockRealtimeMediaSourceCenter::captureDeviceWithPersistentID(device.type(), device.persistentId()))
<a name="4" id="anc4"></a><span class="line-modified">118             return { &quot;Unable to find mock  display device with given persistentID&quot;_s };</span>
119 
120         switch (device.type()) {
121         case CaptureDevice::DeviceType::Screen:
122         case CaptureDevice::DeviceType::Window:
123             return MockRealtimeVideoSource::create(String { device.persistentId() }, String { device.label() }, String { }, constraints);
124             break;
125         case CaptureDevice::DeviceType::Microphone:
126         case CaptureDevice::DeviceType::Camera:
127         case CaptureDevice::DeviceType::Unknown:
128             ASSERT_NOT_REACHED();
129             break;
130         }
131 
132         return { };
133     }
134 private:
135     CaptureDeviceManager&amp; displayCaptureDeviceManager() final { return MockRealtimeMediaSourceCenter::singleton().displayCaptureDeviceManager(); }
136 };
137 
138 class MockRealtimeAudioSourceFactory : public AudioCaptureFactory {
139 public:
140     CaptureSourceOrError createAudioCaptureSource(const CaptureDevice&amp; device, String&amp;&amp; hashSalt, const MediaConstraints* constraints) final
141     {
142         ASSERT(device.type() == CaptureDevice::DeviceType::Microphone);
143         if (!MockRealtimeMediaSourceCenter::captureDeviceWithPersistentID(CaptureDevice::DeviceType::Microphone, device.persistentId()))
<a name="5" id="anc5"></a><span class="line-modified">144             return { &quot;Unable to find mock microphone device with given persistentID&quot;_s };</span>
145 
146         return MockRealtimeAudioSource::create(String { device.persistentId() }, String { device.label() }, WTFMove(hashSalt), constraints);
147     }
148 private:
149 #if PLATFORM(IOS_FAMILY)
<a name="6" id="anc6"></a><span class="line-modified">150     void setAudioCapturePageState(bool interrupted, bool pageMuted) final { CoreAudioCaptureSourceFactory::singleton().setAudioCapturePageState(interrupted, pageMuted); }</span>




151 #endif
152     CaptureDeviceManager&amp; audioCaptureDeviceManager() final { return MockRealtimeMediaSourceCenter::singleton().audioCaptureDeviceManager(); }
153 };
154 
155 static Vector&lt;MockMediaDevice&gt;&amp; devices()
156 {
157     static auto devices = makeNeverDestroyed([] {
158         return defaultDevices();
159     }());
160     return devices;
161 }
162 
163 static HashMap&lt;String, MockMediaDevice&gt;&amp; deviceMap()
164 {
165     static auto map = makeNeverDestroyed([] {
166         HashMap&lt;String, MockMediaDevice&gt; map;
167         for (auto&amp; device : devices())
168             map.add(device.persistentId, device);
169 
170         return map;
171     }());
172     return map;
173 }
174 
175 static inline Vector&lt;CaptureDevice&gt;&amp; deviceListForDevice(const MockMediaDevice&amp; device)
176 {
177     if (device.isMicrophone())
178         return MockRealtimeMediaSourceCenter::audioDevices();
179     if (device.isCamera())
180         return MockRealtimeMediaSourceCenter::videoDevices();
181 
182     ASSERT(device.isDisplay());
183     return MockRealtimeMediaSourceCenter::displayDevices();
184 }
185 
186 MockRealtimeMediaSourceCenter&amp; MockRealtimeMediaSourceCenter::singleton()
187 {
188     static NeverDestroyed&lt;MockRealtimeMediaSourceCenter&gt; center;
189     return center;
190 }
191 
192 void MockRealtimeMediaSourceCenter::setMockRealtimeMediaSourceCenterEnabled(bool enabled)
193 {
<a name="7" id="anc7"></a><span class="line-modified">194     MockRealtimeMediaSourceCenter&amp; mock = singleton();</span>


195 
<a name="8" id="anc8"></a><span class="line-modified">196     if (mock.m_isEnabled == enabled)</span>
<span class="line-added">197         return;</span>
198 
<a name="9" id="anc9"></a><span class="line-added">199     mock.m_isEnabled = enabled;</span>
200     RealtimeMediaSourceCenter&amp; center = RealtimeMediaSourceCenter::singleton();
<a name="10" id="anc10"></a>
201 
<a name="11" id="anc11"></a><span class="line-modified">202     if (mock.m_isEnabled) {</span>
203         if (mock.m_isMockAudioCaptureEnabled)
204             center.setAudioCaptureFactory(mock.audioCaptureFactory());
205         if (mock.m_isMockVideoCaptureEnabled)
206             center.setVideoCaptureFactory(mock.videoCaptureFactory());
207         if (mock.m_isMockDisplayCaptureEnabled)
208             center.setDisplayCaptureFactory(mock.displayCaptureFactory());
209         return;
210     }
211 
212     if (mock.m_isMockAudioCaptureEnabled)
213         center.unsetAudioCaptureFactory(mock.audioCaptureFactory());
214     if (mock.m_isMockVideoCaptureEnabled)
215         center.unsetVideoCaptureFactory(mock.videoCaptureFactory());
216     if (mock.m_isMockDisplayCaptureEnabled)
217         center.unsetDisplayCaptureFactory(mock.displayCaptureFactory());
218 }
219 
220 bool MockRealtimeMediaSourceCenter::mockRealtimeMediaSourceCenterEnabled()
221 {
<a name="12" id="anc12"></a><span class="line-modified">222     return singleton().m_isEnabled;</span>



223 }
224 
225 static void createCaptureDevice(const MockMediaDevice&amp; device)
226 {
227     deviceListForDevice(device).append(MockRealtimeMediaSourceCenter::captureDeviceWithPersistentID(device.type(), device.persistentId).value());
228 }
229 
230 void MockRealtimeMediaSourceCenter::resetDevices()
231 {
232     setDevices(defaultDevices());
233     RealtimeMediaSourceCenter::singleton().captureDevicesChanged();
234 }
235 
236 void MockRealtimeMediaSourceCenter::setDevices(Vector&lt;MockMediaDevice&gt;&amp;&amp; newMockDevices)
237 {
238     audioDevices().clear();
239     videoDevices().clear();
240     displayDevices().clear();
241 
242     auto&amp; mockDevices = devices();
243     mockDevices = WTFMove(newMockDevices);
244 
245     auto&amp; map = deviceMap();
246     map.clear();
247 
248     for (const auto&amp; device : mockDevices) {
249         map.add(device.persistentId, device);
250         createCaptureDevice(device);
251     }
252     RealtimeMediaSourceCenter::singleton().captureDevicesChanged();
253 }
254 
255 void MockRealtimeMediaSourceCenter::addDevice(const MockMediaDevice&amp; device)
256 {
257     devices().append(device);
258     deviceMap().set(device.persistentId, device);
259     createCaptureDevice(device);
260     RealtimeMediaSourceCenter::singleton().captureDevicesChanged();
261 }
262 
263 void MockRealtimeMediaSourceCenter::removeDevice(const String&amp; persistentId)
264 {
265     auto&amp; map = deviceMap();
266     auto iterator = map.find(persistentId);
267     if (iterator == map.end())
268         return;
269 
270     devices().removeFirstMatching([&amp;persistentId](const auto&amp; device) {
271         return device.persistentId == persistentId;
272     });
273 
274     deviceListForDevice(iterator-&gt;value).removeFirstMatching([&amp;persistentId](const auto&amp; device) {
275         return device.persistentId() == persistentId;
276     });
277 
278     map.remove(iterator);
279     RealtimeMediaSourceCenter::singleton().captureDevicesChanged();
280 }
281 
282 Optional&lt;MockMediaDevice&gt; MockRealtimeMediaSourceCenter::mockDeviceWithPersistentID(const String&amp; id)
283 {
284     ASSERT(!id.isEmpty());
285 
286     auto&amp; map = deviceMap();
287     auto iterator = map.find(id);
288     if (iterator == map.end())
289         return WTF::nullopt;
290 
291     return iterator-&gt;value;
292 }
293 
294 Optional&lt;CaptureDevice&gt; MockRealtimeMediaSourceCenter::captureDeviceWithPersistentID(CaptureDevice::DeviceType type, const String&amp; id)
295 {
296     ASSERT(!id.isEmpty());
297 
298     auto&amp; map = deviceMap();
299     auto iterator = map.find(id);
300     if (iterator == map.end() || iterator-&gt;value.type() != type)
301         return WTF::nullopt;
302 
303     CaptureDevice device { iterator-&gt;value.persistentId, type, iterator-&gt;value.label };
304     device.setEnabled(true);
305     return device;
306 }
307 
308 Vector&lt;CaptureDevice&gt;&amp; MockRealtimeMediaSourceCenter::audioDevices()
309 {
310     static auto audioDevices = makeNeverDestroyed([] {
311         Vector&lt;CaptureDevice&gt; audioDevices;
312         for (const auto&amp; device : devices()) {
313             if (device.isMicrophone())
314                 audioDevices.append(captureDeviceWithPersistentID(CaptureDevice::DeviceType::Microphone, device.persistentId).value());
315         }
316         return audioDevices;
317     }());
318 
319     return audioDevices;
320 }
321 
322 Vector&lt;CaptureDevice&gt;&amp; MockRealtimeMediaSourceCenter::videoDevices()
323 {
324     static auto videoDevices = makeNeverDestroyed([] {
325         Vector&lt;CaptureDevice&gt; videoDevices;
326         for (const auto&amp; device : devices()) {
327             if (device.isCamera())
328                 videoDevices.append(captureDeviceWithPersistentID(CaptureDevice::DeviceType::Camera, device.persistentId).value());
329         }
330         return videoDevices;
331     }());
332 
333     return videoDevices;
334 }
335 
336 Vector&lt;CaptureDevice&gt;&amp; MockRealtimeMediaSourceCenter::displayDevices()
337 {
338     static auto displayDevices = makeNeverDestroyed([] {
339         Vector&lt;CaptureDevice&gt; displayDevices;
340         for (const auto&amp; device : devices()) {
341             if (device.isDisplay())
342                 displayDevices.append(captureDeviceWithPersistentID(CaptureDevice::DeviceType::Screen, device.persistentId).value());
343         }
344         return displayDevices;
345     }());
346 
347     return displayDevices;
348 }
349 
350 AudioCaptureFactory&amp; MockRealtimeMediaSourceCenter::audioCaptureFactory()
351 {
352     static NeverDestroyed&lt;MockRealtimeAudioSourceFactory&gt; factory;
353     return factory.get();
354 }
355 
356 VideoCaptureFactory&amp; MockRealtimeMediaSourceCenter::videoCaptureFactory()
357 {
358     static NeverDestroyed&lt;MockRealtimeVideoSourceFactory&gt; factory;
359     return factory.get();
360 }
361 
362 DisplayCaptureFactory&amp; MockRealtimeMediaSourceCenter::displayCaptureFactory()
363 {
364     static NeverDestroyed&lt;MockRealtimeDisplaySourceFactory&gt; factory;
365     return factory.get();
366 }
367 
368 } // namespace WebCore
369 
370 #endif // ENABLE(MEDIA_STREAM)
<a name="13" id="anc13"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="13" type="hidden" />
</body>
</html>