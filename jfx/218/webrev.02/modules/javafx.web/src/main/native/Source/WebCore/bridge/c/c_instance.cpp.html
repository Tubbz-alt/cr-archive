<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New modules/javafx.web/src/main/native/Source/WebCore/bridge/c/c_instance.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (C) 2003-2019 Apple Inc.  All rights reserved.
  3  *
  4  * Redistribution and use in source and binary forms, with or without
  5  * modification, are permitted provided that the following conditions
  6  * are met:
  7  * 1. Redistributions of source code must retain the above copyright
  8  *    notice, this list of conditions and the following disclaimer.
  9  * 2. Redistributions in binary form must reproduce the above copyright
 10  *    notice, this list of conditions and the following disclaimer in the
 11  *    documentation and/or other materials provided with the distribution.
 12  *
 13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. ``AS IS&#39;&#39; AND ANY
 14  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 15  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 16  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE INC. OR
 17  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 18  * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 19  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 20  * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 21  * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 22  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 23  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #include &quot;config.h&quot;
 27 
 28 #if ENABLE(NETSCAPE_PLUGIN_API)
 29 
 30 #include &quot;c_instance.h&quot;
 31 
 32 #include &quot;CRuntimeObject.h&quot;
 33 #include &quot;IdentifierRep.h&quot;
 34 #include &quot;JSDOMBinding.h&quot;
 35 #include &quot;c_class.h&quot;
 36 #include &quot;c_runtime.h&quot;
 37 #include &quot;c_utility.h&quot;
 38 #include &quot;npruntime_impl.h&quot;
 39 #include &quot;runtime_method.h&quot;
 40 #include &quot;runtime_root.h&quot;
 41 #include &lt;JavaScriptCore/ArgList.h&gt;
 42 #include &lt;JavaScriptCore/CallFrame.h&gt;
 43 #include &lt;JavaScriptCore/Error.h&gt;
 44 #include &lt;JavaScriptCore/FunctionPrototype.h&gt;
 45 #include &lt;JavaScriptCore/JSLock.h&gt;
 46 #include &lt;JavaScriptCore/PropertyNameArray.h&gt;
 47 #include &lt;wtf/Assertions.h&gt;
 48 #include &lt;wtf/NeverDestroyed.h&gt;
 49 #include &lt;wtf/StdLibExtras.h&gt;
 50 #include &lt;wtf/Vector.h&gt;
 51 
 52 using namespace WebCore;
 53 
 54 namespace JSC {
 55 namespace Bindings {
 56 
 57 static String&amp; globalExceptionString()
 58 {
 59     static NeverDestroyed&lt;String&gt; exceptionStr;
 60     return exceptionStr;
 61 }
 62 
 63 void CInstance::setGlobalException(String exception)
 64 {
 65     globalExceptionString() = exception;
 66 }
 67 
 68 void CInstance::moveGlobalExceptionToExecState(JSGlobalObject* lexicalGlobalObject)
 69 {
 70     if (globalExceptionString().isNull())
 71         return;
 72 
 73     {
 74         VM&amp; vm = lexicalGlobalObject-&gt;vm();
 75         JSLockHolder lock(vm);
 76         auto scope = DECLARE_THROW_SCOPE(vm);
 77         throwException(lexicalGlobalObject, scope, createError(lexicalGlobalObject, globalExceptionString()));
 78     }
 79 
 80     globalExceptionString() = String();
 81 }
 82 
 83 CInstance::CInstance(NPObject* o, RefPtr&lt;RootObject&gt;&amp;&amp; rootObject)
 84     : Instance(WTFMove(rootObject))
 85 {
 86     _object = _NPN_RetainObject(o);
 87     _class = 0;
 88 }
 89 
 90 CInstance::~CInstance()
 91 {
 92     _NPN_ReleaseObject(_object);
 93 }
 94 
 95 RuntimeObject* CInstance::newRuntimeObject(JSGlobalObject* lexicalGlobalObject)
 96 {
 97     // FIXME: deprecatedGetDOMStructure uses the prototype off of the wrong global object.
 98     return CRuntimeObject::create(lexicalGlobalObject-&gt;vm(), WebCore::deprecatedGetDOMStructure&lt;CRuntimeObject&gt;(lexicalGlobalObject), this);
 99 }
100 
101 Class *CInstance::getClass() const
102 {
103     if (!_class)
104         _class = CClass::classForIsA(_object-&gt;_class);
105     return _class;
106 }
107 
108 bool CInstance::supportsInvokeDefaultMethod() const
109 {
110     return _object-&gt;_class-&gt;invokeDefault;
111 }
112 
113 class CRuntimeMethod final : public RuntimeMethod {
114 public:
115     using Base = RuntimeMethod;
116 
117     static CRuntimeMethod* create(JSGlobalObject* lexicalGlobalObject, JSGlobalObject* globalObject, const String&amp; name, Bindings::Method* method)
118     {
119         VM&amp; vm = globalObject-&gt;vm();
120         // FIXME: deprecatedGetDOMStructure uses the prototype off of the wrong global object
121         // We need to pass in the right global object for &quot;i&quot;.
122         Structure* domStructure = WebCore::deprecatedGetDOMStructure&lt;CRuntimeMethod&gt;(lexicalGlobalObject);
123         CRuntimeMethod* runtimeMethod = new (NotNull, allocateCell&lt;CRuntimeMethod&gt;(vm.heap)) CRuntimeMethod(vm, domStructure, method);
124         runtimeMethod-&gt;finishCreation(vm, name);
125         return runtimeMethod;
126     }
127 
128     static Structure* createStructure(VM&amp; vm, JSGlobalObject* globalObject, JSValue prototype)
129     {
130         return Structure::create(vm, globalObject, prototype, TypeInfo(InternalFunctionType, StructureFlags), info());
131     }
132 
133     DECLARE_INFO;
134 
135 private:
136     CRuntimeMethod(VM&amp; vm, Structure* structure, Bindings::Method* method)
137         : RuntimeMethod(vm, structure, method)
138     {
139     }
140 
141     void finishCreation(VM&amp; vm, const String&amp; name)
142     {
143         Base::finishCreation(vm, name);
144         ASSERT(inherits(vm, info()));
145     }
146 };
147 
148 const ClassInfo CRuntimeMethod::s_info = { &quot;CRuntimeMethod&quot;, &amp;RuntimeMethod::s_info, nullptr, nullptr, CREATE_METHOD_TABLE(CRuntimeMethod) };
149 
150 JSValue CInstance::getMethod(JSGlobalObject* lexicalGlobalObject, PropertyName propertyName)
151 {
152     Method* method = getClass()-&gt;methodNamed(propertyName, this);
153     return CRuntimeMethod::create(lexicalGlobalObject, lexicalGlobalObject, propertyName.publicName(), method);
154 }
155 
156 JSValue CInstance::invokeMethod(JSGlobalObject* lexicalGlobalObject, CallFrame* callFrame, RuntimeMethod* runtimeMethod)
157 {
158     VM&amp; vm = lexicalGlobalObject-&gt;vm();
159     auto scope = DECLARE_THROW_SCOPE(vm);
160 
161     if (!asObject(runtimeMethod)-&gt;inherits&lt;CRuntimeMethod&gt;(vm))
162         return throwTypeError(lexicalGlobalObject, scope, &quot;Attempt to invoke non-plug-in method on plug-in object.&quot;_s);
163 
164     CMethod* method = static_cast&lt;CMethod*&gt;(runtimeMethod-&gt;method());
165     ASSERT(method);
166 
167     NPIdentifier ident = method-&gt;identifier();
168     if (!_object-&gt;_class-&gt;hasMethod(_object, ident))
169         return jsUndefined();
170 
171     unsigned count = callFrame-&gt;argumentCount();
172     Vector&lt;NPVariant, 8&gt; cArgs(count);
173 
174     unsigned i;
175     for (i = 0; i &lt; count; i++)
176         convertValueToNPVariant(lexicalGlobalObject, callFrame-&gt;uncheckedArgument(i), &amp;cArgs[i]);
177 
178     // Invoke the &#39;C&#39; method.
179     bool retval = true;
180     NPVariant resultVariant;
181     VOID_TO_NPVARIANT(resultVariant);
182 
183     {
184         JSLock::DropAllLocks dropAllLocks(lexicalGlobalObject);
185         ASSERT(globalExceptionString().isNull());
186         retval = _object-&gt;_class-&gt;invoke(_object, ident, cArgs.data(), count, &amp;resultVariant);
187         moveGlobalExceptionToExecState(lexicalGlobalObject);
188     }
189 
190     if (!retval)
191         throwException(lexicalGlobalObject, scope, createError(lexicalGlobalObject, &quot;Error calling method on NPObject.&quot;_s));
192 
193     for (i = 0; i &lt; count; i++)
194         _NPN_ReleaseVariantValue(&amp;cArgs[i]);
195 
196     JSValue resultValue = convertNPVariantToValue(lexicalGlobalObject, &amp;resultVariant, m_rootObject.get());
197     _NPN_ReleaseVariantValue(&amp;resultVariant);
198     return resultValue;
199 }
200 
201 
202 JSValue CInstance::invokeDefaultMethod(JSGlobalObject* lexicalGlobalObject, CallFrame* callFrame)
203 {
204     VM&amp; vm = lexicalGlobalObject-&gt;vm();
205     auto scope = DECLARE_THROW_SCOPE(vm);
206 
207     if (!_object-&gt;_class-&gt;invokeDefault)
208         return jsUndefined();
209 
210     unsigned count = callFrame-&gt;argumentCount();
211     Vector&lt;NPVariant, 8&gt; cArgs(count);
212 
213     unsigned i;
214     for (i = 0; i &lt; count; i++)
215         convertValueToNPVariant(lexicalGlobalObject, callFrame-&gt;uncheckedArgument(i), &amp;cArgs[i]);
216 
217     // Invoke the &#39;C&#39; method.
218     bool retval = true;
219     NPVariant resultVariant;
220     VOID_TO_NPVARIANT(resultVariant);
221     {
222         JSLock::DropAllLocks dropAllLocks(lexicalGlobalObject);
223         ASSERT(globalExceptionString().isNull());
224         retval = _object-&gt;_class-&gt;invokeDefault(_object, cArgs.data(), count, &amp;resultVariant);
225         moveGlobalExceptionToExecState(lexicalGlobalObject);
226     }
227 
228     if (!retval)
229         throwException(lexicalGlobalObject, scope, createError(lexicalGlobalObject, &quot;Error calling method on NPObject.&quot;_s));
230 
231     for (i = 0; i &lt; count; i++)
232         _NPN_ReleaseVariantValue(&amp;cArgs[i]);
233 
234     JSValue resultValue = convertNPVariantToValue(lexicalGlobalObject, &amp;resultVariant, m_rootObject.get());
235     _NPN_ReleaseVariantValue(&amp;resultVariant);
236     return resultValue;
237 }
238 
239 bool CInstance::supportsConstruct() const
240 {
241     return _object-&gt;_class-&gt;construct;
242 }
243 
244 JSValue CInstance::invokeConstruct(JSGlobalObject* lexicalGlobalObject, CallFrame*, const ArgList&amp; args)
245 {
246     VM&amp; vm = lexicalGlobalObject-&gt;vm();
247     auto scope = DECLARE_THROW_SCOPE(vm);
248 
249     if (!_object-&gt;_class-&gt;construct)
250         return jsUndefined();
251 
252     unsigned count = args.size();
253     Vector&lt;NPVariant, 8&gt; cArgs(count);
254 
255     unsigned i;
256     for (i = 0; i &lt; count; i++)
257         convertValueToNPVariant(lexicalGlobalObject, args.at(i), &amp;cArgs[i]);
258 
259     // Invoke the &#39;C&#39; method.
260     bool retval = true;
261     NPVariant resultVariant;
262     VOID_TO_NPVARIANT(resultVariant);
263     {
264         JSLock::DropAllLocks dropAllLocks(lexicalGlobalObject);
265         ASSERT(globalExceptionString().isNull());
266         retval = _object-&gt;_class-&gt;construct(_object, cArgs.data(), count, &amp;resultVariant);
267         moveGlobalExceptionToExecState(lexicalGlobalObject);
268     }
269 
270     if (!retval)
271         throwException(lexicalGlobalObject, scope, createError(lexicalGlobalObject, &quot;Error calling method on NPObject.&quot;_s));
272 
273     for (i = 0; i &lt; count; i++)
274         _NPN_ReleaseVariantValue(&amp;cArgs[i]);
275 
276     JSValue resultValue = convertNPVariantToValue(lexicalGlobalObject, &amp;resultVariant, m_rootObject.get());
277     _NPN_ReleaseVariantValue(&amp;resultVariant);
278     return resultValue;
279 }
280 
281 JSValue CInstance::defaultValue(JSGlobalObject* lexicalGlobalObject, PreferredPrimitiveType hint) const
282 {
283     if (hint == PreferString)
284         return stringValue(lexicalGlobalObject);
285     if (hint == PreferNumber)
286         return numberValue(lexicalGlobalObject);
287     return valueOf(lexicalGlobalObject);
288 }
289 
290 JSValue CInstance::stringValue(JSGlobalObject* lexicalGlobalObject) const
291 {
292     JSValue value;
293     if (toJSPrimitive(lexicalGlobalObject, &quot;toString&quot;, value))
294         return value;
295 
296     // Fallback to default implementation.
297     return jsNontrivialString(lexicalGlobalObject-&gt;vm(), &quot;NPObject&quot;_s);
298 }
299 
300 JSValue CInstance::numberValue(JSGlobalObject*) const
301 {
302     // FIXME: Implement something sensible.
303     return jsNumber(0);
304 }
305 
306 JSValue CInstance::booleanValue() const
307 {
308     // As per ECMA 9.2.
309     return jsBoolean(getObject());
310 }
311 
312 JSValue CInstance::valueOf(JSGlobalObject* lexicalGlobalObject) const
313 {
314     JSValue value;
315     if (toJSPrimitive(lexicalGlobalObject, &quot;valueOf&quot;, value))
316         return value;
317 
318     // Fallback to default implementation.
319     return stringValue(lexicalGlobalObject);
320 }
321 
322 bool CInstance::toJSPrimitive(JSGlobalObject* lexicalGlobalObject, const char* name, JSValue&amp; resultValue) const
323 {
324     VM&amp; vm = lexicalGlobalObject-&gt;vm();
325     auto scope = DECLARE_THROW_SCOPE(vm);
326 
327     NPIdentifier ident = _NPN_GetStringIdentifier(name);
328     if (!_object-&gt;_class-&gt;hasMethod(_object, ident))
329         return false;
330 
331     // Invoke the &#39;C&#39; method.
332     bool retval = true;
333     NPVariant resultVariant;
334     VOID_TO_NPVARIANT(resultVariant);
335 
336     {
337         JSLock::DropAllLocks dropAllLocks(lexicalGlobalObject);
338         ASSERT(globalExceptionString().isNull());
339         retval = _object-&gt;_class-&gt;invoke(_object, ident, 0, 0, &amp;resultVariant);
340         moveGlobalExceptionToExecState(lexicalGlobalObject);
341     }
342 
343     if (!retval)
344         throwException(lexicalGlobalObject, scope, createError(lexicalGlobalObject, &quot;Error calling method on NPObject.&quot;_s));
345 
346     resultValue = convertNPVariantToValue(lexicalGlobalObject, &amp;resultVariant, m_rootObject.get());
347     _NPN_ReleaseVariantValue(&amp;resultVariant);
348     return true;
349 }
350 
351 void CInstance::getPropertyNames(JSGlobalObject* lexicalGlobalObject, PropertyNameArray&amp; nameArray)
352 {
353     if (!NP_CLASS_STRUCT_VERSION_HAS_ENUM(_object-&gt;_class) || !_object-&gt;_class-&gt;enumerate)
354         return;
355 
356     uint32_t count;
357     NPIdentifier* identifiers;
358 
359     {
360         JSLock::DropAllLocks dropAllLocks(lexicalGlobalObject);
361         ASSERT(globalExceptionString().isNull());
362         bool ok = _object-&gt;_class-&gt;enumerate(_object, &amp;identifiers, &amp;count);
363         moveGlobalExceptionToExecState(lexicalGlobalObject);
364         if (!ok)
365             return;
366     }
367 
368     VM&amp; vm = lexicalGlobalObject-&gt;vm();
369     for (uint32_t i = 0; i &lt; count; i++) {
370         IdentifierRep* identifier = static_cast&lt;IdentifierRep*&gt;(identifiers[i]);
371 
372         if (identifier-&gt;isString())
373             nameArray.add(identifierFromNPIdentifier(lexicalGlobalObject, identifier-&gt;string()));
374         else
375             nameArray.add(Identifier::from(vm, identifier-&gt;number()));
376     }
377 
378     // FIXME: This should really call NPN_MemFree but that&#39;s in WebKit
379     free(identifiers);
380 }
381 
382 }
383 }
384 
385 #endif // ENABLE(NETSCAPE_PLUGIN_API)
    </pre>
  </body>
</html>