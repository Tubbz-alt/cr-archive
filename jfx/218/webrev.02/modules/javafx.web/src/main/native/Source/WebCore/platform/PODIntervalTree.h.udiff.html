<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WebCore/platform/PODIntervalTree.h</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="PODInterval.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="PODRedBlackTree.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/platform/PODIntervalTree.h</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,8 @@</span>
  /*
   * Copyright (C) 2010 Google Inc. All rights reserved.
<span class="udiff-line-added">+  * Copyright (C) 2019-2020 Apple Inc. All rights reserved.</span>
   *
   * Redistribution and use in source and binary forms, with or without
   * modification, are permitted provided that the following conditions
   * are met:
   *
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -21,137 +22,75 @@</span>
   * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
   * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
   * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
   */
  
<span class="udiff-line-modified-removed">- #ifndef PODIntervalTree_h</span>
<span class="udiff-line-removed">- #define PODIntervalTree_h</span>
<span class="udiff-line-modified-added">+ #pragma once</span>
  
  #include &quot;PODInterval.h&quot;
  #include &quot;PODRedBlackTree.h&quot;
<span class="udiff-line-removed">- #include &lt;wtf/Assertions.h&gt;</span>
<span class="udiff-line-removed">- #include &lt;wtf/Noncopyable.h&gt;</span>
  #include &lt;wtf/Optional.h&gt;
  #include &lt;wtf/Vector.h&gt;
<span class="udiff-line-removed">- #include &lt;wtf/text/ValueToString.h&gt;</span>
  
<span class="udiff-line-modified-removed">- namespace WebCore {</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- template &lt;class T, class UserData = void*&gt;</span>
<span class="udiff-line-removed">- class PODIntervalSearchAdapter {</span>
<span class="udiff-line-removed">- public:</span>
<span class="udiff-line-removed">-     typedef PODInterval&lt;T, UserData&gt; IntervalType;</span>
<span class="udiff-line-modified-added">+ // FIXME: The prefix &quot;POD&quot; here isn&#39;t correct; this tree works with non-POD types.</span>
  
<span class="udiff-line-modified-removed">-     PODIntervalSearchAdapter(Vector&lt;IntervalType&gt;&amp; result, const T&amp; lowValue, const T&amp; highValue)</span>
<span class="udiff-line-removed">-         : m_result(result)</span>
<span class="udiff-line-removed">-         , m_lowValue(lowValue)</span>
<span class="udiff-line-removed">-         , m_highValue(highValue)</span>
<span class="udiff-line-removed">-     {</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     const T&amp; lowValue() const { return m_lowValue; }</span>
<span class="udiff-line-removed">-     const T&amp; highValue() const { return m_highValue; }</span>
<span class="udiff-line-removed">-     void collectIfNeeded(const IntervalType&amp; data) const</span>
<span class="udiff-line-removed">-     {</span>
<span class="udiff-line-removed">-         if (data.overlaps(m_lowValue, m_highValue))</span>
<span class="udiff-line-removed">-             m_result.append(data);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-modified-added">+ namespace WebCore {</span>
  
<span class="udiff-line-modified-removed">- private:</span>
<span class="udiff-line-removed">-     Vector&lt;IntervalType&gt;&amp; m_result;</span>
<span class="udiff-line-removed">-     T m_lowValue;</span>
<span class="udiff-line-removed">-     T m_highValue;</span>
<span class="udiff-line-removed">- };</span>
<span class="udiff-line-modified-added">+ struct PODIntervalNodeUpdater;</span>
  
  // An interval tree, which is a form of augmented red-black tree. It
  // supports efficient (O(lg n)) insertion, removal and querying of
  // intervals in the tree.
<span class="udiff-line-modified-removed">- template&lt;class T, class UserData = void*&gt;</span>
<span class="udiff-line-removed">- class PODIntervalTree : public PODRedBlackTree&lt;PODInterval&lt;T, UserData&gt;&gt; {</span>
<span class="udiff-line-modified-added">+ template&lt;typename T, typename UserData&gt; class PODIntervalTree final : public PODRedBlackTree&lt;PODInterval&lt;T, UserData&gt;, PODIntervalNodeUpdater&gt; {</span>
      WTF_MAKE_FAST_ALLOCATED;
<span class="udiff-line-removed">-     WTF_MAKE_NONCOPYABLE(PODIntervalTree);</span>
  public:
<span class="udiff-line-modified-removed">-     // Typedef to reduce typing when declaring intervals to be stored in</span>
<span class="udiff-line-modified-removed">-     // this tree.</span>
<span class="udiff-line-removed">-     typedef PODInterval&lt;T, UserData&gt; IntervalType;</span>
<span class="udiff-line-removed">-     typedef PODIntervalSearchAdapter&lt;T, UserData&gt; IntervalSearchAdapterType;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     PODIntervalTree()</span>
<span class="udiff-line-removed">-         : PODRedBlackTree&lt;IntervalType&gt;()</span>
<span class="udiff-line-removed">-     {</span>
<span class="udiff-line-removed">-         init();</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-modified-added">+     using IntervalType = PODInterval&lt;T, UserData&gt;;</span>
<span class="udiff-line-modified-added">+     class OverlapsSearchAdapter;</span>
  
<span class="udiff-line-modified-removed">-     // Returns all intervals in the tree which overlap the given query</span>
<span class="udiff-line-removed">-     // interval. The returned intervals are sorted by increasing low</span>
<span class="udiff-line-removed">-     // endpoint.</span>
<span class="udiff-line-modified-added">+     // Returns all intervals in the tree which overlap the given query interval, sorted by the &lt; operator.</span>
      Vector&lt;IntervalType&gt; allOverlaps(const IntervalType&amp; interval) const
      {
          Vector&lt;IntervalType&gt; result;
<span class="udiff-line-modified-removed">-         allOverlaps(interval, result);</span>
<span class="udiff-line-modified-added">+         OverlapsSearchAdapter adapter(result, interval);</span>
<span class="udiff-line-added">+         allOverlapsWithAdapter(adapter);</span>
          return result;
      }
  
<span class="udiff-line-modified-removed">-     // Returns all intervals in the tree which overlap the given query</span>
<span class="udiff-line-removed">-     // interval. The returned intervals are sorted by increasing low</span>
<span class="udiff-line-removed">-     // endpoint.</span>
<span class="udiff-line-removed">-     void allOverlaps(const IntervalType&amp; interval, Vector&lt;IntervalType&gt;&amp; result) const</span>
<span class="udiff-line-removed">-     {</span>
<span class="udiff-line-removed">-         // Explicit dereference of &quot;this&quot; required because of</span>
<span class="udiff-line-removed">-         // inheritance rules in template classes.</span>
<span class="udiff-line-removed">-         IntervalSearchAdapterType adapter(result, interval.low(), interval.high());</span>
<span class="udiff-line-removed">-         searchForOverlapsFrom&lt;IntervalSearchAdapterType&gt;(this-&gt;root(), adapter);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     template &lt;class AdapterType&gt;</span>
<span class="udiff-line-removed">-     void allOverlapsWithAdapter(AdapterType&amp; adapter) const</span>
<span class="udiff-line-modified-added">+     template&lt;typename AdapterType&gt; void allOverlapsWithAdapter(AdapterType&amp; adapter) const</span>
      {
<span class="udiff-line-modified-removed">-         // Explicit dereference of &quot;this&quot; required because of</span>
<span class="udiff-line-removed">-         // inheritance rules in template classes.</span>
<span class="udiff-line-removed">-         searchForOverlapsFrom&lt;AdapterType&gt;(this-&gt;root(), adapter);</span>
<span class="udiff-line-modified-added">+         searchForOverlapsFrom(this-&gt;root(), adapter);</span>
      }
  
<span class="udiff-line-modified-removed">-     // Helper to create interval objects.</span>
<span class="udiff-line-removed">-     static IntervalType createInterval(const T&amp; low, const T&amp; high, const UserData data = 0)</span>
<span class="udiff-line-modified-added">+     Optional&lt;IntervalType&gt; nextIntervalAfter(const T&amp; point)</span>
      {
<span class="udiff-line-modified-removed">-         return IntervalType(low, high, data);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     Optional&lt;IntervalType&gt; nextIntervalAfter(const IntervalType&amp; interval)</span>
<span class="udiff-line-removed">-     {</span>
<span class="udiff-line-removed">-         auto next = smallestNodeGreaterThanFrom(interval, this-&gt;root());</span>
<span class="udiff-line-modified-added">+         auto next = smallestNodeGreaterThanFrom(point, this-&gt;root());</span>
          if (!next)
              return WTF::nullopt;
<span class="udiff-line-removed">- </span>
          return next-&gt;data();
      }
  
<span class="udiff-line-modified-removed">-     bool checkInvariants() const override</span>
<span class="udiff-line-modified-added">+ #ifndef NDEBUG</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     bool checkInvariants() const</span>
      {
<span class="udiff-line-modified-removed">-         if (!PODRedBlackTree&lt;IntervalType&gt;::checkInvariants())</span>
<span class="udiff-line-modified-added">+         if (!Base::checkInvariants())</span>
              return false;
          if (!this-&gt;root())
              return true;
<span class="udiff-line-modified-removed">-         return checkInvariantsFromNode(this-&gt;root(), 0);</span>
<span class="udiff-line-modified-added">+         return checkInvariantsFromNode(this-&gt;root(), nullptr);</span>
      }
  
<span class="udiff-line-modified-removed">- private:</span>
<span class="udiff-line-removed">-     typedef typename PODRedBlackTree&lt;IntervalType&gt;::Node IntervalNode;</span>
<span class="udiff-line-modified-added">+ #endif</span>
  
<span class="udiff-line-modified-removed">-     // Initializes the tree.</span>
<span class="udiff-line-modified-removed">-     void init()</span>
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-removed">-         // Explicit dereference of &quot;this&quot; required because of</span>
<span class="udiff-line-removed">-         // inheritance rules in template classes.</span>
<span class="udiff-line-removed">-         this-&gt;setNeedsFullOrderingComparisons(true);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-modified-added">+ private:</span>
<span class="udiff-line-modified-added">+     using Base = PODRedBlackTree&lt;PODInterval&lt;T, UserData&gt;, PODIntervalNodeUpdater&gt;;</span>
<span class="udiff-line-modified-added">+     using IntervalNode = typename Base::Node;</span>
  
      // Starting from the given node, adds all overlaps with the given
      // interval to the result vector. The intervals are sorted by
      // increasing low endpoint.
<span class="udiff-line-modified-removed">-     template &lt;class AdapterType&gt;</span>
<span class="udiff-line-removed">-     void searchForOverlapsFrom(IntervalNode* node, AdapterType&amp; adapter) const</span>
<span class="udiff-line-modified-added">+     template&lt;typename AdapterType&gt; void searchForOverlapsFrom(IntervalNode* node, AdapterType&amp; adapter) const</span>
      {
          if (!node)
              return;
  
          // Because the intervals are sorted by left endpoint, inorder
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -173,47 +112,26 @@</span>
          // on type T.
          if (!(adapter.highValue() &lt; node-&gt;data().low()))
              searchForOverlapsFrom&lt;AdapterType&gt;(node-&gt;right(), adapter);
      }
  
<span class="udiff-line-modified-removed">-     IntervalNode* smallestNodeGreaterThanFrom(const IntervalType&amp; interval, IntervalNode* node) const</span>
<span class="udiff-line-modified-added">+     IntervalNode* smallestNodeGreaterThanFrom(const T&amp; point, IntervalNode* node) const</span>
      {
          if (!node)
              return nullptr;
  
<span class="udiff-line-modified-removed">-         if (!(interval.high() &lt; node-&gt;data().low()))</span>
<span class="udiff-line-modified-removed">-             return smallestNodeGreaterThanFrom(interval, node-&gt;right());</span>
<span class="udiff-line-modified-added">+         if (!(point &lt; node-&gt;data().low()))</span>
<span class="udiff-line-modified-added">+             return smallestNodeGreaterThanFrom(point, node-&gt;right());</span>
  
<span class="udiff-line-modified-removed">-         if (auto left = smallestNodeGreaterThanFrom(interval, node-&gt;right()))</span>
<span class="udiff-line-modified-added">+         if (auto left = smallestNodeGreaterThanFrom(point, node-&gt;right()))</span>
              return left;
  
          return node;
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     bool updateNode(IntervalNode* node) override</span>
<span class="udiff-line-removed">-     {</span>
<span class="udiff-line-removed">-         // Would use const T&amp;, but need to reassign this reference in this</span>
<span class="udiff-line-removed">-         // function.</span>
<span class="udiff-line-removed">-         const T* curMax = &amp;node-&gt;data().high();</span>
<span class="udiff-line-removed">-         IntervalNode* left = node-&gt;left();</span>
<span class="udiff-line-removed">-         if (left) {</span>
<span class="udiff-line-removed">-             if (*curMax &lt; left-&gt;data().maxHigh())</span>
<span class="udiff-line-removed">-                 curMax = &amp;left-&gt;data().maxHigh();</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         IntervalNode* right = node-&gt;right();</span>
<span class="udiff-line-removed">-         if (right) {</span>
<span class="udiff-line-removed">-             if (*curMax &lt; right-&gt;data().maxHigh())</span>
<span class="udiff-line-removed">-                 curMax = &amp;right-&gt;data().maxHigh();</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         // This is phrased like this to avoid needing operator!= on type T.</span>
<span class="udiff-line-removed">-         if (!(*curMax == node-&gt;data().maxHigh())) {</span>
<span class="udiff-line-removed">-             node-&gt;data().setMaxHigh(*curMax);</span>
<span class="udiff-line-removed">-             return true;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         return false;</span>
      }
  
<span class="udiff-line-added">+ #ifndef NDEBUG</span>
<span class="udiff-line-added">+ </span>
      bool checkInvariantsFromNode(IntervalNode* node, T* currentMaxValue) const
      {
          // These assignments are only done in order to avoid requiring
          // a default constructor on type T.
          T leftMaxValue(node-&gt;data().maxHigh());
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -243,36 +161,67 @@</span>
          } else
              localMaxValue = (leftMaxValue &lt; rightMaxValue) ? rightMaxValue : leftMaxValue;
          if (localMaxValue &lt; node-&gt;data().high())
              localMaxValue = node-&gt;data().high();
          if (!(localMaxValue == node-&gt;data().maxHigh())) {
<span class="udiff-line-modified-removed">- #ifndef NDEBUG</span>
<span class="udiff-line-modified-removed">-             String localMaxValueString = ValueToString&lt;T&gt;::string(localMaxValue);</span>
<span class="udiff-line-modified-removed">-             LOG_ERROR(&quot;PODIntervalTree verification failed at node 0x%p: localMaxValue=%s and data=%s&quot;,</span>
<span class="udiff-line-modified-removed">-                       node, localMaxValueString.utf8().data(), node-&gt;data().toString().utf8().data());</span>
<span class="udiff-line-removed">- #endif</span>
<span class="udiff-line-modified-added">+             TextStream stream;</span>
<span class="udiff-line-modified-added">+             stream &lt;&lt; &quot;localMaxValue=&quot; &lt;&lt; localMaxValue &lt;&lt; &quot;and data =&quot; &lt;&lt; node-&gt;data();</span>
<span class="udiff-line-modified-added">+             LOG_ERROR(&quot;PODIntervalTree verification failed at node 0x%p: %s&quot;,</span>
<span class="udiff-line-modified-added">+                 node, stream.release().utf8().data());</span>
              return false;
          }
          if (currentMaxValue)
              *currentMaxValue = localMaxValue;
          return true;
      }
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+ </span>
  };
  
<span class="udiff-line-modified-removed">- } // namespace WebCore</span>
<span class="udiff-line-modified-added">+ template&lt;typename T, typename UserData&gt; class PODIntervalTree&lt;T, UserData&gt;::OverlapsSearchAdapter {</span>
<span class="udiff-line-added">+ public:</span>
<span class="udiff-line-added">+     using IntervalType = PODInterval&lt;T, UserData&gt;;</span>
  
<span class="udiff-line-modified-removed">- #ifndef NDEBUG</span>
<span class="udiff-line-modified-removed">- namespace WTF {</span>
<span class="udiff-line-modified-added">+     OverlapsSearchAdapter(Vector&lt;IntervalType&gt;&amp; result, const IntervalType&amp; interval)</span>
<span class="udiff-line-modified-added">+         : m_result(result)</span>
<span class="udiff-line-added">+         , m_interval(interval)</span>
<span class="udiff-line-added">+     {</span>
<span class="udiff-line-added">+     }</span>
  
<span class="udiff-line-modified-removed">- // Support for printing PODIntervals at the PODRedBlackTree level.</span>
<span class="udiff-line-modified-removed">- template&lt;class T, class UserData&gt;</span>
<span class="udiff-line-modified-removed">- struct ValueToString&lt;WebCore::PODInterval&lt;T, UserData&gt;&gt; {</span>
<span class="udiff-line-removed">-     static String string(const WebCore::PODInterval&lt;T, UserData&gt;&amp; interval)</span>
<span class="udiff-line-modified-added">+     const T&amp; lowValue() const { return m_interval.low(); }</span>
<span class="udiff-line-modified-added">+     const T&amp; highValue() const { return m_interval.high(); }</span>
<span class="udiff-line-modified-added">+     void collectIfNeeded(const IntervalType&amp; data) const</span>
      {
<span class="udiff-line-modified-removed">-         return interval.toString();</span>
<span class="udiff-line-modified-added">+         if (data.overlaps(m_interval))</span>
<span class="udiff-line-added">+             m_result.append(data);</span>
      }
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ private:</span>
<span class="udiff-line-added">+     Vector&lt;IntervalType&gt;&amp; m_result;</span>
<span class="udiff-line-added">+     const IntervalType&amp; m_interval;</span>
  };
  
<span class="udiff-line-modified-removed">- } // namespace WTF</span>
<span class="udiff-line-modified-removed">- #endif</span>
<span class="udiff-line-modified-added">+ struct PODIntervalNodeUpdater {</span>
<span class="udiff-line-modified-added">+     template&lt;typename Node&gt; static bool update(Node&amp; node)</span>
<span class="udiff-line-added">+     {</span>
<span class="udiff-line-added">+         auto* curMax = &amp;node.data().high();</span>
<span class="udiff-line-added">+         auto* left = node.left();</span>
<span class="udiff-line-added">+         if (left) {</span>
<span class="udiff-line-added">+             if (*curMax &lt; left-&gt;data().maxHigh())</span>
<span class="udiff-line-added">+                 curMax = &amp;left-&gt;data().maxHigh();</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         auto* right = node.right();</span>
<span class="udiff-line-added">+         if (right) {</span>
<span class="udiff-line-added">+             if (*curMax &lt; right-&gt;data().maxHigh())</span>
<span class="udiff-line-added">+                 curMax = &amp;right-&gt;data().maxHigh();</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         // This is phrased like this to avoid needing operator!= on type T.</span>
<span class="udiff-line-added">+         if (!(*curMax == node.data().maxHigh())) {</span>
<span class="udiff-line-added">+             node.data().setMaxHigh(*curMax);</span>
<span class="udiff-line-added">+             return true;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         return false;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ };</span>
  
<span class="udiff-line-modified-removed">- #endif // PODIntervalTree_h</span>
<span class="udiff-line-modified-added">+ } // namespace WebCore</span>
</pre>
<center><a href="PODInterval.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="PODRedBlackTree.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>