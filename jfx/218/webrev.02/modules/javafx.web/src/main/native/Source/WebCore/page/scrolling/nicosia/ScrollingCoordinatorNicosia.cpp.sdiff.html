<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WebCore/page/scrolling/nicosia/ScrollingCoordinatorNicosia.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../ThreadedScrollingTree.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="ScrollingStateNodeNicosia.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/page/scrolling/nicosia/ScrollingCoordinatorNicosia.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 41 }
 42 
 43 ScrollingCoordinatorNicosia::ScrollingCoordinatorNicosia(Page* page)
 44     : AsyncScrollingCoordinator(page)
 45     , m_scrollingStateTreeCommitterTimer(RunLoop::main(), this, &amp;ScrollingCoordinatorNicosia::commitTreeState)
 46 {
 47     setScrollingTree(ScrollingTreeNicosia::create(*this));
 48 }
 49 
 50 ScrollingCoordinatorNicosia::~ScrollingCoordinatorNicosia()
 51 {
 52     ASSERT(!scrollingTree());
 53 }
 54 
 55 void ScrollingCoordinatorNicosia::pageDestroyed()
 56 {
 57     AsyncScrollingCoordinator::pageDestroyed();
 58 
 59     m_scrollingStateTreeCommitterTimer.stop();
 60 
<span class="line-modified"> 61     releaseScrollingTree();</span>


 62 }
 63 
 64 void ScrollingCoordinatorNicosia::commitTreeStateIfNeeded()
 65 {
 66     commitTreeState();
 67     m_scrollingStateTreeCommitterTimer.stop();
 68 }
 69 
<span class="line-modified"> 70 ScrollingEventResult ScrollingCoordinatorNicosia::handleWheelEvent(FrameView&amp;, const PlatformWheelEvent&amp;)</span>
 71 {
<span class="line-modified"> 72     return ScrollingEventResult::DidNotHandleEvent;</span>







 73 }
 74 
 75 void ScrollingCoordinatorNicosia::scheduleTreeStateCommit()
 76 {
 77     if (!m_scrollingStateTreeCommitterTimer.isActive())
 78         m_scrollingStateTreeCommitterTimer.startOneShot(0_s);
 79 }
 80 
 81 void ScrollingCoordinatorNicosia::commitTreeState()
 82 {


 83     if (!scrollingStateTree()-&gt;hasChangedProperties())
 84         return;
 85 
 86     RefPtr&lt;ThreadedScrollingTree&gt; threadedScrollingTree = downcast&lt;ThreadedScrollingTree&gt;(scrollingTree());

 87 
 88     auto treeState = scrollingStateTree()-&gt;commit(LayerRepresentation::PlatformLayerRepresentation);
 89     ScrollingThread::dispatch([threadedScrollingTree, treeState = WTFMove(treeState)]() mutable {
 90         threadedScrollingTree-&gt;commitTreeState(WTFMove(treeState));
 91     });
 92 }
 93 
 94 } // namespace WebCore
 95 
 96 #endif // ENABLE(ASYNC_SCROLLING) &amp;&amp; USE(NICOSIA)
</pre>
</td>
<td>
<hr />
<pre>
 41 }
 42 
 43 ScrollingCoordinatorNicosia::ScrollingCoordinatorNicosia(Page* page)
 44     : AsyncScrollingCoordinator(page)
 45     , m_scrollingStateTreeCommitterTimer(RunLoop::main(), this, &amp;ScrollingCoordinatorNicosia::commitTreeState)
 46 {
 47     setScrollingTree(ScrollingTreeNicosia::create(*this));
 48 }
 49 
 50 ScrollingCoordinatorNicosia::~ScrollingCoordinatorNicosia()
 51 {
 52     ASSERT(!scrollingTree());
 53 }
 54 
 55 void ScrollingCoordinatorNicosia::pageDestroyed()
 56 {
 57     AsyncScrollingCoordinator::pageDestroyed();
 58 
 59     m_scrollingStateTreeCommitterTimer.stop();
 60 
<span class="line-modified"> 61     // Invalidating the scrolling tree will break the reference cycle between the ScrollingCoordinator and ScrollingTree objects.</span>
<span class="line-added"> 62     RefPtr&lt;ThreadedScrollingTree&gt; scrollingTree = static_pointer_cast&lt;ThreadedScrollingTree&gt;(releaseScrollingTree());</span>
<span class="line-added"> 63     ScrollingThread::dispatch([scrollingTree] { scrollingTree-&gt;invalidate(); });</span>
 64 }
 65 
 66 void ScrollingCoordinatorNicosia::commitTreeStateIfNeeded()
 67 {
 68     commitTreeState();
 69     m_scrollingStateTreeCommitterTimer.stop();
 70 }
 71 
<span class="line-modified"> 72 ScrollingEventResult ScrollingCoordinatorNicosia::handleWheelEvent(FrameView&amp;, const PlatformWheelEvent&amp; wheelEvent)</span>
 73 {
<span class="line-modified"> 74     ASSERT(isMainThread());</span>
<span class="line-added"> 75     ASSERT(m_page);</span>
<span class="line-added"> 76     ASSERT(scrollingTree());</span>
<span class="line-added"> 77 </span>
<span class="line-added"> 78     ScrollingThread::dispatch([threadedScrollingTree = makeRef(downcast&lt;ThreadedScrollingTree&gt;(*scrollingTree())), wheelEvent] {</span>
<span class="line-added"> 79         threadedScrollingTree-&gt;handleWheelEvent(wheelEvent);</span>
<span class="line-added"> 80     });</span>
<span class="line-added"> 81     return ScrollingEventResult::DidHandleEvent;</span>
 82 }
 83 
 84 void ScrollingCoordinatorNicosia::scheduleTreeStateCommit()
 85 {
 86     if (!m_scrollingStateTreeCommitterTimer.isActive())
 87         m_scrollingStateTreeCommitterTimer.startOneShot(0_s);
 88 }
 89 
 90 void ScrollingCoordinatorNicosia::commitTreeState()
 91 {
<span class="line-added"> 92     willCommitTree();</span>
<span class="line-added"> 93 </span>
 94     if (!scrollingStateTree()-&gt;hasChangedProperties())
 95         return;
 96 
 97     RefPtr&lt;ThreadedScrollingTree&gt; threadedScrollingTree = downcast&lt;ThreadedScrollingTree&gt;(scrollingTree());
<span class="line-added"> 98     threadedScrollingTree-&gt;incrementPendingCommitCount();</span>
 99 
100     auto treeState = scrollingStateTree()-&gt;commit(LayerRepresentation::PlatformLayerRepresentation);
101     ScrollingThread::dispatch([threadedScrollingTree, treeState = WTFMove(treeState)]() mutable {
102         threadedScrollingTree-&gt;commitTreeState(WTFMove(treeState));
103     });
104 }
105 
106 } // namespace WebCore
107 
108 #endif // ENABLE(ASYNC_SCROLLING) &amp;&amp; USE(NICOSIA)
</pre>
</td>
</tr>
</table>
<center><a href="../ThreadedScrollingTree.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="ScrollingStateNodeNicosia.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>