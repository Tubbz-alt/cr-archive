<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WebCore/bindings/js/JSDocumentCustom.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="JSDeprecatedCSSOMValueCustom.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="JSDocumentCustom.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/bindings/js/JSDocumentCustom.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 15  * along with this library; see the file COPYING.LIB.  If not, write to
 16  * the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
 17  * Boston, MA 02110-1301, USA.
 18  */
 19 
 20 #include &quot;config.h&quot;
 21 #include &quot;JSDocument.h&quot;
 22 
 23 #include &quot;Frame.h&quot;
 24 #include &quot;JSDOMWindowCustom.h&quot;
 25 #include &quot;JSHTMLDocument.h&quot;
 26 #include &quot;JSXMLDocument.h&quot;
 27 #include &quot;NodeTraversal.h&quot;
 28 #include &quot;SVGDocument.h&quot;
 29 #include &lt;JavaScriptCore/HeapAnalyzer.h&gt;
 30 
 31 
 32 namespace WebCore {
 33 using namespace JSC;
 34 
<span class="line-modified"> 35 static inline JSValue createNewDocumentWrapper(ExecState&amp; state, JSDOMGlobalObject&amp; globalObject, Ref&lt;Document&gt;&amp;&amp; passedDocument)</span>
 36 {
 37     auto&amp; document = passedDocument.get();
 38     JSObject* wrapper;
 39     if (document.isHTMLDocument())
 40         wrapper = createWrapper&lt;HTMLDocument&gt;(&amp;globalObject, WTFMove(passedDocument));
 41     else if (document.isXMLDocument())
 42         wrapper = createWrapper&lt;XMLDocument&gt;(&amp;globalObject, WTFMove(passedDocument));
 43     else
 44         wrapper = createWrapper&lt;Document&gt;(&amp;globalObject, WTFMove(passedDocument));
 45 
<span class="line-modified"> 46     reportMemoryForDocumentIfFrameless(state, document);</span>
 47 
 48     return wrapper;
 49 }
 50 
<span class="line-modified"> 51 JSObject* cachedDocumentWrapper(ExecState&amp; state, JSDOMGlobalObject&amp; globalObject, Document&amp; document)</span>
 52 {
 53     if (auto* wrapper = getCachedWrapper(globalObject.world(), document))
 54         return wrapper;
 55 
 56     auto* window = document.domWindow();
 57     if (!window)
 58         return nullptr;
 59 
<span class="line-modified"> 60     auto* documentGlobalObject = toJSDOMWindow(state.vm(), toJS(&amp;state, *window));</span>
 61     if (!documentGlobalObject)
 62         return nullptr;
 63 
 64     // Creating a wrapper for domWindow might have created a wrapper for document as well.
 65     return getCachedWrapper(documentGlobalObject-&gt;world(), document);
 66 }
 67 
<span class="line-modified"> 68 void reportMemoryForDocumentIfFrameless(ExecState&amp; state, Document&amp; document)</span>
 69 {
 70     // Make sure the document is kept around by the window object, and works right with the back/forward cache.
 71     if (document.frame())
 72         return;
 73 
<span class="line-modified"> 74     VM&amp; vm = state.vm();</span>
 75     size_t memoryCost = 0;
 76     for (Node* node = &amp;document; node; node = NodeTraversal::next(*node))
 77         memoryCost += node-&gt;approximateMemoryCost();
 78 
 79     // FIXME: Adopt reportExtraMemoryVisited, and switch to reportExtraMemoryAllocated.
 80     // https://bugs.webkit.org/show_bug.cgi?id=142595
 81     vm.heap.deprecatedReportExtraMemory(memoryCost);
 82 }
 83 
<span class="line-modified"> 84 JSValue toJSNewlyCreated(ExecState* state, JSDOMGlobalObject* globalObject, Ref&lt;Document&gt;&amp;&amp; document)</span>
 85 {
<span class="line-modified"> 86     return createNewDocumentWrapper(*state, *globalObject, WTFMove(document));</span>
 87 }
 88 
<span class="line-modified"> 89 JSValue toJS(ExecState* state, JSDOMGlobalObject* globalObject, Document&amp; document)</span>
 90 {
<span class="line-modified"> 91     if (auto* wrapper = cachedDocumentWrapper(*state, *globalObject, document))</span>
 92         return wrapper;
<span class="line-modified"> 93     return toJSNewlyCreated(state, globalObject, Ref&lt;Document&gt;(document));</span>
 94 }
 95 
 96 void JSDocument::visitAdditionalChildren(SlotVisitor&amp; visitor)
 97 {
 98     visitor.addOpaqueRoot(static_cast&lt;ScriptExecutionContext*&gt;(&amp;wrapped()));
 99 }
100 
101 void JSDocument::analyzeHeap(JSCell* cell, HeapAnalyzer&amp; analyzer)
102 {
103     Base::analyzeHeap(cell, analyzer);
104     auto* thisObject = jsCast&lt;JSDocument*&gt;(cell);
105     analyzer.setLabelForCell(cell, thisObject-&gt;wrapped().url().string());
106 }
107 
108 } // namespace WebCore
</pre>
</td>
<td>
<hr />
<pre>
 15  * along with this library; see the file COPYING.LIB.  If not, write to
 16  * the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
 17  * Boston, MA 02110-1301, USA.
 18  */
 19 
 20 #include &quot;config.h&quot;
 21 #include &quot;JSDocument.h&quot;
 22 
 23 #include &quot;Frame.h&quot;
 24 #include &quot;JSDOMWindowCustom.h&quot;
 25 #include &quot;JSHTMLDocument.h&quot;
 26 #include &quot;JSXMLDocument.h&quot;
 27 #include &quot;NodeTraversal.h&quot;
 28 #include &quot;SVGDocument.h&quot;
 29 #include &lt;JavaScriptCore/HeapAnalyzer.h&gt;
 30 
 31 
 32 namespace WebCore {
 33 using namespace JSC;
 34 
<span class="line-modified"> 35 static inline JSValue createNewDocumentWrapper(JSGlobalObject&amp; lexicalGlobalObject, JSDOMGlobalObject&amp; globalObject, Ref&lt;Document&gt;&amp;&amp; passedDocument)</span>
 36 {
 37     auto&amp; document = passedDocument.get();
 38     JSObject* wrapper;
 39     if (document.isHTMLDocument())
 40         wrapper = createWrapper&lt;HTMLDocument&gt;(&amp;globalObject, WTFMove(passedDocument));
 41     else if (document.isXMLDocument())
 42         wrapper = createWrapper&lt;XMLDocument&gt;(&amp;globalObject, WTFMove(passedDocument));
 43     else
 44         wrapper = createWrapper&lt;Document&gt;(&amp;globalObject, WTFMove(passedDocument));
 45 
<span class="line-modified"> 46     reportMemoryForDocumentIfFrameless(lexicalGlobalObject, document);</span>
 47 
 48     return wrapper;
 49 }
 50 
<span class="line-modified"> 51 JSObject* cachedDocumentWrapper(JSGlobalObject&amp; lexicalGlobalObject, JSDOMGlobalObject&amp; globalObject, Document&amp; document)</span>
 52 {
 53     if (auto* wrapper = getCachedWrapper(globalObject.world(), document))
 54         return wrapper;
 55 
 56     auto* window = document.domWindow();
 57     if (!window)
 58         return nullptr;
 59 
<span class="line-modified"> 60     auto* documentGlobalObject = toJSDOMWindow(lexicalGlobalObject.vm(), toJS(&amp;lexicalGlobalObject, *window));</span>
 61     if (!documentGlobalObject)
 62         return nullptr;
 63 
 64     // Creating a wrapper for domWindow might have created a wrapper for document as well.
 65     return getCachedWrapper(documentGlobalObject-&gt;world(), document);
 66 }
 67 
<span class="line-modified"> 68 void reportMemoryForDocumentIfFrameless(JSGlobalObject&amp; lexicalGlobalObject, Document&amp; document)</span>
 69 {
 70     // Make sure the document is kept around by the window object, and works right with the back/forward cache.
 71     if (document.frame())
 72         return;
 73 
<span class="line-modified"> 74     VM&amp; vm = lexicalGlobalObject.vm();</span>
 75     size_t memoryCost = 0;
 76     for (Node* node = &amp;document; node; node = NodeTraversal::next(*node))
 77         memoryCost += node-&gt;approximateMemoryCost();
 78 
 79     // FIXME: Adopt reportExtraMemoryVisited, and switch to reportExtraMemoryAllocated.
 80     // https://bugs.webkit.org/show_bug.cgi?id=142595
 81     vm.heap.deprecatedReportExtraMemory(memoryCost);
 82 }
 83 
<span class="line-modified"> 84 JSValue toJSNewlyCreated(JSGlobalObject* lexicalGlobalObject, JSDOMGlobalObject* globalObject, Ref&lt;Document&gt;&amp;&amp; document)</span>
 85 {
<span class="line-modified"> 86     return createNewDocumentWrapper(*lexicalGlobalObject, *globalObject, WTFMove(document));</span>
 87 }
 88 
<span class="line-modified"> 89 JSValue toJS(JSGlobalObject* lexicalGlobalObject, JSDOMGlobalObject* globalObject, Document&amp; document)</span>
 90 {
<span class="line-modified"> 91     if (auto* wrapper = cachedDocumentWrapper(*lexicalGlobalObject, *globalObject, document))</span>
 92         return wrapper;
<span class="line-modified"> 93     return toJSNewlyCreated(lexicalGlobalObject, globalObject, Ref&lt;Document&gt;(document));</span>
 94 }
 95 
 96 void JSDocument::visitAdditionalChildren(SlotVisitor&amp; visitor)
 97 {
 98     visitor.addOpaqueRoot(static_cast&lt;ScriptExecutionContext*&gt;(&amp;wrapped()));
 99 }
100 
101 void JSDocument::analyzeHeap(JSCell* cell, HeapAnalyzer&amp; analyzer)
102 {
103     Base::analyzeHeap(cell, analyzer);
104     auto* thisObject = jsCast&lt;JSDocument*&gt;(cell);
105     analyzer.setLabelForCell(cell, thisObject-&gt;wrapped().url().string());
106 }
107 
108 } // namespace WebCore
</pre>
</td>
</tr>
</table>
<center><a href="JSDeprecatedCSSOMValueCustom.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="JSDocumentCustom.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>