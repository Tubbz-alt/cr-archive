<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/WebCore/html/canvas/WebGLRenderingContext.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (C) 2015-2017 Apple Inc. All rights reserved.
  3  *
  4  * Redistribution and use in source and binary forms, with or without
  5  * modification, are permitted provided that the following conditions
  6  * are met:
  7  * 1. Redistributions of source code must retain the above copyright
  8  *    notice, this list of conditions and the following disclaimer.
  9  * 2. Redistributions in binary form must reproduce the above copyright
 10  *    notice, this list of conditions and the following disclaimer in the
 11  *    documentation and/or other materials provided with the distribution.
 12  *
 13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. ``AS IS&#39;&#39; AND ANY
 14  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 15  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 16  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE INC. OR
 17  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 18  * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 19  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 20  * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 21  * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 22  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 23  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #include &quot;config.h&quot;
 27 #include &quot;WebGLRenderingContext.h&quot;
 28 
 29 #if ENABLE(WEBGL)
 30 
 31 #include &quot;ANGLEInstancedArrays.h&quot;
 32 #include &quot;CachedImage.h&quot;
 33 #include &quot;EXTBlendMinMax.h&quot;
 34 #include &quot;EXTFragDepth.h&quot;
 35 #include &quot;EXTShaderTextureLOD.h&quot;
 36 #include &quot;EXTTextureFilterAnisotropic.h&quot;
 37 #include &quot;EXTsRGB.h&quot;
<a name="1" id="anc1"></a><span class="line-modified"> 38 #include &quot;ExtensionsGL.h&quot;</span>
 39 #include &quot;HTMLCanvasElement.h&quot;
 40 #include &quot;HTMLImageElement.h&quot;
 41 #include &quot;HTMLVideoElement.h&quot;
 42 #include &quot;ImageData.h&quot;
 43 #include &quot;InspectorInstrumentation.h&quot;
 44 #include &quot;OESElementIndexUint.h&quot;
 45 #include &quot;OESStandardDerivatives.h&quot;
 46 #include &quot;OESTextureFloat.h&quot;
 47 #include &quot;OESTextureFloatLinear.h&quot;
 48 #include &quot;OESTextureHalfFloat.h&quot;
 49 #include &quot;OESTextureHalfFloatLinear.h&quot;
 50 #include &quot;OESVertexArrayObject.h&quot;
 51 #include &quot;RenderBox.h&quot;
 52 #include &quot;WebGLCompressedTextureASTC.h&quot;
 53 #include &quot;WebGLCompressedTextureATC.h&quot;
<a name="2" id="anc2"></a><span class="line-added"> 54 #include &quot;WebGLCompressedTextureETC.h&quot;</span>
<span class="line-added"> 55 #include &quot;WebGLCompressedTextureETC1.h&quot;</span>
 56 #include &quot;WebGLCompressedTexturePVRTC.h&quot;
 57 #include &quot;WebGLCompressedTextureS3TC.h&quot;
 58 #include &quot;WebGLDebugRendererInfo.h&quot;
 59 #include &quot;WebGLDebugShaders.h&quot;
 60 #include &quot;WebGLDepthTexture.h&quot;
 61 #include &quot;WebGLDrawBuffers.h&quot;
 62 #include &quot;WebGLLoseContext.h&quot;
 63 #include &quot;WebGLVertexArrayObjectOES.h&quot;
 64 #include &lt;JavaScriptCore/GenericTypedArrayViewInlines.h&gt;
 65 #include &lt;JavaScriptCore/HeapInlines.h&gt;
 66 #include &lt;JavaScriptCore/JSCJSValueInlines.h&gt;
 67 #include &lt;JavaScriptCore/JSCellInlines.h&gt;
 68 #include &lt;JavaScriptCore/JSGenericTypedArrayViewInlines.h&gt;
 69 #include &lt;wtf/IsoMallocInlines.h&gt;
 70 
 71 namespace WebCore {
 72 
 73 WTF_MAKE_ISO_ALLOCATED_IMPL(WebGLRenderingContext);
 74 
<a name="3" id="anc3"></a><span class="line-modified"> 75 std::unique_ptr&lt;WebGLRenderingContext&gt; WebGLRenderingContext::create(CanvasBase&amp; canvas, GraphicsContextGLAttributes attributes)</span>
 76 {
 77     auto renderingContext = std::unique_ptr&lt;WebGLRenderingContext&gt;(new WebGLRenderingContext(canvas, attributes));
 78 
 79     InspectorInstrumentation::didCreateCanvasRenderingContext(*renderingContext);
 80 
 81     return renderingContext;
 82 }
 83 
<a name="4" id="anc4"></a><span class="line-modified"> 84 std::unique_ptr&lt;WebGLRenderingContext&gt; WebGLRenderingContext::create(CanvasBase&amp; canvas, Ref&lt;GraphicsContextGLOpenGL&gt;&amp;&amp; context, GraphicsContextGLAttributes attributes)</span>
 85 {
 86     auto renderingContext = std::unique_ptr&lt;WebGLRenderingContext&gt;(new WebGLRenderingContext(canvas, WTFMove(context), attributes));
 87 
 88     InspectorInstrumentation::didCreateCanvasRenderingContext(*renderingContext);
 89 
 90     return renderingContext;
 91 }
 92 
<a name="5" id="anc5"></a><span class="line-modified"> 93 WebGLRenderingContext::WebGLRenderingContext(CanvasBase&amp; canvas, GraphicsContextGLAttributes attributes)</span>
 94     : WebGLRenderingContextBase(canvas, attributes)
 95 {
 96 }
 97 
<a name="6" id="anc6"></a><span class="line-modified"> 98 WebGLRenderingContext::WebGLRenderingContext(CanvasBase&amp; canvas, Ref&lt;GraphicsContextGLOpenGL&gt;&amp;&amp; context, GraphicsContextGLAttributes attributes)</span>
 99     : WebGLRenderingContextBase(canvas, WTFMove(context), attributes)
100 {
101     initializeVertexArrayObjects();
102 }
103 
104 void WebGLRenderingContext::initializeVertexArrayObjects()
105 {
106     m_defaultVertexArrayObject = WebGLVertexArrayObjectOES::create(*this, WebGLVertexArrayObjectOES::Type::Default);
107     addContextObject(*m_defaultVertexArrayObject);
108     m_boundVertexArrayObject = m_defaultVertexArrayObject;
109     if (!isGLES2Compliant())
110         initVertexAttrib0();
111 }
112 
113 WebGLExtension* WebGLRenderingContext::getExtension(const String&amp; name)
114 {
115     if (isContextLostOrPending())
116         return nullptr;
117 
118 #define ENABLE_IF_REQUESTED(type, variable, nameLiteral, canEnable) \
119     if (equalIgnoringASCIICase(name, nameLiteral)) { \
120         if (!variable) { \
121             variable = (canEnable) ? makeUnique&lt;type&gt;(*this) : nullptr; \
122             if (variable != nullptr) \
123                 InspectorInstrumentation::didEnableExtension(*this, name); \
124         } \
125         return variable.get(); \
126     }
127 
128     ENABLE_IF_REQUESTED(EXTBlendMinMax, m_extBlendMinMax, &quot;EXT_blend_minmax&quot;, enableSupportedExtension(&quot;GL_EXT_blend_minmax&quot;_s));
129     ENABLE_IF_REQUESTED(EXTsRGB, m_extsRGB, &quot;EXT_sRGB&quot;, enableSupportedExtension(&quot;GL_EXT_sRGB&quot;_s));
130     ENABLE_IF_REQUESTED(EXTFragDepth, m_extFragDepth, &quot;EXT_frag_depth&quot;, enableSupportedExtension(&quot;GL_EXT_frag_depth&quot;_s));
131     if (equalIgnoringASCIICase(name, &quot;EXT_shader_texture_lod&quot;)) {
132         if (!m_extShaderTextureLOD) {
133             if (!(m_context-&gt;getExtensions().supports(&quot;GL_EXT_shader_texture_lod&quot;_s) || m_context-&gt;getExtensions().supports(&quot;GL_ARB_shader_texture_lod&quot;_s)))
134                 m_extShaderTextureLOD = nullptr;
135             else {
136                 m_context-&gt;getExtensions().ensureEnabled(&quot;GL_EXT_shader_texture_lod&quot;_s);
137                 m_extShaderTextureLOD = makeUnique&lt;EXTShaderTextureLOD&gt;(*this);
138                 InspectorInstrumentation::didEnableExtension(*this, name);
139             }
140         }
141         return m_extShaderTextureLOD.get();
142     }
143     ENABLE_IF_REQUESTED(EXTTextureFilterAnisotropic, m_extTextureFilterAnisotropic, &quot;EXT_texture_filter_anisotropic&quot;, enableSupportedExtension(&quot;GL_EXT_texture_filter_anisotropic&quot;_s));
<a name="7" id="anc7"></a>
144     ENABLE_IF_REQUESTED(OESStandardDerivatives, m_oesStandardDerivatives, &quot;OES_standard_derivatives&quot;, enableSupportedExtension(&quot;GL_OES_standard_derivatives&quot;_s));
145     ENABLE_IF_REQUESTED(OESTextureFloat, m_oesTextureFloat, &quot;OES_texture_float&quot;, enableSupportedExtension(&quot;GL_OES_texture_float&quot;_s));
146     ENABLE_IF_REQUESTED(OESTextureFloatLinear, m_oesTextureFloatLinear, &quot;OES_texture_float_linear&quot;, enableSupportedExtension(&quot;GL_OES_texture_float_linear&quot;_s));
147     ENABLE_IF_REQUESTED(OESTextureHalfFloat, m_oesTextureHalfFloat, &quot;OES_texture_half_float&quot;, enableSupportedExtension(&quot;GL_OES_texture_half_float&quot;_s));
148     ENABLE_IF_REQUESTED(OESTextureHalfFloatLinear, m_oesTextureHalfFloatLinear, &quot;OES_texture_half_float_linear&quot;, enableSupportedExtension(&quot;GL_OES_texture_half_float_linear&quot;_s));
149     ENABLE_IF_REQUESTED(OESVertexArrayObject, m_oesVertexArrayObject, &quot;OES_vertex_array_object&quot;, enableSupportedExtension(&quot;GL_OES_vertex_array_object&quot;_s));
150     ENABLE_IF_REQUESTED(OESElementIndexUint, m_oesElementIndexUint, &quot;OES_element_index_uint&quot;, enableSupportedExtension(&quot;GL_OES_element_index_uint&quot;_s));
151     ENABLE_IF_REQUESTED(WebGLLoseContext, m_webglLoseContext, &quot;WEBGL_lose_context&quot;, true);
<a name="8" id="anc8"></a><span class="line-added">152     ENABLE_IF_REQUESTED(WebGLCompressedTextureASTC, m_webglCompressedTextureASTC, &quot;WEBGL_compressed_texture_astc&quot;, WebGLCompressedTextureASTC::supported(*this));</span>
153     ENABLE_IF_REQUESTED(WebGLCompressedTextureATC, m_webglCompressedTextureATC, &quot;WEBKIT_WEBGL_compressed_texture_atc&quot;, WebGLCompressedTextureATC::supported(*this));
<a name="9" id="anc9"></a><span class="line-added">154     ENABLE_IF_REQUESTED(WebGLCompressedTextureETC, m_webglCompressedTextureETC, &quot;WEBGL_compressed_texture_etc&quot;, WebGLCompressedTextureETC::supported(*this));</span>
<span class="line-added">155     ENABLE_IF_REQUESTED(WebGLCompressedTextureETC1, m_webglCompressedTextureETC1, &quot;WEBGL_compressed_texture_etc1&quot;, WebGLCompressedTextureETC1::supported(*this));</span>
156     ENABLE_IF_REQUESTED(WebGLCompressedTexturePVRTC, m_webglCompressedTexturePVRTC, &quot;WEBKIT_WEBGL_compressed_texture_pvrtc&quot;, WebGLCompressedTexturePVRTC::supported(*this));
157     ENABLE_IF_REQUESTED(WebGLCompressedTextureS3TC, m_webglCompressedTextureS3TC, &quot;WEBGL_compressed_texture_s3tc&quot;, WebGLCompressedTextureS3TC::supported(*this));
<a name="10" id="anc10"></a>
158     ENABLE_IF_REQUESTED(WebGLDepthTexture, m_webglDepthTexture, &quot;WEBGL_depth_texture&quot;, WebGLDepthTexture::supported(*m_context));
159     if (equalIgnoringASCIICase(name, &quot;WEBGL_draw_buffers&quot;)) {
160         if (!m_webglDrawBuffers) {
161             if (!supportsDrawBuffers())
162                 m_webglDrawBuffers = nullptr;
163             else {
164                 m_context-&gt;getExtensions().ensureEnabled(&quot;GL_EXT_draw_buffers&quot;_s);
165                 m_webglDrawBuffers = makeUnique&lt;WebGLDrawBuffers&gt;(*this);
166                 InspectorInstrumentation::didEnableExtension(*this, name);
167             }
168         }
169         return m_webglDrawBuffers.get();
170     }
171     if (equalIgnoringASCIICase(name, &quot;ANGLE_instanced_arrays&quot;)) {
172         if (!m_angleInstancedArrays) {
173             if (!ANGLEInstancedArrays::supported(*this))
174                 m_angleInstancedArrays = nullptr;
175             else {
176                 m_context-&gt;getExtensions().ensureEnabled(&quot;GL_ANGLE_instanced_arrays&quot;_s);
177                 m_angleInstancedArrays = makeUnique&lt;ANGLEInstancedArrays&gt;(*this);
178                 InspectorInstrumentation::didEnableExtension(*this, name);
179             }
180         }
181         return m_angleInstancedArrays.get();
182     }
183     ENABLE_IF_REQUESTED(WebGLDebugRendererInfo, m_webglDebugRendererInfo, &quot;WEBGL_debug_renderer_info&quot;, true);
184     ENABLE_IF_REQUESTED(WebGLDebugShaders, m_webglDebugShaders, &quot;WEBGL_debug_shaders&quot;, m_context-&gt;getExtensions().supports(&quot;GL_ANGLE_translated_shader_source&quot;_s));
185     return nullptr;
186 }
187 
188 Optional&lt;Vector&lt;String&gt;&gt; WebGLRenderingContext::getSupportedExtensions()
189 {
190     if (isContextLost())
191         return WTF::nullopt;
192 
193     Vector&lt;String&gt; result;
194 
195     if (m_isPendingPolicyResolution)
196         return result;
197 
198     if (m_context-&gt;getExtensions().supports(&quot;GL_EXT_blend_minmax&quot;_s))
199         result.append(&quot;EXT_blend_minmax&quot;_s);
200     if (m_context-&gt;getExtensions().supports(&quot;GL_EXT_sRGB&quot;_s))
201         result.append(&quot;EXT_sRGB&quot;_s);
202     if (m_context-&gt;getExtensions().supports(&quot;GL_EXT_frag_depth&quot;_s))
203         result.append(&quot;EXT_frag_depth&quot;_s);
204     if (m_context-&gt;getExtensions().supports(&quot;GL_OES_texture_float&quot;_s))
205         result.append(&quot;OES_texture_float&quot;_s);
206     if (m_context-&gt;getExtensions().supports(&quot;GL_OES_texture_float_linear&quot;_s))
207         result.append(&quot;OES_texture_float_linear&quot;_s);
208     if (m_context-&gt;getExtensions().supports(&quot;GL_OES_texture_half_float&quot;_s))
209         result.append(&quot;OES_texture_half_float&quot;_s);
210     if (m_context-&gt;getExtensions().supports(&quot;GL_OES_texture_half_float_linear&quot;_s))
211         result.append(&quot;OES_texture_half_float_linear&quot;_s);
212     if (m_context-&gt;getExtensions().supports(&quot;GL_OES_standard_derivatives&quot;_s))
213         result.append(&quot;OES_standard_derivatives&quot;_s);
214     if (m_context-&gt;getExtensions().supports(&quot;GL_EXT_shader_texture_lod&quot;_s) || m_context-&gt;getExtensions().supports(&quot;GL_ARB_shader_texture_lod&quot;_s))
215         result.append(&quot;EXT_shader_texture_lod&quot;_s);
216     if (m_context-&gt;getExtensions().supports(&quot;GL_EXT_texture_filter_anisotropic&quot;_s))
217         result.append(&quot;EXT_texture_filter_anisotropic&quot;_s);
218     if (m_context-&gt;getExtensions().supports(&quot;GL_OES_vertex_array_object&quot;_s))
219         result.append(&quot;OES_vertex_array_object&quot;_s);
220     if (m_context-&gt;getExtensions().supports(&quot;GL_OES_element_index_uint&quot;_s))
221         result.append(&quot;OES_element_index_uint&quot;_s);
222     result.append(&quot;WEBGL_lose_context&quot;_s);
<a name="11" id="anc11"></a><span class="line-added">223     if (WebGLCompressedTextureASTC::supported(*this))</span>
<span class="line-added">224         result.append(&quot;WEBGL_compressed_texture_astc&quot;_s);</span>
225     if (WebGLCompressedTextureATC::supported(*this))
226         result.append(&quot;WEBKIT_WEBGL_compressed_texture_atc&quot;_s);
<a name="12" id="anc12"></a><span class="line-added">227     if (WebGLCompressedTextureETC::supported(*this))</span>
<span class="line-added">228         result.append(&quot;WEBGL_compressed_texture_etc&quot;_s);</span>
<span class="line-added">229     if (WebGLCompressedTextureETC1::supported(*this))</span>
<span class="line-added">230         result.append(&quot;WEBGL_compressed_texture_etc1&quot;_s);</span>
231     if (WebGLCompressedTexturePVRTC::supported(*this))
232         result.append(&quot;WEBKIT_WEBGL_compressed_texture_pvrtc&quot;_s);
233     if (WebGLCompressedTextureS3TC::supported(*this))
234         result.append(&quot;WEBGL_compressed_texture_s3tc&quot;_s);
<a name="13" id="anc13"></a>

235     if (WebGLDepthTexture::supported(*m_context))
236         result.append(&quot;WEBGL_depth_texture&quot;_s);
237     if (supportsDrawBuffers())
238         result.append(&quot;WEBGL_draw_buffers&quot;_s);
239     if (ANGLEInstancedArrays::supported(*this))
240         result.append(&quot;ANGLE_instanced_arrays&quot;_s);
241     if (m_context-&gt;getExtensions().supports(&quot;GL_ANGLE_translated_shader_source&quot;_s))
242         result.append(&quot;WEBGL_debug_shaders&quot;_s);
243     result.append(&quot;WEBGL_debug_renderer_info&quot;_s);
244 
245     return result;
246 }
247 
<a name="14" id="anc14"></a><span class="line-modified">248 WebGLAny WebGLRenderingContext::getFramebufferAttachmentParameter(GCGLenum target, GCGLenum attachment, GCGLenum pname)</span>
249 {
250     if (isContextLostOrPending() || !validateFramebufferFuncParameters(&quot;getFramebufferAttachmentParameter&quot;, target, attachment))
251         return nullptr;
252 
253     if (!m_framebufferBinding || !m_framebufferBinding-&gt;object()) {
<a name="15" id="anc15"></a><span class="line-modified">254         synthesizeGLError(GraphicsContextGL::INVALID_OPERATION, &quot;getFramebufferAttachmentParameter&quot;, &quot;no framebuffer bound&quot;);</span>
255         return nullptr;
256     }
257 
258     auto object = makeRefPtr(m_framebufferBinding-&gt;getAttachmentObject(attachment));
259     if (!object) {
<a name="16" id="anc16"></a><span class="line-modified">260         if (pname == GraphicsContextGL::FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE)</span>
<span class="line-modified">261             return static_cast&lt;unsigned&gt;(GraphicsContextGL::NONE);</span>
262         // OpenGL ES 2.0 specifies INVALID_ENUM in this case, while desktop GL
263         // specifies INVALID_OPERATION.
<a name="17" id="anc17"></a><span class="line-modified">264         synthesizeGLError(GraphicsContextGL::INVALID_ENUM, &quot;getFramebufferAttachmentParameter&quot;, &quot;invalid parameter name&quot;);</span>
265         return nullptr;
266     }
267 
268     if (object-&gt;isTexture()) {
269         switch (pname) {
<a name="18" id="anc18"></a><span class="line-modified">270         case GraphicsContextGL::FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE:</span>
<span class="line-modified">271             return static_cast&lt;unsigned&gt;(GraphicsContextGL::TEXTURE);</span>
<span class="line-modified">272         case GraphicsContextGL::FRAMEBUFFER_ATTACHMENT_OBJECT_NAME:</span>
273             return makeRefPtr(reinterpret_cast&lt;WebGLTexture&amp;&gt;(*object));
<a name="19" id="anc19"></a><span class="line-modified">274         case GraphicsContextGL::FRAMEBUFFER_ATTACHMENT_TEXTURE_LEVEL:</span>
<span class="line-modified">275         case GraphicsContextGL::FRAMEBUFFER_ATTACHMENT_TEXTURE_CUBE_MAP_FACE:</span>
<span class="line-modified">276         case ExtensionsGL::FRAMEBUFFER_ATTACHMENT_COLOR_ENCODING_EXT: {</span>
<span class="line-modified">277             GCGLint value = 0;</span>
278             m_context-&gt;getFramebufferAttachmentParameteriv(target, attachment, pname, &amp;value);
279             return value;
280         }
281         default:
<a name="20" id="anc20"></a><span class="line-modified">282             synthesizeGLError(GraphicsContextGL::INVALID_ENUM, &quot;getFramebufferAttachmentParameter&quot;, &quot;invalid parameter name for texture attachment&quot;);</span>
283             return nullptr;
284         }
285     } else {
286         ASSERT(object-&gt;isRenderbuffer());
287         switch (pname) {
<a name="21" id="anc21"></a><span class="line-modified">288         case GraphicsContextGL::FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE:</span>
<span class="line-modified">289             return static_cast&lt;unsigned&gt;(GraphicsContextGL::RENDERBUFFER);</span>
<span class="line-modified">290         case GraphicsContextGL::FRAMEBUFFER_ATTACHMENT_OBJECT_NAME:</span>
291             return makeRefPtr(reinterpret_cast&lt;WebGLRenderbuffer&amp;&gt;(*object));
<a name="22" id="anc22"></a><span class="line-modified">292         case ExtensionsGL::FRAMEBUFFER_ATTACHMENT_COLOR_ENCODING_EXT: {</span>
293             if (!m_extsRGB) {
<a name="23" id="anc23"></a><span class="line-modified">294                 synthesizeGLError(GraphicsContextGL::INVALID_ENUM, &quot;getFramebufferAttachmentParameter&quot;, &quot;invalid parameter name for renderbuffer attachment&quot;);</span>
295                 return nullptr;
296             }
297             RefPtr&lt;WebGLRenderbuffer&gt; renderBuffer = reinterpret_cast&lt;WebGLRenderbuffer*&gt;(object.get());
<a name="24" id="anc24"></a><span class="line-modified">298             GCGLenum renderBufferFormat = renderBuffer-&gt;getInternalFormat();</span>
<span class="line-modified">299             ASSERT(renderBufferFormat != ExtensionsGL::SRGB_EXT &amp;&amp; renderBufferFormat != ExtensionsGL::SRGB_ALPHA_EXT);</span>
<span class="line-modified">300             if (renderBufferFormat == ExtensionsGL::SRGB8_ALPHA8_EXT)</span>
<span class="line-modified">301                 return static_cast&lt;unsigned&gt;(ExtensionsGL::SRGB_EXT);</span>
<span class="line-modified">302             return static_cast&lt;unsigned&gt;(GraphicsContextGL::LINEAR);</span>
303         }
304         default:
<a name="25" id="anc25"></a><span class="line-modified">305             synthesizeGLError(GraphicsContextGL::INVALID_ENUM, &quot;getFramebufferAttachmentParameter&quot;, &quot;invalid parameter name for renderbuffer attachment&quot;);</span>
306             return nullptr;
307         }
308     }
309 }
310 
<a name="26" id="anc26"></a><span class="line-modified">311 bool WebGLRenderingContext::validateFramebufferFuncParameters(const char* functionName, GCGLenum target, GCGLenum attachment)</span>
312 {
<a name="27" id="anc27"></a><span class="line-modified">313     if (target != GraphicsContextGL::FRAMEBUFFER) {</span>
<span class="line-modified">314         synthesizeGLError(GraphicsContextGL::INVALID_ENUM, functionName, &quot;invalid target&quot;);</span>
315         return false;
316     }
317     // FIXME: Why does this return true unconditionally for COLOR_ATTACHMENT0,
318     // but false for other COLOR_ATTACHMENT values if m_webglDrawBuffers is false?
319     switch (attachment) {
<a name="28" id="anc28"></a><span class="line-modified">320     case GraphicsContextGL::COLOR_ATTACHMENT0:</span>
<span class="line-modified">321     case GraphicsContextGL::DEPTH_ATTACHMENT:</span>
<span class="line-modified">322     case GraphicsContextGL::STENCIL_ATTACHMENT:</span>
<span class="line-modified">323     case GraphicsContextGL::DEPTH_STENCIL_ATTACHMENT:</span>
324         return true;
325     default:
326         if (m_webglDrawBuffers
<a name="29" id="anc29"></a><span class="line-modified">327             &amp;&amp; attachment &gt;= GraphicsContextGL::COLOR_ATTACHMENT0</span>
<span class="line-modified">328             &amp;&amp; attachment &lt; static_cast&lt;GCGLenum&gt;(GraphicsContextGL::COLOR_ATTACHMENT0 + getMaxColorAttachments()))</span>
329             return true;
<a name="30" id="anc30"></a><span class="line-modified">330         synthesizeGLError(GraphicsContextGL::INVALID_ENUM, functionName, &quot;invalid attachment&quot;);</span>
331         return false;
332     }
333 }
334 
<a name="31" id="anc31"></a><span class="line-modified">335 void WebGLRenderingContext::renderbufferStorage(GCGLenum target, GCGLenum internalformat, GCGLsizei width, GCGLsizei height)</span>
336 {
337     if (isContextLostOrPending())
338         return;
<a name="32" id="anc32"></a><span class="line-modified">339     if (target != GraphicsContextGL::RENDERBUFFER) {</span>
<span class="line-modified">340         synthesizeGLError(GraphicsContextGL::INVALID_ENUM, &quot;renderbufferStorage&quot;, &quot;invalid target&quot;);</span>
341         return;
342     }
343     if (!m_renderbufferBinding || !m_renderbufferBinding-&gt;object()) {
<a name="33" id="anc33"></a><span class="line-modified">344         synthesizeGLError(GraphicsContextGL::INVALID_OPERATION, &quot;renderbufferStorage&quot;, &quot;no bound renderbuffer&quot;);</span>
345         return;
346     }
347     if (!validateSize(&quot;renderbufferStorage&quot;, width, height))
348         return;
349     switch (internalformat) {
<a name="34" id="anc34"></a><span class="line-modified">350     case GraphicsContextGL::DEPTH_COMPONENT16:</span>
<span class="line-modified">351     case GraphicsContextGL::RGBA4:</span>
<span class="line-modified">352     case GraphicsContextGL::RGB5_A1:</span>
<span class="line-modified">353     case GraphicsContextGL::RGB565:</span>
<span class="line-modified">354     case GraphicsContextGL::STENCIL_INDEX8:</span>
<span class="line-modified">355     case ExtensionsGL::SRGB8_ALPHA8_EXT:</span>
<span class="line-modified">356         if (internalformat == ExtensionsGL::SRGB8_ALPHA8_EXT &amp;&amp; !m_extsRGB) {</span>
<span class="line-modified">357             synthesizeGLError(GraphicsContextGL::INVALID_ENUM, &quot;renderbufferStorage&quot;, &quot;invalid internalformat&quot;);</span>
358             return;
359         }
360         m_context-&gt;renderbufferStorage(target, internalformat, width, height);
361         m_renderbufferBinding-&gt;setInternalFormat(internalformat);
362         m_renderbufferBinding-&gt;setIsValid(true);
363         m_renderbufferBinding-&gt;setSize(width, height);
364         break;
<a name="35" id="anc35"></a><span class="line-modified">365     case GraphicsContextGL::DEPTH_STENCIL:</span>
366         if (isDepthStencilSupported())
<a name="36" id="anc36"></a><span class="line-modified">367             m_context-&gt;renderbufferStorage(target, ExtensionsGL::DEPTH24_STENCIL8, width, height);</span>
368         m_renderbufferBinding-&gt;setSize(width, height);
369         m_renderbufferBinding-&gt;setIsValid(isDepthStencilSupported());
370         m_renderbufferBinding-&gt;setInternalFormat(internalformat);
371         break;
372     default:
<a name="37" id="anc37"></a><span class="line-modified">373         synthesizeGLError(GraphicsContextGL::INVALID_ENUM, &quot;renderbufferStorage&quot;, &quot;invalid internalformat&quot;);</span>
374         return;
375     }
376     applyStencilTest();
377 }
378 
<a name="38" id="anc38"></a><span class="line-modified">379 void WebGLRenderingContext::hint(GCGLenum target, GCGLenum mode)</span>
380 {
381     if (isContextLostOrPending())
382         return;
383     bool isValid = false;
384     switch (target) {
<a name="39" id="anc39"></a><span class="line-modified">385     case GraphicsContextGL::GENERATE_MIPMAP_HINT:</span>
386         isValid = true;
387         break;
<a name="40" id="anc40"></a><span class="line-modified">388     case ExtensionsGL::FRAGMENT_SHADER_DERIVATIVE_HINT_OES: // OES_standard_derivatives</span>
389         if (m_oesStandardDerivatives)
390             isValid = true;
391         break;
392     }
393     if (!isValid) {
<a name="41" id="anc41"></a><span class="line-modified">394         synthesizeGLError(GraphicsContextGL::INVALID_ENUM, &quot;hint&quot;, &quot;invalid target&quot;);</span>
395         return;
396     }
397     m_context-&gt;hint(target, mode);
398 }
399 
<a name="42" id="anc42"></a><span class="line-modified">400 void WebGLRenderingContext::clear(GCGLbitfield mask)</span>
401 {
402     if (isContextLostOrPending())
403         return;
<a name="43" id="anc43"></a><span class="line-modified">404     if (mask &amp; ~(GraphicsContextGL::COLOR_BUFFER_BIT | GraphicsContextGL::DEPTH_BUFFER_BIT | GraphicsContextGL::STENCIL_BUFFER_BIT)) {</span>
<span class="line-modified">405         synthesizeGLError(GraphicsContextGL::INVALID_VALUE, &quot;clear&quot;, &quot;invalid mask&quot;);</span>
406         return;
407     }
408     const char* reason = &quot;framebuffer incomplete&quot;;
409     if (m_framebufferBinding &amp;&amp; !m_framebufferBinding-&gt;onAccess(m_context.get(), &amp;reason)) {
<a name="44" id="anc44"></a><span class="line-modified">410         synthesizeGLError(GraphicsContextGL::INVALID_FRAMEBUFFER_OPERATION, &quot;clear&quot;, reason);</span>
411         return;
412     }
413     if (!clearIfComposited(mask))
414         m_context-&gt;clear(mask);
415     markContextChangedAndNotifyCanvasObserver();
416 }
417 
<a name="45" id="anc45"></a><span class="line-modified">418 WebGLAny WebGLRenderingContext::getParameter(GCGLenum pname)</span>
419 {
420     if (isContextLostOrPending())
421         return nullptr;
422 
423     switch (pname) {
<a name="46" id="anc46"></a><span class="line-modified">424     case GraphicsContextGL::ACTIVE_TEXTURE:</span>
425         return getUnsignedIntParameter(pname);
<a name="47" id="anc47"></a><span class="line-modified">426     case GraphicsContextGL::ALIASED_LINE_WIDTH_RANGE:</span>
427         return getWebGLFloatArrayParameter(pname);
<a name="48" id="anc48"></a><span class="line-modified">428     case GraphicsContextGL::ALIASED_POINT_SIZE_RANGE:</span>
429         return getWebGLFloatArrayParameter(pname);
<a name="49" id="anc49"></a><span class="line-modified">430     case GraphicsContextGL::ALPHA_BITS:</span>
431         if (!m_framebufferBinding &amp;&amp; !m_attributes.alpha)
432             return 0;
433         return getIntParameter(pname);
<a name="50" id="anc50"></a><span class="line-modified">434     case GraphicsContextGL::ARRAY_BUFFER_BINDING:</span>
435         return m_boundArrayBuffer;
<a name="51" id="anc51"></a><span class="line-modified">436     case GraphicsContextGL::BLEND:</span>
437         return getBooleanParameter(pname);
<a name="52" id="anc52"></a><span class="line-modified">438     case GraphicsContextGL::BLEND_COLOR:</span>
439         return getWebGLFloatArrayParameter(pname);
<a name="53" id="anc53"></a><span class="line-modified">440     case GraphicsContextGL::BLEND_DST_ALPHA:</span>
441         return getUnsignedIntParameter(pname);
<a name="54" id="anc54"></a><span class="line-modified">442     case GraphicsContextGL::BLEND_DST_RGB:</span>
443         return getUnsignedIntParameter(pname);
<a name="55" id="anc55"></a><span class="line-modified">444     case GraphicsContextGL::BLEND_EQUATION_ALPHA:</span>
445         return getUnsignedIntParameter(pname);
<a name="56" id="anc56"></a><span class="line-modified">446     case GraphicsContextGL::BLEND_EQUATION_RGB:</span>
447         return getUnsignedIntParameter(pname);
<a name="57" id="anc57"></a><span class="line-modified">448     case GraphicsContextGL::BLEND_SRC_ALPHA:</span>
449         return getUnsignedIntParameter(pname);
<a name="58" id="anc58"></a><span class="line-modified">450     case GraphicsContextGL::BLEND_SRC_RGB:</span>
451         return getUnsignedIntParameter(pname);
<a name="59" id="anc59"></a><span class="line-modified">452     case GraphicsContextGL::BLUE_BITS:</span>
453         return getIntParameter(pname);
<a name="60" id="anc60"></a><span class="line-modified">454     case GraphicsContextGL::COLOR_CLEAR_VALUE:</span>
455         return getWebGLFloatArrayParameter(pname);
<a name="61" id="anc61"></a><span class="line-modified">456     case GraphicsContextGL::COLOR_WRITEMASK:</span>
457         return getBooleanArrayParameter(pname);
<a name="62" id="anc62"></a><span class="line-modified">458     case GraphicsContextGL::COMPRESSED_TEXTURE_FORMATS:</span>
459         return Uint32Array::tryCreate(m_compressedTextureFormats.data(), m_compressedTextureFormats.size());
<a name="63" id="anc63"></a><span class="line-modified">460     case GraphicsContextGL::CULL_FACE:</span>
461         return getBooleanParameter(pname);
<a name="64" id="anc64"></a><span class="line-modified">462     case GraphicsContextGL::CULL_FACE_MODE:</span>
463         return getUnsignedIntParameter(pname);
<a name="65" id="anc65"></a><span class="line-modified">464     case GraphicsContextGL::CURRENT_PROGRAM:</span>
465         return m_currentProgram;
<a name="66" id="anc66"></a><span class="line-modified">466     case GraphicsContextGL::DEPTH_BITS:</span>
467         if (!m_framebufferBinding &amp;&amp; !m_attributes.depth)
468             return 0;
469         return getIntParameter(pname);
<a name="67" id="anc67"></a><span class="line-modified">470     case GraphicsContextGL::DEPTH_CLEAR_VALUE:</span>
471         return getFloatParameter(pname);
<a name="68" id="anc68"></a><span class="line-modified">472     case GraphicsContextGL::DEPTH_FUNC:</span>
473         return getUnsignedIntParameter(pname);
<a name="69" id="anc69"></a><span class="line-modified">474     case GraphicsContextGL::DEPTH_RANGE:</span>
475         return getWebGLFloatArrayParameter(pname);
<a name="70" id="anc70"></a><span class="line-modified">476     case GraphicsContextGL::DEPTH_TEST:</span>
477         return getBooleanParameter(pname);
<a name="71" id="anc71"></a><span class="line-modified">478     case GraphicsContextGL::DEPTH_WRITEMASK:</span>
479         return getBooleanParameter(pname);
<a name="72" id="anc72"></a><span class="line-modified">480     case GraphicsContextGL::DITHER:</span>
481         return getBooleanParameter(pname);
<a name="73" id="anc73"></a><span class="line-modified">482     case GraphicsContextGL::ELEMENT_ARRAY_BUFFER_BINDING:</span>
483         return makeRefPtr(m_boundVertexArrayObject-&gt;getElementArrayBuffer());
<a name="74" id="anc74"></a><span class="line-modified">484     case GraphicsContextGL::FRAMEBUFFER_BINDING:</span>
485         return m_framebufferBinding;
<a name="75" id="anc75"></a><span class="line-modified">486     case GraphicsContextGL::FRONT_FACE:</span>
487         return getUnsignedIntParameter(pname);
<a name="76" id="anc76"></a><span class="line-modified">488     case GraphicsContextGL::GENERATE_MIPMAP_HINT:</span>
489         return getUnsignedIntParameter(pname);
<a name="77" id="anc77"></a><span class="line-modified">490     case GraphicsContextGL::GREEN_BITS:</span>
491         return getIntParameter(pname);
<a name="78" id="anc78"></a><span class="line-modified">492     case GraphicsContextGL::IMPLEMENTATION_COLOR_READ_FORMAT:</span>
493         return getIntParameter(pname);
<a name="79" id="anc79"></a><span class="line-modified">494     case GraphicsContextGL::IMPLEMENTATION_COLOR_READ_TYPE:</span>
495         return getIntParameter(pname);
<a name="80" id="anc80"></a><span class="line-modified">496     case GraphicsContextGL::LINE_WIDTH:</span>
497         return getFloatParameter(pname);
<a name="81" id="anc81"></a><span class="line-modified">498     case GraphicsContextGL::MAX_COMBINED_TEXTURE_IMAGE_UNITS:</span>
499         return getIntParameter(pname);
<a name="82" id="anc82"></a><span class="line-modified">500     case GraphicsContextGL::MAX_CUBE_MAP_TEXTURE_SIZE:</span>
501         return getIntParameter(pname);
<a name="83" id="anc83"></a><span class="line-modified">502     case GraphicsContextGL::MAX_FRAGMENT_UNIFORM_VECTORS:</span>
503         return getIntParameter(pname);
<a name="84" id="anc84"></a><span class="line-modified">504     case GraphicsContextGL::MAX_RENDERBUFFER_SIZE:</span>
505         return getIntParameter(pname);
<a name="85" id="anc85"></a><span class="line-modified">506     case GraphicsContextGL::MAX_TEXTURE_IMAGE_UNITS:</span>
507         return getIntParameter(pname);
<a name="86" id="anc86"></a><span class="line-modified">508     case GraphicsContextGL::MAX_TEXTURE_SIZE:</span>
509         return getIntParameter(pname);
<a name="87" id="anc87"></a><span class="line-modified">510     case GraphicsContextGL::MAX_VARYING_VECTORS:</span>
511         return getIntParameter(pname);
<a name="88" id="anc88"></a><span class="line-modified">512     case GraphicsContextGL::MAX_VERTEX_ATTRIBS:</span>
513         return getIntParameter(pname);
<a name="89" id="anc89"></a><span class="line-modified">514     case GraphicsContextGL::MAX_VERTEX_TEXTURE_IMAGE_UNITS:</span>
515         return getIntParameter(pname);
<a name="90" id="anc90"></a><span class="line-modified">516     case GraphicsContextGL::MAX_VERTEX_UNIFORM_VECTORS:</span>
517         return getIntParameter(pname);
<a name="91" id="anc91"></a><span class="line-modified">518     case GraphicsContextGL::MAX_VIEWPORT_DIMS:</span>
519         return getWebGLIntArrayParameter(pname);
<a name="92" id="anc92"></a><span class="line-modified">520     case GraphicsContextGL::NUM_SHADER_BINARY_FORMATS:</span>
521         return getIntParameter(pname);
<a name="93" id="anc93"></a><span class="line-modified">522     case GraphicsContextGL::PACK_ALIGNMENT:</span>
523         return getIntParameter(pname);
<a name="94" id="anc94"></a><span class="line-modified">524     case GraphicsContextGL::POLYGON_OFFSET_FACTOR:</span>
525         return getFloatParameter(pname);
<a name="95" id="anc95"></a><span class="line-modified">526     case GraphicsContextGL::POLYGON_OFFSET_FILL:</span>
527         return getBooleanParameter(pname);
<a name="96" id="anc96"></a><span class="line-modified">528     case GraphicsContextGL::POLYGON_OFFSET_UNITS:</span>
529         return getFloatParameter(pname);
<a name="97" id="anc97"></a><span class="line-modified">530     case GraphicsContextGL::RED_BITS:</span>
531         return getIntParameter(pname);
<a name="98" id="anc98"></a><span class="line-modified">532     case GraphicsContextGL::RENDERBUFFER_BINDING:</span>
533         return m_renderbufferBinding;
<a name="99" id="anc99"></a><span class="line-modified">534     case GraphicsContextGL::RENDERER:</span>
535         return &quot;WebKit WebGL&quot;_str;
<a name="100" id="anc100"></a><span class="line-modified">536     case GraphicsContextGL::SAMPLE_BUFFERS:</span>
537         return getIntParameter(pname);
<a name="101" id="anc101"></a><span class="line-modified">538     case GraphicsContextGL::SAMPLE_COVERAGE_INVERT:</span>
539         return getBooleanParameter(pname);
<a name="102" id="anc102"></a><span class="line-modified">540     case GraphicsContextGL::SAMPLE_COVERAGE_VALUE:</span>
541         return getFloatParameter(pname);
<a name="103" id="anc103"></a><span class="line-modified">542     case GraphicsContextGL::SAMPLES:</span>
543         return getIntParameter(pname);
<a name="104" id="anc104"></a><span class="line-modified">544     case GraphicsContextGL::SCISSOR_BOX:</span>
545         return getWebGLIntArrayParameter(pname);
<a name="105" id="anc105"></a><span class="line-modified">546     case GraphicsContextGL::SCISSOR_TEST:</span>
547         return getBooleanParameter(pname);
<a name="106" id="anc106"></a><span class="line-modified">548     case GraphicsContextGL::SHADING_LANGUAGE_VERSION:</span>
<span class="line-modified">549         return &quot;WebGL GLSL ES 1.0 (&quot; + m_context-&gt;getString(GraphicsContextGL::SHADING_LANGUAGE_VERSION) + &quot;)&quot;;</span>
<span class="line-modified">550     case GraphicsContextGL::STENCIL_BACK_FAIL:</span>
551         return getUnsignedIntParameter(pname);
<a name="107" id="anc107"></a><span class="line-modified">552     case GraphicsContextGL::STENCIL_BACK_FUNC:</span>
553         return getUnsignedIntParameter(pname);
<a name="108" id="anc108"></a><span class="line-modified">554     case GraphicsContextGL::STENCIL_BACK_PASS_DEPTH_FAIL:</span>
555         return getUnsignedIntParameter(pname);
<a name="109" id="anc109"></a><span class="line-modified">556     case GraphicsContextGL::STENCIL_BACK_PASS_DEPTH_PASS:</span>
557         return getUnsignedIntParameter(pname);
<a name="110" id="anc110"></a><span class="line-modified">558     case GraphicsContextGL::STENCIL_BACK_REF:</span>
559         return getIntParameter(pname);
<a name="111" id="anc111"></a><span class="line-modified">560     case GraphicsContextGL::STENCIL_BACK_VALUE_MASK:</span>
561         return getUnsignedIntParameter(pname);
<a name="112" id="anc112"></a><span class="line-modified">562     case GraphicsContextGL::STENCIL_BACK_WRITEMASK:</span>
563         return getUnsignedIntParameter(pname);
<a name="113" id="anc113"></a><span class="line-modified">564     case GraphicsContextGL::STENCIL_BITS:</span>
565         if (!m_framebufferBinding &amp;&amp; !m_attributes.stencil)
566             return 0;
567         return getIntParameter(pname);
<a name="114" id="anc114"></a><span class="line-modified">568     case GraphicsContextGL::STENCIL_CLEAR_VALUE:</span>
569         return getIntParameter(pname);
<a name="115" id="anc115"></a><span class="line-modified">570     case GraphicsContextGL::STENCIL_FAIL:</span>
571         return getUnsignedIntParameter(pname);
<a name="116" id="anc116"></a><span class="line-modified">572     case GraphicsContextGL::STENCIL_FUNC:</span>
573         return getUnsignedIntParameter(pname);
<a name="117" id="anc117"></a><span class="line-modified">574     case GraphicsContextGL::STENCIL_PASS_DEPTH_FAIL:</span>
575         return getUnsignedIntParameter(pname);
<a name="118" id="anc118"></a><span class="line-modified">576     case GraphicsContextGL::STENCIL_PASS_DEPTH_PASS:</span>
577         return getUnsignedIntParameter(pname);
<a name="119" id="anc119"></a><span class="line-modified">578     case GraphicsContextGL::STENCIL_REF:</span>
579         return getIntParameter(pname);
<a name="120" id="anc120"></a><span class="line-modified">580     case GraphicsContextGL::STENCIL_TEST:</span>
581         return getBooleanParameter(pname);
<a name="121" id="anc121"></a><span class="line-modified">582     case GraphicsContextGL::STENCIL_VALUE_MASK:</span>
583         return getUnsignedIntParameter(pname);
<a name="122" id="anc122"></a><span class="line-modified">584     case GraphicsContextGL::STENCIL_WRITEMASK:</span>
585         return getUnsignedIntParameter(pname);
<a name="123" id="anc123"></a><span class="line-modified">586     case GraphicsContextGL::SUBPIXEL_BITS:</span>
587         return getIntParameter(pname);
<a name="124" id="anc124"></a><span class="line-modified">588     case GraphicsContextGL::TEXTURE_BINDING_2D:</span>
589         return m_textureUnits[m_activeTextureUnit].texture2DBinding;
<a name="125" id="anc125"></a><span class="line-modified">590     case GraphicsContextGL::TEXTURE_BINDING_CUBE_MAP:</span>
591         return m_textureUnits[m_activeTextureUnit].textureCubeMapBinding;
<a name="126" id="anc126"></a><span class="line-modified">592     case GraphicsContextGL::UNPACK_ALIGNMENT:</span>
593         return getIntParameter(pname);
<a name="127" id="anc127"></a><span class="line-modified">594     case GraphicsContextGL::UNPACK_FLIP_Y_WEBGL:</span>
595         return m_unpackFlipY;
<a name="128" id="anc128"></a><span class="line-modified">596     case GraphicsContextGL::UNPACK_PREMULTIPLY_ALPHA_WEBGL:</span>
597         return m_unpackPremultiplyAlpha;
<a name="129" id="anc129"></a><span class="line-modified">598     case GraphicsContextGL::UNPACK_COLORSPACE_CONVERSION_WEBGL:</span>
599         return m_unpackColorspaceConversion;
<a name="130" id="anc130"></a><span class="line-modified">600     case GraphicsContextGL::VENDOR:</span>
601         return &quot;WebKit&quot;_str;
<a name="131" id="anc131"></a><span class="line-modified">602     case GraphicsContextGL::VERSION:</span>
603         return &quot;WebGL 1.0&quot;_str;
<a name="132" id="anc132"></a><span class="line-modified">604     case GraphicsContextGL::VIEWPORT:</span>
605         return getWebGLIntArrayParameter(pname);
<a name="133" id="anc133"></a><span class="line-modified">606     case ExtensionsGL::FRAGMENT_SHADER_DERIVATIVE_HINT_OES: // OES_standard_derivatives</span>
607         if (m_oesStandardDerivatives)
<a name="134" id="anc134"></a><span class="line-modified">608             return getUnsignedIntParameter(ExtensionsGL::FRAGMENT_SHADER_DERIVATIVE_HINT_OES);</span>
<span class="line-modified">609         synthesizeGLError(GraphicsContextGL::INVALID_ENUM, &quot;getParameter&quot;, &quot;invalid parameter name, OES_standard_derivatives not enabled&quot;);</span>
610         return nullptr;
611     case WebGLDebugRendererInfo::UNMASKED_RENDERER_WEBGL:
612         if (m_webglDebugRendererInfo) {
613 #if PLATFORM(IOS_FAMILY)
614             return &quot;Apple GPU&quot;_str;
615 #else
<a name="135" id="anc135"></a><span class="line-modified">616             return m_context-&gt;getString(GraphicsContextGL::RENDERER);</span>
617 #endif
618         }
<a name="136" id="anc136"></a><span class="line-modified">619         synthesizeGLError(GraphicsContextGL::INVALID_ENUM, &quot;getParameter&quot;, &quot;invalid parameter name, WEBGL_debug_renderer_info not enabled&quot;);</span>
620         return nullptr;
621     case WebGLDebugRendererInfo::UNMASKED_VENDOR_WEBGL:
622         if (m_webglDebugRendererInfo)
<a name="137" id="anc137"></a><span class="line-modified">623             return m_context-&gt;getString(GraphicsContextGL::VENDOR);</span>
<span class="line-modified">624         synthesizeGLError(GraphicsContextGL::INVALID_ENUM, &quot;getParameter&quot;, &quot;invalid parameter name, WEBGL_debug_renderer_info not enabled&quot;);</span>
625         return nullptr;
<a name="138" id="anc138"></a><span class="line-modified">626     case ExtensionsGL::VERTEX_ARRAY_BINDING_OES: // OES_vertex_array_object</span>
627         if (m_oesVertexArrayObject) {
628             if (m_boundVertexArrayObject-&gt;isDefaultObject())
629                 return nullptr;
630             return makeRefPtr(static_cast&lt;WebGLVertexArrayObjectOES&amp;&gt;(*m_boundVertexArrayObject));
631         }
<a name="139" id="anc139"></a><span class="line-modified">632         synthesizeGLError(GraphicsContextGL::INVALID_ENUM, &quot;getParameter&quot;, &quot;invalid parameter name, OES_vertex_array_object not enabled&quot;);</span>
633         return nullptr;
<a name="140" id="anc140"></a><span class="line-modified">634     case ExtensionsGL::MAX_TEXTURE_MAX_ANISOTROPY_EXT: // EXT_texture_filter_anisotropic</span>
635         if (m_extTextureFilterAnisotropic)
<a name="141" id="anc141"></a><span class="line-modified">636             return getUnsignedIntParameter(ExtensionsGL::MAX_TEXTURE_MAX_ANISOTROPY_EXT);</span>
<span class="line-modified">637         synthesizeGLError(GraphicsContextGL::INVALID_ENUM, &quot;getParameter&quot;, &quot;invalid parameter name, EXT_texture_filter_anisotropic not enabled&quot;);</span>
638         return nullptr;
<a name="142" id="anc142"></a><span class="line-modified">639     case ExtensionsGL::MAX_COLOR_ATTACHMENTS_EXT: // EXT_draw_buffers BEGIN</span>
640         if (m_webglDrawBuffers)
641             return getMaxColorAttachments();
<a name="143" id="anc143"></a><span class="line-modified">642         synthesizeGLError(GraphicsContextGL::INVALID_ENUM, &quot;getParameter&quot;, &quot;invalid parameter name, WEBGL_draw_buffers not enabled&quot;);</span>
643         return nullptr;
<a name="144" id="anc144"></a><span class="line-modified">644     case ExtensionsGL::MAX_DRAW_BUFFERS_EXT:</span>
645         if (m_webglDrawBuffers)
646             return getMaxDrawBuffers();
<a name="145" id="anc145"></a><span class="line-modified">647         synthesizeGLError(GraphicsContextGL::INVALID_ENUM, &quot;getParameter&quot;, &quot;invalid parameter name, WEBGL_draw_buffers not enabled&quot;);</span>
648         return nullptr;
649     default:
650         if (m_webglDrawBuffers
<a name="146" id="anc146"></a><span class="line-modified">651             &amp;&amp; pname &gt;= ExtensionsGL::DRAW_BUFFER0_EXT</span>
<span class="line-modified">652             &amp;&amp; pname &lt; static_cast&lt;GCGLenum&gt;(ExtensionsGL::DRAW_BUFFER0_EXT + getMaxDrawBuffers())) {</span>
<span class="line-modified">653             GCGLint value = GraphicsContextGL::NONE;</span>
654             if (m_framebufferBinding)
655                 value = m_framebufferBinding-&gt;getDrawBuffer(pname);
656             else // emulated backbuffer
657                 value = m_backDrawBuffer;
658             return value;
659         }
<a name="147" id="anc147"></a><span class="line-modified">660         synthesizeGLError(GraphicsContextGL::INVALID_ENUM, &quot;getParameter&quot;, &quot;invalid parameter name&quot;);</span>
661         return nullptr;
662     }
663 }
664 
<a name="148" id="anc148"></a><span class="line-modified">665 GCGLint WebGLRenderingContext::getMaxDrawBuffers()</span>
666 {
667     if (!supportsDrawBuffers())
668         return 0;
669     if (!m_maxDrawBuffers)
<a name="149" id="anc149"></a><span class="line-modified">670         m_context-&gt;getIntegerv(ExtensionsGL::MAX_DRAW_BUFFERS_EXT, &amp;m_maxDrawBuffers);</span>
671     if (!m_maxColorAttachments)
<a name="150" id="anc150"></a><span class="line-modified">672         m_context-&gt;getIntegerv(ExtensionsGL::MAX_COLOR_ATTACHMENTS_EXT, &amp;m_maxColorAttachments);</span>
673     // WEBGL_draw_buffers requires MAX_COLOR_ATTACHMENTS &gt;= MAX_DRAW_BUFFERS.
674     return std::min(m_maxDrawBuffers, m_maxColorAttachments);
675 }
676 
<a name="151" id="anc151"></a><span class="line-modified">677 GCGLint WebGLRenderingContext::getMaxColorAttachments()</span>
678 {
679     if (!supportsDrawBuffers())
680         return 0;
681     if (!m_maxColorAttachments)
<a name="152" id="anc152"></a><span class="line-modified">682         m_context-&gt;getIntegerv(ExtensionsGL::MAX_COLOR_ATTACHMENTS_EXT, &amp;m_maxColorAttachments);</span>
683     return m_maxColorAttachments;
684 }
685 
<a name="153" id="anc153"></a><span class="line-modified">686 bool WebGLRenderingContext::validateIndexArrayConservative(GCGLenum type, unsigned&amp; numElementsRequired)</span>
687 {
688     // Performs conservative validation by caching a maximum index of
689     // the given type per element array buffer. If all of the bound
690     // array buffers have enough elements to satisfy that maximum
691     // index, skips the expensive per-draw-call iteration in
692     // validateIndexArrayPrecise.
693 
694     RefPtr&lt;WebGLBuffer&gt; elementArrayBuffer = m_boundVertexArrayObject-&gt;getElementArrayBuffer();
695 
696     if (!elementArrayBuffer)
697         return false;
698 
<a name="154" id="anc154"></a><span class="line-modified">699     GCGLsizeiptr numElements = elementArrayBuffer-&gt;byteLength();</span>
700     // The case count==0 is already dealt with in drawElements before validateIndexArrayConservative.
701     if (!numElements)
702         return false;
703     auto buffer = elementArrayBuffer-&gt;elementArrayBuffer();
704     ASSERT(buffer);
705 
706     Optional&lt;unsigned&gt; maxIndex = elementArrayBuffer-&gt;getCachedMaxIndex(type);
707     if (!maxIndex) {
708         // Compute the maximum index in the entire buffer for the given type of index.
709         switch (type) {
<a name="155" id="anc155"></a><span class="line-modified">710         case GraphicsContextGL::UNSIGNED_BYTE: {</span>
<span class="line-modified">711             const GCGLubyte* p = static_cast&lt;const GCGLubyte*&gt;(buffer-&gt;data());</span>
<span class="line-modified">712             for (GCGLsizeiptr i = 0; i &lt; numElements; i++)</span>
713                 maxIndex = maxIndex ? std::max(maxIndex.value(), static_cast&lt;unsigned&gt;(p[i])) : static_cast&lt;unsigned&gt;(p[i]);
714             break;
715         }
<a name="156" id="anc156"></a><span class="line-modified">716         case GraphicsContextGL::UNSIGNED_SHORT: {</span>
<span class="line-modified">717             numElements /= sizeof(GCGLushort);</span>
<span class="line-modified">718             const GCGLushort* p = static_cast&lt;const GCGLushort*&gt;(buffer-&gt;data());</span>
<span class="line-modified">719             for (GCGLsizeiptr i = 0; i &lt; numElements; i++)</span>
720                 maxIndex = maxIndex ? std::max(maxIndex.value(), static_cast&lt;unsigned&gt;(p[i])) : static_cast&lt;unsigned&gt;(p[i]);
721             break;
722         }
<a name="157" id="anc157"></a><span class="line-modified">723         case GraphicsContextGL::UNSIGNED_INT: {</span>
724             if (!m_oesElementIndexUint)
725                 return false;
<a name="158" id="anc158"></a><span class="line-modified">726             numElements /= sizeof(GCGLuint);</span>
<span class="line-modified">727             const GCGLuint* p = static_cast&lt;const GCGLuint*&gt;(buffer-&gt;data());</span>
<span class="line-modified">728             for (GCGLsizeiptr i = 0; i &lt; numElements; i++)</span>
729                 maxIndex = maxIndex ? std::max(maxIndex.value(), static_cast&lt;unsigned&gt;(p[i])) : static_cast&lt;unsigned&gt;(p[i]);
730             break;
731         }
732         default:
733             return false;
734         }
735         if (maxIndex)
736             elementArrayBuffer-&gt;setCachedMaxIndex(type, maxIndex.value());
737     }
738 
739     if (!maxIndex)
740         return false;
741 
742     // The number of required elements is one more than the maximum index that will be accessed.
743     auto checkedNumElementsRequired = checkedAddAndMultiply&lt;unsigned&gt;(maxIndex.value(), 1, 1);
744     if (!checkedNumElementsRequired)
745         return false;
746     numElementsRequired = checkedNumElementsRequired.value();
747 
748     return true;
749 }
750 
<a name="159" id="anc159"></a><span class="line-modified">751 bool WebGLRenderingContext::validateBlendEquation(const char* functionName, GCGLenum mode)</span>
752 {
753     switch (mode) {
<a name="160" id="anc160"></a><span class="line-modified">754     case GraphicsContextGL::FUNC_ADD:</span>
<span class="line-modified">755     case GraphicsContextGL::FUNC_SUBTRACT:</span>
<span class="line-modified">756     case GraphicsContextGL::FUNC_REVERSE_SUBTRACT:</span>
<span class="line-modified">757     case ExtensionsGL::MIN_EXT:</span>
<span class="line-modified">758     case ExtensionsGL::MAX_EXT:</span>
<span class="line-modified">759         if ((mode == ExtensionsGL::MIN_EXT || mode == ExtensionsGL::MAX_EXT) &amp;&amp; !m_extBlendMinMax) {</span>
<span class="line-modified">760             synthesizeGLError(GraphicsContextGL::INVALID_ENUM, functionName, &quot;invalid mode&quot;);</span>
761             return false;
762         }
763         return true;
764         break;
765     default:
<a name="161" id="anc161"></a><span class="line-modified">766         synthesizeGLError(GraphicsContextGL::INVALID_ENUM, functionName, &quot;invalid mode&quot;);</span>
767         return false;
768     }
769 }
770 
<a name="162" id="anc162"></a><span class="line-modified">771 bool WebGLRenderingContext::validateCapability(const char* functionName, GCGLenum cap)</span>
772 {
773     switch (cap) {
<a name="163" id="anc163"></a><span class="line-modified">774     case GraphicsContextGL::BLEND:</span>
<span class="line-modified">775     case GraphicsContextGL::CULL_FACE:</span>
<span class="line-modified">776     case GraphicsContextGL::DEPTH_TEST:</span>
<span class="line-modified">777     case GraphicsContextGL::DITHER:</span>
<span class="line-modified">778     case GraphicsContextGL::POLYGON_OFFSET_FILL:</span>
<span class="line-modified">779     case GraphicsContextGL::SAMPLE_ALPHA_TO_COVERAGE:</span>
<span class="line-modified">780     case GraphicsContextGL::SAMPLE_COVERAGE:</span>
<span class="line-modified">781     case GraphicsContextGL::SCISSOR_TEST:</span>
<span class="line-modified">782     case GraphicsContextGL::STENCIL_TEST:</span>
783         return true;
784     default:
<a name="164" id="anc164"></a><span class="line-modified">785         synthesizeGLError(GraphicsContextGL::INVALID_ENUM, functionName, &quot;invalid capability&quot;);</span>
786         return false;
787     }
788 }
789 
790 } // namespace WebCore
791 
792 #endif // ENABLE(WEBGL)
<a name="165" id="anc165"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="165" type="hidden" />
</body>
</html>