<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/WebCore/layout/FormattingContext.h</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (C) 2018 Apple Inc. All rights reserved.
  3  *
  4  * Redistribution and use in source and binary forms, with or without
  5  * modification, are permitted provided that the following conditions
  6  * are met:
  7  * 1. Redistributions of source code must retain the above copyright
  8  *    notice, this list of conditions and the following disclaimer.
  9  * 2. Redistributions in binary form must reproduce the above copyright
 10  *    notice, this list of conditions and the following disclaimer in the
 11  *    documentation and/or other materials provided with the distribution.
 12  *
 13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. AND ITS CONTRIBUTORS ``AS IS&#39;&#39;
 14  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
 15  * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 16  * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL APPLE INC. OR ITS CONTRIBUTORS
 17  * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 18  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 19  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 20  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 21  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 22  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF
 23  * THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #pragma once
 27 
 28 #if ENABLE(LAYOUT_FORMATTING_CONTEXT)
 29 
<a name="1" id="anc1"></a><span class="line-modified"> 30 #include &quot;LayoutContainer.h&quot;</span>
<span class="line-added"> 31 #include &quot;LayoutUnit.h&quot;</span>
<span class="line-added"> 32 #include &quot;LayoutUnits.h&quot;</span>
 33 #include &lt;wtf/IsoMalloc.h&gt;
 34 #include &lt;wtf/WeakPtr.h&gt;
 35 
 36 namespace WebCore {
 37 
<a name="2" id="anc2"></a><span class="line-modified"> 38 namespace Display {</span>
<span class="line-modified"> 39 class Box;</span>
<span class="line-added"> 40 }</span>
<span class="line-added"> 41 class LayoutSize;</span>
<span class="line-added"> 42 struct Length;</span>
 43 
 44 namespace Layout {
 45 
 46 class Box;
<a name="3" id="anc3"></a><span class="line-added"> 47 struct ComputedHorizontalMargin;</span>
<span class="line-added"> 48 struct ComputedVerticalMargin;</span>
 49 class Container;
<a name="4" id="anc4"></a><span class="line-added"> 50 struct ContentHeightAndMargin;</span>
<span class="line-added"> 51 struct ContentWidthAndMargin;</span>
<span class="line-added"> 52 struct Edges;</span>
 53 class FormattingState;
<a name="5" id="anc5"></a><span class="line-added"> 54 struct HorizontalGeometry;</span>
<span class="line-added"> 55 class InvalidationState;</span>
 56 class LayoutState;
<a name="6" id="anc6"></a><span class="line-added"> 57 struct OverrideHorizontalValues;</span>
<span class="line-added"> 58 struct OverrideVerticalValues;</span>
<span class="line-added"> 59 struct VerticalGeometry;</span>
 60 
 61 class FormattingContext {
 62     WTF_MAKE_ISO_ALLOCATED(FormattingContext);
 63 public:
<a name="7" id="anc7"></a><span class="line-modified"> 64     FormattingContext(const Container&amp; formattingContextRoot, FormattingState&amp;);</span>
 65     virtual ~FormattingContext();
 66 
<a name="8" id="anc8"></a><span class="line-modified"> 67     virtual void layoutInFlowContent(InvalidationState&amp;, const HorizontalConstraints&amp;, const VerticalConstraints&amp;) = 0;</span>
<span class="line-modified"> 68     void layoutOutOfFlowContent(InvalidationState&amp;, const HorizontalConstraints&amp;, const VerticalConstraints&amp;);</span>
 69 
 70     struct IntrinsicWidthConstraints {
 71         void expand(LayoutUnit horizontalValue);
 72         IntrinsicWidthConstraints&amp; operator+=(const IntrinsicWidthConstraints&amp;);
 73 
 74         LayoutUnit minimum;
 75         LayoutUnit maximum;
 76     };
<a name="9" id="anc9"></a><span class="line-modified"> 77     virtual IntrinsicWidthConstraints computedIntrinsicWidthConstraints() = 0;</span>
<span class="line-modified"> 78 </span>
<span class="line-modified"> 79     LayoutUnit mapTopToFormattingContextRoot(const Box&amp;) const;</span>
<span class="line-modified"> 80     LayoutUnit mapLeftToFormattingContextRoot(const Box&amp;) const;</span>
<span class="line-modified"> 81     LayoutUnit mapRightToFormattingContextRoot(const Box&amp;) const;</span>
<span class="line-modified"> 82 </span>
<span class="line-modified"> 83     bool isBlockFormattingContext() const { return root().establishesBlockFormattingContext(); }</span>
<span class="line-modified"> 84     bool isInlineFormattingContext() const { return root().establishesInlineFormattingContext(); }</span>
<span class="line-added"> 85     bool isTableFormattingContext() const { return root().establishesTableFormattingContext(); }</span>
<span class="line-added"> 86 </span>
<span class="line-added"> 87     enum class EscapeReason {</span>
<span class="line-added"> 88         NeedsGeometryFromEstablishedFormattingContext,</span>
<span class="line-added"> 89         OutOfFlowBoxNeedsInFlowGeometry,</span>
<span class="line-added"> 90         FloatBoxNeedsToBeInAbsoluteCoordinates,</span>
<span class="line-added"> 91         FindFixedHeightAncestorQuirk,</span>
<span class="line-added"> 92         BodyStrechesToViewportQuirk,</span>
<span class="line-added"> 93         StrokeOverflowNeedsViewportGeometry,</span>
<span class="line-added"> 94         TableNeedsAccessToTableWrapper</span>
<span class="line-added"> 95     };</span>
<span class="line-added"> 96     const Display::Box&amp; geometryForBox(const Box&amp;, Optional&lt;EscapeReason&gt; = WTF::nullopt) const;</span>
 97 
 98 protected:
 99     using LayoutQueue = Vector&lt;const Box*&gt;;
100 
<a name="10" id="anc10"></a><span class="line-added">101     const Container&amp; root() const { return *m_root; }</span>
102     LayoutState&amp; layoutState() const;
<a name="11" id="anc11"></a><span class="line-modified">103     const FormattingState&amp; formattingState() const { return m_formattingState; }</span>
<span class="line-modified">104     FormattingState&amp; formattingState() { return m_formattingState; }</span>
105 
<a name="12" id="anc12"></a><span class="line-modified">106     void computeBorderAndPadding(const Box&amp;, const HorizontalConstraints&amp;);</span>
107 
108 #ifndef NDEBUG
109     virtual void validateGeometryConstraintsAfterLayout() const;
110 #endif
111 
112     // This class implements generic positioning and sizing.
113     class Geometry {
114     public:
<a name="13" id="anc13"></a><span class="line-modified">115         VerticalGeometry outOfFlowVerticalGeometry(const Box&amp;, const HorizontalConstraints&amp;, const VerticalConstraints&amp;, const OverrideVerticalValues&amp;) const;</span>
<span class="line-modified">116         HorizontalGeometry outOfFlowHorizontalGeometry(const Box&amp;, const HorizontalConstraints&amp;, const OverrideHorizontalValues&amp;);</span>
<span class="line-added">117 </span>
<span class="line-added">118         ContentHeightAndMargin floatingHeightAndMargin(const Box&amp;, const HorizontalConstraints&amp;, const OverrideVerticalValues&amp;) const;</span>
<span class="line-added">119         ContentWidthAndMargin floatingWidthAndMargin(const Box&amp;, const HorizontalConstraints&amp;, const OverrideHorizontalValues&amp;);</span>
<span class="line-added">120 </span>
<span class="line-added">121         ContentHeightAndMargin inlineReplacedHeightAndMargin(const Box&amp;, const HorizontalConstraints&amp;, Optional&lt;VerticalConstraints&gt;, const OverrideVerticalValues&amp;) const;</span>
<span class="line-added">122         ContentWidthAndMargin inlineReplacedWidthAndMargin(const Box&amp;, const HorizontalConstraints&amp;, const OverrideHorizontalValues&amp;) const;</span>
123 
<a name="14" id="anc14"></a><span class="line-modified">124         LayoutSize inFlowPositionedPositionOffset(const Box&amp;, const HorizontalConstraints&amp;) const;</span>

125 
<a name="15" id="anc15"></a><span class="line-modified">126         ContentHeightAndMargin complicatedCases(const Box&amp;, const HorizontalConstraints&amp;, const OverrideVerticalValues&amp;) const;</span>
<span class="line-modified">127         LayoutUnit shrinkToFitWidth(const Box&amp;, LayoutUnit availableWidth);</span>
128 
<a name="16" id="anc16"></a><span class="line-modified">129         Edges computedBorder(const Box&amp;) const;</span>
<span class="line-added">130         Optional&lt;Edges&gt; computedPadding(const Box&amp;, const HorizontalConstraints&amp;) const;</span>
131 
<a name="17" id="anc17"></a><span class="line-modified">132         ComputedHorizontalMargin computedHorizontalMargin(const Box&amp;, const HorizontalConstraints&amp;) const;</span>
<span class="line-modified">133         ComputedVerticalMargin computedVerticalMargin(const Box&amp;, const HorizontalConstraints&amp;) const;</span>
134 
<a name="18" id="anc18"></a><span class="line-modified">135         Optional&lt;LayoutUnit&gt; computedValueIfNotAuto(const Length&amp; geometryProperty, LayoutUnit containingBlockWidth) const;</span>
<span class="line-modified">136         Optional&lt;LayoutUnit&gt; fixedValue(const Length&amp; geometryProperty) const;</span>
137 
<a name="19" id="anc19"></a><span class="line-modified">138         Optional&lt;LayoutUnit&gt; computedMinHeight(const Box&amp;, Optional&lt;LayoutUnit&gt; containingBlockHeight = WTF::nullopt) const;</span>
<span class="line-modified">139         Optional&lt;LayoutUnit&gt; computedMaxHeight(const Box&amp;, Optional&lt;LayoutUnit&gt; containingBlockHeight = WTF::nullopt) const;</span>
140 
<a name="20" id="anc20"></a><span class="line-modified">141         Optional&lt;LayoutUnit&gt; computedMinWidth(const Box&amp;, LayoutUnit containingBlockWidth) const;</span>
<span class="line-modified">142         Optional&lt;LayoutUnit&gt; computedMaxWidth(const Box&amp;, LayoutUnit containingBlockWidth) const;</span>
143 
<a name="21" id="anc21"></a><span class="line-modified">144         FormattingContext::IntrinsicWidthConstraints constrainByMinMaxWidth(const Box&amp;, IntrinsicWidthConstraints) const;</span>

145 
<a name="22" id="anc22"></a><span class="line-modified">146         LayoutUnit contentHeightForFormattingContextRoot(const Box&amp;) const;</span>
147 
<a name="23" id="anc23"></a><span class="line-modified">148         static HorizontalConstraints horizontalConstraintsForOutOfFlow(const Display::Box&amp; containingBlockGeometry);</span>
<span class="line-added">149         static VerticalConstraints verticalConstraintsForOutOfFlow(const Display::Box&amp; containingBlockGeometry);</span>
<span class="line-added">150         static HorizontalConstraints horizontalConstraintsForInFlow(const Display::Box&amp; containingBlockGeometry);</span>
<span class="line-added">151         static VerticalConstraints verticalConstraintsForInFlow(const Display::Box&amp; containingBlockGeometry);</span>
152 
153     protected:
<a name="24" id="anc24"></a><span class="line-added">154         friend class FormattingContext;</span>
<span class="line-added">155         Geometry(const FormattingContext&amp;);</span>
<span class="line-added">156 </span>
157         enum class HeightType { Min, Max, Normal };
<a name="25" id="anc25"></a><span class="line-modified">158         Optional&lt;LayoutUnit&gt; computedHeightValue(const Box&amp;, HeightType, Optional&lt;LayoutUnit&gt; containingBlockHeight) const;</span>
<span class="line-added">159         Optional&lt;LayoutUnit&gt; computedContentHeight(const Box&amp;, Optional&lt;LayoutUnit&gt; containingBlockHeight = WTF::nullopt) const;</span>
<span class="line-added">160         Optional&lt;LayoutUnit&gt; computedContentWidth(const Box&amp;, LayoutUnit containingBlockWidth) const;</span>
<span class="line-added">161 </span>
<span class="line-added">162         const LayoutState&amp; layoutState() const { return m_formattingContext.layoutState(); }</span>
<span class="line-added">163         LayoutState&amp; layoutState() { return m_formattingContext.layoutState(); }</span>
<span class="line-added">164         const FormattingContext&amp; formattingContext() const { return m_formattingContext; }</span>
165 
166     private:
<a name="26" id="anc26"></a><span class="line-modified">167         VerticalGeometry outOfFlowReplacedVerticalGeometry(const Box&amp;, const HorizontalConstraints&amp;, const VerticalConstraints&amp;, const OverrideVerticalValues&amp;) const;</span>
<span class="line-modified">168         HorizontalGeometry outOfFlowReplacedHorizontalGeometry(const Box&amp;, const HorizontalConstraints&amp;, const OverrideHorizontalValues&amp;) const;</span>
<span class="line-added">169 </span>
<span class="line-added">170         VerticalGeometry outOfFlowNonReplacedVerticalGeometry(const Box&amp;, const HorizontalConstraints&amp;, const VerticalConstraints&amp;, const OverrideVerticalValues&amp;) const;</span>
<span class="line-added">171         HorizontalGeometry outOfFlowNonReplacedHorizontalGeometry(const Box&amp;, const HorizontalConstraints&amp;, const OverrideHorizontalValues&amp;);</span>
172 
<a name="27" id="anc27"></a><span class="line-modified">173         ContentHeightAndMargin floatingReplacedHeightAndMargin(const Box&amp;, const HorizontalConstraints&amp;, const OverrideVerticalValues&amp;) const;</span>
<span class="line-modified">174         ContentWidthAndMargin floatingReplacedWidthAndMargin(const Box&amp;, const HorizontalConstraints&amp;, const OverrideHorizontalValues&amp;) const;</span>
175 
<a name="28" id="anc28"></a><span class="line-modified">176         ContentWidthAndMargin floatingNonReplacedWidthAndMargin(const Box&amp;, const HorizontalConstraints&amp;, const OverrideHorizontalValues&amp;);</span>

177 
<a name="29" id="anc29"></a><span class="line-modified">178         LayoutUnit staticVerticalPositionForOutOfFlowPositioned(const Box&amp;, const VerticalConstraints&amp;) const;</span>
<span class="line-added">179         LayoutUnit staticHorizontalPositionForOutOfFlowPositioned(const Box&amp;, const HorizontalConstraints&amp;) const;</span>
<span class="line-added">180 </span>
<span class="line-added">181         const FormattingContext&amp; m_formattingContext;</span>
182     };
<a name="30" id="anc30"></a><span class="line-added">183     FormattingContext::Geometry geometry() const { return Geometry(*this); }</span>
184 
185     class Quirks {
186     public:
<a name="31" id="anc31"></a><span class="line-modified">187         LayoutUnit heightValueOfNearestContainingBlockWithFixedHeight(const Box&amp;);</span>
<span class="line-added">188 </span>
<span class="line-added">189     protected:</span>
<span class="line-added">190         friend class FormattingContext;</span>
<span class="line-added">191         Quirks(const FormattingContext&amp;);</span>
<span class="line-added">192 </span>
<span class="line-added">193         const LayoutState&amp; layoutState() const { return m_formattingContext.layoutState(); }</span>
<span class="line-added">194         LayoutState&amp; layoutState() { return m_formattingContext.layoutState(); }</span>
<span class="line-added">195         const FormattingContext&amp; formattingContext() const { return m_formattingContext; }</span>
<span class="line-added">196 </span>
<span class="line-added">197         const FormattingContext&amp; m_formattingContext;</span>
198     };
<a name="32" id="anc32"></a><span class="line-added">199     FormattingContext::Quirks quirks() const { return Quirks(*this); }</span>
200 
201 private:
<a name="33" id="anc33"></a><span class="line-modified">202     void collectOutOfFlowDescendantsIfNeeded();</span>
<span class="line-modified">203     void computeOutOfFlowVerticalGeometry(const Box&amp;, const HorizontalConstraints&amp;, const VerticalConstraints&amp;);</span>
<span class="line-added">204     void computeOutOfFlowHorizontalGeometry(const Box&amp;, const HorizontalConstraints&amp;);</span>
205 
<a name="34" id="anc34"></a><span class="line-modified">206     WeakPtr&lt;const Container&gt; m_root;</span>
207     FormattingState&amp; m_formattingState;
208 };
209 
<a name="35" id="anc35"></a><span class="line-added">210 inline FormattingContext::Geometry::Geometry(const FormattingContext&amp; formattingContext)</span>
<span class="line-added">211     : m_formattingContext(formattingContext)</span>
<span class="line-added">212 {</span>
<span class="line-added">213 }</span>
<span class="line-added">214 </span>
<span class="line-added">215 inline FormattingContext::Quirks::Quirks(const FormattingContext&amp; formattingContext)</span>
<span class="line-added">216     : m_formattingContext(formattingContext)</span>
<span class="line-added">217 {</span>
<span class="line-added">218 }</span>
<span class="line-added">219 </span>
220 inline void FormattingContext::IntrinsicWidthConstraints::expand(LayoutUnit horizontalValue)
221 {
222     minimum += horizontalValue;
223     maximum += horizontalValue;
224 }
225 
226 inline FormattingContext::IntrinsicWidthConstraints&amp; FormattingContext::IntrinsicWidthConstraints::operator+=(const IntrinsicWidthConstraints&amp; other)
227 {
228     minimum += other.minimum;
229     maximum += other.maximum;
230     return *this;
231 }
232 
233 }
234 }
<a name="36" id="anc36"></a><span class="line-added">235 </span>
<span class="line-added">236 #define SPECIALIZE_TYPE_TRAITS_LAYOUT_FORMATTING_CONTEXT(ToValueTypeName, predicate) \</span>
<span class="line-added">237 SPECIALIZE_TYPE_TRAITS_BEGIN(WebCore::Layout::ToValueTypeName) \</span>
<span class="line-added">238     static bool isType(const WebCore::Layout::FormattingContext&amp; formattingContext) { return formattingContext.predicate; } \</span>
<span class="line-added">239 SPECIALIZE_TYPE_TRAITS_END()</span>
<span class="line-added">240 </span>
241 #endif
<a name="37" id="anc37"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="37" type="hidden" />
</body>
</html>