<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WebCore/Modules/indexeddb/server/UniqueIDBDatabaseTransaction.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="UniqueIDBDatabaseConnection.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="UniqueIDBDatabaseTransaction.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/Modules/indexeddb/server/UniqueIDBDatabaseTransaction.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 11  *    documentation and/or other materials provided with the distribution.
 12  *
 13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. AND ITS CONTRIBUTORS ``AS IS&#39;&#39;
 14  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
 15  * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 16  * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL APPLE INC. OR ITS CONTRIBUTORS
 17  * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 18  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 19  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 20  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 21  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 22  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF
 23  * THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #include &quot;config.h&quot;
 27 #include &quot;UniqueIDBDatabaseTransaction.h&quot;
 28 
 29 #if ENABLE(INDEXED_DATABASE)
 30 
<span class="line-removed"> 31 #include &quot;IDBError.h&quot;</span>
 32 #include &quot;IDBIterateCursorData.h&quot;
 33 #include &quot;IDBResultData.h&quot;
 34 #include &quot;IDBServer.h&quot;
 35 #include &quot;Logging.h&quot;
 36 #include &quot;UniqueIDBDatabase.h&quot;
 37 
 38 namespace WebCore {
 39 namespace IDBServer {
 40 
 41 Ref&lt;UniqueIDBDatabaseTransaction&gt; UniqueIDBDatabaseTransaction::create(UniqueIDBDatabaseConnection&amp; connection, const IDBTransactionInfo&amp; info)
 42 {
 43     return adoptRef(*new UniqueIDBDatabaseTransaction(connection, info));
 44 }
 45 
 46 UniqueIDBDatabaseTransaction::UniqueIDBDatabaseTransaction(UniqueIDBDatabaseConnection&amp; connection, const IDBTransactionInfo&amp; info)
<span class="line-modified"> 47     : m_databaseConnection(connection)</span>
 48     , m_transactionInfo(info)
 49 {
 50     auto database = m_databaseConnection-&gt;database();
 51     ASSERT(database);
 52 
 53     if (m_transactionInfo.mode() == IDBTransactionMode::Versionchange)
 54         m_originalDatabaseInfo = makeUnique&lt;IDBDatabaseInfo&gt;(database-&gt;info());
 55 
<span class="line-modified"> 56     if (auto* server = m_databaseConnection-&gt;server())</span>
<span class="line-removed"> 57         server-&gt;registerTransaction(*this);</span>
 58 }
 59 
 60 UniqueIDBDatabaseTransaction::~UniqueIDBDatabaseTransaction()
 61 {
<span class="line-modified"> 62     if (auto database = m_databaseConnection-&gt;database())</span>
<span class="line-removed"> 63         database-&gt;transactionDestroyed(*this);</span>
<span class="line-removed"> 64 </span>
<span class="line-removed"> 65     if (auto* server = m_databaseConnection-&gt;server())</span>
<span class="line-removed"> 66         server-&gt;unregisterTransaction(*this);</span>
 67 }
 68 
 69 IDBDatabaseInfo* UniqueIDBDatabaseTransaction::originalDatabaseInfo() const
 70 {
 71     ASSERT(m_transactionInfo.mode() == IDBTransactionMode::Versionchange);
 72     return m_originalDatabaseInfo.get();
 73 }
 74 
 75 void UniqueIDBDatabaseTransaction::abort()
 76 {
 77     LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::abort&quot;);
 78 
<span class="line-removed"> 79     RefPtr&lt;UniqueIDBDatabaseTransaction&gt; protectedThis(this);</span>
<span class="line-removed"> 80 </span>
 81     auto database = m_databaseConnection-&gt;database();
 82     ASSERT(database);
 83 
<span class="line-modified"> 84     database-&gt;abortTransaction(*this, UniqueIDBDatabase::WaitForPendingTasks::Yes, [this, protectedThis](const IDBError&amp; error) {</span>
 85         LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::abort (callback)&quot;);

 86         m_databaseConnection-&gt;didAbortTransaction(*this, error);
 87     });
 88 }
 89 
 90 void UniqueIDBDatabaseTransaction::abortWithoutCallback()
 91 {
 92     LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::abortWithoutCallback&quot;);
 93 
 94     m_databaseConnection-&gt;abortTransactionWithoutCallback(*this);
 95 }
 96 
 97 bool UniqueIDBDatabaseTransaction::isVersionChange() const
 98 {
 99     return m_transactionInfo.mode() == IDBTransactionMode::Versionchange;
100 }
101 
102 bool UniqueIDBDatabaseTransaction::isReadOnly() const
103 {
104     return m_transactionInfo.mode() == IDBTransactionMode::Readonly;
105 }
106 
107 void UniqueIDBDatabaseTransaction::commit()
108 {
109     LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::commit&quot;);
110 
<span class="line-removed">111     RefPtr&lt;UniqueIDBDatabaseTransaction&gt; protectedThis(this);</span>
<span class="line-removed">112 </span>
113     auto database = m_databaseConnection-&gt;database();
<span class="line-removed">114     if (!database || database-&gt;hardClosedForUserDelete())</span>
<span class="line-removed">115         return;</span>
116 
<span class="line-modified">117     database-&gt;commitTransaction(*this, [this, protectedThis](const IDBError&amp; error) {</span>
118         LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::commit (callback)&quot;);

119         m_databaseConnection-&gt;didCommitTransaction(*this, error);
120     });
121 }
122 
123 void UniqueIDBDatabaseTransaction::createObjectStore(const IDBRequestData&amp; requestData, const IDBObjectStoreInfo&amp; info)
124 {
125     LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::createObjectStore&quot;);
126 
127     ASSERT(isVersionChange());
128     ASSERT(m_transactionInfo.identifier() == requestData.transactionIdentifier());
129 
<span class="line-removed">130     RefPtr&lt;UniqueIDBDatabaseTransaction&gt; protectedThis(this);</span>
<span class="line-removed">131 </span>
132     auto database = m_databaseConnection-&gt;database();
133     ASSERT(database);
134 
<span class="line-modified">135     database-&gt;createObjectStore(*this, info, [this, protectedThis, requestData](const IDBError&amp; error) {</span>
136         LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::createObjectStore (callback)&quot;);

137         if (error.isNull())
138             m_databaseConnection-&gt;didCreateObjectStore(IDBResultData::createObjectStoreSuccess(requestData.requestIdentifier()));
139         else
140             m_databaseConnection-&gt;didCreateObjectStore(IDBResultData::error(requestData.requestIdentifier(), error));
141     });
142 }
143 
144 void UniqueIDBDatabaseTransaction::deleteObjectStore(const IDBRequestData&amp; requestData, const String&amp; objectStoreName)
145 {
146     LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::deleteObjectStore&quot;);
147 
148     ASSERT(isVersionChange());
149     ASSERT(m_transactionInfo.identifier() == requestData.transactionIdentifier());
150 
<span class="line-removed">151     RefPtr&lt;UniqueIDBDatabaseTransaction&gt; protectedThis(this);</span>
<span class="line-removed">152 </span>
153     auto database = m_databaseConnection-&gt;database();
154     ASSERT(database);
155 
<span class="line-modified">156     database-&gt;deleteObjectStore(*this, objectStoreName, [this, protectedThis, requestData](const IDBError&amp; error) {</span>
157         LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::deleteObjectStore (callback)&quot;);

158         if (error.isNull())
159             m_databaseConnection-&gt;didDeleteObjectStore(IDBResultData::deleteObjectStoreSuccess(requestData.requestIdentifier()));
160         else
161             m_databaseConnection-&gt;didDeleteObjectStore(IDBResultData::error(requestData.requestIdentifier(), error));
162     });
163 }
164 
165 void UniqueIDBDatabaseTransaction::renameObjectStore(const IDBRequestData&amp; requestData, uint64_t objectStoreIdentifier, const String&amp; newName)
166 {
167     LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::renameObjectStore&quot;);
168 
169     ASSERT(isVersionChange());
170     ASSERT(m_transactionInfo.identifier() == requestData.transactionIdentifier());
171 
<span class="line-removed">172     RefPtr&lt;UniqueIDBDatabaseTransaction&gt; protectedThis(this);</span>
<span class="line-removed">173 </span>
174     auto database = m_databaseConnection-&gt;database();
175     ASSERT(database);
176 
<span class="line-modified">177     database-&gt;renameObjectStore(*this, objectStoreIdentifier, newName, [this, protectedThis, requestData](const IDBError&amp; error) {</span>
178         LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::renameObjectStore (callback)&quot;);

179         if (error.isNull())
180             m_databaseConnection-&gt;didRenameObjectStore(IDBResultData::renameObjectStoreSuccess(requestData.requestIdentifier()));
181         else
182             m_databaseConnection-&gt;didRenameObjectStore(IDBResultData::error(requestData.requestIdentifier(), error));
183     });
184 }
185 
186 void UniqueIDBDatabaseTransaction::clearObjectStore(const IDBRequestData&amp; requestData, uint64_t objectStoreIdentifier)
187 {
188     LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::clearObjectStore&quot;);
189 
190     ASSERT(m_transactionInfo.identifier() == requestData.transactionIdentifier());
191 
<span class="line-removed">192     RefPtr&lt;UniqueIDBDatabaseTransaction&gt; protectedThis(this);</span>
<span class="line-removed">193 </span>
194     auto database = m_databaseConnection-&gt;database();
195     ASSERT(database);
196 
<span class="line-modified">197     database-&gt;clearObjectStore(*this, objectStoreIdentifier, [this, protectedThis, requestData](const IDBError&amp; error) {</span>
198         LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::clearObjectStore (callback)&quot;);

199         if (error.isNull())
200             m_databaseConnection-&gt;didClearObjectStore(IDBResultData::clearObjectStoreSuccess(requestData.requestIdentifier()));
201         else
202             m_databaseConnection-&gt;didClearObjectStore(IDBResultData::error(requestData.requestIdentifier(), error));
203     });
204 }
205 
206 void UniqueIDBDatabaseTransaction::createIndex(const IDBRequestData&amp; requestData, const IDBIndexInfo&amp; info)
207 {
208     LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::createIndex&quot;);
209 
210     ASSERT(isVersionChange());
211     ASSERT(m_transactionInfo.identifier() == requestData.transactionIdentifier());
212 
<span class="line-removed">213     RefPtr&lt;UniqueIDBDatabaseTransaction&gt; protectedThis(this);</span>
<span class="line-removed">214 </span>
215     auto database = m_databaseConnection-&gt;database();
216     ASSERT(database);
217 
<span class="line-modified">218     database-&gt;createIndex(*this, info, [this, protectedThis, requestData](const IDBError&amp; error) {</span>
219         LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::createIndex (callback)&quot;);

220         if (error.isNull())
221             m_databaseConnection-&gt;didCreateIndex(IDBResultData::createIndexSuccess(requestData.requestIdentifier()));
222         else
223             m_databaseConnection-&gt;didCreateIndex(IDBResultData::error(requestData.requestIdentifier(), error));
224     });
225 }
226 
227 void UniqueIDBDatabaseTransaction::deleteIndex(const IDBRequestData&amp; requestData, uint64_t objectStoreIdentifier, const String&amp; indexName)
228 {
229     LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::deleteIndex&quot;);
230 
231     ASSERT(isVersionChange());
232     ASSERT(m_transactionInfo.identifier() == requestData.transactionIdentifier());
233 
<span class="line-removed">234     RefPtr&lt;UniqueIDBDatabaseTransaction&gt; protectedThis(this);</span>
<span class="line-removed">235 </span>
236     auto database = m_databaseConnection-&gt;database();
237     ASSERT(database);
238 
<span class="line-modified">239     database-&gt;deleteIndex(*this, objectStoreIdentifier, indexName, [this, protectedThis, requestData](const IDBError&amp; error) {</span>
240         LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::createIndex (callback)&quot;);

241         if (error.isNull())
242             m_databaseConnection-&gt;didDeleteIndex(IDBResultData::deleteIndexSuccess(requestData.requestIdentifier()));
243         else
244             m_databaseConnection-&gt;didDeleteIndex(IDBResultData::error(requestData.requestIdentifier(), error));
245     });
246 }
247 
248 void UniqueIDBDatabaseTransaction::renameIndex(const IDBRequestData&amp; requestData, uint64_t objectStoreIdentifier, uint64_t indexIdentifier, const String&amp; newName)
249 {
250     LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::renameIndex&quot;);
251 
252     ASSERT(isVersionChange());
253     ASSERT(m_transactionInfo.identifier() == requestData.transactionIdentifier());
254 
<span class="line-removed">255     RefPtr&lt;UniqueIDBDatabaseTransaction&gt; protectedThis(this);</span>
<span class="line-removed">256 </span>
257     auto database = m_databaseConnection-&gt;database();
258     ASSERT(database);
259 
<span class="line-modified">260     database-&gt;renameIndex(*this, objectStoreIdentifier, indexIdentifier, newName, [this, protectedThis, requestData](const IDBError&amp; error) {</span>
261         LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::renameIndex (callback)&quot;);

262         if (error.isNull())
263             m_databaseConnection-&gt;didRenameIndex(IDBResultData::renameIndexSuccess(requestData.requestIdentifier()));
264         else
265             m_databaseConnection-&gt;didRenameIndex(IDBResultData::error(requestData.requestIdentifier(), error));
266     });
267 }
268 
269 
270 void UniqueIDBDatabaseTransaction::putOrAdd(const IDBRequestData&amp; requestData, const IDBKeyData&amp; keyData, const IDBValue&amp; value, IndexedDB::ObjectStoreOverwriteMode overwriteMode)
271 {
272     LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::putOrAdd&quot;);
273 
274     ASSERT(!isReadOnly());
275     ASSERT(m_transactionInfo.identifier() == requestData.transactionIdentifier());
276 
<span class="line-removed">277     RefPtr&lt;UniqueIDBDatabaseTransaction&gt; protectedThis(this);</span>
<span class="line-removed">278 </span>
279     auto database = m_databaseConnection-&gt;database();
280     ASSERT(database);
281 
<span class="line-modified">282     database-&gt;putOrAdd(requestData, keyData, value, overwriteMode, [this, protectedThis, requestData](const IDBError&amp; error, const IDBKeyData&amp; key) {</span>
283         LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::putOrAdd (callback)&quot;);
284 
285         if (error.isNull())
286             m_databaseConnection-&gt;connectionToClient().didPutOrAdd(IDBResultData::putOrAddSuccess(requestData.requestIdentifier(), key));
287         else
288             m_databaseConnection-&gt;connectionToClient().didPutOrAdd(IDBResultData::error(requestData.requestIdentifier(), error));
289     });
290 }
291 
292 void UniqueIDBDatabaseTransaction::getRecord(const IDBRequestData&amp; requestData, const IDBGetRecordData&amp; getRecordData)
293 {
294     LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::getRecord&quot;);
295 
296     ASSERT(m_transactionInfo.identifier() == requestData.transactionIdentifier());
297 
<span class="line-removed">298     RefPtr&lt;UniqueIDBDatabaseTransaction&gt; protectedThis(this);</span>
<span class="line-removed">299 </span>
300     auto database = m_databaseConnection-&gt;database();
301     ASSERT(database);
302 
<span class="line-modified">303     database-&gt;getRecord(requestData, getRecordData, [this, protectedThis, requestData](const IDBError&amp; error, const IDBGetResult&amp; result) {</span>
304         LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::getRecord (callback)&quot;);
305 
306         if (error.isNull())
307             m_databaseConnection-&gt;connectionToClient().didGetRecord(IDBResultData::getRecordSuccess(requestData.requestIdentifier(), result));
308         else
309             m_databaseConnection-&gt;connectionToClient().didGetRecord(IDBResultData::error(requestData.requestIdentifier(), error));
310     });
311 }
312 
313 void UniqueIDBDatabaseTransaction::getAllRecords(const IDBRequestData&amp; requestData, const IDBGetAllRecordsData&amp; getAllRecordsData)
314 {
315     LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::getAllRecords&quot;);
316 
317     ASSERT(m_transactionInfo.identifier() == requestData.transactionIdentifier());
318 
<span class="line-removed">319     RefPtr&lt;UniqueIDBDatabaseTransaction&gt; protectedThis(this);</span>
<span class="line-removed">320 </span>
321     auto database = m_databaseConnection-&gt;database();
322     ASSERT(database);
323 
<span class="line-modified">324     database-&gt;getAllRecords(requestData, getAllRecordsData, [this, protectedThis, requestData](const IDBError&amp; error, const IDBGetAllResult&amp; result) {</span>
325         LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::getAllRecords (callback)&quot;);
326 
327         if (error.isNull())
328             m_databaseConnection-&gt;connectionToClient().didGetAllRecords(IDBResultData::getAllRecordsSuccess(requestData.requestIdentifier(), result));
329         else
330             m_databaseConnection-&gt;connectionToClient().didGetAllRecords(IDBResultData::error(requestData.requestIdentifier(), error));
331     });
332 }
333 
334 void UniqueIDBDatabaseTransaction::getCount(const IDBRequestData&amp; requestData, const IDBKeyRangeData&amp; keyRangeData)
335 {
336     LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::getCount&quot;);
337 
338     ASSERT(m_transactionInfo.identifier() == requestData.transactionIdentifier());
339 
<span class="line-removed">340     RefPtr&lt;UniqueIDBDatabaseTransaction&gt; protectedThis(this);</span>
<span class="line-removed">341 </span>
342     auto database = m_databaseConnection-&gt;database();
343     ASSERT(database);
344 
<span class="line-modified">345     database-&gt;getCount(requestData, keyRangeData, [this, protectedThis, requestData](const IDBError&amp; error, uint64_t count) {</span>
346         LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::getCount (callback)&quot;);
347 
348         if (error.isNull())
349             m_databaseConnection-&gt;connectionToClient().didGetCount(IDBResultData::getCountSuccess(requestData.requestIdentifier(), count));
350         else
351             m_databaseConnection-&gt;connectionToClient().didGetCount(IDBResultData::error(requestData.requestIdentifier(), error));
352     });
353 }
354 
355 void UniqueIDBDatabaseTransaction::deleteRecord(const IDBRequestData&amp; requestData, const IDBKeyRangeData&amp; keyRangeData)
356 {
357     LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::deleteRecord&quot;);
358 
359     ASSERT(m_transactionInfo.identifier() == requestData.transactionIdentifier());
360 
<span class="line-removed">361     RefPtr&lt;UniqueIDBDatabaseTransaction&gt; protectedThis(this);</span>
<span class="line-removed">362 </span>
363     auto database = m_databaseConnection-&gt;database();
364     ASSERT(database);
365 
<span class="line-modified">366     database-&gt;deleteRecord(requestData, keyRangeData, [this, protectedThis, requestData](const IDBError&amp; error) {</span>
367         LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::deleteRecord (callback)&quot;);
368 
369         if (error.isNull())
370             m_databaseConnection-&gt;connectionToClient().didDeleteRecord(IDBResultData::deleteRecordSuccess(requestData.requestIdentifier()));
371         else
372             m_databaseConnection-&gt;connectionToClient().didDeleteRecord(IDBResultData::error(requestData.requestIdentifier(), error));
373     });
374 }
375 
376 void UniqueIDBDatabaseTransaction::openCursor(const IDBRequestData&amp; requestData, const IDBCursorInfo&amp; info)
377 {
378     LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::openCursor&quot;);
379 
380     ASSERT(m_transactionInfo.identifier() == requestData.transactionIdentifier());
381 
<span class="line-removed">382     RefPtr&lt;UniqueIDBDatabaseTransaction&gt; protectedThis(this);</span>
<span class="line-removed">383 </span>
384     auto database = m_databaseConnection-&gt;database();
385     ASSERT(database);
386 
<span class="line-modified">387     database-&gt;openCursor(requestData, info, [this, protectedThis, requestData](const IDBError&amp; error, const IDBGetResult&amp; result) {</span>
388         LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::openCursor (callback)&quot;);
389 
390         if (error.isNull())
391             m_databaseConnection-&gt;connectionToClient().didOpenCursor(IDBResultData::openCursorSuccess(requestData.requestIdentifier(), result));
392         else
393             m_databaseConnection-&gt;connectionToClient().didOpenCursor(IDBResultData::error(requestData.requestIdentifier(), error));
394     });
395 }
396 
397 void UniqueIDBDatabaseTransaction::iterateCursor(const IDBRequestData&amp; requestData, const IDBIterateCursorData&amp; data)
398 {
399     LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::iterateCursor&quot;);
400 
401     ASSERT(m_transactionInfo.identifier() == requestData.transactionIdentifier());
402 
<span class="line-removed">403     RefPtr&lt;UniqueIDBDatabaseTransaction&gt; protectedThis(this);</span>
<span class="line-removed">404 </span>
405     auto database = m_databaseConnection-&gt;database();
406     ASSERT(database);
407 
<span class="line-modified">408     database-&gt;iterateCursor(requestData, data, [this, protectedThis, requestData](const IDBError&amp; error, const IDBGetResult&amp; result) {</span>
409         LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::iterateCursor (callback)&quot;);
410 



411         if (error.isNull())
412             m_databaseConnection-&gt;connectionToClient().didIterateCursor(IDBResultData::iterateCursorSuccess(requestData.requestIdentifier(), result));
413         else
414             m_databaseConnection-&gt;connectionToClient().didIterateCursor(IDBResultData::error(requestData.requestIdentifier(), error));
415     });
416 }
417 
418 const Vector&lt;uint64_t&gt;&amp; UniqueIDBDatabaseTransaction::objectStoreIdentifiers()
419 {
420     if (!m_objectStoreIdentifiers.isEmpty())
421         return m_objectStoreIdentifiers;
422 
423     auto&amp; info = m_databaseConnection-&gt;database()-&gt;info();
424     for (const auto&amp; objectStoreName : info.objectStoreNames()) {
425         auto objectStoreInfo = info.infoForExistingObjectStore(objectStoreName);
426         ASSERT(objectStoreInfo);
427         if (!objectStoreInfo)
428             continue;
429 
430         if (m_transactionInfo.objectStores().contains(objectStoreName))
</pre>
</td>
<td>
<hr />
<pre>
 11  *    documentation and/or other materials provided with the distribution.
 12  *
 13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. AND ITS CONTRIBUTORS ``AS IS&#39;&#39;
 14  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
 15  * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 16  * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL APPLE INC. OR ITS CONTRIBUTORS
 17  * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 18  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 19  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 20  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 21  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 22  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF
 23  * THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #include &quot;config.h&quot;
 27 #include &quot;UniqueIDBDatabaseTransaction.h&quot;
 28 
 29 #if ENABLE(INDEXED_DATABASE)
 30 

 31 #include &quot;IDBIterateCursorData.h&quot;
 32 #include &quot;IDBResultData.h&quot;
 33 #include &quot;IDBServer.h&quot;
 34 #include &quot;Logging.h&quot;
 35 #include &quot;UniqueIDBDatabase.h&quot;
 36 
 37 namespace WebCore {
 38 namespace IDBServer {
 39 
 40 Ref&lt;UniqueIDBDatabaseTransaction&gt; UniqueIDBDatabaseTransaction::create(UniqueIDBDatabaseConnection&amp; connection, const IDBTransactionInfo&amp; info)
 41 {
 42     return adoptRef(*new UniqueIDBDatabaseTransaction(connection, info));
 43 }
 44 
 45 UniqueIDBDatabaseTransaction::UniqueIDBDatabaseTransaction(UniqueIDBDatabaseConnection&amp; connection, const IDBTransactionInfo&amp; info)
<span class="line-modified"> 46     : m_databaseConnection(&amp;connection)</span>
 47     , m_transactionInfo(info)
 48 {
 49     auto database = m_databaseConnection-&gt;database();
 50     ASSERT(database);
 51 
 52     if (m_transactionInfo.mode() == IDBTransactionMode::Versionchange)
 53         m_originalDatabaseInfo = makeUnique&lt;IDBDatabaseInfo&gt;(database-&gt;info());
 54 
<span class="line-modified"> 55     m_databaseConnection-&gt;server()-&gt;registerTransaction(*this);</span>

 56 }
 57 
 58 UniqueIDBDatabaseTransaction::~UniqueIDBDatabaseTransaction()
 59 {
<span class="line-modified"> 60     m_databaseConnection-&gt;server()-&gt;unregisterTransaction(*this);</span>




 61 }
 62 
 63 IDBDatabaseInfo* UniqueIDBDatabaseTransaction::originalDatabaseInfo() const
 64 {
 65     ASSERT(m_transactionInfo.mode() == IDBTransactionMode::Versionchange);
 66     return m_originalDatabaseInfo.get();
 67 }
 68 
 69 void UniqueIDBDatabaseTransaction::abort()
 70 {
 71     LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::abort&quot;);
 72 


 73     auto database = m_databaseConnection-&gt;database();
 74     ASSERT(database);
 75 
<span class="line-modified"> 76     database-&gt;abortTransaction(*this, [this](auto&amp; error) {</span>
 77         LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::abort (callback)&quot;);
<span class="line-added"> 78 </span>
 79         m_databaseConnection-&gt;didAbortTransaction(*this, error);
 80     });
 81 }
 82 
 83 void UniqueIDBDatabaseTransaction::abortWithoutCallback()
 84 {
 85     LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::abortWithoutCallback&quot;);
 86 
 87     m_databaseConnection-&gt;abortTransactionWithoutCallback(*this);
 88 }
 89 
 90 bool UniqueIDBDatabaseTransaction::isVersionChange() const
 91 {
 92     return m_transactionInfo.mode() == IDBTransactionMode::Versionchange;
 93 }
 94 
 95 bool UniqueIDBDatabaseTransaction::isReadOnly() const
 96 {
 97     return m_transactionInfo.mode() == IDBTransactionMode::Readonly;
 98 }
 99 
100 void UniqueIDBDatabaseTransaction::commit()
101 {
102     LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::commit&quot;);
103 


104     auto database = m_databaseConnection-&gt;database();


105 
<span class="line-modified">106     database-&gt;commitTransaction(*this, [this](auto&amp; error) {</span>
107         LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::commit (callback)&quot;);
<span class="line-added">108 </span>
109         m_databaseConnection-&gt;didCommitTransaction(*this, error);
110     });
111 }
112 
113 void UniqueIDBDatabaseTransaction::createObjectStore(const IDBRequestData&amp; requestData, const IDBObjectStoreInfo&amp; info)
114 {
115     LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::createObjectStore&quot;);
116 
117     ASSERT(isVersionChange());
118     ASSERT(m_transactionInfo.identifier() == requestData.transactionIdentifier());
119 


120     auto database = m_databaseConnection-&gt;database();
121     ASSERT(database);
122 
<span class="line-modified">123     database-&gt;createObjectStore(*this, info, [this, requestData](auto&amp; error) {</span>
124         LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::createObjectStore (callback)&quot;);
<span class="line-added">125 </span>
126         if (error.isNull())
127             m_databaseConnection-&gt;didCreateObjectStore(IDBResultData::createObjectStoreSuccess(requestData.requestIdentifier()));
128         else
129             m_databaseConnection-&gt;didCreateObjectStore(IDBResultData::error(requestData.requestIdentifier(), error));
130     });
131 }
132 
133 void UniqueIDBDatabaseTransaction::deleteObjectStore(const IDBRequestData&amp; requestData, const String&amp; objectStoreName)
134 {
135     LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::deleteObjectStore&quot;);
136 
137     ASSERT(isVersionChange());
138     ASSERT(m_transactionInfo.identifier() == requestData.transactionIdentifier());
139 


140     auto database = m_databaseConnection-&gt;database();
141     ASSERT(database);
142 
<span class="line-modified">143     database-&gt;deleteObjectStore(*this, objectStoreName, [this, requestData](const IDBError&amp; error) {</span>
144         LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::deleteObjectStore (callback)&quot;);
<span class="line-added">145 </span>
146         if (error.isNull())
147             m_databaseConnection-&gt;didDeleteObjectStore(IDBResultData::deleteObjectStoreSuccess(requestData.requestIdentifier()));
148         else
149             m_databaseConnection-&gt;didDeleteObjectStore(IDBResultData::error(requestData.requestIdentifier(), error));
150     });
151 }
152 
153 void UniqueIDBDatabaseTransaction::renameObjectStore(const IDBRequestData&amp; requestData, uint64_t objectStoreIdentifier, const String&amp; newName)
154 {
155     LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::renameObjectStore&quot;);
156 
157     ASSERT(isVersionChange());
158     ASSERT(m_transactionInfo.identifier() == requestData.transactionIdentifier());
159 


160     auto database = m_databaseConnection-&gt;database();
161     ASSERT(database);
162 
<span class="line-modified">163     database-&gt;renameObjectStore(*this, objectStoreIdentifier, newName, [this, requestData](auto&amp; error) {</span>
164         LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::renameObjectStore (callback)&quot;);
<span class="line-added">165 </span>
166         if (error.isNull())
167             m_databaseConnection-&gt;didRenameObjectStore(IDBResultData::renameObjectStoreSuccess(requestData.requestIdentifier()));
168         else
169             m_databaseConnection-&gt;didRenameObjectStore(IDBResultData::error(requestData.requestIdentifier(), error));
170     });
171 }
172 
173 void UniqueIDBDatabaseTransaction::clearObjectStore(const IDBRequestData&amp; requestData, uint64_t objectStoreIdentifier)
174 {
175     LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::clearObjectStore&quot;);
176 
177     ASSERT(m_transactionInfo.identifier() == requestData.transactionIdentifier());
178 


179     auto database = m_databaseConnection-&gt;database();
180     ASSERT(database);
181 
<span class="line-modified">182     database-&gt;clearObjectStore(*this, objectStoreIdentifier, [this, requestData](auto&amp; error) {</span>
183         LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::clearObjectStore (callback)&quot;);
<span class="line-added">184 </span>
185         if (error.isNull())
186             m_databaseConnection-&gt;didClearObjectStore(IDBResultData::clearObjectStoreSuccess(requestData.requestIdentifier()));
187         else
188             m_databaseConnection-&gt;didClearObjectStore(IDBResultData::error(requestData.requestIdentifier(), error));
189     });
190 }
191 
192 void UniqueIDBDatabaseTransaction::createIndex(const IDBRequestData&amp; requestData, const IDBIndexInfo&amp; info)
193 {
194     LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::createIndex&quot;);
195 
196     ASSERT(isVersionChange());
197     ASSERT(m_transactionInfo.identifier() == requestData.transactionIdentifier());
198 


199     auto database = m_databaseConnection-&gt;database();
200     ASSERT(database);
201 
<span class="line-modified">202     database-&gt;createIndex(*this, info, [this, requestData](auto&amp; error) {</span>
203         LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::createIndex (callback)&quot;);
<span class="line-added">204 </span>
205         if (error.isNull())
206             m_databaseConnection-&gt;didCreateIndex(IDBResultData::createIndexSuccess(requestData.requestIdentifier()));
207         else
208             m_databaseConnection-&gt;didCreateIndex(IDBResultData::error(requestData.requestIdentifier(), error));
209     });
210 }
211 
212 void UniqueIDBDatabaseTransaction::deleteIndex(const IDBRequestData&amp; requestData, uint64_t objectStoreIdentifier, const String&amp; indexName)
213 {
214     LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::deleteIndex&quot;);
215 
216     ASSERT(isVersionChange());
217     ASSERT(m_transactionInfo.identifier() == requestData.transactionIdentifier());
218 


219     auto database = m_databaseConnection-&gt;database();
220     ASSERT(database);
221 
<span class="line-modified">222     database-&gt;deleteIndex(*this, objectStoreIdentifier, indexName, [this, requestData](auto&amp; error) {</span>
223         LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::createIndex (callback)&quot;);
<span class="line-added">224 </span>
225         if (error.isNull())
226             m_databaseConnection-&gt;didDeleteIndex(IDBResultData::deleteIndexSuccess(requestData.requestIdentifier()));
227         else
228             m_databaseConnection-&gt;didDeleteIndex(IDBResultData::error(requestData.requestIdentifier(), error));
229     });
230 }
231 
232 void UniqueIDBDatabaseTransaction::renameIndex(const IDBRequestData&amp; requestData, uint64_t objectStoreIdentifier, uint64_t indexIdentifier, const String&amp; newName)
233 {
234     LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::renameIndex&quot;);
235 
236     ASSERT(isVersionChange());
237     ASSERT(m_transactionInfo.identifier() == requestData.transactionIdentifier());
238 


239     auto database = m_databaseConnection-&gt;database();
240     ASSERT(database);
241 
<span class="line-modified">242     database-&gt;renameIndex(*this, objectStoreIdentifier, indexIdentifier, newName, [this, requestData](auto&amp; error) {</span>
243         LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::renameIndex (callback)&quot;);
<span class="line-added">244 </span>
245         if (error.isNull())
246             m_databaseConnection-&gt;didRenameIndex(IDBResultData::renameIndexSuccess(requestData.requestIdentifier()));
247         else
248             m_databaseConnection-&gt;didRenameIndex(IDBResultData::error(requestData.requestIdentifier(), error));
249     });
250 }
251 
252 
253 void UniqueIDBDatabaseTransaction::putOrAdd(const IDBRequestData&amp; requestData, const IDBKeyData&amp; keyData, const IDBValue&amp; value, IndexedDB::ObjectStoreOverwriteMode overwriteMode)
254 {
255     LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::putOrAdd&quot;);
256 
257     ASSERT(!isReadOnly());
258     ASSERT(m_transactionInfo.identifier() == requestData.transactionIdentifier());
259 


260     auto database = m_databaseConnection-&gt;database();
261     ASSERT(database);
262 
<span class="line-modified">263     database-&gt;putOrAdd(requestData, keyData, value, overwriteMode, [this, requestData](auto&amp; error, const IDBKeyData&amp; key) {</span>
264         LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::putOrAdd (callback)&quot;);
265 
266         if (error.isNull())
267             m_databaseConnection-&gt;connectionToClient().didPutOrAdd(IDBResultData::putOrAddSuccess(requestData.requestIdentifier(), key));
268         else
269             m_databaseConnection-&gt;connectionToClient().didPutOrAdd(IDBResultData::error(requestData.requestIdentifier(), error));
270     });
271 }
272 
273 void UniqueIDBDatabaseTransaction::getRecord(const IDBRequestData&amp; requestData, const IDBGetRecordData&amp; getRecordData)
274 {
275     LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::getRecord&quot;);
276 
277     ASSERT(m_transactionInfo.identifier() == requestData.transactionIdentifier());
278 


279     auto database = m_databaseConnection-&gt;database();
280     ASSERT(database);
281 
<span class="line-modified">282     database-&gt;getRecord(requestData, getRecordData, [this, requestData](auto&amp; error, const IDBGetResult&amp; result) {</span>
283         LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::getRecord (callback)&quot;);
284 
285         if (error.isNull())
286             m_databaseConnection-&gt;connectionToClient().didGetRecord(IDBResultData::getRecordSuccess(requestData.requestIdentifier(), result));
287         else
288             m_databaseConnection-&gt;connectionToClient().didGetRecord(IDBResultData::error(requestData.requestIdentifier(), error));
289     });
290 }
291 
292 void UniqueIDBDatabaseTransaction::getAllRecords(const IDBRequestData&amp; requestData, const IDBGetAllRecordsData&amp; getAllRecordsData)
293 {
294     LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::getAllRecords&quot;);
295 
296     ASSERT(m_transactionInfo.identifier() == requestData.transactionIdentifier());
297 


298     auto database = m_databaseConnection-&gt;database();
299     ASSERT(database);
300 
<span class="line-modified">301     database-&gt;getAllRecords(requestData, getAllRecordsData, [this, requestData](auto&amp; error, const IDBGetAllResult&amp; result) {</span>
302         LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::getAllRecords (callback)&quot;);
303 
304         if (error.isNull())
305             m_databaseConnection-&gt;connectionToClient().didGetAllRecords(IDBResultData::getAllRecordsSuccess(requestData.requestIdentifier(), result));
306         else
307             m_databaseConnection-&gt;connectionToClient().didGetAllRecords(IDBResultData::error(requestData.requestIdentifier(), error));
308     });
309 }
310 
311 void UniqueIDBDatabaseTransaction::getCount(const IDBRequestData&amp; requestData, const IDBKeyRangeData&amp; keyRangeData)
312 {
313     LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::getCount&quot;);
314 
315     ASSERT(m_transactionInfo.identifier() == requestData.transactionIdentifier());
316 


317     auto database = m_databaseConnection-&gt;database();
318     ASSERT(database);
319 
<span class="line-modified">320     database-&gt;getCount(requestData, keyRangeData, [this, requestData](auto&amp; error, uint64_t count) {</span>
321         LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::getCount (callback)&quot;);
322 
323         if (error.isNull())
324             m_databaseConnection-&gt;connectionToClient().didGetCount(IDBResultData::getCountSuccess(requestData.requestIdentifier(), count));
325         else
326             m_databaseConnection-&gt;connectionToClient().didGetCount(IDBResultData::error(requestData.requestIdentifier(), error));
327     });
328 }
329 
330 void UniqueIDBDatabaseTransaction::deleteRecord(const IDBRequestData&amp; requestData, const IDBKeyRangeData&amp; keyRangeData)
331 {
332     LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::deleteRecord&quot;);
333 
334     ASSERT(m_transactionInfo.identifier() == requestData.transactionIdentifier());
335 


336     auto database = m_databaseConnection-&gt;database();
337     ASSERT(database);
338 
<span class="line-modified">339     database-&gt;deleteRecord(requestData, keyRangeData, [this, requestData](auto&amp; error) {</span>
340         LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::deleteRecord (callback)&quot;);
341 
342         if (error.isNull())
343             m_databaseConnection-&gt;connectionToClient().didDeleteRecord(IDBResultData::deleteRecordSuccess(requestData.requestIdentifier()));
344         else
345             m_databaseConnection-&gt;connectionToClient().didDeleteRecord(IDBResultData::error(requestData.requestIdentifier(), error));
346     });
347 }
348 
349 void UniqueIDBDatabaseTransaction::openCursor(const IDBRequestData&amp; requestData, const IDBCursorInfo&amp; info)
350 {
351     LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::openCursor&quot;);
352 
353     ASSERT(m_transactionInfo.identifier() == requestData.transactionIdentifier());
354 


355     auto database = m_databaseConnection-&gt;database();
356     ASSERT(database);
357 
<span class="line-modified">358     database-&gt;openCursor(requestData, info, [this, requestData](auto&amp; error, const IDBGetResult&amp; result) {</span>
359         LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::openCursor (callback)&quot;);
360 
361         if (error.isNull())
362             m_databaseConnection-&gt;connectionToClient().didOpenCursor(IDBResultData::openCursorSuccess(requestData.requestIdentifier(), result));
363         else
364             m_databaseConnection-&gt;connectionToClient().didOpenCursor(IDBResultData::error(requestData.requestIdentifier(), error));
365     });
366 }
367 
368 void UniqueIDBDatabaseTransaction::iterateCursor(const IDBRequestData&amp; requestData, const IDBIterateCursorData&amp; data)
369 {
370     LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::iterateCursor&quot;);
371 
372     ASSERT(m_transactionInfo.identifier() == requestData.transactionIdentifier());
373 


374     auto database = m_databaseConnection-&gt;database();
375     ASSERT(database);
376 
<span class="line-modified">377     database-&gt;iterateCursor(requestData, data, [this, requestData, option = data.option](auto&amp; error, const IDBGetResult&amp; result) {</span>
378         LOG(IndexedDB, &quot;UniqueIDBDatabaseTransaction::iterateCursor (callback)&quot;);
379 
<span class="line-added">380         if (option == IndexedDB::CursorIterateOption::DoNotReply)</span>
<span class="line-added">381             return;</span>
<span class="line-added">382 </span>
383         if (error.isNull())
384             m_databaseConnection-&gt;connectionToClient().didIterateCursor(IDBResultData::iterateCursorSuccess(requestData.requestIdentifier(), result));
385         else
386             m_databaseConnection-&gt;connectionToClient().didIterateCursor(IDBResultData::error(requestData.requestIdentifier(), error));
387     });
388 }
389 
390 const Vector&lt;uint64_t&gt;&amp; UniqueIDBDatabaseTransaction::objectStoreIdentifiers()
391 {
392     if (!m_objectStoreIdentifiers.isEmpty())
393         return m_objectStoreIdentifiers;
394 
395     auto&amp; info = m_databaseConnection-&gt;database()-&gt;info();
396     for (const auto&amp; objectStoreName : info.objectStoreNames()) {
397         auto objectStoreInfo = info.infoForExistingObjectStore(objectStoreName);
398         ASSERT(objectStoreInfo);
399         if (!objectStoreInfo)
400             continue;
401 
402         if (m_transactionInfo.objectStores().contains(objectStoreName))
</pre>
</td>
</tr>
</table>
<center><a href="UniqueIDBDatabaseConnection.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="UniqueIDBDatabaseTransaction.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>