<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old modules/javafx.web/src/main/native/Source/WTF/wtf/cf/LanguageCF.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (C) 2003, 2005, 2006, 2010, 2011, 2016, 2017 Apple Inc. All rights reserved.
  3  *
  4  * Redistribution and use in source and binary forms, with or without
  5  * modification, are permitted provided that the following conditions
  6  * are met:
  7  * 1. Redistributions of source code must retain the above copyright
  8  *    notice, this list of conditions and the following disclaimer.
  9  * 2. Redistributions in binary form must reproduce the above copyright
 10  *    notice, this list of conditions and the following disclaimer in the
 11  *    documentation and/or other materials provided with the distribution.
 12  *
 13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. AND ITS CONTRIBUTORS ``AS IS&#39;&#39;
 14  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
 15  * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 16  * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL APPLE INC. OR ITS CONTRIBUTORS
 17  * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 18  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 19  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 20  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 21  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 22  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF
 23  * THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #include &quot;config.h&quot;
 27 #include &lt;wtf/Language.h&gt;
 28 
 29 #include &lt;CoreFoundation/CoreFoundation.h&gt;
 30 #include &lt;mutex&gt;
 31 #include &lt;unicode/uloc.h&gt;
 32 #include &lt;wtf/Assertions.h&gt;
 33 #include &lt;wtf/Lock.h&gt;
 34 #include &lt;wtf/NeverDestroyed.h&gt;
 35 #include &lt;wtf/RetainPtr.h&gt;
 36 #include &lt;wtf/spi/cf/CFBundleSPI.h&gt;
 37 #include &lt;wtf/text/WTFString.h&gt;
 38 
 39 namespace WTF {
 40 
 41 static Lock preferredLanguagesMutex;
 42 
 43 static Vector&lt;String&gt;&amp; preferredLanguages()
 44 {
 45     static NeverDestroyed&lt;Vector&lt;String&gt;&gt; languages;
 46     return languages;
 47 }
 48 
 49 static String httpStyleLanguageCode(CFStringRef language)
 50 {
 51     SInt32 languageCode;
 52     SInt32 regionCode;
 53     SInt32 scriptCode;
 54     CFStringEncoding stringEncoding;
 55 
 56     // FIXME: This transformation is very wrong:
 57     // 1. There is no reason why CFBundle localization names would be at all related to language names as used on the Web.
 58     // 2. Script Manager codes cannot represent all languages that are now supported by the platform, so the conversion is lossy.
 59     // 3. This should probably match what is sent by the network layer as Accept-Language, but currently, that&#39;s implemented separately.
 60     CFBundleGetLocalizationInfoForLocalization(language, &amp;languageCode, &amp;regionCode, &amp;scriptCode, &amp;stringEncoding);
 61     RetainPtr&lt;CFStringRef&gt; preferredLanguageCode = adoptCF(CFBundleCopyLocalizationForLocalizationInfo(languageCode, regionCode, scriptCode, stringEncoding));
 62     if (preferredLanguageCode)
 63         language = preferredLanguageCode.get();
 64 
 65     // Turn a &#39;_&#39; into a &#39;-&#39; if it appears after a 2-letter language code
 66     if (CFStringGetLength(language) &gt;= 3 &amp;&amp; CFStringGetCharacterAtIndex(language, 2) == &#39;_&#39;) {
 67         auto mutableLanguageCode = adoptCF(CFStringCreateMutableCopy(kCFAllocatorDefault, 0, language));
 68         CFStringReplace(mutableLanguageCode.get(), CFRangeMake(2, 1), CFSTR(&quot;-&quot;));
 69         return mutableLanguageCode.get();
 70     }
 71 
 72     return language;
 73 }
 74 
 75 #if PLATFORM(MAC)
 76 static void languagePreferencesDidChange(CFNotificationCenterRef, void*, CFStringRef, const void*, CFDictionaryRef)
 77 {
 78     {
 79         std::lock_guard&lt;Lock&gt; lock(preferredLanguagesMutex);
 80         preferredLanguages().clear();
 81     }
 82 
 83     languageDidChange();
 84 }
 85 #endif
 86 
 87 Vector&lt;String&gt; platformUserPreferredLanguages()
 88 {
 89 #if PLATFORM(MAC)
 90     static dispatch_once_t onceToken;
 91     dispatch_once(&amp;onceToken, ^ {
 92         CFNotificationCenterAddObserver(CFNotificationCenterGetDistributedCenter(), nullptr, &amp;languagePreferencesDidChange, CFSTR(&quot;AppleLanguagePreferencesChangedNotification&quot;), nullptr, CFNotificationSuspensionBehaviorCoalesce);
 93     });
 94 #endif
 95 
 96     std::lock_guard&lt;Lock&gt; lock(preferredLanguagesMutex);
 97     Vector&lt;String&gt;&amp; userPreferredLanguages = preferredLanguages();
 98 
 99     if (userPreferredLanguages.isEmpty()) {
100         RetainPtr&lt;CFArrayRef&gt; languages = adoptCF(CFLocaleCopyPreferredLanguages());
101         CFIndex languageCount = CFArrayGetCount(languages.get());
102         if (!languageCount)
103             userPreferredLanguages.append(&quot;en&quot;);
104         else {
105             for (CFIndex i = 0; i &lt; languageCount; i++)
106                 userPreferredLanguages.append(httpStyleLanguageCode(static_cast&lt;CFStringRef&gt;(CFArrayGetValueAtIndex(languages.get(), i))));
107         }
108     }
109 
110     Vector&lt;String&gt; userPreferredLanguagesCopy;
111     userPreferredLanguagesCopy.reserveInitialCapacity(userPreferredLanguages.size());
112 
113     for (auto&amp; language : userPreferredLanguages)
114         userPreferredLanguagesCopy.uncheckedAppend(language.isolatedCopy());
115 
116     return userPreferredLanguagesCopy;
117 
118     return Vector&lt;String&gt;();
119 }
120 
121 } // namespace WTF
    </pre>
  </body>
</html>