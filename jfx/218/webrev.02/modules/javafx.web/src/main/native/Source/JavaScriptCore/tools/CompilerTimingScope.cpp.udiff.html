<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/JavaScriptCore/tools/CompilerTimingScope.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../testRegExp.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="CompilerTimingScope.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/JavaScriptCore/tools/CompilerTimingScope.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -28,10 +28,12 @@</span>
  
  #include &quot;Options.h&quot;
  #include &lt;wtf/DataLog.h&gt;
  #include &lt;wtf/HashMap.h&gt;
  #include &lt;wtf/Lock.h&gt;
<span class="udiff-line-added">+ #include &lt;wtf/Vector.h&gt;</span>
<span class="udiff-line-added">+ #include &lt;wtf/text/WTFString.h&gt;</span>
  
  namespace JSC {
  
  namespace {
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -42,15 +44,32 @@</span>
      CompilerTimingScopeState() { }
  
      Seconds addToTotal(const char* compilerName, const char* name, Seconds duration)
      {
          auto locker = holdLock(lock);
<span class="udiff-line-modified-removed">-         return totals.add(std::make_pair(compilerName, name), Seconds(0)).iterator-&gt;value += duration;</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-added">+         for (auto&amp; tuple : totals) {</span>
<span class="udiff-line-added">+             if (String(std::get&lt;0&gt;(tuple)) == String(compilerName) &amp;&amp; String(std::get&lt;1&gt;(tuple)) == String(name)) {</span>
<span class="udiff-line-added">+                 std::get&lt;2&gt;(tuple) += duration;</span>
<span class="udiff-line-added">+                 return std::get&lt;2&gt;(tuple);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         totals.append({ compilerName, name, duration });</span>
<span class="udiff-line-added">+         return duration;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     void logTotals()</span>
<span class="udiff-line-added">+     {</span>
<span class="udiff-line-added">+         for (auto&amp; tuple : totals) {</span>
<span class="udiff-line-added">+             dataLogLn(</span>
<span class="udiff-line-added">+                 &quot;[&quot;, std::get&lt;0&gt;(tuple), &quot;] &quot;, std::get&lt;1&gt;(tuple), &quot; total ms: &quot;, std::get&lt;2&gt;(tuple).milliseconds());</span>
<span class="udiff-line-added">+         }</span>
      }
  
  private:
<span class="udiff-line-modified-removed">-     HashMap&lt;std::pair&lt;const char*, const char*&gt;, Seconds&gt; totals;</span>
<span class="udiff-line-modified-added">+     Vector&lt;std::tuple&lt;const char*, const char*, Seconds&gt;&gt; totals;</span>
      Lock lock;
  };
  
  CompilerTimingScopeState&amp; compilerTimingScopeState()
  {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -62,23 +81,29 @@</span>
  
  CompilerTimingScope::CompilerTimingScope(const char* compilerName, const char* name)
      : m_compilerName(compilerName)
      , m_name(name)
  {
<span class="udiff-line-modified-removed">-     if (Options::logPhaseTimes())</span>
<span class="udiff-line-modified-added">+     if (UNLIKELY(Options::logPhaseTimes() || Options::reportTotalPhaseTimes()))</span>
          m_before = MonotonicTime::now();
  }
  
  CompilerTimingScope::~CompilerTimingScope()
  {
<span class="udiff-line-modified-removed">-     if (Options::logPhaseTimes()) {</span>
<span class="udiff-line-modified-added">+     if (UNLIKELY(Options::logPhaseTimes() || Options::reportTotalPhaseTimes())) {</span>
          Seconds duration = MonotonicTime::now() - m_before;
<span class="udiff-line-modified-removed">-         dataLog(</span>
<span class="udiff-line-modified-removed">-             &quot;[&quot;, m_compilerName, &quot;] &quot;, m_name, &quot; took: &quot;, duration.milliseconds(), &quot; ms &quot;,</span>
<span class="udiff-line-modified-removed">-             &quot;(total: &quot;, compilerTimingScopeState().addToTotal(m_compilerName, m_name, duration).milliseconds(),</span>
<span class="udiff-line-modified-removed">-             &quot; ms).\n&quot;);</span>
<span class="udiff-line-modified-added">+         auto total = compilerTimingScopeState().addToTotal(m_compilerName, m_name, duration);</span>
<span class="udiff-line-modified-added">+         if (Options::logPhaseTimes()) {</span>
<span class="udiff-line-modified-added">+             dataLog(</span>
<span class="udiff-line-modified-added">+                 &quot;[&quot;, m_compilerName, &quot;] &quot;, m_name, &quot; took: &quot;, duration.milliseconds(), &quot; ms &quot;,</span>
<span class="udiff-line-added">+                 &quot;(total: &quot;, total.milliseconds(),</span>
<span class="udiff-line-added">+                 &quot; ms).\n&quot;);</span>
<span class="udiff-line-added">+         }</span>
      }
  }
  
<span class="udiff-line-modified-removed">- } // namespace JSC</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-added">+ void logTotalPhaseTimes()</span>
<span class="udiff-line-modified-added">+ {</span>
<span class="udiff-line-added">+     compilerTimingScopeState().logTotals();</span>
<span class="udiff-line-added">+ }</span>
  
<span class="udiff-line-added">+ } // namespace JSC</span>
</pre>
<center><a href="../testRegExp.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="CompilerTimingScope.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>