<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/WebCore/html/canvas/WebGLRenderingContext.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (C) 2015-2017 Apple Inc. All rights reserved.
  3  *
  4  * Redistribution and use in source and binary forms, with or without
  5  * modification, are permitted provided that the following conditions
  6  * are met:
  7  * 1. Redistributions of source code must retain the above copyright
  8  *    notice, this list of conditions and the following disclaimer.
  9  * 2. Redistributions in binary form must reproduce the above copyright
 10  *    notice, this list of conditions and the following disclaimer in the
 11  *    documentation and/or other materials provided with the distribution.
 12  *
 13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. ``AS IS&#39;&#39; AND ANY
 14  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 15  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 16  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE INC. OR
 17  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 18  * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 19  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 20  * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 21  * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 22  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 23  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #include &quot;config.h&quot;
 27 #include &quot;WebGLRenderingContext.h&quot;
 28 
 29 #if ENABLE(WEBGL)
 30 
 31 #include &quot;ANGLEInstancedArrays.h&quot;
 32 #include &quot;CachedImage.h&quot;
 33 #include &quot;EXTBlendMinMax.h&quot;
 34 #include &quot;EXTFragDepth.h&quot;
 35 #include &quot;EXTShaderTextureLOD.h&quot;
 36 #include &quot;EXTTextureFilterAnisotropic.h&quot;
 37 #include &quot;EXTsRGB.h&quot;
<a name="1" id="anc1"></a><span class="line-modified"> 38 #include &quot;Extensions3D.h&quot;</span>
 39 #include &quot;HTMLCanvasElement.h&quot;
 40 #include &quot;HTMLImageElement.h&quot;
 41 #include &quot;HTMLVideoElement.h&quot;
 42 #include &quot;ImageData.h&quot;
 43 #include &quot;InspectorInstrumentation.h&quot;
 44 #include &quot;OESElementIndexUint.h&quot;
 45 #include &quot;OESStandardDerivatives.h&quot;
 46 #include &quot;OESTextureFloat.h&quot;
 47 #include &quot;OESTextureFloatLinear.h&quot;
 48 #include &quot;OESTextureHalfFloat.h&quot;
 49 #include &quot;OESTextureHalfFloatLinear.h&quot;
 50 #include &quot;OESVertexArrayObject.h&quot;
 51 #include &quot;RenderBox.h&quot;
 52 #include &quot;WebGLCompressedTextureASTC.h&quot;
 53 #include &quot;WebGLCompressedTextureATC.h&quot;
<a name="2" id="anc2"></a>

 54 #include &quot;WebGLCompressedTexturePVRTC.h&quot;
 55 #include &quot;WebGLCompressedTextureS3TC.h&quot;
 56 #include &quot;WebGLDebugRendererInfo.h&quot;
 57 #include &quot;WebGLDebugShaders.h&quot;
 58 #include &quot;WebGLDepthTexture.h&quot;
 59 #include &quot;WebGLDrawBuffers.h&quot;
 60 #include &quot;WebGLLoseContext.h&quot;
 61 #include &quot;WebGLVertexArrayObjectOES.h&quot;
 62 #include &lt;JavaScriptCore/GenericTypedArrayViewInlines.h&gt;
 63 #include &lt;JavaScriptCore/HeapInlines.h&gt;
 64 #include &lt;JavaScriptCore/JSCJSValueInlines.h&gt;
 65 #include &lt;JavaScriptCore/JSCellInlines.h&gt;
 66 #include &lt;JavaScriptCore/JSGenericTypedArrayViewInlines.h&gt;
 67 #include &lt;wtf/IsoMallocInlines.h&gt;
 68 
 69 namespace WebCore {
 70 
 71 WTF_MAKE_ISO_ALLOCATED_IMPL(WebGLRenderingContext);
 72 
<a name="3" id="anc3"></a><span class="line-modified"> 73 std::unique_ptr&lt;WebGLRenderingContext&gt; WebGLRenderingContext::create(CanvasBase&amp; canvas, GraphicsContext3DAttributes attributes)</span>
 74 {
 75     auto renderingContext = std::unique_ptr&lt;WebGLRenderingContext&gt;(new WebGLRenderingContext(canvas, attributes));
 76 
 77     InspectorInstrumentation::didCreateCanvasRenderingContext(*renderingContext);
 78 
 79     return renderingContext;
 80 }
 81 
<a name="4" id="anc4"></a><span class="line-modified"> 82 std::unique_ptr&lt;WebGLRenderingContext&gt; WebGLRenderingContext::create(CanvasBase&amp; canvas, Ref&lt;GraphicsContext3D&gt;&amp;&amp; context, GraphicsContext3DAttributes attributes)</span>
 83 {
 84     auto renderingContext = std::unique_ptr&lt;WebGLRenderingContext&gt;(new WebGLRenderingContext(canvas, WTFMove(context), attributes));
 85 
 86     InspectorInstrumentation::didCreateCanvasRenderingContext(*renderingContext);
 87 
 88     return renderingContext;
 89 }
 90 
<a name="5" id="anc5"></a><span class="line-modified"> 91 WebGLRenderingContext::WebGLRenderingContext(CanvasBase&amp; canvas, GraphicsContext3DAttributes attributes)</span>
 92     : WebGLRenderingContextBase(canvas, attributes)
 93 {
 94 }
 95 
<a name="6" id="anc6"></a><span class="line-modified"> 96 WebGLRenderingContext::WebGLRenderingContext(CanvasBase&amp; canvas, Ref&lt;GraphicsContext3D&gt;&amp;&amp; context, GraphicsContext3DAttributes attributes)</span>
 97     : WebGLRenderingContextBase(canvas, WTFMove(context), attributes)
 98 {
 99     initializeVertexArrayObjects();
100 }
101 
102 void WebGLRenderingContext::initializeVertexArrayObjects()
103 {
104     m_defaultVertexArrayObject = WebGLVertexArrayObjectOES::create(*this, WebGLVertexArrayObjectOES::Type::Default);
105     addContextObject(*m_defaultVertexArrayObject);
106     m_boundVertexArrayObject = m_defaultVertexArrayObject;
107     if (!isGLES2Compliant())
108         initVertexAttrib0();
109 }
110 
111 WebGLExtension* WebGLRenderingContext::getExtension(const String&amp; name)
112 {
113     if (isContextLostOrPending())
114         return nullptr;
115 
116 #define ENABLE_IF_REQUESTED(type, variable, nameLiteral, canEnable) \
117     if (equalIgnoringASCIICase(name, nameLiteral)) { \
118         if (!variable) { \
119             variable = (canEnable) ? makeUnique&lt;type&gt;(*this) : nullptr; \
120             if (variable != nullptr) \
121                 InspectorInstrumentation::didEnableExtension(*this, name); \
122         } \
123         return variable.get(); \
124     }
125 
126     ENABLE_IF_REQUESTED(EXTBlendMinMax, m_extBlendMinMax, &quot;EXT_blend_minmax&quot;, enableSupportedExtension(&quot;GL_EXT_blend_minmax&quot;_s));
127     ENABLE_IF_REQUESTED(EXTsRGB, m_extsRGB, &quot;EXT_sRGB&quot;, enableSupportedExtension(&quot;GL_EXT_sRGB&quot;_s));
128     ENABLE_IF_REQUESTED(EXTFragDepth, m_extFragDepth, &quot;EXT_frag_depth&quot;, enableSupportedExtension(&quot;GL_EXT_frag_depth&quot;_s));
129     if (equalIgnoringASCIICase(name, &quot;EXT_shader_texture_lod&quot;)) {
130         if (!m_extShaderTextureLOD) {
131             if (!(m_context-&gt;getExtensions().supports(&quot;GL_EXT_shader_texture_lod&quot;_s) || m_context-&gt;getExtensions().supports(&quot;GL_ARB_shader_texture_lod&quot;_s)))
132                 m_extShaderTextureLOD = nullptr;
133             else {
134                 m_context-&gt;getExtensions().ensureEnabled(&quot;GL_EXT_shader_texture_lod&quot;_s);
135                 m_extShaderTextureLOD = makeUnique&lt;EXTShaderTextureLOD&gt;(*this);
136                 InspectorInstrumentation::didEnableExtension(*this, name);
137             }
138         }
139         return m_extShaderTextureLOD.get();
140     }
141     ENABLE_IF_REQUESTED(EXTTextureFilterAnisotropic, m_extTextureFilterAnisotropic, &quot;EXT_texture_filter_anisotropic&quot;, enableSupportedExtension(&quot;GL_EXT_texture_filter_anisotropic&quot;_s));
<a name="7" id="anc7"></a><span class="line-removed">142     ENABLE_IF_REQUESTED(EXTTextureFilterAnisotropic, m_extTextureFilterAnisotropic, &quot;WEBKIT_EXT_texture_filter_anisotropic&quot;, enableSupportedExtension(&quot;GL_EXT_texture_filter_anisotropic&quot;_s));</span>
143     ENABLE_IF_REQUESTED(OESStandardDerivatives, m_oesStandardDerivatives, &quot;OES_standard_derivatives&quot;, enableSupportedExtension(&quot;GL_OES_standard_derivatives&quot;_s));
144     ENABLE_IF_REQUESTED(OESTextureFloat, m_oesTextureFloat, &quot;OES_texture_float&quot;, enableSupportedExtension(&quot;GL_OES_texture_float&quot;_s));
145     ENABLE_IF_REQUESTED(OESTextureFloatLinear, m_oesTextureFloatLinear, &quot;OES_texture_float_linear&quot;, enableSupportedExtension(&quot;GL_OES_texture_float_linear&quot;_s));
146     ENABLE_IF_REQUESTED(OESTextureHalfFloat, m_oesTextureHalfFloat, &quot;OES_texture_half_float&quot;, enableSupportedExtension(&quot;GL_OES_texture_half_float&quot;_s));
147     ENABLE_IF_REQUESTED(OESTextureHalfFloatLinear, m_oesTextureHalfFloatLinear, &quot;OES_texture_half_float_linear&quot;, enableSupportedExtension(&quot;GL_OES_texture_half_float_linear&quot;_s));
148     ENABLE_IF_REQUESTED(OESVertexArrayObject, m_oesVertexArrayObject, &quot;OES_vertex_array_object&quot;, enableSupportedExtension(&quot;GL_OES_vertex_array_object&quot;_s));
149     ENABLE_IF_REQUESTED(OESElementIndexUint, m_oesElementIndexUint, &quot;OES_element_index_uint&quot;, enableSupportedExtension(&quot;GL_OES_element_index_uint&quot;_s));
150     ENABLE_IF_REQUESTED(WebGLLoseContext, m_webglLoseContext, &quot;WEBGL_lose_context&quot;, true);
<a name="8" id="anc8"></a>
151     ENABLE_IF_REQUESTED(WebGLCompressedTextureATC, m_webglCompressedTextureATC, &quot;WEBKIT_WEBGL_compressed_texture_atc&quot;, WebGLCompressedTextureATC::supported(*this));
<a name="9" id="anc9"></a>

152     ENABLE_IF_REQUESTED(WebGLCompressedTexturePVRTC, m_webglCompressedTexturePVRTC, &quot;WEBKIT_WEBGL_compressed_texture_pvrtc&quot;, WebGLCompressedTexturePVRTC::supported(*this));
153     ENABLE_IF_REQUESTED(WebGLCompressedTextureS3TC, m_webglCompressedTextureS3TC, &quot;WEBGL_compressed_texture_s3tc&quot;, WebGLCompressedTextureS3TC::supported(*this));
<a name="10" id="anc10"></a><span class="line-removed">154     ENABLE_IF_REQUESTED(WebGLCompressedTextureASTC, m_webglCompressedTextureASTC, &quot;WEBGL_compressed_texture_astc&quot;, WebGLCompressedTextureASTC::supported(*this));</span>
155     ENABLE_IF_REQUESTED(WebGLDepthTexture, m_webglDepthTexture, &quot;WEBGL_depth_texture&quot;, WebGLDepthTexture::supported(*m_context));
156     if (equalIgnoringASCIICase(name, &quot;WEBGL_draw_buffers&quot;)) {
157         if (!m_webglDrawBuffers) {
158             if (!supportsDrawBuffers())
159                 m_webglDrawBuffers = nullptr;
160             else {
161                 m_context-&gt;getExtensions().ensureEnabled(&quot;GL_EXT_draw_buffers&quot;_s);
162                 m_webglDrawBuffers = makeUnique&lt;WebGLDrawBuffers&gt;(*this);
163                 InspectorInstrumentation::didEnableExtension(*this, name);
164             }
165         }
166         return m_webglDrawBuffers.get();
167     }
168     if (equalIgnoringASCIICase(name, &quot;ANGLE_instanced_arrays&quot;)) {
169         if (!m_angleInstancedArrays) {
170             if (!ANGLEInstancedArrays::supported(*this))
171                 m_angleInstancedArrays = nullptr;
172             else {
173                 m_context-&gt;getExtensions().ensureEnabled(&quot;GL_ANGLE_instanced_arrays&quot;_s);
174                 m_angleInstancedArrays = makeUnique&lt;ANGLEInstancedArrays&gt;(*this);
175                 InspectorInstrumentation::didEnableExtension(*this, name);
176             }
177         }
178         return m_angleInstancedArrays.get();
179     }
180     ENABLE_IF_REQUESTED(WebGLDebugRendererInfo, m_webglDebugRendererInfo, &quot;WEBGL_debug_renderer_info&quot;, true);
181     ENABLE_IF_REQUESTED(WebGLDebugShaders, m_webglDebugShaders, &quot;WEBGL_debug_shaders&quot;, m_context-&gt;getExtensions().supports(&quot;GL_ANGLE_translated_shader_source&quot;_s));
182     return nullptr;
183 }
184 
185 Optional&lt;Vector&lt;String&gt;&gt; WebGLRenderingContext::getSupportedExtensions()
186 {
187     if (isContextLost())
188         return WTF::nullopt;
189 
190     Vector&lt;String&gt; result;
191 
192     if (m_isPendingPolicyResolution)
193         return result;
194 
195     if (m_context-&gt;getExtensions().supports(&quot;GL_EXT_blend_minmax&quot;_s))
196         result.append(&quot;EXT_blend_minmax&quot;_s);
197     if (m_context-&gt;getExtensions().supports(&quot;GL_EXT_sRGB&quot;_s))
198         result.append(&quot;EXT_sRGB&quot;_s);
199     if (m_context-&gt;getExtensions().supports(&quot;GL_EXT_frag_depth&quot;_s))
200         result.append(&quot;EXT_frag_depth&quot;_s);
201     if (m_context-&gt;getExtensions().supports(&quot;GL_OES_texture_float&quot;_s))
202         result.append(&quot;OES_texture_float&quot;_s);
203     if (m_context-&gt;getExtensions().supports(&quot;GL_OES_texture_float_linear&quot;_s))
204         result.append(&quot;OES_texture_float_linear&quot;_s);
205     if (m_context-&gt;getExtensions().supports(&quot;GL_OES_texture_half_float&quot;_s))
206         result.append(&quot;OES_texture_half_float&quot;_s);
207     if (m_context-&gt;getExtensions().supports(&quot;GL_OES_texture_half_float_linear&quot;_s))
208         result.append(&quot;OES_texture_half_float_linear&quot;_s);
209     if (m_context-&gt;getExtensions().supports(&quot;GL_OES_standard_derivatives&quot;_s))
210         result.append(&quot;OES_standard_derivatives&quot;_s);
211     if (m_context-&gt;getExtensions().supports(&quot;GL_EXT_shader_texture_lod&quot;_s) || m_context-&gt;getExtensions().supports(&quot;GL_ARB_shader_texture_lod&quot;_s))
212         result.append(&quot;EXT_shader_texture_lod&quot;_s);
213     if (m_context-&gt;getExtensions().supports(&quot;GL_EXT_texture_filter_anisotropic&quot;_s))
214         result.append(&quot;EXT_texture_filter_anisotropic&quot;_s);
215     if (m_context-&gt;getExtensions().supports(&quot;GL_OES_vertex_array_object&quot;_s))
216         result.append(&quot;OES_vertex_array_object&quot;_s);
217     if (m_context-&gt;getExtensions().supports(&quot;GL_OES_element_index_uint&quot;_s))
218         result.append(&quot;OES_element_index_uint&quot;_s);
219     result.append(&quot;WEBGL_lose_context&quot;_s);
<a name="11" id="anc11"></a>

220     if (WebGLCompressedTextureATC::supported(*this))
221         result.append(&quot;WEBKIT_WEBGL_compressed_texture_atc&quot;_s);
<a name="12" id="anc12"></a>



222     if (WebGLCompressedTexturePVRTC::supported(*this))
223         result.append(&quot;WEBKIT_WEBGL_compressed_texture_pvrtc&quot;_s);
224     if (WebGLCompressedTextureS3TC::supported(*this))
225         result.append(&quot;WEBGL_compressed_texture_s3tc&quot;_s);
<a name="13" id="anc13"></a><span class="line-removed">226     if (WebGLCompressedTextureASTC::supported(*this))</span>
<span class="line-removed">227         result.append(&quot;WEBGL_compressed_texture_astc&quot;_s);</span>
228     if (WebGLDepthTexture::supported(*m_context))
229         result.append(&quot;WEBGL_depth_texture&quot;_s);
230     if (supportsDrawBuffers())
231         result.append(&quot;WEBGL_draw_buffers&quot;_s);
232     if (ANGLEInstancedArrays::supported(*this))
233         result.append(&quot;ANGLE_instanced_arrays&quot;_s);
234     if (m_context-&gt;getExtensions().supports(&quot;GL_ANGLE_translated_shader_source&quot;_s))
235         result.append(&quot;WEBGL_debug_shaders&quot;_s);
236     result.append(&quot;WEBGL_debug_renderer_info&quot;_s);
237 
238     return result;
239 }
240 
<a name="14" id="anc14"></a><span class="line-modified">241 WebGLAny WebGLRenderingContext::getFramebufferAttachmentParameter(GC3Denum target, GC3Denum attachment, GC3Denum pname)</span>
242 {
243     if (isContextLostOrPending() || !validateFramebufferFuncParameters(&quot;getFramebufferAttachmentParameter&quot;, target, attachment))
244         return nullptr;
245 
246     if (!m_framebufferBinding || !m_framebufferBinding-&gt;object()) {
<a name="15" id="anc15"></a><span class="line-modified">247         synthesizeGLError(GraphicsContext3D::INVALID_OPERATION, &quot;getFramebufferAttachmentParameter&quot;, &quot;no framebuffer bound&quot;);</span>
248         return nullptr;
249     }
250 
251     auto object = makeRefPtr(m_framebufferBinding-&gt;getAttachmentObject(attachment));
252     if (!object) {
<a name="16" id="anc16"></a><span class="line-modified">253         if (pname == GraphicsContext3D::FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE)</span>
<span class="line-modified">254             return static_cast&lt;unsigned&gt;(GraphicsContext3D::NONE);</span>
255         // OpenGL ES 2.0 specifies INVALID_ENUM in this case, while desktop GL
256         // specifies INVALID_OPERATION.
<a name="17" id="anc17"></a><span class="line-modified">257         synthesizeGLError(GraphicsContext3D::INVALID_ENUM, &quot;getFramebufferAttachmentParameter&quot;, &quot;invalid parameter name&quot;);</span>
258         return nullptr;
259     }
260 
261     if (object-&gt;isTexture()) {
262         switch (pname) {
<a name="18" id="anc18"></a><span class="line-modified">263         case GraphicsContext3D::FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE:</span>
<span class="line-modified">264             return static_cast&lt;unsigned&gt;(GraphicsContext3D::TEXTURE);</span>
<span class="line-modified">265         case GraphicsContext3D::FRAMEBUFFER_ATTACHMENT_OBJECT_NAME:</span>
266             return makeRefPtr(reinterpret_cast&lt;WebGLTexture&amp;&gt;(*object));
<a name="19" id="anc19"></a><span class="line-modified">267         case GraphicsContext3D::FRAMEBUFFER_ATTACHMENT_TEXTURE_LEVEL:</span>
<span class="line-modified">268         case GraphicsContext3D::FRAMEBUFFER_ATTACHMENT_TEXTURE_CUBE_MAP_FACE:</span>
<span class="line-modified">269         case Extensions3D::FRAMEBUFFER_ATTACHMENT_COLOR_ENCODING_EXT: {</span>
<span class="line-modified">270             GC3Dint value = 0;</span>
271             m_context-&gt;getFramebufferAttachmentParameteriv(target, attachment, pname, &amp;value);
272             return value;
273         }
274         default:
<a name="20" id="anc20"></a><span class="line-modified">275             synthesizeGLError(GraphicsContext3D::INVALID_ENUM, &quot;getFramebufferAttachmentParameter&quot;, &quot;invalid parameter name for texture attachment&quot;);</span>
276             return nullptr;
277         }
278     } else {
279         ASSERT(object-&gt;isRenderbuffer());
280         switch (pname) {
<a name="21" id="anc21"></a><span class="line-modified">281         case GraphicsContext3D::FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE:</span>
<span class="line-modified">282             return static_cast&lt;unsigned&gt;(GraphicsContext3D::RENDERBUFFER);</span>
<span class="line-modified">283         case GraphicsContext3D::FRAMEBUFFER_ATTACHMENT_OBJECT_NAME:</span>
284             return makeRefPtr(reinterpret_cast&lt;WebGLRenderbuffer&amp;&gt;(*object));
<a name="22" id="anc22"></a><span class="line-modified">285         case Extensions3D::FRAMEBUFFER_ATTACHMENT_COLOR_ENCODING_EXT: {</span>
286             if (!m_extsRGB) {
<a name="23" id="anc23"></a><span class="line-modified">287                 synthesizeGLError(GraphicsContext3D::INVALID_ENUM, &quot;getFramebufferAttachmentParameter&quot;, &quot;invalid parameter name for renderbuffer attachment&quot;);</span>
288                 return nullptr;
289             }
290             RefPtr&lt;WebGLRenderbuffer&gt; renderBuffer = reinterpret_cast&lt;WebGLRenderbuffer*&gt;(object.get());
<a name="24" id="anc24"></a><span class="line-modified">291             GC3Denum renderBufferFormat = renderBuffer-&gt;getInternalFormat();</span>
<span class="line-modified">292             ASSERT(renderBufferFormat != Extensions3D::SRGB_EXT &amp;&amp; renderBufferFormat != Extensions3D::SRGB_ALPHA_EXT);</span>
<span class="line-modified">293             if (renderBufferFormat == Extensions3D::SRGB8_ALPHA8_EXT)</span>
<span class="line-modified">294                 return static_cast&lt;unsigned&gt;(Extensions3D::SRGB_EXT);</span>
<span class="line-modified">295             return static_cast&lt;unsigned&gt;(GraphicsContext3D::LINEAR);</span>
296         }
297         default:
<a name="25" id="anc25"></a><span class="line-modified">298             synthesizeGLError(GraphicsContext3D::INVALID_ENUM, &quot;getFramebufferAttachmentParameter&quot;, &quot;invalid parameter name for renderbuffer attachment&quot;);</span>
299             return nullptr;
300         }
301     }
302 }
303 
<a name="26" id="anc26"></a><span class="line-modified">304 bool WebGLRenderingContext::validateFramebufferFuncParameters(const char* functionName, GC3Denum target, GC3Denum attachment)</span>
305 {
<a name="27" id="anc27"></a><span class="line-modified">306     if (target != GraphicsContext3D::FRAMEBUFFER) {</span>
<span class="line-modified">307         synthesizeGLError(GraphicsContext3D::INVALID_ENUM, functionName, &quot;invalid target&quot;);</span>
308         return false;
309     }
310     // FIXME: Why does this return true unconditionally for COLOR_ATTACHMENT0,
311     // but false for other COLOR_ATTACHMENT values if m_webglDrawBuffers is false?
312     switch (attachment) {
<a name="28" id="anc28"></a><span class="line-modified">313     case GraphicsContext3D::COLOR_ATTACHMENT0:</span>
<span class="line-modified">314     case GraphicsContext3D::DEPTH_ATTACHMENT:</span>
<span class="line-modified">315     case GraphicsContext3D::STENCIL_ATTACHMENT:</span>
<span class="line-modified">316     case GraphicsContext3D::DEPTH_STENCIL_ATTACHMENT:</span>
317         return true;
318     default:
319         if (m_webglDrawBuffers
<a name="29" id="anc29"></a><span class="line-modified">320             &amp;&amp; attachment &gt;= GraphicsContext3D::COLOR_ATTACHMENT0</span>
<span class="line-modified">321             &amp;&amp; attachment &lt; static_cast&lt;GC3Denum&gt;(GraphicsContext3D::COLOR_ATTACHMENT0 + getMaxColorAttachments()))</span>
322             return true;
<a name="30" id="anc30"></a><span class="line-modified">323         synthesizeGLError(GraphicsContext3D::INVALID_ENUM, functionName, &quot;invalid attachment&quot;);</span>
324         return false;
325     }
326 }
327 
<a name="31" id="anc31"></a><span class="line-modified">328 void WebGLRenderingContext::renderbufferStorage(GC3Denum target, GC3Denum internalformat, GC3Dsizei width, GC3Dsizei height)</span>
329 {
330     if (isContextLostOrPending())
331         return;
<a name="32" id="anc32"></a><span class="line-modified">332     if (target != GraphicsContext3D::RENDERBUFFER) {</span>
<span class="line-modified">333         synthesizeGLError(GraphicsContext3D::INVALID_ENUM, &quot;renderbufferStorage&quot;, &quot;invalid target&quot;);</span>
334         return;
335     }
336     if (!m_renderbufferBinding || !m_renderbufferBinding-&gt;object()) {
<a name="33" id="anc33"></a><span class="line-modified">337         synthesizeGLError(GraphicsContext3D::INVALID_OPERATION, &quot;renderbufferStorage&quot;, &quot;no bound renderbuffer&quot;);</span>
338         return;
339     }
340     if (!validateSize(&quot;renderbufferStorage&quot;, width, height))
341         return;
342     switch (internalformat) {
<a name="34" id="anc34"></a><span class="line-modified">343     case GraphicsContext3D::DEPTH_COMPONENT16:</span>
<span class="line-modified">344     case GraphicsContext3D::RGBA4:</span>
<span class="line-modified">345     case GraphicsContext3D::RGB5_A1:</span>
<span class="line-modified">346     case GraphicsContext3D::RGB565:</span>
<span class="line-modified">347     case GraphicsContext3D::STENCIL_INDEX8:</span>
<span class="line-modified">348     case Extensions3D::SRGB8_ALPHA8_EXT:</span>
<span class="line-modified">349         if (internalformat == Extensions3D::SRGB8_ALPHA8_EXT &amp;&amp; !m_extsRGB) {</span>
<span class="line-modified">350             synthesizeGLError(GraphicsContext3D::INVALID_ENUM, &quot;renderbufferStorage&quot;, &quot;invalid internalformat&quot;);</span>
351             return;
352         }
353         m_context-&gt;renderbufferStorage(target, internalformat, width, height);
354         m_renderbufferBinding-&gt;setInternalFormat(internalformat);
355         m_renderbufferBinding-&gt;setIsValid(true);
356         m_renderbufferBinding-&gt;setSize(width, height);
357         break;
<a name="35" id="anc35"></a><span class="line-modified">358     case GraphicsContext3D::DEPTH_STENCIL:</span>
359         if (isDepthStencilSupported())
<a name="36" id="anc36"></a><span class="line-modified">360             m_context-&gt;renderbufferStorage(target, Extensions3D::DEPTH24_STENCIL8, width, height);</span>
361         m_renderbufferBinding-&gt;setSize(width, height);
362         m_renderbufferBinding-&gt;setIsValid(isDepthStencilSupported());
363         m_renderbufferBinding-&gt;setInternalFormat(internalformat);
364         break;
365     default:
<a name="37" id="anc37"></a><span class="line-modified">366         synthesizeGLError(GraphicsContext3D::INVALID_ENUM, &quot;renderbufferStorage&quot;, &quot;invalid internalformat&quot;);</span>
367         return;
368     }
369     applyStencilTest();
370 }
371 
<a name="38" id="anc38"></a><span class="line-modified">372 void WebGLRenderingContext::hint(GC3Denum target, GC3Denum mode)</span>
373 {
374     if (isContextLostOrPending())
375         return;
376     bool isValid = false;
377     switch (target) {
<a name="39" id="anc39"></a><span class="line-modified">378     case GraphicsContext3D::GENERATE_MIPMAP_HINT:</span>
379         isValid = true;
380         break;
<a name="40" id="anc40"></a><span class="line-modified">381     case Extensions3D::FRAGMENT_SHADER_DERIVATIVE_HINT_OES: // OES_standard_derivatives</span>
382         if (m_oesStandardDerivatives)
383             isValid = true;
384         break;
385     }
386     if (!isValid) {
<a name="41" id="anc41"></a><span class="line-modified">387         synthesizeGLError(GraphicsContext3D::INVALID_ENUM, &quot;hint&quot;, &quot;invalid target&quot;);</span>
388         return;
389     }
390     m_context-&gt;hint(target, mode);
391 }
392 
<a name="42" id="anc42"></a><span class="line-modified">393 void WebGLRenderingContext::clear(GC3Dbitfield mask)</span>
394 {
395     if (isContextLostOrPending())
396         return;
<a name="43" id="anc43"></a><span class="line-modified">397     if (mask &amp; ~(GraphicsContext3D::COLOR_BUFFER_BIT | GraphicsContext3D::DEPTH_BUFFER_BIT | GraphicsContext3D::STENCIL_BUFFER_BIT)) {</span>
<span class="line-modified">398         synthesizeGLError(GraphicsContext3D::INVALID_VALUE, &quot;clear&quot;, &quot;invalid mask&quot;);</span>
399         return;
400     }
401     const char* reason = &quot;framebuffer incomplete&quot;;
402     if (m_framebufferBinding &amp;&amp; !m_framebufferBinding-&gt;onAccess(m_context.get(), &amp;reason)) {
<a name="44" id="anc44"></a><span class="line-modified">403         synthesizeGLError(GraphicsContext3D::INVALID_FRAMEBUFFER_OPERATION, &quot;clear&quot;, reason);</span>
404         return;
405     }
406     if (!clearIfComposited(mask))
407         m_context-&gt;clear(mask);
408     markContextChangedAndNotifyCanvasObserver();
409 }
410 
<a name="45" id="anc45"></a><span class="line-modified">411 WebGLAny WebGLRenderingContext::getParameter(GC3Denum pname)</span>
412 {
413     if (isContextLostOrPending())
414         return nullptr;
415 
416     switch (pname) {
<a name="46" id="anc46"></a><span class="line-modified">417     case GraphicsContext3D::ACTIVE_TEXTURE:</span>
418         return getUnsignedIntParameter(pname);
<a name="47" id="anc47"></a><span class="line-modified">419     case GraphicsContext3D::ALIASED_LINE_WIDTH_RANGE:</span>
420         return getWebGLFloatArrayParameter(pname);
<a name="48" id="anc48"></a><span class="line-modified">421     case GraphicsContext3D::ALIASED_POINT_SIZE_RANGE:</span>
422         return getWebGLFloatArrayParameter(pname);
<a name="49" id="anc49"></a><span class="line-modified">423     case GraphicsContext3D::ALPHA_BITS:</span>
424         if (!m_framebufferBinding &amp;&amp; !m_attributes.alpha)
425             return 0;
426         return getIntParameter(pname);
<a name="50" id="anc50"></a><span class="line-modified">427     case GraphicsContext3D::ARRAY_BUFFER_BINDING:</span>
428         return m_boundArrayBuffer;
<a name="51" id="anc51"></a><span class="line-modified">429     case GraphicsContext3D::BLEND:</span>
430         return getBooleanParameter(pname);
<a name="52" id="anc52"></a><span class="line-modified">431     case GraphicsContext3D::BLEND_COLOR:</span>
432         return getWebGLFloatArrayParameter(pname);
<a name="53" id="anc53"></a><span class="line-modified">433     case GraphicsContext3D::BLEND_DST_ALPHA:</span>
434         return getUnsignedIntParameter(pname);
<a name="54" id="anc54"></a><span class="line-modified">435     case GraphicsContext3D::BLEND_DST_RGB:</span>
436         return getUnsignedIntParameter(pname);
<a name="55" id="anc55"></a><span class="line-modified">437     case GraphicsContext3D::BLEND_EQUATION_ALPHA:</span>
438         return getUnsignedIntParameter(pname);
<a name="56" id="anc56"></a><span class="line-modified">439     case GraphicsContext3D::BLEND_EQUATION_RGB:</span>
440         return getUnsignedIntParameter(pname);
<a name="57" id="anc57"></a><span class="line-modified">441     case GraphicsContext3D::BLEND_SRC_ALPHA:</span>
442         return getUnsignedIntParameter(pname);
<a name="58" id="anc58"></a><span class="line-modified">443     case GraphicsContext3D::BLEND_SRC_RGB:</span>
444         return getUnsignedIntParameter(pname);
<a name="59" id="anc59"></a><span class="line-modified">445     case GraphicsContext3D::BLUE_BITS:</span>
446         return getIntParameter(pname);
<a name="60" id="anc60"></a><span class="line-modified">447     case GraphicsContext3D::COLOR_CLEAR_VALUE:</span>
448         return getWebGLFloatArrayParameter(pname);
<a name="61" id="anc61"></a><span class="line-modified">449     case GraphicsContext3D::COLOR_WRITEMASK:</span>
450         return getBooleanArrayParameter(pname);
<a name="62" id="anc62"></a><span class="line-modified">451     case GraphicsContext3D::COMPRESSED_TEXTURE_FORMATS:</span>
452         return Uint32Array::tryCreate(m_compressedTextureFormats.data(), m_compressedTextureFormats.size());
<a name="63" id="anc63"></a><span class="line-modified">453     case GraphicsContext3D::CULL_FACE:</span>
454         return getBooleanParameter(pname);
<a name="64" id="anc64"></a><span class="line-modified">455     case GraphicsContext3D::CULL_FACE_MODE:</span>
456         return getUnsignedIntParameter(pname);
<a name="65" id="anc65"></a><span class="line-modified">457     case GraphicsContext3D::CURRENT_PROGRAM:</span>
458         return m_currentProgram;
<a name="66" id="anc66"></a><span class="line-modified">459     case GraphicsContext3D::DEPTH_BITS:</span>
460         if (!m_framebufferBinding &amp;&amp; !m_attributes.depth)
461             return 0;
462         return getIntParameter(pname);
<a name="67" id="anc67"></a><span class="line-modified">463     case GraphicsContext3D::DEPTH_CLEAR_VALUE:</span>
464         return getFloatParameter(pname);
<a name="68" id="anc68"></a><span class="line-modified">465     case GraphicsContext3D::DEPTH_FUNC:</span>
466         return getUnsignedIntParameter(pname);
<a name="69" id="anc69"></a><span class="line-modified">467     case GraphicsContext3D::DEPTH_RANGE:</span>
468         return getWebGLFloatArrayParameter(pname);
<a name="70" id="anc70"></a><span class="line-modified">469     case GraphicsContext3D::DEPTH_TEST:</span>
470         return getBooleanParameter(pname);
<a name="71" id="anc71"></a><span class="line-modified">471     case GraphicsContext3D::DEPTH_WRITEMASK:</span>
472         return getBooleanParameter(pname);
<a name="72" id="anc72"></a><span class="line-modified">473     case GraphicsContext3D::DITHER:</span>
474         return getBooleanParameter(pname);
<a name="73" id="anc73"></a><span class="line-modified">475     case GraphicsContext3D::ELEMENT_ARRAY_BUFFER_BINDING:</span>
476         return makeRefPtr(m_boundVertexArrayObject-&gt;getElementArrayBuffer());
<a name="74" id="anc74"></a><span class="line-modified">477     case GraphicsContext3D::FRAMEBUFFER_BINDING:</span>
478         return m_framebufferBinding;
<a name="75" id="anc75"></a><span class="line-modified">479     case GraphicsContext3D::FRONT_FACE:</span>
480         return getUnsignedIntParameter(pname);
<a name="76" id="anc76"></a><span class="line-modified">481     case GraphicsContext3D::GENERATE_MIPMAP_HINT:</span>
482         return getUnsignedIntParameter(pname);
<a name="77" id="anc77"></a><span class="line-modified">483     case GraphicsContext3D::GREEN_BITS:</span>
484         return getIntParameter(pname);
<a name="78" id="anc78"></a><span class="line-modified">485     case GraphicsContext3D::IMPLEMENTATION_COLOR_READ_FORMAT:</span>
486         return getIntParameter(pname);
<a name="79" id="anc79"></a><span class="line-modified">487     case GraphicsContext3D::IMPLEMENTATION_COLOR_READ_TYPE:</span>
488         return getIntParameter(pname);
<a name="80" id="anc80"></a><span class="line-modified">489     case GraphicsContext3D::LINE_WIDTH:</span>
490         return getFloatParameter(pname);
<a name="81" id="anc81"></a><span class="line-modified">491     case GraphicsContext3D::MAX_COMBINED_TEXTURE_IMAGE_UNITS:</span>
492         return getIntParameter(pname);
<a name="82" id="anc82"></a><span class="line-modified">493     case GraphicsContext3D::MAX_CUBE_MAP_TEXTURE_SIZE:</span>
494         return getIntParameter(pname);
<a name="83" id="anc83"></a><span class="line-modified">495     case GraphicsContext3D::MAX_FRAGMENT_UNIFORM_VECTORS:</span>
496         return getIntParameter(pname);
<a name="84" id="anc84"></a><span class="line-modified">497     case GraphicsContext3D::MAX_RENDERBUFFER_SIZE:</span>
498         return getIntParameter(pname);
<a name="85" id="anc85"></a><span class="line-modified">499     case GraphicsContext3D::MAX_TEXTURE_IMAGE_UNITS:</span>
500         return getIntParameter(pname);
<a name="86" id="anc86"></a><span class="line-modified">501     case GraphicsContext3D::MAX_TEXTURE_SIZE:</span>
502         return getIntParameter(pname);
<a name="87" id="anc87"></a><span class="line-modified">503     case GraphicsContext3D::MAX_VARYING_VECTORS:</span>
504         return getIntParameter(pname);
<a name="88" id="anc88"></a><span class="line-modified">505     case GraphicsContext3D::MAX_VERTEX_ATTRIBS:</span>
506         return getIntParameter(pname);
<a name="89" id="anc89"></a><span class="line-modified">507     case GraphicsContext3D::MAX_VERTEX_TEXTURE_IMAGE_UNITS:</span>
508         return getIntParameter(pname);
<a name="90" id="anc90"></a><span class="line-modified">509     case GraphicsContext3D::MAX_VERTEX_UNIFORM_VECTORS:</span>
510         return getIntParameter(pname);
<a name="91" id="anc91"></a><span class="line-modified">511     case GraphicsContext3D::MAX_VIEWPORT_DIMS:</span>
512         return getWebGLIntArrayParameter(pname);
<a name="92" id="anc92"></a><span class="line-modified">513     case GraphicsContext3D::NUM_SHADER_BINARY_FORMATS:</span>
514         return getIntParameter(pname);
<a name="93" id="anc93"></a><span class="line-modified">515     case GraphicsContext3D::PACK_ALIGNMENT:</span>
516         return getIntParameter(pname);
<a name="94" id="anc94"></a><span class="line-modified">517     case GraphicsContext3D::POLYGON_OFFSET_FACTOR:</span>
518         return getFloatParameter(pname);
<a name="95" id="anc95"></a><span class="line-modified">519     case GraphicsContext3D::POLYGON_OFFSET_FILL:</span>
520         return getBooleanParameter(pname);
<a name="96" id="anc96"></a><span class="line-modified">521     case GraphicsContext3D::POLYGON_OFFSET_UNITS:</span>
522         return getFloatParameter(pname);
<a name="97" id="anc97"></a><span class="line-modified">523     case GraphicsContext3D::RED_BITS:</span>
524         return getIntParameter(pname);
<a name="98" id="anc98"></a><span class="line-modified">525     case GraphicsContext3D::RENDERBUFFER_BINDING:</span>
526         return m_renderbufferBinding;
<a name="99" id="anc99"></a><span class="line-modified">527     case GraphicsContext3D::RENDERER:</span>
528         return &quot;WebKit WebGL&quot;_str;
<a name="100" id="anc100"></a><span class="line-modified">529     case GraphicsContext3D::SAMPLE_BUFFERS:</span>
530         return getIntParameter(pname);
<a name="101" id="anc101"></a><span class="line-modified">531     case GraphicsContext3D::SAMPLE_COVERAGE_INVERT:</span>
532         return getBooleanParameter(pname);
<a name="102" id="anc102"></a><span class="line-modified">533     case GraphicsContext3D::SAMPLE_COVERAGE_VALUE:</span>
534         return getFloatParameter(pname);
<a name="103" id="anc103"></a><span class="line-modified">535     case GraphicsContext3D::SAMPLES:</span>
536         return getIntParameter(pname);
<a name="104" id="anc104"></a><span class="line-modified">537     case GraphicsContext3D::SCISSOR_BOX:</span>
538         return getWebGLIntArrayParameter(pname);
<a name="105" id="anc105"></a><span class="line-modified">539     case GraphicsContext3D::SCISSOR_TEST:</span>
540         return getBooleanParameter(pname);
<a name="106" id="anc106"></a><span class="line-modified">541     case GraphicsContext3D::SHADING_LANGUAGE_VERSION:</span>
<span class="line-modified">542         return &quot;WebGL GLSL ES 1.0 (&quot; + m_context-&gt;getString(GraphicsContext3D::SHADING_LANGUAGE_VERSION) + &quot;)&quot;;</span>
<span class="line-modified">543     case GraphicsContext3D::STENCIL_BACK_FAIL:</span>
544         return getUnsignedIntParameter(pname);
<a name="107" id="anc107"></a><span class="line-modified">545     case GraphicsContext3D::STENCIL_BACK_FUNC:</span>
546         return getUnsignedIntParameter(pname);
<a name="108" id="anc108"></a><span class="line-modified">547     case GraphicsContext3D::STENCIL_BACK_PASS_DEPTH_FAIL:</span>
548         return getUnsignedIntParameter(pname);
<a name="109" id="anc109"></a><span class="line-modified">549     case GraphicsContext3D::STENCIL_BACK_PASS_DEPTH_PASS:</span>
550         return getUnsignedIntParameter(pname);
<a name="110" id="anc110"></a><span class="line-modified">551     case GraphicsContext3D::STENCIL_BACK_REF:</span>
552         return getIntParameter(pname);
<a name="111" id="anc111"></a><span class="line-modified">553     case GraphicsContext3D::STENCIL_BACK_VALUE_MASK:</span>
554         return getUnsignedIntParameter(pname);
<a name="112" id="anc112"></a><span class="line-modified">555     case GraphicsContext3D::STENCIL_BACK_WRITEMASK:</span>
556         return getUnsignedIntParameter(pname);
<a name="113" id="anc113"></a><span class="line-modified">557     case GraphicsContext3D::STENCIL_BITS:</span>
558         if (!m_framebufferBinding &amp;&amp; !m_attributes.stencil)
559             return 0;
560         return getIntParameter(pname);
<a name="114" id="anc114"></a><span class="line-modified">561     case GraphicsContext3D::STENCIL_CLEAR_VALUE:</span>
562         return getIntParameter(pname);
<a name="115" id="anc115"></a><span class="line-modified">563     case GraphicsContext3D::STENCIL_FAIL:</span>
564         return getUnsignedIntParameter(pname);
<a name="116" id="anc116"></a><span class="line-modified">565     case GraphicsContext3D::STENCIL_FUNC:</span>
566         return getUnsignedIntParameter(pname);
<a name="117" id="anc117"></a><span class="line-modified">567     case GraphicsContext3D::STENCIL_PASS_DEPTH_FAIL:</span>
568         return getUnsignedIntParameter(pname);
<a name="118" id="anc118"></a><span class="line-modified">569     case GraphicsContext3D::STENCIL_PASS_DEPTH_PASS:</span>
570         return getUnsignedIntParameter(pname);
<a name="119" id="anc119"></a><span class="line-modified">571     case GraphicsContext3D::STENCIL_REF:</span>
572         return getIntParameter(pname);
<a name="120" id="anc120"></a><span class="line-modified">573     case GraphicsContext3D::STENCIL_TEST:</span>
574         return getBooleanParameter(pname);
<a name="121" id="anc121"></a><span class="line-modified">575     case GraphicsContext3D::STENCIL_VALUE_MASK:</span>
576         return getUnsignedIntParameter(pname);
<a name="122" id="anc122"></a><span class="line-modified">577     case GraphicsContext3D::STENCIL_WRITEMASK:</span>
578         return getUnsignedIntParameter(pname);
<a name="123" id="anc123"></a><span class="line-modified">579     case GraphicsContext3D::SUBPIXEL_BITS:</span>
580         return getIntParameter(pname);
<a name="124" id="anc124"></a><span class="line-modified">581     case GraphicsContext3D::TEXTURE_BINDING_2D:</span>
582         return m_textureUnits[m_activeTextureUnit].texture2DBinding;
<a name="125" id="anc125"></a><span class="line-modified">583     case GraphicsContext3D::TEXTURE_BINDING_CUBE_MAP:</span>
584         return m_textureUnits[m_activeTextureUnit].textureCubeMapBinding;
<a name="126" id="anc126"></a><span class="line-modified">585     case GraphicsContext3D::UNPACK_ALIGNMENT:</span>
586         return getIntParameter(pname);
<a name="127" id="anc127"></a><span class="line-modified">587     case GraphicsContext3D::UNPACK_FLIP_Y_WEBGL:</span>
588         return m_unpackFlipY;
<a name="128" id="anc128"></a><span class="line-modified">589     case GraphicsContext3D::UNPACK_PREMULTIPLY_ALPHA_WEBGL:</span>
590         return m_unpackPremultiplyAlpha;
<a name="129" id="anc129"></a><span class="line-modified">591     case GraphicsContext3D::UNPACK_COLORSPACE_CONVERSION_WEBGL:</span>
592         return m_unpackColorspaceConversion;
<a name="130" id="anc130"></a><span class="line-modified">593     case GraphicsContext3D::VENDOR:</span>
594         return &quot;WebKit&quot;_str;
<a name="131" id="anc131"></a><span class="line-modified">595     case GraphicsContext3D::VERSION:</span>
596         return &quot;WebGL 1.0&quot;_str;
<a name="132" id="anc132"></a><span class="line-modified">597     case GraphicsContext3D::VIEWPORT:</span>
598         return getWebGLIntArrayParameter(pname);
<a name="133" id="anc133"></a><span class="line-modified">599     case Extensions3D::FRAGMENT_SHADER_DERIVATIVE_HINT_OES: // OES_standard_derivatives</span>
600         if (m_oesStandardDerivatives)
<a name="134" id="anc134"></a><span class="line-modified">601             return getUnsignedIntParameter(Extensions3D::FRAGMENT_SHADER_DERIVATIVE_HINT_OES);</span>
<span class="line-modified">602         synthesizeGLError(GraphicsContext3D::INVALID_ENUM, &quot;getParameter&quot;, &quot;invalid parameter name, OES_standard_derivatives not enabled&quot;);</span>
603         return nullptr;
604     case WebGLDebugRendererInfo::UNMASKED_RENDERER_WEBGL:
605         if (m_webglDebugRendererInfo) {
606 #if PLATFORM(IOS_FAMILY)
607             return &quot;Apple GPU&quot;_str;
608 #else
<a name="135" id="anc135"></a><span class="line-modified">609             return m_context-&gt;getString(GraphicsContext3D::RENDERER);</span>
610 #endif
611         }
<a name="136" id="anc136"></a><span class="line-modified">612         synthesizeGLError(GraphicsContext3D::INVALID_ENUM, &quot;getParameter&quot;, &quot;invalid parameter name, WEBGL_debug_renderer_info not enabled&quot;);</span>
613         return nullptr;
614     case WebGLDebugRendererInfo::UNMASKED_VENDOR_WEBGL:
615         if (m_webglDebugRendererInfo)
<a name="137" id="anc137"></a><span class="line-modified">616             return m_context-&gt;getString(GraphicsContext3D::VENDOR);</span>
<span class="line-modified">617         synthesizeGLError(GraphicsContext3D::INVALID_ENUM, &quot;getParameter&quot;, &quot;invalid parameter name, WEBGL_debug_renderer_info not enabled&quot;);</span>
618         return nullptr;
<a name="138" id="anc138"></a><span class="line-modified">619     case Extensions3D::VERTEX_ARRAY_BINDING_OES: // OES_vertex_array_object</span>
620         if (m_oesVertexArrayObject) {
621             if (m_boundVertexArrayObject-&gt;isDefaultObject())
622                 return nullptr;
623             return makeRefPtr(static_cast&lt;WebGLVertexArrayObjectOES&amp;&gt;(*m_boundVertexArrayObject));
624         }
<a name="139" id="anc139"></a><span class="line-modified">625         synthesizeGLError(GraphicsContext3D::INVALID_ENUM, &quot;getParameter&quot;, &quot;invalid parameter name, OES_vertex_array_object not enabled&quot;);</span>
626         return nullptr;
<a name="140" id="anc140"></a><span class="line-modified">627     case Extensions3D::MAX_TEXTURE_MAX_ANISOTROPY_EXT: // EXT_texture_filter_anisotropic</span>
628         if (m_extTextureFilterAnisotropic)
<a name="141" id="anc141"></a><span class="line-modified">629             return getUnsignedIntParameter(Extensions3D::MAX_TEXTURE_MAX_ANISOTROPY_EXT);</span>
<span class="line-modified">630         synthesizeGLError(GraphicsContext3D::INVALID_ENUM, &quot;getParameter&quot;, &quot;invalid parameter name, EXT_texture_filter_anisotropic not enabled&quot;);</span>
631         return nullptr;
<a name="142" id="anc142"></a><span class="line-modified">632     case Extensions3D::MAX_COLOR_ATTACHMENTS_EXT: // EXT_draw_buffers BEGIN</span>
633         if (m_webglDrawBuffers)
634             return getMaxColorAttachments();
<a name="143" id="anc143"></a><span class="line-modified">635         synthesizeGLError(GraphicsContext3D::INVALID_ENUM, &quot;getParameter&quot;, &quot;invalid parameter name, WEBGL_draw_buffers not enabled&quot;);</span>
636         return nullptr;
<a name="144" id="anc144"></a><span class="line-modified">637     case Extensions3D::MAX_DRAW_BUFFERS_EXT:</span>
638         if (m_webglDrawBuffers)
639             return getMaxDrawBuffers();
<a name="145" id="anc145"></a><span class="line-modified">640         synthesizeGLError(GraphicsContext3D::INVALID_ENUM, &quot;getParameter&quot;, &quot;invalid parameter name, WEBGL_draw_buffers not enabled&quot;);</span>
641         return nullptr;
642     default:
643         if (m_webglDrawBuffers
<a name="146" id="anc146"></a><span class="line-modified">644             &amp;&amp; pname &gt;= Extensions3D::DRAW_BUFFER0_EXT</span>
<span class="line-modified">645             &amp;&amp; pname &lt; static_cast&lt;GC3Denum&gt;(Extensions3D::DRAW_BUFFER0_EXT + getMaxDrawBuffers())) {</span>
<span class="line-modified">646             GC3Dint value = GraphicsContext3D::NONE;</span>
647             if (m_framebufferBinding)
648                 value = m_framebufferBinding-&gt;getDrawBuffer(pname);
649             else // emulated backbuffer
650                 value = m_backDrawBuffer;
651             return value;
652         }
<a name="147" id="anc147"></a><span class="line-modified">653         synthesizeGLError(GraphicsContext3D::INVALID_ENUM, &quot;getParameter&quot;, &quot;invalid parameter name&quot;);</span>
654         return nullptr;
655     }
656 }
657 
<a name="148" id="anc148"></a><span class="line-modified">658 GC3Dint WebGLRenderingContext::getMaxDrawBuffers()</span>
659 {
660     if (!supportsDrawBuffers())
661         return 0;
662     if (!m_maxDrawBuffers)
<a name="149" id="anc149"></a><span class="line-modified">663         m_context-&gt;getIntegerv(Extensions3D::MAX_DRAW_BUFFERS_EXT, &amp;m_maxDrawBuffers);</span>
664     if (!m_maxColorAttachments)
<a name="150" id="anc150"></a><span class="line-modified">665         m_context-&gt;getIntegerv(Extensions3D::MAX_COLOR_ATTACHMENTS_EXT, &amp;m_maxColorAttachments);</span>
666     // WEBGL_draw_buffers requires MAX_COLOR_ATTACHMENTS &gt;= MAX_DRAW_BUFFERS.
667     return std::min(m_maxDrawBuffers, m_maxColorAttachments);
668 }
669 
<a name="151" id="anc151"></a><span class="line-modified">670 GC3Dint WebGLRenderingContext::getMaxColorAttachments()</span>
671 {
672     if (!supportsDrawBuffers())
673         return 0;
674     if (!m_maxColorAttachments)
<a name="152" id="anc152"></a><span class="line-modified">675         m_context-&gt;getIntegerv(Extensions3D::MAX_COLOR_ATTACHMENTS_EXT, &amp;m_maxColorAttachments);</span>
676     return m_maxColorAttachments;
677 }
678 
<a name="153" id="anc153"></a><span class="line-modified">679 bool WebGLRenderingContext::validateIndexArrayConservative(GC3Denum type, unsigned&amp; numElementsRequired)</span>
680 {
681     // Performs conservative validation by caching a maximum index of
682     // the given type per element array buffer. If all of the bound
683     // array buffers have enough elements to satisfy that maximum
684     // index, skips the expensive per-draw-call iteration in
685     // validateIndexArrayPrecise.
686 
687     RefPtr&lt;WebGLBuffer&gt; elementArrayBuffer = m_boundVertexArrayObject-&gt;getElementArrayBuffer();
688 
689     if (!elementArrayBuffer)
690         return false;
691 
<a name="154" id="anc154"></a><span class="line-modified">692     GC3Dsizeiptr numElements = elementArrayBuffer-&gt;byteLength();</span>
693     // The case count==0 is already dealt with in drawElements before validateIndexArrayConservative.
694     if (!numElements)
695         return false;
696     auto buffer = elementArrayBuffer-&gt;elementArrayBuffer();
697     ASSERT(buffer);
698 
699     Optional&lt;unsigned&gt; maxIndex = elementArrayBuffer-&gt;getCachedMaxIndex(type);
700     if (!maxIndex) {
701         // Compute the maximum index in the entire buffer for the given type of index.
702         switch (type) {
<a name="155" id="anc155"></a><span class="line-modified">703         case GraphicsContext3D::UNSIGNED_BYTE: {</span>
<span class="line-modified">704             const GC3Dubyte* p = static_cast&lt;const GC3Dubyte*&gt;(buffer-&gt;data());</span>
<span class="line-modified">705             for (GC3Dsizeiptr i = 0; i &lt; numElements; i++)</span>
706                 maxIndex = maxIndex ? std::max(maxIndex.value(), static_cast&lt;unsigned&gt;(p[i])) : static_cast&lt;unsigned&gt;(p[i]);
707             break;
708         }
<a name="156" id="anc156"></a><span class="line-modified">709         case GraphicsContext3D::UNSIGNED_SHORT: {</span>
<span class="line-modified">710             numElements /= sizeof(GC3Dushort);</span>
<span class="line-modified">711             const GC3Dushort* p = static_cast&lt;const GC3Dushort*&gt;(buffer-&gt;data());</span>
<span class="line-modified">712             for (GC3Dsizeiptr i = 0; i &lt; numElements; i++)</span>
713                 maxIndex = maxIndex ? std::max(maxIndex.value(), static_cast&lt;unsigned&gt;(p[i])) : static_cast&lt;unsigned&gt;(p[i]);
714             break;
715         }
<a name="157" id="anc157"></a><span class="line-modified">716         case GraphicsContext3D::UNSIGNED_INT: {</span>
717             if (!m_oesElementIndexUint)
718                 return false;
<a name="158" id="anc158"></a><span class="line-modified">719             numElements /= sizeof(GC3Duint);</span>
<span class="line-modified">720             const GC3Duint* p = static_cast&lt;const GC3Duint*&gt;(buffer-&gt;data());</span>
<span class="line-modified">721             for (GC3Dsizeiptr i = 0; i &lt; numElements; i++)</span>
722                 maxIndex = maxIndex ? std::max(maxIndex.value(), static_cast&lt;unsigned&gt;(p[i])) : static_cast&lt;unsigned&gt;(p[i]);
723             break;
724         }
725         default:
726             return false;
727         }
728         if (maxIndex)
729             elementArrayBuffer-&gt;setCachedMaxIndex(type, maxIndex.value());
730     }
731 
732     if (!maxIndex)
733         return false;
734 
735     // The number of required elements is one more than the maximum index that will be accessed.
736     auto checkedNumElementsRequired = checkedAddAndMultiply&lt;unsigned&gt;(maxIndex.value(), 1, 1);
737     if (!checkedNumElementsRequired)
738         return false;
739     numElementsRequired = checkedNumElementsRequired.value();
740 
741     return true;
742 }
743 
<a name="159" id="anc159"></a><span class="line-modified">744 bool WebGLRenderingContext::validateBlendEquation(const char* functionName, GC3Denum mode)</span>
745 {
746     switch (mode) {
<a name="160" id="anc160"></a><span class="line-modified">747     case GraphicsContext3D::FUNC_ADD:</span>
<span class="line-modified">748     case GraphicsContext3D::FUNC_SUBTRACT:</span>
<span class="line-modified">749     case GraphicsContext3D::FUNC_REVERSE_SUBTRACT:</span>
<span class="line-modified">750     case Extensions3D::MIN_EXT:</span>
<span class="line-modified">751     case Extensions3D::MAX_EXT:</span>
<span class="line-modified">752         if ((mode == Extensions3D::MIN_EXT || mode == Extensions3D::MAX_EXT) &amp;&amp; !m_extBlendMinMax) {</span>
<span class="line-modified">753             synthesizeGLError(GraphicsContext3D::INVALID_ENUM, functionName, &quot;invalid mode&quot;);</span>
754             return false;
755         }
756         return true;
757         break;
758     default:
<a name="161" id="anc161"></a><span class="line-modified">759         synthesizeGLError(GraphicsContext3D::INVALID_ENUM, functionName, &quot;invalid mode&quot;);</span>
760         return false;
761     }
762 }
763 
<a name="162" id="anc162"></a><span class="line-modified">764 bool WebGLRenderingContext::validateCapability(const char* functionName, GC3Denum cap)</span>
765 {
766     switch (cap) {
<a name="163" id="anc163"></a><span class="line-modified">767     case GraphicsContext3D::BLEND:</span>
<span class="line-modified">768     case GraphicsContext3D::CULL_FACE:</span>
<span class="line-modified">769     case GraphicsContext3D::DEPTH_TEST:</span>
<span class="line-modified">770     case GraphicsContext3D::DITHER:</span>
<span class="line-modified">771     case GraphicsContext3D::POLYGON_OFFSET_FILL:</span>
<span class="line-modified">772     case GraphicsContext3D::SAMPLE_ALPHA_TO_COVERAGE:</span>
<span class="line-modified">773     case GraphicsContext3D::SAMPLE_COVERAGE:</span>
<span class="line-modified">774     case GraphicsContext3D::SCISSOR_TEST:</span>
<span class="line-modified">775     case GraphicsContext3D::STENCIL_TEST:</span>
776         return true;
777     default:
<a name="164" id="anc164"></a><span class="line-modified">778         synthesizeGLError(GraphicsContext3D::INVALID_ENUM, functionName, &quot;invalid capability&quot;);</span>
779         return false;
780     }
781 }
782 
783 } // namespace WebCore
784 
785 #endif // ENABLE(WEBGL)
<a name="165" id="anc165"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="165" type="hidden" />
</body>
</html>