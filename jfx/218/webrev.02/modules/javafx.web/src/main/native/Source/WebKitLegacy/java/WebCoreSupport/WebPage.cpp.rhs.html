<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/WebKitLegacy/java/WebCoreSupport/WebPage.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 2011, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.  Oracle designates this
   8  * particular file as subject to the &quot;Classpath&quot; exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
  23  * questions.
  24  */
  25 
  26 
  27 #if COMPILER(GCC) || COMPILER(CLANG)
  28 #pragma GCC diagnostic ignored &quot;-Wunused-parameter&quot;
  29 #endif
  30 
  31 #include &quot;WebPage.h&quot;
  32 
  33 #include &quot;BackForwardList.h&quot;
  34 #include &quot;ChromeClientJava.h&quot;
  35 #include &quot;ContextMenuClientJava.h&quot;
  36 #include &quot;ContextMenuJava.h&quot;
  37 #include &quot;DragClientJava.h&quot;
  38 #include &quot;EditorClientJava.h&quot;
  39 #include &quot;FrameLoaderClientJava.h&quot;
  40 #include &quot;InspectorClientJava.h&quot;
  41 #include &quot;PageStorageSessionProvider.h&quot;
  42 #include &quot;PlatformStrategiesJava.h&quot;
  43 #include &quot;ProgressTrackerClientJava.h&quot;
  44 #include &quot;VisitedLinkStoreJava.h&quot;
  45 #include &quot;WebKitLegacy/Storage/StorageNamespaceImpl.h&quot;
  46 #include &quot;WebKitLegacy/Storage/WebDatabaseProvider.h&quot;
  47 #include &quot;WebKitVersion.h&quot; //generated
  48 #include &quot;WebPageConfig.h&quot;
  49 #include &lt;WebCore/WebCoreTestSupport.h&gt;
  50 #include &lt;JavaScriptCore/APICast.h&gt;
  51 #include &lt;JavaScriptCore/InitializeThreading.h&gt;
  52 #include &lt;JavaScriptCore/JSContextRef.h&gt;
  53 #include &lt;JavaScriptCore/JSContextRefPrivate.h&gt;
  54 #include &lt;JavaScriptCore/JSStringRef.h&gt;
  55 #include &lt;JavaScriptCore/Options.h&gt;
  56 #include &lt;WebCore/BackForwardController.h&gt;
  57 #include &lt;WebCore/BridgeUtils.h&gt;
  58 #include &lt;WebCore/CharacterData.h&gt;
  59 #include &lt;WebCore/Chrome.h&gt;
<a name="1" id="anc1"></a><span class="line-added">  60 #include &lt;WebCore/CompositionHighlight.h&gt;</span>
  61 #include &lt;WebCore/ContextMenu.h&gt;
  62 #include &lt;WebCore/ContextMenuController.h&gt;
  63 #include &lt;WebCore/CookieJar.h&gt;
  64 #include &lt;WebCore/DeprecatedGlobalSettings.h&gt;
  65 #include &lt;WebCore/Document.h&gt;
  66 #include &lt;WebCore/DragController.h&gt;
  67 #include &lt;WebCore/DragData.h&gt;
  68 #include &lt;WebCore/Editor.h&gt;
  69 #include &lt;WebCore/EmptyClients.h&gt;
  70 #include &lt;WebCore/EventHandler.h&gt;
  71 #include &lt;WebCore/FloatRect.h&gt;
  72 #include &lt;WebCore/FloatSize.h&gt;
  73 #include &lt;WebCore/FocusController.h&gt;
  74 #include &lt;WebCore/Frame.h&gt;
  75 #include &lt;WebCore/FrameLoadRequest.h&gt;
  76 #include &lt;WebCore/FrameTree.h&gt;
  77 #include &lt;WebCore/FrameView.h&gt;
  78 #include &lt;WebCore/GCController.h&gt;
  79 #include &lt;WebCore/GeolocationClientMock.h&gt;
  80 #include &lt;WebCore/GraphicsContext.h&gt;
  81 #include &lt;WebCore/GraphicsLayerTextureMapper.h&gt;
  82 #include &lt;WebCore/InspectorController.h&gt;
  83 #include &lt;WebCore/KeyboardEvent.h&gt;
  84 #include &lt;WebCore/NodeTraversal.h&gt;
  85 #include &lt;WebCore/Page.h&gt;
  86 #include &lt;WebCore/PageConfiguration.h&gt;
  87 #include &lt;WebCore/PageSupplementJava.h&gt;
  88 #include &lt;WebCore/PlatformContextJava.h&gt;
  89 #include &lt;WebCore/PlatformJavaClasses.h&gt;
  90 #include &lt;WebCore/PlatformKeyboardEvent.h&gt;
  91 #include &lt;WebCore/PlatformMouseEvent.h&gt;
  92 #include &lt;WebCore/PlatformTouchEvent.h&gt;
  93 #include &lt;WebCore/PlatformWheelEvent.h&gt;
  94 #include &lt;WebCore/RenderTreeAsText.h&gt;
  95 #include &lt;WebCore/RenderView.h&gt;
  96 #include &lt;WebCore/ResourceRequest.h&gt;
  97 #include &lt;WebCore/RuntimeEnabledFeatures.h&gt;
  98 #include &lt;WebCore/ScriptController.h&gt;
  99 #include &lt;WebCore/SecurityPolicy.h&gt;
 100 #include &lt;WebCore/Settings.h&gt;
 101 #include &lt;WebCore/StorageNamespaceProvider.h&gt;
 102 #include &lt;WebCore/TextIterator.h&gt;
 103 #include &lt;WebCore/TextureMapperJava.h&gt;
 104 #include &lt;WebCore/TextureMapperLayer.h&gt;
 105 #include &lt;WebCore/WorkerThread.h&gt;
 106 #include &lt;wtf/Ref.h&gt;
 107 #include &lt;wtf/RunLoop.h&gt;
 108 #include &lt;wtf/java/JavaRef.h&gt;
 109 #include &lt;wtf/text/WTFString.h&gt;
 110 
 111 // FIXME: Move dependency of runtime_root to BridgeUtils
 112 #include &lt;WebCore/runtime_root.h&gt;
 113 #if OS(UNIX)
 114 #include &lt;sys/utsname.h&gt;
 115 #endif
 116 #if OS(WINDOWS)
 117 #include &lt;WebCore/SystemInfo.h&gt;
 118 #endif
 119 
 120 
 121 #include &quot;com_sun_webkit_WebPage.h&quot;
 122 #include &quot;com_sun_webkit_event_WCFocusEvent.h&quot;
 123 #include &quot;com_sun_webkit_event_WCKeyEvent.h&quot;
 124 #include &quot;com_sun_webkit_event_WCMouseEvent.h&quot;
 125 
 126 #if ENABLE(NOTIFICATIONS) || ENABLE(LEGACY_NOTIFICATIONS)
 127 #include &lt;WebCore/NotificationController.h&gt;
 128 #include &quot;NotificationClientJava.h&quot;
 129 #endif
 130 
 131 namespace WebCore {
 132 
 133 WebPage::WebPage(std::unique_ptr&lt;Page&gt; page)
 134     : m_page(WTFMove(page))
 135 {
 136 #if ENABLE(NOTIFICATIONS) || ENABLE(LEGACY_NOTIFICATIONS)
 137     if(!NotificationController::from(m_page.get())) {
 138         provideNotification(m_page.get(), NotificationClientJava::instance());
 139     }
 140 #endif
 141 }
 142 
 143 WebPage::~WebPage()
 144 {
 145     debugEnded();
 146 }
 147 
 148 WebPage* WebPage::webPageFromJObject(const JLObject&amp; oWebPage)
 149 {
 150     JNIEnv* env = WTF::GetJavaEnv();
 151 
 152     static jmethodID midGetPageMethod = env-&gt;GetMethodID(
 153         PG_GetWebPageClass(env),
 154         &quot;getPage&quot;,
 155         &quot;()J&quot;);
 156     ASSERT(midGetPageMethod);
 157 
 158     jlong p = env-&gt;CallLongMethod(oWebPage, midGetPageMethod);
 159     WTF::CheckAndClearException(env);
 160 
 161     return webPageFromJLong(p);
 162 }
 163 
 164 JLObject WebPage::jobjectFromPage(Page* page)
 165 {
 166     if (!page)
 167         return nullptr;
 168 
 169     auto pageSupplement = PageSupplementJava::from(page);
 170     return pageSupplement ? pageSupplement-&gt;jWebPage() : nullptr;
 171 }
 172 
 173 void WebPage::setSize(const IntSize&amp; size)
 174 {
 175     Frame* mainFrame = (Frame*)&amp;m_page-&gt;mainFrame();
 176 
 177     FrameView* frameView = mainFrame-&gt;view();
 178     if (!frameView) {
 179         return;
 180     }
 181 
 182     frameView-&gt;resize(size);
 183     frameView-&gt;layoutContext().scheduleLayout();
 184 
 185     if (m_rootLayer) {
 186         m_rootLayer-&gt;setSize(size);
 187         m_rootLayer-&gt;setNeedsDisplay();
 188     }
 189 }
 190 
 191 static void drawDebugLed(GraphicsContext&amp; context,
 192                          const IntRect&amp; rect,
 193                          const Color&amp; color)
 194 {
 195     const int w = 50;
 196     const int h = 50;
 197     FloatRect ledRect(
 198             rect.x() + rect.width() / 2 - w / 2,
 199             rect.y() + rect.height() / 2 - h / 2,
 200             w,
 201             h);
 202     context.fillRect(ledRect, color);
 203 }
 204 
 205 static void drawDebugBorder(GraphicsContext&amp; context,
 206                             const IntRect&amp; rect,
 207                             const Color&amp; color,
 208                             int width)
 209 {
 210     int x = rect.x();
 211     int y = rect.y();
 212     int w = rect.width();
 213     int h = rect.height();
 214     context.fillRect(FloatRect(x, y, w, width));
 215     context.fillRect(FloatRect(x, y + h - width, w, width), color);
 216     context.fillRect(FloatRect(x, y, width, h), color);
 217     context.fillRect(FloatRect(x + w - width, y, width, h), color);
 218 }
 219 
 220 void WebPage::prePaint() {
 221     if (m_rootLayer) {
 222         if (m_syncLayers) {
 223             m_syncLayers = false;
 224             syncLayers();
 225         }
 226         return;
 227     }
 228 
 229     Frame* mainFrame = (Frame*)&amp;m_page-&gt;mainFrame();
 230     FrameView* frameView = mainFrame-&gt;view();
 231     if (frameView) {
 232         // Updating layout &amp; styles precedes normal painting.
 233         frameView-&gt;updateLayoutAndStyleIfNeededRecursive();
 234     }
 235 }
 236 
 237 RefPtr&lt;RQRef&gt; WebPage::jRenderTheme()
 238 {
 239     if (!m_jRenderTheme) {
 240         JNIEnv* env = WTF::GetJavaEnv();
 241         m_jRenderTheme = RQRef::create(PG_GetRenderThemeObjectFromPage(env, jobjectFromPage(m_page.get())));
 242     }
 243     return m_jRenderTheme;
 244 }
 245 
 246 void WebPage::paint(jobject rq, jint x, jint y, jint w, jint h)
 247 {
 248     if (m_rootLayer) {
 249         return;
 250     }
 251 
<a name="2" id="anc2"></a><span class="line-modified"> 252     // DBG_CHECKPOINTEX(&quot;twkUpdateContent&quot;, 15, 100);</span>
 253 
 254     RefPtr&lt;Frame&gt; mainFrame((Frame*)&amp;m_page-&gt;mainFrame());
 255     RefPtr&lt;FrameView&gt; frameView(mainFrame-&gt;view());
 256     if (!frameView) {
 257         return;
 258     }
 259 
 260     // Will be deleted by GraphicsContext destructor
 261     PlatformContextJava* ppgc = new PlatformContextJava(rq, jRenderTheme());
 262     GraphicsContext gc(ppgc);
 263 
 264     // TODO: Following JS synchronization is not necessary for single thread model
<a name="3" id="anc3"></a><span class="line-modified"> 265     JSGlobalContextRef globalContext = toGlobalRef(mainFrame-&gt;script().globalObject(mainThreadNormalWorld()));</span>
 266     JSC::JSLockHolder sw(toJS(globalContext)); // TODO-java: was JSC::APIEntryShim sw( toJS(globalContext) );
 267 
 268     frameView-&gt;paint(gc, IntRect(x, y, w, h));
 269     if (m_page-&gt;settings().showDebugBorders()) {
 270         drawDebugLed(gc, IntRect(x, y, w, h), Color(0, 0, 255, 128));
 271     }
 272 
 273     gc.platformContext()-&gt;rq().flushBuffer();
 274 }
 275 
 276 void WebPage::postPaint(jobject rq, jint x, jint y, jint w, jint h)
 277 {
 278     if (!m_page-&gt;inspectorController().highlightedNode()
 279             &amp;&amp; !m_rootLayer
 280     ) {
 281         return;
 282     }
 283 
 284     // Will be deleted by GraphicsContext destructor
 285     PlatformContextJava* ppgc = new PlatformContextJava(rq, jRenderTheme());
 286     GraphicsContext gc(ppgc);
 287 
 288     if (m_rootLayer) {
 289         if (m_syncLayers) {
 290             m_syncLayers = false;
 291             syncLayers();
 292         }
 293         renderCompositedLayers(gc, IntRect(x, y, w, h));
 294         if (m_page-&gt;settings().showDebugBorders()) {
 295             drawDebugLed(gc, IntRect(x, y, w, h), Color(0, 192, 0, 128));
 296         }
 297         if (downcast&lt;GraphicsLayerTextureMapper&gt;(m_rootLayer.get())-&gt;layer().descendantsOrSelfHaveRunningAnimations()) {
 298             requestJavaRepaint(pageRect());
 299         }
 300     }
 301 
 302     if (m_page-&gt;inspectorController().highlightedNode()) {
 303         m_page-&gt;inspectorController().drawHighlight(gc);
 304     }
 305 
 306     gc.platformContext()-&gt;rq().flushBuffer();
 307 }
 308 
 309 void WebPage::scroll(const IntSize&amp; scrollDelta,
 310                      const IntRect&amp; rectToScroll,
 311                      const IntRect&amp; clipRect)
 312 {
 313     if (m_rootLayer) {
 314         m_rootLayer-&gt;setNeedsDisplayInRect(rectToScroll);
 315         return;
 316     }
 317 
 318     JNIEnv* env = WTF::GetJavaEnv();
 319 
 320     static jmethodID mid = env-&gt;GetMethodID(
 321             PG_GetWebPageClass(env),
 322             &quot;fwkScroll&quot;,
 323             &quot;(IIIIII)V&quot;);
 324     ASSERT(mid);
 325 
 326     env-&gt;CallVoidMethod(
 327             jobjectFromPage(m_page.get()),
 328             mid,
 329             rectToScroll.x(),
 330             rectToScroll.y(),
 331             rectToScroll.width(),
 332             rectToScroll.height(),
 333             scrollDelta.width(),
 334             scrollDelta.height());
 335     WTF::CheckAndClearException(env);
 336 }
 337 
 338 void WebPage::repaint(const IntRect&amp; rect)
 339 {
 340     if (m_rootLayer) {
 341         m_rootLayer-&gt;setNeedsDisplayInRect(rect);
 342     }
 343     requestJavaRepaint(rect);
 344 }
 345 
 346 void WebPage::requestJavaRepaint(const IntRect&amp; rect)
 347 {
 348     JNIEnv* env = WTF::GetJavaEnv();
 349 
 350     static jmethodID mid = env-&gt;GetMethodID(
 351             PG_GetWebPageClass(env),
 352             &quot;fwkRepaint&quot;,
 353             &quot;(IIII)V&quot;);
 354     ASSERT(mid);
 355 
 356     env-&gt;CallVoidMethod(
 357             jobjectFromPage(m_page.get()),
 358             mid,
 359             rect.x(),
 360             rect.y(),
 361             rect.width(),
 362             rect.height());
 363     WTF::CheckAndClearException(env);
 364 }
 365 
 366 void WebPage::setRootChildLayer(GraphicsLayer* layer)
 367 {
 368     if (layer) {
 369         m_rootLayer = GraphicsLayer::create(nullptr, *this);
 370         m_rootLayer-&gt;setDrawsContent(true);
 371         m_rootLayer-&gt;setContentsOpaque(true);
 372         m_rootLayer-&gt;setSize(pageRect().size());
 373         m_rootLayer-&gt;setNeedsDisplay();
 374         m_rootLayer-&gt;addChild(*layer);
 375 
 376         m_textureMapper = TextureMapper::create();
 377         downcast&lt;GraphicsLayerTextureMapper&gt;(m_rootLayer.get())-&gt;layer()
 378                 .setTextureMapper(m_textureMapper.get());
 379     } else {
 380         m_rootLayer = nullptr;
 381         m_textureMapper.reset();
 382     }
 383 }
 384 
 385 void WebPage::setNeedsOneShotDrawingSynchronization()
 386 {
 387 }
 388 
 389 void WebPage::scheduleCompositingLayerSync()
 390 {
 391     markForSync();
 392 }
 393 
 394 void WebPage::markForSync()
 395 {
 396     if (!m_rootLayer) {
 397         return;
 398     }
 399     m_syncLayers = true;
 400     requestJavaRepaint(pageRect());
 401 }
 402 
 403 void WebPage::syncLayers()
 404 {
 405     if (!m_rootLayer) {
 406         return;
 407     }
 408 
 409     FrameView* frameView = m_page-&gt;mainFrame().view();
 410     if (!m_page-&gt;mainFrame().contentRenderer() || !frameView)
 411         return;
 412 
 413     frameView-&gt;updateLayoutAndStyleIfNeededRecursive();
 414     // Updating layout might have taken us out of compositing mode
 415     if (m_rootLayer) {
 416         m_rootLayer-&gt;flushCompositingStateForThisLayerOnly();
 417     }
 418 
 419     if (!frameView-&gt;flushCompositingStateIncludingSubframes())
 420         return;
 421 }
 422 
 423 IntRect WebPage::pageRect()
 424 {
 425     ChromeClient&amp; client = m_page-&gt;chrome().client();
 426     return IntRect(client.pageRect());
 427 }
 428 
 429 void WebPage::renderCompositedLayers(GraphicsContext&amp; context, const IntRect&amp; clip)
 430 {
 431     ASSERT(m_rootLayer);
 432     ASSERT(m_textureMapper);
 433 
 434     TextureMapperLayer&amp; rootTextureMapperLayer = downcast&lt;GraphicsLayerTextureMapper&gt;(*m_rootLayer).layer();
 435 
 436     static_cast&lt;TextureMapperJava&amp;&gt;(*m_textureMapper).setGraphicsContext(&amp;context);
 437     TransformationMatrix matrix;
 438     m_textureMapper-&gt;beginPainting();
 439     m_textureMapper-&gt;beginClip(matrix, clip);
 440     rootTextureMapperLayer.applyAnimationsRecursively(MonotonicTime::now());
 441     downcast&lt;GraphicsLayerTextureMapper&gt;(*m_rootLayer).updateBackingStoreIncludingSubLayers();
 442     rootTextureMapperLayer.paint();
 443     m_textureMapper-&gt;endClip();
 444     m_textureMapper-&gt;endPainting();
 445 }
 446 
 447 void WebPage::notifyAnimationStarted(const GraphicsLayer*, const String&amp; /*animationKey*/, MonotonicTime /*time*/)
 448 {
 449     ASSERT_NOT_REACHED();
 450 }
 451 
 452 void WebPage::notifyFlushRequired(const GraphicsLayer*)
 453 {
 454     markForSync();
 455 }
 456 
<a name="4" id="anc4"></a><span class="line-modified"> 457 void WebPage::paintContents(const GraphicsLayer*, GraphicsContext&amp; context, const FloatRect&amp; inClip, GraphicsLayerPaintBehavior)</span>




 458 {
 459     context.save();
 460     context.clip(inClip);
 461     m_page-&gt;mainFrame().view()-&gt;paint(context, enclosingIntRect(inClip));
 462     if (m_page-&gt;settings().showDebugBorders()) {
 463         drawDebugBorder(context, roundedIntRect(inClip), Color(0, 192, 0), 20);
 464     }
 465     context.restore();
 466 }
 467 
 468 bool WebPage::processKeyEvent(const PlatformKeyboardEvent&amp; event)
 469 {
 470     return event.type() == PlatformKeyboardEvent::Char
 471         ? charEvent(event)
 472         : keyEvent(event);
 473 }
 474 
 475 //
 476 // The below keyboard event handling code was adapted from
 477 // WebKit/chromium/src/WebViewImpl.cpp
 478 //
 479 
 480 static const int VKEY_PRIOR = com_sun_webkit_event_WCKeyEvent_VK_PRIOR;
 481 static const int VKEY_NEXT = com_sun_webkit_event_WCKeyEvent_VK_NEXT;
 482 static const int VKEY_END = com_sun_webkit_event_WCKeyEvent_VK_END;
 483 static const int VKEY_HOME = com_sun_webkit_event_WCKeyEvent_VK_HOME;
 484 static const int VKEY_LEFT = com_sun_webkit_event_WCKeyEvent_VK_LEFT;
 485 static const int VKEY_UP = com_sun_webkit_event_WCKeyEvent_VK_UP;
 486 static const int VKEY_RIGHT = com_sun_webkit_event_WCKeyEvent_VK_RIGHT;
 487 static const int VKEY_DOWN = com_sun_webkit_event_WCKeyEvent_VK_DOWN;
 488 
 489 bool WebPage::keyEvent(const PlatformKeyboardEvent&amp; event)
 490 {
 491     ASSERT((event.type() == PlatformKeyboardEvent::RawKeyDown)
 492         || (event.type() == PlatformKeyboardEvent::KeyDown)
 493         || (event.type() == PlatformKeyboardEvent::KeyUp));
 494 
 495     // Please refer to the comments explaining the m_suppressNextKeypressEvent
 496     // member.
 497     // The m_suppressNextKeypressEvent is set if the KeyDown is handled by
 498     // Webkit. A keyDown event is typically associated with a keyPress(char)
 499     // event and a keyUp event. We reset this flag here as this is a new keyDown
 500     // event.
 501     m_suppressNextKeypressEvent = false;
 502 
 503     RefPtr&lt;Frame&gt; frame = focusedWebCoreFrame();
 504     if (!frame)
 505         return false;
 506 
 507     EventHandler&amp; handler = frame-&gt;eventHandler();
 508 
 509     if (handler.keyEvent(event)) {
 510         if (event.type() == PlatformKeyboardEvent::RawKeyDown) {
 511             // Suppress the next keypress event unless the focused node
 512             // is a plug-in node. (Flash needs these keypress events to
 513             // handle non-US keyboards.)
 514             Node* node = focusedWebCoreNode();
 515             if (!node || !node-&gt;renderer()
 516                     || !node-&gt;renderer()-&gt;isEmbeddedObject())
 517                 m_suppressNextKeypressEvent = true;
 518         }
 519         return true;
 520     }
 521 
 522     return keyEventDefault(event);
 523 }
 524 
 525 bool WebPage::charEvent(const PlatformKeyboardEvent&amp; event)
 526 {
 527     ASSERT(event.type() == PlatformKeyboardEvent::Char);
 528 
 529     // Please refer to the comments explaining the m_suppressNextKeypressEvent
 530     // member.  The m_suppressNextKeypressEvent is set if the KeyDown is
 531     // handled by Webkit. A keyDown event is typically associated with a
 532     // keyPress(char) event and a keyUp event. We reset this flag here as it
 533     // only applies to the current keyPress event.
 534     bool suppress = m_suppressNextKeypressEvent;
 535     m_suppressNextKeypressEvent = false;
 536 
 537     Frame* frame = focusedWebCoreFrame();
 538     if (!frame)
 539         return suppress;
 540 
 541     EventHandler&amp; handler = frame-&gt;eventHandler();
 542 
 543     if (!suppress &amp;&amp; !handler.keyEvent(event))
 544         return keyEventDefault(event);
 545 
 546     return true;
 547 }
 548 
 549 bool WebPage::keyEventDefault(const PlatformKeyboardEvent&amp; event)
 550 {
 551     Frame* frame = focusedWebCoreFrame();
 552     if (!frame)
 553         return false;
 554 
 555     switch (event.type()) {
 556     case PlatformKeyboardEvent::RawKeyDown:
 557         if (event.modifiers() == PlatformKeyboardEvent::Modifier::ControlKey) {
 558             switch (event.windowsVirtualKeyCode()) {
 559             // Match FF behavior in the sense that Ctrl+home/end are the only
 560             // Ctrl // key combinations which affect scrolling. Safari is buggy
 561             // in the sense that it scrolls the page for all Ctrl+scrolling key
 562             // combinations. For e.g. Ctrl+pgup/pgdn/up/down, etc.
 563             case VKEY_HOME:
 564             case VKEY_END:
 565                 break;
 566             default:
 567                 return false;
 568             }
 569         }
 570         if (!event.shiftKey())
 571             return scrollViewWithKeyboard(event.windowsVirtualKeyCode(), event);
 572         break;
 573     default:
 574         break;
 575     }
 576     return false;
 577 }
 578 
 579 bool WebPage::scrollViewWithKeyboard(int keyCode, const PlatformKeyboardEvent&amp; event)
 580 {
 581     ScrollDirection scrollDirection;
 582     ScrollGranularity scrollGranularity;
 583 #if OS(DARWIN)
 584     if (event.metaKey()) {
 585         if (keyCode == VKEY_UP)
 586             keyCode = VKEY_HOME;
 587         else if (keyCode == VKEY_DOWN)
 588             keyCode = VKEY_END;
 589     }
 590     if (event.altKey()) {
 591         if (keyCode == VKEY_UP)
 592             keyCode = VKEY_PRIOR;
 593         else if (keyCode == VKEY_DOWN)
 594             keyCode = VKEY_NEXT;
 595     }
 596 #endif
 597     if (!mapKeyCodeForScroll(keyCode, &amp;scrollDirection, &amp;scrollGranularity))
 598         return false;
 599     return propagateScroll(scrollDirection, scrollGranularity);
 600 }
 601 
 602 bool WebPage::mapKeyCodeForScroll(int keyCode,
 603                                   ScrollDirection* scrollDirection,
 604                                   ScrollGranularity* scrollGranularity)
 605 {
 606     switch (keyCode) {
 607     case VKEY_LEFT:
 608         *scrollDirection = ScrollLeft;
 609         *scrollGranularity = ScrollByLine;
 610         break;
 611     case VKEY_RIGHT:
 612         *scrollDirection = ScrollRight;
 613         *scrollGranularity = ScrollByLine;
 614         break;
 615     case VKEY_UP:
 616         *scrollDirection = ScrollUp;
 617         *scrollGranularity = ScrollByLine;
 618         break;
 619     case VKEY_DOWN:
 620         *scrollDirection = ScrollDown;
 621         *scrollGranularity = ScrollByLine;
 622         break;
 623     case VKEY_HOME:
 624         *scrollDirection = ScrollUp;
 625         *scrollGranularity = ScrollByDocument;
 626         break;
 627     case VKEY_END:
 628         *scrollDirection = ScrollDown;
 629         *scrollGranularity = ScrollByDocument;
 630         break;
 631     case VKEY_PRIOR:  // page up
 632         *scrollDirection = ScrollUp;
 633         *scrollGranularity = ScrollByPage;
 634         break;
 635     case VKEY_NEXT:  // page down
 636         *scrollDirection = ScrollDown;
 637         *scrollGranularity = ScrollByPage;
 638         break;
 639     default:
 640         return false;
 641     }
 642 
 643     return true;
 644 }
 645 
 646 bool WebPage::propagateScroll(ScrollDirection scrollDirection,
 647                               ScrollGranularity scrollGranularity)
 648 {
 649     Frame* frame = focusedWebCoreFrame();
 650     if (!frame)
 651         return false;
 652 
 653     bool scrollHandled = frame-&gt;eventHandler().scrollOverflow(
 654             scrollDirection,
 655             scrollGranularity);
 656     Frame* currentFrame = frame;
 657     while (!scrollHandled &amp;&amp; currentFrame) {
 658         scrollHandled = currentFrame-&gt;view()-&gt;scroll(scrollDirection,
 659                                                      scrollGranularity);
 660         currentFrame = currentFrame-&gt;tree().parent();
 661     }
 662     return scrollHandled;
 663 }
 664 
 665 Frame* WebPage::focusedWebCoreFrame()
 666 {
 667     return &amp;m_page-&gt;focusController().focusedOrMainFrame();
 668 }
 669 
 670 Node* WebPage::focusedWebCoreNode()
 671 {
 672     Frame* frame = m_page-&gt;focusController().focusedFrame();
 673     if (!frame)
 674         return 0;
 675 
 676     Document* document = frame-&gt;document();
 677     if (!document)
 678         return 0;
 679 
 680     return (Node*)document-&gt;focusedElement();
 681 }
 682 
 683 //implemented in customized WebCore/page/java/DragControllerJava.cpp
 684 void setCopyKeyState(bool _copyKeyIsDown);
 685 
 686 static String agentOS()
 687 {
 688 #if OS(DARWIN)
 689 #if CPU(X86) || CPU(X86_64)
 690     return &quot;Macintosh; Intel Mac OS X&quot;;
 691 #else
 692     return &quot;Macintosh; PPC Mac OS X&quot;;
 693 #endif
 694 #elif OS(UNIX)
 695     struct utsname name;
 696     if (uname(&amp;name) != -1)
 697         return makeString(name.sysname, &#39; &#39;, name.machine);
 698 #elif OS(WINDOWS)
 699     return windowsVersionForUAString();
 700 #else
 701     notImplemented();
 702 #endif
 703     return &quot;Unknown&quot;;
 704 }
 705 
 706 static String defaultUserAgent()
 707 {
 708     static const auto userAgentString = makeNeverDestroyed([] {
 709         String wkVersion = makeString(
 710                               WEBKIT_MAJOR_VERSION, &quot;.&quot;, WEBKIT_MINOR_VERSION,
 711                               &quot; (KHTML, like Gecko) JavaFX/&quot;, JAVAFX_RELEASE_VERSION,
 712                               &quot; Safari/&quot;, WEBKIT_MAJOR_VERSION, &quot;.&quot;,  WEBKIT_MINOR_VERSION);
 713         return makeString(&quot;Mozilla/5.0 (&quot;, agentOS(), &quot;) AppleWebKit/&quot;, wkVersion);
 714     }());
 715     return userAgentString;
 716 }
 717 
 718 int WebPage::beginPrinting(float width, float height)
 719 {
 720     Frame* frame = (Frame*)&amp;m_page-&gt;mainFrame();
 721     if (!frame-&gt;document() || !frame-&gt;view())
 722         return 0;
 723     frame-&gt;document()-&gt;updateLayout();
 724 
 725     ASSERT(!m_printContext);
 726     m_printContext = std::unique_ptr&lt;PrintContext&gt;(new PrintContext(frame));
 727     m_printContext-&gt;begin(width, height);
 728     m_printContext-&gt;computePageRects(FloatRect(0, 0, width, height), 0, 0, 1, height);
 729     return m_printContext-&gt;pageCount();
 730 }
 731 
 732 void WebPage::endPrinting()
 733 {
 734     ASSERT(m_printContext);
 735     if (!m_printContext)
 736         return;
 737 
 738     m_printContext-&gt;end();
 739     m_printContext.reset();
 740 }
 741 
 742 void WebPage::print(GraphicsContext&amp; gc, int pageIndex, float pageWidth)
 743 {
 744     ASSERT(m_printContext);
 745     ASSERT(pageIndex &gt;= 0 &amp;&amp; pageIndex &lt; m_printContext-&gt;pageCount());
 746 
 747     if (!m_printContext || pageIndex &lt; 0 || pageIndex &gt;= (int)m_printContext-&gt;pageCount())
 748         return;
 749 
 750     gc.save();
 751     gc.translate(0, 0);
 752     m_printContext-&gt;spoolPage(gc, pageIndex, pageWidth);
 753     gc.restore();
 754     gc.platformContext()-&gt;rq().flushBuffer();
 755 }
 756 
 757 int WebPage::globalDebugSessionCounter = 0;
 758 
 759 void WebPage::debugStarted() {
 760     if (!m_isDebugging) {
 761         m_isDebugging = true;
 762         globalDebugSessionCounter++;
 763 
 764         disableWatchdog();
 765     }
 766 }
 767 void WebPage::debugEnded() {
 768     if (m_isDebugging) {
 769         m_isDebugging = false;
 770         globalDebugSessionCounter--;
 771 
 772         enableWatchdog();
 773     }
 774 }
 775 void WebPage::enableWatchdog() {
 776     if (globalDebugSessionCounter == 0) {
 777         JSContextGroupRef contextGroup = toRef(&amp;mainThreadNormalWorld().vm());
 778         JSContextGroupSetExecutionTimeLimit(contextGroup, 10, 0, 0);
 779     }
 780 }
 781 
 782 void WebPage::disableWatchdog() {
 783     if (globalDebugSessionCounter &gt; 0) {
 784         JSContextGroupRef contextGroup = toRef(&amp;(mainThreadNormalWorld().vm()));
 785         JSContextGroupClearExecutionTimeLimit(contextGroup);
 786     }
 787 }
 788 
 789 } // namespace WebCore
 790 
 791 using namespace WebCore;
 792 using namespace WTF;
 793 
 794 class WebStorageNamespaceProviderJava final : public WebCore::StorageNamespaceProvider {
 795 public:
 796     void setLocalStorageDatabasePath(const String&amp; path) {
 797         m_localStorageDatabasePath = path;
 798     }
 799 private:
 800     String m_localStorageDatabasePath;
 801 
 802     Ref&lt;StorageNamespace&gt; createSessionStorageNamespace(Page&amp; page, unsigned quota) override
 803     {
 804         return WebKit::StorageNamespaceImpl::createSessionStorageNamespace(quota, page.sessionID());
 805     }
 806 
 807     Ref&lt;StorageNamespace&gt; createLocalStorageNamespace(unsigned quota, PAL::SessionID sessionID) override
 808     {
 809         return WebKit::StorageNamespaceImpl::getOrCreateLocalStorageNamespace(m_localStorageDatabasePath, quota, sessionID);
 810     }
 811 
 812     Ref&lt;StorageNamespace&gt; createTransientLocalStorageNamespace(SecurityOrigin&amp;, unsigned quota, PAL::SessionID sessionID) override
 813     {
 814         // FIXME: A smarter implementation would create a special namespace type instead of just piggy-backing off
 815         // SessionStorageNamespace here.
 816         return WebKit::StorageNamespaceImpl::createSessionStorageNamespace(quota, sessionID);
 817     }
 818 };
 819 
 820 namespace {
 821 
 822 bool s_useJIT;
 823 bool s_useDFGJIT;
 824 bool s_useCSS3D;
 825 
 826 }  // namespace
 827 
 828 extern &quot;C&quot; {
 829 
 830 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkInitWebCore
 831     (JNIEnv* env, jclass self, jboolean useJIT, jboolean useDFGJIT, jboolean useCSS3D) {
 832     s_useJIT = useJIT;
 833     s_useDFGJIT = useDFGJIT;
 834     s_useCSS3D = useCSS3D;
 835 }
 836 
 837 JNIEXPORT jlong JNICALL Java_com_sun_webkit_WebPage_twkCreatePage
 838     (JNIEnv* env, jobject self, jboolean editable)
 839 {
 840     // FIXME-java(JDK-8169950): Refactor the following WebCore module
 841     // initialization flow.
 842     JSC::initializeThreading();
 843     WTF::initializeMainThread();
 844     RunLoop::initializeMainRunLoop();
 845     // RT-17330: Allow local loads for substitute data, that is,
 846     // for content loaded with twkLoad
 847     WebCore::SecurityPolicy::setLocalLoadPolicy(
 848             WebCore::SecurityPolicy::AllowLocalLoadsForLocalAndSubstituteData);
 849 
 850     //DBG_CHECKPOINTEX(&quot;twkCreatePage&quot;, 3, 5);
 851 
 852     VisitedLinkStoreJava::setShouldTrackVisitedLinks(true);
 853 
 854 #if !LOG_DISABLED
 855     WebKitInitializeLogChannelsIfNecessary();
 856 #endif
 857     WebCore::PlatformStrategiesJava::initialize();
 858 
 859     static std::once_flag initializeJSCOptions;
 860     std::call_once(initializeJSCOptions, [] {
 861         JSC::Options::useJIT() = s_useJIT;
 862         // Enable DFG only if JIT is enabled.
 863         JSC::Options::useDFGJIT() = s_useJIT &amp;&amp; s_useDFGJIT;
 864     });
 865 
 866     JLObject jlself(self, true);
 867 
 868     //utaTODO: history agent implementation
 869 
<a name="5" id="anc5"></a><span class="line-modified"> 870     auto pc = pageConfigurationWithEmptyClients(PAL::SessionID::defaultSessionID());</span>
 871     auto pageStorageSessionProvider = PageStorageSessionProvider::create();
 872     pc.cookieJar = CookieJar::create(pageStorageSessionProvider.copyRef());
 873     pc.chromeClient = new ChromeClientJava(jlself);
 874     pc.contextMenuClient = new ContextMenuClientJava(jlself);
 875     pc.editorClient = makeUniqueRef&lt;EditorClientJava&gt;(jlself);
<a name="6" id="anc6"></a><span class="line-modified"> 876     pc.dragClient = makeUnique&lt;DragClientJava&gt;(jlself);</span>
 877     pc.inspectorClient = new InspectorClientJava(jlself);
 878     pc.databaseProvider = &amp;WebDatabaseProvider::singleton();
 879     pc.storageNamespaceProvider = adoptRef(new WebStorageNamespaceProviderJava());
 880     pc.visitedLinkStore = VisitedLinkStoreJava::create();
 881 
 882     pc.loaderClientForMainFrame = new FrameLoaderClientJava(jlself);
<a name="7" id="anc7"></a><span class="line-modified"> 883     pc.progressTrackerClient = makeUniqueRef&lt;ProgressTrackerClientJava&gt;(jlself);</span>
 884 
 885     pc.backForwardClient = BackForwardList::create();
 886     auto page = std::make_unique&lt;Page&gt;(WTFMove(pc));
 887     // Associate PageSupplementJava instance which has WebPage java object.
 888     page-&gt;provideSupplement(PageSupplementJava::supplementName(), std::make_unique&lt;PageSupplementJava&gt;(self));
 889     pageStorageSessionProvider-&gt;setPage(*page);
 890 #if ENABLE(GEOLOCATION)
 891     WebCore::provideGeolocationTo(page.get(), *new GeolocationClientMock());
 892 #endif
 893     return ptr_to_jlong(new WebPage(WTFMove(page)));
 894 }
 895 
 896 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkInit
 897     (JNIEnv* env, jobject self, jlong pPage, jboolean usePlugins, jfloat devicePixelScale)
 898 {
 899     Page* page = WebPage::pageFromJLong(pPage);
 900 
 901     /* Initialization of the default settings */
 902     Settings&amp; settings = page-&gt;settings();
 903     settings.setTextAreasAreResizable(true);
 904     settings.setLoadsImagesAutomatically(true);
 905     settings.setMinimumFontSize(0);
 906     settings.setMinimumLogicalFontSize(5);
 907     settings.setAcceleratedCompositingEnabled(s_useCSS3D);
 908     settings.setScriptEnabled(true);
 909     settings.setJavaScriptCanOpenWindowsAutomatically(true);
 910     settings.setPluginsEnabled(usePlugins);
 911     settings.setDefaultFixedFontSize(13);
 912     settings.setDefaultFontSize(16);
 913     settings.setContextMenuEnabled(true);
 914     settings.setUserAgent(defaultUserAgent());
 915     settings.setMaximumHTMLParserDOMTreeDepth(180);
 916     settings.setXSSAuditorEnabled(true);
 917     settings.setInteractiveFormValidationEnabled(true);
 918 
 919     /* Using java logical fonts as defaults */
 920     settings.setSerifFontFamily(&quot;Serif&quot;);
 921     settings.setSansSerifFontFamily(&quot;SansSerif&quot;);
 922     settings.setFixedFontFamily(&quot;Monospaced&quot;);
 923     page-&gt;setDeviceScaleFactor(devicePixelScale);
 924 
 925     RuntimeEnabledFeatures::sharedFeatures().setLinkPrefetchEnabled(true);
 926     RuntimeEnabledFeatures::sharedFeatures().setInputTypeColorEnabled(true);
 927     static_cast&lt;FrameLoaderClientJava&amp;&gt;(page-&gt;mainFrame().loader().client())
 928                                             .setFrame(&amp;page-&gt;mainFrame());
 929 
 930     page-&gt;mainFrame().init();
 931 
 932     JSContextGroupRef contextGroup = toRef(&amp;(mainThreadNormalWorld().vm()));
 933     JSContextGroupSetExecutionTimeLimit(contextGroup, 10, 0, 0);
 934 
 935     WebPage::webPageFromJLong(pPage)-&gt;enableWatchdog();
 936 }
 937 
 938 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkDestroyPage
 939     (JNIEnv* env, jobject self, jlong pPage)
 940 {
 941     WebPage* webPage = WebPage::webPageFromJLong(pPage);
 942     if (!webPage) {
 943         return;
 944     }
 945 
 946     Frame* mainFrame = (Frame*)&amp;webPage-&gt;page()-&gt;mainFrame();
 947     if (mainFrame) {
 948         mainFrame-&gt;loader().stopAllLoaders();
 949         mainFrame-&gt;loader().detachFromParent();
 950     }
 951 
 952     delete webPage;
 953 }
 954 
 955 JNIEXPORT jlong JNICALL Java_com_sun_webkit_WebPage_twkGetMainFrame
 956     (JNIEnv* env, jobject self, jlong pPage)
 957 {
 958     Page* page = WebPage::pageFromJLong(pPage);
 959     if (!page) {
 960         return 0;
 961     }
 962     Frame* mainFrame = (Frame*)&amp;page-&gt;mainFrame();
 963     if (!mainFrame) {
 964         return 0;
 965     }
 966     return ptr_to_jlong(mainFrame);
 967 }
 968 
 969 JNIEXPORT jlong JNICALL Java_com_sun_webkit_WebPage_twkGetParentFrame
 970     (JNIEnv* env, jobject self, jlong pFrame)
 971 {
 972     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
 973     if (!frame) {
 974         return 0;
 975     }
 976     Frame* parentFrame = frame-&gt;tree().parent();
 977     if (!parentFrame) {
 978         return 0;
 979     }
 980     return ptr_to_jlong(parentFrame);
 981 }
 982 
 983 JNIEXPORT jlongArray JNICALL Java_com_sun_webkit_WebPage_twkGetChildFrames
 984     (JNIEnv* env, jobject self, jlong pFrame)
 985 {
 986     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
 987     if (!frame) {
 988         return 0;
 989     }
 990 
 991     FrameTree&amp; tree = frame-&gt;tree();
 992 
 993     jlongArray jArray = env-&gt;NewLongArray(tree.childCount());
 994     jlong *arr = env-&gt;GetLongArrayElements(jArray, 0);
 995     int i = 0;
 996     for (Frame* child = tree.firstChild(); child; child = child-&gt;tree().nextSibling()) {
 997         arr[i++] = ptr_to_jlong(child);
 998     }
 999     env-&gt;ReleaseLongArrayElements(jArray, arr, 0);
1000 
1001     return jArray;
1002 }
1003 
1004 JNIEXPORT jstring JNICALL Java_com_sun_webkit_WebPage_twkGetName
1005     (JNIEnv* env, jobject self, jlong pFrame)
1006 {
1007     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1008     if (!frame) {
1009         return 0;
1010     }
1011     return frame-&gt;tree().uniqueName().string().toJavaString(env).releaseLocal();
1012 }
1013 
1014 JNIEXPORT jstring JNICALL Java_com_sun_webkit_WebPage_twkGetURL
1015     (JNIEnv* env, jobject self, jlong pFrame)
1016 {
1017     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1018     if (!frame || !frame-&gt;document()) {
1019         return 0;
1020     }
1021     Document* doc = frame-&gt;document();
1022     if (!doc) {
1023         return 0;
1024     }
1025     return doc-&gt;url().string().toJavaString(env).releaseLocal();
1026 }
1027 
1028 JNIEXPORT jstring JNICALL Java_com_sun_webkit_WebPage_twkGetInnerText
1029     (JNIEnv* env, jobject self, jlong pFrame)
1030 {
1031     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1032     if (!frame) {
1033         return 0;
1034     }
1035 
1036     Document* document = frame-&gt;document();
1037     if (!document) {
1038         return 0;
1039     }
1040 
1041     Element* documentElement = document-&gt;documentElement();
1042     if (!documentElement) {
1043         return 0;
1044     }
1045 
1046     FrameView* frameView = frame-&gt;view();
1047     if (frameView &amp;&amp; frameView-&gt;layoutContext().isLayoutPending()) {
1048         frameView-&gt;layoutContext().layout();
1049     }
1050 
1051     return documentElement-&gt;innerText().toJavaString(env).releaseLocal();
1052 }
1053 
1054 JNIEXPORT jstring JNICALL Java_com_sun_webkit_WebPage_twkGetRenderTree
1055     (JNIEnv* env, jobject self, jlong pFrame)
1056 {
1057     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1058     if (!frame || !frame-&gt;contentRenderer()) {
1059         return 0;
1060     }
1061 
1062     FrameView* frameView = frame-&gt;view();
1063     if (frameView &amp;&amp; frameView-&gt;layoutContext().isLayoutPending()) {
1064         frameView-&gt;layoutContext().layout();
1065     }
1066 
1067     return externalRepresentation(frame).toJavaString(env).releaseLocal();
1068 }
1069 
1070 JNIEXPORT jstring JNICALL Java_com_sun_webkit_WebPage_twkGetContentType
1071     (JNIEnv* env, jobject self, jlong pFrame)
1072 {
1073     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1074     if (!frame || !frame-&gt;loader().documentLoader()) {
1075         return 0;
1076     }
1077     return frame-&gt;loader().documentLoader()-&gt;responseMIMEType().toJavaString(env).releaseLocal();
1078 }
1079 
1080 JNIEXPORT jstring JNICALL Java_com_sun_webkit_WebPage_twkGetTitle
1081     (JNIEnv* env, jobject self, jlong pFrame)
1082 {
1083     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1084     if (!frame || !frame-&gt;document()) {
1085         return 0;
1086     }
1087     return frame-&gt;document()-&gt;title().toJavaString(env).releaseLocal();
1088 }
1089 
1090 JNIEXPORT jstring JNICALL Java_com_sun_webkit_WebPage_twkGetIconURL
1091     (JNIEnv* env, jobject self, jlong pFrame)
1092 {
1093     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1094     if (!frame) {
1095         return 0;
1096     }
1097 #if ENABLE(ICONDATABASE)
1098     return frame-&gt;loader()-&gt;icon()-&gt;url().string().toJavaString(env).releaseLocal();
1099 #else
1100     return 0;
1101 #endif
1102 }
1103 
1104 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkOpen
1105     (JNIEnv* env, jobject self, jlong pFrame, jstring url)
1106 {
1107     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1108     if (!frame) {
1109         return;
1110     }
1111 
1112     static const URL emptyParent;
1113 
<a name="8" id="anc8"></a><span class="line-modified">1114     FrameLoadRequest frameLoadRequest(</span>
1115         *frame,
1116         ResourceRequest(URL(emptyParent, String(env, url))),
1117         ShouldOpenExternalURLsPolicy::ShouldNotAllow // TODO-java: recheck policy value
<a name="9" id="anc9"></a><span class="line-modified">1118     );</span>
<span class="line-added">1119     frameLoadRequest.setIsRequestFromClientOrUserInput();</span>
<span class="line-added">1120     frame-&gt;loader().load(WTFMove(frameLoadRequest));</span>
1121 }
1122 
1123 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkLoad
1124     (JNIEnv* env, jobject self, jlong pFrame, jstring text, jstring contentType)
1125 {
1126     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1127     if (!frame) {
1128         return;
1129     }
1130 
1131     const char* stringChars = env-&gt;GetStringUTFChars(text, JNI_FALSE);
1132     size_t stringLen = (size_t)env-&gt;GetStringUTFLength(text);
1133     RefPtr&lt;SharedBuffer&gt; buffer = SharedBuffer::create(stringChars, (int)stringLen);
1134 
1135     static const URL emptyUrl({ }, &quot;&quot;);
1136     ResourceResponse response(URL(), String(env, contentType), stringLen, &quot;UTF-8&quot;);
<a name="10" id="anc10"></a><span class="line-modified">1137     FrameLoadRequest frameLoadRequest(</span>
1138         *frame,
1139         ResourceRequest(emptyUrl),
1140         ShouldOpenExternalURLsPolicy::ShouldNotAllow, // TODO-java: recheck policy value
1141         SubstituteData(
1142             WTFMove(buffer),
1143             URL(),
1144             response,
1145             SubstituteData::SessionHistoryVisibility::Visible) // TODO-java: or Hidden?
<a name="11" id="anc11"></a><span class="line-modified">1146     );</span>
<span class="line-added">1147     frameLoadRequest.setIsRequestFromClientOrUserInput();</span>
<span class="line-added">1148     frame-&gt;loader().load(WTFMove(frameLoadRequest));</span>
1149 
1150     env-&gt;ReleaseStringUTFChars(text, stringChars);
1151 }
1152 
1153 JNIEXPORT jboolean JNICALL Java_com_sun_webkit_WebPage_twkIsLoading
1154     (JNIEnv* env, jobject self, jlong pFrame)
1155 {
1156     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1157 
1158     return bool_to_jbool(frame &amp;&amp; frame-&gt;loader().isLoading());
1159 }
1160 
1161 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkStop
1162     (JNIEnv* env, jobject self, jlong pFrame)
1163 {
1164     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1165     if (!frame) {
1166         return;
1167     }
1168 
1169     frame-&gt;loader().stopAllLoaders();
1170 }
1171 
1172 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkStopAll
1173     (JNIEnv* env, jobject self, jlong pPage)
1174 {
1175     Page* page = WebPage::pageFromJLong(pPage);
1176     if (!page) {
1177         return;
1178     }
1179 
1180     page-&gt;mainFrame().loader().stopAllLoaders();
1181 }
1182 
1183 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkRefresh
1184     (JNIEnv* env, jobject self, jlong pFrame)
1185 {
1186     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1187     if (!frame) {
1188         return;
1189     }
1190 
1191     frame-&gt;loader().reload(ReloadOption::FromOrigin);
1192 }
1193 
1194 JNIEXPORT jboolean JNICALL Java_com_sun_webkit_WebPage_twkGoBackForward
1195     (JNIEnv* env, jobject self, jlong pPage, jint distance)
1196 {
1197     Page* page = WebPage::pageFromJLong(pPage);
1198     if (!page) {
1199         return JNI_FALSE;
1200     }
1201 
1202     if (page-&gt;backForward().canGoBackOrForward(distance)) {
1203         page-&gt;backForward().goBackOrForward(distance);
1204         return JNI_TRUE;
1205     }
1206 
1207     return JNI_FALSE;
1208 }
1209 
1210 JNIEXPORT jboolean JNICALL Java_com_sun_webkit_WebPage_twkCopy
1211     (JNIEnv* env, jobject self, jlong pFrame)
1212 {
1213     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1214     if (!frame) {
1215         return JNI_FALSE;
1216     }
1217 
1218     if (frame-&gt;editor().canCopy()) {
1219         frame-&gt;editor().copy();
1220         return JNI_TRUE;
1221     }
1222 
1223     return JNI_FALSE;
1224 }
1225 
1226 
1227 JNIEXPORT jboolean JNICALL Java_com_sun_webkit_WebPage_twkFindInPage
1228     (JNIEnv* env, jobject self, jlong pPage,
1229      jstring toFind, jboolean forward, jboolean wrap, jboolean matchCase)
1230 {
1231     Page* page = WebPage::pageFromJLong(pPage);
1232     if (page) {
1233         FindOptions opts;
1234         if (!matchCase)
1235             opts.add(CaseInsensitive);
1236         if (!forward)
1237             opts.add(Backwards);
1238         if (wrap)
1239             opts.add(WrapAround);
1240         return bool_to_jbool(page-&gt;findString(String(env, toFind), opts));
1241     }
1242     return JNI_FALSE;
1243 }
1244 
1245 JNIEXPORT jboolean JNICALL Java_com_sun_webkit_WebPage_twkFindInFrame
1246     (JNIEnv* env, jobject self, jlong pFrame,
1247      jstring toFind, jboolean forward, jboolean wrap, jboolean matchCase)
1248 {
1249     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1250     if (frame) {
1251         //utatodo: support for the rest of FindOptionFlag
1252         FindOptions opts;
1253         if (!matchCase)
1254             opts.add(CaseInsensitive);
1255         if (!forward)
1256             opts.add(Backwards);
1257         if (wrap)
1258             opts.add(WrapAround);
1259         return bool_to_jbool(frame-&gt;page()-&gt;findString(
1260             String(env, toFind), opts | StartInSelection));
1261     }
1262     return JNI_FALSE;
1263 }
1264 
1265 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkOverridePreference
1266     (JNIEnv* env, jobject self, jlong pPage, jstring propertyName, jstring propertyValue)
1267 {
1268     Page* page = WebPage::pageFromJLong(pPage);
1269     if (!page) {
1270         return;
1271     }
1272 
1273     Settings&amp; settings = page-&gt;settings();
1274     String nativePropertyName(env, propertyName);
1275     String nativePropertyValue(env, propertyValue);
1276 
1277     if (nativePropertyName == &quot;WebKitTextAreasAreResizable&quot;) {
1278         settings.setTextAreasAreResizable(nativePropertyValue.toInt());
1279     } else if (nativePropertyName == &quot;WebKitLoadsImagesAutomatically&quot;) {
1280         settings.setLoadsImagesAutomatically(nativePropertyValue.toInt());
1281     } else if (nativePropertyName == &quot;WebKitMinimumFontSize&quot;) {
1282         settings.setMinimumFontSize(nativePropertyValue.toInt());
1283     } else if (nativePropertyName == &quot;WebKitMinimumLogicalFontSize&quot;) {
1284         settings.setMinimumLogicalFontSize(nativePropertyValue.toInt());
1285     } else if (nativePropertyName == &quot;WebKitAcceleratedCompositingEnabled&quot;) {
1286         settings.setAcceleratedCompositingEnabled(nativePropertyValue.toInt());
1287     } else if (nativePropertyName == &quot;WebKitScriptEnabled&quot;) {
1288         settings.setScriptEnabled(nativePropertyValue.toInt());
1289     } else if (nativePropertyName == &quot;WebKitJavaScriptCanOpenWindowsAutomatically&quot;) {
1290         settings.setJavaScriptCanOpenWindowsAutomatically(nativePropertyValue.toInt());
1291     } else if (nativePropertyName == &quot;WebKitPluginsEnabled&quot;) {
1292         settings.setPluginsEnabled(nativePropertyValue.toInt());
1293     } else if (nativePropertyName == &quot;WebKitDefaultFixedFontSize&quot;) {
1294         settings.setDefaultFixedFontSize(nativePropertyValue.toInt());
1295     } else if (nativePropertyName == &quot;WebKitContextMenuEnabled&quot;) {
1296         settings.setContextMenuEnabled(nativePropertyValue.toInt());
1297     } else if (nativePropertyName == &quot;WebKitUserAgent&quot;) {
1298         settings.setUserAgent(nativePropertyValue);
1299     } else if (nativePropertyName == &quot;WebKitMaximumHTMLParserDOMTreeDepth&quot;) {
1300         settings.setMaximumHTMLParserDOMTreeDepth(nativePropertyValue.toUInt());
1301     } else if (nativePropertyName == &quot;WebKitXSSAuditorEnabled&quot;)  {
1302         settings.setXSSAuditorEnabled(nativePropertyValue.toInt());
1303     } else if (nativePropertyName == &quot;WebKitSerifFontFamily&quot;) {
1304         settings.setSerifFontFamily(nativePropertyValue);
1305     } else if (nativePropertyName == &quot;WebKitSansSerifFontFamily&quot;) {
1306         settings.setSansSerifFontFamily(nativePropertyValue);
1307     } else if (nativePropertyName == &quot;WebKitFixedFontFamily&quot;) {
1308         settings.setFixedFontFamily(nativePropertyValue);
1309     } else if (nativePropertyName == &quot;WebKitShowsURLsInToolTips&quot;) {
1310         settings.setShowsURLsInToolTips(nativePropertyValue.toInt());
<a name="12" id="anc12"></a>

1311     } else if (nativePropertyName == &quot;WebKitJavaScriptCanAccessClipboardPreferenceKey&quot;) {
1312         settings.setJavaScriptCanAccessClipboard(nativePropertyValue.toInt() != 0);
<a name="13" id="anc13"></a><span class="line-added">1313     } else if (nativePropertyName == &quot;allowTopNavigationToDataURLs&quot;) {</span>
<span class="line-added">1314         settings.setAllowTopNavigationToDataURLs(nativePropertyValue == &quot;true&quot;);</span>
<span class="line-added">1315     } else if (nativePropertyName == &quot;enableBackForwardCache&quot;) {</span>
<span class="line-added">1316         settings.setUsesBackForwardCache(nativePropertyValue == &quot;true&quot;);</span>
1317     } else if (nativePropertyName == &quot;enableColorFilter&quot;) {
1318         settings.setColorFilterEnabled(nativePropertyValue == &quot;true&quot;);
1319     } else if (nativePropertyName == &quot;enableKeygenElement&quot;) {
1320         // removed from Chrome, Firefox, and the HTML specification in 2017.
1321         // https://trac.webkit.org/changeset/248960/webkit
1322         RuntimeEnabledFeatures::sharedFeatures().setKeygenElementEnabled(nativePropertyValue == &quot;true&quot;);
1323     } else if (nativePropertyName == &quot;experimental:WebAnimationsCSSIntegrationEnabled&quot;) {
1324         RuntimeEnabledFeatures::sharedFeatures().setWebAnimationsCSSIntegrationEnabled(nativePropertyValue == &quot;true&quot;);
<a name="14" id="anc14"></a><span class="line-added">1325     } else if (nativePropertyName == &quot;experimental:CSSCustomPropertiesAndValuesEnabled&quot;) {</span>
<span class="line-added">1326         RuntimeEnabledFeatures::sharedFeatures().setCSSCustomPropertiesAndValuesEnabled(nativePropertyValue == &quot;true&quot;);</span>
1327     } else if (nativePropertyName == &quot;enableIntersectionObserver&quot;) {
1328 #if ENABLE(INTERSECTION_OBSERVER)
1329         RuntimeEnabledFeatures::sharedFeatures().setIntersectionObserverEnabled(nativePropertyValue == &quot;true&quot;);
1330 #endif
<a name="15" id="anc15"></a><span class="line-modified">1331     } else if (nativePropertyName == &quot;experimental:RequestIdleCallbackEnabled&quot;) {</span>
<span class="line-added">1332         settings.setRequestIdleCallbackEnabled(nativePropertyValue == &quot;true&quot;);</span>
<span class="line-added">1333     } else if (nativePropertyName == &quot;jscOptions&quot; &amp;&amp; !nativePropertyValue.isEmpty()) {</span>
1334         JSC::Options::setOptions(nativePropertyValue.utf8().data());
<a name="16" id="anc16"></a>

1335     }
1336 }
1337 
1338 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkResetToConsistentStateBeforeTesting
1339     (JNIEnv* env, jobject self, jlong pPage)
1340 {
1341     Page* page = WebPage::pageFromJLong(pPage);
1342     if (!page) {
1343         return;
1344     }
1345 
1346     Settings&amp; settings = page-&gt;settings();
1347 
1348     settings.setAllowUniversalAccessFromFileURLs(true);
1349     settings.setAllowFileAccessFromFileURLs(true);
1350     // settings.setStandardFontFamily(standardFamily);
1351     // settings.setFixedFontFamily(fixedFamily);
1352     // settings.setSerifFontFamily(standardFamily);
1353     // settings.setSansSerifFontFamily(sansSerifFamily);
1354     // settings.setCursiveFontFamily(cursiveFamily);
1355     // settings.setFantasyFontFamily(fantasyFamily);
1356     // settings.setPictographFontFamily(pictographFamily);
1357     settings.setDefaultFontSize(16);
1358     settings.setDefaultFixedFontSize(13);
1359     settings.setMinimumFontSize(0);
1360     settings.setDefaultTextEncodingName(&quot;ISO-8859-1&quot;);
1361     settings.setJavaEnabled(false);
1362     settings.setFullScreenEnabled(true);
1363     settings.setScriptEnabled(true);
1364     settings.setEditableLinkBehavior(EditableLinkOnlyLiveWithShiftKey);
1365     // settings.setTabsToLinks(false);
1366     settings.setDOMPasteAllowed(true);
1367     settings.setShouldPrintBackgrounds(true);
1368     // settings.setCacheModel(WebCacheModelDocumentBrowser);
1369     settings.setXSSAuditorEnabled(false);
1370     settings.setExperimentalNotificationsEnabled(false);
1371     settings.setPluginsEnabled(true);
1372     settings.setTextAreasAreResizable(true);
<a name="17" id="anc17"></a><span class="line-modified">1373     settings.setUsesBackForwardCache(false);</span>
1374     settings.setCSSOMViewScrollingAPIEnabled(true);
<a name="18" id="anc18"></a><span class="line-added">1375     settings.setRequestIdleCallbackEnabled(true);</span>
1376 
1377     // settings.setPrivateBrowsingEnabled(false);
<a name="19" id="anc19"></a><span class="line-added">1378     settings.setAllowTopNavigationToDataURLs(true);</span>
1379     settings.setAuthorAndUserStylesEnabled(true);
1380     // Shrinks standalone images to fit: YES
1381     settings.setJavaScriptCanOpenWindowsAutomatically(true);
1382     settings.setJavaScriptCanAccessClipboard(true);
1383     settings.setOfflineWebApplicationCacheEnabled(true);
1384     // settings.setDeveloperExtrasEnabled(false);
1385     settings.setJavaScriptRuntimeFlags(JSC::RuntimeFlags(0));
1386     // Set JS experiments enabled: YES
1387     settings.setLoadsImagesAutomatically(true);
1388     settings.setLoadsSiteIconsIgnoringImageLoadingSetting(false);
1389     settings.setFrameFlattening(FrameFlattening::Disabled);
1390     settings.setFontRenderingMode(FontRenderingMode::Normal);
1391     // Doesn&#39;t work well with DRT
1392     settings.setScrollAnimatorEnabled(false);
1393     // Set spatial navigation enabled: NO
1394 
1395     // Set WebGL Enabled: NO
1396     // settings.setCSSRegionsEnabled(true);
1397     // Set uses HTML5 parser quirks: NO
1398     // Async spellcheck: NO
1399     DeprecatedGlobalSettings::setMockScrollbarsEnabled(true);
1400 
<a name="20" id="anc20"></a><span class="line-modified">1401     RuntimeEnabledFeatures::sharedFeatures().setHighlightAPIEnabled(true);</span>
1402     RuntimeEnabledFeatures::sharedFeatures().setFetchAPIEnabled(true);
1403     RuntimeEnabledFeatures::sharedFeatures().setShadowDOMEnabled(true);
1404     RuntimeEnabledFeatures::sharedFeatures().setCustomElementsEnabled(true);
1405     RuntimeEnabledFeatures::sharedFeatures().setModernMediaControlsEnabled(false);
1406     RuntimeEnabledFeatures::sharedFeatures().setResourceTimingEnabled(true);
1407     RuntimeEnabledFeatures::sharedFeatures().setUserTimingEnabled(true);
1408     RuntimeEnabledFeatures::sharedFeatures().setDataTransferItemsEnabled(true);
1409     RuntimeEnabledFeatures::sharedFeatures().setInspectorAdditionsEnabled(true);
1410     RuntimeEnabledFeatures::sharedFeatures().setWebAnimationsEnabled(true);
1411     // RuntimeEnabledFeatures::sharedFeatures().clearNetworkLoaderSession();
1412 
1413     Frame&amp; coreFrame = page-&gt;mainFrame();
<a name="21" id="anc21"></a><span class="line-modified">1414     auto globalContext = toGlobalRef(coreFrame.script().globalObject(mainThreadNormalWorld()));</span>
1415     WebCoreTestSupport::resetInternalsObject(globalContext);
1416 }
1417 
1418 JNIEXPORT jfloat JNICALL Java_com_sun_webkit_WebPage_twkGetZoomFactor
1419     (JNIEnv* env, jobject self, jlong pFrame, jboolean textOnly)
1420 {
1421     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1422     ASSERT(frame);
1423     if (!frame) {
1424         return 1.0;
1425     }
1426     return textOnly
1427         ? frame-&gt;textZoomFactor()
1428         : frame-&gt;pageZoomFactor();
1429 }
1430 
1431 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkSetZoomFactor
1432     (JNIEnv* env, jobject self, jlong pFrame, jfloat zoomFactor, jboolean textOnly)
1433 {
1434     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1435     ASSERT(frame);
1436     if (!frame) {
1437         return;
1438     }
1439     if (textOnly) {
1440         frame-&gt;setTextZoomFactor(zoomFactor);
1441     } else {
1442         frame-&gt;setPageZoomFactor(zoomFactor);
1443     }
1444 }
1445 
1446 JNIEXPORT jobject JNICALL Java_com_sun_webkit_WebPage_twkExecuteScript
1447     (JNIEnv* env, jobject self, jlong pFrame, jstring script)
1448 {
1449     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1450     if (!frame) {
1451         return nullptr;
1452     }
1453     JSGlobalContextRef globalContext = getGlobalContext(&amp;frame-&gt;script());
1454     RefPtr&lt;JSC::Bindings::RootObject&gt; rootObject(frame-&gt;script().createRootObject(frame));
1455     return WebCore::executeScript(
1456         env,
1457         nullptr,
1458         globalContext,
1459         rootObject.get(),
1460         script);
1461 }
1462 
1463 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkAddJavaScriptBinding
1464     (JNIEnv* env, jobject self, jlong pFrame, jstring name, jobject value, jobject accessControlContext)
1465 {
1466     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1467     if (!frame) {
1468         return;
1469     }
1470     JSGlobalContextRef globalContext = getGlobalContext(&amp;frame-&gt;script());
1471     JSObjectRef window = JSContextGetGlobalObject(globalContext);
1472     RefPtr&lt;JSC::Bindings::RootObject&gt; rootObject(frame-&gt;script().createRootObject(frame));
1473 
1474     JSValueRef jsval = WebCore::Java_Object_to_JSValue(
1475         env,
1476         globalContext,
1477         rootObject.get(),
1478         value, accessControlContext);
1479 
1480     JSStringRef jsname = asJSStringRef(env, name);
1481     JSValueRef exception;
1482     if (JSValueIsUndefined(globalContext, jsval)) {
1483         JSObjectDeleteProperty(globalContext, window, jsname, &amp;exception);
1484     } else {
1485         JSPropertyAttributes attributes = 0;
1486         JSObjectSetProperty(globalContext, window, jsname, jsval, attributes, &amp;exception);
1487     }
1488     JSStringRelease(jsname);
1489 }
1490 
1491 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkReset
1492     (JNIEnv* env, jobject self, jlong pFrame)
1493 {
1494     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1495     if (!frame) {
1496         return;
1497     }
1498 
1499     frame-&gt;tree().clearName();
1500 }
1501 
1502 JNIEXPORT jint JNICALL Java_com_sun_webkit_WebPage_twkBeginPrinting
1503     (JNIEnv* env, jobject self, jlong pPage, jfloat width, jfloat height)
1504 {
1505     return WebPage::webPageFromJLong(pPage)-&gt;beginPrinting(width, height);
1506 }
1507 
1508 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkEndPrinting
1509     (JNIEnv* env, jobject self, jlong pPage)
1510 {
1511     return WebPage::webPageFromJLong(pPage)-&gt;endPrinting();
1512 }
1513 
1514 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkPrint
1515     (JNIEnv* env, jobject self, jlong pPage, jobject rq, jint pageIndex, jfloat width)
1516 {
1517     auto webPage = WebPage::webPageFromJLong(pPage);
1518     PlatformContextJava* ppgc = new PlatformContextJava(rq, webPage-&gt;jRenderTheme());
1519     GraphicsContext gc(ppgc);
1520     webPage-&gt;print(gc, pageIndex, width);
1521 }
1522 
1523 JNIEXPORT jint JNICALL Java_com_sun_webkit_WebPage_twkGetFrameHeight
1524     (JNIEnv* env, jobject self, jlong pFrame)
1525 {
1526     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1527     if (!frame || !frame-&gt;contentRenderer()) {
1528         return 0;
1529     }
1530 
1531     return frame-&gt;contentRenderer()-&gt;viewLogicalHeight();
1532 /*
1533     bool isFrameSet = frame-&gt;document() &amp;&amp; frame-&gt;document()-&gt;isFrameSet();
1534     if (isFrameSet) {
1535         RenderView* root = static_cast&lt;RenderView*&gt;(frame-&gt;document()-&gt;renderer());
1536         return root-&gt;bottomLayoutOverflow();
1537     } else {
1538         return frame-&gt;contentRenderer()-&gt;bottomLayoutOverflow();
1539     }
1540 */
1541 }
1542 
1543 JNIEXPORT jfloat JNICALL Java_com_sun_webkit_WebPage_twkAdjustFrameHeight
1544     (JNIEnv* env, jobject self, jlong pFrame,
1545      jfloat oldTop, jfloat oldBottom, jfloat bottomLimit)
1546 {
1547     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1548     if (!frame || !frame-&gt;view()) {
1549         return oldBottom;
1550     }
1551 
1552     float result;
1553     frame-&gt;view()-&gt;adjustPageHeightDeprecated(&amp;result, oldTop, oldBottom, bottomLimit);
1554     return result;
1555 }
1556 
1557 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkSetBounds
1558     (JNIEnv* env, jobject self, jlong pPage, jint x, jint y, jint w, jint h)
1559 {
1560     WebPage::webPageFromJLong(pPage)-&gt;setSize(IntSize(w, h));
1561 }
1562 
1563 JNIEXPORT jintArray JNICALL Java_com_sun_webkit_WebPage_twkGetVisibleRect
1564     (JNIEnv* env, jobject self, jlong pFrame)
1565 {
1566     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1567     if (!frame || !frame-&gt;view()) {
1568         return nullptr;
1569     }
1570     IntRect rect = frame-&gt;view()-&gt;visibleContentRect();
1571 
1572     jintArray result = env-&gt;NewIntArray(4);
1573     WTF::CheckAndClearException(env);
1574 
1575     jint* arr = (jint*)env-&gt;GetPrimitiveArrayCritical(result, nullptr);
1576     arr[0] = rect.x();
1577     arr[1] = rect.y();
1578     arr[2] = rect.width();
1579     arr[3] = rect.height();
1580     env-&gt;ReleasePrimitiveArrayCritical(result, arr, 0);
1581 
1582     return result;
1583 }
1584 
1585 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkScrollToPosition
1586     (JNIEnv* env, jobject self, jlong pFrame, jint x, jint y)
1587 {
1588     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1589     if (!frame || !frame-&gt;view()) {
1590         return;
1591     }
1592     frame-&gt;view()-&gt;setScrollPosition(IntPoint(x, y));
1593 }
1594 
1595 JNIEXPORT jintArray JNICALL Java_com_sun_webkit_WebPage_twkGetContentSize
1596     (JNIEnv* env, jobject self, jlong pFrame)
1597 {
1598     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1599     if (!frame || !frame-&gt;view()) {
1600         return nullptr;
1601     }
1602     IntSize size = frame-&gt;view()-&gt;contentsSize();
1603 
1604     jintArray result = env-&gt;NewIntArray(2);
1605     WTF::CheckAndClearException(env);
1606 
1607     jint* arr = (jint*)env-&gt;GetPrimitiveArrayCritical(result, nullptr);
1608     arr[0] = size.width();
1609     arr[1] = size.height();
1610     env-&gt;ReleasePrimitiveArrayCritical(result, arr, 0);
1611 
1612     return result;
1613 }
1614 
1615 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkSetTransparent
1616 (JNIEnv* env, jobject self, jlong pFrame, jboolean isTransparent)
1617 {
1618     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1619     if (!frame || !frame-&gt;view()) {
1620         return;
1621     }
1622     frame-&gt;view()-&gt;setTransparent(isTransparent);
1623 }
1624 
1625 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkSetBackgroundColor
1626 (JNIEnv* env, jobject self, jlong pFrame, jint backgroundColor)
1627 {
1628     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1629     if (!frame || !frame-&gt;view()) {
1630         return;
1631     }
1632     frame-&gt;view()-&gt;setBaseBackgroundColor(Color(RGBA32(backgroundColor)));
1633 }
1634 
1635 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkPrePaint
1636   (JNIEnv*, jobject, jlong pPage)
1637 {
1638     WebPage::webPageFromJLong(pPage)-&gt;prePaint();
1639 }
1640 
1641 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkUpdateContent
1642     (JNIEnv* env, jobject self, jlong pPage, jobject rq, jint x, jint y, jint w, jint h)
1643 {
1644     WebPage::webPageFromJLong(pPage)-&gt;paint(rq, x, y, w, h);
1645 }
1646 
<a name="22" id="anc22"></a><span class="line-added">1647 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkUpdateRendering</span>
<span class="line-added">1648     (JNIEnv*, jobject, jlong pPage)</span>
<span class="line-added">1649 {</span>
<span class="line-added">1650     WebPage::pageFromJLong(pPage)-&gt;updateRendering();</span>
<span class="line-added">1651 }</span>
<span class="line-added">1652 </span>
1653 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkPostPaint
1654   (JNIEnv*, jobject, jlong pPage, jobject rq, jint x, jint y, jint w, jint h)
1655 {
1656     WebPage::webPageFromJLong(pPage)-&gt;postPaint(rq, x, y, w, h);
1657 }
1658 
1659 JNIEXPORT jstring JNICALL Java_com_sun_webkit_WebPage_twkGetEncoding
1660     (JNIEnv* env, jobject self, jlong pPage)
1661 {
1662     Page* p = WebPage::pageFromJLong(pPage);
1663     ASSERT(p);
1664     Frame* mainFrame = (Frame*)&amp;p-&gt;mainFrame();
1665     ASSERT(mainFrame);
1666 
1667     return mainFrame-&gt;document()-&gt;charset().toJavaString(env).releaseLocal();
1668 }
1669 
1670 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkSetEncoding
1671     (JNIEnv* env, jobject self, jlong pPage, jstring encoding)
1672 {
1673     Page* p = WebPage::pageFromJLong(pPage);
1674     ASSERT(p);
1675     Frame* mainFrame = (Frame*)&amp;p-&gt;mainFrame();
1676     ASSERT(mainFrame);
1677 
1678     mainFrame-&gt;loader().reloadWithOverrideEncoding(String(env, encoding));
1679 }
1680 
1681 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkProcessFocusEvent
1682     (JNIEnv* env, jobject self, jlong pPage,
1683      jint id, jint direction)
1684 {
1685     Page* page = WebPage::pageFromJLong(pPage);
1686     Frame* mainFrame = (Frame*)&amp;page-&gt;mainFrame();
1687 
1688     FocusController&amp; focusController = page-&gt;focusController();
1689 
1690     Frame* focusedFrame = focusController.focusedFrame();
1691     switch (id) {
1692         case com_sun_webkit_event_WCFocusEvent_FOCUS_GAINED:
1693             focusController.setActive(true); // window activation
1694             focusController.setFocused(true); // focus gained
1695             if (!focusedFrame) {
1696                 focusController.setFocusedFrame(mainFrame);
1697                 focusedFrame = mainFrame;
1698             }
1699             if (direction == com_sun_webkit_event_WCFocusEvent_FORWARD) {
1700                 // comment out the following line to get focus to the last
1701                 // focused node instead of the first focusable one
1702                 focusedFrame-&gt;document()-&gt;setFocusedElement(0);
1703                 focusController.advanceFocus(FocusDirectionForward, nullptr);
1704             } else if (direction == com_sun_webkit_event_WCFocusEvent_BACKWARD) {
1705                 // comment out the following line to get focus to the last
1706                 // focused node instead of the last focusable one
1707                 focusedFrame-&gt;document()-&gt;setFocusedElement(0);
1708                 focusController.advanceFocus(FocusDirectionBackward, nullptr);
1709             }
1710             break;
1711         case com_sun_webkit_event_WCFocusEvent_FOCUS_LOST:
1712             focusController.setFocused(false); // focus lost
1713             focusController.setActive(false); // window deactivation
1714             break;
1715     }
1716 }
1717 
1718 JNIEXPORT jboolean JNICALL Java_com_sun_webkit_WebPage_twkProcessKeyEvent
1719     (JNIEnv* env, jobject self, jlong pPage,
1720      jint type, jstring text, jstring keyIdentifier, jint windowsVirtualKeyCode,
1721      jboolean shift, jboolean ctrl, jboolean alt, jboolean meta, jdouble timestamp)
1722 {
1723     WebPage* webPage = WebPage::webPageFromJLong(pPage);
1724 
1725     PlatformKeyboardEvent event(type, text, keyIdentifier,
1726                                 windowsVirtualKeyCode,
1727                                 shift, ctrl, alt, meta, timestamp);
1728 
1729     return bool_to_jbool(webPage-&gt;processKeyEvent(event));
1730 }
1731 
1732 JNIEXPORT jboolean JNICALL Java_com_sun_webkit_WebPage_twkProcessMouseEvent
1733     (JNIEnv* env, jobject self, jlong pPage,
1734      jint id, jint button, jint clickCount,
1735      jint x, jint y, jint screenX, jint screenY,
1736      jboolean shift, jboolean ctrl, jboolean alt, jboolean meta,
1737      jboolean popupTrigger, jdouble timestamp)
1738 {
1739     Page* page = WebPage::pageFromJLong(pPage);
1740     Frame* frame = (Frame*)&amp;page-&gt;mainFrame();
1741 
1742     // Uncomment to debug mouse events
1743     // fprintf(stderr, &quot;twkProcessKeyEvent: &quot;
1744     //         &quot;id=%d button=%d clickCount=%d x=%d y=%d&quot;
1745     //         &quot;screenX=%d screenY=%d \n&quot;,
1746     //         id, button, clickCount, x, y, screenX, screenY);
1747 
1748     EventHandler&amp; eventHandler = frame-&gt;eventHandler();
1749 
1750     FrameView* frameView = frame-&gt;view();
1751     if (!frameView) {
1752         return false;
1753     }
1754 
1755     bool consumeEvent = false;
1756     IntPoint loc(x, y);
1757     PlatformMouseEvent mouseEvent = PlatformMouseEvent(loc,
1758                                                        IntPoint(screenX, screenY),
1759                                                        getWebCoreMouseButton(button),
1760                                                        getWebCoreMouseEventType(id),
1761                                                        clickCount,
1762                                                        shift, ctrl, alt, meta,
1763                                                        WallTime::fromRawSeconds(timestamp), ForceAtClick, NoTap); // TODO-java: handle force?
1764     switch (id) {
1765     case com_sun_webkit_event_WCMouseEvent_MOUSE_PRESSED:
1766         //frame-&gt;focusWindow();
1767         page-&gt;chrome().focus();
1768         consumeEvent = eventHandler.handleMousePressEvent(mouseEvent);
1769         break;
1770     case com_sun_webkit_event_WCMouseEvent_MOUSE_RELEASED:
1771         consumeEvent = eventHandler.handleMouseReleaseEvent(mouseEvent);
1772         break;
1773     case com_sun_webkit_event_WCMouseEvent_MOUSE_MOVED:
1774     case com_sun_webkit_event_WCMouseEvent_MOUSE_DRAGGED:
1775         consumeEvent = eventHandler.mouseMoved(mouseEvent);
1776         break;
1777     }
1778 
1779     if (popupTrigger &amp;&amp; page-&gt;settings().isContextMenuEnabled()) {
1780         ContextMenuController&amp; cmc = page-&gt;contextMenuController();
1781         cmc.clearContextMenu();
1782         bool handleEvent = eventHandler.sendContextMenuEvent(mouseEvent);
1783         if (!handleEvent) {
1784             return consumeEvent;
1785         }
1786 
1787         ContextMenu* contextMenu = cmc.contextMenu();
1788         // right-click in disabled text area (and probably many other
1789         // scenarios) result in nullptr contextMenu here
1790         if (!contextMenu) {
1791             return consumeEvent;
1792         }
1793 
1794         Node* node = cmc.hitTestResult().innerNonSharedNode();
1795         if (!node) {
1796             return consumeEvent;
1797         }
1798 
1799         Frame* frame = node-&gt;document().frame();
1800         // we do not want to show context menu for frameset (see 6648628)
1801         if (frame &amp;&amp; !frame-&gt;document()-&gt;isFrameSet()) {
1802             ContextMenuJava(contextMenu-&gt;items()).show(&amp;cmc, self, loc);
1803         }
1804         return JNI_TRUE;
1805     }
1806 
1807     return bool_to_jbool(consumeEvent);
1808 }
1809 
1810 JNIEXPORT jboolean JNICALL Java_com_sun_webkit_WebPage_twkProcessMouseWheelEvent
1811     (JNIEnv* env, jobject self, jlong pPage,
1812      jint x, jint y, jint screenX, jint screenY,
1813      jfloat deltaX, jfloat deltaY,
1814      jboolean shift, jboolean ctrl, jboolean alt, jboolean meta,
1815      jdouble timestamp)
1816 {
1817     Page* page = WebPage::pageFromJLong(pPage);
1818     Frame* frame = (Frame*)&amp;page-&gt;mainFrame();
1819 
1820     PlatformWheelEvent wheelEvent = PlatformWheelEvent(IntPoint(x, y),
1821                                                        IntPoint(screenX, screenY),
1822                                                        deltaX, deltaY,
1823                                                        shift, ctrl, alt, meta);
1824     bool consumeEvent = frame-&gt;eventHandler().handleWheelEvent(wheelEvent);
1825 
1826     return bool_to_jbool(consumeEvent);
1827 }
1828 
1829 #if ENABLE(TOUCH_EVENTS)
1830 JNIEXPORT jboolean JNICALL Java_com_sun_webkit_WebPage_twkProcessTouchEvent
1831     (JNIEnv* env, jobject self, jlong pPage, jint id, jobject touchData,
1832      jboolean shift, jboolean ctrl, jboolean alt, jboolean meta, jfloat timestamp)
1833 {
1834     Page* page = WebPage::pageFromJLong(pPage);
1835     Frame* frame = page-&gt;mainFrame();
1836 
1837     ASSERT(frame-&gt;eventHandler());
1838     if (!frame-&gt;eventHandler()) {
1839         return JNI_FALSE;
1840     }
1841 
1842     PlatformTouchEvent ev(env, id, touchData, shift, ctrl, alt, meta, timestamp);
1843     bool consumeEvent = frame-&gt;eventHandler().handleTouchEvent(ev);
1844     return bool_to_jbool(consumeEvent);
1845 }
1846 #endif
1847 
1848 JNIEXPORT jboolean JNICALL Java_com_sun_webkit_WebPage_twkProcessInputTextChange
1849     (JNIEnv* env, jobject self, jlong pPage,
1850      jstring jcommitted, jstring jcomposed, jintArray jattributes, jint caretPosition)
1851 {
1852     Page* page = WebPage::pageFromJLong(pPage);
1853 
1854     Frame* frame = (Frame*)&amp;page-&gt;focusController().focusedOrMainFrame();
1855     ASSERT(frame);
1856 
1857     if (!frame || !frame-&gt;editor().canEdit()) {
1858         // There&#39;s no client to deliver the event. Consume the event
1859         // so that it won&#39;t be delivered to a wrong webkit client.
1860         return JNI_TRUE;
1861     }
1862 
1863     // Process committed text first
1864     if (env-&gt;GetStringLength(jcommitted) &gt; 0 ||
1865             // if both committed and composed are empty, confirm with an empty text
1866             (env-&gt;GetStringLength(jcomposed) == 0)) {
1867         String committed = String(env, jcommitted);
1868         frame-&gt;editor().confirmComposition(committed);
1869     }
1870 
1871     // Process composed (composition) text here
1872     if (env-&gt;GetStringLength(jcomposed) &gt; 0) {
1873         jsize length = env-&gt;GetArrayLength(jattributes);
1874         Vector&lt;CompositionUnderline&gt; underlines;
1875         underlines.resize(length / 3); // 3 members per element
1876         jint* attrs = env-&gt;GetIntArrayElements(jattributes, nullptr);
1877         if (attrs) {
1878             for (int i = 0; i &lt; length;) {
1879                 int x = i / 3;
1880                 underlines[x].startOffset = attrs[i++];
1881                 underlines[x].endOffset = attrs[i++];
1882                 underlines[x].thick = (attrs[i++] == 1);
1883                 underlines[x].color = Color(0, 0, 0);
1884             }
1885             env-&gt;ReleaseIntArrayElements(jattributes, attrs, JNI_ABORT);
1886         }
1887         String composed = String(env, jcomposed);
<a name="23" id="anc23"></a><span class="line-modified">1888         frame-&gt;editor().setComposition(composed, underlines, { }, caretPosition, 0);</span>
1889     }
1890     return JNI_TRUE;
1891 }
1892 
1893 JNIEXPORT jboolean JNICALL Java_com_sun_webkit_WebPage_twkProcessCaretPositionChange
1894     (JNIEnv* env, jobject self, jlong pPage,
1895      jint caretPosition)
1896 {
1897     Page* page = WebPage::pageFromJLong(pPage);
1898 
1899     Frame* frame = (Frame*)&amp;page-&gt;focusController().focusedOrMainFrame();
1900 
1901     ASSERT(frame);
1902 
1903     Text* text = frame-&gt;editor().compositionNode();
1904     if (!text) {
1905         return JNI_FALSE;
1906     }
1907 
1908     // FIXME: the following code may not work with having committed text
1909     Position position(text, caretPosition);
1910     VisibleSelection selection(position, DOWNSTREAM);
1911     frame-&gt;selection().setSelection(selection /*, default is CharacterGranularity*/);//true, false, false
1912     return JNI_TRUE;
1913 }
1914 
1915 JNIEXPORT jintArray JNICALL Java_com_sun_webkit_WebPage_twkGetTextLocation
1916     (JNIEnv* env, jobject self, jlong pPage, jint charindex)
1917 {
1918     Page* page = WebPage::pageFromJLong(pPage);
1919     Frame&amp; frame = page-&gt;mainFrame();
1920 
1921     jintArray result = env-&gt;NewIntArray(4);
1922     WTF::CheckAndClearException(env); // OOME
1923 
1924     FrameView* frameView = frame.view();
1925     if (frameView) {
1926         IntRect caret = frame.selection().absoluteCaretBounds();
1927         caret = frameView-&gt;contentsToWindow(caret);
1928         jint* ints = (jint*) env-&gt;GetPrimitiveArrayCritical(result, nullptr);
1929         ints[0] = caret.x();
1930         ints[1] = caret.y();
1931         ints[2] = caret.width();
1932         ints[3] = caret.height();
1933         env-&gt;ReleasePrimitiveArrayCritical(result, ints, JNI_ABORT);
1934     }
1935 
1936     return result;
1937 }
1938 
1939 JNIEXPORT jint JNICALL Java_com_sun_webkit_WebPage_twkGetLocationOffset
1940     (JNIEnv* env, jobject self, jlong pPage, jint x, jint y)
1941 {
1942     // Returns -1 if there&#39;s no composition text or the given
1943     // coordinate is out of the composition text range.
1944 
1945     Page* page = WebPage::pageFromJLong(pPage);
1946     Frame* frame = (Frame*)&amp;page-&gt;mainFrame();
1947 
1948     FrameView* frameView = frame-&gt;view();
1949     if (!frameView) {
1950         return 0;
1951     }
1952 
1953     jint offset = -1;
1954     IntPoint point {x, y};
1955     point = frameView-&gt;windowToContents(point);
1956 
1957     Editor &amp;editor = frame-&gt;editor();
1958     if (editor.hasComposition()) {
1959         RefPtr&lt;Range&gt; range = editor.compositionRange();
1960         for (Node* node = &amp;range-&gt;startContainer(); node; node = NodeTraversal::next(*node)) {
1961             RenderObject* renderer = node-&gt;renderer();
1962             IntRect content = renderer-&gt;absoluteBoundingBoxRect();
1963             VisiblePosition targetPosition(renderer-&gt;positionForPoint(LayoutPoint(point.x() - content.x(),
1964                                                                             point.y() - content.y()), nullptr)); // TODO-java: recheck nullptr
1965             offset = targetPosition.deepEquivalent().offsetInContainerNode();
1966             if (offset &gt;= (jint)editor.compositionStart() &amp;&amp; offset &lt; (jint)editor.compositionEnd()) {
1967                 offset -= editor.compositionStart();
1968                 break;
1969             }
1970         }
1971     }
1972     return offset;
1973 }
1974 
1975 JNIEXPORT jint JNICALL Java_com_sun_webkit_WebPage_twkGetInsertPositionOffset
1976     (JNIEnv *env, jobject self, jlong pPage)
1977 {
1978     Page* page = WebPage::pageFromJLong(pPage);
1979     Frame* frame = (Frame*)&amp;page-&gt;mainFrame();
1980 
1981     jint position = 0;
1982     Editor &amp;editor = frame-&gt;editor();
1983     if (editor.canEdit()) {
1984         VisibleSelection selection = frame-&gt;selection().selection();
1985         if (selection.isCaret()) {
1986             VisiblePosition caret = selection.visibleStart();
1987             position = caret.deepEquivalent().offsetInContainerNode();
1988             if (editor.hasComposition()) {
1989                 int start = editor.compositionStart();
1990                 int end = editor.compositionEnd();
1991                 if (start &lt; position &amp;&amp; position &lt;= end) {
1992                     position = start;
1993                 } else if (position &gt; end) {
1994                     position -= end - start;
1995                 }
1996             }
1997         }
1998     }
1999     return position;
2000 }
2001 
2002 JNIEXPORT jint JNICALL Java_com_sun_webkit_WebPage_twkGetCommittedTextLength
2003     (JNIEnv *env, jobject self, jlong pPage)
2004 {
2005     Page* page = WebPage::pageFromJLong(pPage);
2006     Frame* frame = (Frame*)&amp;page-&gt;mainFrame();
2007 
2008     jint length = 0;
2009     Editor &amp;editor = frame-&gt;editor();
2010     if (editor.canEdit()) {
2011         RefPtr&lt;Range&gt; range = rangeOfContents(*(Node*)frame-&gt;selection().selection().start().element());
2012         // Code derived from Range::toString
2013         Node* pastLast = range.get()-&gt;pastLastNode();
2014         for (Node* n = range.get()-&gt;firstNode(); n != pastLast; n = NodeTraversal::next(*n)) {
2015             if (n-&gt;nodeType() == Node::TEXT_NODE || n-&gt;nodeType() == Node::CDATA_SECTION_NODE) {
2016                 length += static_cast&lt;CharacterData*&gt;(n)-&gt;data().length();
2017             }
2018         }
2019         // Exclude the composition part if any
2020         if (editor.hasComposition()) {
2021             int start = editor.compositionStart();
2022             int end = editor.compositionEnd();
2023             length -= end - start;
2024         }
2025     }
2026     return length;
2027 }
2028 
2029 JNIEXPORT jstring JNICALL Java_com_sun_webkit_WebPage_twkGetCommittedText
2030     (JNIEnv *env, jobject self, jlong pPage)
2031 {
2032     Page* page = WebPage::pageFromJLong(pPage);
2033     Frame* frame = (Frame*)&amp;page-&gt;mainFrame();
2034 
2035     jstring text = 0;
2036 
2037     Editor &amp;editor = frame-&gt;editor();
2038     if (editor.canEdit()) {
2039         RefPtr&lt;Range&gt; range = rangeOfContents(*(Node*)frame-&gt;selection().selection().start().element());
2040         if (range) {
2041             String t = plainText(range.get());
2042             // Exclude the composition text if any
2043             if (editor.hasComposition()) {
2044                 String s;
2045                 int start = editor.compositionStart();
2046                 int end = editor.compositionEnd();
2047                 unsigned int length = t.length() - (end - start);
2048                 if (start &gt; 0) {
2049                     s = t.substring(0, start);
2050                 }
2051                 if (s.length() == length) {
2052                     t = s;
2053                 } else {
2054                     t = s + t.substring(end, length - start);
2055                 }
2056             }
2057             text = t.toJavaString(env).releaseLocal();
2058             WTF::CheckAndClearException(env); // OOME
2059         }
2060     }
2061     return text;
2062 }
2063 
2064 JNIEXPORT jstring JNICALL Java_com_sun_webkit_WebPage_twkGetSelectedText
2065     (JNIEnv *env, jobject self, jlong pPage)
2066 {
2067     Page* page = WebPage::pageFromJLong(pPage);
2068     Frame* frame = (Frame*)&amp;page-&gt;mainFrame();
2069 
2070     jstring text = 0;
2071 
2072     String t = frame-&gt;editor().selectedText();
2073     text = t.toJavaString(env).releaseLocal();
2074     WTF::CheckAndClearException(env); // OOME
2075 
2076     return text;
2077 }
2078 
2079 //java.awt.dnd.DConstants
2080 enum JAVA_DND_ACTION {
2081     ACTION_NONE = 0x0,
2082     ACTION_COPY = 0x1,
2083     ACTION_MOVE = 0x2,
2084     ACTION_LINK = 0x40000000
2085 };
2086 
2087 static jint dragOperationToDragCursor(DragOperation op) {
2088     unsigned int res = ACTION_NONE;
2089     if (op &amp; DragOperationCopy)
2090         res = ACTION_COPY;
2091     else if (op &amp; DragOperationLink)
2092         res = ACTION_LINK;
2093     else if (op &amp; DragOperationMove)
2094         res = ACTION_MOVE;
2095     else if (op &amp; DragOperationGeneric)
2096         res = ACTION_MOVE; //This appears to be the Firefox behaviour
2097     return res;
2098 }
2099 
2100 static DragOperation keyStateToDragOperation(jint javaAction) {
2101     unsigned int action = DragOperationNone;
2102     if(javaAction &amp; ACTION_COPY)
2103         action = DragOperationCopy;
2104     else if(javaAction &amp; ACTION_LINK)
2105         action = DragOperationLink;
2106     else if(javaAction &amp; ACTION_MOVE)
2107         action = DragOperationMove;
2108     return static_cast&lt;DragOperation&gt;(action);
2109 }
2110 
2111 JNIEXPORT jint JNICALL Java_com_sun_webkit_WebPage_twkProcessDrag
2112 (JNIEnv* env,
2113  jobject self,
2114  jlong pPage,
2115  jint actionId,
2116  jobjectArray jMimes, jobjectArray jValues,
2117  jint x, jint y,
2118  jint screenX, jint screenY,
2119  jint javaAction) {
2120     if (jMimes) {
2121         //TRAGET
2122         RefPtr&lt;DataObjectJava&gt; pr = DataObjectJava::create();
2123         jint n = env-&gt;GetArrayLength(jMimes);
2124         for( jint j=0; j&lt;n; ++j ){
2125             jstring value = (jstring)env-&gt;GetObjectArrayElement(jValues, j);
2126             if(value){
2127                 pr-&gt;setData(
2128                     String(env, JLString((jstring)env-&gt;GetObjectArrayElement(jMimes, j))),
2129                     String(env, JLString(value)));
2130             }
2131         }
2132         DragData dragData(
2133             pr.get(),
2134             IntPoint(x, y),
2135             IntPoint(screenX, screenY),
2136             keyStateToDragOperation(javaAction));
2137         DragController&amp; dc = WebPage::pageFromJLong(pPage)-&gt;dragController();
2138 
2139         setCopyKeyState(ACTION_COPY == javaAction);
2140         switch(actionId){
2141         case com_sun_webkit_WebPage_DND_DST_EXIT:
2142             dc.dragExited(dragData);
2143             return 0;
2144         case com_sun_webkit_WebPage_DND_DST_ENTER:
2145             return dragOperationToDragCursor(dc.dragEntered(dragData));
2146         case com_sun_webkit_WebPage_DND_DST_OVER:
2147         case com_sun_webkit_WebPage_DND_DST_CHANGE:
2148             return dragOperationToDragCursor(dc.dragUpdated(dragData));
2149         case com_sun_webkit_WebPage_DND_DST_DROP:
2150             {
2151                 int ret = dc.performDragOperation(dragData) ? 1 : 0;
2152                 WebPage::pageFromJLong(pPage)-&gt;dragController().dragEnded();
2153                 return ret;
2154             }
2155         }
2156     } else {
2157         //SOURCE
2158         EventHandler&amp; eventHandler =
2159                 WebPage::pageFromJLong(pPage)-&gt;mainFrame().eventHandler();
2160         PlatformMouseEvent mouseEvent = PlatformMouseEvent(
2161             IntPoint(x, y),
2162             IntPoint(screenX, screenY),
2163             com_sun_webkit_WebPage_DND_SRC_DROP!=actionId
2164                 ? LeftButton
2165                 : NoButton,
2166             PlatformEvent::MouseMoved,
2167             0,
2168             false, false, false, false, WallTime {}, ForceAtClick, NoTap); // TODO-java: handle force?
2169         switch(actionId){
2170         case com_sun_webkit_WebPage_DND_SRC_EXIT:
2171         case com_sun_webkit_WebPage_DND_SRC_ENTER:
2172         case com_sun_webkit_WebPage_DND_SRC_OVER:
2173         case com_sun_webkit_WebPage_DND_SRC_CHANGE:
2174 //            The method has been removed. See the changeset #de77cc97972d for the details.
2175 //            eventHandler-&gt;dragSourceMovedTo(mouseEvent);
2176             break;
2177         case com_sun_webkit_WebPage_DND_SRC_DROP:
2178             eventHandler.dragSourceEndedAt(mouseEvent, keyStateToDragOperation(javaAction));
2179             break;
2180         }
2181     }
2182     return 0;
2183 }
2184 
2185 static Editor* getEditor(Page* page) {
2186     ASSERT(page);
2187     Frame&amp; frame = page-&gt;focusController().focusedOrMainFrame();
2188     return &amp;frame.editor();
2189 }
2190 
2191 JNIEXPORT jboolean JNICALL Java_com_sun_webkit_WebPage_twkExecuteCommand
2192     (JNIEnv* env, jobject self, jlong pPage, jstring command, jstring value)
2193 {
2194     Page* page = WebPage::pageFromJLong(pPage);
2195     ASSERT(page);
2196     Editor* editor = getEditor(page);
2197     if (!editor) {
2198         return JNI_FALSE;
2199     }
2200     Editor::Command cmd = editor-&gt;command(String(env, command));
2201     return bool_to_jbool(cmd.execute(value ? String(env, value) : String()));
2202 }
2203 
2204 JNIEXPORT jboolean JNICALL Java_com_sun_webkit_WebPage_twkQueryCommandEnabled
2205     (JNIEnv* env, jobject self, jlong pPage, jstring command)
2206 {
2207     Page* page = WebPage::pageFromJLong(pPage);
2208     ASSERT(page);
2209     Editor* editor = getEditor(page);
2210     if (!editor) {
2211         return JNI_FALSE;
2212     }
2213     Editor::Command cmd = editor-&gt;command(String(env, command));
2214     return bool_to_jbool(cmd.isEnabled());
2215 }
2216 
2217 JNIEXPORT jboolean JNICALL Java_com_sun_webkit_WebPage_twkQueryCommandState
2218     (JNIEnv* env, jobject self, jlong pPage, jstring command)
2219 {
2220     Page* page = WebPage::pageFromJLong(pPage);
2221     ASSERT(page);
2222     Editor* editor = getEditor(page);
2223     if (!editor) {
2224         return JNI_FALSE;
2225     }
2226     Editor::Command cmd = editor-&gt;command(String(env, command));
2227     return bool_to_jbool(cmd.state() == TrueTriState);
2228 }
2229 
2230 JNIEXPORT jstring JNICALL Java_com_sun_webkit_WebPage_twkQueryCommandValue
2231     (JNIEnv* env, jobject self, jlong pPage, jstring command)
2232 {
2233     Page* page = WebPage::pageFromJLong(pPage);
2234     ASSERT(page);
2235     Editor* editor = getEditor(page);
2236     if (!editor) {
2237         return nullptr;
2238     }
2239     Editor::Command cmd = editor-&gt;command(String(env, command));
2240     return cmd.value().toJavaString(env).releaseLocal();
2241 }
2242 
2243 JNIEXPORT jboolean JNICALL Java_com_sun_webkit_WebPage_twkIsEditable
2244     (JNIEnv* env, jobject self, jlong pPage)
2245 {
2246     Page* page = WebPage::pageFromJLong(pPage);
2247     ASSERT(page);
2248     if (!page) {
2249         return JNI_FALSE;
2250     }
2251     return bool_to_jbool(page-&gt;isEditable());
2252 }
2253 
2254 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkSetEditable
2255     (JNIEnv* env, jobject self, jlong pPage, jboolean editable)
2256 {
2257     Page* page = WebPage::pageFromJLong(pPage);
2258     ASSERT(page);
2259     if (!page) {
2260         return;
2261     }
2262     page-&gt;setEditable(jbool_to_bool(editable));
2263 }
2264 
2265 JNIEXPORT jstring JNICALL Java_com_sun_webkit_WebPage_twkGetHtml
2266     (JNIEnv* env, jobject self, jlong pFrame)
2267 {
2268     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
2269     if (!frame) {
2270         return 0;
2271     }
2272 
2273     Document* document = frame-&gt;document();
2274     if (!document || !document-&gt;isHTMLDocument()) {
2275         return 0;
2276     }
2277 
2278     HTMLElement* documentElement =
2279             static_cast&lt;HTMLElement*&gt;(document-&gt;documentElement());
2280     if (!documentElement) {
2281         return 0;
2282     }
2283 
2284     return documentElement-&gt;outerHTML().toJavaString(env).releaseLocal();
2285 }
2286 
2287 JNIEXPORT jboolean JNICALL Java_com_sun_webkit_WebPage_twkGetUsePageCache
2288     (JNIEnv*, jobject, jlong pPage)
2289 {
2290     ASSERT(pPage);
2291     Page* page = WebPage::pageFromJLong(pPage);
2292     ASSERT(page);
<a name="24" id="anc24"></a><span class="line-modified">2293     return bool_to_jbool(page-&gt;settings().usesBackForwardCache());</span>
2294 }
2295 
2296 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkSetUsePageCache
2297     (JNIEnv*, jobject, jlong pPage, jboolean usePageCache)
2298 {
2299     ASSERT(pPage);
2300     Page* page = WebPage::pageFromJLong(pPage);
2301     ASSERT(page);
<a name="25" id="anc25"></a><span class="line-modified">2302     page-&gt;settings().setUsesBackForwardCache(jbool_to_bool(usePageCache));</span>
2303 }
2304 
2305 JNIEXPORT jboolean JNICALL Java_com_sun_webkit_WebPage_twkIsJavaScriptEnabled
2306     (JNIEnv*, jobject, jlong pPage)
2307 {
2308     ASSERT(pPage);
2309     Page* page = WebPage::pageFromJLong(pPage);
2310     ASSERT(page);
2311     return bool_to_jbool(page-&gt;mainFrame().script().canExecuteScripts(NotAboutToExecuteScript));
2312 }
2313 
2314 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkSetJavaScriptEnabled
2315     (JNIEnv*, jobject, jlong pPage, jboolean enable)
2316 {
2317     ASSERT(pPage);
2318     Page* page = WebPage::pageFromJLong(pPage);
2319     ASSERT(page);
2320     page-&gt;settings().setScriptEnabled(jbool_to_bool(enable));
2321 }
2322 
2323 JNIEXPORT jboolean JNICALL Java_com_sun_webkit_WebPage_twkIsContextMenuEnabled
2324     (JNIEnv*, jobject, jlong pPage)
2325 {
2326     ASSERT(pPage);
2327     Page* page = WebPage::pageFromJLong(pPage);
2328     ASSERT(page);
2329     return bool_to_jbool(page-&gt;settings().isContextMenuEnabled());
2330 }
2331 
2332 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkSetContextMenuEnabled
2333     (JNIEnv*, jobject, jlong pPage, jboolean enable)
2334 {
2335     ASSERT(pPage);
2336     Page* page = WebPage::pageFromJLong(pPage);
2337     ASSERT(page);
2338     page-&gt;settings().setContextMenuEnabled(jbool_to_bool(enable));
2339 }
2340 
2341 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkSetUserStyleSheetLocation
2342     (JNIEnv* env, jobject, jlong pPage, jstring url)
2343 {
2344     ASSERT(pPage);
2345     Page* page = WebPage::pageFromJLong(pPage);
2346     ASSERT(page);
2347     page-&gt;settings().setUserStyleSheetLocation(URL(URL(), String(env, url)));
2348 }
2349 
2350 JNIEXPORT jstring JNICALL Java_com_sun_webkit_WebPage_twkGetUserAgent
2351     (JNIEnv* env, jobject, jlong pPage)
2352 {
2353     ASSERT(pPage);
2354     Page* page = WebPage::pageFromJLong(pPage);
2355     ASSERT(page);
2356     return page-&gt;settings().userAgent().toJavaString(env).releaseLocal();
2357 }
2358 
2359 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkSetUserAgent
2360     (JNIEnv* env, jobject, jlong pPage, jstring userAgent)
2361 {
2362     ASSERT(pPage);
2363     Page* page = WebPage::pageFromJLong(pPage);
2364     ASSERT(page);
2365     page-&gt;settings().setUserAgent(String(env, userAgent));
2366 }
2367 
2368 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkSetLocalStorageDatabasePath
2369   (JNIEnv* env, jobject, jlong pPage, jstring path)
2370 {
2371     ASSERT(pPage);
2372     Page* page = WebPage::pageFromJLong(pPage);
2373     ASSERT(page);
2374     Settings&amp; settings = page-&gt;settings();
2375     settings.setLocalStorageDatabasePath(String(env, path));
2376     static_cast&lt;WebStorageNamespaceProviderJava*&gt;(
2377       &amp;page-&gt;storageNamespaceProvider())
2378         -&gt;setLocalStorageDatabasePath(settings.localStorageDatabasePath());
2379 }
2380 
2381 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkSetLocalStorageEnabled
2382   (JNIEnv*, jobject, jlong pPage, jboolean enabled)
2383 {
2384     ASSERT(pPage);
2385     Page* page = WebPage::pageFromJLong(pPage);
2386     ASSERT(page);
2387     Settings&amp; settings = page-&gt;settings();
2388     settings.setLocalStorageEnabled(jbool_to_bool(enabled));
2389 }
2390 
2391 JNIEXPORT jboolean JNICALL Java_com_sun_webkit_WebPage_twkGetDeveloperExtrasEnabled
2392   (JNIEnv *, jobject, jlong pPage)
2393 {
2394     ASSERT(pPage);
2395     Page* page = WebPage::pageFromJLong(pPage);
2396     ASSERT(page);
2397     return bool_to_jbool(page-&gt;settings().developerExtrasEnabled());
2398 }
2399 
2400 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkSetDeveloperExtrasEnabled
2401   (JNIEnv *, jobject, jlong pPage, jboolean enabled)
2402 {
2403     ASSERT(pPage);
2404     Page* page = WebPage::pageFromJLong(pPage);
2405     ASSERT(page);
2406     page-&gt;settings().setDeveloperExtrasEnabled(jbool_to_bool(enabled));
2407 }
2408 
2409 JNIEXPORT jint JNICALL Java_com_sun_webkit_WebPage_twkGetUnloadEventListenersCount
2410     (JNIEnv*, jobject, jlong pFrame)
2411 {
2412     ASSERT(pFrame);
2413     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
2414     ASSERT(frame);
2415     return (jint)frame-&gt;document()-&gt;domWindow()-&gt;pendingUnloadEventListeners();
2416 }
2417 
2418 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkConnectInspectorFrontend
2419   (JNIEnv *, jobject, jlong pPage)
2420 {
2421     Page *page = WebPage::pageFromJLong(pPage);
2422     if (page) {
2423         InspectorController&amp; ic = page-&gt;inspectorController();
2424         InspectorClientJava* icj = static_cast&lt;InspectorClientJava*&gt;(ic.inspectorClient());
2425         if (icj) {
2426             ic.connectFrontend(*icj, false);
2427         }
2428 
2429     }
2430     WebPage::webPageFromJLong(pPage)-&gt;debugStarted();
2431 }
2432 
2433 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkDisconnectInspectorFrontend
2434   (JNIEnv *, jobject, jlong pPage)
2435 {
2436     Page* page = WebPage::pageFromJLong(pPage);
2437     if (!page) {
2438         return;
2439     }
2440 
2441     InspectorController&amp; ic = page-&gt;inspectorController();
2442     InspectorClientJava* icj = static_cast&lt;InspectorClientJava*&gt;(ic.inspectorClient());
2443     if (icj) {
2444         ic.disconnectFrontend(*icj);
2445     }
2446 
2447     WebPage::webPageFromJLong(pPage)-&gt;debugEnded();
2448 }
2449 
2450 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkDispatchInspectorMessageFromFrontend
2451   (JNIEnv* env, jobject, jlong pPage, jstring message)
2452 {
2453     Page* page = WebPage::pageFromJLong(pPage);
2454     if (!page) {
2455         return;
2456     }
2457     //utatodo: seems that RT-21428 will back again
2458     //JSDOMWindowBase::commonVM()-&gt;timeoutChecker.reset(); // RT-21428
2459     page-&gt;inspectorController().dispatchMessageFromFrontend(
2460             String(env, message));
2461 }
2462 
2463 JNIEXPORT jint JNICALL Java_com_sun_webkit_WebPage_twkWorkerThreadCount
2464   (JNIEnv* env, jclass)
2465 {
2466     return WorkerThread::workerThreadCount();
2467 }
2468 
2469 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkDoJSCGarbageCollection
2470   (JNIEnv*, jclass)
2471 {
2472     GCController::singleton().garbageCollectNow();
2473 }
2474 
2475 }
<a name="26" id="anc26"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="26" type="hidden" />
</body>
</html>