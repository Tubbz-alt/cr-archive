<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/JavaScriptCore/runtime/JSModuleNamespaceObject.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (C) 2015-2019 Apple Inc. All rights reserved.
  3  *
  4  * Redistribution and use in source and binary forms, with or without
  5  * modification, are permitted provided that the following conditions
  6  * are met:
  7  * 1. Redistributions of source code must retain the above copyright
  8  *    notice, this list of conditions and the following disclaimer.
  9  * 2. Redistributions in binary form must reproduce the above copyright
 10  *    notice, this list of conditions and the following disclaimer in the
 11  *    documentation and/or other materials provided with the distribution.
 12  *
 13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. ``AS IS&#39;&#39; AND ANY
 14  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 15  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 16  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE INC. OR
 17  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 18  * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 19  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 20  * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 21  * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 22  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 23  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #include &quot;config.h&quot;
 27 #include &quot;JSModuleNamespaceObject.h&quot;
 28 
 29 #include &quot;AbstractModuleRecord.h&quot;
 30 #include &quot;Error.h&quot;
 31 #include &quot;JSCInlines.h&quot;
 32 #include &quot;JSModuleEnvironment.h&quot;
 33 
 34 namespace JSC {
 35 
 36 const ClassInfo JSModuleNamespaceObject::s_info = { &quot;ModuleNamespaceObject&quot;, &amp;Base::s_info, nullptr, nullptr, CREATE_METHOD_TABLE(JSModuleNamespaceObject) };
 37 
 38 JSModuleNamespaceObject::JSModuleNamespaceObject(VM&amp; vm, Structure* structure)
 39     : Base(vm, structure)
 40     , m_exports()
 41 {
 42 }
 43 
<a name="1" id="anc1"></a><span class="line-modified"> 44 void JSModuleNamespaceObject::finishCreation(JSGlobalObject* globalObject, AbstractModuleRecord* moduleRecord, Vector&lt;std::pair&lt;Identifier, AbstractModuleRecord::Resolution&gt;&gt;&amp;&amp; resolutions)</span>
 45 {
<a name="2" id="anc2"></a><span class="line-modified"> 46     VM&amp; vm = globalObject-&gt;vm();</span>
 47     auto scope = DECLARE_THROW_SCOPE(vm);
 48     Base::finishCreation(vm);
 49     ASSERT(inherits(vm, info()));
 50 
 51     // http://www.ecma-international.org/ecma-262/6.0/#sec-module-namespace-exotic-objects
 52     // Quoted from the spec:
 53     //     A List containing the String values of the exported names exposed as own properties of this object.
 54     //     The list is ordered as if an Array of those String values had been sorted using Array.prototype.sort using SortCompare as comparefn.
 55     //
 56     // Sort the exported names by the code point order.
 57     std::sort(resolutions.begin(), resolutions.end(), [] (const auto&amp; lhs, const auto&amp; rhs) {
 58         return codePointCompare(lhs.first.impl(), rhs.first.impl()) &lt; 0;
 59     });
 60 
 61     m_moduleRecord.set(vm, this, moduleRecord);
<a name="3" id="anc3"></a><span class="line-added"> 62     m_names.reserveCapacity(resolutions.size());</span>
 63     {
<a name="4" id="anc4"></a><span class="line-modified"> 64         auto locker = holdLock(cellLock());</span>

 65         for (const auto&amp; pair : resolutions) {
<a name="5" id="anc5"></a>
 66             m_names.append(pair.first);
<a name="6" id="anc6"></a><span class="line-modified"> 67             auto addResult = m_exports.add(pair.first.impl(), ExportEntry());</span>
<span class="line-modified"> 68             addResult.iterator-&gt;value.localName = pair.second.localName;</span>
<span class="line-modified"> 69             addResult.iterator-&gt;value.moduleRecord.set(vm, this, pair.second.moduleRecord);</span>


 70         }
 71     }
 72 
<a name="7" id="anc7"></a><span class="line-modified"> 73     putDirect(vm, vm.propertyNames-&gt;toStringTagSymbol, jsNontrivialString(vm, &quot;Module&quot;_s), PropertyAttribute::DontEnum | PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly);</span>
 74 
 75     // http://www.ecma-international.org/ecma-262/6.0/#sec-module-namespace-exotic-objects-getprototypeof
 76     // http://www.ecma-international.org/ecma-262/6.0/#sec-module-namespace-exotic-objects-setprototypeof-v
 77     // http://www.ecma-international.org/ecma-262/6.0/#sec-module-namespace-exotic-objects-isextensible
 78     // http://www.ecma-international.org/ecma-262/6.0/#sec-module-namespace-exotic-objects-preventextensions
<a name="8" id="anc8"></a><span class="line-modified"> 79     methodTable(vm)-&gt;preventExtensions(this, globalObject);</span>
 80     scope.assertNoException();
 81 }
 82 
 83 void JSModuleNamespaceObject::destroy(JSCell* cell)
 84 {
 85     JSModuleNamespaceObject* thisObject = static_cast&lt;JSModuleNamespaceObject*&gt;(cell);
 86     thisObject-&gt;JSModuleNamespaceObject::~JSModuleNamespaceObject();
 87 }
 88 
 89 void JSModuleNamespaceObject::visitChildren(JSCell* cell, SlotVisitor&amp; visitor)
 90 {
 91     JSModuleNamespaceObject* thisObject = jsCast&lt;JSModuleNamespaceObject*&gt;(cell);
 92     ASSERT_GC_OBJECT_INHERITS(thisObject, info());
 93     Base::visitChildren(thisObject, visitor);
 94     visitor.append(thisObject-&gt;m_moduleRecord);
<a name="9" id="anc9"></a><span class="line-modified"> 95     {</span>
<span class="line-modified"> 96         auto locker = holdLock(thisObject-&gt;cellLock());</span>
<span class="line-added"> 97         for (auto&amp; pair : thisObject-&gt;m_exports)</span>
<span class="line-added"> 98             visitor.appendHidden(pair.value.moduleRecord);</span>
<span class="line-added"> 99     }</span>
100 }
101 
102 static JSValue getValue(JSModuleEnvironment* environment, PropertyName localName, ScopeOffset&amp; scopeOffset)
103 {
104     SymbolTable* symbolTable = environment-&gt;symbolTable();
105     {
106         ConcurrentJSLocker locker(symbolTable-&gt;m_lock);
107         auto iter = symbolTable-&gt;find(locker, localName.uid());
108         ASSERT(iter != symbolTable-&gt;end(locker));
109         SymbolTableEntry&amp; entry = iter-&gt;value;
110         ASSERT(!entry.isNull());
111         scopeOffset = entry.scopeOffset();
112     }
113     return environment-&gt;variableAt(scopeOffset).get();
114 }
115 
<a name="10" id="anc10"></a><span class="line-modified">116 bool JSModuleNamespaceObject::getOwnPropertySlotCommon(JSGlobalObject* globalObject, PropertyName propertyName, PropertySlot&amp; slot)</span>
117 {
<a name="11" id="anc11"></a><span class="line-modified">118     VM&amp; vm = globalObject-&gt;vm();</span>
119     auto scope = DECLARE_THROW_SCOPE(vm);
120 
121     // http://www.ecma-international.org/ecma-262/6.0/#sec-module-namespace-exotic-objects-getownproperty-p
122 
123     // step 1.
124     // If the property name is a symbol, we don&#39;t look into the imported bindings.
125     // It may return the descriptor with writable: true, but namespace objects does not allow it in [[Set]] / [[DefineOwnProperty]] side.
126     if (propertyName.isSymbol())
<a name="12" id="anc12"></a><span class="line-modified">127         return JSObject::getOwnPropertySlot(this, globalObject, propertyName, slot);</span>
128 
129     slot.setIsTaintedByOpaqueObject();
130 
131     auto iterator = m_exports.find(propertyName.uid());
132     if (iterator == m_exports.end())
133         return false;
134     ExportEntry&amp; exportEntry = iterator-&gt;value;
135 
136     switch (slot.internalMethodType()) {
137     case PropertySlot::InternalMethodType::GetOwnProperty:
138     case PropertySlot::InternalMethodType::Get: {
<a name="13" id="anc13"></a><span class="line-modified">139         JSModuleEnvironment* environment = exportEntry.moduleRecord-&gt;moduleEnvironment();</span>
140         ScopeOffset scopeOffset;
141         JSValue value = getValue(environment, exportEntry.localName, scopeOffset);
142         // If the value is filled with TDZ value, throw a reference error.
143         if (!value) {
<a name="14" id="anc14"></a><span class="line-modified">144             throwVMError(globalObject, scope, createTDZError(globalObject));</span>
145             return false;
146         }
147 
148         slot.setValueModuleNamespace(this, static_cast&lt;unsigned&gt;(PropertyAttribute::DontDelete), value, environment, scopeOffset);
149         return true;
150     }
151 
152     case PropertySlot::InternalMethodType::HasProperty: {
153         // Do not perform [[Get]] for [[HasProperty]].
154         // [[Get]] / [[GetOwnProperty]] onto namespace object could throw an error while [[HasProperty]] just returns true here.
155         // https://tc39.github.io/ecma262/#sec-module-namespace-exotic-objects-hasproperty-p
156         slot.setValue(this, static_cast&lt;unsigned&gt;(PropertyAttribute::DontDelete), jsUndefined());
157         return true;
158     }
159 
160     case PropertySlot::InternalMethodType::VMInquiry:
161         return false;
162     }
163 
164     RELEASE_ASSERT_NOT_REACHED();
165     return false;
166 }
167 
<a name="15" id="anc15"></a><span class="line-modified">168 bool JSModuleNamespaceObject::getOwnPropertySlot(JSObject* cell, JSGlobalObject* globalObject, PropertyName propertyName, PropertySlot&amp; slot)</span>
169 {
170     JSModuleNamespaceObject* thisObject = jsCast&lt;JSModuleNamespaceObject*&gt;(cell);
<a name="16" id="anc16"></a><span class="line-modified">171     return thisObject-&gt;getOwnPropertySlotCommon(globalObject, propertyName, slot);</span>
172 }
173 
<a name="17" id="anc17"></a><span class="line-modified">174 bool JSModuleNamespaceObject::getOwnPropertySlotByIndex(JSObject* cell, JSGlobalObject* globalObject, unsigned propertyName, PropertySlot&amp; slot)</span>
175 {
<a name="18" id="anc18"></a><span class="line-modified">176     VM&amp; vm = globalObject-&gt;vm();</span>
177     JSModuleNamespaceObject* thisObject = jsCast&lt;JSModuleNamespaceObject*&gt;(cell);
<a name="19" id="anc19"></a><span class="line-modified">178     return thisObject-&gt;getOwnPropertySlotCommon(globalObject, Identifier::from(vm, propertyName), slot);</span>
179 }
180 
<a name="20" id="anc20"></a><span class="line-modified">181 bool JSModuleNamespaceObject::put(JSCell*, JSGlobalObject* globalObject, PropertyName, JSValue, PutPropertySlot&amp; slot)</span>
182 {
<a name="21" id="anc21"></a><span class="line-modified">183     VM&amp; vm = globalObject-&gt;vm();</span>
184     auto scope = DECLARE_THROW_SCOPE(vm);
185 
186     // http://www.ecma-international.org/ecma-262/6.0/#sec-module-namespace-exotic-objects-set-p-v-receiver
187     if (slot.isStrictMode())
<a name="22" id="anc22"></a><span class="line-modified">188         throwTypeError(globalObject, scope, ReadonlyPropertyWriteError);</span>
189     return false;
190 }
191 
<a name="23" id="anc23"></a><span class="line-modified">192 bool JSModuleNamespaceObject::putByIndex(JSCell*, JSGlobalObject* globalObject, unsigned, JSValue, bool shouldThrow)</span>
193 {
<a name="24" id="anc24"></a><span class="line-modified">194     VM&amp; vm = globalObject-&gt;vm();</span>
195     auto scope = DECLARE_THROW_SCOPE(vm);
196 
197     if (shouldThrow)
<a name="25" id="anc25"></a><span class="line-modified">198         throwTypeError(globalObject, scope, ReadonlyPropertyWriteError);</span>
199     return false;
200 }
201 
<a name="26" id="anc26"></a><span class="line-modified">202 bool JSModuleNamespaceObject::deleteProperty(JSCell* cell, JSGlobalObject* globalObject, PropertyName propertyName)</span>
203 {
204     // http://www.ecma-international.org/ecma-262/6.0/#sec-module-namespace-exotic-objects-delete-p
205     JSModuleNamespaceObject* thisObject = jsCast&lt;JSModuleNamespaceObject*&gt;(cell);
206     if (propertyName.isSymbol())
<a name="27" id="anc27"></a><span class="line-modified">207         return JSObject::deleteProperty(thisObject, globalObject, propertyName);</span>
208 
209     return !thisObject-&gt;m_exports.contains(propertyName.uid());
210 }
211 
<a name="28" id="anc28"></a><span class="line-modified">212 void JSModuleNamespaceObject::getOwnPropertyNames(JSObject* cell, JSGlobalObject* globalObject, PropertyNameArray&amp; propertyNames, EnumerationMode mode)</span>
213 {
<a name="29" id="anc29"></a><span class="line-modified">214     VM&amp; vm = globalObject-&gt;vm();</span>
<span class="line-added">215     auto scope = DECLARE_THROW_SCOPE(vm);</span>
<span class="line-added">216 </span>
<span class="line-added">217     // https://tc39.es/ecma262/#sec-module-namespace-exotic-objects-ownpropertykeys</span>
218     JSModuleNamespaceObject* thisObject = jsCast&lt;JSModuleNamespaceObject*&gt;(cell);
<a name="30" id="anc30"></a><span class="line-modified">219     for (const auto&amp; name : thisObject-&gt;m_names) {</span>
<span class="line-added">220         if (!mode.includeDontEnumProperties()) {</span>
<span class="line-added">221             // Perform [[GetOwnProperty]] to throw ReferenceError if binding is uninitialized.</span>
<span class="line-added">222             PropertySlot slot(cell, PropertySlot::InternalMethodType::GetOwnProperty);</span>
<span class="line-added">223             thisObject-&gt;getOwnPropertySlotCommon(globalObject, name.impl(), slot);</span>
<span class="line-added">224             RETURN_IF_EXCEPTION(scope, void());</span>
<span class="line-added">225         }</span>
226         propertyNames.add(name.impl());
<a name="31" id="anc31"></a><span class="line-modified">227     }</span>
<span class="line-added">228     JSObject::getOwnPropertyNames(thisObject, globalObject, propertyNames, mode);</span>
229 }
230 
<a name="32" id="anc32"></a><span class="line-modified">231 bool JSModuleNamespaceObject::defineOwnProperty(JSObject*, JSGlobalObject* globalObject, PropertyName, const PropertyDescriptor&amp;, bool shouldThrow)</span>
232 {
<a name="33" id="anc33"></a><span class="line-modified">233     VM&amp; vm = globalObject-&gt;vm();</span>
234     auto scope = DECLARE_THROW_SCOPE(vm);
235 
236     // http://www.ecma-international.org/ecma-262/6.0/#sec-module-namespace-exotic-objects-defineownproperty-p-desc
237     if (shouldThrow)
<a name="34" id="anc34"></a><span class="line-modified">238         throwTypeError(globalObject, scope, NonExtensibleObjectPropertyDefineError);</span>
239     return false;
240 }
241 
242 } // namespace JSC
<a name="35" id="anc35"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="35" type="hidden" />
</body>
</html>