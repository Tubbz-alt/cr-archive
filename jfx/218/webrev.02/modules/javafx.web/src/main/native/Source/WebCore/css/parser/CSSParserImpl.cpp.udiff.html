<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WebCore/css/parser/CSSParserImpl.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="CSSParserFastPaths.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="CSSParserImpl.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/css/parser/CSSParserImpl.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -83,15 +83,11 @@</span>
  }
  
  CSSParser::ParseResult CSSParserImpl::parseValue(MutableStyleProperties* declaration, CSSPropertyID propertyID, const String&amp; string, bool important, const CSSParserContext&amp; context)
  {
      CSSParserImpl parser(context, string);
<span class="udiff-line-modified-removed">-     StyleRule::Type ruleType = StyleRule::Style;</span>
<span class="udiff-line-removed">- #if ENABLE(CSS_DEVICE_ADAPTATION)</span>
<span class="udiff-line-removed">-     if (declaration-&gt;cssParserMode() == CSSViewportRuleMode)</span>
<span class="udiff-line-removed">-         ruleType = StyleRule::Viewport;</span>
<span class="udiff-line-removed">- #endif</span>
<span class="udiff-line-modified-added">+     auto ruleType = context.enclosingRuleType.valueOr(StyleRuleType::Style);</span>
      parser.consumeDeclarationValue(parser.tokenizer()-&gt;tokenRange(), propertyID, important, ruleType);
      if (parser.m_parsedProperties.isEmpty())
          return CSSParser::ParseResult::Error;
      return declaration-&gt;addParsedProperties(parser.m_parsedProperties) ? CSSParser::ParseResult::Changed : CSSParser::ParseResult::Unchanged;
  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -160,22 +156,22 @@</span>
  {
      CSSParserContext context(element-&gt;document());
      context.mode = strictToCSSParserMode(element-&gt;isHTMLElement() &amp;&amp; !element-&gt;document().inQuirksMode());
  
      CSSParserImpl parser(context, string);
<span class="udiff-line-modified-removed">-     parser.consumeDeclarationList(parser.tokenizer()-&gt;tokenRange(), StyleRule::Style);</span>
<span class="udiff-line-modified-added">+     parser.consumeDeclarationList(parser.tokenizer()-&gt;tokenRange(), StyleRuleType::Style);</span>
      return createStyleProperties(parser.m_parsedProperties, context.mode);
  }
  
  Ref&lt;ImmutableStyleProperties&gt; CSSParserImpl::parseDeferredDeclaration(CSSParserTokenRange tokenRange, const CSSParserContext&amp; context, StyleSheetContents* styleSheet)
  {
      if (!styleSheet) {
          ParsedPropertyVector properties;
          return createStyleProperties(properties, context.mode);
      }
      CSSParserImpl parser(context, styleSheet);
<span class="udiff-line-modified-removed">-     parser.consumeDeclarationList(tokenRange, StyleRule::Style);</span>
<span class="udiff-line-modified-added">+     parser.consumeDeclarationList(tokenRange, StyleRuleType::Style);</span>
      return createStyleProperties(parser.m_parsedProperties, context.mode);
  }
  
  void CSSParserImpl::parseDeferredRuleList(CSSParserTokenRange tokenRange, CSSDeferredParser&amp; deferredParser, Vector&lt;RefPtr&lt;StyleRuleBase&gt;&gt;&amp; childRules)
  {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -199,15 +195,11 @@</span>
  }
  
  bool CSSParserImpl::parseDeclarationList(MutableStyleProperties* declaration, const String&amp; string, const CSSParserContext&amp; context)
  {
      CSSParserImpl parser(context, string);
<span class="udiff-line-modified-removed">-     StyleRule::Type ruleType = StyleRule::Style;</span>
<span class="udiff-line-removed">- #if ENABLE(CSS_DEVICE_ADAPTATION)</span>
<span class="udiff-line-removed">-     if (declaration-&gt;cssParserMode() == CSSViewportRuleMode)</span>
<span class="udiff-line-removed">-         ruleType = StyleRule::Viewport;</span>
<span class="udiff-line-removed">- #endif</span>
<span class="udiff-line-modified-added">+     auto ruleType = context.enclosingRuleType.valueOr(StyleRuleType::Style);</span>
      parser.consumeDeclarationList(parser.tokenizer()-&gt;tokenRange(), ruleType);
      if (parser.m_parsedProperties.isEmpty())
          return false;
  
      std::bitset&lt;numCSSProperties&gt; seenProperties;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -304,23 +296,23 @@</span>
  }
  
  bool CSSParserImpl::supportsDeclaration(CSSParserTokenRange&amp; range)
  {
      ASSERT(m_parsedProperties.isEmpty());
<span class="udiff-line-modified-removed">-     consumeDeclaration(range, StyleRule::Style);</span>
<span class="udiff-line-modified-added">+     consumeDeclaration(range, StyleRuleType::Style);</span>
      bool result = !m_parsedProperties.isEmpty();
      m_parsedProperties.clear();
      return result;
  }
  
  void CSSParserImpl::parseDeclarationListForInspector(const String&amp; declaration, const CSSParserContext&amp; context, CSSParserObserver&amp; observer)
  {
      CSSParserObserverWrapper wrapper(observer);
      CSSParserImpl parser(context, declaration, nullptr, &amp;wrapper);
<span class="udiff-line-modified-removed">-     observer.startRuleHeader(StyleRule::Style, 0);</span>
<span class="udiff-line-modified-added">+     observer.startRuleHeader(StyleRuleType::Style, 0);</span>
      observer.endRuleHeader(1);
<span class="udiff-line-modified-removed">-     parser.consumeDeclarationList(parser.tokenizer()-&gt;tokenRange(), StyleRule::Style);</span>
<span class="udiff-line-modified-added">+     parser.consumeDeclarationList(parser.tokenizer()-&gt;tokenRange(), StyleRuleType::Style);</span>
  }
  
  void CSSParserImpl::parseStyleSheetForInspector(const String&amp; string, const CSSParserContext&amp; context, StyleSheetContents* styleSheet, CSSParserObserver&amp; observer)
  {
      CSSParserObserverWrapper wrapper(observer);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -508,11 +500,11 @@</span>
      if (uri.isNull())
          return nullptr; // Parse error, expected string or URI
  
      if (m_observerWrapper) {
          unsigned endOffset = m_observerWrapper-&gt;endOffset(prelude);
<span class="udiff-line-modified-removed">-         m_observerWrapper-&gt;observer().startRuleHeader(StyleRule::Import, m_observerWrapper-&gt;startOffset(prelude));</span>
<span class="udiff-line-modified-added">+         m_observerWrapper-&gt;observer().startRuleHeader(StyleRuleType::Import, m_observerWrapper-&gt;startOffset(prelude));</span>
          m_observerWrapper-&gt;observer().endRuleHeader(endOffset);
          m_observerWrapper-&gt;observer().startRuleBody(endOffset);
          m_observerWrapper-&gt;observer().endRuleBody(endOffset);
      }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -538,11 +530,11 @@</span>
          return StyleRuleMedia::create(MediaQueryParser::parseMediaQuerySet(prelude, MediaQueryParserContext(m_context)).releaseNonNull(),  makeUnique&lt;DeferredStyleGroupRuleList&gt;(block, *m_deferredParser));
  
      Vector&lt;RefPtr&lt;StyleRuleBase&gt;&gt; rules;
  
      if (m_observerWrapper) {
<span class="udiff-line-modified-removed">-         m_observerWrapper-&gt;observer().startRuleHeader(StyleRule::Media, m_observerWrapper-&gt;startOffset(prelude));</span>
<span class="udiff-line-modified-added">+         m_observerWrapper-&gt;observer().startRuleHeader(StyleRuleType::Media, m_observerWrapper-&gt;startOffset(prelude));</span>
          m_observerWrapper-&gt;observer().endRuleHeader(m_observerWrapper-&gt;endOffset(prelude));
          m_observerWrapper-&gt;observer().startRuleBody(m_observerWrapper-&gt;previousTokenStartOffset(block));
      }
  
      consumeRuleList(block, RegularRuleList, [&amp;rules](RefPtr&lt;StyleRuleBase&gt; rule) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -564,11 +556,11 @@</span>
  
      if (m_deferredParser)
          return StyleRuleSupports::create(prelude.serialize().stripWhiteSpace(), supported, makeUnique&lt;DeferredStyleGroupRuleList&gt;(block, *m_deferredParser));
  
      if (m_observerWrapper) {
<span class="udiff-line-modified-removed">-         m_observerWrapper-&gt;observer().startRuleHeader(StyleRule::Supports, m_observerWrapper-&gt;startOffset(prelude));</span>
<span class="udiff-line-modified-added">+         m_observerWrapper-&gt;observer().startRuleHeader(StyleRuleType::Supports, m_observerWrapper-&gt;startOffset(prelude));</span>
          m_observerWrapper-&gt;observer().endRuleHeader(m_observerWrapper-&gt;endOffset(prelude));
          m_observerWrapper-&gt;observer().startRuleBody(m_observerWrapper-&gt;previousTokenStartOffset(block));
      }
  
      Vector&lt;RefPtr&lt;StyleRuleBase&gt;&gt; rules;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -589,11 +581,11 @@</span>
      if (!prelude.atEnd())
          return nullptr; // Parser error; @viewport prelude should be empty
  
      if (m_observerWrapper) {
          unsigned endOffset = m_observerWrapper-&gt;endOffset(prelude);
<span class="udiff-line-modified-removed">-         m_observerWrapper-&gt;observer().startRuleHeader(StyleRule::Viewport, m_observerWrapper-&gt;startOffset(prelude));</span>
<span class="udiff-line-modified-added">+         m_observerWrapper-&gt;observer().startRuleHeader(StyleRuleType::Viewport, m_observerWrapper-&gt;startOffset(prelude));</span>
          m_observerWrapper-&gt;observer().endRuleHeader(endOffset);
          m_observerWrapper-&gt;observer().startRuleBody(endOffset);
          m_observerWrapper-&gt;observer().endRuleBody(endOffset);
      }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -607,17 +599,17 @@</span>
      if (!prelude.atEnd())
          return nullptr; // Parse error; @font-face prelude should be empty
  
      if (m_observerWrapper) {
          unsigned endOffset = m_observerWrapper-&gt;endOffset(prelude);
<span class="udiff-line-modified-removed">-         m_observerWrapper-&gt;observer().startRuleHeader(StyleRule::FontFace, m_observerWrapper-&gt;startOffset(prelude));</span>
<span class="udiff-line-modified-added">+         m_observerWrapper-&gt;observer().startRuleHeader(StyleRuleType::FontFace, m_observerWrapper-&gt;startOffset(prelude));</span>
          m_observerWrapper-&gt;observer().endRuleHeader(endOffset);
          m_observerWrapper-&gt;observer().startRuleBody(endOffset);
          m_observerWrapper-&gt;observer().endRuleBody(endOffset);
      }
  
<span class="udiff-line-modified-removed">-     consumeDeclarationList(block, StyleRule::FontFace);</span>
<span class="udiff-line-modified-added">+     consumeDeclarationList(block, StyleRuleType::FontFace);</span>
      return StyleRuleFontFace::create(createStyleProperties(m_parsedProperties, m_context.mode));
  }
  
  RefPtr&lt;StyleRuleKeyframes&gt; CSSParserImpl::consumeKeyframesRule(bool webkitPrefixed, CSSParserTokenRange prelude, CSSParserTokenRange block)
  {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -636,11 +628,11 @@</span>
  
      if (m_deferredParser)
          return StyleRuleKeyframes::create(name, makeUnique&lt;DeferredStyleGroupRuleList&gt;(block, *m_deferredParser));
  
      if (m_observerWrapper) {
<span class="udiff-line-modified-removed">-         m_observerWrapper-&gt;observer().startRuleHeader(StyleRule::Keyframes, m_observerWrapper-&gt;startOffset(rangeCopy));</span>
<span class="udiff-line-modified-added">+         m_observerWrapper-&gt;observer().startRuleHeader(StyleRuleType::Keyframes, m_observerWrapper-&gt;startOffset(rangeCopy));</span>
          m_observerWrapper-&gt;observer().endRuleHeader(m_observerWrapper-&gt;endOffset(prelude));
          m_observerWrapper-&gt;observer().startRuleBody(m_observerWrapper-&gt;previousTokenStartOffset(block));
          m_observerWrapper-&gt;observer().endRuleBody(m_observerWrapper-&gt;endOffset(block));
      }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -660,15 +652,15 @@</span>
      if (!selectorList.isValid())
          return nullptr; // Parse error, invalid @page selector
  
      if (m_observerWrapper) {
          unsigned endOffset = m_observerWrapper-&gt;endOffset(prelude);
<span class="udiff-line-modified-removed">-         m_observerWrapper-&gt;observer().startRuleHeader(StyleRule::Page, m_observerWrapper-&gt;startOffset(prelude));</span>
<span class="udiff-line-modified-added">+         m_observerWrapper-&gt;observer().startRuleHeader(StyleRuleType::Page, m_observerWrapper-&gt;startOffset(prelude));</span>
          m_observerWrapper-&gt;observer().endRuleHeader(endOffset);
      }
  
<span class="udiff-line-modified-removed">-     consumeDeclarationList(block, StyleRule::Style);</span>
<span class="udiff-line-modified-added">+     consumeDeclarationList(block, StyleRuleType::Style);</span>
  
      return StyleRulePage::create(createStyleProperties(m_parsedProperties, m_context.mode), WTFMove(selectorList));
  }
  
  // FIXME-NEWPARSER: Support &quot;apply&quot;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -688,24 +680,24 @@</span>
      std::unique_ptr&lt;Vector&lt;double&gt;&gt; keyList = consumeKeyframeKeyList(prelude);
      if (!keyList)
          return nullptr;
  
      if (m_observerWrapper) {
<span class="udiff-line-modified-removed">-         m_observerWrapper-&gt;observer().startRuleHeader(StyleRule::Keyframe, m_observerWrapper-&gt;startOffset(prelude));</span>
<span class="udiff-line-modified-added">+         m_observerWrapper-&gt;observer().startRuleHeader(StyleRuleType::Keyframe, m_observerWrapper-&gt;startOffset(prelude));</span>
          m_observerWrapper-&gt;observer().endRuleHeader(m_observerWrapper-&gt;endOffset(prelude));
      }
  
<span class="udiff-line-modified-removed">-     consumeDeclarationList(block, StyleRule::Keyframe);</span>
<span class="udiff-line-modified-added">+     consumeDeclarationList(block, StyleRuleType::Keyframe);</span>
      return StyleRuleKeyframe::create(WTFMove(keyList), createStyleProperties(m_parsedProperties, m_context.mode));
  }
  
  static void observeSelectors(CSSParserObserverWrapper&amp; wrapper, CSSParserTokenRange selectors)
  {
      // This is easier than hooking into the CSSSelectorParser
      selectors.consumeWhitespace();
      CSSParserTokenRange originalRange = selectors;
<span class="udiff-line-modified-removed">-     wrapper.observer().startRuleHeader(StyleRule::Style, wrapper.startOffset(originalRange));</span>
<span class="udiff-line-modified-added">+     wrapper.observer().startRuleHeader(StyleRuleType::Style, wrapper.startOffset(originalRange));</span>
  
      while (!selectors.atEnd()) {
          const CSSParserToken* selectorStart = &amp;selectors.peek();
          while (!selectors.atEnd() &amp;&amp; selectors.peek().type() != CommaToken)
              selectors.consumeComponentValue();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -737,19 +729,19 @@</span>
          if (!blockCopy.atEnd()) {
              return StyleRule::create(createDeferredStyleProperties(block), m_context.hasDocumentSecurityOrigin, WTFMove(selectorList));
          }
      }
  
<span class="udiff-line-modified-removed">-     consumeDeclarationList(block, StyleRule::Style);</span>
<span class="udiff-line-modified-added">+     consumeDeclarationList(block, StyleRuleType::Style);</span>
      return StyleRule::create(createStyleProperties(m_parsedProperties, m_context.mode), m_context.hasDocumentSecurityOrigin, WTFMove(selectorList));
  }
  
<span class="udiff-line-modified-removed">- void CSSParserImpl::consumeDeclarationList(CSSParserTokenRange range, StyleRule::Type ruleType)</span>
<span class="udiff-line-modified-added">+ void CSSParserImpl::consumeDeclarationList(CSSParserTokenRange range, StyleRuleType ruleType)</span>
  {
      ASSERT(m_parsedProperties.isEmpty());
  
<span class="udiff-line-modified-removed">-     bool useObserver = m_observerWrapper &amp;&amp; (ruleType == StyleRule::Style || ruleType == StyleRule::Keyframe);</span>
<span class="udiff-line-modified-added">+     bool useObserver = m_observerWrapper &amp;&amp; (ruleType == StyleRuleType::Style || ruleType == StyleRuleType::Keyframe);</span>
      if (useObserver) {
          m_observerWrapper-&gt;observer().startRuleBody(m_observerWrapper-&gt;previousTokenStartOffset(range));
          m_observerWrapper-&gt;skipCommentsBefore(range, true);
      }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -774,11 +766,11 @@</span>
                  m_observerWrapper-&gt;skipCommentsBefore(range, false);
              break;
          }
          case AtKeywordToken: {
              // FIXME-NEWPARSER: Support apply
<span class="udiff-line-modified-removed">-             AllowedRulesType allowedRules = /* ruleType == StyleRule::Style &amp;&amp; RuntimeEnabledFeatures::cssApplyAtRulesEnabled() ? ApplyRules :*/ NoRules;</span>
<span class="udiff-line-modified-added">+             AllowedRulesType allowedRules = /* ruleType == StyleRuleType::Style &amp;&amp; RuntimeEnabledFeatures::cssApplyAtRulesEnabled() ? ApplyRules :*/ NoRules;</span>
              RefPtr&lt;StyleRuleBase&gt; rule = consumeAtRule(range, allowedRules);
              ASSERT_UNUSED(rule, !rule);
              break;
          }
          default: // Parse error, unexpected token in declaration list
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -793,11 +785,11 @@</span>
          m_observerWrapper-&gt;yieldCommentsBefore(range);
          m_observerWrapper-&gt;observer().endRuleBody(m_observerWrapper-&gt;endOffset(range));
      }
  }
  
<span class="udiff-line-modified-removed">- void CSSParserImpl::consumeDeclaration(CSSParserTokenRange range, StyleRule::Type ruleType)</span>
<span class="udiff-line-modified-added">+ void CSSParserImpl::consumeDeclaration(CSSParserTokenRange range, StyleRuleType ruleType)</span>
  {
      CSSParserTokenRange rangeCopy = range; // For inspector callbacks
  
      ASSERT(range.peek().type() == IdentToken);
      const CSSParserToken&amp; token = range.consumeIncludingWhitespace();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -824,17 +816,17 @@</span>
      if (propertyID == CSSPropertyInvalid &amp;&amp; CSSVariableParser::isValidVariableName(token)) {
          AtomString variableName = token.value().toAtomString();
          consumeCustomPropertyValue(range.makeSubRange(&amp;range.peek(), declarationValueEnd), variableName, important);
      }
  
<span class="udiff-line-modified-removed">-     if (important &amp;&amp; (ruleType == StyleRule::FontFace || ruleType == StyleRule::Keyframe))</span>
<span class="udiff-line-modified-added">+     if (important &amp;&amp; (ruleType == StyleRuleType::FontFace || ruleType == StyleRuleType::Keyframe))</span>
          return;
  
      if (propertyID != CSSPropertyInvalid)
          consumeDeclarationValue(range.makeSubRange(&amp;range.peek(), declarationValueEnd), propertyID, important, ruleType);
  
<span class="udiff-line-modified-removed">-     if (m_observerWrapper &amp;&amp; (ruleType == StyleRule::Style || ruleType == StyleRule::Keyframe)) {</span>
<span class="udiff-line-modified-added">+     if (m_observerWrapper &amp;&amp; (ruleType == StyleRuleType::Style || ruleType == StyleRuleType::Keyframe)) {</span>
          m_observerWrapper-&gt;observer().observeProperty(
              m_observerWrapper-&gt;startOffset(rangeCopy), m_observerWrapper-&gt;endOffset(rangeCopy),
              important, m_parsedProperties.size() != propertiesCount);
      }
  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -843,11 +835,11 @@</span>
  {
      if (RefPtr&lt;CSSCustomPropertyValue&gt; value = CSSVariableParser::parseDeclarationValue(variableName, range, m_context))
          m_parsedProperties.append(CSSProperty(CSSPropertyCustom, WTFMove(value), important));
  }
  
<span class="udiff-line-modified-removed">- void CSSParserImpl::consumeDeclarationValue(CSSParserTokenRange range, CSSPropertyID propertyID, bool important, StyleRule::Type ruleType)</span>
<span class="udiff-line-modified-added">+ void CSSParserImpl::consumeDeclarationValue(CSSParserTokenRange range, CSSPropertyID propertyID, bool important, StyleRuleType ruleType)</span>
  {
      CSSPropertyParser::parseValue(propertyID, important, range, m_context, m_parsedProperties, ruleType);
  }
  
  std::unique_ptr&lt;Vector&lt;double&gt;&gt; CSSParserImpl::consumeKeyframeKeyList(CSSParserTokenRange range)
</pre>
<center><a href="CSSParserFastPaths.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="CSSParserImpl.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>