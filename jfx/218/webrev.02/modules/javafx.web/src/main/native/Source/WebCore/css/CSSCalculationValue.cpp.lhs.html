<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/WebCore/css/CSSCalculationValue.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (C) 2011, 2012 Google Inc. All rights reserved.
<a name="1" id="anc1"></a><span class="line-modified">  3  * Copyright (C) 2014 Apple Inc. All rights reserved.</span>
  4  *
  5  * Redistribution and use in source and binary forms, with or without
  6  * modification, are permitted provided that the following conditions are
  7  * met:
  8  *
  9  *     * Redistributions of source code must retain the above copyright
 10  * notice, this list of conditions and the following disclaimer.
 11  *     * Redistributions in binary form must reproduce the above
 12  * copyright notice, this list of conditions and the following disclaimer
 13  * in the documentation and/or other materials provided with the
 14  * distribution.
 15  *     * Neither the name of Google Inc. nor the names of its
 16  * contributors may be used to endorse or promote products derived from
 17  * this software without specific prior written permission.
 18  *
 19  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 20  * &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 21  * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 22  * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 23  * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 24  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 25  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 26  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 27  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 28  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 29  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 30  */
 31 
 32 #include &quot;config.h&quot;
 33 #include &quot;CSSCalculationValue.h&quot;
 34 
 35 #include &quot;CSSParser.h&quot;
 36 #include &quot;CSSParserTokenRange.h&quot;
 37 #include &quot;CSSPrimitiveValueMappings.h&quot;
<a name="2" id="anc2"></a>
 38 #include &quot;StyleResolver.h&quot;
 39 #include &lt;wtf/MathExtras.h&gt;
 40 #include &lt;wtf/text/StringBuilder.h&gt;
<a name="3" id="anc3"></a>
 41 
 42 static const int maxExpressionDepth = 100;
 43 
<a name="4" id="anc4"></a><span class="line-modified"> 44 enum ParseState {</span>
<span class="line-modified"> 45     OK,</span>
<span class="line-modified"> 46     TooDeep,</span>
<span class="line-modified"> 47     NoMoreTokens</span>
<span class="line-modified"> 48 };</span>






 49 
 50 namespace WebCore {
 51 
 52 static RefPtr&lt;CSSCalcExpressionNode&gt; createCSS(const CalcExpressionNode&amp;, const RenderStyle&amp;);
 53 static RefPtr&lt;CSSCalcExpressionNode&gt; createCSS(const Length&amp;, const RenderStyle&amp;);
 54 
<a name="5" id="anc5"></a><span class="line-modified"> 55 static CalculationCategory unitCategory(CSSPrimitiveValue::UnitType type)</span>






 56 {
 57     switch (type) {
<a name="6" id="anc6"></a><span class="line-modified"> 58     case CSSPrimitiveValue::CSS_NUMBER:</span>
 59         return CalculationCategory::Number;
<a name="7" id="anc7"></a><span class="line-modified"> 60     case CSSPrimitiveValue::CSS_EMS:</span>
<span class="line-modified"> 61     case CSSPrimitiveValue::CSS_EXS:</span>
<span class="line-modified"> 62     case CSSPrimitiveValue::CSS_PX:</span>
<span class="line-modified"> 63     case CSSPrimitiveValue::CSS_CM:</span>
<span class="line-modified"> 64     case CSSPrimitiveValue::CSS_MM:</span>
<span class="line-modified"> 65     case CSSPrimitiveValue::CSS_IN:</span>
<span class="line-modified"> 66     case CSSPrimitiveValue::CSS_PT:</span>
<span class="line-modified"> 67     case CSSPrimitiveValue::CSS_PC:</span>
<span class="line-modified"> 68     case CSSPrimitiveValue::CSS_REMS:</span>
<span class="line-modified"> 69     case CSSPrimitiveValue::CSS_CHS:</span>
<span class="line-modified"> 70     case CSSPrimitiveValue::CSS_VW:</span>
<span class="line-modified"> 71     case CSSPrimitiveValue::CSS_VH:</span>
<span class="line-modified"> 72     case CSSPrimitiveValue::CSS_VMIN:</span>
<span class="line-modified"> 73     case CSSPrimitiveValue::CSS_VMAX:</span>

 74         return CalculationCategory::Length;
<a name="8" id="anc8"></a><span class="line-modified"> 75     case CSSPrimitiveValue::CSS_PERCENTAGE:</span>
 76         return CalculationCategory::Percent;
<a name="9" id="anc9"></a><span class="line-modified"> 77     case CSSPrimitiveValue::CSS_DEG:</span>
<span class="line-modified"> 78     case CSSPrimitiveValue::CSS_RAD:</span>
<span class="line-modified"> 79     case CSSPrimitiveValue::CSS_GRAD:</span>
<span class="line-modified"> 80     case CSSPrimitiveValue::CSS_TURN:</span>
 81         return CalculationCategory::Angle;
<a name="10" id="anc10"></a><span class="line-modified"> 82     case CSSPrimitiveValue::CSS_MS:</span>
<span class="line-modified"> 83     case CSSPrimitiveValue::CSS_S:</span>
 84         return CalculationCategory::Time;
<a name="11" id="anc11"></a><span class="line-modified"> 85     case CSSPrimitiveValue::CSS_HZ:</span>
<span class="line-modified"> 86     case CSSPrimitiveValue::CSS_KHZ:</span>
 87         return CalculationCategory::Frequency;
 88     default:
 89         return CalculationCategory::Other;
 90     }
 91 }
 92 
<a name="12" id="anc12"></a><span class="line-modified"> 93 static bool hasDoubleValue(CSSPrimitiveValue::UnitType type)</span>
 94 {
 95     switch (type) {
<a name="13" id="anc13"></a><span class="line-modified"> 96     case CSSPrimitiveValue::CSS_FR:</span>
<span class="line-modified"> 97     case CSSPrimitiveValue::CSS_NUMBER:</span>
<span class="line-modified"> 98     case CSSPrimitiveValue::CSS_PERCENTAGE:</span>
<span class="line-modified"> 99     case CSSPrimitiveValue::CSS_EMS:</span>
<span class="line-modified">100     case CSSPrimitiveValue::CSS_EXS:</span>
<span class="line-modified">101     case CSSPrimitiveValue::CSS_CHS:</span>
<span class="line-modified">102     case CSSPrimitiveValue::CSS_REMS:</span>
<span class="line-modified">103     case CSSPrimitiveValue::CSS_PX:</span>
<span class="line-modified">104     case CSSPrimitiveValue::CSS_CM:</span>
<span class="line-modified">105     case CSSPrimitiveValue::CSS_MM:</span>
<span class="line-modified">106     case CSSPrimitiveValue::CSS_IN:</span>
<span class="line-modified">107     case CSSPrimitiveValue::CSS_PT:</span>
<span class="line-modified">108     case CSSPrimitiveValue::CSS_PC:</span>
<span class="line-modified">109     case CSSPrimitiveValue::CSS_DEG:</span>
<span class="line-modified">110     case CSSPrimitiveValue::CSS_RAD:</span>
<span class="line-modified">111     case CSSPrimitiveValue::CSS_GRAD:</span>
<span class="line-modified">112     case CSSPrimitiveValue::CSS_TURN:</span>
<span class="line-modified">113     case CSSPrimitiveValue::CSS_MS:</span>
<span class="line-modified">114     case CSSPrimitiveValue::CSS_S:</span>
<span class="line-modified">115     case CSSPrimitiveValue::CSS_HZ:</span>
<span class="line-modified">116     case CSSPrimitiveValue::CSS_KHZ:</span>
<span class="line-modified">117     case CSSPrimitiveValue::CSS_DIMENSION:</span>
<span class="line-modified">118     case CSSPrimitiveValue::CSS_VW:</span>
<span class="line-modified">119     case CSSPrimitiveValue::CSS_VH:</span>
<span class="line-modified">120     case CSSPrimitiveValue::CSS_VMIN:</span>
<span class="line-modified">121     case CSSPrimitiveValue::CSS_VMAX:</span>
<span class="line-modified">122     case CSSPrimitiveValue::CSS_DPPX:</span>
<span class="line-modified">123     case CSSPrimitiveValue::CSS_DPI:</span>
<span class="line-modified">124     case CSSPrimitiveValue::CSS_DPCM:</span>
<span class="line-modified">125         return true;</span>
<span class="line-modified">126     case CSSPrimitiveValue::CSS_UNKNOWN:</span>
<span class="line-modified">127     case CSSPrimitiveValue::CSS_STRING:</span>
<span class="line-modified">128     case CSSPrimitiveValue::CSS_FONT_FAMILY:</span>
<span class="line-modified">129     case CSSPrimitiveValue::CSS_URI:</span>
<span class="line-removed">130     case CSSPrimitiveValue::CSS_IDENT:</span>
<span class="line-removed">131     case CSSPrimitiveValue::CSS_ATTR:</span>
<span class="line-removed">132     case CSSPrimitiveValue::CSS_COUNTER:</span>
<span class="line-removed">133     case CSSPrimitiveValue::CSS_RECT:</span>
<span class="line-removed">134     case CSSPrimitiveValue::CSS_RGBCOLOR:</span>
<span class="line-removed">135     case CSSPrimitiveValue::CSS_PAIR:</span>
<span class="line-removed">136     case CSSPrimitiveValue::CSS_UNICODE_RANGE:</span>
<span class="line-removed">137     case CSSPrimitiveValue::CSS_COUNTER_NAME:</span>
<span class="line-removed">138     case CSSPrimitiveValue::CSS_SHAPE:</span>
<span class="line-removed">139     case CSSPrimitiveValue::CSS_QUAD:</span>
<span class="line-removed">140     case CSSPrimitiveValue::CSS_QUIRKY_EMS:</span>
<span class="line-removed">141     case CSSPrimitiveValue::CSS_CALC:</span>
<span class="line-removed">142     case CSSPrimitiveValue::CSS_CALC_PERCENTAGE_WITH_NUMBER:</span>
<span class="line-removed">143     case CSSPrimitiveValue::CSS_CALC_PERCENTAGE_WITH_LENGTH:</span>
<span class="line-removed">144     case CSSPrimitiveValue::CSS_PROPERTY_ID:</span>
<span class="line-removed">145     case CSSPrimitiveValue::CSS_VALUE_ID:</span>
<span class="line-removed">146         return false;</span>
<span class="line-removed">147     };</span>
<span class="line-removed">148     ASSERT_NOT_REACHED();</span>
<span class="line-removed">149     return false;</span>
150 }
151 
<a name="14" id="anc14"></a><span class="line-modified">152 String CSSCalcValue::customCSSText() const</span>
153 {
<a name="15" id="anc15"></a><span class="line-modified">154     auto expression = m_expression-&gt;customCSSText();</span>
<span class="line-modified">155     if (expression[0] == &#39;(&#39;)</span>
<span class="line-modified">156         return makeString(&quot;calc&quot;, expression);</span>
<span class="line-modified">157     return makeString(&quot;calc(&quot;, expression, &#39;)&#39;);</span>










158 }
159 
<a name="16" id="anc16"></a><span class="line-modified">160 bool CSSCalcValue::equals(const CSSCalcValue&amp; other) const</span>
161 {
<a name="17" id="anc17"></a><span class="line-modified">162     return compareCSSValue(m_expression, other.m_expression);</span>























































163 }
164 
<a name="18" id="anc18"></a><span class="line-modified">165 inline double CSSCalcValue::clampToPermittedRange(double value) const</span>
166 {
<a name="19" id="anc19"></a><span class="line-modified">167     return m_shouldClampToNonNegative &amp;&amp; value &lt; 0 ? 0 : value;</span>













168 }
169 
<a name="20" id="anc20"></a><span class="line-modified">170 double CSSCalcValue::doubleValue() const</span>

171 {
<a name="21" id="anc21"></a><span class="line-modified">172     return clampToPermittedRange(m_expression-&gt;doubleValue());</span>


173 }
174 
<a name="22" id="anc22"></a><span class="line-modified">175 double CSSCalcValue::computeLengthPx(const CSSToLengthConversionData&amp; conversionData) const</span>
176 {
<a name="23" id="anc23"></a><span class="line-modified">177     return clampToPermittedRange(m_expression-&gt;computeLengthPx(conversionData));</span>


178 }
<a name="24" id="anc24"></a>
179 
<a name="25" id="anc25"></a><span class="line-modified">180 class CSSCalcPrimitiveValue final : public CSSCalcExpressionNode {</span>
181     WTF_MAKE_FAST_ALLOCATED;
182 public:
<a name="26" id="anc26"></a><span class="line-modified">183     static Ref&lt;CSSCalcPrimitiveValue&gt; create(Ref&lt;CSSPrimitiveValue&gt;&amp;&amp; value, bool isInteger)</span>
184     {
<a name="27" id="anc27"></a><span class="line-modified">185         return adoptRef(*new CSSCalcPrimitiveValue(WTFMove(value), isInteger));</span>
186     }
187 
<a name="28" id="anc28"></a><span class="line-modified">188     static RefPtr&lt;CSSCalcPrimitiveValue&gt; create(double value, CSSPrimitiveValue::UnitType type, bool isInteger)</span>
189     {
190         if (!std::isfinite(value))
191             return nullptr;
<a name="29" id="anc29"></a><span class="line-modified">192         return adoptRef(new CSSCalcPrimitiveValue(CSSPrimitiveValue::create(value, type), isInteger));</span>










193     }
194 
<a name="30" id="anc30"></a>


















195 private:
196     bool isZero() const final
197     {
198         return !m_value-&gt;doubleValue();
199     }
200 
<a name="31" id="anc31"></a><span class="line-modified">201     String customCSSText() const final</span>















202     {
<a name="32" id="anc32"></a><span class="line-removed">203         return m_value-&gt;cssText();</span>
204     }
205 
<a name="33" id="anc33"></a><span class="line-modified">206     std::unique_ptr&lt;CalcExpressionNode&gt; createCalcExpression(const CSSToLengthConversionData&amp; conversionData) const final</span>
<span class="line-modified">207     {</span>
<span class="line-modified">208         switch (category()) {</span>
<span class="line-modified">209         case CalculationCategory::Number:</span>
<span class="line-modified">210             return makeUnique&lt;CalcExpressionNumber&gt;(m_value-&gt;floatValue());</span>
<span class="line-modified">211         case CalculationCategory::Length:</span>
<span class="line-modified">212             return makeUnique&lt;CalcExpressionLength&gt;(Length(m_value-&gt;computeLength&lt;float&gt;(conversionData), WebCore::Fixed));</span>
<span class="line-modified">213         case CalculationCategory::Percent:</span>
<span class="line-modified">214         case CalculationCategory::PercentLength: {</span>
<span class="line-modified">215             return makeUnique&lt;CalcExpressionLength&gt;(m_value-&gt;convertToLength&lt;FixedFloatConversion | PercentConversion&gt;(conversionData));</span>
<span class="line-modified">216         }</span>
<span class="line-modified">217         // Only types that could be part of a Length expression can be converted</span>
<span class="line-modified">218         // to a CalcExpressionNode. CalculationCategory::PercentNumber makes no sense as a Length.</span>
<span class="line-modified">219         case CalculationCategory::PercentNumber:</span>
<span class="line-modified">220         case CalculationCategory::Angle:</span>
<span class="line-modified">221         case CalculationCategory::Time:</span>
<span class="line-modified">222         case CalculationCategory::Frequency:</span>
<span class="line-modified">223         case CalculationCategory::Other:</span>
<span class="line-modified">224             ASSERT_NOT_REACHED();</span>
<span class="line-modified">225         }</span>
















226         ASSERT_NOT_REACHED();
<a name="34" id="anc34"></a><span class="line-modified">227         return nullptr;</span>














228     }
<a name="35" id="anc35"></a>
229 
<a name="36" id="anc36"></a><span class="line-modified">230     double doubleValue() const final</span>
<span class="line-modified">231     {</span>
<span class="line-modified">232         if (hasDoubleValue(primitiveType()))</span>
<span class="line-modified">233             return m_value-&gt;doubleValue();</span>










































234         ASSERT_NOT_REACHED();
<a name="37" id="anc37"></a><span class="line-removed">235         return 0;</span>
236     }
<a name="38" id="anc38"></a>


237 
<a name="39" id="anc39"></a><span class="line-modified">238     double computeLengthPx(const CSSToLengthConversionData&amp; conversionData) const final</span>
<span class="line-modified">239     {</span>
<span class="line-modified">240         switch (category()) {</span>
<span class="line-modified">241         case CalculationCategory::Length:</span>
<span class="line-modified">242             return m_value-&gt;computeLength&lt;double&gt;(conversionData);</span>
<span class="line-modified">243         case CalculationCategory::Percent:</span>
<span class="line-modified">244         case CalculationCategory::Number:</span>
<span class="line-removed">245             return m_value-&gt;doubleValue();</span>
<span class="line-removed">246         case CalculationCategory::PercentLength:</span>
<span class="line-removed">247         case CalculationCategory::PercentNumber:</span>
<span class="line-removed">248         case CalculationCategory::Angle:</span>
<span class="line-removed">249         case CalculationCategory::Time:</span>
<span class="line-removed">250         case CalculationCategory::Frequency:</span>
<span class="line-removed">251         case CalculationCategory::Other:</span>
<span class="line-removed">252             ASSERT_NOT_REACHED();</span>
<span class="line-removed">253             break;</span>
254         }
<a name="40" id="anc40"></a>




















255         ASSERT_NOT_REACHED();
<a name="41" id="anc41"></a><span class="line-modified">256         return 0;</span>
257     }
<a name="42" id="anc42"></a>

























258 
<a name="43" id="anc43"></a><span class="line-modified">259     void collectDirectComputationalDependencies(HashSet&lt;CSSPropertyID&gt;&amp; values) const final</span>


260     {
<a name="44" id="anc44"></a><span class="line-modified">261         m_value-&gt;collectDirectComputationalDependencies(values);</span>
262     }
263 
<a name="45" id="anc45"></a><span class="line-modified">264     void collectDirectRootComputationalDependencies(HashSet&lt;CSSPropertyID&gt;&amp; values) const final</span>








265     {
<a name="46" id="anc46"></a><span class="line-removed">266         m_value-&gt;collectDirectRootComputationalDependencies(values);</span>
267     }
268 
<a name="47" id="anc47"></a><span class="line-modified">269     bool equals(const CSSCalcExpressionNode&amp; other) const final</span>
<span class="line-removed">270     {</span>
<span class="line-removed">271         if (type() != other.type())</span>
<span class="line-removed">272             return false;</span>
273 
<a name="48" id="anc48"></a><span class="line-modified">274         return compareCSSValue(m_value, static_cast&lt;const CSSCalcPrimitiveValue&amp;&gt;(other).m_value);</span>
<span class="line-modified">275     }</span>



276 
<a name="49" id="anc49"></a><span class="line-modified">277     Type type() const final { return CssCalcPrimitiveValue; }</span>
<span class="line-modified">278     CSSPrimitiveValue::UnitType primitiveType() const final</span>




















279     {
<a name="50" id="anc50"></a><span class="line-modified">280         return CSSPrimitiveValue::UnitType(m_value-&gt;primitiveType());</span>
281     }
282 
<a name="51" id="anc51"></a>




283 private:
<a name="52" id="anc52"></a><span class="line-modified">284     explicit CSSCalcPrimitiveValue(Ref&lt;CSSPrimitiveValue&gt;&amp;&amp; value, bool isInteger)</span>
<span class="line-modified">285         : CSSCalcExpressionNode(unitCategory((CSSPrimitiveValue::UnitType)value-&gt;primitiveType()), isInteger)</span>
<span class="line-modified">286         , m_value(WTFMove(value))</span>
287     {
288     }
289 
<a name="53" id="anc53"></a><span class="line-modified">290     Ref&lt;CSSPrimitiveValue&gt; m_value;</span>













291 };
292 
<a name="54" id="anc54"></a>




























293 static const CalculationCategory addSubtractResult[static_cast&lt;unsigned&gt;(CalculationCategory::Angle)][static_cast&lt;unsigned&gt;(CalculationCategory::Angle)] = {
294 //    CalculationCategory::Number         CalculationCategory::Length         CalculationCategory::Percent        CalculationCategory::PercentNumber  CalculationCategory::PercentLength
295     { CalculationCategory::Number,        CalculationCategory::Other,         CalculationCategory::PercentNumber, CalculationCategory::PercentNumber, CalculationCategory::Other }, //         CalculationCategory::Number
296     { CalculationCategory::Other,         CalculationCategory::Length,        CalculationCategory::PercentLength, CalculationCategory::Other,         CalculationCategory::PercentLength }, // CalculationCategory::Length
297     { CalculationCategory::PercentNumber, CalculationCategory::PercentLength, CalculationCategory::Percent,       CalculationCategory::PercentNumber, CalculationCategory::PercentLength }, // CalculationCategory::Percent
298     { CalculationCategory::PercentNumber, CalculationCategory::Other,         CalculationCategory::PercentNumber, CalculationCategory::PercentNumber, CalculationCategory::Other }, //         CalculationCategory::PercentNumber
299     { CalculationCategory::Other,         CalculationCategory::PercentLength, CalculationCategory::PercentLength, CalculationCategory::Other,         CalculationCategory::PercentLength }, // CalculationCategory::PercentLength
300 };
301 
302 static CalculationCategory determineCategory(const CSSCalcExpressionNode&amp; leftSide, const CSSCalcExpressionNode&amp; rightSide, CalcOperator op)
303 {
304     CalculationCategory leftCategory = leftSide.category();
305     CalculationCategory rightCategory = rightSide.category();
306     ASSERT(leftCategory &lt; CalculationCategory::Other);
307     ASSERT(rightCategory &lt; CalculationCategory::Other);
308 
309     switch (op) {
310     case CalcOperator::Add:
311     case CalcOperator::Subtract:
312         if (leftCategory &lt; CalculationCategory::Angle &amp;&amp; rightCategory &lt; CalculationCategory::Angle)
313             return addSubtractResult[static_cast&lt;unsigned&gt;(leftCategory)][static_cast&lt;unsigned&gt;(rightCategory)];
314         if (leftCategory == rightCategory)
315             return leftCategory;
316         return CalculationCategory::Other;
317     case CalcOperator::Multiply:
318         if (leftCategory != CalculationCategory::Number &amp;&amp; rightCategory != CalculationCategory::Number)
319             return CalculationCategory::Other;
320         return leftCategory == CalculationCategory::Number ? rightCategory : leftCategory;
321     case CalcOperator::Divide:
322         if (rightCategory != CalculationCategory::Number || rightSide.isZero())
323             return CalculationCategory::Other;
324         return leftCategory;
325     case CalcOperator::Min:
326     case CalcOperator::Max:
<a name="55" id="anc55"></a>
327         ASSERT_NOT_REACHED();
328         return CalculationCategory::Other;
329     }
330 
331     ASSERT_NOT_REACHED();
332     return CalculationCategory::Other;
333 }
334 
<a name="56" id="anc56"></a><span class="line-modified">335 static CalculationCategory resolvedTypeForMinOrMax(CalculationCategory category, CalculationCategory destinationCategory)</span>





































































336 {
337     switch (category) {
338     case CalculationCategory::Number:
339     case CalculationCategory::Length:
340     case CalculationCategory::PercentNumber:
341     case CalculationCategory::PercentLength:
342     case CalculationCategory::Angle:
343     case CalculationCategory::Time:
344     case CalculationCategory::Frequency:
345     case CalculationCategory::Other:
346         return category;
347 
348     case CalculationCategory::Percent:
349         if (destinationCategory == CalculationCategory::Length)
350             return CalculationCategory::PercentLength;
351         if (destinationCategory == CalculationCategory::Number)
352             return CalculationCategory::PercentNumber;
353         return category;
354     }
355 
356     return CalculationCategory::Other;
357 }
358 
<a name="57" id="anc57"></a><span class="line-removed">359 static inline bool isIntegerResult(CalcOperator op, const CSSCalcExpressionNode&amp; leftSide, const CSSCalcExpressionNode&amp; rightSide)</span>
<span class="line-removed">360 {</span>
<span class="line-removed">361     // Performs W3C spec&#39;s type checking for calc integers.</span>
<span class="line-removed">362     // http://www.w3.org/TR/css3-values/#calc-type-checking</span>
<span class="line-removed">363     return op != CalcOperator::Divide &amp;&amp; leftSide.isInteger() &amp;&amp; rightSide.isInteger();</span>
<span class="line-removed">364 }</span>
<span class="line-removed">365 </span>
<span class="line-removed">366 static inline bool isIntegerResult(CalcOperator op, const Vector&lt;Ref&lt;CSSCalcExpressionNode&gt;&gt;&amp; nodes)</span>
<span class="line-removed">367 {</span>
<span class="line-removed">368     // Performs W3C spec&#39;s type checking for calc integers.</span>
<span class="line-removed">369     // http://www.w3.org/TR/css3-values/#calc-type-checking</span>
<span class="line-removed">370     if (op == CalcOperator::Divide)</span>
<span class="line-removed">371         return false;</span>
<span class="line-removed">372 </span>
<span class="line-removed">373     for (auto&amp; node : nodes) {</span>
<span class="line-removed">374         if (!node-&gt;isInteger())</span>
<span class="line-removed">375             return false;</span>
<span class="line-removed">376     }</span>
<span class="line-removed">377 </span>
<span class="line-removed">378     return true;</span>
<span class="line-removed">379 }</span>
<span class="line-removed">380 </span>
381 static bool isSamePair(CalculationCategory a, CalculationCategory b, CalculationCategory x, CalculationCategory y)
382 {
383     return (a == x &amp;&amp; b == y) || (a == y &amp;&amp; b == x);
384 }
385 
<a name="58" id="anc58"></a><span class="line-modified">386 class CSSCalcOperation final : public CSSCalcExpressionNode {</span>
387     WTF_MAKE_FAST_ALLOCATED;
388 public:
<a name="59" id="anc59"></a><span class="line-modified">389     static RefPtr&lt;CSSCalcOperation&gt; create(CalcOperator op, RefPtr&lt;CSSCalcExpressionNode&gt;&amp;&amp; leftSide, RefPtr&lt;CSSCalcExpressionNode&gt;&amp;&amp; rightSide)</span>
<span class="line-modified">390     {</span>
<span class="line-modified">391         if (!leftSide || !rightSide)</span>
<span class="line-modified">392             return nullptr;</span>
393 
<a name="60" id="anc60"></a><span class="line-modified">394         ASSERT(leftSide-&gt;category() &lt; CalculationCategory::Other);</span>
<span class="line-removed">395         ASSERT(rightSide-&gt;category() &lt; CalculationCategory::Other);</span>
396 
<a name="61" id="anc61"></a><span class="line-modified">397         auto newCategory = determineCategory(*leftSide, *rightSide, op);</span>
<span class="line-removed">398         if (newCategory == CalculationCategory::Other)</span>
<span class="line-removed">399             return nullptr;</span>
400 
<a name="62" id="anc62"></a><span class="line-modified">401         return adoptRef(new CSSCalcOperation(newCategory, op, leftSide.releaseNonNull(), rightSide.releaseNonNull()));</span>
<span class="line-modified">402     }</span>



403 
<a name="63" id="anc63"></a><span class="line-modified">404     static RefPtr&lt;CSSCalcOperation&gt; createMinOrMax(CalcOperator op, Vector&lt;Ref&lt;CSSCalcExpressionNode&gt;&gt;&amp;&amp; values, CalculationCategory destinationCategory)</span>
<span class="line-modified">405     {</span>
<span class="line-removed">406         ASSERT(op == CalcOperator::Min || op == CalcOperator::Max);</span>
407 
<a name="64" id="anc64"></a><span class="line-modified">408         Optional&lt;CalculationCategory&gt; category = WTF::nullopt;</span>
<span class="line-removed">409         for (auto&amp; value : values) {</span>
<span class="line-removed">410             auto valueCategory = resolvedTypeForMinOrMax(value-&gt;category(), destinationCategory);</span>
411 
<a name="65" id="anc65"></a><span class="line-modified">412             ASSERT(valueCategory &lt; CalculationCategory::Other);</span>
<span class="line-modified">413             if (!category) {</span>
<span class="line-removed">414                 if (valueCategory == CalculationCategory::Other)</span>
<span class="line-removed">415                     return nullptr;</span>
<span class="line-removed">416                 category = valueCategory;</span>
<span class="line-removed">417             }</span>
418 
<a name="66" id="anc66"></a><span class="line-modified">419             if (category != valueCategory) {</span>
<span class="line-modified">420                 if (isSamePair(category.value(), valueCategory, CalculationCategory::Length, CalculationCategory::PercentLength)) {</span>
<span class="line-modified">421                     category = CalculationCategory::PercentLength;</span>
<span class="line-modified">422                     continue;</span>
<span class="line-modified">423                 }</span>
<span class="line-modified">424                 if (isSamePair(category.value(), valueCategory, CalculationCategory::Number, CalculationCategory::PercentNumber)) {</span>
<span class="line-modified">425                     category = CalculationCategory::PercentNumber;</span>
<span class="line-modified">426                     continue;</span>
<span class="line-modified">427                 }</span>
<span class="line-modified">428                 return nullptr;</span>
<span class="line-modified">429             }</span>
<span class="line-modified">430         }</span>















431 
<a name="67" id="anc67"></a><span class="line-modified">432         return adoptRef(new CSSCalcOperation(category.value(), op, WTFMove(values)));</span>















433     }
434 
<a name="68" id="anc68"></a><span class="line-modified">435     static RefPtr&lt;CSSCalcExpressionNode&gt; createSimplified(CalcOperator op, RefPtr&lt;CSSCalcExpressionNode&gt;&amp;&amp; leftSide, RefPtr&lt;CSSCalcExpressionNode&gt;&amp;&amp; rightSide)</span>
436     {
<a name="69" id="anc69"></a><span class="line-modified">437         if (!leftSide || !rightSide)</span>



























































































438             return nullptr;
<a name="70" id="anc70"></a>

439 
<a name="71" id="anc71"></a><span class="line-modified">440         auto leftCategory = leftSide-&gt;category();</span>
<span class="line-modified">441         auto rightCategory = rightSide-&gt;category();</span>
<span class="line-removed">442         ASSERT(leftCategory &lt; CalculationCategory::Other);</span>
<span class="line-removed">443         ASSERT(rightCategory &lt; CalculationCategory::Other);</span>
444 
<a name="72" id="anc72"></a><span class="line-modified">445         bool isInteger = isIntegerResult(op, *leftSide, *rightSide);</span>


446 
<a name="73" id="anc73"></a><span class="line-modified">447         // Simplify numbers.</span>
<span class="line-modified">448         if (leftCategory == CalculationCategory::Number &amp;&amp; rightCategory == CalculationCategory::Number) {</span>
<span class="line-modified">449             CSSPrimitiveValue::UnitType evaluationType = CSSPrimitiveValue::CSS_NUMBER;</span>
<span class="line-modified">450             return CSSCalcPrimitiveValue::create(evaluateOperator(op, { leftSide-&gt;doubleValue(), rightSide-&gt;doubleValue() }), evaluationType, isInteger);</span>
451         }
<a name="74" id="anc74"></a>

452 
<a name="75" id="anc75"></a><span class="line-modified">453         // Simplify addition and subtraction between same types.</span>
<span class="line-modified">454         if (op == CalcOperator::Add || op == CalcOperator::Subtract) {</span>
<span class="line-modified">455             if (leftCategory == rightSide-&gt;category()) {</span>
<span class="line-modified">456                 CSSPrimitiveValue::UnitType leftType = leftSide-&gt;primitiveType();</span>
<span class="line-modified">457                 if (hasDoubleValue(leftType)) {</span>
<span class="line-modified">458                     CSSPrimitiveValue::UnitType rightType = rightSide-&gt;primitiveType();</span>
<span class="line-modified">459                     if (leftType == rightType)</span>
<span class="line-modified">460                         return CSSCalcPrimitiveValue::create(evaluateOperator(op, { leftSide-&gt;doubleValue(), rightSide-&gt;doubleValue() }), leftType, isInteger);</span>
<span class="line-modified">461                     CSSPrimitiveValue::UnitCategory leftUnitCategory = CSSPrimitiveValue::unitCategory(leftType);</span>
<span class="line-modified">462                     if (leftUnitCategory != CSSPrimitiveValue::UOther &amp;&amp; leftUnitCategory == CSSPrimitiveValue::unitCategory(rightType)) {</span>
<span class="line-modified">463                         CSSPrimitiveValue::UnitType canonicalType = CSSPrimitiveValue::canonicalUnitTypeForCategory(leftUnitCategory);</span>
<span class="line-modified">464                         if (canonicalType != CSSPrimitiveValue::CSS_UNKNOWN) {</span>
<span class="line-modified">465                             double leftValue = leftSide-&gt;doubleValue() * CSSPrimitiveValue::conversionToCanonicalUnitsScaleFactor(leftType);</span>
<span class="line-modified">466                             double rightValue = rightSide-&gt;doubleValue() * CSSPrimitiveValue::conversionToCanonicalUnitsScaleFactor(rightType);</span>
<span class="line-modified">467                             return CSSCalcPrimitiveValue::create(evaluateOperator(op, { leftValue, rightValue }), canonicalType, isInteger);</span>
<span class="line-modified">468                         }</span>
<span class="line-modified">469                     }</span>
<span class="line-modified">470                 }</span>












































































































471             }
<a name="76" id="anc76"></a><span class="line-removed">472         } else {</span>
<span class="line-removed">473             // Simplify multiplying or dividing by a number for simplifiable types.</span>
<span class="line-removed">474             ASSERT(op == CalcOperator::Multiply || op == CalcOperator::Divide);</span>
<span class="line-removed">475             auto* numberSide = getNumberSide(*leftSide, *rightSide);</span>
<span class="line-removed">476             if (!numberSide)</span>
<span class="line-removed">477                 return create(op, leftSide.releaseNonNull(), rightSide.releaseNonNull());</span>
<span class="line-removed">478             if (numberSide == leftSide &amp;&amp; op == CalcOperator::Divide)</span>
<span class="line-removed">479                 return nullptr;</span>
<span class="line-removed">480             auto&amp; otherSide = leftSide == numberSide ? *rightSide : *leftSide;</span>
481 
<a name="77" id="anc77"></a><span class="line-modified">482             double number = numberSide-&gt;doubleValue();</span>
<span class="line-modified">483             if (!std::isfinite(number))</span>
<span class="line-modified">484                 return nullptr;</span>
<span class="line-modified">485             if (op == CalcOperator::Divide &amp;&amp; !number)</span>
<span class="line-modified">486                 return nullptr;</span>














487 
<a name="78" id="anc78"></a><span class="line-modified">488             auto otherType = otherSide.primitiveType();</span>
<span class="line-modified">489             if (hasDoubleValue(otherType))</span>
<span class="line-modified">490                 return CSSCalcPrimitiveValue::create(evaluateOperator(op, { otherSide.doubleValue(), number }), otherType, isInteger);</span>





491         }
492 
<a name="79" id="anc79"></a><span class="line-modified">493         return create(op, leftSide.releaseNonNull(), rightSide.releaseNonNull());</span>


494     }
495 
<a name="80" id="anc80"></a><span class="line-modified">496 private:</span>
<span class="line-modified">497     bool isZero() const final</span>
<span class="line-modified">498     {</span>
<span class="line-modified">499         return !doubleValue();</span>









































500     }
501 
<a name="81" id="anc81"></a><span class="line-modified">502     std::unique_ptr&lt;CalcExpressionNode&gt; createCalcExpression(const CSSToLengthConversionData&amp; conversionData) const final</span>
<span class="line-modified">503     {</span>
<span class="line-modified">504         Vector&lt;std::unique_ptr&lt;CalcExpressionNode&gt;&gt; nodes;</span>
<span class="line-modified">505         nodes.reserveInitialCapacity(m_children.size());</span>

506 
<a name="82" id="anc82"></a><span class="line-modified">507         for (auto&amp; child : m_children) {</span>
<span class="line-modified">508             auto node = child-&gt;createCalcExpression(conversionData);</span>
<span class="line-modified">509             if (!node)</span>
<span class="line-modified">510                 return nullptr;</span>
<span class="line-modified">511             nodes.uncheckedAppend(WTFMove(node));</span>





















512         }
<a name="83" id="anc83"></a><span class="line-modified">513         return makeUnique&lt;CalcExpressionOperation&gt;(WTFMove(nodes), m_operator);</span>











514     }
515 
<a name="84" id="anc84"></a><span class="line-modified">516     double doubleValue() const final</span>
<span class="line-modified">517     {</span>
<span class="line-modified">518         Vector&lt;double&gt; doubleValues;</span>
<span class="line-modified">519         for (auto&amp; child : m_children)</span>
<span class="line-modified">520             doubleValues.append(child-&gt;doubleValue());</span>
<span class="line-modified">521         return evaluate(doubleValues);</span>









522     }
523 
<a name="85" id="anc85"></a><span class="line-modified">524     double computeLengthPx(const CSSToLengthConversionData&amp; conversionData) const final</span>
<span class="line-modified">525     {</span>
<span class="line-modified">526         Vector&lt;double&gt; doubleValues;</span>
<span class="line-modified">527         for (auto&amp; child : m_children)</span>
<span class="line-modified">528             doubleValues.append(child-&gt;computeLengthPx(conversionData));</span>
<span class="line-modified">529         return evaluate(doubleValues);</span>








































530     }
531 
<a name="86" id="anc86"></a><span class="line-modified">532     void collectDirectComputationalDependencies(HashSet&lt;CSSPropertyID&gt;&amp; values) const final</span>
<span class="line-modified">533     {</span>
<span class="line-modified">534         for (auto&amp; child : m_children)</span>
<span class="line-modified">535             child-&gt;collectDirectComputationalDependencies(values);</span>









536     }
537 
<a name="87" id="anc87"></a><span class="line-modified">538     void collectDirectRootComputationalDependencies(HashSet&lt;CSSPropertyID&gt;&amp; values) const final</span>
<span class="line-modified">539     {</span>






















540         for (auto&amp; child : m_children)
<a name="88" id="anc88"></a><span class="line-modified">541             child-&gt;collectDirectRootComputationalDependencies(values);</span>



















542     }
543 
<a name="89" id="anc89"></a><span class="line-modified">544     static String buildCssText(Vector&lt;String&gt; childExpressions, CalcOperator op)</span>
<span class="line-modified">545     {</span>
<span class="line-modified">546         StringBuilder result;</span>
<span class="line-modified">547         result.append(&#39;(&#39;);</span>
<span class="line-modified">548         switch (op) {</span>
<span class="line-modified">549         case CalcOperator::Add:</span>
<span class="line-modified">550         case CalcOperator::Subtract:</span>
<span class="line-modified">551         case CalcOperator::Multiply:</span>
<span class="line-modified">552         case CalcOperator::Divide:</span>
<span class="line-modified">553             ASSERT(childExpressions.size() == 2);</span>
<span class="line-modified">554             result.append(childExpressions[0]);</span>
<span class="line-modified">555             result.append(&#39; &#39;);</span>
<span class="line-modified">556             result.append(static_cast&lt;char&gt;(op));</span>
<span class="line-modified">557             result.append(&#39; &#39;);</span>
<span class="line-modified">558             result.append(childExpressions[1]);</span>
<span class="line-modified">559             break;</span>
<span class="line-modified">560         case CalcOperator::Min:</span>
<span class="line-modified">561         case CalcOperator::Max:</span>
<span class="line-modified">562             ASSERT(!childExpressions.isEmpty());</span>
<span class="line-modified">563             const char* functionName = op == CalcOperator::Min ? &quot;min(&quot; : &quot;max(&quot;;</span>
<span class="line-modified">564             result.append(functionName);</span>
<span class="line-modified">565             result.append(childExpressions[0]);</span>
<span class="line-modified">566             for (size_t i = 1; i &lt; childExpressions.size(); ++i) {</span>
<span class="line-modified">567                 result.append(&#39;,&#39;);</span>
<span class="line-modified">568                 result.append(&#39; &#39;);</span>
<span class="line-modified">569                 result.append(childExpressions[i]);</span>


























































































































570             }
<a name="90" id="anc90"></a><span class="line-modified">571             result.append(&#39;)&#39;);</span>



572         }
<a name="91" id="anc91"></a><span class="line-removed">573         result.append(&#39;)&#39;);</span>
574 
<a name="92" id="anc92"></a><span class="line-modified">575         return result.toString();</span>














































576     }
577 
<a name="93" id="anc93"></a><span class="line-modified">578     String customCSSText() const final</span>
<span class="line-modified">579     {</span>
<span class="line-modified">580         Vector&lt;String&gt; cssTexts;</span>
<span class="line-modified">581         for (auto&amp; child : m_children)</span>
<span class="line-modified">582             cssTexts.append(child-&gt;customCSSText());</span>
<span class="line-modified">583         return buildCssText(cssTexts, m_operator);</span>




















































































584     }
<a name="94" id="anc94"></a>



585 
<a name="95" id="anc95"></a><span class="line-removed">586     bool equals(const CSSCalcExpressionNode&amp; exp) const final</span>
<span class="line-removed">587     {</span>
<span class="line-removed">588         if (type() != exp.type())</span>
<span class="line-removed">589             return false;</span>
590 
<a name="96" id="anc96"></a><span class="line-modified">591         const CSSCalcOperation&amp; other = static_cast&lt;const CSSCalcOperation&amp;&gt;(exp);</span>




592 
<a name="97" id="anc97"></a><span class="line-modified">593         if (m_children.size() != other.m_children.size() || m_operator != other.m_operator)</span>
<span class="line-removed">594             return false;</span>
595 
<a name="98" id="anc98"></a><span class="line-modified">596         for (size_t i = 0; i &lt; m_children.size(); ++i) {</span>
<span class="line-modified">597             if (!compareCSSValue(m_children[i], other.m_children[i]))</span>
<span class="line-modified">598                 return false;</span>
<span class="line-modified">599         }</span>
<span class="line-modified">600         return true;</span>

601     }
602 
<a name="99" id="anc99"></a><span class="line-modified">603     Type type() const final { return CssCalcOperation; }</span>





604 
<a name="100" id="anc100"></a><span class="line-modified">605     CSSPrimitiveValue::UnitType primitiveType() const final</span>
<span class="line-modified">606     {</span>
<span class="line-removed">607         switch (category()) {</span>
<span class="line-removed">608         case CalculationCategory::Number:</span>
<span class="line-removed">609 #if !ASSERT_DISABLED</span>
<span class="line-removed">610             for (auto&amp; child : m_children)</span>
<span class="line-removed">611                 ASSERT(child-&gt;category() == CalculationCategory::Number);</span>
<span class="line-removed">612 #endif</span>
<span class="line-removed">613             return CSSPrimitiveValue::CSS_NUMBER;</span>
<span class="line-removed">614         case CalculationCategory::Length:</span>
<span class="line-removed">615         case CalculationCategory::Percent: {</span>
<span class="line-removed">616             if (m_children.isEmpty())</span>
<span class="line-removed">617                 return CSSPrimitiveValue::CSS_UNKNOWN;</span>
<span class="line-removed">618             if (m_children.size() == 2) {</span>
<span class="line-removed">619                 if (m_children[0]-&gt;category() == CalculationCategory::Number)</span>
<span class="line-removed">620                     return m_children[1]-&gt;primitiveType();</span>
<span class="line-removed">621                 if (m_children[1]-&gt;category() == CalculationCategory::Number)</span>
<span class="line-removed">622                     return m_children[0]-&gt;primitiveType();</span>
<span class="line-removed">623             }</span>
<span class="line-removed">624             CSSPrimitiveValue::UnitType firstType = m_children[0]-&gt;primitiveType();</span>
<span class="line-removed">625             for (auto&amp; child : m_children) {</span>
<span class="line-removed">626                 if (firstType != child-&gt;primitiveType())</span>
<span class="line-removed">627                     return CSSPrimitiveValue::CSS_UNKNOWN;</span>
<span class="line-removed">628             }</span>
<span class="line-removed">629             return firstType;</span>
<span class="line-removed">630         }</span>
<span class="line-removed">631         case CalculationCategory::Angle:</span>
<span class="line-removed">632             return CSSPrimitiveValue::CSS_DEG;</span>
<span class="line-removed">633         case CalculationCategory::Time:</span>
<span class="line-removed">634             return CSSPrimitiveValue::CSS_MS;</span>
<span class="line-removed">635         case CalculationCategory::Frequency:</span>
<span class="line-removed">636             return CSSPrimitiveValue::CSS_HZ;</span>
<span class="line-removed">637         case CalculationCategory::PercentLength:</span>
<span class="line-removed">638         case CalculationCategory::PercentNumber:</span>
<span class="line-removed">639         case CalculationCategory::Other:</span>
<span class="line-removed">640             return CSSPrimitiveValue::CSS_UNKNOWN;</span>
<span class="line-removed">641         }</span>
<span class="line-removed">642         ASSERT_NOT_REACHED();</span>
<span class="line-removed">643         return CSSPrimitiveValue::CSS_UNKNOWN;</span>
<span class="line-removed">644     }</span>
645 
<a name="101" id="anc101"></a><span class="line-modified">646     CSSCalcOperation(CalculationCategory category, CalcOperator op, Ref&lt;CSSCalcExpressionNode&gt;&amp;&amp; leftSide, Ref&lt;CSSCalcExpressionNode&gt;&amp;&amp; rightSide)</span>
<span class="line-modified">647         : CSSCalcExpressionNode(category, isIntegerResult(op, leftSide.get(), rightSide.get()))</span>
<span class="line-modified">648         , m_operator(op)</span>
<span class="line-modified">649     {</span>
<span class="line-modified">650         m_children.reserveInitialCapacity(2);</span>
<span class="line-modified">651         m_children.uncheckedAppend(WTFMove(leftSide));</span>
<span class="line-modified">652         m_children.uncheckedAppend(WTFMove(rightSide));</span>
<span class="line-modified">653     }</span>













654 
<a name="102" id="anc102"></a><span class="line-modified">655     CSSCalcOperation(CalculationCategory category, CalcOperator op, Vector&lt;Ref&lt;CSSCalcExpressionNode&gt;&gt;&amp;&amp; children)</span>
<span class="line-modified">656         : CSSCalcExpressionNode(category, isIntegerResult(op, children))</span>
<span class="line-modified">657         , m_operator(op)</span>
<span class="line-modified">658         , m_children(WTFMove(children))</span>
<span class="line-removed">659     {</span>
<span class="line-removed">660     }</span>
661 
<a name="103" id="anc103"></a><span class="line-modified">662     static CSSCalcExpressionNode* getNumberSide(CSSCalcExpressionNode&amp; leftSide, CSSCalcExpressionNode&amp; rightSide)</span>
<span class="line-removed">663     {</span>
<span class="line-removed">664         if (leftSide.category() == CalculationCategory::Number)</span>
<span class="line-removed">665             return &amp;leftSide;</span>
<span class="line-removed">666         if (rightSide.category() == CalculationCategory::Number)</span>
<span class="line-removed">667             return &amp;rightSide;</span>
668         return nullptr;
<a name="104" id="anc104"></a><span class="line-removed">669     }</span>
670 
<a name="105" id="anc105"></a><span class="line-modified">671     double evaluate(const Vector&lt;double&gt;&amp; children) const</span>
<span class="line-removed">672     {</span>
<span class="line-removed">673         return evaluateOperator(m_operator, children);</span>
<span class="line-removed">674     }</span>
675 
<a name="106" id="anc106"></a><span class="line-modified">676     static double evaluateOperator(CalcOperator op, const Vector&lt;double&gt;&amp; children)</span>
<span class="line-removed">677     {</span>
<span class="line-removed">678         switch (op) {</span>
<span class="line-removed">679         case CalcOperator::Add:</span>
<span class="line-removed">680             ASSERT(children.size() == 2);</span>
<span class="line-removed">681             return children[0] + children[1];</span>
<span class="line-removed">682         case CalcOperator::Subtract:</span>
<span class="line-removed">683             ASSERT(children.size() == 2);</span>
<span class="line-removed">684             return children[0] - children[1];</span>
<span class="line-removed">685         case CalcOperator::Multiply:</span>
<span class="line-removed">686             ASSERT(children.size() == 2);</span>
<span class="line-removed">687             return children[0] * children[1];</span>
<span class="line-removed">688         case CalcOperator::Divide:</span>
<span class="line-removed">689             ASSERT(children.size() == 1 || children.size() == 2);</span>
<span class="line-removed">690             if (children.size() == 1)</span>
<span class="line-removed">691                 return std::numeric_limits&lt;double&gt;::quiet_NaN();</span>
<span class="line-removed">692             return children[0] / children[1];</span>
<span class="line-removed">693         case CalcOperator::Min: {</span>
<span class="line-removed">694             if (children.isEmpty())</span>
<span class="line-removed">695                 return std::numeric_limits&lt;double&gt;::quiet_NaN();</span>
<span class="line-removed">696             double minimum = children[0];</span>
<span class="line-removed">697             for (auto child : children)</span>
<span class="line-removed">698                 minimum = std::min(minimum, child);</span>
<span class="line-removed">699             return minimum;</span>
<span class="line-removed">700         }</span>
<span class="line-removed">701         case CalcOperator::Max: {</span>
<span class="line-removed">702             if (children.isEmpty())</span>
<span class="line-removed">703                 return std::numeric_limits&lt;double&gt;::quiet_NaN();</span>
<span class="line-removed">704             double maximum = children[0];</span>
<span class="line-removed">705             for (auto child : children)</span>
<span class="line-removed">706                 maximum = std::max(maximum, child);</span>
<span class="line-removed">707             return maximum;</span>
<span class="line-removed">708         }</span>
<span class="line-removed">709         }</span>
<span class="line-removed">710         ASSERT_NOT_REACHED();</span>
<span class="line-removed">711         return 0;</span>
<span class="line-removed">712     }</span>
713 
<a name="107" id="anc107"></a><span class="line-modified">714     const CalcOperator m_operator;</span>
<span class="line-modified">715     Vector&lt;Ref&lt;CSSCalcExpressionNode&gt;&gt; m_children;</span>







716 };
717 
<a name="108" id="anc108"></a><span class="line-modified">718 static ParseState checkDepthAndIndex(int* depth, CSSParserTokenRange tokens)</span>
719 {
<a name="109" id="anc109"></a><span class="line-removed">720     (*depth)++;</span>
721     if (tokens.atEnd())
722         return NoMoreTokens;
<a name="110" id="anc110"></a><span class="line-modified">723     if (*depth &gt; maxExpressionDepth)</span>

724         return TooDeep;
<a name="111" id="anc111"></a>
725     return OK;
726 }
727 
<a name="112" id="anc112"></a><span class="line-modified">728 class CSSCalcExpressionNodeParser {</span>
<span class="line-modified">729 public:</span>
<span class="line-modified">730     explicit CSSCalcExpressionNodeParser(CalculationCategory destinationCategory)</span>
<span class="line-modified">731         : m_destinationCategory(destinationCategory)</span>
<span class="line-removed">732     { }</span>
733 
<a name="113" id="anc113"></a><span class="line-modified">734     RefPtr&lt;CSSCalcExpressionNode&gt; parseCalc(CSSParserTokenRange tokens, CSSValueID function)</span>
<span class="line-modified">735     {</span>
<span class="line-modified">736         Value result;</span>
<span class="line-modified">737         tokens.consumeWhitespace();</span>
<span class="line-modified">738         bool ok = false;</span>
<span class="line-modified">739         if (function == CSSValueCalc || function == CSSValueWebkitCalc)</span>
<span class="line-modified">740             ok = parseValueExpression(tokens, 0, &amp;result);</span>
<span class="line-modified">741         else if (function == CSSValueMin || function == CSSValueMax)</span>
<span class="line-modified">742             ok = parseMinMaxExpression(tokens, function, 0, &amp;result);</span>
<span class="line-modified">743         if (!ok || !tokens.atEnd())</span>
<span class="line-modified">744             return nullptr;</span>
<span class="line-modified">745         return result.value;</span>







746     }
747 
<a name="114" id="anc114"></a><span class="line-modified">748 private:</span>
<span class="line-removed">749     struct Value {</span>
<span class="line-removed">750         RefPtr&lt;CSSCalcExpressionNode&gt; value;</span>
<span class="line-removed">751     };</span>
752 
<a name="115" id="anc115"></a><span class="line-modified">753     char operatorValue(const CSSParserToken&amp; token)</span>
<span class="line-modified">754     {</span>
<span class="line-modified">755         if (token.type() == DelimiterToken)</span>
<span class="line-modified">756             return token.delimiter();</span>
<span class="line-modified">757         return 0;</span>
<span class="line-modified">758     }</span>



759 
<a name="116" id="anc116"></a><span class="line-modified">760     bool parseValue(CSSParserTokenRange&amp; tokens, Value* result)</span>
<span class="line-modified">761     {</span>
<span class="line-removed">762         CSSParserToken token = tokens.consumeIncludingWhitespace();</span>
<span class="line-removed">763         if (!(token.type() == NumberToken || token.type() == PercentageToken || token.type() == DimensionToken))</span>
764             return false;
765 
<a name="117" id="anc117"></a><span class="line-modified">766         CSSPrimitiveValue::UnitType type = token.unitType();</span>
<span class="line-modified">767         if (unitCategory(type) == CalculationCategory::Other)</span>
768             return false;
769 
<a name="118" id="anc118"></a><span class="line-modified">770         bool isInteger = token.numericValueType() == IntegerValueType || (token.numericValueType() == NumberValueType &amp;&amp; token.numericValue() == trunc(token.numericValue()));</span>
<span class="line-modified">771         result-&gt;value = CSSCalcPrimitiveValue::create(CSSPrimitiveValue::create(token.numericValue(), type), isInteger);</span>

772 
<a name="119" id="anc119"></a><span class="line-modified">773         return true;</span>



















774     }
775 
<a name="120" id="anc120"></a><span class="line-modified">776     bool parseValueTerm(CSSParserTokenRange&amp; tokens, int depth, Value* result)</span>
<span class="line-modified">777     {</span>
<span class="line-modified">778         if (checkDepthAndIndex(&amp;depth, tokens) != OK)</span>
<span class="line-modified">779             return false;</span>




780 
<a name="121" id="anc121"></a><span class="line-modified">781         auto functionId = tokens.peek().functionId();</span>


782 
<a name="122" id="anc122"></a><span class="line-modified">783         if (tokens.peek().type() == LeftParenthesisToken || functionId == CSSValueCalc) {</span>
<span class="line-removed">784             CSSParserTokenRange innerRange = tokens.consumeBlock();</span>
<span class="line-removed">785             tokens.consumeWhitespace();</span>
<span class="line-removed">786             innerRange.consumeWhitespace();</span>
<span class="line-removed">787             return parseValueExpression(innerRange, depth, result);</span>
<span class="line-removed">788         }</span>
789 
<a name="123" id="anc123"></a><span class="line-modified">790         if (functionId == CSSValueMax || functionId == CSSValueMin) {</span>
<span class="line-modified">791             CSSParserTokenRange innerRange = tokens.consumeBlock();</span>
<span class="line-modified">792             tokens.consumeWhitespace();</span>
<span class="line-modified">793             innerRange.consumeWhitespace();</span>
<span class="line-modified">794             return parseMinMaxExpression(innerRange, functionId, depth, result);</span>







795         }
796 
<a name="124" id="anc124"></a><span class="line-modified">797         return parseValue(tokens, result);</span>









798     }
799 
<a name="125" id="anc125"></a><span class="line-modified">800     bool parseValueMultiplicativeExpression(CSSParserTokenRange&amp; tokens, int depth, Value* result)</span>
<span class="line-modified">801     {</span>
<span class="line-removed">802         if (checkDepthAndIndex(&amp;depth, tokens) != OK)</span>
<span class="line-removed">803             return false;</span>
804 
<a name="126" id="anc126"></a><span class="line-modified">805         if (!parseValueTerm(tokens, depth, result))</span>
<span class="line-modified">806             return false;</span>


807 
<a name="127" id="anc127"></a><span class="line-modified">808         while (!tokens.atEnd()) {</span>
<span class="line-modified">809             char operatorCharacter = operatorValue(tokens.peek());</span>
<span class="line-modified">810             if (operatorCharacter != static_cast&lt;char&gt;(CalcOperator::Multiply) &amp;&amp; operatorCharacter != static_cast&lt;char&gt;(CalcOperator::Divide))</span>
<span class="line-removed">811                 break;</span>
<span class="line-removed">812             tokens.consumeIncludingWhitespace();</span>
813 
<a name="128" id="anc128"></a><span class="line-modified">814             Value rhs;</span>
<span class="line-modified">815             if (!parseValueTerm(tokens, depth, &amp;rhs))</span>
<span class="line-modified">816                 return false;</span>




817 
<a name="129" id="anc129"></a><span class="line-modified">818             result-&gt;value = CSSCalcOperation::createSimplified(static_cast&lt;CalcOperator&gt;(operatorCharacter), WTFMove(result-&gt;value), WTFMove(rhs.value));</span>


819 
<a name="130" id="anc130"></a><span class="line-modified">820             if (!result-&gt;value)</span>
<span class="line-modified">821                 return false;</span>
<span class="line-removed">822         }</span>
823 
<a name="131" id="anc131"></a><span class="line-modified">824         return true;</span>



825     }
826 
<a name="132" id="anc132"></a><span class="line-modified">827     bool parseAdditiveValueExpression(CSSParserTokenRange&amp; tokens, int depth, Value* result)</span>
<span class="line-modified">828     {</span>
<span class="line-modified">829         if (checkDepthAndIndex(&amp;depth, tokens) != OK)</span>
<span class="line-modified">830             return false;</span>
831 
<a name="133" id="anc133"></a><span class="line-modified">832         if (!parseValueMultiplicativeExpression(tokens, depth, result))</span>
<span class="line-modified">833             return false;</span>

834 
<a name="134" id="anc134"></a><span class="line-modified">835         while (!tokens.atEnd()) {</span>
<span class="line-modified">836             char operatorCharacter = operatorValue(tokens.peek());</span>
<span class="line-modified">837             if (operatorCharacter != static_cast&lt;char&gt;(CalcOperator::Add) &amp;&amp; operatorCharacter != static_cast&lt;char&gt;(CalcOperator::Subtract))</span>
<span class="line-modified">838                 break;</span>
<span class="line-removed">839             if ((&amp;tokens.peek() - 1)-&gt;type() != WhitespaceToken)</span>
<span class="line-removed">840                 return false; // calc(1px+ 2px) is invalid</span>
<span class="line-removed">841             tokens.consume();</span>
<span class="line-removed">842             if (tokens.peek().type() != WhitespaceToken)</span>
<span class="line-removed">843                 return false; // calc(1px +2px) is invalid</span>
<span class="line-removed">844             tokens.consumeIncludingWhitespace();</span>
<span class="line-removed">845 </span>
<span class="line-removed">846             Value rhs;</span>
<span class="line-removed">847             if (!parseValueMultiplicativeExpression(tokens, depth, &amp;rhs))</span>
<span class="line-removed">848                 return false;</span>
849 
<a name="135" id="anc135"></a><span class="line-modified">850             result-&gt;value = CSSCalcOperation::createSimplified(static_cast&lt;CalcOperator&gt;(operatorCharacter), WTFMove(result-&gt;value), WTFMove(rhs.value));</span>
<span class="line-modified">851             if (!result-&gt;value)</span>
<span class="line-modified">852                 return false;</span>
<span class="line-removed">853         }</span>
854 
<a name="136" id="anc136"></a><span class="line-modified">855         return true;</span>
<span class="line-removed">856     }</span>
857 
<a name="137" id="anc137"></a><span class="line-modified">858     bool parseMinMaxExpression(CSSParserTokenRange&amp; tokens, CSSValueID minMaxFunction, int depth, Value* result)</span>
<span class="line-modified">859     {</span>
<span class="line-modified">860         if (checkDepthAndIndex(&amp;depth, tokens) != OK)</span>
<span class="line-modified">861             return false;</span>
862 
<a name="138" id="anc138"></a><span class="line-modified">863         CalcOperator op = (minMaxFunction == CSSValueMin) ? CalcOperator::Min : CalcOperator::Max;</span>

864 
<a name="139" id="anc139"></a><span class="line-modified">865         Value value;</span>
<span class="line-modified">866         if (!parseValueExpression(tokens, depth, &amp;value))</span>
<span class="line-modified">867             return false;</span>
868 
<a name="140" id="anc140"></a><span class="line-modified">869         Vector&lt;Ref&lt;CSSCalcExpressionNode&gt;&gt; nodes;</span>
<span class="line-removed">870         nodes.append(value.value.releaseNonNull());</span>
871 
<a name="141" id="anc141"></a><span class="line-modified">872         while (!tokens.atEnd()) {</span>
<span class="line-modified">873             tokens.consumeWhitespace();</span>
<span class="line-modified">874             if (tokens.consume().type() != CommaToken)</span>
<span class="line-removed">875                 return false;</span>
<span class="line-removed">876             tokens.consumeWhitespace();</span>
877 
<a name="142" id="anc142"></a><span class="line-modified">878             if (!parseValueExpression(tokens, depth, &amp;value))</span>
<span class="line-modified">879                 return false;</span>
880 
<a name="143" id="anc143"></a><span class="line-modified">881             nodes.append(value.value.releaseNonNull());</span>
<span class="line-modified">882         }</span>
883 
<a name="144" id="anc144"></a><span class="line-modified">884         result-&gt;value = CSSCalcOperation::createMinOrMax(op, WTFMove(nodes), m_destinationCategory);</span>
<span class="line-removed">885         return result-&gt;value;</span>
886     }
887 
<a name="145" id="anc145"></a><span class="line-modified">888     bool parseValueExpression(CSSParserTokenRange&amp; tokens, int depth, Value* result)</span>
<span class="line-modified">889     {</span>
<span class="line-modified">890         return parseAdditiveValueExpression(tokens, depth, result);</span>
891     }
892 
<a name="146" id="anc146"></a><span class="line-modified">893     CalculationCategory m_destinationCategory;</span>
<span class="line-modified">894 };</span>







895 
<a name="147" id="anc147"></a><span class="line-modified">896 static inline RefPtr&lt;CSSCalcOperation&gt; createBlendHalf(const Length&amp; length, const RenderStyle&amp; style, float progress)</span>
897 {
<a name="148" id="anc148"></a><span class="line-modified">898     return CSSCalcOperation::create(CalcOperator::Multiply, createCSS(length, style),</span>
<span class="line-modified">899         CSSCalcPrimitiveValue::create(CSSPrimitiveValue::create(progress, CSSPrimitiveValue::CSS_NUMBER), !progress || progress == 1));</span>







900 }
901 
902 static RefPtr&lt;CSSCalcExpressionNode&gt; createCSS(const CalcExpressionNode&amp; node, const RenderStyle&amp; style)
903 {
904     switch (node.type()) {
905     case CalcExpressionNodeType::Number: {
<a name="149" id="anc149"></a><span class="line-modified">906         float value = toCalcExpressionNumber(node).value();</span>
<span class="line-modified">907         return CSSCalcPrimitiveValue::create(CSSPrimitiveValue::create(value, CSSPrimitiveValue::CSS_NUMBER), value == std::trunc(value));</span>
908     }
909     case CalcExpressionNodeType::Length:
<a name="150" id="anc150"></a><span class="line-modified">910         return createCSS(toCalcExpressionLength(node).length(), style);</span>













911     case CalcExpressionNodeType::Operation: {
<a name="151" id="anc151"></a><span class="line-modified">912         auto&amp; operationNode = toCalcExpressionOperation(node);</span>
913         auto&amp; operationChildren = operationNode.children();
914         CalcOperator op = operationNode.getOperator();
<a name="152" id="anc152"></a><span class="line-modified">915         if (op == CalcOperator::Min || op == CalcOperator::Max) {</span>









916             Vector&lt;Ref&lt;CSSCalcExpressionNode&gt;&gt; values;
917             values.reserveInitialCapacity(operationChildren.size());
<a name="153" id="anc153"></a><span class="line-modified">918             for (auto&amp; child : operationChildren) {</span>
<span class="line-modified">919                 auto cssNode = createCSS(*child, style);</span>
<span class="line-modified">920                 if (!cssNode)</span>
<span class="line-modified">921                     return nullptr;</span>
<span class="line-modified">922                 values.uncheckedAppend(*cssNode);</span>
<span class="line-modified">923             }</span>
<span class="line-modified">924             return CSSCalcOperation::createMinOrMax(operationNode.getOperator(), WTFMove(values), CalculationCategory::Other);</span>













925         }
<a name="154" id="anc154"></a>













926 
<a name="155" id="anc155"></a><span class="line-modified">927         if (operationChildren.size() == 2)</span>
<span class="line-modified">928             return CSSCalcOperation::create(operationNode.getOperator(), createCSS(*operationChildren[0], style), createCSS(*operationChildren[1], style));</span>
929 
<a name="156" id="anc156"></a>










930         return nullptr;
931     }
932     case CalcExpressionNodeType::BlendLength: {
933         // FIXME: (http://webkit.org/b/122036) Create a CSSCalcExpressionNode equivalent of CalcExpressionBlendLength.
<a name="157" id="anc157"></a><span class="line-modified">934         auto&amp; blend = toCalcExpressionBlendLength(node);</span>
935         float progress = blend.progress();
<a name="158" id="anc158"></a><span class="line-modified">936         return CSSCalcOperation::create(CalcOperator::Add, createBlendHalf(blend.from(), style, 1 - progress), createBlendHalf(blend.to(), style, progress));</span>
937     }
938     case CalcExpressionNodeType::Undefined:
939         ASSERT_NOT_REACHED();
940     }
941     return nullptr;
942 }
943 
944 static RefPtr&lt;CSSCalcExpressionNode&gt; createCSS(const Length&amp; length, const RenderStyle&amp; style)
945 {
946     switch (length.type()) {
947     case Percent:
948     case Fixed:
<a name="159" id="anc159"></a><span class="line-modified">949         return CSSCalcPrimitiveValue::create(CSSPrimitiveValue::create(length, style), length.value() == trunc(length.value()));</span>
950     case Calculated:
951         return createCSS(length.calculationValue().expression(), style);
952     case Auto:
953     case Intrinsic:
954     case MinIntrinsic:
955     case MinContent:
956     case MaxContent:
957     case FillAvailable:
958     case FitContent:
959     case Relative:
960     case Undefined:
961         ASSERT_NOT_REACHED();
962     }
963     return nullptr;
964 }
965 
<a name="160" id="anc160"></a>























































966 RefPtr&lt;CSSCalcValue&gt; CSSCalcValue::create(CSSValueID function, const CSSParserTokenRange&amp; tokens, CalculationCategory destinationCategory, ValueRange range)
967 {
968     CSSCalcExpressionNodeParser parser(destinationCategory);
969     auto expression = parser.parseCalc(tokens, function);
970     if (!expression)
971         return nullptr;
<a name="161" id="anc161"></a><span class="line-modified">972     return adoptRef(new CSSCalcValue(expression.releaseNonNull(), range != ValueRangeAll));</span>


973 }
974 
975 RefPtr&lt;CSSCalcValue&gt; CSSCalcValue::create(const CalculationValue&amp; value, const RenderStyle&amp; style)
976 {
977     auto expression = createCSS(value.expression(), style);
978     if (!expression)
979         return nullptr;
<a name="162" id="anc162"></a><span class="line-modified">980     return adoptRef(new CSSCalcValue(expression.releaseNonNull(), value.shouldClampToNonNegative()));</span>

























981 }
982 
983 } // namespace WebCore
<a name="163" id="anc163"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="163" type="hidden" />
</body>
</html>