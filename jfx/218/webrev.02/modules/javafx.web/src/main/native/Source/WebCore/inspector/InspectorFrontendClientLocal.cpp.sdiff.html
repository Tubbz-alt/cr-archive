<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WebCore/inspector/InspectorFrontendClientLocal.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="InspectorFrontendClient.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="InspectorFrontendClientLocal.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/inspector/InspectorFrontendClientLocal.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 64 static const char* inspectorAttachedHeightSetting = &quot;inspectorAttachedHeight&quot;;
 65 static const unsigned defaultAttachedHeight = 300;
 66 static const float minimumAttachedHeight = 250.0f;
 67 static const float maximumAttachedHeightRatio = 0.75f;
 68 static const float minimumAttachedWidth = 500.0f;
 69 static const float minimumAttachedInspectedWidth = 320.0f;
 70 
 71 class InspectorBackendDispatchTask : public RefCounted&lt;InspectorBackendDispatchTask&gt; {
 72     WTF_MAKE_FAST_ALLOCATED;
 73 public:
 74     static Ref&lt;InspectorBackendDispatchTask&gt; create(InspectorController* inspectedPageController)
 75     {
 76         return adoptRef(*new InspectorBackendDispatchTask(inspectedPageController));
 77     }
 78 
 79     void dispatch(const String&amp; message)
 80     {
 81         ASSERT_ARG(message, !message.isEmpty());
 82 
 83         m_messages.append(message);
<span class="line-modified"> 84         if (!m_timer.isActive())</span>
<span class="line-removed"> 85             m_timer.startOneShot(0_s);</span>
 86     }
 87 
 88     void reset()
 89     {
 90         m_messages.clear();
<span class="line-removed"> 91         m_timer.stop();</span>
 92         m_inspectedPageController = nullptr;
 93     }
 94 
<span class="line-modified"> 95     void timerFired()</span>







 96     {
<span class="line-modified"> 97         ASSERT(m_inspectedPageController);</span>










 98 
<span class="line-modified"> 99         // Dispatching a message can possibly close the frontend and destroy</span>
<span class="line-modified">100         // the owning frontend client, so keep a protector reference here.</span>
<span class="line-modified">101         Ref&lt;InspectorBackendDispatchTask&gt; protectedThis(*this);</span>




102 
103         if (!m_messages.isEmpty())
104             m_inspectedPageController-&gt;dispatchMessageFromFrontend(m_messages.takeFirst());
105 
106         if (!m_messages.isEmpty() &amp;&amp; m_inspectedPageController)
<span class="line-modified">107             m_timer.startOneShot(0_s);</span>
<span class="line-removed">108     }</span>
<span class="line-removed">109 </span>
<span class="line-removed">110 private:</span>
<span class="line-removed">111     InspectorBackendDispatchTask(InspectorController* inspectedPageController)</span>
<span class="line-removed">112         : m_inspectedPageController(inspectedPageController)</span>
<span class="line-removed">113         , m_timer(*this, &amp;InspectorBackendDispatchTask::timerFired)</span>
<span class="line-removed">114     {</span>
<span class="line-removed">115         ASSERT_ARG(inspectedPageController, inspectedPageController);</span>
116     }
117 
118     InspectorController* m_inspectedPageController { nullptr };
<span class="line-removed">119     Timer m_timer;</span>
120     Deque&lt;String&gt; m_messages;

121 };
122 
123 String InspectorFrontendClientLocal::Settings::getProperty(const String&amp;)
124 {
125     return String();
126 }
127 
128 void InspectorFrontendClientLocal::Settings::setProperty(const String&amp;, const String&amp;)
129 {
130 }
131 
132 void InspectorFrontendClientLocal::Settings::deleteProperty(const String&amp;)
133 {
134 }
135 
136 InspectorFrontendClientLocal::InspectorFrontendClientLocal(InspectorController* inspectedPageController, Page* frontendPage, std::unique_ptr&lt;Settings&gt; settings)
137     : m_inspectedPageController(inspectedPageController)
138     , m_frontendPage(frontendPage)
139     , m_settings(WTFMove(settings))
140     , m_dockSide(DockSide::Undocked)
</pre>
<hr />
<pre>
392     evaluateOnLoad(&quot;InspectorFrontendAPI.dispatch(&quot; + signature + &quot;)&quot;);
393 }
394 
395 void InspectorFrontendClientLocal::dispatchMessage(const String&amp; messageObject)
396 {
397     ASSERT(!messageObject.isEmpty());
398 
399     evaluateOnLoad(&quot;InspectorFrontendAPI.dispatchMessage(&quot; + messageObject + &quot;)&quot;);
400 }
401 
402 void InspectorFrontendClientLocal::dispatchMessageAsync(const String&amp; messageObject)
403 {
404     ASSERT(!messageObject.isEmpty());
405 
406     evaluateOnLoad(&quot;InspectorFrontendAPI.dispatchMessageAsync(&quot; + messageObject + &quot;)&quot;);
407 }
408 
409 bool InspectorFrontendClientLocal::evaluateAsBoolean(const String&amp; expression)
410 {
411     auto&amp; state = *mainWorldExecState(&amp;m_frontendPage-&gt;mainFrame());
<span class="line-modified">412     return m_frontendPage-&gt;mainFrame().script().executeScript(expression).toWTFString(&amp;state) == &quot;true&quot;;</span>
413 }
414 
415 void InspectorFrontendClientLocal::evaluateOnLoad(const String&amp; expression)
416 {
417     if (!m_frontendLoaded) {
418         m_evaluateOnLoad.append(expression);
419         return;
420     }
421 
422     JSC::SuspendExceptionScope scope(&amp;m_frontendPage-&gt;inspectorController().vm());
<span class="line-modified">423     m_frontendPage-&gt;mainFrame().script().evaluate(ScriptSourceCode(expression));</span>
424 }
425 
426 Page* InspectorFrontendClientLocal::inspectedPage() const
427 {
428     if (!m_inspectedPageController)
429         return nullptr;
430 
431     return &amp;m_inspectedPageController-&gt;inspectedPage();
432 }
433 
434 } // namespace WebCore
</pre>
</td>
<td>
<hr />
<pre>
 64 static const char* inspectorAttachedHeightSetting = &quot;inspectorAttachedHeight&quot;;
 65 static const unsigned defaultAttachedHeight = 300;
 66 static const float minimumAttachedHeight = 250.0f;
 67 static const float maximumAttachedHeightRatio = 0.75f;
 68 static const float minimumAttachedWidth = 500.0f;
 69 static const float minimumAttachedInspectedWidth = 320.0f;
 70 
 71 class InspectorBackendDispatchTask : public RefCounted&lt;InspectorBackendDispatchTask&gt; {
 72     WTF_MAKE_FAST_ALLOCATED;
 73 public:
 74     static Ref&lt;InspectorBackendDispatchTask&gt; create(InspectorController* inspectedPageController)
 75     {
 76         return adoptRef(*new InspectorBackendDispatchTask(inspectedPageController));
 77     }
 78 
 79     void dispatch(const String&amp; message)
 80     {
 81         ASSERT_ARG(message, !message.isEmpty());
 82 
 83         m_messages.append(message);
<span class="line-modified"> 84         scheduleOneShot();</span>

 85     }
 86 
 87     void reset()
 88     {
 89         m_messages.clear();

 90         m_inspectedPageController = nullptr;
 91     }
 92 
<span class="line-modified"> 93 private:</span>
<span class="line-added"> 94     InspectorBackendDispatchTask(InspectorController* inspectedPageController)</span>
<span class="line-added"> 95         : m_inspectedPageController(inspectedPageController)</span>
<span class="line-added"> 96     {</span>
<span class="line-added"> 97         ASSERT_ARG(inspectedPageController, inspectedPageController);</span>
<span class="line-added"> 98     }</span>
<span class="line-added"> 99 </span>
<span class="line-added">100     void scheduleOneShot()</span>
101     {
<span class="line-modified">102         if (m_hasScheduledTask)</span>
<span class="line-added">103             return;</span>
<span class="line-added">104         m_hasScheduledTask = true;</span>
<span class="line-added">105 </span>
<span class="line-added">106         // The frontend can be closed and destroy the owning frontend client before or in the</span>
<span class="line-added">107         // process of dispatching the task, so keep a protector reference here.</span>
<span class="line-added">108         RunLoop::current().dispatch([this, protectedThis = makeRef(*this)] {</span>
<span class="line-added">109             m_hasScheduledTask = false;</span>
<span class="line-added">110             dispatchOneMessage();</span>
<span class="line-added">111         });</span>
<span class="line-added">112     }</span>
113 
<span class="line-modified">114     void dispatchOneMessage()</span>
<span class="line-modified">115     {</span>
<span class="line-modified">116         // Owning frontend client may have been destroyed after the task was scheduled.</span>
<span class="line-added">117         if (!m_inspectedPageController) {</span>
<span class="line-added">118             ASSERT(m_messages.isEmpty());</span>
<span class="line-added">119             return;</span>
<span class="line-added">120         }</span>
121 
122         if (!m_messages.isEmpty())
123             m_inspectedPageController-&gt;dispatchMessageFromFrontend(m_messages.takeFirst());
124 
125         if (!m_messages.isEmpty() &amp;&amp; m_inspectedPageController)
<span class="line-modified">126             scheduleOneShot();</span>








127     }
128 
129     InspectorController* m_inspectedPageController { nullptr };

130     Deque&lt;String&gt; m_messages;
<span class="line-added">131     bool m_hasScheduledTask { false };</span>
132 };
133 
134 String InspectorFrontendClientLocal::Settings::getProperty(const String&amp;)
135 {
136     return String();
137 }
138 
139 void InspectorFrontendClientLocal::Settings::setProperty(const String&amp;, const String&amp;)
140 {
141 }
142 
143 void InspectorFrontendClientLocal::Settings::deleteProperty(const String&amp;)
144 {
145 }
146 
147 InspectorFrontendClientLocal::InspectorFrontendClientLocal(InspectorController* inspectedPageController, Page* frontendPage, std::unique_ptr&lt;Settings&gt; settings)
148     : m_inspectedPageController(inspectedPageController)
149     , m_frontendPage(frontendPage)
150     , m_settings(WTFMove(settings))
151     , m_dockSide(DockSide::Undocked)
</pre>
<hr />
<pre>
403     evaluateOnLoad(&quot;InspectorFrontendAPI.dispatch(&quot; + signature + &quot;)&quot;);
404 }
405 
406 void InspectorFrontendClientLocal::dispatchMessage(const String&amp; messageObject)
407 {
408     ASSERT(!messageObject.isEmpty());
409 
410     evaluateOnLoad(&quot;InspectorFrontendAPI.dispatchMessage(&quot; + messageObject + &quot;)&quot;);
411 }
412 
413 void InspectorFrontendClientLocal::dispatchMessageAsync(const String&amp; messageObject)
414 {
415     ASSERT(!messageObject.isEmpty());
416 
417     evaluateOnLoad(&quot;InspectorFrontendAPI.dispatchMessageAsync(&quot; + messageObject + &quot;)&quot;);
418 }
419 
420 bool InspectorFrontendClientLocal::evaluateAsBoolean(const String&amp; expression)
421 {
422     auto&amp; state = *mainWorldExecState(&amp;m_frontendPage-&gt;mainFrame());
<span class="line-modified">423     return m_frontendPage-&gt;mainFrame().script().executeScriptIgnoringException(expression).toWTFString(&amp;state) == &quot;true&quot;;</span>
424 }
425 
426 void InspectorFrontendClientLocal::evaluateOnLoad(const String&amp; expression)
427 {
428     if (!m_frontendLoaded) {
429         m_evaluateOnLoad.append(expression);
430         return;
431     }
432 
433     JSC::SuspendExceptionScope scope(&amp;m_frontendPage-&gt;inspectorController().vm());
<span class="line-modified">434     m_frontendPage-&gt;mainFrame().script().evaluateIgnoringException(ScriptSourceCode(expression));</span>
435 }
436 
437 Page* InspectorFrontendClientLocal::inspectedPage() const
438 {
439     if (!m_inspectedPageController)
440         return nullptr;
441 
442     return &amp;m_inspectedPageController-&gt;inspectedPage();
443 }
444 
445 } // namespace WebCore
</pre>
</td>
</tr>
</table>
<center><a href="InspectorFrontendClient.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="InspectorFrontendClientLocal.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>