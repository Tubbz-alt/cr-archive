<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/JavaScriptCore/bytecode/ObjectPropertyConditionSet.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (C) 2015-2019 Apple Inc. All rights reserved.</span>
  3  *
  4  * Redistribution and use in source and binary forms, with or without
  5  * modification, are permitted provided that the following conditions
  6  * are met:
  7  * 1. Redistributions of source code must retain the above copyright
  8  *    notice, this list of conditions and the following disclaimer.
  9  * 2. Redistributions in binary form must reproduce the above copyright
 10  *    notice, this list of conditions and the following disclaimer in the
 11  *    documentation and/or other materials provided with the distribution.
 12  *
 13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. ``AS IS&#39;&#39; AND ANY
 14  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 15  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 16  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE INC. OR
 17  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 18  * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 19  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 20  * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 21  * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 22  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 23  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #include &quot;config.h&quot;
 27 #include &quot;ObjectPropertyConditionSet.h&quot;
 28 
 29 #include &quot;JSCInlines.h&quot;
 30 #include &lt;wtf/ListDump.h&gt;
 31 
 32 namespace JSC {
 33 
 34 ObjectPropertyCondition ObjectPropertyConditionSet::forObject(JSObject* object) const
 35 {
 36     for (const ObjectPropertyCondition&amp; condition : *this) {
 37         if (condition.object() == object)
 38             return condition;
 39     }
 40     return ObjectPropertyCondition();
 41 }
 42 
 43 ObjectPropertyCondition ObjectPropertyConditionSet::forConditionKind(
 44     PropertyCondition::Kind kind) const
 45 {
 46     for (const ObjectPropertyCondition&amp; condition : *this) {
 47         if (condition.kind() == kind)
 48             return condition;
 49     }
 50     return ObjectPropertyCondition();
 51 }
 52 
 53 unsigned ObjectPropertyConditionSet::numberOfConditionsWithKind(PropertyCondition::Kind kind) const
 54 {
 55     unsigned result = 0;
 56     for (const ObjectPropertyCondition&amp; condition : *this) {
 57         if (condition.kind() == kind)
 58             result++;
 59     }
 60     return result;
 61 }
 62 
 63 bool ObjectPropertyConditionSet::hasOneSlotBaseCondition() const
 64 {
<a name="2" id="anc2"></a><span class="line-modified"> 65     bool sawBase = false;</span>
<span class="line-added"> 66     for (const ObjectPropertyCondition&amp; condition : *this) {</span>
<span class="line-added"> 67         switch (condition.kind()) {</span>
<span class="line-added"> 68         case PropertyCondition::Presence:</span>
<span class="line-added"> 69         case PropertyCondition::Equivalence:</span>
<span class="line-added"> 70         case PropertyCondition::CustomFunctionEquivalence:</span>
<span class="line-added"> 71             if (sawBase)</span>
<span class="line-added"> 72                 return false;</span>
<span class="line-added"> 73             sawBase = true;</span>
<span class="line-added"> 74             break;</span>
<span class="line-added"> 75         default:</span>
<span class="line-added"> 76             break;</span>
<span class="line-added"> 77         }</span>
<span class="line-added"> 78     }</span>
<span class="line-added"> 79 </span>
<span class="line-added"> 80     return sawBase;</span>
 81 }
 82 
 83 ObjectPropertyCondition ObjectPropertyConditionSet::slotBaseCondition() const
 84 {
 85     ObjectPropertyCondition result;
 86     unsigned numFound = 0;
 87     for (const ObjectPropertyCondition&amp; condition : *this) {
 88         if (condition.kind() == PropertyCondition::Presence
<a name="3" id="anc3"></a><span class="line-modified"> 89             || condition.kind() == PropertyCondition::Equivalence</span>
<span class="line-added"> 90             || condition.kind() == PropertyCondition::CustomFunctionEquivalence) {</span>
 91             result = condition;
 92             numFound++;
 93         }
 94     }
 95     RELEASE_ASSERT(numFound == 1);
 96     return result;
 97 }
 98 
 99 ObjectPropertyConditionSet ObjectPropertyConditionSet::mergedWith(
100     const ObjectPropertyConditionSet&amp; other) const
101 {
102     if (!isValid() || !other.isValid())
103         return invalid();
104 
105     Vector&lt;ObjectPropertyCondition&gt; result;
106 
107     if (!isEmpty())
108         result.appendVector(m_data-&gt;vector);
109 
110     for (const ObjectPropertyCondition&amp; newCondition : other) {
111         bool foundMatch = false;
112         for (const ObjectPropertyCondition&amp; existingCondition : *this) {
113             if (newCondition == existingCondition) {
114                 foundMatch = true;
115                 continue;
116             }
117             if (!newCondition.isCompatibleWith(existingCondition))
118                 return invalid();
119         }
120         if (!foundMatch)
121             result.append(newCondition);
122     }
123 
124     return create(result);
125 }
126 
127 bool ObjectPropertyConditionSet::structuresEnsureValidity() const
128 {
129     if (!isValid())
130         return false;
131 
132     for (const ObjectPropertyCondition&amp; condition : *this) {
133         if (!condition.structureEnsuresValidity())
134             return false;
135     }
136     return true;
137 }
138 
139 bool ObjectPropertyConditionSet::structuresEnsureValidityAssumingImpurePropertyWatchpoint() const
140 {
141     if (!isValid())
142         return false;
143 
144     for (const ObjectPropertyCondition&amp; condition : *this) {
145         if (!condition.structureEnsuresValidityAssumingImpurePropertyWatchpoint())
146             return false;
147     }
148     return true;
149 }
150 
151 bool ObjectPropertyConditionSet::needImpurePropertyWatchpoint() const
152 {
153     for (const ObjectPropertyCondition&amp; condition : *this) {
154         if (condition.validityRequiresImpurePropertyWatchpoint())
155             return true;
156     }
157     return false;
158 }
159 
160 bool ObjectPropertyConditionSet::areStillLive(VM&amp; vm) const
161 {
<a name="4" id="anc4"></a><span class="line-modified">162     bool stillLive = true;</span>
<span class="line-modified">163     forEachDependentCell([&amp;](JSCell* cell) {</span>
<span class="line-modified">164         stillLive &amp;= vm.heap.isMarked(cell);</span>
<span class="line-modified">165     });</span>
<span class="line-modified">166     return stillLive;</span>
167 }
168 
169 void ObjectPropertyConditionSet::dumpInContext(PrintStream&amp; out, DumpContext* context) const
170 {
171     if (!isValid()) {
172         out.print(&quot;&lt;invalid&gt;&quot;);
173         return;
174     }
175 
176     out.print(&quot;[&quot;);
177     if (m_data)
178         out.print(listDumpInContext(m_data-&gt;vector, context));
179     out.print(&quot;]&quot;);
180 }
181 
182 void ObjectPropertyConditionSet::dump(PrintStream&amp; out) const
183 {
184     dumpInContext(out, nullptr);
185 }
186 
187 bool ObjectPropertyConditionSet::isValidAndWatchable() const
188 {
189     if (!isValid())
190         return false;
191 
192     for (ObjectPropertyCondition condition : m_data-&gt;vector) {
193         if (!condition.isWatchable())
194             return false;
195     }
196     return true;
197 }
198 
199 namespace {
200 
201 namespace ObjectPropertyConditionSetInternal {
<a name="5" id="anc5"></a><span class="line-modified">202 static constexpr bool verbose = false;</span>
203 }
204 
205 ObjectPropertyCondition generateCondition(
206     VM&amp; vm, JSCell* owner, JSObject* object, UniquedStringImpl* uid, PropertyCondition::Kind conditionKind)
207 {
208     Structure* structure = object-&gt;structure(vm);
209     if (ObjectPropertyConditionSetInternal::verbose)
210         dataLog(&quot;Creating condition &quot;, conditionKind, &quot; for &quot;, pointerDump(structure), &quot;\n&quot;);
211 
212     ObjectPropertyCondition result;
213     switch (conditionKind) {
214     case PropertyCondition::Presence: {
215         unsigned attributes;
216         PropertyOffset offset = structure-&gt;getConcurrently(uid, attributes);
217         if (offset == invalidOffset)
218             return ObjectPropertyCondition();
219         result = ObjectPropertyCondition::presence(vm, owner, object, uid, offset, attributes);
220         break;
221     }
222     case PropertyCondition::Absence: {
223         if (structure-&gt;hasPolyProto())
224             return ObjectPropertyCondition();
225         result = ObjectPropertyCondition::absence(
226             vm, owner, object, uid, object-&gt;structure(vm)-&gt;storedPrototypeObject());
227         break;
228     }
229     case PropertyCondition::AbsenceOfSetEffect: {
230         if (structure-&gt;hasPolyProto())
231             return ObjectPropertyCondition();
232         result = ObjectPropertyCondition::absenceOfSetEffect(
233             vm, owner, object, uid, object-&gt;structure(vm)-&gt;storedPrototypeObject());
234         break;
235     }
236     case PropertyCondition::Equivalence: {
237         unsigned attributes;
238         PropertyOffset offset = structure-&gt;getConcurrently(uid, attributes);
239         if (offset == invalidOffset)
240             return ObjectPropertyCondition();
241         JSValue value = object-&gt;getDirectConcurrently(structure, offset);
242         if (!value)
243             return ObjectPropertyCondition();
244         result = ObjectPropertyCondition::equivalence(vm, owner, object, uid, value);
245         break;
246     }
<a name="6" id="anc6"></a><span class="line-added">247     case PropertyCondition::CustomFunctionEquivalence: {</span>
<span class="line-added">248         auto entry = object-&gt;findPropertyHashEntry(vm, uid);</span>
<span class="line-added">249         if (!entry)</span>
<span class="line-added">250             return ObjectPropertyCondition();</span>
<span class="line-added">251         result = ObjectPropertyCondition::customFunctionEquivalence(vm, owner, object, uid);</span>
<span class="line-added">252         break;</span>
<span class="line-added">253     }</span>
254     default:
255         RELEASE_ASSERT_NOT_REACHED();
256         return ObjectPropertyCondition();
257     }
258 
259     if (!result.isStillValidAssumingImpurePropertyWatchpoint()) {
260         if (ObjectPropertyConditionSetInternal::verbose)
261             dataLog(&quot;Failed to create condition: &quot;, result, &quot;\n&quot;);
262         return ObjectPropertyCondition();
263     }
264 
265     if (ObjectPropertyConditionSetInternal::verbose)
266         dataLog(&quot;New condition: &quot;, result, &quot;\n&quot;);
267     return result;
268 }
269 
<a name="7" id="anc7"></a>



270 template&lt;typename Functor&gt;
271 ObjectPropertyConditionSet generateConditions(
<a name="8" id="anc8"></a><span class="line-modified">272     VM&amp; vm, JSGlobalObject* globalObject, Structure* structure, JSObject* prototype, const Functor&amp; functor)</span>

273 {
274     Vector&lt;ObjectPropertyCondition&gt; conditions;
275 
276     for (;;) {
277         if (ObjectPropertyConditionSetInternal::verbose)
278             dataLog(&quot;Considering structure: &quot;, pointerDump(structure), &quot;\n&quot;);
279 
280         if (structure-&gt;isProxy()) {
281             if (ObjectPropertyConditionSetInternal::verbose)
282                 dataLog(&quot;It&#39;s a proxy, so invalid.\n&quot;);
283             return ObjectPropertyConditionSet::invalid();
284         }
285 
286         if (structure-&gt;hasPolyProto()) {
287             // FIXME: Integrate this with PolyProtoAccessChain:
288             // https://bugs.webkit.org/show_bug.cgi?id=177339
289             // Or at least allow OPC set generation when the
290             // base is not poly proto:
291             // https://bugs.webkit.org/show_bug.cgi?id=177721
292             return ObjectPropertyConditionSet::invalid();
293         }
294 
295         JSValue value = structure-&gt;prototypeForLookup(globalObject);
296 
297         if (value.isNull()) {
298             if (!prototype) {
299                 if (ObjectPropertyConditionSetInternal::verbose)
300                     dataLog(&quot;Reached end of prototype chain as expected, done.\n&quot;);
301                 break;
302             }
303             if (ObjectPropertyConditionSetInternal::verbose)
304                 dataLog(&quot;Unexpectedly reached end of prototype chain, so invalid.\n&quot;);
305             return ObjectPropertyConditionSet::invalid();
306         }
307 
308         JSObject* object = jsCast&lt;JSObject*&gt;(value);
309         structure = object-&gt;structure(vm);
310 
311         if (structure-&gt;isDictionary()) {
<a name="9" id="anc9"></a><span class="line-modified">312             if (ObjectPropertyConditionSetInternal::verbose)</span>
<span class="line-modified">313                 dataLog(&quot;Cannot cache dictionary.\n&quot;);</span>
<span class="line-modified">314             return ObjectPropertyConditionSet::invalid();</span>












315         }
316 
317         if (!functor(conditions, object)) {
318             if (ObjectPropertyConditionSetInternal::verbose)
319                 dataLog(&quot;Functor failed, invalid.\n&quot;);
320             return ObjectPropertyConditionSet::invalid();
321         }
322 
323         if (object == prototype) {
324             if (ObjectPropertyConditionSetInternal::verbose)
325                 dataLog(&quot;Reached desired prototype, done.\n&quot;);
326             break;
327         }
328     }
329 
330     if (ObjectPropertyConditionSetInternal::verbose)
331         dataLog(&quot;Returning conditions: &quot;, listDump(conditions), &quot;\n&quot;);
332     return ObjectPropertyConditionSet::create(conditions);
333 }
334 
335 } // anonymous namespace
336 
337 ObjectPropertyConditionSet generateConditionsForPropertyMiss(
<a name="10" id="anc10"></a><span class="line-modified">338     VM&amp; vm, JSCell* owner, JSGlobalObject* globalObject, Structure* headStructure, UniquedStringImpl* uid)</span>
339 {
340     return generateConditions(
<a name="11" id="anc11"></a><span class="line-modified">341         vm, globalObject, headStructure, nullptr,</span>
342         [&amp;] (Vector&lt;ObjectPropertyCondition&gt;&amp; conditions, JSObject* object) -&gt; bool {
343             ObjectPropertyCondition result =
344                 generateCondition(vm, owner, object, uid, PropertyCondition::Absence);
345             if (!result)
346                 return false;
347             conditions.append(result);
348             return true;
349         });
350 }
351 
352 ObjectPropertyConditionSet generateConditionsForPropertySetterMiss(
<a name="12" id="anc12"></a><span class="line-modified">353     VM&amp; vm, JSCell* owner, JSGlobalObject* globalObject, Structure* headStructure, UniquedStringImpl* uid)</span>
354 {
355     return generateConditions(
<a name="13" id="anc13"></a><span class="line-modified">356         vm, globalObject, headStructure, nullptr,</span>
357         [&amp;] (Vector&lt;ObjectPropertyCondition&gt;&amp; conditions, JSObject* object) -&gt; bool {
358             ObjectPropertyCondition result =
359                 generateCondition(vm, owner, object, uid, PropertyCondition::AbsenceOfSetEffect);
360             if (!result)
361                 return false;
362             conditions.append(result);
363             return true;
364         });
365 }
366 
367 ObjectPropertyConditionSet generateConditionsForPrototypePropertyHit(
<a name="14" id="anc14"></a><span class="line-modified">368     VM&amp; vm, JSCell* owner, JSGlobalObject* globalObject, Structure* headStructure, JSObject* prototype,</span>
369     UniquedStringImpl* uid)
370 {
371     return generateConditions(
<a name="15" id="anc15"></a><span class="line-modified">372         vm, globalObject, headStructure, prototype,</span>
373         [&amp;] (Vector&lt;ObjectPropertyCondition&gt;&amp; conditions, JSObject* object) -&gt; bool {
374             PropertyCondition::Kind kind =
375                 object == prototype ? PropertyCondition::Presence : PropertyCondition::Absence;
376             ObjectPropertyCondition result =
377                 generateCondition(vm, owner, object, uid, kind);
378             if (!result)
379                 return false;
380             conditions.append(result);
381             return true;
382         });
383 }
384 
385 ObjectPropertyConditionSet generateConditionsForPrototypePropertyHitCustom(
<a name="16" id="anc16"></a><span class="line-modified">386     VM&amp; vm, JSCell* owner, JSGlobalObject* globalObject, Structure* headStructure, JSObject* prototype,</span>
<span class="line-modified">387     UniquedStringImpl* uid, unsigned attributes)</span>
388 {
389     return generateConditions(
<a name="17" id="anc17"></a><span class="line-modified">390         vm, globalObject, headStructure, prototype,</span>
391         [&amp;] (Vector&lt;ObjectPropertyCondition&gt;&amp; conditions, JSObject* object) -&gt; bool {
<a name="18" id="anc18"></a><span class="line-modified">392             auto kind = PropertyCondition::Absence;</span>
<span class="line-modified">393             if (object == prototype) {</span>
<span class="line-modified">394                 Structure* structure = object-&gt;structure(vm);</span>
<span class="line-modified">395                 PropertyOffset offset = structure-&gt;get(vm, uid);</span>
<span class="line-added">396                 if (isValidOffset(offset)) {</span>
<span class="line-added">397                     // When we reify custom accessors, we wrap them in a JSFunction that we shove</span>
<span class="line-added">398                     // inside a GetterSetter. So, once we&#39;ve reified a custom accessor, we will</span>
<span class="line-added">399                     // no longer see it as a &quot;custom&quot; accessor/value. Hence, if our property access actually</span>
<span class="line-added">400                     // notices a custom, it must be a CustomGetterSetterType cell or something</span>
<span class="line-added">401                     // in the static property table. Custom values get reified into CustomGetterSetters.</span>
<span class="line-added">402                     JSValue value = object-&gt;getDirect(offset);</span>
<span class="line-added">403                     ASSERT_UNUSED(value, value.isCell() &amp;&amp; value.asCell()-&gt;type() == CustomGetterSetterType);</span>
<span class="line-added">404                     kind = PropertyCondition::Equivalence;</span>
<span class="line-added">405                 } else if (structure-&gt;findPropertyHashEntry(uid))</span>
<span class="line-added">406                     kind = PropertyCondition::CustomFunctionEquivalence;</span>
<span class="line-added">407                 else if (attributes &amp; PropertyAttribute::DontDelete) {</span>
<span class="line-added">408                     // This can&#39;t change, so we can blindly cache it.</span>
<span class="line-added">409                     return true;</span>
<span class="line-added">410                 } else {</span>
<span class="line-added">411                     // This means we materialized a custom out of thin air and it&#39;s not DontDelete (i.e, it can be</span>
<span class="line-added">412                     // redefined). This is curious. We don&#39;t actually need to crash here. We could blindly cache</span>
<span class="line-added">413                     // the function. Or we could blindly not cache it. However, we don&#39;t actually do this in WebKit</span>
<span class="line-added">414                     // right now, so it&#39;s reasonable to decide what to do later (or to warn people of forgetting DoneDelete.)</span>
<span class="line-added">415                     ASSERT_NOT_REACHED();</span>
<span class="line-added">416                     return false;</span>
<span class="line-added">417                 }</span>
<span class="line-added">418             }</span>
<span class="line-added">419             ObjectPropertyCondition result = generateCondition(vm, owner, object, uid, kind);</span>
420             if (!result)
421                 return false;
422             conditions.append(result);
423             return true;
424         });
425 }
426 
427 ObjectPropertyConditionSet generateConditionsForInstanceOf(
<a name="19" id="anc19"></a><span class="line-modified">428     VM&amp; vm, JSCell* owner, JSGlobalObject* globalObject, Structure* headStructure, JSObject* prototype,</span>
429     bool shouldHit)
430 {
431     bool didHit = false;
432     if (ObjectPropertyConditionSetInternal::verbose)
433         dataLog(&quot;Searching for prototype &quot;, JSValue(prototype), &quot; starting with structure &quot;, RawPointer(headStructure), &quot; with shouldHit = &quot;, shouldHit, &quot;\n&quot;);
434     ObjectPropertyConditionSet result = generateConditions(
<a name="20" id="anc20"></a><span class="line-modified">435         vm, globalObject, headStructure, shouldHit ? prototype : nullptr,</span>
436         [&amp;] (Vector&lt;ObjectPropertyCondition&gt;&amp; conditions, JSObject* object) -&gt; bool {
437             if (ObjectPropertyConditionSetInternal::verbose)
438                 dataLog(&quot;Encountered object: &quot;, RawPointer(object), &quot;\n&quot;);
439             if (object == prototype) {
440                 RELEASE_ASSERT(shouldHit);
441                 didHit = true;
442                 return true;
443             }
444 
445             Structure* structure = object-&gt;structure(vm);
446             if (structure-&gt;hasPolyProto())
447                 return false;
448             conditions.append(
449                 ObjectPropertyCondition::hasPrototype(
450                     vm, owner, object, structure-&gt;storedPrototypeObject()));
451             return true;
452         });
453     if (result.isValid()) {
454         if (ObjectPropertyConditionSetInternal::verbose)
455             dataLog(&quot;didHit = &quot;, didHit, &quot;, shouldHit = &quot;, shouldHit, &quot;\n&quot;);
456         RELEASE_ASSERT(didHit == shouldHit);
457     }
458     return result;
459 }
460 
461 ObjectPropertyConditionSet generateConditionsForPrototypeEquivalenceConcurrently(
462     VM&amp; vm, JSGlobalObject* globalObject, Structure* headStructure, JSObject* prototype, UniquedStringImpl* uid)
463 {
464     return generateConditions(vm, globalObject, headStructure, prototype,
465         [&amp;] (Vector&lt;ObjectPropertyCondition&gt;&amp; conditions, JSObject* object) -&gt; bool {
466             PropertyCondition::Kind kind =
467                 object == prototype ? PropertyCondition::Equivalence : PropertyCondition::Absence;
468             ObjectPropertyCondition result = generateCondition(vm, nullptr, object, uid, kind);
469             if (!result)
470                 return false;
471             conditions.append(result);
472             return true;
<a name="21" id="anc21"></a><span class="line-modified">473         });</span>
474 }
475 
476 ObjectPropertyConditionSet generateConditionsForPropertyMissConcurrently(
477     VM&amp; vm, JSGlobalObject* globalObject, Structure* headStructure, UniquedStringImpl* uid)
478 {
479     return generateConditions(
480         vm, globalObject, headStructure, nullptr,
481         [&amp;] (Vector&lt;ObjectPropertyCondition&gt;&amp; conditions, JSObject* object) -&gt; bool {
482             ObjectPropertyCondition result = generateCondition(vm, nullptr, object, uid, PropertyCondition::Absence);
483             if (!result)
484                 return false;
485             conditions.append(result);
486             return true;
<a name="22" id="anc22"></a><span class="line-modified">487         });</span>
488 }
489 
490 ObjectPropertyConditionSet generateConditionsForPropertySetterMissConcurrently(
491     VM&amp; vm, JSGlobalObject* globalObject, Structure* headStructure, UniquedStringImpl* uid)
492 {
493     return generateConditions(
494         vm, globalObject, headStructure, nullptr,
495         [&amp;] (Vector&lt;ObjectPropertyCondition&gt;&amp; conditions, JSObject* object) -&gt; bool {
496             ObjectPropertyCondition result =
497                 generateCondition(vm, nullptr, object, uid, PropertyCondition::AbsenceOfSetEffect);
498             if (!result)
499                 return false;
500             conditions.append(result);
501             return true;
<a name="23" id="anc23"></a><span class="line-modified">502         });</span>
503 }
504 
505 ObjectPropertyCondition generateConditionForSelfEquivalence(
506     VM&amp; vm, JSCell* owner, JSObject* object, UniquedStringImpl* uid)
507 {
508     return generateCondition(vm, owner, object, uid, PropertyCondition::Equivalence);
509 }
510 
<a name="24" id="anc24"></a><span class="line-added">511 // Current might be null. Structure can&#39;t be null.</span>
<span class="line-added">512 static Optional&lt;PrototypeChainCachingStatus&gt; prepareChainForCaching(JSGlobalObject* globalObject, JSCell* current, Structure* structure, JSObject* target)</span>
<span class="line-added">513 {</span>
<span class="line-added">514     ASSERT(structure);</span>
<span class="line-added">515     VM&amp; vm = globalObject-&gt;vm();</span>
<span class="line-added">516 </span>
<span class="line-added">517     bool found = false;</span>
<span class="line-added">518     bool usesPolyProto = false;</span>
<span class="line-added">519     bool flattenedDictionary = false;</span>
<span class="line-added">520 </span>
<span class="line-added">521     while (true) {</span>
<span class="line-added">522         if (structure-&gt;isDictionary()) {</span>
<span class="line-added">523             if (!current)</span>
<span class="line-added">524                 return WTF::nullopt;</span>
<span class="line-added">525 </span>
<span class="line-added">526             ASSERT(structure-&gt;isObject());</span>
<span class="line-added">527             if (structure-&gt;hasBeenFlattenedBefore())</span>
<span class="line-added">528                 return WTF::nullopt;</span>
<span class="line-added">529 </span>
<span class="line-added">530             structure-&gt;flattenDictionaryStructure(vm, asObject(current));</span>
<span class="line-added">531             flattenedDictionary = true;</span>
<span class="line-added">532         }</span>
<span class="line-added">533 </span>
<span class="line-added">534         if (!structure-&gt;propertyAccessesAreCacheable())</span>
<span class="line-added">535             return WTF::nullopt;</span>
<span class="line-added">536 </span>
<span class="line-added">537         if (structure-&gt;isProxy())</span>
<span class="line-added">538             return WTF::nullopt;</span>
<span class="line-added">539 </span>
<span class="line-added">540         if (current &amp;&amp; current == target) {</span>
<span class="line-added">541             found = true;</span>
<span class="line-added">542             break;</span>
<span class="line-added">543         }</span>
<span class="line-added">544 </span>
<span class="line-added">545         // We only have poly proto if we need to access our prototype via</span>
<span class="line-added">546         // the poly proto protocol. If the slot base is the only poly proto</span>
<span class="line-added">547         // thing in the chain, and we have a cache hit on it, then we&#39;re not</span>
<span class="line-added">548         // poly proto.</span>
<span class="line-added">549         JSValue prototype;</span>
<span class="line-added">550         if (structure-&gt;hasPolyProto()) {</span>
<span class="line-added">551             if (!current)</span>
<span class="line-added">552                 return WTF::nullopt;</span>
<span class="line-added">553             usesPolyProto = true;</span>
<span class="line-added">554             prototype = structure-&gt;prototypeForLookup(globalObject, current);</span>
<span class="line-added">555         } else</span>
<span class="line-added">556             prototype = structure-&gt;prototypeForLookup(globalObject);</span>
<span class="line-added">557 </span>
<span class="line-added">558         if (prototype.isNull())</span>
<span class="line-added">559             break;</span>
<span class="line-added">560         current = asObject(prototype);</span>
<span class="line-added">561         structure = current-&gt;structure(vm);</span>
<span class="line-added">562     }</span>
<span class="line-added">563 </span>
<span class="line-added">564     if (!found &amp;&amp; !!target)</span>
<span class="line-added">565         return WTF::nullopt;</span>
<span class="line-added">566 </span>
<span class="line-added">567     PrototypeChainCachingStatus result;</span>
<span class="line-added">568     result.usesPolyProto = usesPolyProto;</span>
<span class="line-added">569     result.flattenedDictionary = flattenedDictionary;</span>
<span class="line-added">570 </span>
<span class="line-added">571     return result;</span>
<span class="line-added">572 }</span>
<span class="line-added">573 </span>
<span class="line-added">574 Optional&lt;PrototypeChainCachingStatus&gt; prepareChainForCaching(JSGlobalObject* globalObject, JSCell* base, JSObject* target)</span>
<span class="line-added">575 {</span>
<span class="line-added">576     return prepareChainForCaching(globalObject, base, base-&gt;structure(globalObject-&gt;vm()), target);</span>
<span class="line-added">577 }</span>
<span class="line-added">578 </span>
<span class="line-added">579 Optional&lt;PrototypeChainCachingStatus&gt; prepareChainForCaching(JSGlobalObject* globalObject, JSCell* base, const PropertySlot&amp; slot)</span>
<span class="line-added">580 {</span>
<span class="line-added">581     JSObject* target = slot.isUnset() ? nullptr : slot.slotBase();</span>
<span class="line-added">582     return prepareChainForCaching(globalObject, base, target);</span>
<span class="line-added">583 }</span>
<span class="line-added">584 </span>
<span class="line-added">585 Optional&lt;PrototypeChainCachingStatus&gt; prepareChainForCaching(JSGlobalObject* globalObject, Structure* baseStructure, JSObject* target)</span>
<span class="line-added">586 {</span>
<span class="line-added">587     return prepareChainForCaching(globalObject, nullptr, baseStructure, target);</span>
<span class="line-added">588 }</span>
<span class="line-added">589 </span>
590 } // namespace JSC
591 
<a name="25" id="anc25"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="25" type="hidden" />
</body>
</html>