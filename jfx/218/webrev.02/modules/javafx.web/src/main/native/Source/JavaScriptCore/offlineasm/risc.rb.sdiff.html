<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/JavaScriptCore/offlineasm/risc.rb</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="registers.rb.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="transform.rb.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/JavaScriptCore/offlineasm/risc.rb</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
345 end
346 
347 class AbsoluteAddress
348     def riscLowerMalformedImmediatesRecurse(list, validImmediates)
349         self
350     end
351 end
352 
353 class Immediate
354     def riscLowerMalformedImmediatesRecurse(list, validImmediates)
355         unless validImmediates.include? value
356             tmp = Tmp.new(codeOrigin, :gpr)
357             list &lt;&lt; Instruction.new(codeOrigin, &quot;move&quot;, [self, tmp])
358             tmp
359         else
360             self
361         end
362     end
363 end
364 
<span class="line-modified">365 def riscLowerMalformedImmediates(list, validImmediates)</span>
366     newList = []
367     list.each {
368         | node |
369         if node.is_a? Instruction
370             annotation = node.annotation
371             case node.opcode
372             when &quot;move&quot;
373                 newList &lt;&lt; node
374             when &quot;addi&quot;, &quot;addp&quot;, &quot;addq&quot;, &quot;addis&quot;, &quot;subi&quot;, &quot;subp&quot;, &quot;subq&quot;, &quot;subis&quot;
375                 if node.operands[0].is_a? Immediate and
376                         (not validImmediates.include? node.operands[0].value) and
377                         validImmediates.include? -node.operands[0].value and
378                         node.operands.size == 2
379                     if node.opcode =~ /add/
380                         newOpcode = &quot;sub&quot; + $~.post_match
381                     else
382                         newOpcode = &quot;add&quot; + $~.post_match
383                     end
384                     newList &lt;&lt; Instruction.new(node.codeOrigin, newOpcode,
385                                                [Immediate.new(node.codeOrigin, -node.operands[0].value)] + node.operands[1..-1],
386                                                annotation)
387                 else
388                     newList &lt;&lt; node.riscLowerMalformedImmediatesRecurse(newList, validImmediates)
389                 end
390             when &quot;muli&quot;, &quot;mulp&quot;, &quot;mulq&quot;
391                 if node.operands[0].is_a? Immediate
392                     tmp = Tmp.new(codeOrigin, :gpr)
393                     newList &lt;&lt; Instruction.new(node.codeOrigin, &quot;move&quot;, [node.operands[0], tmp], annotation)
394                     newList &lt;&lt; Instruction.new(node.codeOrigin, node.opcode, [tmp] + node.operands[1..-1])
395                 else
396                     newList &lt;&lt; node.riscLowerMalformedImmediatesRecurse(newList, validImmediates)
397                 end


398             else
399                 newList &lt;&lt; node.riscLowerMalformedImmediatesRecurse(newList, validImmediates)
400             end
401         else
402             newList &lt;&lt; node
403         end
404     }
405     newList
406 end
407 
408 #
409 # Lowering of misplaced addresses. For example:
410 #
411 # addi foo, [bar]
412 #
413 # will become:
414 #
415 # loadi [bar], tmp
416 # addi foo, tmp
417 # storei tmp, [bar]
</pre>
<hr />
<pre>
443         | operand, index |
444         newOperands &lt;&lt; riscAsRegister(preList, postList, operand, suffix, index == operands.size - 1)
445     }
446     newOperands
447 end
448 
449 def riscLowerMisplacedAddresses(list)
450     newList = []
451     hasBackendSpecificLowering = Instruction.respond_to? &quot;lowerMisplacedAddresses#{$activeBackend}&quot;
452     list.each {
453         | node |
454         if node.is_a? Instruction
455             if hasBackendSpecificLowering
456                 wasHandled, newList = Instruction.send(&quot;lowerMisplacedAddresses#{$activeBackend}&quot;, node, newList)
457                 next if wasHandled
458             end
459 
460             postInstructions = []
461             annotation = node.annotation
462             case node.opcode
<span class="line-modified">463             when &quot;addi&quot;, &quot;addis&quot;, &quot;andi&quot;, &quot;lshifti&quot;, &quot;muli&quot;, &quot;negi&quot;, &quot;noti&quot;, &quot;ori&quot;, &quot;oris&quot;,</span>
464                 &quot;rshifti&quot;, &quot;urshifti&quot;, &quot;subi&quot;, &quot;subis&quot;, &quot;xori&quot;, /^bi/, /^bti/, /^ci/, /^ti/
465                 newList &lt;&lt; Instruction.new(node.codeOrigin,
466                                            node.opcode,
467                                            riscAsRegisters(newList, postInstructions, node.operands, &quot;i&quot;),
468                                            annotation)
469             when &quot;addp&quot;, &quot;andp&quot;, &quot;lshiftp&quot;, &quot;mulp&quot;, &quot;negp&quot;, &quot;orp&quot;, &quot;rshiftp&quot;, &quot;urshiftp&quot;,
470                 &quot;subp&quot;, &quot;xorp&quot;, /^bp/, /^btp/, /^cp/
471                 newList &lt;&lt; Instruction.new(node.codeOrigin,
472                                            node.opcode,
473                                            riscAsRegisters(newList, postInstructions, node.operands, &quot;p&quot;),
474                                            annotation)
475             when &quot;addq&quot;, &quot;andq&quot;, &quot;lshiftq&quot;, &quot;mulq&quot;, &quot;negq&quot;, &quot;orq&quot;, &quot;rshiftq&quot;, &quot;urshiftq&quot;,
476                 &quot;subq&quot;, &quot;xorq&quot;, /^bq/, /^btq/, /^cq/
477                 newList &lt;&lt; Instruction.new(node.codeOrigin,
478                                            node.opcode,
479                                            riscAsRegisters(newList, postInstructions, node.operands, &quot;q&quot;),
480                                            annotation)
481             when &quot;bbeq&quot;, &quot;bbneq&quot;, &quot;bba&quot;, &quot;bbaeq&quot;, &quot;bbb&quot;, &quot;bbbeq&quot;, &quot;btbz&quot;, &quot;btbnz&quot;, &quot;tbz&quot;, &quot;tbnz&quot;,
482                 &quot;cbeq&quot;, &quot;cbneq&quot;, &quot;cba&quot;, &quot;cbaeq&quot;, &quot;cbb&quot;, &quot;cbbeq&quot;
483                 newList &lt;&lt; Instruction.new(node.codeOrigin,
</pre>
</td>
<td>
<hr />
<pre>
345 end
346 
347 class AbsoluteAddress
348     def riscLowerMalformedImmediatesRecurse(list, validImmediates)
349         self
350     end
351 end
352 
353 class Immediate
354     def riscLowerMalformedImmediatesRecurse(list, validImmediates)
355         unless validImmediates.include? value
356             tmp = Tmp.new(codeOrigin, :gpr)
357             list &lt;&lt; Instruction.new(codeOrigin, &quot;move&quot;, [self, tmp])
358             tmp
359         else
360             self
361         end
362     end
363 end
364 
<span class="line-modified">365 def riscLowerMalformedImmediates(list, validImmediates, validLogicalImmediates)</span>
366     newList = []
367     list.each {
368         | node |
369         if node.is_a? Instruction
370             annotation = node.annotation
371             case node.opcode
372             when &quot;move&quot;
373                 newList &lt;&lt; node
374             when &quot;addi&quot;, &quot;addp&quot;, &quot;addq&quot;, &quot;addis&quot;, &quot;subi&quot;, &quot;subp&quot;, &quot;subq&quot;, &quot;subis&quot;
375                 if node.operands[0].is_a? Immediate and
376                         (not validImmediates.include? node.operands[0].value) and
377                         validImmediates.include? -node.operands[0].value and
378                         node.operands.size == 2
379                     if node.opcode =~ /add/
380                         newOpcode = &quot;sub&quot; + $~.post_match
381                     else
382                         newOpcode = &quot;add&quot; + $~.post_match
383                     end
384                     newList &lt;&lt; Instruction.new(node.codeOrigin, newOpcode,
385                                                [Immediate.new(node.codeOrigin, -node.operands[0].value)] + node.operands[1..-1],
386                                                annotation)
387                 else
388                     newList &lt;&lt; node.riscLowerMalformedImmediatesRecurse(newList, validImmediates)
389                 end
390             when &quot;muli&quot;, &quot;mulp&quot;, &quot;mulq&quot;
391                 if node.operands[0].is_a? Immediate
392                     tmp = Tmp.new(codeOrigin, :gpr)
393                     newList &lt;&lt; Instruction.new(node.codeOrigin, &quot;move&quot;, [node.operands[0], tmp], annotation)
394                     newList &lt;&lt; Instruction.new(node.codeOrigin, node.opcode, [tmp] + node.operands[1..-1])
395                 else
396                     newList &lt;&lt; node.riscLowerMalformedImmediatesRecurse(newList, validImmediates)
397                 end
<span class="line-added">398             when &quot;ori&quot;, &quot;orh&quot;, &quot;orp&quot;, &quot;oris&quot;, &quot;xori&quot;, &quot;xorp&quot;, &quot;andi&quot;, &quot;andp&quot;</span>
<span class="line-added">399                 newList &lt;&lt; node.riscLowerMalformedImmediatesRecurse(newList, validLogicalImmediates)</span>
400             else
401                 newList &lt;&lt; node.riscLowerMalformedImmediatesRecurse(newList, validImmediates)
402             end
403         else
404             newList &lt;&lt; node
405         end
406     }
407     newList
408 end
409 
410 #
411 # Lowering of misplaced addresses. For example:
412 #
413 # addi foo, [bar]
414 #
415 # will become:
416 #
417 # loadi [bar], tmp
418 # addi foo, tmp
419 # storei tmp, [bar]
</pre>
<hr />
<pre>
445         | operand, index |
446         newOperands &lt;&lt; riscAsRegister(preList, postList, operand, suffix, index == operands.size - 1)
447     }
448     newOperands
449 end
450 
451 def riscLowerMisplacedAddresses(list)
452     newList = []
453     hasBackendSpecificLowering = Instruction.respond_to? &quot;lowerMisplacedAddresses#{$activeBackend}&quot;
454     list.each {
455         | node |
456         if node.is_a? Instruction
457             if hasBackendSpecificLowering
458                 wasHandled, newList = Instruction.send(&quot;lowerMisplacedAddresses#{$activeBackend}&quot;, node, newList)
459                 next if wasHandled
460             end
461 
462             postInstructions = []
463             annotation = node.annotation
464             case node.opcode
<span class="line-modified">465             when &quot;addi&quot;, &quot;addis&quot;, &quot;andi&quot;, &quot;lshifti&quot;, &quot;muli&quot;, &quot;negi&quot;, &quot;noti&quot;, &quot;ori&quot;, &quot;orh&quot;, &quot;oris&quot;,</span>
466                 &quot;rshifti&quot;, &quot;urshifti&quot;, &quot;subi&quot;, &quot;subis&quot;, &quot;xori&quot;, /^bi/, /^bti/, /^ci/, /^ti/
467                 newList &lt;&lt; Instruction.new(node.codeOrigin,
468                                            node.opcode,
469                                            riscAsRegisters(newList, postInstructions, node.operands, &quot;i&quot;),
470                                            annotation)
471             when &quot;addp&quot;, &quot;andp&quot;, &quot;lshiftp&quot;, &quot;mulp&quot;, &quot;negp&quot;, &quot;orp&quot;, &quot;rshiftp&quot;, &quot;urshiftp&quot;,
472                 &quot;subp&quot;, &quot;xorp&quot;, /^bp/, /^btp/, /^cp/
473                 newList &lt;&lt; Instruction.new(node.codeOrigin,
474                                            node.opcode,
475                                            riscAsRegisters(newList, postInstructions, node.operands, &quot;p&quot;),
476                                            annotation)
477             when &quot;addq&quot;, &quot;andq&quot;, &quot;lshiftq&quot;, &quot;mulq&quot;, &quot;negq&quot;, &quot;orq&quot;, &quot;rshiftq&quot;, &quot;urshiftq&quot;,
478                 &quot;subq&quot;, &quot;xorq&quot;, /^bq/, /^btq/, /^cq/
479                 newList &lt;&lt; Instruction.new(node.codeOrigin,
480                                            node.opcode,
481                                            riscAsRegisters(newList, postInstructions, node.operands, &quot;q&quot;),
482                                            annotation)
483             when &quot;bbeq&quot;, &quot;bbneq&quot;, &quot;bba&quot;, &quot;bbaeq&quot;, &quot;bbb&quot;, &quot;bbbeq&quot;, &quot;btbz&quot;, &quot;btbnz&quot;, &quot;tbz&quot;, &quot;tbnz&quot;,
484                 &quot;cbeq&quot;, &quot;cbneq&quot;, &quot;cba&quot;, &quot;cbaeq&quot;, &quot;cbb&quot;, &quot;cbbeq&quot;
485                 newList &lt;&lt; Instruction.new(node.codeOrigin,
</pre>
</td>
</tr>
</table>
<center><a href="registers.rb.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="transform.rb.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>