<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New modules/javafx.web/src/main/native/Source/WebCore/platform/graphics/freetype/SimpleFontDataFreeType.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (C) 2006 Apple Inc.  All rights reserved.
  3  * Copyright (C) 2006 Michael Emmel mike.emmel@gmail.com
  4  * Copyright (C) 2007, 2008 Alp Toker &lt;alp@atoker.com&gt;
  5  * Copyright (C) 2007 Holger Hans Peter Freyther
  6  * All rights reserved.
  7  *
  8  * Redistribution and use in source and binary forms, with or without
  9  * modification, are permitted provided that the following conditions
 10  * are met:
 11  *
 12  * 1.  Redistributions of source code must retain the above copyright
 13  *     notice, this list of conditions and the following disclaimer.
 14  * 2.  Redistributions in binary form must reproduce the above copyright
 15  *     notice, this list of conditions and the following disclaimer in the
 16  *     documentation and/or other materials provided with the distribution.
 17  * 3.  Neither the name of Apple Inc. (&quot;Apple&quot;) nor the names of
 18  *     its contributors may be used to endorse or promote products derived
 19  *     from this software without specific prior written permission.
 20  *
 21  * THIS SOFTWARE IS PROVIDED BY APPLE AND ITS CONTRIBUTORS &quot;AS IS&quot; AND ANY
 22  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 23  * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 24  * DISCLAIMED. IN NO EVENT SHALL APPLE OR ITS CONTRIBUTORS BE LIABLE FOR ANY
 25  * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 26  * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 27  * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
 28  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 29  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
 30  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 31  */
 32 
 33 #include &quot;config.h&quot;
 34 #include &quot;Font.h&quot;
 35 
 36 #include &quot;CairoUniquePtr.h&quot;
 37 #include &quot;CairoUtilities.h&quot;
 38 #include &quot;FloatConversion.h&quot;
 39 #include &quot;FloatRect.h&quot;
 40 #include &quot;FontCache.h&quot;
 41 #include &quot;FontDescription.h&quot;
 42 #include &quot;GlyphBuffer.h&quot;
 43 #include &quot;OpenTypeTypes.h&quot;
 44 #include &quot;RefPtrCairo.h&quot;
 45 #include &quot;SurrogatePairAwareTextIterator.h&quot;
 46 #include &quot;UTF16UChar32Iterator.h&quot;
 47 #include &lt;cairo-ft.h&gt;
 48 #include &lt;cairo.h&gt;
 49 #include &lt;fontconfig/fcfreetype.h&gt;
 50 #include &lt;ft2build.h&gt;
 51 #include FT_TRUETYPE_TABLES_H
 52 #include FT_TRUETYPE_TAGS_H
 53 #include &lt;wtf/MathExtras.h&gt;
 54 
 55 namespace WebCore {
 56 
 57 static RefPtr&lt;cairo_scaled_font_t&gt; scaledFontWithoutMetricsHinting(cairo_scaled_font_t* scaledFont)
 58 {
 59     CairoUniquePtr&lt;cairo_font_options_t&gt; fontOptions(cairo_font_options_create());
 60     cairo_scaled_font_get_font_options(scaledFont, fontOptions.get());
 61     cairo_font_options_set_hint_metrics(fontOptions.get(), CAIRO_HINT_METRICS_OFF);
 62     cairo_matrix_t fontMatrix;
 63     cairo_scaled_font_get_font_matrix(scaledFont, &amp;fontMatrix);
 64     cairo_matrix_t fontCTM;
 65     cairo_scaled_font_get_ctm(scaledFont, &amp;fontCTM);
 66     return adoptRef(cairo_scaled_font_create(cairo_scaled_font_get_font_face(scaledFont), &amp;fontMatrix, &amp;fontCTM, fontOptions.get()));
 67 }
 68 
 69 void Font::platformInit()
 70 {
 71     if (!m_platformData.size())
 72         return;
 73 
 74     ASSERT(m_platformData.scaledFont());
 75     // Temporarily create a clone that doesn&#39;t have metrics hinting in order to avoid incorrect
 76     // rounding resulting in incorrect baseline positioning since the sum of ascent and descent
 77     // becomes larger than the line height.
 78     auto fontWithoutMetricsHinting = scaledFontWithoutMetricsHinting(m_platformData.scaledFont());
 79     cairo_font_extents_t fontExtents;
 80     cairo_scaled_font_extents(fontWithoutMetricsHinting.get(), &amp;fontExtents);
 81 
 82     float ascent = narrowPrecisionToFloat(fontExtents.ascent);
 83     float descent = narrowPrecisionToFloat(fontExtents.descent);
 84     float capHeight = narrowPrecisionToFloat(fontExtents.height);
 85     float lineGap = narrowPrecisionToFloat(fontExtents.height - fontExtents.ascent - fontExtents.descent);
 86     Optional&lt;float&gt; xHeight;
 87 
 88     {
 89         CairoFtFaceLocker cairoFtFaceLocker(m_platformData.scaledFont());
 90 
 91         // If the USE_TYPO_METRICS flag is set in the OS/2 table then we use typo metrics instead.
 92         FT_Face freeTypeFace = cairoFtFaceLocker.ftFace();
 93         if (freeTypeFace &amp;&amp; freeTypeFace-&gt;face_flags &amp; FT_FACE_FLAG_SCALABLE) {
 94             if (auto* OS2Table = static_cast&lt;TT_OS2*&gt;(FT_Get_Sfnt_Table(freeTypeFace, ft_sfnt_os2))) {
 95                 const FT_Short kUseTypoMetricsMask = 1 &lt;&lt; 7;
 96                 // FT_Size_Metrics::y_scale is in 16.16 fixed point format.
 97                 // Its (fractional) value is a factor that converts vertical metrics from design units to units of 1/64 pixels.
 98                 double yscale = (freeTypeFace-&gt;size-&gt;metrics.y_scale / 65536.0) / 64.0;
 99                 if (OS2Table-&gt;fsSelection &amp; kUseTypoMetricsMask) {
100                     ascent = narrowPrecisionToFloat(yscale * OS2Table-&gt;sTypoAscender);
101                     descent = -narrowPrecisionToFloat(yscale * OS2Table-&gt;sTypoDescender);
102                     lineGap = narrowPrecisionToFloat(yscale * OS2Table-&gt;sTypoLineGap);
103                 }
104                 xHeight = narrowPrecisionToFloat(yscale * OS2Table-&gt;sxHeight);
105             }
106         }
107     }
108 
109     if (!xHeight) {
110         cairo_text_extents_t textExtents;
111         cairo_scaled_font_text_extents(m_platformData.scaledFont(), &quot;x&quot;, &amp;textExtents);
112         xHeight = narrowPrecisionToFloat((platformData().orientation() == FontOrientation::Horizontal) ? textExtents.height : textExtents.width);
113     }
114 
115     m_fontMetrics.setAscent(ascent);
116     m_fontMetrics.setDescent(descent);
117     m_fontMetrics.setCapHeight(capHeight);
118     m_fontMetrics.setLineSpacing(lroundf(ascent) + lroundf(descent) + lroundf(lineGap));
119     m_fontMetrics.setLineGap(lineGap);
120     m_fontMetrics.setXHeight(xHeight.value());
121 
122     cairo_text_extents_t textExtents;
123     cairo_scaled_font_text_extents(m_platformData.scaledFont(), &quot; &quot;, &amp;textExtents);
124     m_spaceWidth = narrowPrecisionToFloat((platformData().orientation() == FontOrientation::Horizontal) ? textExtents.x_advance : -textExtents.y_advance);
125 
126     if ((platformData().orientation() == FontOrientation::Vertical) &amp;&amp; !isTextOrientationFallback()) {
127         CairoFtFaceLocker cairoFtFaceLocker(m_platformData.scaledFont());
128         FT_Face freeTypeFace = cairoFtFaceLocker.ftFace();
129         m_fontMetrics.setUnitsPerEm(freeTypeFace-&gt;units_per_EM);
130     }
131 
132     m_syntheticBoldOffset = m_platformData.syntheticBold() ? 1.0f : 0.f;
133 
134     FcChar8* fontConfigFamilyName;
135     if (FcPatternGetString(m_platformData.fcPattern(), FC_FAMILY, 0, &amp;fontConfigFamilyName) == FcResultMatch) {
136         String familyName = String::fromUTF8(reinterpret_cast&lt;char*&gt;(fontConfigFamilyName));
137         // Disable antialiasing for the Ahem font because many tests require this.
138         if (equalIgnoringASCIICase(familyName, &quot;Ahem&quot;))
139             m_allowsAntialiasing = false;
140     }
141 }
142 
143 void Font::platformCharWidthInit()
144 {
145     m_avgCharWidth = 0.f;
146     m_maxCharWidth = 0.f;
147     initCharWidths();
148 }
149 
150 RefPtr&lt;Font&gt; Font::platformCreateScaledFont(const FontDescription&amp; fontDescription, float scaleFactor) const
151 {
152     ASSERT(m_platformData.scaledFont());
153     return Font::create(FontPlatformData(cairo_scaled_font_get_font_face(m_platformData.scaledFont()),
154         m_platformData.fcPattern(),
155         scaleFactor * fontDescription.computedSize(),
156         m_platformData.isFixedWidth(),
157         m_platformData.syntheticBold(),
158         m_platformData.syntheticOblique(),
159         fontDescription.orientation()),
160         origin(), Interstitial::No);
161 }
162 
163 void Font::determinePitch()
164 {
165     m_treatAsFixedPitch = m_platformData.isFixedPitch();
166 }
167 
168 FloatRect Font::platformBoundsForGlyph(Glyph glyph) const
169 {
170     if (!m_platformData.size())
171         return FloatRect();
172 
173     cairo_glyph_t cglyph = { glyph, 0, 0 };
174     cairo_text_extents_t extents;
175     cairo_scaled_font_glyph_extents(m_platformData.scaledFont(), &amp;cglyph, 1, &amp;extents);
176 
177     if (cairo_scaled_font_status(m_platformData.scaledFont()) == CAIRO_STATUS_SUCCESS)
178         return FloatRect(extents.x_bearing, extents.y_bearing, extents.width, extents.height);
179 
180     return FloatRect();
181 }
182 
183 float Font::platformWidthForGlyph(Glyph glyph) const
184 {
185     if (!m_platformData.size())
186         return 0;
187 
188     if (cairo_scaled_font_status(m_platformData.scaledFont()) != CAIRO_STATUS_SUCCESS)
189         return m_spaceWidth;
190 
191     cairo_glyph_t cairoGlyph = { glyph, 0, 0 };
192     cairo_text_extents_t extents;
193     cairo_scaled_font_glyph_extents(m_platformData.scaledFont(), &amp;cairoGlyph, 1, &amp;extents);
194     float width = platformData().orientation() == FontOrientation::Horizontal ? extents.x_advance : -extents.y_advance;
195     return width ? width : m_spaceWidth;
196 }
197 
198 bool Font::variantCapsSupportsCharacterForSynthesis(FontVariantCaps fontVariantCaps, UChar32) const
199 {
200     switch (fontVariantCaps) {
201     case FontVariantCaps::Small:
202     case FontVariantCaps::Petite:
203     case FontVariantCaps::AllSmall:
204     case FontVariantCaps::AllPetite:
205         return false;
206     default:
207         // Synthesis only supports the variant-caps values listed above.
208         return true;
209     }
210 }
211 
212 bool Font::platformSupportsCodePoint(UChar32 character, Optional&lt;UChar32&gt; variation) const
213 {
214     CairoFtFaceLocker cairoFtFaceLocker(m_platformData.scaledFont());
215     if (FT_Face face = cairoFtFaceLocker.ftFace())
216         return variation ? !!FT_Face_GetCharVariantIndex(face, character, variation.value()) : !!FcFreeTypeCharIndex(face, character);
217 
218     return false;
219 }
220 
221 }
    </pre>
  </body>
</html>