<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/JavaScriptCore/runtime/JSModuleLoader.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (C) 2015-2019 Apple Inc. All Rights Reserved.
  3  * Copyright (C) 2016 Yusuke Suzuki &lt;utatane.tea@gmail.com&gt;.
  4  *
  5  * Redistribution and use in source and binary forms, with or without
  6  * modification, are permitted provided that the following conditions
  7  * are met:
  8  * 1. Redistributions of source code must retain the above copyright
  9  *    notice, this list of conditions and the following disclaimer.
 10  * 2. Redistributions in binary form must reproduce the above copyright
 11  *    notice, this list of conditions and the following disclaimer in the
 12  *    documentation and/or other materials provided with the distribution.
 13  *
 14  * THIS SOFTWARE IS PROVIDED BY APPLE INC. ``AS IS&#39;&#39; AND ANY
 15  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 16  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 17  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE INC. OR
 18  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 19  * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 20  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 21  * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 22  * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 23  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 24  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 25  */
 26 
 27 #include &quot;config.h&quot;
 28 #include &quot;JSModuleLoader.h&quot;
 29 
 30 #include &quot;BuiltinNames.h&quot;
 31 #include &quot;CatchScope.h&quot;
 32 #include &quot;CodeProfiling.h&quot;
 33 #include &quot;Error.h&quot;
 34 #include &quot;Exception.h&quot;
 35 #include &quot;JSCInlines.h&quot;
 36 #include &quot;JSGlobalObjectFunctions.h&quot;
 37 #include &quot;JSInternalPromise.h&quot;
<a name="1" id="anc1"></a>
 38 #include &quot;JSMap.h&quot;
 39 #include &quot;JSModuleEnvironment.h&quot;
 40 #include &quot;JSModuleNamespaceObject.h&quot;
 41 #include &quot;JSModuleRecord.h&quot;
 42 #include &quot;JSSourceCode.h&quot;
 43 #include &quot;JSWebAssembly.h&quot;
 44 #include &quot;ModuleAnalyzer.h&quot;
 45 #include &quot;Nodes.h&quot;
 46 #include &quot;ObjectConstructor.h&quot;
 47 #include &quot;Parser.h&quot;
 48 #include &quot;ParserError.h&quot;
 49 
 50 namespace JSC {
 51 
<a name="2" id="anc2"></a><span class="line-modified"> 52 static EncodedJSValue JSC_HOST_CALL moduleLoaderParseModule(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified"> 53 static EncodedJSValue JSC_HOST_CALL moduleLoaderRequestedModules(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified"> 54 static EncodedJSValue JSC_HOST_CALL moduleLoaderEvaluate(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified"> 55 static EncodedJSValue JSC_HOST_CALL moduleLoaderModuleDeclarationInstantiation(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified"> 56 static EncodedJSValue JSC_HOST_CALL moduleLoaderResolve(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified"> 57 static EncodedJSValue JSC_HOST_CALL moduleLoaderResolveSync(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified"> 58 static EncodedJSValue JSC_HOST_CALL moduleLoaderFetch(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified"> 59 static EncodedJSValue JSC_HOST_CALL moduleLoaderGetModuleNamespaceObject(JSGlobalObject*, CallFrame*);</span>
 60 
 61 }
 62 
 63 #include &quot;JSModuleLoader.lut.h&quot;
 64 
 65 namespace JSC {
 66 
 67 STATIC_ASSERT_IS_TRIVIALLY_DESTRUCTIBLE(JSModuleLoader);
 68 
 69 const ClassInfo JSModuleLoader::s_info = { &quot;ModuleLoader&quot;, &amp;Base::s_info, &amp;moduleLoaderTable, nullptr, CREATE_METHOD_TABLE(JSModuleLoader) };
 70 
 71 /* Source for JSModuleLoader.lut.h
 72 @begin moduleLoaderTable
 73     ensureRegistered               JSBuiltin                                  DontEnum|Function 1
 74     forceFulfillPromise            JSBuiltin                                  DontEnum|Function 2
 75     fulfillFetch                   JSBuiltin                                  DontEnum|Function 2
 76     requestFetch                   JSBuiltin                                  DontEnum|Function 3
 77     requestInstantiate             JSBuiltin                                  DontEnum|Function 3
 78     requestSatisfy                 JSBuiltin                                  DontEnum|Function 3
 79     link                           JSBuiltin                                  DontEnum|Function 2
 80     moduleDeclarationInstantiation moduleLoaderModuleDeclarationInstantiation DontEnum|Function 2
 81     moduleEvaluation               JSBuiltin                                  DontEnum|Function 2
 82     evaluate                       moduleLoaderEvaluate                       DontEnum|Function 3
 83     provideFetch                   JSBuiltin                                  DontEnum|Function 2
 84     loadAndEvaluateModule          JSBuiltin                                  DontEnum|Function 3
 85     loadModule                     JSBuiltin                                  DontEnum|Function 3
 86     linkAndEvaluateModule          JSBuiltin                                  DontEnum|Function 2
 87     requestImportModule            JSBuiltin                                  DontEnum|Function 3
 88     dependencyKeysIfEvaluated      JSBuiltin                                  DontEnum|Function 1
 89     getModuleNamespaceObject       moduleLoaderGetModuleNamespaceObject       DontEnum|Function 1
 90     parseModule                    moduleLoaderParseModule                    DontEnum|Function 2
 91     requestedModules               moduleLoaderRequestedModules               DontEnum|Function 1
 92     resolve                        moduleLoaderResolve                        DontEnum|Function 2
 93     resolveSync                    moduleLoaderResolveSync                    DontEnum|Function 2
 94     fetch                          moduleLoaderFetch                          DontEnum|Function 3
 95 @end
 96 */
 97 
 98 JSModuleLoader::JSModuleLoader(VM&amp; vm, Structure* structure)
 99     : JSNonFinalObject(vm, structure)
100 {
101 }
102 
<a name="3" id="anc3"></a><span class="line-modified">103 void JSModuleLoader::finishCreation(JSGlobalObject* globalObject, VM&amp; vm)</span>
104 {
105     auto scope = DECLARE_CATCH_SCOPE(vm);
106 
107     Base::finishCreation(vm);
108     ASSERT(inherits(vm, info()));
<a name="4" id="anc4"></a><span class="line-modified">109     JSMap* map = JSMap::create(globalObject, vm, globalObject-&gt;mapStructure());</span>
110     scope.releaseAssertNoException();
111     putDirect(vm, Identifier::fromString(vm, &quot;registry&quot;), map);
112 }
113 
114 // ------------------------------ Functions --------------------------------
115 
<a name="5" id="anc5"></a><span class="line-modified">116 static String printableModuleKey(JSGlobalObject* globalObject, JSValue key)</span>
117 {
<a name="6" id="anc6"></a><span class="line-modified">118     VM&amp; vm = globalObject-&gt;vm();</span>
<span class="line-modified">119     auto scope = DECLARE_CATCH_SCOPE(vm);</span>
120     if (key.isString() || key.isSymbol()) {
<a name="7" id="anc7"></a><span class="line-modified">121         auto propertyName = key.toPropertyKey(globalObject);</span>
122         scope.assertNoException(); // This is OK since this function is just for debugging purpose.
123         return propertyName.impl();
124     }
125     return vm.propertyNames-&gt;emptyIdentifier.impl();
126 }
127 
<a name="8" id="anc8"></a><span class="line-modified">128 JSArray* JSModuleLoader::dependencyKeysIfEvaluated(JSGlobalObject* globalObject, JSValue key)</span>
129 {
<a name="9" id="anc9"></a><span class="line-modified">130     VM&amp; vm = globalObject-&gt;vm();</span>
131     auto scope = DECLARE_THROW_SCOPE(vm);
132 
<a name="10" id="anc10"></a><span class="line-modified">133     JSObject* function = jsCast&lt;JSObject*&gt;(get(globalObject, vm.propertyNames-&gt;builtinNames().dependencyKeysIfEvaluatedPublicName()));</span>
134     RETURN_IF_EXCEPTION(scope, nullptr);
135     CallData callData;
136     CallType callType = JSC::getCallData(vm, function, callData);
137     ASSERT(callType != CallType::None);
138 
139     MarkedArgumentBuffer arguments;
140     arguments.append(key);
141 
<a name="11" id="anc11"></a><span class="line-modified">142     JSValue result = call(globalObject, function, callType, callData, this, arguments);</span>
143     RETURN_IF_EXCEPTION(scope, nullptr);
144 
145     return jsDynamicCast&lt;JSArray*&gt;(vm, result);
146 }
147 
<a name="12" id="anc12"></a><span class="line-modified">148 JSValue JSModuleLoader::provideFetch(JSGlobalObject* globalObject, JSValue key, const SourceCode&amp; sourceCode)</span>
149 {
<a name="13" id="anc13"></a><span class="line-modified">150     VM&amp; vm = globalObject-&gt;vm();</span>
151     auto scope = DECLARE_THROW_SCOPE(vm);
152 
<a name="14" id="anc14"></a><span class="line-modified">153     JSObject* function = jsCast&lt;JSObject*&gt;(get(globalObject, vm.propertyNames-&gt;builtinNames().provideFetchPublicName()));</span>
154     RETURN_IF_EXCEPTION(scope, { });
155     CallData callData;
156     CallType callType = JSC::getCallData(vm, function, callData);
157     ASSERT(callType != CallType::None);
158 
159     SourceCode source { sourceCode };
160     MarkedArgumentBuffer arguments;
161     arguments.append(key);
162     arguments.append(JSSourceCode::create(vm, WTFMove(source)));
163     ASSERT(!arguments.hasOverflowed());
164 
<a name="15" id="anc15"></a><span class="line-modified">165     RELEASE_AND_RETURN(scope, call(globalObject, function, callType, callData, this, arguments));</span>
166 }
167 
<a name="16" id="anc16"></a><span class="line-modified">168 JSInternalPromise* JSModuleLoader::loadAndEvaluateModule(JSGlobalObject* globalObject, JSValue moduleName, JSValue parameters, JSValue scriptFetcher)</span>
169 {
<a name="17" id="anc17"></a><span class="line-modified">170     VM&amp; vm = globalObject-&gt;vm();</span>
171     auto scope = DECLARE_THROW_SCOPE(vm);
172 
<a name="18" id="anc18"></a><span class="line-modified">173     JSObject* function = jsCast&lt;JSObject*&gt;(get(globalObject, vm.propertyNames-&gt;builtinNames().loadAndEvaluateModulePublicName()));</span>
174     RETURN_IF_EXCEPTION(scope, nullptr);
175     CallData callData;
176     CallType callType = JSC::getCallData(vm, function, callData);
177     ASSERT(callType != CallType::None);
178 
179     MarkedArgumentBuffer arguments;
180     arguments.append(moduleName);
181     arguments.append(parameters);
182     arguments.append(scriptFetcher);
183     ASSERT(!arguments.hasOverflowed());
184 
<a name="19" id="anc19"></a><span class="line-modified">185     JSValue promise = call(globalObject, function, callType, callData, this, arguments);</span>
186     RETURN_IF_EXCEPTION(scope, nullptr);
187     return jsCast&lt;JSInternalPromise*&gt;(promise);
188 }
189 
<a name="20" id="anc20"></a><span class="line-modified">190 JSInternalPromise* JSModuleLoader::loadModule(JSGlobalObject* globalObject, JSValue moduleName, JSValue parameters, JSValue scriptFetcher)</span>
191 {
<a name="21" id="anc21"></a><span class="line-modified">192     VM&amp; vm = globalObject-&gt;vm();</span>
193     auto scope = DECLARE_THROW_SCOPE(vm);
194 
<a name="22" id="anc22"></a><span class="line-modified">195     JSObject* function = jsCast&lt;JSObject*&gt;(get(globalObject, vm.propertyNames-&gt;builtinNames().loadModulePublicName()));</span>
196     RETURN_IF_EXCEPTION(scope, nullptr);
197     CallData callData;
198     CallType callType = JSC::getCallData(vm, function, callData);
199     ASSERT(callType != CallType::None);
200 
201     MarkedArgumentBuffer arguments;
202     arguments.append(moduleName);
203     arguments.append(parameters);
204     arguments.append(scriptFetcher);
205     ASSERT(!arguments.hasOverflowed());
206 
<a name="23" id="anc23"></a><span class="line-modified">207     JSValue promise = call(globalObject, function, callType, callData, this, arguments);</span>
208     RETURN_IF_EXCEPTION(scope, nullptr);
209     return jsCast&lt;JSInternalPromise*&gt;(promise);
210 }
211 
<a name="24" id="anc24"></a><span class="line-modified">212 JSValue JSModuleLoader::linkAndEvaluateModule(JSGlobalObject* globalObject, JSValue moduleKey, JSValue scriptFetcher)</span>
213 {
<a name="25" id="anc25"></a><span class="line-modified">214     VM&amp; vm = globalObject-&gt;vm();</span>
215     auto scope = DECLARE_THROW_SCOPE(vm);
216 
<a name="26" id="anc26"></a><span class="line-modified">217     JSObject* function = jsCast&lt;JSObject*&gt;(get(globalObject, vm.propertyNames-&gt;builtinNames().linkAndEvaluateModulePublicName()));</span>
218     RETURN_IF_EXCEPTION(scope, { });
219     CallData callData;
220     CallType callType = JSC::getCallData(vm, function, callData);
221     ASSERT(callType != CallType::None);
222 
223     MarkedArgumentBuffer arguments;
224     arguments.append(moduleKey);
225     arguments.append(scriptFetcher);
226     ASSERT(!arguments.hasOverflowed());
227 
<a name="27" id="anc27"></a><span class="line-modified">228     RELEASE_AND_RETURN(scope, call(globalObject, function, callType, callData, this, arguments));</span>
229 }
230 
<a name="28" id="anc28"></a><span class="line-modified">231 JSInternalPromise* JSModuleLoader::requestImportModule(JSGlobalObject* globalObject, const Identifier&amp; moduleKey, JSValue parameters, JSValue scriptFetcher)</span>
232 {
<a name="29" id="anc29"></a><span class="line-modified">233     VM&amp; vm = globalObject-&gt;vm();</span>
234     auto scope = DECLARE_THROW_SCOPE(vm);
235 
<a name="30" id="anc30"></a><span class="line-modified">236     auto* function = jsCast&lt;JSObject*&gt;(get(globalObject, vm.propertyNames-&gt;builtinNames().requestImportModulePublicName()));</span>
237     RETURN_IF_EXCEPTION(scope, nullptr);
238     CallData callData;
239     auto callType = JSC::getCallData(vm, function, callData);
240     ASSERT(callType != CallType::None);
241 
242     MarkedArgumentBuffer arguments;
243     arguments.append(jsString(vm, moduleKey.impl()));
244     arguments.append(parameters);
245     arguments.append(scriptFetcher);
246     ASSERT(!arguments.hasOverflowed());
247 
<a name="31" id="anc31"></a><span class="line-modified">248     JSValue promise = call(globalObject, function, callType, callData, this, arguments);</span>
249     RETURN_IF_EXCEPTION(scope, nullptr);
250     return jsCast&lt;JSInternalPromise*&gt;(promise);
251 }
252 
<a name="32" id="anc32"></a><span class="line-modified">253 JSInternalPromise* JSModuleLoader::importModule(JSGlobalObject* globalObject, JSString* moduleName, JSValue parameters, const SourceOrigin&amp; referrer)</span>
254 {
<a name="33" id="anc33"></a><span class="line-modified">255     dataLogLnIf(Options::dumpModuleLoadingState(), &quot;Loader [import] &quot;, printableModuleKey(globalObject, moduleName));</span>

256 
<a name="34" id="anc34"></a>
257     VM&amp; vm = globalObject-&gt;vm();
258     auto throwScope = DECLARE_THROW_SCOPE(vm);
259 
260     if (globalObject-&gt;globalObjectMethodTable()-&gt;moduleLoaderImportModule)
<a name="35" id="anc35"></a><span class="line-modified">261         RELEASE_AND_RETURN(throwScope, globalObject-&gt;globalObjectMethodTable()-&gt;moduleLoaderImportModule(globalObject, this, moduleName, parameters, referrer));</span>
262 
<a name="36" id="anc36"></a><span class="line-modified">263     auto* promise = JSInternalPromise::create(vm, globalObject-&gt;internalPromiseStructure());</span>

264 
265     auto catchScope = DECLARE_CATCH_SCOPE(vm);
<a name="37" id="anc37"></a><span class="line-modified">266     auto moduleNameString = moduleName-&gt;value(globalObject);</span>
267     if (UNLIKELY(catchScope.exception())) {
268         JSValue exception = catchScope.exception()-&gt;value();
269         catchScope.clearException();
<a name="38" id="anc38"></a><span class="line-modified">270         promise-&gt;reject(globalObject, exception);</span>
271         catchScope.clearException();
<a name="39" id="anc39"></a><span class="line-modified">272         return promise;</span>
273     }
<a name="40" id="anc40"></a><span class="line-modified">274     promise-&gt;reject(globalObject, createError(globalObject, makeString(&quot;Could not import the module &#39;&quot;, moduleNameString, &quot;&#39;.&quot;)));</span>
275     catchScope.clearException();
<a name="41" id="anc41"></a><span class="line-modified">276     return promise;</span>
277 }
278 
<a name="42" id="anc42"></a><span class="line-modified">279 Identifier JSModuleLoader::resolveSync(JSGlobalObject* globalObject, JSValue name, JSValue referrer, JSValue scriptFetcher)</span>
280 {
<a name="43" id="anc43"></a><span class="line-modified">281     dataLogLnIf(Options::dumpModuleLoadingState(), &quot;Loader [resolve] &quot;, printableModuleKey(globalObject, name));</span>

282 
<a name="44" id="anc44"></a>
283     if (globalObject-&gt;globalObjectMethodTable()-&gt;moduleLoaderResolve)
<a name="45" id="anc45"></a><span class="line-modified">284         return globalObject-&gt;globalObjectMethodTable()-&gt;moduleLoaderResolve(globalObject, this, name, referrer, scriptFetcher);</span>
<span class="line-modified">285     return name.toPropertyKey(globalObject);</span>
286 }
287 
<a name="46" id="anc46"></a><span class="line-modified">288 JSInternalPromise* JSModuleLoader::resolve(JSGlobalObject* globalObject, JSValue name, JSValue referrer, JSValue scriptFetcher)</span>
289 {
<a name="47" id="anc47"></a><span class="line-modified">290     VM&amp; vm = globalObject-&gt;vm();</span>

291 
<a name="48" id="anc48"></a><span class="line-modified">292     auto* promise = JSInternalPromise::create(vm, globalObject-&gt;internalPromiseStructure());</span>

293 
294     auto catchScope = DECLARE_CATCH_SCOPE(vm);
295 
<a name="49" id="anc49"></a><span class="line-modified">296     const Identifier moduleKey = resolveSync(globalObject, name, referrer, scriptFetcher);</span>
297     if (UNLIKELY(catchScope.exception())) {
298         JSValue exception = catchScope.exception();
299         catchScope.clearException();
<a name="50" id="anc50"></a><span class="line-modified">300         promise-&gt;reject(globalObject, exception);</span>
301         catchScope.clearException();
<a name="51" id="anc51"></a><span class="line-modified">302         return promise;</span>
303     }
<a name="52" id="anc52"></a><span class="line-modified">304     promise-&gt;resolve(globalObject, identifierToJSValue(vm, moduleKey));</span>
305     catchScope.clearException();
<a name="53" id="anc53"></a><span class="line-modified">306     return promise;</span>
307 }
308 
<a name="54" id="anc54"></a><span class="line-modified">309 JSInternalPromise* JSModuleLoader::fetch(JSGlobalObject* globalObject, JSValue key, JSValue parameters, JSValue scriptFetcher)</span>
310 {
<a name="55" id="anc55"></a><span class="line-modified">311     dataLogLnIf(Options::dumpModuleLoadingState(), &quot;Loader [fetch] &quot;, printableModuleKey(globalObject, key));</span>

312 
<a name="56" id="anc56"></a>
313     VM&amp; vm = globalObject-&gt;vm();
314     auto throwScope = DECLARE_THROW_SCOPE(vm);
315 
316     if (globalObject-&gt;globalObjectMethodTable()-&gt;moduleLoaderFetch)
<a name="57" id="anc57"></a><span class="line-modified">317         RELEASE_AND_RETURN(throwScope, globalObject-&gt;globalObjectMethodTable()-&gt;moduleLoaderFetch(globalObject, this, key, parameters, scriptFetcher));</span>
318 
<a name="58" id="anc58"></a><span class="line-modified">319     auto* promise = JSInternalPromise::create(vm, globalObject-&gt;internalPromiseStructure());</span>

320 
321     auto catchScope = DECLARE_CATCH_SCOPE(vm);
322 
<a name="59" id="anc59"></a><span class="line-modified">323     String moduleKey = key.toWTFString(globalObject);</span>
324     if (UNLIKELY(catchScope.exception())) {
325         JSValue exception = catchScope.exception()-&gt;value();
326         catchScope.clearException();
<a name="60" id="anc60"></a><span class="line-modified">327         promise-&gt;reject(globalObject, exception);</span>
328         catchScope.clearException();
<a name="61" id="anc61"></a><span class="line-modified">329         return promise;</span>
330     }
<a name="62" id="anc62"></a><span class="line-modified">331     promise-&gt;reject(globalObject, createError(globalObject, makeString(&quot;Could not open the module &#39;&quot;, moduleKey, &quot;&#39;.&quot;)));</span>
332     catchScope.clearException();
<a name="63" id="anc63"></a><span class="line-modified">333     return promise;</span>
334 }
335 
<a name="64" id="anc64"></a><span class="line-modified">336 JSObject* JSModuleLoader::createImportMetaProperties(JSGlobalObject* globalObject, JSValue key, JSModuleRecord* moduleRecord, JSValue scriptFetcher)</span>
337 {
<a name="65" id="anc65"></a>
338     if (globalObject-&gt;globalObjectMethodTable()-&gt;moduleLoaderCreateImportMetaProperties)
<a name="66" id="anc66"></a><span class="line-modified">339         return globalObject-&gt;globalObjectMethodTable()-&gt;moduleLoaderCreateImportMetaProperties(globalObject, this, key, moduleRecord, scriptFetcher);</span>
<span class="line-modified">340     return constructEmptyObject(globalObject-&gt;vm(), globalObject-&gt;nullPrototypeObjectStructure());</span>
341 }
342 
<a name="67" id="anc67"></a><span class="line-modified">343 JSValue JSModuleLoader::evaluate(JSGlobalObject* globalObject, JSValue key, JSValue moduleRecordValue, JSValue scriptFetcher)</span>
344 {
<a name="68" id="anc68"></a><span class="line-modified">345     dataLogLnIf(Options::dumpModuleLoadingState(), &quot;Loader [evaluate] &quot;, printableModuleKey(globalObject, key));</span>

346 
<a name="69" id="anc69"></a>
347     if (globalObject-&gt;globalObjectMethodTable()-&gt;moduleLoaderEvaluate)
<a name="70" id="anc70"></a><span class="line-modified">348         return globalObject-&gt;globalObjectMethodTable()-&gt;moduleLoaderEvaluate(globalObject, this, key, moduleRecordValue, scriptFetcher);</span>
349 
<a name="71" id="anc71"></a><span class="line-modified">350     return evaluateNonVirtual(globalObject, key, moduleRecordValue, scriptFetcher);</span>
351 }
352 
<a name="72" id="anc72"></a><span class="line-modified">353 JSValue JSModuleLoader::evaluateNonVirtual(JSGlobalObject* globalObject, JSValue, JSValue moduleRecordValue, JSValue)</span>
354 {
<a name="73" id="anc73"></a><span class="line-modified">355     if (auto* moduleRecord = jsDynamicCast&lt;AbstractModuleRecord*&gt;(globalObject-&gt;vm(), moduleRecordValue))</span>
<span class="line-modified">356         return moduleRecord-&gt;evaluate(globalObject);</span>
357     return jsUndefined();
358 }
359 
<a name="74" id="anc74"></a><span class="line-modified">360 JSModuleNamespaceObject* JSModuleLoader::getModuleNamespaceObject(JSGlobalObject* globalObject, JSValue moduleRecordValue)</span>
361 {
<a name="75" id="anc75"></a><span class="line-modified">362     VM&amp; vm = globalObject-&gt;vm();</span>
363     auto scope = DECLARE_THROW_SCOPE(vm);
364 
365     auto* moduleRecord = jsDynamicCast&lt;AbstractModuleRecord*&gt;(vm, moduleRecordValue);
366     if (!moduleRecord) {
<a name="76" id="anc76"></a><span class="line-modified">367         throwTypeError(globalObject, scope);</span>
368         return nullptr;
369     }
370 
<a name="77" id="anc77"></a><span class="line-modified">371     RELEASE_AND_RETURN(scope, moduleRecord-&gt;getModuleNamespace(globalObject));</span>
372 }
373 
374 // ------------------------------ Functions --------------------------------
375 
<a name="78" id="anc78"></a><span class="line-modified">376 EncodedJSValue JSC_HOST_CALL moduleLoaderParseModule(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
377 {
<a name="79" id="anc79"></a><span class="line-modified">378     VM&amp; vm = globalObject-&gt;vm();</span>

379 
<a name="80" id="anc80"></a><span class="line-modified">380     auto* promise = JSInternalPromise::create(vm, globalObject-&gt;internalPromiseStructure());</span>

381 
382     auto catchScope = DECLARE_CATCH_SCOPE(vm);
383     auto reject = [&amp;] (JSValue rejectionReason) {
384         catchScope.clearException();
<a name="81" id="anc81"></a><span class="line-modified">385         promise-&gt;reject(globalObject, rejectionReason);</span>
386         catchScope.clearException();
<a name="82" id="anc82"></a><span class="line-modified">387         return JSValue::encode(promise);</span>
388     };
389 
<a name="83" id="anc83"></a><span class="line-modified">390     const Identifier moduleKey = callFrame-&gt;argument(0).toPropertyKey(globalObject);</span>
391     if (UNLIKELY(catchScope.exception()))
392         return reject(catchScope.exception());
393 
<a name="84" id="anc84"></a><span class="line-modified">394     JSValue source = callFrame-&gt;argument(1);</span>
395     auto* jsSourceCode = jsCast&lt;JSSourceCode*&gt;(source);
396     SourceCode sourceCode = jsSourceCode-&gt;sourceCode();
397 
398 #if ENABLE(WEBASSEMBLY)
399     if (sourceCode.provider()-&gt;sourceType() == SourceProviderSourceType::WebAssembly)
<a name="85" id="anc85"></a><span class="line-modified">400         return JSValue::encode(JSWebAssembly::instantiate(globalObject, promise, moduleKey, jsSourceCode));</span>
401 #endif
402 
403     CodeProfiling profile(sourceCode);
404 
405     ParserError error;
406     std::unique_ptr&lt;ModuleProgramNode&gt; moduleProgramNode = parse&lt;ModuleProgramNode&gt;(
407         vm, sourceCode, Identifier(), JSParserBuiltinMode::NotBuiltin,
408         JSParserStrictMode::Strict, JSParserScriptMode::Module, SourceParseMode::ModuleAnalyzeMode, SuperBinding::NotNeeded, error);
409     if (error.isValid())
<a name="86" id="anc86"></a><span class="line-modified">410         return reject(error.toErrorObject(globalObject, sourceCode));</span>
411     ASSERT(moduleProgramNode);
412 
<a name="87" id="anc87"></a><span class="line-modified">413     ModuleAnalyzer moduleAnalyzer(globalObject, moduleKey, sourceCode, moduleProgramNode-&gt;varDeclarations(), moduleProgramNode-&gt;lexicalVariables());</span>
414     if (UNLIKELY(catchScope.exception()))
415         return reject(catchScope.exception());
416 
<a name="88" id="anc88"></a><span class="line-modified">417     promise-&gt;resolve(globalObject, moduleAnalyzer.analyze(*moduleProgramNode));</span>
418     catchScope.clearException();
<a name="89" id="anc89"></a><span class="line-modified">419     return JSValue::encode(promise);</span>
420 }
421 
<a name="90" id="anc90"></a><span class="line-modified">422 EncodedJSValue JSC_HOST_CALL moduleLoaderRequestedModules(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
423 {
<a name="91" id="anc91"></a><span class="line-modified">424     VM&amp; vm = globalObject-&gt;vm();</span>
425     auto scope = DECLARE_THROW_SCOPE(vm);
<a name="92" id="anc92"></a><span class="line-modified">426     auto* moduleRecord = jsDynamicCast&lt;AbstractModuleRecord*&gt;(vm, callFrame-&gt;argument(0));</span>
427     if (!moduleRecord)
<a name="93" id="anc93"></a><span class="line-modified">428         RELEASE_AND_RETURN(scope, JSValue::encode(constructEmptyArray(globalObject, nullptr)));</span>
429 
<a name="94" id="anc94"></a><span class="line-modified">430     JSArray* result = constructEmptyArray(globalObject, nullptr, moduleRecord-&gt;requestedModules().size());</span>
431     RETURN_IF_EXCEPTION(scope, encodedJSValue());
432     size_t i = 0;
433     for (auto&amp; key : moduleRecord-&gt;requestedModules()) {
<a name="95" id="anc95"></a><span class="line-modified">434         result-&gt;putDirectIndex(globalObject, i++, jsString(vm, key.get()));</span>
435         RETURN_IF_EXCEPTION(scope, encodedJSValue());
436     }
437     return JSValue::encode(result);
438 }
439 
<a name="96" id="anc96"></a><span class="line-modified">440 EncodedJSValue JSC_HOST_CALL moduleLoaderModuleDeclarationInstantiation(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
441 {
<a name="97" id="anc97"></a><span class="line-modified">442     VM&amp; vm = globalObject-&gt;vm();</span>
443     auto scope = DECLARE_THROW_SCOPE(vm);
<a name="98" id="anc98"></a><span class="line-modified">444     auto* moduleRecord = jsDynamicCast&lt;AbstractModuleRecord*&gt;(vm, callFrame-&gt;argument(0));</span>
445     if (!moduleRecord)
446         return JSValue::encode(jsUndefined());
447 
<a name="99" id="anc99"></a><span class="line-modified">448     dataLogLnIf(Options::dumpModuleLoadingState(), &quot;Loader [link] &quot;, moduleRecord-&gt;moduleKey());</span>

449 
<a name="100" id="anc100"></a><span class="line-modified">450     moduleRecord-&gt;link(globalObject, callFrame-&gt;argument(1));</span>
451     RETURN_IF_EXCEPTION(scope, encodedJSValue());
452 
453     return JSValue::encode(jsUndefined());
454 }
455 
456 // ------------------------------ Hook Functions ---------------------------
457 
<a name="101" id="anc101"></a><span class="line-modified">458 EncodedJSValue JSC_HOST_CALL moduleLoaderResolve(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
459 {
<a name="102" id="anc102"></a><span class="line-modified">460     VM&amp; vm = globalObject-&gt;vm();</span>
461     // Hook point, Loader.resolve.
462     // https://whatwg.github.io/loader/#browser-resolve
463     // Take the name and resolve it to the unique identifier for the resource location.
464     // For example, take the &quot;jquery&quot; and return the URL for the resource.
<a name="103" id="anc103"></a><span class="line-modified">465     JSModuleLoader* loader = jsDynamicCast&lt;JSModuleLoader*&gt;(vm, callFrame-&gt;thisValue());</span>
466     if (!loader)
467         return JSValue::encode(jsUndefined());
<a name="104" id="anc104"></a><span class="line-modified">468     return JSValue::encode(loader-&gt;resolve(globalObject, callFrame-&gt;argument(0), callFrame-&gt;argument(1), callFrame-&gt;argument(2)));</span>
469 }
470 
<a name="105" id="anc105"></a><span class="line-modified">471 EncodedJSValue JSC_HOST_CALL moduleLoaderResolveSync(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
472 {
<a name="106" id="anc106"></a><span class="line-modified">473     VM&amp; vm = globalObject-&gt;vm();</span>
474     auto scope = DECLARE_THROW_SCOPE(vm);
475 
<a name="107" id="anc107"></a><span class="line-modified">476     JSModuleLoader* loader = jsDynamicCast&lt;JSModuleLoader*&gt;(vm, callFrame-&gt;thisValue());</span>
477     if (!loader)
478         return JSValue::encode(jsUndefined());
<a name="108" id="anc108"></a><span class="line-modified">479     auto result = loader-&gt;resolveSync(globalObject, callFrame-&gt;argument(0), callFrame-&gt;argument(1), callFrame-&gt;argument(2));</span>
480     RETURN_IF_EXCEPTION(scope, encodedJSValue());
481     return JSValue::encode(identifierToJSValue(vm, result));
482 }
483 
<a name="109" id="anc109"></a><span class="line-modified">484 EncodedJSValue JSC_HOST_CALL moduleLoaderFetch(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
485 {
<a name="110" id="anc110"></a><span class="line-modified">486     VM&amp; vm = globalObject-&gt;vm();</span>
487     // Hook point, Loader.fetch
488     // https://whatwg.github.io/loader/#browser-fetch
489     // Take the key and fetch the resource actually.
490     // For example, JavaScriptCore shell can provide the hook fetching the resource
491     // from the local file system.
<a name="111" id="anc111"></a><span class="line-modified">492     JSModuleLoader* loader = jsDynamicCast&lt;JSModuleLoader*&gt;(vm, callFrame-&gt;thisValue());</span>
493     if (!loader)
494         return JSValue::encode(jsUndefined());
<a name="112" id="anc112"></a><span class="line-modified">495     return JSValue::encode(loader-&gt;fetch(globalObject, callFrame-&gt;argument(0), callFrame-&gt;argument(1), callFrame-&gt;argument(2)));</span>
496 }
497 
<a name="113" id="anc113"></a><span class="line-modified">498 EncodedJSValue JSC_HOST_CALL moduleLoaderGetModuleNamespaceObject(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
499 {
<a name="114" id="anc114"></a><span class="line-modified">500     VM&amp; vm = globalObject-&gt;vm();</span>
501     auto scope = DECLARE_THROW_SCOPE(vm);
502 
<a name="115" id="anc115"></a><span class="line-modified">503     auto* loader = jsDynamicCast&lt;JSModuleLoader*&gt;(vm, callFrame-&gt;thisValue());</span>
504     if (!loader)
505         return JSValue::encode(jsUndefined());
<a name="116" id="anc116"></a><span class="line-modified">506     auto* moduleNamespaceObject = loader-&gt;getModuleNamespaceObject(globalObject, callFrame-&gt;argument(0));</span>
507     RETURN_IF_EXCEPTION(scope, encodedJSValue());
508     return JSValue::encode(moduleNamespaceObject);
509 }
510 
511 // ------------------- Additional Hook Functions ---------------------------
512 
<a name="117" id="anc117"></a><span class="line-modified">513 EncodedJSValue JSC_HOST_CALL moduleLoaderEvaluate(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
514 {
515     // To instrument and retrieve the errors raised from the module execution,
516     // we inserted the hook point here.
517 
<a name="118" id="anc118"></a><span class="line-modified">518     VM&amp; vm = globalObject-&gt;vm();</span>
<span class="line-modified">519     JSModuleLoader* loader = jsDynamicCast&lt;JSModuleLoader*&gt;(vm, callFrame-&gt;thisValue());</span>
520     if (!loader)
521         return JSValue::encode(jsUndefined());
<a name="119" id="anc119"></a><span class="line-modified">522     return JSValue::encode(loader-&gt;evaluate(globalObject, callFrame-&gt;argument(0), callFrame-&gt;argument(1), callFrame-&gt;argument(2)));</span>
523 }
524 
525 } // namespace JSC
<a name="120" id="anc120"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="120" type="hidden" />
</body>
</html>