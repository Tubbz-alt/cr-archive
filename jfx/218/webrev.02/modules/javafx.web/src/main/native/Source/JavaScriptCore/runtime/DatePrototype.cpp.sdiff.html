<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/JavaScriptCore/runtime/DatePrototype.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="DateInstanceCache.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="DatePrototype.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/JavaScriptCore/runtime/DatePrototype.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  52 #endif
  53 
  54 #if HAVE(SYS_TIME_H)
  55 #include &lt;sys/time.h&gt;
  56 #endif
  57 
  58 #if HAVE(SYS_TIMEB_H)
  59 #include &lt;sys/timeb.h&gt;
  60 #endif
  61 
  62 #if !(OS(DARWIN) &amp;&amp; USE(CF))
  63 #include &lt;unicode/udat.h&gt;
  64 #endif
  65 
  66 #if USE(CF)
  67 #include &lt;CoreFoundation/CoreFoundation.h&gt;
  68 #endif
  69 
  70 namespace JSC {
  71 
<span class="line-modified">  72 using namespace WTF;</span>
<span class="line-modified">  73 </span>
<span class="line-modified">  74 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetDate(ExecState*);</span>
<span class="line-modified">  75 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetDay(ExecState*);</span>
<span class="line-modified">  76 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetFullYear(ExecState*);</span>
<span class="line-modified">  77 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetHours(ExecState*);</span>
<span class="line-modified">  78 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetMilliSeconds(ExecState*);</span>
<span class="line-modified">  79 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetMinutes(ExecState*);</span>
<span class="line-modified">  80 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetMonth(ExecState*);</span>
<span class="line-modified">  81 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetSeconds(ExecState*);</span>
<span class="line-modified">  82 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetTimezoneOffset(ExecState*);</span>
<span class="line-modified">  83 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetUTCDate(ExecState*);</span>
<span class="line-modified">  84 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetUTCDay(ExecState*);</span>
<span class="line-modified">  85 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetUTCFullYear(ExecState*);</span>
<span class="line-modified">  86 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetUTCHours(ExecState*);</span>
<span class="line-modified">  87 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetUTCMilliseconds(ExecState*);</span>
<span class="line-modified">  88 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetUTCMinutes(ExecState*);</span>
<span class="line-modified">  89 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetUTCMonth(ExecState*);</span>
<span class="line-modified">  90 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetUTCSeconds(ExecState*);</span>
<span class="line-modified">  91 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetYear(ExecState*);</span>
<span class="line-modified">  92 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetDate(ExecState*);</span>
<span class="line-modified">  93 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetFullYear(ExecState*);</span>
<span class="line-modified">  94 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetHours(ExecState*);</span>
<span class="line-modified">  95 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetMilliSeconds(ExecState*);</span>
<span class="line-modified">  96 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetMinutes(ExecState*);</span>
<span class="line-modified">  97 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetMonth(ExecState*);</span>
<span class="line-modified">  98 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetSeconds(ExecState*);</span>
<span class="line-modified">  99 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetTime(ExecState*);</span>
<span class="line-modified"> 100 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetUTCDate(ExecState*);</span>
<span class="line-modified"> 101 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetUTCFullYear(ExecState*);</span>
<span class="line-modified"> 102 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetUTCHours(ExecState*);</span>
<span class="line-modified"> 103 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetUTCMilliseconds(ExecState*);</span>
<span class="line-modified"> 104 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetUTCMinutes(ExecState*);</span>
<span class="line-modified"> 105 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetUTCMonth(ExecState*);</span>
<span class="line-modified"> 106 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetUTCSeconds(ExecState*);</span>
<span class="line-modified"> 107 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetYear(ExecState*);</span>
<span class="line-modified"> 108 EncodedJSValue JSC_HOST_CALL dateProtoFuncToDateString(ExecState*);</span>
<span class="line-modified"> 109 EncodedJSValue JSC_HOST_CALL dateProtoFuncToLocaleDateString(ExecState*);</span>
<span class="line-modified"> 110 EncodedJSValue JSC_HOST_CALL dateProtoFuncToLocaleString(ExecState*);</span>
<span class="line-modified"> 111 EncodedJSValue JSC_HOST_CALL dateProtoFuncToLocaleTimeString(ExecState*);</span>
<span class="line-modified"> 112 EncodedJSValue JSC_HOST_CALL dateProtoFuncToPrimitiveSymbol(ExecState*);</span>
<span class="line-modified"> 113 EncodedJSValue JSC_HOST_CALL dateProtoFuncToString(ExecState*);</span>
<span class="line-modified"> 114 EncodedJSValue JSC_HOST_CALL dateProtoFuncToTimeString(ExecState*);</span>
<span class="line-modified"> 115 EncodedJSValue JSC_HOST_CALL dateProtoFuncToUTCString(ExecState*);</span>
<span class="line-removed"> 116 EncodedJSValue JSC_HOST_CALL dateProtoFuncToISOString(ExecState*);</span>
<span class="line-removed"> 117 EncodedJSValue JSC_HOST_CALL dateProtoFuncToJSON(ExecState*);</span>
 118 
 119 }
 120 
 121 #include &quot;DatePrototype.lut.h&quot;
 122 
 123 namespace JSC {
 124 
 125 enum LocaleDateTimeFormat { LocaleDateAndTime, LocaleDate, LocaleTime };
 126 
 127 #if OS(DARWIN) &amp;&amp; USE(CF)
 128 
 129 // FIXME: Since this is superior to the strftime-based version, why limit this to OS(DARWIN)?
 130 // Instead we should consider using this whenever USE(CF) is true.
 131 
 132 static CFDateFormatterStyle styleFromArgString(const String&amp; string, CFDateFormatterStyle defaultStyle)
 133 {
 134     if (string == &quot;short&quot;)
 135         return kCFDateFormatterShortStyle;
 136     if (string == &quot;medium&quot;)
 137         return kCFDateFormatterMediumStyle;
 138     if (string == &quot;long&quot;)
 139         return kCFDateFormatterLongStyle;
 140     if (string == &quot;full&quot;)
 141         return kCFDateFormatterFullStyle;
 142     return defaultStyle;
 143 }
 144 
<span class="line-modified"> 145 static JSCell* formatLocaleDate(ExecState* exec, DateInstance*, double timeInMilliseconds, LocaleDateTimeFormat format)</span>
 146 {
<span class="line-modified"> 147     VM&amp; vm = exec-&gt;vm();</span>
 148     CFDateFormatterStyle dateStyle = (format != LocaleTime ? kCFDateFormatterLongStyle : kCFDateFormatterNoStyle);
 149     CFDateFormatterStyle timeStyle = (format != LocaleDate ? kCFDateFormatterLongStyle : kCFDateFormatterNoStyle);
 150 
 151     bool useCustomFormat = false;
 152     String customFormatString;
 153 
<span class="line-modified"> 154     String arg0String = exec-&gt;argument(0).toWTFString(exec);</span>
<span class="line-modified"> 155     if (arg0String == &quot;custom&quot; &amp;&amp; !exec-&gt;argument(1).isUndefined()) {</span>
 156         useCustomFormat = true;
<span class="line-modified"> 157         customFormatString = exec-&gt;argument(1).toWTFString(exec);</span>
<span class="line-modified"> 158     } else if (format == LocaleDateAndTime &amp;&amp; !exec-&gt;argument(1).isUndefined()) {</span>
 159         dateStyle = styleFromArgString(arg0String, dateStyle);
<span class="line-modified"> 160         timeStyle = styleFromArgString(exec-&gt;argument(1).toWTFString(exec), timeStyle);</span>
<span class="line-modified"> 161     } else if (format != LocaleTime &amp;&amp; !exec-&gt;argument(0).isUndefined())</span>
 162         dateStyle = styleFromArgString(arg0String, dateStyle);
<span class="line-modified"> 163     else if (format != LocaleDate &amp;&amp; !exec-&gt;argument(0).isUndefined())</span>
 164         timeStyle = styleFromArgString(arg0String, timeStyle);
 165 
 166     CFAbsoluteTime absoluteTime = floor(timeInMilliseconds / msPerSecond) - kCFAbsoluteTimeIntervalSince1970;
 167 
 168     auto formatter = adoptCF(CFDateFormatterCreate(kCFAllocatorDefault, adoptCF(CFLocaleCopyCurrent()).get(), dateStyle, timeStyle));
 169     if (useCustomFormat)
 170         CFDateFormatterSetFormat(formatter.get(), customFormatString.createCFString().get());
 171     return jsNontrivialString(vm, adoptCF(CFDateFormatterCreateStringWithAbsoluteTime(kCFAllocatorDefault, formatter.get(), absoluteTime)).get());
 172 }
 173 
 174 #elif !UCONFIG_NO_FORMATTING
 175 
<span class="line-modified"> 176 static JSCell* formatLocaleDate(ExecState* exec, DateInstance*, double timeInMilliseconds, LocaleDateTimeFormat format)</span>
 177 {
<span class="line-modified"> 178     VM&amp; vm = exec-&gt;vm();</span>
 179     UDateFormatStyle timeStyle = (format != LocaleDate ? UDAT_LONG : UDAT_NONE);
 180     UDateFormatStyle dateStyle = (format != LocaleTime ? UDAT_LONG : UDAT_NONE);
 181 
 182     UErrorCode status = U_ZERO_ERROR;
 183     UDateFormat* df = udat_open(timeStyle, dateStyle, 0, 0, -1, 0, 0, &amp;status);
 184     if (!df)
 185         return jsEmptyString(vm);
 186 
 187     UChar buffer[128];
 188     int32_t length;
 189     length = udat_format(df, timeInMilliseconds, buffer, 128, 0, &amp;status);
 190     udat_close(df);
 191     if (status != U_ZERO_ERROR)
 192         return jsEmptyString(vm);
 193 
 194     return jsNontrivialString(vm, String(buffer, length));
 195 }
 196 
 197 #else
 198 
<span class="line-modified"> 199 static JSCell* formatLocaleDate(ExecState* exec, const GregorianDateTime&amp; gdt, LocaleDateTimeFormat format)</span>
 200 {
<span class="line-modified"> 201     VM&amp; vm = exec-&gt;vm();</span>
 202 #if OS(WINDOWS)
 203     SYSTEMTIME systemTime;
 204     memset(&amp;systemTime, 0, sizeof(systemTime));
 205     systemTime.wYear = gdt.year();
 206     systemTime.wMonth = gdt.month() + 1;
 207     systemTime.wDay = gdt.monthDay();
 208     systemTime.wDayOfWeek = gdt.weekDay();
 209     systemTime.wHour = gdt.hour();
 210     systemTime.wMinute = gdt.minute();
 211     systemTime.wSecond = gdt.second();
 212 
 213     Vector&lt;UChar, 128&gt; buffer;
 214     size_t length = 0;
 215 
 216     if (format == LocaleDate) {
 217         buffer.resize(GetDateFormatW(LOCALE_USER_DEFAULT, DATE_LONGDATE, &amp;systemTime, 0, 0, 0));
 218         length = GetDateFormatW(LOCALE_USER_DEFAULT, DATE_LONGDATE, &amp;systemTime, 0, buffer.data(), buffer.size());
 219     } else if (format == LocaleTime) {
 220         buffer.resize(GetTimeFormatW(LOCALE_USER_DEFAULT, 0, &amp;systemTime, 0, 0, 0));
 221         length = GetTimeFormatW(LOCALE_USER_DEFAULT, 0, &amp;systemTime, 0, buffer.data(), buffer.size());
</pre>
<hr />
<pre>
 293     // and wide character represents UTF-32 code point.
 294     // Here we static_cast potential UTF-32 to UTF-16, it should be
 295     // safe because date and (or) time related characters in different languages
 296     // should be in UNICODE BMP. If mbstowcs fails, we just fall
 297     // back on using multi-byte result as-is.
 298 #ifdef __STDC_ISO_10646__
 299     UChar buffer[bufsize];
 300     wchar_t tempbuffer[bufsize];
 301     size_t length = mbstowcs(tempbuffer, timebuffer, bufsize - 1);
 302     if (length != static_cast&lt;size_t&gt;(-1)) {
 303         for (size_t i = 0; i &lt; length; ++i)
 304             buffer[i] = static_cast&lt;UChar&gt;(tempbuffer[i]);
 305         return jsNontrivialString(vm, String(buffer, length));
 306     }
 307 #endif
 308 
 309     return jsNontrivialString(vm, timebuffer);
 310 #endif // OS(WINDOWS)
 311 }
 312 
<span class="line-modified"> 313 static JSCell* formatLocaleDate(ExecState* exec, DateInstance* dateObject, double, LocaleDateTimeFormat format)</span>
 314 {
<span class="line-modified"> 315     VM&amp; vm = exec-&gt;vm();</span>
<span class="line-modified"> 316     const GregorianDateTime* gregorianDateTime = dateObject-&gt;gregorianDateTime(exec);</span>
 317     if (!gregorianDateTime)
 318         return jsNontrivialString(vm, &quot;Invalid Date&quot;_s);
<span class="line-modified"> 319     return formatLocaleDate(exec, *gregorianDateTime, format);</span>
 320 }
 321 
 322 #endif // OS(DARWIN) &amp;&amp; USE(CF)
 323 
<span class="line-modified"> 324 static EncodedJSValue formateDateInstance(ExecState* exec, DateTimeFormat format, bool asUTCVariant)</span>
 325 {
<span class="line-modified"> 326     VM&amp; vm = exec-&gt;vm();</span>
 327     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified"> 328     JSValue thisValue = exec-&gt;thisValue();</span>
 329     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 330     if (UNLIKELY(!thisDateObj))
<span class="line-modified"> 331         return throwVMTypeError(exec, scope);</span>
 332 
 333     const GregorianDateTime* gregorianDateTime = asUTCVariant
<span class="line-modified"> 334         ? thisDateObj-&gt;gregorianDateTimeUTC(exec)</span>
<span class="line-modified"> 335         : thisDateObj-&gt;gregorianDateTime(exec);</span>
 336     if (!gregorianDateTime)
 337         return JSValue::encode(jsNontrivialString(vm, String(&quot;Invalid Date&quot;_s)));
 338 
 339     return JSValue::encode(jsNontrivialString(vm, formatDateTime(*gregorianDateTime, format, asUTCVariant)));
 340 }
 341 
 342 // Converts a list of arguments sent to a Date member function into milliseconds, updating
 343 // ms (representing milliseconds) and t (representing the rest of the date structure) appropriately.
 344 //
 345 // Format of member function: f([hour,] [min,] [sec,] [ms])
<span class="line-modified"> 346 static bool fillStructuresUsingTimeArgs(ExecState* exec, int maxArgs, double* ms, GregorianDateTime* t)</span>
 347 {
<span class="line-modified"> 348     VM&amp; vm = exec-&gt;vm();</span>
 349     auto scope = DECLARE_THROW_SCOPE(vm);
 350 
 351     double milliseconds = 0;
 352     bool ok = true;
 353     int idx = 0;
<span class="line-modified"> 354     int numArgs = exec-&gt;argumentCount();</span>
 355 
 356     // JS allows extra trailing arguments -- ignore them
 357     if (numArgs &gt; maxArgs)
 358         numArgs = maxArgs;
 359 
 360     // hours
 361     if (maxArgs &gt;= 4 &amp;&amp; idx &lt; numArgs) {
 362         t-&gt;setHour(0);
<span class="line-modified"> 363         double hours = exec-&gt;uncheckedArgument(idx++).toIntegerPreserveNaN(exec);</span>
 364         RETURN_IF_EXCEPTION(scope, false);
 365         ok = std::isfinite(hours);
 366         milliseconds += hours * msPerHour;
 367     }
 368 
 369     // minutes
 370     if (maxArgs &gt;= 3 &amp;&amp; idx &lt; numArgs &amp;&amp; ok) {
 371         t-&gt;setMinute(0);
<span class="line-modified"> 372         double minutes = exec-&gt;uncheckedArgument(idx++).toIntegerPreserveNaN(exec);</span>
 373         RETURN_IF_EXCEPTION(scope, false);
 374         ok = std::isfinite(minutes);
 375         milliseconds += minutes * msPerMinute;
 376     }
 377 
 378     // seconds
 379     if (maxArgs &gt;= 2 &amp;&amp; idx &lt; numArgs &amp;&amp; ok) {
 380         t-&gt;setSecond(0);
<span class="line-modified"> 381         double seconds = exec-&gt;uncheckedArgument(idx++).toIntegerPreserveNaN(exec);</span>
 382         RETURN_IF_EXCEPTION(scope, false);
 383         ok = std::isfinite(seconds);
 384         milliseconds += seconds * msPerSecond;
 385     }
 386 
 387     if (!ok)
 388         return false;
 389 
 390     // milliseconds
 391     if (idx &lt; numArgs) {
<span class="line-modified"> 392         double millis = exec-&gt;uncheckedArgument(idx).toIntegerPreserveNaN(exec);</span>
 393         RETURN_IF_EXCEPTION(scope, false);
 394         ok = std::isfinite(millis);
 395         milliseconds += millis;
 396     } else
 397         milliseconds += *ms;
 398 
 399     *ms = milliseconds;
 400     return ok;
 401 }
 402 
 403 // Converts a list of arguments sent to a Date member function into years, months, and milliseconds, updating
 404 // ms (representing milliseconds) and t (representing the rest of the date structure) appropriately.
 405 //
 406 // Format of member function: f([years,] [months,] [days])
<span class="line-modified"> 407 static bool fillStructuresUsingDateArgs(ExecState *exec, int maxArgs, double *ms, GregorianDateTime *t)</span>
 408 {
<span class="line-modified"> 409     VM&amp; vm = exec-&gt;vm();</span>
 410     auto scope = DECLARE_THROW_SCOPE(vm);
 411 
 412     int idx = 0;
 413     bool ok = true;
<span class="line-modified"> 414     int numArgs = exec-&gt;argumentCount();</span>
 415 
 416     // JS allows extra trailing arguments -- ignore them
 417     if (numArgs &gt; maxArgs)
 418         numArgs = maxArgs;
 419 
 420     // years
 421     if (maxArgs &gt;= 3 &amp;&amp; idx &lt; numArgs) {
<span class="line-modified"> 422         double years = exec-&gt;uncheckedArgument(idx++).toIntegerPreserveNaN(exec);</span>
 423         RETURN_IF_EXCEPTION(scope, false);
 424         ok = std::isfinite(years);
 425         t-&gt;setYear(toInt32(years));
 426     }
 427     // months
 428     if (maxArgs &gt;= 2 &amp;&amp; idx &lt; numArgs &amp;&amp; ok) {
<span class="line-modified"> 429         double months = exec-&gt;uncheckedArgument(idx++).toIntegerPreserveNaN(exec);</span>
 430         RETURN_IF_EXCEPTION(scope, false);
 431         ok = std::isfinite(months);
 432         t-&gt;setMonth(toInt32(months));
 433     }
 434     // days
 435     if (idx &lt; numArgs &amp;&amp; ok) {
<span class="line-modified"> 436         double days = exec-&gt;uncheckedArgument(idx++).toIntegerPreserveNaN(exec);</span>
 437         RETURN_IF_EXCEPTION(scope, false);
 438         ok = std::isfinite(days);
 439         t-&gt;setMonthDay(0);
 440         *ms += days * msPerDay;
 441     }
 442 
 443     return ok;
 444 }
 445 
 446 const ClassInfo DatePrototype::s_info = {&quot;Object&quot;, &amp;JSNonFinalObject::s_info, &amp;dateTable, nullptr, CREATE_METHOD_TABLE(DatePrototype)};
 447 
 448 /* Source for DatePrototype.lut.h
 449 @begin dateTable
 450   toString              dateProtoFuncToString                DontEnum|Function       0
 451   toISOString           dateProtoFuncToISOString             DontEnum|Function       0
 452   toDateString          dateProtoFuncToDateString            DontEnum|Function       0
 453   toTimeString          dateProtoFuncToTimeString            DontEnum|Function       0
 454   toLocaleString        dateProtoFuncToLocaleString          DontEnum|Function       0
 455   toLocaleDateString    dateProtoFuncToLocaleDateString      DontEnum|Function       0
 456   toLocaleTimeString    dateProtoFuncToLocaleTimeString      DontEnum|Function       0
<span class="line-modified"> 457   valueOf               dateProtoFuncGetTime                 DontEnum|Function       0</span>
<span class="line-modified"> 458   getTime               dateProtoFuncGetTime                 DontEnum|Function       0</span>
<span class="line-modified"> 459   getFullYear           dateProtoFuncGetFullYear             DontEnum|Function       0</span>
<span class="line-modified"> 460   getUTCFullYear        dateProtoFuncGetUTCFullYear          DontEnum|Function       0</span>
<span class="line-modified"> 461   getMonth              dateProtoFuncGetMonth                DontEnum|Function       0</span>
<span class="line-modified"> 462   getUTCMonth           dateProtoFuncGetUTCMonth             DontEnum|Function       0</span>
<span class="line-modified"> 463   getDate               dateProtoFuncGetDate                 DontEnum|Function       0</span>
<span class="line-modified"> 464   getUTCDate            dateProtoFuncGetUTCDate              DontEnum|Function       0</span>
<span class="line-modified"> 465   getDay                dateProtoFuncGetDay                  DontEnum|Function       0</span>
<span class="line-modified"> 466   getUTCDay             dateProtoFuncGetUTCDay               DontEnum|Function       0</span>
<span class="line-modified"> 467   getHours              dateProtoFuncGetHours                DontEnum|Function       0</span>
<span class="line-modified"> 468   getUTCHours           dateProtoFuncGetUTCHours             DontEnum|Function       0</span>
<span class="line-modified"> 469   getMinutes            dateProtoFuncGetMinutes              DontEnum|Function       0</span>
<span class="line-modified"> 470   getUTCMinutes         dateProtoFuncGetUTCMinutes           DontEnum|Function       0</span>
<span class="line-modified"> 471   getSeconds            dateProtoFuncGetSeconds              DontEnum|Function       0</span>
<span class="line-modified"> 472   getUTCSeconds         dateProtoFuncGetUTCSeconds           DontEnum|Function       0</span>
<span class="line-modified"> 473   getMilliseconds       dateProtoFuncGetMilliSeconds         DontEnum|Function       0</span>
<span class="line-modified"> 474   getUTCMilliseconds    dateProtoFuncGetUTCMilliseconds      DontEnum|Function       0</span>
<span class="line-modified"> 475   getTimezoneOffset     dateProtoFuncGetTimezoneOffset       DontEnum|Function       0</span>

 476   setTime               dateProtoFuncSetTime                 DontEnum|Function       1
 477   setMilliseconds       dateProtoFuncSetMilliSeconds         DontEnum|Function       1
 478   setUTCMilliseconds    dateProtoFuncSetUTCMilliseconds      DontEnum|Function       1
 479   setSeconds            dateProtoFuncSetSeconds              DontEnum|Function       2
 480   setUTCSeconds         dateProtoFuncSetUTCSeconds           DontEnum|Function       2
 481   setMinutes            dateProtoFuncSetMinutes              DontEnum|Function       3
 482   setUTCMinutes         dateProtoFuncSetUTCMinutes           DontEnum|Function       3
 483   setHours              dateProtoFuncSetHours                DontEnum|Function       4
 484   setUTCHours           dateProtoFuncSetUTCHours             DontEnum|Function       4
 485   setDate               dateProtoFuncSetDate                 DontEnum|Function       1
 486   setUTCDate            dateProtoFuncSetUTCDate              DontEnum|Function       1
 487   setMonth              dateProtoFuncSetMonth                DontEnum|Function       2
 488   setUTCMonth           dateProtoFuncSetUTCMonth             DontEnum|Function       2
 489   setFullYear           dateProtoFuncSetFullYear             DontEnum|Function       3
 490   setUTCFullYear        dateProtoFuncSetUTCFullYear          DontEnum|Function       3
 491   setYear               dateProtoFuncSetYear                 DontEnum|Function       1
<span class="line-removed"> 492   getYear               dateProtoFuncGetYear                 DontEnum|Function       0</span>
 493   toJSON                dateProtoFuncToJSON                  DontEnum|Function       1
 494 @end
 495 */
 496 
 497 // ECMA 15.9.4
 498 
 499 DatePrototype::DatePrototype(VM&amp; vm, Structure* structure)
 500     : Base(vm, structure)
 501 {
 502 }
 503 
 504 void DatePrototype::finishCreation(VM&amp; vm, JSGlobalObject* globalObject)
 505 {
 506     Base::finishCreation(vm);
 507     ASSERT(inherits(vm, info()));
 508 
 509     Identifier toUTCStringName = Identifier::fromString(vm, &quot;toUTCString&quot;_s);
 510     JSFunction* toUTCStringFunction = JSFunction::create(vm, globalObject, 0, toUTCStringName.string(), dateProtoFuncToUTCString);
 511     putDirectWithoutTransition(vm, toUTCStringName, toUTCStringFunction, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum));
 512     putDirectWithoutTransition(vm, Identifier::fromString(vm, &quot;toGMTString&quot;_s), toUTCStringFunction, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum));
 513 
 514 #if ENABLE(INTL)
 515     JSC_BUILTIN_FUNCTION_WITHOUT_TRANSITION(&quot;toLocaleString&quot;, datePrototypeToLocaleStringCodeGenerator, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum));
 516     JSC_BUILTIN_FUNCTION_WITHOUT_TRANSITION(&quot;toLocaleDateString&quot;, datePrototypeToLocaleDateStringCodeGenerator, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum));
 517     JSC_BUILTIN_FUNCTION_WITHOUT_TRANSITION(&quot;toLocaleTimeString&quot;, datePrototypeToLocaleTimeStringCodeGenerator, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum));
 518 #endif
 519 
 520     JSFunction* toPrimitiveFunction = JSFunction::create(vm, globalObject, 1, &quot;[Symbol.toPrimitive]&quot;_s, dateProtoFuncToPrimitiveSymbol, NoIntrinsic);
 521     putDirectWithoutTransition(vm, vm.propertyNames-&gt;toPrimitiveSymbol, toPrimitiveFunction, PropertyAttribute::DontEnum | PropertyAttribute::ReadOnly);
 522 
 523     // The constructor will be added later, after DateConstructor has been built.
 524 }
 525 
 526 // Functions
 527 
<span class="line-modified"> 528 EncodedJSValue JSC_HOST_CALL dateProtoFuncToString(ExecState* exec)</span>
 529 {
 530     const bool asUTCVariant = false;
<span class="line-modified"> 531     return formateDateInstance(exec, DateTimeFormatDateAndTime, asUTCVariant);</span>
 532 }
 533 
<span class="line-modified"> 534 EncodedJSValue JSC_HOST_CALL dateProtoFuncToUTCString(ExecState* exec)</span>
 535 {
 536     const bool asUTCVariant = true;
<span class="line-modified"> 537     return formateDateInstance(exec, DateTimeFormatDateAndTime, asUTCVariant);</span>
 538 }
 539 
<span class="line-modified"> 540 EncodedJSValue JSC_HOST_CALL dateProtoFuncToISOString(ExecState* exec)</span>
 541 {
<span class="line-modified"> 542     VM&amp; vm = exec-&gt;vm();</span>
 543     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified"> 544     JSValue thisValue = exec-&gt;thisValue();</span>
 545     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 546     if (UNLIKELY(!thisDateObj))
<span class="line-modified"> 547         return throwVMTypeError(exec, scope);</span>
 548 
 549     if (!std::isfinite(thisDateObj-&gt;internalNumber()))
<span class="line-modified"> 550         return throwVMError(exec, scope, createRangeError(exec, &quot;Invalid Date&quot;_s));</span>
 551 
<span class="line-modified"> 552     const GregorianDateTime* gregorianDateTime = thisDateObj-&gt;gregorianDateTimeUTC(exec);</span>
 553     if (!gregorianDateTime)
 554         return JSValue::encode(jsNontrivialString(vm, String(&quot;Invalid Date&quot;_s)));
 555     // Maximum amount of space we need in buffer: 7 (max. digits in year) + 2 * 5 (2 characters each for month, day, hour, minute, second) + 4 (. + 3 digits for milliseconds)
 556     // 6 for formatting and one for null termination = 28. We add one extra character to allow us to force null termination.
 557     char buffer[28];
 558     // If the year is outside the bounds of 0 and 9999 inclusive we want to use the extended year format (ES 15.9.1.15.1).
 559     int ms = static_cast&lt;int&gt;(fmod(thisDateObj-&gt;internalNumber(), msPerSecond));
 560     if (ms &lt; 0)
 561         ms += msPerSecond;
 562 
 563     int charactersWritten;
 564     if (gregorianDateTime-&gt;year() &gt; 9999 || gregorianDateTime-&gt;year() &lt; 0)
 565         charactersWritten = snprintf(buffer, sizeof(buffer), &quot;%+07d-%02d-%02dT%02d:%02d:%02d.%03dZ&quot;, gregorianDateTime-&gt;year(), gregorianDateTime-&gt;month() + 1, gregorianDateTime-&gt;monthDay(), gregorianDateTime-&gt;hour(), gregorianDateTime-&gt;minute(), gregorianDateTime-&gt;second(), ms);
 566     else
 567         charactersWritten = snprintf(buffer, sizeof(buffer), &quot;%04d-%02d-%02dT%02d:%02d:%02d.%03dZ&quot;, gregorianDateTime-&gt;year(), gregorianDateTime-&gt;month() + 1, gregorianDateTime-&gt;monthDay(), gregorianDateTime-&gt;hour(), gregorianDateTime-&gt;minute(), gregorianDateTime-&gt;second(), ms);
 568 
 569     ASSERT(charactersWritten &gt; 0 &amp;&amp; static_cast&lt;unsigned&gt;(charactersWritten) &lt; sizeof(buffer));
 570     if (static_cast&lt;unsigned&gt;(charactersWritten) &gt;= sizeof(buffer))
 571         return JSValue::encode(jsEmptyString(vm));
 572 
 573     return JSValue::encode(jsNontrivialString(vm, String(buffer, charactersWritten)));
 574 }
 575 
<span class="line-modified"> 576 EncodedJSValue JSC_HOST_CALL dateProtoFuncToDateString(ExecState* exec)</span>
 577 {
 578     const bool asUTCVariant = false;
<span class="line-modified"> 579     return formateDateInstance(exec, DateTimeFormatDate, asUTCVariant);</span>
 580 }
 581 
<span class="line-modified"> 582 EncodedJSValue JSC_HOST_CALL dateProtoFuncToTimeString(ExecState* exec)</span>
 583 {
 584     const bool asUTCVariant = false;
<span class="line-modified"> 585     return formateDateInstance(exec, DateTimeFormatTime, asUTCVariant);</span>
 586 }
 587 
<span class="line-modified"> 588 EncodedJSValue JSC_HOST_CALL dateProtoFuncToLocaleString(ExecState* exec)</span>
 589 {
<span class="line-modified"> 590     VM&amp; vm = exec-&gt;vm();</span>
 591     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified"> 592     JSValue thisValue = exec-&gt;thisValue();</span>
 593     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 594     if (UNLIKELY(!thisDateObj))
<span class="line-modified"> 595         return throwVMTypeError(exec, scope);</span>
 596 
<span class="line-modified"> 597     return JSValue::encode(formatLocaleDate(exec, thisDateObj, thisDateObj-&gt;internalNumber(), LocaleDateAndTime));</span>
 598 }
 599 
<span class="line-modified"> 600 EncodedJSValue JSC_HOST_CALL dateProtoFuncToLocaleDateString(ExecState* exec)</span>
 601 {
<span class="line-modified"> 602     VM&amp; vm = exec-&gt;vm();</span>
 603     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified"> 604     JSValue thisValue = exec-&gt;thisValue();</span>
 605     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 606     if (UNLIKELY(!thisDateObj))
<span class="line-modified"> 607         return throwVMTypeError(exec, scope);</span>
 608 
<span class="line-modified"> 609     return JSValue::encode(formatLocaleDate(exec, thisDateObj, thisDateObj-&gt;internalNumber(), LocaleDate));</span>
 610 }
 611 
<span class="line-modified"> 612 EncodedJSValue JSC_HOST_CALL dateProtoFuncToLocaleTimeString(ExecState* exec)</span>
 613 {
<span class="line-modified"> 614     VM&amp; vm = exec-&gt;vm();</span>
 615     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified"> 616     JSValue thisValue = exec-&gt;thisValue();</span>
 617     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 618     if (UNLIKELY(!thisDateObj))
<span class="line-modified"> 619         return throwVMTypeError(exec, scope);</span>
 620 
<span class="line-modified"> 621     return JSValue::encode(formatLocaleDate(exec, thisDateObj, thisDateObj-&gt;internalNumber(), LocaleTime));</span>
 622 }
 623 
<span class="line-modified"> 624 EncodedJSValue JSC_HOST_CALL dateProtoFuncToPrimitiveSymbol(ExecState* exec)</span>
 625 {
<span class="line-modified"> 626     VM&amp; vm = exec-&gt;vm();</span>
 627     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified"> 628     JSValue thisValue = exec-&gt;thisValue();</span>
 629     if (!thisValue.isObject())
<span class="line-modified"> 630         return throwVMTypeError(exec, scope, &quot;Date.prototype[Symbol.toPrimitive] expected |this| to be an object.&quot;);</span>
 631     JSObject* thisObject = jsCast&lt;JSObject*&gt;(thisValue);
 632 
<span class="line-modified"> 633     if (!exec-&gt;argumentCount())</span>
<span class="line-modified"> 634         return throwVMTypeError(exec, scope, &quot;Date.prototype[Symbol.toPrimitive] expected a first argument.&quot;);</span>
 635 
<span class="line-modified"> 636     JSValue hintValue = exec-&gt;uncheckedArgument(0);</span>
<span class="line-modified"> 637     PreferredPrimitiveType type = toPreferredPrimitiveType(exec, hintValue);</span>
 638     RETURN_IF_EXCEPTION(scope, encodedJSValue());
 639 
 640     if (type == NoPreference)
 641         type = PreferString;
 642 
<span class="line-modified"> 643     RELEASE_AND_RETURN(scope, JSValue::encode(thisObject-&gt;ordinaryToPrimitive(exec, type)));</span>
 644 }
 645 
<span class="line-modified"> 646 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetTime(ExecState* exec)</span>
 647 {
<span class="line-modified"> 648     VM&amp; vm = exec-&gt;vm();</span>
 649     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified"> 650     JSValue thisValue = exec-&gt;thisValue();</span>
 651     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 652     if (UNLIKELY(!thisDateObj))
<span class="line-modified"> 653         return throwVMTypeError(exec, scope);</span>
 654 
 655     return JSValue::encode(jsNumber(thisDateObj-&gt;internalNumber()));
 656 }
 657 
<span class="line-modified"> 658 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetFullYear(ExecState* exec)</span>
 659 {
<span class="line-modified"> 660     VM&amp; vm = exec-&gt;vm();</span>
 661     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified"> 662     JSValue thisValue = exec-&gt;thisValue();</span>
 663     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 664     if (UNLIKELY(!thisDateObj))
<span class="line-modified"> 665         return throwVMTypeError(exec, scope);</span>
 666 
<span class="line-modified"> 667     const GregorianDateTime* gregorianDateTime = thisDateObj-&gt;gregorianDateTime(exec);</span>
 668     if (!gregorianDateTime)
 669         return JSValue::encode(jsNaN());
 670     return JSValue::encode(jsNumber(gregorianDateTime-&gt;year()));
 671 }
 672 
<span class="line-modified"> 673 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetUTCFullYear(ExecState* exec)</span>
 674 {
<span class="line-modified"> 675     VM&amp; vm = exec-&gt;vm();</span>
 676     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified"> 677     JSValue thisValue = exec-&gt;thisValue();</span>
 678     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 679     if (UNLIKELY(!thisDateObj))
<span class="line-modified"> 680         return throwVMTypeError(exec, scope);</span>
 681 
<span class="line-modified"> 682     const GregorianDateTime* gregorianDateTime = thisDateObj-&gt;gregorianDateTimeUTC(exec);</span>
 683     if (!gregorianDateTime)
 684         return JSValue::encode(jsNaN());
 685     return JSValue::encode(jsNumber(gregorianDateTime-&gt;year()));
 686 }
 687 
<span class="line-modified"> 688 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetMonth(ExecState* exec)</span>
 689 {
<span class="line-modified"> 690     VM&amp; vm = exec-&gt;vm();</span>
 691     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified"> 692     JSValue thisValue = exec-&gt;thisValue();</span>
 693     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 694     if (UNLIKELY(!thisDateObj))
<span class="line-modified"> 695         return throwVMTypeError(exec, scope);</span>
 696 
<span class="line-modified"> 697     const GregorianDateTime* gregorianDateTime = thisDateObj-&gt;gregorianDateTime(exec);</span>
 698     if (!gregorianDateTime)
 699         return JSValue::encode(jsNaN());
 700     return JSValue::encode(jsNumber(gregorianDateTime-&gt;month()));
 701 }
 702 
<span class="line-modified"> 703 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetUTCMonth(ExecState* exec)</span>
 704 {
<span class="line-modified"> 705     VM&amp; vm = exec-&gt;vm();</span>
 706     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified"> 707     JSValue thisValue = exec-&gt;thisValue();</span>
 708     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 709     if (UNLIKELY(!thisDateObj))
<span class="line-modified"> 710         return throwVMTypeError(exec, scope);</span>
 711 
<span class="line-modified"> 712     const GregorianDateTime* gregorianDateTime = thisDateObj-&gt;gregorianDateTimeUTC(exec);</span>
 713     if (!gregorianDateTime)
 714         return JSValue::encode(jsNaN());
 715     return JSValue::encode(jsNumber(gregorianDateTime-&gt;month()));
 716 }
 717 
<span class="line-modified"> 718 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetDate(ExecState* exec)</span>
 719 {
<span class="line-modified"> 720     VM&amp; vm = exec-&gt;vm();</span>
 721     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified"> 722     JSValue thisValue = exec-&gt;thisValue();</span>
 723     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 724     if (UNLIKELY(!thisDateObj))
<span class="line-modified"> 725         return throwVMTypeError(exec, scope);</span>
 726 
<span class="line-modified"> 727     const GregorianDateTime* gregorianDateTime = thisDateObj-&gt;gregorianDateTime(exec);</span>
 728     if (!gregorianDateTime)
 729         return JSValue::encode(jsNaN());
 730     return JSValue::encode(jsNumber(gregorianDateTime-&gt;monthDay()));
 731 }
 732 
<span class="line-modified"> 733 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetUTCDate(ExecState* exec)</span>
 734 {
<span class="line-modified"> 735     VM&amp; vm = exec-&gt;vm();</span>
 736     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified"> 737     JSValue thisValue = exec-&gt;thisValue();</span>
 738     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 739     if (UNLIKELY(!thisDateObj))
<span class="line-modified"> 740         return throwVMTypeError(exec, scope);</span>
 741 
<span class="line-modified"> 742     const GregorianDateTime* gregorianDateTime = thisDateObj-&gt;gregorianDateTimeUTC(exec);</span>
 743     if (!gregorianDateTime)
 744         return JSValue::encode(jsNaN());
 745     return JSValue::encode(jsNumber(gregorianDateTime-&gt;monthDay()));
 746 }
 747 
<span class="line-modified"> 748 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetDay(ExecState* exec)</span>
 749 {
<span class="line-modified"> 750     VM&amp; vm = exec-&gt;vm();</span>
 751     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified"> 752     JSValue thisValue = exec-&gt;thisValue();</span>
 753     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 754     if (UNLIKELY(!thisDateObj))
<span class="line-modified"> 755         return throwVMTypeError(exec, scope);</span>
 756 
<span class="line-modified"> 757     const GregorianDateTime* gregorianDateTime = thisDateObj-&gt;gregorianDateTime(exec);</span>
 758     if (!gregorianDateTime)
 759         return JSValue::encode(jsNaN());
 760     return JSValue::encode(jsNumber(gregorianDateTime-&gt;weekDay()));
 761 }
 762 
<span class="line-modified"> 763 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetUTCDay(ExecState* exec)</span>
 764 {
<span class="line-modified"> 765     VM&amp; vm = exec-&gt;vm();</span>
 766     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified"> 767     JSValue thisValue = exec-&gt;thisValue();</span>
 768     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 769     if (UNLIKELY(!thisDateObj))
<span class="line-modified"> 770         return throwVMTypeError(exec, scope);</span>
 771 
<span class="line-modified"> 772     const GregorianDateTime* gregorianDateTime = thisDateObj-&gt;gregorianDateTimeUTC(exec);</span>
 773     if (!gregorianDateTime)
 774         return JSValue::encode(jsNaN());
 775     return JSValue::encode(jsNumber(gregorianDateTime-&gt;weekDay()));
 776 }
 777 
<span class="line-modified"> 778 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetHours(ExecState* exec)</span>
 779 {
<span class="line-modified"> 780     VM&amp; vm = exec-&gt;vm();</span>
 781     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified"> 782     JSValue thisValue = exec-&gt;thisValue();</span>
 783     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 784     if (UNLIKELY(!thisDateObj))
<span class="line-modified"> 785         return throwVMTypeError(exec, scope);</span>
 786 
<span class="line-modified"> 787     const GregorianDateTime* gregorianDateTime = thisDateObj-&gt;gregorianDateTime(exec);</span>
 788     if (!gregorianDateTime)
 789         return JSValue::encode(jsNaN());
 790     return JSValue::encode(jsNumber(gregorianDateTime-&gt;hour()));
 791 }
 792 
<span class="line-modified"> 793 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetUTCHours(ExecState* exec)</span>
 794 {
<span class="line-modified"> 795     VM&amp; vm = exec-&gt;vm();</span>
 796     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified"> 797     JSValue thisValue = exec-&gt;thisValue();</span>
 798     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 799     if (UNLIKELY(!thisDateObj))
<span class="line-modified"> 800         return throwVMTypeError(exec, scope);</span>
 801 
<span class="line-modified"> 802     const GregorianDateTime* gregorianDateTime = thisDateObj-&gt;gregorianDateTimeUTC(exec);</span>
 803     if (!gregorianDateTime)
 804         return JSValue::encode(jsNaN());
 805     return JSValue::encode(jsNumber(gregorianDateTime-&gt;hour()));
 806 }
 807 
<span class="line-modified"> 808 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetMinutes(ExecState* exec)</span>
 809 {
<span class="line-modified"> 810     VM&amp; vm = exec-&gt;vm();</span>
 811     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified"> 812     JSValue thisValue = exec-&gt;thisValue();</span>
 813     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 814     if (UNLIKELY(!thisDateObj))
<span class="line-modified"> 815         return throwVMTypeError(exec, scope);</span>
 816 
<span class="line-modified"> 817     const GregorianDateTime* gregorianDateTime = thisDateObj-&gt;gregorianDateTime(exec);</span>
 818     if (!gregorianDateTime)
 819         return JSValue::encode(jsNaN());
 820     return JSValue::encode(jsNumber(gregorianDateTime-&gt;minute()));
 821 }
 822 
<span class="line-modified"> 823 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetUTCMinutes(ExecState* exec)</span>
 824 {
<span class="line-modified"> 825     VM&amp; vm = exec-&gt;vm();</span>
 826     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified"> 827     JSValue thisValue = exec-&gt;thisValue();</span>
 828     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 829     if (UNLIKELY(!thisDateObj))
<span class="line-modified"> 830         return throwVMTypeError(exec, scope);</span>
 831 
<span class="line-modified"> 832     const GregorianDateTime* gregorianDateTime = thisDateObj-&gt;gregorianDateTimeUTC(exec);</span>
 833     if (!gregorianDateTime)
 834         return JSValue::encode(jsNaN());
 835     return JSValue::encode(jsNumber(gregorianDateTime-&gt;minute()));
 836 }
 837 
<span class="line-modified"> 838 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetSeconds(ExecState* exec)</span>
 839 {
<span class="line-modified"> 840     VM&amp; vm = exec-&gt;vm();</span>
 841     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified"> 842     JSValue thisValue = exec-&gt;thisValue();</span>
 843     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 844     if (UNLIKELY(!thisDateObj))
<span class="line-modified"> 845         return throwVMTypeError(exec, scope);</span>
 846 
<span class="line-modified"> 847     const GregorianDateTime* gregorianDateTime = thisDateObj-&gt;gregorianDateTime(exec);</span>
 848     if (!gregorianDateTime)
 849         return JSValue::encode(jsNaN());
 850     return JSValue::encode(jsNumber(gregorianDateTime-&gt;second()));
 851 }
 852 
<span class="line-modified"> 853 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetUTCSeconds(ExecState* exec)</span>
 854 {
<span class="line-modified"> 855     VM&amp; vm = exec-&gt;vm();</span>
 856     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified"> 857     JSValue thisValue = exec-&gt;thisValue();</span>
 858     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 859     if (UNLIKELY(!thisDateObj))
<span class="line-modified"> 860         return throwVMTypeError(exec, scope);</span>
 861 
<span class="line-modified"> 862     const GregorianDateTime* gregorianDateTime = thisDateObj-&gt;gregorianDateTimeUTC(exec);</span>
 863     if (!gregorianDateTime)
 864         return JSValue::encode(jsNaN());
 865     return JSValue::encode(jsNumber(gregorianDateTime-&gt;second()));
 866 }
 867 
<span class="line-modified"> 868 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetMilliSeconds(ExecState* exec)</span>
 869 {
<span class="line-modified"> 870     VM&amp; vm = exec-&gt;vm();</span>
 871     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified"> 872     JSValue thisValue = exec-&gt;thisValue();</span>
 873     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 874     if (UNLIKELY(!thisDateObj))
<span class="line-modified"> 875         return throwVMTypeError(exec, scope);</span>
 876 
 877     double milli = thisDateObj-&gt;internalNumber();
 878     if (std::isnan(milli))
 879         return JSValue::encode(jsNaN());
 880 
 881     double secs = floor(milli / msPerSecond);
 882     double ms = milli - secs * msPerSecond;
<span class="line-modified"> 883     return JSValue::encode(jsNumber(ms));</span>

 884 }
 885 
<span class="line-modified"> 886 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetUTCMilliseconds(ExecState* exec)</span>
 887 {
<span class="line-modified"> 888     VM&amp; vm = exec-&gt;vm();</span>
 889     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified"> 890     JSValue thisValue = exec-&gt;thisValue();</span>
 891     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 892     if (UNLIKELY(!thisDateObj))
<span class="line-modified"> 893         return throwVMTypeError(exec, scope);</span>
 894 
 895     double milli = thisDateObj-&gt;internalNumber();
 896     if (std::isnan(milli))
 897         return JSValue::encode(jsNaN());
 898 
 899     double secs = floor(milli / msPerSecond);
 900     double ms = milli - secs * msPerSecond;
<span class="line-modified"> 901     return JSValue::encode(jsNumber(ms));</span>

 902 }
 903 
<span class="line-modified"> 904 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetTimezoneOffset(ExecState* exec)</span>
 905 {
<span class="line-modified"> 906     VM&amp; vm = exec-&gt;vm();</span>
 907     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified"> 908     JSValue thisValue = exec-&gt;thisValue();</span>
 909     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 910     if (UNLIKELY(!thisDateObj))
<span class="line-modified"> 911         return throwVMTypeError(exec, scope);</span>
 912 
<span class="line-modified"> 913     const GregorianDateTime* gregorianDateTime = thisDateObj-&gt;gregorianDateTime(exec);</span>
 914     if (!gregorianDateTime)
 915         return JSValue::encode(jsNaN());
<span class="line-modified"> 916     return JSValue::encode(jsNumber(-gregorianDateTime-&gt;utcOffset() / minutesPerHour));</span>
 917 }
 918 
<span class="line-modified"> 919 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetTime(ExecState* exec)</span>
 920 {
<span class="line-modified"> 921     VM&amp; vm = exec-&gt;vm();</span>
 922     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified"> 923     JSValue thisValue = exec-&gt;thisValue();</span>
 924     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 925     if (UNLIKELY(!thisDateObj))
<span class="line-modified"> 926         return throwVMTypeError(exec, scope);</span>
 927 
<span class="line-modified"> 928     double milli = timeClip(exec-&gt;argument(0).toNumber(exec));</span>
 929     RETURN_IF_EXCEPTION(scope, encodedJSValue());
 930     thisDateObj-&gt;setInternalNumber(milli);
 931     return JSValue::encode(jsNumber(milli));
 932 }
 933 
<span class="line-modified"> 934 static EncodedJSValue setNewValueFromTimeArgs(ExecState* exec, int numArgsToUse, WTF::TimeType inputTimeType)</span>
 935 {
<span class="line-modified"> 936     VM&amp; vm = exec-&gt;vm();</span>
 937     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified"> 938     JSValue thisValue = exec-&gt;thisValue();</span>
 939     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 940     if (UNLIKELY(!thisDateObj))
<span class="line-modified"> 941         return throwVMTypeError(exec, scope);</span>
 942 
 943     double milli = thisDateObj-&gt;internalNumber();
 944 
<span class="line-modified"> 945     if (!exec-&gt;argumentCount() || std::isnan(milli)) {</span>
 946         thisDateObj-&gt;setInternalNumber(PNaN);
 947         return JSValue::encode(jsNaN());
 948     }
 949 
 950     double secs = floor(milli / msPerSecond);
 951     double ms = milli - secs * msPerSecond;
 952 
 953     const GregorianDateTime* other = inputTimeType == WTF::UTCTime
<span class="line-modified"> 954         ? thisDateObj-&gt;gregorianDateTimeUTC(exec)</span>
<span class="line-modified"> 955         : thisDateObj-&gt;gregorianDateTime(exec);</span>
 956     if (!other)
 957         return JSValue::encode(jsNaN());
 958 
<span class="line-modified"> 959     GregorianDateTime gregorianDateTime;</span>
<span class="line-modified"> 960     gregorianDateTime.copyFrom(*other);</span>
<span class="line-removed"> 961     bool success = fillStructuresUsingTimeArgs(exec, numArgsToUse, &amp;ms, &amp;gregorianDateTime);</span>
 962     RETURN_IF_EXCEPTION(scope, encodedJSValue());
 963     if (!success) {
 964         thisDateObj-&gt;setInternalNumber(PNaN);
 965         return JSValue::encode(jsNaN());
 966     }
 967 
 968     double newUTCDate = gregorianDateTimeToMS(vm, gregorianDateTime, ms, inputTimeType);
 969     double result = timeClip(newUTCDate);
 970     thisDateObj-&gt;setInternalNumber(result);
 971     return JSValue::encode(jsNumber(result));
 972 }
 973 
<span class="line-modified"> 974 static EncodedJSValue setNewValueFromDateArgs(ExecState* exec, int numArgsToUse, WTF::TimeType inputTimeType)</span>
 975 {
<span class="line-modified"> 976     VM&amp; vm = exec-&gt;vm();</span>
 977     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified"> 978     JSValue thisValue = exec-&gt;thisValue();</span>
 979     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 980     if (UNLIKELY(!thisDateObj))
<span class="line-modified"> 981         return throwVMTypeError(exec, scope);</span>
 982 
<span class="line-modified"> 983     if (!exec-&gt;argumentCount()) {</span>
 984         thisDateObj-&gt;setInternalNumber(PNaN);
 985         return JSValue::encode(jsNaN());
 986     }
 987 
 988     double milli = thisDateObj-&gt;internalNumber();
 989     double ms = 0;
 990 
 991     GregorianDateTime gregorianDateTime;
 992     if (numArgsToUse == 3 &amp;&amp; std::isnan(milli))
 993         msToGregorianDateTime(vm, 0, WTF::UTCTime, gregorianDateTime);
 994     else {
 995         ms = milli - floor(milli / msPerSecond) * msPerSecond;
 996         const GregorianDateTime* other = inputTimeType == WTF::UTCTime
<span class="line-modified"> 997             ? thisDateObj-&gt;gregorianDateTimeUTC(exec)</span>
<span class="line-modified"> 998             : thisDateObj-&gt;gregorianDateTime(exec);</span>
 999         if (!other)
1000             return JSValue::encode(jsNaN());
<span class="line-modified">1001         gregorianDateTime.copyFrom(*other);</span>
1002     }
1003 
<span class="line-modified">1004     bool success = fillStructuresUsingDateArgs(exec, numArgsToUse, &amp;ms, &amp;gregorianDateTime);</span>
1005     RETURN_IF_EXCEPTION(scope, encodedJSValue());
1006     if (!success) {
1007         thisDateObj-&gt;setInternalNumber(PNaN);
1008         return JSValue::encode(jsNaN());
1009     }
1010 
1011     double newUTCDate = gregorianDateTimeToMS(vm, gregorianDateTime, ms, inputTimeType);
1012     double result = timeClip(newUTCDate);
1013     thisDateObj-&gt;setInternalNumber(result);
1014     return JSValue::encode(jsNumber(result));
1015 }
1016 
<span class="line-modified">1017 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetMilliSeconds(ExecState* exec)</span>
1018 {
<span class="line-modified">1019     return setNewValueFromTimeArgs(exec, 1, WTF::LocalTime);</span>
1020 }
1021 
<span class="line-modified">1022 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetUTCMilliseconds(ExecState* exec)</span>
1023 {
<span class="line-modified">1024     return setNewValueFromTimeArgs(exec, 1, WTF::UTCTime);</span>
1025 }
1026 
<span class="line-modified">1027 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetSeconds(ExecState* exec)</span>
1028 {
<span class="line-modified">1029     return setNewValueFromTimeArgs(exec, 2, WTF::LocalTime);</span>
1030 }
1031 
<span class="line-modified">1032 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetUTCSeconds(ExecState* exec)</span>
1033 {
<span class="line-modified">1034     return setNewValueFromTimeArgs(exec, 2, WTF::UTCTime);</span>
1035 }
1036 
<span class="line-modified">1037 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetMinutes(ExecState* exec)</span>
1038 {
<span class="line-modified">1039     return setNewValueFromTimeArgs(exec, 3, WTF::LocalTime);</span>
1040 }
1041 
<span class="line-modified">1042 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetUTCMinutes(ExecState* exec)</span>
1043 {
<span class="line-modified">1044     return setNewValueFromTimeArgs(exec, 3, WTF::UTCTime);</span>
1045 }
1046 
<span class="line-modified">1047 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetHours(ExecState* exec)</span>
1048 {
<span class="line-modified">1049     return setNewValueFromTimeArgs(exec, 4, WTF::LocalTime);</span>
1050 }
1051 
<span class="line-modified">1052 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetUTCHours(ExecState* exec)</span>
1053 {
<span class="line-modified">1054     return setNewValueFromTimeArgs(exec, 4, WTF::UTCTime);</span>
1055 }
1056 
<span class="line-modified">1057 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetDate(ExecState* exec)</span>
1058 {
<span class="line-modified">1059     return setNewValueFromDateArgs(exec, 1, WTF::LocalTime);</span>
1060 }
1061 
<span class="line-modified">1062 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetUTCDate(ExecState* exec)</span>
1063 {
<span class="line-modified">1064     return setNewValueFromDateArgs(exec, 1, WTF::UTCTime);</span>
1065 }
1066 
<span class="line-modified">1067 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetMonth(ExecState* exec)</span>
1068 {
<span class="line-modified">1069     return setNewValueFromDateArgs(exec, 2, WTF::LocalTime);</span>
1070 }
1071 
<span class="line-modified">1072 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetUTCMonth(ExecState* exec)</span>
1073 {
<span class="line-modified">1074     return setNewValueFromDateArgs(exec, 2, WTF::UTCTime);</span>
1075 }
1076 
<span class="line-modified">1077 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetFullYear(ExecState* exec)</span>
1078 {
<span class="line-modified">1079     return setNewValueFromDateArgs(exec, 3, WTF::LocalTime);</span>
1080 }
1081 
<span class="line-modified">1082 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetUTCFullYear(ExecState* exec)</span>
1083 {
<span class="line-modified">1084     return setNewValueFromDateArgs(exec, 3, WTF::UTCTime);</span>
1085 }
1086 
<span class="line-modified">1087 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetYear(ExecState* exec)</span>
1088 {
<span class="line-modified">1089     VM&amp; vm = exec-&gt;vm();</span>
1090     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified">1091     JSValue thisValue = exec-&gt;thisValue();</span>
1092     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
1093     if (UNLIKELY(!thisDateObj))
<span class="line-modified">1094         return throwVMTypeError(exec, scope);</span>
1095 
<span class="line-modified">1096     if (!exec-&gt;argumentCount()) {</span>
1097         thisDateObj-&gt;setInternalNumber(PNaN);
1098         return JSValue::encode(jsNaN());
1099     }
1100 
1101     double milli = thisDateObj-&gt;internalNumber();
1102     double ms = 0;
1103 
1104     GregorianDateTime gregorianDateTime;
1105     if (std::isnan(milli))
1106         // Based on ECMA 262 B.2.5 (setYear)
1107         // the time must be reset to +0 if it is NaN.
1108         msToGregorianDateTime(vm, 0, WTF::UTCTime, gregorianDateTime);
1109     else {
1110         double secs = floor(milli / msPerSecond);
1111         ms = milli - secs * msPerSecond;
<span class="line-modified">1112         if (const GregorianDateTime* other = thisDateObj-&gt;gregorianDateTime(exec))</span>
<span class="line-modified">1113             gregorianDateTime.copyFrom(*other);</span>
1114     }
1115 
<span class="line-modified">1116     double year = exec-&gt;argument(0).toIntegerPreserveNaN(exec);</span>
1117     RETURN_IF_EXCEPTION(scope, encodedJSValue());
1118     if (!std::isfinite(year)) {
1119         thisDateObj-&gt;setInternalNumber(PNaN);
1120         return JSValue::encode(jsNaN());
1121     }
1122 
1123     gregorianDateTime.setYear(toInt32((year &gt;= 0 &amp;&amp; year &lt;= 99) ? (year + 1900) : year));
1124     double timeInMilliseconds = gregorianDateTimeToMS(vm, gregorianDateTime, ms, WTF::LocalTime);
1125     double result = timeClip(timeInMilliseconds);
1126     thisDateObj-&gt;setInternalNumber(result);
1127     return JSValue::encode(jsNumber(result));
1128 }
1129 
<span class="line-modified">1130 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetYear(ExecState* exec)</span>
1131 {
<span class="line-modified">1132     VM&amp; vm = exec-&gt;vm();</span>
1133     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified">1134     JSValue thisValue = exec-&gt;thisValue();</span>
1135     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
1136     if (UNLIKELY(!thisDateObj))
<span class="line-modified">1137         return throwVMTypeError(exec, scope);</span>
1138 
<span class="line-modified">1139     const GregorianDateTime* gregorianDateTime = thisDateObj-&gt;gregorianDateTime(exec);</span>
1140     if (!gregorianDateTime)
1141         return JSValue::encode(jsNaN());
1142 
1143     // NOTE: IE returns the full year even in getYear.
1144     return JSValue::encode(jsNumber(gregorianDateTime-&gt;year() - 1900));
1145 }
1146 
<span class="line-modified">1147 EncodedJSValue JSC_HOST_CALL dateProtoFuncToJSON(ExecState* exec)</span>
1148 {
<span class="line-modified">1149     VM&amp; vm = exec-&gt;vm();</span>
1150     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified">1151     JSValue thisValue = exec-&gt;thisValue();</span>
<span class="line-modified">1152     JSObject* object = jsCast&lt;JSObject*&gt;(thisValue.toThis(exec, NotStrictMode));</span>
1153     RETURN_IF_EXCEPTION(scope, encodedJSValue());
1154 
<span class="line-modified">1155     JSValue timeValue = object-&gt;toPrimitive(exec, PreferNumber);</span>
1156     RETURN_IF_EXCEPTION(scope, encodedJSValue());
<span class="line-modified">1157     if (timeValue.isNumber() &amp;&amp; !(timeValue.isInt32() || std::isfinite(timeValue.asDouble())))</span>
1158         return JSValue::encode(jsNull());
1159 
<span class="line-modified">1160     JSValue toISOValue = object-&gt;get(exec, vm.propertyNames-&gt;toISOString);</span>
1161     RETURN_IF_EXCEPTION(scope, encodedJSValue());
1162 
1163     CallData callData;
1164     CallType callType = getCallData(vm, toISOValue, callData);
1165     if (callType == CallType::None)
<span class="line-modified">1166         return throwVMTypeError(exec, scope, &quot;toISOString is not a function&quot;_s);</span>
1167 
<span class="line-modified">1168     JSValue result = call(exec, asObject(toISOValue), callType, callData, object, *vm.emptyList);</span>
1169     RETURN_IF_EXCEPTION(scope, encodedJSValue());
1170     return JSValue::encode(result);
1171 }
1172 
1173 } // namespace JSC
</pre>
</td>
<td>
<hr />
<pre>
  52 #endif
  53 
  54 #if HAVE(SYS_TIME_H)
  55 #include &lt;sys/time.h&gt;
  56 #endif
  57 
  58 #if HAVE(SYS_TIMEB_H)
  59 #include &lt;sys/timeb.h&gt;
  60 #endif
  61 
  62 #if !(OS(DARWIN) &amp;&amp; USE(CF))
  63 #include &lt;unicode/udat.h&gt;
  64 #endif
  65 
  66 #if USE(CF)
  67 #include &lt;CoreFoundation/CoreFoundation.h&gt;
  68 #endif
  69 
  70 namespace JSC {
  71 
<span class="line-modified">  72 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetDate(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">  73 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetDay(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">  74 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetFullYear(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">  75 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetHours(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">  76 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetMilliSeconds(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">  77 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetMinutes(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">  78 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetMonth(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">  79 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetSeconds(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">  80 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetTimezoneOffset(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">  81 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetUTCDate(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">  82 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetUTCDay(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">  83 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetUTCFullYear(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">  84 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetUTCHours(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">  85 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetUTCMilliseconds(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">  86 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetUTCMinutes(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">  87 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetUTCMonth(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">  88 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetUTCSeconds(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">  89 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetYear(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">  90 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetDate(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">  91 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetFullYear(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">  92 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetHours(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">  93 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetMilliSeconds(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">  94 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetMinutes(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">  95 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetMonth(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">  96 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetSeconds(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">  97 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetTime(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">  98 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetUTCDate(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">  99 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetUTCFullYear(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified"> 100 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetUTCHours(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified"> 101 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetUTCMilliseconds(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified"> 102 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetUTCMinutes(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified"> 103 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetUTCMonth(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified"> 104 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetUTCSeconds(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified"> 105 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetYear(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified"> 106 EncodedJSValue JSC_HOST_CALL dateProtoFuncToDateString(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified"> 107 EncodedJSValue JSC_HOST_CALL dateProtoFuncToLocaleDateString(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified"> 108 EncodedJSValue JSC_HOST_CALL dateProtoFuncToLocaleString(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified"> 109 EncodedJSValue JSC_HOST_CALL dateProtoFuncToLocaleTimeString(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified"> 110 EncodedJSValue JSC_HOST_CALL dateProtoFuncToPrimitiveSymbol(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified"> 111 EncodedJSValue JSC_HOST_CALL dateProtoFuncToString(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified"> 112 EncodedJSValue JSC_HOST_CALL dateProtoFuncToTimeString(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified"> 113 EncodedJSValue JSC_HOST_CALL dateProtoFuncToUTCString(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified"> 114 EncodedJSValue JSC_HOST_CALL dateProtoFuncToISOString(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified"> 115 EncodedJSValue JSC_HOST_CALL dateProtoFuncToJSON(JSGlobalObject*, CallFrame*);</span>


 116 
 117 }
 118 
 119 #include &quot;DatePrototype.lut.h&quot;
 120 
 121 namespace JSC {
 122 
 123 enum LocaleDateTimeFormat { LocaleDateAndTime, LocaleDate, LocaleTime };
 124 
 125 #if OS(DARWIN) &amp;&amp; USE(CF)
 126 
 127 // FIXME: Since this is superior to the strftime-based version, why limit this to OS(DARWIN)?
 128 // Instead we should consider using this whenever USE(CF) is true.
 129 
 130 static CFDateFormatterStyle styleFromArgString(const String&amp; string, CFDateFormatterStyle defaultStyle)
 131 {
 132     if (string == &quot;short&quot;)
 133         return kCFDateFormatterShortStyle;
 134     if (string == &quot;medium&quot;)
 135         return kCFDateFormatterMediumStyle;
 136     if (string == &quot;long&quot;)
 137         return kCFDateFormatterLongStyle;
 138     if (string == &quot;full&quot;)
 139         return kCFDateFormatterFullStyle;
 140     return defaultStyle;
 141 }
 142 
<span class="line-modified"> 143 static JSCell* formatLocaleDate(JSGlobalObject* globalObject, CallFrame* callFrame, DateInstance*, double timeInMilliseconds, LocaleDateTimeFormat format)</span>
 144 {
<span class="line-modified"> 145     VM&amp; vm = globalObject-&gt;vm();</span>
 146     CFDateFormatterStyle dateStyle = (format != LocaleTime ? kCFDateFormatterLongStyle : kCFDateFormatterNoStyle);
 147     CFDateFormatterStyle timeStyle = (format != LocaleDate ? kCFDateFormatterLongStyle : kCFDateFormatterNoStyle);
 148 
 149     bool useCustomFormat = false;
 150     String customFormatString;
 151 
<span class="line-modified"> 152     String arg0String = callFrame-&gt;argument(0).toWTFString(globalObject);</span>
<span class="line-modified"> 153     if (arg0String == &quot;custom&quot; &amp;&amp; !callFrame-&gt;argument(1).isUndefined()) {</span>
 154         useCustomFormat = true;
<span class="line-modified"> 155         customFormatString = callFrame-&gt;argument(1).toWTFString(globalObject);</span>
<span class="line-modified"> 156     } else if (format == LocaleDateAndTime &amp;&amp; !callFrame-&gt;argument(1).isUndefined()) {</span>
 157         dateStyle = styleFromArgString(arg0String, dateStyle);
<span class="line-modified"> 158         timeStyle = styleFromArgString(callFrame-&gt;argument(1).toWTFString(globalObject), timeStyle);</span>
<span class="line-modified"> 159     } else if (format != LocaleTime &amp;&amp; !callFrame-&gt;argument(0).isUndefined())</span>
 160         dateStyle = styleFromArgString(arg0String, dateStyle);
<span class="line-modified"> 161     else if (format != LocaleDate &amp;&amp; !callFrame-&gt;argument(0).isUndefined())</span>
 162         timeStyle = styleFromArgString(arg0String, timeStyle);
 163 
 164     CFAbsoluteTime absoluteTime = floor(timeInMilliseconds / msPerSecond) - kCFAbsoluteTimeIntervalSince1970;
 165 
 166     auto formatter = adoptCF(CFDateFormatterCreate(kCFAllocatorDefault, adoptCF(CFLocaleCopyCurrent()).get(), dateStyle, timeStyle));
 167     if (useCustomFormat)
 168         CFDateFormatterSetFormat(formatter.get(), customFormatString.createCFString().get());
 169     return jsNontrivialString(vm, adoptCF(CFDateFormatterCreateStringWithAbsoluteTime(kCFAllocatorDefault, formatter.get(), absoluteTime)).get());
 170 }
 171 
 172 #elif !UCONFIG_NO_FORMATTING
 173 
<span class="line-modified"> 174 static JSCell* formatLocaleDate(JSGlobalObject* globalObject, CallFrame*, DateInstance*, double timeInMilliseconds, LocaleDateTimeFormat format)</span>
 175 {
<span class="line-modified"> 176     VM&amp; vm = globalObject-&gt;vm();</span>
 177     UDateFormatStyle timeStyle = (format != LocaleDate ? UDAT_LONG : UDAT_NONE);
 178     UDateFormatStyle dateStyle = (format != LocaleTime ? UDAT_LONG : UDAT_NONE);
 179 
 180     UErrorCode status = U_ZERO_ERROR;
 181     UDateFormat* df = udat_open(timeStyle, dateStyle, 0, 0, -1, 0, 0, &amp;status);
 182     if (!df)
 183         return jsEmptyString(vm);
 184 
 185     UChar buffer[128];
 186     int32_t length;
 187     length = udat_format(df, timeInMilliseconds, buffer, 128, 0, &amp;status);
 188     udat_close(df);
 189     if (status != U_ZERO_ERROR)
 190         return jsEmptyString(vm);
 191 
 192     return jsNontrivialString(vm, String(buffer, length));
 193 }
 194 
 195 #else
 196 
<span class="line-modified"> 197 static JSCell* formatLocaleDate(JSGlobalObject* globalObject, CallFrame* callFrame, const GregorianDateTime&amp; gdt, LocaleDateTimeFormat format)</span>
 198 {
<span class="line-modified"> 199     VM&amp; vm = globalObject-&gt;vm();</span>
 200 #if OS(WINDOWS)
 201     SYSTEMTIME systemTime;
 202     memset(&amp;systemTime, 0, sizeof(systemTime));
 203     systemTime.wYear = gdt.year();
 204     systemTime.wMonth = gdt.month() + 1;
 205     systemTime.wDay = gdt.monthDay();
 206     systemTime.wDayOfWeek = gdt.weekDay();
 207     systemTime.wHour = gdt.hour();
 208     systemTime.wMinute = gdt.minute();
 209     systemTime.wSecond = gdt.second();
 210 
 211     Vector&lt;UChar, 128&gt; buffer;
 212     size_t length = 0;
 213 
 214     if (format == LocaleDate) {
 215         buffer.resize(GetDateFormatW(LOCALE_USER_DEFAULT, DATE_LONGDATE, &amp;systemTime, 0, 0, 0));
 216         length = GetDateFormatW(LOCALE_USER_DEFAULT, DATE_LONGDATE, &amp;systemTime, 0, buffer.data(), buffer.size());
 217     } else if (format == LocaleTime) {
 218         buffer.resize(GetTimeFormatW(LOCALE_USER_DEFAULT, 0, &amp;systemTime, 0, 0, 0));
 219         length = GetTimeFormatW(LOCALE_USER_DEFAULT, 0, &amp;systemTime, 0, buffer.data(), buffer.size());
</pre>
<hr />
<pre>
 291     // and wide character represents UTF-32 code point.
 292     // Here we static_cast potential UTF-32 to UTF-16, it should be
 293     // safe because date and (or) time related characters in different languages
 294     // should be in UNICODE BMP. If mbstowcs fails, we just fall
 295     // back on using multi-byte result as-is.
 296 #ifdef __STDC_ISO_10646__
 297     UChar buffer[bufsize];
 298     wchar_t tempbuffer[bufsize];
 299     size_t length = mbstowcs(tempbuffer, timebuffer, bufsize - 1);
 300     if (length != static_cast&lt;size_t&gt;(-1)) {
 301         for (size_t i = 0; i &lt; length; ++i)
 302             buffer[i] = static_cast&lt;UChar&gt;(tempbuffer[i]);
 303         return jsNontrivialString(vm, String(buffer, length));
 304     }
 305 #endif
 306 
 307     return jsNontrivialString(vm, timebuffer);
 308 #endif // OS(WINDOWS)
 309 }
 310 
<span class="line-modified"> 311 static JSCell* formatLocaleDate(JSGlobalObject* globalObject, CallFrame* callFrame, DateInstance* dateObject, double, LocaleDateTimeFormat format)</span>
 312 {
<span class="line-modified"> 313     VM&amp; vm = globalObject-&gt;vm();</span>
<span class="line-modified"> 314     const GregorianDateTime* gregorianDateTime = dateObject-&gt;gregorianDateTime(vm);</span>
 315     if (!gregorianDateTime)
 316         return jsNontrivialString(vm, &quot;Invalid Date&quot;_s);
<span class="line-modified"> 317     return formatLocaleDate(globalObject, callFrame, *gregorianDateTime, format);</span>
 318 }
 319 
 320 #endif // OS(DARWIN) &amp;&amp; USE(CF)
 321 
<span class="line-modified"> 322 static EncodedJSValue formateDateInstance(JSGlobalObject* globalObject, CallFrame* callFrame, DateTimeFormat format, bool asUTCVariant)</span>
 323 {
<span class="line-modified"> 324     VM&amp; vm = globalObject-&gt;vm();</span>
 325     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified"> 326     JSValue thisValue = callFrame-&gt;thisValue();</span>
 327     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 328     if (UNLIKELY(!thisDateObj))
<span class="line-modified"> 329         return throwVMTypeError(globalObject, scope);</span>
 330 
 331     const GregorianDateTime* gregorianDateTime = asUTCVariant
<span class="line-modified"> 332         ? thisDateObj-&gt;gregorianDateTimeUTC(vm)</span>
<span class="line-modified"> 333         : thisDateObj-&gt;gregorianDateTime(vm);</span>
 334     if (!gregorianDateTime)
 335         return JSValue::encode(jsNontrivialString(vm, String(&quot;Invalid Date&quot;_s)));
 336 
 337     return JSValue::encode(jsNontrivialString(vm, formatDateTime(*gregorianDateTime, format, asUTCVariant)));
 338 }
 339 
 340 // Converts a list of arguments sent to a Date member function into milliseconds, updating
 341 // ms (representing milliseconds) and t (representing the rest of the date structure) appropriately.
 342 //
 343 // Format of member function: f([hour,] [min,] [sec,] [ms])
<span class="line-modified"> 344 static bool fillStructuresUsingTimeArgs(JSGlobalObject* globalObject, CallFrame* callFrame, int maxArgs, double* ms, GregorianDateTime* t)</span>
 345 {
<span class="line-modified"> 346     VM&amp; vm = globalObject-&gt;vm();</span>
 347     auto scope = DECLARE_THROW_SCOPE(vm);
 348 
 349     double milliseconds = 0;
 350     bool ok = true;
 351     int idx = 0;
<span class="line-modified"> 352     int numArgs = callFrame-&gt;argumentCount();</span>
 353 
 354     // JS allows extra trailing arguments -- ignore them
 355     if (numArgs &gt; maxArgs)
 356         numArgs = maxArgs;
 357 
 358     // hours
 359     if (maxArgs &gt;= 4 &amp;&amp; idx &lt; numArgs) {
 360         t-&gt;setHour(0);
<span class="line-modified"> 361         double hours = callFrame-&gt;uncheckedArgument(idx++).toIntegerPreserveNaN(globalObject);</span>
 362         RETURN_IF_EXCEPTION(scope, false);
 363         ok = std::isfinite(hours);
 364         milliseconds += hours * msPerHour;
 365     }
 366 
 367     // minutes
 368     if (maxArgs &gt;= 3 &amp;&amp; idx &lt; numArgs &amp;&amp; ok) {
 369         t-&gt;setMinute(0);
<span class="line-modified"> 370         double minutes = callFrame-&gt;uncheckedArgument(idx++).toIntegerPreserveNaN(globalObject);</span>
 371         RETURN_IF_EXCEPTION(scope, false);
 372         ok = std::isfinite(minutes);
 373         milliseconds += minutes * msPerMinute;
 374     }
 375 
 376     // seconds
 377     if (maxArgs &gt;= 2 &amp;&amp; idx &lt; numArgs &amp;&amp; ok) {
 378         t-&gt;setSecond(0);
<span class="line-modified"> 379         double seconds = callFrame-&gt;uncheckedArgument(idx++).toIntegerPreserveNaN(globalObject);</span>
 380         RETURN_IF_EXCEPTION(scope, false);
 381         ok = std::isfinite(seconds);
 382         milliseconds += seconds * msPerSecond;
 383     }
 384 
 385     if (!ok)
 386         return false;
 387 
 388     // milliseconds
 389     if (idx &lt; numArgs) {
<span class="line-modified"> 390         double millis = callFrame-&gt;uncheckedArgument(idx).toIntegerPreserveNaN(globalObject);</span>
 391         RETURN_IF_EXCEPTION(scope, false);
 392         ok = std::isfinite(millis);
 393         milliseconds += millis;
 394     } else
 395         milliseconds += *ms;
 396 
 397     *ms = milliseconds;
 398     return ok;
 399 }
 400 
 401 // Converts a list of arguments sent to a Date member function into years, months, and milliseconds, updating
 402 // ms (representing milliseconds) and t (representing the rest of the date structure) appropriately.
 403 //
 404 // Format of member function: f([years,] [months,] [days])
<span class="line-modified"> 405 static bool fillStructuresUsingDateArgs(JSGlobalObject* globalObject, CallFrame* callFrame, int maxArgs, double *ms, GregorianDateTime *t)</span>
 406 {
<span class="line-modified"> 407     VM&amp; vm = globalObject-&gt;vm();</span>
 408     auto scope = DECLARE_THROW_SCOPE(vm);
 409 
 410     int idx = 0;
 411     bool ok = true;
<span class="line-modified"> 412     int numArgs = callFrame-&gt;argumentCount();</span>
 413 
 414     // JS allows extra trailing arguments -- ignore them
 415     if (numArgs &gt; maxArgs)
 416         numArgs = maxArgs;
 417 
 418     // years
 419     if (maxArgs &gt;= 3 &amp;&amp; idx &lt; numArgs) {
<span class="line-modified"> 420         double years = callFrame-&gt;uncheckedArgument(idx++).toIntegerPreserveNaN(globalObject);</span>
 421         RETURN_IF_EXCEPTION(scope, false);
 422         ok = std::isfinite(years);
 423         t-&gt;setYear(toInt32(years));
 424     }
 425     // months
 426     if (maxArgs &gt;= 2 &amp;&amp; idx &lt; numArgs &amp;&amp; ok) {
<span class="line-modified"> 427         double months = callFrame-&gt;uncheckedArgument(idx++).toIntegerPreserveNaN(globalObject);</span>
 428         RETURN_IF_EXCEPTION(scope, false);
 429         ok = std::isfinite(months);
 430         t-&gt;setMonth(toInt32(months));
 431     }
 432     // days
 433     if (idx &lt; numArgs &amp;&amp; ok) {
<span class="line-modified"> 434         double days = callFrame-&gt;uncheckedArgument(idx++).toIntegerPreserveNaN(globalObject);</span>
 435         RETURN_IF_EXCEPTION(scope, false);
 436         ok = std::isfinite(days);
 437         t-&gt;setMonthDay(0);
 438         *ms += days * msPerDay;
 439     }
 440 
 441     return ok;
 442 }
 443 
 444 const ClassInfo DatePrototype::s_info = {&quot;Object&quot;, &amp;JSNonFinalObject::s_info, &amp;dateTable, nullptr, CREATE_METHOD_TABLE(DatePrototype)};
 445 
 446 /* Source for DatePrototype.lut.h
 447 @begin dateTable
 448   toString              dateProtoFuncToString                DontEnum|Function       0
 449   toISOString           dateProtoFuncToISOString             DontEnum|Function       0
 450   toDateString          dateProtoFuncToDateString            DontEnum|Function       0
 451   toTimeString          dateProtoFuncToTimeString            DontEnum|Function       0
 452   toLocaleString        dateProtoFuncToLocaleString          DontEnum|Function       0
 453   toLocaleDateString    dateProtoFuncToLocaleDateString      DontEnum|Function       0
 454   toLocaleTimeString    dateProtoFuncToLocaleTimeString      DontEnum|Function       0
<span class="line-modified"> 455   valueOf               dateProtoFuncGetTime                 DontEnum|Function       0  DatePrototypeGetTimeIntrinsic</span>
<span class="line-modified"> 456   getTime               dateProtoFuncGetTime                 DontEnum|Function       0  DatePrototypeGetTimeIntrinsic</span>
<span class="line-modified"> 457   getFullYear           dateProtoFuncGetFullYear             DontEnum|Function       0  DatePrototypeGetFullYearIntrinsic</span>
<span class="line-modified"> 458   getUTCFullYear        dateProtoFuncGetUTCFullYear          DontEnum|Function       0  DatePrototypeGetUTCFullYearIntrinsic</span>
<span class="line-modified"> 459   getMonth              dateProtoFuncGetMonth                DontEnum|Function       0  DatePrototypeGetMonthIntrinsic</span>
<span class="line-modified"> 460   getUTCMonth           dateProtoFuncGetUTCMonth             DontEnum|Function       0  DatePrototypeGetUTCMonthIntrinsic</span>
<span class="line-modified"> 461   getDate               dateProtoFuncGetDate                 DontEnum|Function       0  DatePrototypeGetDateIntrinsic</span>
<span class="line-modified"> 462   getUTCDate            dateProtoFuncGetUTCDate              DontEnum|Function       0  DatePrototypeGetUTCDateIntrinsic</span>
<span class="line-modified"> 463   getDay                dateProtoFuncGetDay                  DontEnum|Function       0  DatePrototypeGetDayIntrinsic</span>
<span class="line-modified"> 464   getUTCDay             dateProtoFuncGetUTCDay               DontEnum|Function       0  DatePrototypeGetUTCDayIntrinsic</span>
<span class="line-modified"> 465   getHours              dateProtoFuncGetHours                DontEnum|Function       0  DatePrototypeGetHoursIntrinsic</span>
<span class="line-modified"> 466   getUTCHours           dateProtoFuncGetUTCHours             DontEnum|Function       0  DatePrototypeGetUTCHoursIntrinsic</span>
<span class="line-modified"> 467   getMinutes            dateProtoFuncGetMinutes              DontEnum|Function       0  DatePrototypeGetMinutesIntrinsic</span>
<span class="line-modified"> 468   getUTCMinutes         dateProtoFuncGetUTCMinutes           DontEnum|Function       0  DatePrototypeGetUTCMinutesIntrinsic</span>
<span class="line-modified"> 469   getSeconds            dateProtoFuncGetSeconds              DontEnum|Function       0  DatePrototypeGetSecondsIntrinsic</span>
<span class="line-modified"> 470   getUTCSeconds         dateProtoFuncGetUTCSeconds           DontEnum|Function       0  DatePrototypeGetUTCSecondsIntrinsic</span>
<span class="line-modified"> 471   getMilliseconds       dateProtoFuncGetMilliSeconds         DontEnum|Function       0  DatePrototypeGetMillisecondsIntrinsic</span>
<span class="line-modified"> 472   getUTCMilliseconds    dateProtoFuncGetUTCMilliseconds      DontEnum|Function       0  DatePrototypeGetUTCMillisecondsIntrinsic</span>
<span class="line-modified"> 473   getTimezoneOffset     dateProtoFuncGetTimezoneOffset       DontEnum|Function       0  DatePrototypeGetTimezoneOffsetIntrinsic</span>
<span class="line-added"> 474   getYear               dateProtoFuncGetYear                 DontEnum|Function       0  DatePrototypeGetYearIntrinsic</span>
 475   setTime               dateProtoFuncSetTime                 DontEnum|Function       1
 476   setMilliseconds       dateProtoFuncSetMilliSeconds         DontEnum|Function       1
 477   setUTCMilliseconds    dateProtoFuncSetUTCMilliseconds      DontEnum|Function       1
 478   setSeconds            dateProtoFuncSetSeconds              DontEnum|Function       2
 479   setUTCSeconds         dateProtoFuncSetUTCSeconds           DontEnum|Function       2
 480   setMinutes            dateProtoFuncSetMinutes              DontEnum|Function       3
 481   setUTCMinutes         dateProtoFuncSetUTCMinutes           DontEnum|Function       3
 482   setHours              dateProtoFuncSetHours                DontEnum|Function       4
 483   setUTCHours           dateProtoFuncSetUTCHours             DontEnum|Function       4
 484   setDate               dateProtoFuncSetDate                 DontEnum|Function       1
 485   setUTCDate            dateProtoFuncSetUTCDate              DontEnum|Function       1
 486   setMonth              dateProtoFuncSetMonth                DontEnum|Function       2
 487   setUTCMonth           dateProtoFuncSetUTCMonth             DontEnum|Function       2
 488   setFullYear           dateProtoFuncSetFullYear             DontEnum|Function       3
 489   setUTCFullYear        dateProtoFuncSetUTCFullYear          DontEnum|Function       3
 490   setYear               dateProtoFuncSetYear                 DontEnum|Function       1

 491   toJSON                dateProtoFuncToJSON                  DontEnum|Function       1
 492 @end
 493 */
 494 
 495 // ECMA 15.9.4
 496 
 497 DatePrototype::DatePrototype(VM&amp; vm, Structure* structure)
 498     : Base(vm, structure)
 499 {
 500 }
 501 
 502 void DatePrototype::finishCreation(VM&amp; vm, JSGlobalObject* globalObject)
 503 {
 504     Base::finishCreation(vm);
 505     ASSERT(inherits(vm, info()));
 506 
 507     Identifier toUTCStringName = Identifier::fromString(vm, &quot;toUTCString&quot;_s);
 508     JSFunction* toUTCStringFunction = JSFunction::create(vm, globalObject, 0, toUTCStringName.string(), dateProtoFuncToUTCString);
 509     putDirectWithoutTransition(vm, toUTCStringName, toUTCStringFunction, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum));
 510     putDirectWithoutTransition(vm, Identifier::fromString(vm, &quot;toGMTString&quot;_s), toUTCStringFunction, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum));
 511 
 512 #if ENABLE(INTL)
 513     JSC_BUILTIN_FUNCTION_WITHOUT_TRANSITION(&quot;toLocaleString&quot;, datePrototypeToLocaleStringCodeGenerator, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum));
 514     JSC_BUILTIN_FUNCTION_WITHOUT_TRANSITION(&quot;toLocaleDateString&quot;, datePrototypeToLocaleDateStringCodeGenerator, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum));
 515     JSC_BUILTIN_FUNCTION_WITHOUT_TRANSITION(&quot;toLocaleTimeString&quot;, datePrototypeToLocaleTimeStringCodeGenerator, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum));
 516 #endif
 517 
 518     JSFunction* toPrimitiveFunction = JSFunction::create(vm, globalObject, 1, &quot;[Symbol.toPrimitive]&quot;_s, dateProtoFuncToPrimitiveSymbol, NoIntrinsic);
 519     putDirectWithoutTransition(vm, vm.propertyNames-&gt;toPrimitiveSymbol, toPrimitiveFunction, PropertyAttribute::DontEnum | PropertyAttribute::ReadOnly);
 520 
 521     // The constructor will be added later, after DateConstructor has been built.
 522 }
 523 
 524 // Functions
 525 
<span class="line-modified"> 526 EncodedJSValue JSC_HOST_CALL dateProtoFuncToString(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 527 {
 528     const bool asUTCVariant = false;
<span class="line-modified"> 529     return formateDateInstance(globalObject, callFrame, DateTimeFormatDateAndTime, asUTCVariant);</span>
 530 }
 531 
<span class="line-modified"> 532 EncodedJSValue JSC_HOST_CALL dateProtoFuncToUTCString(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 533 {
 534     const bool asUTCVariant = true;
<span class="line-modified"> 535     return formateDateInstance(globalObject, callFrame, DateTimeFormatDateAndTime, asUTCVariant);</span>
 536 }
 537 
<span class="line-modified"> 538 EncodedJSValue JSC_HOST_CALL dateProtoFuncToISOString(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 539 {
<span class="line-modified"> 540     VM&amp; vm = globalObject-&gt;vm();</span>
 541     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified"> 542     JSValue thisValue = callFrame-&gt;thisValue();</span>
 543     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 544     if (UNLIKELY(!thisDateObj))
<span class="line-modified"> 545         return throwVMTypeError(globalObject, scope);</span>
 546 
 547     if (!std::isfinite(thisDateObj-&gt;internalNumber()))
<span class="line-modified"> 548         return throwVMError(globalObject, scope, createRangeError(globalObject, &quot;Invalid Date&quot;_s));</span>
 549 
<span class="line-modified"> 550     const GregorianDateTime* gregorianDateTime = thisDateObj-&gt;gregorianDateTimeUTC(vm);</span>
 551     if (!gregorianDateTime)
 552         return JSValue::encode(jsNontrivialString(vm, String(&quot;Invalid Date&quot;_s)));
 553     // Maximum amount of space we need in buffer: 7 (max. digits in year) + 2 * 5 (2 characters each for month, day, hour, minute, second) + 4 (. + 3 digits for milliseconds)
 554     // 6 for formatting and one for null termination = 28. We add one extra character to allow us to force null termination.
 555     char buffer[28];
 556     // If the year is outside the bounds of 0 and 9999 inclusive we want to use the extended year format (ES 15.9.1.15.1).
 557     int ms = static_cast&lt;int&gt;(fmod(thisDateObj-&gt;internalNumber(), msPerSecond));
 558     if (ms &lt; 0)
 559         ms += msPerSecond;
 560 
 561     int charactersWritten;
 562     if (gregorianDateTime-&gt;year() &gt; 9999 || gregorianDateTime-&gt;year() &lt; 0)
 563         charactersWritten = snprintf(buffer, sizeof(buffer), &quot;%+07d-%02d-%02dT%02d:%02d:%02d.%03dZ&quot;, gregorianDateTime-&gt;year(), gregorianDateTime-&gt;month() + 1, gregorianDateTime-&gt;monthDay(), gregorianDateTime-&gt;hour(), gregorianDateTime-&gt;minute(), gregorianDateTime-&gt;second(), ms);
 564     else
 565         charactersWritten = snprintf(buffer, sizeof(buffer), &quot;%04d-%02d-%02dT%02d:%02d:%02d.%03dZ&quot;, gregorianDateTime-&gt;year(), gregorianDateTime-&gt;month() + 1, gregorianDateTime-&gt;monthDay(), gregorianDateTime-&gt;hour(), gregorianDateTime-&gt;minute(), gregorianDateTime-&gt;second(), ms);
 566 
 567     ASSERT(charactersWritten &gt; 0 &amp;&amp; static_cast&lt;unsigned&gt;(charactersWritten) &lt; sizeof(buffer));
 568     if (static_cast&lt;unsigned&gt;(charactersWritten) &gt;= sizeof(buffer))
 569         return JSValue::encode(jsEmptyString(vm));
 570 
 571     return JSValue::encode(jsNontrivialString(vm, String(buffer, charactersWritten)));
 572 }
 573 
<span class="line-modified"> 574 EncodedJSValue JSC_HOST_CALL dateProtoFuncToDateString(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 575 {
 576     const bool asUTCVariant = false;
<span class="line-modified"> 577     return formateDateInstance(globalObject, callFrame, DateTimeFormatDate, asUTCVariant);</span>
 578 }
 579 
<span class="line-modified"> 580 EncodedJSValue JSC_HOST_CALL dateProtoFuncToTimeString(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 581 {
 582     const bool asUTCVariant = false;
<span class="line-modified"> 583     return formateDateInstance(globalObject, callFrame, DateTimeFormatTime, asUTCVariant);</span>
 584 }
 585 
<span class="line-modified"> 586 EncodedJSValue JSC_HOST_CALL dateProtoFuncToLocaleString(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 587 {
<span class="line-modified"> 588     VM&amp; vm = globalObject-&gt;vm();</span>
 589     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified"> 590     JSValue thisValue = callFrame-&gt;thisValue();</span>
 591     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 592     if (UNLIKELY(!thisDateObj))
<span class="line-modified"> 593         return throwVMTypeError(globalObject, scope);</span>
 594 
<span class="line-modified"> 595     return JSValue::encode(formatLocaleDate(globalObject, callFrame, thisDateObj, thisDateObj-&gt;internalNumber(), LocaleDateAndTime));</span>
 596 }
 597 
<span class="line-modified"> 598 EncodedJSValue JSC_HOST_CALL dateProtoFuncToLocaleDateString(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 599 {
<span class="line-modified"> 600     VM&amp; vm = globalObject-&gt;vm();</span>
 601     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified"> 602     JSValue thisValue = callFrame-&gt;thisValue();</span>
 603     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 604     if (UNLIKELY(!thisDateObj))
<span class="line-modified"> 605         return throwVMTypeError(globalObject, scope);</span>
 606 
<span class="line-modified"> 607     return JSValue::encode(formatLocaleDate(globalObject, callFrame, thisDateObj, thisDateObj-&gt;internalNumber(), LocaleDate));</span>
 608 }
 609 
<span class="line-modified"> 610 EncodedJSValue JSC_HOST_CALL dateProtoFuncToLocaleTimeString(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 611 {
<span class="line-modified"> 612     VM&amp; vm = globalObject-&gt;vm();</span>
 613     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified"> 614     JSValue thisValue = callFrame-&gt;thisValue();</span>
 615     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 616     if (UNLIKELY(!thisDateObj))
<span class="line-modified"> 617         return throwVMTypeError(globalObject, scope);</span>
 618 
<span class="line-modified"> 619     return JSValue::encode(formatLocaleDate(globalObject, callFrame, thisDateObj, thisDateObj-&gt;internalNumber(), LocaleTime));</span>
 620 }
 621 
<span class="line-modified"> 622 EncodedJSValue JSC_HOST_CALL dateProtoFuncToPrimitiveSymbol(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 623 {
<span class="line-modified"> 624     VM&amp; vm = globalObject-&gt;vm();</span>
 625     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified"> 626     JSValue thisValue = callFrame-&gt;thisValue();</span>
 627     if (!thisValue.isObject())
<span class="line-modified"> 628         return throwVMTypeError(globalObject, scope, &quot;Date.prototype[Symbol.toPrimitive] expected |this| to be an object.&quot;);</span>
 629     JSObject* thisObject = jsCast&lt;JSObject*&gt;(thisValue);
 630 
<span class="line-modified"> 631     if (!callFrame-&gt;argumentCount())</span>
<span class="line-modified"> 632         return throwVMTypeError(globalObject, scope, &quot;Date.prototype[Symbol.toPrimitive] expected a first argument.&quot;);</span>
 633 
<span class="line-modified"> 634     JSValue hintValue = callFrame-&gt;uncheckedArgument(0);</span>
<span class="line-modified"> 635     PreferredPrimitiveType type = toPreferredPrimitiveType(globalObject, hintValue);</span>
 636     RETURN_IF_EXCEPTION(scope, encodedJSValue());
 637 
 638     if (type == NoPreference)
 639         type = PreferString;
 640 
<span class="line-modified"> 641     RELEASE_AND_RETURN(scope, JSValue::encode(thisObject-&gt;ordinaryToPrimitive(globalObject, type)));</span>
 642 }
 643 
<span class="line-modified"> 644 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetTime(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 645 {
<span class="line-modified"> 646     VM&amp; vm = globalObject-&gt;vm();</span>
 647     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified"> 648     JSValue thisValue = callFrame-&gt;thisValue();</span>
 649     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 650     if (UNLIKELY(!thisDateObj))
<span class="line-modified"> 651         return throwVMTypeError(globalObject, scope);</span>
 652 
 653     return JSValue::encode(jsNumber(thisDateObj-&gt;internalNumber()));
 654 }
 655 
<span class="line-modified"> 656 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetFullYear(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 657 {
<span class="line-modified"> 658     VM&amp; vm = globalObject-&gt;vm();</span>
 659     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified"> 660     JSValue thisValue = callFrame-&gt;thisValue();</span>
 661     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 662     if (UNLIKELY(!thisDateObj))
<span class="line-modified"> 663         return throwVMTypeError(globalObject, scope);</span>
 664 
<span class="line-modified"> 665     const GregorianDateTime* gregorianDateTime = thisDateObj-&gt;gregorianDateTime(vm);</span>
 666     if (!gregorianDateTime)
 667         return JSValue::encode(jsNaN());
 668     return JSValue::encode(jsNumber(gregorianDateTime-&gt;year()));
 669 }
 670 
<span class="line-modified"> 671 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetUTCFullYear(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 672 {
<span class="line-modified"> 673     VM&amp; vm = globalObject-&gt;vm();</span>
 674     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified"> 675     JSValue thisValue = callFrame-&gt;thisValue();</span>
 676     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 677     if (UNLIKELY(!thisDateObj))
<span class="line-modified"> 678         return throwVMTypeError(globalObject, scope);</span>
 679 
<span class="line-modified"> 680     const GregorianDateTime* gregorianDateTime = thisDateObj-&gt;gregorianDateTimeUTC(vm);</span>
 681     if (!gregorianDateTime)
 682         return JSValue::encode(jsNaN());
 683     return JSValue::encode(jsNumber(gregorianDateTime-&gt;year()));
 684 }
 685 
<span class="line-modified"> 686 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetMonth(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 687 {
<span class="line-modified"> 688     VM&amp; vm = globalObject-&gt;vm();</span>
 689     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified"> 690     JSValue thisValue = callFrame-&gt;thisValue();</span>
 691     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 692     if (UNLIKELY(!thisDateObj))
<span class="line-modified"> 693         return throwVMTypeError(globalObject, scope);</span>
 694 
<span class="line-modified"> 695     const GregorianDateTime* gregorianDateTime = thisDateObj-&gt;gregorianDateTime(vm);</span>
 696     if (!gregorianDateTime)
 697         return JSValue::encode(jsNaN());
 698     return JSValue::encode(jsNumber(gregorianDateTime-&gt;month()));
 699 }
 700 
<span class="line-modified"> 701 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetUTCMonth(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 702 {
<span class="line-modified"> 703     VM&amp; vm = globalObject-&gt;vm();</span>
 704     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified"> 705     JSValue thisValue = callFrame-&gt;thisValue();</span>
 706     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 707     if (UNLIKELY(!thisDateObj))
<span class="line-modified"> 708         return throwVMTypeError(globalObject, scope);</span>
 709 
<span class="line-modified"> 710     const GregorianDateTime* gregorianDateTime = thisDateObj-&gt;gregorianDateTimeUTC(vm);</span>
 711     if (!gregorianDateTime)
 712         return JSValue::encode(jsNaN());
 713     return JSValue::encode(jsNumber(gregorianDateTime-&gt;month()));
 714 }
 715 
<span class="line-modified"> 716 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetDate(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 717 {
<span class="line-modified"> 718     VM&amp; vm = globalObject-&gt;vm();</span>
 719     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified"> 720     JSValue thisValue = callFrame-&gt;thisValue();</span>
 721     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 722     if (UNLIKELY(!thisDateObj))
<span class="line-modified"> 723         return throwVMTypeError(globalObject, scope);</span>
 724 
<span class="line-modified"> 725     const GregorianDateTime* gregorianDateTime = thisDateObj-&gt;gregorianDateTime(vm);</span>
 726     if (!gregorianDateTime)
 727         return JSValue::encode(jsNaN());
 728     return JSValue::encode(jsNumber(gregorianDateTime-&gt;monthDay()));
 729 }
 730 
<span class="line-modified"> 731 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetUTCDate(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 732 {
<span class="line-modified"> 733     VM&amp; vm = globalObject-&gt;vm();</span>
 734     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified"> 735     JSValue thisValue = callFrame-&gt;thisValue();</span>
 736     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 737     if (UNLIKELY(!thisDateObj))
<span class="line-modified"> 738         return throwVMTypeError(globalObject, scope);</span>
 739 
<span class="line-modified"> 740     const GregorianDateTime* gregorianDateTime = thisDateObj-&gt;gregorianDateTimeUTC(vm);</span>
 741     if (!gregorianDateTime)
 742         return JSValue::encode(jsNaN());
 743     return JSValue::encode(jsNumber(gregorianDateTime-&gt;monthDay()));
 744 }
 745 
<span class="line-modified"> 746 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetDay(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 747 {
<span class="line-modified"> 748     VM&amp; vm = globalObject-&gt;vm();</span>
 749     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified"> 750     JSValue thisValue = callFrame-&gt;thisValue();</span>
 751     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 752     if (UNLIKELY(!thisDateObj))
<span class="line-modified"> 753         return throwVMTypeError(globalObject, scope);</span>
 754 
<span class="line-modified"> 755     const GregorianDateTime* gregorianDateTime = thisDateObj-&gt;gregorianDateTime(vm);</span>
 756     if (!gregorianDateTime)
 757         return JSValue::encode(jsNaN());
 758     return JSValue::encode(jsNumber(gregorianDateTime-&gt;weekDay()));
 759 }
 760 
<span class="line-modified"> 761 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetUTCDay(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 762 {
<span class="line-modified"> 763     VM&amp; vm = globalObject-&gt;vm();</span>
 764     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified"> 765     JSValue thisValue = callFrame-&gt;thisValue();</span>
 766     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 767     if (UNLIKELY(!thisDateObj))
<span class="line-modified"> 768         return throwVMTypeError(globalObject, scope);</span>
 769 
<span class="line-modified"> 770     const GregorianDateTime* gregorianDateTime = thisDateObj-&gt;gregorianDateTimeUTC(vm);</span>
 771     if (!gregorianDateTime)
 772         return JSValue::encode(jsNaN());
 773     return JSValue::encode(jsNumber(gregorianDateTime-&gt;weekDay()));
 774 }
 775 
<span class="line-modified"> 776 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetHours(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 777 {
<span class="line-modified"> 778     VM&amp; vm = globalObject-&gt;vm();</span>
 779     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified"> 780     JSValue thisValue = callFrame-&gt;thisValue();</span>
 781     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 782     if (UNLIKELY(!thisDateObj))
<span class="line-modified"> 783         return throwVMTypeError(globalObject, scope);</span>
 784 
<span class="line-modified"> 785     const GregorianDateTime* gregorianDateTime = thisDateObj-&gt;gregorianDateTime(vm);</span>
 786     if (!gregorianDateTime)
 787         return JSValue::encode(jsNaN());
 788     return JSValue::encode(jsNumber(gregorianDateTime-&gt;hour()));
 789 }
 790 
<span class="line-modified"> 791 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetUTCHours(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 792 {
<span class="line-modified"> 793     VM&amp; vm = globalObject-&gt;vm();</span>
 794     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified"> 795     JSValue thisValue = callFrame-&gt;thisValue();</span>
 796     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 797     if (UNLIKELY(!thisDateObj))
<span class="line-modified"> 798         return throwVMTypeError(globalObject, scope);</span>
 799 
<span class="line-modified"> 800     const GregorianDateTime* gregorianDateTime = thisDateObj-&gt;gregorianDateTimeUTC(vm);</span>
 801     if (!gregorianDateTime)
 802         return JSValue::encode(jsNaN());
 803     return JSValue::encode(jsNumber(gregorianDateTime-&gt;hour()));
 804 }
 805 
<span class="line-modified"> 806 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetMinutes(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 807 {
<span class="line-modified"> 808     VM&amp; vm = globalObject-&gt;vm();</span>
 809     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified"> 810     JSValue thisValue = callFrame-&gt;thisValue();</span>
 811     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 812     if (UNLIKELY(!thisDateObj))
<span class="line-modified"> 813         return throwVMTypeError(globalObject, scope);</span>
 814 
<span class="line-modified"> 815     const GregorianDateTime* gregorianDateTime = thisDateObj-&gt;gregorianDateTime(vm);</span>
 816     if (!gregorianDateTime)
 817         return JSValue::encode(jsNaN());
 818     return JSValue::encode(jsNumber(gregorianDateTime-&gt;minute()));
 819 }
 820 
<span class="line-modified"> 821 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetUTCMinutes(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 822 {
<span class="line-modified"> 823     VM&amp; vm = globalObject-&gt;vm();</span>
 824     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified"> 825     JSValue thisValue = callFrame-&gt;thisValue();</span>
 826     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 827     if (UNLIKELY(!thisDateObj))
<span class="line-modified"> 828         return throwVMTypeError(globalObject, scope);</span>
 829 
<span class="line-modified"> 830     const GregorianDateTime* gregorianDateTime = thisDateObj-&gt;gregorianDateTimeUTC(vm);</span>
 831     if (!gregorianDateTime)
 832         return JSValue::encode(jsNaN());
 833     return JSValue::encode(jsNumber(gregorianDateTime-&gt;minute()));
 834 }
 835 
<span class="line-modified"> 836 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetSeconds(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 837 {
<span class="line-modified"> 838     VM&amp; vm = globalObject-&gt;vm();</span>
 839     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified"> 840     JSValue thisValue = callFrame-&gt;thisValue();</span>
 841     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 842     if (UNLIKELY(!thisDateObj))
<span class="line-modified"> 843         return throwVMTypeError(globalObject, scope);</span>
 844 
<span class="line-modified"> 845     const GregorianDateTime* gregorianDateTime = thisDateObj-&gt;gregorianDateTime(vm);</span>
 846     if (!gregorianDateTime)
 847         return JSValue::encode(jsNaN());
 848     return JSValue::encode(jsNumber(gregorianDateTime-&gt;second()));
 849 }
 850 
<span class="line-modified"> 851 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetUTCSeconds(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 852 {
<span class="line-modified"> 853     VM&amp; vm = globalObject-&gt;vm();</span>
 854     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified"> 855     JSValue thisValue = callFrame-&gt;thisValue();</span>
 856     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 857     if (UNLIKELY(!thisDateObj))
<span class="line-modified"> 858         return throwVMTypeError(globalObject, scope);</span>
 859 
<span class="line-modified"> 860     const GregorianDateTime* gregorianDateTime = thisDateObj-&gt;gregorianDateTimeUTC(vm);</span>
 861     if (!gregorianDateTime)
 862         return JSValue::encode(jsNaN());
 863     return JSValue::encode(jsNumber(gregorianDateTime-&gt;second()));
 864 }
 865 
<span class="line-modified"> 866 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetMilliSeconds(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 867 {
<span class="line-modified"> 868     VM&amp; vm = globalObject-&gt;vm();</span>
 869     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified"> 870     JSValue thisValue = callFrame-&gt;thisValue();</span>
 871     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 872     if (UNLIKELY(!thisDateObj))
<span class="line-modified"> 873         return throwVMTypeError(globalObject, scope);</span>
 874 
 875     double milli = thisDateObj-&gt;internalNumber();
 876     if (std::isnan(milli))
 877         return JSValue::encode(jsNaN());
 878 
 879     double secs = floor(milli / msPerSecond);
 880     double ms = milli - secs * msPerSecond;
<span class="line-modified"> 881     // Since timeClip makes internalNumber integer milliseconds, this result is always int32_t.</span>
<span class="line-added"> 882     return JSValue::encode(jsNumber(static_cast&lt;int32_t&gt;(ms)));</span>
 883 }
 884 
<span class="line-modified"> 885 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetUTCMilliseconds(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 886 {
<span class="line-modified"> 887     VM&amp; vm = globalObject-&gt;vm();</span>
 888     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified"> 889     JSValue thisValue = callFrame-&gt;thisValue();</span>
 890     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 891     if (UNLIKELY(!thisDateObj))
<span class="line-modified"> 892         return throwVMTypeError(globalObject, scope);</span>
 893 
 894     double milli = thisDateObj-&gt;internalNumber();
 895     if (std::isnan(milli))
 896         return JSValue::encode(jsNaN());
 897 
 898     double secs = floor(milli / msPerSecond);
 899     double ms = milli - secs * msPerSecond;
<span class="line-modified"> 900     // Since timeClip makes internalNumber integer milliseconds, this result is always int32_t.</span>
<span class="line-added"> 901     return JSValue::encode(jsNumber(static_cast&lt;int32_t&gt;(ms)));</span>
 902 }
 903 
<span class="line-modified"> 904 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetTimezoneOffset(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 905 {
<span class="line-modified"> 906     VM&amp; vm = globalObject-&gt;vm();</span>
 907     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified"> 908     JSValue thisValue = callFrame-&gt;thisValue();</span>
 909     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 910     if (UNLIKELY(!thisDateObj))
<span class="line-modified"> 911         return throwVMTypeError(globalObject, scope);</span>
 912 
<span class="line-modified"> 913     const GregorianDateTime* gregorianDateTime = thisDateObj-&gt;gregorianDateTime(vm);</span>
 914     if (!gregorianDateTime)
 915         return JSValue::encode(jsNaN());
<span class="line-modified"> 916     return JSValue::encode(jsNumber(-gregorianDateTime-&gt;utcOffsetInMinute()));</span>
 917 }
 918 
<span class="line-modified"> 919 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetTime(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 920 {
<span class="line-modified"> 921     VM&amp; vm = globalObject-&gt;vm();</span>
 922     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified"> 923     JSValue thisValue = callFrame-&gt;thisValue();</span>
 924     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 925     if (UNLIKELY(!thisDateObj))
<span class="line-modified"> 926         return throwVMTypeError(globalObject, scope);</span>
 927 
<span class="line-modified"> 928     double milli = timeClip(callFrame-&gt;argument(0).toNumber(globalObject));</span>
 929     RETURN_IF_EXCEPTION(scope, encodedJSValue());
 930     thisDateObj-&gt;setInternalNumber(milli);
 931     return JSValue::encode(jsNumber(milli));
 932 }
 933 
<span class="line-modified"> 934 static EncodedJSValue setNewValueFromTimeArgs(JSGlobalObject* globalObject, CallFrame* callFrame, int numArgsToUse, WTF::TimeType inputTimeType)</span>
 935 {
<span class="line-modified"> 936     VM&amp; vm = globalObject-&gt;vm();</span>
 937     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified"> 938     JSValue thisValue = callFrame-&gt;thisValue();</span>
 939     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 940     if (UNLIKELY(!thisDateObj))
<span class="line-modified"> 941         return throwVMTypeError(globalObject, scope);</span>
 942 
 943     double milli = thisDateObj-&gt;internalNumber();
 944 
<span class="line-modified"> 945     if (!callFrame-&gt;argumentCount() || std::isnan(milli)) {</span>
 946         thisDateObj-&gt;setInternalNumber(PNaN);
 947         return JSValue::encode(jsNaN());
 948     }
 949 
 950     double secs = floor(milli / msPerSecond);
 951     double ms = milli - secs * msPerSecond;
 952 
 953     const GregorianDateTime* other = inputTimeType == WTF::UTCTime
<span class="line-modified"> 954         ? thisDateObj-&gt;gregorianDateTimeUTC(vm)</span>
<span class="line-modified"> 955         : thisDateObj-&gt;gregorianDateTime(vm);</span>
 956     if (!other)
 957         return JSValue::encode(jsNaN());
 958 
<span class="line-modified"> 959     GregorianDateTime gregorianDateTime(*other);</span>
<span class="line-modified"> 960     bool success = fillStructuresUsingTimeArgs(globalObject, callFrame, numArgsToUse, &amp;ms, &amp;gregorianDateTime);</span>

 961     RETURN_IF_EXCEPTION(scope, encodedJSValue());
 962     if (!success) {
 963         thisDateObj-&gt;setInternalNumber(PNaN);
 964         return JSValue::encode(jsNaN());
 965     }
 966 
 967     double newUTCDate = gregorianDateTimeToMS(vm, gregorianDateTime, ms, inputTimeType);
 968     double result = timeClip(newUTCDate);
 969     thisDateObj-&gt;setInternalNumber(result);
 970     return JSValue::encode(jsNumber(result));
 971 }
 972 
<span class="line-modified"> 973 static EncodedJSValue setNewValueFromDateArgs(JSGlobalObject* globalObject, CallFrame* callFrame, int numArgsToUse, WTF::TimeType inputTimeType)</span>
 974 {
<span class="line-modified"> 975     VM&amp; vm = globalObject-&gt;vm();</span>
 976     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified"> 977     JSValue thisValue = callFrame-&gt;thisValue();</span>
 978     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 979     if (UNLIKELY(!thisDateObj))
<span class="line-modified"> 980         return throwVMTypeError(globalObject, scope);</span>
 981 
<span class="line-modified"> 982     if (!callFrame-&gt;argumentCount()) {</span>
 983         thisDateObj-&gt;setInternalNumber(PNaN);
 984         return JSValue::encode(jsNaN());
 985     }
 986 
 987     double milli = thisDateObj-&gt;internalNumber();
 988     double ms = 0;
 989 
 990     GregorianDateTime gregorianDateTime;
 991     if (numArgsToUse == 3 &amp;&amp; std::isnan(milli))
 992         msToGregorianDateTime(vm, 0, WTF::UTCTime, gregorianDateTime);
 993     else {
 994         ms = milli - floor(milli / msPerSecond) * msPerSecond;
 995         const GregorianDateTime* other = inputTimeType == WTF::UTCTime
<span class="line-modified"> 996             ? thisDateObj-&gt;gregorianDateTimeUTC(vm)</span>
<span class="line-modified"> 997             : thisDateObj-&gt;gregorianDateTime(vm);</span>
 998         if (!other)
 999             return JSValue::encode(jsNaN());
<span class="line-modified">1000         gregorianDateTime = *other;</span>
1001     }
1002 
<span class="line-modified">1003     bool success = fillStructuresUsingDateArgs(globalObject, callFrame, numArgsToUse, &amp;ms, &amp;gregorianDateTime);</span>
1004     RETURN_IF_EXCEPTION(scope, encodedJSValue());
1005     if (!success) {
1006         thisDateObj-&gt;setInternalNumber(PNaN);
1007         return JSValue::encode(jsNaN());
1008     }
1009 
1010     double newUTCDate = gregorianDateTimeToMS(vm, gregorianDateTime, ms, inputTimeType);
1011     double result = timeClip(newUTCDate);
1012     thisDateObj-&gt;setInternalNumber(result);
1013     return JSValue::encode(jsNumber(result));
1014 }
1015 
<span class="line-modified">1016 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetMilliSeconds(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
1017 {
<span class="line-modified">1018     return setNewValueFromTimeArgs(globalObject, callFrame, 1, WTF::LocalTime);</span>
1019 }
1020 
<span class="line-modified">1021 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetUTCMilliseconds(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
1022 {
<span class="line-modified">1023     return setNewValueFromTimeArgs(globalObject, callFrame, 1, WTF::UTCTime);</span>
1024 }
1025 
<span class="line-modified">1026 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetSeconds(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
1027 {
<span class="line-modified">1028     return setNewValueFromTimeArgs(globalObject, callFrame, 2, WTF::LocalTime);</span>
1029 }
1030 
<span class="line-modified">1031 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetUTCSeconds(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
1032 {
<span class="line-modified">1033     return setNewValueFromTimeArgs(globalObject, callFrame, 2, WTF::UTCTime);</span>
1034 }
1035 
<span class="line-modified">1036 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetMinutes(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
1037 {
<span class="line-modified">1038     return setNewValueFromTimeArgs(globalObject, callFrame, 3, WTF::LocalTime);</span>
1039 }
1040 
<span class="line-modified">1041 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetUTCMinutes(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
1042 {
<span class="line-modified">1043     return setNewValueFromTimeArgs(globalObject, callFrame, 3, WTF::UTCTime);</span>
1044 }
1045 
<span class="line-modified">1046 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetHours(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
1047 {
<span class="line-modified">1048     return setNewValueFromTimeArgs(globalObject, callFrame, 4, WTF::LocalTime);</span>
1049 }
1050 
<span class="line-modified">1051 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetUTCHours(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
1052 {
<span class="line-modified">1053     return setNewValueFromTimeArgs(globalObject, callFrame, 4, WTF::UTCTime);</span>
1054 }
1055 
<span class="line-modified">1056 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetDate(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
1057 {
<span class="line-modified">1058     return setNewValueFromDateArgs(globalObject, callFrame, 1, WTF::LocalTime);</span>
1059 }
1060 
<span class="line-modified">1061 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetUTCDate(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
1062 {
<span class="line-modified">1063     return setNewValueFromDateArgs(globalObject, callFrame, 1, WTF::UTCTime);</span>
1064 }
1065 
<span class="line-modified">1066 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetMonth(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
1067 {
<span class="line-modified">1068     return setNewValueFromDateArgs(globalObject, callFrame, 2, WTF::LocalTime);</span>
1069 }
1070 
<span class="line-modified">1071 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetUTCMonth(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
1072 {
<span class="line-modified">1073     return setNewValueFromDateArgs(globalObject, callFrame, 2, WTF::UTCTime);</span>
1074 }
1075 
<span class="line-modified">1076 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetFullYear(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
1077 {
<span class="line-modified">1078     return setNewValueFromDateArgs(globalObject, callFrame, 3, WTF::LocalTime);</span>
1079 }
1080 
<span class="line-modified">1081 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetUTCFullYear(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
1082 {
<span class="line-modified">1083     return setNewValueFromDateArgs(globalObject, callFrame, 3, WTF::UTCTime);</span>
1084 }
1085 
<span class="line-modified">1086 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetYear(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
1087 {
<span class="line-modified">1088     VM&amp; vm = globalObject-&gt;vm();</span>
1089     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified">1090     JSValue thisValue = callFrame-&gt;thisValue();</span>
1091     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
1092     if (UNLIKELY(!thisDateObj))
<span class="line-modified">1093         return throwVMTypeError(globalObject, scope);</span>
1094 
<span class="line-modified">1095     if (!callFrame-&gt;argumentCount()) {</span>
1096         thisDateObj-&gt;setInternalNumber(PNaN);
1097         return JSValue::encode(jsNaN());
1098     }
1099 
1100     double milli = thisDateObj-&gt;internalNumber();
1101     double ms = 0;
1102 
1103     GregorianDateTime gregorianDateTime;
1104     if (std::isnan(milli))
1105         // Based on ECMA 262 B.2.5 (setYear)
1106         // the time must be reset to +0 if it is NaN.
1107         msToGregorianDateTime(vm, 0, WTF::UTCTime, gregorianDateTime);
1108     else {
1109         double secs = floor(milli / msPerSecond);
1110         ms = milli - secs * msPerSecond;
<span class="line-modified">1111         if (const GregorianDateTime* other = thisDateObj-&gt;gregorianDateTime(vm))</span>
<span class="line-modified">1112             gregorianDateTime = *other;</span>
1113     }
1114 
<span class="line-modified">1115     double year = callFrame-&gt;argument(0).toIntegerPreserveNaN(globalObject);</span>
1116     RETURN_IF_EXCEPTION(scope, encodedJSValue());
1117     if (!std::isfinite(year)) {
1118         thisDateObj-&gt;setInternalNumber(PNaN);
1119         return JSValue::encode(jsNaN());
1120     }
1121 
1122     gregorianDateTime.setYear(toInt32((year &gt;= 0 &amp;&amp; year &lt;= 99) ? (year + 1900) : year));
1123     double timeInMilliseconds = gregorianDateTimeToMS(vm, gregorianDateTime, ms, WTF::LocalTime);
1124     double result = timeClip(timeInMilliseconds);
1125     thisDateObj-&gt;setInternalNumber(result);
1126     return JSValue::encode(jsNumber(result));
1127 }
1128 
<span class="line-modified">1129 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetYear(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
1130 {
<span class="line-modified">1131     VM&amp; vm = globalObject-&gt;vm();</span>
1132     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified">1133     JSValue thisValue = callFrame-&gt;thisValue();</span>
1134     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
1135     if (UNLIKELY(!thisDateObj))
<span class="line-modified">1136         return throwVMTypeError(globalObject, scope);</span>
1137 
<span class="line-modified">1138     const GregorianDateTime* gregorianDateTime = thisDateObj-&gt;gregorianDateTime(vm);</span>
1139     if (!gregorianDateTime)
1140         return JSValue::encode(jsNaN());
1141 
1142     // NOTE: IE returns the full year even in getYear.
1143     return JSValue::encode(jsNumber(gregorianDateTime-&gt;year() - 1900));
1144 }
1145 
<span class="line-modified">1146 EncodedJSValue JSC_HOST_CALL dateProtoFuncToJSON(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
1147 {
<span class="line-modified">1148     VM&amp; vm = globalObject-&gt;vm();</span>
1149     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified">1150     JSValue thisValue = callFrame-&gt;thisValue();</span>
<span class="line-modified">1151     JSObject* object = thisValue.toObject(globalObject);</span>
1152     RETURN_IF_EXCEPTION(scope, encodedJSValue());
1153 
<span class="line-modified">1154     JSValue timeValue = object-&gt;toPrimitive(globalObject, PreferNumber);</span>
1155     RETURN_IF_EXCEPTION(scope, encodedJSValue());
<span class="line-modified">1156     if (timeValue.isNumber() &amp;&amp; !std::isfinite(timeValue.asNumber()))</span>
1157         return JSValue::encode(jsNull());
1158 
<span class="line-modified">1159     JSValue toISOValue = object-&gt;get(globalObject, vm.propertyNames-&gt;toISOString);</span>
1160     RETURN_IF_EXCEPTION(scope, encodedJSValue());
1161 
1162     CallData callData;
1163     CallType callType = getCallData(vm, toISOValue, callData);
1164     if (callType == CallType::None)
<span class="line-modified">1165         return throwVMTypeError(globalObject, scope, &quot;toISOString is not a function&quot;_s);</span>
1166 
<span class="line-modified">1167     JSValue result = call(globalObject, asObject(toISOValue), callType, callData, object, *vm.emptyList);</span>
1168     RETURN_IF_EXCEPTION(scope, encodedJSValue());
1169     return JSValue::encode(result);
1170 }
1171 
1172 } // namespace JSC
</pre>
</td>
</tr>
</table>
<center><a href="DateInstanceCache.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="DatePrototype.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>