<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Tools/Scripts/webkitdirs.pm</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="set-webkit-configuration.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="webkitperl/FeatureList.pm.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Tools/Scripts/webkitdirs.pm</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
<span class="line-modified">   1 # Copyright (C) 2005-2007, 2010-2016 Apple Inc. All rights reserved.</span>
   2 # Copyright (C) 2009 Google Inc. All rights reserved.
   3 # Copyright (C) 2011 Research In Motion Limited. All rights reserved.
   4 # Copyright (C) 2013 Nokia Corporation and/or its subsidiary(-ies).
   5 #
   6 # Redistribution and use in source and binary forms, with or without
   7 # modification, are permitted provided that the following conditions
   8 # are met:
   9 #
  10 # 1.  Redistributions of source code must retain the above copyright
  11 #     notice, this list of conditions and the following disclaimer. 
  12 # 2.  Redistributions in binary form must reproduce the above copyright
  13 #     notice, this list of conditions and the following disclaimer in the
  14 #     documentation and/or other materials provided with the distribution. 
  15 # 3.  Neither the name of Apple Inc. (&quot;Apple&quot;) nor the names of
  16 #     its contributors may be used to endorse or promote products derived
  17 #     from this software without specific prior written permission. 
  18 #
  19 # THIS SOFTWARE IS PROVIDED BY APPLE AND ITS CONTRIBUTORS &quot;AS IS&quot; AND ANY
  20 # EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
  21 # WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
</pre>
<hr />
<pre>
  88        &amp;sdkPlatformDirectory
  89        &amp;setConfiguration
  90        &amp;setupMacWebKitEnvironment
  91        &amp;setupUnixWebKitEnvironment
  92        &amp;sharedCommandLineOptions
  93        &amp;sharedCommandLineOptionsUsage
  94        &amp;shutDownIOSSimulatorDevice
  95        &amp;willUseIOSDeviceSDK
  96        &amp;willUseIOSSimulatorSDK
  97        DO_NOT_USE_OPEN_COMMAND
  98        SIMULATOR_DEVICE_SUFFIX_FOR_WEBKIT_DEVELOPMENT
  99        USE_OPEN_COMMAND
 100    );
 101    %EXPORT_TAGS = ( );
 102    @EXPORT_OK   = ();
 103 }
 104 
 105 # Ports
 106 use constant {
 107     AppleWin    =&gt; &quot;AppleWin&quot;,

 108     GTK         =&gt; &quot;GTK&quot;,
 109     iOS         =&gt; &quot;iOS&quot;,
 110     tvOS        =&gt; &quot;tvOS&quot;,
 111     watchOS     =&gt; &quot;watchOS&quot;,
 112     Mac         =&gt; &quot;Mac&quot;,
 113     MacCatalyst =&gt; &quot;MacCatalyst&quot;,
 114     JSCOnly     =&gt; &quot;JSCOnly&quot;,
 115     PlayStation =&gt; &quot;PlayStation&quot;,
 116     WinCairo    =&gt; &quot;WinCairo&quot;,
 117     Java     =&gt; &quot;Java&quot;,
 118     WPE         =&gt; &quot;WPE&quot;,
 119     Unknown     =&gt; &quot;Unknown&quot;
 120 };
 121 
 122 use constant USE_OPEN_COMMAND =&gt; 1; # Used in runMacWebKitApp().
 123 use constant DO_NOT_USE_OPEN_COMMAND =&gt; 2;
 124 use constant SIMULATOR_DEVICE_STATE_SHUTDOWN =&gt; &quot;1&quot;;
 125 use constant SIMULATOR_DEVICE_STATE_BOOTED =&gt; &quot;3&quot;;
 126 use constant SIMULATOR_DEVICE_SUFFIX_FOR_WEBKIT_DEVELOPMENT  =&gt; &quot;For WebKit Development&quot;;
 127 
 128 # See table &quot;Certificate types and names&quot; on &lt;https://developer.apple.com/library/ios/documentation/IDEs/Conceptual/AppDistributionGuide/MaintainingCertificates/MaintainingCertificates.html#//apple_ref/doc/uid/TP40012582-CH31-SW41&gt;.
 129 use constant IOS_DEVELOPMENT_CERTIFICATE_NAME_PREFIX =&gt; &quot;iPhone Developer: &quot;;
 130 
 131 our @EXPORT_OK;
 132 
 133 my $architecture;
 134 my $asanIsEnabled;


 135 my $ltoMode;
 136 my $numberOfCPUs;
 137 my $maxCPULoad;
 138 my $baseProductDir;
 139 my @baseProductDirOption;
 140 my $configuration;
 141 my $xcodeSDK;
 142 my $configurationForVisualStudio;
 143 my $configurationProductDir;
 144 my $sourceDir;
 145 my $currentSVNRevision;
 146 my $didLoadIPhoneSimulatorNotification;
 147 my $nmPath;
 148 my $osXVersion;
 149 my $iosVersion;
 150 my $generateDsym;
 151 my $isCMakeBuild;
 152 my $isGenerateProjectOnly;
 153 my $shouldBuild32Bit;
 154 my $isWin64;
</pre>
<hr />
<pre>
 408     $architecture = &#39;x86_64&#39; if $architecture =~ /amd64/i;
 409     $architecture = &#39;arm64&#39; if $architecture =~ /aarch64/i;
 410 }
 411 
 412 sub determineASanIsEnabled
 413 {
 414     return if defined $asanIsEnabled;
 415     determineBaseProductDir();
 416 
 417     $asanIsEnabled = 0;
 418     my $asanConfigurationValue;
 419 
 420     if (open ASAN, &quot;$baseProductDir/ASan&quot;) {
 421         $asanConfigurationValue = &lt;ASAN&gt;;
 422         close ASAN;
 423         chomp $asanConfigurationValue;
 424         $asanIsEnabled = 1 if $asanConfigurationValue eq &quot;YES&quot;;
 425     }
 426 }
 427 
























 428 sub determineLTOMode
 429 {
 430     return if defined $ltoMode;
 431     determineBaseProductDir();
 432 
 433     if (open LTO, &quot;$baseProductDir/LTO&quot;) {
 434         $ltoMode = &lt;LTO&gt;;
 435         close LTO;
 436         chomp $ltoMode;
 437     }
 438 }
 439 
 440 sub determineNumberOfCPUs
 441 {
 442     return if defined $numberOfCPUs;
 443     if (defined($ENV{NUMBER_OF_PROCESSORS})) {
 444         $numberOfCPUs = $ENV{NUMBER_OF_PROCESSORS};
 445     } elsif (isLinux()) {
 446         # First try the nproc utility, if it exists. If we get no
 447         # results fall back to just interpretting /proc directly.
</pre>
<hr />
<pre>
 461 
 462 sub determineMaxCPULoad
 463 {
 464     return if defined $maxCPULoad;
 465     if (defined($ENV{MAX_CPU_LOAD})) {
 466         $maxCPULoad = $ENV{MAX_CPU_LOAD};
 467     }
 468 }
 469 
 470 sub jscPath($)
 471 {
 472     my ($productDir) = @_;
 473     my $jscName = &quot;jsc&quot;;
 474     $jscName .= &quot;_debug&quot;  if configuration() eq &quot;Debug_All&quot;;
 475     if (isPlayStation()) {
 476         $jscName .= &quot;.elf&quot;;
 477     } elsif (isAnyWindows()) {
 478         $jscName .= &quot;.exe&quot;;
 479     }
 480     return &quot;$productDir/$jscName&quot; if -e &quot;$productDir/$jscName&quot;;
<span class="line-modified"> 481     return &quot;$productDir/JavaScriptCore.framework/Resources/$jscName&quot;;</span>
 482 }
 483 
 484 sub argumentsForConfiguration()
 485 {
 486     determineConfiguration();
 487     determineArchitecture();
 488     determineXcodeSDK();
 489 
 490     my @args = ();
 491     # FIXME: Is it necessary to pass --debug, --release, --32-bit or --64-bit?
 492     # These are determined automatically from stored configuration.
 493     push(@args, &#39;--debug&#39;) if ($configuration =~ &quot;^Debug&quot;);
 494     push(@args, &#39;--release&#39;) if ($configuration =~ &quot;^Release&quot;);
 495     push(@args, &#39;--ios-device&#39;) if (defined $xcodeSDK &amp;&amp; $xcodeSDK =~ /^iphoneos/);
 496     push(@args, &#39;--ios-simulator&#39;) if (defined $xcodeSDK &amp;&amp; $xcodeSDK =~ /^iphonesimulator/);
 497     push(@args, &#39;--maccatalyst&#39;) if (defined $xcodeSDK &amp;&amp; $xcodeSDK =~ /^maccatalyst/);
 498     push(@args, &#39;--32-bit&#39;) if ($architecture eq &quot;x86&quot; and !isWin64());
 499     push(@args, &#39;--64-bit&#39;) if (isWin64());

 500     push(@args, &#39;--gtk&#39;) if isGtk();
 501     push(@args, &#39;--java&#39;) if isJava();
 502     push(@args, &#39;--wpe&#39;) if isWPE();
 503     push(@args, &#39;--jsc-only&#39;) if isJSCOnly();
 504     push(@args, &#39;--wincairo&#39;) if isWinCairo();
 505     push(@args, &#39;--playstation&#39;) if isPlayStation();
 506     return @args;
 507 }
 508 
 509 sub extractNonMacOSHostConfiguration
 510 {
 511     my @args = ();
<span class="line-modified"> 512     my @extract = (&#39;--device&#39;, &#39;--gtk&#39;, &#39;--ios&#39;, &#39;--platform&#39;, &#39;--sdk&#39;, &#39;--simulator&#39;, &#39;--wincairo&#39;, &#39;SDKROOT&#39;, &#39;ARCHS&#39;);</span>
 513     foreach (@{$_[0]}) {
 514         my $line = $_;
 515         my $flag = 0;
 516         foreach (@extract) {
 517             if (length($line) &gt;= length($_) &amp;&amp; substr($line, 0, length($_)) eq $_
 518                 &amp;&amp; index($line, &#39;i386&#39;) == -1 &amp;&amp; index($line, &#39;x86_64&#39;) == -1) {
 519                 $flag = 1;
 520             }
 521         }
 522         if (!$flag) {
 523             push @args, $_;
 524         }
 525     }
 526     return @args;
 527 }
 528 
 529 # FIXME: Convert to json &lt;rdar://problem/21594308&gt;
 530 sub parseAvailableXcodeSDKs($)
 531 {
 532     my @outputToParse = @{$_[0]};
</pre>
<hr />
<pre>
 699     chomp($path = `cygpath &quot;$path&quot;`) if isCygwin();
 700 
 701     print &quot;Using MSBuild: $path\n&quot;;
 702     return $path;
 703 }
 704 
 705 sub determineConfigurationForVisualStudio
 706 {
 707     return if defined $configurationForVisualStudio;
 708     determineConfiguration();
 709     # FIXME: We should detect when Debug_All or Production has been chosen.
 710     $configurationForVisualStudio = &quot;/p:Configuration=&quot; . $configuration;
 711 }
 712 
 713 sub usesPerConfigurationBuildDirectory
 714 {
 715     # [Gtk] We don&#39;t have Release/Debug configurations in straight
 716     # autotool builds (non build-webkit). In this case and if
 717     # WEBKIT_OUTPUTDIR exist, use that as our configuration dir. This will
 718     # allows us to run run-webkit-tests without using build-webkit.
<span class="line-modified"> 719     return ($ENV{&quot;WEBKIT_OUTPUTDIR&quot;} &amp;&amp; isGtk()) || isAppleWinWebKit() || isJava();</span>
 720 }
 721 
 722 sub determineConfigurationProductDir
 723 {
 724     return if defined $configurationProductDir;
 725     determineBaseProductDir();
 726     determineConfiguration();
<span class="line-modified"> 727     if (isAppleWinWebKit() || isWinCairo() || isPlayStation()) {</span>
 728         $configurationProductDir = File::Spec-&gt;catdir($baseProductDir, $configuration);
 729     } else {
 730         if (usesPerConfigurationBuildDirectory()) {
 731             $configurationProductDir = &quot;$baseProductDir&quot;;
 732         } else {
 733             $configurationProductDir = &quot;$baseProductDir/$configuration&quot;;
 734             $configurationProductDir .= &quot;-&quot; . xcodeSDKPlatformName() if isEmbeddedWebKit() || isMacCatalystWebKit();
 735         }
 736     }
 737 }
 738 
 739 sub setConfigurationProductDir($)
 740 {
 741     ($configurationProductDir) = @_;
 742 }
 743 
 744 sub determineCurrentSVNRevision
 745 {
 746     # We always update the current SVN revision here, and leave the caching
 747     # to currentSVNRevision(), so that changes to the SVN revision while the
</pre>
<hr />
<pre>
 792     return File::Spec-&gt;catdir($productDirectory, $binaryDirectory);
 793 }
 794 
 795 sub jscProductDir
 796 {
 797     return executableProductDir();
 798 }
 799 
 800 sub configuration()
 801 {
 802     determineConfiguration();
 803     return $configuration;
 804 }
 805 
 806 sub asanIsEnabled()
 807 {
 808     determineASanIsEnabled();
 809     return $asanIsEnabled;
 810 }
 811 






 812 sub ltoMode()
 813 {
 814     determineLTOMode();
 815     return $ltoMode;
 816 }
 817 
 818 sub configurationForVisualStudio()
 819 {
 820     determineConfigurationForVisualStudio();
 821     return $configurationForVisualStudio;
 822 }
 823 
 824 sub currentSVNRevision
 825 {
 826     determineCurrentSVNRevision() if not defined $currentSVNRevision;
 827     return $currentSVNRevision;
 828 }
 829 
 830 sub generateDsym()
 831 {
</pre>
<hr />
<pre>
 840 }
 841 
 842 sub hasIOSDevelopmentCertificate()
 843 {
 844     return !exitStatus(system(&quot;security find-identity -p codesigning | grep &#39;&quot; . IOS_DEVELOPMENT_CERTIFICATE_NAME_PREFIX . &quot;&#39; &gt; /dev/null 2&gt;&amp;1&quot;));
 845 }
 846 
 847 sub argumentsForXcode()
 848 {
 849     my @args = ();
 850     push @args, &quot;DEBUG_INFORMATION_FORMAT=dwarf-with-dsym&quot; if generateDsym();
 851     return @args;
 852 }
 853 
 854 sub XcodeOptions
 855 {
 856     determineBaseProductDir();
 857     determineConfiguration();
 858     determineArchitecture();
 859     determineASanIsEnabled();


 860     determineLTOMode();
 861     determineXcodeSDK();
 862 
 863     my @options;
 864     push @options, &quot;-UseSanitizedBuildSystemEnvironment=YES&quot;;
 865     push @options, &quot;-ShowBuildOperationDuration=YES&quot;;
 866     push @options, (&quot;-configuration&quot;, $configuration);
 867     push @options, (&quot;-xcconfig&quot;, sourceDir() . &quot;/Tools/asan/asan.xcconfig&quot;, &quot;ASAN_IGNORE=&quot; . sourceDir() . &quot;/Tools/asan/webkit-asan-ignore.txt&quot;) if $asanIsEnabled;


 868     push @options, &quot;WK_LTO_MODE=$ltoMode&quot; if $ltoMode;
 869     push @options, @baseProductDirOption;
 870     push @options, &quot;ARCHS=$architecture&quot; if $architecture;
 871     push @options, &quot;SDKROOT=$xcodeSDK&quot; if $xcodeSDK;
<span class="line-modified"> 872     if (willUseIOSDeviceSDK()) {</span>








 873         push @options, &quot;ENABLE_BITCODE=NO&quot;;
 874         if (hasIOSDevelopmentCertificate()) {
 875             # FIXME: May match more than one installed development certificate.
 876             push @options, &quot;CODE_SIGN_IDENTITY=&quot; . IOS_DEVELOPMENT_CERTIFICATE_NAME_PREFIX;
 877         } else {
 878             push @options, &quot;CODE_SIGN_IDENTITY=&quot;; # No identity
 879             push @options, &quot;CODE_SIGNING_REQUIRED=NO&quot;;
 880         }
 881     }
 882     push @options, argumentsForXcode();
 883     return @options;
 884 }
 885 
 886 sub XcodeOptionString
 887 {
 888     return join &quot; &quot;, XcodeOptions();
 889 }
 890 
 891 sub XcodeOptionStringNoConfig
 892 {
</pre>
<hr />
<pre>
 912     #     return $1 &gt;= 11;
 913     # }
 914 
 915     return 0;
 916 }
 917 
 918 my $passedConfiguration;
 919 my $searchedForPassedConfiguration;
 920 sub determinePassedConfiguration
 921 {
 922     return if $searchedForPassedConfiguration;
 923     $searchedForPassedConfiguration = 1;
 924     $passedConfiguration = undef;
 925 
 926     if (checkForArgumentAndRemoveFromARGV(&quot;--debug&quot;)) {
 927         $passedConfiguration = &quot;Debug&quot;;
 928     } elsif(checkForArgumentAndRemoveFromARGV(&quot;--release&quot;)) {
 929         $passedConfiguration = &quot;Release&quot;;
 930     } elsif (checkForArgumentAndRemoveFromARGV(&quot;--profile&quot;) || checkForArgumentAndRemoveFromARGV(&quot;--profiling&quot;)) {
 931         $passedConfiguration = &quot;Profiling&quot;;




 932     }
 933 }
 934 
 935 sub passedConfiguration
 936 {
 937     determinePassedConfiguration();
 938     return $passedConfiguration;
 939 }
 940 
 941 sub setConfiguration
 942 {
 943     setArchitecture();
 944 
 945     if (my $config = shift @_) {
 946         $configuration = $config;
 947         return;
 948     }
 949 
 950     determinePassedConfiguration();
 951     $configuration = $passedConfiguration if $passedConfiguration;
</pre>
<hr />
<pre>
1033 
1034     die &quot;Can&#39;t find executable at $safariPath.\n&quot; if !-x $safariPath;
1035     return $safariPath;
1036 }
1037 
1038 sub builtDylibPathForName
1039 {
1040     my $libraryName = shift;
1041     determineConfigurationProductDir();
1042 
1043     if (isGtk()) {
1044         my $extension = isDarwin() ? &quot;.dylib&quot; : &quot;.so&quot;;
1045         return &quot;$configurationProductDir/lib/libwebkit2gtk-4.0&quot; . $extension;
1046     }
1047     if (isIOSWebKit()) {
1048         return &quot;$configurationProductDir/$libraryName.framework/$libraryName&quot;;
1049     }
1050     if (isAppleCocoaWebKit()) {
1051         return &quot;$configurationProductDir/$libraryName.framework/Versions/A/$libraryName&quot;;
1052     }
<span class="line-modified">1053     if (isAppleWinWebKit()) {</span>
1054         if ($libraryName eq &quot;JavaScriptCore&quot;) {
1055             return &quot;$baseProductDir/lib/$libraryName.lib&quot;;
1056         } else {
1057             return &quot;$baseProductDir/$libraryName.intermediate/$configuration/$libraryName.intermediate/$libraryName.lib&quot;;
1058         }
1059     }
1060     if (isJava()) {
1061         my $extension = isDarwin() ? &quot;.dylib&quot; : &quot;.so&quot;;
1062         return &quot;$configurationProductDir/lib/libjfxwebkit&quot; . $extension;
1063     }
1064     if (isWPE()) {
1065         return &quot;$configurationProductDir/lib/libWPEWebKit-1.0.so&quot;;
1066     }
1067 
1068     die &quot;Unsupported platform, can&#39;t determine built library locations.\nTry `build-webkit --help` for more information.\n&quot;;
1069 }
1070 
1071 # Check to see that all the frameworks are built.
1072 sub checkFrameworks # FIXME: This is a poor name since only the Mac calls built WebCore a Framework.
1073 {
</pre>
<hr />
<pre>
1159 {
1160     my ($argToCheck, $arrayRef) = @_;
1161     my @indicesToRemove = findMatchingArguments($argToCheck, $arrayRef);
1162     my $removeOffset = 0;
1163     foreach my $index (@indicesToRemove) {
1164         splice(@$arrayRef, $index - $removeOffset++, 1);
1165     }
1166     return scalar @indicesToRemove &gt; 0;
1167 }
1168 
1169 sub prohibitUnknownPort()
1170 {
1171     $unknownPortProhibited = 1;
1172 }
1173 
1174 sub determinePortName()
1175 {
1176     return if defined $portName;
1177 
1178     my %argToPortName = (

1179         gtk =&gt; GTK,
1180         &#39;jsc-only&#39; =&gt; JSCOnly,
1181         playstation =&gt; PlayStation,
1182         wincairo =&gt; WinCairo,
1183         java =&gt; Java,
1184         wpe =&gt; WPE
1185     );
1186 
1187     for my $arg (sort keys %argToPortName) {
1188         if (checkForArgumentAndRemoveFromARGV(&quot;--$arg&quot;)) {
1189             die &quot;Argument &#39;--$arg&#39; conflicts with selected port &#39;$portName&#39;\n&quot;
1190                 if defined $portName;
1191 
1192             $portName = $argToPortName{$arg};
1193         }
1194     }
1195 
1196     return if defined $portName;
1197 
1198     # Port was not selected via command line, use appropriate default value
</pre>
<hr />
<pre>
1260 {
1261     return portName() eq WPE;
1262 }
1263 
1264 sub isPlayStation()
1265 {
1266     return portName() eq PlayStation;
1267 }
1268 
1269 # Determine if this is debian, ubuntu, linspire, or something similar.
1270 sub isDebianBased()
1271 {
1272     return -e &quot;/etc/debian_version&quot;;
1273 }
1274 
1275 sub isFedoraBased()
1276 {
1277     return -e &quot;/etc/fedora-release&quot;;
1278 }
1279 





1280 sub isWinCairo()
1281 {
1282     return portName() eq WinCairo;
1283 }
1284 
1285 sub shouldBuild32Bit()
1286 {
1287     determineShouldBuild32Bit();
1288     return $shouldBuild32Bit;
1289 }
1290 
1291 sub determineShouldBuild32Bit()
1292 {
1293     return if defined($shouldBuild32Bit);
1294     $shouldBuild32Bit = checkForArgumentAndRemoveFromARGV(&quot;--32-bit&quot;);
1295 }
1296 
1297 sub isWin64()
1298 {
1299     determineIsWin64();
1300     return $isWin64;
1301 }
1302 
1303 sub determineIsWin64()
1304 {
1305     return if defined($isWin64);
<span class="line-modified">1306     $isWin64 = checkForArgumentAndRemoveFromARGV(&quot;--64-bit&quot;) || ((isWinCairo() || isJSCOnly()) &amp;&amp; !shouldBuild32Bit());</span>
1307 }
1308 
1309 sub determineIsWin64FromArchitecture($)
1310 {
1311     my $arch = shift;
1312     $isWin64 = ($arch eq &quot;x86_64&quot;);
1313     return $isWin64;
1314 }
1315 
1316 sub isCygwin()
1317 {
1318     return ($^O eq &quot;cygwin&quot;) || 0;
1319 }
1320 
1321 sub isAnyWindows()
1322 {
1323     return isWindows() || isCygwin();
1324 }
1325 
1326 sub determineWinVersion()
</pre>
<hr />
<pre>
1384 }
1385 
1386 sub isX86_64()
1387 {
1388     return (architecture() eq &quot;x86_64&quot;) || 0;
1389 }
1390 
1391 sub isARM64()
1392 {
1393     return (architecture() eq &quot;arm64&quot;) || 0;
1394 }
1395 
1396 sub isCrossCompilation()
1397 {
1398     my $compiler = &quot;&quot;;
1399     $compiler = $ENV{&#39;CC&#39;} if (defined($ENV{&#39;CC&#39;}));
1400     if ($compiler =~ /gcc/) {
1401         my $compilerOptions = `$compiler -v 2&gt;&amp;1`;
1402         my @host = $compilerOptions =~ m/--host=(.*?)\s/;
1403         my @target = $compilerOptions =~ m/--target=(.*?)\s/;
<span class="line-modified">1404         if ($target[0] ne &quot;&quot; &amp;&amp; $host[0] ne &quot;&quot;) {</span>





1405                 return ($host[0] ne $target[0]);
1406         } else {
1407                 # $tempDir gets automatically deleted when goes out of scope
1408                 my $tempDir = File::Temp-&gt;newdir();
1409                 my $testProgramSourcePath = File::Spec-&gt;catfile($tempDir, &quot;testcross.c&quot;);
1410                 my $testProgramBinaryPath = File::Spec-&gt;catfile($tempDir, &quot;testcross&quot;);
1411                 open(my $testProgramSourceHandler, &quot;&gt;&quot;, $testProgramSourcePath);
1412                 print $testProgramSourceHandler &quot;int main() { return 0; }\n&quot;;
1413                 system(&quot;$compiler $testProgramSourcePath -o $testProgramBinaryPath &gt; /dev/null 2&gt;&amp;1&quot;) == 0 or return 0;
1414                 # Crosscompiling if the program fails to run (because it was built for other arch)
1415                 system(&quot;$testProgramBinaryPath &gt; /dev/null 2&gt;&amp;1&quot;) == 0 or return 1;
1416                 return 0;
1417         }
1418     }
1419     return 0;
1420 }
1421 
1422 sub isIOSWebKit()
1423 {
1424     return portName() eq iOS;
</pre>
<hr />
<pre>
1552     return if $nmPath;
1553 
1554     if (isAppleCocoaWebKit()) {
1555         $nmPath = `xcrun -find nm`;
1556         chomp $nmPath;
1557     }
1558     $nmPath = &quot;nm&quot; if !$nmPath;
1559 }
1560 
1561 sub nmPath()
1562 {
1563     determineNmPath();
1564     return $nmPath;
1565 }
1566 
1567 sub splitVersionString
1568 {
1569     my $versionString = shift;
1570     my @splitVersion = split(/\./, $versionString);
1571     @splitVersion &gt;= 2 or die &quot;Invalid version $versionString&quot;;
<span class="line-modified">1572     $osXVersion = {</span>
<span class="line-modified">1573             &quot;major&quot; =&gt; $splitVersion[0],</span>
<span class="line-modified">1574             &quot;minor&quot; =&gt; $splitVersion[1],</span>
<span class="line-modified">1575             &quot;subminor&quot; =&gt; (defined($splitVersion[2]) ? $splitVersion[2] : 0),</span>
1576     };
1577 }
1578 
1579 sub determineOSXVersion()
1580 {
1581     return if $osXVersion;
1582 
1583     if (!isDarwin()) {
1584         $osXVersion = -1;
1585         return;
1586     }
1587 
<span class="line-modified">1588     my $versionString = `sw_vers -productVersion`;</span>
1589     $osXVersion = splitVersionString($versionString);
1590 }
1591 
1592 sub osXVersion()
1593 {
1594     determineOSXVersion();
1595     return $osXVersion;
1596 }
1597 
1598 sub determineIOSVersion()
1599 {
1600     return if $iosVersion;
1601 
1602     if (!isIOSWebKit()) {
1603         $iosVersion = -1;
1604         return;
1605     }
1606 
1607     my $versionString = xcodeSDKVersion();
1608     $iosVersion = splitVersionString($versionString);
</pre>
<hr />
<pre>
1696 
1697 sub launcherPath()
1698 {
1699     my $relativeScriptsPath = relativeScriptsDir();
1700     if (isGtk() || isWPE()) {
1701         if (inFlatpakSandbox()) {
1702             return &quot;Tools/Scripts/run-minibrowser&quot;;
1703         }
1704         return &quot;$relativeScriptsPath/run-minibrowser&quot;;
1705     } elsif (isAppleWebKit()) {
1706         return &quot;$relativeScriptsPath/run-safari&quot;;
1707     }
1708 }
1709 
1710 sub launcherName()
1711 {
1712     if (isGtk() || isWPE()) {
1713         return &quot;MiniBrowser&quot;;
1714     } elsif (isAppleMacWebKit()) {
1715         return &quot;Safari&quot;;
<span class="line-modified">1716     } elsif (isAppleWinWebKit()) {</span>
1717         return &quot;MiniBrowser&quot;;
1718     }
1719 }
1720 
1721 sub checkRequiredSystemConfig
1722 {
1723     if (isDarwin()) {
1724         chomp(my $productVersion = `sw_vers -productVersion`);
1725         if (eval &quot;v$productVersion&quot; lt v10.10.5) {
1726             print &quot;*************************************************************\n&quot;;
1727             print &quot;OS X Yosemite v10.10.5 or later is required to build WebKit.\n&quot;;
1728             print &quot;You have &quot; . $productVersion . &quot;, thus the build will most likely fail.\n&quot;;
1729             print &quot;*************************************************************\n&quot;;
1730         }
1731         determineXcodeVersion();
1732         if (eval &quot;v$xcodeVersion&quot; lt v7.0) {
1733             print &quot;*************************************************************\n&quot;;
1734             print &quot;Xcode 7.0 or later is required to build WebKit.\n&quot;;
1735             print &quot;You have an earlier version of Xcode, thus the build will\n&quot;;
1736             print &quot;most likely fail. The latest Xcode is available from the App Store.\n&quot;;
</pre>
<hr />
<pre>
1799     my @missing = ();
1800     foreach my $font (@fonts) {
1801         push @missing, $font if not fontExists($font);
1802     }
1803 
1804     if (scalar @missing &gt; 0) {
1805         print &quot;*************************************************************\n&quot;;
1806         print &quot;Mathematical fonts, such as Latin Modern Math are needed to\n&quot;;
1807         print &quot;use the MathML feature.  You do not appear to have these fonts\n&quot;;
1808         print &quot;on your system.\n\n&quot;;
1809         print &quot;You can download a suitable set of fonts from the following URL:\n&quot;;
1810         print &quot;https://trac.webkit.org/wiki/MathML/Fonts\n&quot;;
1811         print &quot;*************************************************************\n&quot;;
1812     }
1813 
1814     print &quot;Installed tools are correct for the WebKit build.\n&quot;;
1815 }
1816 
1817 sub setupAppleWinEnv()
1818 {
<span class="line-modified">1819     return unless isAppleWinWebKit();</span>
1820 
1821     checkInstalledTools();
1822 
1823     if (isWindowsNT()) {
1824         my $restartNeeded = 0;
1825         my %variablesToSet = ();
1826 
1827         # FIXME: We should remove this explicit version check for cygwin once we stop supporting Cygwin 1.7.9 or older versions. 
1828         # https://bugs.webkit.org/show_bug.cgi?id=85791
1829         my $uname_version = (POSIX::uname())[2];
1830         $uname_version =~ s/\(.*\)//;  # Remove the trailing cygwin version, if any.
1831         $uname_version =~ s/\-.*$//; # Remove trailing dash-version content, if any
1832         if (version-&gt;parse($uname_version) &lt; version-&gt;parse(&quot;1.7.10&quot;)) {
1833             # Setting the environment variable &#39;CYGWIN&#39; to &#39;tty&#39; makes cygwin enable extra support (i.e., termios)
1834             # for UNIX-like ttys in the Windows console
1835             $variablesToSet{CYGWIN} = &quot;tty&quot; unless $ENV{CYGWIN};
1836         }
1837         
1838         # Those environment variables must be set to be able to build inside Visual Studio.
1839         $variablesToSet{WEBKIT_LIBRARIES} = windowsLibrariesDir() unless $ENV{WEBKIT_LIBRARIES};
</pre>
<hr />
<pre>
1896     if (! -e $msBuildPath) {
1897         print &quot;*************************************************************\n&quot;;
1898         print &quot;Cannot find &#39;$msBuildPath&#39;\n&quot;;
1899         print &quot;Please make sure execute that the Microsoft .NET Framework SDK\n&quot;;
1900         print &quot;is installed on this machine.\n&quot;;
1901         print &quot;*************************************************************\n&quot;;
1902         die;
1903     }
1904 }
1905 
1906 sub buildXCodeProject($$@)
1907 {
1908     my ($project, $clean, @extraOptions) = @_;
1909 
1910     if ($clean) {
1911         push(@extraOptions, &quot;-alltargets&quot;);
1912         push(@extraOptions, &quot;clean&quot;);
1913     }
1914 
1915     chomp($ENV{DSYMUTIL_NUM_THREADS} = `sysctl -n hw.activecpu`);












1916     return system &quot;xcodebuild&quot;, &quot;-project&quot;, &quot;$project.xcodeproj&quot;, @extraOptions;
1917 }
1918 
1919 sub getVisualStudioToolset()
1920 {
1921     if (isPlayStation()) {
1922         return &quot;&quot;;
1923     } elsif (isWin64()) {
1924         return &quot;x64&quot;;
1925     } else {
1926         return &quot;Win32&quot;;
1927     }
1928 }
1929 
1930 sub getMSBuildPlatformArgument()
1931 {
1932     my $toolset = getVisualStudioToolset();
1933     if (defined($toolset) &amp;&amp; length($toolset)) {
1934         return &quot;/p:Platform=$toolset&quot;;
1935     }
</pre>
<hr />
<pre>
2214     return commandExists(&quot;ninja&quot;) || commandExists(&quot;ninja-build&quot;);
2215 }
2216 
2217 sub canUseEclipseNinjaGenerator(@)
2218 {
2219     # Check that eclipse and eclipse Ninja generator is installed
2220     my $devnull = File::Spec-&gt;devnull();
2221     return commandExists(&quot;eclipse&quot;) &amp;&amp; exitStatus(system(&quot;cmake -N -G &#39;Eclipse CDT4 - Ninja&#39; &gt;$devnull 2&gt;&amp;1&quot;)) == 0;
2222 }
2223 
2224 sub cmakeGeneratedBuildfile(@)
2225 {
2226     my ($willUseNinja) = @_;
2227     if ($willUseNinja) {
2228         return File::Spec-&gt;catfile(baseProductDir(), configuration(), &quot;build.ninja&quot;)
2229     } elsif (isAnyWindows()) {
2230         return File::Spec-&gt;catfile(baseProductDir(), configuration(), &quot;WebKit.sln&quot;)
2231     } else {
2232         return File::Spec-&gt;catfile(baseProductDir(), configuration(), &quot;Makefile&quot;)
2233     }

2234 }
2235 
2236 sub generateBuildSystemFromCMakeProject
2237 {
2238     my ($prefixPath, @cmakeArgs) = @_;
2239     my $config = configuration();
2240     my $port = cmakeBasedPortName();
2241     my $buildPath = File::Spec-&gt;catdir(baseProductDir(), $config);
2242     File::Path::mkpath($buildPath) unless -d $buildPath;
2243     my $originalWorkingDirectory = getcwd();
2244     chdir($buildPath) or die;
2245 
2246     # We try to be smart about when to rerun cmake, so that we can have faster incremental builds.
2247     my $willUseNinja = canUseNinja();
2248     if (-e cmakeCachePath() &amp;&amp; -e cmakeGeneratedBuildfile($willUseNinja)) {
2249         return 0;
2250     }
2251 
2252     my @args;
2253     push @args, &quot;-DPORT=\&quot;$port\&quot;&quot;;
</pre>
<hr />
<pre>
2278         if (isWin64()) {
2279             push @args, &#39;&quot;Visual Studio 15 2017 Win64&quot;&#39;;
2280             push @args, &#39;-DCMAKE_GENERATOR_TOOLSET=&quot;host=x64&quot;&#39;;
2281         } else {
2282             push @args, &#39;&quot;Visual Studio 15 2017&quot;&#39;;
2283         }
2284     } else {
2285         if (isAnyWindows()) {
2286             push @args, getCMakeWindowsToolsetArgument();
2287         }
2288         if ((isAnyWindows() || isPlayStation()) &amp;&amp; defined $ENV{VisualStudioVersion}) {
2289             my $var = int($ENV{VisualStudioVersion});
2290             push @args, qq(-G &quot;Visual Studio $var&quot;);
2291         }
2292     }
2293 
2294     # Do not show progress of generating bindings in interactive Ninja build not to leave noisy lines on tty
2295     push @args, &#39;-DSHOW_BINDINGS_GENERATION_PROGRESS=1&#39; unless ($willUseNinja &amp;&amp; -t STDOUT);
2296 
2297     # Some ports have production mode, but build-webkit should always use developer mode.
<span class="line-modified">2298     push @args, &quot;-DDEVELOPER_MODE=ON&quot; if isGtk() || isJSCOnly() || isWPE() || isWinCairo();</span>
2299 
2300     if (architecture() eq &quot;x86_64&quot; &amp;&amp; shouldBuild32Bit() &amp;&amp; !(isJava() &amp;&amp; isCygwin())) {
2301         # CMAKE_LIBRARY_ARCHITECTURE is needed to get the right .pc
2302         # files in Debian-based systems, for the others
2303         # CMAKE_PREFIX_PATH will get us /usr/lib, which should be the
2304         # right path for 32bit. See FindPkgConfig.cmake.
2305         push @cmakeArgs, &#39;-DFORCE_32BIT=ON -DCMAKE_PREFIX_PATH=&quot;/usr&quot; -DCMAKE_LIBRARY_ARCHITECTURE=x86&#39;;
2306         $ENV{&quot;CFLAGS&quot;} =  &quot;-m32&quot; . ($ENV{&quot;CFLAGS&quot;} || &quot;&quot;);
2307         $ENV{&quot;CXXFLAGS&quot;} = &quot;-m32&quot; . ($ENV{&quot;CXXFLAGS&quot;} || &quot;&quot;);
2308         $ENV{&quot;LDFLAGS&quot;} = &quot;-m32&quot; . ($ENV{&quot;LDFLAGS&quot;} || &quot;&quot;);
2309     }
2310     push @args, @cmakeArgs if @cmakeArgs;
2311 
2312     my $cmakeSourceDir = isCygwin() ? windowsSourceDir() : sourceDir();
2313     push @args, &#39;&quot;&#39; . $cmakeSourceDir . &#39;&quot;&#39;;
2314 
2315     # We call system(&quot;cmake @args&quot;) instead of system(&quot;cmake&quot;, @args) so that @args is
2316     # parsed for shell metacharacters.
2317     my $wrapper = join(&quot; &quot;, wrapperPrefixIfNeeded()) . &quot; &quot;;
2318     my $returnCode = systemVerbose($wrapper . &quot;cmake @args&quot;);
2319 
2320     chdir($originalWorkingDirectory);
2321     return $returnCode;
2322 }
2323 
2324 sub buildCMakeGeneratedProject($)
2325 {
2326     my (@makeArgs) = @_;
2327     my $config = configuration();
2328     my $buildPath = File::Spec-&gt;catdir(baseProductDir(), $config);
2329     if (! -d $buildPath) {
2330         die &quot;Must call generateBuildSystemFromCMakeProject() before building CMake project.&quot;;
2331     }
2332 
2333     if ($ENV{VERBOSE} &amp;&amp; canUseNinja()) {
2334         push @makeArgs, &quot;-v&quot;;
2335         push @makeArgs, &quot;-d keeprsp&quot; if (version-&gt;parse(determineNinjaVersion()) &gt;= version-&gt;parse(&quot;1.4.0&quot;));
2336     }
2337 


2338     my $command = &quot;cmake&quot;;
2339     my @args = (&quot;--build&quot;, $buildPath, &quot;--config&quot;, $config);
2340     push @args, (&quot;--&quot;, @makeArgs) if @makeArgs;
2341 
2342     # GTK and JSCOnly can use a build script to preserve colors and pretty-printing.
2343     if ((isGtk() || isJSCOnly()) &amp;&amp; -e &quot;$buildPath/build.sh&quot;) {
2344         chdir &quot;$buildPath&quot; or die;
2345         $command = &quot;$buildPath/build.sh&quot;;
2346         @args = (@makeArgs);
2347     }
2348 
2349     # We call system(&quot;cmake @args&quot;) instead of system(&quot;cmake&quot;, @args) so that @args is
2350     # parsed for shell metacharacters. In particular, @makeArgs may contain such metacharacters.
2351     my $wrapper = join(&quot; &quot;, wrapperPrefixIfNeeded()) . &quot; &quot;;
2352     return systemVerbose($wrapper . &quot;$command @args&quot;);
2353 }
2354 
2355 sub cleanCMakeGeneratedProject()
2356 {
2357     my $config = configuration();
</pre>
<hr />
<pre>
2445 }
2446 
2447 sub appleApplicationSupportPath
2448 {
2449     open INSTALL_DIR, &quot;&lt;/proc/registry/HKEY_LOCAL_MACHINE/SOFTWARE/Apple\ Inc./Apple\ Application\ Support/InstallDir&quot;;
2450     my $path = &lt;INSTALL_DIR&gt;;
2451     $path =~ s/[\r\n\x00].*//;
2452     close INSTALL_DIR;
2453 
2454     my $unixPath = `cygpath -u &#39;$path&#39;`;
2455     chomp $unixPath;
2456     return $unixPath;
2457 }
2458 
2459 sub setPathForRunningWebKitApp
2460 {
2461     my ($env) = @_;
2462 
2463     if (isAnyWindows()) {
2464         my $productBinaryDir = executableProductDir();
<span class="line-modified">2465         if (isAppleWinWebKit()) {</span>
2466             $env-&gt;{PATH} = join(&#39;:&#39;, $productBinaryDir, appleApplicationSupportPath(), $env-&gt;{PATH} || &quot;&quot;);
2467         } elsif (isWinCairo()) {
2468             my $winCairoBin = sourceDir() . &quot;/WebKitLibraries/win/&quot; . (isWin64() ? &quot;bin64/&quot; : &quot;bin32/&quot;);
2469             my $gstreamerBin = isWin64() ? $ENV{&quot;GSTREAMER_1_0_ROOT_X86_64&quot;} . &quot;bin&quot; : $ENV{&quot;GSTREAMER_1_0_ROOT_X86&quot;} . &quot;bin&quot;;
2470             $env-&gt;{PATH} = join(&#39;:&#39;, $productBinaryDir, $winCairoBin, $gstreamerBin, $env-&gt;{PATH} || &quot;&quot;);
2471         }
2472     }
2473 }
2474 
2475 sub printHelpAndExitForRunAndDebugWebKitAppIfNeeded
2476 {
2477     return unless checkForArgumentAndRemoveFromARGV(&quot;--help&quot;);
2478 
2479     print STDERR &lt;&lt;EOF;
2480 Usage: @{[basename($0)]} [options] [args ...]
2481   --help                            Show this help message
2482   --no-saved-state                  Launch the application without state restoration
2483 
2484 Options specific to macOS:
2485   -g|--guard-malloc                 Enable Guard Malloc
2486   --lang=LANGUAGE                   Use a specific language instead of system language.
2487                                     This accepts a language name (German) or a language code (de, ar, pt_BR, etc).
2488   --locale=LOCALE                   Use a specific locale instead of the system region.
2489 EOF
2490 
2491     exit(1);
2492 }
2493 
2494 sub argumentsForRunAndDebugMacWebKitApp()
2495 {
2496     my @args = ();
2497     if (checkForArgumentAndRemoveFromARGV(&quot;--no-saved-state&quot;)) {
2498         push @args, (&quot;-ApplePersistenceIgnoreStateQuietly&quot;, &quot;YES&quot;);
<span class="line-removed">2499         # FIXME: Don&#39;t set ApplePersistenceIgnoreState once all supported OS versions respect ApplePersistenceIgnoreStateQuietly (rdar://15032886).</span>
<span class="line-removed">2500         push @args, (&quot;-ApplePersistenceIgnoreState&quot;, &quot;YES&quot;);</span>
2501     }
2502 
2503     my $lang;
2504     if (checkForArgumentAndRemoveFromARGVGettingValue(&quot;--lang&quot;, \$lang)) {
2505         push @args, (&quot;-AppleLanguages&quot;, &quot;(&quot; . $lang . &quot;)&quot;);
2506     }
2507 
2508     my $locale;
2509     if (checkForArgumentAndRemoveFromARGVGettingValue(&quot;--locale&quot;, \$locale)) {
2510         push @args, (&quot;-AppleLocale&quot;, $locale);
2511     }
2512 
2513     unshift @args, @ARGV;
2514 
2515     return @args;
2516 }
2517 
2518 sub setupMacWebKitEnvironment($)
2519 {
2520     my ($dyldFrameworkPath) = @_;
</pre>
<hr />
<pre>
2535     my ($productDir) = @_;
2536 
2537     $ENV{TEST_RUNNER_INJECTED_BUNDLE_FILENAME} = File::Spec-&gt;catfile($productDir, &quot;lib&quot;, &quot;libTestRunnerInjectedBundle.so&quot;);
2538     $ENV{TEST_RUNNER_TEST_PLUGIN_PATH} = File::Spec-&gt;catdir($productDir, &quot;lib&quot;, &quot;plugins&quot;);
2539 }
2540 
2541 sub setupIOSWebKitEnvironment($)
2542 {
2543     my ($dyldFrameworkPath) = @_;
2544     $dyldFrameworkPath = File::Spec-&gt;rel2abs($dyldFrameworkPath);
2545 
2546     prependToEnvironmentVariableList(&quot;DYLD_FRAMEWORK_PATH&quot;, $dyldFrameworkPath);
2547     prependToEnvironmentVariableList(&quot;DYLD_LIBRARY_PATH&quot;, $dyldFrameworkPath);
2548 
2549     setUpGuardMallocIfNeeded();
2550 }
2551 
2552 sub iosSimulatorApplicationsPath()
2553 {
2554     # FIXME: We should ask simctl for this information, instead of guessing from available runtimes.
<span class="line-modified">2555     my $runtimePath = File::Spec-&gt;catdir(sdkPlatformDirectory(&quot;iphoneos&quot;), &quot;Developer&quot;, &quot;Library&quot;, &quot;CoreSimulator&quot;, &quot;Profiles&quot;, &quot;Runtimes&quot;);</span>
2556     opendir(RUNTIMES, $runtimePath);
2557     my @runtimes = grep {/.*\.simruntime/} readdir(RUNTIMES);
2558     close(RUNTIMES);
2559     my $sult = File::Spec-&gt;catdir($runtimePath, @runtimes ? $runtimes[0] : &quot;iOS.simruntime&quot;, &quot;Contents&quot;, &quot;Resources&quot;, &quot;RuntimeRoot&quot;, &quot;Applications&quot;);
2560     return $sult;
2561 }
2562 
2563 sub installedMobileSafariBundle()
2564 {
2565     return File::Spec-&gt;catfile(iosSimulatorApplicationsPath(), &quot;MobileSafari.app&quot;);
2566 }
2567 
2568 sub mobileSafariBundle()
2569 {
2570     determineConfigurationProductDir();
2571 
2572     # Use MobileSafari.app in product directory if present.
2573     if (isIOSWebKit() &amp;&amp; -d &quot;$configurationProductDir/MobileSafari.app&quot;) {
2574         return &quot;$configurationProductDir/MobileSafari.app&quot;;
2575     }
</pre>
<hr />
<pre>
2902 sub debugSafari
2903 {
2904     if (isAppleMacWebKit()) {
2905         checkFrameworks();
2906         execMacWebKitAppForDebugging(safariPath());
2907     }
2908 
2909     return 1; # Unsupported platform; can&#39;t debug Safari on this platform.
2910 }
2911 
2912 sub runSafari
2913 {
2914     if (isIOSWebKit()) {
2915         return runIOSWebKitApp(mobileSafariBundle());
2916     }
2917 
2918     if (isAppleMacWebKit()) {
2919         return runMacWebKitApp(safariPath());
2920     }
2921 
<span class="line-modified">2922     if (isAppleWinWebKit()) {</span>
2923         my $result;
2924         my $webKitLauncherPath = File::Spec-&gt;catfile(executableProductDir(), &quot;MiniBrowser.exe&quot;);
2925         return system { $webKitLauncherPath } $webKitLauncherPath, @ARGV;
2926     }
2927 
2928     return 1; # Unsupported platform; can&#39;t run Safari on this platform.
2929 }
2930 
2931 sub runMiniBrowser
2932 {
2933     if (isAppleMacWebKit()) {
2934         return runMacWebKitApp(File::Spec-&gt;catfile(productDir(), &quot;MiniBrowser.app&quot;, &quot;Contents&quot;, &quot;MacOS&quot;, &quot;MiniBrowser&quot;));
2935     }
<span class="line-modified">2936     if (isAppleWinWebKit()) {</span>
2937         my $webKitLauncherPath = File::Spec-&gt;catfile(executableProductDir(), &quot;MiniBrowser.exe&quot;);
2938         return system { $webKitLauncherPath } $webKitLauncherPath, @ARGV;
2939     }
2940     return 1;
2941 }
2942 
2943 sub debugMiniBrowser
2944 {
2945     if (isAppleMacWebKit()) {
2946         execMacWebKitAppForDebugging(File::Spec-&gt;catfile(productDir(), &quot;MiniBrowser.app&quot;, &quot;Contents&quot;, &quot;MacOS&quot;, &quot;MiniBrowser&quot;));
2947     }
2948     
2949     return 1;
2950 }
2951 
2952 sub runWebKitTestRunner
2953 {
2954     if (isAppleMacWebKit()) {
2955         return runMacWebKitApp(File::Spec-&gt;catfile(productDir(), &quot;WebKitTestRunner&quot;));
2956     }
</pre>
</td>
<td>
<hr />
<pre>
<span class="line-modified">   1 # Copyright (C) 2005-2019 Apple Inc. All rights reserved.</span>
   2 # Copyright (C) 2009 Google Inc. All rights reserved.
   3 # Copyright (C) 2011 Research In Motion Limited. All rights reserved.
   4 # Copyright (C) 2013 Nokia Corporation and/or its subsidiary(-ies).
   5 #
   6 # Redistribution and use in source and binary forms, with or without
   7 # modification, are permitted provided that the following conditions
   8 # are met:
   9 #
  10 # 1.  Redistributions of source code must retain the above copyright
  11 #     notice, this list of conditions and the following disclaimer. 
  12 # 2.  Redistributions in binary form must reproduce the above copyright
  13 #     notice, this list of conditions and the following disclaimer in the
  14 #     documentation and/or other materials provided with the distribution. 
  15 # 3.  Neither the name of Apple Inc. (&quot;Apple&quot;) nor the names of
  16 #     its contributors may be used to endorse or promote products derived
  17 #     from this software without specific prior written permission. 
  18 #
  19 # THIS SOFTWARE IS PROVIDED BY APPLE AND ITS CONTRIBUTORS &quot;AS IS&quot; AND ANY
  20 # EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
  21 # WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
</pre>
<hr />
<pre>
  88        &amp;sdkPlatformDirectory
  89        &amp;setConfiguration
  90        &amp;setupMacWebKitEnvironment
  91        &amp;setupUnixWebKitEnvironment
  92        &amp;sharedCommandLineOptions
  93        &amp;sharedCommandLineOptionsUsage
  94        &amp;shutDownIOSSimulatorDevice
  95        &amp;willUseIOSDeviceSDK
  96        &amp;willUseIOSSimulatorSDK
  97        DO_NOT_USE_OPEN_COMMAND
  98        SIMULATOR_DEVICE_SUFFIX_FOR_WEBKIT_DEVELOPMENT
  99        USE_OPEN_COMMAND
 100    );
 101    %EXPORT_TAGS = ( );
 102    @EXPORT_OK   = ();
 103 }
 104 
 105 # Ports
 106 use constant {
 107     AppleWin    =&gt; &quot;AppleWin&quot;,
<span class="line-added"> 108     FTW         =&gt; &quot;FTW&quot;,</span>
 109     GTK         =&gt; &quot;GTK&quot;,
 110     iOS         =&gt; &quot;iOS&quot;,
 111     tvOS        =&gt; &quot;tvOS&quot;,
 112     watchOS     =&gt; &quot;watchOS&quot;,
 113     Mac         =&gt; &quot;Mac&quot;,
 114     MacCatalyst =&gt; &quot;MacCatalyst&quot;,
 115     JSCOnly     =&gt; &quot;JSCOnly&quot;,
 116     PlayStation =&gt; &quot;PlayStation&quot;,
 117     WinCairo    =&gt; &quot;WinCairo&quot;,
 118     Java     =&gt; &quot;Java&quot;,
 119     WPE         =&gt; &quot;WPE&quot;,
 120     Unknown     =&gt; &quot;Unknown&quot;
 121 };
 122 
 123 use constant USE_OPEN_COMMAND =&gt; 1; # Used in runMacWebKitApp().
 124 use constant DO_NOT_USE_OPEN_COMMAND =&gt; 2;
 125 use constant SIMULATOR_DEVICE_STATE_SHUTDOWN =&gt; &quot;1&quot;;
 126 use constant SIMULATOR_DEVICE_STATE_BOOTED =&gt; &quot;3&quot;;
 127 use constant SIMULATOR_DEVICE_SUFFIX_FOR_WEBKIT_DEVELOPMENT  =&gt; &quot;For WebKit Development&quot;;
 128 
 129 # See table &quot;Certificate types and names&quot; on &lt;https://developer.apple.com/library/ios/documentation/IDEs/Conceptual/AppDistributionGuide/MaintainingCertificates/MaintainingCertificates.html#//apple_ref/doc/uid/TP40012582-CH31-SW41&gt;.
 130 use constant IOS_DEVELOPMENT_CERTIFICATE_NAME_PREFIX =&gt; &quot;iPhone Developer: &quot;;
 131 
 132 our @EXPORT_OK;
 133 
 134 my $architecture;
 135 my $asanIsEnabled;
<span class="line-added"> 136 my $forceOptimizationLevel;</span>
<span class="line-added"> 137 my $coverageIsEnabled;</span>
 138 my $ltoMode;
 139 my $numberOfCPUs;
 140 my $maxCPULoad;
 141 my $baseProductDir;
 142 my @baseProductDirOption;
 143 my $configuration;
 144 my $xcodeSDK;
 145 my $configurationForVisualStudio;
 146 my $configurationProductDir;
 147 my $sourceDir;
 148 my $currentSVNRevision;
 149 my $didLoadIPhoneSimulatorNotification;
 150 my $nmPath;
 151 my $osXVersion;
 152 my $iosVersion;
 153 my $generateDsym;
 154 my $isCMakeBuild;
 155 my $isGenerateProjectOnly;
 156 my $shouldBuild32Bit;
 157 my $isWin64;
</pre>
<hr />
<pre>
 411     $architecture = &#39;x86_64&#39; if $architecture =~ /amd64/i;
 412     $architecture = &#39;arm64&#39; if $architecture =~ /aarch64/i;
 413 }
 414 
 415 sub determineASanIsEnabled
 416 {
 417     return if defined $asanIsEnabled;
 418     determineBaseProductDir();
 419 
 420     $asanIsEnabled = 0;
 421     my $asanConfigurationValue;
 422 
 423     if (open ASAN, &quot;$baseProductDir/ASan&quot;) {
 424         $asanConfigurationValue = &lt;ASAN&gt;;
 425         close ASAN;
 426         chomp $asanConfigurationValue;
 427         $asanIsEnabled = 1 if $asanConfigurationValue eq &quot;YES&quot;;
 428     }
 429 }
 430 
<span class="line-added"> 431 sub determineForceOptimizationLevel</span>
<span class="line-added"> 432 {</span>
<span class="line-added"> 433     return if defined $forceOptimizationLevel;</span>
<span class="line-added"> 434     determineBaseProductDir();</span>
<span class="line-added"> 435 </span>
<span class="line-added"> 436     if (open ForceOptimizationLevel, &quot;$baseProductDir/ForceOptimizationLevel&quot;) {</span>
<span class="line-added"> 437         $forceOptimizationLevel = &lt;ForceOptimizationLevel&gt;;</span>
<span class="line-added"> 438         close ForceOptimizationLevel;</span>
<span class="line-added"> 439         chomp $forceOptimizationLevel;</span>
<span class="line-added"> 440     }</span>
<span class="line-added"> 441 }</span>
<span class="line-added"> 442 </span>
<span class="line-added"> 443 sub determineCoverageIsEnabled</span>
<span class="line-added"> 444 {</span>
<span class="line-added"> 445     return if defined $coverageIsEnabled;</span>
<span class="line-added"> 446     determineBaseProductDir();</span>
<span class="line-added"> 447 </span>
<span class="line-added"> 448     if (open Coverage, &quot;$baseProductDir/Coverage&quot;) {</span>
<span class="line-added"> 449         $coverageIsEnabled = &lt;Coverage&gt;;</span>
<span class="line-added"> 450         close Coverage;</span>
<span class="line-added"> 451         chomp $coverageIsEnabled;</span>
<span class="line-added"> 452     }</span>
<span class="line-added"> 453 }</span>
<span class="line-added"> 454 </span>
 455 sub determineLTOMode
 456 {
 457     return if defined $ltoMode;
 458     determineBaseProductDir();
 459 
 460     if (open LTO, &quot;$baseProductDir/LTO&quot;) {
 461         $ltoMode = &lt;LTO&gt;;
 462         close LTO;
 463         chomp $ltoMode;
 464     }
 465 }
 466 
 467 sub determineNumberOfCPUs
 468 {
 469     return if defined $numberOfCPUs;
 470     if (defined($ENV{NUMBER_OF_PROCESSORS})) {
 471         $numberOfCPUs = $ENV{NUMBER_OF_PROCESSORS};
 472     } elsif (isLinux()) {
 473         # First try the nproc utility, if it exists. If we get no
 474         # results fall back to just interpretting /proc directly.
</pre>
<hr />
<pre>
 488 
 489 sub determineMaxCPULoad
 490 {
 491     return if defined $maxCPULoad;
 492     if (defined($ENV{MAX_CPU_LOAD})) {
 493         $maxCPULoad = $ENV{MAX_CPU_LOAD};
 494     }
 495 }
 496 
 497 sub jscPath($)
 498 {
 499     my ($productDir) = @_;
 500     my $jscName = &quot;jsc&quot;;
 501     $jscName .= &quot;_debug&quot;  if configuration() eq &quot;Debug_All&quot;;
 502     if (isPlayStation()) {
 503         $jscName .= &quot;.elf&quot;;
 504     } elsif (isAnyWindows()) {
 505         $jscName .= &quot;.exe&quot;;
 506     }
 507     return &quot;$productDir/$jscName&quot; if -e &quot;$productDir/$jscName&quot;;
<span class="line-modified"> 508     return &quot;$productDir/JavaScriptCore.framework/Helpers/$jscName&quot;;</span>
 509 }
 510 
 511 sub argumentsForConfiguration()
 512 {
 513     determineConfiguration();
 514     determineArchitecture();
 515     determineXcodeSDK();
 516 
 517     my @args = ();
 518     # FIXME: Is it necessary to pass --debug, --release, --32-bit or --64-bit?
 519     # These are determined automatically from stored configuration.
 520     push(@args, &#39;--debug&#39;) if ($configuration =~ &quot;^Debug&quot;);
 521     push(@args, &#39;--release&#39;) if ($configuration =~ &quot;^Release&quot;);
 522     push(@args, &#39;--ios-device&#39;) if (defined $xcodeSDK &amp;&amp; $xcodeSDK =~ /^iphoneos/);
 523     push(@args, &#39;--ios-simulator&#39;) if (defined $xcodeSDK &amp;&amp; $xcodeSDK =~ /^iphonesimulator/);
 524     push(@args, &#39;--maccatalyst&#39;) if (defined $xcodeSDK &amp;&amp; $xcodeSDK =~ /^maccatalyst/);
 525     push(@args, &#39;--32-bit&#39;) if ($architecture eq &quot;x86&quot; and !isWin64());
 526     push(@args, &#39;--64-bit&#39;) if (isWin64());
<span class="line-added"> 527     push(@args, &#39;--ftw&#39;) if isFTW();</span>
 528     push(@args, &#39;--gtk&#39;) if isGtk();
 529     push(@args, &#39;--java&#39;) if isJava();
 530     push(@args, &#39;--wpe&#39;) if isWPE();
 531     push(@args, &#39;--jsc-only&#39;) if isJSCOnly();
 532     push(@args, &#39;--wincairo&#39;) if isWinCairo();
 533     push(@args, &#39;--playstation&#39;) if isPlayStation();
 534     return @args;
 535 }
 536 
 537 sub extractNonMacOSHostConfiguration
 538 {
 539     my @args = ();
<span class="line-modified"> 540     my @extract = (&#39;--device&#39;, &#39;--gtk&#39;, &#39;--ios&#39;, &#39;--platform&#39;, &#39;--sdk&#39;, &#39;--simulator&#39;, &#39;--wincairo&#39;, &#39;--ftw&#39;, &#39;SDKROOT&#39;, &#39;ARCHS&#39;);</span>
 541     foreach (@{$_[0]}) {
 542         my $line = $_;
 543         my $flag = 0;
 544         foreach (@extract) {
 545             if (length($line) &gt;= length($_) &amp;&amp; substr($line, 0, length($_)) eq $_
 546                 &amp;&amp; index($line, &#39;i386&#39;) == -1 &amp;&amp; index($line, &#39;x86_64&#39;) == -1) {
 547                 $flag = 1;
 548             }
 549         }
 550         if (!$flag) {
 551             push @args, $_;
 552         }
 553     }
 554     return @args;
 555 }
 556 
 557 # FIXME: Convert to json &lt;rdar://problem/21594308&gt;
 558 sub parseAvailableXcodeSDKs($)
 559 {
 560     my @outputToParse = @{$_[0]};
</pre>
<hr />
<pre>
 727     chomp($path = `cygpath &quot;$path&quot;`) if isCygwin();
 728 
 729     print &quot;Using MSBuild: $path\n&quot;;
 730     return $path;
 731 }
 732 
 733 sub determineConfigurationForVisualStudio
 734 {
 735     return if defined $configurationForVisualStudio;
 736     determineConfiguration();
 737     # FIXME: We should detect when Debug_All or Production has been chosen.
 738     $configurationForVisualStudio = &quot;/p:Configuration=&quot; . $configuration;
 739 }
 740 
 741 sub usesPerConfigurationBuildDirectory
 742 {
 743     # [Gtk] We don&#39;t have Release/Debug configurations in straight
 744     # autotool builds (non build-webkit). In this case and if
 745     # WEBKIT_OUTPUTDIR exist, use that as our configuration dir. This will
 746     # allows us to run run-webkit-tests without using build-webkit.
<span class="line-modified"> 747     return ($ENV{&quot;WEBKIT_OUTPUTDIR&quot;} &amp;&amp; isGtk()) || isAppleWinWebKit() || isFTW() || isJava();</span>
 748 }
 749 
 750 sub determineConfigurationProductDir
 751 {
 752     return if defined $configurationProductDir;
 753     determineBaseProductDir();
 754     determineConfiguration();
<span class="line-modified"> 755     if (isAppleWinWebKit() || isWinCairo() || isPlayStation() || isFTW()) {</span>
 756         $configurationProductDir = File::Spec-&gt;catdir($baseProductDir, $configuration);
 757     } else {
 758         if (usesPerConfigurationBuildDirectory()) {
 759             $configurationProductDir = &quot;$baseProductDir&quot;;
 760         } else {
 761             $configurationProductDir = &quot;$baseProductDir/$configuration&quot;;
 762             $configurationProductDir .= &quot;-&quot; . xcodeSDKPlatformName() if isEmbeddedWebKit() || isMacCatalystWebKit();
 763         }
 764     }
 765 }
 766 
 767 sub setConfigurationProductDir($)
 768 {
 769     ($configurationProductDir) = @_;
 770 }
 771 
 772 sub determineCurrentSVNRevision
 773 {
 774     # We always update the current SVN revision here, and leave the caching
 775     # to currentSVNRevision(), so that changes to the SVN revision while the
</pre>
<hr />
<pre>
 820     return File::Spec-&gt;catdir($productDirectory, $binaryDirectory);
 821 }
 822 
 823 sub jscProductDir
 824 {
 825     return executableProductDir();
 826 }
 827 
 828 sub configuration()
 829 {
 830     determineConfiguration();
 831     return $configuration;
 832 }
 833 
 834 sub asanIsEnabled()
 835 {
 836     determineASanIsEnabled();
 837     return $asanIsEnabled;
 838 }
 839 
<span class="line-added"> 840 sub forceOptimizationLevel()</span>
<span class="line-added"> 841 {</span>
<span class="line-added"> 842     determineForceOptimizationLevel();</span>
<span class="line-added"> 843     return $forceOptimizationLevel;</span>
<span class="line-added"> 844 }</span>
<span class="line-added"> 845 </span>
 846 sub ltoMode()
 847 {
 848     determineLTOMode();
 849     return $ltoMode;
 850 }
 851 
 852 sub configurationForVisualStudio()
 853 {
 854     determineConfigurationForVisualStudio();
 855     return $configurationForVisualStudio;
 856 }
 857 
 858 sub currentSVNRevision
 859 {
 860     determineCurrentSVNRevision() if not defined $currentSVNRevision;
 861     return $currentSVNRevision;
 862 }
 863 
 864 sub generateDsym()
 865 {
</pre>
<hr />
<pre>
 874 }
 875 
 876 sub hasIOSDevelopmentCertificate()
 877 {
 878     return !exitStatus(system(&quot;security find-identity -p codesigning | grep &#39;&quot; . IOS_DEVELOPMENT_CERTIFICATE_NAME_PREFIX . &quot;&#39; &gt; /dev/null 2&gt;&amp;1&quot;));
 879 }
 880 
 881 sub argumentsForXcode()
 882 {
 883     my @args = ();
 884     push @args, &quot;DEBUG_INFORMATION_FORMAT=dwarf-with-dsym&quot; if generateDsym();
 885     return @args;
 886 }
 887 
 888 sub XcodeOptions
 889 {
 890     determineBaseProductDir();
 891     determineConfiguration();
 892     determineArchitecture();
 893     determineASanIsEnabled();
<span class="line-added"> 894     determineForceOptimizationLevel();</span>
<span class="line-added"> 895     determineCoverageIsEnabled();</span>
 896     determineLTOMode();
 897     determineXcodeSDK();
 898 
 899     my @options;
 900     push @options, &quot;-UseSanitizedBuildSystemEnvironment=YES&quot;;
 901     push @options, &quot;-ShowBuildOperationDuration=YES&quot;;
 902     push @options, (&quot;-configuration&quot;, $configuration);
 903     push @options, (&quot;-xcconfig&quot;, sourceDir() . &quot;/Tools/asan/asan.xcconfig&quot;, &quot;ASAN_IGNORE=&quot; . sourceDir() . &quot;/Tools/asan/webkit-asan-ignore.txt&quot;) if $asanIsEnabled;
<span class="line-added"> 904     push @options, (&quot;-xcconfig&quot;, sourceDir() . &quot;/Tools/coverage/coverage.xcconfig&quot;) if $coverageIsEnabled;</span>
<span class="line-added"> 905     push @options, (&quot;GCC_OPTIMIZATION_LEVEL=$forceOptimizationLevel&quot;) if $forceOptimizationLevel;</span>
 906     push @options, &quot;WK_LTO_MODE=$ltoMode&quot; if $ltoMode;
 907     push @options, @baseProductDirOption;
 908     push @options, &quot;ARCHS=$architecture&quot; if $architecture;
 909     push @options, &quot;SDKROOT=$xcodeSDK&quot; if $xcodeSDK;
<span class="line-modified"> 910 </span>
<span class="line-added"> 911     # When this environment variable is set Tools/Scripts/check-for-weak-vtables-and-externals</span>
<span class="line-added"> 912     # treats errors as non-fatal when it encounters missing symbols related to coverage.</span>
<span class="line-added"> 913     appendToEnvironmentVariableList(&quot;WEBKIT_COVERAGE_BUILD&quot;, &quot;1&quot;) if $coverageIsEnabled;</span>
<span class="line-added"> 914 </span>
<span class="line-added"> 915     die &quot;cannot enable both ASAN and Coverage at this time\n&quot; if $coverageIsEnabled &amp;&amp; $asanIsEnabled;</span>
<span class="line-added"> 916 </span>
<span class="line-added"> 917     if (willUseIOSDeviceSDK() || willUseWatchDeviceSDK() || willUseAppleTVDeviceSDK()) {</span>
<span class="line-added"> 918         push @options, &quot;-IDEProvisioningProfileSupportRelaxed=YES&quot;;</span>
 919         push @options, &quot;ENABLE_BITCODE=NO&quot;;
 920         if (hasIOSDevelopmentCertificate()) {
 921             # FIXME: May match more than one installed development certificate.
 922             push @options, &quot;CODE_SIGN_IDENTITY=&quot; . IOS_DEVELOPMENT_CERTIFICATE_NAME_PREFIX;
 923         } else {
 924             push @options, &quot;CODE_SIGN_IDENTITY=&quot;; # No identity
 925             push @options, &quot;CODE_SIGNING_REQUIRED=NO&quot;;
 926         }
 927     }
 928     push @options, argumentsForXcode();
 929     return @options;
 930 }
 931 
 932 sub XcodeOptionString
 933 {
 934     return join &quot; &quot;, XcodeOptions();
 935 }
 936 
 937 sub XcodeOptionStringNoConfig
 938 {
</pre>
<hr />
<pre>
 958     #     return $1 &gt;= 11;
 959     # }
 960 
 961     return 0;
 962 }
 963 
 964 my $passedConfiguration;
 965 my $searchedForPassedConfiguration;
 966 sub determinePassedConfiguration
 967 {
 968     return if $searchedForPassedConfiguration;
 969     $searchedForPassedConfiguration = 1;
 970     $passedConfiguration = undef;
 971 
 972     if (checkForArgumentAndRemoveFromARGV(&quot;--debug&quot;)) {
 973         $passedConfiguration = &quot;Debug&quot;;
 974     } elsif(checkForArgumentAndRemoveFromARGV(&quot;--release&quot;)) {
 975         $passedConfiguration = &quot;Release&quot;;
 976     } elsif (checkForArgumentAndRemoveFromARGV(&quot;--profile&quot;) || checkForArgumentAndRemoveFromARGV(&quot;--profiling&quot;)) {
 977         $passedConfiguration = &quot;Profiling&quot;;
<span class="line-added"> 978     } elsif(checkForArgumentAndRemoveFromARGV(&quot;--testing&quot;)) {</span>
<span class="line-added"> 979         $passedConfiguration = &quot;Testing&quot;;</span>
<span class="line-added"> 980     } elsif(checkForArgumentAndRemoveFromARGV(&quot;--release-and-assert&quot;) || checkForArgumentAndRemoveFromARGV(&quot;--ra&quot;)) {</span>
<span class="line-added"> 981         $passedConfiguration = &quot;Release+Assert&quot;;</span>
 982     }
 983 }
 984 
 985 sub passedConfiguration
 986 {
 987     determinePassedConfiguration();
 988     return $passedConfiguration;
 989 }
 990 
 991 sub setConfiguration
 992 {
 993     setArchitecture();
 994 
 995     if (my $config = shift @_) {
 996         $configuration = $config;
 997         return;
 998     }
 999 
1000     determinePassedConfiguration();
1001     $configuration = $passedConfiguration if $passedConfiguration;
</pre>
<hr />
<pre>
1083 
1084     die &quot;Can&#39;t find executable at $safariPath.\n&quot; if !-x $safariPath;
1085     return $safariPath;
1086 }
1087 
1088 sub builtDylibPathForName
1089 {
1090     my $libraryName = shift;
1091     determineConfigurationProductDir();
1092 
1093     if (isGtk()) {
1094         my $extension = isDarwin() ? &quot;.dylib&quot; : &quot;.so&quot;;
1095         return &quot;$configurationProductDir/lib/libwebkit2gtk-4.0&quot; . $extension;
1096     }
1097     if (isIOSWebKit()) {
1098         return &quot;$configurationProductDir/$libraryName.framework/$libraryName&quot;;
1099     }
1100     if (isAppleCocoaWebKit()) {
1101         return &quot;$configurationProductDir/$libraryName.framework/Versions/A/$libraryName&quot;;
1102     }
<span class="line-modified">1103     if (isAppleWinWebKit() || isFTW()) {</span>
1104         if ($libraryName eq &quot;JavaScriptCore&quot;) {
1105             return &quot;$baseProductDir/lib/$libraryName.lib&quot;;
1106         } else {
1107             return &quot;$baseProductDir/$libraryName.intermediate/$configuration/$libraryName.intermediate/$libraryName.lib&quot;;
1108         }
1109     }
1110     if (isJava()) {
1111         my $extension = isDarwin() ? &quot;.dylib&quot; : &quot;.so&quot;;
1112         return &quot;$configurationProductDir/lib/libjfxwebkit&quot; . $extension;
1113     }
1114     if (isWPE()) {
1115         return &quot;$configurationProductDir/lib/libWPEWebKit-1.0.so&quot;;
1116     }
1117 
1118     die &quot;Unsupported platform, can&#39;t determine built library locations.\nTry `build-webkit --help` for more information.\n&quot;;
1119 }
1120 
1121 # Check to see that all the frameworks are built.
1122 sub checkFrameworks # FIXME: This is a poor name since only the Mac calls built WebCore a Framework.
1123 {
</pre>
<hr />
<pre>
1209 {
1210     my ($argToCheck, $arrayRef) = @_;
1211     my @indicesToRemove = findMatchingArguments($argToCheck, $arrayRef);
1212     my $removeOffset = 0;
1213     foreach my $index (@indicesToRemove) {
1214         splice(@$arrayRef, $index - $removeOffset++, 1);
1215     }
1216     return scalar @indicesToRemove &gt; 0;
1217 }
1218 
1219 sub prohibitUnknownPort()
1220 {
1221     $unknownPortProhibited = 1;
1222 }
1223 
1224 sub determinePortName()
1225 {
1226     return if defined $portName;
1227 
1228     my %argToPortName = (
<span class="line-added">1229         ftw =&gt; FTW,</span>
1230         gtk =&gt; GTK,
1231         &#39;jsc-only&#39; =&gt; JSCOnly,
1232         playstation =&gt; PlayStation,
1233         wincairo =&gt; WinCairo,
1234         java =&gt; Java,
1235         wpe =&gt; WPE
1236     );
1237 
1238     for my $arg (sort keys %argToPortName) {
1239         if (checkForArgumentAndRemoveFromARGV(&quot;--$arg&quot;)) {
1240             die &quot;Argument &#39;--$arg&#39; conflicts with selected port &#39;$portName&#39;\n&quot;
1241                 if defined $portName;
1242 
1243             $portName = $argToPortName{$arg};
1244         }
1245     }
1246 
1247     return if defined $portName;
1248 
1249     # Port was not selected via command line, use appropriate default value
</pre>
<hr />
<pre>
1311 {
1312     return portName() eq WPE;
1313 }
1314 
1315 sub isPlayStation()
1316 {
1317     return portName() eq PlayStation;
1318 }
1319 
1320 # Determine if this is debian, ubuntu, linspire, or something similar.
1321 sub isDebianBased()
1322 {
1323     return -e &quot;/etc/debian_version&quot;;
1324 }
1325 
1326 sub isFedoraBased()
1327 {
1328     return -e &quot;/etc/fedora-release&quot;;
1329 }
1330 
<span class="line-added">1331 sub isFTW()</span>
<span class="line-added">1332 {</span>
<span class="line-added">1333     return portName() eq FTW;</span>
<span class="line-added">1334 }</span>
<span class="line-added">1335 </span>
1336 sub isWinCairo()
1337 {
1338     return portName() eq WinCairo;
1339 }
1340 
1341 sub shouldBuild32Bit()
1342 {
1343     determineShouldBuild32Bit();
1344     return $shouldBuild32Bit;
1345 }
1346 
1347 sub determineShouldBuild32Bit()
1348 {
1349     return if defined($shouldBuild32Bit);
1350     $shouldBuild32Bit = checkForArgumentAndRemoveFromARGV(&quot;--32-bit&quot;);
1351 }
1352 
1353 sub isWin64()
1354 {
1355     determineIsWin64();
1356     return $isWin64;
1357 }
1358 
1359 sub determineIsWin64()
1360 {
1361     return if defined($isWin64);
<span class="line-modified">1362     $isWin64 = checkForArgumentAndRemoveFromARGV(&quot;--64-bit&quot;) || ((isAnyWindows() || isJSCOnly()) &amp;&amp; !shouldBuild32Bit());</span>
1363 }
1364 
1365 sub determineIsWin64FromArchitecture($)
1366 {
1367     my $arch = shift;
1368     $isWin64 = ($arch eq &quot;x86_64&quot;);
1369     return $isWin64;
1370 }
1371 
1372 sub isCygwin()
1373 {
1374     return ($^O eq &quot;cygwin&quot;) || 0;
1375 }
1376 
1377 sub isAnyWindows()
1378 {
1379     return isWindows() || isCygwin();
1380 }
1381 
1382 sub determineWinVersion()
</pre>
<hr />
<pre>
1440 }
1441 
1442 sub isX86_64()
1443 {
1444     return (architecture() eq &quot;x86_64&quot;) || 0;
1445 }
1446 
1447 sub isARM64()
1448 {
1449     return (architecture() eq &quot;arm64&quot;) || 0;
1450 }
1451 
1452 sub isCrossCompilation()
1453 {
1454     my $compiler = &quot;&quot;;
1455     $compiler = $ENV{&#39;CC&#39;} if (defined($ENV{&#39;CC&#39;}));
1456     if ($compiler =~ /gcc/) {
1457         my $compilerOptions = `$compiler -v 2&gt;&amp;1`;
1458         my @host = $compilerOptions =~ m/--host=(.*?)\s/;
1459         my @target = $compilerOptions =~ m/--target=(.*?)\s/;
<span class="line-modified">1460         if (!@target || !@host) {</span>
<span class="line-added">1461             # Sometimes a compiler does not report the host of target it was compiled for,</span>
<span class="line-added">1462             # in which case, lacking better information we assume we are not cross-compiling.</span>
<span class="line-added">1463             return 0;</span>
<span class="line-added">1464         }</span>
<span class="line-added">1465         elsif ($target[0] ne &quot;&quot; &amp;&amp; $host[0] ne &quot;&quot;) {</span>
1466                 return ($host[0] ne $target[0]);
1467         } else {
1468                 # $tempDir gets automatically deleted when goes out of scope
1469                 my $tempDir = File::Temp-&gt;newdir();
1470                 my $testProgramSourcePath = File::Spec-&gt;catfile($tempDir, &quot;testcross.c&quot;);
1471                 my $testProgramBinaryPath = File::Spec-&gt;catfile($tempDir, &quot;testcross&quot;);
1472                 open(my $testProgramSourceHandler, &quot;&gt;&quot;, $testProgramSourcePath);
1473                 print $testProgramSourceHandler &quot;int main() { return 0; }\n&quot;;
1474                 system(&quot;$compiler $testProgramSourcePath -o $testProgramBinaryPath &gt; /dev/null 2&gt;&amp;1&quot;) == 0 or return 0;
1475                 # Crosscompiling if the program fails to run (because it was built for other arch)
1476                 system(&quot;$testProgramBinaryPath &gt; /dev/null 2&gt;&amp;1&quot;) == 0 or return 1;
1477                 return 0;
1478         }
1479     }
1480     return 0;
1481 }
1482 
1483 sub isIOSWebKit()
1484 {
1485     return portName() eq iOS;
</pre>
<hr />
<pre>
1613     return if $nmPath;
1614 
1615     if (isAppleCocoaWebKit()) {
1616         $nmPath = `xcrun -find nm`;
1617         chomp $nmPath;
1618     }
1619     $nmPath = &quot;nm&quot; if !$nmPath;
1620 }
1621 
1622 sub nmPath()
1623 {
1624     determineNmPath();
1625     return $nmPath;
1626 }
1627 
1628 sub splitVersionString
1629 {
1630     my $versionString = shift;
1631     my @splitVersion = split(/\./, $versionString);
1632     @splitVersion &gt;= 2 or die &quot;Invalid version $versionString&quot;;
<span class="line-modified">1633     return {</span>
<span class="line-modified">1634         &quot;major&quot; =&gt; $splitVersion[0],</span>
<span class="line-modified">1635         &quot;minor&quot; =&gt; $splitVersion[1],</span>
<span class="line-modified">1636         &quot;subminor&quot; =&gt; (defined($splitVersion[2]) ? $splitVersion[2] : 0),</span>
1637     };
1638 }
1639 
1640 sub determineOSXVersion()
1641 {
1642     return if $osXVersion;
1643 
1644     if (!isDarwin()) {
1645         $osXVersion = -1;
1646         return;
1647     }
1648 
<span class="line-modified">1649     chomp(my $versionString = `sw_vers -productVersion`);</span>
1650     $osXVersion = splitVersionString($versionString);
1651 }
1652 
1653 sub osXVersion()
1654 {
1655     determineOSXVersion();
1656     return $osXVersion;
1657 }
1658 
1659 sub determineIOSVersion()
1660 {
1661     return if $iosVersion;
1662 
1663     if (!isIOSWebKit()) {
1664         $iosVersion = -1;
1665         return;
1666     }
1667 
1668     my $versionString = xcodeSDKVersion();
1669     $iosVersion = splitVersionString($versionString);
</pre>
<hr />
<pre>
1757 
1758 sub launcherPath()
1759 {
1760     my $relativeScriptsPath = relativeScriptsDir();
1761     if (isGtk() || isWPE()) {
1762         if (inFlatpakSandbox()) {
1763             return &quot;Tools/Scripts/run-minibrowser&quot;;
1764         }
1765         return &quot;$relativeScriptsPath/run-minibrowser&quot;;
1766     } elsif (isAppleWebKit()) {
1767         return &quot;$relativeScriptsPath/run-safari&quot;;
1768     }
1769 }
1770 
1771 sub launcherName()
1772 {
1773     if (isGtk() || isWPE()) {
1774         return &quot;MiniBrowser&quot;;
1775     } elsif (isAppleMacWebKit()) {
1776         return &quot;Safari&quot;;
<span class="line-modified">1777     } elsif (isAppleWinWebKit() || isFTW()) {</span>
1778         return &quot;MiniBrowser&quot;;
1779     }
1780 }
1781 
1782 sub checkRequiredSystemConfig
1783 {
1784     if (isDarwin()) {
1785         chomp(my $productVersion = `sw_vers -productVersion`);
1786         if (eval &quot;v$productVersion&quot; lt v10.10.5) {
1787             print &quot;*************************************************************\n&quot;;
1788             print &quot;OS X Yosemite v10.10.5 or later is required to build WebKit.\n&quot;;
1789             print &quot;You have &quot; . $productVersion . &quot;, thus the build will most likely fail.\n&quot;;
1790             print &quot;*************************************************************\n&quot;;
1791         }
1792         determineXcodeVersion();
1793         if (eval &quot;v$xcodeVersion&quot; lt v7.0) {
1794             print &quot;*************************************************************\n&quot;;
1795             print &quot;Xcode 7.0 or later is required to build WebKit.\n&quot;;
1796             print &quot;You have an earlier version of Xcode, thus the build will\n&quot;;
1797             print &quot;most likely fail. The latest Xcode is available from the App Store.\n&quot;;
</pre>
<hr />
<pre>
1860     my @missing = ();
1861     foreach my $font (@fonts) {
1862         push @missing, $font if not fontExists($font);
1863     }
1864 
1865     if (scalar @missing &gt; 0) {
1866         print &quot;*************************************************************\n&quot;;
1867         print &quot;Mathematical fonts, such as Latin Modern Math are needed to\n&quot;;
1868         print &quot;use the MathML feature.  You do not appear to have these fonts\n&quot;;
1869         print &quot;on your system.\n\n&quot;;
1870         print &quot;You can download a suitable set of fonts from the following URL:\n&quot;;
1871         print &quot;https://trac.webkit.org/wiki/MathML/Fonts\n&quot;;
1872         print &quot;*************************************************************\n&quot;;
1873     }
1874 
1875     print &quot;Installed tools are correct for the WebKit build.\n&quot;;
1876 }
1877 
1878 sub setupAppleWinEnv()
1879 {
<span class="line-modified">1880     return unless isAppleWinWebKit() || isFTW();</span>
1881 
1882     checkInstalledTools();
1883 
1884     if (isWindowsNT()) {
1885         my $restartNeeded = 0;
1886         my %variablesToSet = ();
1887 
1888         # FIXME: We should remove this explicit version check for cygwin once we stop supporting Cygwin 1.7.9 or older versions. 
1889         # https://bugs.webkit.org/show_bug.cgi?id=85791
1890         my $uname_version = (POSIX::uname())[2];
1891         $uname_version =~ s/\(.*\)//;  # Remove the trailing cygwin version, if any.
1892         $uname_version =~ s/\-.*$//; # Remove trailing dash-version content, if any
1893         if (version-&gt;parse($uname_version) &lt; version-&gt;parse(&quot;1.7.10&quot;)) {
1894             # Setting the environment variable &#39;CYGWIN&#39; to &#39;tty&#39; makes cygwin enable extra support (i.e., termios)
1895             # for UNIX-like ttys in the Windows console
1896             $variablesToSet{CYGWIN} = &quot;tty&quot; unless $ENV{CYGWIN};
1897         }
1898         
1899         # Those environment variables must be set to be able to build inside Visual Studio.
1900         $variablesToSet{WEBKIT_LIBRARIES} = windowsLibrariesDir() unless $ENV{WEBKIT_LIBRARIES};
</pre>
<hr />
<pre>
1957     if (! -e $msBuildPath) {
1958         print &quot;*************************************************************\n&quot;;
1959         print &quot;Cannot find &#39;$msBuildPath&#39;\n&quot;;
1960         print &quot;Please make sure execute that the Microsoft .NET Framework SDK\n&quot;;
1961         print &quot;is installed on this machine.\n&quot;;
1962         print &quot;*************************************************************\n&quot;;
1963         die;
1964     }
1965 }
1966 
1967 sub buildXCodeProject($$@)
1968 {
1969     my ($project, $clean, @extraOptions) = @_;
1970 
1971     if ($clean) {
1972         push(@extraOptions, &quot;-alltargets&quot;);
1973         push(@extraOptions, &quot;clean&quot;);
1974     }
1975 
1976     chomp($ENV{DSYMUTIL_NUM_THREADS} = `sysctl -n hw.activecpu`);
<span class="line-added">1977 </span>
<span class="line-added">1978     # lldbWebKitTester won&#39;t work with the wrong CLANG_DEBUG_INFORMATION_LEVEL, so always use the default for that project</span>
<span class="line-added">1979     if ($project eq &quot;lldbWebKitTester&quot;) {</span>
<span class="line-added">1980         my $index = 0;</span>
<span class="line-added">1981         while ($index &lt; scalar(@extraOptions)) {</span>
<span class="line-added">1982             if ($extraOptions[$index] =~ /CLANG_DEBUG_INFORMATION_LEVEL=/) {</span>
<span class="line-added">1983                 splice @extraOptions, $index, 1;</span>
<span class="line-added">1984             } else {</span>
<span class="line-added">1985                 $index += 1;</span>
<span class="line-added">1986             }</span>
<span class="line-added">1987         }</span>
<span class="line-added">1988     }</span>
1989     return system &quot;xcodebuild&quot;, &quot;-project&quot;, &quot;$project.xcodeproj&quot;, @extraOptions;
1990 }
1991 
1992 sub getVisualStudioToolset()
1993 {
1994     if (isPlayStation()) {
1995         return &quot;&quot;;
1996     } elsif (isWin64()) {
1997         return &quot;x64&quot;;
1998     } else {
1999         return &quot;Win32&quot;;
2000     }
2001 }
2002 
2003 sub getMSBuildPlatformArgument()
2004 {
2005     my $toolset = getVisualStudioToolset();
2006     if (defined($toolset) &amp;&amp; length($toolset)) {
2007         return &quot;/p:Platform=$toolset&quot;;
2008     }
</pre>
<hr />
<pre>
2287     return commandExists(&quot;ninja&quot;) || commandExists(&quot;ninja-build&quot;);
2288 }
2289 
2290 sub canUseEclipseNinjaGenerator(@)
2291 {
2292     # Check that eclipse and eclipse Ninja generator is installed
2293     my $devnull = File::Spec-&gt;devnull();
2294     return commandExists(&quot;eclipse&quot;) &amp;&amp; exitStatus(system(&quot;cmake -N -G &#39;Eclipse CDT4 - Ninja&#39; &gt;$devnull 2&gt;&amp;1&quot;)) == 0;
2295 }
2296 
2297 sub cmakeGeneratedBuildfile(@)
2298 {
2299     my ($willUseNinja) = @_;
2300     if ($willUseNinja) {
2301         return File::Spec-&gt;catfile(baseProductDir(), configuration(), &quot;build.ninja&quot;)
2302     } elsif (isAnyWindows()) {
2303         return File::Spec-&gt;catfile(baseProductDir(), configuration(), &quot;WebKit.sln&quot;)
2304     } else {
2305         return File::Spec-&gt;catfile(baseProductDir(), configuration(), &quot;Makefile&quot;)
2306     }
<span class="line-added">2307     return 0;</span>
2308 }
2309 
2310 sub generateBuildSystemFromCMakeProject
2311 {
2312     my ($prefixPath, @cmakeArgs) = @_;
2313     my $config = configuration();
2314     my $port = cmakeBasedPortName();
2315     my $buildPath = File::Spec-&gt;catdir(baseProductDir(), $config);
2316     File::Path::mkpath($buildPath) unless -d $buildPath;
2317     my $originalWorkingDirectory = getcwd();
2318     chdir($buildPath) or die;
2319 
2320     # We try to be smart about when to rerun cmake, so that we can have faster incremental builds.
2321     my $willUseNinja = canUseNinja();
2322     if (-e cmakeCachePath() &amp;&amp; -e cmakeGeneratedBuildfile($willUseNinja)) {
2323         return 0;
2324     }
2325 
2326     my @args;
2327     push @args, &quot;-DPORT=\&quot;$port\&quot;&quot;;
</pre>
<hr />
<pre>
2352         if (isWin64()) {
2353             push @args, &#39;&quot;Visual Studio 15 2017 Win64&quot;&#39;;
2354             push @args, &#39;-DCMAKE_GENERATOR_TOOLSET=&quot;host=x64&quot;&#39;;
2355         } else {
2356             push @args, &#39;&quot;Visual Studio 15 2017&quot;&#39;;
2357         }
2358     } else {
2359         if (isAnyWindows()) {
2360             push @args, getCMakeWindowsToolsetArgument();
2361         }
2362         if ((isAnyWindows() || isPlayStation()) &amp;&amp; defined $ENV{VisualStudioVersion}) {
2363             my $var = int($ENV{VisualStudioVersion});
2364             push @args, qq(-G &quot;Visual Studio $var&quot;);
2365         }
2366     }
2367 
2368     # Do not show progress of generating bindings in interactive Ninja build not to leave noisy lines on tty
2369     push @args, &#39;-DSHOW_BINDINGS_GENERATION_PROGRESS=1&#39; unless ($willUseNinja &amp;&amp; -t STDOUT);
2370 
2371     # Some ports have production mode, but build-webkit should always use developer mode.
<span class="line-modified">2372     push @args, &quot;-DDEVELOPER_MODE=ON&quot; if isGtk() || isJSCOnly() || isWPE() || isWin64();</span>
2373 
2374     if (architecture() eq &quot;x86_64&quot; &amp;&amp; shouldBuild32Bit() &amp;&amp; !(isJava() &amp;&amp; isCygwin())) {
2375         # CMAKE_LIBRARY_ARCHITECTURE is needed to get the right .pc
2376         # files in Debian-based systems, for the others
2377         # CMAKE_PREFIX_PATH will get us /usr/lib, which should be the
2378         # right path for 32bit. See FindPkgConfig.cmake.
2379         push @cmakeArgs, &#39;-DFORCE_32BIT=ON -DCMAKE_PREFIX_PATH=&quot;/usr&quot; -DCMAKE_LIBRARY_ARCHITECTURE=x86&#39;;
2380         $ENV{&quot;CFLAGS&quot;} =  &quot;-m32&quot; . ($ENV{&quot;CFLAGS&quot;} || &quot;&quot;);
2381         $ENV{&quot;CXXFLAGS&quot;} = &quot;-m32&quot; . ($ENV{&quot;CXXFLAGS&quot;} || &quot;&quot;);
2382         $ENV{&quot;LDFLAGS&quot;} = &quot;-m32&quot; . ($ENV{&quot;LDFLAGS&quot;} || &quot;&quot;);
2383     }
2384     push @args, @cmakeArgs if @cmakeArgs;
2385 
2386     my $cmakeSourceDir = isCygwin() ? windowsSourceDir() : sourceDir();
2387     push @args, &#39;&quot;&#39; . $cmakeSourceDir . &#39;&quot;&#39;;
2388 
2389     # We call system(&quot;cmake @args&quot;) instead of system(&quot;cmake&quot;, @args) so that @args is
2390     # parsed for shell metacharacters.
2391     my $wrapper = join(&quot; &quot;, wrapperPrefixIfNeeded()) . &quot; &quot;;
2392     my $returnCode = systemVerbose($wrapper . &quot;cmake @args&quot;);
2393 
2394     chdir($originalWorkingDirectory);
2395     return $returnCode;
2396 }
2397 
2398 sub buildCMakeGeneratedProject($)
2399 {
2400     my (@makeArgs) = @_;
2401     my $config = configuration();
2402     my $buildPath = File::Spec-&gt;catdir(baseProductDir(), $config);
2403     if (! -d $buildPath) {
2404         die &quot;Must call generateBuildSystemFromCMakeProject() before building CMake project.&quot;;
2405     }
2406 
2407     if ($ENV{VERBOSE} &amp;&amp; canUseNinja()) {
2408         push @makeArgs, &quot;-v&quot;;
2409         push @makeArgs, &quot;-d keeprsp&quot; if (version-&gt;parse(determineNinjaVersion()) &gt;= version-&gt;parse(&quot;1.4.0&quot;));
2410     }
2411 
<span class="line-added">2412     chomp($buildPath = `cygpath -m &#39;$buildPath&#39;`) if isCygwin();</span>
<span class="line-added">2413 </span>
2414     my $command = &quot;cmake&quot;;
2415     my @args = (&quot;--build&quot;, $buildPath, &quot;--config&quot;, $config);
2416     push @args, (&quot;--&quot;, @makeArgs) if @makeArgs;
2417 
2418     # GTK and JSCOnly can use a build script to preserve colors and pretty-printing.
2419     if ((isGtk() || isJSCOnly()) &amp;&amp; -e &quot;$buildPath/build.sh&quot;) {
2420         chdir &quot;$buildPath&quot; or die;
2421         $command = &quot;$buildPath/build.sh&quot;;
2422         @args = (@makeArgs);
2423     }
2424 
2425     # We call system(&quot;cmake @args&quot;) instead of system(&quot;cmake&quot;, @args) so that @args is
2426     # parsed for shell metacharacters. In particular, @makeArgs may contain such metacharacters.
2427     my $wrapper = join(&quot; &quot;, wrapperPrefixIfNeeded()) . &quot; &quot;;
2428     return systemVerbose($wrapper . &quot;$command @args&quot;);
2429 }
2430 
2431 sub cleanCMakeGeneratedProject()
2432 {
2433     my $config = configuration();
</pre>
<hr />
<pre>
2521 }
2522 
2523 sub appleApplicationSupportPath
2524 {
2525     open INSTALL_DIR, &quot;&lt;/proc/registry/HKEY_LOCAL_MACHINE/SOFTWARE/Apple\ Inc./Apple\ Application\ Support/InstallDir&quot;;
2526     my $path = &lt;INSTALL_DIR&gt;;
2527     $path =~ s/[\r\n\x00].*//;
2528     close INSTALL_DIR;
2529 
2530     my $unixPath = `cygpath -u &#39;$path&#39;`;
2531     chomp $unixPath;
2532     return $unixPath;
2533 }
2534 
2535 sub setPathForRunningWebKitApp
2536 {
2537     my ($env) = @_;
2538 
2539     if (isAnyWindows()) {
2540         my $productBinaryDir = executableProductDir();
<span class="line-modified">2541         if (isAppleWinWebKit() || isFTW()) {</span>
2542             $env-&gt;{PATH} = join(&#39;:&#39;, $productBinaryDir, appleApplicationSupportPath(), $env-&gt;{PATH} || &quot;&quot;);
2543         } elsif (isWinCairo()) {
2544             my $winCairoBin = sourceDir() . &quot;/WebKitLibraries/win/&quot; . (isWin64() ? &quot;bin64/&quot; : &quot;bin32/&quot;);
2545             my $gstreamerBin = isWin64() ? $ENV{&quot;GSTREAMER_1_0_ROOT_X86_64&quot;} . &quot;bin&quot; : $ENV{&quot;GSTREAMER_1_0_ROOT_X86&quot;} . &quot;bin&quot;;
2546             $env-&gt;{PATH} = join(&#39;:&#39;, $productBinaryDir, $winCairoBin, $gstreamerBin, $env-&gt;{PATH} || &quot;&quot;);
2547         }
2548     }
2549 }
2550 
2551 sub printHelpAndExitForRunAndDebugWebKitAppIfNeeded
2552 {
2553     return unless checkForArgumentAndRemoveFromARGV(&quot;--help&quot;);
2554 
2555     print STDERR &lt;&lt;EOF;
2556 Usage: @{[basename($0)]} [options] [args ...]
2557   --help                            Show this help message
2558   --no-saved-state                  Launch the application without state restoration
2559 
2560 Options specific to macOS:
2561   -g|--guard-malloc                 Enable Guard Malloc
2562   --lang=LANGUAGE                   Use a specific language instead of system language.
2563                                     This accepts a language name (German) or a language code (de, ar, pt_BR, etc).
2564   --locale=LOCALE                   Use a specific locale instead of the system region.
2565 EOF
2566 
2567     exit(1);
2568 }
2569 
2570 sub argumentsForRunAndDebugMacWebKitApp()
2571 {
2572     my @args = ();
2573     if (checkForArgumentAndRemoveFromARGV(&quot;--no-saved-state&quot;)) {
2574         push @args, (&quot;-ApplePersistenceIgnoreStateQuietly&quot;, &quot;YES&quot;);


2575     }
2576 
2577     my $lang;
2578     if (checkForArgumentAndRemoveFromARGVGettingValue(&quot;--lang&quot;, \$lang)) {
2579         push @args, (&quot;-AppleLanguages&quot;, &quot;(&quot; . $lang . &quot;)&quot;);
2580     }
2581 
2582     my $locale;
2583     if (checkForArgumentAndRemoveFromARGVGettingValue(&quot;--locale&quot;, \$locale)) {
2584         push @args, (&quot;-AppleLocale&quot;, $locale);
2585     }
2586 
2587     unshift @args, @ARGV;
2588 
2589     return @args;
2590 }
2591 
2592 sub setupMacWebKitEnvironment($)
2593 {
2594     my ($dyldFrameworkPath) = @_;
</pre>
<hr />
<pre>
2609     my ($productDir) = @_;
2610 
2611     $ENV{TEST_RUNNER_INJECTED_BUNDLE_FILENAME} = File::Spec-&gt;catfile($productDir, &quot;lib&quot;, &quot;libTestRunnerInjectedBundle.so&quot;);
2612     $ENV{TEST_RUNNER_TEST_PLUGIN_PATH} = File::Spec-&gt;catdir($productDir, &quot;lib&quot;, &quot;plugins&quot;);
2613 }
2614 
2615 sub setupIOSWebKitEnvironment($)
2616 {
2617     my ($dyldFrameworkPath) = @_;
2618     $dyldFrameworkPath = File::Spec-&gt;rel2abs($dyldFrameworkPath);
2619 
2620     prependToEnvironmentVariableList(&quot;DYLD_FRAMEWORK_PATH&quot;, $dyldFrameworkPath);
2621     prependToEnvironmentVariableList(&quot;DYLD_LIBRARY_PATH&quot;, $dyldFrameworkPath);
2622 
2623     setUpGuardMallocIfNeeded();
2624 }
2625 
2626 sub iosSimulatorApplicationsPath()
2627 {
2628     # FIXME: We should ask simctl for this information, instead of guessing from available runtimes.
<span class="line-modified">2629     my $runtimePath = File::Spec-&gt;catdir(sdkPlatformDirectory(&quot;iphoneos&quot;), &quot;Library&quot;, &quot;Developer&quot;, &quot;CoreSimulator&quot;, &quot;Profiles&quot;, &quot;Runtimes&quot;);</span>
2630     opendir(RUNTIMES, $runtimePath);
2631     my @runtimes = grep {/.*\.simruntime/} readdir(RUNTIMES);
2632     close(RUNTIMES);
2633     my $sult = File::Spec-&gt;catdir($runtimePath, @runtimes ? $runtimes[0] : &quot;iOS.simruntime&quot;, &quot;Contents&quot;, &quot;Resources&quot;, &quot;RuntimeRoot&quot;, &quot;Applications&quot;);
2634     return $sult;
2635 }
2636 
2637 sub installedMobileSafariBundle()
2638 {
2639     return File::Spec-&gt;catfile(iosSimulatorApplicationsPath(), &quot;MobileSafari.app&quot;);
2640 }
2641 
2642 sub mobileSafariBundle()
2643 {
2644     determineConfigurationProductDir();
2645 
2646     # Use MobileSafari.app in product directory if present.
2647     if (isIOSWebKit() &amp;&amp; -d &quot;$configurationProductDir/MobileSafari.app&quot;) {
2648         return &quot;$configurationProductDir/MobileSafari.app&quot;;
2649     }
</pre>
<hr />
<pre>
2976 sub debugSafari
2977 {
2978     if (isAppleMacWebKit()) {
2979         checkFrameworks();
2980         execMacWebKitAppForDebugging(safariPath());
2981     }
2982 
2983     return 1; # Unsupported platform; can&#39;t debug Safari on this platform.
2984 }
2985 
2986 sub runSafari
2987 {
2988     if (isIOSWebKit()) {
2989         return runIOSWebKitApp(mobileSafariBundle());
2990     }
2991 
2992     if (isAppleMacWebKit()) {
2993         return runMacWebKitApp(safariPath());
2994     }
2995 
<span class="line-modified">2996     if (isAppleWinWebKit() || isFTW()) {</span>
2997         my $result;
2998         my $webKitLauncherPath = File::Spec-&gt;catfile(executableProductDir(), &quot;MiniBrowser.exe&quot;);
2999         return system { $webKitLauncherPath } $webKitLauncherPath, @ARGV;
3000     }
3001 
3002     return 1; # Unsupported platform; can&#39;t run Safari on this platform.
3003 }
3004 
3005 sub runMiniBrowser
3006 {
3007     if (isAppleMacWebKit()) {
3008         return runMacWebKitApp(File::Spec-&gt;catfile(productDir(), &quot;MiniBrowser.app&quot;, &quot;Contents&quot;, &quot;MacOS&quot;, &quot;MiniBrowser&quot;));
3009     }
<span class="line-modified">3010     if (isAppleWinWebKit() || isFTW()) {</span>
3011         my $webKitLauncherPath = File::Spec-&gt;catfile(executableProductDir(), &quot;MiniBrowser.exe&quot;);
3012         return system { $webKitLauncherPath } $webKitLauncherPath, @ARGV;
3013     }
3014     return 1;
3015 }
3016 
3017 sub debugMiniBrowser
3018 {
3019     if (isAppleMacWebKit()) {
3020         execMacWebKitAppForDebugging(File::Spec-&gt;catfile(productDir(), &quot;MiniBrowser.app&quot;, &quot;Contents&quot;, &quot;MacOS&quot;, &quot;MiniBrowser&quot;));
3021     }
3022     
3023     return 1;
3024 }
3025 
3026 sub runWebKitTestRunner
3027 {
3028     if (isAppleMacWebKit()) {
3029         return runMacWebKitApp(File::Spec-&gt;catfile(productDir(), &quot;WebKitTestRunner&quot;));
3030     }
</pre>
</td>
</tr>
</table>
<center><a href="set-webkit-configuration.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="webkitperl/FeatureList.pm.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>