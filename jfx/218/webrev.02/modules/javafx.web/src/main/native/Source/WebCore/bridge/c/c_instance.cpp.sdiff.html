<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WebCore/bridge/c/c_instance.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="CRuntimeObject.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="c_instance.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/bridge/c/c_instance.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 48 #include &lt;wtf/NeverDestroyed.h&gt;
 49 #include &lt;wtf/StdLibExtras.h&gt;
 50 #include &lt;wtf/Vector.h&gt;
 51 
 52 using namespace WebCore;
 53 
 54 namespace JSC {
 55 namespace Bindings {
 56 
 57 static String&amp; globalExceptionString()
 58 {
 59     static NeverDestroyed&lt;String&gt; exceptionStr;
 60     return exceptionStr;
 61 }
 62 
 63 void CInstance::setGlobalException(String exception)
 64 {
 65     globalExceptionString() = exception;
 66 }
 67 
<span class="line-modified"> 68 void CInstance::moveGlobalExceptionToExecState(ExecState* exec)</span>
 69 {
 70     if (globalExceptionString().isNull())
 71         return;
 72 
 73     {
<span class="line-modified"> 74         VM&amp; vm = exec-&gt;vm();</span>
 75         JSLockHolder lock(vm);
 76         auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified"> 77         throwException(exec, scope, createError(exec, globalExceptionString()));</span>
 78     }
 79 
 80     globalExceptionString() = String();
 81 }
 82 
 83 CInstance::CInstance(NPObject* o, RefPtr&lt;RootObject&gt;&amp;&amp; rootObject)
 84     : Instance(WTFMove(rootObject))
 85 {
 86     _object = _NPN_RetainObject(o);
 87     _class = 0;
 88 }
 89 
 90 CInstance::~CInstance()
 91 {
 92     _NPN_ReleaseObject(_object);
 93 }
 94 
<span class="line-modified"> 95 RuntimeObject* CInstance::newRuntimeObject(ExecState* exec)</span>
 96 {
 97     // FIXME: deprecatedGetDOMStructure uses the prototype off of the wrong global object.
<span class="line-modified"> 98     return CRuntimeObject::create(exec-&gt;vm(), WebCore::deprecatedGetDOMStructure&lt;CRuntimeObject&gt;(exec), this);</span>
 99 }
100 
101 Class *CInstance::getClass() const
102 {
103     if (!_class)
104         _class = CClass::classForIsA(_object-&gt;_class);
105     return _class;
106 }
107 
108 bool CInstance::supportsInvokeDefaultMethod() const
109 {
110     return _object-&gt;_class-&gt;invokeDefault;
111 }
112 
<span class="line-modified">113 class CRuntimeMethod : public RuntimeMethod {</span>
114 public:
<span class="line-modified">115     typedef RuntimeMethod Base;</span>
116 
<span class="line-modified">117     static CRuntimeMethod* create(ExecState* exec, JSGlobalObject* globalObject, const String&amp; name, Bindings::Method* method)</span>
118     {
119         VM&amp; vm = globalObject-&gt;vm();
120         // FIXME: deprecatedGetDOMStructure uses the prototype off of the wrong global object
121         // We need to pass in the right global object for &quot;i&quot;.
<span class="line-modified">122         Structure* domStructure = WebCore::deprecatedGetDOMStructure&lt;CRuntimeMethod&gt;(exec);</span>
<span class="line-modified">123         CRuntimeMethod* runtimeMethod = new (NotNull, allocateCell&lt;CRuntimeMethod&gt;(vm.heap)) CRuntimeMethod(globalObject, domStructure, method);</span>
124         runtimeMethod-&gt;finishCreation(vm, name);
125         return runtimeMethod;
126     }
127 
128     static Structure* createStructure(VM&amp; vm, JSGlobalObject* globalObject, JSValue prototype)
129     {
130         return Structure::create(vm, globalObject, prototype, TypeInfo(InternalFunctionType, StructureFlags), info());
131     }
132 
133     DECLARE_INFO;
134 
135 private:
<span class="line-modified">136     CRuntimeMethod(JSGlobalObject* globalObject, Structure* structure, Bindings::Method* method)</span>
<span class="line-modified">137         : RuntimeMethod(globalObject, structure, method)</span>
138     {
139     }
140 
141     void finishCreation(VM&amp; vm, const String&amp; name)
142     {
143         Base::finishCreation(vm, name);
144         ASSERT(inherits(vm, info()));
145     }
<span class="line-removed">146 </span>
147 };
148 
149 const ClassInfo CRuntimeMethod::s_info = { &quot;CRuntimeMethod&quot;, &amp;RuntimeMethod::s_info, nullptr, nullptr, CREATE_METHOD_TABLE(CRuntimeMethod) };
150 
<span class="line-modified">151 JSValue CInstance::getMethod(ExecState* exec, PropertyName propertyName)</span>
152 {
153     Method* method = getClass()-&gt;methodNamed(propertyName, this);
<span class="line-modified">154     return CRuntimeMethod::create(exec, exec-&gt;lexicalGlobalObject(), propertyName.publicName(), method);</span>
155 }
156 
<span class="line-modified">157 JSValue CInstance::invokeMethod(ExecState* exec, RuntimeMethod* runtimeMethod)</span>
158 {
<span class="line-modified">159     VM&amp; vm = exec-&gt;vm();</span>
160     auto scope = DECLARE_THROW_SCOPE(vm);
161 
162     if (!asObject(runtimeMethod)-&gt;inherits&lt;CRuntimeMethod&gt;(vm))
<span class="line-modified">163         return throwTypeError(exec, scope, &quot;Attempt to invoke non-plug-in method on plug-in object.&quot;_s);</span>
164 
165     CMethod* method = static_cast&lt;CMethod*&gt;(runtimeMethod-&gt;method());
166     ASSERT(method);
167 
168     NPIdentifier ident = method-&gt;identifier();
169     if (!_object-&gt;_class-&gt;hasMethod(_object, ident))
170         return jsUndefined();
171 
<span class="line-modified">172     unsigned count = exec-&gt;argumentCount();</span>
173     Vector&lt;NPVariant, 8&gt; cArgs(count);
174 
175     unsigned i;
176     for (i = 0; i &lt; count; i++)
<span class="line-modified">177         convertValueToNPVariant(exec, exec-&gt;uncheckedArgument(i), &amp;cArgs[i]);</span>
178 
179     // Invoke the &#39;C&#39; method.
180     bool retval = true;
181     NPVariant resultVariant;
182     VOID_TO_NPVARIANT(resultVariant);
183 
184     {
<span class="line-modified">185         JSLock::DropAllLocks dropAllLocks(exec);</span>
186         ASSERT(globalExceptionString().isNull());
187         retval = _object-&gt;_class-&gt;invoke(_object, ident, cArgs.data(), count, &amp;resultVariant);
<span class="line-modified">188         moveGlobalExceptionToExecState(exec);</span>
189     }
190 
191     if (!retval)
<span class="line-modified">192         throwException(exec, scope, createError(exec, &quot;Error calling method on NPObject.&quot;_s));</span>
193 
194     for (i = 0; i &lt; count; i++)
195         _NPN_ReleaseVariantValue(&amp;cArgs[i]);
196 
<span class="line-modified">197     JSValue resultValue = convertNPVariantToValue(exec, &amp;resultVariant, m_rootObject.get());</span>
198     _NPN_ReleaseVariantValue(&amp;resultVariant);
199     return resultValue;
200 }
201 
202 
<span class="line-modified">203 JSValue CInstance::invokeDefaultMethod(ExecState* exec)</span>
204 {
<span class="line-modified">205     VM&amp; vm = exec-&gt;vm();</span>
206     auto scope = DECLARE_THROW_SCOPE(vm);
207 
208     if (!_object-&gt;_class-&gt;invokeDefault)
209         return jsUndefined();
210 
<span class="line-modified">211     unsigned count = exec-&gt;argumentCount();</span>
212     Vector&lt;NPVariant, 8&gt; cArgs(count);
213 
214     unsigned i;
215     for (i = 0; i &lt; count; i++)
<span class="line-modified">216         convertValueToNPVariant(exec, exec-&gt;uncheckedArgument(i), &amp;cArgs[i]);</span>
217 
218     // Invoke the &#39;C&#39; method.
219     bool retval = true;
220     NPVariant resultVariant;
221     VOID_TO_NPVARIANT(resultVariant);
222     {
<span class="line-modified">223         JSLock::DropAllLocks dropAllLocks(exec);</span>
224         ASSERT(globalExceptionString().isNull());
225         retval = _object-&gt;_class-&gt;invokeDefault(_object, cArgs.data(), count, &amp;resultVariant);
<span class="line-modified">226         moveGlobalExceptionToExecState(exec);</span>
227     }
228 
229     if (!retval)
<span class="line-modified">230         throwException(exec, scope, createError(exec, &quot;Error calling method on NPObject.&quot;_s));</span>
231 
232     for (i = 0; i &lt; count; i++)
233         _NPN_ReleaseVariantValue(&amp;cArgs[i]);
234 
<span class="line-modified">235     JSValue resultValue = convertNPVariantToValue(exec, &amp;resultVariant, m_rootObject.get());</span>
236     _NPN_ReleaseVariantValue(&amp;resultVariant);
237     return resultValue;
238 }
239 
240 bool CInstance::supportsConstruct() const
241 {
242     return _object-&gt;_class-&gt;construct;
243 }
244 
<span class="line-modified">245 JSValue CInstance::invokeConstruct(ExecState* exec, const ArgList&amp; args)</span>
246 {
<span class="line-modified">247     VM&amp; vm = exec-&gt;vm();</span>
248     auto scope = DECLARE_THROW_SCOPE(vm);
249 
250     if (!_object-&gt;_class-&gt;construct)
251         return jsUndefined();
252 
253     unsigned count = args.size();
254     Vector&lt;NPVariant, 8&gt; cArgs(count);
255 
256     unsigned i;
257     for (i = 0; i &lt; count; i++)
<span class="line-modified">258         convertValueToNPVariant(exec, args.at(i), &amp;cArgs[i]);</span>
259 
260     // Invoke the &#39;C&#39; method.
261     bool retval = true;
262     NPVariant resultVariant;
263     VOID_TO_NPVARIANT(resultVariant);
264     {
<span class="line-modified">265         JSLock::DropAllLocks dropAllLocks(exec);</span>
266         ASSERT(globalExceptionString().isNull());
267         retval = _object-&gt;_class-&gt;construct(_object, cArgs.data(), count, &amp;resultVariant);
<span class="line-modified">268         moveGlobalExceptionToExecState(exec);</span>
269     }
270 
271     if (!retval)
<span class="line-modified">272         throwException(exec, scope, createError(exec, &quot;Error calling method on NPObject.&quot;_s));</span>
273 
274     for (i = 0; i &lt; count; i++)
275         _NPN_ReleaseVariantValue(&amp;cArgs[i]);
276 
<span class="line-modified">277     JSValue resultValue = convertNPVariantToValue(exec, &amp;resultVariant, m_rootObject.get());</span>
278     _NPN_ReleaseVariantValue(&amp;resultVariant);
279     return resultValue;
280 }
281 
<span class="line-modified">282 JSValue CInstance::defaultValue(ExecState* exec, PreferredPrimitiveType hint) const</span>
283 {
284     if (hint == PreferString)
<span class="line-modified">285         return stringValue(exec);</span>
286     if (hint == PreferNumber)
<span class="line-modified">287         return numberValue(exec);</span>
<span class="line-modified">288     return valueOf(exec);</span>
289 }
290 
<span class="line-modified">291 JSValue CInstance::stringValue(ExecState* exec) const</span>
292 {
293     JSValue value;
<span class="line-modified">294     if (toJSPrimitive(exec, &quot;toString&quot;, value))</span>
295         return value;
296 
297     // Fallback to default implementation.
<span class="line-modified">298     return jsNontrivialString(exec-&gt;vm(), &quot;NPObject&quot;_s);</span>
299 }
300 
<span class="line-modified">301 JSValue CInstance::numberValue(ExecState*) const</span>
302 {
303     // FIXME: Implement something sensible.
304     return jsNumber(0);
305 }
306 
307 JSValue CInstance::booleanValue() const
308 {
309     // As per ECMA 9.2.
310     return jsBoolean(getObject());
311 }
312 
<span class="line-modified">313 JSValue CInstance::valueOf(ExecState* exec) const</span>
314 {
315     JSValue value;
<span class="line-modified">316     if (toJSPrimitive(exec, &quot;valueOf&quot;, value))</span>
317         return value;
318 
319     // Fallback to default implementation.
<span class="line-modified">320     return stringValue(exec);</span>
321 }
322 
<span class="line-modified">323 bool CInstance::toJSPrimitive(ExecState* exec, const char* name, JSValue&amp; resultValue) const</span>
324 {
<span class="line-modified">325     VM&amp; vm = exec-&gt;vm();</span>
326     auto scope = DECLARE_THROW_SCOPE(vm);
327 
328     NPIdentifier ident = _NPN_GetStringIdentifier(name);
329     if (!_object-&gt;_class-&gt;hasMethod(_object, ident))
330         return false;
331 
332     // Invoke the &#39;C&#39; method.
333     bool retval = true;
334     NPVariant resultVariant;
335     VOID_TO_NPVARIANT(resultVariant);
336 
337     {
<span class="line-modified">338         JSLock::DropAllLocks dropAllLocks(exec);</span>
339         ASSERT(globalExceptionString().isNull());
340         retval = _object-&gt;_class-&gt;invoke(_object, ident, 0, 0, &amp;resultVariant);
<span class="line-modified">341         moveGlobalExceptionToExecState(exec);</span>
342     }
343 
344     if (!retval)
<span class="line-modified">345         throwException(exec, scope, createError(exec, &quot;Error calling method on NPObject.&quot;_s));</span>
346 
<span class="line-modified">347     resultValue = convertNPVariantToValue(exec, &amp;resultVariant, m_rootObject.get());</span>
348     _NPN_ReleaseVariantValue(&amp;resultVariant);
349     return true;
350 }
351 
<span class="line-modified">352 void CInstance::getPropertyNames(ExecState* exec, PropertyNameArray&amp; nameArray)</span>
353 {
354     if (!NP_CLASS_STRUCT_VERSION_HAS_ENUM(_object-&gt;_class) || !_object-&gt;_class-&gt;enumerate)
355         return;
356 
357     uint32_t count;
358     NPIdentifier* identifiers;
359 
360     {
<span class="line-modified">361         JSLock::DropAllLocks dropAllLocks(exec);</span>
362         ASSERT(globalExceptionString().isNull());
363         bool ok = _object-&gt;_class-&gt;enumerate(_object, &amp;identifiers, &amp;count);
<span class="line-modified">364         moveGlobalExceptionToExecState(exec);</span>
365         if (!ok)
366             return;
367     }
368 
<span class="line-modified">369     VM&amp; vm = exec-&gt;vm();</span>
370     for (uint32_t i = 0; i &lt; count; i++) {
371         IdentifierRep* identifier = static_cast&lt;IdentifierRep*&gt;(identifiers[i]);
372 
373         if (identifier-&gt;isString())
<span class="line-modified">374             nameArray.add(identifierFromNPIdentifier(exec, identifier-&gt;string()));</span>
375         else
376             nameArray.add(Identifier::from(vm, identifier-&gt;number()));
377     }
378 
379     // FIXME: This should really call NPN_MemFree but that&#39;s in WebKit
380     free(identifiers);
381 }
382 
383 }
384 }
385 
386 #endif // ENABLE(NETSCAPE_PLUGIN_API)
</pre>
</td>
<td>
<hr />
<pre>
 48 #include &lt;wtf/NeverDestroyed.h&gt;
 49 #include &lt;wtf/StdLibExtras.h&gt;
 50 #include &lt;wtf/Vector.h&gt;
 51 
 52 using namespace WebCore;
 53 
 54 namespace JSC {
 55 namespace Bindings {
 56 
 57 static String&amp; globalExceptionString()
 58 {
 59     static NeverDestroyed&lt;String&gt; exceptionStr;
 60     return exceptionStr;
 61 }
 62 
 63 void CInstance::setGlobalException(String exception)
 64 {
 65     globalExceptionString() = exception;
 66 }
 67 
<span class="line-modified"> 68 void CInstance::moveGlobalExceptionToExecState(JSGlobalObject* lexicalGlobalObject)</span>
 69 {
 70     if (globalExceptionString().isNull())
 71         return;
 72 
 73     {
<span class="line-modified"> 74         VM&amp; vm = lexicalGlobalObject-&gt;vm();</span>
 75         JSLockHolder lock(vm);
 76         auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified"> 77         throwException(lexicalGlobalObject, scope, createError(lexicalGlobalObject, globalExceptionString()));</span>
 78     }
 79 
 80     globalExceptionString() = String();
 81 }
 82 
 83 CInstance::CInstance(NPObject* o, RefPtr&lt;RootObject&gt;&amp;&amp; rootObject)
 84     : Instance(WTFMove(rootObject))
 85 {
 86     _object = _NPN_RetainObject(o);
 87     _class = 0;
 88 }
 89 
 90 CInstance::~CInstance()
 91 {
 92     _NPN_ReleaseObject(_object);
 93 }
 94 
<span class="line-modified"> 95 RuntimeObject* CInstance::newRuntimeObject(JSGlobalObject* lexicalGlobalObject)</span>
 96 {
 97     // FIXME: deprecatedGetDOMStructure uses the prototype off of the wrong global object.
<span class="line-modified"> 98     return CRuntimeObject::create(lexicalGlobalObject-&gt;vm(), WebCore::deprecatedGetDOMStructure&lt;CRuntimeObject&gt;(lexicalGlobalObject), this);</span>
 99 }
100 
101 Class *CInstance::getClass() const
102 {
103     if (!_class)
104         _class = CClass::classForIsA(_object-&gt;_class);
105     return _class;
106 }
107 
108 bool CInstance::supportsInvokeDefaultMethod() const
109 {
110     return _object-&gt;_class-&gt;invokeDefault;
111 }
112 
<span class="line-modified">113 class CRuntimeMethod final : public RuntimeMethod {</span>
114 public:
<span class="line-modified">115     using Base = RuntimeMethod;</span>
116 
<span class="line-modified">117     static CRuntimeMethod* create(JSGlobalObject* lexicalGlobalObject, JSGlobalObject* globalObject, const String&amp; name, Bindings::Method* method)</span>
118     {
119         VM&amp; vm = globalObject-&gt;vm();
120         // FIXME: deprecatedGetDOMStructure uses the prototype off of the wrong global object
121         // We need to pass in the right global object for &quot;i&quot;.
<span class="line-modified">122         Structure* domStructure = WebCore::deprecatedGetDOMStructure&lt;CRuntimeMethod&gt;(lexicalGlobalObject);</span>
<span class="line-modified">123         CRuntimeMethod* runtimeMethod = new (NotNull, allocateCell&lt;CRuntimeMethod&gt;(vm.heap)) CRuntimeMethod(vm, domStructure, method);</span>
124         runtimeMethod-&gt;finishCreation(vm, name);
125         return runtimeMethod;
126     }
127 
128     static Structure* createStructure(VM&amp; vm, JSGlobalObject* globalObject, JSValue prototype)
129     {
130         return Structure::create(vm, globalObject, prototype, TypeInfo(InternalFunctionType, StructureFlags), info());
131     }
132 
133     DECLARE_INFO;
134 
135 private:
<span class="line-modified">136     CRuntimeMethod(VM&amp; vm, Structure* structure, Bindings::Method* method)</span>
<span class="line-modified">137         : RuntimeMethod(vm, structure, method)</span>
138     {
139     }
140 
141     void finishCreation(VM&amp; vm, const String&amp; name)
142     {
143         Base::finishCreation(vm, name);
144         ASSERT(inherits(vm, info()));
145     }

146 };
147 
148 const ClassInfo CRuntimeMethod::s_info = { &quot;CRuntimeMethod&quot;, &amp;RuntimeMethod::s_info, nullptr, nullptr, CREATE_METHOD_TABLE(CRuntimeMethod) };
149 
<span class="line-modified">150 JSValue CInstance::getMethod(JSGlobalObject* lexicalGlobalObject, PropertyName propertyName)</span>
151 {
152     Method* method = getClass()-&gt;methodNamed(propertyName, this);
<span class="line-modified">153     return CRuntimeMethod::create(lexicalGlobalObject, lexicalGlobalObject, propertyName.publicName(), method);</span>
154 }
155 
<span class="line-modified">156 JSValue CInstance::invokeMethod(JSGlobalObject* lexicalGlobalObject, CallFrame* callFrame, RuntimeMethod* runtimeMethod)</span>
157 {
<span class="line-modified">158     VM&amp; vm = lexicalGlobalObject-&gt;vm();</span>
159     auto scope = DECLARE_THROW_SCOPE(vm);
160 
161     if (!asObject(runtimeMethod)-&gt;inherits&lt;CRuntimeMethod&gt;(vm))
<span class="line-modified">162         return throwTypeError(lexicalGlobalObject, scope, &quot;Attempt to invoke non-plug-in method on plug-in object.&quot;_s);</span>
163 
164     CMethod* method = static_cast&lt;CMethod*&gt;(runtimeMethod-&gt;method());
165     ASSERT(method);
166 
167     NPIdentifier ident = method-&gt;identifier();
168     if (!_object-&gt;_class-&gt;hasMethod(_object, ident))
169         return jsUndefined();
170 
<span class="line-modified">171     unsigned count = callFrame-&gt;argumentCount();</span>
172     Vector&lt;NPVariant, 8&gt; cArgs(count);
173 
174     unsigned i;
175     for (i = 0; i &lt; count; i++)
<span class="line-modified">176         convertValueToNPVariant(lexicalGlobalObject, callFrame-&gt;uncheckedArgument(i), &amp;cArgs[i]);</span>
177 
178     // Invoke the &#39;C&#39; method.
179     bool retval = true;
180     NPVariant resultVariant;
181     VOID_TO_NPVARIANT(resultVariant);
182 
183     {
<span class="line-modified">184         JSLock::DropAllLocks dropAllLocks(lexicalGlobalObject);</span>
185         ASSERT(globalExceptionString().isNull());
186         retval = _object-&gt;_class-&gt;invoke(_object, ident, cArgs.data(), count, &amp;resultVariant);
<span class="line-modified">187         moveGlobalExceptionToExecState(lexicalGlobalObject);</span>
188     }
189 
190     if (!retval)
<span class="line-modified">191         throwException(lexicalGlobalObject, scope, createError(lexicalGlobalObject, &quot;Error calling method on NPObject.&quot;_s));</span>
192 
193     for (i = 0; i &lt; count; i++)
194         _NPN_ReleaseVariantValue(&amp;cArgs[i]);
195 
<span class="line-modified">196     JSValue resultValue = convertNPVariantToValue(lexicalGlobalObject, &amp;resultVariant, m_rootObject.get());</span>
197     _NPN_ReleaseVariantValue(&amp;resultVariant);
198     return resultValue;
199 }
200 
201 
<span class="line-modified">202 JSValue CInstance::invokeDefaultMethod(JSGlobalObject* lexicalGlobalObject, CallFrame* callFrame)</span>
203 {
<span class="line-modified">204     VM&amp; vm = lexicalGlobalObject-&gt;vm();</span>
205     auto scope = DECLARE_THROW_SCOPE(vm);
206 
207     if (!_object-&gt;_class-&gt;invokeDefault)
208         return jsUndefined();
209 
<span class="line-modified">210     unsigned count = callFrame-&gt;argumentCount();</span>
211     Vector&lt;NPVariant, 8&gt; cArgs(count);
212 
213     unsigned i;
214     for (i = 0; i &lt; count; i++)
<span class="line-modified">215         convertValueToNPVariant(lexicalGlobalObject, callFrame-&gt;uncheckedArgument(i), &amp;cArgs[i]);</span>
216 
217     // Invoke the &#39;C&#39; method.
218     bool retval = true;
219     NPVariant resultVariant;
220     VOID_TO_NPVARIANT(resultVariant);
221     {
<span class="line-modified">222         JSLock::DropAllLocks dropAllLocks(lexicalGlobalObject);</span>
223         ASSERT(globalExceptionString().isNull());
224         retval = _object-&gt;_class-&gt;invokeDefault(_object, cArgs.data(), count, &amp;resultVariant);
<span class="line-modified">225         moveGlobalExceptionToExecState(lexicalGlobalObject);</span>
226     }
227 
228     if (!retval)
<span class="line-modified">229         throwException(lexicalGlobalObject, scope, createError(lexicalGlobalObject, &quot;Error calling method on NPObject.&quot;_s));</span>
230 
231     for (i = 0; i &lt; count; i++)
232         _NPN_ReleaseVariantValue(&amp;cArgs[i]);
233 
<span class="line-modified">234     JSValue resultValue = convertNPVariantToValue(lexicalGlobalObject, &amp;resultVariant, m_rootObject.get());</span>
235     _NPN_ReleaseVariantValue(&amp;resultVariant);
236     return resultValue;
237 }
238 
239 bool CInstance::supportsConstruct() const
240 {
241     return _object-&gt;_class-&gt;construct;
242 }
243 
<span class="line-modified">244 JSValue CInstance::invokeConstruct(JSGlobalObject* lexicalGlobalObject, CallFrame*, const ArgList&amp; args)</span>
245 {
<span class="line-modified">246     VM&amp; vm = lexicalGlobalObject-&gt;vm();</span>
247     auto scope = DECLARE_THROW_SCOPE(vm);
248 
249     if (!_object-&gt;_class-&gt;construct)
250         return jsUndefined();
251 
252     unsigned count = args.size();
253     Vector&lt;NPVariant, 8&gt; cArgs(count);
254 
255     unsigned i;
256     for (i = 0; i &lt; count; i++)
<span class="line-modified">257         convertValueToNPVariant(lexicalGlobalObject, args.at(i), &amp;cArgs[i]);</span>
258 
259     // Invoke the &#39;C&#39; method.
260     bool retval = true;
261     NPVariant resultVariant;
262     VOID_TO_NPVARIANT(resultVariant);
263     {
<span class="line-modified">264         JSLock::DropAllLocks dropAllLocks(lexicalGlobalObject);</span>
265         ASSERT(globalExceptionString().isNull());
266         retval = _object-&gt;_class-&gt;construct(_object, cArgs.data(), count, &amp;resultVariant);
<span class="line-modified">267         moveGlobalExceptionToExecState(lexicalGlobalObject);</span>
268     }
269 
270     if (!retval)
<span class="line-modified">271         throwException(lexicalGlobalObject, scope, createError(lexicalGlobalObject, &quot;Error calling method on NPObject.&quot;_s));</span>
272 
273     for (i = 0; i &lt; count; i++)
274         _NPN_ReleaseVariantValue(&amp;cArgs[i]);
275 
<span class="line-modified">276     JSValue resultValue = convertNPVariantToValue(lexicalGlobalObject, &amp;resultVariant, m_rootObject.get());</span>
277     _NPN_ReleaseVariantValue(&amp;resultVariant);
278     return resultValue;
279 }
280 
<span class="line-modified">281 JSValue CInstance::defaultValue(JSGlobalObject* lexicalGlobalObject, PreferredPrimitiveType hint) const</span>
282 {
283     if (hint == PreferString)
<span class="line-modified">284         return stringValue(lexicalGlobalObject);</span>
285     if (hint == PreferNumber)
<span class="line-modified">286         return numberValue(lexicalGlobalObject);</span>
<span class="line-modified">287     return valueOf(lexicalGlobalObject);</span>
288 }
289 
<span class="line-modified">290 JSValue CInstance::stringValue(JSGlobalObject* lexicalGlobalObject) const</span>
291 {
292     JSValue value;
<span class="line-modified">293     if (toJSPrimitive(lexicalGlobalObject, &quot;toString&quot;, value))</span>
294         return value;
295 
296     // Fallback to default implementation.
<span class="line-modified">297     return jsNontrivialString(lexicalGlobalObject-&gt;vm(), &quot;NPObject&quot;_s);</span>
298 }
299 
<span class="line-modified">300 JSValue CInstance::numberValue(JSGlobalObject*) const</span>
301 {
302     // FIXME: Implement something sensible.
303     return jsNumber(0);
304 }
305 
306 JSValue CInstance::booleanValue() const
307 {
308     // As per ECMA 9.2.
309     return jsBoolean(getObject());
310 }
311 
<span class="line-modified">312 JSValue CInstance::valueOf(JSGlobalObject* lexicalGlobalObject) const</span>
313 {
314     JSValue value;
<span class="line-modified">315     if (toJSPrimitive(lexicalGlobalObject, &quot;valueOf&quot;, value))</span>
316         return value;
317 
318     // Fallback to default implementation.
<span class="line-modified">319     return stringValue(lexicalGlobalObject);</span>
320 }
321 
<span class="line-modified">322 bool CInstance::toJSPrimitive(JSGlobalObject* lexicalGlobalObject, const char* name, JSValue&amp; resultValue) const</span>
323 {
<span class="line-modified">324     VM&amp; vm = lexicalGlobalObject-&gt;vm();</span>
325     auto scope = DECLARE_THROW_SCOPE(vm);
326 
327     NPIdentifier ident = _NPN_GetStringIdentifier(name);
328     if (!_object-&gt;_class-&gt;hasMethod(_object, ident))
329         return false;
330 
331     // Invoke the &#39;C&#39; method.
332     bool retval = true;
333     NPVariant resultVariant;
334     VOID_TO_NPVARIANT(resultVariant);
335 
336     {
<span class="line-modified">337         JSLock::DropAllLocks dropAllLocks(lexicalGlobalObject);</span>
338         ASSERT(globalExceptionString().isNull());
339         retval = _object-&gt;_class-&gt;invoke(_object, ident, 0, 0, &amp;resultVariant);
<span class="line-modified">340         moveGlobalExceptionToExecState(lexicalGlobalObject);</span>
341     }
342 
343     if (!retval)
<span class="line-modified">344         throwException(lexicalGlobalObject, scope, createError(lexicalGlobalObject, &quot;Error calling method on NPObject.&quot;_s));</span>
345 
<span class="line-modified">346     resultValue = convertNPVariantToValue(lexicalGlobalObject, &amp;resultVariant, m_rootObject.get());</span>
347     _NPN_ReleaseVariantValue(&amp;resultVariant);
348     return true;
349 }
350 
<span class="line-modified">351 void CInstance::getPropertyNames(JSGlobalObject* lexicalGlobalObject, PropertyNameArray&amp; nameArray)</span>
352 {
353     if (!NP_CLASS_STRUCT_VERSION_HAS_ENUM(_object-&gt;_class) || !_object-&gt;_class-&gt;enumerate)
354         return;
355 
356     uint32_t count;
357     NPIdentifier* identifiers;
358 
359     {
<span class="line-modified">360         JSLock::DropAllLocks dropAllLocks(lexicalGlobalObject);</span>
361         ASSERT(globalExceptionString().isNull());
362         bool ok = _object-&gt;_class-&gt;enumerate(_object, &amp;identifiers, &amp;count);
<span class="line-modified">363         moveGlobalExceptionToExecState(lexicalGlobalObject);</span>
364         if (!ok)
365             return;
366     }
367 
<span class="line-modified">368     VM&amp; vm = lexicalGlobalObject-&gt;vm();</span>
369     for (uint32_t i = 0; i &lt; count; i++) {
370         IdentifierRep* identifier = static_cast&lt;IdentifierRep*&gt;(identifiers[i]);
371 
372         if (identifier-&gt;isString())
<span class="line-modified">373             nameArray.add(identifierFromNPIdentifier(lexicalGlobalObject, identifier-&gt;string()));</span>
374         else
375             nameArray.add(Identifier::from(vm, identifier-&gt;number()));
376     }
377 
378     // FIXME: This should really call NPN_MemFree but that&#39;s in WebKit
379     free(identifiers);
380 }
381 
382 }
383 }
384 
385 #endif // ENABLE(NETSCAPE_PLUGIN_API)
</pre>
</td>
</tr>
</table>
<center><a href="CRuntimeObject.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="c_instance.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>