<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New modules/javafx.web/src/main/native/Source/WebCore/css/DOMCSSRegisterCustomProperty.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (C) 2018 Apple Inc. All rights reserved.
  3  *
  4  * Redistribution and use in source and binary forms, with or without
  5  * modification, are permitted provided that the following conditions
  6  * are met:
  7  * 1. Redistributions of source code must retain the above copyright
  8  *    notice, this list of conditions and the following disclaimer.
  9  * 2. Redistributions in binary form must reproduce the above copyright
 10  *    notice, this list of conditions and the following disclaimer in the
 11  *    documentation and/or other materials provided with the distribution.
 12  *
 13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. ``AS IS&#39;&#39; AND ANY
 14  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 15  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 16  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE INC. OR
 17  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 18  * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 19  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 20  * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 21  * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 22  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 23  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #include &quot;config.h&quot;
 27 #include &quot;DOMCSSRegisterCustomProperty.h&quot;
 28 
 29 #include &quot;CSSCustomPropertyValue.h&quot;
 30 #include &quot;CSSPropertyNames.h&quot;
 31 #include &quot;CSSPropertyParser.h&quot;
 32 #include &quot;CSSRegisteredCustomProperty.h&quot;
 33 #include &quot;CSSTokenizer.h&quot;
 34 #include &quot;DOMCSSNamespace.h&quot;
 35 #include &quot;Document.h&quot;
 36 #include &quot;StyleBuilder.h&quot;
 37 #include &quot;StyleBuilderConverter.h&quot;
 38 #include &quot;StyleResolver.h&quot;
 39 #include &lt;wtf/text/WTFString.h&gt;
 40 
 41 namespace WebCore {
 42 
 43 ExceptionOr&lt;void&gt; DOMCSSRegisterCustomProperty::registerProperty(Document&amp; document, const DOMCSSCustomPropertyDescriptor&amp; descriptor)
 44 {
 45     if (!isCustomPropertyName(descriptor.name))
 46         return Exception { SyntaxError, &quot;The name of this property is not a custom property name.&quot; };
 47 
 48     RefPtr&lt;CSSCustomPropertyValue&gt; initialValue;
 49     if (!descriptor.initialValue.isEmpty()) {
 50         CSSTokenizer tokenizer(descriptor.initialValue);
 51         Style::Resolver styleResolver(document);
 52 
 53         // We need to initialize this so that we can successfully parse computationally dependent values (like em units).
 54         // We don&#39;t actually need the values to be accurate, since they will be rejected later anyway
 55         auto style = styleResolver.defaultStyleForElement(nullptr);
 56 
 57         HashSet&lt;CSSPropertyID&gt; dependencies;
 58         CSSPropertyParser::collectParsedCustomPropertyValueDependencies(descriptor.syntax, false, dependencies, tokenizer.tokenRange(), strictCSSParserContext());
 59 
 60         if (!dependencies.isEmpty())
 61             return Exception { SyntaxError, &quot;The given initial value must be computationally independent.&quot; };
 62 
 63 
 64         Style::MatchResult matchResult;
 65 
 66         auto parentStyle = RenderStyle::clone(*style);
 67         Style::Builder dummyBuilder(*style, { document, parentStyle }, matchResult, { });
 68 
 69         initialValue = CSSPropertyParser::parseTypedCustomPropertyValue(descriptor.name, descriptor.syntax, tokenizer.tokenRange(), dummyBuilder.state(), strictCSSParserContext());
 70 
 71         if (!initialValue || !initialValue-&gt;isResolved())
 72             return Exception { SyntaxError, &quot;The given initial value does not parse for the given syntax.&quot; };
 73 
 74         initialValue-&gt;collectDirectComputationalDependencies(dependencies);
 75         initialValue-&gt;collectDirectRootComputationalDependencies(dependencies);
 76 
 77         if (!dependencies.isEmpty())
 78             return Exception { SyntaxError, &quot;The given initial value must be computationally independent.&quot; };
 79     }
 80 
 81     CSSRegisteredCustomProperty property { descriptor.name, descriptor.syntax, descriptor.inherits, WTFMove(initialValue) };
 82     if (!document.registerCSSProperty(WTFMove(property)))
 83         return Exception { InvalidModificationError, &quot;This property has already been registered.&quot; };
 84 
 85     document.styleScope().didChangeStyleSheetEnvironment();
 86 
 87     return { };
 88 }
 89 
 90 DOMCSSRegisterCustomProperty* DOMCSSRegisterCustomProperty::from(DOMCSSNamespace&amp; css)
 91 {
 92     auto* supplement = static_cast&lt;DOMCSSRegisterCustomProperty*&gt;(Supplement&lt;DOMCSSNamespace&gt;::from(&amp;css, supplementName()));
 93     if (!supplement) {
 94         auto newSupplement = makeUnique&lt;DOMCSSRegisterCustomProperty&gt;(css);
 95         supplement = newSupplement.get();
 96         provideTo(&amp;css, supplementName(), WTFMove(newSupplement));
 97     }
 98     return supplement;
 99 }
100 
101 const char* DOMCSSRegisterCustomProperty::supplementName()
102 {
103     return &quot;DOMCSSRegisterCustomProperty&quot;;
104 }
105 
106 }
    </pre>
  </body>
</html>