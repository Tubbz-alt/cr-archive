<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/JavaScriptCore/runtime/IteratorOperations.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (C) 2015 Yusuke Suzuki &lt;utatane.tea@gmail.com&gt;.
  3  * Copyright (C) 2016-2017 Apple Inc. All rights reserved.
  4  *
  5  * Redistribution and use in source and binary forms, with or without
  6  * modification, are permitted provided that the following conditions
  7  * are met:
  8  * 1. Redistributions of source code must retain the above copyright
  9  *    notice, this list of conditions and the following disclaimer.
 10  * 2. Redistributions in binary form must reproduce the above copyright
 11  *    notice, this list of conditions and the following disclaimer in the
 12  *    documentation and/or other materials provided with the distribution.
 13  *
 14  * THIS SOFTWARE IS PROVIDED BY APPLE INC. ``AS IS&#39;&#39; AND ANY
 15  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 16  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 17  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE INC. OR
 18  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 19  * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 20  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 21  * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 22  * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 23  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 24  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 25  */
 26 
 27 #include &quot;config.h&quot;
 28 #include &quot;IteratorOperations.h&quot;
 29 
 30 #include &quot;CatchScope.h&quot;
 31 #include &quot;Error.h&quot;
 32 #include &quot;JSCInlines.h&quot;
 33 #include &quot;ObjectConstructor.h&quot;
 34 
 35 namespace JSC {
 36 
<a name="1" id="anc1"></a><span class="line-modified"> 37 JSValue iteratorNext(ExecState* exec, IterationRecord iterationRecord, JSValue argument)</span>
 38 {
<a name="2" id="anc2"></a><span class="line-modified"> 39     VM&amp; vm = exec-&gt;vm();</span>
 40     auto scope = DECLARE_THROW_SCOPE(vm);
 41 
 42     JSValue iterator = iterationRecord.iterator;
 43     JSValue nextFunction = iterationRecord.nextMethod;
 44 
 45     CallData nextFunctionCallData;
 46     CallType nextFunctionCallType = getCallData(vm, nextFunction, nextFunctionCallData);
 47     if (nextFunctionCallType == CallType::None)
<a name="3" id="anc3"></a><span class="line-modified"> 48         return throwTypeError(exec, scope);</span>
 49 
 50     MarkedArgumentBuffer nextFunctionArguments;
 51     if (!argument.isEmpty())
 52         nextFunctionArguments.append(argument);
 53     ASSERT(!nextFunctionArguments.hasOverflowed());
<a name="4" id="anc4"></a><span class="line-modified"> 54     JSValue result = call(exec, nextFunction, nextFunctionCallType, nextFunctionCallData, iterator, nextFunctionArguments);</span>
 55     RETURN_IF_EXCEPTION(scope, JSValue());
 56 
 57     if (!result.isObject())
<a name="5" id="anc5"></a><span class="line-modified"> 58         return throwTypeError(exec, scope, &quot;Iterator result interface is not an object.&quot;_s);</span>
 59 
 60     return result;
 61 }
 62 
<a name="6" id="anc6"></a><span class="line-modified"> 63 JSValue iteratorValue(ExecState* exec, JSValue iterResult)</span>
 64 {
<a name="7" id="anc7"></a><span class="line-modified"> 65     return iterResult.get(exec, exec-&gt;vm().propertyNames-&gt;value);</span>
 66 }
 67 
<a name="8" id="anc8"></a><span class="line-modified"> 68 bool iteratorComplete(ExecState* exec, JSValue iterResult)</span>
 69 {
<a name="9" id="anc9"></a><span class="line-modified"> 70     JSValue done = iterResult.get(exec, exec-&gt;vm().propertyNames-&gt;done);</span>
<span class="line-modified"> 71     return done.toBoolean(exec);</span>
 72 }
 73 
<a name="10" id="anc10"></a><span class="line-modified"> 74 JSValue iteratorStep(ExecState* exec, IterationRecord iterationRecord)</span>
 75 {
<a name="11" id="anc11"></a><span class="line-modified"> 76     VM&amp; vm = exec-&gt;vm();</span>
 77     auto scope = DECLARE_THROW_SCOPE(vm);
 78 
<a name="12" id="anc12"></a><span class="line-modified"> 79     JSValue result = iteratorNext(exec, iterationRecord);</span>
 80     RETURN_IF_EXCEPTION(scope, JSValue());
<a name="13" id="anc13"></a><span class="line-modified"> 81     bool done = iteratorComplete(exec, result);</span>
 82     RETURN_IF_EXCEPTION(scope, JSValue());
 83     if (done)
 84         return jsBoolean(false);
 85     return result;
 86 }
 87 
<a name="14" id="anc14"></a><span class="line-modified"> 88 void iteratorClose(ExecState* exec, IterationRecord iterationRecord)</span>
 89 {
<a name="15" id="anc15"></a><span class="line-modified"> 90     VM&amp; vm = exec-&gt;vm();</span>
 91     auto throwScope = DECLARE_THROW_SCOPE(vm);
 92     auto catchScope = DECLARE_CATCH_SCOPE(vm);
 93 
 94     Exception* exception = nullptr;
 95     if (UNLIKELY(catchScope.exception())) {
 96         exception = catchScope.exception();
 97         catchScope.clearException();
 98     }
<a name="16" id="anc16"></a><span class="line-modified"> 99     JSValue returnFunction = iterationRecord.iterator.get(exec, vm.propertyNames-&gt;returnKeyword);</span>
100     RETURN_IF_EXCEPTION(throwScope, void());
101 
102     if (returnFunction.isUndefined()) {
103         if (exception)
<a name="17" id="anc17"></a><span class="line-modified">104             throwException(exec, throwScope, exception);</span>
105         return;
106     }
107 
108     CallData returnFunctionCallData;
109     CallType returnFunctionCallType = getCallData(vm, returnFunction, returnFunctionCallData);
110     if (returnFunctionCallType == CallType::None) {
111         if (exception)
<a name="18" id="anc18"></a><span class="line-modified">112             throwException(exec, throwScope, exception);</span>
113         else
<a name="19" id="anc19"></a><span class="line-modified">114             throwTypeError(exec, throwScope);</span>
115         return;
116     }
117 
118     MarkedArgumentBuffer returnFunctionArguments;
119     ASSERT(!returnFunctionArguments.hasOverflowed());
<a name="20" id="anc20"></a><span class="line-modified">120     JSValue innerResult = call(exec, returnFunction, returnFunctionCallType, returnFunctionCallData, iterationRecord.iterator, returnFunctionArguments);</span>
121 
122     if (exception) {
<a name="21" id="anc21"></a><span class="line-modified">123         throwException(exec, throwScope, exception);</span>
124         return;
125     }
126 
127     RETURN_IF_EXCEPTION(throwScope, void());
128 
129     if (!innerResult.isObject()) {
<a name="22" id="anc22"></a><span class="line-modified">130         throwTypeError(exec, throwScope, &quot;Iterator result interface is not an object.&quot;_s);</span>
131         return;
132     }
133 }
134 
135 static const PropertyOffset valuePropertyOffset = 0;
136 static const PropertyOffset donePropertyOffset = 1;
137 
138 Structure* createIteratorResultObjectStructure(VM&amp; vm, JSGlobalObject&amp; globalObject)
139 {
140     Structure* iteratorResultStructure = vm.structureCache.emptyObjectStructureForPrototype(&amp;globalObject, globalObject.objectPrototype(), JSFinalObject::defaultInlineCapacity());
141     PropertyOffset offset;
142     iteratorResultStructure = Structure::addPropertyTransition(vm, iteratorResultStructure, vm.propertyNames-&gt;value, 0, offset);
143     RELEASE_ASSERT(offset == valuePropertyOffset);
144     iteratorResultStructure = Structure::addPropertyTransition(vm, iteratorResultStructure, vm.propertyNames-&gt;done, 0, offset);
145     RELEASE_ASSERT(offset == donePropertyOffset);
146     return iteratorResultStructure;
147 }
148 
<a name="23" id="anc23"></a><span class="line-modified">149 JSObject* createIteratorResultObject(ExecState* exec, JSValue value, bool done)</span>
150 {
<a name="24" id="anc24"></a><span class="line-modified">151     VM&amp; vm = exec-&gt;vm();</span>
<span class="line-modified">152     JSObject* resultObject = constructEmptyObject(exec, exec-&gt;lexicalGlobalObject()-&gt;iteratorResultObjectStructure());</span>
153     resultObject-&gt;putDirect(vm, valuePropertyOffset, value);
154     resultObject-&gt;putDirect(vm, donePropertyOffset, jsBoolean(done));
155     return resultObject;
156 }
157 
<a name="25" id="anc25"></a><span class="line-modified">158 bool hasIteratorMethod(ExecState&amp; state, JSValue value)</span>
159 {
<a name="26" id="anc26"></a><span class="line-modified">160     auto&amp; vm = state.vm();</span>
161     auto scope = DECLARE_THROW_SCOPE(vm);
162 
163     if (!value.isObject())
164         return false;
165 
166     JSObject* object = asObject(value);
167     CallData callData;
168     CallType callType;
<a name="27" id="anc27"></a><span class="line-modified">169     JSValue applyMethod = object-&gt;getMethod(&amp;state, callData, callType, vm.propertyNames-&gt;iteratorSymbol, &quot;Symbol.iterator property should be callable&quot;_s);</span>
170     RETURN_IF_EXCEPTION(scope, false);
171 
172     return !applyMethod.isUndefined();
173 }
174 
<a name="28" id="anc28"></a><span class="line-modified">175 JSValue iteratorMethod(ExecState&amp; state, JSObject* object)</span>
176 {
<a name="29" id="anc29"></a><span class="line-modified">177     auto&amp; vm = state.vm();</span>
178     auto scope = DECLARE_THROW_SCOPE(vm);
179 
180     CallData callData;
181     CallType callType;
<a name="30" id="anc30"></a><span class="line-modified">182     JSValue method = object-&gt;getMethod(&amp;state, callData, callType, vm.propertyNames-&gt;iteratorSymbol, &quot;Symbol.iterator property should be callable&quot;_s);</span>
183     RETURN_IF_EXCEPTION(scope, jsUndefined());
184 
185     return method;
186 }
187 
<a name="31" id="anc31"></a><span class="line-modified">188 IterationRecord iteratorForIterable(ExecState&amp; state, JSObject* object, JSValue iteratorMethod)</span>
189 {
<a name="32" id="anc32"></a><span class="line-modified">190     VM&amp; vm = state.vm();</span>
191     auto scope = DECLARE_THROW_SCOPE(vm);
192 
193     CallData iteratorMethodCallData;
194     CallType iteratorMethodCallType = getCallData(vm, iteratorMethod, iteratorMethodCallData);
195     if (iteratorMethodCallType == CallType::None) {
<a name="33" id="anc33"></a><span class="line-modified">196         throwTypeError(&amp;state, scope);</span>
197         return { };
198     }
199 
200     ArgList iteratorMethodArguments;
<a name="34" id="anc34"></a><span class="line-modified">201     JSValue iterator = call(&amp;state, iteratorMethod, iteratorMethodCallType, iteratorMethodCallData, object, iteratorMethodArguments);</span>
202     RETURN_IF_EXCEPTION(scope, { });
203 
204     if (!iterator.isObject()) {
<a name="35" id="anc35"></a><span class="line-modified">205         throwTypeError(&amp;state, scope);</span>
206         return { };
207     }
208 
<a name="36" id="anc36"></a><span class="line-modified">209     JSValue nextMethod = iterator.getObject()-&gt;get(&amp;state, vm.propertyNames-&gt;next);</span>
210     RETURN_IF_EXCEPTION(scope, { });
211 
212     return { iterator, nextMethod };
213 }
214 
<a name="37" id="anc37"></a><span class="line-modified">215 IterationRecord iteratorForIterable(ExecState* state, JSValue iterable)</span>
216 {
<a name="38" id="anc38"></a><span class="line-modified">217     VM&amp; vm = state-&gt;vm();</span>
218     auto scope = DECLARE_THROW_SCOPE(vm);
219 
<a name="39" id="anc39"></a><span class="line-modified">220     JSValue iteratorFunction = iterable.get(state, vm.propertyNames-&gt;iteratorSymbol);</span>
221     RETURN_IF_EXCEPTION(scope, { });
222 
223     CallData iteratorFunctionCallData;
224     CallType iteratorFunctionCallType = getCallData(vm, iteratorFunction, iteratorFunctionCallData);
225     if (iteratorFunctionCallType == CallType::None) {
<a name="40" id="anc40"></a><span class="line-modified">226         throwTypeError(state, scope);</span>
227         return { };
228     }
229 
230     ArgList iteratorFunctionArguments;
<a name="41" id="anc41"></a><span class="line-modified">231     JSValue iterator = call(state, iteratorFunction, iteratorFunctionCallType, iteratorFunctionCallData, iterable, iteratorFunctionArguments);</span>
232     RETURN_IF_EXCEPTION(scope, { });
233 
234     if (!iterator.isObject()) {
<a name="42" id="anc42"></a><span class="line-modified">235         throwTypeError(state, scope);</span>
236         return { };
237     }
238 
<a name="43" id="anc43"></a><span class="line-modified">239     JSValue nextMethod = iterator.getObject()-&gt;get(state, vm.propertyNames-&gt;next);</span>
240     RETURN_IF_EXCEPTION(scope, { });
241 
242     return { iterator, nextMethod };
243 }
244 
245 } // namespace JSC
<a name="44" id="anc44"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="44" type="hidden" />
</body>
</html>