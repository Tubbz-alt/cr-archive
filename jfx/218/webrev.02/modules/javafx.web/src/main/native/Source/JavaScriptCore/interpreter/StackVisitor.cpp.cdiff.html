<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.web/src/main/native/Source/JavaScriptCore/interpreter/StackVisitor.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="ShadowChickenInlines.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="StackVisitor.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/JavaScriptCore/interpreter/StackVisitor.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 24,39 ***</span>
   */
  
  #include &quot;config.h&quot;
  #include &quot;StackVisitor.h&quot;
  
<span class="line-removed">- #include &quot;CallFrameInlines.h&quot;</span>
  #include &quot;ClonedArguments.h&quot;
  #include &quot;DebuggerPrimitives.h&quot;
  #include &quot;InlineCallFrame.h&quot;
  #include &quot;Interpreter.h&quot;
  #include &quot;JSCInlines.h&quot;
  #include &quot;WasmCallee.h&quot;
  #include &quot;WasmIndexOrName.h&quot;
  #include &quot;WebAssemblyFunction.h&quot;
  #include &lt;wtf/text/StringBuilder.h&gt;
  
  namespace JSC {
  
<span class="line-modified">! StackVisitor::StackVisitor(CallFrame* startFrame, VM* vm)</span>
  {
      m_frame.m_index = 0;
      m_frame.m_isWasmFrame = false;
      CallFrame* topFrame;
      if (startFrame) {
<span class="line-modified">!         ASSERT(vm);</span>
<span class="line-removed">-         ASSERT(!vm-&gt;topCallFrame || reinterpret_cast&lt;void*&gt;(vm-&gt;topCallFrame) != vm-&gt;topEntryFrame);</span>
  
<span class="line-modified">!         m_frame.m_entryFrame = vm-&gt;topEntryFrame;</span>
<span class="line-modified">!         topFrame = vm-&gt;topCallFrame;</span>
  
          if (topFrame &amp;&amp; topFrame-&gt;isStackOverflowFrame()) {
              topFrame = topFrame-&gt;callerFrame(m_frame.m_entryFrame);
<span class="line-modified">!             m_topEntryFrameIsEmpty = (m_frame.m_entryFrame != vm-&gt;topEntryFrame);</span>
<span class="line-modified">!             if (startFrame == vm-&gt;topCallFrame)</span>
                  startFrame = topFrame;
          }
  
      } else {
          m_frame.m_entryFrame = 0;
<span class="line-new-header">--- 24,38 ---</span>
   */
  
  #include &quot;config.h&quot;
  #include &quot;StackVisitor.h&quot;
  
  #include &quot;ClonedArguments.h&quot;
  #include &quot;DebuggerPrimitives.h&quot;
  #include &quot;InlineCallFrame.h&quot;
  #include &quot;Interpreter.h&quot;
  #include &quot;JSCInlines.h&quot;
<span class="line-added">+ #include &quot;RegisterAtOffsetList.h&quot;</span>
  #include &quot;WasmCallee.h&quot;
  #include &quot;WasmIndexOrName.h&quot;
  #include &quot;WebAssemblyFunction.h&quot;
  #include &lt;wtf/text/StringBuilder.h&gt;
  
  namespace JSC {
  
<span class="line-modified">! StackVisitor::StackVisitor(CallFrame* startFrame, VM&amp; vm)</span>
  {
      m_frame.m_index = 0;
      m_frame.m_isWasmFrame = false;
      CallFrame* topFrame;
      if (startFrame) {
<span class="line-modified">!         ASSERT(!vm.topCallFrame || reinterpret_cast&lt;void*&gt;(vm.topCallFrame) != vm.topEntryFrame);</span>
  
<span class="line-modified">!         m_frame.m_entryFrame = vm.topEntryFrame;</span>
<span class="line-modified">!         topFrame = vm.topCallFrame;</span>
  
          if (topFrame &amp;&amp; topFrame-&gt;isStackOverflowFrame()) {
              topFrame = topFrame-&gt;callerFrame(m_frame.m_entryFrame);
<span class="line-modified">!             m_topEntryFrameIsEmpty = (m_frame.m_entryFrame != vm.topEntryFrame);</span>
<span class="line-modified">!             if (startFrame == vm.topCallFrame)</span>
                  startFrame = topFrame;
          }
  
      } else {
          m_frame.m_entryFrame = 0;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 168,21 ***</span>
      m_frame.m_callee = callee;
  
      if (callFrame-&gt;isAnyWasmCallee()) {
          m_frame.m_isWasmFrame = true;
          m_frame.m_codeBlock = nullptr;
<span class="line-modified">!         m_frame.m_bytecodeOffset = 0;</span>
  #if ENABLE(WEBASSEMBLY)
          CalleeBits bits = callFrame-&gt;callee();
          if (bits.isWasm())
              m_frame.m_wasmFunctionIndexOrName = bits.asWasmCallee()-&gt;indexOrName();
  #endif
      } else {
          m_frame.m_codeBlock = callFrame-&gt;codeBlock();
<span class="line-modified">!         m_frame.m_bytecodeOffset = !m_frame.codeBlock() ? 0</span>
              : codeOrigin ? codeOrigin-&gt;bytecodeIndex()
<span class="line-modified">!             : callFrame-&gt;bytecodeOffset();</span>
  
      }
  
  #if ENABLE(DFG_JIT)
      m_frame.m_inlineCallFrame = 0;
<span class="line-new-header">--- 167,21 ---</span>
      m_frame.m_callee = callee;
  
      if (callFrame-&gt;isAnyWasmCallee()) {
          m_frame.m_isWasmFrame = true;
          m_frame.m_codeBlock = nullptr;
<span class="line-modified">!         m_frame.m_bytecodeIndex = BytecodeIndex();</span>
  #if ENABLE(WEBASSEMBLY)
          CalleeBits bits = callFrame-&gt;callee();
          if (bits.isWasm())
              m_frame.m_wasmFunctionIndexOrName = bits.asWasmCallee()-&gt;indexOrName();
  #endif
      } else {
          m_frame.m_codeBlock = callFrame-&gt;codeBlock();
<span class="line-modified">!         m_frame.m_bytecodeIndex = !m_frame.codeBlock() ? BytecodeIndex(0)</span>
              : codeOrigin ? codeOrigin-&gt;bytecodeIndex()
<span class="line-modified">!             : callFrame-&gt;bytecodeIndex();</span>
  
      }
  
  #if ENABLE(DFG_JIT)
      m_frame.m_inlineCallFrame = 0;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 208,15 ***</span>
          InlineCallFrame* inlineCallFrame = codeOrigin-&gt;inlineCallFrame();
  
          m_frame.m_callFrame = callFrame;
          m_frame.m_inlineCallFrame = inlineCallFrame;
          if (inlineCallFrame-&gt;argumentCountRegister.isValid())
<span class="line-modified">!             m_frame.m_argumentCountIncludingThis = callFrame-&gt;r(inlineCallFrame-&gt;argumentCountRegister.offset()).unboxedInt32();</span>
          else
              m_frame.m_argumentCountIncludingThis = inlineCallFrame-&gt;argumentCountIncludingThis;
          m_frame.m_codeBlock = inlineCallFrame-&gt;baselineCodeBlock.get();
<span class="line-modified">!         m_frame.m_bytecodeOffset = codeOrigin-&gt;bytecodeIndex();</span>
  
          JSFunction* callee = inlineCallFrame-&gt;calleeForCallFrame(callFrame);
          m_frame.m_callee = callee;
          ASSERT(!!m_frame.callee().rawPtr());
  
<span class="line-new-header">--- 207,15 ---</span>
          InlineCallFrame* inlineCallFrame = codeOrigin-&gt;inlineCallFrame();
  
          m_frame.m_callFrame = callFrame;
          m_frame.m_inlineCallFrame = inlineCallFrame;
          if (inlineCallFrame-&gt;argumentCountRegister.isValid())
<span class="line-modified">!             m_frame.m_argumentCountIncludingThis = callFrame-&gt;r(inlineCallFrame-&gt;argumentCountRegister).unboxedInt32();</span>
          else
              m_frame.m_argumentCountIncludingThis = inlineCallFrame-&gt;argumentCountIncludingThis;
          m_frame.m_codeBlock = inlineCallFrame-&gt;baselineCodeBlock.get();
<span class="line-modified">!         m_frame.m_bytecodeIndex = codeOrigin-&gt;bytecodeIndex();</span>
  
          JSFunction* callee = inlineCallFrame-&gt;calleeForCallFrame(callFrame);
          m_frame.m_callee = callee;
          ASSERT(!!m_frame.callee().rawPtr());
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 264,11 ***</span>
          return WTF::nullopt;
  
  #if ENABLE(WEBASSEMBLY)
      if (isWasmFrame()) {
          if (callee().isCell()) {
<span class="line-modified">!             RELEASE_ASSERT(isWebAssemblyToJSCallee(callee().asCell()));</span>
              return WTF::nullopt;
          }
          Wasm::Callee* wasmCallee = callee().asWasmCallee();
          return *wasmCallee-&gt;calleeSaveRegisters();
      }
<span class="line-new-header">--- 263,11 ---</span>
          return WTF::nullopt;
  
  #if ENABLE(WEBASSEMBLY)
      if (isWasmFrame()) {
          if (callee().isCell()) {
<span class="line-modified">!             RELEASE_ASSERT(isWebAssemblyModule(callee().asCell()));</span>
              return WTF::nullopt;
          }
          Wasm::Callee* wasmCallee = callee().asWasmCallee();
          return *wasmCallee-&gt;calleeSaveRegisters();
      }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 301,15 ***</span>
          traceLine = &quot;module code&quot;_s;
          break;
      case CodeType::Native: {
          JSCell* callee = this-&gt;callee().asCell();
          if (callee)
<span class="line-modified">!             traceLine = getCalculatedDisplayName(callFrame()-&gt;vm(), jsCast&lt;JSObject*&gt;(callee)).impl();</span>
          break;
      }
      case CodeType::Function:
<span class="line-modified">!         traceLine = getCalculatedDisplayName(callFrame()-&gt;vm(), jsCast&lt;JSObject*&gt;(this-&gt;callee().asCell())).impl();</span>
          break;
      case CodeType::Global:
          traceLine = &quot;global code&quot;_s;
          break;
      }
<span class="line-new-header">--- 300,15 ---</span>
          traceLine = &quot;module code&quot;_s;
          break;
      case CodeType::Native: {
          JSCell* callee = this-&gt;callee().asCell();
          if (callee)
<span class="line-modified">!             traceLine = getCalculatedDisplayName(callFrame()-&gt;deprecatedVM(), jsCast&lt;JSObject*&gt;(callee)).impl();</span>
          break;
      }
      case CodeType::Function:
<span class="line-modified">!         traceLine = getCalculatedDisplayName(callFrame()-&gt;deprecatedVM(), jsCast&lt;JSObject*&gt;(this-&gt;callee().asCell())).impl();</span>
          break;
      case CodeType::Global:
          traceLine = &quot;global code&quot;_s;
          break;
      }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 368,27 ***</span>
      if (CodeBlock* codeBlock = this-&gt;codeBlock())
          return codeBlock-&gt;ownerExecutable()-&gt;sourceID();
      return noSourceID;
  }
  
<span class="line-modified">! ClonedArguments* StackVisitor::Frame::createArguments()</span>
  {
      ASSERT(m_callFrame);
      CallFrame* physicalFrame = m_callFrame;
      ClonedArguments* arguments;
      ArgumentsMode mode;
      if (Options::useFunctionDotArguments())
          mode = ArgumentsMode::Cloned;
      else
          mode = ArgumentsMode::FakeValues;
  #if ENABLE(DFG_JIT)
      if (isInlinedFrame()) {
          ASSERT(m_inlineCallFrame);
<span class="line-modified">!         arguments = ClonedArguments::createWithInlineFrame(physicalFrame, physicalFrame, m_inlineCallFrame, mode);</span>
      } else
  #endif
<span class="line-modified">!         arguments = ClonedArguments::createWithMachineFrame(physicalFrame, physicalFrame, mode);</span>
      return arguments;
  }
  
  bool StackVisitor::Frame::hasLineAndColumnInfo() const
  {
<span class="line-new-header">--- 367,30 ---</span>
      if (CodeBlock* codeBlock = this-&gt;codeBlock())
          return codeBlock-&gt;ownerExecutable()-&gt;sourceID();
      return noSourceID;
  }
  
<span class="line-modified">! ClonedArguments* StackVisitor::Frame::createArguments(VM&amp; vm)</span>
  {
      ASSERT(m_callFrame);
      CallFrame* physicalFrame = m_callFrame;
<span class="line-added">+     // FIXME: Revisit JSGlobalObject.</span>
<span class="line-added">+     // https://bugs.webkit.org/show_bug.cgi?id=203204</span>
<span class="line-added">+     JSGlobalObject* globalObject = physicalFrame-&gt;lexicalGlobalObject(vm);</span>
      ClonedArguments* arguments;
      ArgumentsMode mode;
      if (Options::useFunctionDotArguments())
          mode = ArgumentsMode::Cloned;
      else
          mode = ArgumentsMode::FakeValues;
  #if ENABLE(DFG_JIT)
      if (isInlinedFrame()) {
          ASSERT(m_inlineCallFrame);
<span class="line-modified">!         arguments = ClonedArguments::createWithInlineFrame(globalObject, physicalFrame, m_inlineCallFrame, mode);</span>
      } else
  #endif
<span class="line-modified">!         arguments = ClonedArguments::createWithMachineFrame(globalObject, physicalFrame, mode);</span>
      return arguments;
  }
  
  bool StackVisitor::Frame::hasLineAndColumnInfo() const
  {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 419,11 ***</span>
  }
  
  void StackVisitor::Frame::retrieveExpressionInfo(int&amp; divot, int&amp; startOffset, int&amp; endOffset, unsigned&amp; line, unsigned&amp; column) const
  {
      CodeBlock* codeBlock = this-&gt;codeBlock();
<span class="line-modified">!     codeBlock-&gt;unlinkedCodeBlock()-&gt;expressionRangeForBytecodeOffset(bytecodeOffset(), divot, startOffset, endOffset, line, column);</span>
      divot += codeBlock-&gt;sourceOffset();
  }
  
  void StackVisitor::Frame::setToEnd()
  {
<span class="line-new-header">--- 421,11 ---</span>
  }
  
  void StackVisitor::Frame::retrieveExpressionInfo(int&amp; divot, int&amp; startOffset, int&amp; endOffset, unsigned&amp; line, unsigned&amp; column) const
  {
      CodeBlock* codeBlock = this-&gt;codeBlock();
<span class="line-modified">!     codeBlock-&gt;unlinkedCodeBlock()-&gt;expressionRangeForBytecodeIndex(bytecodeIndex(), divot, startOffset, endOffset, line, column);</span>
      divot += codeBlock-&gt;sourceOffset();
  }
  
  void StackVisitor::Frame::setToEnd()
  {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 481,12 ***</span>
          out.print(&quot;\n&quot;);
          if (codeBlock &amp;&amp; !isInlined) {
              indent++;
  
              if (callFrame-&gt;callSiteBitsAreBytecodeOffset()) {
<span class="line-modified">!                 unsigned bytecodeOffset = callFrame-&gt;bytecodeOffset();</span>
<span class="line-modified">!                 out.print(indent, &quot;bytecodeOffset: &quot;, bytecodeOffset, &quot; of &quot;, codeBlock-&gt;instructions().size(), &quot;\n&quot;);</span>
  #if ENABLE(DFG_JIT)
              } else {
                  out.print(indent, &quot;hasCodeOrigins: &quot;, codeBlock-&gt;hasCodeOrigins(), &quot;\n&quot;);
                  if (codeBlock-&gt;hasCodeOrigins()) {
                      CallSiteIndex callSiteIndex = callFrame-&gt;callSiteIndex();
<span class="line-new-header">--- 483,12 ---</span>
          out.print(&quot;\n&quot;);
          if (codeBlock &amp;&amp; !isInlined) {
              indent++;
  
              if (callFrame-&gt;callSiteBitsAreBytecodeOffset()) {
<span class="line-modified">!                 BytecodeIndex bytecodeIndex = callFrame-&gt;bytecodeIndex();</span>
<span class="line-modified">!                 out.print(indent, bytecodeIndex, &quot; of &quot;, codeBlock-&gt;instructions().size(), &quot;\n&quot;);</span>
  #if ENABLE(DFG_JIT)
              } else {
                  out.print(indent, &quot;hasCodeOrigins: &quot;, codeBlock-&gt;hasCodeOrigins(), &quot;\n&quot;);
                  if (codeBlock-&gt;hasCodeOrigins()) {
                      CallSiteIndex callSiteIndex = callFrame-&gt;callSiteIndex();
</pre>
<center><a href="ShadowChickenInlines.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="StackVisitor.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>