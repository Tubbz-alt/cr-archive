<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/JavaScriptCore/jit/JITMathIC.h</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="JITLeftShiftGenerator.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="JITMulGenerator.cpp.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/JavaScriptCore/jit/JITMathIC.h</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -50,15 +50,15 @@</span>
      bool shouldSlowPathRepatch;
  };
  
  #define ENABLE_MATH_IC_STATS 0
  
<span class="udiff-line-modified-removed">- template &lt;typename GeneratorType, bool(*isProfileEmpty)(ArithProfile&amp;)&gt;</span>
<span class="udiff-line-modified-added">+ template &lt;typename GeneratorType, typename ArithProfileType&gt;</span>
  class JITMathIC {
      WTF_MAKE_FAST_ALLOCATED;
  public:
<span class="udiff-line-modified-removed">-     JITMathIC(ArithProfile* arithProfile)</span>
<span class="udiff-line-modified-added">+     JITMathIC(ArithProfileType* arithProfile)</span>
          : m_arithProfile(arithProfile)
      {
      }
  
      CodeLocationLabel&lt;JSInternalPtrTag&gt; doneLocation() { return m_inlineEnd; }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -68,25 +68,23 @@</span>
      bool generateInline(CCallHelpers&amp; jit, MathICGenerationState&amp; state, bool shouldEmitProfiling = true)
      {
          state.fastPathStart = jit.label();
          size_t startSize = jit.m_assembler.buffer().codeSize();
  
<span class="udiff-line-modified-removed">-         if (m_arithProfile) {</span>
<span class="udiff-line-modified-removed">-             if (isProfileEmpty(*m_arithProfile)) {</span>
<span class="udiff-line-modified-removed">-                 // It looks like the MathIC has yet to execute. We don&#39;t want to emit code in this</span>
<span class="udiff-line-modified-removed">-                 // case for a couple reasons. First, the operation may never execute, so if we don&#39;t emit</span>
<span class="udiff-line-modified-removed">-                 // code, it&#39;s a win. Second, if the operation does execute, we can emit better code</span>
<span class="udiff-line-modified-removed">-                 // once we have an idea about the types.</span>
<span class="udiff-line-modified-removed">-                 state.slowPathJumps.append(jit.patchableJump());</span>
<span class="udiff-line-modified-removed">-                 size_t inlineSize = jit.m_assembler.buffer().codeSize() - startSize;</span>
<span class="udiff-line-modified-removed">-                 ASSERT_UNUSED(inlineSize, static_cast&lt;ptrdiff_t&gt;(inlineSize) &lt;= MacroAssembler::patchableJumpSize());</span>
<span class="udiff-line-modified-removed">-                 state.shouldSlowPathRepatch = true;</span>
<span class="udiff-line-modified-removed">-                 state.fastPathEnd = jit.label();</span>
<span class="udiff-line-modified-removed">-                 ASSERT(!m_generateFastPathOnRepatch); // We should have gathered some observed type info about the types before trying to regenerate again.</span>
<span class="udiff-line-modified-removed">-                 m_generateFastPathOnRepatch = true;</span>
<span class="udiff-line-removed">-                 return true;</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-modified-added">+         if (m_arithProfile &amp;&amp; m_arithProfile-&gt;isObservedTypeEmpty()) {</span>
<span class="udiff-line-modified-added">+             // It looks like the MathIC has yet to execute. We don&#39;t want to emit code in this</span>
<span class="udiff-line-modified-added">+             // case for a couple reasons. First, the operation may never execute, so if we don&#39;t emit</span>
<span class="udiff-line-modified-added">+             // code, it&#39;s a win. Second, if the operation does execute, we can emit better code</span>
<span class="udiff-line-modified-added">+             // once we have an idea about the types.</span>
<span class="udiff-line-modified-added">+             state.slowPathJumps.append(jit.patchableJump());</span>
<span class="udiff-line-modified-added">+             size_t inlineSize = jit.m_assembler.buffer().codeSize() - startSize;</span>
<span class="udiff-line-modified-added">+             ASSERT_UNUSED(inlineSize, static_cast&lt;ptrdiff_t&gt;(inlineSize) &lt;= MacroAssembler::patchableJumpSize());</span>
<span class="udiff-line-modified-added">+             state.shouldSlowPathRepatch = true;</span>
<span class="udiff-line-modified-added">+             state.fastPathEnd = jit.label();</span>
<span class="udiff-line-modified-added">+             ASSERT(!m_generateFastPathOnRepatch); // We should have gathered some observed type info about the types before trying to regenerate again.</span>
<span class="udiff-line-modified-added">+             m_generateFastPathOnRepatch = true;</span>
<span class="udiff-line-modified-added">+             return true;</span>
          }
  
          JITMathICInlineResult result = m_generator.generateInline(jit, state, m_arithProfile);
  
          switch (result) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -221,11 +219,11 @@</span>
  
          m_slowPathCallLocation = linkBuffer.locationOf&lt;JSInternalPtrTag&gt;(state.slowPathCall);
          m_slowPathStartLocation = linkBuffer.locationOf&lt;JSInternalPtrTag&gt;(state.slowPathStart);
      }
  
<span class="udiff-line-modified-removed">-     ArithProfile* arithProfile() const { return m_arithProfile; }</span>
<span class="udiff-line-modified-added">+     ArithProfileType* arithProfile() const { return m_arithProfile; }</span>
  
  #if ENABLE(MATH_IC_STATS)
      size_t m_generatedCodeSize { 0 };
      size_t codeSize() const
      {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -234,47 +232,38 @@</span>
              result += m_code.size();
          return result;
      }
  #endif
  
<span class="udiff-line-modified-removed">-     ArithProfile* m_arithProfile;</span>
<span class="udiff-line-modified-added">+     ArithProfileType* m_arithProfile;</span>
      MacroAssemblerCodeRef&lt;JITStubRoutinePtrTag&gt; m_code;
      CodeLocationLabel&lt;JSInternalPtrTag&gt; m_inlineStart;
      CodeLocationLabel&lt;JSInternalPtrTag&gt; m_inlineEnd;
      CodeLocationLabel&lt;JSInternalPtrTag&gt; m_slowPathCallLocation;
      CodeLocationLabel&lt;JSInternalPtrTag&gt; m_slowPathStartLocation;
      bool m_generateFastPathOnRepatch { false };
      GeneratorType m_generator;
  };
  
<span class="udiff-line-removed">- inline bool isBinaryProfileEmpty(ArithProfile&amp; arithProfile)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-     return arithProfile.lhsObservedType().isEmpty() || arithProfile.rhsObservedType().isEmpty();</span>
<span class="udiff-line-removed">- }</span>
  template &lt;typename GeneratorType&gt;
<span class="udiff-line-modified-removed">- class JITBinaryMathIC : public JITMathIC&lt;GeneratorType, isBinaryProfileEmpty&gt; {</span>
<span class="udiff-line-modified-added">+ class JITBinaryMathIC : public JITMathIC&lt;GeneratorType, BinaryArithProfile&gt; {</span>
  public:
<span class="udiff-line-modified-removed">-     JITBinaryMathIC(ArithProfile* arithProfile)</span>
<span class="udiff-line-modified-removed">-         : JITMathIC&lt;GeneratorType, isBinaryProfileEmpty&gt;(arithProfile)</span>
<span class="udiff-line-modified-added">+     JITBinaryMathIC(BinaryArithProfile* arithProfile)</span>
<span class="udiff-line-modified-added">+         : JITMathIC&lt;GeneratorType, BinaryArithProfile&gt;(arithProfile)</span>
      {
      }
  };
  
  typedef JITBinaryMathIC&lt;JITAddGenerator&gt; JITAddIC;
  typedef JITBinaryMathIC&lt;JITMulGenerator&gt; JITMulIC;
  typedef JITBinaryMathIC&lt;JITSubGenerator&gt; JITSubIC;
  
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- inline bool isUnaryProfileEmpty(ArithProfile&amp; arithProfile)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-     return arithProfile.lhsObservedType().isEmpty();</span>
<span class="udiff-line-removed">- }</span>
  template &lt;typename GeneratorType&gt;
<span class="udiff-line-modified-removed">- class JITUnaryMathIC : public JITMathIC&lt;GeneratorType, isUnaryProfileEmpty&gt; {</span>
<span class="udiff-line-modified-added">+ class JITUnaryMathIC : public JITMathIC&lt;GeneratorType, UnaryArithProfile&gt; {</span>
  public:
<span class="udiff-line-modified-removed">-     JITUnaryMathIC(ArithProfile* arithProfile)</span>
<span class="udiff-line-modified-removed">-         : JITMathIC&lt;GeneratorType, isUnaryProfileEmpty&gt;(arithProfile)</span>
<span class="udiff-line-modified-added">+     JITUnaryMathIC(UnaryArithProfile* arithProfile)</span>
<span class="udiff-line-modified-added">+         : JITMathIC&lt;GeneratorType, UnaryArithProfile&gt;(arithProfile)</span>
      {
      }
  };
  
  typedef JITUnaryMathIC&lt;JITNegGenerator&gt; JITNegIC;
</pre>
<center><a href="JITLeftShiftGenerator.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="JITMulGenerator.cpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>