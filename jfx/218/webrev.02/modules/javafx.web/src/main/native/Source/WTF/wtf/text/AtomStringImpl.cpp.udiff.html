<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WTF/wtf/text/AtomStringImpl.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="AtomStringHash.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="AtomStringImpl.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WTF/wtf/text/AtomStringImpl.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -65,11 +65,11 @@</span>
      AtomStringTableLocker() { }
  };
  
  #endif // USE(WEB_THREAD)
  
<span class="udiff-line-modified-removed">- using StringTableImpl = HashSet&lt;StringImpl*&gt;;</span>
<span class="udiff-line-modified-added">+ using StringTableImpl = HashSet&lt;PackedPtr&lt;StringImpl&gt;&gt;;</span>
  
  static ALWAYS_INLINE StringTableImpl&amp; stringTable()
  {
      return Thread::current().atomStringTable()-&gt;table();
  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -80,12 +80,12 @@</span>
      auto addResult = atomStringTable.add&lt;HashTranslator&gt;(value);
  
      // If the string is newly-translated, then we need to adopt it.
      // The boolean in the pair tells us if that is so.
      if (addResult.isNewEntry)
<span class="udiff-line-modified-removed">-         return adoptRef(static_cast&lt;AtomStringImpl&amp;&gt;(**addResult.iterator));</span>
<span class="udiff-line-modified-removed">-     return *static_cast&lt;AtomStringImpl*&gt;(*addResult.iterator);</span>
<span class="udiff-line-modified-added">+         return adoptRef(static_cast&lt;AtomStringImpl&amp;&gt;(*addResult.iterator-&gt;get()));</span>
<span class="udiff-line-modified-added">+     return *static_cast&lt;AtomStringImpl*&gt;(addResult.iterator-&gt;get());</span>
  }
  
  template&lt;typename T, typename HashTranslator&gt;
  static inline Ref&lt;AtomStringImpl&gt; addToStringTable(const T&amp; value)
  {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -97,20 +97,21 @@</span>
      static unsigned hash(const LChar* characters)
      {
          return StringHasher::computeHashAndMaskTop8Bits(characters);
      }
  
<span class="udiff-line-modified-removed">-     static inline bool equal(StringImpl* str, const LChar* characters)</span>
<span class="udiff-line-modified-added">+     static inline bool equal(PackedPtr&lt;StringImpl&gt; str, const LChar* characters)</span>
      {
<span class="udiff-line-modified-removed">-         return WTF::equal(str, characters);</span>
<span class="udiff-line-modified-added">+         return WTF::equal(str.get(), characters);</span>
      }
  
<span class="udiff-line-modified-removed">-     static void translate(StringImpl*&amp; location, const LChar* const&amp; characters, unsigned hash)</span>
<span class="udiff-line-modified-added">+     static void translate(PackedPtr&lt;StringImpl&gt;&amp; location, const LChar* const&amp; characters, unsigned hash)</span>
      {
<span class="udiff-line-modified-removed">-         location = &amp;StringImpl::create(characters).leakRef();</span>
<span class="udiff-line-modified-removed">-         location-&gt;setHash(hash);</span>
<span class="udiff-line-modified-removed">-         location-&gt;setIsAtom(true);</span>
<span class="udiff-line-modified-added">+         auto* pointer = &amp;StringImpl::create(characters).leakRef();</span>
<span class="udiff-line-modified-added">+         pointer-&gt;setHash(hash);</span>
<span class="udiff-line-modified-added">+         pointer-&gt;setIsAtom(true);</span>
<span class="udiff-line-added">+         location = pointer;</span>
      }
  };
  
  RefPtr&lt;AtomStringImpl&gt; AtomStringImpl::add(const LChar* characters)
  {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -148,20 +149,21 @@</span>
      static unsigned hash(const UCharBuffer&amp; buf)
      {
          return buf.hash;
      }
  
<span class="udiff-line-modified-removed">-     static bool equal(StringImpl* const&amp; str, const UCharBuffer&amp; buf)</span>
<span class="udiff-line-modified-added">+     static bool equal(PackedPtr&lt;StringImpl&gt; const&amp; str, const UCharBuffer&amp; buf)</span>
      {
<span class="udiff-line-modified-removed">-         return WTF::equal(str, buf.characters, buf.length);</span>
<span class="udiff-line-modified-added">+         return WTF::equal(str.get(), buf.characters, buf.length);</span>
      }
  
<span class="udiff-line-modified-removed">-     static void translate(StringImpl*&amp; location, const UCharBuffer&amp; buf, unsigned hash)</span>
<span class="udiff-line-modified-added">+     static void translate(PackedPtr&lt;StringImpl&gt;&amp; location, const UCharBuffer&amp; buf, unsigned hash)</span>
      {
<span class="udiff-line-modified-removed">-         location = &amp;StringImpl::create8BitIfPossible(buf.characters, buf.length).leakRef();</span>
<span class="udiff-line-modified-removed">-         location-&gt;setHash(hash);</span>
<span class="udiff-line-modified-removed">-         location-&gt;setIsAtom(true);</span>
<span class="udiff-line-modified-added">+         auto* pointer = &amp;StringImpl::create8BitIfPossible(buf.characters, buf.length).leakRef();</span>
<span class="udiff-line-modified-added">+         pointer-&gt;setHash(hash);</span>
<span class="udiff-line-modified-added">+         pointer-&gt;setIsAtom(true);</span>
<span class="udiff-line-added">+         location = pointer;</span>
      }
  };
  
  struct HashAndUTF8Characters {
      unsigned hash;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -174,12 +176,13 @@</span>
      static unsigned hash(const HashAndUTF8Characters&amp; buffer)
      {
          return buffer.hash;
      }
  
<span class="udiff-line-modified-removed">-     static bool equal(StringImpl* const&amp; string, const HashAndUTF8Characters&amp; buffer)</span>
<span class="udiff-line-modified-added">+     static bool equal(PackedPtr&lt;StringImpl&gt; const&amp; passedString, const HashAndUTF8Characters&amp; buffer)</span>
      {
<span class="udiff-line-added">+         auto* string = passedString.get();</span>
          if (buffer.utf16Length != string-&gt;length())
              return false;
  
          // If buffer contains only ASCII characters UTF-8 and UTF16 length are the same.
          if (buffer.utf16Length != buffer.length) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -210,11 +213,11 @@</span>
          }
  
          return true;
      }
  
<span class="udiff-line-modified-removed">-     static void translate(StringImpl*&amp; location, const HashAndUTF8Characters&amp; buffer, unsigned hash)</span>
<span class="udiff-line-modified-added">+     static void translate(PackedPtr&lt;StringImpl&gt;&amp; location, const HashAndUTF8Characters&amp; buffer, unsigned hash)</span>
      {
          UChar* target;
          auto newString = StringImpl::createUninitialized(buffer.utf16Length, target);
  
          bool isAllASCII;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -223,13 +226,14 @@</span>
              ASSERT_NOT_REACHED();
  
          if (isAllASCII)
              newString = StringImpl::create(buffer.characters, buffer.length);
  
<span class="udiff-line-modified-removed">-         location = &amp;newString.leakRef();</span>
<span class="udiff-line-modified-removed">-         location-&gt;setHash(hash);</span>
<span class="udiff-line-modified-removed">-         location-&gt;setIsAtom(true);</span>
<span class="udiff-line-modified-added">+         auto* pointer = &amp;newString.leakRef();</span>
<span class="udiff-line-modified-added">+         pointer-&gt;setHash(hash);</span>
<span class="udiff-line-modified-added">+         pointer-&gt;setIsAtom(true);</span>
<span class="udiff-line-added">+         location = pointer;</span>
      }
  };
  
  RefPtr&lt;AtomStringImpl&gt; AtomStringImpl::add(const UChar* characters, unsigned length)
  {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -264,39 +268,40 @@</span>
      unsigned start;
      unsigned length;
  };
  
  struct SubstringTranslator {
<span class="udiff-line-modified-removed">-     static void translate(StringImpl*&amp; location, const SubstringLocation&amp; buffer, unsigned hash)</span>
<span class="udiff-line-modified-added">+     static void translate(PackedPtr&lt;StringImpl&gt;&amp; location, const SubstringLocation&amp; buffer, unsigned hash)</span>
      {
<span class="udiff-line-modified-removed">-         location = &amp;StringImpl::createSubstringSharingImpl(*buffer.baseString, buffer.start, buffer.length).leakRef();</span>
<span class="udiff-line-modified-removed">-         location-&gt;setHash(hash);</span>
<span class="udiff-line-modified-removed">-         location-&gt;setIsAtom(true);</span>
<span class="udiff-line-modified-added">+         auto* pointer = &amp;StringImpl::createSubstringSharingImpl(*buffer.baseString, buffer.start, buffer.length).leakRef();</span>
<span class="udiff-line-modified-added">+         pointer-&gt;setHash(hash);</span>
<span class="udiff-line-modified-added">+         pointer-&gt;setIsAtom(true);</span>
<span class="udiff-line-added">+         location = pointer;</span>
      }
  };
  
  struct SubstringTranslator8 : SubstringTranslator {
      static unsigned hash(const SubstringLocation&amp; buffer)
      {
          return StringHasher::computeHashAndMaskTop8Bits(buffer.baseString-&gt;characters8() + buffer.start, buffer.length);
      }
  
<span class="udiff-line-modified-removed">-     static bool equal(StringImpl* const&amp; string, const SubstringLocation&amp; buffer)</span>
<span class="udiff-line-modified-added">+     static bool equal(PackedPtr&lt;StringImpl&gt; const&amp; string, const SubstringLocation&amp; buffer)</span>
      {
<span class="udiff-line-modified-removed">-         return WTF::equal(string, buffer.baseString-&gt;characters8() + buffer.start, buffer.length);</span>
<span class="udiff-line-modified-added">+         return WTF::equal(string.get(), buffer.baseString-&gt;characters8() + buffer.start, buffer.length);</span>
      }
  };
  
  struct SubstringTranslator16 : SubstringTranslator {
      static unsigned hash(const SubstringLocation&amp; buffer)
      {
          return StringHasher::computeHashAndMaskTop8Bits(buffer.baseString-&gt;characters16() + buffer.start, buffer.length);
      }
  
<span class="udiff-line-modified-removed">-     static bool equal(StringImpl* const&amp; string, const SubstringLocation&amp; buffer)</span>
<span class="udiff-line-modified-added">+     static bool equal(PackedPtr&lt;StringImpl&gt; const&amp; string, const SubstringLocation&amp; buffer)</span>
      {
<span class="udiff-line-modified-removed">-         return WTF::equal(string, buffer.baseString-&gt;characters16() + buffer.start, buffer.length);</span>
<span class="udiff-line-modified-added">+         return WTF::equal(string.get(), buffer.baseString-&gt;characters16() + buffer.start, buffer.length);</span>
      }
  };
  
  RefPtr&lt;AtomStringImpl&gt; AtomStringImpl::add(StringImpl* baseString, unsigned start, unsigned length)
  {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -324,20 +329,21 @@</span>
      static unsigned hash(const LCharBuffer&amp; buf)
      {
          return buf.hash;
      }
  
<span class="udiff-line-modified-removed">-     static bool equal(StringImpl* const&amp; str, const LCharBuffer&amp; buf)</span>
<span class="udiff-line-modified-added">+     static bool equal(PackedPtr&lt;StringImpl&gt; const&amp; str, const LCharBuffer&amp; buf)</span>
      {
<span class="udiff-line-modified-removed">-         return WTF::equal(str, buf.characters, buf.length);</span>
<span class="udiff-line-modified-added">+         return WTF::equal(str.get(), buf.characters, buf.length);</span>
      }
  
<span class="udiff-line-modified-removed">-     static void translate(StringImpl*&amp; location, const LCharBuffer&amp; buf, unsigned hash)</span>
<span class="udiff-line-modified-added">+     static void translate(PackedPtr&lt;StringImpl&gt;&amp; location, const LCharBuffer&amp; buf, unsigned hash)</span>
      {
<span class="udiff-line-modified-removed">-         location = &amp;StringImpl::create(buf.characters, buf.length).leakRef();</span>
<span class="udiff-line-modified-removed">-         location-&gt;setHash(hash);</span>
<span class="udiff-line-modified-removed">-         location-&gt;setIsAtom(true);</span>
<span class="udiff-line-modified-added">+         auto* pointer = &amp;StringImpl::create(buf.characters, buf.length).leakRef();</span>
<span class="udiff-line-modified-added">+         pointer-&gt;setHash(hash);</span>
<span class="udiff-line-modified-added">+         pointer-&gt;setIsAtom(true);</span>
<span class="udiff-line-added">+         location = pointer;</span>
      }
  };
  
  template&lt;typename CharType&gt;
  struct BufferFromStaticDataTranslator {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -345,20 +351,21 @@</span>
      static unsigned hash(const Buffer&amp; buf)
      {
          return buf.hash;
      }
  
<span class="udiff-line-modified-removed">-     static bool equal(StringImpl* const&amp; str, const Buffer&amp; buf)</span>
<span class="udiff-line-modified-added">+     static bool equal(PackedPtr&lt;StringImpl&gt; const&amp; str, const Buffer&amp; buf)</span>
      {
<span class="udiff-line-modified-removed">-         return WTF::equal(str, buf.characters, buf.length);</span>
<span class="udiff-line-modified-added">+         return WTF::equal(str.get(), buf.characters, buf.length);</span>
      }
  
<span class="udiff-line-modified-removed">-     static void translate(StringImpl*&amp; location, const Buffer&amp; buf, unsigned hash)</span>
<span class="udiff-line-modified-added">+     static void translate(PackedPtr&lt;StringImpl&gt;&amp; location, const Buffer&amp; buf, unsigned hash)</span>
      {
<span class="udiff-line-modified-removed">-         location = &amp;StringImpl::createWithoutCopying(buf.characters, buf.length).leakRef();</span>
<span class="udiff-line-modified-removed">-         location-&gt;setHash(hash);</span>
<span class="udiff-line-modified-removed">-         location-&gt;setIsAtom(true);</span>
<span class="udiff-line-modified-added">+         auto* pointer = &amp;StringImpl::createWithoutCopying(buf.characters, buf.length).leakRef();</span>
<span class="udiff-line-modified-added">+         pointer-&gt;setHash(hash);</span>
<span class="udiff-line-modified-added">+         pointer-&gt;setIsAtom(true);</span>
<span class="udiff-line-added">+         location = pointer;</span>
      }
  };
  
  RefPtr&lt;AtomStringImpl&gt; AtomStringImpl::add(const LChar* characters, unsigned length)
  {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -441,15 +448,15 @@</span>
  
      AtomStringTableLocker locker;
      auto addResult = stringTable().add(&amp;string);
  
      if (addResult.isNewEntry) {
<span class="udiff-line-modified-removed">-         ASSERT(*addResult.iterator == &amp;string);</span>
<span class="udiff-line-modified-added">+         ASSERT(addResult.iterator-&gt;get() == &amp;string);</span>
          string.setIsAtom(true);
      }
  
<span class="udiff-line-modified-removed">-     return *static_cast&lt;AtomStringImpl*&gt;(*addResult.iterator);</span>
<span class="udiff-line-modified-added">+     return *static_cast&lt;AtomStringImpl*&gt;(addResult.iterator-&gt;get());</span>
  }
  
  Ref&lt;AtomStringImpl&gt; AtomStringImpl::addSlowCase(AtomStringTable&amp; stringTable, StringImpl&amp; string)
  {
      // This check is necessary for null symbols.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -471,25 +478,25 @@</span>
  
      AtomStringTableLocker locker;
      auto addResult = stringTable.table().add(&amp;string);
  
      if (addResult.isNewEntry) {
<span class="udiff-line-modified-removed">-         ASSERT(*addResult.iterator == &amp;string);</span>
<span class="udiff-line-modified-added">+         ASSERT(addResult.iterator-&gt;get() == &amp;string);</span>
          string.setIsAtom(true);
      }
  
<span class="udiff-line-modified-removed">-     return *static_cast&lt;AtomStringImpl*&gt;(*addResult.iterator);</span>
<span class="udiff-line-modified-added">+     return *static_cast&lt;AtomStringImpl*&gt;(addResult.iterator-&gt;get());</span>
  }
  
  void AtomStringImpl::remove(AtomStringImpl* string)
  {
      ASSERT(string-&gt;isAtom());
      AtomStringTableLocker locker;
      auto&amp; atomStringTable = stringTable();
      auto iterator = atomStringTable.find(string);
      ASSERT_WITH_MESSAGE(iterator != atomStringTable.end(), &quot;The string being removed is an atom in the string table of an other thread!&quot;);
<span class="udiff-line-modified-removed">-     ASSERT(string == *iterator);</span>
<span class="udiff-line-modified-added">+     ASSERT(string == iterator-&gt;get());</span>
      atomStringTable.remove(iterator);
  }
  
  RefPtr&lt;AtomStringImpl&gt; AtomStringImpl::lookUpSlowCase(StringImpl&amp; string)
  {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -500,11 +507,11 @@</span>
  
      AtomStringTableLocker locker;
      auto&amp; atomStringTable = stringTable();
      auto iterator = atomStringTable.find(&amp;string);
      if (iterator != atomStringTable.end())
<span class="udiff-line-modified-removed">-         return static_cast&lt;AtomStringImpl*&gt;(*iterator);</span>
<span class="udiff-line-modified-added">+         return static_cast&lt;AtomStringImpl*&gt;(iterator-&gt;get());</span>
      return nullptr;
  }
  
  RefPtr&lt;AtomStringImpl&gt; AtomStringImpl::addUTF8(const char* charactersStart, const char* charactersEnd)
  {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -524,11 +531,11 @@</span>
      auto&amp; table = stringTable();
  
      LCharBuffer buffer = { characters, length };
      auto iterator = table.find&lt;LCharBufferTranslator&gt;(buffer);
      if (iterator != table.end())
<span class="udiff-line-modified-removed">-         return static_cast&lt;AtomStringImpl*&gt;(*iterator);</span>
<span class="udiff-line-modified-added">+         return static_cast&lt;AtomStringImpl*&gt;(iterator-&gt;get());</span>
      return nullptr;
  }
  
  RefPtr&lt;AtomStringImpl&gt; AtomStringImpl::lookUp(const UChar* characters, unsigned length)
  {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -536,15 +543,15 @@</span>
      auto&amp; table = stringTable();
  
      UCharBuffer buffer { characters, length };
      auto iterator = table.find&lt;UCharBufferTranslator&gt;(buffer);
      if (iterator != table.end())
<span class="udiff-line-modified-removed">-         return static_cast&lt;AtomStringImpl*&gt;(*iterator);</span>
<span class="udiff-line-modified-added">+         return static_cast&lt;AtomStringImpl*&gt;(iterator-&gt;get());</span>
      return nullptr;
  }
  
<span class="udiff-line-modified-removed">- #if !ASSERT_DISABLED</span>
<span class="udiff-line-modified-added">+ #if ASSERT_ENABLED</span>
  bool AtomStringImpl::isInAtomStringTable(StringImpl* string)
  {
      AtomStringTableLocker locker;
      return stringTable().contains(string);
  }
</pre>
<center><a href="AtomStringHash.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="AtomStringImpl.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>