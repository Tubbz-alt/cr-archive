<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WebCore/bindings/js/JSDOMGlobalObject.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="JSDOMExceptionHandling.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="JSDOMGlobalObject.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/bindings/js/JSDOMGlobalObject.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 31 #include &quot;Document.h&quot;
 32 #include &quot;JSDOMPromiseDeferred.h&quot;
 33 #include &quot;JSDOMWindow.h&quot;
 34 #include &quot;JSEventListener.h&quot;
 35 #include &quot;JSMediaStream.h&quot;
 36 #include &quot;JSMediaStreamTrack.h&quot;
 37 #include &quot;JSRTCIceCandidate.h&quot;
 38 #include &quot;JSRTCSessionDescription.h&quot;
 39 #include &quot;JSReadableStream.h&quot;
 40 #include &quot;JSRemoteDOMWindow.h&quot;
 41 #include &quot;JSWorkerGlobalScope.h&quot;
 42 #include &quot;JSWorkletGlobalScope.h&quot;
 43 #include &quot;RejectedPromiseTracker.h&quot;
 44 #include &quot;RuntimeEnabledFeatures.h&quot;
 45 #include &quot;StructuredClone.h&quot;
 46 #include &quot;WebCoreJSClientData.h&quot;
 47 #include &quot;WorkerGlobalScope.h&quot;
 48 #include &lt;JavaScriptCore/BuiltinNames.h&gt;
 49 #include &lt;JavaScriptCore/CodeBlock.h&gt;
 50 #include &lt;JavaScriptCore/JSInternalPromise.h&gt;
<span class="line-removed"> 51 #include &lt;JavaScriptCore/JSInternalPromiseDeferred.h&gt;</span>
 52 #include &lt;JavaScriptCore/StructureInlines.h&gt;
 53 
 54 namespace WebCore {
 55 using namespace JSC;
 56 
<span class="line-modified"> 57 EncodedJSValue JSC_HOST_CALL makeThisTypeErrorForBuiltins(ExecState*);</span>
<span class="line-modified"> 58 EncodedJSValue JSC_HOST_CALL makeGetterTypeErrorForBuiltins(ExecState*);</span>
<span class="line-modified"> 59 EncodedJSValue JSC_HOST_CALL isReadableByteStreamAPIEnabled(ExecState*);</span>
 60 
 61 const ClassInfo JSDOMGlobalObject::s_info = { &quot;DOMGlobalObject&quot;, &amp;JSGlobalObject::s_info, nullptr, nullptr, CREATE_METHOD_TABLE(JSDOMGlobalObject) };
 62 
 63 JSDOMGlobalObject::JSDOMGlobalObject(VM&amp; vm, Structure* structure, Ref&lt;DOMWrapperWorld&gt;&amp;&amp; world, const GlobalObjectMethodTable* globalObjectMethodTable)
 64     : JSGlobalObject(vm, structure, globalObjectMethodTable)
 65     , m_world(WTFMove(world))
 66     , m_worldIsNormal(m_world-&gt;isNormal())
 67     , m_builtinInternalFunctions(vm)
 68 {
 69 }
 70 
 71 JSDOMGlobalObject::~JSDOMGlobalObject() = default;
 72 
 73 void JSDOMGlobalObject::destroy(JSCell* cell)
 74 {
 75     static_cast&lt;JSDOMGlobalObject*&gt;(cell)-&gt;JSDOMGlobalObject::~JSDOMGlobalObject();
 76 }
 77 
<span class="line-modified"> 78 EncodedJSValue JSC_HOST_CALL makeThisTypeErrorForBuiltins(ExecState* execState)</span>
 79 {
<span class="line-modified"> 80     ASSERT(execState);</span>
<span class="line-modified"> 81     ASSERT(execState-&gt;argumentCount() == 2);</span>
<span class="line-modified"> 82     VM&amp; vm = execState-&gt;vm();</span>
 83     auto scope = DECLARE_CATCH_SCOPE(vm);
 84 
<span class="line-modified"> 85     auto interfaceName = execState-&gt;uncheckedArgument(0).getString(execState);</span>
 86     scope.assertNoException();
<span class="line-modified"> 87     auto functionName = execState-&gt;uncheckedArgument(1).getString(execState);</span>
 88     scope.assertNoException();
<span class="line-modified"> 89     return JSValue::encode(createTypeError(execState, makeThisTypeErrorMessage(interfaceName.utf8().data(), functionName.utf8().data())));</span>
 90 }
 91 
<span class="line-modified"> 92 EncodedJSValue JSC_HOST_CALL makeGetterTypeErrorForBuiltins(ExecState* execState)</span>
 93 {
<span class="line-modified"> 94     ASSERT(execState);</span>
<span class="line-modified"> 95     ASSERT(execState-&gt;argumentCount() == 2);</span>
<span class="line-modified"> 96     VM&amp; vm = execState-&gt;vm();</span>
 97     auto scope = DECLARE_CATCH_SCOPE(vm);
 98 
<span class="line-modified"> 99     auto interfaceName = execState-&gt;uncheckedArgument(0).getString(execState);</span>
100     scope.assertNoException();
<span class="line-modified">101     auto attributeName = execState-&gt;uncheckedArgument(1).getString(execState);</span>
102     scope.assertNoException();
103 
<span class="line-modified">104     auto error = static_cast&lt;ErrorInstance*&gt;(createTypeError(execState, makeGetterTypeErrorMessage(interfaceName.utf8().data(), attributeName.utf8().data())));</span>
105     error-&gt;setNativeGetterTypeError();
106     return JSValue::encode(error);
107 }
108 
109 #if ENABLE(STREAMS_API)
<span class="line-modified">110 EncodedJSValue JSC_HOST_CALL isReadableByteStreamAPIEnabled(ExecState*)</span>
111 {
112     return JSValue::encode(jsBoolean(RuntimeEnabledFeatures::sharedFeatures().readableByteStreamAPIEnabled()));
113 }
114 #endif
115 
116 void JSDOMGlobalObject::addBuiltinGlobals(VM&amp; vm)
117 {
118     m_builtinInternalFunctions.initialize(*this);
119 
120     JSVMClientData&amp; clientData = *static_cast&lt;JSVMClientData*&gt;(vm.clientData);
121     JSDOMGlobalObject::GlobalPropertyInfo staticGlobals[] = {
122         JSDOMGlobalObject::GlobalPropertyInfo(clientData.builtinNames().makeThisTypeErrorPrivateName(),
123             JSFunction::create(vm, this, 2, String(), makeThisTypeErrorForBuiltins), PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
124         JSDOMGlobalObject::GlobalPropertyInfo(clientData.builtinNames().makeGetterTypeErrorPrivateName(),
125             JSFunction::create(vm, this, 2, String(), makeGetterTypeErrorForBuiltins), PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
126         JSDOMGlobalObject::GlobalPropertyInfo(clientData.builtinNames().cloneArrayBufferPrivateName(),
127             JSFunction::create(vm, this, 3, String(), cloneArrayBuffer), PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
128         JSDOMGlobalObject::GlobalPropertyInfo(clientData.builtinNames().structuredCloneArrayBufferPrivateName(),
129             JSFunction::create(vm, this, 1, String(), structuredCloneArrayBuffer), PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
130         JSDOMGlobalObject::GlobalPropertyInfo(clientData.builtinNames().structuredCloneArrayBufferViewPrivateName(),
</pre>
<hr />
<pre>
133 #if ENABLE(STREAMS_API)
134         JSDOMGlobalObject::GlobalPropertyInfo(clientData.builtinNames().streamClosedPrivateName(), jsNumber(1), PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
135         JSDOMGlobalObject::GlobalPropertyInfo(clientData.builtinNames().streamClosingPrivateName(), jsNumber(2), PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
136         JSDOMGlobalObject::GlobalPropertyInfo(clientData.builtinNames().streamErroredPrivateName(), jsNumber(3), PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
137         JSDOMGlobalObject::GlobalPropertyInfo(clientData.builtinNames().streamReadablePrivateName(), jsNumber(4), PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
138         JSDOMGlobalObject::GlobalPropertyInfo(clientData.builtinNames().streamWaitingPrivateName(), jsNumber(5), PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
139         JSDOMGlobalObject::GlobalPropertyInfo(clientData.builtinNames().streamWritablePrivateName(), jsNumber(6), PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
140         JSDOMGlobalObject::GlobalPropertyInfo(clientData.builtinNames().readableByteStreamAPIEnabledPrivateName(), JSFunction::create(vm, this, 0, String(), isReadableByteStreamAPIEnabled), PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
141 #endif
142     };
143     addStaticGlobals(staticGlobals, WTF_ARRAY_LENGTH(staticGlobals));
144 }
145 
146 void JSDOMGlobalObject::finishCreation(VM&amp; vm)
147 {
148     Base::finishCreation(vm);
149     ASSERT(inherits(vm, info()));
150 
151     addBuiltinGlobals(vm);
152 
<span class="line-modified">153     RELEASE_ASSERT(classInfo());</span>
154 }
155 
156 void JSDOMGlobalObject::finishCreation(VM&amp; vm, JSObject* thisValue)
157 {
158     Base::finishCreation(vm, thisValue);
159     ASSERT(inherits(vm, info()));
160 
161     addBuiltinGlobals(vm);
162 
<span class="line-modified">163     RELEASE_ASSERT(classInfo());</span>
164 }
165 
166 ScriptExecutionContext* JSDOMGlobalObject::scriptExecutionContext() const
167 {
168     if (inherits&lt;JSDOMWindowBase&gt;(vm()))
169         return jsCast&lt;const JSDOMWindowBase*&gt;(this)-&gt;scriptExecutionContext();
170     if (inherits&lt;JSRemoteDOMWindowBase&gt;(vm()))
171         return nullptr;
172     if (inherits&lt;JSWorkerGlobalScopeBase&gt;(vm()))
173         return jsCast&lt;const JSWorkerGlobalScopeBase*&gt;(this)-&gt;scriptExecutionContext();
174 #if ENABLE(CSS_PAINTING_API)
175     if (inherits&lt;JSWorkletGlobalScopeBase&gt;(vm()))
176         return jsCast&lt;const JSWorkletGlobalScopeBase*&gt;(this)-&gt;scriptExecutionContext();
177 #endif
178     dataLog(&quot;Unexpected global object: &quot;, JSValue(this), &quot;\n&quot;);
179     RELEASE_ASSERT_NOT_REACHED();
180     return nullptr;
181 }
182 
183 void JSDOMGlobalObject::visitChildren(JSCell* cell, SlotVisitor&amp; visitor)
</pre>
<hr />
<pre>
195         for (auto&amp; constructor : thisObject-&gt;constructors(locker).values())
196             visitor.append(constructor);
197 
198         for (auto&amp; guarded : thisObject-&gt;guardedObjects(locker))
199             guarded-&gt;visitAggregate(visitor);
200     }
201 
202     thisObject-&gt;m_builtinInternalFunctions.visit(visitor);
203 }
204 
205 void JSDOMGlobalObject::setCurrentEvent(Event* currentEvent)
206 {
207     m_currentEvent = currentEvent;
208 }
209 
210 Event* JSDOMGlobalObject::currentEvent() const
211 {
212     return m_currentEvent;
213 }
214 
<span class="line-modified">215 void JSDOMGlobalObject::promiseRejectionTracker(JSGlobalObject* jsGlobalObject, ExecState* exec, JSPromise* promise, JSPromiseRejectionOperation operation)</span>
216 {
217     // https://html.spec.whatwg.org/multipage/webappapis.html#the-hostpromiserejectiontracker-implementation
218 
219     auto&amp; globalObject = *JSC::jsCast&lt;JSDOMGlobalObject*&gt;(jsGlobalObject);
220     auto* context = globalObject.scriptExecutionContext();
221     if (!context)
222         return;
223 
224     // FIXME: If script has muted errors (cross origin), terminate these steps.
225     // &lt;https://webkit.org/b/171415&gt; Implement the `muted-errors` property of Scripts to avoid onerror/onunhandledrejection for cross-origin scripts
226 
227     switch (operation) {
228     case JSPromiseRejectionOperation::Reject:
<span class="line-modified">229         context-&gt;ensureRejectedPromiseTracker().promiseRejected(*exec, globalObject, *promise);</span>
230         break;
231     case JSPromiseRejectionOperation::Handle:
<span class="line-modified">232         context-&gt;ensureRejectedPromiseTracker().promiseHandled(*exec, globalObject, *promise);</span>
233         break;
234     }
235 }
236 
<span class="line-modified">237 JSDOMGlobalObject&amp; callerGlobalObject(ExecState&amp; state)</span>
238 {
239     class GetCallerGlobalObjectFunctor {
240     public:
241         GetCallerGlobalObjectFunctor() = default;
242 
243         StackVisitor::Status operator()(StackVisitor&amp; visitor) const
244         {
245             if (!m_hasSkippedFirstFrame) {
246                 m_hasSkippedFirstFrame = true;
247                 return StackVisitor::Continue;
248             }
249 
250             if (auto* codeBlock = visitor-&gt;codeBlock())
251                 m_globalObject = codeBlock-&gt;globalObject();
252             else {
253                 ASSERT(visitor-&gt;callee().rawPtr());
254                 // FIXME: Callee is not an object if the caller is Web Assembly.
255                 // Figure out what to do here. We can probably get the global object
256                 // from the top-most Wasm Instance. https://bugs.webkit.org/show_bug.cgi?id=165721
257                 if (visitor-&gt;callee().isCell() &amp;&amp; visitor-&gt;callee().asCell()-&gt;isObject())
258                     m_globalObject = jsCast&lt;JSObject*&gt;(visitor-&gt;callee().asCell())-&gt;globalObject();
259             }
260             return StackVisitor::Done;
261         }
262 
263         JSGlobalObject* globalObject() const { return m_globalObject; }
264 
265     private:
266         mutable bool m_hasSkippedFirstFrame { false };
267         mutable JSGlobalObject* m_globalObject { nullptr };
268     };
269 
270     GetCallerGlobalObjectFunctor iter;
<span class="line-modified">271     state.iterate(iter);</span>
272     if (iter.globalObject())
273         return *jsCast&lt;JSDOMGlobalObject*&gt;(iter.globalObject());
274 
<span class="line-modified">275     VM&amp; vm = state.vm();</span>
<span class="line-modified">276     return *jsCast&lt;JSDOMGlobalObject*&gt;(vm.vmEntryGlobalObject(&amp;state));</span>
277 }
278 
279 JSDOMGlobalObject* toJSDOMGlobalObject(ScriptExecutionContext&amp; context, DOMWrapperWorld&amp; world)
280 {
281     if (is&lt;Document&gt;(context))
282         return toJSDOMWindow(downcast&lt;Document&gt;(context).frame(), world);
283 
284     if (is&lt;WorkerGlobalScope&gt;(context))
285         return downcast&lt;WorkerGlobalScope&gt;(context).script()-&gt;workerGlobalScopeWrapper();
286 
287     ASSERT_NOT_REACHED();
288     return nullptr;
289 }
290 
291 } // namespace WebCore
</pre>
</td>
<td>
<hr />
<pre>
 31 #include &quot;Document.h&quot;
 32 #include &quot;JSDOMPromiseDeferred.h&quot;
 33 #include &quot;JSDOMWindow.h&quot;
 34 #include &quot;JSEventListener.h&quot;
 35 #include &quot;JSMediaStream.h&quot;
 36 #include &quot;JSMediaStreamTrack.h&quot;
 37 #include &quot;JSRTCIceCandidate.h&quot;
 38 #include &quot;JSRTCSessionDescription.h&quot;
 39 #include &quot;JSReadableStream.h&quot;
 40 #include &quot;JSRemoteDOMWindow.h&quot;
 41 #include &quot;JSWorkerGlobalScope.h&quot;
 42 #include &quot;JSWorkletGlobalScope.h&quot;
 43 #include &quot;RejectedPromiseTracker.h&quot;
 44 #include &quot;RuntimeEnabledFeatures.h&quot;
 45 #include &quot;StructuredClone.h&quot;
 46 #include &quot;WebCoreJSClientData.h&quot;
 47 #include &quot;WorkerGlobalScope.h&quot;
 48 #include &lt;JavaScriptCore/BuiltinNames.h&gt;
 49 #include &lt;JavaScriptCore/CodeBlock.h&gt;
 50 #include &lt;JavaScriptCore/JSInternalPromise.h&gt;

 51 #include &lt;JavaScriptCore/StructureInlines.h&gt;
 52 
 53 namespace WebCore {
 54 using namespace JSC;
 55 
<span class="line-modified"> 56 EncodedJSValue JSC_HOST_CALL makeThisTypeErrorForBuiltins(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified"> 57 EncodedJSValue JSC_HOST_CALL makeGetterTypeErrorForBuiltins(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified"> 58 EncodedJSValue JSC_HOST_CALL isReadableByteStreamAPIEnabled(JSGlobalObject*, CallFrame*);</span>
 59 
 60 const ClassInfo JSDOMGlobalObject::s_info = { &quot;DOMGlobalObject&quot;, &amp;JSGlobalObject::s_info, nullptr, nullptr, CREATE_METHOD_TABLE(JSDOMGlobalObject) };
 61 
 62 JSDOMGlobalObject::JSDOMGlobalObject(VM&amp; vm, Structure* structure, Ref&lt;DOMWrapperWorld&gt;&amp;&amp; world, const GlobalObjectMethodTable* globalObjectMethodTable)
 63     : JSGlobalObject(vm, structure, globalObjectMethodTable)
 64     , m_world(WTFMove(world))
 65     , m_worldIsNormal(m_world-&gt;isNormal())
 66     , m_builtinInternalFunctions(vm)
 67 {
 68 }
 69 
 70 JSDOMGlobalObject::~JSDOMGlobalObject() = default;
 71 
 72 void JSDOMGlobalObject::destroy(JSCell* cell)
 73 {
 74     static_cast&lt;JSDOMGlobalObject*&gt;(cell)-&gt;JSDOMGlobalObject::~JSDOMGlobalObject();
 75 }
 76 
<span class="line-modified"> 77 EncodedJSValue JSC_HOST_CALL makeThisTypeErrorForBuiltins(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 78 {
<span class="line-modified"> 79     ASSERT(callFrame);</span>
<span class="line-modified"> 80     ASSERT(callFrame-&gt;argumentCount() == 2);</span>
<span class="line-modified"> 81     VM&amp; vm = globalObject-&gt;vm();</span>
 82     auto scope = DECLARE_CATCH_SCOPE(vm);
 83 
<span class="line-modified"> 84     auto interfaceName = callFrame-&gt;uncheckedArgument(0).getString(globalObject);</span>
 85     scope.assertNoException();
<span class="line-modified"> 86     auto functionName = callFrame-&gt;uncheckedArgument(1).getString(globalObject);</span>
 87     scope.assertNoException();
<span class="line-modified"> 88     return JSValue::encode(createTypeError(globalObject, makeThisTypeErrorMessage(interfaceName.utf8().data(), functionName.utf8().data())));</span>
 89 }
 90 
<span class="line-modified"> 91 EncodedJSValue JSC_HOST_CALL makeGetterTypeErrorForBuiltins(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 92 {
<span class="line-modified"> 93     ASSERT(callFrame);</span>
<span class="line-modified"> 94     ASSERT(callFrame-&gt;argumentCount() == 2);</span>
<span class="line-modified"> 95     VM&amp; vm = globalObject-&gt;vm();</span>
 96     auto scope = DECLARE_CATCH_SCOPE(vm);
 97 
<span class="line-modified"> 98     auto interfaceName = callFrame-&gt;uncheckedArgument(0).getString(globalObject);</span>
 99     scope.assertNoException();
<span class="line-modified">100     auto attributeName = callFrame-&gt;uncheckedArgument(1).getString(globalObject);</span>
101     scope.assertNoException();
102 
<span class="line-modified">103     auto error = static_cast&lt;ErrorInstance*&gt;(createTypeError(globalObject, makeGetterTypeErrorMessage(interfaceName.utf8().data(), attributeName.utf8().data())));</span>
104     error-&gt;setNativeGetterTypeError();
105     return JSValue::encode(error);
106 }
107 
108 #if ENABLE(STREAMS_API)
<span class="line-modified">109 EncodedJSValue JSC_HOST_CALL isReadableByteStreamAPIEnabled(JSGlobalObject*, CallFrame*)</span>
110 {
111     return JSValue::encode(jsBoolean(RuntimeEnabledFeatures::sharedFeatures().readableByteStreamAPIEnabled()));
112 }
113 #endif
114 
115 void JSDOMGlobalObject::addBuiltinGlobals(VM&amp; vm)
116 {
117     m_builtinInternalFunctions.initialize(*this);
118 
119     JSVMClientData&amp; clientData = *static_cast&lt;JSVMClientData*&gt;(vm.clientData);
120     JSDOMGlobalObject::GlobalPropertyInfo staticGlobals[] = {
121         JSDOMGlobalObject::GlobalPropertyInfo(clientData.builtinNames().makeThisTypeErrorPrivateName(),
122             JSFunction::create(vm, this, 2, String(), makeThisTypeErrorForBuiltins), PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
123         JSDOMGlobalObject::GlobalPropertyInfo(clientData.builtinNames().makeGetterTypeErrorPrivateName(),
124             JSFunction::create(vm, this, 2, String(), makeGetterTypeErrorForBuiltins), PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
125         JSDOMGlobalObject::GlobalPropertyInfo(clientData.builtinNames().cloneArrayBufferPrivateName(),
126             JSFunction::create(vm, this, 3, String(), cloneArrayBuffer), PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
127         JSDOMGlobalObject::GlobalPropertyInfo(clientData.builtinNames().structuredCloneArrayBufferPrivateName(),
128             JSFunction::create(vm, this, 1, String(), structuredCloneArrayBuffer), PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
129         JSDOMGlobalObject::GlobalPropertyInfo(clientData.builtinNames().structuredCloneArrayBufferViewPrivateName(),
</pre>
<hr />
<pre>
132 #if ENABLE(STREAMS_API)
133         JSDOMGlobalObject::GlobalPropertyInfo(clientData.builtinNames().streamClosedPrivateName(), jsNumber(1), PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
134         JSDOMGlobalObject::GlobalPropertyInfo(clientData.builtinNames().streamClosingPrivateName(), jsNumber(2), PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
135         JSDOMGlobalObject::GlobalPropertyInfo(clientData.builtinNames().streamErroredPrivateName(), jsNumber(3), PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
136         JSDOMGlobalObject::GlobalPropertyInfo(clientData.builtinNames().streamReadablePrivateName(), jsNumber(4), PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
137         JSDOMGlobalObject::GlobalPropertyInfo(clientData.builtinNames().streamWaitingPrivateName(), jsNumber(5), PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
138         JSDOMGlobalObject::GlobalPropertyInfo(clientData.builtinNames().streamWritablePrivateName(), jsNumber(6), PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
139         JSDOMGlobalObject::GlobalPropertyInfo(clientData.builtinNames().readableByteStreamAPIEnabledPrivateName(), JSFunction::create(vm, this, 0, String(), isReadableByteStreamAPIEnabled), PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
140 #endif
141     };
142     addStaticGlobals(staticGlobals, WTF_ARRAY_LENGTH(staticGlobals));
143 }
144 
145 void JSDOMGlobalObject::finishCreation(VM&amp; vm)
146 {
147     Base::finishCreation(vm);
148     ASSERT(inherits(vm, info()));
149 
150     addBuiltinGlobals(vm);
151 
<span class="line-modified">152     RELEASE_ASSERT(classInfo(vm));</span>
153 }
154 
155 void JSDOMGlobalObject::finishCreation(VM&amp; vm, JSObject* thisValue)
156 {
157     Base::finishCreation(vm, thisValue);
158     ASSERT(inherits(vm, info()));
159 
160     addBuiltinGlobals(vm);
161 
<span class="line-modified">162     RELEASE_ASSERT(classInfo(vm));</span>
163 }
164 
165 ScriptExecutionContext* JSDOMGlobalObject::scriptExecutionContext() const
166 {
167     if (inherits&lt;JSDOMWindowBase&gt;(vm()))
168         return jsCast&lt;const JSDOMWindowBase*&gt;(this)-&gt;scriptExecutionContext();
169     if (inherits&lt;JSRemoteDOMWindowBase&gt;(vm()))
170         return nullptr;
171     if (inherits&lt;JSWorkerGlobalScopeBase&gt;(vm()))
172         return jsCast&lt;const JSWorkerGlobalScopeBase*&gt;(this)-&gt;scriptExecutionContext();
173 #if ENABLE(CSS_PAINTING_API)
174     if (inherits&lt;JSWorkletGlobalScopeBase&gt;(vm()))
175         return jsCast&lt;const JSWorkletGlobalScopeBase*&gt;(this)-&gt;scriptExecutionContext();
176 #endif
177     dataLog(&quot;Unexpected global object: &quot;, JSValue(this), &quot;\n&quot;);
178     RELEASE_ASSERT_NOT_REACHED();
179     return nullptr;
180 }
181 
182 void JSDOMGlobalObject::visitChildren(JSCell* cell, SlotVisitor&amp; visitor)
</pre>
<hr />
<pre>
194         for (auto&amp; constructor : thisObject-&gt;constructors(locker).values())
195             visitor.append(constructor);
196 
197         for (auto&amp; guarded : thisObject-&gt;guardedObjects(locker))
198             guarded-&gt;visitAggregate(visitor);
199     }
200 
201     thisObject-&gt;m_builtinInternalFunctions.visit(visitor);
202 }
203 
204 void JSDOMGlobalObject::setCurrentEvent(Event* currentEvent)
205 {
206     m_currentEvent = currentEvent;
207 }
208 
209 Event* JSDOMGlobalObject::currentEvent() const
210 {
211     return m_currentEvent;
212 }
213 
<span class="line-modified">214 void JSDOMGlobalObject::promiseRejectionTracker(JSGlobalObject* jsGlobalObject, JSPromise* promise, JSPromiseRejectionOperation operation)</span>
215 {
216     // https://html.spec.whatwg.org/multipage/webappapis.html#the-hostpromiserejectiontracker-implementation
217 
218     auto&amp; globalObject = *JSC::jsCast&lt;JSDOMGlobalObject*&gt;(jsGlobalObject);
219     auto* context = globalObject.scriptExecutionContext();
220     if (!context)
221         return;
222 
223     // FIXME: If script has muted errors (cross origin), terminate these steps.
224     // &lt;https://webkit.org/b/171415&gt; Implement the `muted-errors` property of Scripts to avoid onerror/onunhandledrejection for cross-origin scripts
225 
226     switch (operation) {
227     case JSPromiseRejectionOperation::Reject:
<span class="line-modified">228         context-&gt;ensureRejectedPromiseTracker().promiseRejected(globalObject, *promise);</span>
229         break;
230     case JSPromiseRejectionOperation::Handle:
<span class="line-modified">231         context-&gt;ensureRejectedPromiseTracker().promiseHandled(globalObject, *promise);</span>
232         break;
233     }
234 }
235 
<span class="line-modified">236 JSDOMGlobalObject&amp; callerGlobalObject(JSGlobalObject&amp; lexicalGlobalObject, CallFrame&amp; callFrame)</span>
237 {
238     class GetCallerGlobalObjectFunctor {
239     public:
240         GetCallerGlobalObjectFunctor() = default;
241 
242         StackVisitor::Status operator()(StackVisitor&amp; visitor) const
243         {
244             if (!m_hasSkippedFirstFrame) {
245                 m_hasSkippedFirstFrame = true;
246                 return StackVisitor::Continue;
247             }
248 
249             if (auto* codeBlock = visitor-&gt;codeBlock())
250                 m_globalObject = codeBlock-&gt;globalObject();
251             else {
252                 ASSERT(visitor-&gt;callee().rawPtr());
253                 // FIXME: Callee is not an object if the caller is Web Assembly.
254                 // Figure out what to do here. We can probably get the global object
255                 // from the top-most Wasm Instance. https://bugs.webkit.org/show_bug.cgi?id=165721
256                 if (visitor-&gt;callee().isCell() &amp;&amp; visitor-&gt;callee().asCell()-&gt;isObject())
257                     m_globalObject = jsCast&lt;JSObject*&gt;(visitor-&gt;callee().asCell())-&gt;globalObject();
258             }
259             return StackVisitor::Done;
260         }
261 
262         JSGlobalObject* globalObject() const { return m_globalObject; }
263 
264     private:
265         mutable bool m_hasSkippedFirstFrame { false };
266         mutable JSGlobalObject* m_globalObject { nullptr };
267     };
268 
269     GetCallerGlobalObjectFunctor iter;
<span class="line-modified">270     callFrame.iterate(lexicalGlobalObject.vm(), iter);</span>
271     if (iter.globalObject())
272         return *jsCast&lt;JSDOMGlobalObject*&gt;(iter.globalObject());
273 
<span class="line-modified">274     // If we cannot find JSGlobalObject in caller frames, we just return the current lexicalGlobalObject.</span>
<span class="line-modified">275     return *jsCast&lt;JSDOMGlobalObject*&gt;(&amp;lexicalGlobalObject);</span>
276 }
277 
278 JSDOMGlobalObject* toJSDOMGlobalObject(ScriptExecutionContext&amp; context, DOMWrapperWorld&amp; world)
279 {
280     if (is&lt;Document&gt;(context))
281         return toJSDOMWindow(downcast&lt;Document&gt;(context).frame(), world);
282 
283     if (is&lt;WorkerGlobalScope&gt;(context))
284         return downcast&lt;WorkerGlobalScope&gt;(context).script()-&gt;workerGlobalScopeWrapper();
285 
286     ASSERT_NOT_REACHED();
287     return nullptr;
288 }
289 
290 } // namespace WebCore
</pre>
</td>
</tr>
</table>
<center><a href="JSDOMExceptionHandling.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="JSDOMGlobalObject.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>