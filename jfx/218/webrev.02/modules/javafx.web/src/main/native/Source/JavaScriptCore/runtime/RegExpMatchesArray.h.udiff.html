<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/JavaScriptCore/runtime/RegExpMatchesArray.h</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="RegExpMatchesArray.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="RegExpObject.cpp.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/JavaScriptCore/runtime/RegExpMatchesArray.h</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -22,10 +22,11 @@</span>
  #include &quot;ButterflyInlines.h&quot;
  #include &quot;GCDeferralContextInlines.h&quot;
  #include &quot;JSArray.h&quot;
  #include &quot;JSCInlines.h&quot;
  #include &quot;JSGlobalObject.h&quot;
<span class="udiff-line-added">+ #include &quot;ObjectConstructor.h&quot;</span>
  #include &quot;RegExpInlines.h&quot;
  #include &quot;RegExpObject.h&quot;
  
  namespace JSC {
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -80,27 +81,22 @@</span>
      // FIXME: This should handle array allocation errors gracefully.
      // https://bugs.webkit.org/show_bug.cgi?id=155144
  
      unsigned numSubpatterns = regExp-&gt;numSubpatterns();
      bool hasNamedCaptures = regExp-&gt;hasNamedCaptures();
<span class="udiff-line-modified-removed">-     JSObject* groups = nullptr;</span>
<span class="udiff-line-modified-added">+     JSObject* groups = hasNamedCaptures ? constructEmptyObject(vm, globalObject-&gt;nullPrototypeObjectStructure()) : nullptr;</span>
      Structure* matchStructure = globalObject-&gt;regExpMatchesArrayStructure();
<span class="udiff-line-removed">-     if (hasNamedCaptures) {</span>
<span class="udiff-line-removed">-         groups = JSFinalObject::create(vm, JSFinalObject::createStructure(vm, globalObject, globalObject-&gt;objectPrototype(), 0));</span>
<span class="udiff-line-removed">-         matchStructure = globalObject-&gt;regExpMatchesArrayWithGroupsStructure();</span>
<span class="udiff-line-removed">-     }</span>
  
      auto setProperties = [&amp;] () {
          array-&gt;putDirect(vm, RegExpMatchesArrayIndexPropertyOffset, jsNumber(result.start));
          array-&gt;putDirect(vm, RegExpMatchesArrayInputPropertyOffset, input);
<span class="udiff-line-modified-removed">-         if (hasNamedCaptures)</span>
<span class="udiff-line-removed">-             array-&gt;putDirect(vm, RegExpMatchesArrayGroupsPropertyOffset, groups);</span>
<span class="udiff-line-modified-added">+         array-&gt;putDirect(vm, RegExpMatchesArrayGroupsPropertyOffset, hasNamedCaptures ? groups : jsUndefined());</span>
  
          ASSERT(!array-&gt;butterfly()-&gt;indexingHeader()-&gt;preCapacity(matchStructure));
          auto capacity = matchStructure-&gt;outOfLineCapacity();
          auto size = matchStructure-&gt;outOfLineSize();
<span class="udiff-line-modified-removed">-         memset(array-&gt;butterfly()-&gt;base(0, capacity), 0, (capacity - size) * sizeof(JSValue));</span>
<span class="udiff-line-modified-added">+         gcSafeZeroMemory(static_cast&lt;JSValue*&gt;(array-&gt;butterfly()-&gt;base(0, capacity)), (capacity - size) * sizeof(JSValue));</span>
      };
  
      if (UNLIKELY(globalObject-&gt;isHavingABadTime())) {
          GCDeferralContext deferralContext(vm.heap);
          ObjectInitializationScope scope(vm);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -153,27 +149,31 @@</span>
  
      // Now the object is safe to scan by GC.
  
      // We initialize the groups object late as it could allocate, which with the current API could cause
      // allocations.
<span class="udiff-line-modified-removed">-     if (groups) {</span>
<span class="udiff-line-modified-added">+     if (hasNamedCaptures) {</span>
          for (unsigned i = 1; i &lt;= numSubpatterns; ++i) {
              String groupName = regExp-&gt;getCaptureGroupName(i);
              if (!groupName.isEmpty())
                  groups-&gt;putDirect(vm, Identifier::fromString(vm, groupName), array-&gt;getIndexQuickly(i));
          }
      }
      return array;
  }
  
<span class="udiff-line-modified-removed">- inline JSArray* createRegExpMatchesArray(ExecState* exec, JSGlobalObject* globalObject, JSString* string, RegExp* regExp, unsigned startOffset)</span>
<span class="udiff-line-modified-added">+ inline JSArray* createRegExpMatchesArray(JSGlobalObject* globalObject, JSString* string, RegExp* regExp, unsigned startOffset)</span>
  {
<span class="udiff-line-added">+     VM&amp; vm = getVM(globalObject);</span>
<span class="udiff-line-added">+     auto scope = DECLARE_THROW_SCOPE(vm);</span>
<span class="udiff-line-added">+ </span>
      MatchResult ignoredResult;
<span class="udiff-line-modified-removed">-     return createRegExpMatchesArray(globalObject-&gt;vm(), globalObject, string, string-&gt;value(exec), regExp, startOffset, ignoredResult);</span>
<span class="udiff-line-modified-added">+     String input = string-&gt;value(globalObject);</span>
<span class="udiff-line-added">+     RETURN_IF_EXCEPTION(scope, { });</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     RELEASE_AND_RETURN(scope, createRegExpMatchesArray(vm, globalObject, string, input, regExp, startOffset, ignoredResult));</span>
  }
  JSArray* createEmptyRegExpMatchesArray(JSGlobalObject*, JSString*, RegExp*);
  Structure* createRegExpMatchesArrayStructure(VM&amp;, JSGlobalObject*);
  Structure* createRegExpMatchesArraySlowPutStructure(VM&amp;, JSGlobalObject*);
<span class="udiff-line-removed">- Structure* createRegExpMatchesArrayWithGroupsStructure(VM&amp;, JSGlobalObject*);</span>
<span class="udiff-line-removed">- Structure* createRegExpMatchesArrayWithGroupsSlowPutStructure(VM&amp;, JSGlobalObject*);</span>
  
  } // namespace JSC
</pre>
<center><a href="RegExpMatchesArray.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="RegExpObject.cpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>