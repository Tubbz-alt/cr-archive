<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New modules/javafx.web/src/main/native/Source/WebCore/css/CSSPrimitiveValue.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * (C) 1999-2003 Lars Knoll (knoll@kde.org)
   3  * Copyright (C) 2004, 2005, 2006, 2007, 2008, 2012, 2013 Apple Inc. All rights reserved.
   4  *
   5  * This library is free software; you can redistribute it and/or
   6  * modify it under the terms of the GNU Library General Public
   7  * License as published by the Free Software Foundation; either
   8  * version 2 of the License, or (at your option) any later version.
   9  *
  10  * This library is distributed in the hope that it will be useful,
  11  * but WITHOUT ANY WARRANTY; without even the implied warranty of
  12  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
  13  * Library General Public License for more details.
  14  *
  15  * You should have received a copy of the GNU Library General Public License
  16  * along with this library; see the file COPYING.LIB.  If not, write to
  17  * the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
  18  * Boston, MA 02110-1301, USA.
  19  */
  20 
  21 #include &quot;config.h&quot;
  22 #include &quot;CSSPrimitiveValue.h&quot;
  23 
  24 #include &quot;CSSBasicShapes.h&quot;
  25 #include &quot;CSSCalculationValue.h&quot;
  26 #include &quot;CSSFontFamily.h&quot;
  27 #include &quot;CSSHelper.h&quot;
  28 #include &quot;CSSMarkup.h&quot;
  29 #include &quot;CSSPrimitiveValueMappings.h&quot;
  30 #include &quot;CSSPropertyNames.h&quot;
  31 #include &quot;CSSToLengthConversionData.h&quot;
  32 #include &quot;CSSValueKeywords.h&quot;
  33 #include &quot;CalculationValue.h&quot;
  34 #include &quot;Color.h&quot;
  35 #include &quot;Counter.h&quot;
  36 #include &quot;DeprecatedCSSOMPrimitiveValue.h&quot;
  37 #include &quot;FontCascade.h&quot;
  38 #include &quot;Node.h&quot;
  39 #include &quot;Pair.h&quot;
  40 #include &quot;Rect.h&quot;
  41 #include &quot;RenderStyle.h&quot;
  42 #include &lt;wtf/NeverDestroyed.h&gt;
  43 #include &lt;wtf/StdLibExtras.h&gt;
  44 #include &lt;wtf/text/StringBuilder.h&gt;
  45 #include &lt;wtf/text/StringConcatenateNumbers.h&gt;
  46 
  47 namespace WebCore {
  48 
  49 static inline bool isValidCSSUnitTypeForDoubleConversion(CSSUnitType unitType)
  50 {
  51     switch (unitType) {
  52     case CSSUnitType::CSS_CALC:
  53     case CSSUnitType::CSS_CALC_PERCENTAGE_WITH_LENGTH:
  54     case CSSUnitType::CSS_CALC_PERCENTAGE_WITH_NUMBER:
  55     case CSSUnitType::CSS_CHS:
  56     case CSSUnitType::CSS_CM:
  57     case CSSUnitType::CSS_DEG:
  58     case CSSUnitType::CSS_DIMENSION:
  59     case CSSUnitType::CSS_EMS:
  60     case CSSUnitType::CSS_EXS:
  61     case CSSUnitType::CSS_FR:
  62     case CSSUnitType::CSS_GRAD:
  63     case CSSUnitType::CSS_HZ:
  64     case CSSUnitType::CSS_IN:
  65     case CSSUnitType::CSS_KHZ:
  66     case CSSUnitType::CSS_MM:
  67     case CSSUnitType::CSS_MS:
  68     case CSSUnitType::CSS_NUMBER:
  69     case CSSUnitType::CSS_PC:
  70     case CSSUnitType::CSS_PERCENTAGE:
  71     case CSSUnitType::CSS_PT:
  72     case CSSUnitType::CSS_PX:
  73     case CSSUnitType::CSS_Q:
  74     case CSSUnitType::CSS_QUIRKY_EMS:
  75     case CSSUnitType::CSS_RAD:
  76     case CSSUnitType::CSS_REMS:
  77     case CSSUnitType::CSS_S:
  78     case CSSUnitType::CSS_TURN:
  79     case CSSUnitType::CSS_VH:
  80     case CSSUnitType::CSS_VMAX:
  81     case CSSUnitType::CSS_VMIN:
  82     case CSSUnitType::CSS_VW:
  83     case CSSUnitType::CSS_DPCM:
  84     case CSSUnitType::CSS_DPI:
  85     case CSSUnitType::CSS_DPPX:
  86         return true;
  87     case CSSUnitType::CSS_ATTR:
  88     case CSSUnitType::CSS_COUNTER:
  89     case CSSUnitType::CSS_COUNTER_NAME:
  90     case CSSUnitType::CSS_FONT_FAMILY:
  91     case CSSUnitType::CSS_IDENT:
  92     case CSSUnitType::CSS_PAIR:
  93     case CSSUnitType::CSS_PROPERTY_ID:
  94     case CSSUnitType::CSS_QUAD:
  95     case CSSUnitType::CSS_RECT:
  96     case CSSUnitType::CSS_RGBCOLOR:
  97     case CSSUnitType::CSS_SHAPE:
  98     case CSSUnitType::CSS_STRING:
  99     case CSSUnitType::CSS_UNICODE_RANGE:
 100     case CSSUnitType::CSS_UNKNOWN:
 101     case CSSUnitType::CSS_URI:
 102     case CSSUnitType::CSS_VALUE_ID:
 103         return false;
 104     }
 105 
 106     ASSERT_NOT_REACHED();
 107     return false;
 108 }
 109 
 110 #if ASSERT_ENABLED
 111 
 112 static inline bool isStringType(CSSUnitType type)
 113 {
 114     switch (type) {
 115     case CSSUnitType::CSS_STRING:
 116     case CSSUnitType::CSS_URI:
 117     case CSSUnitType::CSS_ATTR:
 118     case CSSUnitType::CSS_COUNTER_NAME:
 119     case CSSUnitType::CSS_DIMENSION:
 120         return true;
 121     case CSSUnitType::CSS_CALC:
 122     case CSSUnitType::CSS_CALC_PERCENTAGE_WITH_LENGTH:
 123     case CSSUnitType::CSS_CALC_PERCENTAGE_WITH_NUMBER:
 124     case CSSUnitType::CSS_CHS:
 125     case CSSUnitType::CSS_CM:
 126     case CSSUnitType::CSS_COUNTER:
 127     case CSSUnitType::CSS_DEG:
 128     case CSSUnitType::CSS_DPCM:
 129     case CSSUnitType::CSS_DPI:
 130     case CSSUnitType::CSS_DPPX:
 131     case CSSUnitType::CSS_EMS:
 132     case CSSUnitType::CSS_EXS:
 133     case CSSUnitType::CSS_FONT_FAMILY:
 134     case CSSUnitType::CSS_FR:
 135     case CSSUnitType::CSS_GRAD:
 136     case CSSUnitType::CSS_HZ:
 137     case CSSUnitType::CSS_IDENT:
 138     case CSSUnitType::CSS_IN:
 139     case CSSUnitType::CSS_KHZ:
 140     case CSSUnitType::CSS_MM:
 141     case CSSUnitType::CSS_MS:
 142     case CSSUnitType::CSS_NUMBER:
 143     case CSSUnitType::CSS_PAIR:
 144     case CSSUnitType::CSS_PC:
 145     case CSSUnitType::CSS_PERCENTAGE:
 146     case CSSUnitType::CSS_PROPERTY_ID:
 147     case CSSUnitType::CSS_PT:
 148     case CSSUnitType::CSS_PX:
 149     case CSSUnitType::CSS_Q:
 150     case CSSUnitType::CSS_QUAD:
 151     case CSSUnitType::CSS_QUIRKY_EMS:
 152     case CSSUnitType::CSS_RAD:
 153     case CSSUnitType::CSS_RECT:
 154     case CSSUnitType::CSS_REMS:
 155     case CSSUnitType::CSS_RGBCOLOR:
 156     case CSSUnitType::CSS_S:
 157     case CSSUnitType::CSS_SHAPE:
 158     case CSSUnitType::CSS_TURN:
 159     case CSSUnitType::CSS_UNICODE_RANGE:
 160     case CSSUnitType::CSS_UNKNOWN:
 161     case CSSUnitType::CSS_VALUE_ID:
 162     case CSSUnitType::CSS_VH:
 163     case CSSUnitType::CSS_VMAX:
 164     case CSSUnitType::CSS_VMIN:
 165     case CSSUnitType::CSS_VW:
 166         return false;
 167     }
 168 
 169     ASSERT_NOT_REACHED();
 170     return false;
 171 }
 172 
 173 #endif // ASSERT_ENABLED
 174 
 175 typedef HashMap&lt;const CSSPrimitiveValue*, String&gt; CSSTextCache;
 176 static CSSTextCache&amp; cssTextCache()
 177 {
 178     static NeverDestroyed&lt;CSSTextCache&gt; cache;
 179     return cache;
 180 }
 181 
 182 CSSUnitType CSSPrimitiveValue::primitiveType() const
 183 {
 184     if (primitiveUnitType() == CSSUnitType::CSS_PROPERTY_ID || primitiveUnitType() == CSSUnitType::CSS_VALUE_ID)
 185         return CSSUnitType::CSS_IDENT;
 186 
 187     // Web-exposed content expects font family values to have CSSUnitType::CSS_STRING primitive type
 188     // so we need to map our internal CSSUnitType::CSS_FONT_FAMILY type here.
 189     if (primitiveUnitType() == CSSUnitType::CSS_FONT_FAMILY)
 190         return CSSUnitType::CSS_STRING;
 191 
 192     if (primitiveUnitType() != CSSUnitType::CSS_CALC)
 193         return primitiveUnitType();
 194 
 195     switch (m_value.calc-&gt;category()) {
 196     case CalculationCategory::Number:
 197         return CSSUnitType::CSS_NUMBER;
 198     case CalculationCategory::Percent:
 199         return CSSUnitType::CSS_PERCENTAGE;
 200     case CalculationCategory::PercentNumber:
 201         return CSSUnitType::CSS_CALC_PERCENTAGE_WITH_NUMBER;
 202     case CalculationCategory::PercentLength:
 203         return CSSUnitType::CSS_CALC_PERCENTAGE_WITH_LENGTH;
 204     case CalculationCategory::Length:
 205     case CalculationCategory::Angle:
 206     case CalculationCategory::Time:
 207     case CalculationCategory::Frequency:
 208         return m_value.calc-&gt;primitiveType();
 209     case CalculationCategory::Other:
 210         return CSSUnitType::CSS_UNKNOWN;
 211     }
 212     return CSSUnitType::CSS_UNKNOWN;
 213 }
 214 
 215 static const AtomString&amp; propertyName(CSSPropertyID propertyID)
 216 {
 217     ASSERT_ARG(propertyID, (propertyID &gt;= firstCSSProperty &amp;&amp; propertyID &lt; firstCSSProperty + numCSSProperties));
 218 
 219     return getPropertyNameAtomString(propertyID);
 220 }
 221 
 222 static const AtomString&amp; valueName(CSSValueID valueID)
 223 {
 224     ASSERT_ARG(valueID, (valueID &gt;= firstCSSValueKeyword &amp;&amp; valueID &lt;= lastCSSValueKeyword));
 225 
 226     return getValueNameAtomString(valueID);
 227 }
 228 
 229 CSSPrimitiveValue::CSSPrimitiveValue(CSSValueID valueID)
 230     : CSSValue(PrimitiveClass)
 231 {
 232     setPrimitiveUnitType(CSSUnitType::CSS_VALUE_ID);
 233     m_value.valueID = valueID;
 234 }
 235 
 236 CSSPrimitiveValue::CSSPrimitiveValue(CSSPropertyID propertyID)
 237     : CSSValue(PrimitiveClass)
 238 {
 239     setPrimitiveUnitType(CSSUnitType::CSS_PROPERTY_ID);
 240     m_value.propertyID = propertyID;
 241 }
 242 
 243 CSSPrimitiveValue::CSSPrimitiveValue(double num, CSSUnitType type)
 244     : CSSValue(PrimitiveClass)
 245 {
 246     setPrimitiveUnitType(type);
 247     ASSERT(std::isfinite(num));
 248     m_value.num = num;
 249 }
 250 
 251 CSSPrimitiveValue::CSSPrimitiveValue(const String&amp; string, CSSUnitType type)
 252     : CSSValue(PrimitiveClass)
 253 {
 254     ASSERT(isStringType(type));
 255     setPrimitiveUnitType(type);
 256     if ((m_value.string = string.impl()))
 257         m_value.string-&gt;ref();
 258 }
 259 
 260 CSSPrimitiveValue::CSSPrimitiveValue(const Color&amp; color)
 261     : CSSValue(PrimitiveClass)
 262 {
 263     setPrimitiveUnitType(CSSUnitType::CSS_RGBCOLOR);
 264     m_value.color = new Color(color);
 265 }
 266 
 267 CSSPrimitiveValue::CSSPrimitiveValue(const Length&amp; length)
 268     : CSSValue(PrimitiveClass)
 269 {
 270     init(length);
 271 }
 272 
 273 CSSPrimitiveValue::CSSPrimitiveValue(const Length&amp; length, const RenderStyle&amp; style)
 274     : CSSValue(PrimitiveClass)
 275 {
 276     switch (length.type()) {
 277     case Auto:
 278     case Intrinsic:
 279     case MinIntrinsic:
 280     case MinContent:
 281     case MaxContent:
 282     case FillAvailable:
 283     case FitContent:
 284     case Percent:
 285         init(length);
 286         return;
 287     case Fixed:
 288         setPrimitiveUnitType(CSSUnitType::CSS_PX);
 289         m_value.num = adjustFloatForAbsoluteZoom(length.value(), style);
 290         return;
 291     case Calculated: {
 292         init(CSSCalcValue::create(length.calculationValue(), style));
 293         return;
 294     }
 295     case Relative:
 296     case Undefined:
 297         ASSERT_NOT_REACHED();
 298         return;
 299     }
 300     ASSERT_NOT_REACHED();
 301 }
 302 
 303 CSSPrimitiveValue::CSSPrimitiveValue(const LengthSize&amp; lengthSize, const RenderStyle&amp; style)
 304     : CSSValue(PrimitiveClass)
 305 {
 306     init(lengthSize, style);
 307 }
 308 
 309 CSSPrimitiveValue::CSSPrimitiveValue(StaticCSSValueTag, CSSValueID valueID)
 310     : CSSPrimitiveValue(valueID)
 311 {
 312     makeStatic();
 313 }
 314 
 315 CSSPrimitiveValue::CSSPrimitiveValue(StaticCSSValueTag, const Color&amp; color)
 316     : CSSPrimitiveValue(color)
 317 {
 318     makeStatic();
 319 }
 320 
 321 CSSPrimitiveValue::CSSPrimitiveValue(StaticCSSValueTag, double num, CSSUnitType type)
 322     : CSSPrimitiveValue(num, type)
 323 {
 324     makeStatic();
 325 }
 326 
 327 void CSSPrimitiveValue::init(const Length&amp; length)
 328 {
 329     switch (length.type()) {
 330     case Auto:
 331         setPrimitiveUnitType(CSSUnitType::CSS_VALUE_ID);
 332         m_value.valueID = CSSValueAuto;
 333         return;
 334     case WebCore::Fixed:
 335         setPrimitiveUnitType(CSSUnitType::CSS_PX);
 336         m_value.num = length.value();
 337         return;
 338     case Intrinsic:
 339         setPrimitiveUnitType(CSSUnitType::CSS_VALUE_ID);
 340         m_value.valueID = CSSValueIntrinsic;
 341         return;
 342     case MinIntrinsic:
 343         setPrimitiveUnitType(CSSUnitType::CSS_VALUE_ID);
 344         m_value.valueID = CSSValueMinIntrinsic;
 345         return;
 346     case MinContent:
 347         setPrimitiveUnitType(CSSUnitType::CSS_VALUE_ID);
 348         m_value.valueID = CSSValueMinContent;
 349         return;
 350     case MaxContent:
 351         setPrimitiveUnitType(CSSUnitType::CSS_VALUE_ID);
 352         m_value.valueID = CSSValueMaxContent;
 353         return;
 354     case FillAvailable:
 355         setPrimitiveUnitType(CSSUnitType::CSS_VALUE_ID);
 356         m_value.valueID = CSSValueWebkitFillAvailable;
 357         return;
 358     case FitContent:
 359         setPrimitiveUnitType(CSSUnitType::CSS_VALUE_ID);
 360         m_value.valueID = CSSValueFitContent;
 361         return;
 362     case Percent:
 363         setPrimitiveUnitType(CSSUnitType::CSS_PERCENTAGE);
 364         ASSERT(std::isfinite(length.percent()));
 365         m_value.num = length.percent();
 366         return;
 367     case Calculated:
 368     case Relative:
 369     case Undefined:
 370         ASSERT_NOT_REACHED();
 371         return;
 372     }
 373     ASSERT_NOT_REACHED();
 374 }
 375 
 376 void CSSPrimitiveValue::init(const LengthSize&amp; lengthSize, const RenderStyle&amp; style)
 377 {
 378     setPrimitiveUnitType(CSSUnitType::CSS_PAIR);
 379     m_hasCachedCSSText = false;
 380     m_value.pair = &amp;Pair::create(create(lengthSize.width, style), create(lengthSize.height, style)).leakRef();
 381 }
 382 
 383 void CSSPrimitiveValue::init(Ref&lt;Counter&gt;&amp;&amp; counter)
 384 {
 385     setPrimitiveUnitType(CSSUnitType::CSS_COUNTER);
 386     m_hasCachedCSSText = false;
 387     m_value.counter = &amp;counter.leakRef();
 388 }
 389 
 390 void CSSPrimitiveValue::init(Ref&lt;Rect&gt;&amp;&amp; r)
 391 {
 392     setPrimitiveUnitType(CSSUnitType::CSS_RECT);
 393     m_hasCachedCSSText = false;
 394     m_value.rect = &amp;r.leakRef();
 395 }
 396 
 397 void CSSPrimitiveValue::init(Ref&lt;Quad&gt;&amp;&amp; quad)
 398 {
 399     setPrimitiveUnitType(CSSUnitType::CSS_QUAD);
 400     m_hasCachedCSSText = false;
 401     m_value.quad = &amp;quad.leakRef();
 402 }
 403 
 404 void CSSPrimitiveValue::init(Ref&lt;Pair&gt;&amp;&amp; p)
 405 {
 406     setPrimitiveUnitType(CSSUnitType::CSS_PAIR);
 407     m_hasCachedCSSText = false;
 408     m_value.pair = &amp;p.leakRef();
 409 }
 410 
 411 void CSSPrimitiveValue::init(Ref&lt;CSSBasicShape&gt;&amp;&amp; shape)
 412 {
 413     setPrimitiveUnitType(CSSUnitType::CSS_SHAPE);
 414     m_hasCachedCSSText = false;
 415     m_value.shape = &amp;shape.leakRef();
 416 }
 417 
 418 void CSSPrimitiveValue::init(RefPtr&lt;CSSCalcValue&gt;&amp;&amp; c)
 419 {
 420     setPrimitiveUnitType(CSSUnitType::CSS_CALC);
 421     m_hasCachedCSSText = false;
 422     m_value.calc = c.leakRef();
 423 }
 424 
 425 CSSPrimitiveValue::~CSSPrimitiveValue()
 426 {
 427     cleanup();
 428 }
 429 
 430 void CSSPrimitiveValue::cleanup()
 431 {
 432     auto type = primitiveUnitType();
 433     switch (type) {
 434     case CSSUnitType::CSS_STRING:
 435     case CSSUnitType::CSS_URI:
 436     case CSSUnitType::CSS_ATTR:
 437     case CSSUnitType::CSS_COUNTER_NAME:
 438         if (m_value.string)
 439             m_value.string-&gt;deref();
 440         break;
 441     case CSSUnitType::CSS_DIMENSION:
 442     case CSSUnitType::CSS_COUNTER:
 443         m_value.counter-&gt;deref();
 444         break;
 445     case CSSUnitType::CSS_RECT:
 446         m_value.rect-&gt;deref();
 447         break;
 448     case CSSUnitType::CSS_QUAD:
 449         m_value.quad-&gt;deref();
 450         break;
 451     case CSSUnitType::CSS_PAIR:
 452         m_value.pair-&gt;deref();
 453         break;
 454     case CSSUnitType::CSS_CALC:
 455         m_value.calc-&gt;deref();
 456         break;
 457     case CSSUnitType::CSS_CALC_PERCENTAGE_WITH_NUMBER:
 458     case CSSUnitType::CSS_CALC_PERCENTAGE_WITH_LENGTH:
 459         ASSERT_NOT_REACHED();
 460         break;
 461     case CSSUnitType::CSS_SHAPE:
 462         m_value.shape-&gt;deref();
 463         break;
 464     case CSSUnitType::CSS_FONT_FAMILY:
 465         ASSERT(m_value.fontFamily);
 466         delete m_value.fontFamily;
 467         m_value.fontFamily = nullptr;
 468         break;
 469     case CSSUnitType::CSS_RGBCOLOR:
 470         ASSERT(m_value.color);
 471         delete m_value.color;
 472         m_value.color = nullptr;
 473         break;
 474     case CSSUnitType::CSS_NUMBER:
 475     case CSSUnitType::CSS_PERCENTAGE:
 476     case CSSUnitType::CSS_EMS:
 477     case CSSUnitType::CSS_QUIRKY_EMS:
 478     case CSSUnitType::CSS_EXS:
 479     case CSSUnitType::CSS_REMS:
 480     case CSSUnitType::CSS_CHS:
 481     case CSSUnitType::CSS_PX:
 482     case CSSUnitType::CSS_CM:
 483     case CSSUnitType::CSS_MM:
 484     case CSSUnitType::CSS_IN:
 485     case CSSUnitType::CSS_PT:
 486     case CSSUnitType::CSS_PC:
 487     case CSSUnitType::CSS_DEG:
 488     case CSSUnitType::CSS_RAD:
 489     case CSSUnitType::CSS_GRAD:
 490     case CSSUnitType::CSS_MS:
 491     case CSSUnitType::CSS_S:
 492     case CSSUnitType::CSS_HZ:
 493     case CSSUnitType::CSS_KHZ:
 494     case CSSUnitType::CSS_TURN:
 495     case CSSUnitType::CSS_VW:
 496     case CSSUnitType::CSS_VH:
 497     case CSSUnitType::CSS_VMIN:
 498     case CSSUnitType::CSS_VMAX:
 499     case CSSUnitType::CSS_DPPX:
 500     case CSSUnitType::CSS_DPI:
 501     case CSSUnitType::CSS_DPCM:
 502     case CSSUnitType::CSS_FR:
 503     case CSSUnitType::CSS_Q:
 504     case CSSUnitType::CSS_IDENT:
 505     case CSSUnitType::CSS_UNKNOWN:
 506     case CSSUnitType::CSS_UNICODE_RANGE:
 507     case CSSUnitType::CSS_PROPERTY_ID:
 508     case CSSUnitType::CSS_VALUE_ID:
 509         ASSERT(!isStringType(type));
 510         break;
 511     }
 512     setPrimitiveUnitType(CSSUnitType::CSS_UNKNOWN);
 513     if (m_hasCachedCSSText) {
 514         cssTextCache().remove(this);
 515         m_hasCachedCSSText = false;
 516     }
 517 }
 518 
 519 double CSSPrimitiveValue::computeDegrees() const
 520 {
 521     switch (primitiveType()) {
 522     case CSSUnitType::CSS_DEG:
 523         return doubleValue();
 524     case CSSUnitType::CSS_RAD:
 525         return rad2deg(doubleValue());
 526     case CSSUnitType::CSS_GRAD:
 527         return grad2deg(doubleValue());
 528     case CSSUnitType::CSS_TURN:
 529         return turn2deg(doubleValue());
 530     default:
 531         ASSERT_NOT_REACHED();
 532         return 0;
 533     }
 534 }
 535 
 536 template&lt;&gt; int CSSPrimitiveValue::computeLength(const CSSToLengthConversionData&amp; conversionData) const
 537 {
 538     return roundForImpreciseConversion&lt;int&gt;(computeLengthDouble(conversionData));
 539 }
 540 
 541 template&lt;&gt; unsigned CSSPrimitiveValue::computeLength(const CSSToLengthConversionData&amp; conversionData) const
 542 {
 543     return roundForImpreciseConversion&lt;unsigned&gt;(computeLengthDouble(conversionData));
 544 }
 545 
 546 template&lt;&gt; Length CSSPrimitiveValue::computeLength(const CSSToLengthConversionData&amp; conversionData) const
 547 {
 548     return Length(clampTo&lt;float&gt;(computeLengthDouble(conversionData), minValueForCssLength, maxValueForCssLength), Fixed);
 549 }
 550 
 551 template&lt;&gt; short CSSPrimitiveValue::computeLength(const CSSToLengthConversionData&amp; conversionData) const
 552 {
 553     return roundForImpreciseConversion&lt;short&gt;(computeLengthDouble(conversionData));
 554 }
 555 
 556 template&lt;&gt; unsigned short CSSPrimitiveValue::computeLength(const CSSToLengthConversionData&amp; conversionData) const
 557 {
 558     return roundForImpreciseConversion&lt;unsigned short&gt;(computeLengthDouble(conversionData));
 559 }
 560 
 561 template&lt;&gt; float CSSPrimitiveValue::computeLength(const CSSToLengthConversionData&amp; conversionData) const
 562 {
 563     return static_cast&lt;float&gt;(computeLengthDouble(conversionData));
 564 }
 565 
 566 template&lt;&gt; double CSSPrimitiveValue::computeLength(const CSSToLengthConversionData&amp; conversionData) const
 567 {
 568     return computeLengthDouble(conversionData);
 569 }
 570 
 571 template&lt;&gt; LayoutUnit CSSPrimitiveValue::computeLength(const CSSToLengthConversionData&amp; conversionData) const
 572 {
 573     return LayoutUnit(computeLengthDouble(conversionData));
 574 }
 575 
 576 double CSSPrimitiveValue::computeLengthDouble(const CSSToLengthConversionData&amp; conversionData) const
 577 {
 578     if (primitiveUnitType() == CSSUnitType::CSS_CALC) {
 579         // The multiplier and factor is applied to each value in the calc expression individually
 580         return m_value.calc-&gt;computeLengthPx(conversionData);
 581     }
 582 
 583     return computeNonCalcLengthDouble(conversionData, primitiveType(), m_value.num);
 584 }
 585 
 586 static constexpr double mmPerInch = 25.4;
 587 static constexpr double cmPerInch = 2.54;
 588 static constexpr double QPerInch = 25.4 * 4.0;
 589 
 590 double CSSPrimitiveValue::computeNonCalcLengthDouble(const CSSToLengthConversionData&amp; conversionData, CSSUnitType primitiveType, double value)
 591 {
 592     double factor;
 593     bool applyZoom = true;
 594 
 595     switch (primitiveType) {
 596     case CSSUnitType::CSS_EMS:
 597     case CSSUnitType::CSS_QUIRKY_EMS:
 598         ASSERT(conversionData.style());
 599         factor = conversionData.computingFontSize() ? conversionData.style()-&gt;fontDescription().specifiedSize() : conversionData.style()-&gt;fontDescription().computedSize();
 600         break;
 601     case CSSUnitType::CSS_EXS:
 602         ASSERT(conversionData.style());
 603         // FIXME: We have a bug right now where the zoom will be applied twice to EX units.
 604         // We really need to compute EX using fontMetrics for the original specifiedSize and not use
 605         // our actual constructed rendering font.
 606         if (conversionData.style()-&gt;fontMetrics().hasXHeight())
 607             factor = conversionData.style()-&gt;fontMetrics().xHeight();
 608         else
 609             factor = (conversionData.computingFontSize() ? conversionData.style()-&gt;fontDescription().specifiedSize() : conversionData.style()-&gt;fontDescription().computedSize()) / 2.0;
 610         break;
 611     case CSSUnitType::CSS_REMS:
 612         if (conversionData.rootStyle())
 613             factor = conversionData.computingFontSize() ? conversionData.rootStyle()-&gt;fontDescription().specifiedSize() : conversionData.rootStyle()-&gt;fontDescription().computedSize();
 614         else
 615             factor = 1.0;
 616         break;
 617     case CSSUnitType::CSS_CHS:
 618         ASSERT(conversionData.style());
 619         factor = conversionData.style()-&gt;fontMetrics().zeroWidth();
 620         break;
 621     case CSSUnitType::CSS_PX:
 622         factor = 1.0;
 623         break;
 624     case CSSUnitType::CSS_CM:
 625         factor = cssPixelsPerInch / cmPerInch;
 626         break;
 627     case CSSUnitType::CSS_MM:
 628         factor = cssPixelsPerInch / mmPerInch;
 629         break;
 630     case CSSUnitType::CSS_Q:
 631         factor = cssPixelsPerInch / QPerInch;
 632         break;
 633     case CSSUnitType::CSS_IN:
 634         factor = cssPixelsPerInch;
 635         break;
 636     case CSSUnitType::CSS_PT:
 637         factor = cssPixelsPerInch / 72.0;
 638         break;
 639     case CSSUnitType::CSS_PC:
 640         // 1 pc == 12 pt
 641         factor = cssPixelsPerInch * 12.0 / 72.0;
 642         break;
 643     case CSSUnitType::CSS_CALC_PERCENTAGE_WITH_LENGTH:
 644     case CSSUnitType::CSS_CALC_PERCENTAGE_WITH_NUMBER:
 645         ASSERT_NOT_REACHED();
 646         return -1.0;
 647     case CSSUnitType::CSS_VH:
 648         factor = conversionData.viewportHeightFactor();
 649         applyZoom = false;
 650         break;
 651     case CSSUnitType::CSS_VW:
 652         factor = conversionData.viewportWidthFactor();
 653         applyZoom = false;
 654         break;
 655     case CSSUnitType::CSS_VMAX:
 656         factor = conversionData.viewportMaxFactor();
 657         applyZoom = false;
 658         break;
 659     case CSSUnitType::CSS_VMIN:
 660         factor = conversionData.viewportMinFactor();
 661         applyZoom = false;
 662         break;
 663     default:
 664         ASSERT_NOT_REACHED();
 665         return -1.0;
 666     }
 667 
 668     // We do not apply the zoom factor when we are computing the value of the font-size property. The zooming
 669     // for font sizes is much more complicated, since we have to worry about enforcing the minimum font size preference
 670     // as well as enforcing the implicit &quot;smart minimum.&quot;
 671     double result = value * factor;
 672     if (conversionData.computingFontSize() || isFontRelativeLength(primitiveType))
 673         return result;
 674 
 675     if (applyZoom)
 676         result *= conversionData.zoom();
 677 
 678     return result;
 679 }
 680 
 681 bool CSSPrimitiveValue::equalForLengthResolution(const RenderStyle&amp; styleA, const RenderStyle&amp; styleB)
 682 {
 683     // These properties affect results of computeNonCalcLengthDouble above.
 684     if (styleA.fontDescription().computedSize() != styleB.fontDescription().computedSize())
 685         return false;
 686     if (styleA.fontDescription().specifiedSize() != styleB.fontDescription().specifiedSize())
 687         return false;
 688 
 689     if (styleA.fontMetrics().xHeight() != styleB.fontMetrics().xHeight())
 690         return false;
 691     if (styleA.fontMetrics().zeroWidth() != styleB.fontMetrics().zeroWidth())
 692         return false;
 693 
 694     if (styleA.zoom() != styleB.zoom())
 695         return false;
 696 
 697     return true;
 698 }
 699 
 700 ExceptionOr&lt;void&gt; CSSPrimitiveValue::setFloatValue(CSSUnitType, double)
 701 {
 702     // Keeping values immutable makes optimizations easier and allows sharing of the primitive value objects.
 703     // No other engine supports mutating style through this API. Computed style is always read-only anyway.
 704     // Supporting setter would require making primitive value copy-on-write and taking care of style invalidation.
 705     return Exception { NoModificationAllowedError };
 706 }
 707 
 708 double CSSPrimitiveValue::conversionToCanonicalUnitsScaleFactor(CSSUnitType unitType)
 709 {
 710     double factor = 1.0;
 711     // FIXME: the switch can be replaced by an array of scale factors.
 712     switch (unitType) {
 713     // These are &quot;canonical&quot; units in their respective categories.
 714     case CSSUnitType::CSS_PX:
 715     case CSSUnitType::CSS_DEG:
 716     case CSSUnitType::CSS_MS:
 717     case CSSUnitType::CSS_HZ:
 718     case CSSUnitType::CSS_DPPX:
 719         break;
 720     case CSSUnitType::CSS_CM:
 721         factor = cssPixelsPerInch / cmPerInch;
 722         break;
 723     case CSSUnitType::CSS_DPCM:
 724         factor = cmPerInch / cssPixelsPerInch; // (2.54 cm/in)
 725         break;
 726     case CSSUnitType::CSS_MM:
 727         factor = cssPixelsPerInch / mmPerInch;
 728         break;
 729     case CSSUnitType::CSS_Q:
 730         factor = cssPixelsPerInch / QPerInch;
 731         break;
 732     case CSSUnitType::CSS_IN:
 733         factor = cssPixelsPerInch;
 734         break;
 735     case CSSUnitType::CSS_DPI:
 736         factor = 1 / cssPixelsPerInch;
 737         break;
 738     case CSSUnitType::CSS_PT:
 739         factor = cssPixelsPerInch / 72.0;
 740         break;
 741     case CSSUnitType::CSS_PC:
 742         factor = cssPixelsPerInch * 12.0 / 72.0; // 1 pc == 12 pt
 743         break;
 744     case CSSUnitType::CSS_RAD:
 745         factor = 180 / piDouble;
 746         break;
 747     case CSSUnitType::CSS_GRAD:
 748         factor = 0.9;
 749         break;
 750     case CSSUnitType::CSS_TURN:
 751         factor = 360;
 752         break;
 753     case CSSUnitType::CSS_S:
 754     case CSSUnitType::CSS_KHZ:
 755         factor = 1000;
 756         break;
 757     default:
 758         break;
 759     }
 760 
 761     return factor;
 762 }
 763 
 764 ExceptionOr&lt;float&gt; CSSPrimitiveValue::getFloatValue(CSSUnitType unitType) const
 765 {
 766     auto result = doubleValueInternal(unitType);
 767     if (!result)
 768         return Exception { InvalidAccessError };
 769     return clampTo&lt;float&gt;(result.value());
 770 }
 771 
 772 double CSSPrimitiveValue::doubleValue(CSSUnitType unitType) const
 773 {
 774     return doubleValueInternal(unitType).valueOr(0);
 775 }
 776 
 777 double CSSPrimitiveValue::doubleValue() const
 778 {
 779     return primitiveUnitType() != CSSUnitType::CSS_CALC ? m_value.num : m_value.calc-&gt;doubleValue();
 780 }
 781 
 782 Optional&lt;bool&gt; CSSPrimitiveValue::isZero() const
 783 {
 784     if (primitiveUnitType() == CSSUnitType::CSS_CALC)
 785         return WTF::nullopt;
 786     return !m_value.num;
 787 }
 788 
 789 Optional&lt;bool&gt; CSSPrimitiveValue::isPositive() const
 790 {
 791     if (primitiveUnitType() == CSSUnitType::CSS_CALC)
 792         return WTF::nullopt;
 793     return m_value.num &gt; 0;
 794 }
 795 
 796 Optional&lt;bool&gt; CSSPrimitiveValue::isNegative() const
 797 {
 798     if (primitiveUnitType() == CSSUnitType::CSS_CALC)
 799         return WTF::nullopt;
 800     return m_value.num &lt; 0;
 801 }
 802 
 803 Optional&lt;double&gt; CSSPrimitiveValue::doubleValueInternal(CSSUnitType requestedUnitType) const
 804 {
 805     if (!isValidCSSUnitTypeForDoubleConversion(primitiveUnitType()) || !isValidCSSUnitTypeForDoubleConversion(requestedUnitType))
 806         return WTF::nullopt;
 807 
 808     CSSUnitType sourceUnitType = primitiveType();
 809     if (requestedUnitType == sourceUnitType || requestedUnitType == CSSUnitType::CSS_DIMENSION)
 810         return doubleValue();
 811 
 812     CSSUnitCategory sourceCategory = unitCategory(sourceUnitType);
 813     ASSERT(sourceCategory != CSSUnitCategory::Other);
 814 
 815     CSSUnitType targetUnitType = requestedUnitType;
 816     CSSUnitCategory targetCategory = unitCategory(targetUnitType);
 817     ASSERT(targetCategory != CSSUnitCategory::Other);
 818 
 819     // Cannot convert between unrelated unit categories if one of them is not CSSUnitCategory::Number.
 820     if (sourceCategory != targetCategory &amp;&amp; sourceCategory != CSSUnitCategory::Number &amp;&amp; targetCategory != CSSUnitCategory::Number)
 821         return WTF::nullopt;
 822 
 823     if (targetCategory == CSSUnitCategory::Number) {
 824         // We interpret conversion to CSSUnitType::CSS_NUMBER as conversion to a canonical unit in this value&#39;s category.
 825         targetUnitType = canonicalUnitTypeForCategory(sourceCategory);
 826         if (targetUnitType == CSSUnitType::CSS_UNKNOWN)
 827             return WTF::nullopt;
 828     }
 829 
 830     if (sourceUnitType == CSSUnitType::CSS_NUMBER) {
 831         // We interpret conversion from CSSUnitType::CSS_NUMBER in the same way as CSSParser::validUnit() while using non-strict mode.
 832         sourceUnitType = canonicalUnitTypeForCategory(targetCategory);
 833         if (sourceUnitType == CSSUnitType::CSS_UNKNOWN)
 834             return WTF::nullopt;
 835     }
 836 
 837     double convertedValue = doubleValue();
 838 
 839     // First convert the value from primitiveUnitType() to canonical type.
 840     double factor = conversionToCanonicalUnitsScaleFactor(sourceUnitType);
 841     convertedValue *= factor;
 842 
 843     // Now convert from canonical type to the target unitType.
 844     factor = conversionToCanonicalUnitsScaleFactor(targetUnitType);
 845     convertedValue /= factor;
 846 
 847     return convertedValue;
 848 }
 849 
 850 ExceptionOr&lt;void&gt; CSSPrimitiveValue::setStringValue(CSSUnitType, const String&amp;)
 851 {
 852     // Keeping values immutable makes optimizations easier and allows sharing of the primitive value objects.
 853     // No other engine supports mutating style through this API. Computed style is always read-only anyway.
 854     // Supporting setter would require making primitive value copy-on-write and taking care of style invalidation.
 855     return Exception { NoModificationAllowedError };
 856 }
 857 
 858 ExceptionOr&lt;String&gt; CSSPrimitiveValue::getStringValue() const
 859 {
 860     switch (primitiveUnitType()) {
 861     case CSSUnitType::CSS_STRING:
 862     case CSSUnitType::CSS_ATTR:
 863     case CSSUnitType::CSS_URI:
 864         return m_value.string;
 865     case CSSUnitType::CSS_FONT_FAMILY:
 866         return String { m_value.fontFamily-&gt;familyName };
 867     case CSSUnitType::CSS_VALUE_ID:
 868         return String { valueName(m_value.valueID).string() };
 869     case CSSUnitType::CSS_PROPERTY_ID:
 870         return String { propertyName(m_value.propertyID).string() };
 871     default:
 872         return Exception { InvalidAccessError };
 873     }
 874 }
 875 
 876 String CSSPrimitiveValue::stringValue() const
 877 {
 878     switch (primitiveUnitType()) {
 879     case CSSUnitType::CSS_STRING:
 880     case CSSUnitType::CSS_ATTR:
 881     case CSSUnitType::CSS_URI:
 882         return m_value.string;
 883     case CSSUnitType::CSS_FONT_FAMILY:
 884         return m_value.fontFamily-&gt;familyName;
 885     case CSSUnitType::CSS_VALUE_ID:
 886         return valueName(m_value.valueID);
 887     case CSSUnitType::CSS_PROPERTY_ID:
 888         return propertyName(m_value.propertyID);
 889     default:
 890         return String();
 891     }
 892 }
 893 
 894 NEVER_INLINE String CSSPrimitiveValue::formatNumberValue(StringView suffix) const
 895 {
 896     return makeString(m_value.num, suffix);
 897 }
 898 
 899 String CSSPrimitiveValue::unitTypeString(CSSUnitType unitType)
 900 {
 901     switch (unitType) {
 902         case CSSUnitType::CSS_PERCENTAGE: return &quot;%&quot;;
 903         case CSSUnitType::CSS_EMS: return &quot;em&quot;;
 904         case CSSUnitType::CSS_EXS: return &quot;ex&quot;;
 905         case CSSUnitType::CSS_PX: return &quot;px&quot;;
 906         case CSSUnitType::CSS_CM: return &quot;cm&quot;;
 907         case CSSUnitType::CSS_MM: return &quot;mm&quot;;
 908         case CSSUnitType::CSS_IN: return &quot;in&quot;;
 909         case CSSUnitType::CSS_PT: return &quot;pt&quot;;
 910         case CSSUnitType::CSS_PC: return &quot;pc&quot;;
 911         case CSSUnitType::CSS_DEG: return &quot;deg&quot;;
 912         case CSSUnitType::CSS_RAD: return &quot;rad&quot;;
 913         case CSSUnitType::CSS_GRAD: return &quot;grad&quot;;
 914         case CSSUnitType::CSS_MS: return &quot;ms&quot;;
 915         case CSSUnitType::CSS_S: return &quot;s&quot;;
 916         case CSSUnitType::CSS_HZ: return &quot;hz&quot;;
 917         case CSSUnitType::CSS_KHZ: return &quot;khz&quot;;
 918         case CSSUnitType::CSS_VW: return &quot;vw&quot;;
 919         case CSSUnitType::CSS_VH: return &quot;vh&quot;;
 920         case CSSUnitType::CSS_VMIN: return &quot;vmin&quot;;
 921         case CSSUnitType::CSS_VMAX: return &quot;vmax&quot;;
 922         case CSSUnitType::CSS_DPPX: return &quot;dppx&quot;;
 923         case CSSUnitType::CSS_DPI: return &quot;dpi&quot;;
 924         case CSSUnitType::CSS_DPCM: return &quot;dpcm&quot;;
 925         case CSSUnitType::CSS_FR: return &quot;fr&quot;;
 926         case CSSUnitType::CSS_Q: return &quot;q&quot;;
 927         case CSSUnitType::CSS_TURN: return &quot;turn&quot;;
 928         case CSSUnitType::CSS_REMS: return &quot;rem&quot;;
 929         case CSSUnitType::CSS_CHS: return &quot;ch&quot;;
 930 
 931         case CSSUnitType::CSS_UNKNOWN:
 932         case CSSUnitType::CSS_NUMBER:
 933         case CSSUnitType::CSS_DIMENSION:
 934         case CSSUnitType::CSS_STRING:
 935         case CSSUnitType::CSS_URI:
 936         case CSSUnitType::CSS_IDENT:
 937         case CSSUnitType::CSS_ATTR:
 938         case CSSUnitType::CSS_COUNTER:
 939         case CSSUnitType::CSS_RECT:
 940         case CSSUnitType::CSS_RGBCOLOR:
 941         case CSSUnitType::CSS_PAIR:
 942         case CSSUnitType::CSS_UNICODE_RANGE:
 943         case CSSUnitType::CSS_COUNTER_NAME:
 944         case CSSUnitType::CSS_SHAPE:
 945         case CSSUnitType::CSS_QUAD:
 946         case CSSUnitType::CSS_CALC:
 947         case CSSUnitType::CSS_CALC_PERCENTAGE_WITH_NUMBER:
 948         case CSSUnitType::CSS_CALC_PERCENTAGE_WITH_LENGTH:
 949         case CSSUnitType::CSS_FONT_FAMILY:
 950         case CSSUnitType::CSS_PROPERTY_ID:
 951         case CSSUnitType::CSS_VALUE_ID:
 952         case CSSUnitType::CSS_QUIRKY_EMS:
 953             return emptyString();
 954     }
 955     return emptyString();
 956 }
 957 
 958 ALWAYS_INLINE String CSSPrimitiveValue::formatNumberForCustomCSSText() const
 959 {
 960     switch (primitiveUnitType()) {
 961     case CSSUnitType::CSS_UNKNOWN:
 962         return String();
 963     case CSSUnitType::CSS_NUMBER:
 964         return formatNumberValue(&quot;&quot;);
 965     case CSSUnitType::CSS_PERCENTAGE:
 966         return formatNumberValue(&quot;%&quot;);
 967     case CSSUnitType::CSS_EMS:
 968     case CSSUnitType::CSS_QUIRKY_EMS:
 969         return formatNumberValue(&quot;em&quot;);
 970     case CSSUnitType::CSS_EXS:
 971         return formatNumberValue(&quot;ex&quot;);
 972     case CSSUnitType::CSS_REMS:
 973         return formatNumberValue(&quot;rem&quot;);
 974     case CSSUnitType::CSS_CHS:
 975         return formatNumberValue(&quot;ch&quot;);
 976     case CSSUnitType::CSS_PX:
 977         return formatNumberValue(&quot;px&quot;);
 978     case CSSUnitType::CSS_CM:
 979         return formatNumberValue(&quot;cm&quot;);
 980     case CSSUnitType::CSS_DPPX:
 981         return formatNumberValue(&quot;dppx&quot;);
 982     case CSSUnitType::CSS_DPI:
 983         return formatNumberValue(&quot;dpi&quot;);
 984     case CSSUnitType::CSS_DPCM:
 985         return formatNumberValue(&quot;dpcm&quot;);
 986     case CSSUnitType::CSS_MM:
 987         return formatNumberValue(&quot;mm&quot;);
 988     case CSSUnitType::CSS_IN:
 989         return formatNumberValue(&quot;in&quot;);
 990     case CSSUnitType::CSS_PT:
 991         return formatNumberValue(&quot;pt&quot;);
 992     case CSSUnitType::CSS_PC:
 993         return formatNumberValue(&quot;pc&quot;);
 994     case CSSUnitType::CSS_DEG:
 995         return formatNumberValue(&quot;deg&quot;);
 996     case CSSUnitType::CSS_RAD:
 997         return formatNumberValue(&quot;rad&quot;);
 998     case CSSUnitType::CSS_GRAD:
 999         return formatNumberValue(&quot;grad&quot;);
1000     case CSSUnitType::CSS_MS:
1001         return formatNumberValue(&quot;ms&quot;);
1002     case CSSUnitType::CSS_S:
1003         return formatNumberValue(&quot;s&quot;);
1004     case CSSUnitType::CSS_HZ:
1005         return formatNumberValue(&quot;hz&quot;);
1006     case CSSUnitType::CSS_KHZ:
1007         return formatNumberValue(&quot;khz&quot;);
1008     case CSSUnitType::CSS_TURN:
1009         return formatNumberValue(&quot;turn&quot;);
1010     case CSSUnitType::CSS_FR:
1011         return formatNumberValue(&quot;fr&quot;);
1012     case CSSUnitType::CSS_Q:
1013         return formatNumberValue(&quot;q&quot;);
1014     case CSSUnitType::CSS_DIMENSION:
1015         // FIXME: We currently don&#39;t handle CSSUnitType::CSS_DIMENSION properly as we don&#39;t store
1016         // the actual dimension, just the numeric value as a string.
1017     case CSSUnitType::CSS_STRING:
1018         // FIME-NEWPARSER: Once we have CSSCustomIdentValue hooked up, this can just be
1019         // serializeString, since custom identifiers won&#39;t be the same value as strings
1020         // any longer.
1021         return serializeAsStringOrCustomIdent(m_value.string);
1022     case CSSUnitType::CSS_FONT_FAMILY:
1023         return serializeFontFamily(m_value.fontFamily-&gt;familyName);
1024     case CSSUnitType::CSS_URI:
1025         return serializeURL(m_value.string);
1026     case CSSUnitType::CSS_VALUE_ID:
1027         return valueName(m_value.valueID);
1028     case CSSUnitType::CSS_PROPERTY_ID:
1029         return propertyName(m_value.propertyID);
1030     case CSSUnitType::CSS_ATTR:
1031         return &quot;attr(&quot; + String(m_value.string) + &#39;)&#39;;
1032     case CSSUnitType::CSS_COUNTER_NAME:
1033         return &quot;counter(&quot; + String(m_value.string) + &#39;)&#39;;
1034     case CSSUnitType::CSS_COUNTER: {
1035         StringBuilder result;
1036         String separator = m_value.counter-&gt;separator();
1037         if (separator.isEmpty())
1038             result.appendLiteral(&quot;counter(&quot;);
1039         else
1040             result.appendLiteral(&quot;counters(&quot;);
1041 
1042         result.append(m_value.counter-&gt;identifier());
1043         if (!separator.isEmpty()) {
1044             result.appendLiteral(&quot;, &quot;);
1045             serializeString(separator, result);
1046         }
1047         String listStyle = m_value.counter-&gt;listStyle();
1048         if (!listStyle.isEmpty())
1049             result.append(&quot;, &quot;, listStyle);
1050         result.append(&#39;)&#39;);
1051 
1052         return result.toString();
1053     }
1054     case CSSUnitType::CSS_RECT:
1055         return rectValue()-&gt;cssText();
1056     case CSSUnitType::CSS_QUAD:
1057         return quadValue()-&gt;cssText();
1058     case CSSUnitType::CSS_RGBCOLOR:
1059         return color().cssText();
1060     case CSSUnitType::CSS_PAIR:
1061         return pairValue()-&gt;cssText();
1062     case CSSUnitType::CSS_CALC:
1063         return m_value.calc-&gt;cssText();
1064     case CSSUnitType::CSS_SHAPE:
1065         return m_value.shape-&gt;cssText();
1066     case CSSUnitType::CSS_VW:
1067         return formatNumberValue(&quot;vw&quot;);
1068     case CSSUnitType::CSS_VH:
1069         return formatNumberValue(&quot;vh&quot;);
1070     case CSSUnitType::CSS_VMIN:
1071         return formatNumberValue(&quot;vmin&quot;);
1072     case CSSUnitType::CSS_VMAX:
1073         return formatNumberValue(&quot;vmax&quot;);
1074     case CSSUnitType::CSS_IDENT:
1075     case CSSUnitType::CSS_UNICODE_RANGE:
1076     case CSSUnitType::CSS_CALC_PERCENTAGE_WITH_NUMBER:
1077     case CSSUnitType::CSS_CALC_PERCENTAGE_WITH_LENGTH:
1078         ASSERT_NOT_REACHED();
1079     }
1080     return String();
1081 }
1082 
1083 String CSSPrimitiveValue::customCSSText() const
1084 {
1085     // FIXME: return the original value instead of a generated one (e.g. color
1086     // name if it was specified) - check what spec says about this
1087 
1088     CSSTextCache&amp; cssTextCache = WebCore::cssTextCache();
1089 
1090     if (m_hasCachedCSSText) {
1091         ASSERT(cssTextCache.contains(this));
1092         return cssTextCache.get(this);
1093     }
1094 
1095     String text = formatNumberForCustomCSSText();
1096 
1097     ASSERT(!cssTextCache.contains(this));
1098     m_hasCachedCSSText = true;
1099     cssTextCache.set(this, text);
1100     return text;
1101 }
1102 
1103 bool CSSPrimitiveValue::equals(const CSSPrimitiveValue&amp; other) const
1104 {
1105     if (primitiveUnitType() != other.primitiveUnitType())
1106         return false;
1107 
1108     switch (primitiveUnitType()) {
1109     case CSSUnitType::CSS_UNKNOWN:
1110         return false;
1111     case CSSUnitType::CSS_NUMBER:
1112     case CSSUnitType::CSS_PERCENTAGE:
1113     case CSSUnitType::CSS_EMS:
1114     case CSSUnitType::CSS_QUIRKY_EMS:
1115     case CSSUnitType::CSS_EXS:
1116     case CSSUnitType::CSS_REMS:
1117     case CSSUnitType::CSS_CHS:
1118     case CSSUnitType::CSS_PX:
1119     case CSSUnitType::CSS_CM:
1120     case CSSUnitType::CSS_DPPX:
1121     case CSSUnitType::CSS_DPI:
1122     case CSSUnitType::CSS_DPCM:
1123     case CSSUnitType::CSS_MM:
1124     case CSSUnitType::CSS_IN:
1125     case CSSUnitType::CSS_PT:
1126     case CSSUnitType::CSS_PC:
1127     case CSSUnitType::CSS_DEG:
1128     case CSSUnitType::CSS_RAD:
1129     case CSSUnitType::CSS_GRAD:
1130     case CSSUnitType::CSS_MS:
1131     case CSSUnitType::CSS_S:
1132     case CSSUnitType::CSS_HZ:
1133     case CSSUnitType::CSS_KHZ:
1134     case CSSUnitType::CSS_TURN:
1135     case CSSUnitType::CSS_VW:
1136     case CSSUnitType::CSS_VH:
1137     case CSSUnitType::CSS_VMIN:
1138     case CSSUnitType::CSS_VMAX:
1139     case CSSUnitType::CSS_FR:
1140     case CSSUnitType::CSS_Q:
1141         return m_value.num == other.m_value.num;
1142     case CSSUnitType::CSS_PROPERTY_ID:
1143         return propertyName(m_value.propertyID) == propertyName(other.m_value.propertyID);
1144     case CSSUnitType::CSS_VALUE_ID:
1145         return valueName(m_value.valueID) == valueName(other.m_value.valueID);
1146     case CSSUnitType::CSS_DIMENSION:
1147     case CSSUnitType::CSS_STRING:
1148     case CSSUnitType::CSS_URI:
1149     case CSSUnitType::CSS_ATTR:
1150     case CSSUnitType::CSS_COUNTER_NAME:
1151         return equal(m_value.string, other.m_value.string);
1152     case CSSUnitType::CSS_COUNTER:
1153         return m_value.counter &amp;&amp; other.m_value.counter &amp;&amp; m_value.counter-&gt;equals(*other.m_value.counter);
1154     case CSSUnitType::CSS_RECT:
1155         return m_value.rect &amp;&amp; other.m_value.rect &amp;&amp; m_value.rect-&gt;equals(*other.m_value.rect);
1156     case CSSUnitType::CSS_QUAD:
1157         return m_value.quad &amp;&amp; other.m_value.quad &amp;&amp; m_value.quad-&gt;equals(*other.m_value.quad);
1158     case CSSUnitType::CSS_RGBCOLOR:
1159         return color() == other.color();
1160     case CSSUnitType::CSS_PAIR:
1161         return m_value.pair &amp;&amp; other.m_value.pair &amp;&amp; m_value.pair-&gt;equals(*other.m_value.pair);
1162     case CSSUnitType::CSS_CALC:
1163         return m_value.calc &amp;&amp; other.m_value.calc &amp;&amp; m_value.calc-&gt;equals(*other.m_value.calc);
1164     case CSSUnitType::CSS_SHAPE:
1165         return m_value.shape &amp;&amp; other.m_value.shape &amp;&amp; m_value.shape-&gt;equals(*other.m_value.shape);
1166     case CSSUnitType::CSS_FONT_FAMILY:
1167         return fontFamily() == other.fontFamily();
1168     case CSSUnitType::CSS_IDENT:
1169     case CSSUnitType::CSS_UNICODE_RANGE:
1170     case CSSUnitType::CSS_CALC_PERCENTAGE_WITH_NUMBER:
1171     case CSSUnitType::CSS_CALC_PERCENTAGE_WITH_LENGTH:
1172         // FIXME: seems like these should be handled.
1173         ASSERT_NOT_REACHED();
1174         break;
1175     }
1176     return false;
1177 }
1178 
1179 Ref&lt;DeprecatedCSSOMPrimitiveValue&gt; CSSPrimitiveValue::createDeprecatedCSSOMPrimitiveWrapper(CSSStyleDeclaration&amp; styleDeclaration) const
1180 {
1181     return DeprecatedCSSOMPrimitiveValue::create(*this, styleDeclaration);
1182 }
1183 
1184 // https://drafts.css-houdini.org/css-properties-values-api/#dependency-cycles-via-relative-units
1185 void CSSPrimitiveValue::collectDirectComputationalDependencies(HashSet&lt;CSSPropertyID&gt;&amp; values) const
1186 {
1187     switch (primitiveUnitType()) {
1188     case CSSUnitType::CSS_EMS:
1189     case CSSUnitType::CSS_QUIRKY_EMS:
1190     case CSSUnitType::CSS_EXS:
1191     case CSSUnitType::CSS_CHS:
1192         values.add(CSSPropertyFontSize);
1193         break;
1194     case CSSUnitType::CSS_CALC:
1195         m_value.calc-&gt;collectDirectComputationalDependencies(values);
1196         break;
1197     default:
1198         break;
1199     }
1200 }
1201 
1202 void CSSPrimitiveValue::collectDirectRootComputationalDependencies(HashSet&lt;CSSPropertyID&gt;&amp; values) const
1203 {
1204     switch (primitiveUnitType()) {
1205     case CSSUnitType::CSS_REMS:
1206         values.add(CSSPropertyFontSize);
1207         break;
1208     case CSSUnitType::CSS_CALC:
1209         m_value.calc-&gt;collectDirectRootComputationalDependencies(values);
1210         break;
1211     default:
1212         break;
1213     }
1214 }
1215 
1216 } // namespace WebCore
    </pre>
  </body>
</html>