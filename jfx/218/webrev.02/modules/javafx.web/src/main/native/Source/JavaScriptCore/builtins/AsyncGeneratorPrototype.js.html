<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New modules/javafx.web/src/main/native/Source/JavaScriptCore/builtins/AsyncGeneratorPrototype.js</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (C) 2017 Oleksandr Skachkov &lt;gskachkov@gmail.com&gt;.
  3  * Copyright (C) 2019 Apple Inc. All rights reserved.
  4  *
  5  * Redistribution and use in source and binary forms, with or without
  6  * modification, are permitted provided that the following conditions
  7  * are met:
  8  * 1. Redistributions of source code must retain the above copyright
  9  *    notice, this list of conditions and the following disclaimer.
 10  * 2. Redistributions in binary form must reproduce the above copyright
 11  *    notice, this list of conditions and the following disclaimer in the
 12  *    documentation and/or other materials provided with the distribution.
 13  *
 14  * THIS SOFTWARE IS PROVIDED BY APPLE INC. ``AS IS&#39;&#39; AND ANY
 15  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 16  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 17  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE INC. OR
 18  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 19  * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 20  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 21  * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 22  * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 23  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 24  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 25  */
 26 
 27 @globalPrivate
 28 function asyncGeneratorQueueIsEmpty(generator)
 29 {
 30     &quot;use strict&quot;;
 31 
 32     return @getAsyncGeneratorInternalField(generator, @asyncGeneratorFieldQueueFirst) === null;
 33 }
 34 
 35 @globalPrivate
 36 function asyncGeneratorQueueEnqueue(generator, item)
 37 {
 38     &quot;use strict&quot;;
 39 
 40     @assert(@getByIdDirectPrivate(item, &quot;asyncGeneratorQueueItemNext&quot;) === null);
 41 
 42     if (@getAsyncGeneratorInternalField(generator, @asyncGeneratorFieldQueueFirst) === null) {
 43         @assert(@getAsyncGeneratorInternalField(generator, @asyncGeneratorFieldQueueLast) === null);
 44 
 45         @putAsyncGeneratorInternalField(generator, @asyncGeneratorFieldQueueFirst, item);
 46         @putAsyncGeneratorInternalField(generator, @asyncGeneratorFieldQueueLast, item);
 47     } else {
 48         var last = @getAsyncGeneratorInternalField(generator, @asyncGeneratorFieldQueueLast);
 49         @putByIdDirectPrivate(last, &quot;asyncGeneratorQueueItemNext&quot;, item);
 50         @putAsyncGeneratorInternalField(generator, @asyncGeneratorFieldQueueLast, item);
 51     }
 52 }
 53 
 54 @globalPrivate
 55 function asyncGeneratorQueueDequeue(generator)
 56 {
 57     &quot;use strict&quot;;
 58 
 59     @assert(!@asyncGeneratorQueueIsEmpty(generator), &quot;Async genetator&#39;s Queue is an empty List.&quot;);
 60 
 61     var result = @getAsyncGeneratorInternalField(generator, @asyncGeneratorFieldQueueFirst);
 62 
 63     var updatedFirst = @getByIdDirectPrivate(result, &quot;asyncGeneratorQueueItemNext&quot;);
 64     @putAsyncGeneratorInternalField(generator, @asyncGeneratorFieldQueueFirst, updatedFirst);
 65 
 66     if (updatedFirst === null)
 67         @putAsyncGeneratorInternalField(generator, @asyncGeneratorFieldQueueLast, null);
 68 
 69     return result;
 70 }
 71 
 72 @globalPrivate
 73 function isExecutionState(generator)
 74 {
 75     &quot;use strict&quot;;
 76 
 77     var state = @getAsyncGeneratorInternalField(generator, @generatorFieldState);
 78     var reason = @getAsyncGeneratorInternalField(generator, @asyncGeneratorFieldSuspendReason);
 79     return (state &gt; 0 &amp;&amp; reason === @AsyncGeneratorSuspendReasonNone)
 80         || state === @AsyncGeneratorStateExecuting
 81         || reason === @AsyncGeneratorSuspendReasonAwait;
 82 }
 83 
 84 @globalPrivate
 85 function isSuspendYieldState(generator)
 86 {
 87     &quot;use strict&quot;;
 88 
 89     var state = @getAsyncGeneratorInternalField(generator, @generatorFieldState);
 90     return (state &gt; 0 &amp;&amp; @getAsyncGeneratorInternalField(generator, @asyncGeneratorFieldSuspendReason) === @AsyncGeneratorSuspendReasonYield)
 91         || state === @AsyncGeneratorStateSuspendedYield;
 92 }
 93 
 94 @globalPrivate
 95 function asyncGeneratorReject(generator, exception)
 96 {
 97     &quot;use strict&quot;;
 98 
 99     @assert(@isAsyncGenerator(generator), &quot;Generator is not an AsyncGenerator instance.&quot;);
100 
101     var promise = @asyncGeneratorQueueDequeue(generator).promise;
102     @assert(@isPromise(promise));
103     @rejectPromiseWithFirstResolvingFunctionCallCheck(promise, exception);
104 
105     return @asyncGeneratorResumeNext(generator);
106 }
107 
108 @globalPrivate
109 function asyncGeneratorResolve(generator, value, done)
110 {
111     &quot;use strict&quot;;
112 
113     @assert(@isAsyncGenerator(generator), &quot;Generator is not an AsyncGenerator instance.&quot;);
114 
115     var promise = @asyncGeneratorQueueDequeue(generator).promise;
116     @assert(@isPromise(promise));
117     @resolvePromiseWithFirstResolvingFunctionCallCheck(promise, { value, done });
118 
119     return @asyncGeneratorResumeNext(generator);
120 }
121 
122 @globalPrivate
123 function asyncGeneratorYield(generator, value, resumeMode)
124 {
125     &quot;use strict&quot;;
126 
127     function asyncGeneratorYieldAwaited(result)
128     {
129         @putAsyncGeneratorInternalField(generator, @asyncGeneratorFieldSuspendReason, @AsyncGeneratorSuspendReasonYield);
130         @asyncGeneratorResolve(generator, result, false);
131     }
132 
133     @putAsyncGeneratorInternalField(generator, @asyncGeneratorFieldSuspendReason, @AsyncGeneratorSuspendReasonAwait);
134 
135     @awaitValue(generator, value, asyncGeneratorYieldAwaited);
136 }
137 
138 @globalPrivate
139 function awaitValue(generator, value, onFulfilled)
140 {
141     &quot;use strict&quot;;
142 
143     var onRejected = function (result) { @doAsyncGeneratorBodyCall(generator, result, @GeneratorResumeModeThrow); };
144     @resolveWithoutPromise(value, onFulfilled, onRejected);
145 }
146 
147 @globalPrivate
148 function doAsyncGeneratorBodyCall(generator, resumeValue, resumeMode)
149 {
150     &quot;use strict&quot;;
151 
152     var value = @undefined;
153     var state = @getAsyncGeneratorInternalField(generator, @generatorFieldState);
154 
155     @putAsyncGeneratorInternalField(generator, @generatorFieldState, @AsyncGeneratorStateExecuting);
156     @putAsyncGeneratorInternalField(generator, @asyncGeneratorFieldSuspendReason, @AsyncGeneratorSuspendReasonNone);
157 
158     try {
159         value = @getAsyncGeneratorInternalField(generator, @generatorFieldNext).@call(@getAsyncGeneratorInternalField(generator, @generatorFieldThis), generator, state, resumeValue, resumeMode, @getAsyncGeneratorInternalField(generator, @generatorFieldFrame));
160         state = @getAsyncGeneratorInternalField(generator, @generatorFieldState);
161         if (state === @AsyncGeneratorStateExecuting) {
162             @putAsyncGeneratorInternalField(generator, @generatorFieldState, @AsyncGeneratorStateCompleted);
163             state = @AsyncGeneratorStateCompleted;
164         }
165     } catch (error) {
166         @putAsyncGeneratorInternalField(generator, @generatorFieldState, @AsyncGeneratorStateCompleted);
167         @putAsyncGeneratorInternalField(generator, @asyncGeneratorFieldSuspendReason, @AsyncGeneratorSuspendReasonNone);
168 
169         return @asyncGeneratorReject(generator, error);
170     }
171 
172     var reason = @getAsyncGeneratorInternalField(generator, @asyncGeneratorFieldSuspendReason);
173     if (reason === @AsyncGeneratorSuspendReasonAwait) {
174         var onFulfilled = function(result) { @doAsyncGeneratorBodyCall(generator, result, @GeneratorResumeModeNormal); };
175 
176         @awaitValue(generator, value, onFulfilled);
177         return;
178     }
179 
180     if (reason === @AsyncGeneratorSuspendReasonYield)
181         return @asyncGeneratorYield(generator, value, resumeMode);
182 
183     if (state === @AsyncGeneratorStateCompleted) {
184         @assert(@getAsyncGeneratorInternalField(generator, @generatorFieldState) == @AsyncGeneratorStateCompleted);
185         @putAsyncGeneratorInternalField(generator, @asyncGeneratorFieldSuspendReason, @AsyncGeneratorSuspendReasonNone);
186         return @asyncGeneratorResolve(generator, value, true);
187     }
188 }
189 
190 @globalPrivate
191 function asyncGeneratorResumeNext(generator)
192 {
193     &quot;use strict&quot;;
194 
195     @assert(@isAsyncGenerator(generator), &quot;Generator is not an AsyncGenerator instance.&quot;);
196 
197     var state = @getAsyncGeneratorInternalField(generator, @generatorFieldState);
198 
199     @assert(state !== @AsyncGeneratorStateExecuting, &quot;Async generator should not be in executing state&quot;);
200 
201     if (state === @AsyncGeneratorStateAwaitingReturn)
202         return;
203 
204     if (@asyncGeneratorQueueIsEmpty(generator))
205         return;
206 
207     var next = @getAsyncGeneratorInternalField(generator, @asyncGeneratorFieldQueueFirst);
208 
209     if (next.resumeMode !== @GeneratorResumeModeNormal) {
210         if (state === @AsyncGeneratorStateSuspendedStart) {
211             @putAsyncGeneratorInternalField(generator, @generatorFieldState, @AsyncGeneratorStateCompleted);
212             state = @AsyncGeneratorStateCompleted;
213         }
214 
215         if (state === @AsyncGeneratorStateCompleted) {
216             if (next.resumeMode === @GeneratorResumeModeReturn) {
217                 @putAsyncGeneratorInternalField(generator, @generatorFieldState, @AsyncGeneratorStateAwaitingReturn);
218                 @resolveWithoutPromise(next.value,
219                     function (result) {
220                         @putAsyncGeneratorInternalField(generator, @generatorFieldState, @AsyncGeneratorStateCompleted);
221                         @asyncGeneratorResolve(generator, result, true);
222                     },
223                     function (error) {
224                         @putAsyncGeneratorInternalField(generator, @generatorFieldState, @AsyncGeneratorStateCompleted);
225                         @asyncGeneratorReject(generator, error);
226                     });
227                 return;
228             }
229 
230             @assert(next.resumeMode === @GeneratorResumeModeThrow, &quot;Async generator has wrong mode&quot;);
231 
232             return @asyncGeneratorReject(generator, next.value);;
233         }
234     } else if (state === @AsyncGeneratorStateCompleted)
235         return @asyncGeneratorResolve(generator, @undefined, true);
236 
237     @assert(state === @AsyncGeneratorStateSuspendedStart || @isSuspendYieldState(generator), &quot;Async generator has wrong state&quot;);
238 
239     @doAsyncGeneratorBodyCall(generator, next.value, next.resumeMode);
240 }
241 
242 @globalPrivate
243 function asyncGeneratorEnqueue(generator, value, resumeMode)
244 {
245     &quot;use strict&quot;;
246 
247     var promise = @newPromise();
248     if (!@isAsyncGenerator(generator)) {
249         @rejectPromiseWithFirstResolvingFunctionCallCheck(promise, @makeTypeError(&#39;|this| should be an async generator&#39;));
250         return promise;
251     }
252 
253     @asyncGeneratorQueueEnqueue(generator, {resumeMode, value, promise, @asyncGeneratorQueueItemNext: null});
254 
255     if (!@isExecutionState(generator))
256         @asyncGeneratorResumeNext(generator);
257 
258     return promise;
259 }
260 
261 function next(value)
262 {
263     &quot;use strict&quot;;
264 
265     return @asyncGeneratorEnqueue(this, value, @GeneratorResumeModeNormal);
266 }
267 
268 function return(value)
269 {
270     &quot;use strict&quot;;
271 
272     return @asyncGeneratorEnqueue(this, value, @GeneratorResumeModeReturn);
273 }
274 
275 function throw(exception)
276 {
277     &quot;use strict&quot;;
278     
279     return @asyncGeneratorEnqueue(this, exception, @GeneratorResumeModeThrow);
280 }
    </pre>
  </body>
</html>