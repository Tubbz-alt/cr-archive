<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/JavaScriptCore/runtime/JSArrayBufferView.h</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="JSArrayBufferView.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="JSArrayBufferViewInlines.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/JavaScriptCore/runtime/JSArrayBufferView.h</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 78     // knows-what, and M = DataViewMode. The view does not own the vector.
 79     // There is an extra field (in JSDataView) that points to the
 80     // ArrayBuffer.
 81     DataViewMode
 82 };
 83 
 84 inline bool hasArrayBuffer(TypedArrayMode mode)
 85 {
 86     return mode &gt;= WastefulTypedArray;
 87 }
 88 
 89 // When WebCore uses a JSArrayBufferView, it expects to be able to get the native
 90 // ArrayBuffer and little else. This requires slowing down and wasting memory,
 91 // and then accessing things via the Butterfly. When JS uses a JSArrayBufferView
 92 // it is always via the usual methods in the MethodTable, so this class&#39;s
 93 // implementation of those has no need to even exist - we could at any time sink
 94 // code into JSGenericTypedArrayView if it was convenient.
 95 
 96 class JSArrayBufferView : public JSNonFinalObject {
 97 public:
<span class="line-modified"> 98     typedef JSNonFinalObject Base;</span>
<span class="line-modified"> 99     static const unsigned fastSizeLimit = 1000;</span>







100     using VectorPtr = CagedBarrierPtr&lt;Gigacage::Primitive, void, tagCagedPtr&gt;;
101 
102     static size_t sizeOf(uint32_t length, uint32_t elementSize)
103     {
<span class="line-modified">104         return (length * elementSize + sizeof(EncodedJSValue) - 1)</span>
105             &amp; ~(sizeof(EncodedJSValue) - 1);
106     }
107 
108     static size_t allocationSize(Checked&lt;size_t&gt; inlineCapacity)
109     {
110         ASSERT_UNUSED(inlineCapacity, !inlineCapacity);
111         return sizeof(JSArrayBufferView);
112     }
113 
114 protected:
115     class ConstructionContext {
116         WTF_MAKE_NONCOPYABLE(ConstructionContext);
117 
118     public:
119         enum InitializationMode { ZeroFill, DontInitialize };
120 
121         JS_EXPORT_PRIVATE ConstructionContext(VM&amp;, Structure*, uint32_t length, uint32_t elementSize, InitializationMode = ZeroFill);
122 
123         // This is only for constructing fast typed arrays. It&#39;s used by the JIT&#39;s slow path.
124         ConstructionContext(Structure*, uint32_t length, void* vector);
</pre>
<hr />
<pre>
135         bool operator!() const { return !m_structure; }
136 
137         Structure* structure() const { return m_structure; }
138         void* vector() const { return m_vector.getMayBeNull(m_length); }
139         uint32_t length() const { return m_length; }
140         TypedArrayMode mode() const { return m_mode; }
141         Butterfly* butterfly() const { return m_butterfly; }
142 
143     private:
144         Structure* m_structure;
145         using VectorType = CagedPtr&lt;Gigacage::Primitive, void, tagCagedPtr&gt;;
146         VectorType m_vector;
147         uint32_t m_length;
148         TypedArrayMode m_mode;
149         Butterfly* m_butterfly;
150     };
151 
152     JS_EXPORT_PRIVATE JSArrayBufferView(VM&amp;, ConstructionContext&amp;);
153     JS_EXPORT_PRIVATE void finishCreation(VM&amp;);
154 
<span class="line-modified">155     static bool put(JSCell*, ExecState*, PropertyName, JSValue, PutPropertySlot&amp;);</span>
156 
157     static void visitChildren(JSCell*, SlotVisitor&amp;);
158 
159 public:
160     TypedArrayMode mode() const { return m_mode; }
161     bool hasArrayBuffer() const { return JSC::hasArrayBuffer(mode()); }
162 
163     bool isShared();
164     JS_EXPORT_PRIVATE ArrayBuffer* unsharedBuffer();
<span class="line-modified">165     ArrayBuffer* possiblySharedBuffer();</span>
<span class="line-modified">166     JSArrayBuffer* unsharedJSBuffer(ExecState* exec);</span>
<span class="line-modified">167     JSArrayBuffer* possiblySharedJSBuffer(ExecState* exec);</span>
168     RefPtr&lt;ArrayBufferView&gt; unsharedImpl();
169     JS_EXPORT_PRIVATE RefPtr&lt;ArrayBufferView&gt; possiblySharedImpl();
170     bool isNeutered() { return hasArrayBuffer() &amp;&amp; !hasVector(); }
171     void neuter();
172 
173     bool hasVector() const { return !!m_vector; }
174     void* vector() const { return m_vector.getMayBeNull(length()); }
175 
<span class="line-modified">176     unsigned byteOffset();</span>


177     unsigned length() const { return m_length; }
178 
179     DECLARE_EXPORT_INFO;
180 
181     static ptrdiff_t offsetOfVector() { return OBJECT_OFFSETOF(JSArrayBufferView, m_vector); }
182     static ptrdiff_t offsetOfLength() { return OBJECT_OFFSETOF(JSArrayBufferView, m_length); }
183     static ptrdiff_t offsetOfMode() { return OBJECT_OFFSETOF(JSArrayBufferView, m_mode); }
184 
185     static RefPtr&lt;ArrayBufferView&gt; toWrapped(VM&amp;, JSValue);
186 
187 private:




188     JS_EXPORT_PRIVATE ArrayBuffer* slowDownAndWasteMemory();
189     static void finalize(JSCell*);
190 
191 protected:
192     friend class LLIntOffsetsExtractor;
193 
194     ArrayBuffer* existingBufferInButterfly();
195 
<span class="line-modified">196     static String toStringName(const JSObject*, ExecState*);</span>
197 
198     VectorPtr m_vector;
199     uint32_t m_length;
200     TypedArrayMode m_mode;
201 };
202 
203 } // namespace JSC
204 
205 namespace WTF {
206 
207 JS_EXPORT_PRIVATE void printInternal(PrintStream&amp;, JSC::TypedArrayMode);
208 
209 } // namespace WTF
</pre>
</td>
<td>
<hr />
<pre>
 78     // knows-what, and M = DataViewMode. The view does not own the vector.
 79     // There is an extra field (in JSDataView) that points to the
 80     // ArrayBuffer.
 81     DataViewMode
 82 };
 83 
 84 inline bool hasArrayBuffer(TypedArrayMode mode)
 85 {
 86     return mode &gt;= WastefulTypedArray;
 87 }
 88 
 89 // When WebCore uses a JSArrayBufferView, it expects to be able to get the native
 90 // ArrayBuffer and little else. This requires slowing down and wasting memory,
 91 // and then accessing things via the Butterfly. When JS uses a JSArrayBufferView
 92 // it is always via the usual methods in the MethodTable, so this class&#39;s
 93 // implementation of those has no need to even exist - we could at any time sink
 94 // code into JSGenericTypedArrayView if it was convenient.
 95 
 96 class JSArrayBufferView : public JSNonFinalObject {
 97 public:
<span class="line-modified"> 98     using Base = JSNonFinalObject;</span>
<span class="line-modified"> 99 </span>
<span class="line-added">100     template&lt;typename, SubspaceAccess&gt;</span>
<span class="line-added">101     static void subspaceFor(VM&amp;)</span>
<span class="line-added">102     {</span>
<span class="line-added">103         RELEASE_ASSERT_NOT_REACHED();</span>
<span class="line-added">104     }</span>
<span class="line-added">105 </span>
<span class="line-added">106     static constexpr unsigned fastSizeLimit = 1000;</span>
107     using VectorPtr = CagedBarrierPtr&lt;Gigacage::Primitive, void, tagCagedPtr&gt;;
108 
109     static size_t sizeOf(uint32_t length, uint32_t elementSize)
110     {
<span class="line-modified">111         return (static_cast&lt;size_t&gt;(length) * elementSize + sizeof(EncodedJSValue) - 1)</span>
112             &amp; ~(sizeof(EncodedJSValue) - 1);
113     }
114 
115     static size_t allocationSize(Checked&lt;size_t&gt; inlineCapacity)
116     {
117         ASSERT_UNUSED(inlineCapacity, !inlineCapacity);
118         return sizeof(JSArrayBufferView);
119     }
120 
121 protected:
122     class ConstructionContext {
123         WTF_MAKE_NONCOPYABLE(ConstructionContext);
124 
125     public:
126         enum InitializationMode { ZeroFill, DontInitialize };
127 
128         JS_EXPORT_PRIVATE ConstructionContext(VM&amp;, Structure*, uint32_t length, uint32_t elementSize, InitializationMode = ZeroFill);
129 
130         // This is only for constructing fast typed arrays. It&#39;s used by the JIT&#39;s slow path.
131         ConstructionContext(Structure*, uint32_t length, void* vector);
</pre>
<hr />
<pre>
142         bool operator!() const { return !m_structure; }
143 
144         Structure* structure() const { return m_structure; }
145         void* vector() const { return m_vector.getMayBeNull(m_length); }
146         uint32_t length() const { return m_length; }
147         TypedArrayMode mode() const { return m_mode; }
148         Butterfly* butterfly() const { return m_butterfly; }
149 
150     private:
151         Structure* m_structure;
152         using VectorType = CagedPtr&lt;Gigacage::Primitive, void, tagCagedPtr&gt;;
153         VectorType m_vector;
154         uint32_t m_length;
155         TypedArrayMode m_mode;
156         Butterfly* m_butterfly;
157     };
158 
159     JS_EXPORT_PRIVATE JSArrayBufferView(VM&amp;, ConstructionContext&amp;);
160     JS_EXPORT_PRIVATE void finishCreation(VM&amp;);
161 
<span class="line-modified">162     static bool put(JSCell*, JSGlobalObject*, PropertyName, JSValue, PutPropertySlot&amp;);</span>
163 
164     static void visitChildren(JSCell*, SlotVisitor&amp;);
165 
166 public:
167     TypedArrayMode mode() const { return m_mode; }
168     bool hasArrayBuffer() const { return JSC::hasArrayBuffer(mode()); }
169 
170     bool isShared();
171     JS_EXPORT_PRIVATE ArrayBuffer* unsharedBuffer();
<span class="line-modified">172     inline ArrayBuffer* possiblySharedBuffer();</span>
<span class="line-modified">173     JSArrayBuffer* unsharedJSBuffer(JSGlobalObject* globalObject);</span>
<span class="line-modified">174     JSArrayBuffer* possiblySharedJSBuffer(JSGlobalObject* globalObject);</span>
175     RefPtr&lt;ArrayBufferView&gt; unsharedImpl();
176     JS_EXPORT_PRIVATE RefPtr&lt;ArrayBufferView&gt; possiblySharedImpl();
177     bool isNeutered() { return hasArrayBuffer() &amp;&amp; !hasVector(); }
178     void neuter();
179 
180     bool hasVector() const { return !!m_vector; }
181     void* vector() const { return m_vector.getMayBeNull(length()); }
182 
<span class="line-modified">183     inline unsigned byteOffset();</span>
<span class="line-added">184     inline Optional&lt;unsigned&gt; byteOffsetConcurrently();</span>
<span class="line-added">185 </span>
186     unsigned length() const { return m_length; }
187 
188     DECLARE_EXPORT_INFO;
189 
190     static ptrdiff_t offsetOfVector() { return OBJECT_OFFSETOF(JSArrayBufferView, m_vector); }
191     static ptrdiff_t offsetOfLength() { return OBJECT_OFFSETOF(JSArrayBufferView, m_length); }
192     static ptrdiff_t offsetOfMode() { return OBJECT_OFFSETOF(JSArrayBufferView, m_mode); }
193 
194     static RefPtr&lt;ArrayBufferView&gt; toWrapped(VM&amp;, JSValue);
195 
196 private:
<span class="line-added">197     enum Requester { Mutator, ConcurrentThread };</span>
<span class="line-added">198     template&lt;Requester, typename ResultType&gt; ResultType byteOffsetImpl();</span>
<span class="line-added">199     template&lt;Requester&gt; ArrayBuffer* possiblySharedBufferImpl();</span>
<span class="line-added">200 </span>
201     JS_EXPORT_PRIVATE ArrayBuffer* slowDownAndWasteMemory();
202     static void finalize(JSCell*);
203 
204 protected:
205     friend class LLIntOffsetsExtractor;
206 
207     ArrayBuffer* existingBufferInButterfly();
208 
<span class="line-modified">209     static String toStringName(const JSObject*, JSGlobalObject*);</span>
210 
211     VectorPtr m_vector;
212     uint32_t m_length;
213     TypedArrayMode m_mode;
214 };
215 
216 } // namespace JSC
217 
218 namespace WTF {
219 
220 JS_EXPORT_PRIVATE void printInternal(PrintStream&amp;, JSC::TypedArrayMode);
221 
222 } // namespace WTF
</pre>
</td>
</tr>
</table>
<center><a href="JSArrayBufferView.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="JSArrayBufferViewInlines.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>