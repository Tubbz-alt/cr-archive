<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WebCore/Modules/encryptedmedia/legacy/WebKitMediaKeySession.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="WebKitMediaKeyNeededEvent.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="WebKitMediaKeySession.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/Modules/encryptedmedia/legacy/WebKitMediaKeySession.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 12  *
 13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. AND ITS CONTRIBUTORS ``AS IS&#39;&#39;
 14  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
 15  * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 16  * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL APPLE INC. OR ITS CONTRIBUTORS
 17  * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 18  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 19  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 20  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 21  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 22  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF
 23  * THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #include &quot;config.h&quot;
 27 #include &quot;WebKitMediaKeySession.h&quot;
 28 
 29 #if ENABLE(LEGACY_ENCRYPTED_MEDIA)
 30 
 31 #include &quot;Document.h&quot;

 32 #include &quot;EventNames.h&quot;
 33 #include &quot;Page.h&quot;
 34 #include &quot;SecurityOriginData.h&quot;
 35 #include &quot;Settings.h&quot;
 36 #include &quot;WebKitMediaKeyError.h&quot;
 37 #include &quot;WebKitMediaKeyMessageEvent.h&quot;
 38 #include &quot;WebKitMediaKeys.h&quot;
 39 #include &lt;wtf/FileSystem.h&gt;
 40 #include &lt;wtf/IsoMallocInlines.h&gt;
 41 
 42 namespace WebCore {
 43 
 44 WTF_MAKE_ISO_ALLOCATED_IMPL(WebKitMediaKeySession);
 45 
 46 Ref&lt;WebKitMediaKeySession&gt; WebKitMediaKeySession::create(ScriptExecutionContext&amp; context, WebKitMediaKeys&amp; keys, const String&amp; keySystem)
 47 {
 48     auto session = adoptRef(*new WebKitMediaKeySession(context, keys, keySystem));
 49     session-&gt;suspendIfNeeded();
 50     return session;
 51 }
 52 
 53 WebKitMediaKeySession::WebKitMediaKeySession(ScriptExecutionContext&amp; context, WebKitMediaKeys&amp; keys, const String&amp; keySystem)
 54     : ActiveDOMObject(&amp;context)
 55     , m_keys(&amp;keys)
 56     , m_keySystem(keySystem)
<span class="line-removed"> 57     , m_asyncEventQueue(*this)</span>
 58     , m_session(keys.cdm().createSession(*this))
 59     , m_keyRequestTimer(*this, &amp;WebKitMediaKeySession::keyRequestTimerFired)
 60     , m_addKeyTimer(*this, &amp;WebKitMediaKeySession::addKeyTimerFired)
 61 {
 62     if (m_session)
 63         m_sessionId = m_session-&gt;sessionId();
 64 }
 65 
 66 WebKitMediaKeySession::~WebKitMediaKeySession()
 67 {
 68     if (m_session)
 69         m_session-&gt;setClient(nullptr);
<span class="line-removed"> 70 </span>
<span class="line-removed"> 71     m_asyncEventQueue.cancelAllEvents();</span>
 72 }
 73 
 74 void WebKitMediaKeySession::close()
 75 {
 76     if (m_session) {
 77         m_session-&gt;releaseKeys();
 78         m_session = nullptr;
 79     }
 80 }
 81 
 82 RefPtr&lt;ArrayBuffer&gt; WebKitMediaKeySession::cachedKeyForKeyId(const String&amp; keyId) const
 83 {
 84     return m_session ? m_session-&gt;cachedKeyForKeyID(keyId) : nullptr;
 85 }
 86 
 87 void WebKitMediaKeySession::generateKeyRequest(const String&amp; mimeType, Ref&lt;Uint8Array&gt;&amp;&amp; initData)
 88 {
 89     m_pendingKeyRequests.append({ mimeType, WTFMove(initData) });
 90     m_keyRequestTimer.startOneShot(0_s);
 91 }
</pre>
<hr />
<pre>
166         // 2.2. Let &#39;did store key&#39; be false.
167         bool didStoreKey = false;
168         // 2.3. Let &#39;next message&#39; be null.
169         RefPtr&lt;Uint8Array&gt; nextMessage;
170         // 2.4. Use cdm to handle key.
171         didStoreKey = m_session-&gt;update(pendingKey.ptr(), nextMessage, errorCode, systemCode);
172         // 2.5. If did store key is true and the media element is waiting for a key, queue a task to attempt to resume playback.
173         // TODO: Find and restart the media element
174 
175         // 2.6. If next message is not null, queue a task to fire a simple event named keymessage at the MediaKeySession object.
176         //      The event is of type MediaKeyMessageEvent and has:
177         //      message = next message
178         //      destinationURL = null
179         if (nextMessage)
180             sendMessage(nextMessage.get(), emptyString());
181 
182         // 2.7. If did store key is true, queue a task to fire a simple event named keyadded at the MediaKeySession object.
183         if (didStoreKey) {
184             auto keyaddedEvent = Event::create(eventNames().webkitkeyaddedEvent, Event::CanBubble::No, Event::IsCancelable::No);
185             keyaddedEvent-&gt;setTarget(this);
<span class="line-modified">186             m_asyncEventQueue.enqueueEvent(WTFMove(keyaddedEvent));</span>
187 
188             ASSERT(m_keys);
189             m_keys-&gt;keyAdded();
190         }
191 
192         // 2.8. If any of the preceding steps in the task failed
193         if (errorCode) {
194             // 2.8.1. Create a new MediaKeyError object with the following attributes:
195             //        code = the appropriate MediaKeyError code
196             //        systemCode = a Key System-specific value, if provided, and 0 otherwise
197             // 2.8.2. Set the MediaKeySession object&#39;s error attribute to the error object created in the previous step.
198             // 2.8.3. queue a task to fire a simple event named keyerror at the MediaKeySession object.
199             sendError(errorCode, systemCode);
200             // 2.8.4. Abort the task.
201             // NOTE: no-op
202         }
203     }
204 }
205 
206 void WebKitMediaKeySession::sendMessage(Uint8Array* message, String destinationURL)
207 {
208     auto event = WebKitMediaKeyMessageEvent::create(eventNames().webkitkeymessageEvent, message, destinationURL);
209     event-&gt;setTarget(this);
<span class="line-modified">210     m_asyncEventQueue.enqueueEvent(WTFMove(event));</span>
211 }
212 
213 void WebKitMediaKeySession::sendError(MediaKeyErrorCode errorCode, uint32_t systemCode)
214 {
215     m_error = WebKitMediaKeyError::create(errorCode, systemCode);
216 
217     auto keyerrorEvent = Event::create(eventNames().webkitkeyerrorEvent, Event::CanBubble::No, Event::IsCancelable::No);
218     keyerrorEvent-&gt;setTarget(this);
<span class="line-modified">219     m_asyncEventQueue.enqueueEvent(WTFMove(keyerrorEvent));</span>
220 }
221 
222 String WebKitMediaKeySession::mediaKeysStorageDirectory() const
223 {
224     auto* document = downcast&lt;Document&gt;(scriptExecutionContext());
225     if (!document)
226         return emptyString();
227 
228     auto* page = document-&gt;page();
229     if (!page || page-&gt;usesEphemeralSession())
230         return emptyString();
231 
232     auto storageDirectory = document-&gt;settings().mediaKeysStorageDirectory();
233     if (storageDirectory.isEmpty())
234         return emptyString();
235 
236     return FileSystem::pathByAppendingComponent(storageDirectory, document-&gt;securityOrigin().data().databaseIdentifier());
237 }
238 
239 bool WebKitMediaKeySession::hasPendingActivity() const
240 {
<span class="line-modified">241     return (m_keys &amp;&amp; m_session) || m_asyncEventQueue.hasPendingEvents();</span>
<span class="line-removed">242 }</span>
<span class="line-removed">243 </span>
<span class="line-removed">244 void WebKitMediaKeySession::suspend(ReasonForSuspension)</span>
<span class="line-removed">245 {</span>
<span class="line-removed">246     ASSERT_NOT_REACHED();</span>
<span class="line-removed">247 }</span>
<span class="line-removed">248 </span>
<span class="line-removed">249 void WebKitMediaKeySession::resume()</span>
<span class="line-removed">250 {</span>
<span class="line-removed">251     ASSERT_NOT_REACHED();</span>
252 }
253 
254 void WebKitMediaKeySession::stop()
255 {
<span class="line-removed">256     m_asyncEventQueue.close();</span>
257     close();
258 }
259 
260 const char* WebKitMediaKeySession::activeDOMObjectName() const
261 {
262     return &quot;WebKitMediaKeySession&quot;;
263 }
264 
<span class="line-removed">265 bool WebKitMediaKeySession::canSuspendForDocumentSuspension() const</span>
<span class="line-removed">266 {</span>
<span class="line-removed">267     // FIXME: We should try and do better here.</span>
<span class="line-removed">268     return false;</span>
<span class="line-removed">269 }</span>
<span class="line-removed">270 </span>
271 }
272 
273 #endif
</pre>
</td>
<td>
<hr />
<pre>
 12  *
 13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. AND ITS CONTRIBUTORS ``AS IS&#39;&#39;
 14  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
 15  * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 16  * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL APPLE INC. OR ITS CONTRIBUTORS
 17  * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 18  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 19  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 20  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 21  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 22  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF
 23  * THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #include &quot;config.h&quot;
 27 #include &quot;WebKitMediaKeySession.h&quot;
 28 
 29 #if ENABLE(LEGACY_ENCRYPTED_MEDIA)
 30 
 31 #include &quot;Document.h&quot;
<span class="line-added"> 32 #include &quot;EventLoop.h&quot;</span>
 33 #include &quot;EventNames.h&quot;
 34 #include &quot;Page.h&quot;
 35 #include &quot;SecurityOriginData.h&quot;
 36 #include &quot;Settings.h&quot;
 37 #include &quot;WebKitMediaKeyError.h&quot;
 38 #include &quot;WebKitMediaKeyMessageEvent.h&quot;
 39 #include &quot;WebKitMediaKeys.h&quot;
 40 #include &lt;wtf/FileSystem.h&gt;
 41 #include &lt;wtf/IsoMallocInlines.h&gt;
 42 
 43 namespace WebCore {
 44 
 45 WTF_MAKE_ISO_ALLOCATED_IMPL(WebKitMediaKeySession);
 46 
 47 Ref&lt;WebKitMediaKeySession&gt; WebKitMediaKeySession::create(ScriptExecutionContext&amp; context, WebKitMediaKeys&amp; keys, const String&amp; keySystem)
 48 {
 49     auto session = adoptRef(*new WebKitMediaKeySession(context, keys, keySystem));
 50     session-&gt;suspendIfNeeded();
 51     return session;
 52 }
 53 
 54 WebKitMediaKeySession::WebKitMediaKeySession(ScriptExecutionContext&amp; context, WebKitMediaKeys&amp; keys, const String&amp; keySystem)
 55     : ActiveDOMObject(&amp;context)
 56     , m_keys(&amp;keys)
 57     , m_keySystem(keySystem)

 58     , m_session(keys.cdm().createSession(*this))
 59     , m_keyRequestTimer(*this, &amp;WebKitMediaKeySession::keyRequestTimerFired)
 60     , m_addKeyTimer(*this, &amp;WebKitMediaKeySession::addKeyTimerFired)
 61 {
 62     if (m_session)
 63         m_sessionId = m_session-&gt;sessionId();
 64 }
 65 
 66 WebKitMediaKeySession::~WebKitMediaKeySession()
 67 {
 68     if (m_session)
 69         m_session-&gt;setClient(nullptr);


 70 }
 71 
 72 void WebKitMediaKeySession::close()
 73 {
 74     if (m_session) {
 75         m_session-&gt;releaseKeys();
 76         m_session = nullptr;
 77     }
 78 }
 79 
 80 RefPtr&lt;ArrayBuffer&gt; WebKitMediaKeySession::cachedKeyForKeyId(const String&amp; keyId) const
 81 {
 82     return m_session ? m_session-&gt;cachedKeyForKeyID(keyId) : nullptr;
 83 }
 84 
 85 void WebKitMediaKeySession::generateKeyRequest(const String&amp; mimeType, Ref&lt;Uint8Array&gt;&amp;&amp; initData)
 86 {
 87     m_pendingKeyRequests.append({ mimeType, WTFMove(initData) });
 88     m_keyRequestTimer.startOneShot(0_s);
 89 }
</pre>
<hr />
<pre>
164         // 2.2. Let &#39;did store key&#39; be false.
165         bool didStoreKey = false;
166         // 2.3. Let &#39;next message&#39; be null.
167         RefPtr&lt;Uint8Array&gt; nextMessage;
168         // 2.4. Use cdm to handle key.
169         didStoreKey = m_session-&gt;update(pendingKey.ptr(), nextMessage, errorCode, systemCode);
170         // 2.5. If did store key is true and the media element is waiting for a key, queue a task to attempt to resume playback.
171         // TODO: Find and restart the media element
172 
173         // 2.6. If next message is not null, queue a task to fire a simple event named keymessage at the MediaKeySession object.
174         //      The event is of type MediaKeyMessageEvent and has:
175         //      message = next message
176         //      destinationURL = null
177         if (nextMessage)
178             sendMessage(nextMessage.get(), emptyString());
179 
180         // 2.7. If did store key is true, queue a task to fire a simple event named keyadded at the MediaKeySession object.
181         if (didStoreKey) {
182             auto keyaddedEvent = Event::create(eventNames().webkitkeyaddedEvent, Event::CanBubble::No, Event::IsCancelable::No);
183             keyaddedEvent-&gt;setTarget(this);
<span class="line-modified">184             queueTaskToDispatchEvent(*this, TaskSource::Networking, WTFMove(keyaddedEvent));</span>
185 
186             ASSERT(m_keys);
187             m_keys-&gt;keyAdded();
188         }
189 
190         // 2.8. If any of the preceding steps in the task failed
191         if (errorCode) {
192             // 2.8.1. Create a new MediaKeyError object with the following attributes:
193             //        code = the appropriate MediaKeyError code
194             //        systemCode = a Key System-specific value, if provided, and 0 otherwise
195             // 2.8.2. Set the MediaKeySession object&#39;s error attribute to the error object created in the previous step.
196             // 2.8.3. queue a task to fire a simple event named keyerror at the MediaKeySession object.
197             sendError(errorCode, systemCode);
198             // 2.8.4. Abort the task.
199             // NOTE: no-op
200         }
201     }
202 }
203 
204 void WebKitMediaKeySession::sendMessage(Uint8Array* message, String destinationURL)
205 {
206     auto event = WebKitMediaKeyMessageEvent::create(eventNames().webkitkeymessageEvent, message, destinationURL);
207     event-&gt;setTarget(this);
<span class="line-modified">208     queueTaskToDispatchEvent(*this, TaskSource::Networking, WTFMove(event));</span>
209 }
210 
211 void WebKitMediaKeySession::sendError(MediaKeyErrorCode errorCode, uint32_t systemCode)
212 {
213     m_error = WebKitMediaKeyError::create(errorCode, systemCode);
214 
215     auto keyerrorEvent = Event::create(eventNames().webkitkeyerrorEvent, Event::CanBubble::No, Event::IsCancelable::No);
216     keyerrorEvent-&gt;setTarget(this);
<span class="line-modified">217     queueTaskToDispatchEvent(*this, TaskSource::Networking, WTFMove(keyerrorEvent));</span>
218 }
219 
220 String WebKitMediaKeySession::mediaKeysStorageDirectory() const
221 {
222     auto* document = downcast&lt;Document&gt;(scriptExecutionContext());
223     if (!document)
224         return emptyString();
225 
226     auto* page = document-&gt;page();
227     if (!page || page-&gt;usesEphemeralSession())
228         return emptyString();
229 
230     auto storageDirectory = document-&gt;settings().mediaKeysStorageDirectory();
231     if (storageDirectory.isEmpty())
232         return emptyString();
233 
234     return FileSystem::pathByAppendingComponent(storageDirectory, document-&gt;securityOrigin().data().databaseIdentifier());
235 }
236 
237 bool WebKitMediaKeySession::hasPendingActivity() const
238 {
<span class="line-modified">239     return (m_keys &amp;&amp; m_session) || ActiveDOMObject::hasPendingActivity();</span>










240 }
241 
242 void WebKitMediaKeySession::stop()
243 {

244     close();
245 }
246 
247 const char* WebKitMediaKeySession::activeDOMObjectName() const
248 {
249     return &quot;WebKitMediaKeySession&quot;;
250 }
251 






252 }
253 
254 #endif
</pre>
</td>
</tr>
</table>
<center><a href="WebKitMediaKeyNeededEvent.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="WebKitMediaKeySession.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>