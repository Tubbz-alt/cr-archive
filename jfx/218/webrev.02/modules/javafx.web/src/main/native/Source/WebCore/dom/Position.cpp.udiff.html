<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WebCore/dom/Position.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="PopStateEvent.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="Position.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/dom/Position.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -35,21 +35,21 @@</span>
  #include &quot;HTMLParserIdioms.h&quot;
  #include &quot;HTMLTableElement.h&quot;
  #include &quot;InlineElementBox.h&quot;
  #include &quot;InlineIterator.h&quot;
  #include &quot;InlineTextBox.h&quot;
<span class="udiff-line-added">+ #include &quot;LineLayoutTraversal.h&quot;</span>
  #include &quot;Logging.h&quot;
  #include &quot;NodeTraversal.h&quot;
  #include &quot;PositionIterator.h&quot;
  #include &quot;RenderBlock.h&quot;
  #include &quot;RenderFlexibleBox.h&quot;
  #include &quot;RenderGrid.h&quot;
  #include &quot;RenderInline.h&quot;
  #include &quot;RenderIterator.h&quot;
  #include &quot;RenderLineBreak.h&quot;
  #include &quot;RenderText.h&quot;
<span class="udiff-line-removed">- #include &quot;RuntimeEnabledFeatures.h&quot;</span>
  #include &quot;Text.h&quot;
  #include &quot;TextIterator.h&quot;
  #include &quot;VisiblePosition.h&quot;
  #include &quot;VisibleUnits.h&quot;
  #include &lt;stdio.h&gt;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -654,17 +654,10 @@</span>
          return true;
  
      return pos.atStartOfNode();
  }
  
<span class="udiff-line-removed">- static void ensureLineBoxesIfNeeded(RenderObject&amp; renderer)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-     if (!is&lt;RenderText&gt;(renderer) &amp;&amp; !is&lt;RenderLineBreak&gt;(renderer))</span>
<span class="udiff-line-removed">-         return;</span>
<span class="udiff-line-removed">-     is&lt;RenderText&gt;(renderer) ? downcast&lt;RenderText&gt;(renderer).ensureLineBoxes() : downcast&lt;RenderLineBreak&gt;(renderer).ensureLineBoxes();</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
  // This function and downstream() are used for moving back and forth between visually equivalent candidates.
  // For example, for the text node &quot;foo     bar&quot; where whitespace is collapsible, there are two candidates
  // that map to the VisiblePosition between &#39;b&#39; and the space.  This function will return the left candidate
  // and downstream() will return the right one.
  // Also, upstream() will return [boundary, 0] for any of the positions from [boundary, 0] to the first candidate
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -706,11 +699,11 @@</span>
  
          // skip position in unrendered or invisible node
          RenderObject* renderer = currentNode.renderer();
          if (!renderer || renderer-&gt;style().visibility() != Visibility::Visible)
              continue;
<span class="udiff-line-modified-removed">-         ensureLineBoxesIfNeeded(*renderer);</span>
<span class="udiff-line-modified-added">+ </span>
          if (rule == CanCrossEditingBoundary &amp;&amp; boundaryCrossed) {
              lastVisible = currentPosition;
              break;
          }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -731,56 +724,33 @@</span>
          }
  
          // return current position if it is in rendered text
          if (is&lt;RenderText&gt;(*renderer)) {
              auto&amp; textRenderer = downcast&lt;RenderText&gt;(*renderer);
<span class="udiff-line-modified-removed">-             if (!textRenderer.firstTextBox())</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-added">+             auto firstTextBox = LineLayoutTraversal::firstTextBoxInTextOrderFor(textRenderer);</span>
<span class="udiff-line-added">+             if (!firstTextBox)</span>
                  continue;
<span class="udiff-line-added">+ </span>
              if (&amp;currentNode != startNode) {
                  // This assertion fires in layout tests in the case-transform.html test because
                  // of a mix-up between offsets in the text in the DOM tree with text in the
                  // render tree which can have a different length due to case transformation.
                  // Until we resolve that, disable this so we can run the layout tests!
                  //ASSERT(currentOffset &gt;= renderer-&gt;caretMaxOffset());
                  return createLegacyEditingPosition(&amp;currentNode, renderer-&gt;caretMaxOffset());
              }
  
              unsigned textOffset = currentPosition.offsetInLeafNode();
<span class="udiff-line-modified-removed">-             auto lastTextBox = textRenderer.lastTextBox();</span>
<span class="udiff-line-modified-removed">-             for (auto* box = textRenderer.firstTextBox(); box; box = box-&gt;nextTextBox()) {</span>
<span class="udiff-line-modified-removed">-                 if (textOffset &lt;= box-&gt;start() + box-&gt;len()) {</span>
<span class="udiff-line-removed">-                     if (textOffset &gt; box-&gt;start())</span>
<span class="udiff-line-modified-added">+             for (auto box = firstTextBox; box; box.traverseNextInTextOrder()) {</span>
<span class="udiff-line-modified-added">+                 if (textOffset &lt;= box-&gt;localEndOffset()) {</span>
<span class="udiff-line-modified-added">+                     if (textOffset &gt; box-&gt;localStartOffset())</span>
                          return currentPosition;
                      continue;
                  }
  
<span class="udiff-line-modified-removed">-                 if (box == lastTextBox || textOffset != box-&gt;start() + box-&gt;len() + 1)</span>
<span class="udiff-line-removed">-                     continue;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-                 // The text continues on the next line only if the last text box is not on this line and</span>
<span class="udiff-line-removed">-                 // none of the boxes on this line have a larger start offset.</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-                 bool continuesOnNextLine = true;</span>
<span class="udiff-line-removed">-                 InlineBox* otherBox = box;</span>
<span class="udiff-line-removed">-                 while (continuesOnNextLine) {</span>
<span class="udiff-line-removed">-                     otherBox = otherBox-&gt;nextLeafChild();</span>
<span class="udiff-line-removed">-                     if (!otherBox)</span>
<span class="udiff-line-removed">-                         break;</span>
<span class="udiff-line-removed">-                     if (otherBox == lastTextBox || (&amp;otherBox-&gt;renderer() == &amp;textRenderer &amp;&amp; downcast&lt;InlineTextBox&gt;(*otherBox).start() &gt; textOffset))</span>
<span class="udiff-line-removed">-                         continuesOnNextLine = false;</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-                 otherBox = box;</span>
<span class="udiff-line-removed">-                 while (continuesOnNextLine) {</span>
<span class="udiff-line-removed">-                     otherBox = otherBox-&gt;prevLeafChild();</span>
<span class="udiff-line-removed">-                     if (!otherBox)</span>
<span class="udiff-line-removed">-                         break;</span>
<span class="udiff-line-removed">-                     if (otherBox == lastTextBox || (&amp;otherBox-&gt;renderer() == &amp;textRenderer &amp;&amp; downcast&lt;InlineTextBox&gt;(*otherBox).start() &gt; textOffset))</span>
<span class="udiff-line-removed">-                         continuesOnNextLine = false;</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-                 if (continuesOnNextLine)</span>
<span class="udiff-line-modified-added">+                 if (textOffset == box-&gt;localEndOffset() + 1 &amp;&amp; box-&gt;isLastOnLine() &amp;&amp; !box-&gt;isLast())</span>
                      return currentPosition;
              }
          }
      }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -841,11 +811,11 @@</span>
  
          // skip position in unrendered or invisible node
          auto* renderer = currentNode.renderer();
          if (!renderer || renderer-&gt;style().visibility() != Visibility::Visible)
              continue;
<span class="udiff-line-modified-removed">-         ensureLineBoxesIfNeeded(*renderer);</span>
<span class="udiff-line-modified-added">+ </span>
          if (rule == CanCrossEditingBoundary &amp;&amp; boundaryCrossed) {
              lastVisible = currentPosition;
              break;
          }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -861,52 +831,32 @@</span>
          }
  
          // return current position if it is in rendered text
          if (is&lt;RenderText&gt;(*renderer)) {
              auto&amp; textRenderer = downcast&lt;RenderText&gt;(*renderer);
<span class="udiff-line-modified-removed">-             if (!textRenderer.firstTextBox())</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-added">+             auto firstTextBox = LineLayoutTraversal::firstTextBoxInTextOrderFor(textRenderer);</span>
<span class="udiff-line-added">+             if (!firstTextBox)</span>
                  continue;
<span class="udiff-line-added">+ </span>
              if (&amp;currentNode != startNode) {
                  ASSERT(currentPosition.atStartOfNode());
<span class="udiff-line-modified-removed">-                 return createLegacyEditingPosition(&amp;currentNode, renderer-&gt;caretMinOffset());</span>
<span class="udiff-line-modified-added">+                 return createLegacyEditingPosition(&amp;currentNode, textRenderer.caretMinOffset());</span>
              }
  
              unsigned textOffset = currentPosition.offsetInLeafNode();
<span class="udiff-line-modified-removed">-             auto lastTextBox = textRenderer.lastTextBox();</span>
<span class="udiff-line-modified-removed">-             for (auto* box = textRenderer.firstTextBox(); box; box = box-&gt;nextTextBox()) {</span>
<span class="udiff-line-modified-removed">-                 if (textOffset &lt;= box-&gt;end()) {</span>
<span class="udiff-line-removed">-                     if (textOffset &gt;= box-&gt;start())</span>
<span class="udiff-line-removed">-                         return currentPosition;</span>
<span class="udiff-line-removed">-                     continue;</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-modified-added">+             for (auto box = firstTextBox; box; box.traverseNextInTextOrder()) {</span>
<span class="udiff-line-modified-added">+                 if (!box-&gt;length() &amp;&amp; textOffset == box-&gt;localStartOffset())</span>
<span class="udiff-line-modified-added">+                     return currentPosition;</span>
  
<span class="udiff-line-modified-removed">-                 if (box == lastTextBox || textOffset != box-&gt;start() + box-&gt;len())</span>
<span class="udiff-line-modified-added">+                 if (textOffset &lt; box-&gt;localEndOffset()) {</span>
<span class="udiff-line-added">+                     if (textOffset &gt;= box-&gt;localStartOffset())</span>
<span class="udiff-line-added">+                         return currentPosition;</span>
                      continue;
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-                 // The text continues on the next line only if the last text box is not on this line and</span>
<span class="udiff-line-removed">-                 // none of the boxes on this line have a larger start offset.</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-                 bool continuesOnNextLine = true;</span>
<span class="udiff-line-removed">-                 InlineBox* otherBox = box;</span>
<span class="udiff-line-removed">-                 while (continuesOnNextLine) {</span>
<span class="udiff-line-removed">-                     otherBox = otherBox-&gt;nextLeafChild();</span>
<span class="udiff-line-removed">-                     if (!otherBox)</span>
<span class="udiff-line-removed">-                         break;</span>
<span class="udiff-line-removed">-                     if (otherBox == lastTextBox || (&amp;otherBox-&gt;renderer() == &amp;textRenderer &amp;&amp; downcast&lt;InlineTextBox&gt;(*otherBox).start() &gt;= textOffset))</span>
<span class="udiff-line-removed">-                         continuesOnNextLine = false;</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-                 otherBox = box;</span>
<span class="udiff-line-removed">-                 while (continuesOnNextLine) {</span>
<span class="udiff-line-removed">-                     otherBox = otherBox-&gt;prevLeafChild();</span>
<span class="udiff-line-removed">-                     if (!otherBox)</span>
<span class="udiff-line-removed">-                         break;</span>
<span class="udiff-line-removed">-                     if (otherBox == lastTextBox || (&amp;otherBox-&gt;renderer() == &amp;textRenderer &amp;&amp; downcast&lt;InlineTextBox&gt;(*otherBox).start() &gt;= textOffset))</span>
<span class="udiff-line-removed">-                         continuesOnNextLine = false;</span>
                  }
  
<span class="udiff-line-modified-removed">-                 if (continuesOnNextLine)</span>
<span class="udiff-line-modified-added">+                 if (textOffset == box-&gt;localEndOffset() &amp;&amp; box-&gt;isLastOnLine() &amp;&amp; !box-&gt;isLast())</span>
                      return currentPosition;
              }
          }
      }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1278,11 +1228,11 @@</span>
                  return;
              }
  
              if (((caretOffset == caretMaxOffset) ^ (affinity == DOWNSTREAM))
                  || ((caretOffset == caretMinOffset) ^ (affinity == UPSTREAM))
<span class="udiff-line-modified-removed">-                 || (caretOffset == caretMaxOffset &amp;&amp; box-&gt;nextLeafChild() &amp;&amp; box-&gt;nextLeafChild()-&gt;isLineBreak()))</span>
<span class="udiff-line-modified-added">+                 || (caretOffset == caretMaxOffset &amp;&amp; box-&gt;nextLeafOnLine() &amp;&amp; box-&gt;nextLeafOnLine()-&gt;isLineBreak()))</span>
                  break;
  
              candidate = box;
          }
          if (candidate &amp;&amp; candidate == textRenderer.lastTextBox() &amp;&amp; affinity == DOWNSTREAM) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1319,86 +1269,86 @@</span>
  
      unsigned char level = inlineBox-&gt;bidiLevel();
  
      if (inlineBox-&gt;direction() == primaryDirection) {
          if (caretOffset == inlineBox-&gt;caretRightmostOffset()) {
<span class="udiff-line-modified-removed">-             InlineBox* nextBox = inlineBox-&gt;nextLeafChild();</span>
<span class="udiff-line-modified-added">+             InlineBox* nextBox = inlineBox-&gt;nextLeafOnLine();</span>
              if (!nextBox || nextBox-&gt;bidiLevel() &gt;= level)
                  return;
  
              level = nextBox-&gt;bidiLevel();
              InlineBox* prevBox = inlineBox;
              do {
<span class="udiff-line-modified-removed">-                 prevBox = prevBox-&gt;prevLeafChild();</span>
<span class="udiff-line-modified-added">+                 prevBox = prevBox-&gt;previousLeafOnLine();</span>
              } while (prevBox &amp;&amp; prevBox-&gt;bidiLevel() &gt; level);
  
              if (prevBox &amp;&amp; prevBox-&gt;bidiLevel() == level)   // For example, abc FED 123 ^ CBA
                  return;
  
              // For example, abc 123 ^ CBA
<span class="udiff-line-modified-removed">-             while (InlineBox* nextBox = inlineBox-&gt;nextLeafChild()) {</span>
<span class="udiff-line-modified-added">+             while (InlineBox* nextBox = inlineBox-&gt;nextLeafOnLine()) {</span>
                  if (nextBox-&gt;bidiLevel() &lt; level)
                      break;
                  inlineBox = nextBox;
              }
              caretOffset = inlineBox-&gt;caretRightmostOffset();
          } else {
<span class="udiff-line-modified-removed">-             InlineBox* prevBox = inlineBox-&gt;prevLeafChild();</span>
<span class="udiff-line-modified-added">+             InlineBox* prevBox = inlineBox-&gt;previousLeafOnLine();</span>
              if (!prevBox || prevBox-&gt;bidiLevel() &gt;= level)
                  return;
  
              level = prevBox-&gt;bidiLevel();
              InlineBox* nextBox = inlineBox;
              do {
<span class="udiff-line-modified-removed">-                 nextBox = nextBox-&gt;nextLeafChild();</span>
<span class="udiff-line-modified-added">+                 nextBox = nextBox-&gt;nextLeafOnLine();</span>
              } while (nextBox &amp;&amp; nextBox-&gt;bidiLevel() &gt; level);
  
              if (nextBox &amp;&amp; nextBox-&gt;bidiLevel() == level)
                  return;
  
<span class="udiff-line-modified-removed">-             while (InlineBox* prevBox = inlineBox-&gt;prevLeafChild()) {</span>
<span class="udiff-line-modified-added">+             while (InlineBox* prevBox = inlineBox-&gt;previousLeafOnLine()) {</span>
                  if (prevBox-&gt;bidiLevel() &lt; level)
                      break;
                  inlineBox = prevBox;
              }
              caretOffset = inlineBox-&gt;caretLeftmostOffset();
          }
          return;
      }
  
      if (caretOffset == inlineBox-&gt;caretLeftmostOffset()) {
<span class="udiff-line-modified-removed">-         InlineBox* prevBox = inlineBox-&gt;prevLeafChildIgnoringLineBreak();</span>
<span class="udiff-line-modified-added">+         InlineBox* prevBox = inlineBox-&gt;previousLeafOnLineIgnoringLineBreak();</span>
          if (!prevBox || prevBox-&gt;bidiLevel() &lt; level) {
              // Left edge of a secondary run. Set to the right edge of the entire run.
<span class="udiff-line-modified-removed">-             while (InlineBox* nextBox = inlineBox-&gt;nextLeafChildIgnoringLineBreak()) {</span>
<span class="udiff-line-modified-added">+             while (InlineBox* nextBox = inlineBox-&gt;nextLeafOnLineIgnoringLineBreak()) {</span>
                  if (nextBox-&gt;bidiLevel() &lt; level)
                      break;
                  inlineBox = nextBox;
              }
              caretOffset = inlineBox-&gt;caretRightmostOffset();
          } else if (prevBox-&gt;bidiLevel() &gt; level) {
              // Right edge of a &quot;tertiary&quot; run. Set to the left edge of that run.
<span class="udiff-line-modified-removed">-             while (InlineBox* tertiaryBox = inlineBox-&gt;prevLeafChildIgnoringLineBreak()) {</span>
<span class="udiff-line-modified-added">+             while (InlineBox* tertiaryBox = inlineBox-&gt;previousLeafOnLineIgnoringLineBreak()) {</span>
                  if (tertiaryBox-&gt;bidiLevel() &lt;= level)
                      break;
                  inlineBox = tertiaryBox;
              }
              caretOffset = inlineBox-&gt;caretLeftmostOffset();
          }
      } else {
<span class="udiff-line-modified-removed">-         InlineBox* nextBox = inlineBox-&gt;nextLeafChildIgnoringLineBreak();</span>
<span class="udiff-line-modified-added">+         InlineBox* nextBox = inlineBox-&gt;nextLeafOnLineIgnoringLineBreak();</span>
          if (!nextBox || nextBox-&gt;bidiLevel() &lt; level) {
              // Right edge of a secondary run. Set to the left edge of the entire run.
<span class="udiff-line-modified-removed">-             while (InlineBox* prevBox = inlineBox-&gt;prevLeafChildIgnoringLineBreak()) {</span>
<span class="udiff-line-modified-added">+             while (InlineBox* prevBox = inlineBox-&gt;previousLeafOnLineIgnoringLineBreak()) {</span>
                  if (prevBox-&gt;bidiLevel() &lt; level)
                      break;
                  inlineBox = prevBox;
              }
              caretOffset = inlineBox-&gt;caretLeftmostOffset();
          } else if (nextBox-&gt;bidiLevel() &gt; level) {
              // Left edge of a &quot;tertiary&quot; run. Set to the right edge of that run.
<span class="udiff-line-modified-removed">-             while (InlineBox* tertiaryBox = inlineBox-&gt;nextLeafChildIgnoringLineBreak()) {</span>
<span class="udiff-line-modified-added">+             while (InlineBox* tertiaryBox = inlineBox-&gt;nextLeafOnLineIgnoringLineBreak()) {</span>
                  if (tertiaryBox-&gt;bidiLevel() &lt;= level)
                      break;
                  inlineBox = tertiaryBox;
              }
              caretOffset = inlineBox-&gt;caretRightmostOffset();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1617,10 +1567,32 @@</span>
      auto* nodeB = commonScope-&gt;ancestorNodeInThisScope(b.containerNode());
      ASSERT(nodeB);
      return Range::commonAncestorContainer(nodeA, nodeB);
  }
  
<span class="udiff-line-added">+ Position positionInParentBeforeNode(Node* node)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     auto* ancestor = node-&gt;parentNode();</span>
<span class="udiff-line-added">+     while (ancestor &amp;&amp; editingIgnoresContent(*ancestor)) {</span>
<span class="udiff-line-added">+         node = ancestor;</span>
<span class="udiff-line-added">+         ancestor = ancestor-&gt;parentNode();</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+     ASSERT(ancestor);</span>
<span class="udiff-line-added">+     return Position(ancestor, node-&gt;computeNodeIndex(), Position::PositionIsOffsetInAnchor);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ Position positionInParentAfterNode(Node* node)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     auto* ancestor = node-&gt;parentNode();</span>
<span class="udiff-line-added">+     while (ancestor &amp;&amp; editingIgnoresContent(*ancestor)) {</span>
<span class="udiff-line-added">+         node = ancestor;</span>
<span class="udiff-line-added">+         ancestor = ancestor-&gt;parentNode();</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+     ASSERT(ancestor);</span>
<span class="udiff-line-added">+     return Position(ancestor, node-&gt;computeNodeIndex() + 1, Position::PositionIsOffsetInAnchor);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  } // namespace WebCore
  
  #if ENABLE(TREE_DEBUGGING)
  
  void showTree(const WebCore::Position&amp; pos)
</pre>
<center><a href="PopStateEvent.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="Position.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>