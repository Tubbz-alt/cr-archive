<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/WebCore/Modules/geolocation/Geolocation.h</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (C) 2008, 2009, 2010, 2011 Apple Inc. All Rights Reserved.
  3  * Copyright 2010, The Android Open Source Project
  4  *
  5  * Redistribution and use in source and binary forms, with or without
  6  * modification, are permitted provided that the following conditions
  7  * are met:
  8  * 1. Redistributions of source code must retain the above copyright
  9  *    notice, this list of conditions and the following disclaimer.
 10  * 2. Redistributions in binary form must reproduce the above copyright
 11  *    notice, this list of conditions and the following disclaimer in the
 12  *    documentation and/or other materials provided with the distribution.
 13  *
 14  * THIS SOFTWARE IS PROVIDED BY APPLE INC. ``AS IS&#39;&#39; AND ANY
 15  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 16  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 17  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE INC. OR
 18  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 19  * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 20  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 21  * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 22  * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 23  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 24  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 25  */
 26 
 27 #pragma once
 28 
 29 #if ENABLE(GEOLOCATION)
 30 
 31 #include &quot;ActiveDOMObject.h&quot;
 32 #include &quot;Document.h&quot;
 33 #include &quot;GeolocationPosition.h&quot;
 34 #include &quot;GeolocationPositionError.h&quot;
 35 #include &quot;PositionCallback.h&quot;
 36 #include &quot;PositionErrorCallback.h&quot;
 37 #include &quot;PositionOptions.h&quot;
 38 #include &quot;ScriptWrappable.h&quot;
 39 #include &quot;Timer.h&quot;
 40 #include &lt;wtf/HashMap.h&gt;
 41 #include &lt;wtf/HashSet.h&gt;
 42 
 43 namespace WebCore {
 44 
 45 class Frame;
 46 class GeoNotifier;
 47 class GeolocationError;
 48 class Navigator;
 49 class Page;
 50 class ScriptExecutionContext;
 51 class SecurityOrigin;
 52 struct PositionOptions;
 53 
 54 class Geolocation final : public ScriptWrappable, public RefCounted&lt;Geolocation&gt;, public ActiveDOMObject {
<a name="1" id="anc1"></a><span class="line-modified"> 55     WTF_MAKE_ISO_ALLOCATED_EXPORT(Geolocation, WEBCORE_EXPORT);</span>
 56     friend class GeoNotifier;
 57 public:
 58     static Ref&lt;Geolocation&gt; create(Navigator&amp;);
 59     WEBCORE_EXPORT ~Geolocation();
 60 
 61     WEBCORE_EXPORT void resetAllGeolocationPermission();
 62     Document* document() const { return downcast&lt;Document&gt;(scriptExecutionContext()); }
 63 
 64     void getCurrentPosition(Ref&lt;PositionCallback&gt;&amp;&amp;, RefPtr&lt;PositionErrorCallback&gt;&amp;&amp;, PositionOptions&amp;&amp;);
 65     int watchPosition(Ref&lt;PositionCallback&gt;&amp;&amp;, RefPtr&lt;PositionErrorCallback&gt;&amp;&amp;, PositionOptions&amp;&amp;);
 66     void clearWatch(int watchID);
 67 
<a name="2" id="anc2"></a><span class="line-modified"> 68     WEBCORE_EXPORT void setIsAllowed(bool, const String&amp; authorizationToken);</span>
<span class="line-modified"> 69     const String&amp; authorizationToken() const { return m_authorizationToken; }</span>
<span class="line-added"> 70     WEBCORE_EXPORT void resetIsAllowed();</span>
 71     bool isAllowed() const { return m_allowGeolocation == Yes; }
 72 
 73     void positionChanged();
 74     void setError(GeolocationError&amp;);
 75     bool shouldBlockGeolocationRequests();
 76 
 77     Navigator* navigator();
 78     WEBCORE_EXPORT Frame* frame() const;
 79 
 80 private:
 81     explicit Geolocation(Navigator&amp;);
 82 
 83     GeolocationPosition* lastPosition();
 84 
 85     // ActiveDOMObject
 86     void stop() override;
<a name="3" id="anc3"></a>
 87     void suspend(ReasonForSuspension) override;
 88     void resume() override;
 89     const char* activeDOMObjectName() const override;
 90 
 91     bool isDenied() const { return m_allowGeolocation == No; }
 92 
 93     Page* page() const;
 94     SecurityOrigin* securityOrigin() const;
 95 
 96     typedef Vector&lt;RefPtr&lt;GeoNotifier&gt;&gt; GeoNotifierVector;
 97     typedef HashSet&lt;RefPtr&lt;GeoNotifier&gt;&gt; GeoNotifierSet;
 98 
 99     class Watchers {
100     public:
101         bool add(int id, RefPtr&lt;GeoNotifier&gt;&amp;&amp;);
102         GeoNotifier* find(int id);
103         void remove(int id);
104         void remove(GeoNotifier*);
105         bool contains(GeoNotifier*) const;
106         void clear();
107         bool isEmpty() const;
108         void getNotifiersVector(GeoNotifierVector&amp;) const;
109     private:
110         typedef HashMap&lt;int, RefPtr&lt;GeoNotifier&gt;&gt; IdToNotifierMap;
111         typedef HashMap&lt;RefPtr&lt;GeoNotifier&gt;, int&gt; NotifierToIdMap;
112         IdToNotifierMap m_idToNotifierMap;
113         NotifierToIdMap m_notifierToIdMap;
114     };
115 
116     bool hasListeners() const { return !m_oneShots.isEmpty() || !m_watchers.isEmpty(); }
117 
118     void sendError(GeoNotifierVector&amp;, GeolocationPositionError&amp;);
119     void sendPosition(GeoNotifierVector&amp;, GeolocationPosition&amp;);
120 
121     static void extractNotifiersWithCachedPosition(GeoNotifierVector&amp; notifiers, GeoNotifierVector* cached);
122     static void copyToSet(const GeoNotifierVector&amp;, GeoNotifierSet&amp;);
123 
124     static void stopTimer(GeoNotifierVector&amp;);
125     void stopTimersForOneShots();
126     void stopTimersForWatchers();
127     void stopTimers();
128 
129     void cancelRequests(GeoNotifierVector&amp;);
130     void cancelAllRequests();
131 
132     void makeSuccessCallbacks(GeolocationPosition&amp;);
133     void handleError(GeolocationPositionError&amp;);
134 
135     void requestPermission();
<a name="4" id="anc4"></a><span class="line-added">136     void revokeAuthorizationTokenIfNecessary();</span>
137 
138     bool startUpdating(GeoNotifier*);
139     void stopUpdating();
140 
141     void handlePendingPermissionNotifiers();
142 
143     void startRequest(GeoNotifier*);
144 
145     void fatalErrorOccurred(GeoNotifier*);
146     void requestTimedOut(GeoNotifier*);
147     void requestUsesCachedPosition(GeoNotifier*);
148     bool haveSuitableCachedPosition(const PositionOptions&amp;);
149     void makeCachedPositionCallbacks();
150 
151     void resumeTimerFired();
152 
153     WeakPtr&lt;Navigator&gt; m_navigator;
154     GeoNotifierSet m_oneShots;
155     Watchers m_watchers;
156     GeoNotifierSet m_pendingForPermissionNotifiers;
157     RefPtr&lt;GeolocationPosition&gt; m_lastPosition;
158 
159     enum { Unknown, InProgress, Yes, No } m_allowGeolocation { Unknown };
<a name="5" id="anc5"></a><span class="line-added">160     String m_authorizationToken;</span>
161     bool m_isSuspended { false };
162     bool m_resetOnResume { false };
163     bool m_hasChangedPosition { false };
164     RefPtr&lt;GeolocationPositionError&gt; m_errorWaitingForResume;
165     Timer m_resumeTimer;
166     GeoNotifierSet m_requestsAwaitingCachedPosition;
167 };
168 
169 } // namespace WebCore
170 
171 #endif // ENABLE(GEOLOCATION)
<a name="6" id="anc6"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="6" type="hidden" />
</body>
</html>