<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.web/src/main/native/Source/WebCore/Modules/mediastream/libwebrtc/LibWebRTCStatsCollector.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="LibWebRTCRtpTransceiverBackend.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="LibWebRTCStatsCollector.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/Modules/mediastream/libwebrtc/LibWebRTCStatsCollector.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 25,10 ***</span>
<span class="line-new-header">--- 25,11 ---</span>
  #include &quot;config.h&quot;
  #include &quot;LibWebRTCStatsCollector.h&quot;
  
  #if USE(LIBWEBRTC)
  
<span class="line-added">+ #include &quot;JSDOMMapLike.h&quot;</span>
  #include &quot;JSRTCStatsReport.h&quot;
  #include &quot;Performance.h&quot;
  #include &lt;wtf/MainThread.h&gt;
  
  namespace WebCore {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 42,11 ***</span>
  {
      if (!m_callback)
          return;
  
      callOnMainThread([callback = WTFMove(m_callback)]() mutable {
<span class="line-modified">!         callback();</span>
      });
  }
  
  static inline String fromStdString(const std::string&amp; value)
  {
<span class="line-new-header">--- 43,11 ---</span>
  {
      if (!m_callback)
          return;
  
      callOnMainThread([callback = WTFMove(m_callback)]() mutable {
<span class="line-modified">!         callback(nullptr);</span>
      });
  }
  
  static inline String fromStdString(const std::string&amp; value)
  {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 92,20 ***</span>
  
  static inline void fillInboundRTPStreamStats(RTCStatsReport::InboundRTPStreamStats&amp; stats, const webrtc::RTCInboundRTPStreamStats&amp; rtcStats)
  {
      fillRTCRTPStreamStats(stats, rtcStats);
  
      if (rtcStats.packets_received.is_defined())
          stats.packetsReceived = *rtcStats.packets_received;
      if (rtcStats.bytes_received.is_defined())
          stats.bytesReceived = *rtcStats.bytes_received;
      if (rtcStats.packets_lost.is_defined())
          stats.packetsLost = *rtcStats.packets_lost;
      if (rtcStats.jitter.is_defined())
          stats.jitter = *rtcStats.jitter;
<span class="line-modified">!     if (rtcStats.fraction_lost.is_defined())</span>
<span class="line-removed">-         stats.fractionLost = *rtcStats.fraction_lost;</span>
      if (rtcStats.packets_discarded.is_defined())
          stats.packetsDiscarded = *rtcStats.packets_discarded;
      if (rtcStats.packets_repaired.is_defined())
          stats.packetsRepaired = *rtcStats.packets_repaired;
      if (rtcStats.burst_packets_lost.is_defined())
<span class="line-new-header">--- 93,20 ---</span>
  
  static inline void fillInboundRTPStreamStats(RTCStatsReport::InboundRTPStreamStats&amp; stats, const webrtc::RTCInboundRTPStreamStats&amp; rtcStats)
  {
      fillRTCRTPStreamStats(stats, rtcStats);
  
<span class="line-added">+     // FIXME: Add support for decoder_implementation</span>
      if (rtcStats.packets_received.is_defined())
          stats.packetsReceived = *rtcStats.packets_received;
      if (rtcStats.bytes_received.is_defined())
          stats.bytesReceived = *rtcStats.bytes_received;
      if (rtcStats.packets_lost.is_defined())
          stats.packetsLost = *rtcStats.packets_lost;
      if (rtcStats.jitter.is_defined())
          stats.jitter = *rtcStats.jitter;
<span class="line-modified">!     // FIXME: Add support back for fractionLost.</span>
      if (rtcStats.packets_discarded.is_defined())
          stats.packetsDiscarded = *rtcStats.packets_discarded;
      if (rtcStats.packets_repaired.is_defined())
          stats.packetsRepaired = *rtcStats.packets_repaired;
      if (rtcStats.burst_packets_lost.is_defined())
</pre>
<hr />
<pre>
<span class="line-old-header">*** 130,10 ***</span>
<span class="line-new-header">--- 131,11 ---</span>
  
  static inline void fillOutboundRTPStreamStats(RTCStatsReport::OutboundRTPStreamStats&amp; stats, const webrtc::RTCOutboundRTPStreamStats&amp; rtcStats)
  {
      fillRTCRTPStreamStats(stats, rtcStats);
  
<span class="line-added">+     // FIXME: Add support for encoder_implementation</span>
      if (rtcStats.packets_sent.is_defined())
          stats.packetsSent = *rtcStats.packets_sent;
      if (rtcStats.bytes_sent.is_defined())
          stats.bytesSent = *rtcStats.bytes_sent;
      if (rtcStats.target_bitrate.is_defined())
</pre>
<hr />
<pre>
<span class="line-old-header">*** 347,12 ***</span>
          stats.clockRate = *rtcStats.clock_rate;
      if (rtcStats.channels.is_defined())
          stats.channels = *rtcStats.channels;
      if (rtcStats.sdp_fmtp_line.is_defined())
          stats.sdpFmtpLine = fromStdString(*rtcStats.sdp_fmtp_line);
<span class="line-removed">-     if (rtcStats.implementation.is_defined())</span>
<span class="line-removed">-         stats.implementation = fromStdString(*rtcStats.implementation);</span>
  }
  
  static inline void fillRTCTransportStats(RTCStatsReport::TransportStats&amp; stats, const webrtc::RTCTransportStats&amp; rtcStats)
  {
      fillRTCStats(stats, rtcStats);
<span class="line-new-header">--- 349,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 379,62 ***</span>
          stats.dataChannelsOpened = *rtcStats.data_channels_opened;
      if (rtcStats.data_channels_closed.is_defined())
          stats.dataChannelsClosed = *rtcStats.data_channels_closed;
  }
  
<span class="line-modified">! void LibWebRTCStatsCollector::OnStatsDelivered(const rtc::scoped_refptr&lt;const webrtc::RTCStatsReport&gt;&amp; rtcReport)</span>
  {
<span class="line-modified">!     callOnMainThread([protectedThis = rtc::scoped_refptr&lt;LibWebRTCStatsCollector&gt;(this), rtcReport] {</span>
<span class="line-modified">!         auto report = protectedThis-&gt;m_callback();</span>
<span class="line-modified">!         if (!report)</span>
<span class="line-modified">!             return;</span>
<span class="line-modified">! </span>
<span class="line-modified">!         ASSERT(report-&gt;backingMap());</span>
<span class="line-modified">! </span>
<span class="line-modified">!         for (const auto&amp; rtcStats : *rtcReport) {</span>
<span class="line-modified">!             if (rtcStats.type() == webrtc::RTCInboundRTPStreamStats::kType) {</span>
<span class="line-modified">!                 RTCStatsReport::InboundRTPStreamStats stats;</span>
<span class="line-modified">!                 fillInboundRTPStreamStats(stats, static_cast&lt;const webrtc::RTCInboundRTPStreamStats&amp;&gt;(rtcStats));</span>
<span class="line-modified">!                 report-&gt;addStats&lt;IDLDictionary&lt;RTCStatsReport::InboundRTPStreamStats&gt;&gt;(WTFMove(stats));</span>
<span class="line-modified">!             } else if (rtcStats.type() == webrtc::RTCOutboundRTPStreamStats::kType) {</span>
<span class="line-modified">!                 RTCStatsReport::OutboundRTPStreamStats stats;</span>
<span class="line-modified">!                 fillOutboundRTPStreamStats(stats, static_cast&lt;const webrtc::RTCOutboundRTPStreamStats&amp;&gt;(rtcStats));</span>
<span class="line-modified">!                 report-&gt;addStats&lt;IDLDictionary&lt;RTCStatsReport::OutboundRTPStreamStats&gt;&gt;(WTFMove(stats));</span>
<span class="line-modified">!             } else if (rtcStats.type() == webrtc::RTCMediaStreamTrackStats::kType) {</span>
<span class="line-modified">!                 RTCStatsReport::MediaStreamTrackStats stats;</span>
<span class="line-modified">!                 fillRTCMediaStreamTrackStats(stats, static_cast&lt;const webrtc::RTCMediaStreamTrackStats&amp;&gt;(rtcStats));</span>
<span class="line-modified">!                 report-&gt;addStats&lt;IDLDictionary&lt;RTCStatsReport::MediaStreamTrackStats&gt;&gt;(WTFMove(stats));</span>
<span class="line-modified">!             } else if (rtcStats.type() == webrtc::RTCDataChannelStats::kType) {</span>
<span class="line-modified">!                 RTCStatsReport::DataChannelStats stats;</span>
<span class="line-modified">!                 fillRTCDataChannelStats(stats, static_cast&lt;const webrtc::RTCDataChannelStats&amp;&gt;(rtcStats));</span>
<span class="line-modified">!                 report-&gt;addStats&lt;IDLDictionary&lt;RTCStatsReport::DataChannelStats&gt;&gt;(WTFMove(stats));</span>
<span class="line-modified">!             } else if (rtcStats.type() == webrtc::RTCIceCandidatePairStats::kType) {</span>
<span class="line-modified">!                 RTCStatsReport::IceCandidatePairStats stats;</span>
<span class="line-modified">!                 fillRTCIceCandidatePairStats(stats, static_cast&lt;const webrtc::RTCIceCandidatePairStats&amp;&gt;(rtcStats));</span>
<span class="line-modified">!                 report-&gt;addStats&lt;IDLDictionary&lt;RTCStatsReport::IceCandidatePairStats&gt;&gt;(WTFMove(stats));</span>
<span class="line-modified">!             } else if (rtcStats.type() == webrtc::RTCRemoteIceCandidateStats::kType || rtcStats.type() == webrtc::RTCLocalIceCandidateStats::kType) {</span>
<span class="line-modified">!                 RTCStatsReport::IceCandidateStats stats;</span>
<span class="line-modified">!                 fillRTCIceCandidateStats(stats, static_cast&lt;const webrtc::RTCIceCandidateStats&amp;&gt;(rtcStats));</span>
<span class="line-modified">!                 report-&gt;addStats&lt;IDLDictionary&lt;RTCStatsReport::IceCandidateStats&gt;&gt;(WTFMove(stats));</span>
<span class="line-modified">!             } else if (rtcStats.type() == webrtc::RTCCertificateStats::kType) {</span>
<span class="line-modified">!                 RTCStatsReport::CertificateStats stats;</span>
<span class="line-modified">!                 fillRTCCertificateStats(stats, static_cast&lt;const webrtc::RTCCertificateStats&amp;&gt;(rtcStats));</span>
<span class="line-modified">!                 report-&gt;addStats&lt;IDLDictionary&lt;RTCStatsReport::CertificateStats&gt;&gt;(WTFMove(stats));</span>
<span class="line-modified">!             } else if (rtcStats.type() == webrtc::RTCCodecStats::kType) {</span>
<span class="line-modified">!                 RTCStatsReport::CodecStats stats;</span>
<span class="line-modified">!                 fillRTCCodecStats(stats, static_cast&lt;const webrtc::RTCCodecStats&amp;&gt;(rtcStats));</span>
<span class="line-modified">!                 report-&gt;addStats&lt;IDLDictionary&lt;RTCStatsReport::CodecStats&gt;&gt;(WTFMove(stats));</span>
<span class="line-modified">!             } else if (rtcStats.type() == webrtc::RTCTransportStats::kType) {</span>
<span class="line-removed">-                 RTCStatsReport::TransportStats stats;</span>
<span class="line-removed">-                 fillRTCTransportStats(stats, static_cast&lt;const webrtc::RTCTransportStats&amp;&gt;(rtcStats));</span>
<span class="line-removed">-                 report-&gt;addStats&lt;IDLDictionary&lt;RTCStatsReport::TransportStats&gt;&gt;(WTFMove(stats));</span>
<span class="line-removed">-             } else if (rtcStats.type() == webrtc::RTCPeerConnectionStats::kType) {</span>
<span class="line-removed">-                 RTCStatsReport::PeerConnectionStats stats;</span>
<span class="line-removed">-                 fillRTCPeerConnectionStats(stats, static_cast&lt;const webrtc::RTCPeerConnectionStats&amp;&gt;(rtcStats));</span>
<span class="line-removed">-                 report-&gt;addStats&lt;IDLDictionary&lt;RTCStatsReport::PeerConnectionStats&gt;&gt;(WTFMove(stats));</span>
<span class="line-removed">-             }</span>
          }
      });
  }
  
  }; // namespace WTF
  
<span class="line-new-header">--- 379,64 ---</span>
          stats.dataChannelsOpened = *rtcStats.data_channels_opened;
      if (rtcStats.data_channels_closed.is_defined())
          stats.dataChannelsClosed = *rtcStats.data_channels_closed;
  }
  
<span class="line-modified">! static inline void initializeRTCStatsReportBackingMap(DOMMapAdapter&amp; report, const webrtc::RTCStatsReport&amp; rtcReport)</span>
  {
<span class="line-modified">!     for (const auto&amp; rtcStats : rtcReport) {</span>
<span class="line-modified">!         if (rtcStats.type() == webrtc::RTCInboundRTPStreamStats::kType) {</span>
<span class="line-modified">!             RTCStatsReport::InboundRTPStreamStats stats;</span>
<span class="line-modified">!             fillInboundRTPStreamStats(stats, static_cast&lt;const webrtc::RTCInboundRTPStreamStats&amp;&gt;(rtcStats));</span>
<span class="line-modified">!             report.set&lt;IDLDOMString, IDLDictionary&lt;RTCStatsReport::InboundRTPStreamStats&gt;&gt;(stats.id, WTFMove(stats));</span>
<span class="line-modified">!         } else if (rtcStats.type() == webrtc::RTCOutboundRTPStreamStats::kType) {</span>
<span class="line-modified">!             RTCStatsReport::OutboundRTPStreamStats stats;</span>
<span class="line-modified">!             fillOutboundRTPStreamStats(stats, static_cast&lt;const webrtc::RTCOutboundRTPStreamStats&amp;&gt;(rtcStats));</span>
<span class="line-modified">!             report.set&lt;IDLDOMString, IDLDictionary&lt;RTCStatsReport::OutboundRTPStreamStats&gt;&gt;(stats.id, WTFMove(stats));</span>
<span class="line-modified">!         } else if (rtcStats.type() == webrtc::RTCMediaStreamTrackStats::kType) {</span>
<span class="line-modified">!             RTCStatsReport::MediaStreamTrackStats stats;</span>
<span class="line-modified">!             fillRTCMediaStreamTrackStats(stats, static_cast&lt;const webrtc::RTCMediaStreamTrackStats&amp;&gt;(rtcStats));</span>
<span class="line-modified">!             report.set&lt;IDLDOMString, IDLDictionary&lt;RTCStatsReport::MediaStreamTrackStats&gt;&gt;(stats.id, WTFMove(stats));</span>
<span class="line-modified">!         } else if (rtcStats.type() == webrtc::RTCDataChannelStats::kType) {</span>
<span class="line-modified">!             RTCStatsReport::DataChannelStats stats;</span>
<span class="line-modified">!             fillRTCDataChannelStats(stats, static_cast&lt;const webrtc::RTCDataChannelStats&amp;&gt;(rtcStats));</span>
<span class="line-modified">!             report.set&lt;IDLDOMString, IDLDictionary&lt;RTCStatsReport::DataChannelStats&gt;&gt;(stats.id, WTFMove(stats));</span>
<span class="line-modified">!         } else if (rtcStats.type() == webrtc::RTCIceCandidatePairStats::kType) {</span>
<span class="line-modified">!             RTCStatsReport::IceCandidatePairStats stats;</span>
<span class="line-modified">!             fillRTCIceCandidatePairStats(stats, static_cast&lt;const webrtc::RTCIceCandidatePairStats&amp;&gt;(rtcStats));</span>
<span class="line-modified">!             report.set&lt;IDLDOMString, IDLDictionary&lt;RTCStatsReport::IceCandidatePairStats&gt;&gt;(stats.id, WTFMove(stats));</span>
<span class="line-modified">!         } else if (rtcStats.type() == webrtc::RTCRemoteIceCandidateStats::kType || rtcStats.type() == webrtc::RTCLocalIceCandidateStats::kType) {</span>
<span class="line-modified">!             RTCStatsReport::IceCandidateStats stats;</span>
<span class="line-modified">!             fillRTCIceCandidateStats(stats, static_cast&lt;const webrtc::RTCIceCandidateStats&amp;&gt;(rtcStats));</span>
<span class="line-modified">!             report.set&lt;IDLDOMString, IDLDictionary&lt;RTCStatsReport::IceCandidateStats&gt;&gt;(stats.id, WTFMove(stats));</span>
<span class="line-modified">!         } else if (rtcStats.type() == webrtc::RTCCertificateStats::kType) {</span>
<span class="line-modified">!             RTCStatsReport::CertificateStats stats;</span>
<span class="line-modified">!             fillRTCCertificateStats(stats, static_cast&lt;const webrtc::RTCCertificateStats&amp;&gt;(rtcStats));</span>
<span class="line-modified">!             report.set&lt;IDLDOMString, IDLDictionary&lt;RTCStatsReport::CertificateStats&gt;&gt;(stats.id, WTFMove(stats));</span>
<span class="line-modified">!         } else if (rtcStats.type() == webrtc::RTCCodecStats::kType) {</span>
<span class="line-modified">!             RTCStatsReport::CodecStats stats;</span>
<span class="line-modified">!             fillRTCCodecStats(stats, static_cast&lt;const webrtc::RTCCodecStats&amp;&gt;(rtcStats));</span>
<span class="line-modified">!             report.set&lt;IDLDOMString, IDLDictionary&lt;RTCStatsReport::CodecStats&gt;&gt;(stats.id, WTFMove(stats));</span>
<span class="line-modified">!         } else if (rtcStats.type() == webrtc::RTCTransportStats::kType) {</span>
<span class="line-modified">!             RTCStatsReport::TransportStats stats;</span>
<span class="line-modified">!             fillRTCTransportStats(stats, static_cast&lt;const webrtc::RTCTransportStats&amp;&gt;(rtcStats));</span>
<span class="line-modified">!             report.set&lt;IDLDOMString, IDLDictionary&lt;RTCStatsReport::TransportStats&gt;&gt;(stats.id, WTFMove(stats));</span>
<span class="line-modified">!         } else if (rtcStats.type() == webrtc::RTCPeerConnectionStats::kType) {</span>
<span class="line-modified">!             RTCStatsReport::PeerConnectionStats stats;</span>
<span class="line-modified">!             fillRTCPeerConnectionStats(stats, static_cast&lt;const webrtc::RTCPeerConnectionStats&amp;&gt;(rtcStats));</span>
<span class="line-modified">!             report.set&lt;IDLDOMString, IDLDictionary&lt;RTCStatsReport::PeerConnectionStats&gt;&gt;(stats.id, WTFMove(stats));</span>
          }
<span class="line-added">+     }</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ void LibWebRTCStatsCollector::OnStatsDelivered(const rtc::scoped_refptr&lt;const webrtc::RTCStatsReport&gt;&amp; rtcReport)</span>
<span class="line-added">+ {</span>
<span class="line-added">+     callOnMainThread([this, protectedThis = rtc::scoped_refptr&lt;LibWebRTCStatsCollector&gt;(this), rtcReport]() {</span>
<span class="line-added">+         m_callback(RTCStatsReport::create([rtcReport](auto&amp; mapAdapter) {</span>
<span class="line-added">+             if (rtcReport)</span>
<span class="line-added">+                 initializeRTCStatsReportBackingMap(mapAdapter, *rtcReport);</span>
<span class="line-added">+         }));</span>
      });
  }
  
  }; // namespace WTF
  
</pre>
<center><a href="LibWebRTCRtpTransceiverBackend.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="LibWebRTCStatsCollector.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>