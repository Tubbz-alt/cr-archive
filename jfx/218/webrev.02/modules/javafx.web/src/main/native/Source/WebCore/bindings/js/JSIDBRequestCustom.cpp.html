<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New modules/javafx.web/src/main/native/Source/WebCore/bindings/js/JSIDBRequestCustom.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (C) 2019 Apple Inc. All rights reserved.
  3  *
  4  * Redistribution and use in source and binary forms, with or without
  5  * modification, are permitted provided that the following conditions
  6  * are met:
  7  * 1. Redistributions of source code must retain the above copyright
  8  *    notice, this list of conditions and the following disclaimer.
  9  * 2. Redistributions in binary form must reproduce the above copyright
 10  *    notice, this list of conditions and the following disclaimer in the
 11  *    documentation and/or other materials provided with the distribution.
 12  *
 13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. AND ITS CONTRIBUTORS ``AS IS&#39;&#39;
 14  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
 15  * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 16  * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL APPLE INC. OR ITS CONTRIBUTORS
 17  * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 18  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 19  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 20  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 21  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 22  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF
 23  * THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #include &quot;config.h&quot;
 27 #include &quot;JSIDBRequest.h&quot;
 28 
 29 #if ENABLE(INDEXED_DATABASE)
 30 
 31 #include &quot;IDBBindingUtilities.h&quot;
 32 #include &quot;JSDOMConvertIndexedDB.h&quot;
 33 #include &quot;JSDOMConvertInterface.h&quot;
 34 #include &quot;JSDOMConvertSequences.h&quot;
 35 #include &quot;JSIDBCursor.h&quot;
 36 #include &quot;JSIDBDatabase.h&quot;
 37 
 38 namespace WebCore {
 39 using namespace JSC;
 40 
 41 JSC::JSValue JSIDBRequest::result(JSC::JSGlobalObject&amp; lexicalGlobalObject) const
 42 {
 43     return cachedPropertyValue(lexicalGlobalObject, *this, wrapped().resultWrapper(), [&amp;] {
 44         auto result = wrapped().result();
 45         if (UNLIKELY(result.hasException())) {
 46             auto throwScope = DECLARE_THROW_SCOPE(lexicalGlobalObject.vm());
 47             propagateException(lexicalGlobalObject, throwScope, result.releaseException());
 48             return jsNull();
 49         }
 50 
 51         IDBRequest::Result resultValue = result.releaseReturnValue();
 52         return WTF::switchOn(resultValue, [&amp;lexicalGlobalObject] (RefPtr&lt;IDBCursor&gt;&amp; cursor) {
 53             auto throwScope = DECLARE_THROW_SCOPE(lexicalGlobalObject.vm());
 54             return toJS&lt;IDLInterface&lt;IDBCursor&gt;&gt;(lexicalGlobalObject, *jsCast&lt;JSDOMGlobalObject*&gt;(&amp;lexicalGlobalObject), throwScope, cursor.get());
 55         }, [&amp;lexicalGlobalObject] (RefPtr&lt;IDBDatabase&gt;&amp; database) {
 56             auto throwScope = DECLARE_THROW_SCOPE(lexicalGlobalObject.vm());
 57             return toJS&lt;IDLInterface&lt;IDBDatabase&gt;&gt;(lexicalGlobalObject, *jsCast&lt;JSDOMGlobalObject*&gt;(&amp;lexicalGlobalObject), throwScope, database.get());
 58         }, [&amp;lexicalGlobalObject] (IDBKeyData keyData) {
 59             return toJS&lt;IDLIDBKeyData&gt;(lexicalGlobalObject, *jsCast&lt;JSDOMGlobalObject*&gt;(&amp;lexicalGlobalObject), keyData);
 60         }, [&amp;lexicalGlobalObject] (Vector&lt;IDBKeyData&gt; keyDatas) {
 61             return toJS&lt;IDLSequence&lt;IDLIDBKeyData&gt;&gt;(lexicalGlobalObject, *jsCast&lt;JSDOMGlobalObject*&gt;(&amp;lexicalGlobalObject), keyDatas);
 62         }, [&amp;lexicalGlobalObject] (IDBGetResult getResult) {
 63             auto result = deserializeIDBValueWithKeyInjection(lexicalGlobalObject, getResult.value(), getResult.keyData(), getResult.keyPath());
 64             return result ? result.value() : jsNull();
 65         }, [&amp;lexicalGlobalObject] (IDBGetAllResult getAllResult) {
 66             auto&amp; keys = getAllResult.keys();
 67             auto&amp; values = getAllResult.values();
 68             auto&amp; keyPath = getAllResult.keyPath();
 69             auto scope = DECLARE_THROW_SCOPE(lexicalGlobalObject.vm());
 70             JSC::MarkedArgumentBuffer list;
 71             for (unsigned i = 0; i &lt; values.size(); i ++) {
 72                 auto result = deserializeIDBValueWithKeyInjection(lexicalGlobalObject, values[i], keys[i], keyPath);
 73                 if (!result)
 74                     return jsNull();
 75                 list.append(result.value());
 76                 if (UNLIKELY(list.hasOverflowed())) {
 77                     propagateException(lexicalGlobalObject, scope, Exception(UnknownError));
 78                     return jsNull();
 79                 }
 80             }
 81             return JSValue(JSC::constructArray(&amp;lexicalGlobalObject, static_cast&lt;JSC::ArrayAllocationProfile*&gt;(nullptr), list));
 82         }, [] (uint64_t number) {
 83             return toJS&lt;IDLUnsignedLongLong&gt;(number);
 84         }, [] (IDBRequest::NullResultType other) {
 85             if (other == IDBRequest::NullResultType::Empty)
 86                 return JSC::jsNull();
 87             return JSC::jsUndefined();
 88         });
 89     });
 90 }
 91 
 92 void JSIDBRequest::visitAdditionalChildren(SlotVisitor&amp; visitor)
 93 {
 94     auto&amp; request = wrapped();
 95     request.resultWrapper().visit(visitor);
 96     request.cursorWrapper().visit(visitor);
 97 }
 98 
 99 }
100 #endif // ENABLE(INDEXED_DATABASE)
    </pre>
  </body>
</html>