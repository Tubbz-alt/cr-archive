<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.web/src/main/native/Source/JavaScriptCore/bytecode/ArithProfile.h</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="ArithProfile.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="ByValInfo.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/JavaScriptCore/bytecode/ArithProfile.h</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 64,183 ***</span>
  
  private:
      uint8_t m_bits { 0 };
  };
  
<span class="line-modified">! struct ArithProfile {</span>
<span class="line-modified">! private:</span>
<span class="line-modified">!     static constexpr uint32_t numberOfFlagBits = 6;</span>
<span class="line-modified">!     static constexpr uint32_t rhsResultTypeShift = numberOfFlagBits;</span>
<span class="line-modified">!     static constexpr uint32_t lhsResultTypeShift = rhsResultTypeShift + ResultType::numBitsNeeded;</span>
<span class="line-modified">!     static constexpr uint32_t rhsObservedTypeShift = lhsResultTypeShift + ResultType::numBitsNeeded;</span>
<span class="line-modified">!     static constexpr uint32_t lhsObservedTypeShift = rhsObservedTypeShift + ObservedType::numBitsNeeded;</span>
  
<span class="line-modified">!     static_assert(ObservedType::numBitsNeeded == 3, &quot;We make a hard assumption about that here.&quot;);</span>
<span class="line-modified">!     static constexpr uint32_t clearRhsObservedTypeBitMask = static_cast&lt;uint32_t&gt;(~((1 &lt;&lt; rhsObservedTypeShift) | (1 &lt;&lt; (rhsObservedTypeShift + 1)) | (1 &lt;&lt; (rhsObservedTypeShift + 2))));</span>
<span class="line-modified">!     static constexpr uint32_t clearLhsObservedTypeBitMask = static_cast&lt;uint32_t&gt;(~((1 &lt;&lt; lhsObservedTypeShift) | (1 &lt;&lt; (lhsObservedTypeShift + 1)) | (1 &lt;&lt; (lhsObservedTypeShift + 2))));</span>
  
<span class="line-modified">!     static constexpr uint32_t resultTypeMask = (1 &lt;&lt; ResultType::numBitsNeeded) - 1;</span>
<span class="line-modified">!     static constexpr uint32_t observedTypeMask = (1 &lt;&lt; ObservedType::numBitsNeeded) - 1;</span>
  
<span class="line-modified">!     enum class ConstantTag { Constant };</span>
  
  public:
<span class="line-modified">!     static constexpr uint32_t specialFastPathBit = 1 &lt;&lt; (lhsObservedTypeShift + ObservedType::numBitsNeeded);</span>
<span class="line-removed">-     static_assert((lhsObservedTypeShift + ObservedType::numBitsNeeded) &lt;= (sizeof(uint32_t) * 8) - 1, &quot;Should fit in a uint32_t.&quot;);</span>
<span class="line-removed">-     static_assert(!(specialFastPathBit &amp; ~clearLhsObservedTypeBitMask), &quot;These bits should not intersect.&quot;);</span>
<span class="line-removed">-     static_assert(specialFastPathBit &amp; clearLhsObservedTypeBitMask, &quot;These bits should intersect.&quot;);</span>
<span class="line-removed">-     static_assert(specialFastPathBit &gt; ~clearLhsObservedTypeBitMask, &quot;These bits should not intersect and specialFastPathBit should be a higher bit.&quot;);</span>
<span class="line-removed">- </span>
<span class="line-removed">-     ArithProfile(ResultType arg)</span>
<span class="line-removed">-         : ArithProfile(ConstantTag::Constant, arg)</span>
      {
<span class="line-modified">!         ASSERT(lhsResultType().bits() == arg.bits());</span>
<span class="line-removed">-         ASSERT(lhsObservedType().isEmpty());</span>
<span class="line-removed">-         ASSERT(rhsObservedType().isEmpty());</span>
      }
  
<span class="line-modified">!     ArithProfile(ResultType lhs, ResultType rhs)</span>
<span class="line-removed">-         : ArithProfile(ConstantTag::Constant, lhs, rhs)</span>
      {
<span class="line-modified">!         ASSERT(lhsResultType().bits() == lhs.bits() &amp;&amp; rhsResultType().bits() == rhs.bits());</span>
<span class="line-modified">!         ASSERT(lhsObservedType().isEmpty());</span>
<span class="line-modified">!         ASSERT(rhsObservedType().isEmpty());</span>
      }
  
<span class="line-modified">!     ArithProfile(OperandTypes types)</span>
<span class="line-modified">!         : ArithProfile(types.first(), types.second())</span>
<span class="line-modified">!     { }</span>
  
      ArithProfile() = default;
  
<span class="line-modified">!     static constexpr ArithProfile fromInt(uint32_t bits)</span>
      {
<span class="line-modified">!         return ArithProfile { ConstantTag::Constant, bits };</span>
      }
  
<span class="line-modified">!     static constexpr ArithProfile observedUnaryInt()</span>
      {
          constexpr ObservedType observedInt32 { ObservedType().withInt32() };
<span class="line-modified">!         constexpr uint32_t bits = observedInt32.bits() &lt;&lt; lhsObservedTypeShift;</span>
<span class="line-modified">!         static_assert(bits == 0x800000, &quot;&quot;);</span>
<span class="line-removed">-         return fromInt(bits);</span>
      }
<span class="line-modified">!     static constexpr ArithProfile observedUnaryNumber()</span>
      {
          constexpr ObservedType observedNumber { ObservedType().withNumber() };
<span class="line-modified">!         constexpr uint32_t bits = observedNumber.bits() &lt;&lt; lhsObservedTypeShift;</span>
<span class="line-modified">!         static_assert(bits == 0x1000000, &quot;&quot;);</span>
<span class="line-modified">!         return fromInt(bits);</span>
      }
<span class="line-modified">!     static constexpr ArithProfile observedBinaryIntInt()</span>
      {
          constexpr ObservedType observedInt32 { ObservedType().withInt32() };
<span class="line-modified">!         constexpr uint32_t bits = (observedInt32.bits() &lt;&lt; lhsObservedTypeShift) | (observedInt32.bits() &lt;&lt; rhsObservedTypeShift);</span>
<span class="line-modified">!         static_assert(bits == 0x900000, &quot;&quot;);</span>
<span class="line-removed">-         return fromInt(bits);</span>
      }
<span class="line-modified">!     static constexpr ArithProfile observedBinaryNumberInt()</span>
      {
          constexpr ObservedType observedNumber { ObservedType().withNumber() };
          constexpr ObservedType observedInt32 { ObservedType().withInt32() };
<span class="line-modified">!         constexpr uint32_t bits = (observedNumber.bits() &lt;&lt; lhsObservedTypeShift) | (observedInt32.bits() &lt;&lt; rhsObservedTypeShift);</span>
<span class="line-modified">!         static_assert(bits == 0x1100000, &quot;&quot;);</span>
<span class="line-removed">-         return fromInt(bits);</span>
      }
<span class="line-modified">!     static constexpr ArithProfile observedBinaryIntNumber()</span>
      {
          constexpr ObservedType observedNumber { ObservedType().withNumber() };
          constexpr ObservedType observedInt32 { ObservedType().withInt32() };
<span class="line-modified">!         constexpr uint32_t bits = (observedInt32.bits() &lt;&lt; lhsObservedTypeShift) | (observedNumber.bits() &lt;&lt; rhsObservedTypeShift);</span>
<span class="line-modified">!         static_assert(bits == 0xa00000, &quot;&quot;);</span>
<span class="line-removed">-         return fromInt(bits);</span>
      }
<span class="line-modified">!     static constexpr ArithProfile observedBinaryNumberNumber()</span>
      {
          constexpr ObservedType observedNumber { ObservedType().withNumber() };
<span class="line-modified">!         constexpr uint32_t bits = (observedNumber.bits() &lt;&lt; lhsObservedTypeShift) | (observedNumber.bits() &lt;&lt; rhsObservedTypeShift);</span>
<span class="line-modified">!         static_assert(bits == 0x1200000, &quot;&quot;);</span>
<span class="line-removed">-         return fromInt(bits);</span>
      }
  
<span class="line-removed">-     enum ObservedResults {</span>
<span class="line-removed">-         NonNegZeroDouble = 1 &lt;&lt; 0,</span>
<span class="line-removed">-         NegZeroDouble    = 1 &lt;&lt; 1,</span>
<span class="line-removed">-         NonNumeric       = 1 &lt;&lt; 2,</span>
<span class="line-removed">-         Int32Overflow    = 1 &lt;&lt; 3,</span>
<span class="line-removed">-         Int52Overflow    = 1 &lt;&lt; 4,</span>
<span class="line-removed">-         BigInt           = 1 &lt;&lt; 5,</span>
<span class="line-removed">-     };</span>
<span class="line-removed">- </span>
<span class="line-removed">-     ResultType lhsResultType() const { return ResultType((m_bits &gt;&gt; lhsResultTypeShift) &amp; resultTypeMask); }</span>
<span class="line-removed">-     ResultType rhsResultType() const { return ResultType((m_bits &gt;&gt; rhsResultTypeShift) &amp; resultTypeMask); }</span>
<span class="line-removed">- </span>
      constexpr ObservedType lhsObservedType() const { return ObservedType((m_bits &gt;&gt; lhsObservedTypeShift) &amp; observedTypeMask); }
      constexpr ObservedType rhsObservedType() const { return ObservedType((m_bits &gt;&gt; rhsObservedTypeShift) &amp; observedTypeMask); }
      void setLhsObservedType(ObservedType type)
      {
<span class="line-modified">!         uint32_t bits = m_bits;</span>
          bits &amp;= clearLhsObservedTypeBitMask;
          bits |= type.bits() &lt;&lt; lhsObservedTypeShift;
          m_bits = bits;
          ASSERT(lhsObservedType() == type);
      }
  
      void setRhsObservedType(ObservedType type)
      {
<span class="line-modified">!         uint32_t bits = m_bits;</span>
          bits &amp;= clearRhsObservedTypeBitMask;
          bits |= type.bits() &lt;&lt; rhsObservedTypeShift;
          m_bits = bits;
          ASSERT(rhsObservedType() == type);
      }
  
      bool tookSpecialFastPath() const { return m_bits &amp; specialFastPathBit; }
  
<span class="line-removed">-     bool didObserveNonInt32() const { return hasBits(NonNegZeroDouble | NegZeroDouble | NonNumeric | BigInt); }</span>
<span class="line-removed">-     bool didObserveDouble() const { return hasBits(NonNegZeroDouble | NegZeroDouble); }</span>
<span class="line-removed">-     bool didObserveNonNegZeroDouble() const { return hasBits(NonNegZeroDouble); }</span>
<span class="line-removed">-     bool didObserveNegZeroDouble() const { return hasBits(NegZeroDouble); }</span>
<span class="line-removed">-     bool didObserveNonNumeric() const { return hasBits(NonNumeric); }</span>
<span class="line-removed">-     bool didObserveBigInt() const { return hasBits(BigInt); }</span>
<span class="line-removed">-     bool didObserveInt32Overflow() const { return hasBits(Int32Overflow); }</span>
<span class="line-removed">-     bool didObserveInt52Overflow() const { return hasBits(Int52Overflow); }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     void setObservedNonNegZeroDouble() { setBit(NonNegZeroDouble); }</span>
<span class="line-removed">-     void setObservedNegZeroDouble() { setBit(NegZeroDouble); }</span>
<span class="line-removed">-     void setObservedNonNumeric() { setBit(NonNumeric); }</span>
<span class="line-removed">-     void setObservedBigInt() { setBit(BigInt); }</span>
<span class="line-removed">-     void setObservedInt32Overflow() { setBit(Int32Overflow); }</span>
<span class="line-removed">-     void setObservedInt52Overflow() { setBit(Int52Overflow); }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     const void* addressOfBits() const { return &amp;m_bits; }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     void observeResult(JSValue value)</span>
<span class="line-removed">-     {</span>
<span class="line-removed">-         if (value.isInt32())</span>
<span class="line-removed">-             return;</span>
<span class="line-removed">-         if (value.isNumber()) {</span>
<span class="line-removed">-             m_bits |= Int32Overflow | Int52Overflow | NonNegZeroDouble | NegZeroDouble;</span>
<span class="line-removed">-             return;</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-         if (value &amp;&amp; value.isBigInt()) {</span>
<span class="line-removed">-             m_bits |= BigInt;</span>
<span class="line-removed">-             return;</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-         m_bits |= NonNumeric;</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
      void lhsSawInt32() { setLhsObservedType(lhsObservedType().withInt32()); }
      void lhsSawNumber() { setLhsObservedType(lhsObservedType().withNumber()); }
      void lhsSawNonNumber() { setLhsObservedType(lhsObservedType().withNonNumber()); }
      void rhsSawInt32() { setRhsObservedType(rhsObservedType().withInt32()); }
      void rhsSawNumber() { setRhsObservedType(rhsObservedType().withNumber()); }
      void rhsSawNonNumber() { setRhsObservedType(rhsObservedType().withNonNumber()); }
  
      void observeLHS(JSValue lhs)
      {
<span class="line-modified">!         ArithProfile newProfile = *this;</span>
          if (lhs.isNumber()) {
              if (lhs.isInt32())
                  newProfile.lhsSawInt32();
              else
                  newProfile.lhsSawNumber();
<span class="line-new-header">--- 64,272 ---</span>
  
  private:
      uint8_t m_bits { 0 };
  };
  
<span class="line-modified">! class ObservedResults {</span>
<span class="line-modified">! public:</span>
<span class="line-modified">!     enum Tags : uint8_t {</span>
<span class="line-modified">!         NonNegZeroDouble = 1 &lt;&lt; 0,</span>
<span class="line-modified">!         NegZeroDouble    = 1 &lt;&lt; 1,</span>
<span class="line-modified">!         NonNumeric       = 1 &lt;&lt; 2,</span>
<span class="line-modified">!         Int32Overflow    = 1 &lt;&lt; 3,</span>
<span class="line-added">+         Int52Overflow    = 1 &lt;&lt; 4,</span>
<span class="line-added">+         BigInt           = 1 &lt;&lt; 5,</span>
<span class="line-added">+     };</span>
<span class="line-added">+     static constexpr uint32_t numBitsNeeded = 6;</span>
  
<span class="line-modified">!     ObservedResults() = default;</span>
<span class="line-modified">!     explicit ObservedResults(uint8_t bits)</span>
<span class="line-modified">!         : m_bits(bits)</span>
<span class="line-added">+     { }</span>
  
<span class="line-modified">!     bool didObserveNonInt32() { return m_bits &amp; (NonNegZeroDouble | NegZeroDouble | NonNumeric | BigInt); }</span>
<span class="line-modified">!     bool didObserveDouble() { return m_bits &amp; (NonNegZeroDouble | NegZeroDouble); }</span>
<span class="line-added">+     bool didObserveNonNegZeroDouble() { return m_bits &amp; NonNegZeroDouble; }</span>
<span class="line-added">+     bool didObserveNegZeroDouble() { return m_bits &amp; NegZeroDouble; }</span>
<span class="line-added">+     bool didObserveNonNumeric() { return m_bits &amp; NonNumeric; }</span>
<span class="line-added">+     bool didObserveBigInt() { return m_bits &amp; BigInt; }</span>
<span class="line-added">+     bool didObserveInt32Overflow() { return m_bits &amp; Int32Overflow; }</span>
<span class="line-added">+     bool didObserveInt52Overflow() { return m_bits &amp; Int52Overflow; }</span>
  
<span class="line-modified">! private:</span>
<span class="line-added">+     uint8_t m_bits { 0 };</span>
<span class="line-added">+ };</span>
  
<span class="line-added">+ template &lt;typename BitfieldType&gt;</span>
<span class="line-added">+ class ArithProfile {</span>
  public:
<span class="line-modified">!     ObservedResults observedResults() const</span>
      {
<span class="line-modified">!         return ObservedResults(m_bits &amp; ((1 &lt;&lt; ObservedResults::numBitsNeeded) - 1));</span>
      }
<span class="line-added">+     bool didObserveNonInt32() const { return observedResults().didObserveNonInt32();}</span>
<span class="line-added">+     bool didObserveDouble() const { return observedResults().didObserveDouble(); }</span>
<span class="line-added">+     bool didObserveNonNegZeroDouble() const { return observedResults().didObserveNonNegZeroDouble(); }</span>
<span class="line-added">+     bool didObserveNegZeroDouble() const { return observedResults().didObserveNegZeroDouble(); }</span>
<span class="line-added">+     bool didObserveNonNumeric() const { return observedResults().didObserveNonNumeric(); }</span>
<span class="line-added">+     bool didObserveBigInt() const { return observedResults().didObserveBigInt(); }</span>
<span class="line-added">+     bool didObserveInt32Overflow() const { return observedResults().didObserveInt32Overflow(); }</span>
<span class="line-added">+     bool didObserveInt52Overflow() const { return observedResults().didObserveInt52Overflow(); }</span>
<span class="line-added">+ </span>
<span class="line-added">+     void setObservedNonNegZeroDouble() { setBit(ObservedResults::NonNegZeroDouble); }</span>
<span class="line-added">+     void setObservedNegZeroDouble() { setBit(ObservedResults::NegZeroDouble); }</span>
<span class="line-added">+     void setObservedNonNumeric() { setBit(ObservedResults::NonNumeric); }</span>
<span class="line-added">+     void setObservedBigInt() { setBit(ObservedResults::BigInt); }</span>
<span class="line-added">+     void setObservedInt32Overflow() { setBit(ObservedResults::Int32Overflow); }</span>
<span class="line-added">+     void setObservedInt52Overflow() { setBit(ObservedResults::Int52Overflow); }</span>
  
<span class="line-modified">!     void observeResult(JSValue value)</span>
      {
<span class="line-modified">!         if (value.isInt32())</span>
<span class="line-modified">!             return;</span>
<span class="line-modified">!         if (value.isNumber()) {</span>
<span class="line-added">+             m_bits |= ObservedResults::Int32Overflow | ObservedResults::Int52Overflow | ObservedResults::NonNegZeroDouble | ObservedResults::NegZeroDouble;</span>
<span class="line-added">+             return;</span>
<span class="line-added">+         }</span>
<span class="line-added">+         if (value &amp;&amp; value.isBigInt()) {</span>
<span class="line-added">+             m_bits |= ObservedResults::BigInt;</span>
<span class="line-added">+             return;</span>
<span class="line-added">+         }</span>
<span class="line-added">+         m_bits |= ObservedResults::NonNumeric;</span>
      }
  
<span class="line-modified">!     const void* addressOfBits() const { return &amp;m_bits; }</span>
<span class="line-modified">! </span>
<span class="line-modified">! #if ENABLE(JIT)</span>
<span class="line-added">+     // Sets (Int32Overflow | Int52Overflow | NonNegZeroDouble | NegZeroDouble) if it sees a</span>
<span class="line-added">+     // double. Sets NonNumeric if it sees a non-numeric.</span>
<span class="line-added">+     void emitObserveResult(CCallHelpers&amp;, JSValueRegs, TagRegistersMode = HaveTagRegisters);</span>
  
<span class="line-added">+     // Sets (Int32Overflow | Int52Overflow | NonNegZeroDouble | NegZeroDouble).</span>
<span class="line-added">+     bool shouldEmitSetDouble() const;</span>
<span class="line-added">+     void emitSetDouble(CCallHelpers&amp;) const;</span>
<span class="line-added">+ </span>
<span class="line-added">+     // Sets NonNumeric</span>
<span class="line-added">+     void emitSetNonNumeric(CCallHelpers&amp;) const;</span>
<span class="line-added">+     bool shouldEmitSetNonNumeric() const;</span>
<span class="line-added">+ </span>
<span class="line-added">+     // Sets BigInt</span>
<span class="line-added">+     void emitSetBigInt(CCallHelpers&amp;) const;</span>
<span class="line-added">+     bool shouldEmitSetBigInt() const;</span>
<span class="line-added">+ </span>
<span class="line-added">+     void emitUnconditionalSet(CCallHelpers&amp;, BitfieldType) const;</span>
<span class="line-added">+ #endif // ENABLE(JIT)</span>
<span class="line-added">+ </span>
<span class="line-added">+     constexpr uint32_t bits() const { return m_bits; }</span>
<span class="line-added">+ </span>
<span class="line-added">+ protected:</span>
      ArithProfile() = default;
  
<span class="line-modified">!     bool hasBits(int mask) const { return m_bits &amp; mask; }</span>
<span class="line-added">+     void setBit(int mask) { m_bits |= mask; }</span>
<span class="line-added">+ </span>
<span class="line-added">+     BitfieldType m_bits { 0 }; // We take care to update m_bits only in a single operation. We don&#39;t ever store an inconsistent bit representation to it.</span>
<span class="line-added">+ };</span>
<span class="line-added">+ </span>
<span class="line-added">+ /* This class stores the following components in 16 bits:</span>
<span class="line-added">+  * - ObservedResults</span>
<span class="line-added">+  * - ObservedType for the argument</span>
<span class="line-added">+  */</span>
<span class="line-added">+ using UnaryArithProfileBase = uint16_t;</span>
<span class="line-added">+ class UnaryArithProfile : public ArithProfile&lt;UnaryArithProfileBase&gt; {</span>
<span class="line-added">+     static constexpr unsigned argObservedTypeShift = ObservedResults::numBitsNeeded;</span>
<span class="line-added">+ </span>
<span class="line-added">+     static_assert(argObservedTypeShift + ObservedType::numBitsNeeded &lt;= sizeof(UnaryArithProfileBase) * 8, &quot;Should fit in a the type of the underlying bitfield.&quot;);</span>
<span class="line-added">+ </span>
<span class="line-added">+     static constexpr UnaryArithProfileBase clearArgObservedTypeBitMask = static_cast&lt;UnaryArithProfileBase&gt;(~(0b111 &lt;&lt; argObservedTypeShift));</span>
<span class="line-added">+ </span>
<span class="line-added">+     static constexpr UnaryArithProfileBase observedTypeMask = (1 &lt;&lt; ObservedType::numBitsNeeded) - 1;</span>
<span class="line-added">+ </span>
<span class="line-added">+ public:</span>
<span class="line-added">+     UnaryArithProfile()</span>
<span class="line-added">+         : ArithProfile&lt;UnaryArithProfileBase&gt;()</span>
      {
<span class="line-modified">!         ASSERT(argObservedType().isEmpty());</span>
<span class="line-added">+         ASSERT(argObservedType().isEmpty());</span>
      }
  
<span class="line-modified">!     static constexpr UnaryArithProfileBase observedIntBits()</span>
      {
          constexpr ObservedType observedInt32 { ObservedType().withInt32() };
<span class="line-modified">!         constexpr UnaryArithProfileBase bits = observedInt32.bits() &lt;&lt; argObservedTypeShift;</span>
<span class="line-modified">!         return bits;</span>
      }
<span class="line-modified">!     static constexpr UnaryArithProfileBase observedNumberBits()</span>
      {
          constexpr ObservedType observedNumber { ObservedType().withNumber() };
<span class="line-modified">!         constexpr UnaryArithProfileBase bits = observedNumber.bits() &lt;&lt; argObservedTypeShift;</span>
<span class="line-modified">!         return bits;</span>
<span class="line-modified">!     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     constexpr ObservedType argObservedType() const { return ObservedType((m_bits &gt;&gt; argObservedTypeShift) &amp; observedTypeMask); }</span>
<span class="line-added">+     void setArgObservedType(ObservedType type)</span>
<span class="line-added">+     {</span>
<span class="line-added">+         UnaryArithProfileBase bits = m_bits;</span>
<span class="line-added">+         bits &amp;= clearArgObservedTypeBitMask;</span>
<span class="line-added">+         bits |= type.bits() &lt;&lt; argObservedTypeShift;</span>
<span class="line-added">+         m_bits = bits;</span>
<span class="line-added">+         ASSERT(argObservedType() == type);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     void argSawInt32() { setArgObservedType(argObservedType().withInt32()); }</span>
<span class="line-added">+     void argSawNumber() { setArgObservedType(argObservedType().withNumber()); }</span>
<span class="line-added">+     void argSawNonNumber() { setArgObservedType(argObservedType().withNonNumber()); }</span>
<span class="line-added">+ </span>
<span class="line-added">+     void observeArg(JSValue arg)</span>
<span class="line-added">+     {</span>
<span class="line-added">+         UnaryArithProfile newProfile = *this;</span>
<span class="line-added">+         if (arg.isNumber()) {</span>
<span class="line-added">+             if (arg.isInt32())</span>
<span class="line-added">+                 newProfile.argSawInt32();</span>
<span class="line-added">+             else</span>
<span class="line-added">+                 newProfile.argSawNumber();</span>
<span class="line-added">+         } else</span>
<span class="line-added">+             newProfile.argSawNonNumber();</span>
<span class="line-added">+ </span>
<span class="line-added">+         m_bits = newProfile.bits();</span>
      }
<span class="line-modified">! </span>
<span class="line-added">+     bool isObservedTypeEmpty()</span>
<span class="line-added">+     {</span>
<span class="line-added">+         return argObservedType().isEmpty();</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     friend class JSC::LLIntOffsetsExtractor;</span>
<span class="line-added">+ };</span>
<span class="line-added">+ </span>
<span class="line-added">+ /* This class stores the following components in 16 bits:</span>
<span class="line-added">+  * - ObservedResults</span>
<span class="line-added">+  * - ObservedType for right-hand-side</span>
<span class="line-added">+  * - ObservedType for left-hand-side</span>
<span class="line-added">+  * - a bit used by division to indicate whether a special fast path was taken</span>
<span class="line-added">+  */</span>
<span class="line-added">+ using BinaryArithProfileBase = uint16_t;</span>
<span class="line-added">+ class BinaryArithProfile : public ArithProfile&lt;BinaryArithProfileBase&gt; {</span>
<span class="line-added">+     static constexpr uint32_t rhsObservedTypeShift = ObservedResults::numBitsNeeded;</span>
<span class="line-added">+     static constexpr uint32_t lhsObservedTypeShift = rhsObservedTypeShift + ObservedType::numBitsNeeded;</span>
<span class="line-added">+ </span>
<span class="line-added">+     static_assert(ObservedType::numBitsNeeded == 3, &quot;We make a hard assumption about that here.&quot;);</span>
<span class="line-added">+     static constexpr BinaryArithProfileBase clearRhsObservedTypeBitMask = static_cast&lt;BinaryArithProfileBase&gt;(~(0b111 &lt;&lt; rhsObservedTypeShift));</span>
<span class="line-added">+     static constexpr BinaryArithProfileBase clearLhsObservedTypeBitMask = static_cast&lt;BinaryArithProfileBase&gt;(~(0b111 &lt;&lt; lhsObservedTypeShift));</span>
<span class="line-added">+ </span>
<span class="line-added">+     static constexpr BinaryArithProfileBase observedTypeMask = (1 &lt;&lt; ObservedType::numBitsNeeded) - 1;</span>
<span class="line-added">+ </span>
<span class="line-added">+ public:</span>
<span class="line-added">+     static constexpr BinaryArithProfileBase specialFastPathBit = 1 &lt;&lt; (lhsObservedTypeShift + ObservedType::numBitsNeeded);</span>
<span class="line-added">+     static_assert((lhsObservedTypeShift + ObservedType::numBitsNeeded + 1) &lt;= sizeof(BinaryArithProfileBase) * 8, &quot;Should fit in a uint32_t.&quot;);</span>
<span class="line-added">+     static_assert(!(specialFastPathBit &amp; ~clearLhsObservedTypeBitMask), &quot;These bits should not intersect.&quot;);</span>
<span class="line-added">+     static_assert(specialFastPathBit &amp; clearLhsObservedTypeBitMask, &quot;These bits should intersect.&quot;);</span>
<span class="line-added">+     static_assert(static_cast&lt;unsigned&gt;(specialFastPathBit) &gt; static_cast&lt;unsigned&gt;(static_cast&lt;BinaryArithProfileBase&gt;(~clearLhsObservedTypeBitMask)), &quot;These bits should not intersect and specialFastPathBit should be a higher bit.&quot;);</span>
<span class="line-added">+ </span>
<span class="line-added">+     BinaryArithProfile()</span>
<span class="line-added">+         : ArithProfile&lt;BinaryArithProfileBase&gt; ()</span>
<span class="line-added">+     {</span>
<span class="line-added">+         ASSERT(lhsObservedType().isEmpty());</span>
<span class="line-added">+         ASSERT(rhsObservedType().isEmpty());</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     static constexpr BinaryArithProfileBase observedIntIntBits()</span>
      {
          constexpr ObservedType observedInt32 { ObservedType().withInt32() };
<span class="line-modified">!         constexpr BinaryArithProfileBase bits = (observedInt32.bits() &lt;&lt; lhsObservedTypeShift) | (observedInt32.bits() &lt;&lt; rhsObservedTypeShift);</span>
<span class="line-modified">!         return bits;</span>
      }
<span class="line-modified">!     static constexpr BinaryArithProfileBase observedNumberIntBits()</span>
      {
          constexpr ObservedType observedNumber { ObservedType().withNumber() };
          constexpr ObservedType observedInt32 { ObservedType().withInt32() };
<span class="line-modified">!         constexpr BinaryArithProfileBase bits = (observedNumber.bits() &lt;&lt; lhsObservedTypeShift) | (observedInt32.bits() &lt;&lt; rhsObservedTypeShift);</span>
<span class="line-modified">!         return bits;</span>
      }
<span class="line-modified">!     static constexpr BinaryArithProfileBase observedIntNumberBits()</span>
      {
          constexpr ObservedType observedNumber { ObservedType().withNumber() };
          constexpr ObservedType observedInt32 { ObservedType().withInt32() };
<span class="line-modified">!         constexpr BinaryArithProfileBase bits = (observedInt32.bits() &lt;&lt; lhsObservedTypeShift) | (observedNumber.bits() &lt;&lt; rhsObservedTypeShift);</span>
<span class="line-modified">!         return bits;</span>
      }
<span class="line-modified">!     static constexpr BinaryArithProfileBase observedNumberNumberBits()</span>
      {
          constexpr ObservedType observedNumber { ObservedType().withNumber() };
<span class="line-modified">!         constexpr BinaryArithProfileBase bits = (observedNumber.bits() &lt;&lt; lhsObservedTypeShift) | (observedNumber.bits() &lt;&lt; rhsObservedTypeShift);</span>
<span class="line-modified">!         return bits;</span>
      }
  
      constexpr ObservedType lhsObservedType() const { return ObservedType((m_bits &gt;&gt; lhsObservedTypeShift) &amp; observedTypeMask); }
      constexpr ObservedType rhsObservedType() const { return ObservedType((m_bits &gt;&gt; rhsObservedTypeShift) &amp; observedTypeMask); }
      void setLhsObservedType(ObservedType type)
      {
<span class="line-modified">!         BinaryArithProfileBase bits = m_bits;</span>
          bits &amp;= clearLhsObservedTypeBitMask;
          bits |= type.bits() &lt;&lt; lhsObservedTypeShift;
          m_bits = bits;
          ASSERT(lhsObservedType() == type);
      }
  
      void setRhsObservedType(ObservedType type)
      {
<span class="line-modified">!         BinaryArithProfileBase bits = m_bits;</span>
          bits &amp;= clearRhsObservedTypeBitMask;
          bits |= type.bits() &lt;&lt; rhsObservedTypeShift;
          m_bits = bits;
          ASSERT(rhsObservedType() == type);
      }
  
      bool tookSpecialFastPath() const { return m_bits &amp; specialFastPathBit; }
  
      void lhsSawInt32() { setLhsObservedType(lhsObservedType().withInt32()); }
      void lhsSawNumber() { setLhsObservedType(lhsObservedType().withNumber()); }
      void lhsSawNonNumber() { setLhsObservedType(lhsObservedType().withNonNumber()); }
      void rhsSawInt32() { setRhsObservedType(rhsObservedType().withInt32()); }
      void rhsSawNumber() { setRhsObservedType(rhsObservedType().withNumber()); }
      void rhsSawNonNumber() { setRhsObservedType(rhsObservedType().withNonNumber()); }
  
      void observeLHS(JSValue lhs)
      {
<span class="line-modified">!         BinaryArithProfile newProfile = *this;</span>
          if (lhs.isNumber()) {
              if (lhs.isInt32())
                  newProfile.lhsSawInt32();
              else
                  newProfile.lhsSawNumber();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 252,11 ***</span>
  
      void observeLHSAndRHS(JSValue lhs, JSValue rhs)
      {
          observeLHS(lhs);
  
<span class="line-modified">!         ArithProfile newProfile = *this;</span>
          if (rhs.isNumber()) {
              if (rhs.isInt32())
                  newProfile.rhsSawInt32();
              else
                  newProfile.rhsSawNumber();
<span class="line-new-header">--- 341,11 ---</span>
  
      void observeLHSAndRHS(JSValue lhs, JSValue rhs)
      {
          observeLHS(lhs);
  
<span class="line-modified">!         BinaryArithProfile newProfile = *this;</span>
          if (rhs.isNumber()) {
              if (rhs.isInt32())
                  newProfile.rhsSawInt32();
              else
                  newProfile.rhsSawNumber();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 264,57 ***</span>
              newProfile.rhsSawNonNumber();
  
          m_bits = newProfile.bits();
      }
  
<span class="line-modified">! #if ENABLE(JIT)</span>
<span class="line-removed">-     // Sets (Int32Overflow | Int52Overflow | NonNegZeroDouble | NegZeroDouble) if it sees a</span>
<span class="line-removed">-     // double. Sets NonNumeric if it sees a non-numeric.</span>
<span class="line-removed">-     void emitObserveResult(CCallHelpers&amp;, JSValueRegs, TagRegistersMode = HaveTagRegisters);</span>
<span class="line-removed">- </span>
<span class="line-removed">-     // Sets (Int32Overflow | Int52Overflow | NonNegZeroDouble | NegZeroDouble).</span>
<span class="line-removed">-     bool shouldEmitSetDouble() const;</span>
<span class="line-removed">-     void emitSetDouble(CCallHelpers&amp;) const;</span>
<span class="line-removed">- </span>
<span class="line-removed">-     // Sets NonNumber.</span>
<span class="line-removed">-     void emitSetNonNumeric(CCallHelpers&amp;) const;</span>
<span class="line-removed">-     bool shouldEmitSetNonNumeric() const;</span>
<span class="line-removed">- </span>
<span class="line-removed">-     // Sets BigInt</span>
<span class="line-removed">-     void emitSetBigInt(CCallHelpers&amp;) const;</span>
<span class="line-removed">-     bool shouldEmitSetBigInt() const;</span>
<span class="line-removed">- #endif // ENABLE(JIT)</span>
<span class="line-removed">- </span>
<span class="line-removed">-     constexpr uint32_t bits() const { return m_bits; }</span>
<span class="line-removed">- </span>
<span class="line-removed">- private:</span>
<span class="line-removed">-     constexpr explicit ArithProfile(ConstantTag, uint32_t bits)</span>
<span class="line-removed">-         : m_bits(bits)</span>
<span class="line-removed">-     {</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     constexpr ArithProfile(ConstantTag, ResultType arg)</span>
<span class="line-removed">-         : m_bits(arg.bits() &lt;&lt; lhsResultTypeShift)</span>
<span class="line-removed">-     {</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     constexpr ArithProfile(ConstantTag, ResultType lhs, ResultType rhs)</span>
<span class="line-removed">-         : m_bits((lhs.bits() &lt;&lt; lhsResultTypeShift) | (rhs.bits() &lt;&lt; rhsResultTypeShift))</span>
      {
      }
  
<span class="line-removed">-     bool hasBits(int mask) const { return m_bits &amp; mask; }</span>
<span class="line-removed">-     void setBit(int mask) { m_bits |= mask; }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     uint32_t m_bits { 0 }; // We take care to update m_bits only in a single operation. We don&#39;t ever store an inconsistent bit representation to it.</span>
<span class="line-removed">- </span>
      friend class JSC::LLIntOffsetsExtractor;
  };
  
  } // namespace JSC
  
  namespace WTF {
  
<span class="line-modified">! void printInternal(PrintStream&amp;, const JSC::ArithProfile&amp;);</span>
  void printInternal(PrintStream&amp;, const JSC::ObservedType&amp;);
  
  } // namespace WTF
<span class="line-new-header">--- 353,22 ---</span>
              newProfile.rhsSawNonNumber();
  
          m_bits = newProfile.bits();
      }
  
<span class="line-modified">!     bool isObservedTypeEmpty()</span>
      {
<span class="line-added">+         return lhsObservedType().isEmpty() &amp;&amp; rhsObservedType().isEmpty();</span>
      }
  
      friend class JSC::LLIntOffsetsExtractor;
  };
  
  } // namespace JSC
  
  namespace WTF {
  
<span class="line-modified">! void printInternal(PrintStream&amp;, const JSC::UnaryArithProfile&amp;);</span>
<span class="line-added">+ void printInternal(PrintStream&amp;, const JSC::BinaryArithProfile&amp;);</span>
  void printInternal(PrintStream&amp;, const JSC::ObservedType&amp;);
  
  } // namespace WTF
</pre>
<center><a href="ArithProfile.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="ByValInfo.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>