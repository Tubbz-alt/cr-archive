<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WebCore/storage/StorageQuotaManager.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="StorageNamespaceProvider.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="StorageQuotaManager.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/storage/StorageQuotaManager.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -25,187 +25,122 @@</span>
  
  #include &quot;config.h&quot;
  #include &quot;StorageQuotaManager.h&quot;
  
  #include &quot;Logging.h&quot;
<span class="udiff-line-modified-removed">- #include &quot;StorageQuotaUser.h&quot;</span>
<span class="udiff-line-modified-added">+ #include &lt;wtf/Ref.h&gt;</span>
<span class="udiff-line-added">+ #include &lt;wtf/RefCounted.h&gt;</span>
<span class="udiff-line-added">+ #include &lt;wtf/threads/BinarySemaphore.h&gt;</span>
  
  namespace WebCore {
  
<span class="udiff-line-modified-removed">- StorageQuotaManager::~StorageQuotaManager()</span>
<span class="udiff-line-modified-added">+ Ref&lt;StorageQuotaManager&gt; StorageQuotaManager::create(uint64_t quota, UsageGetter&amp;&amp; usageGetter, QuotaIncreaseRequester&amp;&amp; quotaIncreaseRequester)</span>
  {
<span class="udiff-line-modified-removed">-     while (!m_pendingRequests.isEmpty())</span>
<span class="udiff-line-removed">-         m_pendingRequests.takeFirst().callback(Decision::Deny);</span>
<span class="udiff-line-modified-added">+     return adoptRef(*new StorageQuotaManager(quota, WTFMove(usageGetter), WTFMove(quotaIncreaseRequester)));</span>
  }
  
<span class="udiff-line-modified-removed">- uint64_t StorageQuotaManager::spaceUsage() const</span>
<span class="udiff-line-modified-added">+ StorageQuotaManager::StorageQuotaManager(uint64_t quota, UsageGetter&amp;&amp; usageGetter, QuotaIncreaseRequester&amp;&amp; quotaIncreaseRequester)</span>
<span class="udiff-line-added">+     : m_quota(quota)</span>
<span class="udiff-line-added">+     , m_usageGetter(WTFMove(usageGetter))</span>
<span class="udiff-line-added">+     , m_quotaIncreaseRequester(WTFMove(quotaIncreaseRequester))</span>
<span class="udiff-line-added">+     , m_workQueue(WorkQueue::create(&quot;StorageQuotaManager Background Queue&quot;, WorkQueue::Type::Serial))</span>
<span class="udiff-line-added">+     , m_initialQuota(quota)</span>
  {
<span class="udiff-line-removed">-     uint64_t usage = 0;</span>
<span class="udiff-line-removed">-     for (auto&amp; user : m_users)</span>
<span class="udiff-line-removed">-         usage += user-&gt;spaceUsed();</span>
<span class="udiff-line-removed">-     return usage;</span>
  }
  
<span class="udiff-line-modified-removed">- void StorageQuotaManager::updateQuotaBasedOnSpaceUsage()</span>
<span class="udiff-line-modified-added">+ void StorageQuotaManager::requestSpaceOnMainThread(uint64_t spaceRequested, RequestCallback&amp;&amp; callback)</span>
  {
<span class="udiff-line-modified-removed">-     if (!m_quota)</span>
<span class="udiff-line-removed">-         return;</span>
<span class="udiff-line-modified-added">+     ASSERT(isMainThread());</span>
  
<span class="udiff-line-modified-removed">-     auto defaultQuotaStep = m_quota / 10;</span>
<span class="udiff-line-modified-removed">-     m_quota = std::max(m_quota, defaultQuotaStep * ((spaceUsage() / defaultQuotaStep) + 1));</span>
<span class="udiff-line-modified-removed">- }</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">- void StorageQuotaManager::initializeUsersIfNeeded()</span>
<span class="udiff-line-modified-removed">- {</span>
<span class="udiff-line-removed">-     if (m_pendingInitializationUsers.isEmpty())</span>
<span class="udiff-line-removed">-         return;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     Vector&lt;StorageQuotaUser*&gt; usersToInitialize;</span>
<span class="udiff-line-removed">-     for (auto&amp; keyValue : m_pendingInitializationUsers) {</span>
<span class="udiff-line-removed">-         if (keyValue.value == WhenInitializedCalled::No) {</span>
<span class="udiff-line-removed">-             keyValue.value = WhenInitializedCalled::Yes;</span>
<span class="udiff-line-removed">-             usersToInitialize.append(keyValue.key);</span>
<span class="udiff-line-modified-added">+     // Fast path.</span>
<span class="udiff-line-modified-added">+     if (m_quotaCountDownLock.tryLock()) {</span>
<span class="udiff-line-modified-added">+         if (tryGrantRequest(spaceRequested)) {</span>
<span class="udiff-line-modified-added">+             m_quotaCountDownLock.unlock();</span>
<span class="udiff-line-modified-added">+             callback(Decision::Grant);</span>
<span class="udiff-line-modified-added">+             return;</span>
          }
<span class="udiff-line-added">+         m_quotaCountDownLock.unlock();</span>
      }
<span class="udiff-line-modified-removed">-     for (auto* user : usersToInitialize) {</span>
<span class="udiff-line-modified-removed">-         if (m_pendingInitializationUsers.contains(user))</span>
<span class="udiff-line-modified-removed">-             askUserToInitialize(*user);</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+     m_workQueue-&gt;dispatch([this, protectedThis = makeRef(*this), spaceRequested, callback = WTFMove(callback)]() mutable {</span>
<span class="udiff-line-modified-added">+         auto decision = requestSpaceOnBackgroundThread(spaceRequested);</span>
<span class="udiff-line-modified-added">+         callOnMainThread([callback = WTFMove(callback), decision]() mutable {</span>
<span class="udiff-line-added">+             callback(decision);</span>
<span class="udiff-line-added">+         });</span>
<span class="udiff-line-added">+     });</span>
  }
  
<span class="udiff-line-modified-removed">- void StorageQuotaManager::askUserToInitialize(StorageQuotaUser&amp; user)</span>
<span class="udiff-line-modified-added">+ StorageQuotaManager::Decision StorageQuotaManager::requestSpaceOnBackgroundThread(uint64_t spaceRequested)</span>
  {
<span class="udiff-line-modified-removed">-     user.whenInitialized([this, &amp;user, weakThis = makeWeakPtr(this)]() {</span>
<span class="udiff-line-removed">-         if (!weakThis)</span>
<span class="udiff-line-removed">-             return;</span>
<span class="udiff-line-modified-added">+     ASSERT(!isMainThread());</span>
  
<span class="udiff-line-modified-removed">-         if (m_pendingInitializationUsers.remove(&amp;user))</span>
<span class="udiff-line-removed">-             m_users.add(&amp;user);</span>
<span class="udiff-line-modified-added">+     LockHolder locker(m_quotaCountDownLock);</span>
  
<span class="udiff-line-modified-removed">-         if (!m_pendingInitializationUsers.isEmpty())</span>
<span class="udiff-line-modified-removed">-             return;</span>
<span class="udiff-line-modified-added">+     if (tryGrantRequest(spaceRequested))</span>
<span class="udiff-line-modified-added">+         return Decision::Grant;</span>
  
<span class="udiff-line-modified-removed">-         updateQuotaBasedOnSpaceUsage();</span>
<span class="udiff-line-modified-removed">-         processPendingRequests({ }, ShouldDequeueFirstPendingRequest::No);</span>
<span class="udiff-line-modified-removed">-     });</span>
<span class="udiff-line-modified-removed">- }</span>
<span class="udiff-line-modified-added">+     m_usage = m_usageGetter();</span>
<span class="udiff-line-modified-added">+     updateQuotaBasedOnUsage();</span>
<span class="udiff-line-modified-added">+     m_quotaCountDown = m_usage &lt; m_quota ? m_quota - m_usage : 0;</span>
<span class="udiff-line-modified-added">+     if (tryGrantRequest(spaceRequested))</span>
<span class="udiff-line-added">+         return Decision::Grant;</span>
  
<span class="udiff-line-modified-removed">- void StorageQuotaManager::addUser(StorageQuotaUser&amp; user)</span>
<span class="udiff-line-modified-removed">- {</span>
<span class="udiff-line-modified-removed">-     ASSERT(!m_pendingInitializationUsers.contains(&amp;user));</span>
<span class="udiff-line-modified-removed">-     ASSERT(!m_users.contains(&amp;user));</span>
<span class="udiff-line-modified-removed">-     m_pendingInitializationUsers.add(&amp;user, WhenInitializedCalled::No);</span>
<span class="udiff-line-modified-added">+     // Block this thread until getting decsion for quota increase.</span>
<span class="udiff-line-modified-added">+     BinarySemaphore semaphore;</span>
<span class="udiff-line-modified-added">+     callOnMainThread([this, protectedThis = makeRef(*this), spaceRequested, &amp;semaphore]() mutable {</span>
<span class="udiff-line-modified-added">+         RELEASE_LOG(Storage, &quot;%p - StorageQuotaManager asks for quota increase %&quot; PRIu64, this, spaceRequested);</span>
<span class="udiff-line-modified-added">+         m_quotaIncreaseRequester(m_quota, m_usage, spaceRequested, [this, protectedThis = WTFMove(protectedThis), &amp;semaphore](Optional&lt;uint64_t&gt; newQuota) mutable {</span>
<span class="udiff-line-added">+             RELEASE_LOG(Storage, &quot;%p - StorageQuotaManager receives quota increase response %&quot; PRIu64, this, newQuota ? *newQuota : 0);</span>
<span class="udiff-line-added">+             ASSERT(isMainThread());</span>
  
<span class="udiff-line-modified-removed">-     if (!m_pendingRequests.isEmpty())</span>
<span class="udiff-line-modified-removed">-         askUserToInitialize(user);</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-modified-added">+             if (newQuota)</span>
<span class="udiff-line-modified-added">+                 m_quota = *newQuota;</span>
  
<span class="udiff-line-modified-removed">- bool StorageQuotaManager::shouldAskForMoreSpace(uint64_t spaceIncrease) const</span>
<span class="udiff-line-modified-removed">- {</span>
<span class="udiff-line-modified-removed">-     if (!spaceIncrease)</span>
<span class="udiff-line-modified-removed">-         return false;</span>
<span class="udiff-line-modified-added">+             semaphore.signal();</span>
<span class="udiff-line-modified-added">+         });</span>
<span class="udiff-line-modified-added">+     });</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-added">+     semaphore.wait();</span>
  
<span class="udiff-line-modified-removed">-     return spaceUsage() + spaceIncrease &gt; m_quota;</span>
<span class="udiff-line-modified-added">+     m_usage = m_usageGetter();</span>
<span class="udiff-line-added">+     m_quotaCountDown = m_usage &lt; m_quota ? m_quota - m_usage : 0;</span>
<span class="udiff-line-added">+     return tryGrantRequest(spaceRequested) ? Decision::Grant : Decision::Deny;</span>
  }
  
<span class="udiff-line-modified-removed">- void StorageQuotaManager::removeUser(StorageQuotaUser&amp; user)</span>
<span class="udiff-line-modified-added">+ bool StorageQuotaManager::tryGrantRequest(uint64_t spaceRequested)</span>
  {
<span class="udiff-line-modified-removed">-     ASSERT(m_users.contains(&amp;user) || m_pendingInitializationUsers.contains(&amp;user));</span>
<span class="udiff-line-modified-removed">-     m_users.remove(&amp;user);</span>
<span class="udiff-line-modified-removed">-     if (m_pendingInitializationUsers.remove(&amp;user) &amp;&amp; m_pendingInitializationUsers.isEmpty()) {</span>
<span class="udiff-line-modified-removed">-         // When being cleared, quota users may remove themselves and add themselves to trigger reinitialization.</span>
<span class="udiff-line-removed">-         // Let&#39;s wait for addUser to be called before processing pending requests.</span>
<span class="udiff-line-removed">-         callOnMainThread([this, weakThis = makeWeakPtr(this)] {</span>
<span class="udiff-line-removed">-             if (!weakThis)</span>
<span class="udiff-line-removed">-                 return;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             if (m_pendingInitializationUsers.isEmpty())</span>
<span class="udiff-line-removed">-                 this-&gt;processPendingRequests({ }, ShouldDequeueFirstPendingRequest::No);</span>
<span class="udiff-line-removed">-         });</span>
<span class="udiff-line-modified-added">+     ASSERT(m_quotaCountDownLock.isLocked());</span>
<span class="udiff-line-modified-added">+     if (spaceRequested &lt;= m_quotaCountDown) {</span>
<span class="udiff-line-modified-added">+         m_quotaCountDown -= spaceRequested;</span>
<span class="udiff-line-modified-added">+         return true;</span>
      }
<span class="udiff-line-added">+     return false;</span>
  }
  
<span class="udiff-line-modified-removed">- void StorageQuotaManager::requestSpace(uint64_t spaceIncrease, RequestCallback&amp;&amp; callback)</span>
<span class="udiff-line-modified-added">+ void StorageQuotaManager::updateQuotaBasedOnUsage()</span>
  {
<span class="udiff-line-modified-removed">-     if (!m_pendingRequests.isEmpty()) {</span>
<span class="udiff-line-modified-removed">-         m_pendingRequests.append({ spaceIncrease, WTFMove(callback) });</span>
<span class="udiff-line-modified-removed">-         return;</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-     if (!spaceIncrease) {</span>
<span class="udiff-line-modified-removed">-         callback(Decision::Grant);</span>
<span class="udiff-line-removed">-         return;</span>
<span class="udiff-line-modified-added">+     // When StorageQuotaManager is used for the first time, we want to make sure its initial quota is bigger than current disk usage,</span>
<span class="udiff-line-modified-added">+     // based on the assumption that the quota was increased to at least the disk usage under user&#39;s permission before.</span>
<span class="udiff-line-modified-added">+     ASSERT(m_quotaCountDownLock.isLocked());</span>
<span class="udiff-line-modified-added">+     if (!m_quotaUpdatedBasedOnUsage) {</span>
<span class="udiff-line-modified-added">+         m_quotaUpdatedBasedOnUsage = true;</span>
<span class="udiff-line-modified-added">+         auto defaultQuotaStep = m_quota / 10;</span>
<span class="udiff-line-modified-added">+         m_quota = std::max(m_quota, defaultQuotaStep * ((m_usage / defaultQuotaStep) + 1));</span>
      }
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     initializeUsersIfNeeded();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     if (!m_pendingInitializationUsers.isEmpty()) {</span>
<span class="udiff-line-removed">-         m_pendingRequests.append({ spaceIncrease, WTFMove(callback) });</span>
<span class="udiff-line-removed">-         return;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     if (shouldAskForMoreSpace(spaceIncrease)) {</span>
<span class="udiff-line-removed">-         m_pendingRequests.append({ spaceIncrease, WTFMove(callback) });</span>
<span class="udiff-line-removed">-         askForMoreSpace(spaceIncrease);</span>
<span class="udiff-line-removed">-         return;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     callback(Decision::Grant);</span>
  }
  
<span class="udiff-line-modified-removed">- void StorageQuotaManager::askForMoreSpace(uint64_t spaceIncrease)</span>
<span class="udiff-line-modified-added">+ void StorageQuotaManager::resetQuotaUpdatedBasedOnUsageForTesting()</span>
  {
<span class="udiff-line-modified-removed">-     ASSERT(shouldAskForMoreSpace(spaceIncrease));</span>
<span class="udiff-line-modified-removed">-     ASSERT(!m_isWaitingForSpaceIncreaseResponse);</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-     RELEASE_LOG(Storage, &quot;%p - StorageQuotaManager::askForMoreSpace %&quot; PRIu64, this, spaceIncrease);</span>
<span class="udiff-line-removed">-     m_isWaitingForSpaceIncreaseResponse = true;</span>
<span class="udiff-line-removed">-     m_spaceIncreaseRequester(m_quota, spaceUsage(), spaceIncrease, [this, weakThis = makeWeakPtr(*this)](Optional&lt;uint64_t&gt; newQuota) {</span>
<span class="udiff-line-removed">-         if (!weakThis)</span>
<span class="udiff-line-removed">-             return;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         RELEASE_LOG(Storage, &quot;%p - StorageQuotaManager::askForMoreSpace received response %&quot; PRIu64, this, newQuota ? *newQuota : 0);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         m_isWaitingForSpaceIncreaseResponse = false;</span>
<span class="udiff-line-removed">-         processPendingRequests(newQuota, ShouldDequeueFirstPendingRequest::Yes);</span>
<span class="udiff-line-removed">-     });</span>
<span class="udiff-line-modified-added">+     LockHolder locker(m_quotaCountDownLock);</span>
<span class="udiff-line-modified-added">+     m_quota = m_initialQuota;</span>
<span class="udiff-line-modified-added">+     m_quotaCountDown = 0;</span>
<span class="udiff-line-modified-added">+     m_quotaUpdatedBasedOnUsage = false;</span>
  }
  
<span class="udiff-line-modified-removed">- void StorageQuotaManager::processPendingRequests(Optional&lt;uint64_t&gt; newQuota, ShouldDequeueFirstPendingRequest shouldDequeueFirstPendingRequest)</span>
<span class="udiff-line-modified-added">+ void StorageQuotaManager::resetQuotaForTesting()</span>
  {
<span class="udiff-line-modified-removed">-     if (m_pendingRequests.isEmpty())</span>
<span class="udiff-line-modified-removed">-         return;</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-removed">-     if (newQuota)</span>
<span class="udiff-line-removed">-         m_quota = *newQuota;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     if (m_isWaitingForSpaceIncreaseResponse)</span>
<span class="udiff-line-removed">-         return;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     if (!m_pendingInitializationUsers.isEmpty())</span>
<span class="udiff-line-removed">-         return;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     if (shouldDequeueFirstPendingRequest == ShouldDequeueFirstPendingRequest::Yes) {</span>
<span class="udiff-line-removed">-         auto request = m_pendingRequests.takeFirst();</span>
<span class="udiff-line-removed">-         bool shouldAllowRequest = !shouldAskForMoreSpace(request.spaceIncrease);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         RELEASE_LOG(Storage, &quot;%p - StorageQuotaManager::processPendingRequests first request decision is %d&quot;, this, shouldAllowRequest);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         request.callback(shouldAllowRequest ? Decision::Grant : Decision::Deny);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     while (!m_pendingRequests.isEmpty()) {</span>
<span class="udiff-line-removed">-         auto&amp; request = m_pendingRequests.first();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         if (shouldAskForMoreSpace(request.spaceIncrease)) {</span>
<span class="udiff-line-removed">-             uint64_t spaceIncrease = 0;</span>
<span class="udiff-line-removed">-             for (auto&amp; request : m_pendingRequests)</span>
<span class="udiff-line-removed">-                 spaceIncrease += request.spaceIncrease;</span>
<span class="udiff-line-removed">-             askForMoreSpace(spaceIncrease);</span>
<span class="udiff-line-removed">-             return;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         m_pendingRequests.takeFirst().callback(Decision::Grant);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-modified-added">+     LockHolder locker(m_quotaCountDownLock);</span>
<span class="udiff-line-modified-added">+     m_quota = m_initialQuota;</span>
<span class="udiff-line-modified-added">+     m_quotaCountDown = 0;</span>
  }
  
  } // namespace WebCore
</pre>
<center><a href="StorageNamespaceProvider.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="StorageQuotaManager.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>