<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.web/src/main/native/Source/WTF/wtf/URLParser.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="URLHelpers.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="UUID.cpp.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WTF/wtf/URLParser.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (C) 2016-2018 Apple Inc. All rights reserved.</span>
   *
   * Redistribution and use in source and binary forms, with or without
   * modification, are permitted provided that the following conditions
   * are met:
   * 1. Redistributions of source code must retain the above copyright
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (C) 2016-2019 Apple Inc. All rights reserved.</span>
   *
   * Redistribution and use in source and binary forms, with or without
   * modification, are permitted provided that the following conditions
   * are met:
   * 1. Redistributions of source code must retain the above copyright
</pre>
<hr />
<pre>
<span class="line-old-header">*** 650,16 ***</span>
      }
  }
  
  Optional&lt;uint16_t&gt; URLParser::defaultPortForProtocol(StringView scheme)
  {
<span class="line-modified">!     static const uint16_t ftpPort = 21;</span>
<span class="line-modified">!     static const uint16_t gopherPort = 70;</span>
<span class="line-modified">!     static const uint16_t httpPort = 80;</span>
<span class="line-modified">!     static const uint16_t httpsPort = 443;</span>
<span class="line-modified">!     static const uint16_t wsPort = 80;</span>
<span class="line-removed">-     static const uint16_t wssPort = 443;</span>
  
      auto length = scheme.length();
      if (!length)
          return WTF::nullopt;
      switch (scheme[0]) {
<span class="line-new-header">--- 650,15 ---</span>
      }
  }
  
  Optional&lt;uint16_t&gt; URLParser::defaultPortForProtocol(StringView scheme)
  {
<span class="line-modified">!     static constexpr uint16_t ftpPort = 21;</span>
<span class="line-modified">!     static constexpr uint16_t httpPort = 80;</span>
<span class="line-modified">!     static constexpr uint16_t httpsPort = 443;</span>
<span class="line-modified">!     static constexpr uint16_t wsPort = 80;</span>
<span class="line-modified">!     static constexpr uint16_t wssPort = 443;</span>
  
      auto length = scheme.length();
      if (!length)
          return WTF::nullopt;
      switch (scheme[0]) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 693,19 ***</span>
                  return httpsPort;
              return WTF::nullopt;
          default:
              return WTF::nullopt;
          }
<span class="line-removed">-     case &#39;g&#39;:</span>
<span class="line-removed">-         if (length == 6</span>
<span class="line-removed">-             &amp;&amp; scheme[1] == &#39;o&#39;</span>
<span class="line-removed">-             &amp;&amp; scheme[2] == &#39;p&#39;</span>
<span class="line-removed">-             &amp;&amp; scheme[3] == &#39;h&#39;</span>
<span class="line-removed">-             &amp;&amp; scheme[4] == &#39;e&#39;</span>
<span class="line-removed">-             &amp;&amp; scheme[5] == &#39;r&#39;)</span>
<span class="line-removed">-             return gopherPort;</span>
<span class="line-removed">-         return WTF::nullopt;</span>
      case &#39;f&#39;:
          if (length == 3
              &amp;&amp; scheme[1] == &#39;t&#39;
              &amp;&amp; scheme[2] == &#39;p&#39;)
              return ftpPort;
<span class="line-new-header">--- 692,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 721,11 ***</span>
  #endif
      WS,
      WSS,
      File,
      FTP,
<span class="line-removed">-     Gopher,</span>
      HTTP,
      HTTPS,
      NonSpecial
  };
  
<span class="line-new-header">--- 711,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 749,19 ***</span>
                  return Scheme::File;
              return Scheme::NonSpecial;
          default:
              return Scheme::NonSpecial;
          }
<span class="line-removed">-     case &#39;g&#39;:</span>
<span class="line-removed">-         if (length == 6</span>
<span class="line-removed">-             &amp;&amp; scheme[1] == &#39;o&#39;</span>
<span class="line-removed">-             &amp;&amp; scheme[2] == &#39;p&#39;</span>
<span class="line-removed">-             &amp;&amp; scheme[3] == &#39;h&#39;</span>
<span class="line-removed">-             &amp;&amp; scheme[4] == &#39;e&#39;</span>
<span class="line-removed">-             &amp;&amp; scheme[5] == &#39;r&#39;)</span>
<span class="line-removed">-             return Scheme::Gopher;</span>
<span class="line-removed">-         return Scheme::NonSpecial;</span>
      case &#39;h&#39;:
          switch (length) {
          case 4:
              if (scheme[1] == &#39;t&#39;
                  &amp;&amp; scheme[2] == &#39;t&#39;
<span class="line-new-header">--- 738,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 930,11 ***</span>
          return;
      case Scheme::File:
          m_urlIsFile = true;
          FALLTHROUGH;
      case Scheme::FTP:
<span class="line-removed">-     case Scheme::Gopher:</span>
      case Scheme::HTTP:
      case Scheme::HTTPS:
          m_urlIsSpecial = true;
          return;
      case Scheme::NonSpecial:
<span class="line-new-header">--- 910,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1180,19 ***</span>
      ASSERT(!m_url.m_isValid
          || m_didSeeSyntaxViolation == (m_url.string() != input)
          || (input.isAllSpecialCharacters&lt;isC0ControlOrSpace&gt;()
              &amp;&amp; m_url.m_string == base.m_string.left(base.m_queryEnd)));
      ASSERT(internalValuesConsistent(m_url));
<span class="line-modified">! #if !ASSERT_DISABLED</span>
      if (!m_didSeeSyntaxViolation) {
          // Force a syntax violation at the beginning to make sure we get the same result.
          URLParser parser(makeString(&quot; &quot;, input), base, nonUTF8QueryEncoding);
          URL parsed = parser.result();
          if (parsed.isValid())
              ASSERT(allValuesEqual(parser.result(), m_url));
      }
<span class="line-modified">! #endif</span>
  }
  
  template&lt;typename CharacterType&gt;
  void URLParser::parse(const CharacterType* input, const unsigned length, const URL&amp; base, const URLTextEncoding* nonUTF8QueryEncoding)
  {
<span class="line-new-header">--- 1159,19 ---</span>
      ASSERT(!m_url.m_isValid
          || m_didSeeSyntaxViolation == (m_url.string() != input)
          || (input.isAllSpecialCharacters&lt;isC0ControlOrSpace&gt;()
              &amp;&amp; m_url.m_string == base.m_string.left(base.m_queryEnd)));
      ASSERT(internalValuesConsistent(m_url));
<span class="line-modified">! #if ASSERT_ENABLED</span>
      if (!m_didSeeSyntaxViolation) {
          // Force a syntax violation at the beginning to make sure we get the same result.
          URLParser parser(makeString(&quot; &quot;, input), base, nonUTF8QueryEncoding);
          URL parsed = parser.result();
          if (parsed.isValid())
              ASSERT(allValuesEqual(parser.result(), m_url));
      }
<span class="line-modified">! #endif // ASSERT_ENABLED</span>
  }
  
  template&lt;typename CharacterType&gt;
  void URLParser::parse(const CharacterType* input, const unsigned length, const URL&amp; base, const URLTextEncoding* nonUTF8QueryEncoding)
  {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1311,11 ***</span>
                  case Scheme::HTTP:
                  case Scheme::HTTPS:
                      m_url.m_protocolIsInHTTPFamily = true;
                      FALLTHROUGH;
                  case Scheme::FTP:
<span class="line-removed">-                 case Scheme::Gopher:</span>
                      m_urlIsSpecial = true;
                      if (base.protocolIs(urlScheme))
                          state = State::SpecialRelativeOrAuthority;
                      else
                          state = State::SpecialAuthoritySlashes;
<span class="line-new-header">--- 1290,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2589,18 ***</span>
      UErrorCode error = U_ZERO_ERROR;
      UIDNAInfo processingDetails = UIDNA_INFO_INITIALIZER;
      int32_t numCharactersConverted = uidna_nameToASCII(&amp;internationalDomainNameTranscoder(), StringView(domain).upconvertedCharacters(), domain.length(), hostnameBuffer, maxDomainLength, &amp;processingDetails, &amp;error);
  
      if (U_SUCCESS(error) &amp;&amp; !processingDetails.errors) {
<span class="line-modified">! #if ASSERT_DISABLED</span>
<span class="line-removed">-         UNUSED_PARAM(numCharactersConverted);</span>
<span class="line-removed">- #else</span>
          for (int32_t i = 0; i &lt; numCharactersConverted; ++i) {
              ASSERT(isASCII(hostnameBuffer[i]));
              ASSERT(!isASCIIUpper(hostnameBuffer[i]));
          }
<span class="line-modified">! #endif</span>
          ascii.append(hostnameBuffer, numCharactersConverted);
          if (domain != StringView(ascii.data(), ascii.size()))
              syntaxViolation(iteratorForSyntaxViolationPosition);
          return ascii;
      }
<span class="line-new-header">--- 2567,18 ---</span>
      UErrorCode error = U_ZERO_ERROR;
      UIDNAInfo processingDetails = UIDNA_INFO_INITIALIZER;
      int32_t numCharactersConverted = uidna_nameToASCII(&amp;internationalDomainNameTranscoder(), StringView(domain).upconvertedCharacters(), domain.length(), hostnameBuffer, maxDomainLength, &amp;processingDetails, &amp;error);
  
      if (U_SUCCESS(error) &amp;&amp; !processingDetails.errors) {
<span class="line-modified">! #if ASSERT_ENABLED</span>
          for (int32_t i = 0; i &lt; numCharactersConverted; ++i) {
              ASSERT(isASCII(hostnameBuffer[i]));
              ASSERT(!isASCIIUpper(hostnameBuffer[i]));
          }
<span class="line-modified">! #else</span>
<span class="line-added">+         UNUSED_PARAM(numCharactersConverted);</span>
<span class="line-added">+ #endif // ASSERT_ENABLED</span>
          ascii.append(hostnameBuffer, numCharactersConverted);
          if (domain != StringView(ascii.data(), ascii.size()))
              syntaxViolation(iteratorForSyntaxViolationPosition);
          return ascii;
      }
</pre>
<center><a href="URLHelpers.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="UUID.cpp.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>