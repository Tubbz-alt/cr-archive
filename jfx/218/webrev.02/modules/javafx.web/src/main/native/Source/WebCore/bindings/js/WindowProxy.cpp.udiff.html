<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WebCore/bindings/js/WindowProxy.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="WebCoreTypedArrayController.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="WindowProxy.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/bindings/js/WindowProxy.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -30,10 +30,11 @@</span>
  #include &quot;PageGroup.h&quot;
  #include &quot;RemoteFrame.h&quot;
  #include &quot;ScriptController.h&quot;
  #include &quot;runtime_root.h&quot;
  #include &lt;JavaScriptCore/JSLock.h&gt;
<span class="udiff-line-added">+ #include &lt;JavaScriptCore/StrongInlines.h&gt;</span>
  #include &lt;JavaScriptCore/WeakGCMapInlines.h&gt;
  #include &lt;wtf/MemoryPressureHandler.h&gt;
  
  namespace WebCore {
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -51,62 +52,63 @@</span>
          GCController::singleton().garbageCollectSoon();
  }
  
  WindowProxy::WindowProxy(AbstractFrame&amp; frame)
      : m_frame(&amp;frame)
<span class="udiff-line-added">+     , m_jsWindowProxies(makeUniqueRef&lt;ProxyMap&gt;())</span>
  {
  }
  
  WindowProxy::~WindowProxy()
  {
      ASSERT(!m_frame);
<span class="udiff-line-modified-removed">-     ASSERT(m_jsWindowProxies.isEmpty());</span>
<span class="udiff-line-modified-added">+     ASSERT(m_jsWindowProxies-&gt;isEmpty());</span>
  }
  
  void WindowProxy::detachFromFrame()
  {
      ASSERT(m_frame);
  
      m_frame = nullptr;
  
      // It&#39;s likely that destroying windowProxies will create a lot of garbage.
<span class="udiff-line-modified-removed">-     if (!m_jsWindowProxies.isEmpty()) {</span>
<span class="udiff-line-modified-removed">-         while (!m_jsWindowProxies.isEmpty()) {</span>
<span class="udiff-line-modified-removed">-             auto it = m_jsWindowProxies.begin();</span>
<span class="udiff-line-modified-added">+     if (!m_jsWindowProxies-&gt;isEmpty()) {</span>
<span class="udiff-line-modified-added">+         while (!m_jsWindowProxies-&gt;isEmpty()) {</span>
<span class="udiff-line-modified-added">+             auto it = m_jsWindowProxies-&gt;begin();</span>
              it-&gt;value-&gt;window()-&gt;setConsoleClient(nullptr);
              destroyJSWindowProxy(*it-&gt;key);
          }
          collectGarbageAfterWindowProxyDestruction();
      }
  }
  
  void WindowProxy::destroyJSWindowProxy(DOMWrapperWorld&amp; world)
  {
<span class="udiff-line-modified-removed">-     ASSERT(m_jsWindowProxies.contains(&amp;world));</span>
<span class="udiff-line-modified-removed">-     m_jsWindowProxies.remove(&amp;world);</span>
<span class="udiff-line-modified-added">+     ASSERT(m_jsWindowProxies-&gt;contains(&amp;world));</span>
<span class="udiff-line-modified-added">+     m_jsWindowProxies-&gt;remove(&amp;world);</span>
      world.didDestroyWindowProxy(this);
  }
  
  JSWindowProxy&amp; WindowProxy::createJSWindowProxy(DOMWrapperWorld&amp; world)
  {
      ASSERT(m_frame);
  
<span class="udiff-line-modified-removed">-     ASSERT(!m_jsWindowProxies.contains(&amp;world));</span>
<span class="udiff-line-modified-added">+     ASSERT(!m_jsWindowProxies-&gt;contains(&amp;world));</span>
      ASSERT(m_frame-&gt;window());
  
      VM&amp; vm = world.vm();
  
      Strong&lt;JSWindowProxy&gt; jsWindowProxy(vm, &amp;JSWindowProxy::create(vm, *m_frame-&gt;window(), world));
      Strong&lt;JSWindowProxy&gt; jsWindowProxy2(jsWindowProxy);
<span class="udiff-line-modified-removed">-     m_jsWindowProxies.add(&amp;world, jsWindowProxy);</span>
<span class="udiff-line-modified-added">+     m_jsWindowProxies-&gt;add(&amp;world, jsWindowProxy);</span>
      world.didCreateWindowProxy(this);
      return *jsWindowProxy.get();
  }
  
  Vector&lt;JSC::Strong&lt;JSWindowProxy&gt;&gt; WindowProxy::jsWindowProxiesAsVector() const
  {
<span class="udiff-line-modified-removed">-     return copyToVector(m_jsWindowProxies.values());</span>
<span class="udiff-line-modified-added">+     return copyToVector(m_jsWindowProxies-&gt;values());</span>
  }
  
  JSDOMGlobalObject* WindowProxy::globalObject(DOMWrapperWorld&amp; world)
  {
      if (auto* windowProxy = jsWindowProxy(world))
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -123,13 +125,13 @@</span>
      if (is&lt;Frame&gt;(*m_frame))
          downcast&lt;Frame&gt;(*m_frame).script().initScriptForWindowProxy(windowProxy);
      return windowProxy;
  }
  
<span class="udiff-line-modified-removed">- void WindowProxy::clearJSWindowProxiesNotMatchingDOMWindow(AbstractDOMWindow* newDOMWindow, bool goingIntoPageCache)</span>
<span class="udiff-line-modified-added">+ void WindowProxy::clearJSWindowProxiesNotMatchingDOMWindow(AbstractDOMWindow* newDOMWindow, bool goingIntoBackForwardCache)</span>
  {
<span class="udiff-line-modified-removed">-     if (m_jsWindowProxies.isEmpty())</span>
<span class="udiff-line-modified-added">+     if (m_jsWindowProxies-&gt;isEmpty())</span>
          return;
  
      JSLockHolder lock(commonVM());
  
      for (auto&amp; windowProxy : jsWindowProxiesAsVector()) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -143,19 +145,19 @@</span>
              jsDOMWindow-&gt;willRemoveFromWindowProxy();
      }
  
      // It&#39;s likely that resetting our windows created a lot of garbage, unless
      // it went in a back/forward cache.
<span class="udiff-line-modified-removed">-     if (!goingIntoPageCache)</span>
<span class="udiff-line-modified-added">+     if (!goingIntoBackForwardCache)</span>
          collectGarbageAfterWindowProxyDestruction();
  }
  
  void WindowProxy::setDOMWindow(AbstractDOMWindow* newDOMWindow)
  {
      ASSERT(newDOMWindow);
  
<span class="udiff-line-modified-removed">-     if (m_jsWindowProxies.isEmpty())</span>
<span class="udiff-line-modified-added">+     if (m_jsWindowProxies-&gt;isEmpty())</span>
          return;
  
      ASSERT(m_frame);
  
      JSLockHolder lock(commonVM());
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -186,15 +188,30 @@</span>
      }
  }
  
  void WindowProxy::attachDebugger(JSC::Debugger* debugger)
  {
<span class="udiff-line-modified-removed">-     for (auto&amp; windowProxy : m_jsWindowProxies.values())</span>
<span class="udiff-line-modified-added">+     for (auto&amp; windowProxy : m_jsWindowProxies-&gt;values())</span>
          windowProxy-&gt;attachDebugger(debugger);
  }
  
  AbstractDOMWindow* WindowProxy::window() const
  {
      return m_frame ? m_frame-&gt;window() : nullptr;
  }
  
<span class="udiff-line-added">+ WindowProxy::ProxyMap::ValuesConstIteratorRange WindowProxy::jsWindowProxies() const</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     return m_jsWindowProxies-&gt;values();</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ WindowProxy::ProxyMap WindowProxy::releaseJSWindowProxies()</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     return std::exchange(m_jsWindowProxies, makeUniqueRef&lt;ProxyMap&gt;());</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void WindowProxy::setJSWindowProxies(ProxyMap&amp;&amp; windowProxies)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     m_jsWindowProxies = makeUniqueRef&lt;ProxyMap&gt;(WTFMove(windowProxies));</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  } // namespace WebCore
</pre>
<center><a href="WebCoreTypedArrayController.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="WindowProxy.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>