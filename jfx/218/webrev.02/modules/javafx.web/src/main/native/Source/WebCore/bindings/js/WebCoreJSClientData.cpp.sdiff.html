<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WebCore/bindings/js/WebCoreJSClientData.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="WebCoreBuiltinNames.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="WebCoreJSClientData.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/bindings/js/WebCoreJSClientData.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 11  *    documentation and/or other materials provided with the distribution.
 12  *
 13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. ``AS IS&#39;&#39; AND ANY
 14  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 15  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 16  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE INC. OR
 17  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 18  * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 19  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 20  * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 21  * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 22  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 23  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #include &quot;config.h&quot;
 27 #include &quot;WebCoreJSClientData.h&quot;
 28 
 29 #include &quot;DOMGCOutputConstraint.h&quot;
 30 #include &quot;JSDOMBinding.h&quot;










 31 #include &lt;JavaScriptCore/FastMallocAlignedMemoryAllocator.h&gt;
 32 #include &lt;JavaScriptCore/HeapInlines.h&gt;

 33 #include &lt;JavaScriptCore/JSDestructibleObjectHeapCellType.h&gt;
 34 #include &lt;JavaScriptCore/MarkingConstraint.h&gt;
 35 #include &lt;JavaScriptCore/SubspaceInlines.h&gt;
 36 #include &lt;JavaScriptCore/VM.h&gt;

 37 #include &quot;runtime_method.h&quot;

 38 #include &lt;wtf/MainThread.h&gt;
 39 
 40 namespace WebCore {
 41 using namespace JSC;
 42 
 43 JSVMClientData::JSVMClientData(VM&amp; vm)
 44     : m_builtinFunctions(vm)
 45     , m_builtinNames(vm)
<span class="line-modified"> 46     , m_runtimeMethodSpace ISO_SUBSPACE_INIT(vm.heap, vm.destructibleObjectHeapCellType.get(), RuntimeMethod) // Hash:0xf70c4a85</span>































 47     , m_outputConstraintSpace(&quot;WebCore Wrapper w/ Output Constraint&quot;, vm.heap, vm.destructibleObjectHeapCellType.get(), vm.fastMallocAllocator.get()) // Hash:0x7724c2e4
<span class="line-removed"> 48     , m_globalObjectOutputConstraintSpace(&quot;WebCore Global Object w/ Output Constraint&quot;, vm.heap, vm.cellHeapCellType.get(), vm.fastMallocAllocator.get()) // Hash:0x522d6ec9</span>
 49 {
 50 }
 51 
 52 JSVMClientData::~JSVMClientData()
 53 {
 54     ASSERT(m_worldSet.contains(m_normalWorld.get()));
 55     ASSERT(m_worldSet.size() == 1);
 56     ASSERT(m_normalWorld-&gt;hasOneRef());
 57     m_normalWorld = nullptr;
 58     ASSERT(m_worldSet.isEmpty());
 59 }
 60 
 61 void JSVMClientData::getAllWorlds(Vector&lt;Ref&lt;DOMWrapperWorld&gt;&gt;&amp; worlds)
 62 {
 63     ASSERT(worlds.isEmpty());
 64 
 65     worlds.reserveInitialCapacity(m_worldSet.size());
<span class="line-modified"> 66     for (auto it = m_worldSet.begin(), end = m_worldSet.end(); it != end; ++it)</span>
<span class="line-modified"> 67         worlds.uncheckedAppend(*(*it));</span>

























 68 }
 69 
 70 void JSVMClientData::initNormalWorld(VM* vm)
 71 {
 72     JSVMClientData* clientData = new JSVMClientData(*vm);
 73     vm-&gt;clientData = clientData; // ~VM deletes this pointer.
 74 
 75     vm-&gt;heap.addMarkingConstraint(makeUnique&lt;DOMGCOutputConstraint&gt;(*vm, *clientData));
 76 
<span class="line-modified"> 77     clientData-&gt;m_normalWorld = DOMWrapperWorld::create(*vm, true);</span>
 78     vm-&gt;m_typedArrayController = adoptRef(new WebCoreTypedArrayController());
 79 }
 80 
 81 } // namespace WebCore
 82 
</pre>
</td>
<td>
<hr />
<pre>
 11  *    documentation and/or other materials provided with the distribution.
 12  *
 13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. ``AS IS&#39;&#39; AND ANY
 14  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 15  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 16  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE INC. OR
 17  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 18  * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 19  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 20  * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 21  * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 22  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 23  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #include &quot;config.h&quot;
 27 #include &quot;WebCoreJSClientData.h&quot;
 28 
 29 #include &quot;DOMGCOutputConstraint.h&quot;
 30 #include &quot;JSDOMBinding.h&quot;
<span class="line-added"> 31 #include &quot;JSDOMBuiltinConstructorBase.h&quot;</span>
<span class="line-added"> 32 #include &quot;JSDOMWindow.h&quot;</span>
<span class="line-added"> 33 #include &quot;JSDOMWindowProperties.h&quot;</span>
<span class="line-added"> 34 #include &quot;JSDedicatedWorkerGlobalScope.h&quot;</span>
<span class="line-added"> 35 #include &quot;JSPaintWorkletGlobalScope.h&quot;</span>
<span class="line-added"> 36 #include &quot;JSRemoteDOMWindow.h&quot;</span>
<span class="line-added"> 37 #include &quot;JSServiceWorkerGlobalScope.h&quot;</span>
<span class="line-added"> 38 #include &quot;JSWindowProxy.h&quot;</span>
<span class="line-added"> 39 #include &quot;JSWorkerGlobalScope.h&quot;</span>
<span class="line-added"> 40 #include &quot;JSWorkletGlobalScope.h&quot;</span>
 41 #include &lt;JavaScriptCore/FastMallocAlignedMemoryAllocator.h&gt;
 42 #include &lt;JavaScriptCore/HeapInlines.h&gt;
<span class="line-added"> 43 #include &lt;JavaScriptCore/IsoHeapCellType.h&gt;</span>
 44 #include &lt;JavaScriptCore/JSDestructibleObjectHeapCellType.h&gt;
 45 #include &lt;JavaScriptCore/MarkingConstraint.h&gt;
 46 #include &lt;JavaScriptCore/SubspaceInlines.h&gt;
 47 #include &lt;JavaScriptCore/VM.h&gt;
<span class="line-added"> 48 #include &quot;runtime_array.h&quot;</span>
 49 #include &quot;runtime_method.h&quot;
<span class="line-added"> 50 #include &quot;runtime_object.h&quot;</span>
 51 #include &lt;wtf/MainThread.h&gt;
 52 
 53 namespace WebCore {
 54 using namespace JSC;
 55 
 56 JSVMClientData::JSVMClientData(VM&amp; vm)
 57     : m_builtinFunctions(vm)
 58     , m_builtinNames(vm)
<span class="line-modified"> 59     , m_runtimeArrayHeapCellType(JSC::IsoHeapCellType::create&lt;RuntimeArray&gt;())</span>
<span class="line-added"> 60     , m_runtimeObjectHeapCellType(JSC::IsoHeapCellType::create&lt;JSC::Bindings::RuntimeObject&gt;())</span>
<span class="line-added"> 61     , m_windowProxyHeapCellType(JSC::IsoHeapCellType::create&lt;JSWindowProxy&gt;())</span>
<span class="line-added"> 62     , m_heapCellTypeForJSDOMWindow(JSC::IsoHeapCellType::create&lt;JSDOMWindow&gt;())</span>
<span class="line-added"> 63     , m_heapCellTypeForJSDedicatedWorkerGlobalScope(JSC::IsoHeapCellType::create&lt;JSDedicatedWorkerGlobalScope&gt;())</span>
<span class="line-added"> 64     , m_heapCellTypeForJSRemoteDOMWindow(JSC::IsoHeapCellType::create&lt;JSRemoteDOMWindow&gt;())</span>
<span class="line-added"> 65     , m_heapCellTypeForJSWorkerGlobalScope(JSC::IsoHeapCellType::create&lt;JSWorkerGlobalScope&gt;())</span>
<span class="line-added"> 66 #if ENABLE(SERVICE_WORKER)</span>
<span class="line-added"> 67     , m_heapCellTypeForJSServiceWorkerGlobalScope(JSC::IsoHeapCellType::create&lt;JSServiceWorkerGlobalScope&gt;())</span>
<span class="line-added"> 68 #endif</span>
<span class="line-added"> 69 #if ENABLE(CSS_PAINTING_API)</span>
<span class="line-added"> 70     , m_heapCellTypeForJSPaintWorkletGlobalScope(JSC::IsoHeapCellType::create&lt;JSPaintWorkletGlobalScope&gt;())</span>
<span class="line-added"> 71     , m_heapCellTypeForJSWorkletGlobalScope(JSC::IsoHeapCellType::create&lt;JSWorkletGlobalScope&gt;())</span>
<span class="line-added"> 72 #endif</span>
<span class="line-added"> 73     , m_domBuiltinConstructorSpace ISO_SUBSPACE_INIT(vm.heap, vm.cellHeapCellType.get(), JSDOMBuiltinConstructorBase)</span>
<span class="line-added"> 74     , m_domConstructorSpace ISO_SUBSPACE_INIT(vm.heap, vm.cellHeapCellType.get(), JSDOMConstructorBase)</span>
<span class="line-added"> 75     , m_domWindowPropertiesSpace ISO_SUBSPACE_INIT(vm.heap, vm.cellHeapCellType.get(), JSDOMWindowProperties)</span>
<span class="line-added"> 76     , m_runtimeArraySpace ISO_SUBSPACE_INIT(vm.heap, m_runtimeArrayHeapCellType.get(), RuntimeArray)</span>
<span class="line-added"> 77     , m_runtimeMethodSpace ISO_SUBSPACE_INIT(vm.heap, vm.cellHeapCellType.get(), RuntimeMethod) // Hash:0xf70c4a85</span>
<span class="line-added"> 78     , m_runtimeObjectSpace ISO_SUBSPACE_INIT(vm.heap, m_runtimeObjectHeapCellType.get(), JSC::Bindings::RuntimeObject)</span>
<span class="line-added"> 79     , m_windowProxySpace ISO_SUBSPACE_INIT(vm.heap, m_windowProxyHeapCellType.get(), JSWindowProxy)</span>
<span class="line-added"> 80     , m_subspaceForJSDOMWindow ISO_SUBSPACE_INIT(vm.heap, m_heapCellTypeForJSDOMWindow.get(), JSDOMWindow)</span>
<span class="line-added"> 81     , m_subspaceForJSDedicatedWorkerGlobalScope ISO_SUBSPACE_INIT(vm.heap, m_heapCellTypeForJSDedicatedWorkerGlobalScope.get(), JSDedicatedWorkerGlobalScope)</span>
<span class="line-added"> 82     , m_subspaceForJSRemoteDOMWindow ISO_SUBSPACE_INIT(vm.heap, m_heapCellTypeForJSRemoteDOMWindow.get(), JSRemoteDOMWindow)</span>
<span class="line-added"> 83     , m_subspaceForJSWorkerGlobalScope ISO_SUBSPACE_INIT(vm.heap, m_heapCellTypeForJSWorkerGlobalScope.get(), JSWorkerGlobalScope)</span>
<span class="line-added"> 84 #if ENABLE(SERVICE_WORKER)</span>
<span class="line-added"> 85     , m_subspaceForJSServiceWorkerGlobalScope ISO_SUBSPACE_INIT(vm.heap, m_heapCellTypeForJSServiceWorkerGlobalScope.get(), JSServiceWorkerGlobalScope)</span>
<span class="line-added"> 86 #endif</span>
<span class="line-added"> 87 #if ENABLE(CSS_PAINTING_API)</span>
<span class="line-added"> 88     , m_subspaceForJSPaintWorkletGlobalScope ISO_SUBSPACE_INIT(vm.heap, m_heapCellTypeForJSPaintWorkletGlobalScope.get(), JSPaintWorkletGlobalScope)</span>
<span class="line-added"> 89     , m_subspaceForJSWorkletGlobalScope ISO_SUBSPACE_INIT(vm.heap, m_heapCellTypeForJSWorkletGlobalScope.get(), JSWorkletGlobalScope)</span>
<span class="line-added"> 90 #endif</span>
 91     , m_outputConstraintSpace(&quot;WebCore Wrapper w/ Output Constraint&quot;, vm.heap, vm.destructibleObjectHeapCellType.get(), vm.fastMallocAllocator.get()) // Hash:0x7724c2e4

 92 {
 93 }
 94 
 95 JSVMClientData::~JSVMClientData()
 96 {
 97     ASSERT(m_worldSet.contains(m_normalWorld.get()));
 98     ASSERT(m_worldSet.size() == 1);
 99     ASSERT(m_normalWorld-&gt;hasOneRef());
100     m_normalWorld = nullptr;
101     ASSERT(m_worldSet.isEmpty());
102 }
103 
104 void JSVMClientData::getAllWorlds(Vector&lt;Ref&lt;DOMWrapperWorld&gt;&gt;&amp; worlds)
105 {
106     ASSERT(worlds.isEmpty());
107 
108     worlds.reserveInitialCapacity(m_worldSet.size());
<span class="line-modified">109 </span>
<span class="line-modified">110     // It is necessary to order the `DOMWrapperWorld`s because certain callers expect the main world</span>
<span class="line-added">111     // to be the first item in the list, as they use the main world as an indicator of when the page</span>
<span class="line-added">112     // is ready to start evaluating JavaScript. For example, Web Inspector waits for the main world</span>
<span class="line-added">113     // change to clear any injected scripts and debugger/breakpoint state.</span>
<span class="line-added">114 </span>
<span class="line-added">115     auto&amp; mainNormalWorld = mainThreadNormalWorld();</span>
<span class="line-added">116 </span>
<span class="line-added">117     // Add main normal world.</span>
<span class="line-added">118     if (m_worldSet.contains(&amp;mainNormalWorld))</span>
<span class="line-added">119         worlds.uncheckedAppend(mainNormalWorld);</span>
<span class="line-added">120 </span>
<span class="line-added">121     // Add other normal worlds.</span>
<span class="line-added">122     for (auto* world : m_worldSet) {</span>
<span class="line-added">123         if (world-&gt;type() != DOMWrapperWorld::Type::Normal)</span>
<span class="line-added">124             continue;</span>
<span class="line-added">125         if (world == &amp;mainNormalWorld)</span>
<span class="line-added">126             continue;</span>
<span class="line-added">127         worlds.uncheckedAppend(*world);</span>
<span class="line-added">128     }</span>
<span class="line-added">129 </span>
<span class="line-added">130     // Add non-normal worlds.</span>
<span class="line-added">131     for (auto* world : m_worldSet) {</span>
<span class="line-added">132         if (world-&gt;type() == DOMWrapperWorld::Type::Normal)</span>
<span class="line-added">133             continue;</span>
<span class="line-added">134         worlds.uncheckedAppend(*world);</span>
<span class="line-added">135     }</span>
136 }
137 
138 void JSVMClientData::initNormalWorld(VM* vm)
139 {
140     JSVMClientData* clientData = new JSVMClientData(*vm);
141     vm-&gt;clientData = clientData; // ~VM deletes this pointer.
142 
143     vm-&gt;heap.addMarkingConstraint(makeUnique&lt;DOMGCOutputConstraint&gt;(*vm, *clientData));
144 
<span class="line-modified">145     clientData-&gt;m_normalWorld = DOMWrapperWorld::create(*vm, DOMWrapperWorld::Type::Normal);</span>
146     vm-&gt;m_typedArrayController = adoptRef(new WebCoreTypedArrayController());
147 }
148 
149 } // namespace WebCore
150 
</pre>
</td>
</tr>
</table>
<center><a href="WebCoreBuiltinNames.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="WebCoreJSClientData.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>