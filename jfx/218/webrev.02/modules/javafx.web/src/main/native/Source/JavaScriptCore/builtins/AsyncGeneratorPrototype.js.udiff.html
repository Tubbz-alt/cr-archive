<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/JavaScriptCore/builtins/AsyncGeneratorPrototype.js</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="AsyncFunctionPrototype.js.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="BuiltinExecutableCreator.cpp.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/JavaScriptCore/builtins/AsyncGeneratorPrototype.js</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,8 @@</span>
  /*
   * Copyright (C) 2017 Oleksandr Skachkov &lt;gskachkov@gmail.com&gt;.
<span class="udiff-line-added">+  * Copyright (C) 2019 Apple Inc. All rights reserved.</span>
   *
   * Redistribution and use in source and binary forms, with or without
   * modification, are permitted provided that the following conditions
   * are met:
   * 1. Redistributions of source code must retain the above copyright
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -26,107 +27,96 @@</span>
  @globalPrivate
  function asyncGeneratorQueueIsEmpty(generator)
  {
      &quot;use strict&quot;;
  
<span class="udiff-line-modified-removed">-     return @getByIdDirectPrivate(generator, &quot;asyncGeneratorQueueLast&quot;) === null;</span>
<span class="udiff-line-modified-added">+     return @getAsyncGeneratorInternalField(generator, @asyncGeneratorFieldQueueFirst) === null;</span>
  }
  
  @globalPrivate
  function asyncGeneratorQueueEnqueue(generator, item)
  {
      &quot;use strict&quot;;
  
<span class="udiff-line-modified-removed">-     @assert(@getByIdDirectPrivate(item, &quot;asyncGeneratorQueueItemNext&quot;) === null &amp;&amp; @getByIdDirectPrivate(item, &quot;asyncGeneratorQueueItemPrevious&quot;) === null);</span>
<span class="udiff-line-modified-added">+     @assert(@getByIdDirectPrivate(item, &quot;asyncGeneratorQueueItemNext&quot;) === null);</span>
  
<span class="udiff-line-modified-removed">-     if (@getByIdDirectPrivate(generator, &quot;asyncGeneratorQueueFirst&quot;) === null) {</span>
<span class="udiff-line-modified-removed">-         @assert(@getByIdDirectPrivate(generator, &quot;asyncGeneratorQueueLast&quot;) === null);</span>
<span class="udiff-line-modified-added">+     if (@getAsyncGeneratorInternalField(generator, @asyncGeneratorFieldQueueFirst) === null) {</span>
<span class="udiff-line-modified-added">+         @assert(@getAsyncGeneratorInternalField(generator, @asyncGeneratorFieldQueueLast) === null);</span>
  
<span class="udiff-line-modified-removed">-         @putByIdDirectPrivate(generator, &quot;asyncGeneratorQueueFirst&quot;, item);</span>
<span class="udiff-line-modified-removed">-         @putByIdDirectPrivate(generator, &quot;asyncGeneratorQueueLast&quot;, item);</span>
<span class="udiff-line-modified-added">+         @putAsyncGeneratorInternalField(generator, @asyncGeneratorFieldQueueFirst, item);</span>
<span class="udiff-line-modified-added">+         @putAsyncGeneratorInternalField(generator, @asyncGeneratorFieldQueueLast, item);</span>
      } else {
<span class="udiff-line-modified-removed">-         var last = @getByIdDirectPrivate(generator, &quot;asyncGeneratorQueueLast&quot;);</span>
<span class="udiff-line-removed">-         @putByIdDirectPrivate(item, &quot;asyncGeneratorQueueItemPrevious&quot;, last);</span>
<span class="udiff-line-modified-added">+         var last = @getAsyncGeneratorInternalField(generator, @asyncGeneratorFieldQueueLast);</span>
          @putByIdDirectPrivate(last, &quot;asyncGeneratorQueueItemNext&quot;, item);
<span class="udiff-line-modified-removed">-         @putByIdDirectPrivate(generator, &quot;asyncGeneratorQueueLast&quot;, item);</span>
<span class="udiff-line-modified-added">+         @putAsyncGeneratorInternalField(generator, @asyncGeneratorFieldQueueLast, item);</span>
      }
  }
  
  @globalPrivate
  function asyncGeneratorQueueDequeue(generator)
  {
      &quot;use strict&quot;;
  
<span class="udiff-line-modified-removed">-     const result = @getByIdDirectPrivate(generator, &quot;asyncGeneratorQueueFirst&quot;);</span>
<span class="udiff-line-modified-removed">-     if (result === null)</span>
<span class="udiff-line-modified-removed">-         return null;</span>
<span class="udiff-line-modified-added">+     @assert(!@asyncGeneratorQueueIsEmpty(generator), &quot;Async genetator&#39;s Queue is an empty List.&quot;);</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+     var result = @getAsyncGeneratorInternalField(generator, @asyncGeneratorFieldQueueFirst);</span>
  
      var updatedFirst = @getByIdDirectPrivate(result, &quot;asyncGeneratorQueueItemNext&quot;);
<span class="udiff-line-modified-removed">-     @putByIdDirectPrivate(generator, &quot;asyncGeneratorQueueFirst&quot;, updatedFirst);</span>
<span class="udiff-line-modified-added">+     @putAsyncGeneratorInternalField(generator, @asyncGeneratorFieldQueueFirst, updatedFirst);</span>
  
      if (updatedFirst === null)
<span class="udiff-line-modified-removed">-         @putByIdDirectPrivate(generator, &quot;asyncGeneratorQueueLast&quot;, null);</span>
<span class="udiff-line-modified-added">+         @putAsyncGeneratorInternalField(generator, @asyncGeneratorFieldQueueLast, null);</span>
  
      return result;
  }
  
<span class="udiff-line-removed">- @globalPrivate</span>
<span class="udiff-line-removed">- function asyncGeneratorDequeue(generator)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-     &quot;use strict&quot;;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     const queue = @getByIdDirectPrivate(generator, &quot;asyncGeneratorQueue&quot;);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     @assert(!@asyncGeneratorQueueIsEmpty(generator), &quot;Async genetator&#39;s Queue is an empty List.&quot;);</span>
<span class="udiff-line-removed">-     </span>
<span class="udiff-line-removed">-     return @asyncGeneratorQueueDequeue(generator);</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
  @globalPrivate
  function isExecutionState(generator)
  {
      &quot;use strict&quot;;
  
<span class="udiff-line-modified-removed">-     var state = @getByIdDirectPrivate(generator, &quot;generatorState&quot;);</span>
<span class="udiff-line-modified-removed">-     var reason = @getByIdDirectPrivate(generator, &quot;asyncGeneratorSuspendReason&quot;);</span>
<span class="udiff-line-modified-added">+     var state = @getAsyncGeneratorInternalField(generator, @generatorFieldState);</span>
<span class="udiff-line-modified-added">+     var reason = @getAsyncGeneratorInternalField(generator, @asyncGeneratorFieldSuspendReason);</span>
      return (state &gt; 0 &amp;&amp; reason === @AsyncGeneratorSuspendReasonNone)
          || state === @AsyncGeneratorStateExecuting
          || reason === @AsyncGeneratorSuspendReasonAwait;
  }
  
  @globalPrivate
  function isSuspendYieldState(generator)
  {
      &quot;use strict&quot;;
  
<span class="udiff-line-modified-removed">-     var state = @getByIdDirectPrivate(generator, &quot;generatorState&quot;);</span>
<span class="udiff-line-modified-removed">-     return (state &gt; 0 &amp;&amp; @getByIdDirectPrivate(generator, &quot;asyncGeneratorSuspendReason&quot;) === @AsyncGeneratorSuspendReasonYield)</span>
<span class="udiff-line-modified-added">+     var state = @getAsyncGeneratorInternalField(generator, @generatorFieldState);</span>
<span class="udiff-line-modified-added">+     return (state &gt; 0 &amp;&amp; @getAsyncGeneratorInternalField(generator, @asyncGeneratorFieldSuspendReason) === @AsyncGeneratorSuspendReasonYield)</span>
          || state === @AsyncGeneratorStateSuspendedYield;
  }
  
  @globalPrivate
  function asyncGeneratorReject(generator, exception)
  {
      &quot;use strict&quot;;
  
<span class="udiff-line-modified-removed">-     @assert(typeof @getByIdDirectPrivate(generator, &quot;asyncGeneratorSuspendReason&quot;) === &quot;number&quot;, &quot;Generator is not an AsyncGenerator instance.&quot;);</span>
<span class="udiff-line-modified-added">+     @assert(@isAsyncGenerator(generator), &quot;Generator is not an AsyncGenerator instance.&quot;);</span>
  
<span class="udiff-line-modified-removed">-     const { promiseCapability } = @asyncGeneratorDequeue(generator);</span>
<span class="udiff-line-modified-removed">-     promiseCapability.@reject.@call(@undefined, exception);</span>
<span class="udiff-line-modified-added">+     var promise = @asyncGeneratorQueueDequeue(generator).promise;</span>
<span class="udiff-line-modified-added">+     @assert(@isPromise(promise));</span>
<span class="udiff-line-added">+     @rejectPromiseWithFirstResolvingFunctionCallCheck(promise, exception);</span>
  
      return @asyncGeneratorResumeNext(generator);
  }
  
  @globalPrivate
  function asyncGeneratorResolve(generator, value, done)
  {
      &quot;use strict&quot;;
  
<span class="udiff-line-modified-removed">-     @assert(typeof @getByIdDirectPrivate(generator, &quot;asyncGeneratorSuspendReason&quot;) === &quot;number&quot;, &quot;Generator is not an AsyncGenerator instance.&quot;);</span>
<span class="udiff-line-modified-added">+     @assert(@isAsyncGenerator(generator), &quot;Generator is not an AsyncGenerator instance.&quot;);</span>
  
<span class="udiff-line-modified-removed">-     const { promiseCapability } = @asyncGeneratorDequeue(generator);</span>
<span class="udiff-line-modified-removed">-     promiseCapability.@resolve.@call(@undefined, { value, done });</span>
<span class="udiff-line-modified-added">+     var promise = @asyncGeneratorQueueDequeue(generator).promise;</span>
<span class="udiff-line-modified-added">+     @assert(@isPromise(promise));</span>
<span class="udiff-line-added">+     @resolvePromiseWithFirstResolvingFunctionCallCheck(promise, { value, done });</span>
  
      return @asyncGeneratorResumeNext(generator);
  }
  
  @globalPrivate
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -134,116 +124,109 @@</span>
  {
      &quot;use strict&quot;;
  
      function asyncGeneratorYieldAwaited(result)
      {
<span class="udiff-line-modified-removed">-         @putByIdDirectPrivate(generator, &quot;asyncGeneratorSuspendReason&quot;, @AsyncGeneratorSuspendReasonYield);</span>
<span class="udiff-line-modified-added">+         @putAsyncGeneratorInternalField(generator, @asyncGeneratorFieldSuspendReason, @AsyncGeneratorSuspendReasonYield);</span>
          @asyncGeneratorResolve(generator, result, false);
      }
  
<span class="udiff-line-modified-removed">-     @putByIdDirectPrivate(generator, &quot;asyncGeneratorSuspendReason&quot;, @AsyncGeneratorSuspendReasonAwait);</span>
<span class="udiff-line-modified-added">+     @putAsyncGeneratorInternalField(generator, @asyncGeneratorFieldSuspendReason, @AsyncGeneratorSuspendReasonAwait);</span>
  
      @awaitValue(generator, value, asyncGeneratorYieldAwaited);
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     return @undefined;</span>
  }
  
  @globalPrivate
<span class="udiff-line-modified-removed">- function awaitValue(generator, value, onFullfiled)</span>
<span class="udiff-line-modified-added">+ function awaitValue(generator, value, onFulfilled)</span>
  {
      &quot;use strict&quot;;
  
<span class="udiff-line-modified-removed">-     const wrappedValue = @newPromiseCapability(@Promise);</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-removed">-     const onRejected = function (result) { @doAsyncGeneratorBodyCall(generator, result, @GeneratorResumeModeThrow); };</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     wrappedValue.@resolve.@call(@undefined, value);</span>
<span class="udiff-line-removed">-     wrappedValue.@promise.@then(onFullfiled, onRejected);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     return wrappedValue;</span>
<span class="udiff-line-modified-added">+     var onRejected = function (result) { @doAsyncGeneratorBodyCall(generator, result, @GeneratorResumeModeThrow); };</span>
<span class="udiff-line-modified-added">+     @resolveWithoutPromise(value, onFulfilled, onRejected);</span>
  }
  
  @globalPrivate
  function doAsyncGeneratorBodyCall(generator, resumeValue, resumeMode)
  {
      &quot;use strict&quot;;
  
<span class="udiff-line-modified-removed">-     let value = @undefined;</span>
<span class="udiff-line-modified-removed">-     let state = @getByIdDirectPrivate(generator, &quot;generatorState&quot;);</span>
<span class="udiff-line-modified-added">+     var value = @undefined;</span>
<span class="udiff-line-modified-added">+     var state = @getAsyncGeneratorInternalField(generator, @generatorFieldState);</span>
  
<span class="udiff-line-modified-removed">-     @putByIdDirectPrivate(generator, &quot;generatorState&quot;, @AsyncGeneratorStateExecuting);</span>
<span class="udiff-line-modified-removed">-     @putByIdDirectPrivate(generator, &quot;asyncGeneratorSuspendReason&quot;, @AsyncGeneratorSuspendReasonNone);</span>
<span class="udiff-line-modified-added">+     @putAsyncGeneratorInternalField(generator, @generatorFieldState, @AsyncGeneratorStateExecuting);</span>
<span class="udiff-line-modified-added">+     @putAsyncGeneratorInternalField(generator, @asyncGeneratorFieldSuspendReason, @AsyncGeneratorSuspendReasonNone);</span>
  
      try {
<span class="udiff-line-modified-removed">-         value = @getByIdDirectPrivate(generator, &quot;generatorNext&quot;).@call(@getByIdDirectPrivate(generator, &quot;generatorThis&quot;), generator, state, resumeValue, resumeMode, @getByIdDirectPrivate(generator, &quot;generatorFrame&quot;));</span>
<span class="udiff-line-modified-removed">-         if (@getByIdDirectPrivate(generator, &quot;generatorState&quot;) === @AsyncGeneratorStateExecuting)</span>
<span class="udiff-line-modified-removed">-             @putByIdDirectPrivate(generator, &quot;generatorState&quot;, @AsyncGeneratorStateCompleted);</span>
<span class="udiff-line-modified-added">+         value = @getAsyncGeneratorInternalField(generator, @generatorFieldNext).@call(@getAsyncGeneratorInternalField(generator, @generatorFieldThis), generator, state, resumeValue, resumeMode, @getAsyncGeneratorInternalField(generator, @generatorFieldFrame));</span>
<span class="udiff-line-modified-added">+         state = @getAsyncGeneratorInternalField(generator, @generatorFieldState);</span>
<span class="udiff-line-modified-added">+         if (state === @AsyncGeneratorStateExecuting) {</span>
<span class="udiff-line-added">+             @putAsyncGeneratorInternalField(generator, @generatorFieldState, @AsyncGeneratorStateCompleted);</span>
<span class="udiff-line-added">+             state = @AsyncGeneratorStateCompleted;</span>
<span class="udiff-line-added">+         }</span>
      } catch (error) {
<span class="udiff-line-modified-removed">-         @putByIdDirectPrivate(generator, &quot;generatorState&quot;, @AsyncGeneratorStateCompleted);</span>
<span class="udiff-line-modified-removed">-         @putByIdDirectPrivate(generator, &quot;asyncGeneratorSuspendReason&quot;, @AsyncGeneratorSuspendReasonNone);</span>
<span class="udiff-line-modified-added">+         @putAsyncGeneratorInternalField(generator, @generatorFieldState, @AsyncGeneratorStateCompleted);</span>
<span class="udiff-line-modified-added">+         @putAsyncGeneratorInternalField(generator, @asyncGeneratorFieldSuspendReason, @AsyncGeneratorSuspendReasonNone);</span>
  
          return @asyncGeneratorReject(generator, error);
      }
  
<span class="udiff-line-modified-removed">-     if (@getByIdDirectPrivate(generator, &quot;asyncGeneratorSuspendReason&quot;) === @AsyncGeneratorSuspendReasonAwait) {</span>
<span class="udiff-line-modified-removed">-         const onFulfilled = function(result) { @doAsyncGeneratorBodyCall(generator, result, @GeneratorResumeModeNormal); };</span>
<span class="udiff-line-modified-added">+     var reason = @getAsyncGeneratorInternalField(generator, @asyncGeneratorFieldSuspendReason);</span>
<span class="udiff-line-modified-added">+     if (reason === @AsyncGeneratorSuspendReasonAwait) {</span>
<span class="udiff-line-added">+         var onFulfilled = function(result) { @doAsyncGeneratorBodyCall(generator, result, @GeneratorResumeModeNormal); };</span>
  
          @awaitValue(generator, value, onFulfilled);
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-removed">-         return @undefined;</span>
<span class="udiff-line-modified-added">+         return;</span>
      }
  
<span class="udiff-line-modified-removed">-     if (@getByIdDirectPrivate(generator, &quot;asyncGeneratorSuspendReason&quot;) === @AsyncGeneratorSuspendReasonYield)</span>
<span class="udiff-line-modified-added">+     if (reason === @AsyncGeneratorSuspendReasonYield)</span>
          return @asyncGeneratorYield(generator, value, resumeMode);
  
<span class="udiff-line-modified-removed">-     if (@getByIdDirectPrivate(generator, &quot;generatorState&quot;) === @AsyncGeneratorStateCompleted) {</span>
<span class="udiff-line-modified-removed">-         @putByIdDirectPrivate(generator, &quot;asyncGeneratorSuspendReason&quot;, @AsyncGeneratorSuspendReasonNone);</span>
<span class="udiff-line-modified-added">+     if (state === @AsyncGeneratorStateCompleted) {</span>
<span class="udiff-line-modified-added">+         @assert(@getAsyncGeneratorInternalField(generator, @generatorFieldState) == @AsyncGeneratorStateCompleted);</span>
<span class="udiff-line-added">+         @putAsyncGeneratorInternalField(generator, @asyncGeneratorFieldSuspendReason, @AsyncGeneratorSuspendReasonNone);</span>
          return @asyncGeneratorResolve(generator, value, true);
      }
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     return @undefined;</span>
  }
  
  @globalPrivate
  function asyncGeneratorResumeNext(generator)
  {
      &quot;use strict&quot;;
  
<span class="udiff-line-modified-removed">-     @assert(typeof @getByIdDirectPrivate(generator, &quot;asyncGeneratorSuspendReason&quot;) === &quot;number&quot;, &quot;Generator is not an AsyncGenerator instance.&quot;);</span>
<span class="udiff-line-modified-added">+     @assert(@isAsyncGenerator(generator), &quot;Generator is not an AsyncGenerator instance.&quot;);</span>
  
<span class="udiff-line-modified-removed">-     let state = @getByIdDirectPrivate(generator, &quot;generatorState&quot;);</span>
<span class="udiff-line-modified-added">+     var state = @getAsyncGeneratorInternalField(generator, @generatorFieldState);</span>
  
      @assert(state !== @AsyncGeneratorStateExecuting, &quot;Async generator should not be in executing state&quot;);
  
      if (state === @AsyncGeneratorStateAwaitingReturn)
<span class="udiff-line-modified-removed">-         return @undefined;</span>
<span class="udiff-line-modified-added">+         return;</span>
  
      if (@asyncGeneratorQueueIsEmpty(generator))
<span class="udiff-line-modified-removed">-         return @undefined;</span>
<span class="udiff-line-modified-added">+         return;</span>
  
<span class="udiff-line-modified-removed">-     const next = @getByIdDirectPrivate(generator, &quot;asyncGeneratorQueueFirst&quot;);</span>
<span class="udiff-line-modified-added">+     var next = @getAsyncGeneratorInternalField(generator, @asyncGeneratorFieldQueueFirst);</span>
  
      if (next.resumeMode !== @GeneratorResumeModeNormal) {
          if (state === @AsyncGeneratorStateSuspendedStart) {
<span class="udiff-line-modified-removed">-             @putByIdDirectPrivate(generator, &quot;generatorState&quot;, @AsyncGeneratorStateCompleted);</span>
<span class="udiff-line-modified-added">+             @putAsyncGeneratorInternalField(generator, @generatorFieldState, @AsyncGeneratorStateCompleted);</span>
              state = @AsyncGeneratorStateCompleted;
          }
  
          if (state === @AsyncGeneratorStateCompleted) {
              if (next.resumeMode === @GeneratorResumeModeReturn) {
<span class="udiff-line-modified-removed">-                 @putByIdDirectPrivate(generator, &quot;generatorState&quot;, @AsyncGeneratorStateAwaitingReturn);</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-                 const promiseCapability = @newPromiseCapability(@Promise);</span>
<span class="udiff-line-modified-removed">-                 promiseCapability.@resolve.@call(@undefined, next.value);</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-                 const throwawayCapabilityPromise = promiseCapability.@promise.@then(</span>
<span class="udiff-line-modified-removed">-                     function (result) { generator.@generatorState = @AsyncGeneratorStateCompleted; @asyncGeneratorResolve(generator, result, true); },</span>
<span class="udiff-line-modified-removed">-                     function (error) { generator.@generatorState = @AsyncGeneratorStateCompleted; @asyncGeneratorReject(generator, error); });</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-                 @putByIdDirectPrivate(throwawayCapabilityPromise, &quot;promiseIsHandled&quot;, true);</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-removed">-                 return @undefined;</span>
<span class="udiff-line-modified-added">+                 @putAsyncGeneratorInternalField(generator, @generatorFieldState, @AsyncGeneratorStateAwaitingReturn);</span>
<span class="udiff-line-modified-added">+                 @resolveWithoutPromise(next.value,</span>
<span class="udiff-line-modified-added">+                     function (result) {</span>
<span class="udiff-line-modified-added">+                         @putAsyncGeneratorInternalField(generator, @generatorFieldState, @AsyncGeneratorStateCompleted);</span>
<span class="udiff-line-modified-added">+                         @asyncGeneratorResolve(generator, result, true);</span>
<span class="udiff-line-modified-added">+                     },</span>
<span class="udiff-line-modified-added">+                     function (error) {</span>
<span class="udiff-line-modified-added">+                         @putAsyncGeneratorInternalField(generator, @generatorFieldState, @AsyncGeneratorStateCompleted);</span>
<span class="udiff-line-modified-added">+                         @asyncGeneratorReject(generator, error);</span>
<span class="udiff-line-modified-added">+                     });</span>
<span class="udiff-line-modified-added">+                 return;</span>
              }
  
              @assert(next.resumeMode === @GeneratorResumeModeThrow, &quot;Async generator has wrong mode&quot;);
  
              return @asyncGeneratorReject(generator, next.value);;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -252,31 +235,29 @@</span>
          return @asyncGeneratorResolve(generator, @undefined, true);
  
      @assert(state === @AsyncGeneratorStateSuspendedStart || @isSuspendYieldState(generator), &quot;Async generator has wrong state&quot;);
  
      @doAsyncGeneratorBodyCall(generator, next.value, next.resumeMode);
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     return @undefined;</span>
  }
  
  @globalPrivate
  function asyncGeneratorEnqueue(generator, value, resumeMode)
  {
      &quot;use strict&quot;;
<span class="udiff-line-modified-removed">-     </span>
<span class="udiff-line-modified-removed">-     const promiseCapability = @newPromiseCapability(@Promise);</span>
<span class="udiff-line-modified-removed">-     if (!@isObject(generator) || typeof @getByIdDirectPrivate(generator, &quot;asyncGeneratorSuspendReason&quot;) !== &#39;number&#39;) {</span>
<span class="udiff-line-modified-removed">-         promiseCapability.@reject.@call(@undefined, @makeTypeError(&#39;|this| should be an async generator&#39;));</span>
<span class="udiff-line-modified-removed">-         return promiseCapability.@promise;</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+     var promise = @newPromise();</span>
<span class="udiff-line-modified-added">+     if (!@isAsyncGenerator(generator)) {</span>
<span class="udiff-line-modified-added">+         @rejectPromiseWithFirstResolvingFunctionCallCheck(promise, @makeTypeError(&#39;|this| should be an async generator&#39;));</span>
<span class="udiff-line-modified-added">+         return promise;</span>
      }
  
<span class="udiff-line-modified-removed">-     @asyncGeneratorQueueEnqueue(generator, {resumeMode, value, promiseCapability, @asyncGeneratorQueueItemNext: null, @asyncGeneratorQueueItemPrevious: null});</span>
<span class="udiff-line-modified-added">+     @asyncGeneratorQueueEnqueue(generator, {resumeMode, value, promise, @asyncGeneratorQueueItemNext: null});</span>
  
      if (!@isExecutionState(generator))
          @asyncGeneratorResumeNext(generator);
  
<span class="udiff-line-modified-removed">-     return promiseCapability.@promise;</span>
<span class="udiff-line-modified-added">+     return promise;</span>
  }
  
  function next(value)
  {
      &quot;use strict&quot;;
</pre>
<center><a href="AsyncFunctionPrototype.js.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="BuiltinExecutableCreator.cpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>