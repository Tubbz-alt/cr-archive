<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WebCore/bridge/jni/jsc/JavaArrayJSC.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="JNIUtilityPrivate.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="JavaArrayJSC.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/bridge/jni/jsc/JavaArrayJSC.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 26 
 27 #include &quot;config.h&quot;
 28 #include &quot;JavaArrayJSC.h&quot;
 29 
 30 #if ENABLE(JAVA_BRIDGE)
 31 
 32 #include &quot;JNIUtilityPrivate.h&quot;
 33 #include &quot;JavaInstanceJSC.h&quot;
 34 #include &quot;JobjectWrapper.h&quot;
 35 #include &quot;runtime_array.h&quot;
 36 #include &quot;runtime_object.h&quot;
 37 #include &quot;runtime_root.h&quot;
 38 #include &lt;JavaScriptCore/Error.h&gt;
 39 
 40 #include &quot;Logging.h&quot;
 41 
 42 using namespace JSC;
 43 using namespace JSC::Bindings;
 44 using namespace WebCore;
 45 
<span class="line-modified"> 46 JSValue JavaArray::convertJObjectToArray(ExecState* exec, jobject anObject, const char* type, RefPtr&lt;RootObject&gt;&amp;&amp; rootObject, jobject accessControlContext)</span>
 47 {
 48     if (type[0] != &#39;[&#39;)
 49         return jsUndefined();
 50 
<span class="line-modified"> 51     return RuntimeArray::create(exec, new JavaArray(anObject, type, WTFMove(rootObject), accessControlContext));</span>
 52 }
 53 
 54 JavaArray::JavaArray(jobject array, const char* type, RefPtr&lt;RootObject&gt;&amp;&amp; rootObject, jobject accessControlContext)
 55     : Array(WTFMove(rootObject))
 56 {
 57     m_array = JobjectWrapper::create(array);
 58 
 59     // Java array are fixed length, so we can cache length.
 60     JNIEnv* env = getJNIEnv();
 61 
 62     // Since m_array-&gt;instance() is WeakGlobalRef, creating a localref to safeguard instance() from GC
 63     JLObject jlarrayinstance(m_array-&gt;instance(), true);
 64 
 65     if (!jlarrayinstance) {
 66         LOG_ERROR(&quot;Could not get javaInstance for %p in JavaArray Constructor&quot;, (jobject)jlarrayinstance);
 67         m_length = 0;
 68     } else {
 69         m_length = env-&gt;GetArrayLength(static_cast&lt;jarray&gt;(m_array-&gt;instance()));
 70     }
 71 
 72     m_type = strdup(type);
 73     m_accessControlContext = JobjectWrapper::create(accessControlContext, true);
 74 }
 75 
 76 JavaArray::~JavaArray()
 77 {
 78     free(const_cast&lt;char*&gt;(m_type));
 79 }
 80 
 81 RootObject* JavaArray::rootObject() const
 82 {
 83     return m_rootObject &amp;&amp; m_rootObject-&gt;isValid() ? m_rootObject.get() : 0;
 84 }
 85 
<span class="line-modified"> 86 bool JavaArray::setValueAt(ExecState* exec, unsigned index, JSValue aValue) const</span>
 87 {
 88     // Since javaArray() is WeakGlobalRef, creating a localref to safeguard instance() from GC
 89     JLObject jlinstance(javaArray(), true);
 90 
 91     if (!jlinstance) {
 92         LOG_ERROR(&quot;Could not get javaInstance for %p in JavaArray::setValueAt&quot;, (jobject)jlinstance);
 93         return false;
 94     }
 95 
 96     JNIEnv* env = getJNIEnv();
 97     char* javaClassName = 0;
 98 
 99     JavaType arrayType = javaTypeFromPrimitiveType(m_type[1]);
100     if (m_type[1] == &#39;L&#39;) {
101         // The type of the array will be something like:
102         // &quot;[Ljava.lang.string;&quot;. This is guaranteed, so no need
103         // for extra sanity checks.
104         javaClassName = strdup(&amp;m_type[2]);
105         javaClassName[strchr(javaClassName, &#39;;&#39;)-javaClassName] = 0;
106     }
<span class="line-modified">107     jvalue aJValue = convertValueToJValue(exec, m_rootObject.get(), aValue, arrayType, javaClassName);</span>
108 
109     switch (arrayType) {
110     case JavaTypeObject:
111         {
112             env-&gt;SetObjectArrayElement(static_cast&lt;jobjectArray&gt;(javaArray()), index, aJValue.l);
113             break;
114         }
115 
116     case JavaTypeBoolean:
117         {
118             env-&gt;SetBooleanArrayRegion(static_cast&lt;jbooleanArray&gt;(javaArray()), index, 1, &amp;aJValue.z);
119             break;
120         }
121 
122     case JavaTypeByte:
123         {
124             env-&gt;SetByteArrayRegion(static_cast&lt;jbyteArray&gt;(javaArray()), index, 1, &amp;aJValue.b);
125             break;
126         }
127 
</pre>
<hr />
<pre>
152     case JavaTypeFloat:
153         {
154             env-&gt;SetFloatArrayRegion(static_cast&lt;jfloatArray&gt;(javaArray()), index, 1, &amp;aJValue.f);
155             break;
156         }
157 
158     case JavaTypeDouble:
159         {
160             env-&gt;SetDoubleArrayRegion(static_cast&lt;jdoubleArray&gt;(javaArray()), index, 1, &amp;aJValue.d);
161             break;
162         }
163     default:
164         break;
165     }
166 
167     if (javaClassName)
168         free(const_cast&lt;char*&gt;(javaClassName));
169     return true;
170 }
171 
<span class="line-modified">172 JSValue JavaArray::valueAt(ExecState* exec, unsigned index) const</span>
173 {
174     // Since javaArray() is WeakGlobalRef, creating a localref to safeguard instance() from GC
175     JLObject jlinstance(javaArray(), true);
176 
177     if (!jlinstance) {
178         LOG_ERROR(&quot;Could not get javaInstance for %p in JavaArray::valueAt&quot;, (jobject)jlinstance);
179         return jsUndefined();
180     }
181 
182     JNIEnv* env = getJNIEnv();
183     JavaType arrayType = javaTypeFromPrimitiveType(m_type[1]);
184     switch (arrayType) {
185     case JavaTypeObject:
186         {
187             jobjectArray objectArray = static_cast&lt;jobjectArray&gt;(javaArray());
188             jobject anObject;
189             anObject = env-&gt;GetObjectArrayElement(objectArray, index);
190 
191             // No object?
192             if (!anObject)
193                 return jsNull();
194 
195             // Nested array?
196             if (m_type[1] == &#39;[&#39;)
<span class="line-modified">197                 return JavaArray::convertJObjectToArray(exec, anObject,</span>
198                         m_type + 1, rootObject(), accessControlContext());
199             // or array of other object type?
200             return JavaInstance::create(anObject, rootObject(),
<span class="line-modified">201                     accessControlContext())-&gt;createRuntimeObject(exec);</span>
202         }
203 
204     case JavaTypeBoolean:
205         {
206             jbooleanArray booleanArray = static_cast&lt;jbooleanArray&gt;(javaArray());
207             jboolean aBoolean;
208             env-&gt;GetBooleanArrayRegion(booleanArray, index, 1, &amp;aBoolean);
209             return jsBoolean(aBoolean);
210         }
211 
212     case JavaTypeByte:
213         {
214             jbyteArray byteArray = static_cast&lt;jbyteArray&gt;(javaArray());
215             jbyte aByte;
216             env-&gt;GetByteArrayRegion(byteArray, index, 1, &amp;aByte);
217             return jsNumber(aByte);
218         }
219 
220     case JavaTypeChar:
221         {
</pre>
</td>
<td>
<hr />
<pre>
 26 
 27 #include &quot;config.h&quot;
 28 #include &quot;JavaArrayJSC.h&quot;
 29 
 30 #if ENABLE(JAVA_BRIDGE)
 31 
 32 #include &quot;JNIUtilityPrivate.h&quot;
 33 #include &quot;JavaInstanceJSC.h&quot;
 34 #include &quot;JobjectWrapper.h&quot;
 35 #include &quot;runtime_array.h&quot;
 36 #include &quot;runtime_object.h&quot;
 37 #include &quot;runtime_root.h&quot;
 38 #include &lt;JavaScriptCore/Error.h&gt;
 39 
 40 #include &quot;Logging.h&quot;
 41 
 42 using namespace JSC;
 43 using namespace JSC::Bindings;
 44 using namespace WebCore;
 45 
<span class="line-modified"> 46 JSValue JavaArray::convertJObjectToArray(JSGlobalObject* globalObject, jobject anObject, const char* type, RefPtr&lt;RootObject&gt;&amp;&amp; rootObject, jobject accessControlContext)</span>
 47 {
 48     if (type[0] != &#39;[&#39;)
 49         return jsUndefined();
 50 
<span class="line-modified"> 51     return RuntimeArray::create(globalObject, new JavaArray(anObject, type, WTFMove(rootObject), accessControlContext));</span>
 52 }
 53 
 54 JavaArray::JavaArray(jobject array, const char* type, RefPtr&lt;RootObject&gt;&amp;&amp; rootObject, jobject accessControlContext)
 55     : Array(WTFMove(rootObject))
 56 {
 57     m_array = JobjectWrapper::create(array);
 58 
 59     // Java array are fixed length, so we can cache length.
 60     JNIEnv* env = getJNIEnv();
 61 
 62     // Since m_array-&gt;instance() is WeakGlobalRef, creating a localref to safeguard instance() from GC
 63     JLObject jlarrayinstance(m_array-&gt;instance(), true);
 64 
 65     if (!jlarrayinstance) {
 66         LOG_ERROR(&quot;Could not get javaInstance for %p in JavaArray Constructor&quot;, (jobject)jlarrayinstance);
 67         m_length = 0;
 68     } else {
 69         m_length = env-&gt;GetArrayLength(static_cast&lt;jarray&gt;(m_array-&gt;instance()));
 70     }
 71 
 72     m_type = strdup(type);
 73     m_accessControlContext = JobjectWrapper::create(accessControlContext, true);
 74 }
 75 
 76 JavaArray::~JavaArray()
 77 {
 78     free(const_cast&lt;char*&gt;(m_type));
 79 }
 80 
 81 RootObject* JavaArray::rootObject() const
 82 {
 83     return m_rootObject &amp;&amp; m_rootObject-&gt;isValid() ? m_rootObject.get() : 0;
 84 }
 85 
<span class="line-modified"> 86 bool JavaArray::setValueAt(JSGlobalObject* globalObject, unsigned index, JSValue aValue) const</span>
 87 {
 88     // Since javaArray() is WeakGlobalRef, creating a localref to safeguard instance() from GC
 89     JLObject jlinstance(javaArray(), true);
 90 
 91     if (!jlinstance) {
 92         LOG_ERROR(&quot;Could not get javaInstance for %p in JavaArray::setValueAt&quot;, (jobject)jlinstance);
 93         return false;
 94     }
 95 
 96     JNIEnv* env = getJNIEnv();
 97     char* javaClassName = 0;
 98 
 99     JavaType arrayType = javaTypeFromPrimitiveType(m_type[1]);
100     if (m_type[1] == &#39;L&#39;) {
101         // The type of the array will be something like:
102         // &quot;[Ljava.lang.string;&quot;. This is guaranteed, so no need
103         // for extra sanity checks.
104         javaClassName = strdup(&amp;m_type[2]);
105         javaClassName[strchr(javaClassName, &#39;;&#39;)-javaClassName] = 0;
106     }
<span class="line-modified">107     jvalue aJValue = convertValueToJValue(globalObject, m_rootObject.get(), aValue, arrayType, javaClassName);</span>
108 
109     switch (arrayType) {
110     case JavaTypeObject:
111         {
112             env-&gt;SetObjectArrayElement(static_cast&lt;jobjectArray&gt;(javaArray()), index, aJValue.l);
113             break;
114         }
115 
116     case JavaTypeBoolean:
117         {
118             env-&gt;SetBooleanArrayRegion(static_cast&lt;jbooleanArray&gt;(javaArray()), index, 1, &amp;aJValue.z);
119             break;
120         }
121 
122     case JavaTypeByte:
123         {
124             env-&gt;SetByteArrayRegion(static_cast&lt;jbyteArray&gt;(javaArray()), index, 1, &amp;aJValue.b);
125             break;
126         }
127 
</pre>
<hr />
<pre>
152     case JavaTypeFloat:
153         {
154             env-&gt;SetFloatArrayRegion(static_cast&lt;jfloatArray&gt;(javaArray()), index, 1, &amp;aJValue.f);
155             break;
156         }
157 
158     case JavaTypeDouble:
159         {
160             env-&gt;SetDoubleArrayRegion(static_cast&lt;jdoubleArray&gt;(javaArray()), index, 1, &amp;aJValue.d);
161             break;
162         }
163     default:
164         break;
165     }
166 
167     if (javaClassName)
168         free(const_cast&lt;char*&gt;(javaClassName));
169     return true;
170 }
171 
<span class="line-modified">172 JSValue JavaArray::valueAt(JSGlobalObject* globalObject, unsigned index) const</span>
173 {
174     // Since javaArray() is WeakGlobalRef, creating a localref to safeguard instance() from GC
175     JLObject jlinstance(javaArray(), true);
176 
177     if (!jlinstance) {
178         LOG_ERROR(&quot;Could not get javaInstance for %p in JavaArray::valueAt&quot;, (jobject)jlinstance);
179         return jsUndefined();
180     }
181 
182     JNIEnv* env = getJNIEnv();
183     JavaType arrayType = javaTypeFromPrimitiveType(m_type[1]);
184     switch (arrayType) {
185     case JavaTypeObject:
186         {
187             jobjectArray objectArray = static_cast&lt;jobjectArray&gt;(javaArray());
188             jobject anObject;
189             anObject = env-&gt;GetObjectArrayElement(objectArray, index);
190 
191             // No object?
192             if (!anObject)
193                 return jsNull();
194 
195             // Nested array?
196             if (m_type[1] == &#39;[&#39;)
<span class="line-modified">197                 return JavaArray::convertJObjectToArray(globalObject, anObject,</span>
198                         m_type + 1, rootObject(), accessControlContext());
199             // or array of other object type?
200             return JavaInstance::create(anObject, rootObject(),
<span class="line-modified">201                     accessControlContext())-&gt;createRuntimeObject(globalObject);</span>
202         }
203 
204     case JavaTypeBoolean:
205         {
206             jbooleanArray booleanArray = static_cast&lt;jbooleanArray&gt;(javaArray());
207             jboolean aBoolean;
208             env-&gt;GetBooleanArrayRegion(booleanArray, index, 1, &amp;aBoolean);
209             return jsBoolean(aBoolean);
210         }
211 
212     case JavaTypeByte:
213         {
214             jbyteArray byteArray = static_cast&lt;jbyteArray&gt;(javaArray());
215             jbyte aByte;
216             env-&gt;GetByteArrayRegion(byteArray, index, 1, &amp;aByte);
217             return jsNumber(aByte);
218         }
219 
220     case JavaTypeChar:
221         {
</pre>
</td>
</tr>
</table>
<center><a href="JNIUtilityPrivate.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="JavaArrayJSC.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>