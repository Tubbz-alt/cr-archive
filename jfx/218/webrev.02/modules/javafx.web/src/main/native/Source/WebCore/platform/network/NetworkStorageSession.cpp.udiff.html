<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WebCore/platform/network/NetworkStorageSession.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="NetworkLoadMetrics.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="NetworkStorageSession.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/platform/network/NetworkStorageSession.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -24,12 +24,12 @@</span>
   */
  
  #include &quot;config.h&quot;
  #include &quot;NetworkStorageSession.h&quot;
  
<span class="udiff-line-added">+ #include &quot;HTTPCookieAcceptPolicy.h&quot;</span>
  #include &quot;RuntimeApplicationChecks.h&quot;
<span class="udiff-line-removed">- #include &lt;pal/SessionID.h&gt;</span>
  #include &lt;wtf/NeverDestroyed.h&gt;
  #include &lt;wtf/ProcessPrivilege.h&gt;
  
  #if ENABLE(RESOURCE_LOAD_STATISTICS)
  #include &quot;ResourceRequest.h&quot;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -58,36 +58,50 @@</span>
  
  #if ENABLE(RESOURCE_LOAD_STATISTICS)
  
  bool NetworkStorageSession::shouldBlockThirdPartyCookies(const RegistrableDomain&amp; registrableDomain) const
  {
<span class="udiff-line-modified-removed">-     if (registrableDomain.isEmpty())</span>
<span class="udiff-line-modified-added">+     if (!m_isResourceLoadStatisticsEnabled || registrableDomain.isEmpty())</span>
          return false;
  
      ASSERT(!(m_registrableDomainsToBlockAndDeleteCookiesFor.contains(registrableDomain) &amp;&amp; m_registrableDomainsToBlockButKeepCookiesFor.contains(registrableDomain)));
  
      return m_registrableDomainsToBlockAndDeleteCookiesFor.contains(registrableDomain)
          || m_registrableDomainsToBlockButKeepCookiesFor.contains(registrableDomain);
  }
  
  bool NetworkStorageSession::shouldBlockThirdPartyCookiesButKeepFirstPartyCookiesFor(const RegistrableDomain&amp; registrableDomain) const
  {
<span class="udiff-line-modified-removed">-     if (registrableDomain.isEmpty())</span>
<span class="udiff-line-modified-added">+     if (!m_isResourceLoadStatisticsEnabled || registrableDomain.isEmpty())</span>
          return false;
  
      ASSERT(!(m_registrableDomainsToBlockAndDeleteCookiesFor.contains(registrableDomain) &amp;&amp; m_registrableDomainsToBlockButKeepCookiesFor.contains(registrableDomain)));
  
      return m_registrableDomainsToBlockButKeepCookiesFor.contains(registrableDomain);
  }
  
<span class="udiff-line-added">+ bool NetworkStorageSession::hasHadUserInteractionAsFirstParty(const RegistrableDomain&amp; registrableDomain) const</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     if (registrableDomain.isEmpty())</span>
<span class="udiff-line-added">+         return false;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     return m_registrableDomainsWithUserInteractionAsFirstParty.contains(registrableDomain);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  bool NetworkStorageSession::shouldBlockCookies(const ResourceRequest&amp; request, Optional&lt;FrameIdentifier&gt; frameID, Optional&lt;PageIdentifier&gt; pageID) const
  {
<span class="udiff-line-added">+     if (!m_isResourceLoadStatisticsEnabled)</span>
<span class="udiff-line-added">+         return false;</span>
<span class="udiff-line-added">+ </span>
      return shouldBlockCookies(request.firstPartyForCookies(), request.url(), frameID, pageID);
  }
  
  bool NetworkStorageSession::shouldBlockCookies(const URL&amp; firstPartyForCookies, const URL&amp; resource, Optional&lt;FrameIdentifier&gt; frameID, Optional&lt;PageIdentifier&gt; pageID) const
  {
<span class="udiff-line-added">+     if (!m_isResourceLoadStatisticsEnabled)</span>
<span class="udiff-line-added">+         return false;</span>
<span class="udiff-line-added">+ </span>
      RegistrableDomain firstPartyDomain { firstPartyForCookies };
      if (firstPartyDomain.isEmpty())
          return false;
  
      RegistrableDomain resourceDomain { resource };
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -98,11 +112,22 @@</span>
          return false;
  
      if (pageID &amp;&amp; hasStorageAccess(resourceDomain, firstPartyDomain, frameID, pageID.value()))
          return false;
  
<span class="udiff-line-modified-removed">-     return shouldBlockThirdPartyCookies(resourceDomain);</span>
<span class="udiff-line-modified-added">+     switch (m_thirdPartyCookieBlockingMode) {</span>
<span class="udiff-line-added">+     case ThirdPartyCookieBlockingMode::All:</span>
<span class="udiff-line-added">+         return true;</span>
<span class="udiff-line-added">+     case ThirdPartyCookieBlockingMode::AllOnSitesWithoutUserInteraction:</span>
<span class="udiff-line-added">+         if (!hasHadUserInteractionAsFirstParty(firstPartyDomain))</span>
<span class="udiff-line-added">+             return true;</span>
<span class="udiff-line-added">+         FALLTHROUGH;</span>
<span class="udiff-line-added">+     case ThirdPartyCookieBlockingMode::OnlyAccordingToPerDomainPolicy:</span>
<span class="udiff-line-added">+         return shouldBlockThirdPartyCookies(resourceDomain);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+     ASSERT_NOT_REACHED();</span>
<span class="udiff-line-added">+     return false;</span>
  }
  
  Optional&lt;Seconds&gt; NetworkStorageSession::maxAgeCacheCap(const ResourceRequest&amp; request)
  {
      if (m_cacheMaxAgeCapForPrevalentResources &amp;&amp; shouldBlockCookies(request, WTF::nullopt, WTF::nullopt))
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -126,10 +151,16 @@</span>
  {
      m_registrableDomainsToBlockButKeepCookiesFor.clear();
      m_registrableDomainsToBlockButKeepCookiesFor.add(domains.begin(), domains.end());
  }
  
<span class="udiff-line-added">+ void NetworkStorageSession::setDomainsWithUserInteractionAsFirstParty(const Vector&lt;RegistrableDomain&gt;&amp; domains)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     m_registrableDomainsWithUserInteractionAsFirstParty.clear();</span>
<span class="udiff-line-added">+     m_registrableDomainsWithUserInteractionAsFirstParty.add(domains.begin(), domains.end());</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  void NetworkStorageSession::removePrevalentDomains(const Vector&lt;RegistrableDomain&gt;&amp; domains)
  {
      for (auto&amp; domain : domains) {
          m_registrableDomainsToBlockAndDeleteCookiesFor.remove(domain);
          m_registrableDomainsToBlockButKeepCookiesFor.remove(domain);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -245,10 +276,15 @@</span>
  {
      m_navigatedToWithLinkDecorationByPrevalentResource.clear();
      m_navigationWithLinkDecorationTestMode = true;
  }
  
<span class="udiff-line-added">+ void NetworkStorageSession::setThirdPartyCookieBlockingMode(ThirdPartyCookieBlockingMode blockingMode)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     m_thirdPartyCookieBlockingMode = blockingMode;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  Optional&lt;Seconds&gt; NetworkStorageSession::clientSideCookieCap(const RegistrableDomain&amp; firstParty, Optional&lt;PageIdentifier&gt; pageID) const
  {
      if (!m_ageCapForClientSideCookies || !pageID || m_navigatedToWithLinkDecorationByPrevalentResource.isEmpty())
          return m_ageCapForClientSideCookies;
  
</pre>
<center><a href="NetworkLoadMetrics.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="NetworkStorageSession.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>