<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.web/src/main/native/Source/JavaScriptCore/runtime/JSArrayInlines.h</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="JSArrayBufferViewInlines.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="JSAsyncFunction.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/JavaScriptCore/runtime/JSArrayInlines.h</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  *  Copyright (C) 2016 Apple Inc. All rights reserved.</span>
   *
   *  This library is free software; you can redistribute it and/or
   *  modify it under the terms of the GNU Lesser General Public
   *  License as published by the Free Software Foundation; either
   *  version 2 of the License, or (at your option) any later version.
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  *  Copyright (C) 2016-2019 Apple Inc. All rights reserved.</span>
   *
   *  This library is free software; you can redistribute it and/or
   *  modify it under the terms of the GNU Lesser General Public
   *  License as published by the Free Software Foundation; either
   *  version 2 of the License, or (at your option) any later version.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 18,10 ***</span>
<span class="line-new-header">--- 18,11 ---</span>
   */
  
  #pragma once
  
  #include &quot;ArrayPrototype.h&quot;
<span class="line-added">+ #include &quot;ButterflyInlines.h&quot;</span>
  #include &quot;Error.h&quot;
  #include &quot;JSArray.h&quot;
  #include &quot;JSCellInlines.h&quot;
  #include &quot;Structure.h&quot;
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 89,25 ***</span>
          return false;
  
      return true;
  }
  
<span class="line-modified">! ALWAYS_INLINE double toLength(ExecState* exec, JSObject* obj)</span>
  {
<span class="line-modified">!     VM&amp; vm = exec-&gt;vm();</span>
      auto scope = DECLARE_THROW_SCOPE(vm);
      if (LIKELY(isJSArray(obj)))
          return jsCast&lt;JSArray*&gt;(obj)-&gt;length();
  
<span class="line-modified">!     JSValue lengthValue = obj-&gt;get(exec, vm.propertyNames-&gt;length);</span>
      RETURN_IF_EXCEPTION(scope, PNaN);
<span class="line-modified">!     RELEASE_AND_RETURN(scope, lengthValue.toLength(exec));</span>
  }
  
<span class="line-modified">! ALWAYS_INLINE void JSArray::pushInline(ExecState* exec, JSValue value)</span>
  {
<span class="line-modified">!     VM&amp; vm = exec-&gt;vm();</span>
      auto scope = DECLARE_THROW_SCOPE(vm);
  
      ensureWritable(vm);
  
      Butterfly* butterfly = this-&gt;butterfly();
<span class="line-new-header">--- 90,25 ---</span>
          return false;
  
      return true;
  }
  
<span class="line-modified">! ALWAYS_INLINE double toLength(JSGlobalObject* globalObject, JSObject* obj)</span>
  {
<span class="line-modified">!     VM&amp; vm = globalObject-&gt;vm();</span>
      auto scope = DECLARE_THROW_SCOPE(vm);
      if (LIKELY(isJSArray(obj)))
          return jsCast&lt;JSArray*&gt;(obj)-&gt;length();
  
<span class="line-modified">!     JSValue lengthValue = obj-&gt;get(globalObject, vm.propertyNames-&gt;length);</span>
      RETURN_IF_EXCEPTION(scope, PNaN);
<span class="line-modified">!     RELEASE_AND_RETURN(scope, lengthValue.toLength(globalObject));</span>
  }
  
<span class="line-modified">! ALWAYS_INLINE void JSArray::pushInline(JSGlobalObject* globalObject, JSValue value)</span>
  {
<span class="line-modified">!     VM&amp; vm = globalObject-&gt;vm();</span>
      auto scope = DECLARE_THROW_SCOPE(vm);
  
      ensureWritable(vm);
  
      Butterfly* butterfly = this-&gt;butterfly();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 119,19 ***</span>
      }
  
      case ArrayWithUndecided: {
          convertUndecidedForValue(vm, value);
          scope.release();
<span class="line-modified">!         push(exec, value);</span>
          return;
      }
  
      case ArrayWithInt32: {
          if (!value.isInt32()) {
              convertInt32ForValue(vm, value);
              scope.release();
<span class="line-modified">!             push(exec, value);</span>
              return;
          }
  
          unsigned length = butterfly-&gt;publicLength();
          ASSERT(length &lt;= butterfly-&gt;vectorLength());
<span class="line-new-header">--- 120,19 ---</span>
      }
  
      case ArrayWithUndecided: {
          convertUndecidedForValue(vm, value);
          scope.release();
<span class="line-modified">!         push(globalObject, value);</span>
          return;
      }
  
      case ArrayWithInt32: {
          if (!value.isInt32()) {
              convertInt32ForValue(vm, value);
              scope.release();
<span class="line-modified">!             push(globalObject, value);</span>
              return;
          }
  
          unsigned length = butterfly-&gt;publicLength();
          ASSERT(length &lt;= butterfly-&gt;vectorLength());
</pre>
<hr />
<pre>
<span class="line-old-header">*** 140,54 ***</span>
              butterfly-&gt;setPublicLength(length + 1);
              return;
          }
  
          if (UNLIKELY(length &gt; MAX_ARRAY_INDEX)) {
<span class="line-modified">!             methodTable(vm)-&gt;putByIndex(this, exec, length, value, true);</span>
              if (!scope.exception())
<span class="line-modified">!                 throwException(exec, scope, createRangeError(exec, LengthExceededTheMaximumArrayLengthError));</span>
              return;
          }
  
          scope.release();
<span class="line-modified">!         putByIndexBeyondVectorLengthWithoutAttributes&lt;Int32Shape&gt;(exec, length, value);</span>
          return;
      }
  
      case ArrayWithContiguous: {
          unsigned length = butterfly-&gt;publicLength();
          ASSERT(length &lt;= butterfly-&gt;vectorLength());
          if (length &lt; butterfly-&gt;vectorLength()) {
<span class="line-modified">!             butterfly-&gt;contiguous().at(this, length).set(vm, this, value);</span>
              butterfly-&gt;setPublicLength(length + 1);
              return;
          }
  
          if (UNLIKELY(length &gt; MAX_ARRAY_INDEX)) {
<span class="line-modified">!             methodTable(vm)-&gt;putByIndex(this, exec, length, value, true);</span>
              if (!scope.exception())
<span class="line-modified">!                 throwException(exec, scope, createRangeError(exec, LengthExceededTheMaximumArrayLengthError));</span>
              return;
          }
  
          scope.release();
<span class="line-modified">!         putByIndexBeyondVectorLengthWithoutAttributes&lt;ContiguousShape&gt;(exec, length, value);</span>
          return;
      }
  
      case ArrayWithDouble: {
          if (!value.isNumber()) {
              convertDoubleToContiguous(vm);
              scope.release();
<span class="line-modified">!             push(exec, value);</span>
              return;
          }
          double valueAsDouble = value.asNumber();
          if (valueAsDouble != valueAsDouble) {
              convertDoubleToContiguous(vm);
              scope.release();
<span class="line-modified">!             push(exec, value);</span>
              return;
          }
  
          unsigned length = butterfly-&gt;publicLength();
          ASSERT(length &lt;= butterfly-&gt;vectorLength());
<span class="line-new-header">--- 141,55 ---</span>
              butterfly-&gt;setPublicLength(length + 1);
              return;
          }
  
          if (UNLIKELY(length &gt; MAX_ARRAY_INDEX)) {
<span class="line-modified">!             methodTable(vm)-&gt;putByIndex(this, globalObject, length, value, true);</span>
              if (!scope.exception())
<span class="line-modified">!                 throwException(globalObject, scope, createRangeError(globalObject, LengthExceededTheMaximumArrayLengthError));</span>
              return;
          }
  
          scope.release();
<span class="line-modified">!         putByIndexBeyondVectorLengthWithoutAttributes&lt;Int32Shape&gt;(globalObject, length, value);</span>
          return;
      }
  
      case ArrayWithContiguous: {
          unsigned length = butterfly-&gt;publicLength();
          ASSERT(length &lt;= butterfly-&gt;vectorLength());
          if (length &lt; butterfly-&gt;vectorLength()) {
<span class="line-modified">!             butterfly-&gt;contiguous().at(this, length).setWithoutWriteBarrier(value);</span>
              butterfly-&gt;setPublicLength(length + 1);
<span class="line-added">+             vm.heap.writeBarrier(this, value);</span>
              return;
          }
  
          if (UNLIKELY(length &gt; MAX_ARRAY_INDEX)) {
<span class="line-modified">!             methodTable(vm)-&gt;putByIndex(this, globalObject, length, value, true);</span>
              if (!scope.exception())
<span class="line-modified">!                 throwException(globalObject, scope, createRangeError(globalObject, LengthExceededTheMaximumArrayLengthError));</span>
              return;
          }
  
          scope.release();
<span class="line-modified">!         putByIndexBeyondVectorLengthWithoutAttributes&lt;ContiguousShape&gt;(globalObject, length, value);</span>
          return;
      }
  
      case ArrayWithDouble: {
          if (!value.isNumber()) {
              convertDoubleToContiguous(vm);
              scope.release();
<span class="line-modified">!             push(globalObject, value);</span>
              return;
          }
          double valueAsDouble = value.asNumber();
          if (valueAsDouble != valueAsDouble) {
              convertDoubleToContiguous(vm);
              scope.release();
<span class="line-modified">!             push(globalObject, value);</span>
              return;
          }
  
          unsigned length = butterfly-&gt;publicLength();
          ASSERT(length &lt;= butterfly-&gt;vectorLength());
</pre>
<hr />
<pre>
<span class="line-old-header">*** 196,30 ***</span>
              butterfly-&gt;setPublicLength(length + 1);
              return;
          }
  
          if (UNLIKELY(length &gt; MAX_ARRAY_INDEX)) {
<span class="line-modified">!             methodTable(vm)-&gt;putByIndex(this, exec, length, value, true);</span>
              if (!scope.exception())
<span class="line-modified">!                 throwException(exec, scope, createRangeError(exec, LengthExceededTheMaximumArrayLengthError));</span>
              return;
          }
  
          scope.release();
<span class="line-modified">!         putByIndexBeyondVectorLengthWithoutAttributes&lt;DoubleShape&gt;(exec, length, value);</span>
          return;
      }
  
      case ArrayWithSlowPutArrayStorage: {
          unsigned oldLength = length();
          bool putResult = false;
<span class="line-modified">!         bool result = attemptToInterceptPutByIndexOnHole(exec, oldLength, value, true, putResult);</span>
          RETURN_IF_EXCEPTION(scope, void());
          if (result) {
              if (oldLength &lt; 0xFFFFFFFFu) {
                  scope.release();
<span class="line-modified">!                 setLength(exec, oldLength + 1, true);</span>
              }
              return;
          }
          FALLTHROUGH;
      }
<span class="line-new-header">--- 198,30 ---</span>
              butterfly-&gt;setPublicLength(length + 1);
              return;
          }
  
          if (UNLIKELY(length &gt; MAX_ARRAY_INDEX)) {
<span class="line-modified">!             methodTable(vm)-&gt;putByIndex(this, globalObject, length, value, true);</span>
              if (!scope.exception())
<span class="line-modified">!                 throwException(globalObject, scope, createRangeError(globalObject, LengthExceededTheMaximumArrayLengthError));</span>
              return;
          }
  
          scope.release();
<span class="line-modified">!         putByIndexBeyondVectorLengthWithoutAttributes&lt;DoubleShape&gt;(globalObject, length, value);</span>
          return;
      }
  
      case ArrayWithSlowPutArrayStorage: {
          unsigned oldLength = length();
          bool putResult = false;
<span class="line-modified">!         bool result = attemptToInterceptPutByIndexOnHole(globalObject, oldLength, value, true, putResult);</span>
          RETURN_IF_EXCEPTION(scope, void());
          if (result) {
              if (oldLength &lt; 0xFFFFFFFFu) {
                  scope.release();
<span class="line-modified">!                 setLength(globalObject, oldLength + 1, true);</span>
              }
              return;
          }
          FALLTHROUGH;
      }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 236,20 ***</span>
              return;
          }
  
          // Pushing to an array of invalid length (2^31-1) stores the property, but throws a range error.
          if (UNLIKELY(storage-&gt;length() &gt; MAX_ARRAY_INDEX)) {
<span class="line-modified">!             methodTable(vm)-&gt;putByIndex(this, exec, storage-&gt;length(), value, true);</span>
              // Per ES5.1 15.4.4.7 step 6 &amp; 15.4.5.1 step 3.d.
              if (!scope.exception())
<span class="line-modified">!                 throwException(exec, scope, createRangeError(exec, LengthExceededTheMaximumArrayLengthError));</span>
              return;
          }
  
          // Handled the same as putIndex.
          scope.release();
<span class="line-modified">!         putByIndexBeyondVectorLengthWithArrayStorage(exec, storage-&gt;length(), value, true, storage);</span>
          return;
      }
  
      default:
          RELEASE_ASSERT_NOT_REACHED();
<span class="line-new-header">--- 238,20 ---</span>
              return;
          }
  
          // Pushing to an array of invalid length (2^31-1) stores the property, but throws a range error.
          if (UNLIKELY(storage-&gt;length() &gt; MAX_ARRAY_INDEX)) {
<span class="line-modified">!             methodTable(vm)-&gt;putByIndex(this, globalObject, storage-&gt;length(), value, true);</span>
              // Per ES5.1 15.4.4.7 step 6 &amp; 15.4.5.1 step 3.d.
              if (!scope.exception())
<span class="line-modified">!                 throwException(globalObject, scope, createRangeError(globalObject, LengthExceededTheMaximumArrayLengthError));</span>
              return;
          }
  
          // Handled the same as putIndex.
          scope.release();
<span class="line-modified">!         putByIndexBeyondVectorLengthWithArrayStorage(globalObject, storage-&gt;length(), value, true, storage);</span>
          return;
      }
  
      default:
          RELEASE_ASSERT_NOT_REACHED();
</pre>
<center><a href="JSArrayBufferViewInlines.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="JSAsyncFunction.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>