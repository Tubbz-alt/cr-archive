<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.web/src/main/native/Source/WebCore/dom/EventTarget.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="EventSender.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="EventTargetFactory.in.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/dom/EventTarget.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 37,11 ***</span>
  #include &quot;HTMLBodyElement.h&quot;
  #include &quot;HTMLHtmlElement.h&quot;
  #include &quot;InspectorInstrumentation.h&quot;
  #include &quot;JSEventListener.h&quot;
  #include &quot;JSLazyEventListener.h&quot;
<span class="line-modified">! #include &quot;RuntimeEnabledFeatures.h&quot;</span>
  #include &quot;ScriptController.h&quot;
  #include &quot;ScriptDisallowedScope.h&quot;
  #include &quot;Settings.h&quot;
  #include &quot;WebKitAnimationEvent.h&quot;
  #include &quot;WebKitTransitionEvent.h&quot;
<span class="line-new-header">--- 37,11 ---</span>
  #include &quot;HTMLBodyElement.h&quot;
  #include &quot;HTMLHtmlElement.h&quot;
  #include &quot;InspectorInstrumentation.h&quot;
  #include &quot;JSEventListener.h&quot;
  #include &quot;JSLazyEventListener.h&quot;
<span class="line-modified">! #include &quot;Quirks.h&quot;</span>
  #include &quot;ScriptController.h&quot;
  #include &quot;ScriptDisallowedScope.h&quot;
  #include &quot;Settings.h&quot;
  #include &quot;WebKitAnimationEvent.h&quot;
  #include &quot;WebKitTransitionEvent.h&quot;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 68,27 ***</span>
      return false;
  }
  
  bool EventTarget::addEventListener(const AtomString&amp; eventType, Ref&lt;EventListener&gt;&amp;&amp; listener, const AddEventListenerOptions&amp; options)
  {
<span class="line-modified">! #if !ASSERT_DISABLED</span>
      listener-&gt;checkValidityForEventTarget(*this);
  #endif
  
      auto passive = options.passive;
  
<span class="line-modified">!     if (!passive.hasValue() &amp;&amp; eventNames().isTouchScrollBlockingEventType(eventType)) {</span>
<span class="line-modified">!         if (is&lt;DOMWindow&gt;(*this)) {</span>
<span class="line-removed">-             auto&amp; window = downcast&lt;DOMWindow&gt;(*this);</span>
<span class="line-removed">-             if (auto* document = window.document())</span>
<span class="line-removed">-                 passive = document-&gt;settings().passiveTouchListenersAsDefaultOnDocument();</span>
<span class="line-removed">-         } else if (is&lt;Node&gt;(*this)) {</span>
<span class="line-removed">-             auto&amp; node = downcast&lt;Node&gt;(*this);</span>
<span class="line-removed">-             if (is&lt;Document&gt;(node) || node.document().documentElement() == &amp;node || node.document().body() == &amp;node)</span>
<span class="line-removed">-                 passive = node.document().settings().passiveTouchListenersAsDefaultOnDocument();</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-     }</span>
  
      bool listenerCreatedFromScript = listener-&gt;type() == EventListener::JSEventListenerType &amp;&amp; !listener-&gt;wasCreatedFromMarkup();
      auto listenerRef = listener.copyRef();
  
      if (!ensureEventTargetData().eventListenerMap.add(eventType, WTFMove(listener), { options.capture, passive.valueOr(false), options.once }))
<span class="line-new-header">--- 68,18 ---</span>
      return false;
  }
  
  bool EventTarget::addEventListener(const AtomString&amp; eventType, Ref&lt;EventListener&gt;&amp;&amp; listener, const AddEventListenerOptions&amp; options)
  {
<span class="line-modified">! #if ASSERT_ENABLED</span>
      listener-&gt;checkValidityForEventTarget(*this);
  #endif
  
      auto passive = options.passive;
  
<span class="line-modified">!     if (!passive.hasValue() &amp;&amp; Quirks::shouldMakeEventListenerPassive(*this, eventType, listener.get()))</span>
<span class="line-modified">!         passive = true;</span>
  
      bool listenerCreatedFromScript = listener-&gt;type() == EventListener::JSEventListenerType &amp;&amp; !listener-&gt;wasCreatedFromMarkup();
      auto listenerRef = listener.copyRef();
  
      if (!ensureEventTargetData().eventListenerMap.add(eventType, WTFMove(listener), { options.capture, passive.valueOr(false), options.once }))
</pre>
<hr />
<pre>
<span class="line-old-header">*** 148,11 ***</span>
          return false;
      }
      if (existingListener) {
          InspectorInstrumentation::willRemoveEventListener(*this, eventType, *existingListener, false);
  
<span class="line-modified">! #if !ASSERT_DISABLED</span>
          listener-&gt;checkValidityForEventTarget(*this);
  #endif
  
          auto listenerPointer = listener.copyRef();
          eventTargetData()-&gt;eventListenerMap.replace(eventType, *existingListener, listener.releaseNonNull(), { });
<span class="line-new-header">--- 139,11 ---</span>
          return false;
      }
      if (existingListener) {
          InspectorInstrumentation::willRemoveEventListener(*this, eventType, *existingListener, false);
  
<span class="line-modified">! #if ASSERT_ENABLED</span>
          listener-&gt;checkValidityForEventTarget(*this);
  #endif
  
          auto listenerPointer = listener.copyRef();
          eventTargetData()-&gt;eventListenerMap.replace(eventType, *existingListener, listener.releaseNonNull(), { });
</pre>
<hr />
<pre>
<span class="line-old-header">*** 185,18 ***</span>
      return data &amp;&amp; data-&gt;eventListenerMap.containsActive(eventType);
  }
  
  ExceptionOr&lt;bool&gt; EventTarget::dispatchEventForBindings(Event&amp; event)
  {
<span class="line-removed">-     event.setUntrusted();</span>
<span class="line-removed">- </span>
      if (!event.isInitialized() || event.isBeingDispatched())
          return Exception { InvalidStateError };
  
      if (!scriptExecutionContext())
          return false;
  
      dispatchEvent(event);
      return event.legacyReturnValue();
  }
  
  void EventTarget::dispatchEvent(Event&amp; event)
<span class="line-new-header">--- 176,18 ---</span>
      return data &amp;&amp; data-&gt;eventListenerMap.containsActive(eventType);
  }
  
  ExceptionOr&lt;bool&gt; EventTarget::dispatchEventForBindings(Event&amp; event)
  {
      if (!event.isInitialized() || event.isBeingDispatched())
          return Exception { InvalidStateError };
  
      if (!scriptExecutionContext())
          return false;
  
<span class="line-added">+     event.setUntrusted();</span>
<span class="line-added">+ </span>
      dispatchEvent(event);
      return event.legacyReturnValue();
  }
  
  void EventTarget::dispatchEvent(Event&amp; event)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 280,13 ***</span>
      ASSERT(!listeners.isEmpty());
      ASSERT(scriptExecutionContext());
  
      auto&amp; context = *scriptExecutionContext();
      bool contextIsDocument = is&lt;Document&gt;(context);
<span class="line-removed">-     InspectorInstrumentationCookie willDispatchEventCookie;</span>
      if (contextIsDocument)
<span class="line-modified">!         willDispatchEventCookie = InspectorInstrumentation::willDispatchEvent(downcast&lt;Document&gt;(context), event, true);</span>
  
      for (auto&amp; registeredListener : listeners) {
          if (UNLIKELY(registeredListener-&gt;wasRemoved()))
              continue;
  
<span class="line-new-header">--- 271,12 ---</span>
      ASSERT(!listeners.isEmpty());
      ASSERT(scriptExecutionContext());
  
      auto&amp; context = *scriptExecutionContext();
      bool contextIsDocument = is&lt;Document&gt;(context);
      if (contextIsDocument)
<span class="line-modified">!         InspectorInstrumentation::willDispatchEvent(downcast&lt;Document&gt;(context), event);</span>
  
      for (auto&amp; registeredListener : listeners) {
          if (UNLIKELY(registeredListener-&gt;wasRemoved()))
              continue;
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 308,11 ***</span>
              removeEventListener(event.type(), registeredListener-&gt;callback(), ListenerOptions(registeredListener-&gt;useCapture()));
  
          if (registeredListener-&gt;isPassive())
              event.setInPassiveListener(true);
  
<span class="line-modified">! #if !ASSERT_DISABLED</span>
          registeredListener-&gt;callback().checkValidityForEventTarget(*this);
  #endif
  
          InspectorInstrumentation::willHandleEvent(context, event, *registeredListener);
          registeredListener-&gt;callback().handleEvent(context, event);
<span class="line-new-header">--- 298,11 ---</span>
              removeEventListener(event.type(), registeredListener-&gt;callback(), ListenerOptions(registeredListener-&gt;useCapture()));
  
          if (registeredListener-&gt;isPassive())
              event.setInPassiveListener(true);
  
<span class="line-modified">! #if ASSERT_ENABLED</span>
          registeredListener-&gt;callback().checkValidityForEventTarget(*this);
  #endif
  
          InspectorInstrumentation::willHandleEvent(context, event, *registeredListener);
          registeredListener-&gt;callback().handleEvent(context, event);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 321,11 ***</span>
          if (registeredListener-&gt;isPassive())
              event.setInPassiveListener(false);
      }
  
      if (contextIsDocument)
<span class="line-modified">!         InspectorInstrumentation::didDispatchEvent(willDispatchEventCookie, event.defaultPrevented());</span>
  }
  
  Vector&lt;AtomString&gt; EventTarget::eventTypes()
  {
      if (auto* data = eventTargetData())
<span class="line-new-header">--- 311,11 ---</span>
          if (registeredListener-&gt;isPassive())
              event.setInPassiveListener(false);
      }
  
      if (contextIsDocument)
<span class="line-modified">!         InspectorInstrumentation::didDispatchEvent(downcast&lt;Document&gt;(context), event);</span>
  }
  
  Vector&lt;AtomString&gt; EventTarget::eventTypes()
  {
      if (auto* data = eventTargetData())
</pre>
<center><a href="EventSender.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="EventTargetFactory.in.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>