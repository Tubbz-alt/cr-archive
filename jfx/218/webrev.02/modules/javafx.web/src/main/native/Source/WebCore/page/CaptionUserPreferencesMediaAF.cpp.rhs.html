<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/WebCore/page/CaptionUserPreferencesMediaAF.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (C) 2012-2017 Apple Inc. All rights reserved.
  3  *
  4  * Redistribution and use in source and binary forms, with or without
  5  * modification, are permitted provided that the following conditions
  6  * are met:
  7  * 1. Redistributions of source code must retain the above copyright
  8  *    notice, this list of conditions and the following disclaimer.
  9  * 2. Redistributions in binary form must reproduce the above copyright
 10  *    notice, this list of conditions and the following disclaimer in the
 11  *    documentation and/or other materials provided with the distribution.
 12  *
 13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. ``AS IS&#39;&#39; AND ANY
 14  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 15  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 16  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE INC. OR
 17  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 18  * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 19  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 20  * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 21  * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 22  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 23  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #include &quot;config.h&quot;
 27 
 28 #if ENABLE(VIDEO_TRACK)
 29 
 30 #if !USE(DIRECT2D)
 31 
 32 #include &quot;CaptionUserPreferencesMediaAF.h&quot;
 33 
 34 #include &quot;AudioTrackList.h&quot;
 35 #include &quot;FloatConversion.h&quot;
 36 #include &quot;HTMLMediaElement.h&quot;
 37 #include &quot;LocalizedStrings.h&quot;
 38 #include &quot;Logging.h&quot;
 39 #include &quot;MediaControlElements.h&quot;
 40 #include &quot;TextTrackList.h&quot;
 41 #include &quot;UserStyleSheetTypes.h&quot;
 42 #include &quot;VTTCue.h&quot;
 43 #include &lt;algorithm&gt;
 44 #include &lt;wtf/Language.h&gt;
 45 #include &lt;wtf/NeverDestroyed.h&gt;
 46 #include &lt;wtf/RetainPtr.h&gt;
 47 #include &lt;wtf/SoftLinking.h&gt;
 48 #include &lt;wtf/URL.h&gt;
 49 #include &lt;wtf/text/CString.h&gt;
 50 #include &lt;wtf/text/StringBuilder.h&gt;
 51 #include &lt;wtf/text/StringConcatenateNumbers.h&gt;
 52 
 53 #if PLATFORM(IOS_FAMILY)
 54 #import &quot;WebCoreThreadRun.h&quot;
 55 #endif
 56 
 57 #if PLATFORM(WIN)
 58 #include &lt;pal/spi/win/CoreTextSPIWin.h&gt;
 59 #endif
 60 
 61 #if COMPILER(MSVC)
 62 // See https://msdn.microsoft.com/en-us/library/35bhkfb6.aspx
 63 #pragma warning(disable: 4273)
 64 #endif
 65 
 66 #if HAVE(MEDIA_ACCESSIBILITY_FRAMEWORK)
 67 
 68 #include &lt;CoreText/CoreText.h&gt;
 69 #include &lt;MediaAccessibility/MediaAccessibility.h&gt;
 70 
 71 #include &quot;MediaAccessibilitySoftLink.h&quot;
 72 
 73 #if PLATFORM(WIN)
 74 
 75 #ifdef DEBUG_ALL
 76 #define SOFT_LINK_AVF_FRAMEWORK(Lib) SOFT_LINK_DEBUG_LIBRARY(Lib)
 77 #else
 78 #define SOFT_LINK_AVF_FRAMEWORK(Lib) SOFT_LINK_LIBRARY(Lib)
 79 #endif
 80 
 81 #define SOFT_LINK_AVF(Lib, Name, Type) SOFT_LINK_DLL_IMPORT(Lib, Name, Type)
 82 #define SOFT_LINK_AVF_POINTER(Lib, Name, Type) SOFT_LINK_VARIABLE_DLL_IMPORT_OPTIONAL(Lib, Name, Type)
 83 #define SOFT_LINK_AVF_FRAMEWORK_IMPORT(Lib, Fun, ReturnType, Arguments, Signature) SOFT_LINK_DLL_IMPORT(Lib, Fun, ReturnType, __cdecl, Arguments, Signature)
 84 #define SOFT_LINK_AVF_FRAMEWORK_IMPORT_OPTIONAL(Lib, Fun, ReturnType, Arguments) SOFT_LINK_DLL_IMPORT_OPTIONAL(Lib, Fun, ReturnType, __cdecl, Arguments)
 85 
 86 SOFT_LINK_AVF_FRAMEWORK(CoreMedia)
 87 SOFT_LINK_AVF_FRAMEWORK_IMPORT_OPTIONAL(CoreMedia, MTEnableCaption2015Behavior, Boolean, ())
 88 
 89 #else // PLATFORM(WIN)
 90 
 91 SOFT_LINK_FRAMEWORK_OPTIONAL(MediaToolbox)
 92 SOFT_LINK_OPTIONAL(MediaToolbox, MTEnableCaption2015Behavior, Boolean, (), ())
 93 
 94 #endif // !PLATFORM(WIN)
 95 
 96 #endif // HAVE(MEDIA_ACCESSIBILITY_FRAMEWORK)
 97 
 98 namespace WebCore {
 99 
100 #if HAVE(MEDIA_ACCESSIBILITY_FRAMEWORK)
101 
102 static void userCaptionPreferencesChangedNotificationCallback(CFNotificationCenterRef, void* observer, CFStringRef, const void *, CFDictionaryRef)
103 {
104 #if !PLATFORM(IOS_FAMILY)
105     static_cast&lt;CaptionUserPreferencesMediaAF*&gt;(observer)-&gt;captionPreferencesChanged();
106 #else
107     WebThreadRun(^{
108         static_cast&lt;CaptionUserPreferencesMediaAF*&gt;(observer)-&gt;captionPreferencesChanged();
109     });
110 #endif
111 }
112 
113 #endif
114 
115 CaptionUserPreferencesMediaAF::CaptionUserPreferencesMediaAF(PageGroup&amp; group)
116     : CaptionUserPreferences(group)
117 #if HAVE(MEDIA_ACCESSIBILITY_FRAMEWORK)
118     , m_updateStyleSheetTimer(*this, &amp;CaptionUserPreferencesMediaAF::updateTimerFired)
119     , m_listeningForPreferenceChanges(false)
120 #endif
121 {
122     static bool initialized;
123     if (!initialized) {
124         initialized = true;
125 
126 #if !PLATFORM(WIN)
127         if (!MediaToolboxLibrary())
128             return;
129 #endif
130 
131         MTEnableCaption2015BehaviorPtrType function = MTEnableCaption2015BehaviorPtr();
132         if (!function || !function())
133             return;
134 
135         beginBlockingNotifications();
136         CaptionUserPreferences::setCaptionDisplayMode(Manual);
137         setUserPrefersCaptions(false);
138         setUserPrefersSubtitles(false);
139         setUserPrefersTextDescriptions(false);
140         endBlockingNotifications();
141     }
142 }
143 
144 CaptionUserPreferencesMediaAF::~CaptionUserPreferencesMediaAF()
145 {
146 #if HAVE(MEDIA_ACCESSIBILITY_FRAMEWORK)
147     if (kMAXCaptionAppearanceSettingsChangedNotification)
148         CFNotificationCenterRemoveObserver(CFNotificationCenterGetLocalCenter(), this, kMAXCaptionAppearanceSettingsChangedNotification, 0);
149     if (kMAAudibleMediaSettingsChangedNotification)
150         CFNotificationCenterRemoveObserver(CFNotificationCenterGetLocalCenter(), this, kMAAudibleMediaSettingsChangedNotification, 0);
151 #endif
152 }
153 
154 #if HAVE(MEDIA_ACCESSIBILITY_FRAMEWORK)
155 
156 CaptionUserPreferences::CaptionDisplayMode CaptionUserPreferencesMediaAF::captionDisplayMode() const
157 {
158     CaptionDisplayMode internalMode = CaptionUserPreferences::captionDisplayMode();
159     if (internalMode == Manual || testingMode() || !MediaAccessibilityLibrary())
160         return internalMode;
161 
162     MACaptionAppearanceDisplayType displayType = MACaptionAppearanceGetDisplayType(kMACaptionAppearanceDomainUser);
163     switch (displayType) {
164     case kMACaptionAppearanceDisplayTypeForcedOnly:
165         return ForcedOnly;
166 
167     case kMACaptionAppearanceDisplayTypeAutomatic:
168         return Automatic;
169 
170     case kMACaptionAppearanceDisplayTypeAlwaysOn:
171         return AlwaysOn;
172     }
173 
174     ASSERT_NOT_REACHED();
175     return ForcedOnly;
176 }
177 
178 void CaptionUserPreferencesMediaAF::setCaptionDisplayMode(CaptionUserPreferences::CaptionDisplayMode mode)
179 {
180     if (testingMode() || !MediaAccessibilityLibrary()) {
181         CaptionUserPreferences::setCaptionDisplayMode(mode);
182         return;
183     }
184 
185     if (captionDisplayMode() == Manual)
186         return;
187 
188     MACaptionAppearanceDisplayType displayType = kMACaptionAppearanceDisplayTypeForcedOnly;
189     switch (mode) {
190     case Automatic:
191         displayType = kMACaptionAppearanceDisplayTypeAutomatic;
192         break;
193     case ForcedOnly:
194         displayType = kMACaptionAppearanceDisplayTypeForcedOnly;
195         break;
196     case AlwaysOn:
197         displayType = kMACaptionAppearanceDisplayTypeAlwaysOn;
198         break;
199     default:
200         ASSERT_NOT_REACHED();
201         break;
202     }
203 
204     MACaptionAppearanceSetDisplayType(kMACaptionAppearanceDomainUser, displayType);
205 }
206 
207 bool CaptionUserPreferencesMediaAF::userPrefersCaptions() const
208 {
209     bool captionSetting = CaptionUserPreferences::userPrefersCaptions();
210     if (captionSetting || testingMode() || !MediaAccessibilityLibrary())
211         return captionSetting;
212 
213     RetainPtr&lt;CFArrayRef&gt; captioningMediaCharacteristics = adoptCF(MACaptionAppearanceCopyPreferredCaptioningMediaCharacteristics(kMACaptionAppearanceDomainUser));
214     return captioningMediaCharacteristics &amp;&amp; CFArrayGetCount(captioningMediaCharacteristics.get());
215 }
216 
217 bool CaptionUserPreferencesMediaAF::userPrefersSubtitles() const
218 {
219     bool subtitlesSetting = CaptionUserPreferences::userPrefersSubtitles();
220     if (subtitlesSetting || testingMode() || !MediaAccessibilityLibrary())
221         return subtitlesSetting;
222 
223     RetainPtr&lt;CFArrayRef&gt; captioningMediaCharacteristics = adoptCF(MACaptionAppearanceCopyPreferredCaptioningMediaCharacteristics(kMACaptionAppearanceDomainUser));
224     return !(captioningMediaCharacteristics &amp;&amp; CFArrayGetCount(captioningMediaCharacteristics.get()));
225 }
226 
227 void CaptionUserPreferencesMediaAF::updateTimerFired()
228 {
229     updateCaptionStyleSheetOverride();
230 }
231 
232 void CaptionUserPreferencesMediaAF::setInterestedInCaptionPreferenceChanges()
233 {
234     if (m_listeningForPreferenceChanges)
235         return;
236 
237     if (!MediaAccessibilityLibrary())
238         return;
239 
240     if (!kMAXCaptionAppearanceSettingsChangedNotification &amp;&amp; !canLoad_MediaAccessibility_kMAAudibleMediaSettingsChangedNotification())
241         return;
242 
243     m_listeningForPreferenceChanges = true;
244     m_registeringForNotification = true;
245 
246     if (kMAXCaptionAppearanceSettingsChangedNotification)
247         CFNotificationCenterAddObserver(CFNotificationCenterGetLocalCenter(), this, userCaptionPreferencesChangedNotificationCallback, kMAXCaptionAppearanceSettingsChangedNotification, 0, CFNotificationSuspensionBehaviorCoalesce);
248     if (canLoad_MediaAccessibility_kMAAudibleMediaSettingsChangedNotification())
249         CFNotificationCenterAddObserver(CFNotificationCenterGetLocalCenter(), this, userCaptionPreferencesChangedNotificationCallback, kMAAudibleMediaSettingsChangedNotification, 0, CFNotificationSuspensionBehaviorCoalesce);
250     m_registeringForNotification = false;
251 
252     // Generating and registering the caption stylesheet can be expensive and this method is called indirectly when the parser creates an audio or
253     // video element, so do it after a brief pause.
254     m_updateStyleSheetTimer.startOneShot(0_s);
255 }
256 
257 void CaptionUserPreferencesMediaAF::captionPreferencesChanged()
258 {
259     if (m_registeringForNotification)
260         return;
261 
262     if (m_listeningForPreferenceChanges)
263         updateCaptionStyleSheetOverride();
264 
265     CaptionUserPreferences::captionPreferencesChanged();
266 }
267 
268 String CaptionUserPreferencesMediaAF::captionsWindowCSS() const
269 {
270     MACaptionAppearanceBehavior behavior;
271     RetainPtr&lt;CGColorRef&gt; color = adoptCF(MACaptionAppearanceCopyWindowColor(kMACaptionAppearanceDomainUser, &amp;behavior));
272 
273     Color windowColor(color.get());
274     if (!windowColor.isValid())
275         windowColor = Color::transparent;
276 
277     bool important = behavior == kMACaptionAppearanceBehaviorUseValue;
278     CGFloat opacity = MACaptionAppearanceGetWindowOpacity(kMACaptionAppearanceDomainUser, &amp;behavior);
279     if (!important)
280         important = behavior == kMACaptionAppearanceBehaviorUseValue;
281     String windowStyle = colorPropertyCSS(CSSPropertyBackgroundColor, Color(windowColor.red(), windowColor.green(), windowColor.blue(), static_cast&lt;int&gt;(opacity * 255)), important);
282 
283     if (!opacity)
284         return windowStyle;
285 
286     return makeString(windowStyle, getPropertyNameString(CSSPropertyPadding), &quot;: .4em !important;&quot;);
287 }
288 
289 String CaptionUserPreferencesMediaAF::captionsBackgroundCSS() const
290 {
291     // This default value must be the same as the one specified in mediaControls.css for -webkit-media-text-track-past-nodes
292     // and webkit-media-text-track-future-nodes.
293     static NeverDestroyed&lt;Color&gt; defaultBackgroundColor(0, 0, 0, 0.8 * 255);
294 
295     MACaptionAppearanceBehavior behavior;
296 
297     RetainPtr&lt;CGColorRef&gt; color = adoptCF(MACaptionAppearanceCopyBackgroundColor(kMACaptionAppearanceDomainUser, &amp;behavior));
298     Color backgroundColor(color.get());
299     if (!backgroundColor.isValid())
300         backgroundColor = defaultBackgroundColor;
301 
302     bool important = behavior == kMACaptionAppearanceBehaviorUseValue;
303     CGFloat opacity = MACaptionAppearanceGetBackgroundOpacity(kMACaptionAppearanceDomainUser, &amp;behavior);
304     if (!important)
305         important = behavior == kMACaptionAppearanceBehaviorUseValue;
306     return colorPropertyCSS(CSSPropertyBackgroundColor, Color(backgroundColor.red(), backgroundColor.green(), backgroundColor.blue(), static_cast&lt;int&gt;(opacity * 255)), important);
307 }
308 
309 Color CaptionUserPreferencesMediaAF::captionsTextColor(bool&amp; important) const
310 {
311     MACaptionAppearanceBehavior behavior;
312     RetainPtr&lt;CGColorRef&gt; color = adoptCF(MACaptionAppearanceCopyForegroundColor(kMACaptionAppearanceDomainUser, &amp;behavior));
313     Color textColor(color.get());
314     if (!textColor.isValid())
315         // This default value must be the same as the one specified in mediaControls.css for -webkit-media-text-track-container.
316         textColor = Color::white;
317 
318     important = behavior == kMACaptionAppearanceBehaviorUseValue;
319     CGFloat opacity = MACaptionAppearanceGetForegroundOpacity(kMACaptionAppearanceDomainUser, &amp;behavior);
320     if (!important)
321         important = behavior == kMACaptionAppearanceBehaviorUseValue;
322     return Color(textColor.red(), textColor.green(), textColor.blue(), static_cast&lt;int&gt;(opacity * 255));
323 }
324 
325 String CaptionUserPreferencesMediaAF::captionsTextColorCSS() const
326 {
327     bool important;
328     Color textColor = captionsTextColor(important);
329 
330     if (!textColor.isValid())
331         return emptyString();
332 
333     return colorPropertyCSS(CSSPropertyColor, textColor, important);
334 }
335 
336 static void appendCSS(StringBuilder&amp; builder, CSSPropertyID id, const String&amp; value, bool important)
337 {
338     builder.append(getPropertyNameString(id));
339     builder.append(&#39;:&#39;);
340     builder.append(value);
341     if (important)
342         builder.appendLiteral(&quot; !important&quot;);
343     builder.append(&#39;;&#39;);
344 }
345 
346 String CaptionUserPreferencesMediaAF::windowRoundedCornerRadiusCSS() const
347 {
348     MACaptionAppearanceBehavior behavior;
349     CGFloat radius = MACaptionAppearanceGetWindowRoundedCornerRadius(kMACaptionAppearanceDomainUser, &amp;behavior);
350     if (!radius)
351         return emptyString();
352 
353     StringBuilder builder;
<a name="1" id="anc1"></a><span class="line-modified">354     appendCSS(builder, CSSPropertyBorderRadius, makeString(radius, &quot;px&quot;), behavior == kMACaptionAppearanceBehaviorUseValue);</span>
355     return builder.toString();
356 }
357 
358 String CaptionUserPreferencesMediaAF::colorPropertyCSS(CSSPropertyID id, const Color&amp; color, bool important) const
359 {
360     StringBuilder builder;
361     appendCSS(builder, id, color.serialized(), important);
362     return builder.toString();
363 }
364 
365 bool CaptionUserPreferencesMediaAF::captionStrokeWidthForFont(float fontSize, const String&amp; language, float&amp; strokeWidth, bool&amp; important) const
366 {
367     if (!canLoad_MediaAccessibility_MACaptionAppearanceCopyFontDescriptorWithStrokeForStyle())
368         return false;
369 
370     MACaptionAppearanceBehavior behavior;
371     auto trackLanguage = language.createCFString();
372     CGFloat strokeWidthPt;
373 
374     auto fontDescriptor = adoptCF(MACaptionAppearanceCopyFontDescriptorWithStrokeForStyle(kMACaptionAppearanceDomainUser, &amp;behavior, kMACaptionAppearanceFontStyleDefault, trackLanguage.get(), fontSize, &amp;strokeWidthPt));
375 
376     if (!fontDescriptor)
377         return false;
378 
379     // Since only half of the stroke is visible because the stroke is drawn before the fill, we double the stroke width here.
380     strokeWidth = strokeWidthPt * 2;
381     important = behavior == kMACaptionAppearanceBehaviorUseValue;
382 
383     return true;
384 }
385 
386 String CaptionUserPreferencesMediaAF::captionsTextEdgeCSS() const
387 {
388     static NeverDestroyed&lt;const String&gt; edgeStyleRaised(MAKE_STATIC_STRING_IMPL(&quot; -.1em -.1em .16em &quot;));
389     static NeverDestroyed&lt;const String&gt; edgeStyleDepressed(MAKE_STATIC_STRING_IMPL(&quot; .1em .1em .16em &quot;));
390     static NeverDestroyed&lt;const String&gt; edgeStyleDropShadow(MAKE_STATIC_STRING_IMPL(&quot; 0 .1em .16em &quot;));
391 
392     MACaptionAppearanceBehavior behavior;
393     MACaptionAppearanceTextEdgeStyle textEdgeStyle = MACaptionAppearanceGetTextEdgeStyle(kMACaptionAppearanceDomainUser, &amp;behavior);
394 
395     if (textEdgeStyle == kMACaptionAppearanceTextEdgeStyleUndefined || textEdgeStyle == kMACaptionAppearanceTextEdgeStyleNone)
396         return emptyString();
397 
398     StringBuilder builder;
399     bool important = behavior == kMACaptionAppearanceBehaviorUseValue;
400     if (textEdgeStyle == kMACaptionAppearanceTextEdgeStyleRaised)
401         appendCSS(builder, CSSPropertyTextShadow, makeString(edgeStyleRaised.get(), &quot; black&quot;), important);
402     else if (textEdgeStyle == kMACaptionAppearanceTextEdgeStyleDepressed)
403         appendCSS(builder, CSSPropertyTextShadow, makeString(edgeStyleDepressed.get(), &quot; black&quot;), important);
404     else if (textEdgeStyle == kMACaptionAppearanceTextEdgeStyleDropShadow)
405         appendCSS(builder, CSSPropertyTextShadow, makeString(edgeStyleDropShadow.get(), &quot; black&quot;), important);
406 
407     if (textEdgeStyle == kMACaptionAppearanceTextEdgeStyleDropShadow || textEdgeStyle == kMACaptionAppearanceTextEdgeStyleUniform) {
408         appendCSS(builder, CSSPropertyStrokeColor, &quot;black&quot;, important);
409         appendCSS(builder, CSSPropertyPaintOrder, getValueName(CSSValueStroke), important);
410         appendCSS(builder, CSSPropertyStrokeLinejoin, getValueName(CSSValueRound), important);
411         appendCSS(builder, CSSPropertyStrokeLinecap, getValueName(CSSValueRound), important);
412     }
413 
414     return builder.toString();
415 }
416 
417 String CaptionUserPreferencesMediaAF::captionsDefaultFontCSS() const
418 {
419     MACaptionAppearanceBehavior behavior;
420 
421     RetainPtr&lt;CTFontDescriptorRef&gt; font = adoptCF(MACaptionAppearanceCopyFontDescriptorForStyle(kMACaptionAppearanceDomainUser, &amp;behavior, kMACaptionAppearanceFontStyleDefault));
422     if (!font)
423         return emptyString();
424 
425     RetainPtr&lt;CFTypeRef&gt; name = adoptCF(CTFontDescriptorCopyAttribute(font.get(), kCTFontNameAttribute));
426     if (!name)
427         return emptyString();
428 
429     StringBuilder builder;
430 
431     builder.append(getPropertyNameString(CSSPropertyFontFamily));
432     builder.appendLiteral(&quot;: \&quot;&quot;);
433     builder.append(static_cast&lt;CFStringRef&gt;(name.get()));
434     builder.append(&#39;&quot;&#39;);
435 
436     auto cascadeList = adoptCF(static_cast&lt;CFArrayRef&gt;(CTFontDescriptorCopyAttribute(font.get(), kCTFontCascadeListAttribute)));
437 
438     if (cascadeList) {
439         for (CFIndex i = 0; i &lt; CFArrayGetCount(cascadeList.get()); i++) {
440             auto fontCascade = static_cast&lt;CTFontDescriptorRef&gt;(CFArrayGetValueAtIndex(cascadeList.get(), i));
441             if (!fontCascade)
442                 continue;
443             auto fontCascadeName = adoptCF(CTFontDescriptorCopyAttribute(fontCascade, kCTFontNameAttribute));
444             if (!fontCascadeName)
445                 continue;
446             builder.append(&quot;, \&quot;&quot;);
447             builder.append(static_cast&lt;CFStringRef&gt;(fontCascadeName.get()));
448             builder.append(&#39;&quot;&#39;);
449         }
450     }
451 
452     if (behavior == kMACaptionAppearanceBehaviorUseValue)
453         builder.appendLiteral(&quot; !important&quot;);
454     builder.append(&#39;;&#39;);
455 
456     return builder.toString();
457 }
458 
459 float CaptionUserPreferencesMediaAF::captionFontSizeScaleAndImportance(bool&amp; important) const
460 {
461     if (testingMode() || !MediaAccessibilityLibrary())
462         return CaptionUserPreferences::captionFontSizeScaleAndImportance(important);
463 
464     MACaptionAppearanceBehavior behavior;
465     CGFloat characterScale = CaptionUserPreferences::captionFontSizeScaleAndImportance(important);
466     CGFloat scaleAdjustment = MACaptionAppearanceGetRelativeCharacterSize(kMACaptionAppearanceDomainUser, &amp;behavior);
467 
468     if (!scaleAdjustment)
469         return characterScale;
470 
471     important = behavior == kMACaptionAppearanceBehaviorUseValue;
472 #if defined(__LP64__) &amp;&amp; __LP64__
473     return narrowPrecisionToFloat(scaleAdjustment * characterScale);
474 #else
475     return scaleAdjustment * characterScale;
476 #endif
477 }
478 
479 void CaptionUserPreferencesMediaAF::setPreferredLanguage(const String&amp; language)
480 {
481     if (CaptionUserPreferences::captionDisplayMode() == Manual)
482         return;
483 
484     if (testingMode() || !MediaAccessibilityLibrary()) {
485         CaptionUserPreferences::setPreferredLanguage(language);
486         return;
487     }
488 
489     MACaptionAppearanceAddSelectedLanguage(kMACaptionAppearanceDomainUser, language.createCFString().get());
490 }
491 
492 Vector&lt;String&gt; CaptionUserPreferencesMediaAF::preferredLanguages() const
493 {
494     if (testingMode() || !MediaAccessibilityLibrary())
495         return CaptionUserPreferences::preferredLanguages();
496 
497     Vector&lt;String&gt; platformLanguages = platformUserPreferredLanguages();
498     Vector&lt;String&gt; override = userPreferredLanguagesOverride();
499     if (!override.isEmpty()) {
500         if (platformLanguages.size() != override.size())
501             return override;
502         for (size_t i = 0; i &lt; override.size(); i++) {
503             if (override[i] != platformLanguages[i])
504                 return override;
505         }
506     }
507 
508     CFIndex languageCount = 0;
509     RetainPtr&lt;CFArrayRef&gt; languages = adoptCF(MACaptionAppearanceCopySelectedLanguages(kMACaptionAppearanceDomainUser));
510     if (languages)
511         languageCount = CFArrayGetCount(languages.get());
512 
513     if (!languageCount)
514         return CaptionUserPreferences::preferredLanguages();
515 
516     Vector&lt;String&gt; userPreferredLanguages;
517     userPreferredLanguages.reserveCapacity(languageCount + platformLanguages.size());
518     for (CFIndex i = 0; i &lt; languageCount; i++)
519         userPreferredLanguages.append(static_cast&lt;CFStringRef&gt;(CFArrayGetValueAtIndex(languages.get(), i)));
520 
521     userPreferredLanguages.appendVector(platformLanguages);
522 
523     return userPreferredLanguages;
524 }
525 
526 void CaptionUserPreferencesMediaAF::setPreferredAudioCharacteristic(const String&amp; characteristic)
527 {
528     if (testingMode() || !MediaAccessibilityLibrary())
529         CaptionUserPreferences::setPreferredAudioCharacteristic(characteristic);
530 }
531 
532 Vector&lt;String&gt; CaptionUserPreferencesMediaAF::preferredAudioCharacteristics() const
533 {
534     if (testingMode() || !MediaAccessibilityLibrary() || !canLoad_MediaAccessibility_MAAudibleMediaCopyPreferredCharacteristics())
535         return CaptionUserPreferences::preferredAudioCharacteristics();
536 
537     CFIndex characteristicCount = 0;
538     RetainPtr&lt;CFArrayRef&gt; characteristics = adoptCF(MAAudibleMediaCopyPreferredCharacteristics());
539     if (characteristics)
540         characteristicCount = CFArrayGetCount(characteristics.get());
541 
542     if (!characteristicCount)
543         return CaptionUserPreferences::preferredAudioCharacteristics();
544 
545     Vector&lt;String&gt; userPreferredAudioCharacteristics;
546     userPreferredAudioCharacteristics.reserveCapacity(characteristicCount);
547     for (CFIndex i = 0; i &lt; characteristicCount; i++)
548         userPreferredAudioCharacteristics.append(static_cast&lt;CFStringRef&gt;(CFArrayGetValueAtIndex(characteristics.get(), i)));
549 
550     return userPreferredAudioCharacteristics;
551 }
552 #endif // HAVE(MEDIA_ACCESSIBILITY_FRAMEWORK)
553 
554 String CaptionUserPreferencesMediaAF::captionsStyleSheetOverride() const
555 {
556     if (testingMode())
557         return CaptionUserPreferences::captionsStyleSheetOverride();
558 
559     StringBuilder captionsOverrideStyleSheet;
560 
561 #if HAVE(MEDIA_ACCESSIBILITY_FRAMEWORK)
562     if (!MediaAccessibilityLibrary())
563         return CaptionUserPreferences::captionsStyleSheetOverride();
564 
565     String captionsColor = captionsTextColorCSS();
566     String edgeStyle = captionsTextEdgeCSS();
567     String fontName = captionsDefaultFontCSS();
568     String background = captionsBackgroundCSS();
569     if (!background.isEmpty() || !captionsColor.isEmpty() || !edgeStyle.isEmpty() || !fontName.isEmpty()) {
570         captionsOverrideStyleSheet.appendLiteral(&quot; ::&quot;);
571         captionsOverrideStyleSheet.append(TextTrackCue::cueShadowPseudoId());
572         captionsOverrideStyleSheet.append(&#39;{&#39;);
573 
574         if (!background.isEmpty())
575             captionsOverrideStyleSheet.append(background);
576         if (!captionsColor.isEmpty())
577             captionsOverrideStyleSheet.append(captionsColor);
578         if (!edgeStyle.isEmpty())
579             captionsOverrideStyleSheet.append(edgeStyle);
580         if (!fontName.isEmpty())
581             captionsOverrideStyleSheet.append(fontName);
582 
583         captionsOverrideStyleSheet.append(&#39;}&#39;);
584     }
585 
586     String windowColor = captionsWindowCSS();
587     String windowCornerRadius = windowRoundedCornerRadiusCSS();
588     if (!windowColor.isEmpty() || !windowCornerRadius.isEmpty()) {
589         captionsOverrideStyleSheet.appendLiteral(&quot; ::&quot;);
<a name="2" id="anc2"></a><span class="line-modified">590         captionsOverrideStyleSheet.append(TextTrackCue::cueBackdropShadowPseudoId());</span>
591         captionsOverrideStyleSheet.append(&#39;{&#39;);
592 
593         if (!windowColor.isEmpty())
594             captionsOverrideStyleSheet.append(windowColor);
595         if (!windowCornerRadius.isEmpty()) {
596             captionsOverrideStyleSheet.append(windowCornerRadius);
597         }
598 
599         captionsOverrideStyleSheet.append(&#39;}&#39;);
600     }
601 #endif // HAVE(MEDIA_ACCESSIBILITY_FRAMEWORK)
602 
603     LOG(Media, &quot;CaptionUserPreferencesMediaAF::captionsStyleSheetOverrideSetting style to:\n%s&quot;, captionsOverrideStyleSheet.toString().utf8().data());
604 
605     return captionsOverrideStyleSheet.toString();
606 }
607 
608 static String languageIdentifier(const String&amp; languageCode)
609 {
610     if (languageCode.isEmpty())
611         return languageCode;
612 
613     String lowercaseLanguageCode = languageCode.convertToASCIILowercase();
614 
615     // Need 2U here to disambiguate String::operator[] from operator(NSString*, int)[] in a production build.
616     if (lowercaseLanguageCode.length() &gt;= 3 &amp;&amp; (lowercaseLanguageCode[2U] == &#39;_&#39; || lowercaseLanguageCode[2U] == &#39;-&#39;))
617         lowercaseLanguageCode.truncate(2);
618 
619     return lowercaseLanguageCode;
620 }
621 
622 static void buildDisplayStringForTrackBase(StringBuilder&amp; displayName, const TrackBase&amp; track)
623 {
624     String label = track.label();
625     String trackLanguageIdentifier = track.validBCP47Language();
626 
627     RetainPtr&lt;CFLocaleRef&gt; currentLocale = adoptCF(CFLocaleCreate(kCFAllocatorDefault, defaultLanguage().createCFString().get()));
628     RetainPtr&lt;CFStringRef&gt; localeIdentifier = adoptCF(CFLocaleCreateCanonicalLocaleIdentifierFromString(kCFAllocatorDefault, trackLanguageIdentifier.createCFString().get()));
629     RetainPtr&lt;CFStringRef&gt; languageCF = adoptCF(CFLocaleCopyDisplayNameForPropertyValue(currentLocale.get(), kCFLocaleLanguageCode, localeIdentifier.get()));
630     String language = languageCF.get();
631 
632     if (!label.isEmpty()) {
633         if (language.isEmpty() || label.contains(language))
634             displayName.append(label);
635         else {
636             RetainPtr&lt;CFDictionaryRef&gt; localeDict = adoptCF(CFLocaleCreateComponentsFromLocaleIdentifier(kCFAllocatorDefault, localeIdentifier.get()));
637             if (localeDict) {
638                 CFStringRef countryCode = 0;
639                 String countryName;
640 
641                 CFDictionaryGetValueIfPresent(localeDict.get(), kCFLocaleCountryCode, (const void **)&amp;countryCode);
642                 if (countryCode) {
643                     RetainPtr&lt;CFStringRef&gt; countryNameCF = adoptCF(CFLocaleCopyDisplayNameForPropertyValue(currentLocale.get(), kCFLocaleCountryCode, countryCode));
644                     countryName = countryNameCF.get();
645                 }
646 
647                 if (!countryName.isEmpty())
648                     displayName.append(textTrackCountryAndLanguageMenuItemText(label, countryName, language));
649                 else
650                     displayName.append(textTrackLanguageMenuItemText(label, language));
651             }
652         }
653     } else {
654         String languageAndLocale = adoptCF(CFLocaleCopyDisplayNameForPropertyValue(currentLocale.get(), kCFLocaleIdentifier, trackLanguageIdentifier.createCFString().get())).get();
655         if (!languageAndLocale.isEmpty())
656             displayName.append(languageAndLocale);
657         else if (!language.isEmpty())
658             displayName.append(language);
659         else
660             displayName.append(localeIdentifier.get());
661     }
662 }
663 
664 static String trackDisplayName(AudioTrack* track)
665 {
666     StringBuilder displayName;
667     buildDisplayStringForTrackBase(displayName, *track);
668 
669     if (displayName.isEmpty())
670         displayName.append(audioTrackNoLabelText());
671 
672     if (track-&gt;kind() != AudioTrack::descriptionKeyword())
673         return displayName.toString();
674 
675     return audioDescriptionTrackSuffixText(displayName.toString());
676 }
677 
678 String CaptionUserPreferencesMediaAF::displayNameForTrack(AudioTrack* track) const
679 {
680     return trackDisplayName(track);
681 }
682 
683 static String trackDisplayName(TextTrack* track)
684 {
685     if (track == TextTrack::captionMenuOffItem())
686         return textTrackOffMenuItemText();
687     if (track == TextTrack::captionMenuAutomaticItem())
688         return textTrackAutomaticMenuItemText();
689 
690     StringBuilder displayNameBuilder;
691     buildDisplayStringForTrackBase(displayNameBuilder, *track);
692 
693     if (displayNameBuilder.isEmpty())
694         displayNameBuilder.append(textTrackNoLabelText());
695 
696     String displayName = displayNameBuilder.toString();
697 
698     if (track-&gt;isClosedCaptions()) {
699         displayName = closedCaptionTrackMenuItemText(displayName);
700         if (track-&gt;isEasyToRead())
701             displayName = easyReaderTrackMenuItemText(displayName);
702 
703         return displayName;
704     }
705 
706     if (track-&gt;isSDH())
707         displayName = sdhTrackMenuItemText(displayName);
708 
709     if (track-&gt;containsOnlyForcedSubtitles())
710         displayName = forcedTrackMenuItemText(displayName);
711 
712     if (track-&gt;isEasyToRead())
713         displayName = easyReaderTrackMenuItemText(displayName);
714 
715     return displayName;
716 }
717 
718 String CaptionUserPreferencesMediaAF::displayNameForTrack(TextTrack* track) const
719 {
720     return trackDisplayName(track);
721 }
722 
723 int CaptionUserPreferencesMediaAF::textTrackSelectionScore(TextTrack* track, HTMLMediaElement* mediaElement) const
724 {
725     CaptionDisplayMode displayMode = captionDisplayMode();
726     if (displayMode == Manual)
727         return 0;
728 
729     bool legacyOverride = mediaElement-&gt;webkitClosedCaptionsVisible();
730     if (displayMode == AlwaysOn &amp;&amp; (!userPrefersSubtitles() &amp;&amp; !userPrefersCaptions() &amp;&amp; !legacyOverride))
731         return 0;
732     if (track-&gt;kind() != TextTrack::Kind::Captions &amp;&amp; track-&gt;kind() != TextTrack::Kind::Subtitles &amp;&amp; track-&gt;kind() != TextTrack::Kind::Forced)
733         return 0;
734     if (!track-&gt;isMainProgramContent())
735         return 0;
736 
737     bool trackHasOnlyForcedSubtitles = track-&gt;containsOnlyForcedSubtitles();
738     if (!legacyOverride &amp;&amp; ((trackHasOnlyForcedSubtitles &amp;&amp; displayMode != ForcedOnly) || (!trackHasOnlyForcedSubtitles &amp;&amp; displayMode == ForcedOnly)))
739         return 0;
740 
741     Vector&lt;String&gt; userPreferredCaptionLanguages = preferredLanguages();
742 
743     if ((displayMode == Automatic &amp;&amp; !legacyOverride) || trackHasOnlyForcedSubtitles) {
744 
745         if (!mediaElement || !mediaElement-&gt;player())
746             return 0;
747 
748         String textTrackLanguage = track-&gt;validBCP47Language();
749         if (textTrackLanguage.isEmpty())
750             return 0;
751 
752         Vector&lt;String&gt; languageList;
753         languageList.reserveCapacity(1);
754 
755         String audioTrackLanguage;
756         if (testingMode())
757             audioTrackLanguage = primaryAudioTrackLanguageOverride();
758         else
759             audioTrackLanguage = mediaElement-&gt;player()-&gt;languageOfPrimaryAudioTrack();
760 
761         if (audioTrackLanguage.isEmpty())
762             return 0;
763 
764         bool exactMatch;
765         if (trackHasOnlyForcedSubtitles) {
766             languageList.append(audioTrackLanguage);
767             size_t offset = indexOfBestMatchingLanguageInList(textTrackLanguage, languageList, exactMatch);
768 
769             // Only consider a forced-only track if it IS in the same language as the primary audio track.
770             if (offset)
771                 return 0;
772         } else {
773             languageList.append(defaultLanguage());
774 
775             // Only enable a text track if the current audio track is NOT in the user&#39;s preferred language ...
776             size_t offset = indexOfBestMatchingLanguageInList(audioTrackLanguage, languageList, exactMatch);
777             if (!offset)
778                 return 0;
779 
780             // and the text track matches the user&#39;s preferred language.
781             offset = indexOfBestMatchingLanguageInList(textTrackLanguage, languageList, exactMatch);
782             if (offset)
783                 return 0;
784         }
785 
786         userPreferredCaptionLanguages = languageList;
787     }
788 
789     int trackScore = 0;
790 
791     if (userPrefersCaptions()) {
792         // When the user prefers accessibility tracks, rank is SDH, then CC, then subtitles.
793         if (track-&gt;kind() == TextTrack::Kind::Subtitles)
794             trackScore = 1;
795         else if (track-&gt;isClosedCaptions())
796             trackScore = 2;
797         else
798             trackScore = 3;
799     } else {
800         // When the user prefers translation tracks, rank is subtitles, then SDH, then CC tracks.
801         if (track-&gt;kind() == TextTrack::Kind::Subtitles)
802             trackScore = 3;
803         else if (!track-&gt;isClosedCaptions())
804             trackScore = 2;
805         else
806             trackScore = 1;
807     }
808 
809     return trackScore + textTrackLanguageSelectionScore(track, userPreferredCaptionLanguages);
810 }
811 
812 static bool textTrackCompare(const RefPtr&lt;TextTrack&gt;&amp; a, const RefPtr&lt;TextTrack&gt;&amp; b)
813 {
814     String preferredLanguageDisplayName = displayNameForLanguageLocale(languageIdentifier(defaultLanguage()));
815     String aLanguageDisplayName = displayNameForLanguageLocale(languageIdentifier(a-&gt;validBCP47Language()));
816     String bLanguageDisplayName = displayNameForLanguageLocale(languageIdentifier(b-&gt;language()));
817 
818     // Tracks in the user&#39;s preferred language are always at the top of the menu.
819     bool aIsPreferredLanguage = !codePointCompare(aLanguageDisplayName, preferredLanguageDisplayName);
820     bool bIsPreferredLanguage = !codePointCompare(bLanguageDisplayName, preferredLanguageDisplayName);
821     if ((aIsPreferredLanguage || bIsPreferredLanguage) &amp;&amp; (aIsPreferredLanguage != bIsPreferredLanguage))
822         return aIsPreferredLanguage;
823 
824     // Tracks not in the user&#39;s preferred language sort first by language ...
825     if (codePointCompare(aLanguageDisplayName, bLanguageDisplayName))
826         return codePointCompare(aLanguageDisplayName, bLanguageDisplayName) &lt; 0;
827 
828     // ... but when tracks have the same language, main program content sorts next highest ...
829     bool aIsMainContent = a-&gt;isMainProgramContent();
830     bool bIsMainContent = b-&gt;isMainProgramContent();
831     if ((aIsMainContent || bIsMainContent) &amp;&amp; (aIsMainContent != bIsMainContent))
832         return aIsMainContent;
833 
834     // ... and main program trakcs sort higher than CC tracks ...
835     bool aIsCC = a-&gt;isClosedCaptions();
836     bool bIsCC = b-&gt;isClosedCaptions();
837     if ((aIsCC || bIsCC) &amp;&amp; (aIsCC != bIsCC)) {
838         if (aIsCC)
839             return aIsMainContent;
840         return bIsMainContent;
841     }
842 
843     // ... and tracks of the same type and language sort by the menu item text.
<a name="3" id="anc3"></a><span class="line-modified">844     auto trackDisplayComparison = codePointCompare(trackDisplayName(a.get()), trackDisplayName(b.get()));</span>
<span class="line-added">845     if (trackDisplayComparison)</span>
<span class="line-added">846         return trackDisplayComparison &lt; 0;</span>
<span class="line-added">847 </span>
<span class="line-added">848     // ... and if the menu item text is the same, compare the unique IDs</span>
<span class="line-added">849     return a-&gt;uniqueId() &lt; b-&gt;uniqueId();</span>
850 }
851 
852 Vector&lt;RefPtr&lt;AudioTrack&gt;&gt; CaptionUserPreferencesMediaAF::sortedTrackListForMenu(AudioTrackList* trackList)
853 {
854     ASSERT(trackList);
855 
856     Vector&lt;RefPtr&lt;AudioTrack&gt;&gt; tracksForMenu;
857 
858     for (unsigned i = 0, length = trackList-&gt;length(); i &lt; length; ++i) {
859         AudioTrack* track = trackList-&gt;item(i);
860         String language = displayNameForLanguageLocale(track-&gt;validBCP47Language());
861         tracksForMenu.append(track);
862     }
863 
864     std::sort(tracksForMenu.begin(), tracksForMenu.end(), [](auto&amp; a, auto&amp; b) {
<a name="4" id="anc4"></a><span class="line-modified">865         auto trackDisplayComparison = codePointCompare(trackDisplayName(a.get()), trackDisplayName(b.get()));</span>
<span class="line-added">866         if (trackDisplayComparison)</span>
<span class="line-added">867             return trackDisplayComparison &lt; 0;</span>
<span class="line-added">868 </span>
<span class="line-added">869         return a-&gt;uniqueId() &lt; b-&gt;uniqueId();</span>
870     });
871 
872     return tracksForMenu;
873 }
874 
875 Vector&lt;RefPtr&lt;TextTrack&gt;&gt; CaptionUserPreferencesMediaAF::sortedTrackListForMenu(TextTrackList* trackList)
876 {
877     ASSERT(trackList);
878 
879     Vector&lt;RefPtr&lt;TextTrack&gt;&gt; tracksForMenu;
880     HashSet&lt;String&gt; languagesIncluded;
881     CaptionDisplayMode displayMode = captionDisplayMode();
882     bool prefersAccessibilityTracks = userPrefersCaptions();
883     bool filterTrackList = shouldFilterTrackMenu();
884 
885     for (unsigned i = 0, length = trackList-&gt;length(); i &lt; length; ++i) {
886         TextTrack* track = trackList-&gt;item(i);
887         String language = displayNameForLanguageLocale(track-&gt;validBCP47Language());
888 
889         if (displayMode == Manual) {
890             LOG(Media, &quot;CaptionUserPreferencesMediaAF::sortedTrackListForMenu - adding &#39;%s&#39; track with language &#39;%s&#39; because selection mode is &#39;manual&#39;&quot;, track-&gt;kindKeyword().string().utf8().data(), language.utf8().data());
891             tracksForMenu.append(track);
892             continue;
893         }
894 
895         auto kind = track-&gt;kind();
896         if (kind != TextTrack::Kind::Captions &amp;&amp; kind != TextTrack::Kind::Descriptions &amp;&amp; kind != TextTrack::Kind::Subtitles)
897             continue;
898 
899         if (track-&gt;containsOnlyForcedSubtitles()) {
900             LOG(Media, &quot;CaptionUserPreferencesMediaAF::sortedTrackListForMenu - skipping &#39;%s&#39; track with language &#39;%s&#39; because it contains only forced subtitles&quot;, track-&gt;kindKeyword().string().utf8().data(), language.utf8().data());
901             continue;
902         }
903 
904         if (track-&gt;isEasyToRead()) {
905             LOG(Media, &quot;CaptionUserPreferencesMediaAF::sortedTrackListForMenu - adding &#39;%s&#39; track with language &#39;%s&#39; because it is &#39;easy to read&#39;&quot;, track-&gt;kindKeyword().string().utf8().data(), language.utf8().data());
906             if (!language.isEmpty())
907                 languagesIncluded.add(language);
908             tracksForMenu.append(track);
909             continue;
910         }
911 
912         if (track-&gt;mode() == TextTrack::Mode::Showing) {
913             LOG(Media, &quot;CaptionUserPreferencesMediaAF::sortedTrackListForMenu - adding &#39;%s&#39; track with language &#39;%s&#39; because it is already visible&quot;, track-&gt;kindKeyword().string().utf8().data(), language.utf8().data());
914             if (!language.isEmpty())
915                 languagesIncluded.add(language);
916             tracksForMenu.append(track);
917             continue;
918         }
919 
920         if (!language.isEmpty() &amp;&amp; track-&gt;isMainProgramContent()) {
921             bool isAccessibilityTrack = track-&gt;kind() == TextTrack::Kind::Captions;
922             if (prefersAccessibilityTracks) {
923                 // In the first pass, include only caption tracks if the user prefers accessibility tracks.
924                 if (!isAccessibilityTrack &amp;&amp; filterTrackList) {
925                     LOG(Media, &quot;CaptionUserPreferencesMediaAF::sortedTrackListForMenu - skipping &#39;%s&#39; track with language &#39;%s&#39; because it is NOT an accessibility track&quot;, track-&gt;kindKeyword().string().utf8().data(), language.utf8().data());
926                     continue;
927                 }
928             } else {
929                 // In the first pass, only include the first non-CC or SDH track with each language if the user prefers translation tracks.
930                 if (isAccessibilityTrack &amp;&amp; filterTrackList) {
931                     LOG(Media, &quot;CaptionUserPreferencesMediaAF::sortedTrackListForMenu - skipping &#39;%s&#39; track with language &#39;%s&#39; because it is an accessibility track&quot;, track-&gt;kindKeyword().string().utf8().data(), language.utf8().data());
932                     continue;
933                 }
934                 if (languagesIncluded.contains(language) &amp;&amp; filterTrackList) {
935                     LOG(Media, &quot;CaptionUserPreferencesMediaAF::sortedTrackListForMenu - skipping &#39;%s&#39; track with language &#39;%s&#39; because it is not the first with this language&quot;, track-&gt;kindKeyword().string().utf8().data(), language.utf8().data());
936                     continue;
937                 }
938             }
939         }
940 
941         if (!language.isEmpty())
942             languagesIncluded.add(language);
943         tracksForMenu.append(track);
944 
945         LOG(Media, &quot;CaptionUserPreferencesMediaAF::sortedTrackListForMenu - adding &#39;%s&#39; track with language &#39;%s&#39;, is%s main program content&quot;, track-&gt;kindKeyword().string().utf8().data(), language.utf8().data(), track-&gt;isMainProgramContent() ? &quot;&quot; : &quot; NOT&quot;);
946     }
947 
948     // Now that we have filtered for the user&#39;s accessibility/translation preference, add  all tracks with a unique language without regard to track type.
949     for (unsigned i = 0, length = trackList-&gt;length(); i &lt; length; ++i) {
950         TextTrack* track = trackList-&gt;item(i);
951         String language = displayNameForLanguageLocale(track-&gt;language());
952 
953         if (tracksForMenu.contains(track))
954             continue;
955 
956         auto kind = track-&gt;kind();
957         if (kind != TextTrack::Kind::Captions &amp;&amp; kind != TextTrack::Kind::Descriptions &amp;&amp; kind != TextTrack::Kind::Subtitles)
958             continue;
959 
960         // All candidates with no languge were added the first time through.
961         if (language.isEmpty())
962             continue;
963 
964         if (track-&gt;containsOnlyForcedSubtitles())
965             continue;
966 
967         if (!languagesIncluded.contains(language) &amp;&amp; track-&gt;isMainProgramContent()) {
968             languagesIncluded.add(language);
969             tracksForMenu.append(track);
970             LOG(Media, &quot;CaptionUserPreferencesMediaAF::sortedTrackListForMenu - adding &#39;%s&#39; track with language &#39;%s&#39; because it is the only track with this language&quot;, track-&gt;kindKeyword().string().utf8().data(), language.utf8().data());
971         }
972     }
973 
974     if (tracksForMenu.isEmpty())
975         return tracksForMenu;
976 
977     std::sort(tracksForMenu.begin(), tracksForMenu.end(), textTrackCompare);
978 
979     tracksForMenu.insert(0, TextTrack::captionMenuOffItem());
980     tracksForMenu.insert(1, TextTrack::captionMenuAutomaticItem());
981 
982     return tracksForMenu;
983 }
984 
985 }
986 
987 #endif
988 
989 #endif // ENABLE(VIDEO_TRACK)
<a name="5" id="anc5"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="5" type="hidden" />
</body>
</html>