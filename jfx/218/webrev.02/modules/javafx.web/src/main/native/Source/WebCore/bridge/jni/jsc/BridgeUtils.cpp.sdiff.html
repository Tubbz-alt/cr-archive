<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WebCore/bridge/jni/jsc/BridgeUtils.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../c/c_utility.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="JNIUtilityPrivate.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/bridge/jni/jsc/BridgeUtils.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
105 {
106     FIND_CACHE_CLASS(env, &quot;java/lang/String&quot;);
107 }
108 
109 static jclass getNullPointerExceptionClass (JNIEnv *env)
110 {
111     FIND_CACHE_CLASS(env, &quot;java/lang/NullPointerException&quot;);
112 }
113 
114 static void throwNullPointerException (JNIEnv *env)
115 {
116     jclass clJSException = getNullPointerExceptionClass(env);
117     env-&gt;Throw((jthrowable) env-&gt;NewObject(clJSException,
118             env-&gt;GetMethodID(clJSException, &quot;&lt;init&gt;&quot;, &quot;()V&quot;)));
119 }
120 
121 namespace WebCore {
122 
123 JSGlobalContextRef getGlobalContext(WebCore::ScriptController* scriptController)
124 {
<span class="line-modified">125     return toGlobalRef(scriptController-&gt;globalObject(WebCore::mainThreadNormalWorld())-&gt;globalExec());</span>
126 }
127 
128 JSStringRef asJSStringRef(JNIEnv *env, jstring str)
129 {
130     unsigned int slen = env-&gt;GetStringLength(str);
131     const jchar* schars = env-&gt;GetStringCritical(str, nullptr);
132     JSStringRef name = JSStringCreateWithCharacters((const JSChar*) schars, slen);
133     env-&gt;ReleaseStringCritical(str, schars);
134     return name;
135 }
136 
137 JSValueRef Java_Object_to_JSValue(
138     JNIEnv *env,
139     JSContextRef ctx,
140     JSC::Bindings::RootObject* rootObject,
141     jobject val,
142     jobject accessControlContext)
143 {
144     if (val == nullptr)
145         return JSValueMakeNull(ctx);
<span class="line-modified">146     JSC::ExecState* exec = toJS(ctx);</span>
<span class="line-modified">147     JSC::JSLockHolder lock(exec);</span>
148 
149     jclass clJSObject = getJSObjectClass(env);
150     if (env-&gt;IsInstanceOf(val, clJSObject)) {
151         static jfieldID fldPeer = env-&gt;GetFieldID(clJSObject, &quot;peer&quot;, &quot;J&quot;);
152         static jfieldID fldPeerType = env-&gt;GetFieldID(clJSObject, &quot;peer_type&quot;, &quot;I&quot;);
153         jlong peer = env-&gt;GetLongField(val, fldPeer);
154         jint peer_type = env-&gt;GetIntField(val, fldPeerType);
155         switch (peer_type) {
156         case com_sun_webkit_dom_JSObject_JS_CONTEXT_OBJECT:
157             return static_cast&lt;JSObjectRef&gt;(jlong_to_ptr(peer));
158         case com_sun_webkit_dom_JSObject_JS_DOM_NODE_OBJECT:
159         case com_sun_webkit_dom_JSObject_JS_DOM_WINDOW_OBJECT:
160             {
161                 JSDOMGlobalObject* globalObject = toJSDOMGlobalObject(
162                     ((peer_type == com_sun_webkit_dom_JSObject_JS_DOM_WINDOW_OBJECT)
163                         ? *static_cast&lt;DOMWindow*&gt;(jlong_to_ptr(peer))-&gt;document()
164                         : static_cast&lt;Node*&gt;(jlong_to_ptr(peer))-&gt;document()),
<span class="line-modified">165                     normalWorld(exec-&gt;vm()));</span>
<span class="line-modified">166                 return toRef(exec,</span>
167                     (peer_type == com_sun_webkit_dom_JSObject_JS_DOM_WINDOW_OBJECT)
<span class="line-modified">168                         ? WebCore::toJS(exec, globalObject, static_cast&lt;DOMWindow*&gt;(jlong_to_ptr(peer)))</span>
<span class="line-modified">169                         : WebCore::toJS(exec, globalObject, static_cast&lt;Node*&gt;(jlong_to_ptr(peer))));</span>
170             }
171         }
172     }
173     jclass clString = getStringClass(env);
174     if (env-&gt;IsInstanceOf(val, clString)) {
175         JSStringRef value = asJSStringRef(env, (jstring) val);
176         JSValueRef jsvalue = JSValueMakeString(ctx, value);
177         JSStringRelease(value);
178         return jsvalue;
179     }
180     jclass clBoolean = getBooleanClass(env);
181     if (env-&gt;IsInstanceOf(val, clBoolean)) {
182         static jmethodID booleanValueMethod = env-&gt;GetMethodID(clBoolean, &quot;booleanValue&quot;, &quot;()Z&quot;);
183         jboolean value = env-&gt;CallBooleanMethod(val, booleanValueMethod);
184         return JSValueMakeBoolean(ctx, value);
185     }
186     jclass clNumber = getNumberClass(env);
187     if (env-&gt;IsInstanceOf(val, clNumber)) {
188         static jmethodID doubleValueMethod = env-&gt;GetMethodID(clNumber, &quot;doubleValue&quot;, &quot;()D&quot;);
189         jdouble value = env-&gt;CallDoubleMethod(val, doubleValueMethod);
190         return JSValueMakeNumber(ctx, value);
191     }
192 
193     JLObject valClass(JSC::Bindings::callJNIMethod&lt;jobject&gt;(val, &quot;getClass&quot;, &quot;()Ljava/lang/Class;&quot;));
194     if (JSC::Bindings::callJNIMethod&lt;jboolean&gt;(valClass, &quot;isArray&quot;, &quot;()Z&quot;)) {
195         JLString className((jstring)JSC::Bindings::callJNIMethod&lt;jobject&gt;(valClass, &quot;getName&quot;, &quot;()Ljava/lang/String;&quot;));
196         const char* classNameC = JSC::Bindings::getCharactersFromJString(className);
<span class="line-modified">197         JSC::JSValue arr = JSC::Bindings::JavaArray::convertJObjectToArray(exec, val, classNameC, rootObject, accessControlContext);</span>
198         JSC::Bindings::releaseCharactersForJString(className, classNameC);
<span class="line-modified">199         return toRef(exec, arr);</span>
200     }
201     else {
202         // All other Java Object types including java.lang.Character will be wrapped inside JavaInstance.
203         RefPtr&lt;JSC::Bindings::JavaInstance&gt; jinstance = JSC::Bindings::JavaInstance::create(val, rootObject, accessControlContext);
<span class="line-modified">204         return toRef(jinstance-&gt;createRuntimeObject(exec));</span>
205     }
206 }
207 
208 jstring JSValue_to_Java_String(JSValueRef value, JNIEnv* env, JSContextRef ctx)
209 {
210     JSStringRef str = JSValueToStringCopy(ctx, value, nullptr);
211     size_t slen = JSStringGetLength(str);
212     const JSChar* schars = JSStringGetCharactersPtr(str);
213     jstring result = env-&gt;NewString((const jchar*) schars, slen);
214     JSStringRelease(str);
215     return result;
216 }
217 
218 jobject JSValue_to_Java_Object(
219     JSValueRef value,
220     JNIEnv*,
221     JSContextRef ctx,
222     JSC::Bindings::RootObject* rootObject)
223 {
<span class="line-modified">224     JSC::ExecState* exec = toJS(ctx);</span>
<span class="line-modified">225     return convertValueToJValue(exec, rootObject, toJS(exec, value),</span>
226         JSC::Bindings::JavaTypeObject, &quot;java.lang.Object&quot;).l;
227 }
228 
229 static void throwJavaException(
230     JNIEnv* env,
231     JSContextRef ctx,
232     JSValueRef exception,
233     JSC::Bindings::RootObject* rootObject)
234 {
235     jclass clJSObject = getJSObjectClass(env);
236     jobject jex = JSValue_to_Java_Object(exception, env, ctx, rootObject);
237     static jmethodID makeID =
238         env-&gt;GetStaticMethodID(clJSObject, &quot;fwkMakeException&quot;,
239                         &quot;(Ljava/lang/Object;)Lnetscape/javascript/JSException;&quot;);
240 
241     env-&gt;Throw(JLocalRef&lt;jthrowable&gt;((jthrowable)env-&gt;CallStaticObjectMethod(
242             clJSObject,
243             makeID,
244             jex)));
245 }
</pre>
<hr />
<pre>
265     }
266     return WebCore::JSValue_to_Java_Object(value, env, ctx, rootObject);
267 }
268 
269 }
270 
271 
272 RefPtr&lt;JSC::Bindings::RootObject&gt; checkJSPeer(
273     jlong peer,
274     jint peer_type,
275     JSObjectRef &amp;object,
276     JSContextRef &amp;context)
277 {
278     JSC::Bindings::RootObject *rootObject = nullptr;
279     switch (peer_type) {
280     case com_sun_webkit_dom_JSObject_JS_CONTEXT_OBJECT:
281         {
282             object = static_cast&lt;JSObjectRef&gt;(jlong_to_ptr(peer));
283             rootObject = JSC::Bindings::findProtectingRootObject(reinterpret_cast&lt;JSC::JSObject*&gt;(object));
284             if (rootObject) {
<span class="line-modified">285                 context = toRef(rootObject-&gt;globalObject()-&gt;globalExec());</span>
286             }
287         }
288         break;
289     case com_sun_webkit_dom_JSObject_JS_DOM_NODE_OBJECT:
290     case com_sun_webkit_dom_JSObject_JS_DOM_WINDOW_OBJECT:
291         {
292             WebCore::Frame* frame = (peer_type == com_sun_webkit_dom_JSObject_JS_DOM_WINDOW_OBJECT)
293                 ? static_cast&lt;WebCore::DOMWindow*&gt;(jlong_to_ptr(peer))-&gt;document()-&gt;frame()
294                 : static_cast&lt;WebCore::Node*&gt;(jlong_to_ptr(peer))-&gt;document().frame();
295 
296             if (!frame) {
297                 return rootObject;
298             }
299             rootObject = &amp;(frame-&gt;script().createRootObject(frame).leakRef());
300             if (rootObject) {
301                 context = WebCore::getGlobalContext(&amp;frame-&gt;script());
<span class="line-modified">302                 JSC::ExecState* exec = toJS(context);</span>
<span class="line-modified">303                 JSC::JSLockHolder lock(exec);</span>
304 
<span class="line-modified">305                 object = const_cast&lt;JSObjectRef&gt;(toRef(exec,</span>
306                     (peer_type == com_sun_webkit_dom_JSObject_JS_DOM_WINDOW_OBJECT)
<span class="line-modified">307                     ? WebCore::toJS(exec, static_cast&lt;WebCore::JSDOMGlobalObject *&gt;(rootObject-&gt;globalObject()), static_cast&lt;WebCore::DOMWindow*&gt;(jlong_to_ptr(peer)))</span>
<span class="line-modified">308                     : WebCore::toJS(exec, static_cast&lt;WebCore::JSDOMGlobalObject *&gt;(rootObject-&gt;globalObject()), static_cast&lt;WebCore::Node*&gt;(jlong_to_ptr(peer)))));</span>
309 
310             }
311         }
312         break;
313     };
314 
315     return rootObject;
316 }
317 
318 
319 
320 extern &quot;C&quot; {
321 
322 JNIEXPORT jobject JNICALL Java_com_sun_webkit_dom_JSObject_evalImpl
323 (JNIEnv *env, jclass, jlong peer, jint peer_type, jstring str)
324 {
325     if (str == nullptr) {
326         throwNullPointerException(env);
327         return nullptr;
328     }
</pre>
<hr />
<pre>
423     JSContextRef ctx;
424     RefPtr&lt;JSC::Bindings::RootObject&gt; rootObject(checkJSPeer(peer, peer_type, object, ctx));
425     if (rootObject.get() == nullptr) {
426         throwNullPointerException(env);
427         return;
428     }
429 
430     JSValueRef jsvalue = WebCore::Java_Object_to_JSValue(env, ctx, rootObject.get(), value, accessControlContext);
431     JSObjectSetPropertyAtIndex(ctx, object, (unsigned) index, jsvalue, nullptr);
432 }
433 
434 JNIEXPORT jstring JNICALL Java_com_sun_webkit_dom_JSObject_toStringImpl
435 (JNIEnv *env, jclass, jlong peer, jint peer_type)
436 {
437     JSObjectRef object;
438     JSContextRef ctx;
439     if (!checkJSPeer(peer, peer_type, object, ctx)) {
440         return nullptr;
441     }
442 
<span class="line-modified">443     JSC::ExecState* exec = toJS(ctx);</span>
<span class="line-modified">444     JSC::JSLockHolder lock(exec);</span>
445 
<span class="line-modified">446     return toJS(object)-&gt;toString(exec)-&gt;value(exec)</span>
447         .toJavaString(env).releaseLocal();
448 }
449 
450 JNIEXPORT jobject JNICALL Java_com_sun_webkit_dom_JSObject_callImpl
451   (JNIEnv *env, jclass, jlong peer, jint peer_type, jstring methodName, jobjectArray args, jobject accessControlContext)
452 {
453     if (methodName == nullptr || args == nullptr) {
454         throwNullPointerException(env);
455         return nullptr;
456     }
457     JSObjectRef object;
458     JSContextRef ctx;
459     RefPtr&lt;JSC::Bindings::RootObject&gt; rootObject(checkJSPeer(peer, peer_type, object, ctx));
460     if (!rootObject || !rootObject.get() || !ctx) {
461         env-&gt;ThrowNew(getJSExceptionClass(env), &quot;Invalid function reference&quot;);
462         return nullptr;
463     }
464 
465     JSStringRef name = WebCore::asJSStringRef(env, methodName);
466     JSValueRef member = JSObjectGetProperty(ctx, object, name, nullptr);
</pre>
</td>
<td>
<hr />
<pre>
105 {
106     FIND_CACHE_CLASS(env, &quot;java/lang/String&quot;);
107 }
108 
109 static jclass getNullPointerExceptionClass (JNIEnv *env)
110 {
111     FIND_CACHE_CLASS(env, &quot;java/lang/NullPointerException&quot;);
112 }
113 
114 static void throwNullPointerException (JNIEnv *env)
115 {
116     jclass clJSException = getNullPointerExceptionClass(env);
117     env-&gt;Throw((jthrowable) env-&gt;NewObject(clJSException,
118             env-&gt;GetMethodID(clJSException, &quot;&lt;init&gt;&quot;, &quot;()V&quot;)));
119 }
120 
121 namespace WebCore {
122 
123 JSGlobalContextRef getGlobalContext(WebCore::ScriptController* scriptController)
124 {
<span class="line-modified">125     return toGlobalRef(scriptController-&gt;globalObject(WebCore::mainThreadNormalWorld()));</span>
126 }
127 
128 JSStringRef asJSStringRef(JNIEnv *env, jstring str)
129 {
130     unsigned int slen = env-&gt;GetStringLength(str);
131     const jchar* schars = env-&gt;GetStringCritical(str, nullptr);
132     JSStringRef name = JSStringCreateWithCharacters((const JSChar*) schars, slen);
133     env-&gt;ReleaseStringCritical(str, schars);
134     return name;
135 }
136 
137 JSValueRef Java_Object_to_JSValue(
138     JNIEnv *env,
139     JSContextRef ctx,
140     JSC::Bindings::RootObject* rootObject,
141     jobject val,
142     jobject accessControlContext)
143 {
144     if (val == nullptr)
145         return JSValueMakeNull(ctx);
<span class="line-modified">146     JSC::JSGlobalObject* lexicalGlobalObject = toJS(ctx);</span>
<span class="line-modified">147     JSC::JSLockHolder lock(lexicalGlobalObject);</span>
148 
149     jclass clJSObject = getJSObjectClass(env);
150     if (env-&gt;IsInstanceOf(val, clJSObject)) {
151         static jfieldID fldPeer = env-&gt;GetFieldID(clJSObject, &quot;peer&quot;, &quot;J&quot;);
152         static jfieldID fldPeerType = env-&gt;GetFieldID(clJSObject, &quot;peer_type&quot;, &quot;I&quot;);
153         jlong peer = env-&gt;GetLongField(val, fldPeer);
154         jint peer_type = env-&gt;GetIntField(val, fldPeerType);
155         switch (peer_type) {
156         case com_sun_webkit_dom_JSObject_JS_CONTEXT_OBJECT:
157             return static_cast&lt;JSObjectRef&gt;(jlong_to_ptr(peer));
158         case com_sun_webkit_dom_JSObject_JS_DOM_NODE_OBJECT:
159         case com_sun_webkit_dom_JSObject_JS_DOM_WINDOW_OBJECT:
160             {
161                 JSDOMGlobalObject* globalObject = toJSDOMGlobalObject(
162                     ((peer_type == com_sun_webkit_dom_JSObject_JS_DOM_WINDOW_OBJECT)
163                         ? *static_cast&lt;DOMWindow*&gt;(jlong_to_ptr(peer))-&gt;document()
164                         : static_cast&lt;Node*&gt;(jlong_to_ptr(peer))-&gt;document()),
<span class="line-modified">165                     normalWorld(lexicalGlobalObject-&gt;vm()));</span>
<span class="line-modified">166                 return toRef(lexicalGlobalObject,</span>
167                     (peer_type == com_sun_webkit_dom_JSObject_JS_DOM_WINDOW_OBJECT)
<span class="line-modified">168                         ? WebCore::toJS(lexicalGlobalObject, globalObject, static_cast&lt;DOMWindow*&gt;(jlong_to_ptr(peer)))</span>
<span class="line-modified">169                         : WebCore::toJS(lexicalGlobalObject, globalObject, static_cast&lt;Node*&gt;(jlong_to_ptr(peer))));</span>
170             }
171         }
172     }
173     jclass clString = getStringClass(env);
174     if (env-&gt;IsInstanceOf(val, clString)) {
175         JSStringRef value = asJSStringRef(env, (jstring) val);
176         JSValueRef jsvalue = JSValueMakeString(ctx, value);
177         JSStringRelease(value);
178         return jsvalue;
179     }
180     jclass clBoolean = getBooleanClass(env);
181     if (env-&gt;IsInstanceOf(val, clBoolean)) {
182         static jmethodID booleanValueMethod = env-&gt;GetMethodID(clBoolean, &quot;booleanValue&quot;, &quot;()Z&quot;);
183         jboolean value = env-&gt;CallBooleanMethod(val, booleanValueMethod);
184         return JSValueMakeBoolean(ctx, value);
185     }
186     jclass clNumber = getNumberClass(env);
187     if (env-&gt;IsInstanceOf(val, clNumber)) {
188         static jmethodID doubleValueMethod = env-&gt;GetMethodID(clNumber, &quot;doubleValue&quot;, &quot;()D&quot;);
189         jdouble value = env-&gt;CallDoubleMethod(val, doubleValueMethod);
190         return JSValueMakeNumber(ctx, value);
191     }
192 
193     JLObject valClass(JSC::Bindings::callJNIMethod&lt;jobject&gt;(val, &quot;getClass&quot;, &quot;()Ljava/lang/Class;&quot;));
194     if (JSC::Bindings::callJNIMethod&lt;jboolean&gt;(valClass, &quot;isArray&quot;, &quot;()Z&quot;)) {
195         JLString className((jstring)JSC::Bindings::callJNIMethod&lt;jobject&gt;(valClass, &quot;getName&quot;, &quot;()Ljava/lang/String;&quot;));
196         const char* classNameC = JSC::Bindings::getCharactersFromJString(className);
<span class="line-modified">197         JSC::JSValue arr = JSC::Bindings::JavaArray::convertJObjectToArray(lexicalGlobalObject, val, classNameC, rootObject, accessControlContext);</span>
198         JSC::Bindings::releaseCharactersForJString(className, classNameC);
<span class="line-modified">199         return toRef(lexicalGlobalObject, arr);</span>
200     }
201     else {
202         // All other Java Object types including java.lang.Character will be wrapped inside JavaInstance.
203         RefPtr&lt;JSC::Bindings::JavaInstance&gt; jinstance = JSC::Bindings::JavaInstance::create(val, rootObject, accessControlContext);
<span class="line-modified">204         return toRef(jinstance-&gt;createRuntimeObject(lexicalGlobalObject));</span>
205     }
206 }
207 
208 jstring JSValue_to_Java_String(JSValueRef value, JNIEnv* env, JSContextRef ctx)
209 {
210     JSStringRef str = JSValueToStringCopy(ctx, value, nullptr);
211     size_t slen = JSStringGetLength(str);
212     const JSChar* schars = JSStringGetCharactersPtr(str);
213     jstring result = env-&gt;NewString((const jchar*) schars, slen);
214     JSStringRelease(str);
215     return result;
216 }
217 
218 jobject JSValue_to_Java_Object(
219     JSValueRef value,
220     JNIEnv*,
221     JSContextRef ctx,
222     JSC::Bindings::RootObject* rootObject)
223 {
<span class="line-modified">224     JSC::JSGlobalObject* globalObject = toJS(ctx);</span>
<span class="line-modified">225     return convertValueToJValue(globalObject, rootObject, toJS(globalObject, value),</span>
226         JSC::Bindings::JavaTypeObject, &quot;java.lang.Object&quot;).l;
227 }
228 
229 static void throwJavaException(
230     JNIEnv* env,
231     JSContextRef ctx,
232     JSValueRef exception,
233     JSC::Bindings::RootObject* rootObject)
234 {
235     jclass clJSObject = getJSObjectClass(env);
236     jobject jex = JSValue_to_Java_Object(exception, env, ctx, rootObject);
237     static jmethodID makeID =
238         env-&gt;GetStaticMethodID(clJSObject, &quot;fwkMakeException&quot;,
239                         &quot;(Ljava/lang/Object;)Lnetscape/javascript/JSException;&quot;);
240 
241     env-&gt;Throw(JLocalRef&lt;jthrowable&gt;((jthrowable)env-&gt;CallStaticObjectMethod(
242             clJSObject,
243             makeID,
244             jex)));
245 }
</pre>
<hr />
<pre>
265     }
266     return WebCore::JSValue_to_Java_Object(value, env, ctx, rootObject);
267 }
268 
269 }
270 
271 
272 RefPtr&lt;JSC::Bindings::RootObject&gt; checkJSPeer(
273     jlong peer,
274     jint peer_type,
275     JSObjectRef &amp;object,
276     JSContextRef &amp;context)
277 {
278     JSC::Bindings::RootObject *rootObject = nullptr;
279     switch (peer_type) {
280     case com_sun_webkit_dom_JSObject_JS_CONTEXT_OBJECT:
281         {
282             object = static_cast&lt;JSObjectRef&gt;(jlong_to_ptr(peer));
283             rootObject = JSC::Bindings::findProtectingRootObject(reinterpret_cast&lt;JSC::JSObject*&gt;(object));
284             if (rootObject) {
<span class="line-modified">285                 context = toRef(rootObject-&gt;globalObject());</span>
286             }
287         }
288         break;
289     case com_sun_webkit_dom_JSObject_JS_DOM_NODE_OBJECT:
290     case com_sun_webkit_dom_JSObject_JS_DOM_WINDOW_OBJECT:
291         {
292             WebCore::Frame* frame = (peer_type == com_sun_webkit_dom_JSObject_JS_DOM_WINDOW_OBJECT)
293                 ? static_cast&lt;WebCore::DOMWindow*&gt;(jlong_to_ptr(peer))-&gt;document()-&gt;frame()
294                 : static_cast&lt;WebCore::Node*&gt;(jlong_to_ptr(peer))-&gt;document().frame();
295 
296             if (!frame) {
297                 return rootObject;
298             }
299             rootObject = &amp;(frame-&gt;script().createRootObject(frame).leakRef());
300             if (rootObject) {
301                 context = WebCore::getGlobalContext(&amp;frame-&gt;script());
<span class="line-modified">302                 JSC::JSGlobalObject* JSGlobalObject = toJS(context);</span>
<span class="line-modified">303                 JSC::JSLockHolder lock(JSGlobalObject);</span>
304 
<span class="line-modified">305                 object = const_cast&lt;JSObjectRef&gt;(toRef(JSGlobalObject,</span>
306                     (peer_type == com_sun_webkit_dom_JSObject_JS_DOM_WINDOW_OBJECT)
<span class="line-modified">307                     ? WebCore::toJS(JSGlobalObject, static_cast&lt;WebCore::JSDOMGlobalObject *&gt;(rootObject-&gt;globalObject()), static_cast&lt;WebCore::DOMWindow*&gt;(jlong_to_ptr(peer)))</span>
<span class="line-modified">308                     : WebCore::toJS(JSGlobalObject, static_cast&lt;WebCore::JSDOMGlobalObject *&gt;(rootObject-&gt;globalObject()), static_cast&lt;WebCore::Node*&gt;(jlong_to_ptr(peer)))));</span>
309 
310             }
311         }
312         break;
313     };
314 
315     return rootObject;
316 }
317 
318 
319 
320 extern &quot;C&quot; {
321 
322 JNIEXPORT jobject JNICALL Java_com_sun_webkit_dom_JSObject_evalImpl
323 (JNIEnv *env, jclass, jlong peer, jint peer_type, jstring str)
324 {
325     if (str == nullptr) {
326         throwNullPointerException(env);
327         return nullptr;
328     }
</pre>
<hr />
<pre>
423     JSContextRef ctx;
424     RefPtr&lt;JSC::Bindings::RootObject&gt; rootObject(checkJSPeer(peer, peer_type, object, ctx));
425     if (rootObject.get() == nullptr) {
426         throwNullPointerException(env);
427         return;
428     }
429 
430     JSValueRef jsvalue = WebCore::Java_Object_to_JSValue(env, ctx, rootObject.get(), value, accessControlContext);
431     JSObjectSetPropertyAtIndex(ctx, object, (unsigned) index, jsvalue, nullptr);
432 }
433 
434 JNIEXPORT jstring JNICALL Java_com_sun_webkit_dom_JSObject_toStringImpl
435 (JNIEnv *env, jclass, jlong peer, jint peer_type)
436 {
437     JSObjectRef object;
438     JSContextRef ctx;
439     if (!checkJSPeer(peer, peer_type, object, ctx)) {
440         return nullptr;
441     }
442 
<span class="line-modified">443     JSC::JSGlobalObject* JSGlobalObject = toJS(ctx);</span>
<span class="line-modified">444     JSC::JSLockHolder lock(JSGlobalObject);</span>
445 
<span class="line-modified">446     return toJS(object)-&gt;toString(JSGlobalObject)-&gt;value(JSGlobalObject)</span>
447         .toJavaString(env).releaseLocal();
448 }
449 
450 JNIEXPORT jobject JNICALL Java_com_sun_webkit_dom_JSObject_callImpl
451   (JNIEnv *env, jclass, jlong peer, jint peer_type, jstring methodName, jobjectArray args, jobject accessControlContext)
452 {
453     if (methodName == nullptr || args == nullptr) {
454         throwNullPointerException(env);
455         return nullptr;
456     }
457     JSObjectRef object;
458     JSContextRef ctx;
459     RefPtr&lt;JSC::Bindings::RootObject&gt; rootObject(checkJSPeer(peer, peer_type, object, ctx));
460     if (!rootObject || !rootObject.get() || !ctx) {
461         env-&gt;ThrowNew(getJSExceptionClass(env), &quot;Invalid function reference&quot;);
462         return nullptr;
463     }
464 
465     JSStringRef name = WebCore::asJSStringRef(env, methodName);
466     JSValueRef member = JSObjectGetProperty(ctx, object, name, nullptr);
</pre>
</td>
</tr>
</table>
<center><a href="../../c/c_utility.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="JNIUtilityPrivate.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>