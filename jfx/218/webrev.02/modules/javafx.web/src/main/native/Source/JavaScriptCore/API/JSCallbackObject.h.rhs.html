<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/JavaScriptCore/API/JSCallbackObject.h</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (C) 2006-2019 Apple Inc. All rights reserved.
  3  * Copyright (C) 2007 Eric Seidel &lt;eric@webkit.org&gt;
  4  *
  5  * Redistribution and use in source and binary forms, with or without
  6  * modification, are permitted provided that the following conditions
  7  * are met:
  8  * 1. Redistributions of source code must retain the above copyright
  9  *    notice, this list of conditions and the following disclaimer.
 10  * 2. Redistributions in binary form must reproduce the above copyright
 11  *    notice, this list of conditions and the following disclaimer in the
 12  *    documentation and/or other materials provided with the distribution.
 13  *
 14  * THIS SOFTWARE IS PROVIDED BY APPLE INC. ``AS IS&#39;&#39; AND ANY
 15  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 16  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 17  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE INC. OR
 18  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 19  * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 20  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 21  * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 22  * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 23  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 24  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 25  */
 26 
 27 #ifndef JSCallbackObject_h
 28 #define JSCallbackObject_h
 29 
 30 #include &quot;JSObjectRef.h&quot;
 31 #include &quot;JSValueRef.h&quot;
 32 #include &quot;JSObject.h&quot;
 33 
 34 namespace JSC {
 35 
 36 struct JSCallbackObjectData {
 37     WTF_MAKE_FAST_ALLOCATED;
 38 public:
 39     JSCallbackObjectData(void* privateData, JSClassRef jsClass)
 40         : privateData(privateData)
 41         , jsClass(jsClass)
 42     {
 43         JSClassRetain(jsClass);
 44     }
 45 
 46     ~JSCallbackObjectData()
 47     {
 48         JSClassRelease(jsClass);
 49     }
 50 
 51     JSValue getPrivateProperty(const Identifier&amp; propertyName) const
 52     {
 53         if (!m_privateProperties)
 54             return JSValue();
 55         return m_privateProperties-&gt;getPrivateProperty(propertyName);
 56     }
 57 
 58     void setPrivateProperty(VM&amp; vm, JSCell* owner, const Identifier&amp; propertyName, JSValue value)
 59     {
 60         if (!m_privateProperties)
 61             m_privateProperties = makeUnique&lt;JSPrivatePropertyMap&gt;();
 62         m_privateProperties-&gt;setPrivateProperty(vm, owner, propertyName, value);
 63     }
 64 
 65     void deletePrivateProperty(const Identifier&amp; propertyName)
 66     {
 67         if (!m_privateProperties)
 68             return;
 69         m_privateProperties-&gt;deletePrivateProperty(propertyName);
 70     }
 71 
 72     void visitChildren(SlotVisitor&amp; visitor)
 73     {
 74         JSPrivatePropertyMap* properties = m_privateProperties.get();
 75         if (!properties)
 76             return;
 77         properties-&gt;visitChildren(visitor);
 78     }
 79 
 80     void* privateData;
 81     JSClassRef jsClass;
 82     struct JSPrivatePropertyMap {
 83         WTF_MAKE_FAST_ALLOCATED;
 84     public:
 85         JSValue getPrivateProperty(const Identifier&amp; propertyName) const
 86         {
 87             PrivatePropertyMap::const_iterator location = m_propertyMap.find(propertyName.impl());
 88             if (location == m_propertyMap.end())
 89                 return JSValue();
 90             return location-&gt;value.get();
 91         }
 92 
 93         void setPrivateProperty(VM&amp; vm, JSCell* owner, const Identifier&amp; propertyName, JSValue value)
 94         {
 95             LockHolder locker(m_lock);
 96             WriteBarrier&lt;Unknown&gt; empty;
 97             m_propertyMap.add(propertyName.impl(), empty).iterator-&gt;value.set(vm, owner, value);
 98         }
 99 
100         void deletePrivateProperty(const Identifier&amp; propertyName)
101         {
102             LockHolder locker(m_lock);
103             m_propertyMap.remove(propertyName.impl());
104         }
105 
106         void visitChildren(SlotVisitor&amp; visitor)
107         {
108             LockHolder locker(m_lock);
109             for (auto&amp; pair : m_propertyMap) {
110                 if (pair.value)
111                     visitor.append(pair.value);
112             }
113         }
114 
115     private:
116         typedef HashMap&lt;RefPtr&lt;UniquedStringImpl&gt;, WriteBarrier&lt;Unknown&gt;, IdentifierRepHash&gt; PrivatePropertyMap;
117         PrivatePropertyMap m_propertyMap;
118         Lock m_lock;
119     };
120     std::unique_ptr&lt;JSPrivatePropertyMap&gt; m_privateProperties;
121 };
122 
123 
124 template &lt;class Parent&gt;
125 class JSCallbackObject final : public Parent {
126 protected:
<a name="1" id="anc1"></a><span class="line-modified">127     JSCallbackObject(JSGlobalObject*, Structure*, JSClassRef, void* data);</span>
128     JSCallbackObject(VM&amp;, JSClassRef, Structure*);
129 
<a name="2" id="anc2"></a><span class="line-modified">130     void finishCreation(JSGlobalObject*);</span>
131     void finishCreation(VM&amp;);
132 
133 public:
<a name="3" id="anc3"></a><span class="line-modified">134     using Base = Parent;</span>
<span class="line-modified">135     static constexpr unsigned StructureFlags = Base::StructureFlags | ProhibitsPropertyCaching | OverridesGetOwnPropertySlot | InterceptsGetOwnPropertySlotByIndexEvenWhenLengthIsNotZero | ImplementsHasInstance | OverridesGetPropertyNames | OverridesGetCallData;</span>
136     static_assert(!(StructureFlags &amp; ImplementsDefaultHasInstance), &quot;using customHasInstance&quot;);
137 
138     ~JSCallbackObject();
139 
<a name="4" id="anc4"></a><span class="line-modified">140     static JSCallbackObject* create(JSGlobalObject* globalObject, Structure* structure, JSClassRef classRef, void* data)</span>
141     {
<a name="5" id="anc5"></a><span class="line-modified">142         VM&amp; vm = getVM(globalObject);</span>
143         ASSERT_UNUSED(globalObject, !structure-&gt;globalObject() || structure-&gt;globalObject() == globalObject);
<a name="6" id="anc6"></a><span class="line-modified">144         JSCallbackObject* callbackObject = new (NotNull, allocateCell&lt;JSCallbackObject&gt;(vm.heap)) JSCallbackObject(globalObject, structure, classRef, data);</span>
<span class="line-modified">145         callbackObject-&gt;finishCreation(globalObject);</span>
146         return callbackObject;
147     }
148     static JSCallbackObject&lt;Parent&gt;* create(VM&amp;, JSClassRef, Structure*);
149 
150     static const bool needsDestruction;
151     static void destroy(JSCell* cell)
152     {
153         static_cast&lt;JSCallbackObject*&gt;(cell)-&gt;JSCallbackObject::~JSCallbackObject();
154     }
155 
<a name="7" id="anc7"></a><span class="line-added">156     template&lt;typename CellType, SubspaceAccess mode&gt;</span>
<span class="line-added">157     static IsoSubspace* subspaceFor(VM&amp; vm)</span>
<span class="line-added">158     {</span>
<span class="line-added">159         return subspaceForImpl(vm, mode);</span>
<span class="line-added">160     }</span>
<span class="line-added">161 </span>
162     void setPrivate(void* data);
163     void* getPrivate();
164 
165     // FIXME: We should fix the warnings for extern-template in JSObject template classes: https://bugs.webkit.org/show_bug.cgi?id=161979
166     IGNORE_CLANG_WARNINGS_BEGIN(&quot;undefined-var-template&quot;)
167     DECLARE_INFO;
168     IGNORE_CLANG_WARNINGS_END
169 
170     JSClassRef classRef() const { return m_callbackObjectData-&gt;jsClass; }
171     bool inherits(JSClassRef) const;
172 
173     static Structure* createStructure(VM&amp;, JSGlobalObject*, JSValue);
174 
175     JSValue getPrivateProperty(const Identifier&amp; propertyName) const
176     {
177         return m_callbackObjectData-&gt;getPrivateProperty(propertyName);
178     }
179 
180     void setPrivateProperty(VM&amp; vm, const Identifier&amp; propertyName, JSValue value)
181     {
182         m_callbackObjectData-&gt;setPrivateProperty(vm, this, propertyName, value);
183     }
184 
185     void deletePrivateProperty(const Identifier&amp; propertyName)
186     {
187         m_callbackObjectData-&gt;deletePrivateProperty(propertyName);
188     }
189 
190     using Parent::methodTable;
191 
192 private:
<a name="8" id="anc8"></a><span class="line-added">193     static IsoSubspace* subspaceForImpl(VM&amp;, SubspaceAccess);</span>
194     static String className(const JSObject*, VM&amp;);
<a name="9" id="anc9"></a><span class="line-modified">195     static String toStringName(const JSObject*, JSGlobalObject*);</span>
196 
<a name="10" id="anc10"></a><span class="line-modified">197     static JSValue defaultValue(const JSObject*, JSGlobalObject*, PreferredPrimitiveType);</span>
198 
<a name="11" id="anc11"></a><span class="line-modified">199     static bool getOwnPropertySlot(JSObject*, JSGlobalObject*, PropertyName, PropertySlot&amp;);</span>
<span class="line-modified">200     static bool getOwnPropertySlotByIndex(JSObject*, JSGlobalObject*, unsigned propertyName, PropertySlot&amp;);</span>
201 
<a name="12" id="anc12"></a><span class="line-modified">202     static bool put(JSCell*, JSGlobalObject*, PropertyName, JSValue, PutPropertySlot&amp;);</span>
<span class="line-modified">203     static bool putByIndex(JSCell*, JSGlobalObject*, unsigned, JSValue, bool shouldThrow);</span>
204 
<a name="13" id="anc13"></a><span class="line-modified">205     static bool deleteProperty(JSCell*, JSGlobalObject*, PropertyName);</span>
<span class="line-modified">206     static bool deletePropertyByIndex(JSCell*, JSGlobalObject*, unsigned);</span>
207 
<a name="14" id="anc14"></a><span class="line-modified">208     static bool customHasInstance(JSObject*, JSGlobalObject*, JSValue);</span>
209 
<a name="15" id="anc15"></a><span class="line-modified">210     static void getOwnNonIndexPropertyNames(JSObject*, JSGlobalObject*, PropertyNameArray&amp;, EnumerationMode);</span>
211 
212     static ConstructType getConstructData(JSCell*, ConstructData&amp;);
213     static CallType getCallData(JSCell*, CallData&amp;);
214 
215     static void visitChildren(JSCell* cell, SlotVisitor&amp; visitor)
216     {
217         JSCallbackObject* thisObject = jsCast&lt;JSCallbackObject*&gt;(cell);
218         ASSERT_GC_OBJECT_INHERITS((static_cast&lt;Parent*&gt;(thisObject)), JSCallbackObject&lt;Parent&gt;::info());
219         Parent::visitChildren(thisObject, visitor);
220         thisObject-&gt;m_callbackObjectData-&gt;visitChildren(visitor);
221     }
222 
<a name="16" id="anc16"></a><span class="line-modified">223     void init(JSGlobalObject*);</span>
224 
225     static JSCallbackObject* asCallbackObject(JSValue);
226     static JSCallbackObject* asCallbackObject(EncodedJSValue);
227 
<a name="17" id="anc17"></a><span class="line-modified">228     static EncodedJSValue JSC_HOST_CALL call(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">229     static EncodedJSValue JSC_HOST_CALL construct(JSGlobalObject*, CallFrame*);</span>
230 
<a name="18" id="anc18"></a><span class="line-modified">231     JSValue getStaticValue(JSGlobalObject*, PropertyName);</span>
<span class="line-modified">232     static EncodedJSValue staticFunctionGetter(JSGlobalObject*, EncodedJSValue, PropertyName);</span>
<span class="line-modified">233     static EncodedJSValue callbackGetter(JSGlobalObject*, EncodedJSValue, PropertyName);</span>
234 
235     std::unique_ptr&lt;JSCallbackObjectData&gt; m_callbackObjectData;
236     const ClassInfo* m_classInfo { nullptr };
237 };
238 
239 } // namespace JSC
240 
241 // include the actual template class implementation
242 #include &quot;JSCallbackObjectFunctions.h&quot;
243 
244 #endif // JSCallbackObject_h
<a name="19" id="anc19"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="19" type="hidden" />
</body>
</html>