<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WebCore/inspector/InspectorShaderProgram.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="InspectorOverlay.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="InspectorShaderProgram.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/inspector/InspectorShaderProgram.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -24,54 +24,260 @@</span>
   */
  
  #include &quot;config.h&quot;
  #include &quot;InspectorShaderProgram.h&quot;
  
<span class="udiff-line-removed">- #if ENABLE(WEBGL)</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- #include &quot;GraphicsContext3D.h&quot;</span>
<span class="udiff-line-removed">- #include &quot;GraphicsTypes3D.h&quot;</span>
<span class="udiff-line-removed">- #include &quot;HTMLCanvasElement.h&quot;</span>
  #include &quot;InspectorCanvas.h&quot;
<span class="udiff-line-added">+ #include &lt;JavaScriptCore/IdentifiersFactory.h&gt;</span>
<span class="udiff-line-added">+ #include &lt;wtf/Optional.h&gt;</span>
<span class="udiff-line-added">+ #include &lt;wtf/Ref.h&gt;</span>
<span class="udiff-line-added">+ #include &lt;wtf/Variant.h&gt;</span>
<span class="udiff-line-added">+ #include &lt;wtf/text/WTFString.h&gt;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ #if ENABLE(WEBGL)</span>
<span class="udiff-line-added">+ #include &quot;GraphicsContextGLOpenGL.h&quot;</span>
  #include &quot;WebGLProgram.h&quot;
  #include &quot;WebGLRenderingContextBase.h&quot;
  #include &quot;WebGLShader.h&quot;
<span class="udiff-line-modified-removed">- #include &lt;JavaScriptCore/IdentifiersFactory.h&gt;</span>
<span class="udiff-line-modified-added">+ #endif</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ #if ENABLE(WEBGPU)</span>
<span class="udiff-line-added">+ #include &quot;GPUShaderModule.h&quot;</span>
<span class="udiff-line-added">+ #include &quot;WHLSLPrepare.h&quot;</span>
<span class="udiff-line-added">+ #include &quot;WebGPUComputePipeline.h&quot;</span>
<span class="udiff-line-added">+ #include &quot;WebGPUPipeline.h&quot;</span>
<span class="udiff-line-added">+ #include &quot;WebGPURenderPipeline.h&quot;</span>
<span class="udiff-line-added">+ #include &quot;WebGPUShaderModule.h&quot;</span>
<span class="udiff-line-added">+ #endif</span>
  
  namespace WebCore {
  
  using namespace Inspector;
  
<span class="udiff-line-added">+ #if ENABLE(WEBGL)</span>
  Ref&lt;InspectorShaderProgram&gt; InspectorShaderProgram::create(WebGLProgram&amp; program, InspectorCanvas&amp; inspectorCanvas)
  {
      return adoptRef(*new InspectorShaderProgram(program, inspectorCanvas));
  }
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ #if ENABLE(WEBGPU)</span>
<span class="udiff-line-added">+ Ref&lt;InspectorShaderProgram&gt; InspectorShaderProgram::create(WebGPUPipeline&amp; pipeline, InspectorCanvas&amp; inspectorCanvas)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     return adoptRef(*new InspectorShaderProgram(pipeline, inspectorCanvas));</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ #endif</span>
  
<span class="udiff-line-added">+ #if ENABLE(WEBGL)</span>
  InspectorShaderProgram::InspectorShaderProgram(WebGLProgram&amp; program, InspectorCanvas&amp; inspectorCanvas)
      : m_identifier(&quot;program:&quot; + IdentifiersFactory::createIdentifier())
<span class="udiff-line-added">+     , m_canvas(inspectorCanvas)</span>
      , m_program(program)
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     ASSERT(is&lt;WebGLRenderingContextBase&gt;(m_canvas.canvasContext()));</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ #if ENABLE(WEBGPU)</span>
<span class="udiff-line-added">+ InspectorShaderProgram::InspectorShaderProgram(WebGPUPipeline&amp; pipeline, InspectorCanvas&amp; inspectorCanvas)</span>
<span class="udiff-line-added">+     : m_identifier(&quot;pipeline:&quot; + IdentifiersFactory::createIdentifier())</span>
      , m_canvas(inspectorCanvas)
<span class="udiff-line-added">+     , m_program(pipeline)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     ASSERT(m_canvas.deviceContext());</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ #if ENABLE(WEBGL)</span>
<span class="udiff-line-added">+ WebGLProgram* InspectorShaderProgram::program() const</span>
  {
<span class="udiff-line-added">+     if (auto* programWrapper = WTF::get_if&lt;std::reference_wrapper&lt;WebGLProgram&gt;&gt;(m_program))</span>
<span class="udiff-line-added">+         return &amp;programWrapper-&gt;get();</span>
<span class="udiff-line-added">+     return nullptr;</span>
  }
<span class="udiff-line-added">+ #endif</span>
  
<span class="udiff-line-modified-removed">- WebGLRenderingContextBase&amp; InspectorShaderProgram::context() const</span>
<span class="udiff-line-modified-added">+ #if ENABLE(WEBGPU)</span>
<span class="udiff-line-added">+ WebGPUPipeline* InspectorShaderProgram::pipeline() const</span>
  {
<span class="udiff-line-modified-removed">-     ASSERT(is&lt;WebGLRenderingContextBase&gt;(m_canvas.context()));</span>
<span class="udiff-line-modified-removed">-     return downcast&lt;WebGLRenderingContextBase&gt;(m_canvas.context());</span>
<span class="udiff-line-modified-added">+     if (auto* pipelineWrapper = WTF::get_if&lt;std::reference_wrapper&lt;WebGPUPipeline&gt;&gt;(m_program))</span>
<span class="udiff-line-modified-added">+         return &amp;pipelineWrapper-&gt;get();</span>
<span class="udiff-line-added">+     return nullptr;</span>
  }
<span class="udiff-line-added">+ #endif</span>
  
<span class="udiff-line-modified-removed">- WebGLShader* InspectorShaderProgram::shaderForType(const String&amp; protocolType)</span>
<span class="udiff-line-modified-added">+ #if ENABLE(WEBGL)</span>
<span class="udiff-line-added">+ static WebGLShader* shaderForType(WebGLProgram&amp; program, Inspector::Protocol::Canvas::ShaderType shaderType)</span>
  {
<span class="udiff-line-modified-removed">-     GC3Denum shaderType;</span>
<span class="udiff-line-modified-removed">-     if (protocolType == &quot;vertex&quot;)</span>
<span class="udiff-line-modified-removed">-         shaderType = GraphicsContext3D::VERTEX_SHADER;</span>
<span class="udiff-line-modified-removed">-     else if (protocolType == &quot;fragment&quot;)</span>
<span class="udiff-line-modified-removed">-         shaderType = GraphicsContext3D::FRAGMENT_SHADER;</span>
<span class="udiff-line-modified-removed">-     else</span>
<span class="udiff-line-modified-added">+     switch (shaderType) {</span>
<span class="udiff-line-modified-added">+     case Inspector::Protocol::Canvas::ShaderType::Fragment:</span>
<span class="udiff-line-modified-added">+         return program.getAttachedShader(GraphicsContextGL::FRAGMENT_SHADER);</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+     case Inspector::Protocol::Canvas::ShaderType::Vertex:</span>
<span class="udiff-line-modified-added">+         return program.getAttachedShader(GraphicsContextGL::VERTEX_SHADER);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     // Compute shaders are a WebGPU concept.</span>
<span class="udiff-line-added">+     case Inspector::Protocol::Canvas::ShaderType::Compute:</span>
          return nullptr;
<span class="udiff-line-added">+     }</span>
  
<span class="udiff-line-modified-removed">-     return m_program.getAttachedShader(shaderType);</span>
<span class="udiff-line-modified-added">+     ASSERT_NOT_REACHED();</span>
<span class="udiff-line-added">+     return nullptr;</span>
  }
<span class="udiff-line-added">+ #endif</span>
  
<span class="udiff-line-modified-removed">- } // namespace WebCore</span>
<span class="udiff-line-modified-added">+ #if ENABLE(WEBGPU)</span>
<span class="udiff-line-added">+ static RefPtr&lt;WebGPUShaderModule&gt; shaderForType(WebGPUPipeline&amp; pipeline, Inspector::Protocol::Canvas::ShaderType shaderType)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     switch (shaderType) {</span>
<span class="udiff-line-added">+     case Inspector::Protocol::Canvas::ShaderType::Compute:</span>
<span class="udiff-line-added">+         if (is&lt;WebGPUComputePipeline&gt;(pipeline))</span>
<span class="udiff-line-added">+             return downcast&lt;WebGPUComputePipeline&gt;(pipeline).computeShader();</span>
<span class="udiff-line-added">+         return nullptr;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     case Inspector::Protocol::Canvas::ShaderType::Fragment:</span>
<span class="udiff-line-added">+         if (is&lt;WebGPURenderPipeline&gt;(pipeline))</span>
<span class="udiff-line-added">+             return downcast&lt;WebGPURenderPipeline&gt;(pipeline).fragmentShader();</span>
<span class="udiff-line-added">+         return nullptr;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     case Inspector::Protocol::Canvas::ShaderType::Vertex:</span>
<span class="udiff-line-added">+         if (is&lt;WebGPURenderPipeline&gt;(pipeline))</span>
<span class="udiff-line-added">+             return downcast&lt;WebGPURenderPipeline&gt;(pipeline).vertexShader();</span>
<span class="udiff-line-added">+         return nullptr;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     ASSERT_NOT_REACHED();</span>
<span class="udiff-line-added">+     return nullptr;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ String InspectorShaderProgram::requestShaderSource(Inspector::Protocol::Canvas::ShaderType shaderType)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+ #if !ENABLE(WEBGL) &amp;&amp; !ENABLE(WEBGPU)</span>
<span class="udiff-line-added">+     UNUSED_PARAM(shaderType);</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     return WTF::switchOn(m_program,</span>
<span class="udiff-line-added">+ #if ENABLE(WEBGL)</span>
<span class="udiff-line-added">+         [&amp;] (std::reference_wrapper&lt;WebGLProgram&gt; programWrapper) {</span>
<span class="udiff-line-added">+             auto&amp; program = programWrapper.get();</span>
<span class="udiff-line-added">+             if (auto* shader = shaderForType(program, shaderType))</span>
<span class="udiff-line-added">+                 return shader-&gt;getSource();</span>
<span class="udiff-line-added">+             return String();</span>
<span class="udiff-line-added">+         },</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+ #if ENABLE(WEBGPU)</span>
<span class="udiff-line-added">+         [&amp;] (std::reference_wrapper&lt;WebGPUPipeline&gt; pipelineWrapper) {</span>
<span class="udiff-line-added">+             auto&amp; pipeline = pipelineWrapper.get();</span>
<span class="udiff-line-added">+             if (auto shader = shaderForType(pipeline, shaderType))</span>
<span class="udiff-line-added">+                 return shader-&gt;source();</span>
<span class="udiff-line-added">+             return String();</span>
<span class="udiff-line-added">+         },</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+         [&amp;] (Monostate) {</span>
<span class="udiff-line-added">+ #if ENABLE(WEBGL) || ENABLE(WEBGPU)</span>
<span class="udiff-line-added">+             ASSERT_NOT_REACHED();</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+             return String();</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     );</span>
<span class="udiff-line-added">+ }</span>
  
<span class="udiff-line-modified-removed">- #endif // ENABLE(WEBGL)</span>
<span class="udiff-line-modified-added">+ bool InspectorShaderProgram::updateShader(Inspector::Protocol::Canvas::ShaderType shaderType, const String&amp; source)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+ #if !ENABLE(WEBGL) &amp;&amp; !ENABLE(WEBGPU)</span>
<span class="udiff-line-added">+     UNUSED_PARAM(shaderType);</span>
<span class="udiff-line-added">+     UNUSED_PARAM(source);</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     return WTF::switchOn(m_program,</span>
<span class="udiff-line-added">+ #if ENABLE(WEBGL)</span>
<span class="udiff-line-added">+         [&amp;] (std::reference_wrapper&lt;WebGLProgram&gt; programWrapper) {</span>
<span class="udiff-line-added">+             auto&amp; program = programWrapper.get();</span>
<span class="udiff-line-added">+             if (auto* shader = shaderForType(program, shaderType)) {</span>
<span class="udiff-line-added">+                 if (auto* context = m_canvas.canvasContext()) {</span>
<span class="udiff-line-added">+                     if (is&lt;WebGLRenderingContextBase&gt;(context)) {</span>
<span class="udiff-line-added">+                         auto&amp; contextWebGLBase = downcast&lt;WebGLRenderingContextBase&gt;(*context);</span>
<span class="udiff-line-added">+                         contextWebGLBase.shaderSource(shader, source);</span>
<span class="udiff-line-added">+                         contextWebGLBase.compileShader(shader);</span>
<span class="udiff-line-added">+                         if (shader-&gt;isValid()) {</span>
<span class="udiff-line-added">+                             contextWebGLBase.linkProgramWithoutInvalidatingAttribLocations(&amp;program);</span>
<span class="udiff-line-added">+                             return true;</span>
<span class="udiff-line-added">+                         }</span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             return false;</span>
<span class="udiff-line-added">+         },</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+ #if ENABLE(WEBGPU)</span>
<span class="udiff-line-added">+         [&amp;] (std::reference_wrapper&lt;WebGPUPipeline&gt; pipelineWrapper) {</span>
<span class="udiff-line-added">+             auto&amp; pipeline = pipelineWrapper.get();</span>
<span class="udiff-line-added">+             if (auto* device = m_canvas.deviceContext()) {</span>
<span class="udiff-line-added">+                 if (pipeline.cloneShaderModules(*device)) {</span>
<span class="udiff-line-added">+                     if (auto shader = shaderForType(pipeline, shaderType)) {</span>
<span class="udiff-line-added">+                         shader-&gt;update(*device, source);</span>
<span class="udiff-line-added">+                         if (pipeline.recompile(*device))</span>
<span class="udiff-line-added">+                             return true;</span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             return false;</span>
<span class="udiff-line-added">+         },</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+         [&amp;] (Monostate) {</span>
<span class="udiff-line-added">+ #if ENABLE(WEBGL) || ENABLE(WEBGPU)</span>
<span class="udiff-line-added">+             ASSERT_NOT_REACHED();</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+             return false;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     );</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ Ref&lt;Inspector::Protocol::Canvas::ShaderProgram&gt; InspectorShaderProgram::buildObjectForShaderProgram()</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     bool sharesVertexFragmentShader = false;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     using ProgramTypeType = Optional&lt;Inspector::Protocol::Canvas::ProgramType&gt;;</span>
<span class="udiff-line-added">+     auto programType = WTF::switchOn(m_program,</span>
<span class="udiff-line-added">+ #if ENABLE(WEBGL)</span>
<span class="udiff-line-added">+         [&amp;] (std::reference_wrapper&lt;WebGLProgram&gt;) -&gt; ProgramTypeType {</span>
<span class="udiff-line-added">+             return Inspector::Protocol::Canvas::ProgramType::Render;</span>
<span class="udiff-line-added">+         },</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+ #if ENABLE(WEBGPU)</span>
<span class="udiff-line-added">+         [&amp;] (std::reference_wrapper&lt;WebGPUPipeline&gt; pipelineWrapper) -&gt; ProgramTypeType {</span>
<span class="udiff-line-added">+             auto&amp; pipeline = pipelineWrapper.get();</span>
<span class="udiff-line-added">+             if (is&lt;WebGPUComputePipeline&gt;(pipeline))</span>
<span class="udiff-line-added">+                 return Inspector::Protocol::Canvas::ProgramType::Compute;</span>
<span class="udiff-line-added">+             if (is&lt;WebGPURenderPipeline&gt;(pipeline)) {</span>
<span class="udiff-line-added">+                 auto&amp; renderPipeline = downcast&lt;WebGPURenderPipeline&gt;(pipeline);</span>
<span class="udiff-line-added">+                 if (renderPipeline.vertexShader() == renderPipeline.fragmentShader())</span>
<span class="udiff-line-added">+                     sharesVertexFragmentShader = true;</span>
<span class="udiff-line-added">+                 return Inspector::Protocol::Canvas::ProgramType::Render;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             return WTF::nullopt;</span>
<span class="udiff-line-added">+         },</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+         [&amp;] (Monostate) -&gt; ProgramTypeType {</span>
<span class="udiff-line-added">+ #if ENABLE(WEBGL) || ENABLE(WEBGPU)</span>
<span class="udiff-line-added">+             ASSERT_NOT_REACHED();</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+             return WTF::nullopt;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     );</span>
<span class="udiff-line-added">+     if (!programType) {</span>
<span class="udiff-line-added">+         ASSERT_NOT_REACHED();</span>
<span class="udiff-line-added">+         programType = Inspector::Protocol::Canvas::ProgramType::Render;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     auto payload = Inspector::Protocol::Canvas::ShaderProgram::create()</span>
<span class="udiff-line-added">+         .setProgramId(m_identifier)</span>
<span class="udiff-line-added">+         .setProgramType(programType.value())</span>
<span class="udiff-line-added">+         .setCanvasId(m_canvas.identifier())</span>
<span class="udiff-line-added">+         .release();</span>
<span class="udiff-line-added">+     if (sharesVertexFragmentShader)</span>
<span class="udiff-line-added">+         payload-&gt;setSharesVertexFragmentShader(true);</span>
<span class="udiff-line-added">+     return payload;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ } // namespace WebCore</span>
</pre>
<center><a href="InspectorOverlay.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="InspectorShaderProgram.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>