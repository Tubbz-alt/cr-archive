<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/JavaScriptCore/builtins/AsyncGeneratorPrototype.js</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (C) 2017 Oleksandr Skachkov &lt;gskachkov@gmail.com&gt;.
<a name="1" id="anc1"></a><span class="line-added">  3  * Copyright (C) 2019 Apple Inc. All rights reserved.</span>
  4  *
  5  * Redistribution and use in source and binary forms, with or without
  6  * modification, are permitted provided that the following conditions
  7  * are met:
  8  * 1. Redistributions of source code must retain the above copyright
  9  *    notice, this list of conditions and the following disclaimer.
 10  * 2. Redistributions in binary form must reproduce the above copyright
 11  *    notice, this list of conditions and the following disclaimer in the
 12  *    documentation and/or other materials provided with the distribution.
 13  *
 14  * THIS SOFTWARE IS PROVIDED BY APPLE INC. ``AS IS&#39;&#39; AND ANY
 15  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 16  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 17  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE INC. OR
 18  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 19  * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 20  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 21  * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 22  * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 23  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 24  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 25  */
 26 
 27 @globalPrivate
 28 function asyncGeneratorQueueIsEmpty(generator)
 29 {
 30     &quot;use strict&quot;;
 31 
<a name="2" id="anc2"></a><span class="line-modified"> 32     return @getAsyncGeneratorInternalField(generator, @asyncGeneratorFieldQueueFirst) === null;</span>
 33 }
 34 
 35 @globalPrivate
 36 function asyncGeneratorQueueEnqueue(generator, item)
 37 {
 38     &quot;use strict&quot;;
 39 
<a name="3" id="anc3"></a><span class="line-modified"> 40     @assert(@getByIdDirectPrivate(item, &quot;asyncGeneratorQueueItemNext&quot;) === null);</span>
 41 
<a name="4" id="anc4"></a><span class="line-modified"> 42     if (@getAsyncGeneratorInternalField(generator, @asyncGeneratorFieldQueueFirst) === null) {</span>
<span class="line-modified"> 43         @assert(@getAsyncGeneratorInternalField(generator, @asyncGeneratorFieldQueueLast) === null);</span>
 44 
<a name="5" id="anc5"></a><span class="line-modified"> 45         @putAsyncGeneratorInternalField(generator, @asyncGeneratorFieldQueueFirst, item);</span>
<span class="line-modified"> 46         @putAsyncGeneratorInternalField(generator, @asyncGeneratorFieldQueueLast, item);</span>
 47     } else {
<a name="6" id="anc6"></a><span class="line-modified"> 48         var last = @getAsyncGeneratorInternalField(generator, @asyncGeneratorFieldQueueLast);</span>

 49         @putByIdDirectPrivate(last, &quot;asyncGeneratorQueueItemNext&quot;, item);
<a name="7" id="anc7"></a><span class="line-modified"> 50         @putAsyncGeneratorInternalField(generator, @asyncGeneratorFieldQueueLast, item);</span>
 51     }
 52 }
 53 
 54 @globalPrivate
 55 function asyncGeneratorQueueDequeue(generator)
 56 {
 57     &quot;use strict&quot;;
 58 
<a name="8" id="anc8"></a><span class="line-modified"> 59     @assert(!@asyncGeneratorQueueIsEmpty(generator), &quot;Async genetator&#39;s Queue is an empty List.&quot;);</span>
<span class="line-modified"> 60 </span>
<span class="line-modified"> 61     var result = @getAsyncGeneratorInternalField(generator, @asyncGeneratorFieldQueueFirst);</span>
 62 
 63     var updatedFirst = @getByIdDirectPrivate(result, &quot;asyncGeneratorQueueItemNext&quot;);
<a name="9" id="anc9"></a><span class="line-modified"> 64     @putAsyncGeneratorInternalField(generator, @asyncGeneratorFieldQueueFirst, updatedFirst);</span>
 65 
 66     if (updatedFirst === null)
<a name="10" id="anc10"></a><span class="line-modified"> 67         @putAsyncGeneratorInternalField(generator, @asyncGeneratorFieldQueueLast, null);</span>
 68 
 69     return result;
 70 }
 71 
<a name="11" id="anc11"></a>











 72 @globalPrivate
 73 function isExecutionState(generator)
 74 {
 75     &quot;use strict&quot;;
 76 
<a name="12" id="anc12"></a><span class="line-modified"> 77     var state = @getAsyncGeneratorInternalField(generator, @generatorFieldState);</span>
<span class="line-modified"> 78     var reason = @getAsyncGeneratorInternalField(generator, @asyncGeneratorFieldSuspendReason);</span>
 79     return (state &gt; 0 &amp;&amp; reason === @AsyncGeneratorSuspendReasonNone)
 80         || state === @AsyncGeneratorStateExecuting
 81         || reason === @AsyncGeneratorSuspendReasonAwait;
 82 }
 83 
 84 @globalPrivate
 85 function isSuspendYieldState(generator)
 86 {
 87     &quot;use strict&quot;;
 88 
<a name="13" id="anc13"></a><span class="line-modified"> 89     var state = @getAsyncGeneratorInternalField(generator, @generatorFieldState);</span>
<span class="line-modified"> 90     return (state &gt; 0 &amp;&amp; @getAsyncGeneratorInternalField(generator, @asyncGeneratorFieldSuspendReason) === @AsyncGeneratorSuspendReasonYield)</span>
 91         || state === @AsyncGeneratorStateSuspendedYield;
 92 }
 93 
 94 @globalPrivate
 95 function asyncGeneratorReject(generator, exception)
 96 {
 97     &quot;use strict&quot;;
 98 
<a name="14" id="anc14"></a><span class="line-modified"> 99     @assert(@isAsyncGenerator(generator), &quot;Generator is not an AsyncGenerator instance.&quot;);</span>
100 
<a name="15" id="anc15"></a><span class="line-modified">101     var promise = @asyncGeneratorQueueDequeue(generator).promise;</span>
<span class="line-modified">102     @assert(@isPromise(promise));</span>
<span class="line-added">103     @rejectPromiseWithFirstResolvingFunctionCallCheck(promise, exception);</span>
104 
105     return @asyncGeneratorResumeNext(generator);
106 }
107 
108 @globalPrivate
109 function asyncGeneratorResolve(generator, value, done)
110 {
111     &quot;use strict&quot;;
112 
<a name="16" id="anc16"></a><span class="line-modified">113     @assert(@isAsyncGenerator(generator), &quot;Generator is not an AsyncGenerator instance.&quot;);</span>
114 
<a name="17" id="anc17"></a><span class="line-modified">115     var promise = @asyncGeneratorQueueDequeue(generator).promise;</span>
<span class="line-modified">116     @assert(@isPromise(promise));</span>
<span class="line-added">117     @resolvePromiseWithFirstResolvingFunctionCallCheck(promise, { value, done });</span>
118 
119     return @asyncGeneratorResumeNext(generator);
120 }
121 
122 @globalPrivate
123 function asyncGeneratorYield(generator, value, resumeMode)
124 {
125     &quot;use strict&quot;;
126 
127     function asyncGeneratorYieldAwaited(result)
128     {
<a name="18" id="anc18"></a><span class="line-modified">129         @putAsyncGeneratorInternalField(generator, @asyncGeneratorFieldSuspendReason, @AsyncGeneratorSuspendReasonYield);</span>
130         @asyncGeneratorResolve(generator, result, false);
131     }
132 
<a name="19" id="anc19"></a><span class="line-modified">133     @putAsyncGeneratorInternalField(generator, @asyncGeneratorFieldSuspendReason, @AsyncGeneratorSuspendReasonAwait);</span>
134 
135     @awaitValue(generator, value, asyncGeneratorYieldAwaited);
<a name="20" id="anc20"></a>

136 }
137 
138 @globalPrivate
<a name="21" id="anc21"></a><span class="line-modified">139 function awaitValue(generator, value, onFulfilled)</span>
140 {
141     &quot;use strict&quot;;
142 
<a name="22" id="anc22"></a><span class="line-modified">143     var onRejected = function (result) { @doAsyncGeneratorBodyCall(generator, result, @GeneratorResumeModeThrow); };</span>
<span class="line-modified">144     @resolveWithoutPromise(value, onFulfilled, onRejected);</span>






145 }
146 
147 @globalPrivate
148 function doAsyncGeneratorBodyCall(generator, resumeValue, resumeMode)
149 {
150     &quot;use strict&quot;;
151 
<a name="23" id="anc23"></a><span class="line-modified">152     var value = @undefined;</span>
<span class="line-modified">153     var state = @getAsyncGeneratorInternalField(generator, @generatorFieldState);</span>
154 
<a name="24" id="anc24"></a><span class="line-modified">155     @putAsyncGeneratorInternalField(generator, @generatorFieldState, @AsyncGeneratorStateExecuting);</span>
<span class="line-modified">156     @putAsyncGeneratorInternalField(generator, @asyncGeneratorFieldSuspendReason, @AsyncGeneratorSuspendReasonNone);</span>
157 
158     try {
<a name="25" id="anc25"></a><span class="line-modified">159         value = @getAsyncGeneratorInternalField(generator, @generatorFieldNext).@call(@getAsyncGeneratorInternalField(generator, @generatorFieldThis), generator, state, resumeValue, resumeMode, @getAsyncGeneratorInternalField(generator, @generatorFieldFrame));</span>
<span class="line-modified">160         state = @getAsyncGeneratorInternalField(generator, @generatorFieldState);</span>
<span class="line-modified">161         if (state === @AsyncGeneratorStateExecuting) {</span>
<span class="line-added">162             @putAsyncGeneratorInternalField(generator, @generatorFieldState, @AsyncGeneratorStateCompleted);</span>
<span class="line-added">163             state = @AsyncGeneratorStateCompleted;</span>
<span class="line-added">164         }</span>
165     } catch (error) {
<a name="26" id="anc26"></a><span class="line-modified">166         @putAsyncGeneratorInternalField(generator, @generatorFieldState, @AsyncGeneratorStateCompleted);</span>
<span class="line-modified">167         @putAsyncGeneratorInternalField(generator, @asyncGeneratorFieldSuspendReason, @AsyncGeneratorSuspendReasonNone);</span>
168 
169         return @asyncGeneratorReject(generator, error);
170     }
171 
<a name="27" id="anc27"></a><span class="line-modified">172     var reason = @getAsyncGeneratorInternalField(generator, @asyncGeneratorFieldSuspendReason);</span>
<span class="line-modified">173     if (reason === @AsyncGeneratorSuspendReasonAwait) {</span>
<span class="line-added">174         var onFulfilled = function(result) { @doAsyncGeneratorBodyCall(generator, result, @GeneratorResumeModeNormal); };</span>
175 
176         @awaitValue(generator, value, onFulfilled);
<a name="28" id="anc28"></a><span class="line-modified">177         return;</span>

178     }
179 
<a name="29" id="anc29"></a><span class="line-modified">180     if (reason === @AsyncGeneratorSuspendReasonYield)</span>
181         return @asyncGeneratorYield(generator, value, resumeMode);
182 
<a name="30" id="anc30"></a><span class="line-modified">183     if (state === @AsyncGeneratorStateCompleted) {</span>
<span class="line-modified">184         @assert(@getAsyncGeneratorInternalField(generator, @generatorFieldState) == @AsyncGeneratorStateCompleted);</span>
<span class="line-added">185         @putAsyncGeneratorInternalField(generator, @asyncGeneratorFieldSuspendReason, @AsyncGeneratorSuspendReasonNone);</span>
186         return @asyncGeneratorResolve(generator, value, true);
187     }
<a name="31" id="anc31"></a>

188 }
189 
190 @globalPrivate
191 function asyncGeneratorResumeNext(generator)
192 {
193     &quot;use strict&quot;;
194 
<a name="32" id="anc32"></a><span class="line-modified">195     @assert(@isAsyncGenerator(generator), &quot;Generator is not an AsyncGenerator instance.&quot;);</span>
196 
<a name="33" id="anc33"></a><span class="line-modified">197     var state = @getAsyncGeneratorInternalField(generator, @generatorFieldState);</span>
198 
199     @assert(state !== @AsyncGeneratorStateExecuting, &quot;Async generator should not be in executing state&quot;);
200 
201     if (state === @AsyncGeneratorStateAwaitingReturn)
<a name="34" id="anc34"></a><span class="line-modified">202         return;</span>
203 
204     if (@asyncGeneratorQueueIsEmpty(generator))
<a name="35" id="anc35"></a><span class="line-modified">205         return;</span>
206 
<a name="36" id="anc36"></a><span class="line-modified">207     var next = @getAsyncGeneratorInternalField(generator, @asyncGeneratorFieldQueueFirst);</span>
208 
209     if (next.resumeMode !== @GeneratorResumeModeNormal) {
210         if (state === @AsyncGeneratorStateSuspendedStart) {
<a name="37" id="anc37"></a><span class="line-modified">211             @putAsyncGeneratorInternalField(generator, @generatorFieldState, @AsyncGeneratorStateCompleted);</span>
212             state = @AsyncGeneratorStateCompleted;
213         }
214 
215         if (state === @AsyncGeneratorStateCompleted) {
216             if (next.resumeMode === @GeneratorResumeModeReturn) {
<a name="38" id="anc38"></a><span class="line-modified">217                 @putAsyncGeneratorInternalField(generator, @generatorFieldState, @AsyncGeneratorStateAwaitingReturn);</span>
<span class="line-modified">218                 @resolveWithoutPromise(next.value,</span>
<span class="line-modified">219                     function (result) {</span>
<span class="line-modified">220                         @putAsyncGeneratorInternalField(generator, @generatorFieldState, @AsyncGeneratorStateCompleted);</span>
<span class="line-modified">221                         @asyncGeneratorResolve(generator, result, true);</span>
<span class="line-modified">222                     },</span>
<span class="line-modified">223                     function (error) {</span>
<span class="line-modified">224                         @putAsyncGeneratorInternalField(generator, @generatorFieldState, @AsyncGeneratorStateCompleted);</span>
<span class="line-modified">225                         @asyncGeneratorReject(generator, error);</span>
<span class="line-modified">226                     });</span>
<span class="line-modified">227                 return;</span>

228             }
229 
230             @assert(next.resumeMode === @GeneratorResumeModeThrow, &quot;Async generator has wrong mode&quot;);
231 
232             return @asyncGeneratorReject(generator, next.value);;
233         }
234     } else if (state === @AsyncGeneratorStateCompleted)
235         return @asyncGeneratorResolve(generator, @undefined, true);
236 
237     @assert(state === @AsyncGeneratorStateSuspendedStart || @isSuspendYieldState(generator), &quot;Async generator has wrong state&quot;);
238 
239     @doAsyncGeneratorBodyCall(generator, next.value, next.resumeMode);
<a name="39" id="anc39"></a>

240 }
241 
242 @globalPrivate
243 function asyncGeneratorEnqueue(generator, value, resumeMode)
244 {
245     &quot;use strict&quot;;
<a name="40" id="anc40"></a><span class="line-modified">246 </span>
<span class="line-modified">247     var promise = @newPromise();</span>
<span class="line-modified">248     if (!@isAsyncGenerator(generator)) {</span>
<span class="line-modified">249         @rejectPromiseWithFirstResolvingFunctionCallCheck(promise, @makeTypeError(&#39;|this| should be an async generator&#39;));</span>
<span class="line-modified">250         return promise;</span>
251     }
252 
<a name="41" id="anc41"></a><span class="line-modified">253     @asyncGeneratorQueueEnqueue(generator, {resumeMode, value, promise, @asyncGeneratorQueueItemNext: null});</span>
254 
255     if (!@isExecutionState(generator))
256         @asyncGeneratorResumeNext(generator);
257 
<a name="42" id="anc42"></a><span class="line-modified">258     return promise;</span>
259 }
260 
261 function next(value)
262 {
263     &quot;use strict&quot;;
264 
265     return @asyncGeneratorEnqueue(this, value, @GeneratorResumeModeNormal);
266 }
267 
268 function return(value)
269 {
270     &quot;use strict&quot;;
271 
272     return @asyncGeneratorEnqueue(this, value, @GeneratorResumeModeReturn);
273 }
274 
275 function throw(exception)
276 {
277     &quot;use strict&quot;;
278     
279     return @asyncGeneratorEnqueue(this, exception, @GeneratorResumeModeThrow);
280 }
<a name="43" id="anc43"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="43" type="hidden" />
</body>
</html>