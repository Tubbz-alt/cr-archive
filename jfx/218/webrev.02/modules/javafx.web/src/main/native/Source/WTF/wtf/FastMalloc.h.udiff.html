<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WTF/wtf/FastMalloc.h</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="FastMalloc.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="FileSystem.cpp.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WTF/wtf/FastMalloc.h</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -20,10 +20,11 @@</span>
  
  #pragma once
  
  #include &lt;new&gt;
  #include &lt;stdlib.h&gt;
<span class="udiff-line-added">+ #include &lt;wtf/DebugHeap.h&gt;</span>
  #include &lt;wtf/StdLibExtras.h&gt;
  
  namespace WTF {
  
  #if !defined(NDEBUG)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -80,10 +81,12 @@</span>
      size_t committedVMBytes;
      size_t freeListBytes;
  };
  WTF_EXPORT_PRIVATE FastMallocStatistics fastMallocStatistics();
  
<span class="udiff-line-added">+ WTF_EXPORT_PRIVATE void fastMallocDumpMallocStats();</span>
<span class="udiff-line-added">+ </span>
  // This defines a type which holds an unsigned integer and is the same
  // size as the minimally aligned memory allocation.
  typedef unsigned long long AllocAlignmentInteger;
  
  inline TryMallocReturnValue::TryMallocReturnValue(void* data)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -198,10 +201,21 @@</span>
          if (result.getValue(realResult))
              return realResult;
          return nullptr;
      }
  
<span class="udiff-line-added">+     static void* zeroedMalloc(size_t size) { return fastZeroedMalloc(size); }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     static void* tryZeroedMalloc(size_t size)</span>
<span class="udiff-line-added">+     {</span>
<span class="udiff-line-added">+         auto result = tryFastZeroedMalloc(size);</span>
<span class="udiff-line-added">+         void* realResult;</span>
<span class="udiff-line-added">+         if (result.getValue(realResult))</span>
<span class="udiff-line-added">+             return realResult;</span>
<span class="udiff-line-added">+         return nullptr;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      static void* realloc(void* p, size_t size) { return fastRealloc(p, size); }
  
      static void* tryRealloc(void* p, size_t size)
      {
          auto result = tryFastRealloc(p, size);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -297,14 +311,80 @@</span>
          ASSERT(location); \
          return location; \
      } \
      using webkitFastMalloced = int; \
  
<span class="udiff-line-added">+ // FIXME: WTF_MAKE_FAST_ALLOCATED should take class name so that we can create malloc_zone per this macro.</span>
<span class="udiff-line-added">+ // https://bugs.webkit.org/show_bug.cgi?id=205702</span>
  #define WTF_MAKE_FAST_ALLOCATED \
  public: \
      WTF_MAKE_FAST_ALLOCATED_IMPL \
  private: \
  using __thisIsHereToForceASemicolonAfterThisMacro = int
  
  #define WTF_MAKE_STRUCT_FAST_ALLOCATED \
      WTF_MAKE_FAST_ALLOCATED_IMPL \
  using __thisIsHereToForceASemicolonAfterThisMacro = int
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ #if ENABLE(MALLOC_HEAP_BREAKDOWN)</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ #define WTF_MAKE_FAST_ALLOCATED_WITH_HEAP_IDENTIFIER_IMPL(classname) \</span>
<span class="udiff-line-added">+     void* operator new(size_t, void* p) { return p; } \</span>
<span class="udiff-line-added">+     void* operator new[](size_t, void* p) { return p; } \</span>
<span class="udiff-line-added">+     \</span>
<span class="udiff-line-added">+     void* operator new(size_t size) \</span>
<span class="udiff-line-added">+     { \</span>
<span class="udiff-line-added">+         return classname##Malloc::malloc(size); \</span>
<span class="udiff-line-added">+     } \</span>
<span class="udiff-line-added">+     \</span>
<span class="udiff-line-added">+     void operator delete(void* p) \</span>
<span class="udiff-line-added">+     { \</span>
<span class="udiff-line-added">+         classname##Malloc::free(p); \</span>
<span class="udiff-line-added">+     } \</span>
<span class="udiff-line-added">+     \</span>
<span class="udiff-line-added">+     void* operator new[](size_t size) \</span>
<span class="udiff-line-added">+     { \</span>
<span class="udiff-line-added">+         return classname##Malloc::malloc(size); \</span>
<span class="udiff-line-added">+     } \</span>
<span class="udiff-line-added">+     \</span>
<span class="udiff-line-added">+     void operator delete[](void* p) \</span>
<span class="udiff-line-added">+     { \</span>
<span class="udiff-line-added">+         classname##Malloc::free(p); \</span>
<span class="udiff-line-added">+     } \</span>
<span class="udiff-line-added">+     void* operator new(size_t, NotNullTag, void* location) \</span>
<span class="udiff-line-added">+     { \</span>
<span class="udiff-line-added">+         ASSERT(location); \</span>
<span class="udiff-line-added">+         return location; \</span>
<span class="udiff-line-added">+     } \</span>
<span class="udiff-line-added">+     using webkitFastMalloced = int; \</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ #define WTF_MAKE_FAST_ALLOCATED_WITH_HEAP_IDENTIFIER(classname) \</span>
<span class="udiff-line-added">+ public: \</span>
<span class="udiff-line-added">+     WTF_MAKE_FAST_ALLOCATED_WITH_HEAP_IDENTIFIER_IMPL(classname) \</span>
<span class="udiff-line-added">+ private: \</span>
<span class="udiff-line-added">+     WTF_EXPORT_PRIVATE static WTF::DebugHeap&amp; debugHeap(const char*); \</span>
<span class="udiff-line-added">+ using __thisIsHereToForceASemicolonAfterThisMacro = int</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ #define WTF_MAKE_STRUCT_FAST_ALLOCATED_WITH_HEAP_IDENTIFIER(className) \</span>
<span class="udiff-line-added">+ private: \</span>
<span class="udiff-line-added">+     WTF_EXPORT_PRIVATE static WTF::DebugHeap&amp; debugHeap(const char*); \</span>
<span class="udiff-line-added">+ public: \</span>
<span class="udiff-line-added">+     WTF_MAKE_FAST_ALLOCATED_WITH_HEAP_IDENTIFIER_IMPL(className) \</span>
<span class="udiff-line-added">+ using __thisIsHereToForceASemicolonAfterThisMacro = int</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ #else</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ #define WTF_MAKE_FAST_ALLOCATED_WITH_HEAP_IDENTIFIER_IMPL(classname) \</span>
<span class="udiff-line-added">+     WTF_MAKE_FAST_ALLOCATED_IMPL</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ #define WTF_MAKE_FAST_ALLOCATED_WITH_HEAP_IDENTIFIER(classname) \</span>
<span class="udiff-line-added">+ public: \</span>
<span class="udiff-line-added">+     WTF_MAKE_FAST_ALLOCATED_WITH_HEAP_IDENTIFIER_IMPL(classname) \</span>
<span class="udiff-line-added">+ private: \</span>
<span class="udiff-line-added">+ using __thisIsHereToForceASemicolonAfterThisMacro = int</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ #define WTF_MAKE_STRUCT_FAST_ALLOCATED_WITH_HEAP_IDENTIFIER(className) \</span>
<span class="udiff-line-added">+ public: \</span>
<span class="udiff-line-added">+     WTF_MAKE_FAST_ALLOCATED_WITH_HEAP_IDENTIFIER_IMPL(className) \</span>
<span class="udiff-line-added">+ using __thisIsHereToForceASemicolonAfterThisMacro = int</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ #endif</span>
</pre>
<center><a href="FastMalloc.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="FileSystem.cpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>