<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/WebCore/svg/SVGLengthValue.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (C) 2004, 2005, 2006 Nikolas Zimmermann &lt;zimmermann@kde.org&gt;
  3  * Copyright (C) 2004, 2005, 2006, 2007 Rob Buis &lt;buis@kde.org&gt;
<a name="1" id="anc1"></a><span class="line-modified">  4  * Copyright (C) 2007-2019 Apple Inc. All rights reserved.</span>
  5  *
  6  * This library is free software; you can redistribute it and/or
  7  * modify it under the terms of the GNU Library General Public
  8  * License as published by the Free Software Foundation; either
  9  * version 2 of the License, or (at your option) any later version.
 10  *
 11  * This library is distributed in the hope that it will be useful,
 12  * but WITHOUT ANY WARRANTY; without even the implied warranty of
 13  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 14  * Library General Public License for more details.
 15  *
 16  * You should have received a copy of the GNU Library General Public License
 17  * along with this library; see the file COPYING.LIB.  If not, write to
 18  * the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
 19  * Boston, MA 02110-1301, USA.
 20  */
 21 
 22 #include &quot;config.h&quot;
 23 #include &quot;SVGLengthValue.h&quot;
 24 
<a name="2" id="anc2"></a><span class="line-modified"> 25 #include &quot;AnimationUtilities.h&quot;</span>
 26 #include &quot;CSSPrimitiveValue.h&quot;
<a name="3" id="anc3"></a><span class="line-modified"> 27 #include &quot;SVGLengthContext.h&quot;</span>

 28 #include &quot;SVGParserUtilities.h&quot;
<a name="4" id="anc4"></a>

 29 #include &lt;wtf/text/StringConcatenateNumbers.h&gt;
 30 #include &lt;wtf/text/TextStream.h&gt;
 31 
 32 namespace WebCore {
 33 
<a name="5" id="anc5"></a><span class="line-modified"> 34 static inline const char* lengthTypeToString(SVGLengthType lengthType)</span>

 35 {
<a name="6" id="anc6"></a><span class="line-modified"> 36     switch (lengthType) {</span>
<span class="line-modified"> 37     case SVGLengthType::Unknown:</span>
<span class="line-modified"> 38     case SVGLengthType::Number:</span>
















 39         return &quot;&quot;;
<a name="7" id="anc7"></a><span class="line-modified"> 40     case SVGLengthType::Percentage:</span>
 41         return &quot;%&quot;;
<a name="8" id="anc8"></a><span class="line-modified"> 42     case SVGLengthType::Ems:</span>
 43         return &quot;em&quot;;
<a name="9" id="anc9"></a><span class="line-modified"> 44     case SVGLengthType::Exs:</span>
 45         return &quot;ex&quot;;
<a name="10" id="anc10"></a><span class="line-modified"> 46     case SVGLengthType::Pixels:</span>
 47         return &quot;px&quot;;
<a name="11" id="anc11"></a><span class="line-modified"> 48     case SVGLengthType::Centimeters:</span>
 49         return &quot;cm&quot;;
<a name="12" id="anc12"></a><span class="line-modified"> 50     case SVGLengthType::Millimeters:</span>
 51         return &quot;mm&quot;;
<a name="13" id="anc13"></a><span class="line-modified"> 52     case SVGLengthType::Inches:</span>
 53         return &quot;in&quot;;
<a name="14" id="anc14"></a><span class="line-modified"> 54     case SVGLengthType::Points:</span>
 55         return &quot;pt&quot;;
<a name="15" id="anc15"></a><span class="line-modified"> 56     case SVGLengthType::Picas:</span>
 57         return &quot;pc&quot;;
 58     }
 59 
 60     ASSERT_NOT_REACHED();
 61     return &quot;&quot;;
 62 }
 63 
<a name="16" id="anc16"></a><span class="line-modified"> 64 static inline SVGLengthType parseLengthType(const UChar* ptr, const UChar* end)</span>
 65 {
 66     if (ptr == end)
<a name="17" id="anc17"></a><span class="line-modified"> 67         return SVGLengthType::Number;</span>
 68 
 69     const UChar firstChar = *ptr;
 70 
 71     if (++ptr == end)
<a name="18" id="anc18"></a><span class="line-modified"> 72         return firstChar == &#39;%&#39; ? SVGLengthType::Percentage : SVGLengthType::Unknown;</span>
 73 
 74     const UChar secondChar = *ptr;
 75 
 76     if (++ptr != end)
<a name="19" id="anc19"></a><span class="line-modified"> 77         return SVGLengthType::Unknown;</span>
 78 
 79     if (firstChar == &#39;e&#39; &amp;&amp; secondChar == &#39;m&#39;)
<a name="20" id="anc20"></a><span class="line-modified"> 80         return SVGLengthType::Ems;</span>
 81     if (firstChar == &#39;e&#39; &amp;&amp; secondChar == &#39;x&#39;)
<a name="21" id="anc21"></a><span class="line-modified"> 82         return SVGLengthType::Exs;</span>
 83     if (firstChar == &#39;p&#39; &amp;&amp; secondChar == &#39;x&#39;)
<a name="22" id="anc22"></a><span class="line-modified"> 84         return SVGLengthType::Pixels;</span>
 85     if (firstChar == &#39;c&#39; &amp;&amp; secondChar == &#39;m&#39;)
<a name="23" id="anc23"></a><span class="line-modified"> 86         return SVGLengthType::Centimeters;</span>
 87     if (firstChar == &#39;m&#39; &amp;&amp; secondChar == &#39;m&#39;)
<a name="24" id="anc24"></a><span class="line-modified"> 88         return SVGLengthType::Millimeters;</span>
 89     if (firstChar == &#39;i&#39; &amp;&amp; secondChar == &#39;n&#39;)
<a name="25" id="anc25"></a><span class="line-modified"> 90         return SVGLengthType::Inches;</span>
 91     if (firstChar == &#39;p&#39; &amp;&amp; secondChar == &#39;t&#39;)
<a name="26" id="anc26"></a><span class="line-modified"> 92         return SVGLengthType::Points;</span>
 93     if (firstChar == &#39;p&#39; &amp;&amp; secondChar == &#39;c&#39;)
<a name="27" id="anc27"></a><span class="line-modified"> 94         return SVGLengthType::Picas;</span>
 95 
<a name="28" id="anc28"></a><span class="line-modified"> 96     return SVGLengthType::Unknown;</span>
 97 }
 98 
<a name="29" id="anc29"></a><span class="line-modified"> 99 static inline SVGLengthType primitiveTypeToLengthType(CSSUnitType primitiveType)</span>

100 {
<a name="30" id="anc30"></a><span class="line-modified">101     switch (primitiveType) {</span>
<span class="line-added">102     case CSSUnitType::CSS_UNKNOWN:</span>
<span class="line-added">103         return SVGLengthType::Unknown;</span>
<span class="line-added">104     case CSSUnitType::CSS_NUMBER:</span>
<span class="line-added">105         return SVGLengthType::Number;</span>
<span class="line-added">106     case CSSUnitType::CSS_PERCENTAGE:</span>
<span class="line-added">107         return SVGLengthType::Percentage;</span>
<span class="line-added">108     case CSSUnitType::CSS_EMS:</span>
<span class="line-added">109         return SVGLengthType::Ems;</span>
<span class="line-added">110     case CSSUnitType::CSS_EXS:</span>
<span class="line-added">111         return SVGLengthType::Exs;</span>
<span class="line-added">112     case CSSUnitType::CSS_PX:</span>
<span class="line-added">113         return SVGLengthType::Pixels;</span>
<span class="line-added">114     case CSSUnitType::CSS_CM:</span>
<span class="line-added">115         return SVGLengthType::Centimeters;</span>
<span class="line-added">116     case CSSUnitType::CSS_MM:</span>
<span class="line-added">117         return SVGLengthType::Millimeters;</span>
<span class="line-added">118     case CSSUnitType::CSS_IN:</span>
<span class="line-added">119         return SVGLengthType::Inches;</span>
<span class="line-added">120     case CSSUnitType::CSS_PT:</span>
<span class="line-added">121         return SVGLengthType::Points;</span>
<span class="line-added">122     case CSSUnitType::CSS_PC:</span>
<span class="line-added">123         return SVGLengthType::Picas;</span>
<span class="line-added">124     default:</span>
<span class="line-added">125         return SVGLengthType::Unknown;</span>
<span class="line-added">126     }</span>
<span class="line-added">127 </span>
<span class="line-added">128     return SVGLengthType::Unknown;</span>
129 }
130 
<a name="31" id="anc31"></a><span class="line-modified">131 static inline CSSUnitType lengthTypeToPrimitiveType(SVGLengthType lengthType)</span>

132 {
<a name="32" id="anc32"></a><span class="line-modified">133     switch (lengthType) {</span>
<span class="line-added">134     case SVGLengthType::Unknown:</span>
<span class="line-added">135         return CSSUnitType::CSS_UNKNOWN;</span>
<span class="line-added">136     case SVGLengthType::Number:</span>
<span class="line-added">137         return CSSUnitType::CSS_NUMBER;</span>
<span class="line-added">138     case SVGLengthType::Percentage:</span>
<span class="line-added">139         return CSSUnitType::CSS_PERCENTAGE;</span>
<span class="line-added">140     case SVGLengthType::Ems:</span>
<span class="line-added">141         return CSSUnitType::CSS_EMS;</span>
<span class="line-added">142     case SVGLengthType::Exs:</span>
<span class="line-added">143         return CSSUnitType::CSS_EXS;</span>
<span class="line-added">144     case SVGLengthType::Pixels:</span>
<span class="line-added">145         return CSSUnitType::CSS_PX;</span>
<span class="line-added">146     case SVGLengthType::Centimeters:</span>
<span class="line-added">147         return CSSUnitType::CSS_CM;</span>
<span class="line-added">148     case SVGLengthType::Millimeters:</span>
<span class="line-added">149         return CSSUnitType::CSS_MM;</span>
<span class="line-added">150     case SVGLengthType::Inches:</span>
<span class="line-added">151         return CSSUnitType::CSS_IN;</span>
<span class="line-added">152     case SVGLengthType::Points:</span>
<span class="line-added">153         return CSSUnitType::CSS_PT;</span>
<span class="line-added">154     case SVGLengthType::Picas:</span>
<span class="line-added">155         return CSSUnitType::CSS_PC;</span>
<span class="line-added">156     }</span>
<span class="line-added">157 </span>
<span class="line-added">158     ASSERT_NOT_REACHED();</span>
<span class="line-added">159     return CSSUnitType::CSS_UNKNOWN;</span>
160 }
161 
<a name="33" id="anc33"></a><span class="line-modified">162 SVGLengthValue::SVGLengthValue(SVGLengthMode lengthMode, const String&amp; valueAsString)</span>
<span class="line-added">163     : m_lengthMode(lengthMode)</span>
164 {
<a name="34" id="anc34"></a><span class="line-modified">165     setValueAsString(valueAsString);</span>


166 }
167 
<a name="35" id="anc35"></a><span class="line-modified">168 SVGLengthValue::SVGLengthValue(float valueInSpecifiedUnits, SVGLengthType lengthType, SVGLengthMode lengthMode)</span>
<span class="line-added">169     : m_valueInSpecifiedUnits(valueInSpecifiedUnits)</span>
<span class="line-added">170     , m_lengthType(lengthType)</span>
<span class="line-added">171     , m_lengthMode(lengthMode)</span>
172 {
<a name="36" id="anc36"></a><span class="line-modified">173     ASSERT(m_lengthType != SVGLengthType::Unknown);</span>
174 }
175 
<a name="37" id="anc37"></a><span class="line-modified">176 SVGLengthValue::SVGLengthValue(const SVGLengthContext&amp; context, float value, SVGLengthType lengthType, SVGLengthMode lengthMode)</span>
<span class="line-added">177     : m_lengthType(lengthType)</span>
<span class="line-added">178     , m_lengthMode(lengthMode)</span>
179 {
<a name="38" id="anc38"></a><span class="line-modified">180     setValue(context, value);</span>
181 }
182 
<a name="39" id="anc39"></a><span class="line-modified">183 SVGLengthValue SVGLengthValue::construct(SVGLengthMode lengthMode, const String&amp; valueAsString, SVGParsingError&amp; parseError, SVGLengthNegativeValuesMode negativeValuesMode)</span>
184 {
<a name="40" id="anc40"></a><span class="line-modified">185     SVGLengthValue length(lengthMode);</span>
186 
187     if (length.setValueAsString(valueAsString).hasException())
188         parseError = ParsingAttributeFailedError;
<a name="41" id="anc41"></a><span class="line-modified">189     else if (negativeValuesMode == SVGLengthNegativeValuesMode::Forbid &amp;&amp; length.valueInSpecifiedUnits() &lt; 0)</span>
190         parseError = NegativeValueForbiddenError;
191 
192     return length;
193 }
194 
<a name="42" id="anc42"></a><span class="line-modified">195 SVGLengthValue SVGLengthValue::blend(const SVGLengthValue&amp; from, const SVGLengthValue&amp; to, float progress)</span>
<span class="line-added">196 {</span>
<span class="line-added">197     if ((from.isZero() &amp;&amp; to.isZero())</span>
<span class="line-added">198         || from.lengthType() == SVGLengthType::Unknown</span>
<span class="line-added">199         || to.lengthType() == SVGLengthType::Unknown</span>
<span class="line-added">200         || (!from.isZero() &amp;&amp; from.lengthType() != SVGLengthType::Percentage &amp;&amp; to.lengthType() == SVGLengthType::Percentage)</span>
<span class="line-added">201         || (!to.isZero() &amp;&amp; from.lengthType() == SVGLengthType::Percentage &amp;&amp; to.lengthType() != SVGLengthType::Percentage)</span>
<span class="line-added">202         || (!from.isZero() &amp;&amp; !to.isZero() &amp;&amp; (from.lengthType() == SVGLengthType::Ems || from.lengthType() == SVGLengthType::Exs) &amp;&amp; from.lengthType() != to.lengthType()))</span>
<span class="line-added">203         return to;</span>
<span class="line-added">204 </span>
<span class="line-added">205     if (from.lengthType() == SVGLengthType::Percentage || to.lengthType() == SVGLengthType::Percentage) {</span>
<span class="line-added">206         auto fromPercent = from.valueAsPercentage() * 100;</span>
<span class="line-added">207         auto toPercent = to.valueAsPercentage() * 100;</span>
<span class="line-added">208         return { WebCore::blend(fromPercent, toPercent, progress), SVGLengthType::Percentage };</span>
<span class="line-added">209     }</span>
<span class="line-added">210 </span>
<span class="line-added">211     if (from.lengthType() == to.lengthType() || from.isZero() || to.isZero() || from.isRelative()) {</span>
<span class="line-added">212         auto fromValue = from.valueInSpecifiedUnits();</span>
<span class="line-added">213         auto toValue = to.valueInSpecifiedUnits();</span>
<span class="line-added">214         return { WebCore::blend(fromValue, toValue, progress), to.isZero() ? from.lengthType() : to.lengthType() };</span>
<span class="line-added">215     }</span>
<span class="line-added">216 </span>
<span class="line-added">217     SVGLengthContext nonRelativeLengthContext(nullptr);</span>
<span class="line-added">218     auto fromValueInUserUnits = nonRelativeLengthContext.convertValueToUserUnits(from.valueInSpecifiedUnits(), from.lengthType(), from.lengthMode());</span>
<span class="line-added">219     if (fromValueInUserUnits.hasException())</span>
<span class="line-added">220         return { };</span>
<span class="line-added">221 </span>
<span class="line-added">222     auto fromValue = nonRelativeLengthContext.convertValueFromUserUnits(fromValueInUserUnits.releaseReturnValue(), to.lengthType(), to.lengthMode());</span>
<span class="line-added">223     if (fromValue.hasException())</span>
<span class="line-added">224         return { };</span>
<span class="line-added">225 </span>
<span class="line-added">226     float toValue = to.valueInSpecifiedUnits();</span>
<span class="line-added">227     return { WebCore::blend(fromValue.releaseReturnValue(), toValue, progress), to.lengthType() };</span>
<span class="line-added">228 }</span>
<span class="line-added">229 </span>
<span class="line-added">230 SVGLengthValue SVGLengthValue::fromCSSPrimitiveValue(const CSSPrimitiveValue&amp; value)</span>
231 {
<a name="43" id="anc43"></a><span class="line-modified">232     // FIXME: This needs to call value.computeLength() so it can correctly resolve non-absolute units (webkit.org/b/204826).</span>
<span class="line-added">233     SVGLengthType lengthType = primitiveTypeToLengthType(value.primitiveType());</span>
<span class="line-added">234     return lengthType == SVGLengthType::Unknown ? SVGLengthValue() : SVGLengthValue(value.floatValue(), lengthType);</span>
235 }
236 
<a name="44" id="anc44"></a><span class="line-modified">237 Ref&lt;CSSPrimitiveValue&gt; SVGLengthValue::toCSSPrimitiveValue(const SVGLengthValue&amp; length)</span>
238 {
<a name="45" id="anc45"></a><span class="line-modified">239     return CSSPrimitiveValue::create(length.valueInSpecifiedUnits(), lengthTypeToPrimitiveType(length.lengthType()));</span>
<span class="line-added">240 }</span>
<span class="line-added">241 </span>
<span class="line-added">242 ExceptionOr&lt;void&gt; SVGLengthValue::setValueAsString(const String&amp; valueAsString, SVGLengthMode lengthMode)</span>
<span class="line-added">243 {</span>
<span class="line-added">244     m_valueInSpecifiedUnits = 0;</span>
<span class="line-added">245     m_lengthMode = lengthMode;</span>
<span class="line-added">246     m_lengthType = SVGLengthType::Number;</span>
<span class="line-added">247     return setValueAsString(valueAsString);</span>
248 }
249 
250 float SVGLengthValue::value(const SVGLengthContext&amp; context) const
251 {
252     auto result = valueForBindings(context);
253     if (result.hasException())
254         return 0;
255     return result.releaseReturnValue();
256 }
257 
<a name="46" id="anc46"></a><span class="line-modified">258 String SVGLengthValue::valueAsString() const</span>
259 {
<a name="47" id="anc47"></a><span class="line-modified">260     return makeString(m_valueInSpecifiedUnits, lengthTypeToString(m_lengthType));</span>
261 }
262 
<a name="48" id="anc48"></a><span class="line-modified">263 ExceptionOr&lt;float&gt; SVGLengthValue::valueForBindings(const SVGLengthContext&amp; context) const</span>
264 {
<a name="49" id="anc49"></a><span class="line-modified">265     return context.convertValueToUserUnits(m_valueInSpecifiedUnits, m_lengthType, m_lengthMode);</span>


266 }
267 
<a name="50" id="anc50"></a><span class="line-modified">268 ExceptionOr&lt;void&gt; SVGLengthValue::setValue(const SVGLengthContext&amp; context, float value)</span>
269 {
270     // 100% = 100.0 instead of 1.0 for historical reasons, this could eventually be changed
<a name="51" id="anc51"></a><span class="line-modified">271     if (m_lengthType == SVGLengthType::Percentage)</span>
272         value = value / 100;
273 
<a name="52" id="anc52"></a><span class="line-modified">274     auto convertedValue = context.convertValueFromUserUnits(value, m_lengthType, m_lengthMode);</span>
275     if (convertedValue.hasException())
276         return convertedValue.releaseException();
277     m_valueInSpecifiedUnits = convertedValue.releaseReturnValue();
278     return { };
279 }
<a name="53" id="anc53"></a>




280 
<a name="54" id="anc54"></a><span class="line-modified">281 ExceptionOr&lt;void&gt; SVGLengthValue::setValue(const SVGLengthContext&amp; context, float value, SVGLengthType lengthType, SVGLengthMode lengthMode)</span>
<span class="line-added">282 {</span>
<span class="line-added">283     // FIXME: Seems like a bug that we change the value of m_unit even if setValue throws an exception.</span>
<span class="line-added">284     m_lengthMode = lengthMode;</span>
<span class="line-added">285     m_lengthType = lengthType;</span>
<span class="line-added">286     return setValue(context, value);</span>
287 }
288 
289 ExceptionOr&lt;void&gt; SVGLengthValue::setValueAsString(const String&amp; string)
290 {
291     if (string.isEmpty())
292         return { };
293 
294     float convertedNumber = 0;
295     auto upconvertedCharacters = StringView(string).upconvertedCharacters();
296     const UChar* ptr = upconvertedCharacters;
297     const UChar* end = ptr + string.length();
298 
299     if (!parseNumber(ptr, end, convertedNumber, false))
300         return Exception { SyntaxError };
301 
<a name="55" id="anc55"></a><span class="line-modified">302     auto lengthType = parseLengthType(ptr, end);</span>
<span class="line-modified">303     if (lengthType == SVGLengthType::Unknown)</span>
304         return Exception { SyntaxError };
305 
<a name="56" id="anc56"></a><span class="line-modified">306     m_lengthType = lengthType;</span>
307     m_valueInSpecifiedUnits = convertedNumber;
308     return { };
309 }
310 
<a name="57" id="anc57"></a><span class="line-modified">311 ExceptionOr&lt;void&gt; SVGLengthValue::convertToSpecifiedUnits(const SVGLengthContext&amp; context, SVGLengthType lengthType)</span>















312 {
<a name="58" id="anc58"></a>


313     auto valueInUserUnits = valueForBindings(context);
314     if (valueInUserUnits.hasException())
315         return valueInUserUnits.releaseException();
316 
<a name="59" id="anc59"></a><span class="line-modified">317     auto originalLengthType = m_lengthType;</span>
<span class="line-modified">318     m_lengthType = lengthType;</span>
<span class="line-modified">319     auto result = setValue(context, valueInUserUnits.releaseReturnValue());</span>
<span class="line-modified">320     if (!result.hasException())</span>











































321         return { };
<a name="60" id="anc60"></a>
322 
<a name="61" id="anc61"></a><span class="line-modified">323     m_lengthType = originalLengthType;</span>
<span class="line-modified">324     return result.releaseException();</span>




















































































325 }
326 
327 TextStream&amp; operator&lt;&lt;(TextStream&amp; ts, const SVGLengthValue&amp; length)
328 {
329     ts &lt;&lt; length.valueAsString();
330     return ts;
331 }
332 
333 }
<a name="62" id="anc62"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="62" type="hidden" />
</body>
</html>