<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/JavaScriptCore/heap/CompleteSubspace.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="CodeBlockSetInlines.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="CompleteSubspace.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/JavaScriptCore/heap/CompleteSubspace.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -30,10 +30,11 @@</span>
  #include &quot;AllocatorInlines.h&quot;
  #include &quot;BlockDirectoryInlines.h&quot;
  #include &quot;JSCInlines.h&quot;
  #include &quot;LocalAllocatorInlines.h&quot;
  #include &quot;MarkedBlockInlines.h&quot;
<span class="udiff-line-added">+ #include &quot;MarkedSpaceInlines.h&quot;</span>
  #include &quot;PreventCollectionScope.h&quot;
  #include &quot;SubspaceInlines.h&quot;
  
  namespace JSC {
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -77,12 +78,11 @@</span>
          return allocator;
  
      if (false)
          dataLog(&quot;Creating BlockDirectory/LocalAllocator for &quot;, m_name, &quot;, &quot;, attributes(), &quot;, &quot;, sizeClass, &quot;.\n&quot;);
  
<span class="udiff-line-modified-removed">-     std::unique_ptr&lt;BlockDirectory&gt; uniqueDirectory =</span>
<span class="udiff-line-removed">-         makeUnique&lt;BlockDirectory&gt;(m_space.heap(), sizeClass);</span>
<span class="udiff-line-modified-added">+     std::unique_ptr&lt;BlockDirectory&gt; uniqueDirectory = makeUnique&lt;BlockDirectory&gt;(sizeClass);</span>
      BlockDirectory* directory = uniqueDirectory.get();
      m_directories.append(WTFMove(uniqueDirectory));
  
      directory-&gt;setSubspace(this);
      m_space.addBlockDirectory(locker, directory);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -104,11 +104,11 @@</span>
          if (!index--)
              break;
      }
  
      directory-&gt;setNextDirectoryInSubspace(m_firstDirectory);
<span class="udiff-line-modified-removed">-     m_alignedMemoryAllocator-&gt;registerDirectory(directory);</span>
<span class="udiff-line-modified-added">+     m_alignedMemoryAllocator-&gt;registerDirectory(m_space.heap(), directory);</span>
      WTF::storeStoreFence();
      m_firstDirectory = directory;
      return allocator;
  }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -126,54 +126,56 @@</span>
          RELEASE_ASSERT(vm.heap.expectDoesGC());
  
      sanitizeStackForVM(vm);
  
      if (Allocator allocator = allocatorFor(size, AllocatorForMode::EnsureAllocator))
<span class="udiff-line-modified-removed">-         return allocator.allocate(deferralContext, AllocationFailureMode::ReturnNull);</span>
<span class="udiff-line-modified-added">+         return allocator.allocate(vm.heap, deferralContext, AllocationFailureMode::ReturnNull);</span>
  
<span class="udiff-line-modified-removed">-     if (size &lt;= Options::largeAllocationCutoff()</span>
<span class="udiff-line-modified-added">+     if (size &lt;= Options::preciseAllocationCutoff()</span>
          &amp;&amp; size &lt;= MarkedSpace::largeCutoff) {
          dataLog(&quot;FATAL: attampting to allocate small object using large allocation.\n&quot;);
          dataLog(&quot;Requested allocation size: &quot;, size, &quot;\n&quot;);
          RELEASE_ASSERT_NOT_REACHED();
      }
  
      vm.heap.collectIfNecessaryOrDefer(deferralContext);
  
      size = WTF::roundUpToMultipleOf&lt;MarkedSpace::sizeStep&gt;(size);
<span class="udiff-line-modified-removed">-     LargeAllocation* allocation = LargeAllocation::tryCreate(vm.heap, size, this, m_space.m_largeAllocations.size());</span>
<span class="udiff-line-modified-added">+     PreciseAllocation* allocation = PreciseAllocation::tryCreate(vm.heap, size, this, m_space.m_preciseAllocations.size());</span>
      if (!allocation)
          return nullptr;
  
<span class="udiff-line-modified-removed">-     m_space.m_largeAllocations.append(allocation);</span>
<span class="udiff-line-modified-removed">-     ASSERT(allocation-&gt;indexInSpace() == m_space.m_largeAllocations.size() - 1);</span>
<span class="udiff-line-modified-added">+     m_space.m_preciseAllocations.append(allocation);</span>
<span class="udiff-line-modified-added">+     if (auto* set = m_space.preciseAllocationSet())</span>
<span class="udiff-line-added">+         set-&gt;add(allocation-&gt;cell());</span>
<span class="udiff-line-added">+     ASSERT(allocation-&gt;indexInSpace() == m_space.m_preciseAllocations.size() - 1);</span>
      vm.heap.didAllocate(size);
      m_space.m_capacity += size;
  
<span class="udiff-line-modified-removed">-     m_largeAllocations.append(allocation);</span>
<span class="udiff-line-modified-added">+     m_preciseAllocations.append(allocation);</span>
  
      return allocation-&gt;cell();
  }
  
<span class="udiff-line-modified-removed">- void* CompleteSubspace::reallocateLargeAllocationNonVirtual(VM&amp; vm, HeapCell* oldCell, size_t size, GCDeferralContext* deferralContext, AllocationFailureMode failureMode)</span>
<span class="udiff-line-modified-added">+ void* CompleteSubspace::reallocatePreciseAllocationNonVirtual(VM&amp; vm, HeapCell* oldCell, size_t size, GCDeferralContext* deferralContext, AllocationFailureMode failureMode)</span>
  {
      if (validateDFGDoesGC)
          RELEASE_ASSERT(vm.heap.expectDoesGC());
  
      // The following conditions are met in Butterfly for example.
<span class="udiff-line-modified-removed">-     ASSERT(oldCell-&gt;isLargeAllocation());</span>
<span class="udiff-line-modified-added">+     ASSERT(oldCell-&gt;isPreciseAllocation());</span>
  
<span class="udiff-line-modified-removed">-     LargeAllocation* oldAllocation = &amp;oldCell-&gt;largeAllocation();</span>
<span class="udiff-line-modified-added">+     PreciseAllocation* oldAllocation = &amp;oldCell-&gt;preciseAllocation();</span>
      ASSERT(oldAllocation-&gt;cellSize() &lt;= size);
      ASSERT(oldAllocation-&gt;weakSet().isTriviallyDestructible());
      ASSERT(oldAllocation-&gt;attributes().destruction == DoesNotNeedDestruction);
      ASSERT(oldAllocation-&gt;attributes().cellKind == HeapCell::Auxiliary);
      ASSERT(size &gt; MarkedSpace::largeCutoff);
  
      sanitizeStackForVM(vm);
  
<span class="udiff-line-modified-removed">-     if (size &lt;= Options::largeAllocationCutoff()</span>
<span class="udiff-line-modified-added">+     if (size &lt;= Options::preciseAllocationCutoff()</span>
          &amp;&amp; size &lt;= MarkedSpace::largeCutoff) {
          dataLog(&quot;FATAL: attampting to allocate small object using large allocation.\n&quot;);
          dataLog(&quot;Requested allocation size: &quot;, size, &quot;\n&quot;);
          RELEASE_ASSERT_NOT_REACHED();
      }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -184,23 +186,31 @@</span>
      size_t difference = size - oldAllocation-&gt;cellSize();
      unsigned oldIndexInSpace = oldAllocation-&gt;indexInSpace();
      if (oldAllocation-&gt;isOnList())
          oldAllocation-&gt;remove();
  
<span class="udiff-line-modified-removed">-     LargeAllocation* allocation = oldAllocation-&gt;tryReallocate(size, this);</span>
<span class="udiff-line-modified-added">+     PreciseAllocation* allocation = oldAllocation-&gt;tryReallocate(size, this);</span>
      if (!allocation) {
          RELEASE_ASSERT(failureMode != AllocationFailureMode::Assert);
<span class="udiff-line-modified-removed">-         m_largeAllocations.append(oldAllocation);</span>
<span class="udiff-line-modified-added">+         m_preciseAllocations.append(oldAllocation);</span>
          return nullptr;
      }
      ASSERT(oldIndexInSpace == allocation-&gt;indexInSpace());
  
<span class="udiff-line-modified-removed">-     m_space.m_largeAllocations[oldIndexInSpace] = allocation;</span>
<span class="udiff-line-modified-added">+     // If reallocation changes the address, we should update HashSet.</span>
<span class="udiff-line-added">+     if (oldAllocation != allocation) {</span>
<span class="udiff-line-added">+         if (auto* set = m_space.preciseAllocationSet()) {</span>
<span class="udiff-line-added">+             set-&gt;remove(oldAllocation-&gt;cell());</span>
<span class="udiff-line-added">+             set-&gt;add(allocation-&gt;cell());</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     m_space.m_preciseAllocations[oldIndexInSpace] = allocation;</span>
      vm.heap.didAllocate(difference);
      m_space.m_capacity += difference;
  
<span class="udiff-line-modified-removed">-     m_largeAllocations.append(allocation);</span>
<span class="udiff-line-modified-added">+     m_preciseAllocations.append(allocation);</span>
  
      return allocation-&gt;cell();
  }
  
  } // namespace JSC
</pre>
<center><a href="CodeBlockSetInlines.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="CompleteSubspace.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>