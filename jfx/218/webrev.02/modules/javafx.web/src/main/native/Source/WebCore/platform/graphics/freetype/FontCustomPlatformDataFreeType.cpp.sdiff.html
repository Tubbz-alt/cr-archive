<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WebCore/platform/graphics/freetype/FontCustomPlatformDataFreeType.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="FontCacheFreeType.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="FontPlatformDataFreeType.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/platform/graphics/freetype/FontCustomPlatformDataFreeType.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 39 {
 40     static_cast&lt;SharedBuffer*&gt;(data)-&gt;deref();
 41 }
 42 
 43 static cairo_user_data_key_t freeTypeFaceKey;
 44 
 45 FontCustomPlatformData::FontCustomPlatformData(FT_Face freeTypeFace, SharedBuffer&amp; buffer)
 46     : m_fontFace(adoptRef(cairo_ft_font_face_create_for_ft_face(freeTypeFace, FT_LOAD_DEFAULT)))
 47 {
 48     buffer.ref(); // This is balanced by the buffer-&gt;deref() in releaseCustomFontData.
 49     static cairo_user_data_key_t bufferKey;
 50     cairo_font_face_set_user_data(m_fontFace.get(), &amp;bufferKey, &amp;buffer,
 51          static_cast&lt;cairo_destroy_func_t&gt;(releaseCustomFontData));
 52 
 53     // Cairo doesn&#39;t do FreeType reference counting, so we need to ensure that when
 54     // this cairo_font_face_t is destroyed, it cleans up the FreeType face as well.
 55     cairo_font_face_set_user_data(m_fontFace.get(), &amp;freeTypeFaceKey, freeTypeFace,
 56         reinterpret_cast&lt;cairo_destroy_func_t&gt;(reinterpret_cast&lt;void(*)(void)&gt;(FT_Done_Face)));
 57 }
 58 
<span class="line-modified"> 59 static FcPattern* defaultFontconfigOptions()</span>
 60 {
 61     // Get some generic default settings from fontconfig for web fonts. Strategy
 62     // from Behdad Esfahbod in https://code.google.com/p/chromium/issues/detail?id=173207#c35
 63     // For web fonts, the hint style is overridden in FontCustomPlatformData::FontCustomPlatformData
 64     // so Fontconfig will not affect the hint style, but it may disable hinting completely.
 65     static FcPattern* pattern = nullptr;
 66     static std::once_flag flag;
 67     std::call_once(flag, [](FcPattern*) {
 68         pattern = FcPatternCreate();
 69         FcConfigSubstitute(nullptr, pattern, FcMatchPattern);
 70         cairo_ft_font_options_substitute(getDefaultCairoFontOptions(), pattern);
 71         FcDefaultSubstitute(pattern);
 72         FcPatternDel(pattern, FC_FAMILY);
 73         FcConfigSubstitute(nullptr, pattern, FcMatchFont);
 74     }, pattern);
<span class="line-modified"> 75     return pattern;</span>
 76 }
 77 
<span class="line-modified"> 78 FontPlatformData FontCustomPlatformData::fontPlatformData(const FontDescription&amp; description, bool bold, bool italic, const FontFeatureSettings&amp;, const FontVariantSettings&amp;, FontSelectionSpecifiedCapabilities)</span>
 79 {
 80     auto* freeTypeFace = static_cast&lt;FT_Face&gt;(cairo_font_face_get_user_data(m_fontFace.get(), &amp;freeTypeFaceKey));
 81     ASSERT(freeTypeFace);
 82     RefPtr&lt;FcPattern&gt; pattern = defaultFontconfigOptions();

 83 #if ENABLE(VARIATION_FONTS)
 84     auto variants = buildVariationSettings(freeTypeFace, description);
 85     if (!variants.isEmpty()) {
<span class="line-removed"> 86         pattern = adoptRef(FcPatternDuplicate(pattern.get()));</span>
 87         FcPatternAddString(pattern.get(), FC_FONT_VARIATIONS, reinterpret_cast&lt;const FcChar8*&gt;(variants.utf8().data()));
 88     }
 89 #endif
<span class="line-modified"> 90     return FontPlatformData(m_fontFace.get(), pattern.get(), description.computedPixelSize(), freeTypeFace-&gt;face_flags &amp; FT_FACE_FLAG_FIXED_WIDTH, bold, italic, description.orientation());</span>
 91 }
 92 
 93 static bool initializeFreeTypeLibrary(FT_Library&amp; library)
 94 {
 95     // https://www.freetype.org/freetype2/docs/design/design-4.html
 96     // https://lists.nongnu.org/archive/html/freetype-devel/2004-10/msg00022.html
 97 
 98     FT_Memory memory = bitwise_cast&lt;FT_Memory&gt;(ft_smalloc(sizeof(*memory)));
 99     if (!memory)
100         return false;
101 
102     memory-&gt;user = nullptr;
103     memory-&gt;alloc = [](FT_Memory, long size) -&gt; void* {
104         return fastMalloc(size);
105     };
106     memory-&gt;free = [](FT_Memory, void* block) -&gt; void {
107         fastFree(block);
108     };
109     memory-&gt;realloc = [](FT_Memory, long, long newSize, void* block) -&gt; void* {
110         return fastRealloc(block, newSize);
</pre>
</td>
<td>
<hr />
<pre>
 39 {
 40     static_cast&lt;SharedBuffer*&gt;(data)-&gt;deref();
 41 }
 42 
 43 static cairo_user_data_key_t freeTypeFaceKey;
 44 
 45 FontCustomPlatformData::FontCustomPlatformData(FT_Face freeTypeFace, SharedBuffer&amp; buffer)
 46     : m_fontFace(adoptRef(cairo_ft_font_face_create_for_ft_face(freeTypeFace, FT_LOAD_DEFAULT)))
 47 {
 48     buffer.ref(); // This is balanced by the buffer-&gt;deref() in releaseCustomFontData.
 49     static cairo_user_data_key_t bufferKey;
 50     cairo_font_face_set_user_data(m_fontFace.get(), &amp;bufferKey, &amp;buffer,
 51          static_cast&lt;cairo_destroy_func_t&gt;(releaseCustomFontData));
 52 
 53     // Cairo doesn&#39;t do FreeType reference counting, so we need to ensure that when
 54     // this cairo_font_face_t is destroyed, it cleans up the FreeType face as well.
 55     cairo_font_face_set_user_data(m_fontFace.get(), &amp;freeTypeFaceKey, freeTypeFace,
 56         reinterpret_cast&lt;cairo_destroy_func_t&gt;(reinterpret_cast&lt;void(*)(void)&gt;(FT_Done_Face)));
 57 }
 58 
<span class="line-modified"> 59 static RefPtr&lt;FcPattern&gt; defaultFontconfigOptions()</span>
 60 {
 61     // Get some generic default settings from fontconfig for web fonts. Strategy
 62     // from Behdad Esfahbod in https://code.google.com/p/chromium/issues/detail?id=173207#c35
 63     // For web fonts, the hint style is overridden in FontCustomPlatformData::FontCustomPlatformData
 64     // so Fontconfig will not affect the hint style, but it may disable hinting completely.
 65     static FcPattern* pattern = nullptr;
 66     static std::once_flag flag;
 67     std::call_once(flag, [](FcPattern*) {
 68         pattern = FcPatternCreate();
 69         FcConfigSubstitute(nullptr, pattern, FcMatchPattern);
 70         cairo_ft_font_options_substitute(getDefaultCairoFontOptions(), pattern);
 71         FcDefaultSubstitute(pattern);
 72         FcPatternDel(pattern, FC_FAMILY);
 73         FcConfigSubstitute(nullptr, pattern, FcMatchFont);
 74     }, pattern);
<span class="line-modified"> 75     return adoptRef(FcPatternDuplicate(pattern));</span>
 76 }
 77 
<span class="line-modified"> 78 FontPlatformData FontCustomPlatformData::fontPlatformData(const FontDescription&amp; description, bool bold, bool italic, const FontFeatureSettings&amp;, FontSelectionSpecifiedCapabilities)</span>
 79 {
 80     auto* freeTypeFace = static_cast&lt;FT_Face&gt;(cairo_font_face_get_user_data(m_fontFace.get(), &amp;freeTypeFaceKey));
 81     ASSERT(freeTypeFace);
 82     RefPtr&lt;FcPattern&gt; pattern = defaultFontconfigOptions();
<span class="line-added"> 83     FcPatternAddString(pattern.get(), FC_FAMILY, reinterpret_cast&lt;const FcChar8*&gt;(freeTypeFace-&gt;family_name));</span>
 84 #if ENABLE(VARIATION_FONTS)
 85     auto variants = buildVariationSettings(freeTypeFace, description);
 86     if (!variants.isEmpty()) {

 87         FcPatternAddString(pattern.get(), FC_FONT_VARIATIONS, reinterpret_cast&lt;const FcChar8*&gt;(variants.utf8().data()));
 88     }
 89 #endif
<span class="line-modified"> 90     return FontPlatformData(m_fontFace.get(), WTFMove(pattern), description.computedPixelSize(), freeTypeFace-&gt;face_flags &amp; FT_FACE_FLAG_FIXED_WIDTH, bold, italic, description.orientation());</span>
 91 }
 92 
 93 static bool initializeFreeTypeLibrary(FT_Library&amp; library)
 94 {
 95     // https://www.freetype.org/freetype2/docs/design/design-4.html
 96     // https://lists.nongnu.org/archive/html/freetype-devel/2004-10/msg00022.html
 97 
 98     FT_Memory memory = bitwise_cast&lt;FT_Memory&gt;(ft_smalloc(sizeof(*memory)));
 99     if (!memory)
100         return false;
101 
102     memory-&gt;user = nullptr;
103     memory-&gt;alloc = [](FT_Memory, long size) -&gt; void* {
104         return fastMalloc(size);
105     };
106     memory-&gt;free = [](FT_Memory, void* block) -&gt; void {
107         fastFree(block);
108     };
109     memory-&gt;realloc = [](FT_Memory, long, long newSize, void* block) -&gt; void* {
110         return fastRealloc(block, newSize);
</pre>
</td>
</tr>
</table>
<center><a href="FontCacheFreeType.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="FontPlatformDataFreeType.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>