<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WTF/wtf/cf/LanguageCF.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../WordLock.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="RunLoopCF.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WTF/wtf/cf/LanguageCF.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 31 #include &lt;unicode/uloc.h&gt;
 32 #include &lt;wtf/Assertions.h&gt;
 33 #include &lt;wtf/Lock.h&gt;
 34 #include &lt;wtf/NeverDestroyed.h&gt;
 35 #include &lt;wtf/RetainPtr.h&gt;
 36 #include &lt;wtf/spi/cf/CFBundleSPI.h&gt;
 37 #include &lt;wtf/text/WTFString.h&gt;
 38 
 39 namespace WTF {
 40 
 41 static Lock preferredLanguagesMutex;
 42 
 43 static Vector&lt;String&gt;&amp; preferredLanguages()
 44 {
 45     static NeverDestroyed&lt;Vector&lt;String&gt;&gt; languages;
 46     return languages;
 47 }
 48 
 49 static String httpStyleLanguageCode(CFStringRef language)
 50 {
<span class="line-modified"> 51     SInt32 languageCode;</span>
<span class="line-modified"> 52     SInt32 regionCode;</span>
<span class="line-modified"> 53     SInt32 scriptCode;</span>
<span class="line-modified"> 54     CFStringEncoding stringEncoding;</span>
<span class="line-modified"> 55 </span>
<span class="line-modified"> 56     // FIXME: This transformation is very wrong:</span>
<span class="line-modified"> 57     // 1. There is no reason why CFBundle localization names would be at all related to language names as used on the Web.</span>
<span class="line-modified"> 58     // 2. Script Manager codes cannot represent all languages that are now supported by the platform, so the conversion is lossy.</span>
<span class="line-modified"> 59     // 3. This should probably match what is sent by the network layer as Accept-Language, but currently, that&#39;s implemented separately.</span>
<span class="line-modified"> 60     CFBundleGetLocalizationInfoForLocalization(language, &amp;languageCode, &amp;regionCode, &amp;scriptCode, &amp;stringEncoding);</span>
<span class="line-modified"> 61     RetainPtr&lt;CFStringRef&gt; preferredLanguageCode = adoptCF(CFBundleCopyLocalizationForLocalizationInfo(languageCode, regionCode, scriptCode, stringEncoding));</span>
<span class="line-modified"> 62     if (preferredLanguageCode)</span>
<span class="line-modified"> 63         language = preferredLanguageCode.get();</span>












 64 
 65     // Turn a &#39;_&#39; into a &#39;-&#39; if it appears after a 2-letter language code
<span class="line-modified"> 66     if (CFStringGetLength(language) &gt;= 3 &amp;&amp; CFStringGetCharacterAtIndex(language, 2) == &#39;_&#39;) {</span>
<span class="line-removed"> 67         auto mutableLanguageCode = adoptCF(CFStringCreateMutableCopy(kCFAllocatorDefault, 0, language));</span>
 68         CFStringReplace(mutableLanguageCode.get(), CFRangeMake(2, 1), CFSTR(&quot;-&quot;));
<span class="line-removed"> 69         return mutableLanguageCode.get();</span>
<span class="line-removed"> 70     }</span>
 71 
<span class="line-modified"> 72     return language;</span>


 73 }
 74 
 75 #if PLATFORM(MAC)
 76 static void languagePreferencesDidChange(CFNotificationCenterRef, void*, CFStringRef, const void*, CFDictionaryRef)
 77 {
 78     {
 79         std::lock_guard&lt;Lock&gt; lock(preferredLanguagesMutex);
 80         preferredLanguages().clear();
 81     }
 82 
 83     languageDidChange();
 84 }
 85 #endif
 86 
 87 Vector&lt;String&gt; platformUserPreferredLanguages()
 88 {
 89 #if PLATFORM(MAC)
 90     static dispatch_once_t onceToken;
 91     dispatch_once(&amp;onceToken, ^ {
 92         CFNotificationCenterAddObserver(CFNotificationCenterGetDistributedCenter(), nullptr, &amp;languagePreferencesDidChange, CFSTR(&quot;AppleLanguagePreferencesChangedNotification&quot;), nullptr, CFNotificationSuspensionBehaviorCoalesce);
 93     });
 94 #endif
 95 
 96     std::lock_guard&lt;Lock&gt; lock(preferredLanguagesMutex);
 97     Vector&lt;String&gt;&amp; userPreferredLanguages = preferredLanguages();
 98 
 99     if (userPreferredLanguages.isEmpty()) {
100         RetainPtr&lt;CFArrayRef&gt; languages = adoptCF(CFLocaleCopyPreferredLanguages());



101         CFIndex languageCount = CFArrayGetCount(languages.get());
102         if (!languageCount)
103             userPreferredLanguages.append(&quot;en&quot;);
104         else {
105             for (CFIndex i = 0; i &lt; languageCount; i++)
106                 userPreferredLanguages.append(httpStyleLanguageCode(static_cast&lt;CFStringRef&gt;(CFArrayGetValueAtIndex(languages.get(), i))));
107         }
108     }
109 
110     Vector&lt;String&gt; userPreferredLanguagesCopy;
111     userPreferredLanguagesCopy.reserveInitialCapacity(userPreferredLanguages.size());
112 
113     for (auto&amp; language : userPreferredLanguages)
114         userPreferredLanguagesCopy.uncheckedAppend(language.isolatedCopy());
115 
116     return userPreferredLanguagesCopy;
117 
118     return Vector&lt;String&gt;();
119 }
120 
</pre>
</td>
<td>
<hr />
<pre>
 31 #include &lt;unicode/uloc.h&gt;
 32 #include &lt;wtf/Assertions.h&gt;
 33 #include &lt;wtf/Lock.h&gt;
 34 #include &lt;wtf/NeverDestroyed.h&gt;
 35 #include &lt;wtf/RetainPtr.h&gt;
 36 #include &lt;wtf/spi/cf/CFBundleSPI.h&gt;
 37 #include &lt;wtf/text/WTFString.h&gt;
 38 
 39 namespace WTF {
 40 
 41 static Lock preferredLanguagesMutex;
 42 
 43 static Vector&lt;String&gt;&amp; preferredLanguages()
 44 {
 45     static NeverDestroyed&lt;Vector&lt;String&gt;&gt; languages;
 46     return languages;
 47 }
 48 
 49 static String httpStyleLanguageCode(CFStringRef language)
 50 {
<span class="line-modified"> 51     RetainPtr&lt;CFStringRef&gt; preferredLanguageCode;</span>
<span class="line-modified"> 52 #if !PLATFORM(JAVA)</span>
<span class="line-modified"> 53     // If we can minimize the language list to reduce fingerprinting, we can afford to be more lossless when canonicalizing the locale list.</span>
<span class="line-modified"> 54     if (canMinimizeLanguages())</span>
<span class="line-modified"> 55         preferredLanguageCode = adoptCF(CFLocaleCreateCanonicalLanguageIdentifierFromString(kCFAllocatorDefault, language));</span>
<span class="line-modified"> 56     else {</span>
<span class="line-modified"> 57 #endif</span>
<span class="line-modified"> 58         SInt32 languageCode;</span>
<span class="line-modified"> 59         SInt32 regionCode;</span>
<span class="line-modified"> 60         SInt32 scriptCode;</span>
<span class="line-modified"> 61         CFStringEncoding stringEncoding;</span>
<span class="line-modified"> 62 </span>
<span class="line-modified"> 63         // FIXME: This transformation is very wrong:</span>
<span class="line-added"> 64         // 1. There is no reason why CFBundle localization names would be at all related to language names as used on the Web.</span>
<span class="line-added"> 65         // 2. Script Manager codes cannot represent all languages that are now supported by the platform, so the conversion is lossy.</span>
<span class="line-added"> 66         // 3. This should probably match what is sent by the network layer as Accept-Language, but currently, that&#39;s implemented separately.</span>
<span class="line-added"> 67         CFBundleGetLocalizationInfoForLocalization(language, &amp;languageCode, &amp;regionCode, &amp;scriptCode, &amp;stringEncoding);</span>
<span class="line-added"> 68         preferredLanguageCode = adoptCF(CFBundleCopyLocalizationForLocalizationInfo(languageCode, regionCode, scriptCode, stringEncoding));</span>
<span class="line-added"> 69 #if !PLATFORM(JAVA)</span>
<span class="line-added"> 70     }</span>
<span class="line-added"> 71 #endif</span>
<span class="line-added"> 72 </span>
<span class="line-added"> 73     if (!preferredLanguageCode)</span>
<span class="line-added"> 74         preferredLanguageCode = language;</span>
<span class="line-added"> 75     auto mutableLanguageCode = adoptCF(CFStringCreateMutableCopy(kCFAllocatorDefault, 0, preferredLanguageCode.get()));</span>
 76 
 77     // Turn a &#39;_&#39; into a &#39;-&#39; if it appears after a 2-letter language code
<span class="line-modified"> 78     if (CFStringGetLength(mutableLanguageCode.get()) &gt;= 3 &amp;&amp; CFStringGetCharacterAtIndex(mutableLanguageCode.get(), 2) == &#39;_&#39;)</span>

 79         CFStringReplace(mutableLanguageCode.get(), CFRangeMake(2, 1), CFSTR(&quot;-&quot;));


 80 
<span class="line-modified"> 81     CFStringLowercase(mutableLanguageCode.get(), nullptr);</span>
<span class="line-added"> 82     return mutableLanguageCode.get();</span>
<span class="line-added"> 83 </span>
 84 }
 85 
 86 #if PLATFORM(MAC)
 87 static void languagePreferencesDidChange(CFNotificationCenterRef, void*, CFStringRef, const void*, CFDictionaryRef)
 88 {
 89     {
 90         std::lock_guard&lt;Lock&gt; lock(preferredLanguagesMutex);
 91         preferredLanguages().clear();
 92     }
 93 
 94     languageDidChange();
 95 }
 96 #endif
 97 
 98 Vector&lt;String&gt; platformUserPreferredLanguages()
 99 {
100 #if PLATFORM(MAC)
101     static dispatch_once_t onceToken;
102     dispatch_once(&amp;onceToken, ^ {
103         CFNotificationCenterAddObserver(CFNotificationCenterGetDistributedCenter(), nullptr, &amp;languagePreferencesDidChange, CFSTR(&quot;AppleLanguagePreferencesChangedNotification&quot;), nullptr, CFNotificationSuspensionBehaviorCoalesce);
104     });
105 #endif
106 
107     std::lock_guard&lt;Lock&gt; lock(preferredLanguagesMutex);
108     Vector&lt;String&gt;&amp; userPreferredLanguages = preferredLanguages();
109 
110     if (userPreferredLanguages.isEmpty()) {
111         RetainPtr&lt;CFArrayRef&gt; languages = adoptCF(CFLocaleCopyPreferredLanguages());
<span class="line-added">112 #if !PLATFORM(JAVA)</span>
<span class="line-added">113         languages = minimizedLanguagesFromLanguages(languages.get());</span>
<span class="line-added">114 #endif</span>
115         CFIndex languageCount = CFArrayGetCount(languages.get());
116         if (!languageCount)
117             userPreferredLanguages.append(&quot;en&quot;);
118         else {
119             for (CFIndex i = 0; i &lt; languageCount; i++)
120                 userPreferredLanguages.append(httpStyleLanguageCode(static_cast&lt;CFStringRef&gt;(CFArrayGetValueAtIndex(languages.get(), i))));
121         }
122     }
123 
124     Vector&lt;String&gt; userPreferredLanguagesCopy;
125     userPreferredLanguagesCopy.reserveInitialCapacity(userPreferredLanguages.size());
126 
127     for (auto&amp; language : userPreferredLanguages)
128         userPreferredLanguagesCopy.uncheckedAppend(language.isolatedCopy());
129 
130     return userPreferredLanguagesCopy;
131 
132     return Vector&lt;String&gt;();
133 }
134 
</pre>
</td>
</tr>
</table>
<center><a href="../WordLock.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="RunLoopCF.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>