<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/JavaScriptCore/runtime/JSFunction.h</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  *  Copyright (C) 1999-2000 Harri Porten (porten@kde.org)
  3  *  Copyright (C) 2003-2019 Apple Inc. All rights reserved.
  4  *  Copyright (C) 2007 Cameron Zwarich (cwzwarich@uwaterloo.ca)
  5  *  Copyright (C) 2007 Maks Orlovich
  6  *
  7  *  This library is free software; you can redistribute it and/or
  8  *  modify it under the terms of the GNU Library General Public
  9  *  License as published by the Free Software Foundation; either
 10  *  version 2 of the License, or (at your option) any later version.
 11  *
 12  *  This library is distributed in the hope that it will be useful,
 13  *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 14  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 15  *  Library General Public License for more details.
 16  *
 17  *  You should have received a copy of the GNU Library General Public License
 18  *  along with this library; see the file COPYING.LIB.  If not, write to
 19  *  the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
 20  *  Boston, MA 02110-1301, USA.
 21  *
 22  */
 23 
 24 #pragma once
 25 
 26 #include &quot;FunctionRareData.h&quot;
 27 #include &quot;InternalFunction.h&quot;
 28 #include &quot;JSCallee.h&quot;
 29 #include &quot;JSScope.h&quot;
 30 
 31 namespace JSC {
 32 
 33 class ExecutableBase;
 34 class FunctionExecutable;
 35 class FunctionPrototype;
 36 class JSLexicalEnvironment;
 37 class JSGlobalObject;
 38 class LLIntOffsetsExtractor;
 39 class NativeExecutable;
 40 class SourceCode;
 41 class InternalFunction;
 42 namespace DFG {
 43 class SpeculativeJIT;
 44 class JITCompiler;
 45 }
 46 
 47 namespace DOMJIT {
 48 class Signature;
 49 }
 50 
 51 
<a name="1" id="anc1"></a><span class="line-modified"> 52 JS_EXPORT_PRIVATE EncodedJSValue JSC_HOST_CALL callHostFunctionAsConstructor(JSGlobalObject*, CallFrame*);</span>
 53 
 54 JS_EXPORT_PRIVATE String getCalculatedDisplayName(VM&amp;, JSObject*);
 55 
 56 class JSFunction : public JSCallee {
 57     friend class JIT;
 58     friend class DFG::SpeculativeJIT;
 59     friend class DFG::JITCompiler;
 60     friend class VM;
 61     friend class InternalFunction;
 62 
 63 public:
<a name="2" id="anc2"></a><span class="line-added"> 64     static constexpr uintptr_t rareDataTag = 0x1;</span>
 65 
 66     template&lt;typename CellType, SubspaceAccess&gt;
 67     static IsoSubspace* subspaceFor(VM&amp; vm)
 68     {
 69         return &amp;vm.functionSpace;
 70     }
 71 
 72     typedef JSCallee Base;
<a name="3" id="anc3"></a><span class="line-modified"> 73     static constexpr unsigned StructureFlags = Base::StructureFlags | OverridesGetOwnPropertySlot | OverridesGetPropertyNames | OverridesGetCallData;</span>
 74 
 75     static size_t allocationSize(Checked&lt;size_t&gt; inlineCapacity)
 76     {
 77         ASSERT_UNUSED(inlineCapacity, !inlineCapacity);
 78         return sizeof(JSFunction);
 79     }
 80 
 81     static Structure* selectStructureForNewFuncExp(JSGlobalObject*, FunctionExecutable*);
 82 
 83     JS_EXPORT_PRIVATE static JSFunction* create(VM&amp;, JSGlobalObject*, int length, const String&amp; name, NativeFunction, Intrinsic = NoIntrinsic, NativeFunction nativeConstructor = callHostFunctionAsConstructor, const DOMJIT::Signature* = nullptr);
 84     JS_EXPORT_PRIVATE static JSFunction* createFunctionThatMasqueradesAsUndefined(VM&amp;, JSGlobalObject*, int length, const String&amp; name, NativeFunction, Intrinsic = NoIntrinsic, NativeFunction nativeConstructor = callHostFunctionAsConstructor, const DOMJIT::Signature* = nullptr);
 85 
 86     static JSFunction* createWithInvalidatedReallocationWatchpoint(VM&amp;, FunctionExecutable*, JSScope*);
 87 
 88     JS_EXPORT_PRIVATE static JSFunction* create(VM&amp;, FunctionExecutable*, JSScope*);
 89     static JSFunction* create(VM&amp;, FunctionExecutable*, JSScope*, Structure*);
 90 
 91     JS_EXPORT_PRIVATE String name(VM&amp;);
 92     JS_EXPORT_PRIVATE String displayName(VM&amp;);
 93     JS_EXPORT_PRIVATE const String calculatedDisplayName(VM&amp;);
 94 
<a name="4" id="anc4"></a><span class="line-modified"> 95     ExecutableBase* executable() const</span>
<span class="line-added"> 96     {</span>
<span class="line-added"> 97         uintptr_t executableOrRareData = m_executableOrRareData;</span>
<span class="line-added"> 98         if (executableOrRareData &amp; rareDataTag)</span>
<span class="line-added"> 99             return bitwise_cast&lt;FunctionRareData*&gt;(executableOrRareData &amp; ~rareDataTag)-&gt;executable();</span>
<span class="line-added">100         return bitwise_cast&lt;ExecutableBase*&gt;(executableOrRareData);</span>
<span class="line-added">101     }</span>
102 
103     // To call any of these methods include JSFunctionInlines.h
104     bool isHostFunction() const;
105     FunctionExecutable* jsExecutable() const;
106     Intrinsic intrinsic() const;
107 
108     JS_EXPORT_PRIVATE const SourceCode* sourceCode() const;
109 
110     DECLARE_EXPORT_INFO;
111 
112     static Structure* createStructure(VM&amp; vm, JSGlobalObject* globalObject, JSValue prototype)
113     {
114         ASSERT(globalObject);
115         return Structure::create(vm, globalObject, prototype, TypeInfo(JSFunctionType, StructureFlags), info());
116     }
117 
118     TaggedNativeFunction nativeFunction();
119     TaggedNativeFunction nativeConstructor();
120 
<a name="5" id="anc5"></a><span class="line-modified">121     JS_EXPORT_PRIVATE static ConstructType getConstructData(JSCell*, ConstructData&amp;);</span>
<span class="line-modified">122     JS_EXPORT_PRIVATE static CallType getCallData(JSCell*, CallData&amp;);</span>





123 
<a name="6" id="anc6"></a><span class="line-modified">124     static inline ptrdiff_t offsetOfExecutableOrRareData()</span>
125     {
<a name="7" id="anc7"></a><span class="line-modified">126         return OBJECT_OFFSETOF(JSFunction, m_executableOrRareData);</span>
127     }
128 
<a name="8" id="anc8"></a><span class="line-modified">129     FunctionRareData* ensureRareData(VM&amp; vm)</span>
130     {
<a name="9" id="anc9"></a><span class="line-modified">131         uintptr_t executableOrRareData = m_executableOrRareData;</span>
<span class="line-added">132         if (UNLIKELY(!(executableOrRareData &amp; rareDataTag)))</span>
133             return allocateRareData(vm);
<a name="10" id="anc10"></a><span class="line-modified">134         return bitwise_cast&lt;FunctionRareData*&gt;(executableOrRareData &amp; ~rareDataTag);</span>
135     }
136 
<a name="11" id="anc11"></a><span class="line-modified">137     FunctionRareData* ensureRareDataAndAllocationProfile(JSGlobalObject*, unsigned inlineCapacity);</span>
138 
<a name="12" id="anc12"></a><span class="line-modified">139     FunctionRareData* rareData() const</span>
140     {
<a name="13" id="anc13"></a><span class="line-modified">141         uintptr_t executableOrRareData = m_executableOrRareData;</span>
<span class="line-modified">142         if (executableOrRareData &amp; rareDataTag)</span>
<span class="line-modified">143             return bitwise_cast&lt;FunctionRareData*&gt;(executableOrRareData &amp; ~rareDataTag);</span>
<span class="line-modified">144         return nullptr;</span>



145     }
146 
147     bool isHostOrBuiltinFunction() const;
148     bool isBuiltinFunction() const;
<a name="14" id="anc14"></a>
149     JS_EXPORT_PRIVATE bool isHostFunctionNonInline() const;
150     bool isClassConstructorFunction() const;
151 
<a name="15" id="anc15"></a><span class="line-modified">152     void setFunctionName(JSGlobalObject*, JSValue name);</span>
153 
154     // Returns the __proto__ for the |this| value if this JSFunction were to be constructed.
<a name="16" id="anc16"></a><span class="line-modified">155     JSObject* prototypeForConstruction(VM&amp;, JSGlobalObject*);</span>
156 
157     bool canUseAllocationProfile();
158     bool canUseAllocationProfileNonInline();
159 
160     enum class PropertyStatus {
161         Eager,
162         Lazy,
163         Reified,
164     };
<a name="17" id="anc17"></a><span class="line-modified">165     PropertyStatus reifyLazyPropertyIfNeeded(VM&amp;, JSGlobalObject*, PropertyName);</span>
<span class="line-added">166 </span>
<span class="line-added">167     bool areNameAndLengthOriginal(VM&amp;);</span>
168 
169 protected:
<a name="18" id="anc18"></a><span class="line-modified">170     JS_EXPORT_PRIVATE JSFunction(VM&amp;, NativeExecutable*, JSGlobalObject*, Structure*);</span>
171     JSFunction(VM&amp;, FunctionExecutable*, JSScope*, Structure*);
172 
173     void finishCreation(VM&amp;, NativeExecutable*, int length, const String&amp; name);
174     void finishCreation(VM&amp;);
175 
<a name="19" id="anc19"></a><span class="line-modified">176     static bool getOwnPropertySlot(JSObject*, JSGlobalObject*, PropertyName, PropertySlot&amp;);</span>
<span class="line-modified">177     static void getOwnNonIndexPropertyNames(JSObject*, JSGlobalObject*, PropertyNameArray&amp;, EnumerationMode = EnumerationMode());</span>
<span class="line-modified">178     static bool defineOwnProperty(JSObject*, JSGlobalObject*, PropertyName, const PropertyDescriptor&amp;, bool shouldThrow);</span>
179 
<a name="20" id="anc20"></a><span class="line-modified">180     static bool put(JSCell*, JSGlobalObject*, PropertyName, JSValue, PutPropertySlot&amp;);</span>
181 
<a name="21" id="anc21"></a><span class="line-modified">182     static bool deleteProperty(JSCell*, JSGlobalObject*, PropertyName);</span>
183 
184     static void visitChildren(JSCell*, SlotVisitor&amp;);
185 
186 private:
187     static JSFunction* createImpl(VM&amp; vm, FunctionExecutable* executable, JSScope* scope, Structure* structure)
188     {
189         JSFunction* function = new (NotNull, allocateCell&lt;JSFunction&gt;(vm.heap)) JSFunction(vm, executable, scope, structure);
190         ASSERT(function-&gt;structure(vm)-&gt;globalObject());
191         function-&gt;finishCreation(vm);
192         return function;
193     }
194 
195     FunctionRareData* allocateRareData(VM&amp;);
<a name="22" id="anc22"></a><span class="line-modified">196     FunctionRareData* allocateAndInitializeRareData(JSGlobalObject*, size_t inlineCapacity);</span>
<span class="line-modified">197     FunctionRareData* initializeRareData(JSGlobalObject*, size_t inlineCapacity);</span>
198 
199     bool hasReifiedLength() const;
200     bool hasReifiedName() const;
201     void reifyLength(VM&amp;);
<a name="23" id="anc23"></a><span class="line-modified">202     void reifyName(VM&amp;, JSGlobalObject*);</span>
<span class="line-modified">203     void reifyName(VM&amp;, JSGlobalObject*, String name);</span>
204 
205     static bool isLazy(PropertyStatus property) { return property == PropertyStatus::Lazy || property == PropertyStatus::Reified; }
206     static bool isReified(PropertyStatus property) { return property == PropertyStatus::Reified; }
207 
<a name="24" id="anc24"></a><span class="line-modified">208     PropertyStatus reifyLazyPropertyForHostOrBuiltinIfNeeded(VM&amp;, JSGlobalObject*, PropertyName);</span>
<span class="line-modified">209     PropertyStatus reifyLazyLengthIfNeeded(VM&amp;, JSGlobalObject*, PropertyName);</span>
<span class="line-modified">210     PropertyStatus reifyLazyNameIfNeeded(VM&amp;, JSGlobalObject*, PropertyName);</span>
<span class="line-modified">211     PropertyStatus reifyLazyBoundNameIfNeeded(VM&amp;, JSGlobalObject*, PropertyName);</span>
212 
<a name="25" id="anc25"></a><span class="line-modified">213 #if ASSERT_ENABLED</span>


214     void assertTypeInfoFlagInvariants();
<a name="26" id="anc26"></a><span class="line-added">215 #else</span>
<span class="line-added">216     void assertTypeInfoFlagInvariants() { }</span>
217 #endif
218 
219     friend class LLIntOffsetsExtractor;
220 
<a name="27" id="anc27"></a><span class="line-modified">221     static EncodedJSValue argumentsGetter(JSGlobalObject*, EncodedJSValue, PropertyName);</span>
<span class="line-modified">222     static EncodedJSValue callerGetter(JSGlobalObject*, EncodedJSValue, PropertyName);</span>


223 
<a name="28" id="anc28"></a><span class="line-modified">224     uintptr_t m_executableOrRareData;</span>

225 };
226 
227 class JSStrictFunction final : public JSFunction {
228 public:
229     using Base = JSFunction;
230 
231     DECLARE_EXPORT_INFO;
232 
233     static constexpr unsigned StructureFlags = Base::StructureFlags;
234 
235     static Structure* createStructure(VM&amp; vm, JSGlobalObject* globalObject, JSValue prototype)
236     {
237         ASSERT(globalObject);
238         return Structure::create(vm, globalObject, prototype, TypeInfo(JSFunctionType, StructureFlags), info());
239     }
240 };
241 static_assert(sizeof(JSStrictFunction) == sizeof(JSFunction), &quot;Allocated in JSFunction IsoSubspace&quot;);
242 
243 class JSSloppyFunction final : public JSFunction {
244 public:
245     using Base = JSFunction;
246 
247     DECLARE_EXPORT_INFO;
248 
249     static constexpr unsigned StructureFlags = Base::StructureFlags;
250 
251     static Structure* createStructure(VM&amp; vm, JSGlobalObject* globalObject, JSValue prototype)
252     {
253         ASSERT(globalObject);
254         return Structure::create(vm, globalObject, prototype, TypeInfo(JSFunctionType, StructureFlags), info());
255     }
256 };
257 static_assert(sizeof(JSSloppyFunction) == sizeof(JSFunction), &quot;Allocated in JSFunction IsoSubspace&quot;);
258 
259 class JSArrowFunction final : public JSFunction {
260 public:
261     using Base = JSFunction;
262 
263     DECLARE_EXPORT_INFO;
264 
265     static constexpr unsigned StructureFlags = Base::StructureFlags;
266 
267     static Structure* createStructure(VM&amp; vm, JSGlobalObject* globalObject, JSValue prototype)
268     {
269         ASSERT(globalObject);
270         return Structure::create(vm, globalObject, prototype, TypeInfo(JSFunctionType, StructureFlags), info());
271     }
272 };
273 static_assert(sizeof(JSArrowFunction) == sizeof(JSFunction), &quot;Allocated in JSFunction IsoSubspace&quot;);
274 
275 } // namespace JSC
<a name="29" id="anc29"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="29" type="hidden" />
</body>
</html>