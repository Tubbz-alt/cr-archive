<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/WebCore/bridge/jni/jsc/JavaArrayJSC.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (C) 2003, 2004, 2005, 2007, 2009 Apple Inc. All rights reserved.
  3  * Copyright 2010, The Android Open Source Project
  4  *
  5  * Redistribution and use in source and binary forms, with or without
  6  * modification, are permitted provided that the following conditions
  7  * are met:
  8  * 1. Redistributions of source code must retain the above copyright
  9  *    notice, this list of conditions and the following disclaimer.
 10  * 2. Redistributions in binary form must reproduce the above copyright
 11  *    notice, this list of conditions and the following disclaimer in the
 12  *    documentation and/or other materials provided with the distribution.
 13  *
 14  * THIS SOFTWARE IS PROVIDED BY APPLE COMPUTER, INC. ``AS IS&#39;&#39; AND ANY
 15  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 16  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 17  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE COMPUTER, INC. OR
 18  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 19  * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 20  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 21  * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 22  * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 23  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 24  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 25  */
 26 
 27 #include &quot;config.h&quot;
 28 #include &quot;JavaArrayJSC.h&quot;
 29 
 30 #if ENABLE(JAVA_BRIDGE)
 31 
 32 #include &quot;JNIUtilityPrivate.h&quot;
 33 #include &quot;JavaInstanceJSC.h&quot;
 34 #include &quot;JobjectWrapper.h&quot;
 35 #include &quot;runtime_array.h&quot;
 36 #include &quot;runtime_object.h&quot;
 37 #include &quot;runtime_root.h&quot;
 38 #include &lt;JavaScriptCore/Error.h&gt;
 39 
 40 #include &quot;Logging.h&quot;
 41 
 42 using namespace JSC;
 43 using namespace JSC::Bindings;
 44 using namespace WebCore;
 45 
<a name="1" id="anc1"></a><span class="line-modified"> 46 JSValue JavaArray::convertJObjectToArray(JSGlobalObject* globalObject, jobject anObject, const char* type, RefPtr&lt;RootObject&gt;&amp;&amp; rootObject, jobject accessControlContext)</span>
 47 {
 48     if (type[0] != &#39;[&#39;)
 49         return jsUndefined();
 50 
<a name="2" id="anc2"></a><span class="line-modified"> 51     return RuntimeArray::create(globalObject, new JavaArray(anObject, type, WTFMove(rootObject), accessControlContext));</span>
 52 }
 53 
 54 JavaArray::JavaArray(jobject array, const char* type, RefPtr&lt;RootObject&gt;&amp;&amp; rootObject, jobject accessControlContext)
 55     : Array(WTFMove(rootObject))
 56 {
 57     m_array = JobjectWrapper::create(array);
 58 
 59     // Java array are fixed length, so we can cache length.
 60     JNIEnv* env = getJNIEnv();
 61 
 62     // Since m_array-&gt;instance() is WeakGlobalRef, creating a localref to safeguard instance() from GC
 63     JLObject jlarrayinstance(m_array-&gt;instance(), true);
 64 
 65     if (!jlarrayinstance) {
 66         LOG_ERROR(&quot;Could not get javaInstance for %p in JavaArray Constructor&quot;, (jobject)jlarrayinstance);
 67         m_length = 0;
 68     } else {
 69         m_length = env-&gt;GetArrayLength(static_cast&lt;jarray&gt;(m_array-&gt;instance()));
 70     }
 71 
 72     m_type = strdup(type);
 73     m_accessControlContext = JobjectWrapper::create(accessControlContext, true);
 74 }
 75 
 76 JavaArray::~JavaArray()
 77 {
 78     free(const_cast&lt;char*&gt;(m_type));
 79 }
 80 
 81 RootObject* JavaArray::rootObject() const
 82 {
 83     return m_rootObject &amp;&amp; m_rootObject-&gt;isValid() ? m_rootObject.get() : 0;
 84 }
 85 
<a name="3" id="anc3"></a><span class="line-modified"> 86 bool JavaArray::setValueAt(JSGlobalObject* globalObject, unsigned index, JSValue aValue) const</span>
 87 {
 88     // Since javaArray() is WeakGlobalRef, creating a localref to safeguard instance() from GC
 89     JLObject jlinstance(javaArray(), true);
 90 
 91     if (!jlinstance) {
 92         LOG_ERROR(&quot;Could not get javaInstance for %p in JavaArray::setValueAt&quot;, (jobject)jlinstance);
 93         return false;
 94     }
 95 
 96     JNIEnv* env = getJNIEnv();
 97     char* javaClassName = 0;
 98 
 99     JavaType arrayType = javaTypeFromPrimitiveType(m_type[1]);
100     if (m_type[1] == &#39;L&#39;) {
101         // The type of the array will be something like:
102         // &quot;[Ljava.lang.string;&quot;. This is guaranteed, so no need
103         // for extra sanity checks.
104         javaClassName = strdup(&amp;m_type[2]);
105         javaClassName[strchr(javaClassName, &#39;;&#39;)-javaClassName] = 0;
106     }
<a name="4" id="anc4"></a><span class="line-modified">107     jvalue aJValue = convertValueToJValue(globalObject, m_rootObject.get(), aValue, arrayType, javaClassName);</span>
108 
109     switch (arrayType) {
110     case JavaTypeObject:
111         {
112             env-&gt;SetObjectArrayElement(static_cast&lt;jobjectArray&gt;(javaArray()), index, aJValue.l);
113             break;
114         }
115 
116     case JavaTypeBoolean:
117         {
118             env-&gt;SetBooleanArrayRegion(static_cast&lt;jbooleanArray&gt;(javaArray()), index, 1, &amp;aJValue.z);
119             break;
120         }
121 
122     case JavaTypeByte:
123         {
124             env-&gt;SetByteArrayRegion(static_cast&lt;jbyteArray&gt;(javaArray()), index, 1, &amp;aJValue.b);
125             break;
126         }
127 
128     case JavaTypeChar:
129         {
130             env-&gt;SetCharArrayRegion(static_cast&lt;jcharArray&gt;(javaArray()), index, 1, &amp;aJValue.c);
131             break;
132         }
133 
134     case JavaTypeShort:
135         {
136             env-&gt;SetShortArrayRegion(static_cast&lt;jshortArray&gt;(javaArray()), index, 1, &amp;aJValue.s);
137             break;
138         }
139 
140     case JavaTypeInt:
141         {
142             env-&gt;SetIntArrayRegion(static_cast&lt;jintArray&gt;(javaArray()), index, 1, &amp;aJValue.i);
143             break;
144         }
145 
146     case JavaTypeLong:
147         {
148             env-&gt;SetLongArrayRegion(static_cast&lt;jlongArray&gt;(javaArray()), index, 1, &amp;aJValue.j);
149             break;
150         }
151 
152     case JavaTypeFloat:
153         {
154             env-&gt;SetFloatArrayRegion(static_cast&lt;jfloatArray&gt;(javaArray()), index, 1, &amp;aJValue.f);
155             break;
156         }
157 
158     case JavaTypeDouble:
159         {
160             env-&gt;SetDoubleArrayRegion(static_cast&lt;jdoubleArray&gt;(javaArray()), index, 1, &amp;aJValue.d);
161             break;
162         }
163     default:
164         break;
165     }
166 
167     if (javaClassName)
168         free(const_cast&lt;char*&gt;(javaClassName));
169     return true;
170 }
171 
<a name="5" id="anc5"></a><span class="line-modified">172 JSValue JavaArray::valueAt(JSGlobalObject* globalObject, unsigned index) const</span>
173 {
174     // Since javaArray() is WeakGlobalRef, creating a localref to safeguard instance() from GC
175     JLObject jlinstance(javaArray(), true);
176 
177     if (!jlinstance) {
178         LOG_ERROR(&quot;Could not get javaInstance for %p in JavaArray::valueAt&quot;, (jobject)jlinstance);
179         return jsUndefined();
180     }
181 
182     JNIEnv* env = getJNIEnv();
183     JavaType arrayType = javaTypeFromPrimitiveType(m_type[1]);
184     switch (arrayType) {
185     case JavaTypeObject:
186         {
187             jobjectArray objectArray = static_cast&lt;jobjectArray&gt;(javaArray());
188             jobject anObject;
189             anObject = env-&gt;GetObjectArrayElement(objectArray, index);
190 
191             // No object?
192             if (!anObject)
193                 return jsNull();
194 
195             // Nested array?
196             if (m_type[1] == &#39;[&#39;)
<a name="6" id="anc6"></a><span class="line-modified">197                 return JavaArray::convertJObjectToArray(globalObject, anObject,</span>
198                         m_type + 1, rootObject(), accessControlContext());
199             // or array of other object type?
200             return JavaInstance::create(anObject, rootObject(),
<a name="7" id="anc7"></a><span class="line-modified">201                     accessControlContext())-&gt;createRuntimeObject(globalObject);</span>
202         }
203 
204     case JavaTypeBoolean:
205         {
206             jbooleanArray booleanArray = static_cast&lt;jbooleanArray&gt;(javaArray());
207             jboolean aBoolean;
208             env-&gt;GetBooleanArrayRegion(booleanArray, index, 1, &amp;aBoolean);
209             return jsBoolean(aBoolean);
210         }
211 
212     case JavaTypeByte:
213         {
214             jbyteArray byteArray = static_cast&lt;jbyteArray&gt;(javaArray());
215             jbyte aByte;
216             env-&gt;GetByteArrayRegion(byteArray, index, 1, &amp;aByte);
217             return jsNumber(aByte);
218         }
219 
220     case JavaTypeChar:
221         {
222             jcharArray charArray = static_cast&lt;jcharArray&gt;(javaArray());
223             jchar aChar;
224             env-&gt;GetCharArrayRegion(charArray, index, 1, &amp;aChar);
225             return jsNumber(aChar);
226             break;
227         }
228 
229     case JavaTypeShort:
230         {
231             jshortArray shortArray = static_cast&lt;jshortArray&gt;(javaArray());
232             jshort aShort;
233             env-&gt;GetShortArrayRegion(shortArray, index, 1, &amp;aShort);
234             return jsNumber(aShort);
235         }
236 
237     case JavaTypeInt:
238         {
239             jintArray intArray = static_cast&lt;jintArray&gt;(javaArray());
240             jint anInt;
241             env-&gt;GetIntArrayRegion(intArray, index, 1, &amp;anInt);
242             return jsNumber(anInt);
243         }
244 
245     case JavaTypeLong:
246         {
247             jlongArray longArray = static_cast&lt;jlongArray&gt;(javaArray());
248             jlong aLong;
249             env-&gt;GetLongArrayRegion(longArray, index, 1, &amp;aLong);
250             return jsNumber(aLong);
251         }
252 
253     case JavaTypeFloat:
254         {
255             jfloatArray floatArray = static_cast&lt;jfloatArray&gt;(javaArray());
256             jfloat aFloat;
257             env-&gt;GetFloatArrayRegion(floatArray, index, 1, &amp;aFloat);
258             return jsNumber(aFloat);
259         }
260 
261     case JavaTypeDouble:
262         {
263             jdoubleArray doubleArray = static_cast&lt;jdoubleArray&gt;(javaArray());
264             jdouble aDouble;
265             env-&gt;GetDoubleArrayRegion(doubleArray, index, 1, &amp;aDouble);
266             return jsNumber(aDouble);
267         }
268     default:
269         break;
270     }
271     return jsUndefined();
272 }
273 
274 unsigned int JavaArray::getLength() const
275 {
276     return m_length;
277 }
278 
279 #endif // ENABLE(JAVA_BRIDGE)
<a name="8" id="anc8"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="8" type="hidden" />
</body>
</html>