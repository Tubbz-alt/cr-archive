<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/WebCore/page/Quirks.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (C) 2018-2019 Apple Inc. All rights reserved.
  3  *
  4  * Redistribution and use in source and binary forms, with or without
  5  * modification, are permitted provided that the following conditions
  6  * are met:
  7  * 1. Redistributions of source code must retain the above copyright
  8  *    notice, this list of conditions and the following disclaimer.
  9  * 2. Redistributions in binary form must reproduce the above copyright
 10  *    notice, this list of conditions and the following disclaimer in the
 11  *    documentation and/or other materials provided with the distribution.
 12  *
 13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. AND ITS CONTRIBUTORS ``AS IS&#39;&#39;
 14  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
 15  * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 16  * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL APPLE INC. OR ITS CONTRIBUTORS
 17  * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 18  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 19  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 20  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 21  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 22  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF
 23  * THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #include &quot;config.h&quot;
 27 #include &quot;Quirks.h&quot;
 28 
 29 #include &quot;CustomHeaderFields.h&quot;
 30 #include &quot;DOMTokenList.h&quot;
<a name="1" id="anc1"></a><span class="line-added"> 31 #include &quot;DOMWindow.h&quot;</span>
 32 #include &quot;Document.h&quot;
 33 #include &quot;DocumentLoader.h&quot;
<a name="2" id="anc2"></a><span class="line-added"> 34 #include &quot;EventNames.h&quot;</span>
 35 #include &quot;FrameLoader.h&quot;
<a name="3" id="anc3"></a><span class="line-added"> 36 #include &quot;HTMLBodyElement.h&quot;</span>
<span class="line-added"> 37 #include &quot;HTMLDivElement.h&quot;</span>
 38 #include &quot;HTMLMetaElement.h&quot;
 39 #include &quot;HTMLObjectElement.h&quot;
<a name="4" id="anc4"></a><span class="line-added"> 40 #include &quot;JSEventListener.h&quot;</span>
 41 #include &quot;LayoutUnit.h&quot;
 42 #include &quot;RuntimeEnabledFeatures.h&quot;
 43 #include &quot;Settings.h&quot;
 44 #include &quot;UserAgent.h&quot;
 45 
 46 namespace WebCore {
 47 
 48 static inline OptionSet&lt;AutoplayQuirk&gt; allowedAutoplayQuirks(Document&amp; document)
 49 {
 50     auto* loader = document.loader();
 51     if (!loader)
 52         return { };
 53 
 54     return loader-&gt;allowedAutoplayQuirks();
 55 }
 56 
 57 Quirks::Quirks(Document&amp; document)
 58     : m_document(makeWeakPtr(document))
 59 {
 60 }
 61 
 62 Quirks::~Quirks() = default;
 63 
 64 inline bool Quirks::needsQuirks() const
 65 {
 66     return m_document &amp;&amp; m_document-&gt;settings().needsSiteSpecificQuirks();
 67 }
 68 
 69 bool Quirks::shouldIgnoreInvalidSignal() const
 70 {
 71     return needsQuirks();
 72 }
 73 
 74 bool Quirks::needsFormControlToBeMouseFocusable() const
 75 {
 76 #if PLATFORM(MAC)
 77     if (!needsQuirks())
 78         return false;
 79 
 80     auto host = m_document-&gt;url().host();
 81     return equalLettersIgnoringASCIICase(host, &quot;ceac.state.gov&quot;) || host.endsWithIgnoringASCIICase(&quot;.ceac.state.gov&quot;);
 82 #else
 83     return false;
 84 #endif
 85 }
 86 
 87 bool Quirks::needsAutoplayPlayPauseEvents() const
 88 {
 89     if (!needsQuirks())
 90         return false;
 91 
 92     if (allowedAutoplayQuirks(*m_document).contains(AutoplayQuirk::SynthesizedPauseEvents))
 93         return true;
 94 
 95     return allowedAutoplayQuirks(m_document-&gt;topDocument()).contains(AutoplayQuirk::SynthesizedPauseEvents);
 96 }
 97 
 98 bool Quirks::needsSeekingSupportDisabled() const
 99 {
100     if (!needsQuirks())
101         return false;
102 
103     auto host = m_document-&gt;topDocument().url().host();
104     return equalLettersIgnoringASCIICase(host, &quot;netflix.com&quot;) || host.endsWithIgnoringASCIICase(&quot;.netflix.com&quot;);
105 }
106 
107 bool Quirks::needsPerDocumentAutoplayBehavior() const
108 {
109 #if PLATFORM(MAC)
110     ASSERT(m_document == &amp;m_document-&gt;topDocument());
111     return needsQuirks() &amp;&amp; allowedAutoplayQuirks(*m_document).contains(AutoplayQuirk::PerDocumentAutoplayBehavior);
112 #else
113     auto host = m_document-&gt;topDocument().url().host();
114     return equalLettersIgnoringASCIICase(host, &quot;netflix.com&quot;) || host.endsWithIgnoringASCIICase(&quot;.netflix.com&quot;);
115 #endif
116 }
117 
118 bool Quirks::shouldAutoplayForArbitraryUserGesture() const
119 {
120 #if PLATFORM(MAC)
121     return needsQuirks() &amp;&amp; allowedAutoplayQuirks(*m_document).contains(AutoplayQuirk::ArbitraryUserGestures);
122 #else
123     return false;
124 #endif
125 }
126 
127 bool Quirks::hasBrokenEncryptedMediaAPISupportQuirk() const
128 {
129     if (!needsQuirks())
130         return false;
131 
132     if (m_hasBrokenEncryptedMediaAPISupportQuirk)
133         return m_hasBrokenEncryptedMediaAPISupportQuirk.value();
134 
135     auto domain = m_document-&gt;securityOrigin().domain().convertToASCIILowercase();
136 
137     m_hasBrokenEncryptedMediaAPISupportQuirk = domain == &quot;starz.com&quot;
138         || domain.endsWith(&quot;.starz.com&quot;)
139         || domain == &quot;youtube.com&quot;
140         || domain.endsWith(&quot;.youtube.com&quot;)
141         || domain == &quot;hulu.com&quot;
142         || domain.endsWith(&quot;hulu.com&quot;);
143 
144     return m_hasBrokenEncryptedMediaAPISupportQuirk.value();
145 }
146 
147 bool Quirks::shouldDisableContentChangeObserverTouchEventAdjustment() const
148 {
149     if (!needsQuirks())
150         return false;
151 
152     auto&amp; topDocument = m_document-&gt;topDocument();
153     auto* topDocumentLoader = topDocument.loader();
154     if (!topDocumentLoader || !topDocumentLoader-&gt;allowContentChangeObserverQuirk())
155         return false;
156 
157     auto host = m_document-&gt;topDocument().url().host();
158     return host.endsWith(&quot;.youtube.com&quot;) || host == &quot;youtube.com&quot;;
159 }
160 
161 bool Quirks::shouldStripQuotationMarkInFontFaceSetFamily() const
162 {
163     if (!needsQuirks())
164         return false;
165 
166     auto host = m_document-&gt;topDocument().url().host();
167     return equalLettersIgnoringASCIICase(host, &quot;docs.google.com&quot;);
168 }
169 
170 bool Quirks::isTouchBarUpdateSupressedForHiddenContentEditable() const
171 {
172 #if PLATFORM(MAC)
173     if (!needsQuirks())
174         return false;
175 
176     auto host = m_document-&gt;topDocument().url().host();
177     return equalLettersIgnoringASCIICase(host, &quot;docs.google.com&quot;);
178 #else
179     return false;
180 #endif
181 }
182 
183 bool Quirks::isNeverRichlyEditableForTouchBar() const
184 {
185 #if PLATFORM(MAC)
186     if (!needsQuirks())
187         return false;
188 
189     auto&amp; url = m_document-&gt;topDocument().url();
190     auto host = url.host();
191 
192     if (equalLettersIgnoringASCIICase(host, &quot;twitter.com&quot;))
193         return true;
194 
195     if (equalLettersIgnoringASCIICase(host, &quot;onedrive.live.com&quot;))
196         return true;
197 
198     if (equalLettersIgnoringASCIICase(host, &quot;trix-editor.org&quot;))
199         return true;
200 
201     if (equalLettersIgnoringASCIICase(host, &quot;www.icloud.com&quot;)) {
202         auto path = url.path();
203         if (path.contains(&quot;notes&quot;) || url.fragmentIdentifier().contains(&quot;notes&quot;))
204             return true;
205     }
206 #endif
207 
208     return false;
209 }
210 
211 static bool shouldSuppressAutocorrectionAndAutocaptializationInHiddenEditableAreasForHost(const StringView&amp; host)
212 {
213 #if PLATFORM(IOS_FAMILY)
214     return equalLettersIgnoringASCIICase(host, &quot;docs.google.com&quot;);
215 #else
216     UNUSED_PARAM(host);
217     return false;
218 #endif
219 }
220 
221 bool Quirks::shouldDispatchSyntheticMouseEventsWhenModifyingSelection() const
222 {
223     if (m_document-&gt;settings().shouldDispatchSyntheticMouseEventsWhenModifyingSelection())
224         return true;
225 
226     if (!needsQuirks())
227         return false;
228 
229     auto host = m_document-&gt;topDocument().url().host();
230     if (equalLettersIgnoringASCIICase(host, &quot;medium.com&quot;) || host.endsWithIgnoringASCIICase(&quot;.medium.com&quot;))
231         return true;
232 
233     if (equalLettersIgnoringASCIICase(host, &quot;weebly.com&quot;) || host.endsWithIgnoringASCIICase(&quot;.weebly.com&quot;))
234         return true;
235 
236     return false;
237 }
238 
239 bool Quirks::needsYouTubeMouseOutQuirk() const
240 {
241 #if PLATFORM(IOS_FAMILY)
242     if (m_document-&gt;settings().shouldDispatchSyntheticMouseOutAfterSyntheticClick())
243         return true;
244 
245     if (!needsQuirks())
246         return false;
247 
248     return equalLettersIgnoringASCIICase(m_document-&gt;url().host(), &quot;www.youtube.com&quot;);
249 #else
250     return false;
251 #endif
252 }
253 
254 bool Quirks::shouldAvoidUsingIOS13ForGmail() const
255 {
256 #if PLATFORM(IOS_FAMILY)
257     if (!needsQuirks())
258         return false;
259 
260     auto&amp; url = m_document-&gt;topDocument().url();
261     return equalLettersIgnoringASCIICase(url.host(), &quot;mail.google.com&quot;);
262 #else
263     return false;
264 #endif
265 }
266 
267 bool Quirks::shouldSuppressAutocorrectionAndAutocaptializationInHiddenEditableAreas() const
268 {
269     if (!needsQuirks())
270         return false;
271 
272     return shouldSuppressAutocorrectionAndAutocaptializationInHiddenEditableAreasForHost(m_document-&gt;topDocument().url().host());
273 }
274 
275 #if ENABLE(TOUCH_EVENTS)
276 bool Quirks::isAmazon() const
277 {
278     return topPrivatelyControlledDomain(m_document-&gt;topDocument().url().host().toString()).startsWith(&quot;amazon.&quot;);
279 }
280 
281 bool Quirks::isGoogleMaps() const
282 {
283     auto&amp; url = m_document-&gt;topDocument().url();
284     return topPrivatelyControlledDomain(url.host().toString()).startsWith(&quot;google.&quot;) &amp;&amp; url.path().startsWithIgnoringASCIICase(&quot;/maps/&quot;);
285 }
286 
287 bool Quirks::shouldDispatchSimulatedMouseEvents() const
288 {
289     if (RuntimeEnabledFeatures::sharedFeatures().mouseEventsSimulationEnabled())
290         return true;
291 
292     if (!needsQuirks())
293         return false;
294 
<a name="5" id="anc5"></a><span class="line-modified">295     auto doShouldDispatchChecks = [this] () -&gt; bool {</span>
<span class="line-modified">296         auto* loader = m_document-&gt;loader();</span>
<span class="line-modified">297         if (!loader || loader-&gt;simulatedMouseEventsDispatchPolicy() != SimulatedMouseEventsDispatchPolicy::Allow)</span>
<span class="line-added">298             return false;</span>
299 
<a name="6" id="anc6"></a><span class="line-modified">300         if (isAmazon())</span>
<span class="line-modified">301             return true;</span>
<span class="line-modified">302         if (isGoogleMaps())</span>
<span class="line-modified">303             return true;</span>
304 
<a name="7" id="anc7"></a><span class="line-modified">305         auto&amp; url = m_document-&gt;topDocument().url();</span>
<span class="line-modified">306         auto host = url.host().convertToASCIILowercase();</span>
307 
<a name="8" id="anc8"></a><span class="line-modified">308         if (host == &quot;wix.com&quot; || host.endsWith(&quot;.wix.com&quot;)) {</span>
<span class="line-modified">309             // Disable simulated mouse dispatching for template selection.</span>
<span class="line-modified">310             return !url.path().startsWithIgnoringASCIICase(&quot;/website/templates/&quot;);</span>
<span class="line-modified">311         }</span>
<span class="line-modified">312 </span>
<span class="line-modified">313         if ((host == &quot;desmos.com&quot; || host.endsWith(&quot;.desmos.com&quot;)) &amp;&amp; url.path().startsWithIgnoringASCIICase(&quot;/calculator/&quot;))</span>
<span class="line-modified">314             return true;</span>
<span class="line-modified">315         if (host == &quot;figma.com&quot; || host.endsWith(&quot;.figma.com&quot;))</span>
<span class="line-modified">316             return true;</span>
<span class="line-modified">317         if (host == &quot;trello.com&quot; || host.endsWith(&quot;.trello.com&quot;))</span>
<span class="line-modified">318             return true;</span>
<span class="line-modified">319         if (host == &quot;airtable.com&quot; || host.endsWith(&quot;.airtable.com&quot;))</span>
<span class="line-modified">320             return true;</span>
<span class="line-modified">321         if (host == &quot;msn.com&quot; || host.endsWith(&quot;.msn.com&quot;))</span>
<span class="line-modified">322             return true;</span>
<span class="line-modified">323         if (host == &quot;flipkart.com&quot; || host.endsWith(&quot;.flipkart.com&quot;))</span>
<span class="line-modified">324             return true;</span>
<span class="line-modified">325         if (host == &quot;iqiyi.com&quot; || host.endsWith(&quot;.iqiyi.com&quot;))</span>
<span class="line-modified">326             return true;</span>
<span class="line-modified">327         if (host == &quot;trailers.apple.com&quot;)</span>
<span class="line-modified">328             return true;</span>
<span class="line-modified">329         if (host == &quot;soundcloud.com&quot;)</span>
<span class="line-modified">330             return true;</span>
<span class="line-modified">331         if (host == &quot;naver.com&quot;)</span>
<span class="line-modified">332             return true;</span>
<span class="line-modified">333         if (host == &quot;nhl.com&quot; || host.endsWith(&quot;.nhl.com&quot;))</span>
<span class="line-modified">334             return true;</span>
<span class="line-modified">335         if (host.endsWith(&quot;.naver.com&quot;)) {</span>
<span class="line-modified">336             // Disable the quirk for tv.naver.com subdomain to be able to simulate hover on videos.</span>
<span class="line-modified">337             if (host == &quot;tv.naver.com&quot;)</span>
<span class="line-modified">338                 return false;</span>
<span class="line-modified">339             // Disable the quirk for mail.naver.com subdomain to be able to tap on mail subjects.</span>
<span class="line-modified">340             if (host == &quot;mail.naver.com&quot;)</span>
<span class="line-modified">341                 return false;</span>
<span class="line-modified">342             // Disable the quirk on the mobile site.</span>
<span class="line-modified">343             // FIXME: Maybe this quirk should be disabled for &quot;m.&quot; subdomains on all sites? These are generally mobile sites that don&#39;t need mouse events.</span>
<span class="line-modified">344             if (host == &quot;m.naver.com&quot;)</span>
<span class="line-modified">345                 return false;</span>
<span class="line-added">346             return true;</span>
<span class="line-added">347         }</span>
<span class="line-added">348         return false;</span>
<span class="line-added">349     };</span>
<span class="line-added">350 </span>
<span class="line-added">351     if (!m_shouldDispatchSimulatedMouseEventsQuirk)</span>
<span class="line-added">352         m_shouldDispatchSimulatedMouseEventsQuirk = doShouldDispatchChecks();</span>
<span class="line-added">353     return *m_shouldDispatchSimulatedMouseEventsQuirk;</span>
354 }
355 
356 bool Quirks::shouldDispatchedSimulatedMouseEventsAssumeDefaultPrevented(EventTarget* target) const
357 {
358     if (!needsQuirks() || !shouldDispatchSimulatedMouseEvents())
359         return false;
360 
361     if (isAmazon() &amp;&amp; is&lt;Element&gt;(target)) {
362         // When panning on an Amazon product image, we&#39;re either touching on the #magnifierLens element
363         // or its previous sibling.
364         auto&amp; element = downcast&lt;Element&gt;(*target);
365         if (element.getIdAttribute() == &quot;magnifierLens&quot;)
366             return true;
367         if (auto* sibling = element.nextElementSibling())
368             return sibling-&gt;getIdAttribute() == &quot;magnifierLens&quot;;
369     }
370 
371     if (equalLettersIgnoringASCIICase(m_document-&gt;topDocument().url().host(), &quot;soundcloud.com&quot;) &amp;&amp; is&lt;Element&gt;(target))
372         return downcast&lt;Element&gt;(*target).classList().contains(&quot;sceneLayer&quot;);
373 
374     return false;
375 }
376 
377 Optional&lt;Event::IsCancelable&gt; Quirks::simulatedMouseEventTypeForTarget(EventTarget* target) const
378 {
379     if (!shouldDispatchSimulatedMouseEvents())
380         return { };
381 
382     // On Google Maps, we want to limit simulated mouse events to dragging the little man that allows entering into Street View.
383     if (isGoogleMaps()) {
384         if (is&lt;Element&gt;(target) &amp;&amp; downcast&lt;Element&gt;(target)-&gt;getAttribute(&quot;class&quot;) == &quot;widget-expand-button-pegman-icon&quot;)
385             return Event::IsCancelable::Yes;
386         return { };
387     }
388 
389     auto host = m_document-&gt;topDocument().url().host();
390     if (equalLettersIgnoringASCIICase(host, &quot;desmos.com&quot;) || host.endsWithIgnoringASCIICase(&quot;.desmos.com&quot;))
391         return Event::IsCancelable::No;
392 
<a name="9" id="anc9"></a><span class="line-added">393     if (equalLettersIgnoringASCIICase(host, &quot;airtable.com&quot;) || host.endsWithIgnoringASCIICase(&quot;.airtable.com&quot;)) {</span>
<span class="line-added">394         // We want to limit simulated mouse events to elements under &lt;div id=&quot;paneContainer&quot;&gt; to allow for column re-ordering and multiple cell selection.</span>
<span class="line-added">395         if (is&lt;Node&gt;(target)) {</span>
<span class="line-added">396             auto* node = downcast&lt;Node&gt;(target);</span>
<span class="line-added">397             if (auto* paneContainer = node-&gt;treeScope().getElementById(AtomString(&quot;paneContainer&quot;))) {</span>
<span class="line-added">398                 if (paneContainer-&gt;contains(node))</span>
<span class="line-added">399                     return Event::IsCancelable::Yes;</span>
<span class="line-added">400             }</span>
<span class="line-added">401         }</span>
<span class="line-added">402         return { };</span>
<span class="line-added">403     }</span>
<span class="line-added">404 </span>
405     return Event::IsCancelable::Yes;
406 }
407 
408 bool Quirks::shouldMakeTouchEventNonCancelableForTarget(EventTarget* target) const
409 {
410     if (!needsQuirks())
411         return false;
412 
413     auto host = m_document-&gt;topDocument().url().host();
414 
415     if (equalLettersIgnoringASCIICase(host, &quot;www.youtube.com&quot;)) {
416         if (is&lt;Element&gt;(target)) {
417             unsigned depth = 3;
418             for (auto* element = downcast&lt;Element&gt;(target); element &amp;&amp; depth; element = element-&gt;parentElement(), --depth) {
419                 if (element-&gt;localName() == &quot;paper-item&quot; &amp;&amp; element-&gt;classList().contains(&quot;yt-dropdown-menu&quot;))
420                     return true;
421             }
422         }
423     }
424 
425     return false;
426 }
427 #endif
428 
429 bool Quirks::shouldAvoidResizingWhenInputViewBoundsChange() const
430 {
431     if (!needsQuirks())
432         return false;
433 
434     auto host = m_document-&gt;topDocument().url().host();
435     if (equalLettersIgnoringASCIICase(host, &quot;live.com&quot;) || host.endsWithIgnoringASCIICase(&quot;.live.com&quot;))
436         return true;
437 
<a name="10" id="anc10"></a><span class="line-added">438     if (equalLettersIgnoringASCIICase(host, &quot;twitter.com&quot;) || host.endsWithIgnoringASCIICase(&quot;.twitter.com&quot;))</span>
<span class="line-added">439         return true;</span>
<span class="line-added">440 </span>
441     if (host.endsWithIgnoringASCIICase(&quot;.sharepoint.com&quot;))
442         return true;
443 
444     return false;
445 }
446 
447 bool Quirks::shouldDisablePointerEventsQuirk() const
448 {
449 #if PLATFORM(IOS_FAMILY)
450     if (!needsQuirks())
451         return false;
452 
453     auto&amp; url = m_document-&gt;topDocument().url();
454     auto host = url.host();
455     if (equalLettersIgnoringASCIICase(host, &quot;mailchimp.com&quot;) || host.endsWithIgnoringASCIICase(&quot;.mailchimp.com&quot;))
456         return true;
457 #endif
458     return false;
459 }
460 
461 bool Quirks::needsDeferKeyDownAndKeyPressTimersUntilNextEditingCommand() const
462 {
463 #if PLATFORM(IOS_FAMILY)
464     if (m_document-&gt;settings().needsDeferKeyDownAndKeyPressTimersUntilNextEditingCommandQuirk())
465         return true;
466 
467     if (!needsQuirks())
468         return false;
469 
470     auto&amp; url = m_document-&gt;topDocument().url();
471     return equalLettersIgnoringASCIICase(url.host(), &quot;docs.google.com&quot;) &amp;&amp; url.path().startsWithIgnoringASCIICase(&quot;/spreadsheets/&quot;);
472 #else
473     return false;
474 #endif
475 }
476 
<a name="11" id="anc11"></a>







































477 // FIXME(&lt;rdar://problem/50394969&gt;): Remove after desmos.com adopts inputmode=&quot;none&quot;.
478 bool Quirks::needsInputModeNoneImplicitly(const HTMLElement&amp; element) const
479 {
480 #if PLATFORM(IOS_FAMILY)
481     if (!needsQuirks())
482         return false;
483 
484     if (element.hasTagName(HTMLNames::inputTag)) {
485         if (!equalLettersIgnoringASCIICase(m_document-&gt;url().host(), &quot;calendar.google.com&quot;))
486             return false;
487         static NeverDestroyed&lt;QualifiedName&gt; dataInitialValueAttr(nullAtom(), &quot;data-initial-value&quot;, nullAtom());
488         static NeverDestroyed&lt;QualifiedName&gt; dataPreviousValueAttr(nullAtom(), &quot;data-previous-value&quot;, nullAtom());
489 
490         return equalLettersIgnoringASCIICase(element.attributeWithoutSynchronization(HTMLNames::autocompleteAttr), &quot;off&quot;)
491             &amp;&amp; element.hasAttributeWithoutSynchronization(dataInitialValueAttr)
492             &amp;&amp; element.hasAttributeWithoutSynchronization(dataPreviousValueAttr);
493     }
494 
495     if (!element.hasTagName(HTMLNames::textareaTag))
496         return false;
497 
498     auto&amp; url = m_document-&gt;url();
499     auto host = url.host();
500     if (!host.endsWithIgnoringASCIICase(&quot;.desmos.com&quot;))
501         return false;
502 
503     return element.parentElement() &amp;&amp; element.parentElement()-&gt;classNames().contains(&quot;dcg-mq-textarea&quot;);
504 #else
505     UNUSED_PARAM(element);
506     return false;
507 #endif
508 }
509 
510 // FIXME: Remove after the site is fixed, &lt;rdar://problem/50374200&gt;
511 bool Quirks::needsGMailOverflowScrollQuirk() const
512 {
513 #if PLATFORM(IOS_FAMILY)
514     if (!needsQuirks())
515         return false;
516 
517     if (!m_needsGMailOverflowScrollQuirk)
518         m_needsGMailOverflowScrollQuirk = equalLettersIgnoringASCIICase(m_document-&gt;url().host(), &quot;mail.google.com&quot;);
519 
520     return *m_needsGMailOverflowScrollQuirk;
521 #else
522     return false;
523 #endif
524 }
525 
526 // FIXME: Remove after the site is fixed, &lt;rdar://problem/50374311&gt;
527 bool Quirks::needsYouTubeOverflowScrollQuirk() const
528 {
529 #if PLATFORM(IOS_FAMILY)
530     if (!needsQuirks())
531         return false;
532 
533     if (!m_needsYouTubeOverflowScrollQuirk)
534         m_needsYouTubeOverflowScrollQuirk = equalLettersIgnoringASCIICase(m_document-&gt;url().host(), &quot;www.youtube.com&quot;);
535 
536     return *m_needsYouTubeOverflowScrollQuirk;
537 #else
538     return false;
539 #endif
540 }
541 
542 bool Quirks::shouldAvoidScrollingWhenFocusedContentIsVisible() const
543 {
544     if (!needsQuirks())
545         return false;
546 
547     return equalLettersIgnoringASCIICase(m_document-&gt;url().host(), &quot;www.zillow.com&quot;);
548 }
549 
<a name="12" id="anc12"></a><span class="line-added">550 bool Quirks::shouldUseLegacySelectPopoverDismissalBehaviorInDataActivation() const</span>
<span class="line-added">551 {</span>
<span class="line-added">552     if (!needsQuirks())</span>
<span class="line-added">553         return false;</span>
<span class="line-added">554 </span>
<span class="line-added">555     auto host = m_document-&gt;url().host();</span>
<span class="line-added">556     return equalLettersIgnoringASCIICase(host, &quot;att.com&quot;) || host.endsWithIgnoringASCIICase(&quot;.att.com&quot;);</span>
<span class="line-added">557 }</span>
<span class="line-added">558 </span>
<span class="line-added">559 bool Quirks::shouldIgnoreAriaForFastPathContentObservationCheck() const</span>
<span class="line-added">560 {</span>
<span class="line-added">561 #if PLATFORM(IOS_FAMILY)</span>
<span class="line-added">562     if (!needsQuirks())</span>
<span class="line-added">563         return false;</span>
<span class="line-added">564 </span>
<span class="line-added">565     auto host = m_document-&gt;url().host();</span>
<span class="line-added">566     return equalLettersIgnoringASCIICase(host, &quot;www.ralphlauren.com&quot;);</span>
<span class="line-added">567 #endif</span>
<span class="line-added">568     return false;</span>
<span class="line-added">569 }</span>
<span class="line-added">570 </span>
571 bool Quirks::shouldOpenAsAboutBlank(const String&amp; stringToOpen) const
572 {
573 #if PLATFORM(IOS_FAMILY)
574     if (!needsQuirks())
575         return false;
576 
577     auto openerURL = m_document-&gt;url();
578     if (!equalLettersIgnoringASCIICase(openerURL.host(), &quot;docs.google.com&quot;))
579         return false;
580 
<a name="13" id="anc13"></a><span class="line-modified">581     if (!m_document-&gt;frame() || !m_document-&gt;frame()-&gt;loader().userAgent(openerURL).contains(&quot;Macintosh&quot;))</span>
582         return false;
583 
584     URL urlToOpen { URL { }, stringToOpen };
585     if (!urlToOpen.protocolIsAbout())
586         return false;
587 
588     return !equalLettersIgnoringASCIICase(urlToOpen.host(), &quot;blank&quot;) &amp;&amp; !equalLettersIgnoringASCIICase(urlToOpen.host(), &quot;srcdoc&quot;);
589 #else
590     UNUSED_PARAM(stringToOpen);
591     return false;
592 #endif
593 }
594 
<a name="14" id="anc14"></a><span class="line-added">595 bool Quirks::needsPreloadAutoQuirk() const</span>
<span class="line-added">596 {</span>
<span class="line-added">597 #if PLATFORM(IOS_FAMILY)</span>
<span class="line-added">598     if (!needsQuirks())</span>
<span class="line-added">599         return false;</span>
<span class="line-added">600 </span>
<span class="line-added">601     if (m_needsPreloadAutoQuirk)</span>
<span class="line-added">602         return m_needsPreloadAutoQuirk.value();</span>
<span class="line-added">603 </span>
<span class="line-added">604     auto domain = m_document-&gt;securityOrigin().domain().convertToASCIILowercase();</span>
<span class="line-added">605 </span>
<span class="line-added">606     m_needsPreloadAutoQuirk = domain == &quot;vimeo.com&quot; || domain.endsWith(&quot;vimeo.com&quot;);</span>
<span class="line-added">607 </span>
<span class="line-added">608     return m_needsPreloadAutoQuirk.value();</span>
<span class="line-added">609 #else</span>
<span class="line-added">610     return false;</span>
<span class="line-added">611 #endif</span>
<span class="line-added">612 }</span>
<span class="line-added">613 </span>
<span class="line-added">614 bool Quirks::shouldBypassBackForwardCache() const</span>
<span class="line-added">615 {</span>
<span class="line-added">616     if (!needsQuirks())</span>
<span class="line-added">617         return false;</span>
<span class="line-added">618 </span>
<span class="line-added">619     auto topURL = m_document-&gt;topDocument().url();</span>
<span class="line-added">620     auto host = topURL.host();</span>
<span class="line-added">621 </span>
<span class="line-added">622     // Vimeo.com used to bypass the back/forward cache by serving &quot;Cache-Control: no-store&quot; over HTTPS.</span>
<span class="line-added">623     // We started caching such content in r250437 but the vimeo.com content unfortunately is not currently compatible</span>
<span class="line-added">624     // because it changes the opacity of its body to 0 when navigating away and fails to restore the original opacity</span>
<span class="line-added">625     // when coming back from the back/forward cache (e.g. in &#39;pageshow&#39; event handler). See &lt;rdar://problem/56996057&gt;.</span>
<span class="line-added">626     if (topURL.protocolIs(&quot;https&quot;) &amp;&amp; equalLettersIgnoringASCIICase(host, &quot;vimeo.com&quot;)) {</span>
<span class="line-added">627         if (auto* documentLoader = m_document-&gt;frame() ? m_document-&gt;frame()-&gt;loader().documentLoader() : nullptr)</span>
<span class="line-added">628             return documentLoader-&gt;response().cacheControlContainsNoStore();</span>
<span class="line-added">629     }</span>
<span class="line-added">630 </span>
<span class="line-added">631     // Google Docs used to bypass the back/forward cache by serving &quot;Cache-Control: no-store&quot; over HTTPS.</span>
<span class="line-added">632     // We started caching such content in r250437 but the Google Docs index page unfortunately is not currently compatible</span>
<span class="line-added">633     // because it puts an overlay (with class &quot;docs-homescreen-freeze-el-full&quot;) over the page when navigating away and fails</span>
<span class="line-added">634     // to remove it when coming back from the back/forward cache (e.g. in &#39;pageshow&#39; event handler). See &lt;rdar://problem/57670064&gt;.</span>
<span class="line-added">635     // Note that this does not check for docs.google.com host because of hosted G Suite apps.</span>
<span class="line-added">636     static NeverDestroyed&lt;const AtomString&gt; googleDocsOverlayDivClass(&quot;docs-homescreen-freeze-el-full&quot;, AtomString::ConstructFromLiteral);</span>
<span class="line-added">637     auto* firstChildInBody = m_document-&gt;body() ? m_document-&gt;body()-&gt;firstChild() : nullptr;</span>
<span class="line-added">638     if (is&lt;HTMLDivElement&gt;(firstChildInBody)) {</span>
<span class="line-added">639         auto&amp; div = downcast&lt;HTMLDivElement&gt;(*firstChildInBody);</span>
<span class="line-added">640         if (div.hasClass() &amp;&amp; div.classNames().contains(googleDocsOverlayDivClass))</span>
<span class="line-added">641             return true;</span>
<span class="line-added">642     }</span>
<span class="line-added">643 </span>
<span class="line-added">644     return false;</span>
<span class="line-added">645 }</span>
<span class="line-added">646 </span>
<span class="line-added">647 bool Quirks::shouldMakeEventListenerPassive(const EventTarget&amp; eventTarget, const AtomString&amp; eventType, const EventListener&amp; eventListener)</span>
<span class="line-added">648 {</span>
<span class="line-added">649     if (eventNames().isTouchScrollBlockingEventType(eventType)) {</span>
<span class="line-added">650         if (is&lt;DOMWindow&gt;(eventTarget)) {</span>
<span class="line-added">651             auto&amp; window = downcast&lt;DOMWindow&gt;(eventTarget);</span>
<span class="line-added">652             if (auto* document = window.document())</span>
<span class="line-added">653                 return document-&gt;settings().passiveTouchListenersAsDefaultOnDocument();</span>
<span class="line-added">654         } else if (is&lt;Node&gt;(eventTarget)) {</span>
<span class="line-added">655             auto&amp; node = downcast&lt;Node&gt;(eventTarget);</span>
<span class="line-added">656             if (is&lt;Document&gt;(node) || node.document().documentElement() == &amp;node || node.document().body() == &amp;node)</span>
<span class="line-added">657                 return node.document().settings().passiveTouchListenersAsDefaultOnDocument();</span>
<span class="line-added">658         }</span>
<span class="line-added">659         return false;</span>
<span class="line-added">660     }</span>
<span class="line-added">661 </span>
<span class="line-added">662     if (eventType == eventNames().mousewheelEvent) {</span>
<span class="line-added">663         if (!is&lt;JSEventListener&gt;(eventListener))</span>
<span class="line-added">664             return false;</span>
<span class="line-added">665 </span>
<span class="line-added">666         // For SmoothScroll.js</span>
<span class="line-added">667         // Matches Blink intervention in https://chromium.googlesource.com/chromium/src/+/b6b13c9cfe64d52a4168d9d8d1ad9bb8f0b46a2a%5E%21/</span>
<span class="line-added">668         if (is&lt;DOMWindow&gt;(eventTarget)) {</span>
<span class="line-added">669             auto* document = downcast&lt;DOMWindow&gt;(eventTarget).document();</span>
<span class="line-added">670             if (!document || !document-&gt;quirks().needsQuirks())</span>
<span class="line-added">671                 return false;</span>
<span class="line-added">672 </span>
<span class="line-added">673             auto&amp; jsEventListener = downcast&lt;JSEventListener&gt;(eventListener);</span>
<span class="line-added">674             if (jsEventListener.functionName() == &quot;ssc_wheel&quot;)</span>
<span class="line-added">675                 return true;</span>
<span class="line-added">676         }</span>
<span class="line-added">677 </span>
<span class="line-added">678         return false;</span>
<span class="line-added">679     }</span>
<span class="line-added">680 </span>
<span class="line-added">681     return false;</span>
<span class="line-added">682 }</span>
<span class="line-added">683 </span>
<span class="line-added">684 #if ENABLE(MEDIA_STREAM)</span>
<span class="line-added">685 bool Quirks::shouldEnableLegacyGetUserMedia() const</span>
<span class="line-added">686 {</span>
<span class="line-added">687     if (!needsQuirks())</span>
<span class="line-added">688         return false;</span>
<span class="line-added">689 </span>
<span class="line-added">690     return m_document-&gt;url().protocolIs(&quot;https&quot;) &amp;&amp; equalLettersIgnoringASCIICase(m_document-&gt; url().host(), &quot;www.baidu.com&quot;);</span>
<span class="line-added">691 }</span>
<span class="line-added">692 #endif</span>
<span class="line-added">693 </span>
<span class="line-added">694 bool Quirks::shouldDisableElementFullscreenQuirk() const</span>
<span class="line-added">695 {</span>
<span class="line-added">696 #if PLATFORM(IOS_FAMILY)</span>
<span class="line-added">697     if (!needsQuirks())</span>
<span class="line-added">698         return false;</span>
<span class="line-added">699 </span>
<span class="line-added">700     if (m_shouldDisableElementFullscreenQuirk)</span>
<span class="line-added">701         return m_shouldDisableElementFullscreenQuirk.value();</span>
<span class="line-added">702 </span>
<span class="line-added">703     auto domain = m_document-&gt;securityOrigin().domain().convertToASCIILowercase();</span>
<span class="line-added">704 </span>
<span class="line-added">705     m_shouldDisableElementFullscreenQuirk = domain == &quot;nfl.com&quot; || domain.endsWith(&quot;.nfl.com&quot;);</span>
<span class="line-added">706 </span>
<span class="line-added">707     return m_shouldDisableElementFullscreenQuirk.value();</span>
<span class="line-added">708 #else</span>
<span class="line-added">709     return false;</span>
<span class="line-added">710 #endif</span>
<span class="line-added">711 }</span>
<span class="line-added">712 </span>
713 }
<a name="15" id="anc15"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="15" type="hidden" />
</body>
</html>