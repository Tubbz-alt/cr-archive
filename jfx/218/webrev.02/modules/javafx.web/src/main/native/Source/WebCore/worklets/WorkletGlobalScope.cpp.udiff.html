<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WebCore/worklets/WorkletGlobalScope.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="WorkletConsoleClient.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="WorkletGlobalScope.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/worklets/WorkletGlobalScope.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -33,10 +33,11 @@</span>
  #include &quot;InspectorInstrumentation.h&quot;
  #include &quot;JSWorkletGlobalScope.h&quot;
  #include &quot;PageConsoleClient.h&quot;
  #include &quot;SecurityOriginPolicy.h&quot;
  #include &quot;Settings.h&quot;
<span class="udiff-line-added">+ #include &quot;WorkerEventLoop.h&quot;</span>
  #include &quot;WorkletScriptController.h&quot;
  #include &lt;JavaScriptCore/Exception.h&gt;
  #include &lt;JavaScriptCore/JSLock.h&gt;
  #include &lt;JavaScriptCore/ScriptCallStack.h&gt;
  #include &lt;wtf/IsoMallocInlines.h&gt;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -46,14 +47,12 @@</span>
  
  WTF_MAKE_ISO_ALLOCATED_IMPL(WorkletGlobalScope);
  
  WorkletGlobalScope::WorkletGlobalScope(Document&amp; document, ScriptSourceCode&amp;&amp; code)
      : m_document(makeWeakPtr(document))
<span class="udiff-line-removed">-     , m_sessionID(m_document-&gt;sessionID())</span>
      , m_script(makeUnique&lt;WorkletScriptController&gt;(this))
      , m_topOrigin(SecurityOrigin::createUnique())
<span class="udiff-line-removed">-     , m_eventQueue(*this)</span>
      , m_code(WTFMove(code))
  {
      auto addResult = allWorkletGlobalScopesSet().add(this);
      ASSERT_UNUSED(addResult, addResult);
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -75,26 +74,36 @@</span>
  
  void WorkletGlobalScope::prepareForDestruction()
  {
      if (!m_script)
          return;
<span class="udiff-line-added">+     if (m_defaultTaskGroup)</span>
<span class="udiff-line-added">+         m_defaultTaskGroup-&gt;stopAndDiscardAllTasks();</span>
      stopActiveDOMObjects();
<span class="udiff-line-removed">-     removeRejectedPromiseTracker();</span>
      removeAllEventListeners();
<span class="udiff-line-added">+     if (m_eventLoop)</span>
<span class="udiff-line-added">+         m_eventLoop-&gt;clearMicrotaskQueue();</span>
<span class="udiff-line-added">+     removeRejectedPromiseTracker();</span>
      m_script-&gt;vm().notifyNeedTermination();
      m_script = nullptr;
  }
  
  auto WorkletGlobalScope::allWorkletGlobalScopesSet() -&gt; WorkletGlobalScopesSet&amp;
  {
      static NeverDestroyed&lt;WorkletGlobalScopesSet&gt; scopes;
      return scopes;
  }
  
<span class="udiff-line-modified-removed">- String WorkletGlobalScope::origin() const</span>
<span class="udiff-line-modified-added">+ EventLoopTaskGroup&amp; WorkletGlobalScope::eventLoop()</span>
  {
<span class="udiff-line-modified-removed">-     return m_topOrigin-&gt;toString();</span>
<span class="udiff-line-modified-added">+     if (UNLIKELY(!m_defaultTaskGroup)) {</span>
<span class="udiff-line-added">+         m_eventLoop = WorkerEventLoop::create(*this);</span>
<span class="udiff-line-added">+         m_defaultTaskGroup = makeUnique&lt;EventLoopTaskGroup&gt;(*m_eventLoop);</span>
<span class="udiff-line-added">+         if (activeDOMObjectsAreStopped())</span>
<span class="udiff-line-added">+             m_defaultTaskGroup-&gt;stopAndDiscardAllTasks();</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+     return *m_defaultTaskGroup;</span>
  }
  
  String WorkletGlobalScope::userAgent(const URL&amp; url) const
  {
      if (!m_document)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -120,11 +129,11 @@</span>
  void WorkletGlobalScope::disableWebAssembly(const String&amp; errorMessage)
  {
      m_script-&gt;disableWebAssembly(errorMessage);
  }
  
<span class="udiff-line-modified-removed">- URL WorkletGlobalScope::completeURL(const String&amp; url) const</span>
<span class="udiff-line-modified-added">+ URL WorkletGlobalScope::completeURL(const String&amp; url, ForceUTF8) const</span>
  {
      if (url.isNull())
          return URL();
      return URL(m_code.url(), url);
  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -148,14 +157,19 @@</span>
      if (!m_document || isJSExecutionForbidden())
          return;
      m_document-&gt;addConsoleMessage(source, level, message, requestIdentifier);
  }
  
<span class="udiff-line-modified-removed">- void WorkletGlobalScope::addMessage(MessageSource source, MessageLevel level, const String&amp; messageText, const String&amp; sourceURL, unsigned lineNumber, unsigned columnNumber, RefPtr&lt;ScriptCallStack&gt;&amp;&amp; callStack, JSC::ExecState*, unsigned long requestIdentifier)</span>
<span class="udiff-line-modified-added">+ void WorkletGlobalScope::addMessage(MessageSource source, MessageLevel level, const String&amp; messageText, const String&amp; sourceURL, unsigned lineNumber, unsigned columnNumber, RefPtr&lt;ScriptCallStack&gt;&amp;&amp; callStack, JSC::JSGlobalObject*, unsigned long requestIdentifier)</span>
  {
      if (!m_document || isJSExecutionForbidden())
          return;
      m_document-&gt;addMessage(source, level, messageText, sourceURL, lineNumber, columnNumber, WTFMove(callStack), nullptr, requestIdentifier);
  }
  
<span class="udiff-line-added">+ ReferrerPolicy WorkletGlobalScope::referrerPolicy() const</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     return ReferrerPolicy::NoReferrer;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  } // namespace WebCore
  #endif
</pre>
<center><a href="WorkletConsoleClient.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="WorkletGlobalScope.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>