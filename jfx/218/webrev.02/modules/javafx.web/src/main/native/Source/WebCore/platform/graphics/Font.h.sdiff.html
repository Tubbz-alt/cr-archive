<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WebCore/platform/graphics/Font.h</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="Font.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="FontCache.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/platform/graphics/Font.h</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 18  * along with this library; see the file COPYING.LIB.  If not, write to
 19  * the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
 20  * Boston, MA 02110-1301, USA.
 21  *
 22  */
 23 
 24 #ifndef Font_h
 25 #define Font_h
 26 
 27 #include &quot;FloatRect.h&quot;
 28 #include &quot;FontMetrics.h&quot;
 29 #include &quot;FontPlatformData.h&quot;
 30 #include &quot;GlyphBuffer.h&quot;
 31 #include &quot;GlyphMetricsMap.h&quot;
 32 #include &quot;GlyphPage.h&quot;
 33 #include &quot;OpenTypeMathData.h&quot;
 34 #if ENABLE(OPENTYPE_VERTICAL)
 35 #include &quot;OpenTypeVerticalData.h&quot;
 36 #endif
 37 #include &lt;wtf/BitVector.h&gt;

 38 #include &lt;wtf/Optional.h&gt;
 39 #include &lt;wtf/text/StringHash.h&gt;
 40 
 41 #if PLATFORM(COCOA)

 42 #include &lt;wtf/RetainPtr.h&gt;
 43 #endif
 44 
 45 #if PLATFORM(WIN)
 46 #include &lt;usp10.h&gt;
 47 #endif
 48 
<span class="line-removed"> 49 #if USE(CG)</span>
<span class="line-removed"> 50 #include &lt;pal/spi/cg/CoreGraphicsSPI.h&gt;</span>
<span class="line-removed"> 51 #endif</span>
<span class="line-removed"> 52 </span>
 53 #if USE(DIRECT2D)
 54 interface IDWriteFactory5;
 55 interface IDWriteGdiInterop;
 56 #endif
 57 
 58 namespace WebCore {
 59 
 60 class GlyphPage;
 61 class FontDescription;
 62 class SharedBuffer;
 63 struct GlyphData;
 64 struct WidthIterator;
 65 
 66 enum FontVariant { AutoVariant, NormalVariant, SmallCapsVariant, EmphasisMarkVariant, BrokenIdeographVariant };
 67 enum Pitch { UnknownPitch, FixedPitch, VariablePitch };
 68 enum class IsForPlatformFont : uint8_t { No, Yes };
 69 

 70 class Font : public RefCounted&lt;Font&gt; {

 71 public:
 72     // Used to create platform fonts.
 73     enum class Origin : uint8_t {
 74         Remote,
 75         Local
 76     };
 77     enum class Interstitial : uint8_t {
 78         Yes,
 79         No
 80     };
 81     enum class Visibility : uint8_t {
 82         Visible,
 83         Invisible
 84     };
 85     enum class OrientationFallback : uint8_t {
 86         Yes,
 87         No
 88     };
 89     static Ref&lt;Font&gt; create(const FontPlatformData&amp; platformData, Origin origin = Origin::Local, Interstitial interstitial = Interstitial::No, Visibility visibility = Visibility::Visible, OrientationFallback orientationFallback = OrientationFallback::No)
 90     {
</pre>
<hr />
<pre>
170     void setZeroWidthSpaceGlyph(Glyph spaceGlyph) { m_zeroWidthSpaceGlyph = spaceGlyph; }
171     bool isZeroWidthSpaceGlyph(Glyph glyph) const { return glyph == m_zeroWidthSpaceGlyph &amp;&amp; glyph; }
172     Glyph zeroGlyph() const { return m_zeroGlyph; }
173     void setZeroGlyph(Glyph zeroGlyph) { m_zeroGlyph = zeroGlyph; }
174 
175     GlyphData glyphDataForCharacter(UChar32) const;
176     Glyph glyphForCharacter(UChar32) const;
177     bool supportsCodePoint(UChar32) const;
178     bool platformSupportsCodePoint(UChar32, Optional&lt;UChar32&gt; variation = WTF::nullopt) const;
179 
180     RefPtr&lt;Font&gt; systemFallbackFontForCharacter(UChar32, const FontDescription&amp;, IsForPlatformFont) const;
181 
182     const GlyphPage* glyphPage(unsigned pageNumber) const;
183 
184     void determinePitch();
185     Pitch pitch() const { return m_treatAsFixedPitch ? FixedPitch : VariablePitch; }
186 
187     Origin origin() const { return m_origin; }
188     bool isInterstitial() const { return m_isInterstitial; }
189     Visibility visibility() const { return m_visibility; }

190 
191 #if !LOG_DISABLED
192     String description() const;
193 #endif
194 
195 #if PLATFORM(IOS_FAMILY)
196     bool shouldNotBeUsedForArabic() const { return m_shouldNotBeUsedForArabic; };
197 #endif
198 #if PLATFORM(COCOA)
199     CTFontRef getCTFont() const { return m_platformData.font(); }
<span class="line-modified">200     CFDictionaryRef getCFStringAttributes(bool enableKerning, FontOrientation) const;</span>
201     const BitVector&amp; glyphsSupportedBySmallCaps() const;
202     const BitVector&amp; glyphsSupportedByAllSmallCaps() const;
203     const BitVector&amp; glyphsSupportedByPetiteCaps() const;
204     const BitVector&amp; glyphsSupportedByAllPetiteCaps() const;
205 #endif
206 
207 #if HAVE(DISALLOWABLE_USER_INSTALLED_FONTS)
208     bool isUserInstalledFont() const;
209 #endif
210 
211     bool canRenderCombiningCharacterSequence(const UChar*, size_t) const;
<span class="line-modified">212     bool applyTransforms(GlyphBufferGlyph*, GlyphBufferAdvance*, size_t glyphCount, bool enableKerning, bool requiresShaping) const;</span>
213 
214 #if PLATFORM(WIN)
215     SCRIPT_FONTPROPERTIES* scriptFontProperties() const;
216     SCRIPT_CACHE* scriptCache() const { return &amp;m_scriptCache; }
217     static void setShouldApplyMacAscentHack(bool);
218     static bool shouldApplyMacAscentHack();
219     static float ascentConsideringMacAscentHack(const WCHAR*, float ascent, float descent);
220 #endif
221 



222 private:
<span class="line-modified">223     Font(const FontPlatformData&amp;, Origin, Interstitial, Visibility, OrientationFallback);</span>
224 
225     void platformInit();
226     void platformGlyphInit();
227     void platformCharWidthInit();
228     void platformDestroy();
229 
230     void initCharWidths();
231 
232     RefPtr&lt;Font&gt; createFontWithoutSynthesizableFeatures() const;
233     RefPtr&lt;Font&gt; createScaledFont(const FontDescription&amp;, float scaleFactor) const;
234     RefPtr&lt;Font&gt; platformCreateScaledFont(const FontDescription&amp;, float scaleFactor) const;
235 
236     void removeFromSystemFallbackCache();
237 
238     struct DerivedFonts;
239     DerivedFonts&amp; ensureDerivedFontData() const;
240 
241 #if PLATFORM(WIN)
242     void initGDIFont();
243     void platformCommonDestroy();
</pre>
<hr />
<pre>
262 #if ENABLE(OPENTYPE_VERTICAL)
263     RefPtr&lt;OpenTypeVerticalData&gt; m_verticalData;
264 #endif
265 
266     struct DerivedFonts {
267         WTF_MAKE_STRUCT_FAST_ALLOCATED;
268     public:
269 
270         RefPtr&lt;Font&gt; smallCapsFont;
271         RefPtr&lt;Font&gt; noSynthesizableFeaturesFont;
272         RefPtr&lt;Font&gt; emphasisMarkFont;
273         RefPtr&lt;Font&gt; brokenIdeographFont;
274         RefPtr&lt;Font&gt; verticalRightOrientationFont;
275         RefPtr&lt;Font&gt; uprightOrientationFont;
276         RefPtr&lt;Font&gt; invisibleFont;
277     };
278 
279     mutable std::unique_ptr&lt;DerivedFonts&gt; m_derivedFontData;
280 
281 #if PLATFORM(COCOA)
<span class="line-removed">282     mutable RetainPtr&lt;CFMutableDictionaryRef&gt; m_nonKernedCFStringAttributes;</span>
<span class="line-removed">283     mutable RetainPtr&lt;CFMutableDictionaryRef&gt; m_kernedCFStringAttributes;</span>
284     mutable Optional&lt;BitVector&gt; m_glyphsSupportedBySmallCaps;
285     mutable Optional&lt;BitVector&gt; m_glyphsSupportedByAllSmallCaps;
286     mutable Optional&lt;BitVector&gt; m_glyphsSupportedByPetiteCaps;
287     mutable Optional&lt;BitVector&gt; m_glyphsSupportedByAllPetiteCaps;
288 #endif
289 
290 #if PLATFORM(WIN)
291     mutable SCRIPT_CACHE m_scriptCache;
292     mutable SCRIPT_FONTPROPERTIES* m_scriptFontProperties;
293 #endif
294 


295     Glyph m_spaceGlyph { 0 };
296     Glyph m_zeroGlyph { 0 };
297     Glyph m_zeroWidthSpaceGlyph { 0 };
298 
299     Origin m_origin; // Whether or not we are custom font loaded via @font-face
300     Visibility m_visibility; // @font-face&#39;s internal timer can cause us to show fonts even when a font is being downloaded.
301 
302     float m_spaceWidth { 0 };
303     float m_adjustedSpaceWidth { 0 };
304 
305 #if USE(CG) || USE(DIRECT2D) || USE(CAIRO) || PLATFORM(JAVA)
306     float m_syntheticBoldOffset { 0 };
307 #endif
308 
309     unsigned m_treatAsFixedPitch : 1;
310     unsigned m_isInterstitial : 1; // Whether or not this custom font is the last resort placeholder for a loading font
311 
312     unsigned m_isTextOrientationFallback : 1;
313     unsigned m_isBrokenIdeographFallback : 1;
314     unsigned m_hasVerticalGlyphs : 1;
315 
316     unsigned m_isUsedInSystemFallbackCache : 1;
317 


318 #if PLATFORM(IOS_FAMILY)
319     unsigned m_shouldNotBeUsedForArabic : 1;
320 #endif
321 };
322 








323 #if PLATFORM(IOS_FAMILY)
324 bool fontFamilyShouldNotBeUsedForArabic(CFStringRef);
325 #endif
326 
327 ALWAYS_INLINE FloatRect Font::boundsForGlyph(Glyph glyph) const
328 {
329     if (isZeroWidthSpaceGlyph(glyph))
330         return FloatRect();
331 
332     FloatRect bounds;
333     if (m_glyphToBoundsMap) {
334         bounds = m_glyphToBoundsMap-&gt;metricsForGlyph(glyph);
335         if (bounds.width() != cGlyphSizeUnknown)
336             return bounds;
337     }
338 
339     bounds = platformBoundsForGlyph(glyph);
340     if (!m_glyphToBoundsMap)
341         m_glyphToBoundsMap = makeUnique&lt;GlyphMetricsMap&lt;FloatRect&gt;&gt;();
342     m_glyphToBoundsMap-&gt;setMetricsForGlyph(glyph, bounds);
</pre>
</td>
<td>
<hr />
<pre>
 18  * along with this library; see the file COPYING.LIB.  If not, write to
 19  * the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
 20  * Boston, MA 02110-1301, USA.
 21  *
 22  */
 23 
 24 #ifndef Font_h
 25 #define Font_h
 26 
 27 #include &quot;FloatRect.h&quot;
 28 #include &quot;FontMetrics.h&quot;
 29 #include &quot;FontPlatformData.h&quot;
 30 #include &quot;GlyphBuffer.h&quot;
 31 #include &quot;GlyphMetricsMap.h&quot;
 32 #include &quot;GlyphPage.h&quot;
 33 #include &quot;OpenTypeMathData.h&quot;
 34 #if ENABLE(OPENTYPE_VERTICAL)
 35 #include &quot;OpenTypeVerticalData.h&quot;
 36 #endif
 37 #include &lt;wtf/BitVector.h&gt;
<span class="line-added"> 38 #include &lt;wtf/Hasher.h&gt;</span>
 39 #include &lt;wtf/Optional.h&gt;
 40 #include &lt;wtf/text/StringHash.h&gt;
 41 
 42 #if PLATFORM(COCOA)
<span class="line-added"> 43 #include &lt;CoreFoundation/CoreFoundation.h&gt;</span>
 44 #include &lt;wtf/RetainPtr.h&gt;
 45 #endif
 46 
 47 #if PLATFORM(WIN)
 48 #include &lt;usp10.h&gt;
 49 #endif
 50 




 51 #if USE(DIRECT2D)
 52 interface IDWriteFactory5;
 53 interface IDWriteGdiInterop;
 54 #endif
 55 
 56 namespace WebCore {
 57 
 58 class GlyphPage;
 59 class FontDescription;
 60 class SharedBuffer;
 61 struct GlyphData;
 62 struct WidthIterator;
 63 
 64 enum FontVariant { AutoVariant, NormalVariant, SmallCapsVariant, EmphasisMarkVariant, BrokenIdeographVariant };
 65 enum Pitch { UnknownPitch, FixedPitch, VariablePitch };
 66 enum class IsForPlatformFont : uint8_t { No, Yes };
 67 
<span class="line-added"> 68 DECLARE_ALLOCATOR_WITH_HEAP_IDENTIFIER(Font);</span>
 69 class Font : public RefCounted&lt;Font&gt; {
<span class="line-added"> 70     WTF_MAKE_FAST_ALLOCATED_WITH_HEAP_IDENTIFIER(Font);</span>
 71 public:
 72     // Used to create platform fonts.
 73     enum class Origin : uint8_t {
 74         Remote,
 75         Local
 76     };
 77     enum class Interstitial : uint8_t {
 78         Yes,
 79         No
 80     };
 81     enum class Visibility : uint8_t {
 82         Visible,
 83         Invisible
 84     };
 85     enum class OrientationFallback : uint8_t {
 86         Yes,
 87         No
 88     };
 89     static Ref&lt;Font&gt; create(const FontPlatformData&amp; platformData, Origin origin = Origin::Local, Interstitial interstitial = Interstitial::No, Visibility visibility = Visibility::Visible, OrientationFallback orientationFallback = OrientationFallback::No)
 90     {
</pre>
<hr />
<pre>
170     void setZeroWidthSpaceGlyph(Glyph spaceGlyph) { m_zeroWidthSpaceGlyph = spaceGlyph; }
171     bool isZeroWidthSpaceGlyph(Glyph glyph) const { return glyph == m_zeroWidthSpaceGlyph &amp;&amp; glyph; }
172     Glyph zeroGlyph() const { return m_zeroGlyph; }
173     void setZeroGlyph(Glyph zeroGlyph) { m_zeroGlyph = zeroGlyph; }
174 
175     GlyphData glyphDataForCharacter(UChar32) const;
176     Glyph glyphForCharacter(UChar32) const;
177     bool supportsCodePoint(UChar32) const;
178     bool platformSupportsCodePoint(UChar32, Optional&lt;UChar32&gt; variation = WTF::nullopt) const;
179 
180     RefPtr&lt;Font&gt; systemFallbackFontForCharacter(UChar32, const FontDescription&amp;, IsForPlatformFont) const;
181 
182     const GlyphPage* glyphPage(unsigned pageNumber) const;
183 
184     void determinePitch();
185     Pitch pitch() const { return m_treatAsFixedPitch ? FixedPitch : VariablePitch; }
186 
187     Origin origin() const { return m_origin; }
188     bool isInterstitial() const { return m_isInterstitial; }
189     Visibility visibility() const { return m_visibility; }
<span class="line-added">190     bool allowsAntialiasing() const { return m_allowsAntialiasing; }</span>
191 
192 #if !LOG_DISABLED
193     String description() const;
194 #endif
195 
196 #if PLATFORM(IOS_FAMILY)
197     bool shouldNotBeUsedForArabic() const { return m_shouldNotBeUsedForArabic; };
198 #endif
199 #if PLATFORM(COCOA)
200     CTFontRef getCTFont() const { return m_platformData.font(); }
<span class="line-modified">201     RetainPtr&lt;CFDictionaryRef&gt; getCFStringAttributes(bool enableKerning, FontOrientation, const AtomString&amp; locale) const;</span>
202     const BitVector&amp; glyphsSupportedBySmallCaps() const;
203     const BitVector&amp; glyphsSupportedByAllSmallCaps() const;
204     const BitVector&amp; glyphsSupportedByPetiteCaps() const;
205     const BitVector&amp; glyphsSupportedByAllPetiteCaps() const;
206 #endif
207 
208 #if HAVE(DISALLOWABLE_USER_INSTALLED_FONTS)
209     bool isUserInstalledFont() const;
210 #endif
211 
212     bool canRenderCombiningCharacterSequence(const UChar*, size_t) const;
<span class="line-modified">213     void applyTransforms(GlyphBuffer&amp;, unsigned beginningIndex, bool enableKerning, bool requiresShaping, const AtomString&amp; locale) const;</span>
214 
215 #if PLATFORM(WIN)
216     SCRIPT_FONTPROPERTIES* scriptFontProperties() const;
217     SCRIPT_CACHE* scriptCache() const { return &amp;m_scriptCache; }
218     static void setShouldApplyMacAscentHack(bool);
219     static bool shouldApplyMacAscentHack();
220     static float ascentConsideringMacAscentHack(const WCHAR*, float ascent, float descent);
221 #endif
222 
<span class="line-added">223     SharedBuffer* fontFaceData() const { return m_fontFaceData.get(); }</span>
<span class="line-added">224     void setFontFaceData(RefPtr&lt;SharedBuffer&gt;&amp;&amp;);</span>
<span class="line-added">225 </span>
226 private:
<span class="line-modified">227     WEBCORE_EXPORT Font(const FontPlatformData&amp;, Origin, Interstitial, Visibility, OrientationFallback);</span>
228 
229     void platformInit();
230     void platformGlyphInit();
231     void platformCharWidthInit();
232     void platformDestroy();
233 
234     void initCharWidths();
235 
236     RefPtr&lt;Font&gt; createFontWithoutSynthesizableFeatures() const;
237     RefPtr&lt;Font&gt; createScaledFont(const FontDescription&amp;, float scaleFactor) const;
238     RefPtr&lt;Font&gt; platformCreateScaledFont(const FontDescription&amp;, float scaleFactor) const;
239 
240     void removeFromSystemFallbackCache();
241 
242     struct DerivedFonts;
243     DerivedFonts&amp; ensureDerivedFontData() const;
244 
245 #if PLATFORM(WIN)
246     void initGDIFont();
247     void platformCommonDestroy();
</pre>
<hr />
<pre>
266 #if ENABLE(OPENTYPE_VERTICAL)
267     RefPtr&lt;OpenTypeVerticalData&gt; m_verticalData;
268 #endif
269 
270     struct DerivedFonts {
271         WTF_MAKE_STRUCT_FAST_ALLOCATED;
272     public:
273 
274         RefPtr&lt;Font&gt; smallCapsFont;
275         RefPtr&lt;Font&gt; noSynthesizableFeaturesFont;
276         RefPtr&lt;Font&gt; emphasisMarkFont;
277         RefPtr&lt;Font&gt; brokenIdeographFont;
278         RefPtr&lt;Font&gt; verticalRightOrientationFont;
279         RefPtr&lt;Font&gt; uprightOrientationFont;
280         RefPtr&lt;Font&gt; invisibleFont;
281     };
282 
283     mutable std::unique_ptr&lt;DerivedFonts&gt; m_derivedFontData;
284 
285 #if PLATFORM(COCOA)


286     mutable Optional&lt;BitVector&gt; m_glyphsSupportedBySmallCaps;
287     mutable Optional&lt;BitVector&gt; m_glyphsSupportedByAllSmallCaps;
288     mutable Optional&lt;BitVector&gt; m_glyphsSupportedByPetiteCaps;
289     mutable Optional&lt;BitVector&gt; m_glyphsSupportedByAllPetiteCaps;
290 #endif
291 
292 #if PLATFORM(WIN)
293     mutable SCRIPT_CACHE m_scriptCache;
294     mutable SCRIPT_FONTPROPERTIES* m_scriptFontProperties;
295 #endif
296 
<span class="line-added">297     RefPtr&lt;SharedBuffer&gt; m_fontFaceData;</span>
<span class="line-added">298 </span>
299     Glyph m_spaceGlyph { 0 };
300     Glyph m_zeroGlyph { 0 };
301     Glyph m_zeroWidthSpaceGlyph { 0 };
302 
303     Origin m_origin; // Whether or not we are custom font loaded via @font-face
304     Visibility m_visibility; // @font-face&#39;s internal timer can cause us to show fonts even when a font is being downloaded.
305 
306     float m_spaceWidth { 0 };
307     float m_adjustedSpaceWidth { 0 };
308 
309 #if USE(CG) || USE(DIRECT2D) || USE(CAIRO) || PLATFORM(JAVA)
310     float m_syntheticBoldOffset { 0 };
311 #endif
312 
313     unsigned m_treatAsFixedPitch : 1;
314     unsigned m_isInterstitial : 1; // Whether or not this custom font is the last resort placeholder for a loading font
315 
316     unsigned m_isTextOrientationFallback : 1;
317     unsigned m_isBrokenIdeographFallback : 1;
318     unsigned m_hasVerticalGlyphs : 1;
319 
320     unsigned m_isUsedInSystemFallbackCache : 1;
321 
<span class="line-added">322     unsigned m_allowsAntialiasing : 1;</span>
<span class="line-added">323 </span>
324 #if PLATFORM(IOS_FAMILY)
325     unsigned m_shouldNotBeUsedForArabic : 1;
326 #endif
327 };
328 
<span class="line-added">329 class FontHandle {</span>
<span class="line-added">330 public:</span>
<span class="line-added">331     FontHandle() = default;</span>
<span class="line-added">332     WEBCORE_EXPORT FontHandle(Ref&lt;SharedBuffer&gt;&amp;&amp; fontFaceData, Font::Origin, float fontSize, bool syntheticBold, bool syntheticItalic);</span>
<span class="line-added">333 </span>
<span class="line-added">334     RefPtr&lt;Font&gt; font;</span>
<span class="line-added">335 };</span>
<span class="line-added">336 </span>
337 #if PLATFORM(IOS_FAMILY)
338 bool fontFamilyShouldNotBeUsedForArabic(CFStringRef);
339 #endif
340 
341 ALWAYS_INLINE FloatRect Font::boundsForGlyph(Glyph glyph) const
342 {
343     if (isZeroWidthSpaceGlyph(glyph))
344         return FloatRect();
345 
346     FloatRect bounds;
347     if (m_glyphToBoundsMap) {
348         bounds = m_glyphToBoundsMap-&gt;metricsForGlyph(glyph);
349         if (bounds.width() != cGlyphSizeUnknown)
350             return bounds;
351     }
352 
353     bounds = platformBoundsForGlyph(glyph);
354     if (!m_glyphToBoundsMap)
355         m_glyphToBoundsMap = makeUnique&lt;GlyphMetricsMap&lt;FloatRect&gt;&gt;();
356     m_glyphToBoundsMap-&gt;setMetricsForGlyph(glyph, bounds);
</pre>
</td>
</tr>
</table>
<center><a href="Font.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="FontCache.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>