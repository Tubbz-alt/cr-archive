<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WebCore/html/HTMLImageElement.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="HTMLIFrameElement.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="HTMLImageElement.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/html/HTMLImageElement.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -35,10 +35,11 @@</span>
  #include &quot;FrameView.h&quot;
  #include &quot;HTMLAnchorElement.h&quot;
  #include &quot;HTMLAttachmentElement.h&quot;
  #include &quot;HTMLDocument.h&quot;
  #include &quot;HTMLFormElement.h&quot;
<span class="udiff-line-added">+ #include &quot;HTMLImageLoader.h&quot;</span>
  #include &quot;HTMLParserIdioms.h&quot;
  #include &quot;HTMLPictureElement.h&quot;
  #include &quot;HTMLMapElement.h&quot;
  #include &quot;HTMLSourceElement.h&quot;
  #include &quot;HTMLSrcsetParser.h&quot;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -66,35 +67,38 @@</span>
  
  WTF_MAKE_ISO_ALLOCATED_IMPL(HTMLImageElement);
  
  using namespace HTMLNames;
  
<span class="udiff-line-modified-removed">- HTMLImageElement::HTMLImageElement(const QualifiedName&amp; tagName, Document&amp; document, HTMLFormElement* form)</span>
<span class="udiff-line-modified-added">+ HTMLImageElement::HTMLImageElement(const QualifiedName&amp; tagName, Document&amp; document, HTMLFormElement* form, bool createdByParser)</span>
      : HTMLElement(tagName, document)
<span class="udiff-line-modified-removed">-     , m_imageLoader(*this)</span>
<span class="udiff-line-modified-added">+     , m_imageLoader(WTF::makeUnique&lt;HTMLImageLoader&gt;(*this))</span>
      , m_form(nullptr)
      , m_formSetByParser(makeWeakPtr(form))
<span class="udiff-line-modified-removed">-     , m_compositeOperator(CompositeSourceOver)</span>
<span class="udiff-line-modified-added">+     , m_compositeOperator(CompositeOperator::SourceOver)</span>
      , m_imageDevicePixelRatio(1.0f)
      , m_experimentalImageMenuEnabled(false)
<span class="udiff-line-added">+     , m_createdByParser(createdByParser)</span>
  {
      ASSERT(hasTagName(imgTag));
      setHasCustomStyleResolveCallbacks();
  }
  
  Ref&lt;HTMLImageElement&gt; HTMLImageElement::create(Document&amp; document)
  {
      return adoptRef(*new HTMLImageElement(imgTag, document));
  }
  
<span class="udiff-line-modified-removed">- Ref&lt;HTMLImageElement&gt; HTMLImageElement::create(const QualifiedName&amp; tagName, Document&amp; document, HTMLFormElement* form)</span>
<span class="udiff-line-modified-added">+ Ref&lt;HTMLImageElement&gt; HTMLImageElement::create(const QualifiedName&amp; tagName, Document&amp; document, HTMLFormElement* form, bool createdByParser)</span>
  {
<span class="udiff-line-modified-removed">-     return adoptRef(*new HTMLImageElement(tagName, document, form));</span>
<span class="udiff-line-modified-added">+     return adoptRef(*new HTMLImageElement(tagName, document, form, createdByParser));</span>
  }
  
  HTMLImageElement::~HTMLImageElement()
  {
<span class="udiff-line-added">+     document().removeDynamicMediaQueryDependentImage(*this);</span>
<span class="udiff-line-added">+ </span>
      if (m_form)
          m_form-&gt;removeImgElement(this);
      setPictureElement(nullptr);
  }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -156,15 +160,11 @@</span>
  {
      auto picture = makeRefPtr(pictureElement());
      if (!picture)
          return { };
  
<span class="udiff-line-modified-removed">-     picture-&gt;clearViewportDependentResults();</span>
<span class="udiff-line-removed">-     document().removeViewportDependentPicture(*picture);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     picture-&gt;clearAppearanceDependentResults();</span>
<span class="udiff-line-removed">-     document().removeAppearanceDependentPicture(*picture);</span>
<span class="udiff-line-modified-added">+     ImageCandidate candidate;</span>
  
      for (RefPtr&lt;Node&gt; child = picture-&gt;firstChild(); child &amp;&amp; child != this; child = child-&gt;nextSibling()) {
          if (!is&lt;HTMLSourceElement&gt;(*child))
              continue;
          auto&amp; source = downcast&lt;HTMLSourceElement&gt;(*child);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -184,37 +184,55 @@</span>
  
          auto documentElement = makeRefPtr(document().documentElement());
          MediaQueryEvaluator evaluator { document().printing() ? &quot;print&quot; : &quot;screen&quot;, document(), documentElement ? documentElement-&gt;computedStyle() : nullptr };
          auto* queries = source.parsedMediaAttribute(document());
          LOG(MediaQueries, &quot;HTMLImageElement %p bestFitSourceFromPictureElement evaluating media queries&quot;, this);
<span class="udiff-line-modified-removed">-         auto evaluation = !queries || evaluator.evaluate(*queries, picture-&gt;viewportDependentResults(), picture-&gt;appearanceDependentResults());</span>
<span class="udiff-line-modified-removed">-         if (picture-&gt;hasViewportDependentResults())</span>
<span class="udiff-line-removed">-             document().addViewportDependentPicture(*picture);</span>
<span class="udiff-line-removed">-         if (picture-&gt;hasAppearanceDependentResults())</span>
<span class="udiff-line-removed">-             document().addAppearanceDependentPicture(*picture);</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+         auto evaluation = !queries || evaluator.evaluate(*queries, &amp;m_mediaQueryDynamicResults);</span>
          if (!evaluation)
              continue;
  
<span class="udiff-line-modified-removed">-         auto sourceSize = SizesAttributeParser(source.attributeWithoutSynchronization(sizesAttr).string(), document()).length();</span>
<span class="udiff-line-modified-removed">-         auto candidate = bestFitSourceForImageAttributes(document().deviceScaleFactor(), nullAtom(), srcset, sourceSize);</span>
<span class="udiff-line-modified-added">+         SizesAttributeParser sizesParser(source.attributeWithoutSynchronization(sizesAttr).string(), document(), &amp;m_mediaQueryDynamicResults);</span>
<span class="udiff-line-modified-added">+         auto sourceSize = sizesParser.length();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         candidate = bestFitSourceForImageAttributes(document().deviceScaleFactor(), nullAtom(), srcset, sourceSize);</span>
          if (!candidate.isEmpty())
<span class="udiff-line-modified-removed">-             return candidate;</span>
<span class="udiff-line-modified-added">+             break;</span>
      }
<span class="udiff-line-modified-removed">-     return { };</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-added">+     return candidate;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void HTMLImageElement::evaluateDynamicMediaQueryDependencies()</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     auto documentElement = makeRefPtr(document().documentElement());</span>
<span class="udiff-line-added">+     MediaQueryEvaluator evaluator { document().printing() ? &quot;print&quot; : &quot;screen&quot;, document(), documentElement ? documentElement-&gt;computedStyle() : nullptr };</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (!evaluator.evaluateForChanges(m_mediaQueryDynamicResults))</span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     selectImageSource();</span>
  }
  
  void HTMLImageElement::selectImageSource()
  {
<span class="udiff-line-added">+     m_mediaQueryDynamicResults = { };</span>
<span class="udiff-line-added">+     document().removeDynamicMediaQueryDependentImage(*this);</span>
<span class="udiff-line-added">+ </span>
      // First look for the best fit source from our &lt;picture&gt; parent if we have one.
      ImageCandidate candidate = bestFitSourceFromPictureElement();
      if (candidate.isEmpty()) {
          // If we don&#39;t have a &lt;picture&gt; or didn&#39;t find a source, then we use our own attributes.
<span class="udiff-line-modified-removed">-         auto sourceSize = SizesAttributeParser(attributeWithoutSynchronization(sizesAttr).string(), document()).length();</span>
<span class="udiff-line-modified-added">+         SizesAttributeParser sizesParser(attributeWithoutSynchronization(sizesAttr).string(), document(), &amp;m_mediaQueryDynamicResults);</span>
<span class="udiff-line-added">+         auto sourceSize = sizesParser.length();</span>
          candidate = bestFitSourceForImageAttributes(document().deviceScaleFactor(), attributeWithoutSynchronization(srcAttr), attributeWithoutSynchronization(srcsetAttr), sourceSize);
      }
      setBestFitURLAndDPRFromImageCandidate(candidate);
<span class="udiff-line-modified-removed">-     m_imageLoader.updateFromElementIgnoringPreviousError();</span>
<span class="udiff-line-modified-added">+     m_imageLoader-&gt;updateFromElementIgnoringPreviousError();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (!m_mediaQueryDynamicResults.isEmpty())</span>
<span class="udiff-line-added">+         document().addDynamicMediaQueryDependentImage(*this);</span>
  }
  
  void HTMLImageElement::parseAttribute(const QualifiedName&amp; name, const AtomString&amp; value)
  {
      if (name == altAttr) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -232,11 +250,11 @@</span>
              treeScope().addImageElementByUsemap(*m_parsedUsemap.impl(), *this);
      } else if (name == compositeAttr) {
          // FIXME: images don&#39;t support blend modes in their compositing attribute.
          BlendMode blendOp = BlendMode::Normal;
          if (!parseCompositeAndBlendOperator(value, m_compositeOperator, blendOp))
<span class="udiff-line-modified-removed">-             m_compositeOperator = CompositeSourceOver;</span>
<span class="udiff-line-modified-added">+             m_compositeOperator = CompositeOperator::SourceOver;</span>
  #if ENABLE(SERVICE_CONTROLS)
      } else if (name == webkitimagemenuAttr) {
          m_experimentalImageMenuEnabled = !value.isNull();
          updateImageControls();
  #endif
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -310,26 +328,26 @@</span>
  
  void HTMLImageElement::didAttachRenderers()
  {
      if (!is&lt;RenderImage&gt;(renderer()))
          return;
<span class="udiff-line-modified-removed">-     if (m_imageLoader.hasPendingBeforeLoadEvent())</span>
<span class="udiff-line-modified-added">+     if (m_imageLoader-&gt;hasPendingBeforeLoadEvent())</span>
          return;
  
  #if ENABLE(SERVICE_CONTROLS)
      updateImageControls();
  #endif
  
      auto&amp; renderImage = downcast&lt;RenderImage&gt;(*renderer());
      RenderImageResource&amp; renderImageResource = renderImage.imageResource();
      if (renderImageResource.cachedImage())
          return;
<span class="udiff-line-modified-removed">-     renderImageResource.setCachedImage(m_imageLoader.image());</span>
<span class="udiff-line-modified-added">+     renderImageResource.setCachedImage(m_imageLoader-&gt;image());</span>
  
      // If we have no image at all because we have no src attribute, set
      // image height and width for the alt text instead.
<span class="udiff-line-modified-removed">-     if (!m_imageLoader.image() &amp;&amp; !renderImageResource.cachedImage())</span>
<span class="udiff-line-modified-added">+     if (!m_imageLoader-&gt;image() &amp;&amp; !renderImageResource.cachedImage())</span>
          renderImage.setImageSizeForAltText();
  }
  
  Node::InsertedIntoAncestorResult HTMLImageElement::insertedIntoAncestor(InsertionType insertionType, ContainerNode&amp; parentOfInsertedTree)
  {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -365,12 +383,12 @@</span>
          selectImageSource();
      }
  
      // If we have been inserted from a renderer-less document,
      // our loader may have not fetched the image, so do it now.
<span class="udiff-line-modified-removed">-     if (insertionType.connectedToDocument &amp;&amp; !m_imageLoader.image())</span>
<span class="udiff-line-modified-removed">-         m_imageLoader.updateFromElement();</span>
<span class="udiff-line-modified-added">+     if (insertionType.connectedToDocument &amp;&amp; !m_imageLoader-&gt;image())</span>
<span class="udiff-line-modified-added">+         m_imageLoader-&gt;updateFromElement();</span>
  
      return insertNotificationRequest;
  }
  
  void HTMLImageElement::didFinishInsertingNode()
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -470,12 +488,12 @@</span>
          auto optionalWidth = parseHTMLNonNegativeInteger(attributeWithoutSynchronization(widthAttr));
          if (optionalWidth)
              return optionalWidth.value();
  
          // if the image is available, use its width
<span class="udiff-line-modified-removed">-         if (m_imageLoader.image())</span>
<span class="udiff-line-modified-removed">-             return m_imageLoader.image()-&gt;imageSizeForRenderer(renderer(), 1.0f).width().toUnsigned();</span>
<span class="udiff-line-modified-added">+         if (m_imageLoader-&gt;image())</span>
<span class="udiff-line-modified-added">+             return m_imageLoader-&gt;image()-&gt;imageSizeForRenderer(renderer(), 1.0f).width().toUnsigned();</span>
      }
  
      if (ignorePendingStylesheets)
          document().updateLayoutIgnorePendingStylesheets();
      else
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -495,12 +513,12 @@</span>
          auto optionalHeight = parseHTMLNonNegativeInteger(attributeWithoutSynchronization(heightAttr));
          if (optionalHeight)
              return optionalHeight.value();
  
          // if the image is available, use its height
<span class="udiff-line-modified-removed">-         if (m_imageLoader.image())</span>
<span class="udiff-line-modified-removed">-             return m_imageLoader.image()-&gt;imageSizeForRenderer(renderer(), 1.0f).height().toUnsigned();</span>
<span class="udiff-line-modified-added">+         if (m_imageLoader-&gt;image())</span>
<span class="udiff-line-modified-added">+             return m_imageLoader-&gt;image()-&gt;imageSizeForRenderer(renderer(), 1.0f).height().toUnsigned();</span>
      }
  
      if (ignorePendingStylesheets)
          document().updateLayoutIgnorePendingStylesheets();
      else
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -511,24 +529,37 @@</span>
          return 0;
      LayoutRect contentRect = box-&gt;contentBoxRect();
      return adjustForAbsoluteZoom(snappedIntRect(contentRect).height(), *box);
  }
  
<span class="udiff-line-added">+ float HTMLImageElement::effectiveImageDevicePixelRatio() const</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     if (!m_imageLoader-&gt;image())</span>
<span class="udiff-line-added">+         return 1.0f;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     auto* image = m_imageLoader-&gt;image()-&gt;image();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (image &amp;&amp; image-&gt;isSVGImage())</span>
<span class="udiff-line-added">+         return 1.0f;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     return m_imageDevicePixelRatio;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  int HTMLImageElement::naturalWidth() const
  {
<span class="udiff-line-modified-removed">-     if (!m_imageLoader.image())</span>
<span class="udiff-line-modified-added">+     if (!m_imageLoader-&gt;image())</span>
          return 0;
  
<span class="udiff-line-modified-removed">-     return m_imageLoader.image()-&gt;imageSizeForRenderer(renderer(), 1.0f).width();</span>
<span class="udiff-line-modified-added">+     return m_imageLoader-&gt;image()-&gt;unclampedImageSizeForRenderer(renderer(), effectiveImageDevicePixelRatio()).width();</span>
  }
  
  int HTMLImageElement::naturalHeight() const
  {
<span class="udiff-line-modified-removed">-     if (!m_imageLoader.image())</span>
<span class="udiff-line-modified-added">+     if (!m_imageLoader-&gt;image())</span>
          return 0;
  
<span class="udiff-line-modified-removed">-     return m_imageLoader.image()-&gt;imageSizeForRenderer(renderer(), 1.0f).height();</span>
<span class="udiff-line-modified-added">+     return m_imageLoader-&gt;image()-&gt;unclampedImageSizeForRenderer(renderer(), effectiveImageDevicePixelRatio()).height();</span>
  }
  
  bool HTMLImageElement::isURLAttribute(const Attribute&amp; attribute) const
  {
      return attribute.name() == srcAttr
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -551,20 +582,14 @@</span>
          StringBuilder result;
          for (const auto&amp; candidate : imageCandidates) {
              if (&amp;candidate != &amp;imageCandidates[0])
                  result.appendLiteral(&quot;, &quot;);
              result.append(URL(base, candidate.string.toString()).string());
<span class="udiff-line-modified-removed">-             if (candidate.density != UninitializedDescriptor) {</span>
<span class="udiff-line-modified-removed">-                 result.append(&#39; &#39;);</span>
<span class="udiff-line-modified-removed">-                 result.appendFixedPrecisionNumber(candidate.density);</span>
<span class="udiff-line-modified-removed">-                 result.append(&#39;x&#39;);</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             if (candidate.resourceWidth != UninitializedDescriptor) {</span>
<span class="udiff-line-removed">-                 result.append(&#39; &#39;);</span>
<span class="udiff-line-removed">-                 result.appendNumber(candidate.resourceWidth);</span>
<span class="udiff-line-removed">-                 result.append(&#39;w&#39;);</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-modified-added">+             if (candidate.density != UninitializedDescriptor)</span>
<span class="udiff-line-modified-added">+                 result.append(&#39; &#39;, candidate.density, &#39;x&#39;);</span>
<span class="udiff-line-modified-added">+             if (candidate.resourceWidth != UninitializedDescriptor)</span>
<span class="udiff-line-modified-added">+                 result.append(&#39; &#39;, candidate.resourceWidth, &#39;w&#39;);</span>
          }
          return result.toString();
      }
      return HTMLElement::completeURLsInAttributeValue(base, attribute);
  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -632,11 +657,11 @@</span>
      return renderer-&gt;localToAbsolute().y();
  }
  
  bool HTMLImageElement::complete() const
  {
<span class="udiff-line-modified-removed">-     return m_imageLoader.imageComplete();</span>
<span class="udiff-line-modified-added">+     return m_imageLoader-&gt;imageComplete();</span>
  }
  
  DecodingMode HTMLImageElement::decodingMode() const
  {
      const AtomString&amp; decodingMode = attributeWithoutSynchronization(decodingAttr);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -647,11 +672,11 @@</span>
      return DecodingMode::Auto;
  }
  
  void HTMLImageElement::decode(Ref&lt;DeferredPromise&gt;&amp;&amp; promise)
  {
<span class="udiff-line-modified-removed">-     return m_imageLoader.decode(WTFMove(promise));</span>
<span class="udiff-line-modified-added">+     return m_imageLoader-&gt;decode(WTFMove(promise));</span>
  }
  
  void HTMLImageElement::addSubresourceAttributeURLs(ListHashSet&lt;URL&gt;&amp; urls) const
  {
      HTMLElement::addSubresourceAttributeURLs(urls);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -661,11 +686,13 @@</span>
      addSubresourceURL(urls, document().completeURL(attributeWithoutSynchronization(usemapAttr)));
  }
  
  void HTMLImageElement::didMoveToNewDocument(Document&amp; oldDocument, Document&amp; newDocument)
  {
<span class="udiff-line-modified-removed">-     m_imageLoader.elementDidMoveToNewDocument();</span>
<span class="udiff-line-modified-added">+     oldDocument.removeDynamicMediaQueryDependentImage(*this);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     m_imageLoader-&gt;elementDidMoveToNewDocument();</span>
      HTMLElement::didMoveToNewDocument(oldDocument, newDocument);
  }
  
  bool HTMLImageElement::isServerMap() const
  {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -837,6 +864,26 @@</span>
          return;
      }
      HTMLElement::defaultEventHandler(event);
  }
  
<span class="udiff-line-added">+ CachedImage* HTMLImageElement::cachedImage() const</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     return m_imageLoader-&gt;image();</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void HTMLImageElement::setLoadManually(bool loadManually)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     m_imageLoader-&gt;setLoadManually(loadManually);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ bool HTMLImageElement::hasPendingActivity() const</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     return m_imageLoader-&gt;hasPendingActivity();</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ size_t HTMLImageElement::pendingDecodePromisesCountForTesting() const</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     return m_imageLoader-&gt;pendingDecodePromisesCountForTesting();</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  }
</pre>
<center><a href="HTMLIFrameElement.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="HTMLImageElement.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>