<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WebCore/inspector/agents/InspectorIndexedDBAgent.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="InspectorDatabaseAgent.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="InspectorIndexedDBAgent.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/inspector/agents/InspectorIndexedDBAgent.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
205     if (result.hasException())
206         return nullptr;
207     return result.releaseReturnValue();
208 }
209 
210 static RefPtr&lt;IDBIndex&gt; indexForObjectStore(IDBObjectStore* idbObjectStore, const String&amp; indexName)
211 {
212     auto index = idbObjectStore-&gt;index(indexName);
213     if (index.hasException())
214         return nullptr;
215     return index.releaseReturnValue();
216 }
217 
218 class DatabaseLoader final : public ExecutableWithDatabase {
219 public:
220     static Ref&lt;DatabaseLoader&gt; create(ScriptExecutionContext* context, Ref&lt;RequestDatabaseCallback&gt;&amp;&amp; requestCallback)
221     {
222         return adoptRef(*new DatabaseLoader(context, WTFMove(requestCallback)));
223     }
224 
<span class="line-modified">225     virtual ~DatabaseLoader() = default;</span>
226 
227     void execute(IDBDatabase&amp; database) override
228     {
229         if (!requestCallback().isActive())
230             return;
231 
232         auto&amp; databaseInfo = database.info();
233         auto objectStores = JSON::ArrayOf&lt;Inspector::Protocol::IndexedDB::ObjectStore&gt;::create();
234         auto objectStoreNames = databaseInfo.objectStoreNames();
235         for (auto&amp; name : objectStoreNames) {
236             auto* objectStoreInfo = databaseInfo.infoForExistingObjectStore(name);
237             if (!objectStoreInfo)
238                 continue;
239 
240             auto indexes = JSON::ArrayOf&lt;Inspector::Protocol::IndexedDB::ObjectStoreIndex&gt;::create();
241 
242             for (auto&amp; indexInfo : objectStoreInfo-&gt;indexMap().values()) {
243                 auto objectStoreIndex = ObjectStoreIndex::create()
244                     .setName(indexInfo.name())
245                     .setKeyPath(keyPathFromIDBKeyPath(indexInfo.keyPath()))
</pre>
<hr />
<pre>
339     }
340 
341     bool lowerOpen;
342     if (!keyRange-&gt;getBoolean(&quot;lowerOpen&quot;_s, lowerOpen))
343         return nullptr;
344 
345     bool upperOpen;
346     if (!keyRange-&gt;getBoolean(&quot;upperOpen&quot;_s, upperOpen))
347         return nullptr;
348 
349     return IDBKeyRange::create(WTFMove(idbLower), WTFMove(idbUpper), lowerOpen, upperOpen);
350 }
351 
352 class OpenCursorCallback final : public EventListener {
353 public:
354     static Ref&lt;OpenCursorCallback&gt; create(InjectedScript injectedScript, Ref&lt;RequestDataCallback&gt;&amp;&amp; requestCallback, int skipCount, unsigned pageSize)
355     {
356         return adoptRef(*new OpenCursorCallback(injectedScript, WTFMove(requestCallback), skipCount, pageSize));
357     }
358 
<span class="line-modified">359     virtual ~OpenCursorCallback() = default;</span>
360 
361     bool operator==(const EventListener&amp; other) const override
362     {
363         return this == &amp;other;
364     }
365 
366     void handleEvent(ScriptExecutionContext&amp; context, Event&amp; event) override
367     {
368         if (event.type() != eventNames().successEvent) {
369             m_requestCallback-&gt;sendFailure(&quot;Unexpected event type.&quot;);
370             return;
371         }
372 
373         auto&amp; request = static_cast&lt;IDBRequest&amp;&gt;(*event.target());
374 
375         auto result = request.result();
376         if (result.hasException()) {
377             m_requestCallback-&gt;sendFailure(&quot;Could not get result in callback.&quot;);
378             return;
379         }
</pre>
<hr />
<pre>
387         auto cursor = WTF::get&lt;RefPtr&lt;IDBCursor&gt;&gt;(resultValue);
388 
389         if (m_skipCount) {
390             if (cursor-&gt;advance(m_skipCount).hasException())
391                 m_requestCallback-&gt;sendFailure(&quot;Could not advance cursor.&quot;);
392             m_skipCount = 0;
393             return;
394         }
395 
396         if (m_result-&gt;length() == m_pageSize) {
397             end(true);
398             return;
399         }
400 
401         // Continue cursor before making injected script calls, otherwise transaction might be finished.
402         if (cursor-&gt;continueFunction(nullptr).hasException()) {
403             m_requestCallback-&gt;sendFailure(&quot;Could not continue cursor.&quot;);
404             return;
405         }
406 
<span class="line-modified">407         auto* state = context.execState();</span>
<span class="line-modified">408         auto key =  toJS(*state, *state-&gt;lexicalGlobalObject(), cursor-&gt;key());</span>
<span class="line-modified">409         auto primaryKey = toJS(*state, *state-&gt;lexicalGlobalObject(), cursor-&gt;primaryKey());</span>
<span class="line-modified">410         auto value = deserializeIDBValueToJSValue(*state, cursor-&gt;value());</span>
411         auto dataEntry = DataEntry::create()
412             .setKey(m_injectedScript.wrapObject(key, String(), true))
413             .setPrimaryKey(m_injectedScript.wrapObject(primaryKey, String(), true))
414             .setValue(m_injectedScript.wrapObject(value, String(), true))
415             .release();
416         m_result-&gt;addItem(WTFMove(dataEntry));
417     }
418 
419     void end(bool hasMore)
420     {
421         if (!m_requestCallback-&gt;isActive())
422             return;
423         m_requestCallback-&gt;sendSuccess(WTFMove(m_result), hasMore);
424     }
425 
426 private:
427     OpenCursorCallback(InjectedScript injectedScript, Ref&lt;RequestDataCallback&gt;&amp;&amp; requestCallback, int skipCount, unsigned pageSize)
428         : EventListener(EventListener::CPPEventListenerType)
429         , m_injectedScript(injectedScript)
430         , m_requestCallback(WTFMove(requestCallback))
431         , m_result(JSON::ArrayOf&lt;DataEntry&gt;::create())
432         , m_skipCount(skipCount)
433         , m_pageSize(pageSize)
434     {
435     }
436     InjectedScript m_injectedScript;
437     Ref&lt;RequestDataCallback&gt; m_requestCallback;
438     Ref&lt;JSON::ArrayOf&lt;DataEntry&gt;&gt; m_result;
439     int m_skipCount;
440     unsigned m_pageSize;
441 };
442 
443 class DataLoader final : public ExecutableWithDatabase {
444 public:
445     static Ref&lt;DataLoader&gt; create(ScriptExecutionContext* context, Ref&lt;RequestDataCallback&gt;&amp;&amp; requestCallback, const InjectedScript&amp; injectedScript, const String&amp; objectStoreName, const String&amp; indexName, RefPtr&lt;IDBKeyRange&gt;&amp;&amp; idbKeyRange, int skipCount, unsigned pageSize)
446     {
447         return adoptRef(*new DataLoader(context, WTFMove(requestCallback), injectedScript, objectStoreName, indexName, WTFMove(idbKeyRange), skipCount, pageSize));
448     }
449 
<span class="line-modified">450     virtual ~DataLoader() = default;</span>
451 
452     void execute(IDBDatabase&amp; database) override
453     {
454         if (!requestCallback().isActive())
455             return;
456 
457         auto idbTransaction = transactionForDatabase(&amp;database, m_objectStoreName);
458         if (!idbTransaction) {
459             m_requestCallback-&gt;sendFailure(&quot;Could not get transaction&quot;);
460             return;
461         }
462 
463         auto idbObjectStore = objectStoreForTransaction(idbTransaction.get(), m_objectStoreName);
464         if (!idbObjectStore) {
465             m_requestCallback-&gt;sendFailure(&quot;Could not get object store&quot;);
466             return;
467         }
468 
469         TransactionActivator activator(idbTransaction.get());
470         RefPtr&lt;IDBRequest&gt; idbRequest;
</pre>
<hr />
<pre>
634     RefPtr&lt;IDBKeyRange&gt; idbKeyRange = keyRange ? idbKeyRangeFromKeyRange(keyRange) : nullptr;
635     if (keyRange &amp;&amp; !idbKeyRange) {
636         callback-&gt;sendFailure(&quot;Could not parse key range.&quot;_s);
637         return;
638     }
639 
640     Ref&lt;DataLoader&gt; dataLoader = DataLoader::create(document, WTFMove(callback), injectedScript, objectStoreName, indexName, WTFMove(idbKeyRange), skipCount, pageSize);
641     dataLoader-&gt;start(idbFactory, &amp;document-&gt;securityOrigin(), databaseName);
642 }
643 
644 namespace {
645 
646 class ClearObjectStoreListener final : public EventListener {
647     WTF_MAKE_NONCOPYABLE(ClearObjectStoreListener);
648 public:
649     static Ref&lt;ClearObjectStoreListener&gt; create(Ref&lt;ClearObjectStoreCallback&gt; requestCallback)
650     {
651         return adoptRef(*new ClearObjectStoreListener(WTFMove(requestCallback)));
652     }
653 
<span class="line-modified">654     virtual ~ClearObjectStoreListener() = default;</span>
655 
656     bool operator==(const EventListener&amp; other) const override
657     {
658         return this == &amp;other;
659     }
660 
661     void handleEvent(ScriptExecutionContext&amp;, Event&amp; event) override
662     {
663         if (!m_requestCallback-&gt;isActive())
664             return;
665         if (event.type() != eventNames().completeEvent) {
666             m_requestCallback-&gt;sendFailure(&quot;Unexpected event type.&quot;);
667             return;
668         }
669 
670         m_requestCallback-&gt;sendSuccess();
671     }
672 private:
673     ClearObjectStoreListener(Ref&lt;ClearObjectStoreCallback&gt;&amp;&amp; requestCallback)
674         : EventListener(EventListener::CPPEventListenerType)
</pre>
</td>
<td>
<hr />
<pre>
205     if (result.hasException())
206         return nullptr;
207     return result.releaseReturnValue();
208 }
209 
210 static RefPtr&lt;IDBIndex&gt; indexForObjectStore(IDBObjectStore* idbObjectStore, const String&amp; indexName)
211 {
212     auto index = idbObjectStore-&gt;index(indexName);
213     if (index.hasException())
214         return nullptr;
215     return index.releaseReturnValue();
216 }
217 
218 class DatabaseLoader final : public ExecutableWithDatabase {
219 public:
220     static Ref&lt;DatabaseLoader&gt; create(ScriptExecutionContext* context, Ref&lt;RequestDatabaseCallback&gt;&amp;&amp; requestCallback)
221     {
222         return adoptRef(*new DatabaseLoader(context, WTFMove(requestCallback)));
223     }
224 
<span class="line-modified">225     ~DatabaseLoader() override = default;</span>
226 
227     void execute(IDBDatabase&amp; database) override
228     {
229         if (!requestCallback().isActive())
230             return;
231 
232         auto&amp; databaseInfo = database.info();
233         auto objectStores = JSON::ArrayOf&lt;Inspector::Protocol::IndexedDB::ObjectStore&gt;::create();
234         auto objectStoreNames = databaseInfo.objectStoreNames();
235         for (auto&amp; name : objectStoreNames) {
236             auto* objectStoreInfo = databaseInfo.infoForExistingObjectStore(name);
237             if (!objectStoreInfo)
238                 continue;
239 
240             auto indexes = JSON::ArrayOf&lt;Inspector::Protocol::IndexedDB::ObjectStoreIndex&gt;::create();
241 
242             for (auto&amp; indexInfo : objectStoreInfo-&gt;indexMap().values()) {
243                 auto objectStoreIndex = ObjectStoreIndex::create()
244                     .setName(indexInfo.name())
245                     .setKeyPath(keyPathFromIDBKeyPath(indexInfo.keyPath()))
</pre>
<hr />
<pre>
339     }
340 
341     bool lowerOpen;
342     if (!keyRange-&gt;getBoolean(&quot;lowerOpen&quot;_s, lowerOpen))
343         return nullptr;
344 
345     bool upperOpen;
346     if (!keyRange-&gt;getBoolean(&quot;upperOpen&quot;_s, upperOpen))
347         return nullptr;
348 
349     return IDBKeyRange::create(WTFMove(idbLower), WTFMove(idbUpper), lowerOpen, upperOpen);
350 }
351 
352 class OpenCursorCallback final : public EventListener {
353 public:
354     static Ref&lt;OpenCursorCallback&gt; create(InjectedScript injectedScript, Ref&lt;RequestDataCallback&gt;&amp;&amp; requestCallback, int skipCount, unsigned pageSize)
355     {
356         return adoptRef(*new OpenCursorCallback(injectedScript, WTFMove(requestCallback), skipCount, pageSize));
357     }
358 
<span class="line-modified">359     ~OpenCursorCallback() override = default;</span>
360 
361     bool operator==(const EventListener&amp; other) const override
362     {
363         return this == &amp;other;
364     }
365 
366     void handleEvent(ScriptExecutionContext&amp; context, Event&amp; event) override
367     {
368         if (event.type() != eventNames().successEvent) {
369             m_requestCallback-&gt;sendFailure(&quot;Unexpected event type.&quot;);
370             return;
371         }
372 
373         auto&amp; request = static_cast&lt;IDBRequest&amp;&gt;(*event.target());
374 
375         auto result = request.result();
376         if (result.hasException()) {
377             m_requestCallback-&gt;sendFailure(&quot;Could not get result in callback.&quot;);
378             return;
379         }
</pre>
<hr />
<pre>
387         auto cursor = WTF::get&lt;RefPtr&lt;IDBCursor&gt;&gt;(resultValue);
388 
389         if (m_skipCount) {
390             if (cursor-&gt;advance(m_skipCount).hasException())
391                 m_requestCallback-&gt;sendFailure(&quot;Could not advance cursor.&quot;);
392             m_skipCount = 0;
393             return;
394         }
395 
396         if (m_result-&gt;length() == m_pageSize) {
397             end(true);
398             return;
399         }
400 
401         // Continue cursor before making injected script calls, otherwise transaction might be finished.
402         if (cursor-&gt;continueFunction(nullptr).hasException()) {
403             m_requestCallback-&gt;sendFailure(&quot;Could not continue cursor.&quot;);
404             return;
405         }
406 
<span class="line-modified">407         auto* lexicalGlobalObject = context.execState();</span>
<span class="line-modified">408         auto key =  toJS(*lexicalGlobalObject, *lexicalGlobalObject, cursor-&gt;key());</span>
<span class="line-modified">409         auto primaryKey = toJS(*lexicalGlobalObject, *lexicalGlobalObject, cursor-&gt;primaryKey());</span>
<span class="line-modified">410         auto value = deserializeIDBValueToJSValue(*lexicalGlobalObject, cursor-&gt;value());</span>
411         auto dataEntry = DataEntry::create()
412             .setKey(m_injectedScript.wrapObject(key, String(), true))
413             .setPrimaryKey(m_injectedScript.wrapObject(primaryKey, String(), true))
414             .setValue(m_injectedScript.wrapObject(value, String(), true))
415             .release();
416         m_result-&gt;addItem(WTFMove(dataEntry));
417     }
418 
419     void end(bool hasMore)
420     {
421         if (!m_requestCallback-&gt;isActive())
422             return;
423         m_requestCallback-&gt;sendSuccess(WTFMove(m_result), hasMore);
424     }
425 
426 private:
427     OpenCursorCallback(InjectedScript injectedScript, Ref&lt;RequestDataCallback&gt;&amp;&amp; requestCallback, int skipCount, unsigned pageSize)
428         : EventListener(EventListener::CPPEventListenerType)
429         , m_injectedScript(injectedScript)
430         , m_requestCallback(WTFMove(requestCallback))
431         , m_result(JSON::ArrayOf&lt;DataEntry&gt;::create())
432         , m_skipCount(skipCount)
433         , m_pageSize(pageSize)
434     {
435     }
436     InjectedScript m_injectedScript;
437     Ref&lt;RequestDataCallback&gt; m_requestCallback;
438     Ref&lt;JSON::ArrayOf&lt;DataEntry&gt;&gt; m_result;
439     int m_skipCount;
440     unsigned m_pageSize;
441 };
442 
443 class DataLoader final : public ExecutableWithDatabase {
444 public:
445     static Ref&lt;DataLoader&gt; create(ScriptExecutionContext* context, Ref&lt;RequestDataCallback&gt;&amp;&amp; requestCallback, const InjectedScript&amp; injectedScript, const String&amp; objectStoreName, const String&amp; indexName, RefPtr&lt;IDBKeyRange&gt;&amp;&amp; idbKeyRange, int skipCount, unsigned pageSize)
446     {
447         return adoptRef(*new DataLoader(context, WTFMove(requestCallback), injectedScript, objectStoreName, indexName, WTFMove(idbKeyRange), skipCount, pageSize));
448     }
449 
<span class="line-modified">450     ~DataLoader() override = default;</span>
451 
452     void execute(IDBDatabase&amp; database) override
453     {
454         if (!requestCallback().isActive())
455             return;
456 
457         auto idbTransaction = transactionForDatabase(&amp;database, m_objectStoreName);
458         if (!idbTransaction) {
459             m_requestCallback-&gt;sendFailure(&quot;Could not get transaction&quot;);
460             return;
461         }
462 
463         auto idbObjectStore = objectStoreForTransaction(idbTransaction.get(), m_objectStoreName);
464         if (!idbObjectStore) {
465             m_requestCallback-&gt;sendFailure(&quot;Could not get object store&quot;);
466             return;
467         }
468 
469         TransactionActivator activator(idbTransaction.get());
470         RefPtr&lt;IDBRequest&gt; idbRequest;
</pre>
<hr />
<pre>
634     RefPtr&lt;IDBKeyRange&gt; idbKeyRange = keyRange ? idbKeyRangeFromKeyRange(keyRange) : nullptr;
635     if (keyRange &amp;&amp; !idbKeyRange) {
636         callback-&gt;sendFailure(&quot;Could not parse key range.&quot;_s);
637         return;
638     }
639 
640     Ref&lt;DataLoader&gt; dataLoader = DataLoader::create(document, WTFMove(callback), injectedScript, objectStoreName, indexName, WTFMove(idbKeyRange), skipCount, pageSize);
641     dataLoader-&gt;start(idbFactory, &amp;document-&gt;securityOrigin(), databaseName);
642 }
643 
644 namespace {
645 
646 class ClearObjectStoreListener final : public EventListener {
647     WTF_MAKE_NONCOPYABLE(ClearObjectStoreListener);
648 public:
649     static Ref&lt;ClearObjectStoreListener&gt; create(Ref&lt;ClearObjectStoreCallback&gt; requestCallback)
650     {
651         return adoptRef(*new ClearObjectStoreListener(WTFMove(requestCallback)));
652     }
653 
<span class="line-modified">654     ~ClearObjectStoreListener() override = default;</span>
655 
656     bool operator==(const EventListener&amp; other) const override
657     {
658         return this == &amp;other;
659     }
660 
661     void handleEvent(ScriptExecutionContext&amp;, Event&amp; event) override
662     {
663         if (!m_requestCallback-&gt;isActive())
664             return;
665         if (event.type() != eventNames().completeEvent) {
666             m_requestCallback-&gt;sendFailure(&quot;Unexpected event type.&quot;);
667             return;
668         }
669 
670         m_requestCallback-&gt;sendSuccess();
671     }
672 private:
673     ClearObjectStoreListener(Ref&lt;ClearObjectStoreCallback&gt;&amp;&amp; requestCallback)
674         : EventListener(EventListener::CPPEventListenerType)
</pre>
</td>
</tr>
</table>
<center><a href="InspectorDatabaseAgent.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="InspectorIndexedDBAgent.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>