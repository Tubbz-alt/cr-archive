<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.web/src/main/native/Source/WebCore/history/CachedFrame.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="BackForwardItemIdentifier.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="CachedFramePlatformData.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/history/CachedFrame.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 24,10 ***</span>
<span class="line-new-header">--- 24,11 ---</span>
   */
  
  #include &quot;config.h&quot;
  #include &quot;CachedFrame.h&quot;
  
<span class="line-added">+ #include &quot;BackForwardCache.h&quot;</span>
  #include &quot;CSSAnimationController.h&quot;
  #include &quot;CachedFramePlatformData.h&quot;
  #include &quot;CachedPage.h&quot;
  #include &quot;CustomHeaderFields.h&quot;
  #include &quot;DOMWindow.h&quot;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 39,17 ***</span>
  #include &quot;FrameLoaderClient.h&quot;
  #include &quot;FrameView.h&quot;
  #include &quot;Logging.h&quot;
  #include &quot;NavigationDisabler.h&quot;
  #include &quot;Page.h&quot;
<span class="line-removed">- #include &quot;PageCache.h&quot;</span>
  #include &quot;RenderWidget.h&quot;
<span class="line-removed">- #include &quot;RuntimeEnabledFeatures.h&quot;</span>
  #include &quot;SVGDocumentExtensions.h&quot;
  #include &quot;ScriptController.h&quot;
  #include &quot;SerializedScriptValue.h&quot;
  #include &quot;StyleTreeResolver.h&quot;
  #include &lt;wtf/RefCountedLeakCounter.h&gt;
  #include &lt;wtf/text/CString.h&gt;
  
  #if PLATFORM(IOS_FAMILY) || ENABLE(TOUCH_EVENTS)
  #include &quot;Chrome.h&quot;
<span class="line-new-header">--- 40,16 ---</span>
  #include &quot;FrameLoaderClient.h&quot;
  #include &quot;FrameView.h&quot;
  #include &quot;Logging.h&quot;
  #include &quot;NavigationDisabler.h&quot;
  #include &quot;Page.h&quot;
  #include &quot;RenderWidget.h&quot;
  #include &quot;SVGDocumentExtensions.h&quot;
  #include &quot;ScriptController.h&quot;
  #include &quot;SerializedScriptValue.h&quot;
  #include &quot;StyleTreeResolver.h&quot;
<span class="line-added">+ #include &quot;WindowEventLoop.h&quot;</span>
  #include &lt;wtf/RefCountedLeakCounter.h&gt;
  #include &lt;wtf/text/CString.h&gt;
  
  #if PLATFORM(IOS_FAMILY) || ENABLE(TOUCH_EVENTS)
  #include &quot;Chrome.h&quot;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 105,17 ***</span>
          m_cachedFrameScriptData-&gt;restore(frame.get());
  
          if (m_document-&gt;svgExtensions())
              m_document-&gt;accessSVGExtensions().unpauseAnimations();
  
<span class="line-modified">!         m_document-&gt;resume(ReasonForSuspension::PageCache);</span>
  
          // It is necessary to update any platform script objects after restoring the
          // cached page.
          frame-&gt;script().updatePlatformScriptObjects();
  
<span class="line-modified">!         frame-&gt;loader().client().didRestoreFromPageCache();</span>
  
          pruneDetachedChildFrames();
  
          // Reconstruct the FrameTree. And open the child CachedFrames in their respective FrameLoaders.
          for (auto&amp; childFrame : m_childFrames) {
<span class="line-new-header">--- 105,17 ---</span>
          m_cachedFrameScriptData-&gt;restore(frame.get());
  
          if (m_document-&gt;svgExtensions())
              m_document-&gt;accessSVGExtensions().unpauseAnimations();
  
<span class="line-modified">!         m_document-&gt;resume(ReasonForSuspension::BackForwardCache);</span>
  
          // It is necessary to update any platform script objects after restoring the
          // cached page.
          frame-&gt;script().updatePlatformScriptObjects();
  
<span class="line-modified">!         frame-&gt;loader().client().didRestoreFromBackForwardCache();</span>
  
          pruneDetachedChildFrames();
  
          // Reconstruct the FrameTree. And open the child CachedFrames in their respective FrameLoaders.
          for (auto&amp; childFrame : m_childFrames) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 137,11 ***</span>
                  frame-&gt;page()-&gt;chrome().client().setNeedsScrollNotifications(frame, true);
          }
      }
  #endif
  
<span class="line-modified">!     frame-&gt;view()-&gt;didRestoreFromPageCache();</span>
  }
  
  CachedFrame::CachedFrame(Frame&amp; frame)
      : CachedFrameBase(frame)
  {
<span class="line-new-header">--- 137,11 ---</span>
                  frame-&gt;page()-&gt;chrome().client().setNeedsScrollNotifications(frame, true);
          }
      }
  #endif
  
<span class="line-modified">!     frame-&gt;view()-&gt;didRestoreFromBackForwardCache();</span>
  }
  
  CachedFrame::CachedFrame(Frame&amp; frame)
      : CachedFrameBase(frame)
  {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 149,11 ***</span>
      cachedFrameCounter.increment();
  #endif
      ASSERT(m_document);
      ASSERT(m_documentLoader);
      ASSERT(m_view);
<span class="line-modified">!     ASSERT(m_document-&gt;pageCacheState() == Document::InPageCache);</span>
  
      RELEASE_ASSERT(m_document-&gt;domWindow());
      RELEASE_ASSERT(m_document-&gt;frame());
      RELEASE_ASSERT(m_document-&gt;domWindow()-&gt;frame());
  
<span class="line-new-header">--- 149,11 ---</span>
      cachedFrameCounter.increment();
  #endif
      ASSERT(m_document);
      ASSERT(m_documentLoader);
      ASSERT(m_view);
<span class="line-modified">!     ASSERT(m_document-&gt;backForwardCacheState() == Document::InBackForwardCache);</span>
  
      RELEASE_ASSERT(m_document-&gt;domWindow());
      RELEASE_ASSERT(m_document-&gt;frame());
      RELEASE_ASSERT(m_document-&gt;domWindow()-&gt;frame());
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 168,42 ***</span>
      RELEASE_ASSERT(m_document-&gt;domWindow());
      RELEASE_ASSERT(m_document-&gt;frame());
      RELEASE_ASSERT(m_document-&gt;domWindow()-&gt;frame());
  
      // Active DOM objects must be suspended before we cache the frame script data.
<span class="line-modified">!     m_document-&gt;suspend(ReasonForSuspension::PageCache);</span>
  
      m_cachedFrameScriptData = makeUnique&lt;ScriptCachedFrameData&gt;(frame);
  
<span class="line-modified">!     m_document-&gt;domWindow()-&gt;suspendForPageCache();</span>
  
      // Clear FrameView to reset flags such as &#39;firstVisuallyNonEmptyLayoutCallbackPending&#39; so that the
<span class="line-modified">!     // &#39;DidFirstVisuallyNonEmptyLayout&#39; callback gets called against when restoring from PageCache.</span>
      m_view-&gt;resetLayoutMilestones();
  
      frame.loader().client().savePlatformDataToCachedFrame(this);
  
<span class="line-modified">!     // documentWillSuspendForPageCache() can set up a layout timer on the FrameView, so clear timers after that.</span>
      frame.clearTimers();
  
      // Deconstruct the FrameTree, to restore it later.
      // We do this for two reasons:
      // 1 - We reuse the main frame, so when it navigates to a new page load it needs to start with a blank FrameTree.
<span class="line-modified">!     // 2 - It&#39;s much easier to destroy a CachedFrame while it resides in the PageCache if it is disconnected from its parent.</span>
      for (unsigned i = 0; i &lt; m_childFrames.size(); ++i)
          frame.tree().removeChild(m_childFrames[i]-&gt;view()-&gt;frame());
  
      if (!m_isMainFrame)
          frame.page()-&gt;decrementSubframeCount();
  
<span class="line-removed">-     frame.loader().client().didSaveToPageCache();</span>
<span class="line-removed">- </span>
  #ifndef NDEBUG
      if (m_isMainFrame)
<span class="line-modified">!         LOG(PageCache, &quot;Finished creating CachedFrame for main frame url &#39;%s&#39; and DocumentLoader %p\n&quot;, m_url.string().utf8().data(), m_documentLoader.get());</span>
      else
<span class="line-modified">!         LOG(PageCache, &quot;Finished creating CachedFrame for child frame with url &#39;%s&#39; and DocumentLoader %p\n&quot;, m_url.string().utf8().data(), m_documentLoader.get());</span>
  #endif
  
  #if PLATFORM(IOS_FAMILY)
      if (m_isMainFrame) {
          if (DOMWindow* domWindow = m_document-&gt;domWindow()) {
<span class="line-new-header">--- 168,44 ---</span>
      RELEASE_ASSERT(m_document-&gt;domWindow());
      RELEASE_ASSERT(m_document-&gt;frame());
      RELEASE_ASSERT(m_document-&gt;domWindow()-&gt;frame());
  
      // Active DOM objects must be suspended before we cache the frame script data.
<span class="line-modified">!     m_document-&gt;suspend(ReasonForSuspension::BackForwardCache);</span>
  
      m_cachedFrameScriptData = makeUnique&lt;ScriptCachedFrameData&gt;(frame);
  
<span class="line-modified">!     m_document-&gt;domWindow()-&gt;suspendForBackForwardCache();</span>
  
      // Clear FrameView to reset flags such as &#39;firstVisuallyNonEmptyLayoutCallbackPending&#39; so that the
<span class="line-modified">!     // &#39;DidFirstVisuallyNonEmptyLayout&#39; callback gets called against when restoring from the BackForwardCache.</span>
      m_view-&gt;resetLayoutMilestones();
  
<span class="line-added">+     // The main frame is reused for the navigation and the opener link to its should thus persist.</span>
<span class="line-added">+     if (!frame.isMainFrame())</span>
<span class="line-added">+         frame.loader().detachFromAllOpenedFrames();</span>
<span class="line-added">+ </span>
      frame.loader().client().savePlatformDataToCachedFrame(this);
  
<span class="line-modified">!     // documentWillSuspendForBackForwardCache() can set up a layout timer on the FrameView, so clear timers after that.</span>
      frame.clearTimers();
  
      // Deconstruct the FrameTree, to restore it later.
      // We do this for two reasons:
      // 1 - We reuse the main frame, so when it navigates to a new page load it needs to start with a blank FrameTree.
<span class="line-modified">!     // 2 - It&#39;s much easier to destroy a CachedFrame while it resides in the BackForwardCache if it is disconnected from its parent.</span>
      for (unsigned i = 0; i &lt; m_childFrames.size(); ++i)
          frame.tree().removeChild(m_childFrames[i]-&gt;view()-&gt;frame());
  
      if (!m_isMainFrame)
          frame.page()-&gt;decrementSubframeCount();
  
  #ifndef NDEBUG
      if (m_isMainFrame)
<span class="line-modified">!         LOG(BackForwardCache, &quot;Finished creating CachedFrame for main frame url &#39;%s&#39; and DocumentLoader %p\n&quot;, m_url.string().utf8().data(), m_documentLoader.get());</span>
      else
<span class="line-modified">!         LOG(BackForwardCache, &quot;Finished creating CachedFrame for child frame with url &#39;%s&#39; and DocumentLoader %p\n&quot;, m_url.string().utf8().data(), m_documentLoader.get());</span>
  #endif
  
  #if PLATFORM(IOS_FAMILY)
      if (m_isMainFrame) {
          if (DOMWindow* domWindow = m_document-&gt;domWindow()) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 232,15 ***</span>
  void CachedFrame::clear()
  {
      if (!m_document)
          return;
  
<span class="line-modified">!     // clear() should only be called for Frames representing documents that are no longer in the page cache.</span>
      // This means the CachedFrame has been:
      // 1 - Successfully restore()&#39;d by going back/forward.
<span class="line-modified">!     // 2 - destroy()&#39;ed because the PageCache is pruning or the WebView was closed.</span>
<span class="line-modified">!     ASSERT(m_document-&gt;pageCacheState() == Document::NotInPageCache);</span>
      ASSERT(m_view);
      ASSERT(!m_document-&gt;frame() || m_document-&gt;frame() == &amp;m_view-&gt;frame());
  
      for (int i = m_childFrames.size() - 1; i &gt;= 0; --i)
          m_childFrames[i]-&gt;clear();
<span class="line-new-header">--- 234,15 ---</span>
  void CachedFrame::clear()
  {
      if (!m_document)
          return;
  
<span class="line-modified">!     // clear() should only be called for Frames representing documents that are no longer in the back/forward cache.</span>
      // This means the CachedFrame has been:
      // 1 - Successfully restore()&#39;d by going back/forward.
<span class="line-modified">!     // 2 - destroy()&#39;ed because the BackForwardCache is pruning or the WebView was closed.</span>
<span class="line-modified">!     ASSERT(m_document-&gt;backForwardCacheState() == Document::NotInBackForwardCache);</span>
      ASSERT(m_view);
      ASSERT(!m_document-&gt;frame() || m_document-&gt;frame() == &amp;m_view-&gt;frame());
  
      for (int i = m_childFrames.size() - 1; i &gt;= 0; --i)
          m_childFrames[i]-&gt;clear();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 256,12 ***</span>
  void CachedFrame::destroy()
  {
      if (!m_document)
          return;
  
<span class="line-modified">!     // Only CachedFrames that are still in the PageCache should be destroyed in this manner</span>
<span class="line-modified">!     ASSERT(m_document-&gt;pageCacheState() == Document::InPageCache);</span>
      ASSERT(m_view);
      ASSERT(!m_document-&gt;frame());
  
      m_document-&gt;domWindow()-&gt;willDestroyCachedFrame();
  
<span class="line-new-header">--- 258,12 ---</span>
  void CachedFrame::destroy()
  {
      if (!m_document)
          return;
  
<span class="line-modified">!     // Only CachedFrames that are still in the BackForwardCache should be destroyed in this manner</span>
<span class="line-modified">!     ASSERT(m_document-&gt;backForwardCacheState() == Document::InBackForwardCache);</span>
      ASSERT(m_view);
      ASSERT(!m_document-&gt;frame());
  
      m_document-&gt;domWindow()-&gt;willDestroyCachedFrame();
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 278,15 ***</span>
  
      Frame::clearTimers(m_view.get(), m_document.get());
  
      m_view-&gt;frame().animation().detachFromDocument(m_document.get());
  
<span class="line-modified">!     // FIXME: Why do we need to call removeAllEventListeners here? When the document is in page cache, this method won&#39;t work</span>
      // fully anyway, because the document won&#39;t be able to access its DOMWindow object (due to being frameless).
      m_document-&gt;removeAllEventListeners();
  
<span class="line-modified">!     m_document-&gt;setPageCacheState(Document::NotInPageCache);</span>
      m_document-&gt;prepareForDestruction();
  
      clear();
  }
  
<span class="line-new-header">--- 280,15 ---</span>
  
      Frame::clearTimers(m_view.get(), m_document.get());
  
      m_view-&gt;frame().animation().detachFromDocument(m_document.get());
  
<span class="line-modified">!     // FIXME: Why do we need to call removeAllEventListeners here? When the document is in back/forward cache, this method won&#39;t work</span>
      // fully anyway, because the document won&#39;t be able to access its DOMWindow object (due to being frameless).
      m_document-&gt;removeAllEventListeners();
  
<span class="line-modified">!     m_document-&gt;setBackForwardCacheState(Document::NotInBackForwardCache);</span>
      m_document-&gt;prepareForDestruction();
  
      clear();
  }
  
</pre>
<center><a href="BackForwardItemIdentifier.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="CachedFramePlatformData.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>