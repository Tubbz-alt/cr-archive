<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/JavaScriptCore/b3/B3ReduceLoopStrength.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="B3ReduceDoubleToFloat.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="B3ReduceStrength.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/JavaScriptCore/b3/B3ReduceLoopStrength.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
128         &quot;501:\t\n&quot;
129         &quot;movups (%q[src], %q[i], 4), %%xmm0\t\n&quot;
130         &quot;movups 16(%q[src], %q[i], 4), %%xmm1\t\n&quot;
131         &quot;movups %%xmm0, (%q[dst], %q[i], 4)\t\n&quot;
132         &quot;movups %%xmm1, 16(%q[dst], %q[i], 4)\t\n&quot;
133         &quot;addq $8, %q[i]\t\n&quot;
134         &quot;incq %q[counter]\t\n&quot;
135         &quot;jnz 501b\t\n&quot;
136         // if (i == size)
137         &quot;cmpq %q[size], %q[i]\t\n&quot;
138         &quot;je 900f\t\n&quot; // end
139         &quot;jmp 100b\t\n&quot; // backporch
140         &quot;900:\t\n&quot;
141     : [i] &quot;=&amp;c&quot; (i), [counter] &quot;=&amp;r&quot; (counter), [tmp] &quot;=&amp;a&quot; (tmp),  [tmp2] &quot;=&amp;r&quot; (tmp2)
142     : [dst] &quot;D&quot; (dst), [src] &quot;S&quot; (src), [size] &quot;r&quot; (size)
143     : &quot;xmm0&quot;, &quot;xmm1&quot;);
144 }
145 #endif
146 
147 class ReduceLoopStrength {
<span class="line-modified">148     static const bool verbose = false;</span>
149 
150     struct AddrInfo {
151         Value* appendAddr(Procedure&amp; proc, BasicBlock* block, Value* addr)
152         {
153             block-&gt;appendNew&lt;Value&gt;(proc, Identity, addr-&gt;origin(), addr);
154             return addr;
155         }
156 
157         Value* insideLoopAddr;
158 
159         Value* arrayBase;
160         Value* index;
161     };
162 
163 public:
164     ReduceLoopStrength(Procedure&amp; proc)
165         : m_proc(proc)
166         , m_insertionSet(proc)
167         , m_blockInsertionSet(proc)
168         , m_root(proc.at(0))
</pre>
<hr />
<pre>
420         }
421 
422         if (!hoistValue(loopPreheader, source-&gt;arrayBase, false)
423             || !hoistValue(loopPreheader, destination-&gt;arrayBase, false)
424             || !hoistValue(loopPreheader, loopBound, false))
425             return;
426 
427         if (verbose)
428             dataLogLn(&quot;Found byte copy loop: &quot;, *source-&gt;arrayBase, &quot;[&quot;, *source-&gt;index, &quot;] = &quot;, *destination-&gt;arrayBase, &quot;[&quot;, *destination-&gt;index, &quot;] from index &quot;, *startingIndex, &quot; to max index &quot;, *loopBound, &quot; stride: &quot;, elemSize);
429 
430         bool hoistResult = hoistValue(loopPreheader, source-&gt;arrayBase);
431         hoistResult &amp;= hoistValue(loopPreheader, destination-&gt;arrayBase);
432         hoistResult &amp;= hoistValue(loopPreheader, loopBound);
433         ASSERT_UNUSED(hoistResult, hoistResult);
434 
435         auto origin = loopPostfooter-&gt;at(0)-&gt;origin();
436 
437         BasicBlock* memcpy = m_blockInsertionSet.insertBefore(loopPostfooter, loopPostfooter-&gt;frequency());
438         memcpy-&gt;setSuccessors(FrequentedBlock(loopPostfooter));
439         memcpy-&gt;addPredecessor(loopPreheader);
<span class="line-modified">440         for (BasicBlock* pred : loopPostfooter-&gt;predecessors())</span>
<span class="line-modified">441             loopPostfooter-&gt;removePredecessor(pred);</span>
442         loopPostfooter-&gt;addPredecessor(memcpy);
443         loopPreheader-&gt;setSuccessors(memcpy);
444 
445         Effects effects = Effects::forCall();
446         memcpy-&gt;appendNew&lt;CCallValue&gt;(m_proc, B3::Void, origin, effects,
447             memcpy-&gt;appendNew&lt;ConstPtrValue&gt;(m_proc, origin, tagCFunctionPtr&lt;void*&gt;(fastForwardCopy32, B3CCallPtrTag)),
448             destination-&gt;appendAddr(m_proc, memcpy, destination-&gt;arrayBase),
449             source-&gt;appendAddr(m_proc, memcpy, source-&gt;arrayBase),
450             loopBound);
451 
452         memcpy-&gt;appendNew&lt;Value&gt;(m_proc, Jump, origin);
453     }
454 
455     bool hoistValue(BasicBlock* into, Value* value, bool canMutate = true)
456     {
457         if (m_proc.dominators().dominates(value-&gt;owner, into))
458             return true;
459 
460         Effects effects = value-&gt;effects();
461         if (effects != Effects::none()) {
</pre>
</td>
<td>
<hr />
<pre>
128         &quot;501:\t\n&quot;
129         &quot;movups (%q[src], %q[i], 4), %%xmm0\t\n&quot;
130         &quot;movups 16(%q[src], %q[i], 4), %%xmm1\t\n&quot;
131         &quot;movups %%xmm0, (%q[dst], %q[i], 4)\t\n&quot;
132         &quot;movups %%xmm1, 16(%q[dst], %q[i], 4)\t\n&quot;
133         &quot;addq $8, %q[i]\t\n&quot;
134         &quot;incq %q[counter]\t\n&quot;
135         &quot;jnz 501b\t\n&quot;
136         // if (i == size)
137         &quot;cmpq %q[size], %q[i]\t\n&quot;
138         &quot;je 900f\t\n&quot; // end
139         &quot;jmp 100b\t\n&quot; // backporch
140         &quot;900:\t\n&quot;
141     : [i] &quot;=&amp;c&quot; (i), [counter] &quot;=&amp;r&quot; (counter), [tmp] &quot;=&amp;a&quot; (tmp),  [tmp2] &quot;=&amp;r&quot; (tmp2)
142     : [dst] &quot;D&quot; (dst), [src] &quot;S&quot; (src), [size] &quot;r&quot; (size)
143     : &quot;xmm0&quot;, &quot;xmm1&quot;);
144 }
145 #endif
146 
147 class ReduceLoopStrength {
<span class="line-modified">148     static constexpr bool verbose = false;</span>
149 
150     struct AddrInfo {
151         Value* appendAddr(Procedure&amp; proc, BasicBlock* block, Value* addr)
152         {
153             block-&gt;appendNew&lt;Value&gt;(proc, Identity, addr-&gt;origin(), addr);
154             return addr;
155         }
156 
157         Value* insideLoopAddr;
158 
159         Value* arrayBase;
160         Value* index;
161     };
162 
163 public:
164     ReduceLoopStrength(Procedure&amp; proc)
165         : m_proc(proc)
166         , m_insertionSet(proc)
167         , m_blockInsertionSet(proc)
168         , m_root(proc.at(0))
</pre>
<hr />
<pre>
420         }
421 
422         if (!hoistValue(loopPreheader, source-&gt;arrayBase, false)
423             || !hoistValue(loopPreheader, destination-&gt;arrayBase, false)
424             || !hoistValue(loopPreheader, loopBound, false))
425             return;
426 
427         if (verbose)
428             dataLogLn(&quot;Found byte copy loop: &quot;, *source-&gt;arrayBase, &quot;[&quot;, *source-&gt;index, &quot;] = &quot;, *destination-&gt;arrayBase, &quot;[&quot;, *destination-&gt;index, &quot;] from index &quot;, *startingIndex, &quot; to max index &quot;, *loopBound, &quot; stride: &quot;, elemSize);
429 
430         bool hoistResult = hoistValue(loopPreheader, source-&gt;arrayBase);
431         hoistResult &amp;= hoistValue(loopPreheader, destination-&gt;arrayBase);
432         hoistResult &amp;= hoistValue(loopPreheader, loopBound);
433         ASSERT_UNUSED(hoistResult, hoistResult);
434 
435         auto origin = loopPostfooter-&gt;at(0)-&gt;origin();
436 
437         BasicBlock* memcpy = m_blockInsertionSet.insertBefore(loopPostfooter, loopPostfooter-&gt;frequency());
438         memcpy-&gt;setSuccessors(FrequentedBlock(loopPostfooter));
439         memcpy-&gt;addPredecessor(loopPreheader);
<span class="line-modified">440         while (loopPostfooter-&gt;predecessors().size())</span>
<span class="line-modified">441             loopPostfooter-&gt;removePredecessor(loopPostfooter-&gt;predecessors()[0]);</span>
442         loopPostfooter-&gt;addPredecessor(memcpy);
443         loopPreheader-&gt;setSuccessors(memcpy);
444 
445         Effects effects = Effects::forCall();
446         memcpy-&gt;appendNew&lt;CCallValue&gt;(m_proc, B3::Void, origin, effects,
447             memcpy-&gt;appendNew&lt;ConstPtrValue&gt;(m_proc, origin, tagCFunctionPtr&lt;void*&gt;(fastForwardCopy32, B3CCallPtrTag)),
448             destination-&gt;appendAddr(m_proc, memcpy, destination-&gt;arrayBase),
449             source-&gt;appendAddr(m_proc, memcpy, source-&gt;arrayBase),
450             loopBound);
451 
452         memcpy-&gt;appendNew&lt;Value&gt;(m_proc, Jump, origin);
453     }
454 
455     bool hoistValue(BasicBlock* into, Value* value, bool canMutate = true)
456     {
457         if (m_proc.dominators().dominates(value-&gt;owner, into))
458             return true;
459 
460         Effects effects = value-&gt;effects();
461         if (effects != Effects::none()) {
</pre>
</td>
</tr>
</table>
<center><a href="B3ReduceDoubleToFloat.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="B3ReduceStrength.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>