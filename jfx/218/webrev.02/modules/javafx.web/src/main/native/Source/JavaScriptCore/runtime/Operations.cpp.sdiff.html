<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/JavaScriptCore/runtime/Operations.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="ObjectPrototype.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="Operations.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/JavaScriptCore/runtime/Operations.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 14  *
 15  *  You should have received a copy of the GNU Library General Public License
 16  *  along with this library; see the file COPYING.LIB.  If not, write to
 17  *  the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
 18  *  Boston, MA 02110-1301, USA.
 19  *
 20  */
 21 
 22 #include &quot;config.h&quot;
 23 #include &quot;Operations.h&quot;
 24 
 25 #include &quot;Error.h&quot;
 26 #include &quot;JSBigInt.h&quot;
 27 #include &quot;JSCInlines.h&quot;
 28 #include &quot;JSObject.h&quot;
 29 #include &quot;JSString.h&quot;
 30 #include &lt;wtf/MathExtras.h&gt;
 31 
 32 namespace JSC {
 33 
<span class="line-modified"> 34 bool JSValue::equalSlowCase(ExecState* exec, JSValue v1, JSValue v2)</span>
 35 {
<span class="line-modified"> 36     return equalSlowCaseInline(exec, v1, v2);</span>
 37 }
 38 
<span class="line-modified"> 39 bool JSValue::strictEqualSlowCase(ExecState* exec, JSValue v1, JSValue v2)</span>
 40 {
<span class="line-modified"> 41     return strictEqualSlowCaseInline(exec, v1, v2);</span>
 42 }
 43 
<span class="line-modified"> 44 NEVER_INLINE JSValue jsAddSlowCase(CallFrame* callFrame, JSValue v1, JSValue v2)</span>
 45 {
 46     // exception for the Date exception in defaultValue()
<span class="line-modified"> 47     VM&amp; vm = callFrame-&gt;vm();</span>
 48     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified"> 49     JSValue p1 = v1.toPrimitive(callFrame);</span>
 50     RETURN_IF_EXCEPTION(scope, { });
<span class="line-modified"> 51     JSValue p2 = v2.toPrimitive(callFrame);</span>
 52     RETURN_IF_EXCEPTION(scope, { });
 53 
 54     if (p1.isString()) {
 55         if (p2.isCell()) {
<span class="line-modified"> 56             JSString* p2String = p2.toString(callFrame);</span>
 57             RETURN_IF_EXCEPTION(scope, { });
<span class="line-modified"> 58             RELEASE_AND_RETURN(scope, jsString(callFrame, asString(p1), p2String));</span>
 59         }
<span class="line-modified"> 60         String p2String = p2.toWTFString(callFrame);</span>
 61         RETURN_IF_EXCEPTION(scope, { });
<span class="line-modified"> 62         RELEASE_AND_RETURN(scope, jsString(callFrame, asString(p1), p2String));</span>
 63     }
 64 
 65     if (p2.isString()) {
 66         if (p1.isCell()) {
<span class="line-modified"> 67             JSString* p1String = p1.toString(callFrame);</span>
 68             RETURN_IF_EXCEPTION(scope, { });
<span class="line-modified"> 69             RELEASE_AND_RETURN(scope, jsString(callFrame, p1String, asString(p2)));</span>
 70         }
<span class="line-modified"> 71         String p1String = p1.toWTFString(callFrame);</span>
 72         RETURN_IF_EXCEPTION(scope, { });
<span class="line-modified"> 73         RELEASE_AND_RETURN(scope, jsString(callFrame, p1String, asString(p2)));</span>
 74     }
 75 
<span class="line-modified"> 76     auto leftNumeric = p1.toNumeric(callFrame);</span>
 77     RETURN_IF_EXCEPTION(scope, { });
<span class="line-modified"> 78     auto rightNumeric = p2.toNumeric(callFrame);</span>
 79     RETURN_IF_EXCEPTION(scope, { });
 80 
 81     if (WTF::holds_alternative&lt;JSBigInt*&gt;(leftNumeric) || WTF::holds_alternative&lt;JSBigInt*&gt;(rightNumeric)) {
 82         if (WTF::holds_alternative&lt;JSBigInt*&gt;(leftNumeric) &amp;&amp; WTF::holds_alternative&lt;JSBigInt*&gt;(rightNumeric)) {
 83             scope.release();
<span class="line-modified"> 84             return JSBigInt::add(callFrame, WTF::get&lt;JSBigInt*&gt;(leftNumeric), WTF::get&lt;JSBigInt*&gt;(rightNumeric));</span>
 85         }
 86 
<span class="line-modified"> 87         return throwTypeError(callFrame, scope, &quot;Invalid mix of BigInt and other type in addition.&quot;_s);</span>
 88     }
 89 
 90     return jsNumber(WTF::get&lt;double&gt;(leftNumeric) + WTF::get&lt;double&gt;(rightNumeric));
 91 }
 92 
 93 JSValue jsTypeStringForValue(VM&amp; vm, JSGlobalObject* globalObject, JSValue v)
 94 {
 95     if (v.isUndefined())
 96         return vm.smallStrings.undefinedString();
 97     if (v.isBoolean())
 98         return vm.smallStrings.booleanString();
 99     if (v.isNumber())
100         return vm.smallStrings.numberString();
101     if (v.isString())
102         return vm.smallStrings.stringString();
103     if (v.isSymbol())
104         return vm.smallStrings.symbolString();
105     if (v.isBigInt())
106         return vm.smallStrings.bigintString();
107     if (v.isObject()) {
108         JSObject* object = asObject(v);
109         // Return &quot;undefined&quot; for objects that should be treated
110         // as null when doing comparisons.
111         if (object-&gt;structure(vm)-&gt;masqueradesAsUndefined(globalObject))
112             return vm.smallStrings.undefinedString();
113         if (object-&gt;isFunction(vm))
114             return vm.smallStrings.functionString();
115     }
116     return vm.smallStrings.objectString();
117 }
118 
<span class="line-modified">119 JSValue jsTypeStringForValue(CallFrame* callFrame, JSValue v)</span>
120 {
<span class="line-modified">121     return jsTypeStringForValue(callFrame-&gt;vm(), callFrame-&gt;lexicalGlobalObject(), v);</span>
122 }
123 
<span class="line-modified">124 bool jsIsObjectTypeOrNull(CallFrame* callFrame, JSValue v)</span>
125 {
<span class="line-modified">126     VM&amp; vm = callFrame-&gt;vm();</span>
127     if (!v.isCell())
128         return v.isNull();
129 
130     JSType type = v.asCell()-&gt;type();
131     if (type == StringType || type == SymbolType || type == BigIntType)
132         return false;
133     if (type &gt;= ObjectType) {
<span class="line-modified">134         if (asObject(v)-&gt;structure(vm)-&gt;masqueradesAsUndefined(callFrame-&gt;lexicalGlobalObject()))</span>
135             return false;
136         JSObject* object = asObject(v);
137         if (object-&gt;isFunction(vm))
138             return false;
139     }
140     return true;
141 }
142 
<span class="line-modified">143 size_t normalizePrototypeChain(CallFrame* callFrame, JSCell* base, bool&amp; sawPolyProto)</span>
144 {
<span class="line-modified">145     VM&amp; vm = callFrame-&gt;vm();</span>
146     size_t count = 0;
147     sawPolyProto = false;
148     JSCell* current = base;
<span class="line-removed">149     JSGlobalObject* globalObject = callFrame-&gt;lexicalGlobalObject();</span>
150     while (1) {
151         Structure* structure = current-&gt;structure(vm);
152         if (structure-&gt;isProxy())
153             return InvalidPrototypeChain;
154 
155         sawPolyProto |= structure-&gt;hasPolyProto();
156 
157         JSValue prototype = structure-&gt;prototypeForLookup(globalObject, current);
158         if (prototype.isNull())
159             return count;
160 
161         current = prototype.asCell();
162         structure = current-&gt;structure(vm);
163         if (structure-&gt;isDictionary()) {
164             if (structure-&gt;hasBeenFlattenedBefore())
165                 return InvalidPrototypeChain;
166             structure-&gt;flattenDictionaryStructure(vm, asObject(current));
167         }
168 
169         ++count;
</pre>
</td>
<td>
<hr />
<pre>
 14  *
 15  *  You should have received a copy of the GNU Library General Public License
 16  *  along with this library; see the file COPYING.LIB.  If not, write to
 17  *  the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
 18  *  Boston, MA 02110-1301, USA.
 19  *
 20  */
 21 
 22 #include &quot;config.h&quot;
 23 #include &quot;Operations.h&quot;
 24 
 25 #include &quot;Error.h&quot;
 26 #include &quot;JSBigInt.h&quot;
 27 #include &quot;JSCInlines.h&quot;
 28 #include &quot;JSObject.h&quot;
 29 #include &quot;JSString.h&quot;
 30 #include &lt;wtf/MathExtras.h&gt;
 31 
 32 namespace JSC {
 33 
<span class="line-modified"> 34 bool JSValue::equalSlowCase(JSGlobalObject* globalObject, JSValue v1, JSValue v2)</span>
 35 {
<span class="line-modified"> 36     return equalSlowCaseInline(globalObject, v1, v2);</span>
 37 }
 38 
<span class="line-modified"> 39 bool JSValue::strictEqualSlowCase(JSGlobalObject* globalObject, JSValue v1, JSValue v2)</span>
 40 {
<span class="line-modified"> 41     return strictEqualSlowCaseInline(globalObject, v1, v2);</span>
 42 }
 43 
<span class="line-modified"> 44 NEVER_INLINE JSValue jsAddSlowCase(JSGlobalObject* globalObject, JSValue v1, JSValue v2)</span>
 45 {
 46     // exception for the Date exception in defaultValue()
<span class="line-modified"> 47     VM&amp; vm = globalObject-&gt;vm();</span>
 48     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified"> 49     JSValue p1 = v1.toPrimitive(globalObject);</span>
 50     RETURN_IF_EXCEPTION(scope, { });
<span class="line-modified"> 51     JSValue p2 = v2.toPrimitive(globalObject);</span>
 52     RETURN_IF_EXCEPTION(scope, { });
 53 
 54     if (p1.isString()) {
 55         if (p2.isCell()) {
<span class="line-modified"> 56             JSString* p2String = p2.toString(globalObject);</span>
 57             RETURN_IF_EXCEPTION(scope, { });
<span class="line-modified"> 58             RELEASE_AND_RETURN(scope, jsString(globalObject, asString(p1), p2String));</span>
 59         }
<span class="line-modified"> 60         String p2String = p2.toWTFString(globalObject);</span>
 61         RETURN_IF_EXCEPTION(scope, { });
<span class="line-modified"> 62         RELEASE_AND_RETURN(scope, jsString(globalObject, asString(p1), p2String));</span>
 63     }
 64 
 65     if (p2.isString()) {
 66         if (p1.isCell()) {
<span class="line-modified"> 67             JSString* p1String = p1.toString(globalObject);</span>
 68             RETURN_IF_EXCEPTION(scope, { });
<span class="line-modified"> 69             RELEASE_AND_RETURN(scope, jsString(globalObject, p1String, asString(p2)));</span>
 70         }
<span class="line-modified"> 71         String p1String = p1.toWTFString(globalObject);</span>
 72         RETURN_IF_EXCEPTION(scope, { });
<span class="line-modified"> 73         RELEASE_AND_RETURN(scope, jsString(globalObject, p1String, asString(p2)));</span>
 74     }
 75 
<span class="line-modified"> 76     auto leftNumeric = p1.toNumeric(globalObject);</span>
 77     RETURN_IF_EXCEPTION(scope, { });
<span class="line-modified"> 78     auto rightNumeric = p2.toNumeric(globalObject);</span>
 79     RETURN_IF_EXCEPTION(scope, { });
 80 
 81     if (WTF::holds_alternative&lt;JSBigInt*&gt;(leftNumeric) || WTF::holds_alternative&lt;JSBigInt*&gt;(rightNumeric)) {
 82         if (WTF::holds_alternative&lt;JSBigInt*&gt;(leftNumeric) &amp;&amp; WTF::holds_alternative&lt;JSBigInt*&gt;(rightNumeric)) {
 83             scope.release();
<span class="line-modified"> 84             return JSBigInt::add(globalObject, WTF::get&lt;JSBigInt*&gt;(leftNumeric), WTF::get&lt;JSBigInt*&gt;(rightNumeric));</span>
 85         }
 86 
<span class="line-modified"> 87         return throwTypeError(globalObject, scope, &quot;Invalid mix of BigInt and other type in addition.&quot;_s);</span>
 88     }
 89 
 90     return jsNumber(WTF::get&lt;double&gt;(leftNumeric) + WTF::get&lt;double&gt;(rightNumeric));
 91 }
 92 
 93 JSValue jsTypeStringForValue(VM&amp; vm, JSGlobalObject* globalObject, JSValue v)
 94 {
 95     if (v.isUndefined())
 96         return vm.smallStrings.undefinedString();
 97     if (v.isBoolean())
 98         return vm.smallStrings.booleanString();
 99     if (v.isNumber())
100         return vm.smallStrings.numberString();
101     if (v.isString())
102         return vm.smallStrings.stringString();
103     if (v.isSymbol())
104         return vm.smallStrings.symbolString();
105     if (v.isBigInt())
106         return vm.smallStrings.bigintString();
107     if (v.isObject()) {
108         JSObject* object = asObject(v);
109         // Return &quot;undefined&quot; for objects that should be treated
110         // as null when doing comparisons.
111         if (object-&gt;structure(vm)-&gt;masqueradesAsUndefined(globalObject))
112             return vm.smallStrings.undefinedString();
113         if (object-&gt;isFunction(vm))
114             return vm.smallStrings.functionString();
115     }
116     return vm.smallStrings.objectString();
117 }
118 
<span class="line-modified">119 JSValue jsTypeStringForValue(JSGlobalObject* globalObject, JSValue v)</span>
120 {
<span class="line-modified">121     return jsTypeStringForValue(globalObject-&gt;vm(), globalObject, v);</span>
122 }
123 
<span class="line-modified">124 bool jsIsObjectTypeOrNull(JSGlobalObject* globalObject, JSValue v)</span>
125 {
<span class="line-modified">126     VM&amp; vm = globalObject-&gt;vm();</span>
127     if (!v.isCell())
128         return v.isNull();
129 
130     JSType type = v.asCell()-&gt;type();
131     if (type == StringType || type == SymbolType || type == BigIntType)
132         return false;
133     if (type &gt;= ObjectType) {
<span class="line-modified">134         if (asObject(v)-&gt;structure(vm)-&gt;masqueradesAsUndefined(globalObject))</span>
135             return false;
136         JSObject* object = asObject(v);
137         if (object-&gt;isFunction(vm))
138             return false;
139     }
140     return true;
141 }
142 
<span class="line-modified">143 size_t normalizePrototypeChain(JSGlobalObject* globalObject, JSCell* base, bool&amp; sawPolyProto)</span>
144 {
<span class="line-modified">145     VM&amp; vm = globalObject-&gt;vm();</span>
146     size_t count = 0;
147     sawPolyProto = false;
148     JSCell* current = base;

149     while (1) {
150         Structure* structure = current-&gt;structure(vm);
151         if (structure-&gt;isProxy())
152             return InvalidPrototypeChain;
153 
154         sawPolyProto |= structure-&gt;hasPolyProto();
155 
156         JSValue prototype = structure-&gt;prototypeForLookup(globalObject, current);
157         if (prototype.isNull())
158             return count;
159 
160         current = prototype.asCell();
161         structure = current-&gt;structure(vm);
162         if (structure-&gt;isDictionary()) {
163             if (structure-&gt;hasBeenFlattenedBefore())
164                 return InvalidPrototypeChain;
165             structure-&gt;flattenDictionaryStructure(vm, asObject(current));
166         }
167 
168         ++count;
</pre>
</td>
</tr>
</table>
<center><a href="ObjectPrototype.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="Operations.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>