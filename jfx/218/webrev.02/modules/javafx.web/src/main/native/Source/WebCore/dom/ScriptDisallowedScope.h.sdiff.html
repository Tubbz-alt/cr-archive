<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WebCore/dom/ScriptDisallowedScope.h</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="RejectedPromiseTracker.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="ScriptElement.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/dom/ScriptDisallowedScope.h</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 67 
 68     class InMainThread {
 69     public:
 70         InMainThread()
 71         {
 72             ASSERT(isMainThread());
 73             ++s_count;
 74         }
 75 
 76         ~InMainThread()
 77         {
 78             ASSERT(isMainThread());
 79             ASSERT(s_count);
 80             --s_count;
 81         }
 82 
 83         // Don&#39;t enable this assertion in release since it&#39;s O(n).
 84         // Release asserts in canExecuteScript should be sufficient for security defense purposes.
 85         static bool isEventDispatchAllowedInSubtree(Node&amp; node)
 86         {
<span class="line-modified"> 87 #if !ASSERT_DISABLED || ENABLE(SECURITY_ASSERTIONS)</span>
 88             return isScriptAllowed() || EventAllowedScope::isAllowedNode(node);
 89 #else
 90             UNUSED_PARAM(node);
 91             return true;
 92 #endif
 93         }
 94 
 95         static bool hasDisallowedScope()
 96         {
 97             ASSERT(isMainThread());
 98             return s_count;
 99         }
100 
101         static bool isScriptAllowed()
102         {
103             ASSERT(isMainThread());
104 #if PLATFORM(IOS_FAMILY)
105             return !s_count || webThreadDelegateMessageScopeCount;
106 #else
107             return !s_count;
108 #endif
109         }
110     };
111 
<span class="line-modified">112 #if !ASSERT_DISABLED</span>
113     class EventAllowedScope {
114     public:
115         explicit EventAllowedScope(ContainerNode&amp; userAgentContentRoot)
116             : m_eventAllowedTreeRoot(userAgentContentRoot)
117             , m_previousScope(s_currentScope)
118         {
119             s_currentScope = this;
120         }
121 
122         ~EventAllowedScope()
123         {
124             s_currentScope = m_previousScope;
125         }
126 
127         static bool isAllowedNode(Node&amp; node)
128         {
129             return s_currentScope &amp;&amp; s_currentScope-&gt;isAllowedNodeInternal(node);
130         }
131 
132     private:
133         bool isAllowedNodeInternal(Node&amp; node)
134         {
135             return m_eventAllowedTreeRoot-&gt;contains(&amp;node) || (m_previousScope &amp;&amp; m_previousScope-&gt;isAllowedNodeInternal(node));
136         }
137 
138         Ref&lt;ContainerNode&gt; m_eventAllowedTreeRoot;
139 
140         EventAllowedScope* m_previousScope;
141         static EventAllowedScope* s_currentScope;
142     };
<span class="line-modified">143 #else</span>
144     class EventAllowedScope {
145     public:
146         explicit EventAllowedScope(ContainerNode&amp;) { }
147         static bool isAllowedNode(Node&amp;) { return true; }
148     };
<span class="line-modified">149 #endif</span>
150 
151     // FIXME: Remove this class once the sync layout inside SVGImage::draw is removed,
152     // CachedSVGFont::ensureCustomFontData no longer synchronously creates a document during style resolution,
153     // and refactored the code in RenderFrameBase::performLayoutWithFlattening.
154     class DisableAssertionsInScope {
155     public:
156         DisableAssertionsInScope()
157         {
158             ASSERT(isMainThread());
159             std::swap(s_count, m_originalCount);
160         }
161 
162         ~DisableAssertionsInScope()
163         {
164             s_count = m_originalCount;
165         }
166     private:
167         unsigned m_originalCount { 0 };
168     };
169 
</pre>
</td>
<td>
<hr />
<pre>
 67 
 68     class InMainThread {
 69     public:
 70         InMainThread()
 71         {
 72             ASSERT(isMainThread());
 73             ++s_count;
 74         }
 75 
 76         ~InMainThread()
 77         {
 78             ASSERT(isMainThread());
 79             ASSERT(s_count);
 80             --s_count;
 81         }
 82 
 83         // Don&#39;t enable this assertion in release since it&#39;s O(n).
 84         // Release asserts in canExecuteScript should be sufficient for security defense purposes.
 85         static bool isEventDispatchAllowedInSubtree(Node&amp; node)
 86         {
<span class="line-modified"> 87 #if ASSERT_ENABLED || ENABLE(SECURITY_ASSERTIONS)</span>
 88             return isScriptAllowed() || EventAllowedScope::isAllowedNode(node);
 89 #else
 90             UNUSED_PARAM(node);
 91             return true;
 92 #endif
 93         }
 94 
 95         static bool hasDisallowedScope()
 96         {
 97             ASSERT(isMainThread());
 98             return s_count;
 99         }
100 
101         static bool isScriptAllowed()
102         {
103             ASSERT(isMainThread());
104 #if PLATFORM(IOS_FAMILY)
105             return !s_count || webThreadDelegateMessageScopeCount;
106 #else
107             return !s_count;
108 #endif
109         }
110     };
111 
<span class="line-modified">112 #if ASSERT_ENABLED</span>
113     class EventAllowedScope {
114     public:
115         explicit EventAllowedScope(ContainerNode&amp; userAgentContentRoot)
116             : m_eventAllowedTreeRoot(userAgentContentRoot)
117             , m_previousScope(s_currentScope)
118         {
119             s_currentScope = this;
120         }
121 
122         ~EventAllowedScope()
123         {
124             s_currentScope = m_previousScope;
125         }
126 
127         static bool isAllowedNode(Node&amp; node)
128         {
129             return s_currentScope &amp;&amp; s_currentScope-&gt;isAllowedNodeInternal(node);
130         }
131 
132     private:
133         bool isAllowedNodeInternal(Node&amp; node)
134         {
135             return m_eventAllowedTreeRoot-&gt;contains(&amp;node) || (m_previousScope &amp;&amp; m_previousScope-&gt;isAllowedNodeInternal(node));
136         }
137 
138         Ref&lt;ContainerNode&gt; m_eventAllowedTreeRoot;
139 
140         EventAllowedScope* m_previousScope;
141         static EventAllowedScope* s_currentScope;
142     };
<span class="line-modified">143 #else // not ASSERT_ENABLED</span>
144     class EventAllowedScope {
145     public:
146         explicit EventAllowedScope(ContainerNode&amp;) { }
147         static bool isAllowedNode(Node&amp;) { return true; }
148     };
<span class="line-modified">149 #endif // not ASSERT_ENABLED</span>
150 
151     // FIXME: Remove this class once the sync layout inside SVGImage::draw is removed,
152     // CachedSVGFont::ensureCustomFontData no longer synchronously creates a document during style resolution,
153     // and refactored the code in RenderFrameBase::performLayoutWithFlattening.
154     class DisableAssertionsInScope {
155     public:
156         DisableAssertionsInScope()
157         {
158             ASSERT(isMainThread());
159             std::swap(s_count, m_originalCount);
160         }
161 
162         ~DisableAssertionsInScope()
163         {
164             s_count = m_originalCount;
165         }
166     private:
167         unsigned m_originalCount { 0 };
168     };
169 
</pre>
</td>
</tr>
</table>
<center><a href="RejectedPromiseTracker.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="ScriptElement.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>