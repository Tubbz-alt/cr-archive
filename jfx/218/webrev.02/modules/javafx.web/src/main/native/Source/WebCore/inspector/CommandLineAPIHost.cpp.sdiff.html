<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WebCore/inspector/CommandLineAPIHost.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../html/track/WebVTTParser.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="CommandLineAPIHost.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/inspector/CommandLineAPIHost.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 25  * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
 26  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 27  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
 28  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 29  */
 30 
 31 #include &quot;config.h&quot;
 32 #include &quot;CommandLineAPIHost.h&quot;
 33 
 34 #include &quot;Database.h&quot;
 35 #include &quot;Document.h&quot;
 36 #include &quot;EventTarget.h&quot;
 37 #include &quot;InspectorDOMStorageAgent.h&quot;
 38 #include &quot;InspectorDatabaseAgent.h&quot;
 39 #include &quot;JSCommandLineAPIHost.h&quot;
 40 #include &quot;JSDOMGlobalObject.h&quot;
 41 #include &quot;JSEventListener.h&quot;
 42 #include &quot;Pasteboard.h&quot;
 43 #include &quot;Storage.h&quot;
 44 #include &quot;WebConsoleAgent.h&quot;

 45 #include &lt;JavaScriptCore/InspectorAgent.h&gt;
 46 #include &lt;JavaScriptCore/JSCInlines.h&gt;
 47 #include &lt;JavaScriptCore/JSLock.h&gt;
 48 #include &lt;JavaScriptCore/ScriptValue.h&gt;
 49 #include &lt;wtf/JSONValues.h&gt;
 50 #include &lt;wtf/RefPtr.h&gt;
 51 #include &lt;wtf/StdLibExtras.h&gt;
 52 
 53 namespace WebCore {
 54 
 55 using namespace JSC;
 56 using namespace Inspector;
 57 
 58 Ref&lt;CommandLineAPIHost&gt; CommandLineAPIHost::create()
 59 {
 60     return adoptRef(*new CommandLineAPIHost);
 61 }
 62 
 63 CommandLineAPIHost::CommandLineAPIHost()
 64     : m_inspectedObject(makeUnique&lt;InspectableObject&gt;())
 65 {
 66 }
 67 
 68 CommandLineAPIHost::~CommandLineAPIHost() = default;
 69 
 70 void CommandLineAPIHost::disconnect()
 71 {
 72 
 73     m_instrumentingAgents = nullptr;
 74 }
 75 
<span class="line-modified"> 76 void CommandLineAPIHost::inspect(JSC::ExecState&amp; state, JSC::JSValue valueToInspect, JSC::JSValue hintsValue)</span>
 77 {
 78     if (!m_instrumentingAgents)
 79         return;
 80 
 81     auto* inspectorAgent = m_instrumentingAgents-&gt;inspectorAgent();
 82     if (!inspectorAgent)
 83         return;
 84 
 85     RefPtr&lt;JSON::Object&gt; hintsObject;
<span class="line-modified"> 86     if (!Inspector::toInspectorValue(state, hintsValue)-&gt;asObject(hintsObject))</span>
 87         return;
 88 
<span class="line-modified"> 89     auto remoteObject = BindingTraits&lt;Inspector::Protocol::Runtime::RemoteObject&gt;::runtimeCast(Inspector::toInspectorValue(state, valueToInspect));</span>
 90     inspectorAgent-&gt;inspect(WTFMove(remoteObject), WTFMove(hintsObject));
 91 }
 92 
<span class="line-modified"> 93 CommandLineAPIHost::EventListenersRecord CommandLineAPIHost::getEventListeners(ExecState&amp; state, EventTarget&amp; target)</span>
 94 {
 95     auto* scriptExecutionContext = target.scriptExecutionContext();
 96     if (!scriptExecutionContext)
 97         return { };
 98 
 99     EventListenersRecord result;
100 
<span class="line-modified">101     VM&amp; vm = state.vm();</span>
102 
103     for (auto&amp; eventType : target.eventTypes()) {
104         Vector&lt;CommandLineAPIHost::ListenerEntry&gt; entries;
105 
106         for (auto&amp; eventListener : target.eventListeners(eventType)) {
107             if (!is&lt;JSEventListener&gt;(eventListener-&gt;callback()))
108                 continue;
109 
110             auto&amp; jsListener = downcast&lt;JSEventListener&gt;(eventListener-&gt;callback());
111 
112             // Hide listeners from other contexts.
<span class="line-modified">113             if (&amp;jsListener.isolatedWorld() != &amp;currentWorld(state))</span>
114                 continue;
115 
116             auto* function = jsListener.jsFunction(*scriptExecutionContext);
117             if (!function)
118                 continue;
119 
120             entries.append({ Strong&lt;JSObject&gt;(vm, function), eventListener-&gt;useCapture(), eventListener-&gt;isPassive(), eventListener-&gt;isOnce() });
121         }
122 
123         if (!entries.isEmpty())
124             result.append({ eventType, WTFMove(entries) });
125     }
126 
127     return result;
128 }
129 
130 void CommandLineAPIHost::clearConsoleMessages()
131 {
132     if (!m_instrumentingAgents)
133         return;
134 
135     auto* consoleAgent = m_instrumentingAgents-&gt;webConsoleAgent();
136     if (!consoleAgent)
137         return;
138 
139     ErrorString ignored;
140     consoleAgent-&gt;clearMessages(ignored);
141 }
142 
143 void CommandLineAPIHost::copyText(const String&amp; text)
144 {
145     Pasteboard::createForCopyAndPaste()-&gt;writePlainText(text, Pasteboard::CannotSmartReplace);
146 }
147 
<span class="line-modified">148 JSC::JSValue CommandLineAPIHost::InspectableObject::get(JSC::ExecState&amp;)</span>
149 {
150     return { };
151 }
152 
153 void CommandLineAPIHost::addInspectedObject(std::unique_ptr&lt;CommandLineAPIHost::InspectableObject&gt; object)
154 {
155     m_inspectedObject = WTFMove(object);
156 }
157 
<span class="line-modified">158 JSC::JSValue CommandLineAPIHost::inspectedObject(JSC::ExecState&amp; state)</span>
159 {
160     if (!m_inspectedObject)
161         return jsUndefined();
162 
<span class="line-modified">163     JSC::JSLockHolder lock(&amp;state);</span>
<span class="line-modified">164     auto scriptValue = m_inspectedObject-&gt;get(state);</span>
165     return scriptValue ? scriptValue : jsUndefined();
166 }
167 
168 String CommandLineAPIHost::databaseId(Database&amp; database)
169 {
170     if (m_instrumentingAgents) {
171         if (auto* databaseAgent = m_instrumentingAgents-&gt;inspectorDatabaseAgent())
172             return databaseAgent-&gt;databaseId(database);
173     }
174     return { };
175 }
176 
177 String CommandLineAPIHost::storageId(Storage&amp; storage)
178 {
179     return InspectorDOMStorageAgent::storageId(storage);
180 }
181 
<span class="line-modified">182 JSValue CommandLineAPIHost::wrapper(ExecState* exec, JSDOMGlobalObject* globalObject)</span>
183 {
184     JSValue value = m_wrappers.getWrapper(globalObject);
185     if (value)
186         return value;
187 
188     JSObject* prototype = JSCommandLineAPIHost::createPrototype(exec-&gt;vm(), *globalObject);
189     Structure* structure = JSCommandLineAPIHost::createStructure(exec-&gt;vm(), globalObject, prototype);
190     JSCommandLineAPIHost* commandLineAPIHost = JSCommandLineAPIHost::create(structure, globalObject, makeRef(*this));
191     m_wrappers.addWrapper(globalObject, commandLineAPIHost);
192 
193     return commandLineAPIHost;
194 }
195 
196 void CommandLineAPIHost::clearAllWrappers()
197 {
198     m_wrappers.clearAllWrappers();
199     m_inspectedObject = makeUnique&lt;InspectableObject&gt;();
200 }
201 
202 } // namespace WebCore
</pre>
</td>
<td>
<hr />
<pre>
 25  * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
 26  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 27  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
 28  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 29  */
 30 
 31 #include &quot;config.h&quot;
 32 #include &quot;CommandLineAPIHost.h&quot;
 33 
 34 #include &quot;Database.h&quot;
 35 #include &quot;Document.h&quot;
 36 #include &quot;EventTarget.h&quot;
 37 #include &quot;InspectorDOMStorageAgent.h&quot;
 38 #include &quot;InspectorDatabaseAgent.h&quot;
 39 #include &quot;JSCommandLineAPIHost.h&quot;
 40 #include &quot;JSDOMGlobalObject.h&quot;
 41 #include &quot;JSEventListener.h&quot;
 42 #include &quot;Pasteboard.h&quot;
 43 #include &quot;Storage.h&quot;
 44 #include &quot;WebConsoleAgent.h&quot;
<span class="line-added"> 45 #include &lt;JavaScriptCore/ConsoleMessage.h&gt;</span>
 46 #include &lt;JavaScriptCore/InspectorAgent.h&gt;
 47 #include &lt;JavaScriptCore/JSCInlines.h&gt;
 48 #include &lt;JavaScriptCore/JSLock.h&gt;
 49 #include &lt;JavaScriptCore/ScriptValue.h&gt;
 50 #include &lt;wtf/JSONValues.h&gt;
 51 #include &lt;wtf/RefPtr.h&gt;
 52 #include &lt;wtf/StdLibExtras.h&gt;
 53 
 54 namespace WebCore {
 55 
 56 using namespace JSC;
 57 using namespace Inspector;
 58 
 59 Ref&lt;CommandLineAPIHost&gt; CommandLineAPIHost::create()
 60 {
 61     return adoptRef(*new CommandLineAPIHost);
 62 }
 63 
 64 CommandLineAPIHost::CommandLineAPIHost()
 65     : m_inspectedObject(makeUnique&lt;InspectableObject&gt;())
 66 {
 67 }
 68 
 69 CommandLineAPIHost::~CommandLineAPIHost() = default;
 70 
 71 void CommandLineAPIHost::disconnect()
 72 {
 73 
 74     m_instrumentingAgents = nullptr;
 75 }
 76 
<span class="line-modified"> 77 void CommandLineAPIHost::inspect(JSC::JSGlobalObject&amp; lexicalGlobalObject, JSC::JSValue valueToInspect, JSC::JSValue hintsValue)</span>
 78 {
 79     if (!m_instrumentingAgents)
 80         return;
 81 
 82     auto* inspectorAgent = m_instrumentingAgents-&gt;inspectorAgent();
 83     if (!inspectorAgent)
 84         return;
 85 
 86     RefPtr&lt;JSON::Object&gt; hintsObject;
<span class="line-modified"> 87     if (!Inspector::toInspectorValue(&amp;lexicalGlobalObject, hintsValue)-&gt;asObject(hintsObject))</span>
 88         return;
 89 
<span class="line-modified"> 90     auto remoteObject = BindingTraits&lt;Inspector::Protocol::Runtime::RemoteObject&gt;::runtimeCast(Inspector::toInspectorValue(&amp;lexicalGlobalObject, valueToInspect));</span>
 91     inspectorAgent-&gt;inspect(WTFMove(remoteObject), WTFMove(hintsObject));
 92 }
 93 
<span class="line-modified"> 94 CommandLineAPIHost::EventListenersRecord CommandLineAPIHost::getEventListeners(JSGlobalObject&amp; lexicalGlobalObject, EventTarget&amp; target)</span>
 95 {
 96     auto* scriptExecutionContext = target.scriptExecutionContext();
 97     if (!scriptExecutionContext)
 98         return { };
 99 
100     EventListenersRecord result;
101 
<span class="line-modified">102     VM&amp; vm = lexicalGlobalObject.vm();</span>
103 
104     for (auto&amp; eventType : target.eventTypes()) {
105         Vector&lt;CommandLineAPIHost::ListenerEntry&gt; entries;
106 
107         for (auto&amp; eventListener : target.eventListeners(eventType)) {
108             if (!is&lt;JSEventListener&gt;(eventListener-&gt;callback()))
109                 continue;
110 
111             auto&amp; jsListener = downcast&lt;JSEventListener&gt;(eventListener-&gt;callback());
112 
113             // Hide listeners from other contexts.
<span class="line-modified">114             if (&amp;jsListener.isolatedWorld() != &amp;currentWorld(lexicalGlobalObject))</span>
115                 continue;
116 
117             auto* function = jsListener.jsFunction(*scriptExecutionContext);
118             if (!function)
119                 continue;
120 
121             entries.append({ Strong&lt;JSObject&gt;(vm, function), eventListener-&gt;useCapture(), eventListener-&gt;isPassive(), eventListener-&gt;isOnce() });
122         }
123 
124         if (!entries.isEmpty())
125             result.append({ eventType, WTFMove(entries) });
126     }
127 
128     return result;
129 }
130 
131 void CommandLineAPIHost::clearConsoleMessages()
132 {
133     if (!m_instrumentingAgents)
134         return;
135 
136     auto* consoleAgent = m_instrumentingAgents-&gt;webConsoleAgent();
137     if (!consoleAgent)
138         return;
139 
140     ErrorString ignored;
141     consoleAgent-&gt;clearMessages(ignored);
142 }
143 
144 void CommandLineAPIHost::copyText(const String&amp; text)
145 {
146     Pasteboard::createForCopyAndPaste()-&gt;writePlainText(text, Pasteboard::CannotSmartReplace);
147 }
148 
<span class="line-modified">149 JSC::JSValue CommandLineAPIHost::InspectableObject::get(JSC::JSGlobalObject&amp;)</span>
150 {
151     return { };
152 }
153 
154 void CommandLineAPIHost::addInspectedObject(std::unique_ptr&lt;CommandLineAPIHost::InspectableObject&gt; object)
155 {
156     m_inspectedObject = WTFMove(object);
157 }
158 
<span class="line-modified">159 JSC::JSValue CommandLineAPIHost::inspectedObject(JSC::JSGlobalObject&amp; lexicalGlobalObject)</span>
160 {
161     if (!m_inspectedObject)
162         return jsUndefined();
163 
<span class="line-modified">164     JSC::JSLockHolder lock(&amp;lexicalGlobalObject);</span>
<span class="line-modified">165     auto scriptValue = m_inspectedObject-&gt;get(lexicalGlobalObject);</span>
166     return scriptValue ? scriptValue : jsUndefined();
167 }
168 
169 String CommandLineAPIHost::databaseId(Database&amp; database)
170 {
171     if (m_instrumentingAgents) {
172         if (auto* databaseAgent = m_instrumentingAgents-&gt;inspectorDatabaseAgent())
173             return databaseAgent-&gt;databaseId(database);
174     }
175     return { };
176 }
177 
178 String CommandLineAPIHost::storageId(Storage&amp; storage)
179 {
180     return InspectorDOMStorageAgent::storageId(storage);
181 }
182 
<span class="line-modified">183 JSValue CommandLineAPIHost::wrapper(JSGlobalObject* exec, JSDOMGlobalObject* globalObject)</span>
184 {
185     JSValue value = m_wrappers.getWrapper(globalObject);
186     if (value)
187         return value;
188 
189     JSObject* prototype = JSCommandLineAPIHost::createPrototype(exec-&gt;vm(), *globalObject);
190     Structure* structure = JSCommandLineAPIHost::createStructure(exec-&gt;vm(), globalObject, prototype);
191     JSCommandLineAPIHost* commandLineAPIHost = JSCommandLineAPIHost::create(structure, globalObject, makeRef(*this));
192     m_wrappers.addWrapper(globalObject, commandLineAPIHost);
193 
194     return commandLineAPIHost;
195 }
196 
197 void CommandLineAPIHost::clearAllWrappers()
198 {
199     m_wrappers.clearAllWrappers();
200     m_inspectedObject = makeUnique&lt;InspectableObject&gt;();
201 }
202 
203 } // namespace WebCore
</pre>
</td>
</tr>
</table>
<center><a href="../html/track/WebVTTParser.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="CommandLineAPIHost.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>