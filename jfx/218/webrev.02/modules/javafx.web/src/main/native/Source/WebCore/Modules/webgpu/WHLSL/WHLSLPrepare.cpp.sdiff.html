<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WebCore/Modules/webgpu/WHLSL/WHLSLPrepare.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="WHLSLParser.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="WHLSLPreserveVariableLifetimes.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/Modules/webgpu/WHLSL/WHLSLPrepare.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. AND ITS CONTRIBUTORS ``AS IS&#39;&#39;
 14  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
 15  * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 16  * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL APPLE INC. OR ITS CONTRIBUTORS
 17  * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 18  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 19  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 20  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 21  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 22  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF
 23  * THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #include &quot;config.h&quot;
 27 #include &quot;WHLSLPrepare.h&quot;
 28 
 29 #if ENABLE(WEBGPU)
 30 
 31 #include &quot;WHLSLASTDumper.h&quot;
 32 #include &quot;WHLSLCheckDuplicateFunctions.h&quot;

 33 #include &quot;WHLSLCheckTextureReferences.h&quot;
 34 #include &quot;WHLSLChecker.h&quot;
 35 #include &quot;WHLSLComputeDimensions.h&quot;
 36 #include &quot;WHLSLFunctionStageChecker.h&quot;
 37 #include &quot;WHLSLHighZombieFinder.h&quot;
 38 #include &quot;WHLSLLiteralTypeChecker.h&quot;
 39 #include &quot;WHLSLMetalCodeGenerator.h&quot;
 40 #include &quot;WHLSLNameResolver.h&quot;
 41 #include &quot;WHLSLNameSpace.h&quot;
 42 #include &quot;WHLSLParser.h&quot;
 43 #include &quot;WHLSLPreserveVariableLifetimes.h&quot;
 44 #include &quot;WHLSLProgram.h&quot;
 45 #include &quot;WHLSLPropertyResolver.h&quot;
 46 #include &quot;WHLSLPruneUnreachableStandardLibraryFunctions.h&quot;
 47 #include &quot;WHLSLRecursionChecker.h&quot;
 48 #include &quot;WHLSLRecursiveTypeChecker.h&quot;
 49 #include &quot;WHLSLSemanticMatcher.h&quot;
 50 #include &quot;WHLSLStandardLibraryUtilities.h&quot;
 51 #include &quot;WHLSLStatementBehaviorChecker.h&quot;
<span class="line-removed"> 52 #include &quot;WHLSLSynthesizeArrayOperatorLength.h&quot;</span>
 53 #include &quot;WHLSLSynthesizeConstructors.h&quot;
 54 #include &quot;WHLSLSynthesizeEnumerationFunctions.h&quot;
<span class="line-removed"> 55 #include &quot;WHLSLSynthesizeStructureAccessors.h&quot;</span>
 56 #include &lt;wtf/MonotonicTime.h&gt;
 57 #include &lt;wtf/Optional.h&gt;
 58 
 59 namespace WebCore {
 60 
 61 namespace WHLSL {
 62 
 63 struct ShaderModule {
 64     WTF_MAKE_FAST_ALLOCATED;
 65 public:
 66 
 67     ShaderModule(const String&amp; whlslSource)
 68         : whlslSource(whlslSource)
 69     {
 70     }
 71 
 72     String whlslSource;
 73 };
 74 
 75 }
</pre>
<hr />
<pre>
206             if (!parseResult) {
207                 if (dumpPassFailure)
208                     dataLogLn(&quot;failed to parse the program: &quot;, Lexer::errorString(parseResult.error(), whlslSource1, whlslSource2));
209                 return makeUnexpected(Lexer::errorString(parseResult.error(), whlslSource1, whlslSource2));
210             }
211         }
212         program.nameContext().setCurrentNameSpace(AST::NameSpace::StandardLibrary);
213     }
214 
215     {
216         PhaseTimer phaseTimer(&quot;includeStandardLibrary&quot;, phaseTimes);
217         includeStandardLibrary(program, parser, parseFullStandardLibrary);
218     }
219 
220     if (!dumpASTBetweenEachPassIfNeeded(program, &quot;AST after parsing&quot;))
221         dumpASTAfterParsingIfNeeded(program);
222 
223     NameResolver nameResolver(program.nameContext());
224     CHECK_PASS(resolveNamesInTypes, program, nameResolver);
225     CHECK_PASS(checkRecursiveTypes, program);
<span class="line-removed">226     CHECK_PASS(synthesizeStructureAccessors, program);</span>
227     CHECK_PASS(synthesizeEnumerationFunctions, program);
<span class="line-removed">228     CHECK_PASS(synthesizeArrayOperatorLength, program);</span>
229     CHECK_PASS(resolveTypeNamesInFunctions, program, nameResolver);
230     CHECK_PASS(synthesizeConstructors, program);
231     CHECK_PASS(checkDuplicateFunctions, program);
232 
233     CHECK_PASS(check, program);
234     RUN_PASS(pruneUnreachableStandardLibraryFunctions, program);
235 
236     RUN_PASS(checkLiteralTypes, program);
237     CHECK_PASS(checkTextureReferences, program);

238     RUN_PASS(resolveProperties, program);
239     RUN_PASS(findHighZombies, program);
240     CHECK_PASS(checkStatementBehavior, program);
241     CHECK_PASS(checkRecursion, program);
242     CHECK_PASS(checkFunctionStages, program);
243     RUN_PASS(preserveVariableLifetimes, program);
244 
245     dumpASTAtEndIfNeeded(program);
246 
247     return program;
248 }
249 
250 Expected&lt;RenderPrepareResult, String&gt; prepare(const ShaderModule&amp; vertexShaderModule, const ShaderModule* fragmentShaderModule, RenderPipelineDescriptor&amp; renderPipelineDescriptor)
251 {
252     PhaseTimes phaseTimes;
253     Metal::RenderMetalCode generatedCode;
254 
255     {
256         PhaseTimer phaseTimer(&quot;prepare total&quot;, phaseTimes);
257         const String* secondShader = nullptr;
</pre>
</td>
<td>
<hr />
<pre>
 13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. AND ITS CONTRIBUTORS ``AS IS&#39;&#39;
 14  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
 15  * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 16  * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL APPLE INC. OR ITS CONTRIBUTORS
 17  * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 18  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 19  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 20  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 21  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 22  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF
 23  * THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #include &quot;config.h&quot;
 27 #include &quot;WHLSLPrepare.h&quot;
 28 
 29 #if ENABLE(WEBGPU)
 30 
 31 #include &quot;WHLSLASTDumper.h&quot;
 32 #include &quot;WHLSLCheckDuplicateFunctions.h&quot;
<span class="line-added"> 33 #include &quot;WHLSLCheckReferenceTypes.h&quot;</span>
 34 #include &quot;WHLSLCheckTextureReferences.h&quot;
 35 #include &quot;WHLSLChecker.h&quot;
 36 #include &quot;WHLSLComputeDimensions.h&quot;
 37 #include &quot;WHLSLFunctionStageChecker.h&quot;
 38 #include &quot;WHLSLHighZombieFinder.h&quot;
 39 #include &quot;WHLSLLiteralTypeChecker.h&quot;
 40 #include &quot;WHLSLMetalCodeGenerator.h&quot;
 41 #include &quot;WHLSLNameResolver.h&quot;
 42 #include &quot;WHLSLNameSpace.h&quot;
 43 #include &quot;WHLSLParser.h&quot;
 44 #include &quot;WHLSLPreserveVariableLifetimes.h&quot;
 45 #include &quot;WHLSLProgram.h&quot;
 46 #include &quot;WHLSLPropertyResolver.h&quot;
 47 #include &quot;WHLSLPruneUnreachableStandardLibraryFunctions.h&quot;
 48 #include &quot;WHLSLRecursionChecker.h&quot;
 49 #include &quot;WHLSLRecursiveTypeChecker.h&quot;
 50 #include &quot;WHLSLSemanticMatcher.h&quot;
 51 #include &quot;WHLSLStandardLibraryUtilities.h&quot;
 52 #include &quot;WHLSLStatementBehaviorChecker.h&quot;

 53 #include &quot;WHLSLSynthesizeConstructors.h&quot;
 54 #include &quot;WHLSLSynthesizeEnumerationFunctions.h&quot;

 55 #include &lt;wtf/MonotonicTime.h&gt;
 56 #include &lt;wtf/Optional.h&gt;
 57 
 58 namespace WebCore {
 59 
 60 namespace WHLSL {
 61 
 62 struct ShaderModule {
 63     WTF_MAKE_FAST_ALLOCATED;
 64 public:
 65 
 66     ShaderModule(const String&amp; whlslSource)
 67         : whlslSource(whlslSource)
 68     {
 69     }
 70 
 71     String whlslSource;
 72 };
 73 
 74 }
</pre>
<hr />
<pre>
205             if (!parseResult) {
206                 if (dumpPassFailure)
207                     dataLogLn(&quot;failed to parse the program: &quot;, Lexer::errorString(parseResult.error(), whlslSource1, whlslSource2));
208                 return makeUnexpected(Lexer::errorString(parseResult.error(), whlslSource1, whlslSource2));
209             }
210         }
211         program.nameContext().setCurrentNameSpace(AST::NameSpace::StandardLibrary);
212     }
213 
214     {
215         PhaseTimer phaseTimer(&quot;includeStandardLibrary&quot;, phaseTimes);
216         includeStandardLibrary(program, parser, parseFullStandardLibrary);
217     }
218 
219     if (!dumpASTBetweenEachPassIfNeeded(program, &quot;AST after parsing&quot;))
220         dumpASTAfterParsingIfNeeded(program);
221 
222     NameResolver nameResolver(program.nameContext());
223     CHECK_PASS(resolveNamesInTypes, program, nameResolver);
224     CHECK_PASS(checkRecursiveTypes, program);

225     CHECK_PASS(synthesizeEnumerationFunctions, program);

226     CHECK_PASS(resolveTypeNamesInFunctions, program, nameResolver);
227     CHECK_PASS(synthesizeConstructors, program);
228     CHECK_PASS(checkDuplicateFunctions, program);
229 
230     CHECK_PASS(check, program);
231     RUN_PASS(pruneUnreachableStandardLibraryFunctions, program);
232 
233     RUN_PASS(checkLiteralTypes, program);
234     CHECK_PASS(checkTextureReferences, program);
<span class="line-added">235     CHECK_PASS(checkReferenceTypes, program);</span>
236     RUN_PASS(resolveProperties, program);
237     RUN_PASS(findHighZombies, program);
238     CHECK_PASS(checkStatementBehavior, program);
239     CHECK_PASS(checkRecursion, program);
240     CHECK_PASS(checkFunctionStages, program);
241     RUN_PASS(preserveVariableLifetimes, program);
242 
243     dumpASTAtEndIfNeeded(program);
244 
245     return program;
246 }
247 
248 Expected&lt;RenderPrepareResult, String&gt; prepare(const ShaderModule&amp; vertexShaderModule, const ShaderModule* fragmentShaderModule, RenderPipelineDescriptor&amp; renderPipelineDescriptor)
249 {
250     PhaseTimes phaseTimes;
251     Metal::RenderMetalCode generatedCode;
252 
253     {
254         PhaseTimer phaseTimer(&quot;prepare total&quot;, phaseTimes);
255         const String* secondShader = nullptr;
</pre>
</td>
</tr>
</table>
<center><a href="WHLSLParser.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="WHLSLPreserveVariableLifetimes.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>