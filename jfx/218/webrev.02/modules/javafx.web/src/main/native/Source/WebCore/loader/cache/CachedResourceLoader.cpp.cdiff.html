<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.web/src/main/native/Source/WebCore/loader/cache/CachedResourceLoader.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="CachedResourceClient.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="CachedResourceLoader.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/loader/cache/CachedResourceLoader.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 43,30 ***</span>
<span class="line-new-header">--- 43,33 ---</span>
  #include &quot;ContentRuleListResults.h&quot;
  #include &quot;ContentSecurityPolicy.h&quot;
  #include &quot;CrossOriginAccessControl.h&quot;
  #include &quot;CustomHeaderFields.h&quot;
  #include &quot;DOMWindow.h&quot;
<span class="line-added">+ #include &quot;DateComponents.h&quot;</span>
  #include &quot;DiagnosticLoggingClient.h&quot;
  #include &quot;DiagnosticLoggingKeys.h&quot;
  #include &quot;Document.h&quot;
  #include &quot;DocumentLoader.h&quot;
  #include &quot;Frame.h&quot;
  #include &quot;FrameLoader.h&quot;
  #include &quot;FrameLoaderClient.h&quot;
  #include &quot;HTMLElement.h&quot;
  #include &quot;HTMLFrameOwnerElement.h&quot;
  #include &quot;HTTPHeaderField.h&quot;
<span class="line-added">+ #include &quot;InspectorInstrumentation.h&quot;</span>
  #include &quot;LoaderStrategy.h&quot;
  #include &quot;LocalizedStrings.h&quot;
  #include &quot;Logging.h&quot;
  #include &quot;MemoryCache.h&quot;
  #include &quot;Page.h&quot;
  #include &quot;PingLoader.h&quot;
  #include &quot;PlatformStrategies.h&quot;
  #include &quot;RenderElement.h&quot;
  #include &quot;ResourceLoadInfo.h&quot;
  #include &quot;ResourceTiming.h&quot;
<span class="line-added">+ #include &quot;RuntimeApplicationChecks.h&quot;</span>
  #include &quot;RuntimeEnabledFeatures.h&quot;
  #include &quot;ScriptController.h&quot;
  #include &quot;SecurityOrigin.h&quot;
  #include &quot;SecurityPolicy.h&quot;
  #include &quot;ServiceWorker.h&quot;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 85,10 ***</span>
<span class="line-new-header">--- 88,14 ---</span>
  
  #if ENABLE(VIDEO_TRACK)
  #include &quot;CachedTextTrack.h&quot;
  #endif
  
<span class="line-added">+ #if PLATFORM(IOS_FAMILY)</span>
<span class="line-added">+ #include &quot;Device.h&quot;</span>
<span class="line-added">+ #endif</span>
<span class="line-added">+ </span>
  #undef RELEASE_LOG_IF_ALLOWED
  #define RELEASE_LOG_IF_ALLOWED(fmt, ...) RELEASE_LOG_IF(isAlwaysOnLoggingAllowed(), Network, &quot;%p - CachedResourceLoader::&quot; fmt, this, ##__VA_ARGS__)
  
  namespace WebCore {
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 185,20 ***</span>
  Frame* CachedResourceLoader::frame() const
  {
      return m_documentLoader ? m_documentLoader-&gt;frame() : nullptr;
  }
  
<span class="line-removed">- PAL::SessionID CachedResourceLoader::sessionID() const</span>
<span class="line-removed">- {</span>
<span class="line-removed">-     auto sessionID = PAL::SessionID::defaultSessionID();</span>
<span class="line-removed">-     if (auto* frame = this-&gt;frame()) {</span>
<span class="line-removed">-         if (auto* page = frame-&gt;page())</span>
<span class="line-removed">-             sessionID = page-&gt;sessionID();</span>
<span class="line-removed">-     }</span>
<span class="line-removed">-     return sessionID;</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
  ResourceErrorOr&lt;CachedResourceHandle&lt;CachedImage&gt;&gt; CachedResourceLoader::requestImage(CachedResourceRequest&amp;&amp; request)
  {
      if (Frame* frame = this-&gt;frame()) {
          if (frame-&gt;loader().pageDismissalEventBeingDispatched() != FrameLoader::PageDismissalType::None) {
              if (Document* document = frame-&gt;document())
<span class="line-new-header">--- 192,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 244,11 ***</span>
      ASSERT(document());
      request.setDomainForCachePartition(*document());
  
      auto&amp; memoryCache = MemoryCache::singleton();
      if (request.allowsCaching()) {
<span class="line-modified">!         if (CachedResource* existing = memoryCache.resourceForRequest(request.resourceRequest(), sessionID())) {</span>
              if (is&lt;CachedCSSStyleSheet&gt;(*existing))
                  return downcast&lt;CachedCSSStyleSheet&gt;(existing);
              memoryCache.remove(*existing);
          }
      }
<span class="line-new-header">--- 241,11 ---</span>
      ASSERT(document());
      request.setDomainForCachePartition(*document());
  
      auto&amp; memoryCache = MemoryCache::singleton();
      if (request.allowsCaching()) {
<span class="line-modified">!         if (CachedResource* existing = memoryCache.resourceForRequest(request.resourceRequest(), page.sessionID())) {</span>
              if (is&lt;CachedCSSStyleSheet&gt;(*existing))
                  return downcast&lt;CachedCSSStyleSheet&gt;(existing);
              memoryCache.remove(*existing);
          }
      }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 510,11 ***</span>
      if (options.mode == FetchOptions::Mode::SameOrigin &amp;&amp; !m_document-&gt;securityOrigin().canRequest(url) &amp;&amp; !isSameOriginDataURL(url, options)) {
          printAccessDeniedMessage(url);
          return false;
      }
  
<span class="line-modified">!     if (options.mode == FetchOptions::Mode::NoCors &amp;&amp; options.redirect != FetchOptions::Redirect::Follow &amp;&amp; type != CachedResource::Type::Ping) {</span>
          ASSERT(type != CachedResource::Type::MainResource);
          frame()-&gt;document()-&gt;addConsoleMessage(MessageSource::Security, MessageLevel::Error, &quot;No-Cors mode requires follow redirect mode&quot;_s);
          return false;
      }
  
<span class="line-new-header">--- 507,11 ---</span>
      if (options.mode == FetchOptions::Mode::SameOrigin &amp;&amp; !m_document-&gt;securityOrigin().canRequest(url) &amp;&amp; !isSameOriginDataURL(url, options)) {
          printAccessDeniedMessage(url);
          return false;
      }
  
<span class="line-modified">!     if (options.mode == FetchOptions::Mode::NoCors &amp;&amp; !m_document-&gt;securityOrigin().canRequest(url) &amp;&amp; options.redirect != FetchOptions::Redirect::Follow &amp;&amp; type != CachedResource::Type::Ping) {</span>
          ASSERT(type != CachedResource::Type::MainResource);
          frame()-&gt;document()-&gt;addConsoleMessage(MessageSource::Security, MessageLevel::Error, &quot;No-Cors mode requires follow redirect mode&quot;_s);
          return false;
      }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 684,18 ***</span>
          return false;
  
      return true;
  }
  
<span class="line-modified">! CachedResourceHandle&lt;CachedResource&gt; CachedResourceLoader::updateCachedResourceWithCurrentRequest(const CachedResource&amp; resource, CachedResourceRequest&amp;&amp; request, const PAL::SessionID&amp; sessionID, const CookieJar* cookieJar)</span>
  {
      if (!isResourceSuitableForDirectReuse(resource, request)) {
          request.setCachingPolicy(CachingPolicy::DisallowCaching);
<span class="line-modified">!         return loadResource(resource.type(), WTFMove(request), cookieJar);</span>
      }
  
<span class="line-modified">!     auto resourceHandle = createResource(resource.type(), WTFMove(request), sessionID, cookieJar);</span>
      resourceHandle-&gt;loadFrom(resource);
      return resourceHandle;
  }
  
  static inline void logMemoryCacheResourceRequest(Frame* frame, const String&amp; key, const String&amp; description)
<span class="line-new-header">--- 681,18 ---</span>
          return false;
  
      return true;
  }
  
<span class="line-modified">! CachedResourceHandle&lt;CachedResource&gt; CachedResourceLoader::updateCachedResourceWithCurrentRequest(const CachedResource&amp; resource, CachedResourceRequest&amp;&amp; request, const PAL::SessionID&amp; sessionID, const CookieJar&amp; cookieJar)</span>
  {
      if (!isResourceSuitableForDirectReuse(resource, request)) {
          request.setCachingPolicy(CachingPolicy::DisallowCaching);
<span class="line-modified">!         return loadResource(resource.type(), sessionID, WTFMove(request), cookieJar);</span>
      }
  
<span class="line-modified">!     auto resourceHandle = createResource(resource.type(), WTFMove(request), sessionID, &amp;cookieJar);</span>
      resourceHandle-&gt;loadFrom(resource);
      return resourceHandle;
  }
  
  static inline void logMemoryCacheResourceRequest(Frame* frame, const String&amp; key, const String&amp; description)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 784,10 ***</span>
<span class="line-new-header">--- 781,17 ---</span>
      return FetchOptions::Destination::EmptyString;
  }
  
  ResourceErrorOr&lt;CachedResourceHandle&lt;CachedResource&gt;&gt; CachedResourceLoader::requestResource(CachedResource::Type type, CachedResourceRequest&amp;&amp; request, ForPreload forPreload, DeferOption defer)
  {
<span class="line-added">+     if (!frame() || !frame()-&gt;page()) {</span>
<span class="line-added">+         RELEASE_LOG_IF_ALLOWED(&quot;requestResource: failed because no frame or page&quot;);</span>
<span class="line-added">+         return makeUnexpected(ResourceError { errorDomainWebKitInternal, 0, request.resourceRequest().url(), &quot;Invalid loader state&quot;_s });</span>
<span class="line-added">+     }</span>
<span class="line-added">+     auto&amp; frame = *this-&gt;frame();</span>
<span class="line-added">+     auto&amp; page = *frame.page();</span>
<span class="line-added">+ </span>
      request.setDestinationIfNotSet(destinationForType(type));
  
      // Entry point to https://fetch.spec.whatwg.org/#main-fetch.
      std::unique_ptr&lt;ResourceRequest&gt; originalRequest;
      if (CachedResource::shouldUsePingLoad(type) || request.options().destination == FetchOptions::Destination::EmptyString) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 797,40 ***</span>
      }
  
      if (Document* document = this-&gt;document())
          request.upgradeInsecureRequestIfNeeded(*document);
  
      request.updateReferrerPolicy(document() ? document()-&gt;referrerPolicy() : ReferrerPolicy::NoReferrerWhenDowngrade);
      URL url = request.resourceRequest().url();
  
      LOG(ResourceLoading, &quot;CachedResourceLoader::requestResource &#39;%.255s&#39;, charset &#39;%s&#39;, priority=%d, forPreload=%u&quot;, url.stringCenterEllipsizedToLength().latin1().data(), request.charset().latin1().data(), request.priority() ? static_cast&lt;int&gt;(request.priority().value()) : -1, forPreload == ForPreload::Yes);
  
      if (!url.isValid()) {
<span class="line-modified">!         RELEASE_LOG_IF_ALLOWED(&quot;requestResource: URL is invalid (frame = %p)&quot;, frame());</span>
          return makeUnexpected(ResourceError { errorDomainWebKitInternal, 0, url, &quot;URL is invalid&quot;_s });
      }
  
      prepareFetch(type, request);
  
      // We are passing url as well as request, as request url may contain a fragment identifier.
      if (!canRequest(type, url, request, forPreload)) {
<span class="line-modified">!         RELEASE_LOG_IF_ALLOWED(&quot;requestResource: Not allowed to request resource (frame = %p)&quot;, frame());</span>
          return makeUnexpected(ResourceError { errorDomainWebKitInternal, 0, url, &quot;Not allowed to request resource&quot;_s, ResourceError::Type::AccessControl });
      }
  
  #if ENABLE(CONTENT_EXTENSIONS)
<span class="line-modified">!     if (frame() &amp;&amp; frame()-&gt;page() &amp;&amp; m_documentLoader) {</span>
          const auto&amp; resourceRequest = request.resourceRequest();
<span class="line-modified">!         auto* page = frame()-&gt;page();</span>
<span class="line-removed">-         auto results = page-&gt;userContentProvider().processContentRuleListsForLoad(resourceRequest.url(), ContentExtensions::toResourceType(type), *m_documentLoader);</span>
          bool blockedLoad = results.summary.blockedLoad;
          bool madeHTTPS = results.summary.madeHTTPS;
<span class="line-modified">!         request.applyResults(WTFMove(results), page);</span>
          if (blockedLoad) {
<span class="line-modified">!             RELEASE_LOG_IF_ALLOWED(&quot;requestResource: Resource blocked by content blocker (frame = %p)&quot;, frame());</span>
              if (type == CachedResource::Type::MainResource) {
<span class="line-modified">!                 CachedResourceHandle&lt;CachedResource&gt; resource = createResource(type, WTFMove(request), page-&gt;sessionID(), &amp;page-&gt;cookieJar());</span>
                  ASSERT(resource);
                  resource-&gt;error(CachedResource::Status::LoadError);
                  resource-&gt;setResourceError(ResourceError(ContentExtensions::WebKitContentBlockerDomain, 0, resourceRequest.url(), WEB_UI_STRING(&quot;The URL was blocked by a content blocker&quot;, &quot;WebKitErrorBlockedByContentBlocker description&quot;)));
                  return resource;
              }
<span class="line-new-header">--- 801,42 ---</span>
      }
  
      if (Document* document = this-&gt;document())
          request.upgradeInsecureRequestIfNeeded(*document);
  
<span class="line-added">+     if (InspectorInstrumentation::willInterceptRequest(&amp;frame, request.resourceRequest()))</span>
<span class="line-added">+         request.setCachingPolicy(CachingPolicy::DisallowCaching);</span>
<span class="line-added">+ </span>
      request.updateReferrerPolicy(document() ? document()-&gt;referrerPolicy() : ReferrerPolicy::NoReferrerWhenDowngrade);
      URL url = request.resourceRequest().url();
  
      LOG(ResourceLoading, &quot;CachedResourceLoader::requestResource &#39;%.255s&#39;, charset &#39;%s&#39;, priority=%d, forPreload=%u&quot;, url.stringCenterEllipsizedToLength().latin1().data(), request.charset().latin1().data(), request.priority() ? static_cast&lt;int&gt;(request.priority().value()) : -1, forPreload == ForPreload::Yes);
  
      if (!url.isValid()) {
<span class="line-modified">!         RELEASE_LOG_IF_ALLOWED(&quot;requestResource: URL is invalid (frame = %p)&quot;, &amp;frame);</span>
          return makeUnexpected(ResourceError { errorDomainWebKitInternal, 0, url, &quot;URL is invalid&quot;_s });
      }
  
      prepareFetch(type, request);
  
      // We are passing url as well as request, as request url may contain a fragment identifier.
      if (!canRequest(type, url, request, forPreload)) {
<span class="line-modified">!         RELEASE_LOG_IF_ALLOWED(&quot;requestResource: Not allowed to request resource (frame = %p)&quot;, &amp;frame);</span>
          return makeUnexpected(ResourceError { errorDomainWebKitInternal, 0, url, &quot;Not allowed to request resource&quot;_s, ResourceError::Type::AccessControl });
      }
  
  #if ENABLE(CONTENT_EXTENSIONS)
<span class="line-modified">!     if (m_documentLoader) {</span>
          const auto&amp; resourceRequest = request.resourceRequest();
<span class="line-modified">!         auto results = page.userContentProvider().processContentRuleListsForLoad(resourceRequest.url(), ContentExtensions::toResourceType(type), *m_documentLoader);</span>
          bool blockedLoad = results.summary.blockedLoad;
          bool madeHTTPS = results.summary.madeHTTPS;
<span class="line-modified">!         request.applyResults(WTFMove(results), &amp;page);</span>
          if (blockedLoad) {
<span class="line-modified">!             RELEASE_LOG_IF_ALLOWED(&quot;requestResource: Resource blocked by content blocker (frame = %p)&quot;, &amp;frame);</span>
              if (type == CachedResource::Type::MainResource) {
<span class="line-modified">!                 CachedResourceHandle&lt;CachedResource&gt; resource = createResource(type, WTFMove(request), page.sessionID(), &amp;page.cookieJar());</span>
                  ASSERT(resource);
                  resource-&gt;error(CachedResource::Status::LoadError);
                  resource-&gt;setResourceError(ResourceError(ContentExtensions::WebKitContentBlockerDomain, 0, resourceRequest.url(), WEB_UI_STRING(&quot;The URL was blocked by a content blocker&quot;, &quot;WebKitErrorBlockedByContentBlocker description&quot;)));
                  return resource;
              }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 845,17 ***</span>
          url = request.resourceRequest().url(); // The content extension could have changed it from http to https.
          url = MemoryCache::removeFragmentIdentifierIfNeeded(url); // Might need to remove fragment identifier again.
      }
  #endif
  
<span class="line-modified">!     if (frame() &amp;&amp; m_documentLoader &amp;&amp; !m_documentLoader-&gt;customHeaderFields().isEmpty()) {</span>
          bool sameOriginRequest = false;
          auto requestedOrigin = SecurityOrigin::create(url);
          if (type == CachedResource::Type::MainResource) {
<span class="line-modified">!             if (frame()-&gt;isMainFrame())</span>
                  sameOriginRequest = true;
<span class="line-modified">!             else if (auto* topDocument = frame()-&gt;mainFrame().document())</span>
                  sameOriginRequest = topDocument-&gt;securityOrigin().isSameSchemeHostPort(requestedOrigin.get());
          } else if (document()) {
              sameOriginRequest = document()-&gt;topDocument().securityOrigin().isSameSchemeHostPort(requestedOrigin.get())
                  &amp;&amp; document()-&gt;securityOrigin().isSameSchemeHostPort(requestedOrigin.get());
          }
<span class="line-new-header">--- 851,17 ---</span>
          url = request.resourceRequest().url(); // The content extension could have changed it from http to https.
          url = MemoryCache::removeFragmentIdentifierIfNeeded(url); // Might need to remove fragment identifier again.
      }
  #endif
  
<span class="line-modified">!     if (m_documentLoader &amp;&amp; !m_documentLoader-&gt;customHeaderFields().isEmpty()) {</span>
          bool sameOriginRequest = false;
          auto requestedOrigin = SecurityOrigin::create(url);
          if (type == CachedResource::Type::MainResource) {
<span class="line-modified">!             if (frame.isMainFrame())</span>
                  sameOriginRequest = true;
<span class="line-modified">!             else if (auto* topDocument = frame.mainFrame().document())</span>
                  sameOriginRequest = topDocument-&gt;securityOrigin().isSameSchemeHostPort(requestedOrigin.get());
          } else if (document()) {
              sameOriginRequest = document()-&gt;topDocument().securityOrigin().isSameSchemeHostPort(requestedOrigin.get())
                  &amp;&amp; document()-&gt;securityOrigin().isSameSchemeHostPort(requestedOrigin.get());
          }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 882,49 ***</span>
      CachedResourceHandle&lt;CachedResource&gt; resource;
      if (document())
          request.setDomainForCachePartition(*document());
  
      if (request.allowsCaching())
<span class="line-modified">!         resource = memoryCache.resourceForRequest(request.resourceRequest(), sessionID());</span>
  
      if (resource &amp;&amp; request.isLinkPreload() &amp;&amp; !resource-&gt;isLinkPreload())
          resource-&gt;setLinkPreload();
  
<span class="line-modified">!     logMemoryCacheResourceRequest(frame(), DiagnosticLoggingKeys::memoryCacheUsageKey(), resource ? DiagnosticLoggingKeys::inMemoryCacheKey() : DiagnosticLoggingKeys::notInMemoryCacheKey());</span>
  
<span class="line-modified">!     auto* cookieJar = document() &amp;&amp; document()-&gt;page() ? &amp;document()-&gt;page()-&gt;cookieJar() : nullptr;</span>
  
      RevalidationPolicy policy = determineRevalidationPolicy(type, request, resource.get(), forPreload, defer);
      switch (policy) {
      case Reload:
          memoryCache.remove(*resource);
          FALLTHROUGH;
      case Load:
          if (resource)
<span class="line-modified">!             logMemoryCacheResourceRequest(frame(), DiagnosticLoggingKeys::memoryCacheEntryDecisionKey(), DiagnosticLoggingKeys::unusedKey());</span>
<span class="line-modified">!         resource = loadResource(type, WTFMove(request), cookieJar);</span>
          break;
      case Revalidate:
          if (resource)
<span class="line-modified">!             logMemoryCacheResourceRequest(frame(), DiagnosticLoggingKeys::memoryCacheEntryDecisionKey(), DiagnosticLoggingKeys::revalidatingKey());</span>
          resource = revalidateResource(WTFMove(request), *resource);
          break;
      case Use:
          ASSERT(resource);
          if (request.options().mode == FetchOptions::Mode::NoCors) {
              if (auto error = validateCrossOriginResourcePolicy(*request.origin(), request.resourceRequest().url(), resource-&gt;response()))
                  return makeUnexpected(WTFMove(*error));
          }
          if (shouldUpdateCachedResourceWithCurrentRequest(*resource, request)) {
<span class="line-modified">!             resource = updateCachedResourceWithCurrentRequest(*resource, WTFMove(request), document()-&gt;page()-&gt;sessionID(), cookieJar);</span>
              if (resource-&gt;status() != CachedResource::Status::Cached)
                  policy = Load;
          } else {
              ResourceError error;
              if (!shouldContinueAfterNotifyingLoadedFromMemoryCache(request, *resource, error))
                  return makeUnexpected(WTFMove(error));
<span class="line-modified">!             logMemoryCacheResourceRequest(frame(), DiagnosticLoggingKeys::memoryCacheEntryDecisionKey(), DiagnosticLoggingKeys::usedKey());</span>
              loadTiming.setResponseEnd(MonotonicTime::now());
  
              memoryCache.resourceAccessed(*resource);
  
              if (RuntimeEnabledFeatures::sharedFeatures().resourceTimingEnabled() &amp;&amp; document() &amp;&amp; !resource-&gt;isLoading()) {
<span class="line-new-header">--- 888,52 ---</span>
      CachedResourceHandle&lt;CachedResource&gt; resource;
      if (document())
          request.setDomainForCachePartition(*document());
  
      if (request.allowsCaching())
<span class="line-modified">!         resource = memoryCache.resourceForRequest(request.resourceRequest(), page.sessionID());</span>
  
      if (resource &amp;&amp; request.isLinkPreload() &amp;&amp; !resource-&gt;isLinkPreload())
          resource-&gt;setLinkPreload();
  
<span class="line-modified">!     logMemoryCacheResourceRequest(&amp;frame, DiagnosticLoggingKeys::memoryCacheUsageKey(), resource ? DiagnosticLoggingKeys::inMemoryCacheKey() : DiagnosticLoggingKeys::notInMemoryCacheKey());</span>
  
<span class="line-modified">!     auto&amp; cookieJar = page.cookieJar();</span>
  
      RevalidationPolicy policy = determineRevalidationPolicy(type, request, resource.get(), forPreload, defer);
      switch (policy) {
      case Reload:
          memoryCache.remove(*resource);
          FALLTHROUGH;
      case Load:
          if (resource)
<span class="line-modified">!             logMemoryCacheResourceRequest(&amp;frame, DiagnosticLoggingKeys::memoryCacheEntryDecisionKey(), DiagnosticLoggingKeys::unusedKey());</span>
<span class="line-modified">!         resource = loadResource(type, page.sessionID(), WTFMove(request), cookieJar);</span>
          break;
      case Revalidate:
          if (resource)
<span class="line-modified">!             logMemoryCacheResourceRequest(&amp;frame, DiagnosticLoggingKeys::memoryCacheEntryDecisionKey(), DiagnosticLoggingKeys::revalidatingKey());</span>
          resource = revalidateResource(WTFMove(request), *resource);
          break;
      case Use:
          ASSERT(resource);
          if (request.options().mode == FetchOptions::Mode::NoCors) {
              if (auto error = validateCrossOriginResourcePolicy(*request.origin(), request.resourceRequest().url(), resource-&gt;response()))
                  return makeUnexpected(WTFMove(*error));
<span class="line-added">+ </span>
<span class="line-added">+             if (auto error = validateRangeRequestedFlag(request.resourceRequest(), resource-&gt;response()))</span>
<span class="line-added">+                 return makeUnexpected(WTFMove(*error));</span>
          }
          if (shouldUpdateCachedResourceWithCurrentRequest(*resource, request)) {
<span class="line-modified">!             resource = updateCachedResourceWithCurrentRequest(*resource, WTFMove(request), page.sessionID(), cookieJar);</span>
              if (resource-&gt;status() != CachedResource::Status::Cached)
                  policy = Load;
          } else {
              ResourceError error;
              if (!shouldContinueAfterNotifyingLoadedFromMemoryCache(request, *resource, error))
                  return makeUnexpected(WTFMove(error));
<span class="line-modified">!             logMemoryCacheResourceRequest(&amp;frame, DiagnosticLoggingKeys::memoryCacheEntryDecisionKey(), DiagnosticLoggingKeys::usedKey());</span>
              loadTiming.setResponseEnd(MonotonicTime::now());
  
              memoryCache.resourceAccessed(*resource);
  
              if (RuntimeEnabledFeatures::sharedFeatures().resourceTimingEnabled() &amp;&amp; document() &amp;&amp; !resource-&gt;isLoading()) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 932,11 ***</span>
                  if (initiatorContext == InitiatorContext::Worker) {
                      ASSERT(is&lt;CachedRawResource&gt;(resource.get()));
                      downcast&lt;CachedRawResource&gt;(resource.get())-&gt;finishedTimingForWorkerLoad(WTFMove(resourceTiming));
                  } else {
                      ASSERT(initiatorContext == InitiatorContext::Document);
<span class="line-modified">!                     m_resourceTimingInfo.storeResourceTimingInitiatorInformation(resource, request.initiatorName(), frame());</span>
                      m_resourceTimingInfo.addResourceTiming(*resource.get(), *document(), WTFMove(resourceTiming));
                  }
              }
  
              if (forPreload == ForPreload::No)
<span class="line-new-header">--- 941,11 ---</span>
                  if (initiatorContext == InitiatorContext::Worker) {
                      ASSERT(is&lt;CachedRawResource&gt;(resource.get()));
                      downcast&lt;CachedRawResource&gt;(resource.get())-&gt;finishedTimingForWorkerLoad(WTFMove(resourceTiming));
                  } else {
                      ASSERT(initiatorContext == InitiatorContext::Document);
<span class="line-modified">!                     m_resourceTimingInfo.storeResourceTimingInitiatorInformation(resource, request.initiatorName(), &amp;frame);</span>
                      m_resourceTimingInfo.addResourceTiming(*resource.get(), *document(), WTFMove(resourceTiming));
                  }
              }
  
              if (forPreload == ForPreload::No)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 996,11 ***</span>
      ASSERT(resource.inCache());
      auto&amp; memoryCache = MemoryCache::singleton();
      ASSERT(!memoryCache.disabled());
      ASSERT(resource.canUseCacheValidator());
      ASSERT(!resource.resourceToRevalidate());
<span class="line-removed">-     ASSERT(resource.sessionID() == sessionID());</span>
      ASSERT(resource.allowsCaching());
  
      CachedResourceHandle&lt;CachedResource&gt; newResource = createResource(resource.type(), WTFMove(request), resource.sessionID(), resource.cookieJar());
  
      LOG(ResourceLoading, &quot;Resource %p created to revalidate %p&quot;, newResource.get(), &amp;resource);
<span class="line-new-header">--- 1005,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1013,19 ***</span>
          m_resourceTimingInfo.storeResourceTimingInitiatorInformation(newResource, newResource-&gt;initiatorName(), frame());
  
      return newResource;
  }
  
<span class="line-modified">! CachedResourceHandle&lt;CachedResource&gt; CachedResourceLoader::loadResource(CachedResource::Type type, CachedResourceRequest&amp;&amp; request, const CookieJar* cookieJar)</span>
  {
      auto&amp; memoryCache = MemoryCache::singleton();
<span class="line-modified">!     ASSERT(!request.allowsCaching() || !memoryCache.resourceForRequest(request.resourceRequest(), sessionID())</span>
          || request.resourceRequest().cachePolicy() == ResourceRequestCachePolicy::DoNotUseAnyCache || request.resourceRequest().cachePolicy() == ResourceRequestCachePolicy::ReloadIgnoringCacheData || request.resourceRequest().cachePolicy() == ResourceRequestCachePolicy::RefreshAnyCacheData);
  
      LOG(ResourceLoading, &quot;Loading CachedResource for &#39;%s&#39;.&quot;, request.resourceRequest().url().stringCenterEllipsizedToLength().latin1().data());
  
<span class="line-modified">!     CachedResourceHandle&lt;CachedResource&gt; resource = createResource(type, WTFMove(request), sessionID(), cookieJar);</span>
  
      if (resource-&gt;allowsCaching())
          memoryCache.add(*resource);
  
      if (RuntimeEnabledFeatures::sharedFeatures().resourceTimingEnabled())
<span class="line-new-header">--- 1021,19 ---</span>
          m_resourceTimingInfo.storeResourceTimingInitiatorInformation(newResource, newResource-&gt;initiatorName(), frame());
  
      return newResource;
  }
  
<span class="line-modified">! CachedResourceHandle&lt;CachedResource&gt; CachedResourceLoader::loadResource(CachedResource::Type type, PAL::SessionID sessionID, CachedResourceRequest&amp;&amp; request, const CookieJar&amp; cookieJar)</span>
  {
      auto&amp; memoryCache = MemoryCache::singleton();
<span class="line-modified">!     ASSERT(!request.allowsCaching() || !memoryCache.resourceForRequest(request.resourceRequest(), sessionID)</span>
          || request.resourceRequest().cachePolicy() == ResourceRequestCachePolicy::DoNotUseAnyCache || request.resourceRequest().cachePolicy() == ResourceRequestCachePolicy::ReloadIgnoringCacheData || request.resourceRequest().cachePolicy() == ResourceRequestCachePolicy::RefreshAnyCacheData);
  
      LOG(ResourceLoading, &quot;Loading CachedResource for &#39;%s&#39;.&quot;, request.resourceRequest().url().stringCenterEllipsizedToLength().latin1().data());
  
<span class="line-modified">!     CachedResourceHandle&lt;CachedResource&gt; resource = createResource(type, WTFMove(request), sessionID, &amp;cookieJar);</span>
  
      if (resource-&gt;allowsCaching())
          memoryCache.add(*resource);
  
      if (RuntimeEnabledFeatures::sharedFeatures().resourceTimingEnabled())
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1230,11 ***</span>
  
      String message;
      if (!m_document || m_document-&gt;url().isNull())
          message = makeString(&quot;Unsafe attempt to load URL &quot;, url.stringCenterEllipsizedToLength(), &#39;.&#39;);
      else
<span class="line-modified">!         message = makeString(&quot;Unsafe attempt to load URL &quot;, url.stringCenterEllipsizedToLength(), &quot; from origin &quot;, m_document-&gt;origin(), &quot;. Domains, protocols and ports must match.\n&quot;);</span>
  
      frame()-&gt;document()-&gt;addConsoleMessage(MessageSource::Security, MessageLevel::Error, message);
  }
  
  void CachedResourceLoader::setAutoLoadImages(bool enable)
<span class="line-new-header">--- 1238,11 ---</span>
  
      String message;
      if (!m_document || m_document-&gt;url().isNull())
          message = makeString(&quot;Unsafe attempt to load URL &quot;, url.stringCenterEllipsizedToLength(), &#39;.&#39;);
      else
<span class="line-modified">!         message = makeString(&quot;Unsafe attempt to load URL &quot;, url.stringCenterEllipsizedToLength(), &quot; from origin &quot;, m_document-&gt;securityOrigin().toString(), &quot;. Domains, protocols and ports must match.\n&quot;);</span>
  
      frame()-&gt;document()-&gt;addConsoleMessage(MessageSource::Security, MessageLevel::Error, message);
  }
  
  void CachedResourceLoader::setAutoLoadImages(bool enable)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1294,11 ***</span>
  
      if (type != CachedResource::Type::MainResource)
          return frame-&gt;loader().subresourceCachePolicy(url);
  
      if (Page* page = frame-&gt;page()) {
<span class="line-modified">!         if (page-&gt;isResourceCachingDisabled())</span>
              return CachePolicyReload;
      }
  
      switch (frame-&gt;loader().loadType()) {
      case FrameLoadType::ReloadFromOrigin:
<span class="line-new-header">--- 1302,11 ---</span>
  
      if (type != CachedResource::Type::MainResource)
          return frame-&gt;loader().subresourceCachePolicy(url);
  
      if (Page* page = frame-&gt;page()) {
<span class="line-modified">!         if (page-&gt;isResourceCachingDisabledByWebInspector())</span>
              return CachePolicyReload;
      }
  
      switch (frame-&gt;loader().loadType()) {
      case FrameLoadType::ReloadFromOrigin:
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1377,10 ***</span>
<span class="line-new-header">--- 1385,13 ---</span>
      ASSERT(m_requestCount &gt; -1);
  }
  
  ResourceErrorOr&lt;CachedResourceHandle&lt;CachedResource&gt;&gt; CachedResourceLoader::preload(CachedResource::Type type, CachedResourceRequest&amp;&amp; request)
  {
<span class="line-added">+     if (InspectorInstrumentation::willInterceptRequest(frame(), request.resourceRequest()))</span>
<span class="line-added">+         return makeUnexpected(ResourceError { errorDomainWebKitInternal, 0, request.resourceRequest().url(), &quot;Inspector intercept&quot;_s });</span>
<span class="line-added">+ </span>
      if (request.charset().isEmpty() &amp;&amp; (type == CachedResource::Type::Script || type == CachedResource::Type::CSSStyleSheet))
          request.setCharset(m_document-&gt;charset());
  
      auto resource = requestResource(type, WTFMove(request), ForPreload::Yes);
      if (resource &amp;&amp; (!m_preloads || !m_preloads-&gt;contains(resource.value().get()))) {
</pre>
<center><a href="CachedResourceClient.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="CachedResourceLoader.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>