<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/JavaScriptCore/b3/air/AirValidate.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (C) 2015-2017 Apple Inc. All rights reserved.
  3  *
  4  * Redistribution and use in source and binary forms, with or without
  5  * modification, are permitted provided that the following conditions
  6  * are met:
  7  * 1. Redistributions of source code must retain the above copyright
  8  *    notice, this list of conditions and the following disclaimer.
  9  * 2. Redistributions in binary form must reproduce the above copyright
 10  *    notice, this list of conditions and the following disclaimer in the
 11  *    documentation and/or other materials provided with the distribution.
 12  *
 13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. ``AS IS&#39;&#39; AND ANY
 14  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 15  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 16  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE INC. OR
 17  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 18  * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 19  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 20  * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 21  * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 22  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 23  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #include &quot;config.h&quot;
 27 #include &quot;AirValidate.h&quot;
 28 
 29 #if ENABLE(B3_JIT)
 30 
 31 #include &quot;AirCode.h&quot;
 32 #include &quot;AirInstInlines.h&quot;
 33 #include &quot;B3Procedure.h&quot;
<a name="1" id="anc1"></a><span class="line-added"> 34 #include &lt;wtf/StringPrintStream.h&gt;</span>
 35 
 36 namespace JSC { namespace B3 { namespace Air {
 37 
 38 namespace {
 39 
 40 class Validater {
 41 public:
 42     Validater(Code&amp; code, const char* dumpBefore)
 43         : m_code(code)
 44         , m_dumpBefore(dumpBefore)
 45     {
 46     }
 47 
 48 #define VALIDATE(condition, message) do {                               \
 49         if (condition)                                                  \
 50             break;                                                      \
 51         fail(__FILE__, __LINE__, WTF_PRETTY_FUNCTION, #condition, toCString message); \
 52     } while (false)
 53 
 54     void run()
 55     {
 56         HashSet&lt;StackSlot*&gt; validSlots;
 57         HashSet&lt;BasicBlock*&gt; validBlocks;
 58         HashSet&lt;Special*&gt; validSpecials;
 59 
 60         for (BasicBlock* block : m_code)
 61             validBlocks.add(block);
 62         for (StackSlot* slot : m_code.stackSlots())
 63             validSlots.add(slot);
 64         for (Special* special : m_code.specials())
 65             validSpecials.add(special);
 66 
 67         for (BasicBlock* block : m_code) {
 68             // Blocks that are entrypoints must not have predecessors.
 69             if (m_code.isEntrypoint(block))
 70                 VALIDATE(!block-&gt;numPredecessors(), (&quot;At entrypoint &quot;, *block));
 71 
 72             for (unsigned instIndex = 0; instIndex &lt; block-&gt;size(); ++instIndex) {
 73                 Inst&amp; inst = block-&gt;at(instIndex);
 74                 for (Arg&amp; arg : inst.args) {
 75                     switch (arg.kind()) {
 76                     case Arg::Stack:
 77                         VALIDATE(validSlots.contains(arg.stackSlot()), (&quot;At &quot;, inst, &quot; in &quot;, *block));
 78                         break;
 79                     case Arg::Special:
 80                         VALIDATE(validSpecials.contains(arg.special()), (&quot;At &quot;, inst, &quot; in &quot;, *block));
 81                         break;
 82                     default:
 83                         break;
 84                     }
 85                 }
 86                 VALIDATE(inst.isValidForm(), (&quot;At &quot;, inst, &quot; in &quot;, *block));
 87                 if (instIndex == block-&gt;size() - 1)
 88                     VALIDATE(inst.isTerminal(), (&quot;At &quot;, inst, &quot; in &quot;, *block));
 89                 else
 90                     VALIDATE(!inst.isTerminal(), (&quot;At &quot;, inst, &quot; in &quot;, *block));
 91 
 92                 // forEachArg must return Arg&amp;&#39;s that point into the args array.
 93                 inst.forEachArg(
 94                     [&amp;] (Arg&amp; arg, Arg::Role, Bank, Width) {
 95                         VALIDATE(&amp;arg &gt;= &amp;inst.args[0], (&quot;At &quot;, arg, &quot; in &quot;, inst, &quot; in &quot;, *block));
 96                         VALIDATE(&amp;arg &lt;= &amp;inst.args.last(), (&quot;At &quot;, arg, &quot; in &quot;, inst, &quot; in &quot;, *block));
 97                     });
 98 
 99                 switch (inst.kind.opcode) {
100                 case EntrySwitch:
101                     VALIDATE(block-&gt;numSuccessors() == m_code.proc().numEntrypoints(), (&quot;At &quot;, inst, &quot; in &quot;, *block));
102                     break;
103                 case Shuffle:
104                     // We can&#39;t handle trapping shuffles because of how we lower them. That could
105                     // be fixed though. Ditto for shuffles that would do fences, which is the other
106                     // use of this bit.
107                     VALIDATE(!inst.kind.effects, (&quot;At &quot;, inst, &quot; in &quot;, *block));
108                     break;
109                 default:
110                     break;
111                 }
112             }
113             for (BasicBlock* successor : block-&gt;successorBlocks())
114                 VALIDATE(validBlocks.contains(successor), (&quot;In &quot;, *block));
115         }
116 
117         for (BasicBlock* block : m_code) {
118             // We expect the predecessor list to be de-duplicated.
119             HashSet&lt;BasicBlock*&gt; predecessors;
120             for (BasicBlock* predecessor : block-&gt;predecessors())
121                 predecessors.add(predecessor);
122             VALIDATE(block-&gt;numPredecessors() == predecessors.size(), (&quot;At &quot;, *block));
123         }
124     }
125 
126 private:
127     NO_RETURN_DUE_TO_CRASH void fail(
128         const char* filename, int lineNumber, const char* function, const char* condition,
129         CString message)
130     {
131         CString failureMessage;
132         {
133             StringPrintStream out;
134             out.print(&quot;AIR VALIDATION FAILURE\n&quot;);
135             out.print(&quot;    &quot;, condition, &quot; (&quot;, filename, &quot;:&quot;, lineNumber, &quot;)\n&quot;);
136             out.print(&quot;    &quot;, message, &quot;\n&quot;);
137             out.print(&quot;    After &quot;, m_code.lastPhaseName(), &quot;\n&quot;);
138             failureMessage = out.toCString();
139         }
140 
141         dataLog(failureMessage);
142         if (m_dumpBefore) {
143             dataLog(&quot;Before &quot;, m_code.lastPhaseName(), &quot;:\n&quot;);
144             dataLog(m_dumpBefore);
145         }
146         dataLog(&quot;At time of failure:\n&quot;);
147         dataLog(m_code);
148 
149         dataLog(failureMessage);
150         WTFReportAssertionFailure(filename, lineNumber, function, condition);
151         CRASH();
152     }
153 
154     Code&amp; m_code;
155     const char* m_dumpBefore;
156 };
157 
158 } // anonymous namespace
159 
160 void validate(Code&amp; code, const char* dumpBefore)
161 {
162     Validater validater(code, dumpBefore);
163     validater.run();
164 }
165 
166 } } } // namespace JSC::B3::Air
167 
168 #endif // ENABLE(B3_JIT)
169 
<a name="2" id="anc2"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="2" type="hidden" />
</body>
</html>