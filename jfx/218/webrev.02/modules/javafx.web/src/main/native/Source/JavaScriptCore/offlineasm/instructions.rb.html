<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New modules/javafx.web/src/main/native/Source/JavaScriptCore/offlineasm/instructions.rb</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 # Copyright (C) 2011-2018 Apple Inc. All rights reserved.
  2 #
  3 # Redistribution and use in source and binary forms, with or without
  4 # modification, are permitted provided that the following conditions
  5 # are met:
  6 # 1. Redistributions of source code must retain the above copyright
  7 #    notice, this list of conditions and the following disclaimer.
  8 # 2. Redistributions in binary form must reproduce the above copyright
  9 #    notice, this list of conditions and the following disclaimer in the
 10 #    documentation and/or other materials provided with the distribution.
 11 #
 12 # THIS SOFTWARE IS PROVIDED BY APPLE INC. AND ITS CONTRIBUTORS ``AS IS&#39;&#39;
 13 # AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
 14 # THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 15 # PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL APPLE INC. OR ITS CONTRIBUTORS
 16 # BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 17 # CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 18 # SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 19 # INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 20 # CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 21 # ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF
 22 # THE POSSIBILITY OF SUCH DAMAGE.
 23 
 24 require &quot;config&quot;
 25 require &quot;set&quot;
 26 
 27 # Interesting invariant, which we take advantage of: branching instructions
 28 # always begin with &quot;b&quot;, and no non-branching instructions begin with &quot;b&quot;.
 29 # Terminal instructions are &quot;jmp&quot; and &quot;ret&quot;.
 30 
 31 MACRO_INSTRUCTIONS =
 32     [
 33      &quot;emit&quot;,
 34      &quot;addi&quot;,
 35      &quot;andi&quot;,
 36      &quot;andf&quot;,
 37      &quot;andd&quot;,
 38      &quot;lshifti&quot;,
 39      &quot;lshiftp&quot;,
 40      &quot;lshiftq&quot;,
 41      &quot;muli&quot;,
 42      &quot;negi&quot;,
 43      &quot;negp&quot;,
 44      &quot;negq&quot;,
 45      &quot;noti&quot;,
 46      &quot;ori&quot;,
 47      &quot;orf&quot;,
 48      &quot;ord&quot;,
 49      &quot;orh&quot;,
 50      &quot;rshifti&quot;,
 51      &quot;urshifti&quot;,
 52      &quot;rshiftp&quot;,
 53      &quot;urshiftp&quot;,
 54      &quot;rshiftq&quot;,
 55      &quot;urshiftq&quot;,
 56      &quot;lrotatei&quot;,
 57      &quot;lrotateq&quot;,
 58      &quot;rrotatei&quot;,
 59      &quot;rrotateq&quot;,
 60      &quot;subi&quot;,
 61      &quot;xori&quot;,
 62      &quot;loadi&quot;,
 63      &quot;loadis&quot;,
 64      &quot;loadb&quot;,
 65      &quot;loadbsi&quot;,
 66      &quot;loadbsq&quot;,
 67      &quot;loadh&quot;,
 68      &quot;loadhsi&quot;,
 69      &quot;loadhsq&quot;,
 70      &quot;storei&quot;,
 71      &quot;storeh&quot;,
 72      &quot;storeb&quot;,
 73      &quot;loadf&quot;,
 74      &quot;loadd&quot;,
 75      &quot;moved&quot;,
 76      &quot;storef&quot;,
 77      &quot;stored&quot;,
 78      &quot;addf&quot;,
 79      &quot;addd&quot;,
 80      &quot;divf&quot;,
 81      &quot;divd&quot;,
 82      &quot;subf&quot;,
 83      &quot;subd&quot;,
 84      &quot;mulf&quot;,
 85      &quot;muld&quot;,
 86      &quot;sqrtf&quot;,
 87      &quot;sqrtd&quot;,
 88      &quot;floorf&quot;,
 89      &quot;floord&quot;,
 90      &quot;roundf&quot;,
 91      &quot;roundd&quot;,
 92      &quot;truncatef&quot;,
 93      &quot;truncated&quot;,
 94      &quot;truncatef2i&quot;,
 95      &quot;truncatef2q&quot;,
 96      &quot;truncated2q&quot;,
 97      &quot;truncated2i&quot;,
 98      &quot;truncatef2is&quot;,
 99      &quot;truncated2is&quot;,
100      &quot;truncatef2qs&quot;,
101      &quot;truncated2qs&quot;,
102      &quot;ci2d&quot;,
103      &quot;ci2ds&quot;,
104      &quot;ci2f&quot;,
105      &quot;ci2fs&quot;,
106      &quot;cq2f&quot;,
107      &quot;cq2fs&quot;,
108      &quot;cq2d&quot;,
109      &quot;cq2ds&quot;,
110      &quot;cd2f&quot;,
111      &quot;cf2d&quot;,
112      &quot;fii2d&quot;, # usage: fii2d &lt;gpr with least significant bits&gt;, &lt;gpr with most significant bits&gt;, &lt;fpr&gt;
113      &quot;fd2ii&quot;, # usage: fd2ii &lt;fpr&gt;, &lt;gpr with least significant bits&gt;, &lt;gpr with most significant bits&gt;
114      &quot;fq2d&quot;,
115      &quot;fd2q&quot;,
116      &quot;bdeq&quot;,
117      &quot;bdneq&quot;,
118      &quot;bdgt&quot;,
119      &quot;bdgteq&quot;,
120      &quot;bdlt&quot;,
121      &quot;bdlteq&quot;,
122      &quot;bdequn&quot;,
123      &quot;bdnequn&quot;,
124      &quot;bdgtun&quot;,
125      &quot;bdgtequn&quot;,
126      &quot;bdltun&quot;,
127      &quot;bdltequn&quot;,
128      &quot;bfeq&quot;,
129      &quot;bfgt&quot;,
130      &quot;bflt&quot;,
131      &quot;bfgtun&quot;,
132      &quot;bfgtequn&quot;,
133      &quot;bfltun&quot;,
134      &quot;bfltequn&quot;,
135      &quot;btd2i&quot;,
136      &quot;td2i&quot;,
137      &quot;bcd2i&quot;,
138      &quot;movdz&quot;,
139      &quot;pop&quot;,
140      &quot;push&quot;,
141      &quot;move&quot;,
142      &quot;sxi2q&quot;,
143      &quot;zxi2q&quot;,
144      &quot;nop&quot;,
145      &quot;bieq&quot;,
146      &quot;bineq&quot;,
147      &quot;bia&quot;,
148      &quot;biaeq&quot;,
149      &quot;bib&quot;,
150      &quot;bibeq&quot;,
151      &quot;bigt&quot;,
152      &quot;bigteq&quot;,
153      &quot;bilt&quot;,
154      &quot;bilteq&quot;,
155      &quot;bbeq&quot;,
156      &quot;bbneq&quot;,
157      &quot;bba&quot;,
158      &quot;bbaeq&quot;,
159      &quot;bbb&quot;,
160      &quot;bbbeq&quot;,
161      &quot;bbgt&quot;,
162      &quot;bbgteq&quot;,
163      &quot;bblt&quot;,
164      &quot;bblteq&quot;,
165      &quot;btis&quot;,
166      &quot;btiz&quot;,
167      &quot;btinz&quot;,
168      &quot;btbs&quot;,
169      &quot;btbz&quot;,
170      &quot;btbnz&quot;,
171      &quot;jmp&quot;,
172      &quot;baddio&quot;,
173      &quot;baddis&quot;,
174      &quot;baddiz&quot;,
175      &quot;baddinz&quot;,
176      &quot;bsubio&quot;,
177      &quot;bsubis&quot;,
178      &quot;bsubiz&quot;,
179      &quot;bsubinz&quot;,
180      &quot;bmulio&quot;,
181      &quot;bmulis&quot;,
182      &quot;bmuliz&quot;,
183      &quot;bmulinz&quot;,
184      &quot;borio&quot;,
185      &quot;boris&quot;,
186      &quot;boriz&quot;,
187      &quot;borinz&quot;,
188      &quot;break&quot;,
189      &quot;call&quot;,
190      &quot;ret&quot;,
191      &quot;cbeq&quot;,
192      &quot;cbneq&quot;,
193      &quot;cba&quot;,
194      &quot;cbaeq&quot;,
195      &quot;cbb&quot;,
196      &quot;cbbeq&quot;,
197      &quot;cbgt&quot;,
198      &quot;cbgteq&quot;,
199      &quot;cblt&quot;,
200      &quot;cblteq&quot;,
201      &quot;cieq&quot;,
202      &quot;cineq&quot;,
203      &quot;cia&quot;,
204      &quot;ciaeq&quot;,
205      &quot;cib&quot;,
206      &quot;cibeq&quot;,
207      &quot;cigt&quot;,
208      &quot;cigteq&quot;,
209      &quot;cilt&quot;,
210      &quot;cilteq&quot;,
211      &quot;tis&quot;,
212      &quot;tiz&quot;,
213      &quot;tinz&quot;,
214      &quot;tbs&quot;,
215      &quot;tbz&quot;,
216      &quot;tbnz&quot;,
217      &quot;tps&quot;,
218      &quot;tpz&quot;,
219      &quot;tpnz&quot;,
220      &quot;peek&quot;,
221      &quot;poke&quot;,
222      &quot;bpeq&quot;,
223      &quot;bpneq&quot;,
224      &quot;bpa&quot;,
225      &quot;bpaeq&quot;,
226      &quot;bpb&quot;,
227      &quot;bpbeq&quot;,
228      &quot;bpgt&quot;,
229      &quot;bpgteq&quot;,
230      &quot;bplt&quot;,
231      &quot;bplteq&quot;,
232      &quot;addp&quot;,
233      &quot;mulp&quot;,
234      &quot;andp&quot;,
235      &quot;orp&quot;,
236      &quot;subp&quot;,
237      &quot;xorp&quot;,
238      &quot;loadp&quot;,
239      &quot;cpeq&quot;,
240      &quot;cpneq&quot;,
241      &quot;cpa&quot;,
242      &quot;cpaeq&quot;,
243      &quot;cpb&quot;,
244      &quot;cpbeq&quot;,
245      &quot;cpgt&quot;,
246      &quot;cpgteq&quot;,
247      &quot;cplt&quot;,
248      &quot;cplteq&quot;,
249      &quot;storep&quot;,
250      &quot;btps&quot;,
251      &quot;btpz&quot;,
252      &quot;btpnz&quot;,
253      &quot;baddpo&quot;,
254      &quot;baddps&quot;,
255      &quot;baddpz&quot;,
256      &quot;baddpnz&quot;,
257      &quot;tqs&quot;,
258      &quot;tqz&quot;,
259      &quot;tqnz&quot;,
260      &quot;bqeq&quot;,
261      &quot;bqneq&quot;,
262      &quot;bqa&quot;,
263      &quot;bqaeq&quot;,
264      &quot;bqb&quot;,
265      &quot;bqbeq&quot;,
266      &quot;bqgt&quot;,
267      &quot;bqgteq&quot;,
268      &quot;bqlt&quot;,
269      &quot;bqlteq&quot;,
270      &quot;addq&quot;,
271      &quot;mulq&quot;,
272      &quot;andq&quot;,
273      &quot;orq&quot;,
274      &quot;subq&quot;,
275      &quot;xorq&quot;,
276      &quot;loadq&quot;,
277      &quot;cqeq&quot;,
278      &quot;cqneq&quot;,
279      &quot;cqa&quot;,
280      &quot;cqaeq&quot;,
281      &quot;cqb&quot;,
282      &quot;cqbeq&quot;,
283      &quot;cqgt&quot;,
284      &quot;cqgteq&quot;,
285      &quot;cqlt&quot;,
286      &quot;cqlteq&quot;,
287      &quot;storeq&quot;,
288      &quot;btqs&quot;,
289      &quot;btqz&quot;,
290      &quot;btqnz&quot;,
291      &quot;baddqo&quot;,
292      &quot;baddqs&quot;,
293      &quot;baddqz&quot;,
294      &quot;baddqnz&quot;,
295      &quot;bo&quot;,
296      &quot;bs&quot;,
297      &quot;bz&quot;,
298      &quot;bnz&quot;,
299      &quot;leai&quot;,
300      &quot;leap&quot;,
301      &quot;memfence&quot;,
302      &quot;tagReturnAddress&quot;,
303      &quot;untagReturnAddress&quot;,
304      &quot;removeCodePtrTag&quot;,
305      &quot;untagArrayPtr&quot;,    
306      &quot;tzcnti&quot;,
307      &quot;tzcntq&quot;,
308      &quot;lzcnti&quot;,
309      &quot;lzcntq&quot;,
310      &quot;absf&quot;,
311      &quot;absd&quot;,
312      &quot;negf&quot;,
313      &quot;negd&quot;,
314      &quot;ceilf&quot;,
315      &quot;ceild&quot;,
316      &quot;cfeq&quot;,
317      &quot;cdeq&quot;,
318      &quot;cfneq&quot;,
319      &quot;cfnequn&quot;,
320      &quot;cdneq&quot;,
321      &quot;cdnequn&quot;,
322      &quot;cflt&quot;,
323      &quot;cdlt&quot;,
324      &quot;cflteq&quot;,
325      &quot;cdlteq&quot;,
326      &quot;cfgt&quot;,
327      &quot;cdgt&quot;,
328      &quot;cfgteq&quot;,
329      &quot;cdgteq&quot;,
330      &quot;fi2f&quot;,
331      &quot;ff2i&quot;,
332      &quot;tls_loadp&quot;,
333      &quot;tls_storep&quot;,
334     ]
335 
336 X86_INSTRUCTIONS =
337     [
338      &quot;cdqi&quot;,
339      &quot;idivi&quot;,
340      &quot;udivi&quot;,
341      &quot;cqoq&quot;,
342      &quot;idivq&quot;,
343      &quot;udivq&quot;,
344     ]
345 
346 ARM_INSTRUCTIONS =
347     [
348      &quot;clrbp&quot;,
349      &quot;mvlbl&quot;,
350      &quot;globaladdr&quot;
351     ]
352 
353 ARM64_INSTRUCTIONS =
354     [
355      &quot;bfiq&quot;, # Bit field insert &lt;source reg&gt; &lt;last bit written&gt; &lt;width immediate&gt; &lt;dest reg&gt;
356      &quot;pcrtoaddr&quot;,   # Address from PC relative offset - adr instruction
357      &quot;nopFixCortexA53Err835769&quot;, # nop on Cortex-A53 (nothing otherwise)
358      &quot;globaladdr&quot;,
359      &quot;divi&quot;,
360      &quot;divis&quot;,
361      &quot;divq&quot;,
362      &quot;divqs&quot;,
363     ]
364 
365 RISC_INSTRUCTIONS =
366     [
367      &quot;smulli&quot;,  # Multiply two 32-bit words and produce a 64-bit word
368      &quot;addis&quot;,   # Add integers and set a flag.
369      &quot;subis&quot;,   # Same, but for subtraction.
370      &quot;oris&quot;,    # Same, but for bitwise or.
371      &quot;addps&quot;    # addis but for pointers.
372     ]
373 
374 MIPS_INSTRUCTIONS =
375     [
376     &quot;la&quot;,
377     &quot;movz&quot;,
378     &quot;movn&quot;,
379     &quot;setcallreg&quot;,
380     &quot;slt&quot;,
381     &quot;sltu&quot;,
382     &quot;pichdr&quot;
383     ]
384 
385 CXX_INSTRUCTIONS =
386     [
387      &quot;cloopCrash&quot;,              # no operands
388      &quot;cloopCallJSFunction&quot;,     # operands: callee
389      &quot;cloopCallNative&quot;,         # operands: callee
390      &quot;cloopCallSlowPath&quot;,       # operands: callTarget, currentFrame, currentPC
391      &quot;cloopCallSlowPathVoid&quot;,   # operands: callTarget, currentFrame, currentPC
392 
393      # For debugging only:
394      # Takes no operands but simply emits whatever follows in // comments as
395      # a line of C++ code in the generated LLIntAssembly.h file. This can be
396      # used to insert instrumentation into the interpreter loop to inspect
397      # variables of interest. Do not leave these instructions in production
398      # code.
399      &quot;cloopDo&quot;,              # no operands
400     ]
401 
402 INSTRUCTIONS = MACRO_INSTRUCTIONS + X86_INSTRUCTIONS + ARM_INSTRUCTIONS + ARM64_INSTRUCTIONS + RISC_INSTRUCTIONS + MIPS_INSTRUCTIONS + CXX_INSTRUCTIONS
403 
404 INSTRUCTION_SET = INSTRUCTIONS.to_set
405 
406 def isBranch(instruction)
407     instruction =~ /^b/
408 end
409 
410 def hasFallThrough(instruction)
411     instruction != &quot;ret&quot; and instruction != &quot;jmp&quot;
412 end
413 
414 def isPowerOfTwo(value)
415     return false if value &lt;= 0
416     (value &amp; (value - 1)).zero?
417 end
    </pre>
  </body>
</html>