<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.web/src/main/native/Source/WebCore/Modules/indexeddb/server/IDBServer.h</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="IDBServer.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="MemoryCursor.cpp.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/Modules/indexeddb/server/IDBServer.h</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 28,22 ***</span>
  #if ENABLE(INDEXED_DATABASE)
  
  #include &quot;IDBConnectionToClient.h&quot;
  #include &quot;IDBDatabaseIdentifier.h&quot;
  #include &quot;StorageQuotaManager.h&quot;
<span class="line-removed">- #include &quot;StorageQuotaUser.h&quot;</span>
  #include &quot;UniqueIDBDatabase.h&quot;
  #include &quot;UniqueIDBDatabaseConnection.h&quot;
  #include &lt;pal/HysteresisActivity.h&gt;
  #include &lt;pal/SessionID.h&gt;
  #include &lt;wtf/CrossThreadTaskHandler.h&gt;
  #include &lt;wtf/HashMap.h&gt;
  #include &lt;wtf/Lock.h&gt;
<span class="line-removed">- #include &lt;wtf/Ref.h&gt;</span>
<span class="line-removed">- #include &lt;wtf/RefCounted.h&gt;</span>
  #include &lt;wtf/RefPtr.h&gt;
<span class="line-modified">! #include &lt;wtf/WeakPtr.h&gt;</span>
  
  namespace WebCore {
  
  class IDBCursorInfo;
  class IDBRequestData;
<span class="line-new-header">--- 28,19 ---</span>
  #if ENABLE(INDEXED_DATABASE)
  
  #include &quot;IDBConnectionToClient.h&quot;
  #include &quot;IDBDatabaseIdentifier.h&quot;
  #include &quot;StorageQuotaManager.h&quot;
  #include &quot;UniqueIDBDatabase.h&quot;
  #include &quot;UniqueIDBDatabaseConnection.h&quot;
  #include &lt;pal/HysteresisActivity.h&gt;
  #include &lt;pal/SessionID.h&gt;
  #include &lt;wtf/CrossThreadTaskHandler.h&gt;
  #include &lt;wtf/HashMap.h&gt;
  #include &lt;wtf/Lock.h&gt;
  #include &lt;wtf/RefPtr.h&gt;
<span class="line-modified">! #include &lt;wtf/WeakHashSet.h&gt;</span>
  
  namespace WebCore {
  
  class IDBCursorInfo;
  class IDBRequestData;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 52,19 ***</span>
  
  struct IDBGetRecordData;
  
  namespace IDBServer {
  
<span class="line-modified">! class IDBBackingStoreTemporaryFileHandler;</span>
<span class="line-modified">! </span>
<span class="line-removed">- enum class ShouldForceStop : bool { No, Yes };</span>
<span class="line-removed">- </span>
<span class="line-removed">- class IDBServer : public RefCounted&lt;IDBServer&gt;, public CrossThreadTaskHandler, public CanMakeWeakPtr&lt;IDBServer&gt; {</span>
  public:
<span class="line-modified">!     using QuotaManagerGetter = WTF::Function&lt;StorageQuotaManager*(PAL::SessionID, const ClientOrigin&amp;)&gt;;</span>
<span class="line-modified">!     static Ref&lt;IDBServer&gt; create(PAL::SessionID, IDBBackingStoreTemporaryFileHandler&amp;, QuotaManagerGetter&amp;&amp;);</span>
<span class="line-modified">!     WEBCORE_EXPORT static Ref&lt;IDBServer&gt; create(PAL::SessionID, const String&amp; databaseDirectoryPath, IDBBackingStoreTemporaryFileHandler&amp;, QuotaManagerGetter&amp;&amp;);</span>
  
      WEBCORE_EXPORT void registerConnection(IDBConnectionToClient&amp;);
      WEBCORE_EXPORT void unregisterConnection(IDBConnectionToClient&amp;);
  
      // Operations requested by the client.
<span class="line-new-header">--- 49,16 ---</span>
  
  struct IDBGetRecordData;
  
  namespace IDBServer {
  
<span class="line-modified">! class IDBServer {</span>
<span class="line-modified">!     WTF_MAKE_FAST_ALLOCATED;</span>
  public:
<span class="line-modified">!     using StorageQuotaManagerSpaceRequester = Function&lt;StorageQuotaManager::Decision(const ClientOrigin&amp;, uint64_t spaceRequested)&gt;;</span>
<span class="line-modified">!     WEBCORE_EXPORT IDBServer(PAL::SessionID, const String&amp; databaseDirectoryPath, StorageQuotaManagerSpaceRequester&amp;&amp;);</span>
<span class="line-modified">!     WEBCORE_EXPORT ~IDBServer();</span>
  
      WEBCORE_EXPORT void registerConnection(IDBConnectionToClient&amp;);
      WEBCORE_EXPORT void unregisterConnection(IDBConnectionToClient&amp;);
  
      // Operations requested by the client.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 90,116 ***</span>
  
      WEBCORE_EXPORT void establishTransaction(uint64_t databaseConnectionIdentifier, const IDBTransactionInfo&amp;);
      WEBCORE_EXPORT void databaseConnectionPendingClose(uint64_t databaseConnectionIdentifier);
      WEBCORE_EXPORT void databaseConnectionClosed(uint64_t databaseConnectionIdentifier);
      WEBCORE_EXPORT void abortOpenAndUpgradeNeeded(uint64_t databaseConnectionIdentifier, const IDBResourceIdentifier&amp; transactionIdentifier);
<span class="line-modified">!     WEBCORE_EXPORT void didFireVersionChangeEvent(uint64_t databaseConnectionIdentifier, const IDBResourceIdentifier&amp; requestIdentifier);</span>
      WEBCORE_EXPORT void openDBRequestCancelled(const IDBRequestData&amp;);
<span class="line-removed">-     WEBCORE_EXPORT void confirmDidCloseFromServer(uint64_t databaseConnectionIdentifier);</span>
<span class="line-removed">- </span>
<span class="line-removed">-     WEBCORE_EXPORT void getAllDatabaseNames(uint64_t serverConnectionIdentifier, const SecurityOriginData&amp; mainFrameOrigin, const SecurityOriginData&amp; openingOrigin, uint64_t callbackID);</span>
  
<span class="line-modified">!     void postDatabaseTask(CrossThreadTask&amp;&amp;);</span>
<span class="line-removed">-     void postDatabaseTaskReply(CrossThreadTask&amp;&amp;);</span>
  
      void registerDatabaseConnection(UniqueIDBDatabaseConnection&amp;);
      void unregisterDatabaseConnection(UniqueIDBDatabaseConnection&amp;);
      void registerTransaction(UniqueIDBDatabaseTransaction&amp;);
      void unregisterTransaction(UniqueIDBDatabaseTransaction&amp;);
  
      std::unique_ptr&lt;UniqueIDBDatabase&gt; closeAndTakeUniqueIDBDatabase(UniqueIDBDatabase&amp;);
  
      std::unique_ptr&lt;IDBBackingStore&gt; createBackingStore(const IDBDatabaseIdentifier&amp;);
  
<span class="line-modified">!     WEBCORE_EXPORT void closeAndDeleteDatabasesModifiedSince(WallTime, Function&lt;void ()&gt;&amp;&amp; completionHandler);</span>
<span class="line-modified">!     WEBCORE_EXPORT void closeAndDeleteDatabasesForOrigins(const Vector&lt;SecurityOriginData&gt;&amp;, Function&lt;void ()&gt;&amp;&amp; completionHandler);</span>
  
<span class="line-modified">!     void requestSpace(const ClientOrigin&amp;, uint64_t taskSize, CompletionHandler&lt;void(StorageQuotaManager::Decision)&gt;&amp;&amp;);</span>
<span class="line-modified">!     void increasePotentialSpaceUsed(const ClientOrigin&amp;, uint64_t taskSize);</span>
<span class="line-removed">-     void decreasePotentialSpaceUsed(const ClientOrigin&amp;, uint64_t taskSize);</span>
<span class="line-removed">-     void increaseSpaceUsed(const ClientOrigin&amp;, uint64_t size);</span>
<span class="line-removed">-     void decreaseSpaceUsed(const ClientOrigin&amp;, uint64_t size);</span>
<span class="line-removed">-     void resetSpaceUsed(const ClientOrigin&amp;);</span>
  
<span class="line-modified">!     void initializeQuotaUser(const ClientOrigin&amp; origin) { ensureQuotaUser(origin); }</span>
  
<span class="line-modified">!     WEBCORE_EXPORT void tryStop(ShouldForceStop);</span>
<span class="line-removed">-     WEBCORE_EXPORT void resume();</span>
  
<span class="line-modified">! private:</span>
<span class="line-modified">!     IDBServer(PAL::SessionID, IDBBackingStoreTemporaryFileHandler&amp;, QuotaManagerGetter&amp;&amp;);</span>
<span class="line-removed">-     IDBServer(PAL::SessionID, const String&amp; databaseDirectoryPath, IDBBackingStoreTemporaryFileHandler&amp;, QuotaManagerGetter&amp;&amp;);</span>
  
      UniqueIDBDatabase&amp; getOrCreateUniqueIDBDatabase(const IDBDatabaseIdentifier&amp;);
  
      String databaseDirectoryPathIsolatedCopy() const { return m_databaseDirectoryPath.isolatedCopy(); }
  
<span class="line-removed">-     void performGetAllDatabaseNames(uint64_t serverConnectionIdentifier, const SecurityOriginData&amp; mainFrameOrigin, const SecurityOriginData&amp; openingOrigin, uint64_t callbackID);</span>
<span class="line-removed">-     void didGetAllDatabaseNames(uint64_t serverConnectionIdentifier, uint64_t callbackID, const Vector&lt;String&gt;&amp; databaseNames);</span>
<span class="line-removed">- </span>
<span class="line-removed">-     void performCloseAndDeleteDatabasesModifiedSince(WallTime, uint64_t callbackID);</span>
<span class="line-removed">-     void performCloseAndDeleteDatabasesForOrigins(const Vector&lt;SecurityOriginData&gt;&amp;, uint64_t callbackID);</span>
<span class="line-removed">-     void didPerformCloseAndDeleteDatabases(uint64_t callbackID);</span>
<span class="line-removed">- </span>
      void upgradeFilesIfNecessary();
      void removeDatabasesModifiedSinceForVersion(WallTime, const String&amp;);
      void removeDatabasesWithOriginsForVersion(const Vector&lt;SecurityOriginData&gt;&amp;, const String&amp;);
  
<span class="line-removed">-     class QuotaUser final : public StorageQuotaUser {</span>
<span class="line-removed">-         WTF_MAKE_FAST_ALLOCATED;</span>
<span class="line-removed">-     public:</span>
<span class="line-removed">-         QuotaUser(IDBServer&amp;, StorageQuotaManager*, ClientOrigin&amp;&amp;);</span>
<span class="line-removed">-         ~QuotaUser();</span>
<span class="line-removed">- </span>
<span class="line-removed">-         StorageQuotaManager* manager() { return m_manager.get(); }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         void setSpaceUsed(uint64_t spaceUsed) { m_spaceUsed = spaceUsed; }</span>
<span class="line-removed">-         void resetSpaceUsed();</span>
<span class="line-removed">- </span>
<span class="line-removed">-         void increasePotentialSpaceUsed(uint64_t increase) { m_estimatedSpaceIncrease += increase; }</span>
<span class="line-removed">-         void decreasePotentialSpaceUsed(uint64_t decrease)</span>
<span class="line-removed">-         {</span>
<span class="line-removed">-             ASSERT(m_estimatedSpaceIncrease &gt;= decrease);</span>
<span class="line-removed">-             m_estimatedSpaceIncrease -= decrease;</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-         void increaseSpaceUsed(uint64_t size);</span>
<span class="line-removed">-         void decreaseSpaceUsed(uint64_t size);</span>
<span class="line-removed">- </span>
<span class="line-removed">-         void initializeSpaceUsed(uint64_t spaceUsed);</span>
<span class="line-removed">- </span>
<span class="line-removed">-     private:</span>
<span class="line-removed">-         uint64_t spaceUsed() const final { return m_spaceUsed + m_estimatedSpaceIncrease; }</span>
<span class="line-removed">-         void whenInitialized(CompletionHandler&lt;void()&gt;&amp;&amp;) final;</span>
<span class="line-removed">- </span>
<span class="line-removed">-         IDBServer&amp; m_server;</span>
<span class="line-removed">-         WeakPtr&lt;StorageQuotaManager&gt; m_manager;</span>
<span class="line-removed">-         ClientOrigin m_origin;</span>
<span class="line-removed">-         bool m_isInitialized { false };</span>
<span class="line-removed">-         uint64_t m_spaceUsed { 0 };</span>
<span class="line-removed">-         uint64_t m_estimatedSpaceIncrease { 0 };</span>
<span class="line-removed">-         CompletionHandler&lt;void()&gt; m_initializationCallback;</span>
<span class="line-removed">-     };</span>
<span class="line-removed">- </span>
<span class="line-removed">-     WEBCORE_EXPORT QuotaUser&amp; ensureQuotaUser(const ClientOrigin&amp;);</span>
<span class="line-removed">-     void startComputingSpaceUsedForOrigin(const ClientOrigin&amp;);</span>
<span class="line-removed">-     void computeSpaceUsedForOrigin(const ClientOrigin&amp;);</span>
<span class="line-removed">-     void finishComputingSpaceUsedForOrigin(const ClientOrigin&amp;, uint64_t spaceUsed);</span>
<span class="line-removed">- </span>
      PAL::SessionID m_sessionID;
<span class="line-modified">!     HashMap&lt;uint64_t, RefPtr&lt;IDBConnectionToClient&gt;&gt; m_connectionMap;</span>
      HashMap&lt;IDBDatabaseIdentifier, std::unique_ptr&lt;UniqueIDBDatabase&gt;&gt; m_uniqueIDBDatabaseMap;
  
      HashMap&lt;uint64_t, UniqueIDBDatabaseConnection*&gt; m_databaseConnections;
      HashMap&lt;IDBResourceIdentifier, UniqueIDBDatabaseTransaction*&gt; m_transactions;
  
      HashMap&lt;uint64_t, Function&lt;void ()&gt;&gt; m_deleteDatabaseCompletionHandlers;
  
      String m_databaseDirectoryPath;
<span class="line-removed">-     IDBBackingStoreTemporaryFileHandler&amp; m_backingStoreTemporaryFileHandler;</span>
  
<span class="line-modified">!     HashMap&lt;ClientOrigin, std::unique_ptr&lt;QuotaUser&gt;&gt; m_quotaUsers;</span>
<span class="line-modified">!     QuotaManagerGetter m_quotaManagerGetter;</span>
  };
  
  } // namespace IDBServer
  } // namespace WebCore
  
<span class="line-new-header">--- 84,61 ---</span>
  
      WEBCORE_EXPORT void establishTransaction(uint64_t databaseConnectionIdentifier, const IDBTransactionInfo&amp;);
      WEBCORE_EXPORT void databaseConnectionPendingClose(uint64_t databaseConnectionIdentifier);
      WEBCORE_EXPORT void databaseConnectionClosed(uint64_t databaseConnectionIdentifier);
      WEBCORE_EXPORT void abortOpenAndUpgradeNeeded(uint64_t databaseConnectionIdentifier, const IDBResourceIdentifier&amp; transactionIdentifier);
<span class="line-modified">!     WEBCORE_EXPORT void didFireVersionChangeEvent(uint64_t databaseConnectionIdentifier, const IDBResourceIdentifier&amp; requestIdentifier, IndexedDB::ConnectionClosedOnBehalfOfServer);</span>
      WEBCORE_EXPORT void openDBRequestCancelled(const IDBRequestData&amp;);
  
<span class="line-modified">!     WEBCORE_EXPORT void getAllDatabaseNames(IDBConnectionIdentifier serverConnectionIdentifier, const SecurityOriginData&amp; mainFrameOrigin, const SecurityOriginData&amp; openingOrigin, uint64_t callbackID);</span>
  
      void registerDatabaseConnection(UniqueIDBDatabaseConnection&amp;);
      void unregisterDatabaseConnection(UniqueIDBDatabaseConnection&amp;);
      void registerTransaction(UniqueIDBDatabaseTransaction&amp;);
      void unregisterTransaction(UniqueIDBDatabaseTransaction&amp;);
  
      std::unique_ptr&lt;UniqueIDBDatabase&gt; closeAndTakeUniqueIDBDatabase(UniqueIDBDatabase&amp;);
  
      std::unique_ptr&lt;IDBBackingStore&gt; createBackingStore(const IDBDatabaseIdentifier&amp;);
  
<span class="line-modified">!     WEBCORE_EXPORT void closeAndDeleteDatabasesModifiedSince(WallTime);</span>
<span class="line-modified">!     WEBCORE_EXPORT void closeAndDeleteDatabasesForOrigins(const Vector&lt;SecurityOriginData&gt;&amp;);</span>
  
<span class="line-modified">!     StorageQuotaManager::Decision requestSpace(const ClientOrigin&amp;, uint64_t taskSize);</span>
<span class="line-modified">!     WEBCORE_EXPORT static uint64_t diskUsage(const String&amp; rootDirectory, const ClientOrigin&amp;);</span>
  
<span class="line-modified">!     WEBCORE_EXPORT void stopDatabaseActivitiesOnMainThread();</span>
  
<span class="line-modified">!     Lock&amp; lock() { return m_lock; };</span>
  
<span class="line-modified">!     void addDatabase(UniqueIDBDatabase&amp; database) { m_allUniqueIDBDatabases.add(database); }</span>
<span class="line-modified">!     void removeDatabase(UniqueIDBDatabase&amp; database) { m_allUniqueIDBDatabases.remove(database); }</span>
  
<span class="line-added">+ private:</span>
      UniqueIDBDatabase&amp; getOrCreateUniqueIDBDatabase(const IDBDatabaseIdentifier&amp;);
  
      String databaseDirectoryPathIsolatedCopy() const { return m_databaseDirectoryPath.isolatedCopy(); }
  
      void upgradeFilesIfNecessary();
      void removeDatabasesModifiedSinceForVersion(WallTime, const String&amp;);
      void removeDatabasesWithOriginsForVersion(const Vector&lt;SecurityOriginData&gt;&amp;, const String&amp;);
  
      PAL::SessionID m_sessionID;
<span class="line-modified">!     HashMap&lt;IDBConnectionIdentifier, RefPtr&lt;IDBConnectionToClient&gt;&gt; m_connectionMap;</span>
      HashMap&lt;IDBDatabaseIdentifier, std::unique_ptr&lt;UniqueIDBDatabase&gt;&gt; m_uniqueIDBDatabaseMap;
<span class="line-added">+     WeakHashSet&lt;UniqueIDBDatabase&gt; m_allUniqueIDBDatabases;</span>
  
      HashMap&lt;uint64_t, UniqueIDBDatabaseConnection*&gt; m_databaseConnections;
      HashMap&lt;IDBResourceIdentifier, UniqueIDBDatabaseTransaction*&gt; m_transactions;
  
      HashMap&lt;uint64_t, Function&lt;void ()&gt;&gt; m_deleteDatabaseCompletionHandlers;
  
      String m_databaseDirectoryPath;
  
<span class="line-modified">!     StorageQuotaManagerSpaceRequester m_spaceRequester;</span>
<span class="line-modified">! </span>
<span class="line-added">+     Lock m_lock;</span>
  };
  
  } // namespace IDBServer
  } // namespace WebCore
  
</pre>
<center><a href="IDBServer.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="MemoryCursor.cpp.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>