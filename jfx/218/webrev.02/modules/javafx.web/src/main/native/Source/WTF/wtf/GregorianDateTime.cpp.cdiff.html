<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.web/src/main/native/Source/WTF/wtf/GregorianDateTime.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="Gigacage.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="GregorianDateTime.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WTF/wtf/GregorianDateTime.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 33,10 ***</span>
<span class="line-new-header">--- 33,57 ---</span>
  #include &lt;time.h&gt;
  #endif
  
  namespace WTF {
  
<span class="line-added">+ GregorianDateTime::GregorianDateTime(double ms, LocalTimeOffset localTime)</span>
<span class="line-added">+ {</span>
<span class="line-added">+     if (ms &gt;= 0</span>
<span class="line-added">+ #if OS(WINDOWS) &amp;&amp; CPU(X86)</span>
<span class="line-added">+             // The VS Compiler for 32-bit builds generates a floating point error when attempting to cast</span>
<span class="line-added">+             // from an infinity to a 64-bit integer. We leave this routine with the floating point error</span>
<span class="line-added">+             // left in a register, causing undefined behavior in later floating point operations.</span>
<span class="line-added">+             //</span>
<span class="line-added">+             // To avoid this issue, we check for infinity here, and return false in that case.</span>
<span class="line-added">+             &amp;&amp; !std::isinf(ms)</span>
<span class="line-added">+ #endif</span>
<span class="line-added">+         ) {</span>
<span class="line-added">+         int64_t integer = static_cast&lt;int64_t&gt;(ms);</span>
<span class="line-added">+         if (static_cast&lt;double&gt;(integer) == ms &amp;&amp; integer &lt;= maxECMAScriptTime) {</span>
<span class="line-added">+             // Positive integer fast path.</span>
<span class="line-added">+             WTF::TimeClippedPositiveMilliseconds timeClipped(integer);</span>
<span class="line-added">+             const int year = msToYear(ms);</span>
<span class="line-added">+             setSecond(msToSeconds(timeClipped));</span>
<span class="line-added">+             setMinute(msToMinutes(timeClipped));</span>
<span class="line-added">+             setHour(msToHours(timeClipped));</span>
<span class="line-added">+             setWeekDay(msToWeekDay(timeClipped));</span>
<span class="line-added">+             int yearDay = dayInYear(timeClipped, year);</span>
<span class="line-added">+             bool leapYear = isLeapYear(year);</span>
<span class="line-added">+             setYearDay(yearDay);</span>
<span class="line-added">+             setMonthDay(dayInMonthFromDayInYear(yearDay, leapYear));</span>
<span class="line-added">+             setMonth(monthFromDayInYear(yearDay, leapYear));</span>
<span class="line-added">+             setYear(year);</span>
<span class="line-added">+             setIsDST(localTime.isDST);</span>
<span class="line-added">+             setUTCOffsetInMinute(localTime.offset / WTF::msPerMinute);</span>
<span class="line-added">+             return;</span>
<span class="line-added">+         }</span>
<span class="line-added">+     }</span>
<span class="line-added">+     const int year = msToYear(ms);</span>
<span class="line-added">+     setSecond(msToSeconds(ms));</span>
<span class="line-added">+     setMinute(msToMinutes(ms));</span>
<span class="line-added">+     setHour(msToHours(ms));</span>
<span class="line-added">+     setWeekDay(msToWeekDay(ms));</span>
<span class="line-added">+     int yearDay = dayInYear(ms, year);</span>
<span class="line-added">+     bool leapYear = isLeapYear(year);</span>
<span class="line-added">+     setYearDay(yearDay);</span>
<span class="line-added">+     setMonthDay(dayInMonthFromDayInYear(yearDay, leapYear));</span>
<span class="line-added">+     setMonth(monthFromDayInYear(yearDay, leapYear));</span>
<span class="line-added">+     setYear(year);</span>
<span class="line-added">+     setIsDST(localTime.isDST);</span>
<span class="line-added">+     setUTCOffsetInMinute(localTime.offset / WTF::msPerMinute);</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
  void GregorianDateTime::setToCurrentLocalTime()
  {
  #if OS(WINDOWS)
      SYSTEMTIME systemTime;
      GetLocalTime(&amp;systemTime);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 60,11 ***</span>
      m_yearDay = dayInYear(m_year, m_month, m_monthDay);
      m_weekDay = systemTime.wDayOfWeek;
      m_hour = systemTime.wHour;
      m_minute = systemTime.wMinute;
      m_second = systemTime.wSecond;
<span class="line-modified">!     m_utcOffset = -bias * secondsPerMinute;</span>
      m_isDST = timeZoneId == TIME_ZONE_ID_DAYLIGHT ? 1 : 0;
  #else
      tm localTM;
      time_t localTime = time(0);
  #if HAVE(LOCALTIME_R)
<span class="line-new-header">--- 107,11 ---</span>
      m_yearDay = dayInYear(m_year, m_month, m_monthDay);
      m_weekDay = systemTime.wDayOfWeek;
      m_hour = systemTime.wHour;
      m_minute = systemTime.wMinute;
      m_second = systemTime.wSecond;
<span class="line-modified">!     m_utcOffsetInMinute = -bias;</span>
      m_isDST = timeZoneId == TIME_ZONE_ID_DAYLIGHT ? 1 : 0;
  #else
      tm localTM;
      time_t localTime = time(0);
  #if HAVE(LOCALTIME_R)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 81,13 ***</span>
      m_hour = localTM.tm_hour;
      m_minute = localTM.tm_min;
      m_second = localTM.tm_sec;
      m_isDST = localTM.tm_isdst;
  #if HAVE(TM_GMTOFF)
<span class="line-modified">!     m_utcOffset = localTM.tm_gmtoff;</span>
  #else
<span class="line-modified">!     m_utcOffset = calculateLocalTimeOffset(localTime * msPerSecond).offset / msPerSecond;</span>
  #endif
  #endif
  }
  
  } // namespace WTF
<span class="line-new-header">--- 128,13 ---</span>
      m_hour = localTM.tm_hour;
      m_minute = localTM.tm_min;
      m_second = localTM.tm_sec;
      m_isDST = localTM.tm_isdst;
  #if HAVE(TM_GMTOFF)
<span class="line-modified">!     m_utcOffsetInMinute = localTM.tm_gmtoff / secondsPerMinute;</span>
  #else
<span class="line-modified">!     m_utcOffsetInMinute = calculateLocalTimeOffset(localTime * msPerSecond).offset / msPerMinute;</span>
  #endif
  #endif
  }
  
  } // namespace WTF
</pre>
<center><a href="Gigacage.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="GregorianDateTime.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>