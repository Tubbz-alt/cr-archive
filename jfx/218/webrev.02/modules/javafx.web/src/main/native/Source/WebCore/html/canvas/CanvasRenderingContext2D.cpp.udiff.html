<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WebCore/html/canvas/CanvasRenderingContext2D.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="CanvasRenderingContext.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="CanvasRenderingContext2DBase.cpp.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/html/canvas/CanvasRenderingContext2D.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -41,12 +41,12 @@</span>
  #include &quot;InspectorInstrumentation.h&quot;
  #include &quot;Path2D.h&quot;
  #include &quot;RenderTheme.h&quot;
  #include &quot;ResourceLoadObserver.h&quot;
  #include &quot;RuntimeEnabledFeatures.h&quot;
<span class="udiff-line-added">+ #include &quot;StyleBuilder.h&quot;</span>
  #include &quot;StyleProperties.h&quot;
<span class="udiff-line-removed">- #include &quot;StyleResolver.h&quot;</span>
  #include &quot;TextMetrics.h&quot;
  #include &quot;TextRun.h&quot;
  #include &lt;wtf/CheckedArithmetic.h&gt;
  #include &lt;wtf/IsoMallocInlines.h&gt;
  #include &lt;wtf/MathExtras.h&gt;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -125,10 +125,13 @@</span>
      return serializedFont.toString();
  }
  
  void CanvasRenderingContext2D::setFont(const String&amp; newFont)
  {
<span class="udiff-line-added">+     if (newFont.isEmpty())</span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+ </span>
      if (newFont == state().unparsedFont &amp;&amp; state().font.realized())
          return;
  
      auto parsedStyle = MutableStyleProperties::create();
      CSSParser::parseValue(parsedStyle, CSSPropertyFont, newFont, true, strictToCSSParserMode(!m_usesCSSCompatibilityParseMode));
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -166,25 +169,23 @@</span>
      }
  
      newStyle-&gt;fontCascade().update(&amp;document.fontSelector());
  
      // Now map the font property longhands into the style.
<span class="udiff-line-modified-removed">-     StyleResolver&amp; styleResolver = canvas().styleResolver();</span>
<span class="udiff-line-modified-removed">-     styleResolver.applyPropertyToStyle(CSSPropertyFontFamily, parsedStyle-&gt;getPropertyCSSValue(CSSPropertyFontFamily).get(), WTFMove(newStyle));</span>
<span class="udiff-line-modified-removed">-     styleResolver.applyPropertyToCurrentStyle(CSSPropertyFontStyle, parsedStyle-&gt;getPropertyCSSValue(CSSPropertyFontStyle).get());</span>
<span class="udiff-line-modified-removed">-     styleResolver.applyPropertyToCurrentStyle(CSSPropertyFontVariantCaps, parsedStyle-&gt;getPropertyCSSValue(CSSPropertyFontVariantCaps).get());</span>
<span class="udiff-line-modified-removed">-     styleResolver.applyPropertyToCurrentStyle(CSSPropertyFontWeight, parsedStyle-&gt;getPropertyCSSValue(CSSPropertyFontWeight).get());</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-     // As described in BUG66291, setting font-size and line-height on a font may entail a CSSPrimitiveValue::computeLengthDouble call,</span>
<span class="udiff-line-modified-removed">-     // which assumes the fontMetrics are available for the affected font, otherwise a crash occurs (see http://trac.webkit.org/changeset/96122).</span>
<span class="udiff-line-modified-removed">-     // The updateFont() calls below update the fontMetrics and ensure the proper setting of font-size and line-height.</span>
<span class="udiff-line-modified-removed">-     styleResolver.updateFont();</span>
<span class="udiff-line-modified-removed">-     styleResolver.applyPropertyToCurrentStyle(CSSPropertyFontSize, parsedStyle-&gt;getPropertyCSSValue(CSSPropertyFontSize).get());</span>
<span class="udiff-line-modified-removed">-     styleResolver.updateFont();</span>
<span class="udiff-line-modified-removed">-     styleResolver.applyPropertyToCurrentStyle(CSSPropertyLineHeight, parsedStyle-&gt;getPropertyCSSValue(CSSPropertyLineHeight).get());</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     modifiableState().font.initialize(document.fontSelector(), *styleResolver.style());</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+     Style::MatchResult matchResult;</span>
<span class="udiff-line-modified-added">+     auto parentStyle = RenderStyle::clone(*newStyle);</span>
<span class="udiff-line-modified-added">+     Style::Builder styleBuilder(*newStyle, { document, parentStyle }, matchResult, { });</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+     styleBuilder.applyPropertyValue(CSSPropertyFontFamily, parsedStyle-&gt;getPropertyCSSValue(CSSPropertyFontFamily).get());</span>
<span class="udiff-line-modified-added">+     styleBuilder.applyPropertyValue(CSSPropertyFontStyle, parsedStyle-&gt;getPropertyCSSValue(CSSPropertyFontStyle).get());</span>
<span class="udiff-line-modified-added">+     styleBuilder.applyPropertyValue(CSSPropertyFontVariantCaps, parsedStyle-&gt;getPropertyCSSValue(CSSPropertyFontVariantCaps).get());</span>
<span class="udiff-line-modified-added">+     styleBuilder.applyPropertyValue(CSSPropertyFontWeight, parsedStyle-&gt;getPropertyCSSValue(CSSPropertyFontWeight).get());</span>
<span class="udiff-line-modified-added">+     styleBuilder.applyPropertyValue(CSSPropertyFontSize, parsedStyle-&gt;getPropertyCSSValue(CSSPropertyFontSize).get());</span>
<span class="udiff-line-modified-added">+     styleBuilder.applyPropertyValue(CSSPropertyLineHeight, parsedStyle-&gt;getPropertyCSSValue(CSSPropertyLineHeight).get());</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+     modifiableState().font.initialize(document.fontSelector(), *newStyle);</span>
  }
  
  static CanvasTextAlign toCanvasTextAlign(TextAlign textAlign)
  {
      switch (textAlign) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -542,11 +543,11 @@</span>
                  c-&gt;setStrokeColor(Color::black);
  
              fontProxy.drawBidiText(*c, textRun, location + offset, FontCascade::UseFallbackIfFontNotReady);
          }
  
<span class="udiff-line-modified-removed">-         auto maskImage = ImageBuffer::createCompatibleBuffer(maskRect.size(), ColorSpaceSRGB, *c);</span>
<span class="udiff-line-modified-added">+         auto maskImage = ImageBuffer::createCompatibleBuffer(maskRect.size(), ColorSpace::SRGB, *c);</span>
          if (!maskImage)
              return;
  
          auto&amp; maskImageContext = maskImage-&gt;context();
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -590,11 +591,11 @@</span>
      if (isFullCanvasCompositeMode(state().globalComposite)) {
          beginCompositeLayer();
          fontProxy.drawBidiText(*c, textRun, location, FontCascade::UseFallbackIfFontNotReady);
          endCompositeLayer();
          didDrawEntireCanvas();
<span class="udiff-line-modified-removed">-     } else if (state().globalComposite == CompositeCopy) {</span>
<span class="udiff-line-modified-added">+     } else if (state().globalComposite == CompositeOperator::Copy) {</span>
          clearCanvas();
          fontProxy.drawBidiText(*c, textRun, location, FontCascade::UseFallbackIfFontNotReady);
          didDrawEntireCanvas();
      } else {
          fontProxy.drawBidiText(*c, textRun, location, FontCascade::UseFallbackIfFontNotReady);
</pre>
<center><a href="CanvasRenderingContext.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="CanvasRenderingContext2DBase.cpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>